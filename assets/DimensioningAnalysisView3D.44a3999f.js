var hi=Object.defineProperty,ci=Object.defineProperties;var pi=Object.getOwnPropertyDescriptors;var Rt=Object.getOwnPropertySymbols;var ui=Object.prototype.hasOwnProperty,gi=Object.prototype.propertyIsEnumerable;var $t=(t,e,i)=>e in t?hi(t,e,{enumerable:!0,configurable:!0,writable:!0,value:i}):t[e]=i,re=(t,e)=>{for(var i in e||(e={}))ui.call(e,i)&&$t(t,i,e[i]);if(Rt)for(var i of Rt(e))gi.call(e,i)&&$t(t,i,e[i]);return t},we=(t,e)=>ci(t,pi(e));import{aY as fi,f1 as _i,jD as mi,jE as yi,a,d,aQ as ce,jf as vi,kM as wi,kN as xi,n as S,kO as Si,t as m,ap as Vt,r as f,l as j,h6 as Ei,kP as bi,kQ as Pi,kR as Ti,u as tt,am as w,iI as Gt,j5 as xt,jJ as ie,k9 as qt,B as C,bV as St,aZ as Y,aj as W,f0 as Wt,ia as ct,kS as Qe,jK as Xe,eR as Et,k8 as Ci,ag as ee,kT as pt,kU as Oi,i5 as Ri,kV as $i,kW as Vi,kX as Hi,bY as Yt,kY as oe,jq as bt,aO as Li,jZ as Mi,jY as U,kl as ut,h0 as Ii,km as Se,kF as Re,eu as Ut,h1 as fe,ab as Tt,d2 as ki,hE as $,kg as Di,y as F,h5 as D,kn as Ct,kf as Ni,q as $e,fj as Ai,ds as zi,hs as _e,kZ as ji,I as Ve,kI as pe,aF as Fi,U as Je,io as Gi,a7 as qi,J as Oe,kc as Wi,ko as Yi,kk as Ht,kd as Xt,jy as Zt,$ as Ui,c2 as Xi,K as Zi,k_ as Bi,aB as Bt,aq as Qt,k$ as Jt,bZ as Kt,l0 as Qi,aC as Ji,cW as Ki,l1 as Ne,o as Pt,ac as en,ad as tn,l2 as nn,e2 as sn,h as gt,ju as rn,l3 as Ke,fd as on,e_ as ue,l4 as Ae,jr as ft,kz as Lt,k6 as Mt,jL as an,fw as ln,l5 as dn,aN as _t,eZ as mt,aM as hn,az as cn}from"./vendor.fd144a9e.js";import{n as ei,C as yt,a as pn}from"./LineVisualElement.8fc1a873.js";import{G as It,y as un,p as gn,z as fn,a as _n,c as mn,m as yn,s as vn}from"./analysisViewUtils.e61caa7d.js";import{_ as wn,S as kt}from"./PointVisualElement.566cfb09.js";import{j as xn}from"./RightAngleQuadVisualElement.c9cc8344.js";import{c as te,j as Sn,R as x,l as xe,v as En,b as bn,o as vt}from"./Segment.115ca660.js";import{B as Pn,z as Tn}from"./dragEventPipeline3D.5c6f4875.js";import{E as ti,N as Cn,y as ii,b as R,d as ni,j as On,v as si,L as Te,m as ri,S as Rn,g as $n,x as Vn}from"./EditGeometryOperations.a1e50b07.js";import{E as et}from"./QueryEngineResult.ec64a57b.js";import{m as Dt}from"./elevationInfoUtils.45a1c5b7.js";function Hn(t){const e=_i(t),i=e===mi?yi:e;return fi(t,i)?i:t}const Ln=["horizontal","vertical","direct"];let A=class extends Si{constructor(t){super(t),this.type="length",this.startPoint=null,this.endPoint=null,this.axis="horizontal",this.offset=0,this.heading=0}get extent(){if(m(this.startPoint))return null;const t=Vt.fromPoint(this.startPoint);return f(this.endPoint)&&t.union(Vt.fromPoint(this.endPoint)),t}};a([d({type:["length"]})],A.prototype,"type",void 0),a([d({type:ce})],A.prototype,"startPoint",void 0),a([d({type:ce})],A.prototype,"endPoint",void 0),a([d({type:Ln,nonNullable:!0})],A.prototype,"axis",void 0),a([d({type:Number,nonNullable:!0})],A.prototype,"offset",void 0),a([d({type:Number,nonNullable:!0}),vi(t=>wi.normalize(xi(t),0,!0))],A.prototype,"heading",void 0),a([d({readOnly:!0})],A.prototype,"extent",null),A=a([S("esri.analysis.LengthDimension")],A);const Mn=A,In={main:new j([255,127,0])};class kn{constructor(){this.color=In.main,this.opacity=.5,this.radius=5}}class Dn{constructor(){this.fontSize=14}get height(){return 1.5*Ei(this.fontSize)}get offset(){return this.height+20}}class Nn{constructor(){this.pointManipulators=new kn,this.labels=new Dn}}const Ce=new Nn;class An extends ei{constructor(e){super(e),this._ray=Ti(),this._externalResources=null,this._handles=new tt,this._isWorldDown=!1,this._start=w(),this._end=Gt(1,0,0),this._width=1,this._color=xt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=xt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=M.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=ie.OccludeAndTransparent,this._fadedExtensions=zt,this.applyProps(e)}createExternalResources(){const e=new qt(this.materialParameters);this._handles.add(C(()=>this.view.state.camera,()=>{this._updateGeometry()}));const i=new wn({view:this.view,attached:this._laserlineEnabled});this._externalResources={material:e,laserline:i}}destroyExternalResources(){f(this._externalResources)&&this._externalResources.laserline.destroy(),this._externalResources=null,this._handles.removeAll()}forEachExternalMaterial(e){f(this._externalResources)&&e(this._externalResources.material)}createGeometries(e){const i=[w(),w()],n=this.extensionType===M.FADED;n&&i.push(w(),w());const s=n?new Float32Array([1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]):null,r=St.createPolylineGeometry(i,null,s);e.addGeometry(r,Y(this._externalResources).material),this._updateVertices(e)}updateVisibility(e){super.updateVisibility(e),f(this._externalResources)&&(this._externalResources.laserline.visible=e)}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,W(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),Wt(this._end,e,this._end),ct(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,Qe(this._start,e)||(W(this._start,e),ct(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,Qe(this._end,e)||(W(this._end,e),ct(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){Xe(e,this._color)||(Et(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){Xe(e,this._innerColor)||(Et(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const i=f(e)!==f(this._stipplePattern);this._stipplePattern=e,i?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){(m(e)||m(this._stippleOffColor)||!Xe(e,this._stippleOffColor))&&(this._stippleOffColor=f(e)?Ci(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this._updateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&f(this._laserlineStyle)}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,f(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached,f(e)&&(this._externalResources.laserline.style=e))}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,f(this._externalResources)&&(this._externalResources.laserline.attached=this._laserlineAttached))}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=ee(e,zt),this.recreateGeometry()}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._renderOccluded,writeDepth:this._writeDepthEnabled}}_updateGeometry(){f(this.object)&&this._updateVertices(this.object)}_updateVertices(e){const i=this._extensionType===M.FADED?this._updateLineSegmentFinite(Nt):this._updateLineSegmentInfinite(this._extensionType,Nt);this._updateVertexAttributes(e,i),f(this._externalResources)&&(this._externalResources.laserline.intersectsLine=i)}_updateLineSegmentFinite(e){return pt(this._start,this._end,e)}_updateLineSegmentInfinite(e,i){const n=this.view.state.camera;switch(Oi(this._ray,G),e){case M.LINE:G.c0=-Number.MAX_VALUE;break;case M.RAY:case M.GROUND_RAY:{const o=this._ray.origin,l=ee(this.view.elevationProvider.getElevation(o[0],o[1],o[2],this.view.renderCoordsHelper.spatialReference,"ground"),0),h=this.view.renderCoordsHelper.getAltitude(o);this._isWorldDown&&h<l&&Ri(G.ray.direction,G.ray.direction),this._extensionType===M.GROUND_RAY&&l!=null&&(G.c1=Math.abs(h-l));break}}if(!$i(n.frustum,G))return pt(this._start,this._end,i);const s=Vi(G,Z),r=Hi(G,zn);return pt(s,r,i)}_updateVertexAttributes(e,i){const n=e.geometries[0].getMutableAttribute(Yt.POSITION).data;if(this.extensionType===M.FADED){const s=oe(i,-this.fadedExtensions.start,Z);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=oe(i,0,Z);n[3]=r[0],n[4]=r[1],n[5]=r[2];const o=oe(i,1,Z);n[6]=o[0],n[7]=o[1],n[8]=o[2];const l=oe(i,1+this.fadedExtensions.end,Z);n[9]=l[0],n[10]=l[1],n[11]=l[2]}else{const s=oe(i,0,Z);n[0]=s[0],n[1]=s[1],n[2]=s[2];const r=oe(i,1,Z);n[3]=r[0],n[4]=r[1],n[5]=r[2]}e.geometryVertexAttrsUpdated(e.geometryRecords[0])}}const G=bi(),Z=w(),zn=w(),Nt=Pi();var M;(function(t){t[t.LINE=0]="LINE",t[t.RAY=1]="RAY",t[t.GROUND_RAY=2]="GROUND_RAY",t[t.FADED=3]="FADED"})(M||(M={}));const At=1/3,zt={start:At,end:At};class jn extends ei{constructor(e){super(e),this._handles=new tt,this._location=w(),this._direction=Gt(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=xt(1,0,1,1),this._renderOccluded=ie.OccludeAndTransparent,this.applyProps(e)}get location(){return this._location}set location(e){Qe(this._location,e)||(W(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){Qe(this._direction,e)||(W(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,i){bt(this._direction,Wt(this._direction,i,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){Xe(e,this._color)||(Et(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}createExternalResources(){const e=new qt(this.materialParameters);this._handles.add(C(()=>this.view.state.camera,()=>{this._updateGeometry()})),this._externalResources={material:e}}destroyExternalResources(){this._handles.removeAll(),this._externalResources=null}createGeometries(e){const i=St.createPolylineGeometry([w(),w()]),n=St.createPolylineGeometry([w(),w()]),s=Y(this._externalResources).material;e.addGeometry(i,s),e.addGeometry(n,s),this._updateVertices(e)}forEachExternalMaterial(e){f(this._externalResources)&&e(this._externalResources.material)}_updateMaterial(){m(this._externalResources)||this._externalResources.material.setParameters(this.materialParameters)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded}}_updateGeometry(){const e=this.object;m(e)||this._updateVertices(e)}_updateVertices(e){const i=this.view.state.camera;i.projectToScreen(this.location,ze),Li(N,this.location,this.direction),i.projectToScreen(N,ae),Mi(ae,U(ae,ae,ze)),this._updateVertexAttributes(i,e,0,ze,ae,1),this._updateVertexAttributes(i,e,1,ze,ae,-1)}_updateVertexAttributes(e,i,n,s,r,o){const l=i.geometryRecords[n],h=l.geometry.getMutableAttribute(Yt.POSITION).data,c=ut(jt,Ii(jt,r[1]*o,r[0]*-o),this.offset+this.width/2),u=Se(je,Se(je,Se(je,s,ut(je,r,this.length/2)),c),c),g=Se(Ft,u,ut(Ft,r,-this.length));e.unprojectFromScreen(u,N),h[0]=N[0],h[1]=N[1],h[2]=N[2],e.unprojectFromScreen(g,N),h[3]=N[0],h[4]=N[1],h[5]=N[2],i.geometryVertexAttrsUpdated(l)}}const N=w(),ze=Re(),ae=Re(),jt=Re(),je=Re(),Ft=Re();let I=class extends Ut{constructor(){super(...arguments),this.enabled=!0}};a([d({type:Boolean})],I.prototype,"enabled",void 0),I=a([S("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],I);let v=class extends Ut{constructor(t){super(t),this.lineSnapper=new I,this.parallelLineSnapper=new I,this.rightAngleSnapper=new I,this.rightAngleTriangleSnapper=new I,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new j([255,127,0]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5}};a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"lineSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"parallelLineSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"rightAngleSnapper",void 0),a([d({type:I,constructOnly:!0,nonNullable:!0,json:{write:!0}})],v.prototype,"rightAngleTriangleSnapper",void 0),a([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],v.prototype,"shortLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],v.prototype,"distance",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"pointThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"intersectionParallelLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"parallelLineThreshold",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"touchSensitivityMultiplier",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],v.prototype,"pointOnLineThreshold",void 0),a([d({type:j,nonNullable:!0})],v.prototype,"orange",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"lineHintWidthReference",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"lineHintWidthTarget",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],v.prototype,"lineHintFadedExtensions",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],v.prototype,"parallelLineHintWidth",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],v.prototype,"parallelLineHintLength",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],v.prototype,"parallelLineHintOffset",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],v.prototype,"rightAngleHintSize",void 0),a([d({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],v.prototype,"rightAngleHintOutlineSize",void 0),v=a([S("esri.views.interactive.snapping.Settings.Defaults")],v);const y=new v;function ne(t,e){const i=t.x-e.x,n=t.y-e.y;return i*i+n*n}function V(t,e){const i=t.length===e.length&&t[0]===e[0]&&t[1]===e[1];switch(t.length){case 2:return i;case 3:return i&&t[2]===e[2];case 4:return i&&t[3]===e[3]}return!1}function it(t,e){e.sort((i,n)=>fe(i.targetPoint,t)-fe(n.targetPoint,t))}var b;(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(b||(b={}));class He{constructor(e){this.elevationInfo=e}}class nt extends He{constructor(e,i){super(i),this.intersectionPoint=e}equals(e){return e instanceof nt&&V(this.intersectionPoint,e.intersectionPoint)}}Tt.getLogger("esri.views.interactive.snapping.hints.LineSnappingHint");class H extends He{constructor(e,i,n,s,r=!0,o=!0){super(s),this.type=e,this.lineStart=i,this.lineEnd=n,this.fadeLeft=r,this.fadeRight=o}equals(e){return e instanceof H&&this.type===e.type&&V(this.lineStart,e.lineStart)&&V(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}}Tt.getLogger("esri.views.interactive.snapping.hints.ParallelSnappingHint");class st extends He{constructor(e,i,n){super(n),this.lineStart=e,this.lineEnd=i}equals(e){return e instanceof st&&V(this.lineStart,e.lineStart)&&V(this.lineEnd,e.lineEnd)}}class rt extends He{constructor(e,i){super(i),this.point=e}equals(e){return e instanceof rt&&V(this.point,e.point)}}Tt.getLogger("esri.views.interactive.snapping.hints.RightAngleSnappingHint");class Le extends He{constructor(e,i,n,s){super(s),this.previousVertex=e,this.centerVertex=i,this.nextVertex=n}equals(e){return e instanceof Le&&V(this.previousVertex,e.previousVertex)&&V(this.centerVertex,e.centerVertex)&&V(this.nextVertex,e.nextVertex)}}class Fn{draw(e,i){const n=this._getUniqueHints(e),s=[];for(const r of n)r instanceof nt&&s.push(this.visualizeIntersectionPoint(r,i)),r instanceof H&&s.push(this.visualizeLine(r,i)),r instanceof st&&s.push(this.visualizeParallelSign(r,i)),r instanceof Le&&s.push(this.visualizeRightAngleQuad(r,i)),r instanceof rt&&s.push(this.visualizePoint(r,i));return ki(s)}_getUniqueHints(e){const i=[];for(const n of e){let s=!0;for(const r of i)if(n.equals(r)){s=!1;break}s&&i.push(n)}return i}}class Gn extends Fn{visualizeIntersectionPoint(e,i){const{coordinateHelper:n,view:s}=i;return $(new kt({view:s,primitive:"circle",geometry:n.vectorToPoint(e.intersectionPoint),elevationInfo:ee(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:j.toUnitRGBA(y.orange),pixelSnappingEnabled:!1}))}visualizePoint(e,i){const{coordinateHelper:n,view:s}=i;return $(new kt({view:s,primitive:"circle",geometry:n.vectorToPoint(e.point),elevationInfo:ee(e.elevationInfo,i.elevationInfo),size:20,outlineSize:2,color:[0,0,0,0],outlineColor:j.toUnitRGBA(y.orange),pixelSnappingEnabled:!1}))}visualizeLine(e,i){const{coordinateHelper:n,view:s}=i;return $(this._createLineSegmentHintFromMap(e.type,e.lineStart,e.lineEnd,n,ee(e.elevationInfo,i.elevationInfo),s,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,i){const{coordinateHelper:n,view:s}=i,r=ee(e.elevationInfo,i.elevationInfo),o=te(e.lineStart,n,r,i.view),l=te(e.lineEnd,n,r,i.view),h=Di(l,o,l,.5),c=new jn({view:s,attached:!1,offset:y.parallelLineHintOffset,length:y.parallelLineHintLength,width:y.parallelLineHintWidth,color:j.toUnitRGBA(y.orange),location:h,renderOccluded:ie.Opaque});return c.setDirectionFromPoints(o,h),c.attached=!0,$(c)}visualizeRightAngleQuad(e,i){const{coordinateHelper:n,view:s}=i,r=ee(e.elevationInfo,i.elevationInfo);return $(new xn({view:s,attached:!0,color:j.toUnitRGBA(y.orange),renderOccluded:ie.Transparent,outlineRenderOccluded:ie.Opaque,outlineColor:j.toUnitRGBA(y.orange),outlineSize:y.rightAngleHintOutlineSize,size:y.rightAngleHintSize,geometry:{previous:te(e.previousVertex,n,r,s),center:te(e.centerVertex,n,r,s),next:te(e.nextVertex,n,r,s)}}))}_createLineSegmentHintFromMap(e,i,n,s,r,o,l=!0,h=!0){const c=w(),u=w();return Sn(i,n,s,r,o,c,u),this._createLineSegmentHint(e,o,c,u,l,h)}_createLineSegmentHint(e,i,n,s,r=!0,o=!0){const l=new An({view:i,extensionType:M.FADED,start:n,end:s,color:j.toUnitRGBA(y.orange),renderOccluded:ie.Opaque});switch(e){case b.TARGET:l.width=y.lineHintWidthTarget,l.fadedExtensions={start:0,end:y.lineHintFadedExtensions};break;case b.REFERENCE_EXTENSION:l.width=y.lineHintWidthReference,l.fadedExtensions={start:0,end:0};break;case b.REFERENCE:l.width=y.lineHintWidthReference,l.fadedExtensions={start:r?y.lineHintFadedExtensions:0,end:o?y.lineHintFadedExtensions:0}}return l.attached=!0,l}}let B=class extends F{constructor(t){super(t),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};a([d({constructOnly:!0})],B.prototype,"layer",void 0),a([d()],B.prototype,"enabled",void 0),a([d()],B.prototype,"updating",void 0),a([d()],B.prototype,"availability",void 0),B=a([S("esri.views.interactive.snapping.SnappingLayerSource")],B);const oi=B;class ot{constructor(e){this.coordinateHelper=e}}class Me extends ot{constructor(e,i){super(e),this.point=i}objectEqual(e){return e instanceof Me&&V(this.point,e.point)}check(e){return fe(e,this.point)<y.pointThreshold}closestTo(){return this.coordinateHelper.clone(this.point)}intersect(e){const i=[];return e instanceof se?i.push(...ii({start:e.start,end:e.end,type:e instanceof k?R.LINE:R.RAY},this.point)):e instanceof Ie&&i.push(...ni(e.center,e.radius,this.point)),i.map(n=>new ye(this.coordinateHelper,n,this,e))}}class se extends ot{constructor(e,i,n){super(e),this.start=i,this.end=n}objectEqual(e){return e instanceof se&&V(this.start,e.start)&&V(this.end,e.end)}intersect(e){const i=[];return e instanceof Me?i.push(...ii({start:this.start,end:this.end,type:this instanceof k?R.LINE:R.RAY},e.point)):e instanceof se?i.push(...On({start:this.start,end:this.end,type:this instanceof k?R.LINE:R.RAY},{start:e.start,end:e.end,type:e instanceof k?R.LINE:R.RAY})):e instanceof Ie&&i.push(...si({start:this.start,end:this.end,type:this instanceof k?R.LINE:R.RAY},e.center,e.radius)),i.map(n=>new ye(this.coordinateHelper,n,this,e))}}class at extends se{constructor(e,i,n){super(e,i,n),this.dir=D(),this.p=D()}objectEqual(e){return e instanceof at&&super.objectEqual(e)}check(e){return U(this.dir,this.end,this.start),U(this.p,e,this.start),Ct(this.dir,this.p)>=0&&ti(e,this.start,this.end)<y.pointOnLineThreshold}closestTo(e){const i=this.coordinateHelper.clone(e);return Cn(i,e,this.start,this.end),i}}class k extends se{constructor(e,i,n){super(e,i,n)}objectEqual(e){return e instanceof k&&super.objectEqual(e)}check(e){return ti(e,this.start,this.end)<y.pointOnLineThreshold}closestTo(e){const i=this.coordinateHelper.clone(e);return Te(i,e,this.start,this.end),i}}class ye extends ot{constructor(e,i,n,s){super(e),this.intersection=i,this.first=n,this.second=s}objectEqual(e){return e instanceof ye&&this.first.objectEqual(e.first)&&this.second.objectEqual(e.second)}check(){return!1}closestTo(e){const i=this.coordinateHelper.clone(e);return Ni(i,this.intersection),i}intersect(){return[]}}class Ie extends ot{constructor(e,i,n){super(e),this.center=i,this.radius=n}objectEqual(e){return e instanceof Ie&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}check(){return!1}closestTo(e){const i=this.coordinateHelper.clone(e);return ri(i,e,this.center,this.radius),i}intersect(e){const i=[];return e instanceof se?i.push(...si({start:e.start,end:e.end,type:e instanceof k?R.LINE:R.RAY},this.center,this.radius)):e instanceof Me&&i.push(...ni(this.center,this.radius,e.point)),i.map(n=>new ye(this.coordinateHelper,n,this,e))}}class ve{constructor(e,i,n,s){this.coordinateHelper=e,this.targetPoint=i,this.constraint=n,this.elevationInfo=s}}class Ot extends ve{constructor({coordinateHelper:e,targetPoint:i,objectId:n,constraint:s,elevationInfo:r}){super(e,i,s,r),this.objectId=n}}class ai extends Ot{constructor(e){super(we(re({},e),{constraint:new k(e.coordinateHelper,e.edgeStart,e.edgeEnd)}))}get hints(){return[new H(b.REFERENCE,this.constraint.start,this.constraint.end,this.elevationInfo)]}}class qn extends Ot{constructor(e){super(we(re({},e),{constraint:new Me(e.coordinateHelper,e.targetPoint)}))}get hints(){return[new rt(this.targetPoint,this.elevationInfo)]}}let Q=class extends $e{constructor(t){super(t),this.availability=0,this._ids=new Set,this.tmpP=w()}destroy(){this.workerHandle.destroy(),this.workerHandle=null}initialize(){this.workerHandle=new Wn(this.schedule,{fetchAllEdgeLocations:(t,e)=>this._fetchAllEdgeLocations(t,e)})}async fetchCandidates(t,e){const i=t.coordinateHelper.toXYZ(t.point);this.view.renderCoordsHelper.toRenderCoords(i,t.coordinateHelper.spatialReference,i);const n=typeof t.distance=="number"?t.distance:t.distance.pixelSize,s=await this.workerHandle.invoke({bounds:Ai(i[0],i[1],i[2],n),types:t.types},e),r=t.coordinateHelper;return s.candidates.sort((o,l)=>o.distance-l.distance),s.candidates.map(o=>this._convertCandidate(r,o))}async add(t,e){this._ids.add(t.id),await this.workerHandle.invokeMethod("add",t,e)}async remove(t,e){this._ids.delete(t.id),await this.workerHandle.invokeMethod("remove",t,e)}_convertCandidate(t,e){switch(e.type){case"edge":return new ai({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),edgeStart:this._convertRenderCoordinate(t,e.start),edgeEnd:this._convertRenderCoordinate(t,e.end),elevationInfo:Dt});case"vertex":return new qn({coordinateHelper:t,objectId:e.objectId,targetPoint:this._convertRenderCoordinate(t,e.target),elevationInfo:Dt})}}_convertRenderCoordinate(t,e){return this.view.renderCoordsHelper.fromRenderCoords(e,this.tmpP,t.spatialReference),t.fromXYZ(this.tmpP)}async _fetchAllEdgeLocations(t,e){const i=[],n=[];for(const{id:s,uid:r}of t.components)this._ids.has(s)&&i.push((async()=>{const o=await this.fetchEdgeLocations(s,e.signal);return n.push(o.locations.buffer),{id:s,uid:r,objectIds:o.objectIds,locations:o.locations.buffer,origin:o.origin,type:o.type}})());return{result:{components:(await Promise.all(i)).filter(({id:s})=>this._ids.has(s))},transferList:n}}};a([d({constructOnly:!0})],Q.prototype,"view",void 0),a([d({constructOnly:!0})],Q.prototype,"fetchEdgeLocations",void 0),a([d({constructOnly:!0})],Q.prototype,"schedule",void 0),a([d({readOnly:!0})],Q.prototype,"availability",void 0),Q=a([S("esri.views.interactive.snapping.featureSources.sceneLayerSource.SceneLayerSnappingSourceWorker")],Q);class Wn extends zi{constructor(e,i){super("SceneLayerSnappingSourceWorker","fetchCandidates",{},e,{strategy:"dedicated",client:i})}}let J=class extends $e{constructor(t){super(t),this.availability=1,this.abortController=new AbortController}get updating(){return this.updatingHandles.updating}get layer(){return this.layerSource.layer}destroy(){this.abortController=_e(this.abortController)}initialize(){const t=this.view.resourceController;this.edgeWorker=new ji(e=>t.schedule(e)),this.workerHandle=new Q({view:this.view,schedule:e=>t.schedule(e),fetchEdgeLocations:async(e,i)=>{if(m(this.tracker))throw new Error("tracker-not-initialized");return this.tracker.fetchEdgeLocations(e,this.edgeWorker,i)}}),this.updatingHandles.addPromise(this._setupLayerView()),this.handles.add([$(this.workerHandle),$(this.edgeWorker)])}async fetchCandidates(t,e){return this.workerHandle.fetchCandidates(t,e)}refresh(){}async _setupLayerView(){const t=await this.view.whenLayerView(this.layer);if(t.type==="scene-layer-graphics-3d")return;const e={add:(i,n)=>this.updatingHandles.addPromise(this.workerHandle.add({id:i,bounds:n},this.abortController.signal)),remove:i=>this.updatingHandles.addPromise(this.workerHandle.remove({id:i},this.abortController.signal))};this.tracker=t.trackSnappingSources(e),this.handles.add(this.tracker)}};a([d({constructOnly:!0})],J.prototype,"layerSource",void 0),a([d({constructOnly:!0})],J.prototype,"view",void 0),a([d({readOnly:!0})],J.prototype,"updating",null),a([d({readOnly:!0})],J.prototype,"availability",void 0),J=a([S("esri.views.interactive.snapping.featureSources.SceneLayerSnappingSource")],J);let K=class extends F{constructor(t){super(t),this.options=null,this._snappingSources=new Ve}initialize(){this.own([this.view.on("layerview-create",({layerView:t})=>this._createSource(t)),this.view.on("layerview-destroy",({layerView:t})=>this._removeSource(t))]);for(const t of this.view.allLayerViews.items)this._createSource(t)}destroy(){this.options=null,this._snappingSources.drain(t=>t.destroy())}get updating(){return this._snappingSources.some(t=>t.updating)}get _types(){return et.EDGE|et.VERTEX}async fetchCandidates(t,e,i){const{view:n,options:s}=this,{coordinateHelper:r,elevationInfo:o}=e,l=f(s)?s.distance:1,h=te(t,r,o,n,pe.get()),c=l*n.state.camera.computeScreenPixelSizeAt(h),u=this._types,g=this._snappingSources.items.map(_=>_.fetchCandidates({point:t,coordinateHelper:r,distance:c,types:u},i)),p=(await Promise.all(g)).flat();return it(t,p),p}_createSource(t){if(t.type!=="scene-layer-3d")return;const e=new J({layerSource:new oi({layer:t.layer}),view:this.view});this._snappingSources.push(e)}_removeSource(t){const e=this._snappingSources.findIndex(i=>i.layerSource.layer===t.layer);e!==-1&&this._snappingSources.removeAt(e).destroy()}};a([d({constructOnly:!0})],K.prototype,"view",void 0),a([d()],K.prototype,"updating",null),a([d()],K.prototype,"options",void 0),a([d()],K.prototype,"_snappingSources",void 0),K=a([S("esri.views.interactive.snapping.SceneSnappingEngine")],K);class li extends ve{constructor({coordinateHelper:e,targetPoint:i,constraint:n,previousVertex:s,otherVertex:r,otherVertexType:o,objectId:l,elevationInfo:h}){super(e,i,n,h),this.previousVertex=s,this.otherVertex=r,this.otherVertexType=o,this.objectId=l}get hints(){const e=this.previousVertex,i=this.otherVertexType===me.CENTER?this.otherVertex:this.targetPoint,n=this.otherVertexType===me.CENTER?this.targetPoint:this.otherVertex,s=this.elevationInfo;return[new H(b.TARGET,i,n,s),new H(b.REFERENCE,e,i,s),new Le(this.previousVertex,i,n,s)]}}var me;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(me||(me={}));let q=class extends $e{constructor(t){super(t),this.options=null,this.sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null}}}get updating(){return Fi(this.snappingSources,({snappingSource:t})=>t.updating)||this.updatingHandles.updating}get snappingSources(){const t=this._get("snappingSources")||new Map,e=new Map;if(f(this.options)&&f(this.options.featureSources))for(const i of this.options.featureSources.items){const n=i.layer.uid,s=t.get(n);if(s){t.delete(n),e.set(n,s);continue}if(!i.layer.loaded){this.updatingHandles.addPromise(i.layer.load());continue}const r=this._createSourceInfo(i);f(r)&&e.set(n,r)}for(const[,i]of t)i.destroy();return e}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Je),f(this.view)&&this.handles.add([this.view.on("layerview-create",t=>this._updateLayerView(t.layer,t.layerView)),this.view.on("layerview-destroy",t=>this._updateLayerView(t.layer,null))])}_updateLayerView(t,e){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===t&&(i.layerView=e)}destroy(){this._set("options",null);for(const[,t]of this.snappingSources)t.destroy()}async fetchCandidates(t,e,i){if(m(this.options)||!this.options.effectiveFeatureEnabled)return[];const n=[],s=this._computeScreeenSizeDistanceParameters(t,e),r={distance:s,point:t,coordinateHelper:e.coordinateHelper,types:this.types,filter:null};for(const[,{snappingSource:l,layerView:h}]of this.snappingSources)!l.layerSource.enabled||f(h)&&h.suspended||n.push(l.fetchCandidates(r,i).then(c=>c.filter(u=>!this._candidateIsExcluded(l,u,e.excludeFeature))));const o=(await Gi(n)).flat();return this._addRightAngleCandidates(o,t,s,e),qi(i),it(t,o),o}_addRightAngleCandidates(t,e,i,n){var l,h,c,u,g,p,_,O;const s=f(n.vertexHandle)?(h=(l=n.vertexHandle.rightEdge)==null?void 0:l.rightVertex)==null?void 0:h.pos:f(n.editGeometryOperations)&&n.editGeometryOperations.data.type==="polygon"?(u=Y((c=n.editGeometryOperations.data.components[0])==null?void 0:c.getFirstVertex()))==null?void 0:u.pos:null,r=f(n.vertexHandle)?(p=(g=n.vertexHandle.leftEdge)==null?void 0:g.leftVertex)==null?void 0:p.pos:f(n.editGeometryOperations)?(O=Y((_=n.editGeometryOperations.data.components[0])==null?void 0:_.getLastVertex()))==null?void 0:O.pos:null,o=t.length;for(let E=0;E<o;E++)this._addRightAngleCandidate(t[E],r,e,i,n,t),this._addRightAngleCandidate(t[E],s,e,i,n,t)}_addRightAngleCandidate(t,e,i,n,s,r){if(m(e)||!(t instanceof ai))return;const o=t.constraint.closestTo(e),l=(o[0]-i[0])/n.x,h=(o[1]-i[1])/n.y;if(l*l+h*h<=1){const c=s.coordinateHelper;r.push(new li({coordinateHelper:c,targetPoint:o,otherVertex:e,otherVertexType:me.NEXT,previousVertex:t.constraint.start,constraint:new at(c,e,o),objectId:t.objectId,elevationInfo:t.elevationInfo}))}}_computeScreeenSizeDistanceParameters(t,e){const i=f(this.options)?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;if(m(this.view))return{x:i,y:i,pixelSize:i};if(this.view.type==="2d"){const n=i*this.view.resolution;return{x:n,y:n,pixelSize:n}}return this._computeScreenSizeDistanceParameters3D(t,i,this.view,e)}_computeScreenSizeDistanceParameters3D(t,e,i,n){const{coordinateHelper:s,elevationInfo:r}=n,o=i.state.camera.computeScreenPixelSizeAt(te(t,s,r,i,Un)),l=o*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,h=e*l;return{x:h/this._computeScreenMagnitudeOfMapOffset(t,l,0,i,n),y:h/this._computeScreenMagnitudeOfMapOffset(t,0,l,i,n),pixelSize:o}}_computeScreenMagnitudeOfMapOffset(t,e,i,n,{coordinateHelper:s,elevationInfo:r}){const o=s.clone(t);o[0]+=e,o[1]+=i;const l=x(t,s,r,n),h=x(o,s,r,n),c=h.x-l.x,u=h.y-l.y;return Math.sqrt(c*c+u*u)}get types(){return et.EDGE|et.VERTEX}_candidateIsExcluded(t,e,i){if(m(i))return!1;const n=this._getCandidateObjectId(e);if(m(n))return!1;const s=t.layerSource.layer;return s.type==="graphics"?i.uid===n:i.sourceLayer===s&&!(!i.attributes||!("objectIdField"in s))&&i.attributes[s.objectIdField]===n}_getCandidateObjectId(t){return t instanceof Ot?t.objectId:null}_createSourceInfo(t){const e=this._createFeatureSnappingSourceType(t);if(m(e))return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const i=f(this.view)?this.view.allLayerViews.find(n=>n.layer===t.layer):null;return new Yn(e.source,i)}_createFeatureSnappingSourceType(t){switch(t.layer.type){case"feature":case"geojson":case"csv":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(t);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(t)}return null}_createFeatureSnappingSourceFeatureLayer(t){switch(t.layer.source.type){case"feature-layer":{const e=this._getSourceModule("featureService");return f(e.module)?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(t.layer.geometryType==="mesh")return null;const e=this._getSourceModule("featureCollection");return f(e.module)?{source:new e.module.FeatureCollectionSnappingSource({layerSource:t})}:{loading:e.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(t){const e=this._getSourceModule("graphics");return f(e.module)?{source:new e.module.GraphicsSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:t})}:{loading:e.loader}}_getSourceModule(t){const e=this.sourceModules[t];if(m(e.loader)){const i=this._loadSourceModule(t).then(n=>{e.module=n});return e.loader=i,{module:e.module,loader:i}}return{module:e.module,loader:e.loader}}_loadSourceModule(t){switch(t){case"featureService":return this.updatingHandles.addPromise(import("./FeatureServiceSnappingSource.ce95294f.js"));case"featureCollection":return this.updatingHandles.addPromise(import("./FeatureCollectionSnappingSource.0ca2e470.js"));case"graphics":return this.updatingHandles.addPromise(import("./GraphicsSnappingSource.a84d3731.js"))}return null}};a([d({constructOnly:!0})],q.prototype,"spatialReference",void 0),a([d({constructOnly:!0})],q.prototype,"view",void 0),a([d()],q.prototype,"options",void 0),a([d({readOnly:!0})],q.prototype,"updating",null),a([d({readOnly:!0})],q.prototype,"snappingSources",null),q=a([S("esri.views.interactive.snapping.FeatureSnappingEngine")],q);class Yn{constructor(e,i){this.snappingSource=e,this.layerView=i,this.handles=new tt;const n=this.snappingSource.layerSource.layer;if("refresh"in n){const s=n;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([C(()=>e.updating,s=>e.layerSource.updating=s,Oe),C(()=>e.availability,s=>e.layerSource.availability=s,Oe)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}const Un=w();class lt{constructor(e,i){this.view=e,this.options=i,this.squaredShortLineThreshold=y.shortLineThreshold*y.shortLineThreshold}snap(e,i){return f(i.vertexHandle)?i.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,i):this.snapNewVertex(e,i)}edgeExceedsShortLineThreshold(e,i){return this.exceedsShortLineThreshold(e.leftVertex.pos,e.rightVertex.pos,i)}exceedsShortLineThreshold(e,i,{elevationInfo:n,editGeometryOperations:s}){const r=s.data.coordinateHelper;return this.squaredShortLineThreshold===0||ne(x(i,r,n,this.view),x(e,r,n,this.view))>this.squaredShortLineThreshold}squaredProximityTreshold(e){return e==="touch"?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:i}=this.options,n=e*i;return n*n}}class Xn extends ve{constructor({coordinateHelper:e,lineStart:i,lineEnd:n,targetPoint:s,elevationInfo:r}){super(e,s,new k(e,i,n),r),this.referenceLineHint=new H(b.REFERENCE_EXTENSION,i,n,r)}get hints(){return[this.referenceLineHint,new H(b.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.elevationInfo)]}_lineEndClosestToTarget(){const e=this.constraint.start,i=this.constraint.end;return Math.sign(Ct(U(Bn,i,e),U(Zn,this.targetPoint,e)))>0?i:e}}const Zn=D(),Bn=D();class Qn extends lt{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=[];if(s<1)return r;const o=i.coordinateHelper,l=x(e,o,i.elevationInfo,this.view),h=n.edges[s-1];let c=h;do this.edgeExceedsShortLineThreshold(c,i)&&this._processCandidateProposal(c.leftVertex.pos,c.rightVertex.pos,e,l,i,r),c=c.leftVertex.leftEdge;while(c&&c!==h);return r}snapExistingVertex(e,i){const n=[],s=Y(i.vertexHandle),r=s.component;if(r.edges.length<2)return n;const o=i.coordinateHelper,l=x(e,o,i.elevationInfo,this.view),h=s.leftEdge,c=s.rightEdge;h&&c&&this.edgeExceedsShortLineThreshold(h,i)&&this.edgeExceedsShortLineThreshold(c,i)&&this._processCandidateProposal(h.leftVertex.pos,c.rightVertex.pos,e,l,i,n);const u=r.edges[0];let g=u;do g!==s.leftEdge&&g!==s.rightEdge&&this.edgeExceedsShortLineThreshold(g,i)&&this._processCandidateProposal(g.leftVertex.pos,g.rightVertex.pos,e,l,i,n),g=g.rightVertex.rightEdge;while(g&&g!==u);return n}_processCandidateProposal(e,i,n,s,r,o){const l=Te(D(),n,e,i),{coordinateHelper:h,elevationInfo:c,pointer:u}=r,g=h.fromXYZ(l,h.getZ(n,0));ne(s,x(g,h,c,this.view))<this.squaredProximityTreshold(u)&&o.push(new Xn({coordinateHelper:h,lineStart:e,lineEnd:i,targetPoint:g,elevationInfo:c}))}}class Jn extends ve{constructor({coordinateHelper:e,referenceLine:i,lineStart:n,targetPoint:s,elevationInfo:r}){const o=e.clone(n);U(o,Se(o,o,i.rightVertex.pos),i.leftVertex.pos),super(e,s,new k(e,n,o),r),this._referenceLines=[{edge:i,fadeLeft:!0,fadeRight:!0}]}get hints(){const e=this.elevationInfo;return[new H(b.TARGET,this.constraint.start,this.targetPoint,e),new st(this.constraint.start,this.targetPoint,e),...this._referenceLines.map(i=>new H(b.REFERENCE,i.edge.leftVertex.pos,i.edge.rightVertex.pos,e,i.fadeLeft,i.fadeRight))]}addReferenceLine(e){const i={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(n=>{e.rightVertex.rightEdge===n.edge&&(n.fadeLeft=!1,i.fadeRight=!1),e.leftVertex.leftEdge===n.edge&&(n.fadeRight=!1,i.fadeLeft=!1)}),this._referenceLines.push(i)}}class Kn extends lt{constructor(){super(...arguments),this._tmpProjection=D()}snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.edges.length,r=n.vertices.length,o=[];if(s<2)return o;const l=x(e,i.coordinateHelper,i.elevationInfo,this.view),h=n.vertices[r-1],c=n.vertices[0],u=n.edges[s-1];let g=u;do this.edgeExceedsShortLineThreshold(g,i)&&(this._checkEdgeForParalleLines(g,h.pos,e,l,i,o),this._checkEdgeForParalleLines(g,c.pos,e,l,i,o)),g=g.leftVertex.leftEdge;while(g&&g!==u);return o}snapExistingVertex(e,i){const n=[],s=Y(i.vertexHandle),r=s.component;if(r.edges.length<3)return n;const o=x(e,i.coordinateHelper,i.elevationInfo,this.view),l=s.leftEdge,h=s.rightEdge,c=r.vertices[0],u=r.vertices.length,g=r.vertices[u-1],p=r.edges[0];let _=p;do _!==l&&_!==h&&this.edgeExceedsShortLineThreshold(_,i)&&(l&&this._checkEdgeForParalleLines(_,l.leftVertex.pos,e,o,i,n),h&&this._checkEdgeForParalleLines(_,h.rightVertex.pos,e,o,i,n),s===c?this._checkEdgeForParalleLines(_,g.pos,e,o,i,n):s===g&&this._checkEdgeForParalleLines(_,c.pos,e,o,i,n)),_=_.rightVertex.rightEdge;while(_&&_!==p);return n}_checkEdgeForParalleLines(e,i,n,s,r,o){const l=e.leftVertex.pos,h=e.rightVertex.pos;if(Te(this._tmpProjection,i,l,h),fe(this._tmpProjection,i)<y.parallelLineThreshold)return;Te(this._tmpProjection,n,l,h,i);const{coordinateHelper:c,elevationInfo:u,pointer:g}=r,p=c.fromXYZ(this._tmpProjection,c.getZ(n,0));if(ne(s,x(p,c,u,this.view))<this.squaredProximityTreshold(g)){if(this._parallelToPreviousCandidate(e,o))return;o.push(new Jn({coordinateHelper:c,referenceLine:e,lineStart:i,targetPoint:p,elevationInfo:u}))}}_parallelToPreviousCandidate(e,i){const n=e.leftVertex.pos,s=e.rightVertex.pos;for(const r of i)if(Te(this._tmpProjection,s,r.constraint.start,r.constraint.end,n),fe(this._tmpProjection,s)<y.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}class es extends lt{constructor(){super(...arguments),this._tmp=D()}snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=n.vertices.length,r=[];if(s<2)return r;const o=x(e,i.coordinateHelper,i.elevationInfo,this.view),l=n.vertices[s-1];this._checkForSnappingCandidate(r,l.leftEdge,l.pos,e,l.leftEdge.leftVertex.pos,l.pos,i,e,o);const h=n.vertices[0];return this._checkForSnappingCandidate(r,h.rightEdge,h.pos,e,h.rightEdge.rightVertex.pos,h.pos,i,e,o),r}snapExistingVertex(e,i){const n=[],s=Y(i.vertexHandle),r=s.component,o=r.vertices.length;if(o<3)return n;const l=x(e,i.coordinateHelper,i.elevationInfo,this.view),h=s.leftEdge,c=s.rightEdge,u=r.vertices[0],g=r.vertices[o-1];if(!h)return this._checkForSnappingCandidate(n,u.rightEdge.rightVertex.rightEdge,u.rightEdge.rightVertex.pos,e,u.rightEdge.rightVertex.rightEdge.rightVertex.pos,u.rightEdge.rightVertex.pos,i,e,l),n;if(!c)return this._checkForSnappingCandidate(n,g.leftEdge.leftVertex.leftEdge,g.leftEdge.leftVertex.pos,e,g.leftEdge.leftVertex.leftEdge.leftVertex.pos,g.leftEdge.leftVertex.pos,i,e,l),n;if(h&&h.leftVertex.leftEdge){const p=h.leftVertex.leftEdge;this._checkForSnappingCandidate(n,p,h.leftVertex.pos,e,p.leftVertex.pos,h.leftVertex.pos,i,e,l)}if(c&&c.rightVertex.rightEdge){const p=c.rightVertex.rightEdge;this._checkForSnappingCandidate(n,p,c.rightVertex.pos,e,p.rightVertex.pos,c.rightVertex.pos,i,e,l)}return n}_checkForSnappingCandidate(e,i,n,s,r,o,l,h,c){if(!this.edgeExceedsShortLineThreshold(i,l))return;U(this._tmp,i.rightVertex.pos,i.leftVertex.pos);const u=Wi(this._tmp[1],-this._tmp[0]),g=Ct(u,U(this._tmp,s,n))/Yi(u),{coordinateHelper:p,elevationInfo:_,pointer:O}=l,E=p.fromXYZ(Ht(D(),o,u,g),p.getZ(h,0));ne(c,x(E,p,_,this.view))<this.squaredProximityTreshold(O)&&e.push(new li({coordinateHelper:p,targetPoint:E,constraint:new at(p,o,Ht(p.createVector(),o,u,Math.sign(g))),previousVertex:r,otherVertex:o,otherVertexType:me.CENTER,elevationInfo:_}))}}class ts extends ve{constructor({coordinateHelper:e,targetPoint:i,point1:n,point2:s,elevationInfo:r}){super(e,i,new Ie(e,Xt(is,n,s,.5),.5*Zt(n,s)),r),this.p1=n,this.p2=s}get hints(){const e=this.elevationInfo;return[new H(b.REFERENCE,this.targetPoint,this.p1,e),new H(b.REFERENCE,this.targetPoint,this.p2,e),new Le(this.p1,this.targetPoint,this.p2,e)]}}const is=D();class ns extends lt{snapNewVertex(e,i){const n=i.editGeometryOperations.data.components[0],s=[],r=n.vertices.length;if(i.editGeometryOperations.data.type!=="polygon"||r<2)return s;const o=n.vertices[0],l=n.vertices[r-1];return this._processCandidateProposal(o.pos,l.pos,e,i,s),s}snapExistingVertex(e,i){const n=[],s=Y(i.vertexHandle),r=s.component;return r.edges.length<2||(i.editGeometryOperations.data.type!=="polyline"||s.index!==0&&s.index!==r.vertices.length-1)&&this._processCandidateProposal(s.leftEdge.leftVertex.pos,s.rightEdge.rightVertex.pos,e,i,n),n}_processCandidateProposal(e,i,n,s,r){if(!this.exceedsShortLineThreshold(e,i,s))return;const o=Xt(D(),e,i,.5),l=.5*Zt(e,i),h=ri(D(),n,o,l),{coordinateHelper:c,elevationInfo:u,pointer:g}=s,p=c.fromXYZ(h,c.getZ(n,0)),_=x(n,c,u,this.view);ne(_,x(p,c,u,this.view))<this.squaredProximityTreshold(g)&&r.push(new ts({coordinateHelper:c,targetPoint:p,point1:e,point2:i,elevationInfo:u}))}}let le=class extends F{constructor(t){super(t),this.updating=!1,this._snappers=new Ve}initialize(){this._snappers.push(new Kn(this.view,this.options),new Qn(this.view,this.options),new es(this.view,this.options),new ns(this.view,this.options))}set options(t){this._set("options",t);for(const e of this._snappers)e.options=t}async fetchCandidates(t,e){if(!this.options.effectiveSelfEnabled)return[];const i=[];for(const n of this._snappers.items)i.push(...n.snap(t,e));return it(t,i),i}};a([d({readOnly:!0})],le.prototype,"updating",void 0),a([d({constructOnly:!0})],le.prototype,"view",void 0),a([d()],le.prototype,"options",null),le=a([S("esri.views.interactive.snapping.SelfSnappingEngine")],le);function ss(t,e){return[new le({view:t,options:e}),new q({view:t,options:e,spatialReference:t.spatialReference})]}let P=class extends F{constructor(t){super(t),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Ve,this.distance=y.distance,this.touchSensitivityMultiplier=y.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};a([d()],P.prototype,"enabled",void 0),a([d()],P.prototype,"enabledToggled",void 0),a([d()],P.prototype,"selfEnabled",void 0),a([d()],P.prototype,"featureEnabled",void 0),a([d({type:Ve.ofType(oi)})],P.prototype,"featureSources",void 0),a([d()],P.prototype,"distance",void 0),a([d()],P.prototype,"touchSensitivityMultiplier",void 0),a([d({readOnly:!0})],P.prototype,"effectiveEnabled",null),a([d({readOnly:!0})],P.prototype,"effectiveSelfEnabled",null),a([d({readOnly:!0})],P.prototype,"effectiveFeatureEnabled",null),P=a([S("esri.views.interactive.snapping.SnappingOptions")],P);const rs=P;class Fe extends ve{constructor(e,i,n,s,r){super(e,i,new ye(e,i,n.constraint,s.constraint),r),this.first=n,this.second=s}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new nt(this.targetPoint,this.elevationInfo)]}}let z=class extends Ui.EventedMixin($e){constructor(t){super(t),this.options=new rs,this.snappingEnginesFactory=ss,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}initialize(){this.handles.add([C(()=>{const{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}=this.options;return{effectiveFeatureEnabled:t,effectiveSelfEnabled:e,touchSensitivityMultiplier:i,distance:n}},()=>{this.doneSnapping(),this.emit("changed")},Je),C(()=>this.options,t=>{for(const e of this._engines)e.options=t},Je),C(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:t,snappingEnginesFactory:e})=>this._recreateEngines(t,e),Oe)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(t=>t.updating)}_recreateEngines(t,e){if(this._destroyEngines(),!t)return;const{view:i,options:n}=this;this._engines=e(i,n)}_destroyEngines(){for(const t of this._engines)t.destroy();this._engines=[]}get squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get squaredTouchProximityThreshold(){const{distance:t,touchSensitivityMultiplier:e}=this.options,i=t*e;return i*i}async snap(t,e,i){const n=e.coordinateHelper.pointToVector(t),s=await this._fetchCandidates(n,e,i);return{get valid(){return!Xi(i)},apply:()=>{const{snappedPoint:r,hints:o}=this._processCandidates(n,s,e);return this._removeVisualization(),f(e.visualizer)&&this.handles.add(e.visualizer.draw(o,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),Ge),r}}}update(t,e){this._removeVisualization();let i=t;const n=[];if(f(this._currentMainCandidate)){const s=e.coordinateHelper,r=s.pointToVector(t),o=this._currentMainCandidate.constraint.closestTo(r);if(ne(x(r,s,e.elevationInfo,this.view),x(o,s,e.elevationInfo,this.view))<this._squaredPointProximityThreshold(e.pointer)){i=s.vectorToDehydratedPoint(o),this._currentMainCandidate.targetPoint=o,n.push(...this._currentMainCandidate.hints);for(const l of this._currentOtherActiveCandidates)l.targetPoint=o,n.push(...l.hints)}else this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}return f(e.visualizer)&&this.handles.add(e.visualizer.draw(n,{coordinateHelper:e.coordinateHelper,elevationInfo:e.elevationInfo,view:this.view}),Ge),i}doneSnapping(){this._removeVisualization(),this._currentMainCandidate=null,this._currentOtherActiveCandidates=[]}_removeVisualization(){this.handles.remove(Ge)}async _fetchCandidates(t,e,i){return(await Promise.all(this._engines.map(n=>n.fetchCandidates(t,e,i)))).flat()}_processCandidates(t,e,i){if(e.length<1)return this.doneSnapping(),{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(t),hints:[]};it(t,e);const n=this._currentMainCandidate;if(f(n)){const s=this._findOldConstraintInNewCandidates(n,e);if(s>=0){if(!(e[s]instanceof Fe))return this._intersectWithOtherCandidates(s,e,t,i);if(fe(t,n.targetPoint)<this._squaredPointProximityThreshold(i.pointer))return this._updateSnappingCandidate(n,e,i)}}return this._intersectWithOtherCandidates(0,e,t,i)}_findOldConstraintInNewCandidates(t,e){return t instanceof Fe?this._findOldCandidateIndex(e,t.first)>=0&&this._findOldCandidateIndex(e,t.second)>=0?0:-1:this._findOldCandidateIndex(e,t)}_intersectWithOtherCandidates(t,e,i,n){const s=e[t],r=[],o=n.coordinateHelper;for(let l=0;l<e.length;++l){if(l===t)continue;const h=e[l];for(const c of s.constraint.intersect(h.constraint)){const u=o.fromXYZ(c.intersection,s.targetPoint[2]);r.push([new Fe(o,u,s,h,h.elevationInfo),ne(x(i,n.coordinateHelper,n.elevationInfo,this.view),x(u,n.coordinateHelper,n.elevationInfo,this.view))])}}return r.length>0&&(r.sort((l,h)=>l[1]-h[1]),r[0][1]<this._squaredPointProximityThreshold(n.pointer))?this._updateSnappingCandidate(r[0][0],e,n):this._updateSnappingCandidate(s,e,n)}_updateSnappingCandidate(t,e,i){this.doneSnapping(),this._currentMainCandidate=t;const n=this._currentMainCandidate.targetPoint,s=[];s.push(...t.hints);for(const r of e){if(t instanceof Fe){if(r.constraint.objectEqual(t.first.constraint)||r.constraint.objectEqual(t.second.constraint))continue}else if(r.constraint.objectEqual(t.constraint))continue;r.constraint.check(n)&&(r.targetPoint=n,this._currentOtherActiveCandidates.push(r),s.push(...r.hints))}return{snappedPoint:i.coordinateHelper.vectorToDehydratedPoint(n),hints:s}}_squaredPointProximityThreshold(t){return t==="touch"?this.squaredTouchProximityThreshold:this.squaredMouseProximityTreshold}_findOldCandidateIndex(t,e){let i=-1;for(let n=0;n<t.length;++n)if(e.constraint.objectEqual(t[n].constraint)){i=n;break}return i}get test(){return{visualizationsActive:this.handles.has(Ge),engines:this._engines}}};a([d({constructOnly:!0})],z.prototype,"view",void 0),a([d()],z.prototype,"options",void 0),a([d({readOnly:!0})],z.prototype,"updating",null),a([d()],z.prototype,"snappingEnginesFactory",void 0),a([d()],z.prototype,"_engines",void 0),a([d()],z.prototype,"squaredMouseProximityTreshold",null),a([d()],z.prototype,"squaredTouchProximityThreshold",null),z=a([S("esri.views.interactive.snapping.SnappingManager")],z);const Ge="visualization-handle",Ze=new Map;function os(t){Ze.has(t)||Ze.set(t,{referenceCount:0,snappingManager:ls(t)});const e=Ze.get(t);e.referenceCount++;const i=Zi(()=>as(t,e));return re({snappingManager:e.snappingManager},i)}function as(t,e){e.referenceCount--,e.referenceCount>0||Bi(()=>{e.referenceCount===0&&(e.snappingManager.destroy(),Ze.delete(t))})}function ls(t){return new z({view:t,snappingEnginesFactory:(e,i)=>[new K({view:t,options:i})]})}class di{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.visualizer=e.visualizer}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}}class ds{constructor(){this.next=new It}createSnapDragEventPipelineStep({predicate:e=()=>!0,cancel:i,snappingManager:n,snappingContext:s,updatingHandles:r}){if(m(n))return p=>p;let o=null,l=null;const h=()=>{o=_e(o),n.doneSnapping(),f(l)&&l.frameTask.remove(),l=null};i.next(p=>(h(),p)),this.next=new It;const c=Kt(async({frameTask:p,point:_,context:O,event:E,dx:dt,dy:ht},X)=>{const ke=await p.schedule(()=>n.snap(_,O,X),X);if(ke.valid){let De=await p.schedule(()=>ke.apply(),X);_!==u&&(De=n.update(u,O)),Qi(De,g)||(E.mapEnd.x=De.x+dt,E.mapEnd.y=De.y+ht,this.next.execute(E))}});let u,g;return p=>{if(!e(p))return p;if(p.action==="start"){const _=n.view.type==="3d"?n.view.resourceController.scheduler.registerTask(Bt.SNAPPING):Qt;l={context:new di({editGeometryOperations:s.editGeometryOperations,elevationInfo:s.elevationInfo,pointer:s.pointer,vertexHandle:f(p.info)?p.info.handle:null,excludeFeature:s.excludeFeature,visualizer:s.visualizer}),originalPos:f(p.snapOrigin)?s.coordinateHelper.vectorToDehydratedPoint(p.snapOrigin):p.mapStart,frameTask:_}}if(f(l)){const _=l.context.coordinateHelper.vectorToDehydratedPoint(l.context.coordinateHelper.arrayToVector([l.originalPos.x,l.originalPos.y,l.originalPos.z]));_.x+=p.mapEnd.x-p.mapStart.x,_.y+=p.mapEnd.y-p.mapStart.y;const O=p.mapStart.x-l.originalPos.x,E=p.mapStart.y-l.originalPos.y,dt=we(re({},p),{action:"update"}),ht=l.context,X=n.update(_,l.context);if(g=X,p.mapEnd.x=X.x+O,p.mapEnd.y=X.y+E,u=_,p.action!=="end"){const ke=l.frameTask;f(o)||(o=new AbortController),r.addPromise(Jt(c({frameTask:ke,event:dt,context:ht,point:_,dx:O,dy:E},o.signal)))}}return p.action==="end"&&h(),p}}}let Ee=class extends F{constructor(t){super(t),this.stagedPoint=null,this._abortController=null,this._snap=Kt(async(e,i,n,s)=>{const r=await this._frameTask.schedule(()=>i.snap(e,n,s),s);r.valid&&await this._frameTask.schedule(()=>{this.stagedPoint=r.apply(),e!==this._snapMapPoint&&(this.stagedPoint=i.update(this._snapMapPoint,n))},s)})}initialize(){var e,i;const t=this.view.type==="3d"?(i=(e=this.view)==null?void 0:e.resourceController)==null?void 0:i.scheduler:null;this._frameTask=f(t)?t.registerTask(Bt.SNAPPING):Qt}destroy(){this._abortController=_e(this._abortController),this._frameTask=Ji(this._frameTask)}async snap(t,e,i){return this.stagedPoint=e.update(t,i),this._snapMapPoint=t,m(this._abortController)&&(this._abortController=new AbortController),this._snap(t,e,i,this._abortController.signal)}abort(){this._abortController=_e(this._abortController)}};a([d({constructOnly:!0})],Ee.prototype,"view",void 0),a([d()],Ee.prototype,"stagedPoint",void 0),Ee=a([S("esri.views.interactive.snapping.SnappingOperation")],Ee);let de=class extends $e{constructor(t){super(t),this.stagedDimension=null,this._dimensionManipulators=new Map,this._dimensionHandles=new tt,this._snappingPipeline=new ds,this._snappingManagerResult=os(t.view),this.own(this._snappingManagerResult)}initialize(){this._snappingOperation=new Ee({view:this.view}),this.own([this._dimensionHandles,C(()=>this._snappingOperation.stagedPoint,t=>{f(this.stagedDimension)&&(this.stagedDimension.endPoint=Ki(t,e=>Ne(e,new ce)))},Je)])}destroy(){this._snappingOperation=Pt(this._snappingOperation)}get updating(){return this.updatingHandles.updating||this._snappingManager.updating}get _snappingManager(){return this._snappingManagerResult.snappingManager}addDimension(t,e){if(this._dimensionManipulators.has(t))return;const i=this._createPointManipulator(t,{isStart:!0}),n=this._createPointManipulator(t,{isStart:!1}),s={startManipulator:i,endManipulator:n};this._setupDimensionToManipulatorsSync(t,s),this._dimensionManipulators.set(t,s),e.add(i),e.add(n)}removeDimension(t,e){const i=this._dimensionManipulators.get(t);if(m(i))return;this._dimensionHandles.remove(t);const{startManipulator:n,endManipulator:s}=i;this._dimensionManipulators.delete(t),e.remove(n),e.remove(s)}getManipulatorsForDimension(t){return this._dimensionManipulators.get(t)}onDeactivate(){this._snappingManager.doneSnapping()}onUnstagedClick({mapPoint:t,pointerType:e}){const i=this._snappingContext(e),n=Ne(this._snappingManager.update(t,i),new ce),s=new Mn({startPoint:n,endPoint:null});return this.stagedDimension=s,this._snappingManager.doneSnapping(),s}onStagedClick({mapPoint:t,pointerType:e}){if(m(this.stagedDimension))return;const i=this._snappingContext(e),n=Ne(this._snappingManager.update(t,i),new ce);this.stagedDimension.endPoint=n,this.stagedDimension=null,this._snappingManager.doneSnapping()}onPointerMove({mapPoint:t,pointerType:e}){const i=this._snappingContext(e);this.updatingHandles.addPromise(Jt(this._snappingOperation.snap(t,this._snappingManager,i)))}_setupDimensionToManipulatorsSync(t,e){const{startManipulator:i,endManipulator:n}=e;this._dimensionHandles.add([C(()=>({startPoint:t.startPoint,endPoint:t.endPoint,stagedDimension:this.stagedDimension}),({startPoint:s,endPoint:r,stagedDimension:o})=>{f(s)?(i.available=m(o)||o===t,i.location=s):i.available=!1,f(r)?(n.available=m(o),n.location=r):n.available=!1},Oe)],t)}_createPointManipulator(t,e){const{isStart:i}=e,n=i?"startPoint":"endPoint",s=un(this.view,j.toUnitRGB(Ce.pointManipulators.color),Ce.pointManipulators.opacity);s.available=!1,s.radius=Ce.pointManipulators.radius;const r=gn(s,(o,l,h,c)=>{const u=Tn(o);l.next(u).next(Pn(this.view)).next(this._snappingPipeline.createSnapDragEventPipelineStep({snappingContext:this._snappingContext(c),snappingManager:this._snappingManager,cancel:h,updatingHandles:this.updatingHandles}),this._snappingPipeline.next).next(g=>{const p=Ne(g.mapEnd,new ce);t[n]=p}),h.next(u).next(fn(t,[n]))});return this._dimensionHandles.add(r,t),s}_snappingContext(t){return new di({elevationInfo:{mode:"absolute-height",offset:0},pointer:t,editGeometryOperations:new Rn(new $n("point",Vn(!0,!1,this.view.spatialReference))),visualizer:new Gn})}};a([d({constructOnly:!0,nonNullable:!0})],de.prototype,"view",void 0),a([d({readOnly:!0})],de.prototype,"updating",null),a([d()],de.prototype,"stagedDimension",void 0),de=a([S("esri.views.3d.analysis.Dimensioning.LengthDimensionSubTool")],de);var ge;(function(t){t.Ready="ready",t.Creating="creating",t.Created="created"})(ge||(ge={}));let T=class extends _n{constructor(t){super(t),this.preferManipulatorCursor=!0,this.analysisViewData=null}initialize(){this._intersector=en(this.view.state.viewingMode),this._intersector.options.store=tn.MIN,this._lengthDimensionSubTool=new de({view:this.view}),this.own($(this._lengthDimensionSubTool));for(const t of this.analysis.dimensions.items)this._addDimension(t);this.own(this.analysis.dimensions.on("change",t=>{for(const e of t.added)this._addDimension(e);for(const e of t.removed)this._removeDimension(e)})),this.own(C(()=>this.state,t=>{t===ge.Created&&this.finishToolCreation()},Oe))}get state(){return this.analysis.dimensions.some(t=>t.type==="length")?f(this._activeSubTool)?ge.Creating:ge.Created:ge.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}getManipulatorsForDimension(t){return this._lengthDimensionSubTool.getManipulatorsForDimension(t)}onInputEvent(t){switch(t.type){case"immediate-click":this._clickHandler(t);break;case"immediate-double-click":this._doubleClickHandler(t);break;case"pointer-move":this._pointerMoveHandler(t)}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){f(this._activeSubTool)&&(this._activeSubTool.onDeactivate(),f(this._activeSubTool.stagedDimension)&&(this.analysis.dimensions.remove(this._activeSubTool.stagedDimension),this._activeSubTool.stagedDimension=null),this._activeSubTool=null)}_clickHandler(t){if(m(this._activeSubTool))return;const e=this._intersectScreen(t);if(!m(e)){if(m(this._activeSubTool.stagedDimension)){const i=this._activeSubTool.onUnstagedClick({mapPoint:e,pointerType:t.pointerType});this.analysis.dimensions.add(i)}else this._activeSubTool.onStagedClick({mapPoint:e,pointerType:t.pointerType});t.stopPropagation()}}_doubleClickHandler(t){this.view.activeTool=null,t.stopPropagation()}_pointerMoveHandler(t){if(m(this._activeSubTool)||this.hasFocusedManipulators)return;const e=this._intersectScreen(t);m(e)||this._activeSubTool.onPointerMove({mapPoint:e,pointerType:t.pointerType})}_intersectScreen(t){const e=nn(t);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const i=this._intersector.results.min,n=pe.get();return i.getIntersectionPoint(n)?this.view.renderCoordsHelper.fromRenderCoords(n,this.view.spatialReference):null}_addDimension(t){this._lengthDimensionSubTool.addDimension(t,this.manipulators)}_removeDimension(t){this._lengthDimensionSubTool.removeDimension(t,this.manipulators)}};a([d({constructOnly:!0})],T.prototype,"view",void 0),a([d({constructOnly:!0})],T.prototype,"analysis",void 0),a([d({readOnly:!0})],T.prototype,"state",null),a([d({readOnly:!0})],T.prototype,"updating",null),a([d({readOnly:!0})],T.prototype,"cursor",null),a([d({readOnly:!0})],T.prototype,"preferManipulatorCursor",void 0),a([d({constructOnly:!0})],T.prototype,"analysisViewData",void 0),a([d()],T.prototype,"_activeSubTool",void 0),a([d()],T.prototype,"_lengthDimensionSubTool",void 0),T=a([S("esri.views.3d.analysis.Dimensioning.DimensioningTool")],T);let be=class extends F{constructor(t){super(t),this._directSegment=new xe,this._dimensionSegment=new xe,this._offsetAxis=w(),this._startOffsetSegment=new xe(this._directSegment.startRenderSpace,this._dimensionSegment.startRenderSpace),this._endOffsetSegment=new xe(this._directSegment.endRenderSpace,this._dimensionSegment.endRenderSpace),this._labelSegment=new xe,this._hasValidGeometry=!1;const e={view:t.view,attached:!0,width:1,color:sn(1,.5,0,1),renderOccluded:ie.OccludeAndTransparent},i=we(re({},e),{stipplePattern:an(5)});this._dimensionVisualElement=new yt(e),this._startOffsetVisualElement=new yt(i),this._endOffsetVisualElement=new yt(i),this._label=new En({view:t.view,attached:!0,distance:0,fontSize:Ce.labels.fontSize})}initialize(){this.own([$(this._dimensionVisualElement),$(this._startOffsetVisualElement),$(this._endOffsetVisualElement),$(this._label)]);const{computation:t,view:e}=this,{dimension:i}=t;this.own([C(()=>({startPoint:i.startPoint,endPoint:i.endPoint,offset:i.offset,axis:i.axis,heading:i.heading}),n=>{this._updateGeometry(n),this._updateLines(),this._updateLabelGeometry(e.state.camera)},gt),C(()=>t.length,n=>this._updateLabelContent(n),gt),C(()=>e.state.camera,n=>this._updateLabelGeometry(n),gt)])}get testInfo(){return{dimensionVisualElement:this._dimensionVisualElement,label:this._label}}_updateGeometry({startPoint:t,endPoint:e,offset:i,axis:n}){const{renderCoordsHelper:s}=this.view,r=this._directSegment;if(m(t)||m(e)||!s.toRenderCoords(t,r.startRenderSpace)||!s.toRenderCoords(e,r.endRenderSpace))return void(this._hasValidGeometry=!1);const{startRenderSpace:o,endRenderSpace:l}=r,h=r.eval(.5,pe.get()),c=s.worldUpAtPosition(h,pe.get()),u=s.worldBasisAtPosition(h,rn.X,pe.get()),g=this._offsetAxis;hs(g,o,l,c,n,u);const p=i/s.unitInMeters,[_,O]=cs(o,l,g,p),E=this._dimensionSegment;Ke(E.startRenderSpace,r.startRenderSpace,g,_),Ke(E.endRenderSpace,r.endRenderSpace,g,O),this._hasValidGeometry=!0}_updateLines(){if(!this._hasValidGeometry)return this._dimensionVisualElement.visible=!1,this._startOffsetVisualElement.visible=!1,void(this._endOffsetVisualElement.visible=!1);this._dimensionVisualElement.setGeometryFromSegment(this._dimensionSegment),this._startOffsetVisualElement.setGeometryFromSegment(this._startOffsetSegment),this._endOffsetVisualElement.setGeometryFromSegment(this._endOffsetSegment),this._dimensionVisualElement.visible=!0,this._startOffsetVisualElement.visible=!0,this._endOffsetVisualElement.visible=!0}_updateLabelContent(t){if(m(t)||!this._hasValidGeometry)return this._label.text="",void(this._label.visible=!1);const{value:e}=bn(t,"meters");this._label.text=`${on(e,{minimumFractionDigits:2,maximumFractionDigits:2})} m`,this._label.visible=!0}_updateLabelGeometry(t){if(!this._hasValidGeometry)return void(this._label.visible=!1);const{offset:e}=this.computation.dimension,i=t.computeRenderPixelSizeAt(this._dimensionSegment.eval(.5,pe.get())),n=(Math.sign(e)>=0?1:-1)*Ce.labels.offset*i;ps(this._labelSegment,this._dimensionSegment,this._offsetAxis,n),this._label.geometry={type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1}}};function hs(t,e,i,n,s,r){switch(s){case"horizontal":return W(t,n);case"vertical":return ue(e,n)<ue(i,n)?Ae(t,i,e):Ae(t,e,i),ft(t,t,n),Lt(t,Mt)?W(t,r):(ft(t,t,n),bt(t,t),t);case"direct":return ue(e,r)>ue(i,r)?Ae(t,i,e):Ae(t,e,i),ft(t,t,n),Lt(t,Mt)?W(t,r):(bt(t,t),t)}}function cs(t,e,i,n=0){const s=ue(e,i),r=ue(t,i),o=Math.abs(s-r)+n;return s>r?[o,n]:[n,o]}function ps(t,e,i,n){Ke(t.startRenderSpace,e.startRenderSpace,i,n),Ke(t.endRenderSpace,e.endRenderSpace,i,n)}a([d({constructOnly:!0,nonNullable:!0})],be.prototype,"computation",void 0),a([d({constructOnly:!0,nonNullable:!0})],be.prototype,"view",void 0),be=a([S("esri.views.3d.analysis.Dimensioning.LengthDimensionVisualization")],be);let Pe=class extends F{constructor(t){super(t),this._dimensionVisualizations=new Map}initialize(){for(const t of this.computations)this._addComputation(t);this.own(this.computations.on("change",({added:t,removed:e})=>{for(const i of e)this._removeComputation(i);for(const i of t)this._addComputation(i)}))}destroy(){this._dimensionVisualizations.forEach(t=>{t.destroy()}),this._dimensionVisualizations.clear()}get testInfo(){return{visualizations:Array.from(this._dimensionVisualizations.values())}}_addComputation(t){this._dimensionVisualizations.has(t)||this._dimensionVisualizations.set(t,new be({computation:t,view:this.view}))}_removeComputation(t){const e=this._dimensionVisualizations.get(t);m(e)||(e.destroy(),this._dimensionVisualizations.delete(t))}};a([d({constructOnly:!0,nonNullable:!0})],Pe.prototype,"view",void 0),a([d({constructOnly:!0,nonNullable:!0})],Pe.prototype,"computations",void 0),Pe=a([S("esri.views.3d.analysis.Dimensioning.DimensioningVisualization")],Pe);let Be=class extends F{constructor(t){super(t),this.dimension=null}};a([d({constructOnly:!0,nonNullable:!0})],Be.prototype,"dimension",void 0),Be=a([S("esri.views.3d.analysis.LengthDimensionResult")],Be);const us=Be;function gs(t,e){const{spatialReference:i}=t;return ln(i,e.spatialReference)?(qe[0]=t.x,qe[1]=t.y,qe[2]=t.hasZ?t.z:0,We[0]=e.x,We[1]=e.y,We[2]=e.hasZ?e.z:0,fs(qe,We,i)):null}function fs(t,e,i){const n=_s(t,e,i);return f(n)?{direct:vt(n.direct,n.unit),horizontal:vt(n.horizontal,n.unit),vertical:vt(n.vertical,n.unit)}:null}function _s(t,e,i,n){const s=Hn(i),r=dn(s);if(m(r))return null;const o=e[2]-t[2];if(n==="vertical")return{verticalSigned:o,unit:r};if(!_t(t,i,wt,s)||!_t(e,i,Ye,s))return null;if(n==="direct")return{direct:mt(Ye,wt),unit:r};if(hn(Ue,t[0],t[1],e[2]),!_t(Ue,i,Ue,s))return null;const l=mt(Ue,Ye);return n==="horizontal"?{horizontal:l,unit:r}:{direct:mt(Ye,wt),horizontal:l,vertical:Math.abs(o),unit:r}}const qe=w(),We=w(),wt=w(),Ye=w(),Ue=w();let he=class extends F{constructor(t){super(t)}initialize(){this._set("result",new us({dimension:this.dimension}))}get length(){const{startPoint:t,endPoint:e,axis:i}=this.dimension;if(m(t)||m(e))return null;const n=gs(t,e);return m(n)?null:n[i]}};a([d({constructOnly:!0,nonNullable:!0})],he.prototype,"dimension",void 0),a([d({constructOnly:!0,nonNullable:!0})],he.prototype,"result",void 0),a([d()],he.prototype,"length",null),he=a([S("esri.views.3d.analysis.LengthDimensionComputation")],he);let L=class extends pn(F){constructor(t){super(t),this.type="dimensioning-view-3d",this.tool=null,this._computations=new Ve,this._dimensionsToResults=new Map,this._placementTask=null}initialize(){this.own([mn(this,T),cn(()=>this.analysis.dimensions,"change",({added:t,removed:e})=>{for(const i of e)this._removeDimension(i);for(const i of t)this._addDimension(i)},{onListenerAdd:t=>{for(const e of t)this._addDimension(e)},onListenerRemove:t=>{for(const e of t)this._removeDimension(e)}})]),this._analysisVisualization=new Pe({view:this.view,computations:this._computations})}destroy(){this._placementTask=_e(this._placementTask),this._analysisVisualization=Pt(this._analysisVisualization),this._computations.drain(t=>t.destroy()),yn(this)}get results(){return this.analysis.dimensions.map(t=>this._dimensionsToResults.get(t))}get testInfo(){return{visualization:this._analysisVisualization}}async createLengthDimensions(t){return this._placementTask=_e(this._placementTask),this._placementTask=vn(this,T,t),this._placementTask.promise}_addDimension(t){const e=this._dimensionsToResults;if(e.has(t))return;const i=this._computations,n=new he({dimension:t});i.add(n),e.set(t,n.result)}_removeDimension(t){const e=this._computations,i=this._dimensionsToResults,n=e.findIndex(r=>r.dimension===t),s=e.removeAt(n);i.delete(t),Pt(s)}};a([d({readOnly:!0})],L.prototype,"type",void 0),a([d({constructOnly:!0,nonNullable:!0})],L.prototype,"analysis",void 0),a([d()],L.prototype,"tool",void 0),a([d({readOnly:!0})],L.prototype,"results",null),a([d()],L.prototype,"_analysisVisualization",void 0),a([d()],L.prototype,"_computations",void 0),a([d()],L.prototype,"_dimensionsToResults",void 0),a([d()],L.prototype,"_placementTask",void 0),L=a([S("esri.views.3d.analysis.DimensioningAnalysisView3D")],L);const ms=L;var Rs=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:ms});export{Rs as D,it as a,ai as e,qn as r};

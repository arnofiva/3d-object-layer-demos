var N=Object.defineProperty,T=Object.defineProperties;var $=Object.getOwnPropertyDescriptors;var F=Object.getOwnPropertySymbols;var H=Object.prototype.hasOwnProperty,L=Object.prototype.propertyIsEnumerable;var I=(e,t,i)=>t in e?N(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,y=(e,t)=>{for(var i in t||(t={}))H.call(t,i)&&I(e,i,t[i]);if(F)for(var i of F(t))L.call(t,i)&&I(e,i,t[i]);return e},g=(e,t)=>T(e,$(t));import{a as r,d as n,n as v,y as j,H as P,ap as D,er as O,r as o,hj as J,ab as U,u as k,aB as R,az as B,aH as f,hh as z,aI as C,t as _,d0 as Z,A as Y,q as K,w as W,x as X,z as Q,o as p,hk as G,G as m,g as q,C as ee,D as te,B as b,h as V,hl as ie,ay as se,aZ as re,fR as ne,cb as ae,L as le,M as oe}from"./vendor.fd144a9e.js";import{b as ue,j as he}from"./Graphics3DScaleVisibility.f998c732.js";import{d as de,l as pe,s as ce}from"./Graphics3DObjectStates.1c4d8ad6.js";import{o as ye}from"./floorFilterUtils.69500d62.js";import{Y as ge}from"./QueryEngine.1b5f211e.js";import{n as A}from"./attributeUtils.99d8ee08.js";const fe=ge;let h=class extends j{constructor(e){super(e),this._dataQueryEngineInstance=null}get queryGeometryType(){switch(this.layer.geometryType){case"multipoint":case"point":case"polygon":case"polyline":return this.layer.geometryType;case"mesh":return"polygon";default:return}}get defaultQueryJSON(){return new P({outSpatialReference:this.spatialReference}).toJSON()}get dataQueryEngine(){return this._ensureDataQueryEngine()}destroy(){this.clear()}clear(){return!!this._dataQueryEngineInstance&&(this._dataQueryEngineInstance.destroy(),this._dataQueryEngineInstance=null,!0)}async executeQueryForIdSet(e,t){return this.dataQueryEngine.executeQueryForIdSet(this._ensureQueryJSON(e,t))}async executeQueryForCount(e,t){return this.dataQueryEngine.executeQueryForCount(this._ensureQueryJSON(e),t)}async executeQueryForExtent(e,t){const{count:i,extent:s}=await this.dataQueryEngine.executeQueryForExtent(this._ensureQueryJSON(e),t);return{count:i,extent:D.fromJSON(s)}}async executeQueryForIds(e,t){return this.dataQueryEngine.executeQueryForIds(this._ensureQueryJSON(e),t)}async executeQueryForLatestObservations(e,t){const i=await this.dataQueryEngine.executeQueryForLatestObservations(this._ensureQueryJSON(e),t),s=O.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer}),s}async executeQuery(e,t){const i=await this.dataQueryEngine.executeQuery(this._ensureQueryJSON(e),t),s=O.fromJSON(i);return s.features.forEach(l=>{l.layer=this.layer,l.sourceLayer=this.layer}),s}_ensureQueryJSON(e,t){let i=this.defaultQueryJSON;return o(e)&&("outSpatialReference"in e&&!e.outSpatialReference&&(e.outSpatialReference=this.spatialReference),i=e.toJSON()),o(t)&&(i=g(y({},i),{sceneFilter:g(y({},t),{geometry:t.geometry.toJSON()})})),i}_ensureDataQueryEngine(){if(this._dataQueryEngineInstance)return this._dataQueryEngineInstance;const e="timeInfo"in this.layer&&this.layer.timeInfo&&this.layer.timeInfo.toJSON()||null,t=this.layer.objectIdField,i=J.toJSON(this.queryGeometryType),s=this.layer.fields.map(M=>M.toJSON()),l=this.layerView.view.resourceController.scheduler,u=this.priority,c=this.spatialReference.toJSON(),E=this.layerView.processor.featureStore,{hasZ:w,hasM:x}=this.layerView;return this._dataQueryEngineInstance=new fe({hasZ:w,hasM:x,geometryType:i,fields:s,timeInfo:e,spatialReference:c,objectIdField:t,featureStore:E,scheduler:l,priority:u}),this._dataQueryEngineInstance}};r([n({constructOnly:!0})],h.prototype,"layerView",void 0),r([n({constructOnly:!0})],h.prototype,"priority",void 0),r([n({readOnly:!0,aliasOf:"layerView.view.spatialReference"})],h.prototype,"spatialReference",void 0),r([n({readOnly:!0,aliasOf:"layerView.layer"})],h.prototype,"layer",void 0),r([n({readOnly:!0})],h.prototype,"queryGeometryType",null),r([n({readOnly:!0})],h.prototype,"defaultQueryJSON",null),h=r([v("esri.views.3d.layers.graphics.QueryEngine")],h);const me=U.getLogger("esri.views.3d.layers.graphics.Graphics3DFilterVisibility");let d=class extends j{constructor(...e){super(...e),this._dirty=!1,this._querying=!1,this._handles=new k}get updating(){return this._dirty||this._querying||o(this._queryResult)}setup(e,t){this._layerView=e,this._core=t,this._objectIdField=e.layer.objectIdField,this._queryEngine=new h({layerView:this._layerView,priority:R.FILTER_VISIBILITY});const i=this._layerView.view.resourceController.scheduler;this._handles.add(i.registerTask(R.FILTER_VISIBILITY,this)),this._handles.add(B(()=>{var s;return(s=t.owner)==null?void 0:s.loadedGraphics},"after-changes",s=>this._graphicsChanged(s),{onListenerAdd:()=>this.dirty=!0})),this.filterChanged()}destroy(){this._handles.destroy(),this._handles=null,this.clear(),this._layerView=null,this._core=null}clear(){this._queryEngine.clear()&&(this._core.modifyGraphics3DGraphicVisibilities(e=>e.clearVisibilityFlag(f.FILTER)),this._queryResult=null,this._querying=!1),this.dirty=!1}_graphicsChanged(e){this._queryEngine&&(e.type&z.ADD)==0||(this.dirty=!0)}updateVisibility(e){this.active&&(e.hasVisibilityFlag(f.FILTER,C.GRAPHIC)||e.setVisibilityFlag(f.FILTER,!1,C.GRAPHIC),this.dirty=!0)}filterChanged(){const e=this._recomputeFilter();e!==this._featureFilter&&(this._featureFilter=e,this.dirty=!0);const t="layerFilter"in this._layerView?this._layerView.layerFilter:null;t!==this._sceneFilter&&(this._sceneFilter=t,this.dirty=!0)}get active(){return(this._featureFilter||this._sceneFilter)&&this._core.graphics3DGraphics.size>0}_recomputeFilter(){const e="filter"in this._layerView?this._layerView.filter:null,t="timeExtent"in this._layerView?this._layerView.timeExtent:null,i=ye(this._layerView);if(_(t)&&_(i))return e;const s=o(e)?e.clone():new Z;if(o(t)&&(s.timeExtent=o(s.timeExtent)?s.timeExtent.intersection(t):t),o(i)){const l=s.where==null||s.where==="";s.where=l?i:`(${s.where}) AND (${i})`}return s}get running(){return this._dirty&&!this._querying||o(this._queryResult)}runTask(e){if(!this.active)return void this.clear();!this._dirty||this._querying||e.done||(this._querying=!0,this.dirty=!1,this._queryEngine.executeQueryForIdSet(this._featureFilter,this._sceneFilter).then(i=>{this._queryResult=i,this._querying=!1}).catch(i=>{if(!Y(i)){me.warn("FeatureFilter query failed: "+i,{error:i});const s=new Set;this._core.graphics3DGraphics.forEach(l=>s.add(this._getFeatureId(l.graphic))),this._queryResult=s,this._querying=!1}}),e.madeProgress());const t=this._queryResult;o(t)&&!e.done&&(this._core.modifyGraphics3DGraphicVisibilities(i=>{if(e.done)return!1;const s=t.has(this._getFeatureId(i.graphic));return!!i.setVisibilityFlag(f.FILTER,s,C.GRAPHIC)&&(e.madeProgress(),!0)}),e.done||(this._queryResult=null))}_getFeatureId(e){return e.objectId==null?e.attributes[this._objectIdField]:e.objectId}set dirty(e){this._dirty=e}};r([n({readOnly:!0})],d.prototype,"updating",null),r([n({readOnly:!0})],d.prototype,"running",null),r([n()],d.prototype,"_dirty",void 0),r([n()],d.prototype,"_querying",void 0),r([n()],d.prototype,"_queryResult",void 0),d=r([v("esri.views.3d.layers.graphics.Graphics3DFilterVisibility")],d);let a=class extends K{constructor(e){super(e),this.type="graphics-3d",this.elevationFeatureExpressionEnabled=!1,this.dataExtent=null,this.drapeSourceType=W.Features,this.preferredUpdatePolicy=X.ASYNC,this.suspendResumeExtent=null}normalizeCtorArgs(e){const t=e.frustumVisibilityEnabled?new de:null,i=e.scaleVisibilityEnabled?new ue:null,s=(e.filterVisibilityEnabled||e.timeExtentEnabled)&&e.owner.layer.geometryType!=="multipatch"?new d:null,l=e.elevationAlignmentEnabled?new pe:null,{owner:u,updateClippingExtent:c,dataExtent:E,elevationFeatureExpressionEnabled:w,preferredUpdatePolicy:x}=e;return{owner:u,updateClippingExtent:c,dataExtent:E,frustumVisibility:t,scaleVisibility:i,filterVisibility:s,elevationAlignment:l,elevationFeatureExpressionEnabled:w,preferredUpdatePolicy:x}}initialize(){const e=new he({owner:this,layer:this.layer,preferredUpdatePolicy:this.preferredUpdatePolicy,elevationFeatureExpressionEnabled:this.elevationFeatureExpressionEnabled,graphicSymbolSupported:!1,hasZ:this.owner.hasZ,hasM:this.owner.hasM});this._set("graphicsCore",e),this.scaleVisibility&&this.updatingHandles.add(()=>this.layer.effectiveScaleRange,()=>this.scaleVisibility.layerMinMaxScaleChangeHandler());const t=this.filterVisibility;o(t)&&(this.updatingHandles.add(()=>"filter"in this.owner&&this.owner.filter,()=>t.filterChanged()),this.updatingHandles.add(()=>"timeExtent"in this.owner&&this.owner.timeExtent,()=>t.filterChanged()),this.updatingHandles.add(()=>"layerFilter"in this.owner&&this.owner.layerFilter,()=>t.filterChanged())),this.elevationAlignment&&this.updatingHandles.add(()=>this.layer.elevationInfo,(i,s)=>{Q(i,s)&&this.updatingHandles.addPromise(this.graphicsCore.elevationInfoChange())}),this.updatingHandles.add(()=>this.layer.labelsVisible,()=>this.graphicsCore.updateVisibilityInfo()),this.updatingHandles.add(()=>this.layer.labelingInfo,(i,s)=>{Q(i,s)&&this.graphicsCore.updateLabelingInfo()}),this.updatingHandles.add(()=>this.preferredUpdatePolicy,i=>this.graphicsCore.preferredUpdatePolicy=i)}destroy(){this.handles.removeAll(),this.updatingHandles.removeAll(),this._set("frustumVisibility",p(this.frustumVisibility)),this._set("scaleVisibility",p(this.scaleVisibility)),this._set("filterVisibility",p(this.filterVisibility)),this._set("elevationAlignment",p(this.elevationAlignment)),this._set("objectStates",p(this.objectStates)),this._set("graphicsCore",p(this.graphicsCore)),this._set("owner",null)}get layer(){return this.owner.layer}get suspendResumeExtentMode(){return"suspendResumeExtentMode"in this.owner?this.owner.suspendResumeExtentMode:"computed"}get scaleVisibilitySuspended(){var e;return(e=this.scaleVisibility)==null?void 0:e.suspended}get suspended(){return this.owner.suspended}get legendEnabled(){return _(this.frustumVisibility)||!this.frustumVisibility.suspended}get suspendInfo(){var t;const e={};return((t=this.scaleVisibility)==null?void 0:t.suspended)&&(e.outsideScaleRange=!0),o(this.frustumVisibility)&&this.frustumVisibility.suspended&&(e.outsideOfView=!0),e}get updating(){var e,t;return!!(((e=this.graphicsCore)==null?void 0:e.updating)||o(this.frustumVisibility)&&this.frustumVisibility.updating||((t=this.updatingHandles)==null?void 0:t.updating))}get updatingRemaining(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.updatingRemaining)!=null?t:0}get featureStore(){var e;return(e=this.graphicsCore)==null?void 0:e.featureStore}get view(){return this.owner.view}get loadedGraphics(){return this.owner.loadedGraphics}get fullOpacity(){var e;return(e=this.owner)==null?void 0:e.fullOpacity}get filter(){return"filter"in this.owner?this.owner.filter:null}get slicePlaneEnabled(){return this.owner.slicePlaneEnabled}get updatePolicy(){return this.owner.updatePolicy}get featureSpatialReference(){return"featureSpatialReference"in this.owner?this.owner.featureSpatialReference:this.owner.view.spatialReference}get graphics3DGraphics(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphics}get graphics3DGraphicsByObjectID(){var e;return(e=this.graphicsCore)==null?void 0:e.graphics3DGraphicsByObjectID}get symbolUpdateType(){var e;return(e=this.graphicsCore)==null?void 0:e.symbolUpdateType}get displayFeatureLimit(){var u;const e=this.view.resourceController.memoryController.memoryFactor,t=(u=this.graphicsCore)==null?void 0:u.displayFeatureLimit;if(e===1)return t;const i=Math.ceil(t.maximumNumberOfFeatures*e),s=Math.ceil(t.maximumTotalNumberOfFeatures*e),l=Math.ceil(t.minimumTotalNumberOfFeatures*e);return g(y({},t),{maximumNumberOfFeatures:i,maximumTotalNumberOfFeatures:s,minimumTotalNumberOfFeatures:l})}get usedMemory(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.usedMemory)!=null?t:0}get usedMemoryPerFeature(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.usedMemoryPerGraphic)!=null?t:0}get unprocessedMemoryEstimate(){var e,t;return(t=(e=this.graphicsCore)==null?void 0:e.unprocessedMemoryEstimate)!=null?t:0}get performanceInfo(){return{core:this.graphicsCore.performanceInfo,elevationUpdating:this.elevationAlignment.updating,visibilityFrustum:_(this.frustumVisibility)||!this.frustumVisibility.suspended,visibilityScale:!this.scaleVisibility.suspended}}async setup(){o(this.frustumVisibility)&&this.frustumVisibility.setup(this);const e=this.owner,t=this.owner.view.basemapTerrain,i=(s,l,u)=>this.graphicsCore.spatialIndex.queryGraphicUIDsInExtent(s,l,u);if(this.scaleVisibility&&this.scaleVisibility.setup(this,this.layer,i,this.graphicsCore,t),o(this.filterVisibility)&&("filter"in e||"timeExtent"in e)&&this.filterVisibility.setup(e,this.graphicsCore),this.elevationAlignment){const s=e.view.elevationProvider;this.elevationAlignment.setup(this,i,this.graphicsCore,s)}this._set("objectStates",new ce(this.graphicsCore)),this._set("labeling",this.owner.view.labeler.addGraphicsOwner(this.graphicsCore,this.scaleVisibility)),this._set("deconfliction",e.view.deconflictor.addGraphicsOwner(this.graphicsCore)),await G(this.graphicsCore.setup({elevationAlignment:this.elevationAlignment,scaleVisibility:this.scaleVisibility,filterVisibility:this.filterVisibility,deconflictor:this.deconfliction,labeler:this.labeling,objectStates:this.objectStates})),this.updatingHandles.add(()=>this.layer.renderer,s=>this.updatingHandles.addPromise(this.graphicsCore.rendererChange(s))),this.updatingHandles.add(()=>e.fullOpacity,()=>this.graphicsCore.opacityChange()),this._setupSuspendResumeExtent(),this.updateClippingExtent&&(this.updatingHandles.add(()=>e.view.clippingArea,()=>this._updateClippingExtent()),this._updateClippingExtent()),this.graphicsCore.startCreateGraphics(),this.graphicsCore.labelsEnabled&&await G(this.graphicsCore.updateLabelingInfo())}maskOccludee(e){const{set:t,handle:i}=this.objectStates.acquireSet(m.MaskOccludee,null);return this.objectStates.setUid(t,e.uid),i}highlight(e,t){if(e instanceof P){const{set:i,handle:s}=this.objectStates.acquireSet(m.Highlight,t);return this.owner.queryObjectIds(e).then(l=>this.objectStates.setObjectIds(i,l)),s}if(typeof e=="number"||typeof e=="string")return this.highlight([e],t);if(e instanceof q)return this.highlight([e],t);if("toArray"in e&&(e=e.toArray()),Array.isArray(e)&&e.length>0){if(e[0]instanceof q){const i=e;if(A(this.layer.fieldsIndex,i[0].attributes,t)==null){const s=i.map(c=>c.uid),{set:l,handle:u}=this.objectStates.acquireSet(m.Highlight,null);return this.objectStates.setUids(l,s),u}e=i.map(s=>A(this.layer.fieldsIndex,s.attributes,t))}if(typeof e[0]=="number"||typeof e[0]=="string"){const i=e,{set:s,handle:l}=this.objectStates.acquireSet(m.Highlight,t);return this.objectStates.setObjectIds(s,i),l}}return be}whenGraphicBounds(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.whenGraphicBounds(e,t)}computeAttachmentOrigin(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.computeAttachmentOrigin(e,t)}notifyGraphicGeometryChanged(e){this.graphicsCore.notifyGraphicGeometryChanged(e)}notifyGraphicVisibilityChanged(e){this.graphicsCore.notifyGraphicVisibilityChanged(e)}getRenderingInfo(e,t,i){const s=ee(e,{renderer:t,arcade:i});if(o(s)&&s.color){const l=s.color;l[0]=l[0]/255,l[1]=l[1]/255,l[2]=l[2]/255}return s}getRenderingInfoAsync(e,t,i,s){return te(e,y({renderer:t,arcade:i},s))}getSymbolLayerSize(e,t){var i;return(i=this.graphicsCore)==null?void 0:i.getSymbolLayerSize(e,t)}setObjectIdVisibility(e,t){var i;(i=this.graphicsCore)==null||i.setObjectIdVisibility(e,t)}_updateClippingExtent(){const e=this.owner.view.clippingArea;this.graphicsCore.setClippingExtent(e,this.owner.view.spatialReference)&&(this.updateClippingExtent(e)||this.graphicsCore.recreateAllGraphics())}_setupSuspendResumeExtent(){(this.frustumVisibility||this.scaleVisibility)&&this.handles.add(b(()=>this.suspendResumeExtentMode,()=>{switch(this.handles.remove(S),this.suspendResumeExtentMode){case"computed":this.handles.add([b(()=>this.graphicsCore.computedExtent,e=>this._updateSuspendResumeExtent(e),V),b(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(this.graphicsCore.computedExtent))],S);break;case"data":this.handles.add([se(()=>this.dataExtent,e=>this._updateSuspendResumeExtent(e),V),b(()=>this.graphicsCore.extentPadding,()=>this._updateSuspendResumeExtent(re(this.dataExtent)))],S);break;default:ie(this.suspendResumeExtentMode)}},V))}_updateSuspendResumeExtent(e){e?this._suspendResumeExtentChanged(this._extentToSuspendResumeRect(e,this.suspendResumeExtent)):this._suspendResumeExtentChanged(null)}_extentToSuspendResumeRect(e,t){const i=this.owner.view.spatialReference;if(!e.spatialReference.equals(i)){if(!ne(e,i))return;e=ae(e,i)}return le(e,t,oe,this.graphicsCore.extentPadding)}_suspendResumeExtentChanged(e){o(this.frustumVisibility)&&this.frustumVisibility.setExtent(e),this.scaleVisibility&&this.scaleVisibility.setExtent(e)}};r([n()],a.prototype,"type",void 0),r([n({constructOnly:!0})],a.prototype,"owner",void 0),r([n()],a.prototype,"layer",null),r([n({constructOnly:!0})],a.prototype,"updateClippingExtent",void 0),r([n({constructOnly:!0})],a.prototype,"elevationFeatureExpressionEnabled",void 0),r([n({constructOnly:!0})],a.prototype,"graphicsCore",void 0),r([n({constructOnly:!0})],a.prototype,"scaleVisibility",void 0),r([n({constructOnly:!0})],a.prototype,"filterVisibility",void 0),r([n({constructOnly:!0})],a.prototype,"elevationAlignment",void 0),r([n({constructOnly:!0})],a.prototype,"frustumVisibility",void 0),r([n({readOnly:!0})],a.prototype,"deconfliction",void 0),r([n({readOnly:!0})],a.prototype,"labeling",void 0),r([n({readOnly:!0})],a.prototype,"objectStates",void 0),r([n()],a.prototype,"suspendResumeExtentMode",null),r([n()],a.prototype,"dataExtent",void 0),r([n()],a.prototype,"scaleVisibilitySuspended",null),r([n()],a.prototype,"suspended",null),r([n()],a.prototype,"legendEnabled",null),r([n()],a.prototype,"suspendInfo",null),r([n()],a.prototype,"updating",null),r([n()],a.prototype,"updatingRemaining",null),r([n()],a.prototype,"featureStore",null),r([n()],a.prototype,"view",null),r([n()],a.prototype,"loadedGraphics",null),r([n()],a.prototype,"fullOpacity",null),r([n()],a.prototype,"filter",null),r([n()],a.prototype,"slicePlaneEnabled",null),r([n()],a.prototype,"drapeSourceType",void 0),r([n()],a.prototype,"updatePolicy",null),r([n()],a.prototype,"preferredUpdatePolicy",void 0),r([n()],a.prototype,"displayFeatureLimit",null),a=r([v("esri.views.3d.layers.graphics.Graphics3DFeatureProcessor")],a);const ve=a,S="suspendResumeExtentMode",be={remove(){},pause(){},resume(){}};export{ve as F,h as l};

import{aD as h,aE as u,aF as X,au as De,bl as tt,ci as Se,bO as H,bq as ie,bT as k,bh as E,bt as O,bL as he,bK as ue,bG as de,bH as D,bg as pe,sr as T,nm as C,d8 as U,vY as xt,vZ as wt,kl as nt,eN as Ce,v_ as Ve,v$ as Ae,hz as Y,bJ as Lt,d5 as m,oX as Fe,cr as se,cy as me,dG as Tt,di as Pt,cn as it,l7 as $t,cs as Ie,gd as bt,ax as Rt,az as ge,aT as Nt,w0 as Ct,bs as Vt,iE as At,ln as Ft,s4 as st,qp as It,ce as ke,bi as Ot,eZ as Xe,ge as Mt,ee as qt}from"./main-79e5ed80.js";import{c as Ht,b as S,v as Dt}from"./elevationInfoUtils-287337e4.js";import{v as w,L as be,m as kt}from"./geometry2dUtils-9d16f4f8.js";import{u as x}from"./viewUtils-ca2c33e3.js";let j=class extends De{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};h([u({constructOnly:!0})],j.prototype,"layer",void 0),h([u()],j.prototype,"enabled",void 0),h([u()],j.prototype,"updating",void 0),h([u()],j.prototype,"availability",void 0),j=h([X("esri.views.interactive.snapping.FeatureSnappingLayerSource")],j);const zt=j,bn={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Je={toggle:"Control"};let $=class extends tt{constructor(){super(...arguments),this.enabled=!0}};h([u({type:Boolean})],$.prototype,"enabled",void 0),$=h([X("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],$);let g=class extends tt{constructor(e){super(e),this.lineSnapper=new $,this.parallelLineSnapper=new $,this.rightAngleSnapper=new $,this.rightAngleTriangleSnapper=new $,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Se([255,127,0]),this.orangeTransparent=new Se([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};h([u({type:$,constructOnly:!0,nonNullable:!0,json:{write:!0}})],g.prototype,"lineSnapper",void 0),h([u({type:$,constructOnly:!0,nonNullable:!0,json:{write:!0}})],g.prototype,"parallelLineSnapper",void 0),h([u({type:$,constructOnly:!0,nonNullable:!0,json:{write:!0}})],g.prototype,"rightAngleSnapper",void 0),h([u({type:$,constructOnly:!0,nonNullable:!0,json:{write:!0}})],g.prototype,"rightAngleTriangleSnapper",void 0),h([u({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],g.prototype,"shortLineThreshold",void 0),h([u({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],g.prototype,"distance",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],g.prototype,"pointThreshold",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],g.prototype,"intersectionParallelLineThreshold",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],g.prototype,"parallelLineThreshold",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"verticalLineThreshold",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],g.prototype,"touchSensitivityMultiplier",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],g.prototype,"pointOnLineThreshold",void 0),h([u({type:Se,nonNullable:!0})],g.prototype,"orange",void 0),h([u({type:Se,nonNullable:!0})],g.prototype,"orangeTransparent",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],g.prototype,"lineHintWidthReference",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],g.prototype,"lineHintWidthTarget",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],g.prototype,"lineHintFadedExtensions",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],g.prototype,"parallelLineHintWidth",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],g.prototype,"parallelLineHintLength",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],g.prototype,"parallelLineHintOffset",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],g.prototype,"rightAngleHintSize",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],g.prototype,"rightAngleHintOutlineSize",void 0),h([u({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],g.prototype,"satisfiesConstraintScreenThreshold",void 0),g=h([X("esri.views.interactive.snapping.Settings.Defaults")],g);const I=new g;var _;(function(n){n[n.FEATURE=1]="FEATURE",n[n.SELF=2]="SELF",n[n.ALL=3]="ALL"})(_||(_={}));function Cn(n){return n}function rt(n){return k(n)}function Vn(n,e,t){return H(n,e,t)}function y(n,e,t){return n==null?null:ce(t.coordinateHelper.vectorToDehydratedPoint(n,jt),e,t)}function ce(n,e,t){if(n==null)return null;if(e==null)return H(n.x,n.y,n.z??0);if(e.type==="2d")return H(n.x,n.y,0);const{elevationInfo:i}=t,s=Ht(e,n,i,S)??0;return H(n.x,n.y,s)}function Be(n,e,{z:t,m:i,spatialReference:s,elevationInfo:r}){if(t==null&&i==null){const a=ie(n[0],n[1],void 0,s);return i!=null&&(a.m=i,a.hasM=!0),a}if(e==null||e.type==="2d"){const a=ie(n[0],n[1],t,s);return i!=null&&(a.m=i,a.hasM=!0),a}const o=Dt(e,n,s,S,r)??0,l=ie(n[0],n[1],o,s);return i!=null&&(l.m=i,l.hasM=!0),l}function An(n,e){return ie(n[0],n[1],n[2],e)}const jt=ie(0,0,0,null);function Oe({start:n,end:e,type:t},i,s){const r=[],o=O(J,e,n),l=O(oe,n,i),a=he(o),c=2*ue(o,l),d=c*c-4*a*(he(l)-s*s);if(d===0){const p=-c/(2*a);(t===R.PLANE||p>=0)&&r.push(de(D(),n,o,p))}else if(d>0){const p=Math.sqrt(d),f=(-c+p)/(2*a);(t===R.PLANE||f>=0)&&r.push(de(D(),n,o,f));const v=(-c-p)/(2*a);(t===R.PLANE||v>=0)&&r.push(de(D(),n,o,v))}return r}function Me(n,e){const t=n.start,i=n.end,s=O(J,i,t),r=pe(oe,-s[1],s[0],0),o=e.start,l=e.end,a=T(je,l,o),c=C(a,r),d=pe(ct,t[0],t[1],0),p=T(dt,d,o),f=C(p,r);if(Math.abs(c)<b)return[];const v=U(ht,o,a,f/c);if(e.type===w.RAY){const A=T(xe,v,o);if(C(A,a)<-b)return[]}if(n.type===R.HALF_PLANE){const A=xt(xe,v,t);if(ue(A,s)<-b)return[]}return[k(v)]}function qe(n,e){return He(_e(Ge,e[2],n),e)}function ot(n,e){const i=lt(_e(Ge,0,n),_e(Wt,0,e)),s=[];for(const r of i)s.push(wt(r));return s}function at(n,e){return ze(n,_e(Ge,n[2],e))}function Gt(n,e,t){const i=O(J,n,e),s=t/Lt(i),r=de(E(),e,i,s);return r[2]=n[2],r}function ze(n,{start:e,end:t,type:i}){const s=T(J,n,e),r=T(oe,t,e),o=C(s,r)/C(r,r);return U(E(),e,r,i===w.RAY?Math.max(o,0):o)}function Ke({start:n,end:e,type:t},i,s){const r=[],o=nt(J,e,n),l=O(oe,n,i),a=he(o),c=2*ue(o,l),d=c*c-4*a*(he(l)-s*s);if(d===0){const p=-c/(2*a);(t===w.LINE||p>=0)&&r.push(U(E(),n,o,p))}else if(d>0){const p=Math.sqrt(d),f=(-c+p)/(2*a);(t===w.LINE||f>=0)&&r.push(U(E(),n,o,f));const v=(-c-p)/(2*a);(t===w.LINE||v>=0)&&r.push(U(E(),n,o,v))}return r}function lt(n,e){const t=n.start,i=n.end,s=e.start,r=e.end,o=T(J,i,t),l=T(oe,r,s),a=T(je,s,t),c=Ce(ct,o,l),d=C(a,c);if(!Ve(d,0,b))return[];const p=Ae(c);if(Ve(p,0,b))return[];const f=Ce(dt,a,l),v=C(f,c)/p,A=U(ht,t,o,v);if(n.type===w.RAY){const Q=T(xe,A,t);if(C(o,Q)<-b)return[]}if(e.type===w.RAY){const Q=T(xe,A,s);if(C(l,Q)<-b)return[]}return[k(A)]}function He({start:n,end:e,type:t},i){const s=T(J,i,n),r=T(oe,e,n),o=Ce(je,r,s);if(Ae(o)/Ae(r)<b)switch(t){case w.LINE:return[k(i)];case w.RAY:return C(r,s)<-b?[]:[k(i)]}return[]}function Qe(n,e,t){return Ve(Y(t,n),e*e,b)?[k(t)]:[]}function _e(n,e,{start:t,end:i,type:s}){return pe(n.start,t[0],t[1],e),pe(n.end,i[0],i[1],e),n.type=Zt[s],n}var R;(function(n){n[n.PLANE=0]="PLANE",n[n.HALF_PLANE=1]="HALF_PLANE"})(R||(R={}));const Zt={[R.PLANE]:w.LINE,[R.HALF_PLANE]:w.RAY},b=1e-6,J=E(),oe=E(),je=E(),ct=E(),dt=E(),ht=E(),xe=E(),Ge={start:E(),end:E(),type:w.LINE},Wt={start:E(),end:E(),type:w.LINE};class B{intersect(e){return Jt(this,e)}}let Ut=class extends B{constructor(e){super(),this.point=e}equals(e){return te(e)&&m(this.point,e.point)}closestTo(){return rt(this.point)}};class pt extends B{constructor(e,t,i){super(),this.start=e,this.end=t,this.type=i,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return G(e)&&this.type===e.type&&m(this.start,e.start)&&m(this.end,e.end)}closestTo(e){const t=ze(e,this.lineLike);return t}}let Yt=class extends pt{constructor(e,t){super(e,t,w.LINE)}};class Le extends B{constructor(e,t,i){super(),this.intersection=e,this.first=t,this.second=i}equals(e){return e instanceof Le&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return rt(this.intersection)}}let Re=class ut extends B{constructor(e,t,i){super(),this.basePoint=e,this.first=t,this.second=i}equals(e){return e instanceof ut&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const t=this.basePoint;return H(t[0],t[1],e[2])}},ft=class extends B{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return ne(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=Gt(e,this.center,this.radius);return t}},Ze=class extends B{constructor(e,t,i){super(),this.start=e,this.end=t,this.type=i,this.planeLike={start:e,end:t,type:i}}equals(e){return Z(e)&&this.type===e.type&&m(this.start,e.start)&&m(this.end,e.end)}closestTo(e){return at(e,this.planeLike)}closestEndTo(e){const{start:t,end:i}=this;return Math.sign(ue(O(Kt,i,t),O(Qt,e,t)))>0?i:t}};class gt extends Ze{constructor(e,t){super(e,t,R.HALF_PLANE)}}let yt=class extends Ze{constructor(e,t){super(e,t,R.PLANE)}};class vt extends B{constructor(e,t,i){super(),this.start=e,this.end=t,this.getZ=i,this.planeLike={start:e,end:t,type:R.PLANE}}equals(e){return W(e)&&m(this.start,e.start)&&m(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Xt(this,e)}addIfOnTheGround(e,t){for(const i of t){const s=this.getZ(i[0],i[1],i[2])??0;Math.abs(i[2]-s)<b&&(i[2]=s,e.push(i))}}}function Xt(n,e){const t=at(e,n.planeLike);return t[2]=n.getZ(e[0],e[1],e[2])??Et,t}function Jt(n,e){let t=[];if(te(n)){const{point:i}=n;G(e)?t=He(e.lineLike,i):ne(e)?t=Qe(e.center,e.radius,i):Z(e)?t=qe(e.planeLike,i):W(e)&&(t=le(e,n))}else if(G(n)){const{lineLike:i}=n;te(e)?t=He(i,e.point):G(e)?t=lt(i,e.lineLike):ne(e)?t=Ke(i,e.center,e.radius):Z(e)?t=Me(e.planeLike,i):W(e)&&(t=le(e,n))}else if(ne(n)){const{center:i,radius:s}=n;if(G(e))t=Ke(e.lineLike,i,s);else if(te(e))t=Qe(i,s,e.point);else{if(Z(e))return Oe(e.planeLike,i,s).map(r=>new Re(r,n,e));W(e)&&(t=le(e,n))}}else if(Z(n)){const{planeLike:i}=n;if(Z(e))return ot(i,e.planeLike).map(s=>new Re(s,n,e));if(te(e))t=qe(i,e.point);else if(G(e))t=Me(i,e.lineLike);else{if(ne(e))return Oe(i,e.center,e.radius).map(s=>new Re(s,n,e));W(e)&&(t=le(e,n))}}else W(n)&&(t=le(n,e));return Bt(t,n,e)}function le(n,e){const{planeLike:t,getZ:i}=n,s=[];if(te(e))n.addIfOnTheGround(s,qe(t,e.point));else if(G(e))n.addIfOnTheGround(s,Me(t,e.lineLike));else if(ne(e))for(const[r,o]of Oe(t,e.center,e.radius)){const l=i(r,o,0);l!=null&&s.push(H(r,o,l))}else if(Z(e)||W(e))for(const[r,o]of ot(t,e.planeLike)){const l=i(r,o,0)??Et;s.push(H(r,o,l))}return s}function Bt(n,e,t){return n.map(i=>new Le(i,e,t))}function te(n){return n instanceof Ut}function G(n){return n instanceof pt}function ne(n){return n instanceof ft}function Z(n){return n instanceof Ze}function W(n){return n instanceof vt}const Kt=D(),Qt=D(),Et=0;function K(n,e){const t=n.x-e.x,i=n.y-e.y;return t*t+i*i}function en(n,e){return Math.sqrt(K(n,e))}function We(n,e){e.sort((t,i)=>Fe(t.targetPoint,n)-Fe(i.targetPoint,n))}var P;function Hn({point:n,distance:e,returnEdge:t,returnVertex:i,coordinateHelper:{spatialReference:s}},r,o){return{point:ie(n[0],n[1],n[2],s.toJSON()),mode:r,distance:e,returnEdge:t,returnVertex:i,query:o!=null?o.toJSON():{where:"1=1"}}}function we(n,e,t){return{left:y(n.leftVertex.pos,e,t),right:y(n.rightVertex.pos,e,t)}}function Dn(n){return n.createQuery()}function kn(n,e=()=>{}){const t=se(()=>({view:n.view,snappingOptions:n.snappingOptions}),({view:i,snappingOptions:s})=>{const r="snapping-toggle",o=Tt.TOOL;if(n.removeHandles(r),i&&s!=null){const l=[i.on("key-down",a=>{a.key!==Je.toggle||a.repeat||(s.enabledToggled=!0,e())},o),i.on("key-up",a=>{a.key===Je.toggle&&(s.enabledToggled=!1,e())},o),i.on("pointer-move",a=>{const c=a.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},o)];n.addHandles(l,r)}},me);n.addHandles(t)}(function(n){n[n.TARGET=0]="TARGET",n[n.REFERENCE=1]="REFERENCE",n[n.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(P||(P={}));class ae{constructor(e,t,i,s){this.targetPoint=e,this.constraint=t,this.isDraped=i,this.domain=s}}let Ue=class extends ae{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:s}){super(e,i,s,_.FEATURE),this.objectId=t}},Te=class{constructor(e,t){this.isDraped=e,this.domain=t}},V=class St extends Te{constructor(e,t,i,s,r=_.ALL,o=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=i,this.fadeLeft=o,this.fadeRight=l}equals(e){return e instanceof St&&this.type===e.type&&m(this.lineStart,e.lineStart)&&m(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return Pt(this.lineStart,this.lineEnd)}},tn=class extends Ue{constructor(e){super({...e,isDraped:!0,constraint:new vt(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new V(P.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},nn=class extends Ue{constructor(e){super({...e,constraint:new Yt(e.edgeStart,e.edgeEnd)})}get hints(){return[new V(P.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}};class Pe extends Te{constructor(e,t,i,s,r=_.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=i}equals(e){return e instanceof Pe&&m(this.previousVertex,e.previousVertex)&&m(this.centerVertex,e.centerVertex)&&m(this.nextVertex,e.nextVertex)}}let mt=class extends ae{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:o,isDraped:l}){super(e,t,l,_.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=o}get hints(){const e=this.previousVertex,t=this.otherVertexType===re.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===re.CENTER?this.targetPoint:this.otherVertex;return[new V(P.TARGET,t,i,this.isDraped,this.domain),new V(P.REFERENCE,e,t,this.isDraped,this.domain),new Pe(this.previousVertex,t,i,this.isDraped,this.domain)]}};var re;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(re||(re={}));let q=class extends it{get updating(){return $t(this.snappingSources,({snappingSource:n})=>n.updating)||this.updatingHandles.updating}get snappingSources(){const n=this._get("snappingSources")||new Map,e=new Map;if(this.options!=null&&this.options.featureSources!=null)for(const t of this.options.featureSources.items){const i=t.layer.uid,s=n.get(i);if(s){n.delete(i),e.set(i,s);continue}if(!t.layer.loaded){this.updatingHandles.addPromise(t.layer.load());continue}const r=this._createSourceInfo(t);r!=null&&e.set(i,r)}for(const[,t]of n)t.destroy();return e}constructor(n){super(n),this.options=null,this._domain=_.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Ie),this.view!=null&&this.handles.add([this.view.on("layerview-create",n=>this._updateLayerView(n.layer,n.layerView)),this.view.on("layerview-destroy",n=>this._updateLayerView(n.layer,null))])}_updateLayerView(n,e){for(const[,t]of this.snappingSources)t.snappingSource.layerSource.layer===n&&(t.layerView=e)}destroy(){this._set("options",null);for(const[,n]of this.snappingSources)n.destroy()}async fetchCandidates(n,e,t,i){if(!(e&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const s=[],r=this._computeScreenSizeDistanceParameters(n,t),o={distance:r,mode:this.view?.type??"2d",point:n,coordinateHelper:t.coordinateHelper,...this._types};for(const[,{snappingSource:a,layerView:c}]of this.snappingSources)!a.layerSource.enabled||c!=null&&c.suspended||s.push(a.fetchCandidates(o,i).then(d=>d.filter(p=>!this._candidateIsExcluded(a,p,t.excludeFeature))));const l=(await bt(s)).flat();return this._addRightAngleCandidates(l,n,r,t),Rt(i),We(n,l),l}_addRightAngleCandidates(n,e,t,i){const s=i.vertexHandle!=null?i.vertexHandle.rightEdge?.rightVertex?.pos:i.editGeometryOperations!=null&&i.editGeometryOperations.data.type==="polygon"?i.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,r=i.vertexHandle!=null?i.vertexHandle.leftEdge?.leftVertex?.pos:i.editGeometryOperations!=null?i.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:o}=this,l=y(s,o,i),a=y(r,o,i),c=n.length;for(let d=0;d<c;d++)this._addRightAngleCandidate(n[d],a,e,t,n),this._addRightAngleCandidate(n[d],l,e,t,n)}_addRightAngleCandidate(n,e,t,i,s){if(e==null||!rn(n))return;const r=n.constraint.closestTo(e),o=(r[0]-t[0])/i.x,l=(r[1]-t[1])/i.y,{start:a,end:c}=n.constraint;if(o*o+l*l<=1){const d=new mt({targetPoint:r,otherVertex:e,otherVertexType:re.NEXT,previousVertex:Y(r,a)>Y(r,c)?a:c,constraint:new gt(e,r),objectId:n.objectId,isDraped:n.isDraped});s.push(d)}}_computeScreenSizeDistanceParameters(n,e){let t=this.options!=null?this.options.distance*(e.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:t,y:t,z:t,distance:t}:this.view.type==="2d"?(t*=this.view.resolution,{x:t,y:t,z:t,distance:t}):this._computeScreenSizeDistanceParameters3D(n,t,this.view,e)}_computeScreenSizeDistanceParameters3D(n,e,t,i){const{spatialReference:s}=i;t.renderCoordsHelper.toRenderCoords(n,s,et);const r=t.state.camera.computeScreenPixelSizeAt(et),o=r*t.renderCoordsHelper.unitInMeters/t.mapCoordsHelper.unitInMeters,l=e*o,a=x(n,s,S,t),c=a?Ne(a,n,o,0,0,t,i):0,d=a?Ne(a,n,0,o,0,t,i):0,p=a?Ne(a,n,0,0,o,t,i):0;return{x:c===0?0:l/c,y:d===0?0:l/d,z:p===0?0:l/p,distance:r*e}}get _types(){return{returnEdge:!0,returnVertex:!0}}_candidateIsExcluded(n,e,t){if(t==null)return!1;const i=this._getCandidateObjectId(e);if(i==null)return!1;const s=n.layerSource.layer;return s.type==="graphics"?t.uid===i:t.sourceLayer===s&&!(!t.attributes||!("objectIdField"in s))&&t.attributes[s.objectIdField]===i}_getCandidateObjectId(n){return n instanceof Ue?n.objectId:null}_createSourceInfo(n){const e=this._createFeatureSnappingSourceType(n);if(e==null)return null;if("loading"in e)return this.updatingHandles.addPromise(e.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const t=this.view!=null?this.view.allLayerViews.find(i=>i.layer===n.layer):null;return new sn(e.source,t)}_createFeatureSnappingSourceType(n){switch(n.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(n);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(n);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(n);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(n)}return null}_createFeatureSnappingSourceSceneLayer(n){const{view:e}=this;if(e==null||e.type!=="3d")return null;const t=this._getSourceModule("scene");return t.module!=null?{source:new t.module.SceneLayerSnappingSource({layerSource:n,view:e})}:{loading:t.loader}}_createFeatureSnappingSourceFeatureLayer(n){switch(n.layer.source?.type){case"feature-layer":case"oriented-imagery":{const e=this._getSourceModule("featureService");return e.module!=null?{source:new e.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:n})}:{loading:e.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(n.layer.geometryType==="mesh")return null;const e=this._getSourceModule("featureCollection");return e.module!=null?{source:new e.module.FeatureCollectionSnappingSource({layerSource:n,view:this.view})}:{loading:e.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(n){const e=this._getSourceModule("graphics");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>[n.layer],spatialReference:this.spatialReference,view:this.view,layerSource:n})}:{loading:e.loader}}_createFeatureSnappingSourceMapNotesLayer(n){const e=this._getSourceModule("notes");return e.module!=null?{source:new e.module.GraphicsSnappingSource({getGraphicsLayers:()=>n.layer.sublayers!=null?n.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:n})}:{loading:e.loader}}_getSourceModule(n){const e=this._sourceModules[n];if(e.loader==null){const t=this._loadSourceModule(n).then(i=>{e.module=i});return e.loader=t,{module:e.module,loader:t}}return{module:e.module,loader:e.loader}}_loadSourceModule(n){const e=this.updatingHandles;switch(n){case"featureService":return e.addPromise(ge(()=>import("./FeatureServiceSnappingSource-097ef479.js"),["./FeatureServiceSnappingSource-097ef479.js","./main-79e5ed80.js","./main-7772480e.css","./elevationInfoUtils-287337e4.js","./queryEngineUtils-fc6b642b.js","./VertexSnappingCandidate-25d2058a.js","./PointSnappingHint-b8c54ed3.js","./TileTreeDebugger-67b84aad.js","./geometry2dUtils-9d16f4f8.js","./viewUtils-ca2c33e3.js"],import.meta.url));case"featureCollection":return e.addPromise(ge(()=>import("./FeatureCollectionSnappingSource-371d505d.js"),["./FeatureCollectionSnappingSource-371d505d.js","./main-79e5ed80.js","./main-7772480e.css","./elevationInfoUtils-287337e4.js","./queryEngineUtils-fc6b642b.js","./VertexSnappingCandidate-25d2058a.js","./PointSnappingHint-b8c54ed3.js","./symbologySnappingCandidates-67dc9cb4.js","./geometry2dUtils-9d16f4f8.js","./viewUtils-ca2c33e3.js"],import.meta.url));case"graphics":case"notes":return e.addPromise(ge(()=>import("./GraphicsSnappingSource-809129c2.js"),["./GraphicsSnappingSource-809129c2.js","./main-79e5ed80.js","./main-7772480e.css","./normalizeUtilsSync-f1a97bc7.js","./normalizeUtilsCommon-4aa2ad72.js","./FeatureStore-48143fe8.js","./BoundsStore-d475102f.js","./PooledRBush-506b9510.js","./quickselect-d16016af.js","./optimizedFeatureQueryEngineAdapter-f5f88773.js","./centroid-3dcadaf5.js","./QueryEngine-360bd3bb.js","./normalizeUtils-996b11fe.js","./WhereClause-ae8c5a06.js","./executionError-e8d36121.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-a3586684.js","./generateRendererUtils-0f364d1e.js","./elevationInfoUtils-287337e4.js","./queryEngineUtils-fc6b642b.js","./VertexSnappingCandidate-25d2058a.js","./PointSnappingHint-b8c54ed3.js","./symbologySnappingCandidates-67dc9cb4.js","./geometry2dUtils-9d16f4f8.js","./viewUtils-ca2c33e3.js"],import.meta.url));case"scene":return e.addPromise(ge(()=>import("./SceneLayerSnappingSource-e9068456.js"),["./SceneLayerSnappingSource-e9068456.js","./main-79e5ed80.js","./main-7772480e.css","./VertexSnappingCandidate-25d2058a.js","./PointSnappingHint-b8c54ed3.js","./elevationInfoUtils-287337e4.js","./geometry2dUtils-9d16f4f8.js","./viewUtils-ca2c33e3.js"],import.meta.url))}}};h([u({constructOnly:!0})],q.prototype,"spatialReference",void 0),h([u({constructOnly:!0})],q.prototype,"view",void 0),h([u()],q.prototype,"options",void 0),h([u({readOnly:!0})],q.prototype,"updating",null),h([u({readOnly:!0})],q.prototype,"snappingSources",null),q=h([X("esri.views.interactive.snapping.FeatureSnappingEngine")],q);class sn{constructor(e,t){this.snappingSource=e,this.layerView=t,this.handles=new Nt;const i=this.snappingSource.layerSource.layer;if("refresh"in i){const s=i;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([se(()=>e.updating,s=>e.layerSource.updating=s,me),se(()=>e.availability,s=>e.layerSource.availability=s,me)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}}function rn(n){return(n instanceof nn||n instanceof tn)&&!on(n)}function on({constraint:{start:n,end:e}}){const t=Fe(n,e),i=Y(n,e);return t<Ct()||i/t<ln}function Ne(n,e,t,i,s,r,{spatialReference:o}){const l=Vt(an,e);l[0]+=t,l[1]+=i,l[2]+=s;const a=x(l,o,S,r);return a?en(a,n):1/0}const et=E(),an=E(),ln=1e-4;let $e=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=I.shortLineThreshold*I.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(y(e.leftVertex.pos,this.view,t),y(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return this.squaredShortLineThreshold===0||K(x(t,i,S,this.view),x(e,i,S,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return Y(e,t)<I.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}},cn=class extends ae{constructor({lineStart:e,lineEnd:t,targetPoint:i,isDraped:s}){super(i,new yt(e,t),s,_.SELF),this._referenceLineHint=new V(P.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new V(P.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},dn=class extends $e{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:o}=t,l=x(e,o,S,this.view),{view:a}=this,c=i.edges[s-1];let d=c;do{if(this.edgeExceedsShortLineThreshold(d,t)){const p=we(d,a,t);this._processCandidateProposal(p.left,p.right,e,l,t,r)}d=d.leftVertex.leftEdge}while(d&&d!==c);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:o}=this,{spatialReference:l}=t,a=x(e,l,S,o),c=s.leftEdge,d=s.rightEdge;c&&d&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(d,t)&&this._processCandidateProposal(y(c.leftVertex.pos,o,t),y(d.rightVertex.pos,o,t),e,a,t,i);const p=r.edges[0];let f=p;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,t)){const v=we(f,o,t);this._processCandidateProposal(v.left,v.right,e,a,t,i)}f=f.rightVertex.rightEdge}while(f&&f!==p);return i}_processCandidateProposal(e,t,i,s,r,o){const{spatialReference:l,pointer:a}=r,c=ze(i,{start:e,end:t,type:w.LINE});K(s,x(c,l,S,this.view))<this.squaredProximityThreshold(a)&&o.push(new cn({lineStart:e,lineEnd:t,targetPoint:c,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}},hn=class _t extends Te{constructor(e,t,i,s=_.ALL){super(i,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof _t&&m(this.lineStart,e.lineStart)&&m(this.lineEnd,e.lineEnd)}},pn=class extends ae{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:s}){const r=k(t),{left:o,right:l}=e;nt(r,At(r,r,l),o),super(i,new yt(t,r),s,_.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new V(P.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new hn(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new V(P.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{m(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),m(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),m(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),m(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}};class un extends $e{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,o=[];if(s<2)return o;const{view:l}=this,a=x(e,t.spatialReference,S,l),c=y(i.vertices[r-1].pos,l,t),d=y(i.vertices[0].pos,l,t),p=i.edges[s-1];let f=p;do{if(this.edgeExceedsShortLineThreshold(f,t)){const v=we(f,l,t);this._checkEdgeForParallelLines(v,c,e,a,t,o),this._checkEdgeForParallelLines(v,d,e,a,t,o)}f=f.leftVertex.leftEdge}while(f&&f!==p);return o}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:o}=this,l=x(e,t.spatialReference,S,o),a=s.leftEdge,c=s.rightEdge,d=r.vertices[0],p=y(d.pos,o,t),f=r.vertices.length,v=r.vertices[f-1],A=y(v.pos,o,t),Q=r.edges[0];let M=Q;do{if(M!==a&&M!==c&&this.edgeExceedsShortLineThreshold(M,t)){const fe=we(M,o,t);a&&this._checkEdgeForParallelLines(fe,y(a.leftVertex.pos,o,t),e,l,t,i),c&&this._checkEdgeForParallelLines(fe,y(c.rightVertex.pos,o,t),e,l,t,i),s===d?this._checkEdgeForParallelLines(fe,A,e,l,t,i):s===v&&this._checkEdgeForParallelLines(fe,p,e,l,t,i)}M=M.rightVertex.rightEdge}while(M&&M!==Q);return i}_checkEdgeForParallelLines(e,t,i,s,r,o){const l=e.left,a=e.right;if(be(z,t,l,a),Y(z,t)<I.parallelLineThreshold)return;be(z,i,l,a,t);const{spatialReference:c,pointer:d}=r,p=H(z[0],z[1],i[2]);if(K(s,x(p,c,S,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(p,t)||this.isVertical(l,a)||this._parallelToPreviousCandidate(e,o))return;o.push(new pn({referenceLine:e,lineStart:t,targetPoint:p,isDraped:r.elevationInfo?.mode==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const i=e.left,s=e.right;for(const r of t)if(be(z,s,r.constraint.start,r.constraint.end,i),Y(z,s)<I.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}}const z=D();class fn extends $e{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.vertices.length,r=[];if(s<2)return r;const{view:o}=this,l=x(e,t.spatialReference,S,o),a=i.vertices[s-1];if(this.edgeExceedsShortLineThreshold(a.leftEdge,t)){const d=y(a.pos,o,t),p=y(a.leftEdge.leftVertex.pos,o,t);this._checkForSnappingCandidate(r,p,d,e,l,t)}const c=i.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const d=y(c.pos,o,t),p=y(c.rightEdge.rightVertex.pos,o,t);this._checkForSnappingCandidate(r,p,d,e,l,t)}return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,o=x(e,t.spatialReference,S,r),l=s.leftEdge,a=s.rightEdge;if(l&&l.leftVertex.leftEdge){const c=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=y(c.rightVertex.pos,r,t),p=y(c.leftVertex.pos,r,t);this._checkForSnappingCandidate(i,p,d,e,o,t)}}if(a&&a.rightVertex.rightEdge){const c=a.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const d=y(c.leftVertex.pos,r,t),p=y(c.rightVertex.pos,r,t);this._checkForSnappingCandidate(i,p,d,e,o,t)}}return i}_checkForSnappingCandidate(e,t,i,s,r,o){const{spatialReference:l,pointer:a}=o;O(ye,i,t);const c=pe(gn,ye[1],-ye[0],0),d=ue(c,O(ye,s,i))/he(c),p=de(k(s),i,c,d);if(K(r,x(p,l,S,this.view))<this.squaredProximityThreshold(a)){if(this.isVertical(p,i)||this.isVertical(i,t))return;const f=U(E(),i,c,Math.sign(d));e.push(new mt({targetPoint:p,constraint:new gt(i,f),previousVertex:t,otherVertex:i,otherVertexType:re.CENTER,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}}const ye=D(),gn=E();let yn=class extends ae{constructor({targetPoint:e,point1:t,point2:i,isDraped:s}){super(e,new ft(Ft(E(),t,i,.5),.5*st(t,i)),s,_.SELF),this._p1=t,this._p2=i}get hints(){return[new V(P.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new V(P.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new Pe(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},vn=class extends $e{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:o}=this,l=i.vertices[0],a=i.vertices[r-1],c=y(l.pos,o,t),d=y(a.pos,o,t);return this._processCandidateProposal(c,d,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:o}=this,l=y(s.leftEdge.leftVertex.pos,o,t),a=y(s.rightEdge.rightVertex.pos,o,t);return this._processCandidateProposal(l,a,e,t,i),i}_processCandidateProposal(e,t,i,s,r){if(!this.exceedsShortLineThreshold(e,t,s))return;const o=It(En,e,t,.5),l=.5*st(e,t),a=E();kt(a,i,o,l),a[2]=i[2];const c=a,{spatialReference:d,pointer:p}=s,f=x(i,d,S,this.view);if(K(f,x(c,d,S,this.view))<this.squaredProximityThreshold(p)){if(this.isVertical(e,c)||this.isVertical(c,t))return;r.push(new yn({targetPoint:c,point1:e,point2:t,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};const En=D();let ee=class extends De{constructor(n){super(n),this.updating=!1,this._snappers=new ke,this._domain=_.SELF}initialize(){this._snappers.push(new un(this.view,this.options),new dn(this.view,this.options),new fn(this.view,this.options),new vn(this.view,this.options))}set options(n){this._set("options",n);for(const e of this._snappers)e.options=n}async fetchCandidates(n,e,t){if(!(e&this._domain&&this.options.effectiveSelfEnabled))return[];const i=[];for(const s of this._snappers.items)for(const r of s.snap(n,t))i.push(r);return We(n,i),i}};h([u({readOnly:!0})],ee.prototype,"updating",void 0),h([u({constructOnly:!0})],ee.prototype,"view",void 0),h([u()],ee.prototype,"options",null),ee=h([X("esri.views.interactive.snapping.SelfSnappingEngine")],ee);function Sn(n,e){return[new ee({view:n,options:e}),new q({view:n,options:e,spatialReference:n.spatialReference})]}let L=class extends De{constructor(n){super(n),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new ke,this.distance=I.distance,this.touchSensitivityMultiplier=I.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};h([u()],L.prototype,"enabled",void 0),h([u()],L.prototype,"enabledToggled",void 0),h([u()],L.prototype,"selfEnabled",void 0),h([u()],L.prototype,"featureEnabled",void 0),h([u({type:ke.ofType(zt)})],L.prototype,"featureSources",void 0),h([u()],L.prototype,"distance",void 0),h([u()],L.prototype,"touchSensitivityMultiplier",void 0),h([u({readOnly:!0})],L.prototype,"effectiveEnabled",null),h([u({readOnly:!0})],L.prototype,"effectiveSelfEnabled",null),h([u({readOnly:!0})],L.prototype,"effectiveFeatureEnabled",null),L=h([X("esri.views.interactive.snapping.SnappingOptions")],L);const mn=L;class Ye extends Te{constructor(e,t,i=_.ALL){super(t,i),this.intersectionPoint=e}equals(e){return e instanceof Ye&&m(this.intersectionPoint,e.intersectionPoint)}}class ve extends ae{constructor(e,t,i,s){super(e,new Le(e,t.constraint,i.constraint),s,_.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Ye(this.targetPoint,this.isDraped,this.domain)]}}let N=class extends Ot.EventedMixin(it){constructor(n){super(n),this.options=new mn,this.snappingEnginesFactory=Sn,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=F.MAIN}initialize(){this.handles.add([se(()=>{const{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}=this.options;return{effectiveFeatureEnabled:n,effectiveSelfEnabled:e,touchSensitivityMultiplier:t,distance:i}},()=>{this.doneSnapping(),this.emit("changed")},Ie),se(()=>this.options,n=>{for(const e of this._engines)e.options=n},Ie),se(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:n,snappingEnginesFactory:e})=>this._recreateEngines(n,e),me)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(n=>n.updating)}_recreateEngines(n,e){if(this._destroyEngines(),!n)return;const{view:t,options:i}=this;this._engines=e(t,i)}_destroyEngines(){for(const n of this._engines)n.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:n,touchSensitivityMultiplier:e}=this.options,t=n*e;return t*t}get _squaredSatisfiesConstraintThreshold(){return I.satisfiesConstraintScreenThreshold*I.satisfiesConstraintScreenThreshold}async snap(n){return _n(n)?this._snapMultiPoint(n):this._snapSinglePoint(n)}update(n){const{point:e,context:t}=n;this._removeVisualization();const i=this._currentMainCandidate;if(i==null)return e;const s=this._selectUpdateInput(n);if(s==null)return e;const{spatialReference:r}=t,o=Xe(s,r);if(o==null)return e;const{view:l}=this,{elevationInfo:a,visualizer:c}=t,d=[],p=ce(o,l,t),f=i.constraint.closestTo(p);if(!this._arePointsWithinScreenThreshold(p,f,t))return this._resetSnappingState(),e;i.targetPoint=f,d.push(...i.hints);for(const v of this._currentOtherActiveCandidates)v.targetPoint=f,d.push(...v.hints);return c!=null&&this.handles.add(c.draw(d,{spatialReference:r,elevationInfo:xn(t),view:l,selfSnappingZ:t.selfSnappingZ}),Ee),Be(f,l,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:a})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:n,scenePoint:e}){switch(this._currentSnappedType){case F.MAIN:return n;case F.SCENE:return e}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=F.MAIN}_removeVisualization(){this.handles.remove(Ee)}async _snapSinglePoint({point:n,context:e,signal:t}){const{view:i}=this,s=ce(n,i,e),r=await this._fetchCandidates(s,_.ALL,e,t);return this._createSnapResult(s,F.MAIN,r,i,e,{z:n.z,m:n.m,spatialReference:n.spatialReference,elevationInfo:e.elevationInfo},t)}async _snapMultiPoint({point:n,scenePoint:e,context:t,signal:i}){const{view:s}=this,{coordinateHelper:r,spatialReference:o}=t;await Mt(e.spatialReference,o);const l=Xe(e,o),a=ce(l,s,t),c=await this._fetchCandidates(a,_.FEATURE,t,i);if(c.length>0){const f=await this._fetchCandidates(a,_.SELF,t,i);return this._createSnapResult(a,F.SCENE,[...c,...f],s,t,{z:l.z,m:l.m,spatialReference:l.spatialReference,elevationInfo:t.elevationInfo},i)}const d=ce(n,s,t),p=await this._fetchCandidates(d,_.SELF,t,i);return this._createSnapResult(d,F.MAIN,p,s,t,{z:r.hasZ()&&n.hasZ?n.z??0:void 0,m:r.hasM()&&n.hasM?n.m??0:void 0,spatialReference:n.spatialReference,elevationInfo:t.elevationInfo},i)}async _fetchCandidates(n,e,t,i){return(await Promise.all(this._engines.map(s=>s.fetchCandidates(n,e,t,i)))).flat()}_createSnapResult(n,e,t,i,s,r,o){return{get valid(){return!qt(o)},apply:()=>{const{spatialReference:l}=s,{snappedPoint:a,hints:c}=this._processCandidates(n,e,t,s);return this._removeVisualization(),s.visualizer!=null&&this.handles.add(s.visualizer.draw(c,{spatialReference:l,elevationInfo:S,view:i,selfSnappingZ:s.selfSnappingZ}),Ee),Be(a,i,r)}}}_processCandidates(n,e,t,i){if(t.length<1)return this.doneSnapping(),{snappedPoint:n,hints:[]};this._currentSnappedType!==e&&this._resetSnappingState(),We(n,t);const s=this._currentMainCandidate;if(s!=null){const r=this._findOldConstraintInNewCandidates(s,t);if(r>=0){if(!(t[r]instanceof ve))return this._intersectWithOtherCandidates(r,t,n,e,i);if(this._arePointsWithinScreenThreshold(n,s.targetPoint,i))return this._updateSnappingCandidate(s,e,t,i)}}return this._intersectWithOtherCandidates(0,t,n,e,i)}_findOldConstraintInNewCandidates(n,e){return n instanceof ve?this._findOldCandidateIndex(e,n.first)>=0&&this._findOldCandidateIndex(e,n.second)>=0?0:-1:this._findOldCandidateIndex(e,n)}_intersectWithOtherCandidates(n,e,t,i,s){const{coordinateHelper:r}=s,o=e[n],l=[];for(let a=0;a<e.length;++a){if(a===n)continue;const c=e[a];for(const d of o.constraint.intersect(c.constraint)){const p=d.closestTo(o.targetPoint);l.push([new ve(p,o,c,c.isDraped),this._squaredScreenDistance(t,p,r)])}}return l.length>0&&(l.sort((a,c)=>a[1]-c[1]),l[0][1]<this._squaredPointProximityThreshold(s.pointer))?this._updateSnappingCandidate(l[0][0],i,e,s):this._updateSnappingCandidate(o,i,e,s)}_updateSnappingCandidate(n,e,t,i){this.doneSnapping(),this._currentMainCandidate=n,this._currentSnappedType=e;const s=this._currentMainCandidate.targetPoint,r=[];r.push(...n.hints);for(const o of t){if(n instanceof ve){if(o.constraint.equals(n.first.constraint)||o.constraint.equals(n.second.constraint))continue}else if(o.constraint.equals(n.constraint))continue;const l=o.constraint.closestTo(s);this._squaredScreenDistance(l,s,i.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(o.targetPoint=s,this._currentOtherActiveCandidates.push(o),r.push(...o.hints))}return{snappedPoint:s,hints:r}}_squaredPointProximityThreshold(n){return n==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(n,e,t){return this._squaredScreenDistance(n,e,t.coordinateHelper)<this._squaredPointProximityThreshold(t.pointer)}_squaredScreenDistance(n,e,t){return K(this._toScreen(n,t),this._toScreen(e,t))}_toScreen(n,e){return x(n,e.spatialReference,S,this.view)}_findOldCandidateIndex(n,e){let t=-1;for(let i=0;i<n.length;++i)if(e.constraint.equals(n[i].constraint)){t=i;break}return t}get test(){return{visualizationsActive:this.handles.has(Ee),engines:this._engines}}};var F;h([u({constructOnly:!0})],N.prototype,"view",void 0),h([u()],N.prototype,"options",void 0),h([u({readOnly:!0})],N.prototype,"updating",null),h([u()],N.prototype,"snappingEnginesFactory",void 0),h([u()],N.prototype,"_engines",void 0),h([u()],N.prototype,"_squaredMouseProximityTreshold",null),h([u()],N.prototype,"_squaredTouchProximityThreshold",null),h([u()],N.prototype,"_squaredSatisfiesConstraintThreshold",null),N=h([X("esri.views.interactive.snapping.SnappingManager")],N),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(F||(F={}));const Ee="visualization-handle";function _n(n){return n.scenePoint!=null}function xn({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?S:e}export{Dn as E,q as M,N as P,Ut as T,tn as a,Hn as b,V as c,hn as d,bn as e,Pe as f,An as g,P as h,Vn as i,_ as j,kn as k,Cn as l,mn as m,Ue as n,Ye as o,I as p,zt as q,nn as r,Te as s,We as u};

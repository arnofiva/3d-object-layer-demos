import{aD as l,aE as d,aF as E,au as G,gp as La,c3 as Le,dO as Tt,cD as be,h$ as Sa,aB as R,ca as ea,hG as xa,dL as Oa,cg as dt,dR as Ra,fA as Da,nz as Wa,aS as Pa,eh as ta,e4 as pt,av as yi,aI as ia,cd as de,cr as T,xE as It,gW as Ua,aU as Z,cc as $e,xF as He,dA as Fe,dB as Ga,bi as Mt,aV as nt,xG as ai,sB as Ge,m1 as gi,iY as Na,ok as se,ol as ut,om as ct,az as I,m9 as f,m7 as Ye,cN as ja,bx as ht,iB as Ba,aX as Ha,dU as wi,du as Ne,ma as qa,gN as si,ce as rt,oy as za,xH as Ja,xI as Ka,xJ as Qa,xK as Ya,cq as Za,eS as ni,u5 as ri,ax as qe,aK as ue,aM as W,dw as H,cB as Xa,aw as aa,cY as $t,gc as Ft,xL as es,xM as sa,fB as na,xN as ra,aC as kt,aH as ts,cb as oi,sd as _i,hv as Lt,cy as is,io as vi,xO as as,ee as ss,l0 as oa,wn as ns,hU as rs,ay as os,cs as bi,dY as De,xP as ls,qc as ds,l$ as us,iD as cs,tR as Se,gY as la}from"./main-79e5ed80.js";import{q as ps,y as hs,c as ms,B as fs,h as ys}from"./Spinner-717ea9e5.js";import{t as Ae,W as gs,u as Ii,v as ws,L as Fi,y as je,x as St,O as _s,D as ki,T as at,V as Ci,r as li,n as Te,s as Ze,E as xt,H as ze,I as vs,J as bs,K as Is,_ as Ei,P as da,X as Fs,Y as ks,Q as Cs}from"./vmEvent-27fa49b3.js";import{c as Mi}from"./Subtype-44c0ca14.js";import{l as Es,a as Ms,V as Vi,b as Vs,k as As,o as ua,y as Ts}from"./LayerListViewModel-363ded88.js";import{c as Ot}from"./ArcadeDate-5405c860.js";import{t as $s}from"./ImmutableArray-ee1d0ce7.js";import{f as Ls,x as Bt}from"./symbolUtils-2e5baa60.js";import{h as Ss}from"./GraphicsLayer-6532b5a8.js";import{r as ca}from"./helpMessageUtils-4b0262c8.js";import{q as pa}from"./SnappingManager-e561e372.js";import{s as xs,r as Os}from"./drapedUtils-2204a7de.js";import{e as ha}from"./GraphicState-6c6134a1.js";import{a as Rs}from"./SketchViewModel-0c15215b.js";import"./unitFormatUtils-b50d8ff8.js";import"./AttachmentInfo-03d5deea.js";import"./executionError-e8d36121.js";import"./colorUtils-c0f43caf.js";import"./centroid-b0bb7e76.js";import"./elevationInfoUtils-287337e4.js";import"./geometry2dUtils-9d16f4f8.js";import"./viewUtils-ca2c33e3.js";import"./geodesicUtils-04ddd9a4.js";const K="esri-feature-form",pe=`${K}__group`,Q=`${K}__input`,Ai=`${K}__related-records`,k={base:K,form:`${K}__form`,formHeader:`${K}__form-header`,label:`${K}__label`,relationshipLabel:`${K}__relationship-label`,fieldInputWrapper:`${Q}-wrapper`,fieldInputLoader:`${Q}-loader`,fieldInput:`${Q}`,inputDate:`${Q}--date`,inputTime:`${Q}--time`,inputRadioGroup:`${Q}--radio-group`,inputRadio:`${Q}--radio`,inputRadioLabel:`${Q}--radio-label`,inputDisabled:`${Q}--disabled`,inputSwitch:`${Q}--switch`,inputInvalid:`${Q}--invalid`,centeredButton:`${K}__centered-button`,description:`${K}__description-text`,listObserver:`${K}__list-observer`,relatedRecordsHeader:`${Ai}_header`,relatedRecordsList:`${Ai}_list`,dateInputContainer:`${`${K}__date`}-input-container`,group:pe,groupLabel:`${pe}-label`,groupHeader:`${pe}-header`,groupTitle:`${pe}-title`,groupToggleIcon:`${pe}-toggle-icon`,groupCollapsed:`${pe}--collapsed`,groupSequential:`${pe}--sequential`,groupActive:`${pe}--active`,collapseIcon:"esri-icon-up",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input"};let Ce=class extends G{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};l([d()],Ce.prototype,"objectType",void 0),l([d()],Ce.prototype,"maxValue",void 0),l([d()],Ce.prototype,"minValue",void 0),l([d()],Ce.prototype,"codedValue",void 0),Ce=l([E("esri.layers.support.ContingentValue")],Ce);const D=Ce;let Ee=class extends G{constructor(e){super(e),this.isRetired=!1}};l([d()],Ee.prototype,"id",void 0),l([d()],Ee.prototype,"isRetired",void 0),l([d()],Ee.prototype,"subtype",void 0),l([d()],Ee.prototype,"values",void 0),Ee=l([E("esri.layers.support.Contingency")],Ee);const Ti=Ee;let Xe=class extends G{constructor(e){super(e)}};l([d()],Xe.prototype,"fieldGroup",void 0),l([d()],Xe.prototype,"type",void 0),Xe=l([E("esri.layers.support.ContingencyConstraintViolation")],Xe);const $i=Xe;let et=class extends G{constructor(e){super(e)}};l([d()],et.prototype,"contingentValuesAllGroups",void 0),l([d()],et.prototype,"contingentValuesByFieldGroup",void 0),et=l([E("esri.layers.support.ContingentValuesResult")],et);const Ds=et;let Me=class extends G{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};l([d()],Me.prototype,"name",void 0),l([d()],Me.prototype,"fields",void 0),l([d()],Me.prototype,"isEditingRestrictive",void 0),l([d()],Me.prototype,"contingencies",void 0),Me=l([E("esri.layers.support.FieldGroup")],Me);const Ht=Me;var me;let fe=me=class extends La(Sa){constructor(i){super(i),this.request=Le,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){const{layer:i}=this;return i.type==="subtype-group"?i.subtypeField:i.typeIdField}static async createLoadedLayerContingentValuesCache(i){await i.load();const e=i.sourceJSON;if(i.layerId===void 0)return null;const t=e.hasContingentValuesDefinition;if(t)return new me({layer:i}).load();if(t===void 0){const a=Tt(i.url);if(a==null)return null;const s=a.url.path;if((await me._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const n=i.layerId.toString(),r=await me._staticFetchEnterpriseFieldGroup(s,n);if(r){const o=r.map(u=>({name:u.name,isEditingRestrictive:u.isEditingRestrictive,fields:u.fieldNames.names}));return new me({layer:i,fieldGroupDefinitions:o}).load()}}}return null}async load(i){const e=this.layer.load(i).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,i));return this.addResolvingPromise(e),this}validateContingencyConstraints(i,e){const t=Object.keys(i),a=[],s=[];for(const n of this.fieldGroups){const r=n.isEditingRestrictive?"error":"warning";if(e&&!n.fields.some(c=>e.includes(c)))continue;if(!n.fields.every(c=>t.includes(c))){s.push(new $i({fieldGroup:n,type:r}));continue}let o=!1;const u=i[this.subtypeFieldName],p=n.contingencies.filter(c=>!(!c.isRetired&&c.subtype)||c.subtype.code===u);for(const c of p){let h=!0;for(const m in c.values){const y=c.values[m];if(y.objectType!=="any"){if(y.objectType==="null"){if(i[m]!=null){h=!1;break}}else if(y.objectType==="code"){if(i[m]!==y.codedValue.code){h=!1;break}}else if(y.objectType==="range"){const g=i[m];if(g<y.minValue||g>y.maxValue){h=!1;break}}}}if(h){o=!0;break}}o||a.push(new $i({fieldGroup:n,type:r}))}return{invalid:a,incomplete:s}}getContingentValues(i,e,t=!1){const a=i[this.subtypeFieldName],s=a!=null,n={};let r=[];const o=this.fieldGroups.filter(u=>u.fields.includes(e));r.push(new D({objectType:"any"}));for(const u of o){let p=[];const c=u.contingencies.filter(y=>!(y.isRetired||y.subtype&&s&&y.subtype.code!==a));let h=!1;const m={};for(const y of c){let g,w=!0;for(const _ in y.values){const v=y.values[_];if(e!==_){if(i[_]!==void 0&&v.objectType!=="any"){if(v.objectType==="null")i[_]!==null&&(w=!1);else if(v.objectType==="code")i[_]!==v.codedValue.code&&(w=!1);else if(v.objectType==="range"){const b=i[_];(b<v.minValue||b>v.maxValue)&&(w=!1)}}}else g=v,h=h||v.objectType==="range"}if(g&&w){if(g.objectType==="any"){p.length=0,p.push(g);break}const _=this._generateKey(g);m[_]||p.push(g),m[_]=!0}}h&&(p=this._joinRange(p)),n[u.name]=p,r=t?this._filterIntersection(r,p):[]}return o.length===1&&t&&(r=[]),new Ds({contingentValuesAllGroups:r,contingentValuesByFieldGroup:n})}_generateKey(i){switch(i.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return i.codedValue.name+i.codedValue.code.toString();case"range":return i.minValue.toString()+"-"+i.maxValue.toString()}}_joinRange(i){let e,t;i.sort((s,n)=>s.objectType==="null"?-1:n.objectType==="null"?1:s.minValue-n.minValue);const a=[];for(const s of i)s.objectType!=="null"?e!=null&&t!=null?t<s.minValue?(a.push(new D({objectType:"range",minValue:e,maxValue:t})),e=s.minValue,t=s.maxValue):t<s.maxValue&&(t=s.maxValue):(e=s.minValue,t=s.maxValue):a.push(s);return a.push(new D({objectType:"range",minValue:e,maxValue:t})),a}_filterIntersection(i,e){if(i.length===0||e.length===0)return[];if(i[0].objectType==="any")return e;if(e[0].objectType==="any")return i;const t=i[0].objectType==="range"||i[1]?.objectType==="range",a=e[0].objectType==="range"||e[1]?.objectType==="range";return t||a?this._intersectRanges(i,e):this._intersectValues(i,e)}_intersectRanges(i,e){const t=[];let a,s=0;for(const n of i)for(;s<e.length;s++){const r=e[s];if(n.objectType==="null"&&r.objectType==="null")t.push(new D({objectType:"null"}));else{if(n.objectType==="null")break;if(r.objectType==="null")continue}if(n.maxValue<r.minValue)break;if(n.maxValue===r.minValue){t.push(new D({objectType:"range",minValue:n.maxValue,maxValue:r.minValue}));break}if(!(n.minValue>r.maxValue))if(n.minValue!==r.maxValue){if(a=n.minValue>r.minValue?n.minValue:r.minValue,n.maxValue<r.maxValue){t.push(new D({objectType:"range",minValue:a,maxValue:n.maxValue}));break}t.push(new D({objectType:"range",minValue:a,maxValue:r.maxValue}))}else t.push(new D({objectType:"range",minValue:n.minValue,maxValue:r.maxValue}))}return t}_intersectValues(i,e){const t=[];for(const a of i)e.some(s=>{if(a.objectType===s.objectType)switch(a.objectType){case"any":case"null":return!0;case"code":return a.codedValue.code===s.codedValue.code&&a.codedValue.name===s.codedValue.name}return!1})&&t.push(a);return t}static async _staticFetchEnterpriseFeatureRoot(i,e){return Le(i,{responseType:"json",query:{f:"json"},...e}).then(t=>t.data)}static async _staticFetchEnterpriseFieldGroup(i,e,t){return Le(`${i}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([e]),f:"json"},...t}).then(a=>a.data.layerDataElements?.[0].dataElement.fieldGroups)}async _initializeContingentValues(i,e){const t=i??await this._fetchFieldGroupDefs(e);if(t.length===0)return void(this.fieldGroups=[]);const a=await this._fetchContingentValues(t,e);this.fieldGroups=a}async _fetchFieldGroupDefs(i){if(this.layer.layerId===void 0)return[];const e=this.layer.sourceJSON,t=this.layer.layerId.toString(),a=Tt(this.layer.url).url.path;return e.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(a,t,i)).map(s=>({name:s.name,isEditingRestrictive:s.restrictive,fields:s.fields.map(n=>this.layer.fieldsIndex.normalizeFieldName(n))})):e.hasContingentValuesDefinition!==void 0?[]:this._fetchEnterpriseFeatureRoot(a,i).then(async s=>s.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(a,t,i)).map(n=>({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fieldNames.names.map(r=>this.layer.fieldsIndex.normalizeFieldName(r))})):[])}async _fetchAGOLFieldGroup(i,e,t){return Le(`${i}/${e}/fieldgroups`,{responseType:"json",query:{f:"json"},...t}).then(a=>a.data.fieldGroups)}async _fetchEnterpriseFieldGroup(i,e,t){return me._staticFetchEnterpriseFieldGroup(i,e,t)}async _fetchEnterpriseFeatureRoot(i,e){return me._staticFetchEnterpriseFeatureRoot(i,e)}async _fetchContingentValues(i,e){if(this.layer.layerId===void 0)return[];const t=this.layer.sourceJSON,a=this.layer.layerId.toString(),s=Tt(this.layer.url).url.path;if(t.hasContingentValuesDefinition){const r=await this._fetchAGOLContingentValues(s,a,e);return this._constructFieldGroupsAGOL(i,r)}const n=await this._fetchEnterpriseContingentValues(s,a,e);return this._constructFieldGroupsEnterprise(i,n)}_constructFieldGroupsAGOL(i,e){return i.map(t=>{const a=e.contingentValuesDefinition.fieldGroups.find(s=>s.name===t.name);if(a){let s=[];return s=e.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(t,e,a.subTypes):this._parseAGOLFieldGroup(t,e,a.contingentValues),new Ht({name:t.name,isEditingRestrictive:t.isEditingRestrictive,fields:t.fields,contingencies:s})}return null}).filter(be)}_parseAGOLFieldGroupSubtype(i,e,t){let a=[];return t?.forEach(s=>{const n=this._getSubtypeAGOL(s.name);a=a.concat(this._parseAGOLFieldGroup(i,e,s.contingentValues,n))}),a}_parseAGOLFieldGroup(i,e,t,a=null){const s=[];for(const n of t??[]){const r=this._parseAGOLContingency(n,i,e,a);s.push(r)}return s}_parseAGOLContingency(i,e,t,a){const s=i.id,n=!!i.retired&&i.retired===1,r={};for(let o=0,u=0;o<e.fields.length;o++){const p=e.fields[o],c=t.typeCodes[i.types[o]];if(c==="Code"){let h=i.values[u];u++;const m=this._getDomain(a,p);if(this.layer.getField(p)?.type==="string"){const _=t.stringDicts.find(v=>v.domain===m.name);_&&(h=_.entries[h])}const g=m.codedValues.find(_=>_.code===h),w=new D({codedValue:g,objectType:"code"});r[p]=w}else if(c==="Range"){const h=i.values[u];u++;const m=h.range[0],y=h.range[1],g=new D({minValue:m,maxValue:y,objectType:"range"});r[p]=g}else if(c==="Any"){const h=new D({objectType:"any"});r[p]=h}else{const h=new D({objectType:"null"});r[p]=h}}return new Ti({id:s,isRetired:n,subtype:a,values:r})}_constructFieldGroupsEnterprise(i,e){const t=e.fieldGroups;return i.map(a=>{const s=t.find(n=>n.name===a.name);if(s){const n=s.contingencies.map(r=>{const o=r.id,u=r.isRetired||!1,p=this._getSubtypeEnterprise(r.subtypeCode),c={};for(let h=0;h<a.fields.length;h++){const m=a.fields[h];let y=r.values[h];if(typeof y=="number"||typeof y=="string"){const g=this._getDomain(p,m),w=this.layer.getField(m);w?.type==="string"?y=e.stringDictionary[y]:w?.type==="date"&&(y=new Date(`${y}+00:00`).getTime());const _=g.codedValues.find(b=>b.code===y),v=new D({codedValue:_,objectType:"code"});c[m]=v}else if(typeof y=="object"){const g=y.minValue,w=y.maxValue,_=new D({minValue:g,maxValue:w,objectType:"range"});c[m]=_}else if(y){const g=new D({objectType:"any"});c[m]=g}else{const g=new D({objectType:"null"});c[m]=g}}return new Ti({id:o,isRetired:u,subtype:p,values:c})});return new Ht({name:a.name,isEditingRestrictive:a.isEditingRestrictive,fields:a.fields,contingencies:n})}return null}).filter(be)}async _fetchEnterpriseContingentValues(i,e,t){return Le(`${i}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([e]),f:"json"},...t}).then(a=>a.data.contingentValueSets?.[0])}async _fetchAGOLContingentValues(i,e,t){return Le(`${i}/${e}/contingentValues`,{responseType:"json",query:{f:"json"},...t}).then(a=>a.data)}_getSubtypeEnterprise(i){const e=this.layer.sourceJSON;let t;if(e.subtypes){const a=e.subtypes.find(s=>s.code===i);t=Mi.fromJSON(a)}return t||null}_getSubtypeAGOL(i){const e=this.layer.sourceJSON;let t;if(e.subtypes){const a=e.subtypes.find(s=>s.name===i);t=Mi.fromJSON(a)}return t||null}_getDomain(i,e){const t=i?i.domains?.[e]:this.layer.getFieldDomain(e);return t?.type==="inherited"?this.layer.getFieldDomain(e):t}};l([d({constructOnly:!0})],fe.prototype,"layer",void 0),l([d({constructOnly:!0})],fe.prototype,"request",void 0),l([d({type:[Ht]})],fe.prototype,"fieldGroups",void 0),l([d({constructOnly:!0})],fe.prototype,"fieldGroupDefinitions",void 0),l([d()],fe.prototype,"subtypeFieldName",null),fe=me=l([E("esri.layers.support.LayerContingentValuesCache")],fe);const Ws=fe;let st=null;function Ps(i,e,t,a={}){const s=e.elementType,n="value",r=s.type==="array"?[{name:n,type:s.type,elementType:s.elementType}]:s.type==="dictionary"?[{name:n,type:s.type,properties:s.properties}]:[{name:n,type:s.type}];return new $s(i.map(o=>{const u={};return di(u,r,{[n]:o},t,a),u[n]}))}function Us(i,e,t={}){const a=i instanceof Ra?new Da({source:i.features,geometryType:i.geometryType,fields:i.fields,spatialReference:i.spatialReference}):i;return e.constructFeatureSet(a,t.spatialReference,null,!0,t.lruCache,t.interceptor)}function Gs(i,e,t={}){const{spatialReference:a,interceptor:s,lruCache:n}=t;return typeof i=="string"?e.createFeatureSetCollectionFromService(i,a,n,s):e.createFeatureSetCollectionFromMap(i,a,n,s)}function Ns(i,e,t,a={}){const s={};return di(s,e.properties,i,t,a),new st.Dictionary(s)}function di(i,e,t,a,s={}){const n={};for(const r of Object.keys(t))n[r.toLowerCase()]=t[r];for(const r of e){const o=r.name.toLowerCase();if(s.variablesPreProcessed)i[o]=n[o];else switch(r.type){case"array":{const u=n[o];i[o]=Ps(u,r,a,s);break}case"feature":{const u=n[o];i[o]=u==null?null:st.Feature.createFromGraphic(u,s?.timeReference);break}case"featureSet":{const u=n[o];i[o]=a?Us(u,a,s):null;break}case"featureSetCollection":{const u=n[o];i[o]=a?Gs(u,a,s):null;break}case"dictionary":{const u=n[o];i[o]=Ns(u,r,a,s);break}case"date":{const u=n[o];i[o]=u?u instanceof Ot?u:s?.timeReference?.timeZone?Ot.dateJSAndZoneToArcadeDate(u,s?.timeReference?.timeZone):Ot.dateJSToArcadeDate(u):null;break}case"geometry":case"boolean":case"text":case"number":i[o]=n[o]}}}function ma(i,e){for(const t of i)e.push(t),t.type==="dictionary"&&ma(t.properties,e);return e}function Li(i,e,t,a,s){const{spatialReference:n,interceptor:r,lruCache:o,console:u,abortSignal:p,timeReference:c,services:h={portal:Oa.getDefault()}}=t,m={vars:{},spatialReference:n,interceptor:r,timeReference:c,lrucache:o,useAsync:s,services:h,console:u,abortSignal:p};return e&&di(m.vars,i.variables,e,a,t),m}function Ct(i,e){switch(e.getArcadeType(i)){case"number":case"text":case"boolean":case"point":case"polygon":case"polyline":case"multipoint":case"extent":return i;case"date":return i.toJSDate();case"feature":{const t=(i.type,i),a="geometry"in t?t.geometry():null,s="readAttributes"in t?t.readAttributes():t.attributes;return new dt({geometry:a,attributes:s})}case"dictionary":{const t=i,a=t.attributes,s={};for(const n of Object.keys(a))s[n]=Ct(t.field(n),e);return s}case"array":return("toArray"in i?i.toArray():i).map(t=>Ct(t,e))}return i}const Si={variables:[{name:"$feature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"}]},xi={variables:[{name:"$feature",type:"feature"},{name:"$aggregatedFeatures",type:"featureSet"}]},Oi=new Map([["form-constraint",{variables:[{name:"$feature",type:"feature"}]}],["feature-z",{variables:[{name:"$feature",type:"feature"}]}],["field-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$datastore",type:"featureSetCollection"}]}],["form-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$originalFeature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$featureSet",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$editContext",type:"dictionary",properties:[{name:"editType",type:"text"}]}]}],["labeling",{variables:[{name:"$feature",type:"feature"}]}],["popup",Si],["popup-element",Si],["feature-reduction-popup",xi],["feature-reduction-popup-element",xi],["visualization",{variables:[{name:"$feature",type:"feature"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"}]}]}]]);function js(i){const e=Oi.get(i);if(!e){const t=Array.from(Oi.keys()).map(a=>`'${a}'`).join(", ");throw new R("createArcadeProfile:invalid-profile-name",`Invalid profile name '${i}'. You must specify one of the following values: ${t}`)}return ea(e)}async function Bs(i,e,t={}){st||(st=await xa());const{arcade:a,arcadeUtils:s}=st,{loadScriptDependencies:n,referencesMember:r,scriptIsAsync:o}=a,u=ma(e.variables,[]),p=u.filter($=>$.type==="featureSet"||$.type==="featureSetCollection").map($=>$.name.toLowerCase()),c=a.parseScript(i,p);if(!c)throw new R("arcade:invalid-script","Unable to create SyntaxTree");const h=s.extractFieldNames(c),m=a.scriptTouchesGeometry(c),y=u.map($=>$.name.toLowerCase()).filter($=>r(c,$)),g=o(c,p);await n(c,g,p);const w={vars:{},spatialReference:null,useAsync:g};for(const $ of y)w.vars[$]="any";const{lruCache:_}=t,v=a.compileScript(c,w),b=a.featureSetUtils(),{services:F}=t;return{execute:($,ce={})=>{if(g)throw new R("arcade:invalid-execution-mode","Cannot execute the script in synchronous mode");const ke=v(Li(e,$,{lruCache:_,...ce},b,g));return ce.rawOutput?ke:Ct(ke,s)},executeAsync:async($,ce={})=>{const ke=await v(Li(e,$,{lruCache:_,services:F,...ce},b,g));return ce.rawOutput?ke:Ct(ke,s)},isAsync:g,variablesUsed:y,fieldsUsed:h,geometryUsed:m,syntaxTree:c}}var fa;const Hs=Symbol("FormExpressionArcadeExecutor");let P=class extends G{constructor(e){super(e),this[fa]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._stale=!1,this._updatingTracking=new Pa,this._executeAsyncDebounced=ta(async(t,a,s)=>{const n=await this.executor.executeAsync(t,{...a,abortSignal:s});return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=n,this._stale=!1,n)})}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,t){this._abortController=new AbortController;const a=this.executor.execute(e,{...t,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=a,a}async executeAsync(e,t){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,t??{},this._abortController.signal))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};fa=Hs,l([d()],P.prototype,"_lastEvaluatedValue",void 0),l([d()],P.prototype,"_stale",void 0),l([d()],P.prototype,"_updatingTracking",void 0),l([d({constructOnly:!0})],P.prototype,"executor",void 0),l([d()],P.prototype,"isAsync",null),l([d()],P.prototype,"fieldsUsed",null),l([d()],P.prototype,"syntaxTree",null),l([d()],P.prototype,"updating",null),l([d()],P.prototype,"stale",null),l([d()],P.prototype,"geometryUsed",null),l([d()],P.prototype,"variablesUsed",null),l([d()],P.prototype,"lastEvaluatedValue",null),P=l([E("esri.widgets.FeatureForm.FormExpressionArcadeExecutor")],P);const qs=async(i,e)=>{const t=js("form-calculation"),a=await Bs(i,t,{});return e?.fieldsIndex&&(a.fieldsUsed=Wa(e.fieldsIndex,a.fieldsUsed)),new P({executor:a})},Rt="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",zs="esri.widgets.FeatureForm.FormExpressionsManager";let ye=class extends G{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}get _baseContext(){const{editType:e,layer:t,map:a,originalFeature:s,spatialReference:n}=this.arcadeContextInfo,r=t?.type==="feature"?t:t?.type==="scene"&&t.associatedLayer!=null?t.associatedLayer:void 0;return[{$originalfeature:s,$editcontext:{editType:e},$layer:r,$featureset:r,$datastore:t?.url,$map:a},{spatialReference:n??void 0}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:t,_latestFieldValues:a,feature:s}=this,n=new Set;for(const r of e)if(a[r]=s.getAttribute(r),t.has(r))for(const o of t.get(r))n.add(o);return this._evaluate([...n])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(Rt))return this._evaluate([...this._fieldReferencesLookup.get(Rt)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:t,executors:a}=this,s=new Map(this.fieldInputs.map(r=>[r.name,r])),n=new Map(a.map(r=>[r,new Array]));for(const r of a){for(const o of r.fieldsUsed){pt(e,o,()=>new Set).add(r);const u=s.get(o),p=u?.valueExpressionExecutor,c=u?.editableExpressionExecutor;p!=null&&p!==r&&(n.get(p).push(r),pt(t,p,()=>new Set).add(u)),c!=null&&c!==r&&(n.get(c).push(r),pt(t,c,()=>new Set).add(u))}r.geometryUsed&&pt(e,Rt,()=>new Set).add(r)}return n}async _evaluate(e){const t=new Map,{_dependencyGraph:a,_fieldsAffectedLookup:s,_latestFieldValues:n}=this;for(const o of e)ya(o,t,a);for(const[o,{resolver:u,dependencyPromises:p}]of t)Promise.all(p).then(async()=>{const[c,h]=this._makeContext(n);return o.executeAsync(c,h)}).then(()=>{if(s.has(o))for(const c of s.get(o))this._latestFieldValues[c.name]=c.value;u.resolve()},c=>{!c||yi(c)||Ri(c)||o.markStale(),u.reject(c)});const r=(await Promise.allSettled(Array.from(t.values(),({resolver:o})=>o.promise))).filter(o=>o.status==="rejected"&&!(yi(o.reason)||Ri(o.reason)));if(r.length>0)throw new AggregateError(r,"One or more expression executions failed")}_makeContext(e){const[t,a]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...t,$feature:s},a]}};l([d()],ye.prototype,"_baseContext",null),l([d()],ye.prototype,"feature",null),l([d()],ye.prototype,"executors",void 0),l([d()],ye.prototype,"fieldInputs",void 0),l([d()],ye.prototype,"arcadeContextInfo",void 0),ye=l([E(zs)],ye);const ya=(i,e,t)=>{if(e.has(i))return;const a=ia();e.set(i,{resolver:a,dependencyPromises:[]}),i.abort();const s=t.get(i);for(const n of s)ya(n,e,t),e.get(n).dependencyPromises.push(a.promise)},Ri=i=>i&&typeof i=="object"&&"message"in i&&i.message==="Cancelled",ga="esri.widgets.FeatureForm.GroupInput",Di=de.getLogger(ga);let ge=class extends Es{constructor(e){super(e),this._expressionTrackingHandles=new Map,this.type="group"}initialize(){this.addHandles([T(()=>[this.visible,this.inputs],([e])=>{const{inputs:t}=this,a=!!e&&void 0;for(const s of t)Ae(s)&&(s.required=a)},{initial:!0,equals:(e,t)=>t[0]===e[0]&&t[1]===e[1]})])}destroy(){for(const e of this._expressionTrackingHandles.values())e.remove()}set inputFields(e){It(Di,"Property: GroupInput.inputFields",{replacement:"GroupInput.inputs",version:"4.27"}),this.inputs=e}get inputFields(){return It(Di,"Property: GroupInput.inputFields",{replacement:"GroupInput.inputs",version:"4.27"}),this.inputs}get inputs(){return this._get("inputs")}set inputs(e){this.handles.removeAll(),e&&this.handles.add(e.map(t=>T(()=>t.visible,()=>this._dirtyEvaluatedVisibilityExpression()))),this._set("inputs",e)}get label(){return this.element.label}set label(e){Ua(this.element,t=>{t.label=e})}get state(){return this.element.initialState||"expanded"}set state(e){this._overrideIfSome("state",e)}get visible(){return this.evaluatedVisibilityExpression!==!1&&this.inputs&&this.inputs.some(e=>e.visible)}_dirtyEvaluatedVisibilityExpression(){const{element:e}=this;e.visibilityExpression&&this.notifyChange("evaluatedVisibilityExpression")}};l([d()],ge.prototype,"inputs",null),l([d()],ge.prototype,"label",null),l([d()],ge.prototype,"state",null),l([d({readOnly:!0})],ge.prototype,"type",void 0),l([d()],ge.prototype,"visible",null),ge=l([E(ga)],ge);const Js=ge,Ks=3;let S=class extends Ms{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.handles.add([T(()=>({feature:this.feature,element:this.element,layer:this.layer}),t=>this._createRelationshipVM(t),Z)])}destroy(){this._relationshipVM?.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:t,_relationshipVM:a}=this;if(!a?.relationship||!this.loaded||!this.relatedLayerAllowsAdds)return!1;const{cardinality:s,role:n}=a.relationship;return!(s==="one-to-one"&&t>0)&&s!=="many-to-many"&&!(s==="one-to-many"&&n==="destination"&&t>0)&&e}get displayCount(){return this.element.displayCount??Ks}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!1)}get featureCount(){return this._relationshipVM?.featureCount??0}get map(){return this._get("map")}set map(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){return this._relationshipVM?.relatedFeatureInfos??[]}get relatedLayer(){return this._relationshipVM?.relatedLayer}get relatedLayerAllowsAdds(){const{relatedLayer:e}=this;return!e||!this.relatedLayerAllowsEdits?!1:!!$e(e)?.operations?.supportsAdd}get relatedLayerAllowsEdits(){const{relatedLayer:e}=this;return e?!!$e(e)?.operations?.supportsEditing:!1}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get visible(){const{_relationshipVM:e,relatedLayer:t}=this;if(!e?.relationship)return!1;const{cardinality:a}=e.relationship;return a!=="many-to-many"&&!(t&&!He(t))&&(this.evaluatedVisibilityExpression!=null?this.evaluatedVisibilityExpression:this.element!=null)}get updating(){return this._relationshipVM?.state==="loading"||this._relationshipVM?.state==="querying"}get loaded(){return this._relationshipVM?.state==="ready"}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){const{feature:t,element:a,layer:s}=e;if(this._relationshipVM?.destroy(),!t||!a||!s)return;const{displayCount:n,map:r,orderByFields:o,relationshipId:u,showAllEnabled:p}=this;gs(s)&&(this._relationshipVM=new ps({graphic:t,displayCount:n,layer:s,map:r,orderByFields:o,relationshipId:u,showAllEnabled:p}))}};l([d()],S.prototype,"canAddRelatedFeature",null),l([d()],S.prototype,"displayCount",null),l([d()],S.prototype,"displayType",null),l([d()],S.prototype,"editable",null),l([d()],S.prototype,"group",void 0),l([d()],S.prototype,"map",null),l([d()],S.prototype,"orderByFields",null),l([d()],S.prototype,"relationshipId",null),l([d()],S.prototype,"relatedFeatureInfos",null),l([d()],S.prototype,"relatedLayer",null),l([d()],S.prototype,"relatedLayerAllowsAdds",null),l([d()],S.prototype,"relatedLayerAllowsEdits",null),l([d()],S.prototype,"showAllEnabled",null),l([d()],S.prototype,"showAllActionVisible",null),l([d({readOnly:!0})],S.prototype,"type",void 0),l([d()],S.prototype,"visible",null),l([d()],S.prototype,"updating",null),l([d()],S.prototype,"incrementPage",null),l([d()],S.prototype,"getRelatedFeatureByObjectId",null),S=l([E("esri.widgets.FeatureForm.RelationshipInput")],S);const Qs=S,Dt=new dt({attributes:{}}),Ys=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],Zs=["visibilityExpression"],Xs=["editableExpression","visibilityExpression"],en="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",xe="#JSAPI_CONTINGENT_VALUE_ANY_HASH",tn="#JSAPI_CONTINGENT_VALUE_NULL_HASH",ui="esri.widgets.FeatureForm.FeatureFormViewModel",mt=de.getLogger(ui);let M=class extends Fe(Ga(Mt.EventedAccessor)){constructor(e){super(e),this._expressionExecutorLookup=new Map,this._expressionLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=Dt.clone(),this._initialFeature=Dt.clone(),this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.inputs=[],this.map=null,this.relatedRecordCallbacks=null,this.strict=!1}initialize(){const e=T(()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.arcadeEditType],([s,n])=>{s!=null&&(n?this._updateInputs():s.load().catch(()=>de.getLogger(this).error("Failed to load layer",s.loadError)))},{equals:([s,n,r,o,u],[p,c,h,m,y])=>s===p&&n===c&&r===h&&o===m&&u===y,initial:!0}),t=T(()=>this._arcadeContextInfo,s=>{this._expressionsManager!=null&&(this._expressionsManager.arcadeContextInfo=s)}),a=T(()=>this.layer,s=>{const n=s?.type==="subtype-sublayer"?s.parent:s?.type==="feature"?s:null;n&&this.addResolvingPromise(Ws.createLoadedLayerContingentValuesCache(n).then(r=>{this._contingentValuesCache=r,this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.handles.add([e,t,a])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=nt(this._contingentValuesCache)}get activeRelationshipInput(){return this.allRelationshipInputs.find(e=>e.relationshipId===this.relationshipId)}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:t,layer:a,map:s,spatialReference:n}=this;return{layer:ai(a)?a:null,originalFeature:e,editType:t,map:s,spatialReference:n}}get allFieldInputs(){return Ii(this.inputs)}get allRelationshipInputs(){return ws(this.inputs)}get _layerFieldsByName(){return new Map(this.layer?.fields.map(e=>[e.name,e]))}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():Dt.clone(),this._initialFeature=this._featureClone.clone(),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach(t=>t.feature=e)):(this.inputs.forEach(t=>t.destroy()),this.inputs.length=0),this.contingencyConstraintViolations.clear(),this._expressionsManager!=null&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated()))),this._set("feature",e)}get fieldsWithContingentValues(){if(this._contingentValuesCache==null)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap(t=>t.fields);return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){e===void 0?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:t}=this;return e!=null&&e.description&&t?Fi(e.description,this.getValues(),t.fieldsIndex):null}get formTitle(){const{formTemplate:e,layer:t}=this;return e!=null&&e.title&&t?Fi(e.title,this.getValues(),t.fieldsIndex):null}formHeaderVisible(){const{activeRelationshipInput:e,formDescription:t,formTitle:a}=this;return!(e||!t&&!a)}set inputFields(e){Ge(mt,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs=e}get inputFields(){return Ge(mt,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){const t=this.allRelationshipInputs;if(e!=null&&e===this.relationshipId||t.forEach(a=>a.showAllEnabled=!1),e!=null){const a=t.find(s=>s.relationshipId===e);a&&(a.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.get("layer.loaded")?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter(e=>!e.valid).every(({submittable:e})=>e)}get updating(){return this.updatingHandles.updating}get valid(){const e=this.allFieldInputs;return e.length>0&&e.every(({valid:t})=>t)}get view(){return Ge(mt,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._get("view")}set view(e){Ge(mt,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._set("view",e),e?.map&&(this.map=e.map)}findField(e){return this.allFieldInputs.find(t=>t.name===e)}getValue(e){const{_featureClone:t,layer:a}=this,s=!!a?.getField(e);return t.getAttribute(e)??(s?null:void 0)}setValue(e,t){const{_featureClone:a,strict:s}=this,n=this.findField(e);t=t===""?null:t,n&&a.getAttribute(e)!==t&&(n.value=t,s&&!n.valid||(this._afterValueChange(n),this._expressionsManager!=null&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([n.name]).finally(()=>this._afterExpressionsEvaluated()))))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this.allFieldInputs,t=new Set(e.filter(n=>n.valid).map(({name:n})=>n)),a=e.filter(n=>!n.valid).map(({name:n})=>n),s=this.getValues();if(this.validateContingencyConstraints(s,{includeIncompleteViolations:!0}).length>0)for(const[n,r]of this.contingencyConstraintViolations.entries())r.type==="error"&&(t.delete(n),a.push(n));this.emit("submit",{valid:[...t],invalid:a,values:s})}validateContingencyConstraints(e,t){const{_contingentValuesCache:a}=this,s=new Map;if(this.contingencyConstraintViolations=s,a==null)return[];const{invalid:n,incomplete:r}=a.validateContingencyConstraints(e),o=[...n,...t?.includeIncompleteViolations?r:[]];for(const u of o)for(const p of u.fieldGroup.fields)s.set(p,u);return o}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:t,_featureClone:a}=this;a.geometry=t.geometry,e!=null&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally(()=>this._afterExpressionsEvaluated()))}_emitChangeEvent({name:e,valid:t,value:a}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:a,valid:t})}_updateInputs(){const{_featureClone:e,_initialFeature:t,arcadeEditType:a,formTemplate:s,inputs:n,layer:r}=this;if(!r)return;const o={arcadeEditType:a,feature:e,initialFeature:t,layer:r},u=n.slice(),p=s!=null&&s.elements&&s.elements.length>0?this._updateInputsUsingFormElements(u,s.elements,o):this._updateInputsUsingLayerFields(u,r?.fields,o);this.inputs=p}_updateInputsUsingFormElements(e,t,a){const s=new Map;for(const o of e)if(je(o)){s.set(o.element,o);for(const u of o.inputs)u.element&&s.set(u.element,u)}else o.element&&s.set(o.element,o);const n=new Map,r=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:s,updatedElements:t.filter(Wi),sharedInitializationProperties:a,group:null,newExpressionExecutorPromises:n});this.updatingHandles.addPromise(Promise.all(Array.from(n.values())).then(()=>{const o=Array.from(this._expressionExecutorLookup.values()),u=Ii(r);return this._createExpressionsManager(o,u),this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())}));for(const[o,u]of s.entries())s.delete(o),u.destroy();return r}_updateInputsUsingFormElementsRecursive(e){const{existingInputsByElement:t,updatedElements:a,sharedInitializationProperties:s,group:n,newExpressionExecutorPromises:r}=e,o=[];for(const u of a){const p=t.has(u),c=p?t.get(u):St(u)?this._makeGroupInputFromElement(u,s):_s(u)?this._makeFieldInputFromElement(u,s,n):ki(u)?this._makeRelationshipInputFromElement(u,s,n):null;if(c){if(o.push(c),p)if(t.delete(u),je(c)){const{feature:h}=s;c.set({feature:h})}else if(at(c)){const h=this.relationshipId===u.relationshipId;c.set(s),c.set({map:this.map,showAllEnabled:h})}else c.set(s);else this._assignExpressionExecutors(c,u,r);if(St(u)){const h=u.elements.filter(m=>Wi(m));c.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:t,updatedElements:h,sharedInitializationProperties:s,group:c,newExpressionExecutorPromises:r})}}}return o}_updateInputsUsingLayerFields(e,t,a){if(!Array.isArray(t))return de.getLogger(this).warn(this.declaredClass,"No attribute fields found."),[];const s=new Map;for(const c of e)if(je(c)){for(const h of c.inputs)h.destroy();c.inputs.length=0,c.destroy()}else at(c)?c.destroy():Ae(c)&&(c.element!==null?c.destroy():s.set(c.field,c));const n=[],{arcadeEditType:r,feature:o,initialFeature:u,layer:p}=a;for(const c of t){const h=s.get(c)??new Vi({arcadeEditType:r,field:c,feature:o,initialFeature:u,layer:p,value:o?.getAttribute(c.name)??null});n.push(h),s.delete(c)}for(const[c,h]of s.entries())s.delete(c),h.destroy();return n}_resetFieldInputValues(e){for(const t of this.allFieldInputs)t.value=e.getAttribute(t.name)}_makeFieldInputFromElement(e,t,a){const{arcadeEditType:s,feature:n,initialFeature:r,layer:o}=t,{fieldName:u}=e,p=u&&this._layerFieldsByName.get(u);return p?new Vi({arcadeEditType:s,element:e,field:p,value:n?.getAttribute(e.fieldName)??null,feature:n,initialFeature:r,layer:o,group:a}):null}_makeGroupInputFromElement(e,t){const{feature:a,layer:s}=t;return new Js({element:e,inputs:[],feature:a,layer:s})}_makeRelationshipInputFromElement(e,t,a=null){const{map:s}=this,{feature:n,layer:r}=t;return new Qs({element:e,feature:n,group:a,layer:r,map:s})}_assignExpressionExecutors(e,t,a){const s=St(t)?Zs:ki(t)?Xs:Ys,n=[];for(const r of s){const o=t[r],{_expressionExecutorLookup:u}=this;if(o!=null&&o!==""){const p=`${r}Executor`,c=this._expressionLookup.get(o)??this._addToExpressionLookup(o);if(u.has(c))e[p]=u.get(c);else if(a.has(c)){const h=a.get(c).then(m=>(e[p]=m,m));a.set(c,h)}else{const h=qs(c,this.layer).then(m=>(e[p]=m,u.set(c,m),m));a.set(c,h)}}}return n}_createExpressionsManager(e,t){const{_arcadeContextInfo:a,_featureClone:s}=this;this._expressionsManager=new ye({executors:e,feature:s,arcadeContextInfo:a,fieldInputs:t})}_afterValueChange(e){const{name:t,value:a}=e,{_featureClone:s,formTemplate:n,layer:r}=this;if(!r)return;const o=s.getAttribute(t);s.setAttribute(t,a);const{typeFieldName:u,types:p}=Ci(r);if(t===u&&a!==o){if(r.type==="subtype-sublayer"){const h=r.parent?.findSublayerForFeature(s);s.sourceLayer=this.feature.sourceLayer=h}const c=new Set;for(const h of p)if(h.domains&&typeof h.domains=="object")for(const m of Object.keys(h.domains))c.add(m);for(const h of c){const m=this.findField(h);m&&m.notifyChange("domain")}}if(n!=null){const{description:c,title:h}=n;h&&gi(h,t)&&this.notifyChange("formTitle"),c&&gi(c,t)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const t of this.allFieldInputs)t.value!==e.getAttribute(t.name)&&this._afterValueChange(t)}_addToExpressionLookup(e){const{_expressionLookup:t,formTemplate:a}=this,s=a!=null&&a.expressionInfos!=null?Object.values(a.expressionInfos).find(r=>r.name===e):null,n=s?.expression??e;return t.set(e,n),e!==n&&t.set(n,n),n}_joinContingentValues(){const e=this._contingentValuesCache;if(e==null)return[];const{typeFieldName:t}=Ci(this.layer),a=t?this.getValue(t):null,s=[];for(const o of e.fieldGroups){const{contingencies:u,fields:p,name:c}=o,h=[];for(const m of u)m.isRetired||m.subtype!=null&&m.subtype.code!==a||h.push({values:m.values});h.length>0&&s.push({name:c,fields:p,contingencies:h})}const[n,r]=this._generateJoinPlan(s);return[...n.flatMap(o=>this._joinFieldGroupContingencies(o)),...r.flatMap(o=>o.contingencies)]}_generateJoinPlan(e){const t=new Map,a=[],s=new Set;for(const p of e)for(const c of p.fields)if(t.has(c)){const h=t.get(c),m=p,y=[h.name,m.name].sort().join("|");if(s.has(y))continue;a.push([h,m]),s.add(y),t.set(c,m)}else t.set(c,p);const n=new Set(a.flat()),r=new Set(e);for(const p of n)r.delete(p);const o=new Map,u=new Map;for(const p of new Set(a.flat())){const c=Symbol(p.name);o.set(c,new Set([p])),u.set(p,c)}for(const[p,c]of a){const h=u.get(p),m=u.get(c);if(h===m)continue;const y=o.get(h),g=o.get(m);for(const w of g)y.add(w),u.set(w,h);o.delete(m)}return[[...o.values()].map(p=>[...p]),[...r]]}_joinFieldGroupContingencies(e){const t=e.slice(),a=t.shift();let s=t.shift(),n=this._generateJoinKey(a.fields,s.fields),r=new Set([...a.fields,...s.fields]),o=new Map;for(const p of a.contingencies){const[c]=this._hashContingency(p,n.codedValueFields,!0);o.has(c)?o.get(c)?.push(p):o.set(c,[p])}for(;t.length>0;){const p=new Map,c=t.shift(),h=this._generateJoinKey(r,c.fields);for(const m of s.contingencies){const[y,g]=this._hashContingency(m,n.codedValueFields),w=g?this._findMatchingContingenciesWithAnyHashMask(o,y):o.get(y);if(o.has(xe)&&w?.push(...this._findMatchingContingenciesContainingAny(m,o.get(xe),n.codedValueFields)),w!=null)for(const _ of w){const v=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(_,m,n.rangeFields):this._joinContingencies(_,m);if(v==null)break;const[b]=this._hashContingency(v,h.codedValueFields,!0);p.has(b)?p.get(b)?.push(v):p.set(b,[v])}}o=p,s=c,n=h,r=new Set([...r,...s.fields])}const u=[];for(const p of s.contingencies){const[c,h]=this._hashContingency(p,n.codedValueFields),m=h?this._findMatchingContingenciesWithAnyHashMask(o,c):o.get(c);if(o.has(xe)&&m.push(...this._findMatchingContingenciesContainingAny(p,o.get(xe),n.codedValueFields)),m!=null)for(const y of m){const g=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(y,p,n.rangeFields):this._joinContingencies(y,p);g!=null&&u.push(g)}}return u}_joinContingencies(e,t){const a={values:{...e.values,...t.values}};for(const[s,n]of Object.entries(a.values))n.objectType==="any"&&e.values[s]!=null&&(a.values[s]=e.values[s]);return a}_joinContingenciesWithRangeDomains(e,t,a){const s=this._joinContingencies(e,t);for(const n of a){const r=e.values[n],o=t.values[n],{leftIsNull:u,rightIsNull:p,bothAreNull:c,leftIsAny:h,rightIsAny:m,bothAreAny:y,leftIsRange:g,rightIsRange:w}=this._compareObjectTypes(r.objectType,o.objectType);if(c||y)continue;if(u&&m||p&&h){s.values[n]=new D({objectType:"null"});continue}if(u&&w||p&&g)return null;h?(r.minValue=-1/0,r.maxValue=1/0):m&&(o.minValue=-1/0,o.maxValue=1/0);const _=Math.max(r.minValue,o.minValue),v=Math.min(r.maxValue,o.maxValue);if(_>v)return null;s.values[n]=new D({objectType:"range",minValue:_,maxValue:v})}return s}_findMatchingContingenciesContainingAny(e,t,a){return t.filter(s=>a.every(n=>{const r=s.values[n],o=e.values[n];return r.objectType==="any"||o.objectType==="any"||r.codedValue?.code===o.codedValue?.code}))}_findMatchingContingenciesWithAnyHashMask(e,t){const a=RegExp(`${t}$`),s=[];for(const[n,r]of e){if(n===xe)break;a.test(n)&&s.push(...r)}return s}_generateJoinKey(e,t){const a=Array.isArray(e)?new Set(e):e,s=Array.isArray(t)?new Set(t):t,n=a.size<s.size?a:s,r=n===a?s:a,o=new Set,u=new Set;for(const p of n)if(r.has(p)){const c=this.layer?.getFieldDomain(p,{feature:this.feature});if(c==null)continue;switch(c.type){case"coded-value":o.add(p);break;case"range":u.add(p)}}return{codedValueFields:[...o],rangeFields:[...u]}}_hashContingency(e,t,a=!1){if(t.length<1)return[en,!1];const s=[];let n=!1;for(const r of t){const o=e.values[r];if(o.objectType==="any"){if(a)return[xe,!0];n=!0,s.push(`${r}:.*`)}else o.objectType==="null"?s.push(`${r}:${tn}`):s.push(`${r}:${o.codedValue?.code}`)}return[s.sort().join("&"),n]}_compareObjectTypes(e,t){return{leftIsNull:e==="null",rightIsNull:t==="null",bothAreNull:e==="null"&&t==="null",leftIsAny:e==="any",rightIsAny:t==="any",bothAreAny:e==="any"&&t==="any",leftIsRange:e==="range",rightIsRange:t==="range"}}};function Wi(i){return i.type==="field"||i.type==="group"||i.type==="relationship"||(de.getLogger(ui).warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${i.label} has unsupported type '${i.type}'`),!1)}l([d()],M.prototype,"_featureClone",void 0),l([d()],M.prototype,"activeRelationshipInput",null),l([d()],M.prototype,"_arcadeContextInfo",null),l([d({readOnly:!0})],M.prototype,"allFieldInputs",null),l([d()],M.prototype,"allRelationshipInputs",null),l([d()],M.prototype,"_layerFieldsByName",null),l([d()],M.prototype,"arcadeEditType",void 0),l([d()],M.prototype,"contingencyConstraintViolations",void 0),l([d()],M.prototype,"disabled",void 0),l([d()],M.prototype,"feature",null),l([d()],M.prototype,"fieldsWithContingentValues",null),l([d({type:Na})],M.prototype,"formTemplate",null),l([d()],M.prototype,"formDescription",null),l([d()],M.prototype,"formTitle",null),l([d()],M.prototype,"formHeaderVisible",null),l([d()],M.prototype,"inputs",void 0),l([d()],M.prototype,"inputFields",null),l([d()],M.prototype,"joinedContingentValues",null),l([d()],M.prototype,"layer",null),l([d()],M.prototype,"map",void 0),l([d()],M.prototype,"relatedRecordCallbacks",void 0),l([d()],M.prototype,"relationshipId",null),l([d()],M.prototype,"spatialReference",null),l([d()],M.prototype,"state",null),l([d()],M.prototype,"strict",void 0),l([d()],M.prototype,"submittable",null),l([d()],M.prototype,"updating",null),l([d()],M.prototype,"valid",null),l([d()],M.prototype,"view",null),l([d()],M.prototype,"getValues",null),l([d()],M.prototype,"submit",null),M=l([E(ui)],M);const wa=M,Pi="TT",Je="data-field-name",Ui="latn",Gi=i=>"valueAsDate"in i,_a="esri.widgets.FeatureForm",Ni=de.getLogger(_a);let L=class extends ut{constructor(e,t){super(e,t),this._dateFieldInputMap=new Map,this._activeInputName="",this._activeNumberFieldEdit=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedFieldInputNames=new Set,this._listObserverNode=null,this._listObserver=new IntersectionObserver(a=>{a.length&&a[0].isIntersecting&&this._incrementRelatedRecordPage()},{root:window.document}),this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new wa,this._onShowAllRelatedRecordsClick=a=>{const{feature:s,relatedRecordCallbacks:n}=this;s&&n?.showAllRelatedRecords&&n.showAllRelatedRecords({parentFeature:s,relationshipId:a})},this._onAddRelatedRecordsClick=(a,s)=>{const{feature:n,relatedRecordCallbacks:r}=this;n&&r?.addRelatedRecord&&r.addRelatedRecord({parentFeature:n,relatedLayer:s,relationshipId:a})},this._handleInputInput=a=>{this._commitInputValue(a.currentTarget)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this),this._afterDateInputCreateOrUpdate=this._afterDateInputCreateOrUpdate.bind(this)}initialize(){this.addHandles([T(()=>this.feature,()=>{const e=this._getFocusableInput("forward");this._activeInputName=e?.name||"",this._userUpdatedFieldInputNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._dateFieldInputMap.clear(),this._fieldFocusNeeded=!0}),this.on("submit",e=>{if(e.invalid.length>0){const[t]=e.invalid;e.invalid.forEach(a=>this._userUpdatedFieldInputNames.add(a)),this._activeInputName=t,this._fieldFocusNeeded=!0,this.scheduleRender()}}),T(()=>[this.viewModel.activeRelationshipInput,this._listObserverNode],()=>this._onObserverChange())])}loadDependencies(){return ct({button:()=>I(()=>import("./calcite-button-d9045173.js"),["./calcite-button-d9045173.js","./button-a95c5efa.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./icon-3b706e0b.js","./loader-142f20e1.js","./guid-4f97587b.js"],import.meta.url),combobox:()=>I(()=>import("./calcite-combobox-bd420193.js"),["./calcite-combobox-bd420193.js","./main-79e5ed80.js","./main-7772480e.css","./filter2-db8c040b.js","./debounce-c198f28b.js","./openCloseComponent-2d424455.js","./form-9c9dba1f.js","./guid-4f97587b.js","./interactive-1607c36d.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./utils2-2181e413.js","./conditionalSlot-7211d13e.js","./icon-3b706e0b.js"],import.meta.url),"combobox-item":()=>I(()=>import("./calcite-combobox-item-b6fb90ba.js"),["./calcite-combobox-item-b6fb90ba.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./guid-4f97587b.js","./interactive-1607c36d.js","./utils2-2181e413.js","./icon-3b706e0b.js"],import.meta.url),"combobox-item-group":()=>I(()=>import("./calcite-combobox-item-group-0349af4f.js"),["./calcite-combobox-item-group-0349af4f.js","./main-79e5ed80.js","./main-7772480e.css","./guid-4f97587b.js","./utils2-2181e413.js"],import.meta.url),icon:()=>I(()=>import("./calcite-icon-b3dbf1c9.js"),["./calcite-icon-b3dbf1c9.js","./icon-3b706e0b.js","./main-79e5ed80.js","./main-7772480e.css","./observers-7949b362.js"],import.meta.url),"input-date-picker":()=>I(()=>import("./calcite-input-date-picker-b607b7fa.js"),["./calcite-input-date-picker-b607b7fa.js","./main-79e5ed80.js","./main-7772480e.css","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./form-9c9dba1f.js","./interactive-1607c36d.js","./label2-890d1a34.js","./loadable-7d140904.js","./focusTrapComponent-2107ee6f.js","./icon-3b706e0b.js","./guid-4f97587b.js","./input-4cfd753f.js","./progress-7a558d52.js"],import.meta.url),"input-message":()=>I(()=>import("./calcite-input-message-770753da.js"),["./calcite-input-message-770753da.js","./main-79e5ed80.js","./main-7772480e.css","./icon-3b706e0b.js","./observers-7949b362.js"],import.meta.url),"input-time-picker":()=>I(()=>import("./calcite-input-time-picker-f0211e5e.js"),["./calcite-input-time-picker-f0211e5e.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./guid-4f97587b.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./observers-7949b362.js","./focusTrapComponent-2107ee6f.js","./icon-3b706e0b.js","./action-9e20b9c8.js","./loader-142f20e1.js","./input-4cfd753f.js","./progress-7a558d52.js","./popover-a38f0fbf.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./FloatingArrow-52fee7c7.js"],import.meta.url),list:()=>I(()=>import("./calcite-list-d02b2044.js"),["./calcite-list-d02b2044.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./observers-7949b362.js","./utils3-e8f0e96c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js","./input-4cfd753f.js","./form-9c9dba1f.js","./label2-890d1a34.js","./progress-7a558d52.js","./loader-142f20e1.js","./guid-4f97587b.js","./scrim-13194b98.js"],import.meta.url),"list-item":()=>I(()=>import("./calcite-list-item-9a9b9029.js"),["./calcite-list-item-9a9b9029.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./utils3-e8f0e96c.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./loadable-7d140904.js","./action-9e20b9c8.js","./guid-4f97587b.js","./icon-3b706e0b.js","./loader-142f20e1.js"],import.meta.url),loader:()=>I(()=>import("./calcite-loader-6cec631f.js"),["./calcite-loader-6cec631f.js","./loader-142f20e1.js","./main-79e5ed80.js","./main-7772480e.css","./guid-4f97587b.js"],import.meta.url),notice:()=>I(()=>import("./calcite-notice-842cb611.js"),["./calcite-notice-842cb611.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js"],import.meta.url),progress:()=>I(()=>import("./calcite-progress-dcfdfffb.js"),["./calcite-progress-dcfdfffb.js","./progress-7a558d52.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url),switch:()=>I(()=>import("./calcite-switch-6953ae95.js"),["./calcite-switch-6953ae95.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js"],import.meta.url)})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get relatedRecordCallbacks(){return this.viewModel.relatedRecordCallbacks}set relatedRecordCallbacks(e){this.viewModel.relatedRecordCallbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get view(){return Ge(Ni,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view}set view(e){Ge(Ni,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return f("div",{class:this.classes(k.base,k.widget,k.panel)},e==="ready"?this._renderForm():null)}_renderForm(){return f("form",{class:k.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this._renderHeader(),this._renderInputs())}_renderHeader(){const e=this.viewModel;if(!e.formHeaderVisible)return;const t=e.formTitle!=null&&f(Te,{key:"title",level:this.headingLevel},e.formTitle),a=e.formDescription!=null&&f("p",{class:k.description,key:"description"},e.formDescription);return f("div",{class:k.formHeader},t,a)}_renderInputs(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(be).filter(t=>t.visible).map((t,a)=>je(t)?this._renderGroup(t,a):Ae(t)?this._renderLabeledField(t):at(t)?this._renderRelationshipInput(t):void 0)}_renderActiveRelationshipInput(e){return this._renderRelationshipInput(e)}_renderDescriptionOrEmpty(e,t){return e==null?null:f("div",{class:this.classes(k.description),id:t},e)}_renderGroup(e,t){const{formTemplate:a,disabled:s}=this,{description:n,inputs:r,label:o,state:u}=e,p=r.filter(F=>F.visible),c=this.viewModel.findField(this._activeInputName),h=!(!c||c.group!==e),m=`${this.id}_group_${t}`,y=`${this.id}_group-label_${t}`,g=`${this.id}_group-description_${t}`,w=this._renderDescriptionOrEmpty(n,g),_=this.groupDisplay==="sequential",v=_?h:u==="expanded",b=v?k.collapseIcon:k.expandIcon;return f("fieldset",{"aria-expanded":v.toString(),"aria-labelledby":y,"aria-describedby":n?g:"",class:this.classes(k.group,_?k.groupSequential:null,v?null:k.groupCollapsed,h?k.groupActive:null,s?k.inputDisabled:null),disabled:s,"data-group":e,id:m,key:t,onclick:this._handleGroupClick},f("button",{role:_?"presentation":void 0,class:k.groupHeader,type:"button",tabIndex:_?-1:0},f("div",{class:k.groupTitle},f(Te,{class:k.groupLabel,id:y,level:a!=null&&a.title?Ze(this.headingLevel):this.headingLevel},o),w),_?null:f("span",{class:this.classes(b,k.groupToggleIcon)})),p.map(F=>Ae(F)?this._renderLabeledField(F):at(F)?this._renderRelationshipInput(F):void 0))}_getFocusableInput(e,t){const a=this.viewModel.allFieldInputs,s=e==="forward"?a:a.slice().reverse();let n;if(!t||at(t))n=0;else if(je(t)){const r=t.inputs.find(Ae);n=r?s.indexOf(r):0}else{let r;if(xt(t)&&t.group.state==="collapsed"){const o=t.group.inputs.filter(Ae);r=e==="forward"?o[o.length-1]:o[0]}else r=t;n=s.indexOf(r)+1}for(let r=n;r<s.length;r++){const o=s[r];if(o.visible&&Ae(o))return o}return null}_renderLabeledField(e){const{dataType:t,feature:a,label:s,layer:n}=e;return f("label",{key:`${n.id}-${a.uid}-${e.name}`,class:k.label},[s,t!=="unsupported"?this._renderFieldInput(e):this._renderUnsupportedField(e),this._renderAuxiliaryText(e)])}_renderFieldInput(e){const{dataType:t,domain:a,name:s,updating:n,value:r}=e,o=this.getCommonInputProps(e);if(a?.type==="coded-value"){if(ze(e.element,"switch")){const{element:p}=e;if(!(this._switchFieldsWithInitialIncompatibleValue.has(s)||r==null||p.input.onValue!==r&&p.input.offValue!==r))return this._renderSwitchFieldInput(e,o);this._switchFieldsWithInitialIncompatibleValue.add(s)}return e.inputType==="radio-buttons"?this._renderRadioButtonsFieldInput(e,a.codedValues.map(({code:p,name:c})=>({value:p,name:c})),o):this._renderSelectFieldInput(e,this._getFieldValueOptions(s,a),o)}if(e.inputType==="datetime-picker"||t==="date")return this._renderDateFieldInput(e,o);const u=t==="number"?f("input",{type:"number",...o,value:this._activeNumberFieldEdit!=null&&this._activeNumberFieldEdit.fieldName===e.name?this._activeNumberFieldEdit.value:`${o.value}`}):e.inputType==="text-area"?f("textarea",{...o}):f("input",{type:"text",...o});return n?f("div",{key:`${o.key}-input-updating-wrapper`,class:k.fieldInputWrapper},u,f("div",{class:k.fieldInputLoader},f("calcite-progress",{type:"indeterminate"}))):u}_renderDateFieldInput(e,t){const{dateDataType:a,includeTime:s,label:n,name:r,valid:o,value:u}=e,{readOnly:p,required:c}=t;if(a==="string")return this._renderUnsupportedField(e,vs(e.field,t.value));const{date:h,time:m}=this._formatValueForDateInputs(u),y=t.max!=null?this._formatValueForDateInputs(t.max):void 0,g=t.min!=null?this._formatValueForDateInputs(t.min):void 0,w=y?.date??void 0,_=g?.date??void 0,v={afterCreate:this._afterDateInputCreate,afterUpdate:this._afterDateInputCreateOrUpdate,"aria-invalid":!o,label:n,numberingSystem:Ui,overlayPositioning:"fixed",readOnly:p,required:c,tabIndex:0,[Je]:r};return f("div",{key:`${t.key}-date-time-container`,class:k.dateInputContainer},f("calcite-input-date-picker",{bind:this,...v,class:this.classes(t.class,k.inputDate),"data-date-part":"date",key:`${t.key}-date-input`,valueAsDate:h??void 0,maxAsDate:w,minAsDate:_,onCalciteInputDatePickerChange:b=>this._commitDateChanges(b.target),onblur:b=>this._commitDateChanges(b.target,!0)}),s?f("calcite-input-time-picker",{bind:this,...v,class:this.classes(t.class,k.inputTime),"data-date-part":"time",key:`${t.key}-time-input`,value:m??void 0,step:1,onCalciteInputTimePickerChange:b=>this._commitDateChanges(b.target),onfocus:b=>{b.target.calciteTimePickerEl&&(b.target.calciteTimePickerEl.showSecond=!0)},onblur:b=>this._commitDateChanges(b.target,!0)}):null)}_renderUnsupportedField(e,t){const a=this.getCommonInputProps(e);return f("input",{afterCreate:a.afterCreate,afterUpdate:a.afterUpdate,class:this.classes(k.input,k.fieldInput,k.inputDisabled),onfocus:a.onfocus,readOnly:!0,tabIndex:a.tabIndex,type:"text",value:t!=null?`${t}`:a.value,[Je]:a[Je]})}_renderSelectFieldInput(e,t,a){const{element:s,required:n,value:r}=e,{messages:o,messagesTemplates:u}=this,p=t.map(_=>_.map(v=>f("calcite-combobox-item",{value:`${v.value}`,textLabel:v.name,key:`#${v.value}`,selected:r===v.value}))),[c,h]=p;this._registerIncompatibleValue(r,t.flat(),e,_=>{h.unshift(f("calcite-combobox-item",{value:`${_}`,textLabel:`${_}`,key:"incompatible-option",readOnly:!0}))});const m=h.length>0?[f("calcite-combobox-item-group",{key:"recommended",label:o.recommended},c),f("calcite-combobox-item-group",{key:"other",label:u.other},h)]:c,y=s==null,g=ze(s,"combo-box"),w=y||g&&s.input?.showNoValueOption;if(!n&&w){const _="",v=g&&s.input.noValueOptionLabel||o.empty;m.unshift(f("calcite-combobox-item",{value:_,textLabel:o.empty,key:"empty-option"},v))}return f("calcite-combobox",{...a,selectionMode:"single",disabled:a.readOnly,allowCustomValues:!1,clearDisabled:!0,onCalciteComboboxChange:_=>this._handleOptionChange(_.target)},m)}_registerIncompatibleValue(e,t,a,s){const n=this._fieldToInitialIncompatibleDomainValue,r=n.has(a.name);(r||e!=null&&e!==""&&!t.some(o=>o.value===e))&&(r||n.set(a.name,e),s?.(e))}_renderRadioButtonsFieldInput(e,t,a){const{element:s,name:n,required:r,value:o}=e,u=t.map(m=>this._renderRadioButton({key:m.name,label:m.name,name:n,value:m.value,selected:m.value===o,props:a}));this._registerIncompatibleValue(o,t,e);const p=s==null,c=ze(s,"radio-buttons"),h=p||c&&s.input?.showNoValueOption;if(!r&&h){const m="",y=c&&s.input.noValueOptionLabel||this.messages.empty,g=o===m||o===null;u.unshift(this._renderRadioButton({key:"empty-option",label:y,name:n,value:m,selected:g,props:a}))}return f("div",{key:`${a.key}-radio`,class:k.inputRadioGroup},u)}_renderSwitchFieldInput(e,t){const{value:a}=e,s=!!ze(e.element,"switch")&&a===e.element.input.onValue;return f("calcite-switch",{...t,class:k.inputSwitch,onCalciteSwitchChange:n=>this._commitInputValue(n.target),checked:s,disabled:t.readOnly})}_renderRadioButton({key:e,name:t,value:a,selected:s,label:n,props:r}){return f("label",{key:e,class:k.inputRadioLabel},f("input",{...r,class:k.inputRadio,name:t,type:"radio",value:a,checked:s,disabled:r.readOnly,onchange:o=>this._commitInputValue(o.target)}),n)}_renderAuxiliaryText(e){const t=this._userUpdatedFieldInputNames.has(e.name)&&!e.valid?bs(e,this.messages):this.viewModel.contingencyConstraintViolations.get(e.name)!=null?this.messages.validationErrors.valuesIncompatible:e.valueExpressionExecutor!=null&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return t!=null?f("calcite-input-message",{status:"invalid",icon:!0},t):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){const{featureCount:t,relationshipId:a,showAllActionVisible:s}=e,{relatedRecordCallbacks:n}=this;if(!s||!n?.showAllRelatedRecords)return;const r=this.messages;return f("calcite-list-item",{description:Ye(r.totalCount,{count:t}),label:r.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(a)},f("calcite-icon",{slot:"content-end",scale:"s",icon:"list"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:t,relationshipId:a,relatedLayer:s}=e,{relatedRecordCallbacks:n}=this;if(t&&n?.addRelatedRecord&&s)return f("calcite-button",{alignment:"center",appearance:"outline-fill",class:k.centeredButton,disabled:e.updating,iconStart:"plus",key:`${a}-add-button`,round:!0,scale:"s",width:"half",onclick:()=>this._onAddRelatedRecordsClick(a,s)},this.messages.addRecord)}_renderRelatedRecordListItem(e,t){const{feature:a,description:s,title:n}=e,{feature:r,relatedRecordCallbacks:o}=this,u=()=>{o?.editRelatedRecord&&r&&o.editRelatedRecord({parentFeature:r,relationshipId:t,relatedFeature:a})};return f("calcite-list-item",{bind:this,description:s,label:n,key:`${t}-${a.uid}`,value:n,onclick:u},f("calcite-icon",{slot:"content-start",scale:"m",icon:Is(a)}),f("calcite-icon",{slot:"content-end",scale:"s",icon:"chevron-right"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:t,relationshipId:a,showAllEnabled:s}=e,n=s?null:this._renderDescriptionOrEmpty(e.description),r=t>0?this._renderRelatedRecordsList(e):e.loaded?this._renderNoRelatedRecordsNotice():void 0;return f("label",{class:this.classes(k.label,k.relationshipLabel),key:`relationship-${a}-container`},f("div",null,this._renderRelatedRecordsHeaderContainer(e),n,r),this._renderAddRelatedRecordButton(e))}_renderRelatedRecordsHeaderContainer(e){const t=e.updating||!e.loaded;return f("div",{class:k.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},f("span",null,e.label),t?f("calcite-loader",{label:this.messagesCommon?.loading,inline:!0,key:"loader",scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:t}=e;return f("calcite-list",{class:k.relatedRecordsList},e.relatedFeatureInfos.map(a=>this._renderRelatedRecordListItem(a,t)),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoRelatedRecordsNotice(){return f("calcite-notice",{open:!0,scale:"s",kind:"brand",icon:"information",width:"full"},f("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return f("div",{key:"feature-observer",class:k.listObserver,bind:this,afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved})}getCommonInputProps(e){const{disabled:t,groupDisplay:a}=this,{dataType:s,editable:n,group:r,hint:o,label:u,maxLength:p,minLength:c,name:h,required:m,valid:y,value:g}=e,w=this._userUpdatedFieldInputNames.has(h),_=!n||t,v=a==="all"&&r!=null&&r.state==="collapsed";return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":y?"false":"true",class:this.classes(k.input,k.fieldInput,_?k.inputDisabled:null,w&&!y?k.inputInvalid:null),key:h,label:u,minlength:c>-1?`${c}`:"",maxlength:p>-1?`${p}`:"",...e.range,readOnly:_,value:g==null?"":`${g}`,[Je]:h,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:s==="number"?this._handleNumberInputMouseDown:void 0,placeholder:s==="number"||s==="text"?o??void 0:"",required:m,tabIndex:v?-1:0}}_handleNumberInputMouseDown({target:e}){e.focus(),this.scheduleRender()}_getFieldValueOptions(e,t){const a=t.codedValues.map(({code:n,name:r})=>({value:n,name:r})),s=this.viewModel.fieldsWithContingentValues.has(e)?this._getContingentValueOptions(e):[];if(s.length>0){const n=new Set(s.map(r=>r.value));return[s,a.filter(r=>!n.has(r.value))]}return[a,[]]}_getContingentValueOptions(e){const t={};for(const n of this.viewModel.allFieldInputs){const{name:r,value:o}=n;o!=null&&r!==e&&this.viewModel.fieldsWithContingentValues.has(r)&&(t[r]=o)}const a=this.viewModel.joinedContingentValues.slice(),s=new Map;for(const n of a){const r=n.values[e];if(r==null||r.objectType!=="code"&&r.objectType!=="null")continue;const{code:o,name:u}=r.codedValue&&r.objectType!=="null"?r.codedValue:{code:"",name:this.messages.empty};s.has(o)||Object.entries(t).every(([p,c])=>!n.values.hasOwnProperty(p)||this._valueIsValidContingentValue(c,n.values[p]))&&s.set(o,{name:u,value:o})}return[...s.values()]}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(Je))}async _afterDateInputCreate(e){this._afterDateInputCreateOrUpdate(e)}_afterDateInputCreateOrUpdate(e){const{name:t}=this._getFieldInputFromHTMLElement(e),a=this._dateFieldInputMap.get(t),s=Gi(e);a!=null?s?a.date=e:a.time=e:this._dateFieldInputMap.set(t,{[s?"date":"time"]:e}),this._afterInputCreateOrUpdate(e)}_afterInputCreateOrUpdate(e){const{viewModel:t}=this,a=this._getFieldInputFromHTMLElement(e),s=t.findField(this._activeInputName),n=this._fieldToInitialIncompatibleDomainValue.get(a.name)===a.value;this._fieldFocusNeeded&&s===a&&(a.inputType!=="radio-buttons"||n||e.checked)&&(this._fieldFocusNeeded=!1,xt(a)&&(a.group.state="expanded"),e.focus())}_handleInputFocus(e){const t=e.target,a=this._getFieldInputFromHTMLElement(t);this._activeInputName=a.name,Ei(a)&&(this._activeNumberFieldEdit={fieldName:a.name,input:t,value:t.value})}_handleInputBlur(e){const t=e.target,a=this._getFieldInputFromHTMLElement(t);a.dataType==="number"&&this._activeNumberFieldEdit!=null&&(this._activeNumberFieldEdit.input.value=`${a.value}`,this._activeNumberFieldEdit=null),this._commitInputValue(t),this.scheduleRender()}_commitDateChanges(e,t=!1){const{name:a}=this._getFieldInputFromHTMLElement(e);if(!this._dateFieldInputMap.has(a))return;const s=this._dateFieldInputMap.get(a);if(!s||!s.date)return;const n=this._getFieldValueFromDateInput(e),r=this._getFieldValueFromDateInputs(s.date,s.time);this.viewModel.getValue(a)!==r&&(n!==null&&r!==null?this._updateFieldValue(a,r):t&&this._updateFieldValue(a,null))}_commitInputValue(e){const t=this._getFieldInputFromHTMLElement(e);this._activeNumberFieldEdit!=null&&Ei(t)&&(this._activeNumberFieldEdit.value=e.value),this._updateFieldValue(t.name,this._parseValue(e))}_handleInputKeyDown(e){const{key:t,altKey:a,ctrlKey:s,metaKey:n}=e,r=this._getFieldInputFromHTMLElement(e.target);if(t==="Enter")xt(r)&&r.group.state==="collapsed"&&(r.group.state="expanded");else{const{type:o}=r.field,u=o==="single"||o==="double";if((o==="integer"||o==="small-integer"||u)&&!a&&!s&&!n&&t.length===1){const p=Number(t),c=["-","+"],h=["e","."],m=u?[...c,...h]:c;isNaN(p)&&!m.includes(t)&&e.preventDefault()}}}_updateFieldValue(e,t){if(this.viewModel.setValue(e,t),this._userUpdatedFieldInputNames.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const a=Object.fromEntries(Object.entries(this.getValues()).filter(([s,n])=>n!=null));this.viewModel.validateContingencyConstraints(a)}}_parseValue(e){const t=this._getFieldInputFromHTMLElement(e),a=e.value;if(ze(t.element,"switch")&&e.tagName!=="CALCITE-COMBOBOX")return e.checked?t.element.input.onValue:t.element.input.offValue;if(t.inputType==="radio-buttons"&&e.type==="radio"&&!e.checked)return t.value;const{dataType:s}=t;return s==="number"?a?parseFloat(a):null:a}_handleOptionChange(e){this._commitInputValue(e),this.scheduleRender()}_handleGroupClick(e){const t=e.currentTarget["data-group"],a=t.state==="expanded",s=this.groupDisplay==="sequential",n=`.${k.groupHeader}`;if(!(a&&!e.target.closest(n))){if(this._activeInputName=this._getFocusableInput("forward",t)?.name||"",s){const r=e.target.closest(n);if(a&&!r)return;this.viewModel.inputs.forEach(o=>{je(o)&&o!==t&&(o.state="collapsed")})}t.state=a?"collapsed":"expanded",this._fieldFocusNeeded=s,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){e.key==="Enter"&&this.viewModel.submit()}_getDefaultLocaleOptions(){return{locale:ja(),numberingSystem:Ui}}_getFieldValueFromDateInputs(e,t){const a=this._getDateTimeFromInput(e),s=this._getDateTimeFromInput(t);if(!a&&!s)return null;const n=this._getFieldInputFromHTMLElement(e).range,r=Date.now(),o=n.max!=null&&n.max<r?n.max:r,u=ht.fromMillis(o,this._getDefaultLocaleOptions()),p=a||u,{year:c,month:h,day:m}=p,{hour:y,minute:g,second:w}=s||u,_=p.set({year:c,month:h,day:m,hour:y,minute:g,second:w});return _.isValid?_.toMillis():null}_getDateTimeFromInput(e){if(!e)return null;let t=null;if(Gi(e)){const a=e.valueAsDate;if(!a||Array.isArray(a))return null;t=ht.fromJSDate(a)}else{if(!e.value)return null;t=ht.fromFormat(e.value,Pi,this._getDefaultLocaleOptions())}return t??null}_getFieldValueFromDateInput(e){return this._dateTimeToFieldValue(this._getDateTimeFromInput(e))}_dateTimeToFieldValue(e){return e?.isValid?e.toMillis():null}_dateTimeFromFieldValue(e){return e===null?null:ht.fromMillis(e,this._getDefaultLocaleOptions())}_formatValueForDateInputs(e){if(e==null||isNaN(e))return{date:null,time:null};const t=this._dateTimeFromFieldValue(e);return t?{date:t.toJSDate(),time:t.toFormat(Pi,this._getDefaultLocaleOptions())}:{date:null,time:null}}_valueIsValidContingentValue(e,t){switch(t.objectType){case"any":return!0;case"null":return e==null;case"code":return e===t.codedValue?.code;case"range":return e!=null&&t.minValue!=null&&t.maxValue!=null&&+e>=t.minValue&&+e<=t.maxValue;default:return Ba(t.objectType),!1}}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}async _onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;if(!e)return;const{showAllEnabled:t,updating:a}=e;this._listObserverNode&&!a&&t&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){this.viewModel.activeRelationshipInput?.incrementPage()}};l([d()],L.prototype,"_listObserverNode",void 0),l([d()],L.prototype,"_relatedRecordsEnabled",null),l([d()],L.prototype,"disabled",null),l([d()],L.prototype,"feature",null),l([d()],L.prototype,"formTemplate",null),l([d()],L.prototype,"groupDisplay",void 0),l([d()],L.prototype,"headingLevel",void 0),l([d()],L.prototype,"label",null),l([d()],L.prototype,"layer",null),l([d()],L.prototype,"map",null),l([d(),se("esri/widgets/FeatureForm/t9n/FeatureForm")],L.prototype,"messages",void 0),l([d(),se("esri/t9n/common")],L.prototype,"messagesCommon",void 0),l([d(),se("esri/widgets/Feature/t9n/Feature")],L.prototype,"messagesFeature",void 0),l([d(),se("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],L.prototype,"messagesTemplates",void 0),l([d()],L.prototype,"relatedRecordCallbacks",null),l([d()],L.prototype,"relationshipId",null),l([d()],L.prototype,"spatialReference",null),l([d()],L.prototype,"strict",null),l([d()],L.prototype,"view",null),l([d(),li(["value-change","submit"])],L.prototype,"viewModel",void 0),L=l([E(_a)],L);const an=L;var qt;const sn="esri.widgets.FeatureTemplates.TemplateItem";let te=qt=class extends G{constructor(i){super(i),this._activeFetchInfo={id:null,request:null},this.layer=null,this.template=null,this.thumbnail=null}initialize(){this.addHandles(T(()=>{const{layer:i}=this;return[i&&"renderer"in i?i.renderer:null,this.template]},()=>{this._activeFetchInfo.id=null,this._activeFetchInfo.request=null,this._set("thumbnail",null)},Z))}get description(){return this.template?.description}set description(i){this.template&&(this.template.description=i)}get label(){return this.template?.name}set label(i){this.template&&(this.template.name=i)}get id(){return`${this.label??""}${this.layer?.id}`}get supportsUpload(){return this.layer.type==="scene"}clone(){const i=this.thumbnail!=null?this.thumbnail.cloneNode(!0):null,e=new qt({layer:this.layer,template:this.template});return e._set("thumbnail",i),e}static async fetchThumbnail(i,e){const t=await nn(i,e);if(t==null)return null;const a={maxSize:36};return i.renderer?.type==="dictionary"&&(a.fieldMap=i.renderer.fieldMap??void 0,a.feature={attributes:e.prototype.attributes??{}}),await Ls(t,a)}};async function nn(i,e){const{renderer:t}=i;if(t){const a=new dt({attributes:e.prototype.attributes}),s=await t.getSymbolAsync(a);if(s)return s}return rn(i)}async function rn(i){const{geometryType:e}=i,t=e==="point"||e==="multipoint"?await I(()=>import("./main-79e5ed80.js").then(a=>a.y3),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url):e==="polyline"?await I(()=>import("./main-79e5ed80.js").then(a=>a.y1),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url):e==="polygon"||e==="mesh"||e==="multipatch"?await I(()=>import("./main-79e5ed80.js").then(a=>a.y2),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url):null;return t?new t.default:null}l([d()],te.prototype,"description",null),l([d()],te.prototype,"label",null),l([d()],te.prototype,"layer",void 0),l([d()],te.prototype,"template",void 0),l([d({readOnly:!0})],te.prototype,"thumbnail",void 0),l([d()],te.prototype,"id",null),l([d()],te.prototype,"supportsUpload",null),te=qt=l([E(sn)],te);const zt=te;let We=class extends Ha(G){constructor(e){super(e),this.items=null,this.label=null}get id(){return this.label}findByTemplate(e){return this.items.find(t=>t.template===e)}};l([d()],We.prototype,"items",void 0),l([d()],We.prototype,"label",void 0),l([d()],We.prototype,"id",null),We=l([E("esri.widgets.FeatureTemplates.TemplateItemGroup")],We);const on=We;var tt;const ln=({layer:i})=>({key:i,label:i.title??""}),dn=({layer:i})=>({key:i.geometryType,label:i.geometryType??""});let j=tt=class extends Fe(Mt.EventedAccessor){constructor(i){super(i),this._itemPool=new wi(zt),this._groupPool=new wi(on),this.filterFunction=null,this.selectedItem=null}initialize(){this._get("groupBy")||(this.groupBy="layer")}set groupBy(i){if(this._set("groupBy",i),typeof i!="function")switch(i){case"layer":this._groupByFunction=ln;break;case"geometry":this._groupByFunction=dn;break;default:this._groupByFunction=null}else this._groupByFunction=e=>this._ensureGroupByObject(i(e))}set layers(i){const e="layers";if(this.handles.remove(e),i){const t=()=>this.notifyChange("state");this.handles.add(i.map(a=>Ne(()=>a.loadStatus,t)),e)}this._set("layers",i)}get layers(){return this._get("layers")}get state(){const{layers:i}=this;return i&&i.length!==0?i.some(e=>e.loadStatus==="loading"||e.loadStatus==="not-loaded")?"loading":"ready":"disabled"}get _featureTemplatesByLayer(){if(!this.layers)return new Map;const i=[];for(const e of this.layers)if(e.type==="subtype-group")for(const t of e.sublayers){const a=ji(t);i.push([t,a])}else He(e)||i.push([e,ji(e)]);return new Map(i)}get numberOfFeatureTemplates(){return Array.from(this._featureTemplatesByLayer.values()).reduce((i,e)=>i+e.length,0)}get items(){if(this.numberOfFeatureTemplates===0)return this._releasePreviousItems(),[];const i=this._featureTemplatesByLayer,e=[],t=this.filterFunction!=null?this.filterFunction:tt._nullFilterFunction;for(const[n,r]of i)if(n.loaded||n.type==="subtype-sublayer"&&n.parent?.loaded){const o=$e(n)?.operations;if(o?.supportsEditing&&o?.supportsAdd)for(const u of r)e.push({layer:n,template:u,matchesFilter:t({label:u.name})})}if(this._groupByFunction==null){const n=e.filter(({matchesFilter:r})=>r).map(({template:r,layer:o})=>this._createItem(r,o));return this._releasePreviousItems(),n}const a=new Map;for(const n of e){const{template:r,layer:o}=n,u=this._groupByFunction({template:r,layer:o}),{key:p,label:c}=u.key!=null?u:tt.nullGroupBy;a.has(p)||a.set(p,{label:c,templateItemInfos:[]}),a.get(p)?.templateItemInfos.push(n)}const s=[];for(const n of a.values()){const{label:r,templateItemInfos:o}=n,u=o.filter(({matchesFilter:c})=>c),p=t({label:r})?o:o.length>0?u:[];if(p.length>0){const c=p.map(({template:h,layer:m})=>this._createItem(h,m));s.push(this._createGroup(r,c))}}return s.length===1&&s[0].label===tt.nullGroupBy.label?(this._releasePreviousItems(),s[0].items):(this._releasePreviousItems(),s)}refresh(){this.notifyChange("items")}select(i,{emit:e=!0}={}){const t=this.selectedItem,a=i?.clone()||null;this._set("selectedItem",a),e&&this.emit("select",{item:a,oldItem:t,template:a?.template??null})}_createItem(i,e){const t=this._itemPool.acquire();return t.set({template:i,layer:e}),t}_createGroup(i,e){const t=this._groupPool.acquire();return t.set("label",i),t.items=e,t}_releasePreviousItems(){this._destroyItems(this._get("items"))}_destroyItems(i){i&&(i[0]instanceof zt?i.forEach(e=>this._destroyItem(e)):i.forEach(e=>this._destroyGroup(e)))}_destroyGroup(i){i.items.forEach(e=>this._destroyItem(e)),i.items.length=0,this._groupPool.release(i)}_destroyItem(i){i.layer=null,i.template=null,this._itemPool.release(i)}_ensureGroupByObject(i){return typeof i=="string"?{key:i,label:i}:i}};j.nullGroupBy={key:Symbol(),label:"Other"},j._nullFilterFunction=i=>!0,l([d()],j.prototype,"_groupByFunction",void 0),l([d()],j.prototype,"filterFunction",void 0),l([d()],j.prototype,"groupBy",null),l([d()],j.prototype,"layers",null),l([d()],j.prototype,"state",null),l([d({readOnly:!0})],j.prototype,"_featureTemplatesByLayer",null),l([d({readOnly:!0})],j.prototype,"numberOfFeatureTemplates",null),l([d({readOnly:!0})],j.prototype,"items",null),l([d({readOnly:!0})],j.prototype,"selectedItem",void 0),j=tt=l([E("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],j);const ji=i=>[..."templates"in i&&Array.isArray(i.templates)?i.templates:[],..."types"in i&&Array.isArray(i.types)?i.types.flatMap(e=>e.templates):[]],Jt=j,X="esri-item-list",le={base:X,group:`${X}__group`,scroller:`${X}__scroller`,scrollerEnabled:`${X}__scroller--enabled`,groupHeader:`${X}__group__header`,item:`${X}__list-item`,itemIcon:`${X}__list-item-icon`,itemContentEnd:`${X}__list-item-content-end`,noMatchesMessage:`${X}__no-matches-message`,filterContainerSticky:`${X}__filter-container--sticky`},un=4;function va(i){const{filterText:e="",id:t,messages:a,onFilterChange:s,...n}=i;return f("div",{key:t},i.filterEnabled??1?hn({filterText:e,id:t,messages:a,onFilterChange:s}):null,pn({...n,enableListScroll:i.enableListScroll??!0,filterText:e,messages:a}))}function cn(i){return!!i.items}function pn(i){const{headingLevel:e,items:t,...a}=i;return t.length===0?f("div",{class:le.noMatchesMessage,key:"no-matches"},i.messages.noMatches):f("div",{class:qa({[le.scroller]:!0,[le.scrollerEnabled]:!!i.enableListScroll}),key:"item-container"},t.map(s=>cn(s)?mn({...a,group:s,headingLevel:e}):ci({...a,grouped:!0,item:s})))}function hn(i){const{messages:e,filterText:t,enableListScroll:a}=i;return f("div",{key:"filter",class:a?void 0:le.filterContainerSticky},f("calcite-input",{onCalciteInputInput:s=>{const n=s.currentTarget;i.onFilterChange&&i.onFilterChange(n.value)},placeholder:e.filterPlaceholder,value:t,type:"search"}))}function ci(i){const{grouped:e,identify:t,item:a,onItemMouseEnter:s,onItemMouseLeave:n,onItemSelect:r,renderIcon:o,renderCustomItem:u,renderItemContent:p,renderItemContentEnd:c,renderItemLabel:h,renderItemDescription:m,selectedItem:y}=i,g=Bi(a,t),w=g===Bi(y,t),_=u?.(i);if(_)return _;const v=p?.(a),b=c?.(a);return f("calcite-list-item",{"aria-level":e?"2":"",class:le.item,"data-item":a,key:g,label:v?void 0:h?.(a)??a.label??void 0,description:v?void 0:m?.(a)??void 0,selected:w,tabIndex:0,afterUpdate:F=>{F.selected=w},onCalciteListItemSelect:F=>{F.preventDefault(),r?.(Wt(F))},onmouseenter:F=>s?.(Wt(F)),onmouseleave:F=>n?.(Wt(F))},f("div",{key:"content-start",class:le.itemIcon,slot:"content-start"},o?.(a)),v?f("div",{key:"content",slot:"content"},v):null,b?f("div",{key:"content-end",class:le.itemContentEnd,slot:"content-end"},b):null)}function Bi(i,e){return i?`${e?.(i)||i.id}__${i.label}`:""}function Wt(i){return i.currentTarget["data-item"]}function mn(i){const{group:e,headingLevel:t=un,selectionMode:a="none",renderCustomGroupContent:s,...n}=i,r=s?.(i);return f("div",{class:le.group,key:e.label??void 0},f(Te,{level:t,class:le.groupHeader},e.label),r||f("calcite-list",{selectionMode:a,selectionAppearance:"border"},e.items.map(o=>ci({...n,item:o,grouped:!0}))))}const Hi="esri-feature-templates",Pt={base:Hi,loader:`${Hi}__loader`,widget:"esri-widget"};function fn(i){return i.length>0&&da(i[0])}function yn(i){return i.id}const qi={filter:!0};let x=class extends Fe(ut){constructor(e,t){super(e,t),this.enableListScroll=!0,this.filterText="",this.headingLevel=4,this.messages=null,this.viewModel=new Jt,this.visibleElements={...qi},this.renderCustomItem=a=>null,this.renderCustomGroupContent=a=>null,this.renderItemLabel=()=>null,this.renderItemDescription=()=>null,this.renderItemContent=a=>null,this.renderItemContentEnd=a=>null,this._iconIntersectionObserver=new IntersectionObserver((a,s)=>{a.forEach(async n=>{if(n.isIntersecting){const r=n.target;if(wn(r))return void s.unobserve(r);const o=gn(r),{layer:u,template:p}=o;zi(r,!0);const c=await zt.fetchThumbnail(u,p).catch(()=>(zi(r,!1),null));if(c==null)return;r.appendChild(c)}})}),this.renderItemIcon=a=>f("span",{key:"icon",afterCreate:this._afterItemCreateOrUpdate,afterUpdate:this._afterItemCreateOrUpdate,afterRemoved:this._afterItemRemoved,"data-item":a,"data-has-icon":!1}),this._afterItemCreateOrUpdate=a=>{this._iconIntersectionObserver?.observe(a)},this._afterItemRemoved=a=>{this._iconIntersectionObserver?.unobserve(a)}}initialize(){const e=({label:t})=>!this.filterText||!!t?.toLowerCase().includes(this.filterText.toLowerCase());this.addHandles(T(()=>this.viewModel,(t,a)=>{t&&!t.filterFunction&&(this.filterFunction=e),a&&a!==t&&a.filterFunction===e&&(a.filterFunction=null)},Z))}destroy(){this._iconIntersectionObserver?.disconnect(),this._iconIntersectionObserver=null}loadDependencies(){return ct({input:()=>I(()=>import("./calcite-input-be8e458c.js"),["./calcite-input-be8e458c.js","./input-4cfd753f.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./observers-7949b362.js","./icon-3b706e0b.js","./progress-7a558d52.js"],import.meta.url),"list-item":()=>I(()=>import("./calcite-list-item-9a9b9029.js"),["./calcite-list-item-9a9b9029.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./utils3-e8f0e96c.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./loadable-7d140904.js","./action-9e20b9c8.js","./guid-4f97587b.js","./icon-3b706e0b.js","./loader-142f20e1.js"],import.meta.url),notice:()=>I(()=>import("./calcite-notice-842cb611.js"),["./calcite-notice-842cb611.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js"],import.meta.url)})}get filterFunction(){return this.viewModel.filterFunction}set filterFunction(e){this.viewModel.filterFunction=e}get groupBy(){return this.viewModel.groupBy}set groupBy(e){this.viewModel.groupBy=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layers(){return this.viewModel.layers}set layers(e){this.viewModel.layers=e}get selectedItem(){return this.viewModel.selectedItem}castVisibleElements(e){return{...qi,...e}}select(e,t){return this.viewModel.select(e,t)}render(){const{enableListScroll:e,filterText:t,headingLevel:a,messages:s,viewModel:{items:n,numberOfFeatureTemplates:r,selectedItem:o,state:u}}=this,p=this.visibleElements.filter&&r>1;if(fn(n)){const c=n.find(h=>h.label===Jt.nullGroupBy.label);c&&(c.label=s.other)}return f("div",{class:this.classes(Pt.base,Pt.widget),"aria-label":s.widgetLabel},u==="loading"?this.renderLoader():u==="ready"?f(va,{enableListScroll:e,filterEnabled:p,filterText:t,headingLevel:a,id:this.id,identify:yn,items:n,messages:{filterPlaceholder:s.filterPlaceholder,noItems:s.noItems,noMatches:s.noMatches},renderIcon:this.renderItemIcon,renderCustomItem:this.renderCustomItem,renderCustomGroupContent:this.renderCustomGroupContent,renderItemContent:this.renderItemContent,renderItemContentEnd:this.renderItemContentEnd,renderItemDescription:this.renderItemDescription,renderItemLabel:this.renderItemLabel,selectedItem:o??void 0,selectionMode:"single",onItemSelect:c=>!da(c)&&this.viewModel.select(c),onFilterChange:c=>{this.filterText=c,this.viewModel.refresh()}}):null)}renderLoader(){return f("div",{class:Pt.loader,key:"loader"})}};function gn(i){return i?.["data-item"]}function wn(i){return!!i?.["data-has-icon"]}function zi(i,e){i&&(i["data-has-icon"]=e)}l([d()],x.prototype,"enableListScroll",void 0),l([d()],x.prototype,"filterFunction",null),l([d()],x.prototype,"filterText",void 0),l([d()],x.prototype,"groupBy",null),l([d()],x.prototype,"headingLevel",void 0),l([d()],x.prototype,"label",null),l([d()],x.prototype,"layers",null),l([d(),se("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],x.prototype,"messages",void 0),l([d({readOnly:!0})],x.prototype,"selectedItem",null),l([d(),li("select")],x.prototype,"viewModel",void 0),l([d()],x.prototype,"visibleElements",void 0),l([si("visibleElements")],x.prototype,"castVisibleElements",null),l([d()],x.prototype,"renderCustomItem",void 0),l([d()],x.prototype,"renderCustomGroupContent",void 0),l([d()],x.prototype,"renderItemLabel",void 0),l([d()],x.prototype,"renderItemDescription",void 0),l([d()],x.prototype,"renderItemContent",void 0),l([d()],x.prototype,"renderItemContentEnd",void 0),x=l([E("esri.widgets.FeatureTemplates")],x);const _n=x;function Be(i,e,t=void 0){It(i,"`"+e+"` is deprecated, because it instantiates the deprecated class 'esri.widgets.Editor.CreateWorkflow'",{replacement:t,version:"4.23",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-Editor-CreateFeaturesWorkflow.html"})}let Pe=class extends G{constructor(e){super(e),this.creationInfo=null,this.pendingFeatures=new rt,this.viewModel=null,this.upload=null}};l([d()],Pe.prototype,"creationInfo",void 0),l([d()],Pe.prototype,"viewModel",void 0),l([d()],Pe.prototype,"upload",void 0),Pe=l([E("esri.widgets.Editor.CreateFeaturesWorkflowData")],Pe);function Vt(i){const e=i.sourceLayer;if(!e||e.type!=="feature"||!kn(e.renderer))return{rotation:null,size:null};let t=null,a=null;const s=e.renderer.getVisualVariablesForType("rotation").filter(r=>(!r.axis||r.axis==="heading")&&r.field&&!r.valueExpression&&za(r,i)!=null);s.length===1&&(t=vn(s[0],e));const n=e.renderer.getVisualVariablesForType("size").filter(r=>r.field&&!r.useSymbolValue&&!r.valueExpression&&Ja(r)===Ka.RealWorldSize&&Qa(r,i)!=null);return n.length===1&&(a=Fn(n[0],e)),{rotation:t,size:a}}function vn(i,e){const t=(i.axis||"heading")==="heading"&&i.rotationType==="arithmetic"?-1:1,a=i.field,s=e.fields&&e.fields.filter(o=>o.name===a),n=s&&s.length===1?s[0].type:"double",r={initial:0,current:0};return{field:a,fieldType:n,getDefault:()=>Promise.resolve(0),getValue:o=>(r.current=r.initial-t*o,Kt((r.current+360)%360,n)),initValue:o=>{r.initial=o??r.current,r.current=0},isUpdatingInteractively:!1,rotationType:i.rotationType??"geographic"}}function bn(i,e){switch(e){case"width":return i[0];case"depth":return i[1];case"height":return i[2];default:return i[2]||i[1]||i[0]}}async function In(i,e,t){if(e==null)return 0;const{symbol:a}=Xa(e);if(a==null||a.type==="web-style"||a.type==="cim")return 0;const s=a.symbolLayers.at(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:n}=await I(()=>import("./symbolLayerUtils-dcdca8a5.js"),["./symbolLayerUtils-dcdca8a5.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url);return s.size||Math.min(he.icon,(await n(s,he.icon))[0])||he.icon}case"text":return s.size||he.text;case"line":return s.size||he.line;case"object":{const{computeObjectLayerResourceSize:n}=await I(()=>import("./symbolLayerUtils-dcdca8a5.js"),["./symbolLayerUtils-dcdca8a5.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url);return bn(await n(s,i.scale/he.viewScaleSizeFactor),t)}case"path":return(s.width!=null?s.width:s.height)||i.scale/he.viewScaleSizeFactor;case"extrude":return s.size||i.scale/he.viewScaleSizeFactor;default:return 0}}function Fn(i,e){const t=i.field,a=i.axis,s=e.fields&&e.fields.filter(p=>p.name===t),n=s&&s.length===1?s[0].type:"double",r={updating:!1,initial:0,current:0},o=Ya[i.valueUnit]??1;let u;return u=i.valueRepresentation==="area"?p=>(p*o/2)**2*Math.PI:i.valueRepresentation==="radius"||i.valueRepresentation==="distance"?p=>p*o/2:p=>p*o,{field:t,fieldType:n,getDefault:async(p,c)=>Kt(u(await In(c,p,a)),n),getValue:(p,c)=>(r.initial||(r.initial=c.pixelSizeAt(c.center)),r.current=r.initial*p,Kt(r.current,n)),initValue:p=>{r.initial=p??r.current,r.current=0},isUpdatingInteractively:!1,displayUnit:Pn(i.valueUnit),axis:i.axis}}function Kt(i,e){switch(e){case"small-integer":case"integer":case"long":return Math.round(i);case"double":case"single":return i;default:return 0}}function kn(i){switch(i?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function Ie(i,e){const t=await Bt(i,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:e});Za(i.symbol,t)!=null&&(i.symbol=t)}function Cn(i){if(!i)throw new Error("no geometry type");return i==="multipatch"?"mesh":i}async function En(i,e,t,a){await Qt(i,e,a);const s=i.on("create",async n=>{if(n.state==="cancel")return Qt(i,e,a);if(n.state==="complete"){const r=n.graphic;r.sourceLayer||(r.sourceLayer=e.layer),r.attributes||(r.attributes={...e.template?.prototype.attributes}),await Ie(r,a),t(r)}});return ue([s,W(()=>i.cancel())])}async function Qt(i,e,t){const a=e.layer,s={...e.template?.prototype.attributes};await Mn(i,a,s,t),i.layer.elevationInfo=a.elevationInfo,await i.create(Cn(a.geometryType),{graphicProperties:{attributes:s,sourceLayer:a},hasZ:a.capabilities.data.supportsZ,geometryToPlace:e.geometryToPlace??void 0})}async function Mn(i,e,t,a){const s=new dt({sourceLayer:e,attributes:t}),{rotation:n,size:r}=Vt(s);let o=await Bt(s,{useSourceLayer:!0,webStyleCache:a}),u=!1;for(const p of[r,n])p!=null&&t[p.field]==null&&(t[p.field]=await p.getDefault(o,i.view),u=!0);switch(u&&(o=await Bt(s,{useSourceLayer:!0,webStyleCache:a})),o?.type){case"simple-fill":case"polygon-3d":i.polygonSymbol=o;break;case"simple-line":case"line-3d":i.polylineSymbol=o;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":i.pointSymbol=o}ba(i.tooltipOptions,r,n)}function ba(i,e,t){i.visualVariables=e!=null||t!=null?{size:e!=null?{unit:e.displayUnit,axis:e.axis,valueType:e.fieldType}:null,rotation:t!=null?{valueType:t.fieldType,rotationType:t.rotationType??"geographic"}:null}:null}function pi(i,e){return i?i.find(t=>t.layer===e):void 0}async function Vn(i,e,t,a){if(i.length===0)return[];const{updatable:s,graphicsByLayer:n}=await t.async(async()=>{const{results:r}=await Ft(es(e,t),a),o=new Map,u=c=>{const h=c.layer,m=o.get(h);if(!m){const y=new Array;return o.set(h,y),y}return m};sa(r).forEach(({graphic:c})=>u(c).push(c));const p=i.filter(({supports:c,layer:h})=>c.includes("update")&&o.has(h));return p.length!==0&&t.stopPropagation(),{updatable:p,graphicsByLayer:o}});return Ft(na(s.map(async({layer:r})=>{const{objectIdField:o}=r,u="displayField"in r?r.displayField:null,p=[o];u!=null&&r.fieldsIndex.has(u)&&p.push(u);const c=n.get(r);if(c.some(h=>p.some(m=>!(m in h.attributes)))){const h=r.createQuery();return h.outFields=p,h.returnGeometry=!1,h.objectIds=c.map(m=>m.getObjectId()),r.queryFeatures(h,{signal:a}).then(({features:m})=>m)}return c})),a)}async function An(i,e,t,a){if(i.length===0)return[];let s=null;const n=await t.async(async()=>{const{results:r}=await Ft(e.hitTest(t),a);if(r.length===0)return[];const o=new Set;s=sa(r),s.forEach(({graphic:p})=>p&&o.add(p.layer));const u=i.items.filter(({layer:p,supports:c,attachmentsOnUpdateEnabled:h})=>o.has(p)&&(c.includes("update")||c.includes("delete")||h));return u.length>0&&t.stopPropagation(),u});return Ft(na(n.map(({layer:r})=>{const o=r.objectIdField,u="displayField"in r?r.displayField:null,p=ra({displayField:u,fields:r.fields}),c=[o];p!=null&&r.fieldsIndex.has(p)&&c.push(p);const h=r.createQuery();h.outFields=c,h.returnGeometry=!1;const m="renderer"in r?xs({renderer:r.renderer,event:t}):0;return h.geometry=Os(t.mapPoint,m,e),h.outSpatialReference=e.spatialReference,r.queryFeatures(h,{signal:a}).then(({features:y})=>(s?.forEach(({graphic:g})=>{g.layer!==r||y.some(w=>w.getObjectId()===g.getObjectId())||y.push(g)}),y))})),a)}async function Tn(i,e,t,a){switch(e.type){case"3d":return Vn(i,e,t,a);case"2d":return An(i,e,t,a)}}async function $n(i,e,t){const{sourceLayer:a}=i,s=a.createQuery();s.objectIds=[i.getAttribute(a.objectIdField)],s.outFields=["*"],s.outSpatialReference=e,s.returnM=a.capabilities.data.supportsM,s.returnZ=a.capabilities.data.supportsZ,ni()&&ri()&&a.type==="scene"&&a.infoFor3D!=null&&(s.returnGeometry=!0,s.formatOf3DObjects="3D_glb");const n=await a.queryFeatures(s,{signal:t});return qe(t),n.features[0]}async function ot(i){const{graphic:e,sketchViewModel:t,sourceLayer:a,visualVariables:s,webStyleCache:n}=i;let r=!1;const{rotation:o,size:u}=s;[o,u].forEach(async c=>{if(c==null)return;const h=e.getAttribute(c.field);if(h!=null)c.initValue(h);else{const m=await c.getDefault(e.symbol,t.view);c.initValue(m),e.setAttribute(c.field,m),r=!0}}),r&&await Ie(e,n);const p={multipleSelectionEnabled:!1};return a.geometryType==="point"&&(p.enableRotation=o!=null,p.enableScaling=u!=null),ba(t.tooltipOptions,u,o),t.layer.elevationInfo=a.elevationInfo,t.update(e,p)}function Ln(i){return i==null||i.type!=="rotate-start"&&i.type!=="rotate"&&i.type!=="rotate-stop"?null:i}function Sn(i){return i==null||i.type!=="scale-start"&&i.type!=="scale"&&i.type!=="scale-stop"?null:i}async function hi(i,e,t,a,s){if(e.geometry==null||e.geometry?.type!=="point")return;const n=a.rotation,r=Ln(t.toolEventInfo);if(n!=null&&r!=null)if(r.type==="rotate-stop")n.isUpdatingInteractively=!1,n.initValue();else{n.isUpdatingInteractively=!0;const{field:p,getValue:c}=n;e.setAttribute(p,c(r.angle,i))}const o=a.size,u=Sn(t.toolEventInfo);if(o!=null&&u!=null)if(u.type==="scale-stop")o.isUpdatingInteractively=!1,o.initValue();else{o.isUpdatingInteractively=!0;const{field:p,getValue:c}=o;e.setAttribute(p,c(u.xScale,i))}await Ie(e,s)}async function xn(i,e,t,a,s,n){const r=Ut(i);await Ie(r,n),a.map.add(t.layer),t.layer.add(r);const o=i.sourceLayer,u=lt(a,o);await Dn(a,r),await ot({graphic:r,sketchViewModel:t,sourceLayer:o,visualVariables:e,webStyleCache:n});const p=On(t,i,r);let c=null;u.then(v=>c=v).catch(()=>{});const h=e.size,m=e.rotation,y=T(()=>i.attributes,async v=>{let b=!1;for(const F in v){const $=v[F];$!==r.getAttribute(F)&&(r.setAttribute(F,$),h==null||h.isUpdatingInteractively||h.field!==F||h.initValue($),m==null||m.isUpdatingInteractively||m.field!==F||m.initValue($),(c==null||c.requiredFields.includes(F))&&(b=!0))}b&&await Ie(r,n)}),g=t.on("update",async v=>{const b=v.graphics[0];if(v.state==="complete")return ot({graphic:b,sketchViewModel:t,sourceLayer:o,visualVariables:e,webStyleCache:n});await hi(a,b,v,e,n),s(Ut(b),v)}),w=t.on(["undo","redo"],async v=>{s(Ut(v.graphics[0]),v)}),_=t.updateOnGraphicClick;return{visual:ue([p,W(()=>{t.updateOnGraphicClick=_})]),interactive:ue([w,g,W(()=>t.cancel()),y,W(()=>{t.updateOnGraphicClick=!1})])}}function On(i,e,t){const a=i.view,s=e.sourceLayer,n=e.layer,r=e.getAttribute(n.objectIdField);let o=null;function u(p){o?.abort(),o=aa(async c=>{const h=await lt(a,s);qe(c),h.setVisibility?.(r,p)})}return u(!1),ue([Rn(a,t,p=>u(!p)),W(async()=>{u(!0);const p=await lt(a,s);await H(()=>!p.updating),i.layer.remove(t)})])}function Rn(i,e,t){if(i.type==="3d"){const a=new ha({graphic:e});return ue([i.trackGraphicState(a),T(()=>a.displaying,t)])}return T(()=>e.visible,t)}async function Dn(i,e){if(i.type==="3d"){const t=new ha({graphic:e}),a=i.trackGraphicState(t);await H(()=>t.displaying),a.remove()}else await H(()=>e.visible)}const he={icon:$t(24),text:$t(12),line:$t(1),viewScaleSizeFactor:100};function mi(i,e,t){let a=!1;return i.filter(s=>!!a||(a=s===e,a)).map(s=>t[s]())}function Wn(i){if(i.length!==1)return null;const e=i[0];if("items"in e){const t=e;return t.items.length===1?t.items[0]:null}return e}function Ia(i,e){if(i.viewModel.refreshCreationTemplates(),e[0].id==="awaiting-feature-creation-info"){const t=Wn(i.viewModel.featureTemplatesViewModel.items);t==null||t.supportsUpload||(i.creationInfo=t,e.shift())}return e}function Pn(i){switch(i){case"unknown":case"decimal-degrees":return null;default:return i}}function Fa(i){i.filesEnabled=!0,i.mode="view",i.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}function ka(i){const{creationInfo:e,viewModel:t}=i;if(!e)return!1;const{layer:a}=e,s=t.editableItems.find(o=>o.layer===a);if(s)return s.attachmentsOnCreateEnabled;const n=a.capabilities?.data,r=t.layerInfos?.find(o=>o.layer===a);return!(!(n&&"supportsAttachment"in n&&n.supportsAttachment)||r&&(r.allowAttachments===!1||r.attachmentsOnUpdateEnabled===!1))}const Ca=i=>/-stop/.test(i)||/vertex-/.test(i),lt=(i,e)=>{const t=e.type==="subtype-sublayer"?e.parent:e;return i.whenLayerView(t)};function Un(i){return"createInteractiveEditSession"in i}function Ut(i){const e=i.geometry;if(e?.type==="mesh"){const t=i.cloneShallow();return t.attributes=ea(i.attributes),t.geometry=e.cloneShallow(),t.geometry.transform=e.transform?.clone()??null,t}return i.clone()}function Yt(i){const e=i.cursor;return i.cursor="progress",W(()=>i.cursor=e)}async function Gn({view:i,data:e,signal:t,next:a,cancel:s}){const{creationInfo:n}=e;if(!n||!Et(n))return;const{layer:r}=n,o=n.geometryToPlace!=null;if(n.geometryToPlace=null,o)return void s();const u=(await I(()=>import("./Upload-337ca568.js"),["./Upload-337ca568.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url)).Upload;qe(t);const p=new u;e.upload=p;const c=Yt(i),h=ue([c,T(()=>p.state,m=>{switch(m){case"success":n.maxFeatures=1,n.geometryToPlace=p.result,a();break;case"error":c.remove();break;case"canceled":s()}}),W(()=>{e.upload=nt(e.upload)})]);return p.uploadTo(r),h}function Et(i){return i?.layer?.type==="scene"}let O=class extends Fe(Mt.EventedAccessor){constructor(e){super(e),this._indexHistory=[],this._lastStepIndex=-1,this._stepIndex=-1,this._setupAbortController=null,this._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},this.data=void 0,this.started=!1,this.steps=[],this.type=null}get hasNextStep(){const{steps:e}=this;return!!(e&&this._stepIndex<e.filter(t=>!t.parent).length-1)}get hasPreviousStep(){return this._stepIndex>0}get reliesOnOwnerAdminPrivileges(){return!1}get hasInvalidFormTemplate(){return!1}get hasUnsupportedFields(){return!1}get shouldShowAttachments(){return!1}get shouldAllowAttachmentEditing(){return!1}get stepId(){const{steps:e}=this,t=e&&e[this._stepIndex];return t&&t.id}get helpMessage(){}get hasPendingEdits(){return!1}get keyboardCancellationEnabled(){return!0}async back(e=()=>Promise.resolve(!0)){this.hasPendingEdits&&!await e()||(this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0}))}async cancel(e={force:!0}){return e.force!==!1?this._cancel(e):new Promise((t,a)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel({...e,force:!0}).then(t)},deny:()=>a(new R("workflow:cancel-denied","Request to cancel workflow was denied."))}})})}async commit(){this.handles.remove(this._handleKeys.beforeCommit),await this.onCommit?.(this.data),this.handles.remove(this._handleKeys.afterCommit),this.emit("commit")}async go(e){const{steps:t}=this,a=t.findIndex(s=>s.id===e);this._indexHistory.push(this._stepIndex),await this._go(a)}async next(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)}async previous(e={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),e.cancelCurrentStep)}async reset(){await this._cancel({notify:!1}),await this.start()}async save(){await this.commit(),await this.reset()}async start(){this._set("started",!0);const e=this._stepIndex===-1?0:this._stepIndex;await this._go(e)}async _cancel({notify:e=!0,error:t}={}){this.started&&(this._set("started",!1),await this.steps[this._stepIndex].tearDown({canceled:!0})),this.handles.remove([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(e),e&&this.emit("cancel",{error:t})}async _go(e=-1,t=!1){const{steps:a}=this;if(e<=-1||e>=a.length)return;if(!this.started)return this._stepIndex=e,void this._notifyStepProps();this._lastStepIndex>-1&&(this._setupAbortController=kt(this._setupAbortController),await a[this._lastStepIndex].tearDown({canceled:t})),this._setupAbortController=new AbortController;const s=this._setupAbortController.signal;try{await a[e].setUp(s)}catch(n){ts(n)}this._setupAbortController.signal===s&&(this._setupAbortController=null),s.aborted||(this._lastStepIndex=e,this._stepIndex=e,this._notifyStepProps())}_resetIndexing(e=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,e&&this._notifyStepProps()}_notifyStepProps(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")}};l([d()],O.prototype,"data",void 0),l([d()],O.prototype,"hasNextStep",null),l([d()],O.prototype,"hasPreviousStep",null),l([d()],O.prototype,"onCommit",void 0),l([d()],O.prototype,"reliesOnOwnerAdminPrivileges",null),l([d()],O.prototype,"hasInvalidFormTemplate",null),l([d()],O.prototype,"hasUnsupportedFields",null),l([d()],O.prototype,"shouldShowAttachments",null),l([d()],O.prototype,"shouldAllowAttachmentEditing",null),l([d()],O.prototype,"started",void 0),l([d({readOnly:!0})],O.prototype,"stepId",null),l([d()],O.prototype,"steps",void 0),l([d({readOnly:!0})],O.prototype,"type",void 0),l([d()],O.prototype,"helpMessage",null),l([d()],O.prototype,"hasPendingEdits",null),l([d()],O.prototype,"keyboardCancellationEnabled",null),O=l([E("esri.widgets.Editor.Workflow")],O);const At=O;var yt;const Gt=Symbol(),Ji=Symbol();let ie=yt=class extends At{constructor(i){super(i),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[]}get hasPendingEdits(){if(this.numPendingFeatures)return!0;const{data:i}=this,{upload:e}=i;return!(!e||e.error)||!!i.creationInfo?.geometryToPlace}get helpMessage(){const{creationInfo:i,viewModel:e}=this.data;if(this.stepId!=="creating-features"||!i)return;const t=i.layer.geometryType,a=e.sketchViewModel.createGraphic?.geometry;return ca(t,a,e.view)}get numPendingFeatures(){return this.pendingFeatures.length}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return this.numPendingFeatures===0}get reliesOnOwnerAdminPrivileges(){const{creationInfo:i}=this.data;if(!i)return!1;const{layer:e}=i,t=e.capabilities?.operations.supportsAdd,a=$e(e)?.operations.supportsAdd;return oi(e)&&!e.editingEnabled||!!a&&!t}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&ka(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get updating(){return this.updatingHandles.updating}get test(){return{addAttachment:(i,e)=>{this._attachmentFileInfos.set(i,e)}}}async enter(){const{featureFormViewModel:i}=this.data.viewModel,e=i.relatedRecordCallbacks;i.relatedRecordCallbacks=null,this.addHandles(W(()=>{i.relatedRecordCallbacks=e}),Ji)}exit(){this.removeHandles(Ji)}async updatePendingFeature(i,e){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),_i(this._lastActiveGraphics,i),this._startUpdating(i,e)}static create(i){const{addAttachmentsCallback:e,applyEditsCallback:t,creationInfo:a,startAt:s,viewModel:n}=i,r=new yt({data:new Pe({creationInfo:a,viewModel:n}),onCommit:async o=>{const{creationInfo:u}=o;if(!u)return;u.geometryToPlace&&(o.creationInfo=null);const p=o.pendingFeatures.toArray(),{layer:c}=u,h=c.capabilities?.editing.supportsGlobalId&&"globalIdField"in c,m=r._attachmentFileInfos;if(h){const g=Bn(p,c,m);return void await t(c,g,{globalIdUsed:!0})}const y=await t(c,{addFeatures:p});if(m.size>0){const g=y?.addFeatureResults??[];await e(c,jn(p,g,c,m))}}});return r._set("steps",this._createWorkflowSteps(r,s)),r}_fadeExistingFeatures(i){if("effect"in i){const t=i.effect;return i.effect="saturate(0.6) opacity(0.8)",W(()=>i.effect=t)}const e=i.opacity;return i.opacity=.7,W(()=>i.opacity=e)}_highlight(i){const e=this.data.viewModel.view;e?.type==="3d"&&this._highlightHandles.set(i,e.highlight(i))}_removeHighlight(i){Lt(this._highlightHandles.get(i)),this._highlightHandles.delete(i)}async _startCreating(i){const{data:e}=this,{creationInfo:t}=e;if(t)return this.createFeatureState="create-new",Qt(e.viewModel.sketchViewModel,t,i)}async _startUpdating(i,e){const{pendingFeatures:t}=this;t.includes(i)||t.add(i);const{creationInfo:a,viewModel:s}=this.data,{featureFormViewModel:n,layerInfos:r,sketchViewModel:o,view:u}=s;if(!u||!a)return;const p=a.layer,c=pi(r,p),h=c?.formTemplate,m=u.spatialReference;return n.set({arcadeEditType:"INSERT",feature:i,formTemplate:h,spatialReference:m,map:u.map}),this._removeHighlight(i),await Ie(i,e),Lt(this._featureFormHandle),this._featureFormHandle=ue([n.on("value-change",async()=>{i.attributes=n.getValues(),await Ie(i,e)}),o.on(["update","undo","redo"],y=>{(y.type==="undo"||y.type==="redo"||y.type==="update"&&y.toolEventInfo!=null&&Ca(y.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()})]),this.createFeatureState="update-pending",this._visualVariableAttributes=Vt(i),He(p)?void 0:ot({graphic:i,sketchViewModel:o,sourceLayer:p,visualVariables:this._visualVariableAttributes,webStyleCache:e})}static _createWorkflowSteps(i,e="awaiting-feature-creation-info"){const{data:t,handles:a}=i,s=mi(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(n){const{creationInfo:r,viewModel:o}=t,{view:u}=o;if(u)if(Et(r)){const p=await Gn({view:u,data:t,signal:n,next:()=>i.next(),cancel:()=>o.cancelWorkflow()});qe(n),a.add(p,this.id)}else t.creationInfo=null,a.add(o.featureTemplatesViewModel.on("select",({item:p})=>{p&&(t.creationInfo=p,o.activeWorkflow?.next())}),this.id)},async tearDown(){a.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(a.has(this.id))return;const{viewModel:n}=t,{view:r}=n;if(!r)return;const o=new Map,u=[],p=[];i._lastActiveGraphics=[],i._featureFormHandle=Lt(i._featureFormHandle),i._visualVariableAttributes={rotation:null,size:null},Fa(n.attachmentsViewModel),u.push(T(()=>n.attachmentsViewModel.mode,m=>{switch(m){case"add":i.go("adding-attachment");break;case"edit":i.go("editing-attachment")}}));const c=Yt(r);u.push(c);const h=He(i.data.creationInfo?.layer);try{if(!h){const y=yt._configureSketchViewModel(i,o);u.push(y.beforeCommit),p.push(y.afterCommit)}const m=t.creationInfo?.initialFeature;m?(h||n.sketchViewModel.layer.add(m),await i._startUpdating(m,o)):await i._startCreating(o)}finally{c.remove()}u.push(i._featureFormHandle),a.add(u,i._handleKeys.beforeCommit),a.add([...u,...p],this.id)},async tearDown(n){const{viewModel:r}=t;if(n.canceled){const{pendingFeatures:o}=i;o.drain(u=>r.sketchViewModel.layer.remove(u)),a.remove([this.id,Gt]),r.attachmentsViewModel.fileInfos.removeAll(),i._attachmentFileInfos.clear()}}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:n}=t.viewModel,{graphic:r,fileInfos:o}=n;i._attachmentFileInfos.set(r,o.toArray()),n.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:n}=t.viewModel,{graphic:r,fileInfos:o}=n;i._attachmentFileInfos.set(r,o.toArray()),n.mode="view"}})});return Ia(t,s)}static _configureSketchViewModel(i,e){const{data:t,handles:a}=i,{viewModel:s}=t,{view:n}=s,r=s.sketchViewModel;let o=null;const u=[];if(!n)return{beforeCommit:W(),afterCommit:W()};const p=r.updateOnGraphicClick;return r.updateOnGraphicClick=!1,n.type==="2d"&&t.creationInfo&&u.push(i._fadeExistingFeatures(t.creationInfo.layer)),u.push(r.on("create",async c=>{if(c.state==="cancel"){if(i._preventDefaultActionOnCancel)return void(i._preventDefaultActionOnCancel=!1);if(i._lastActiveGraphics.length<1)return i._startCreating(e);const h=i._lastActiveGraphics.pop();return i._startUpdating(h,e)}if(c.state==="complete"&&c.graphic)return i._startUpdating(c.graphic,e)}),r.on("update",async c=>{const{viewModel:h}=t,{attachmentsViewModel:m,featureFormViewModel:y}=h,g=c.graphics[0];if(c.state==="complete"){if(g!==o&&(i._lastActiveGraphics.push(g),i._highlight(g)),o=null,i.numPendingFeatures===t.creationInfo?.maxFeatures){const F=i._lastActiveGraphics.pop();return i._startUpdating(F,e)}if(m.mode!=="add"&&m.mode!=="edit"||h.activeWorkflow?.previous(),c.aborted&&i._preventDefaultActionOnCancel)return void(i._preventDefaultActionOnCancel=!1);a.add([Yt(n),n.on("click",F=>F.preventDefault())],Gt),await H(()=>!y.updating),a.remove(Gt),i._startCreating(e)}c.state==="start"&&(i._removeHighlight(g),m.mode!=="add"&&m.mode!=="edit"||h.activeWorkflow?.previous(),m.fileInfos.removeAll(),m.graphic=g,m.mode="view",(i._attachmentFileInfos.get(g)||[]).forEach(({file:F,form:$})=>m.addFile(F,$)));const w=i._visualVariableAttributes;await hi(n,g,c,w,e);const _=g.attributes,{rotation:v,size:b}=w;if(v!=null){const{field:F}=v;y.setValue(F,_[F])}if(b!=null){const{field:F}=b;y.setValue(F,_[F])}}),r.on("delete",async c=>{const h=c.graphics[0];i.pendingFeatures.remove(h),_i(i._lastActiveGraphics,h),o=h}),n.on("immediate-click",async c=>{if(Et(t.creationInfo))return;const{results:h}=await n.hitTest(c,{include:r.layer}),m=h.find(g=>g.type==="graphic");if(!m)return;const y=m.graphic;if(r.activeTool==="transform"||r.activeTool==="reshape"){if(r.updateGraphics.at(0)===y)return;await i.updatePendingFeature(y,e)}}),W(()=>r.cancel()),Nn(r,t)),{beforeCommit:ue(u),afterCommit:W(()=>{r.updateOnGraphicClick=p})}}};function Nn(i,e){let t=null;const a=()=>i.snappingOptions.featureSources,s=()=>(t=new pa({layer:i.layer}),a().add(t),t),n=()=>{t!=null&&(a().remove(t),t=nt(t))};return ue([T(()=>{const r=e.creationInfo?.layer,o=a().find(u=>u.layer===r);return{hasFeatureLayerSource:!!o,enabled:o?.enabled??!1}},({hasFeatureLayerSource:r,enabled:o})=>{if(!r)return n();t??(t=s()),t.enabled=o},is),W(n)])}function jn(i,e,t,a){const s=[];return e.forEach((n,r)=>{if(!n.error){const o=i[r],u=a.get(o)||[];o.attributes[t.objectIdField]=n.objectId,u.forEach(({form:p})=>s.push({feature:o,attachment:p}))}}),s}function Bn(i,e,t){const a=[],s=e.globalIdField;return i.forEach((n,r)=>{var o;(o=i[r].attributes)[s]??(o[s]=vi()),(t?.get(n)||[]).forEach(({file:u})=>a.push({feature:n,attachment:{globalId:vi(),data:u}}))}),a.length?{addFeatures:i,addAttachments:a}:{addFeatures:i}}l([d()],ie.prototype,"hasPendingEdits",null),l([d()],ie.prototype,"helpMessage",null),l([d()],ie.prototype,"keyboardCancellationEnabled",null),l([d()],ie.prototype,"reliesOnOwnerAdminPrivileges",null),l([d()],ie.prototype,"shouldShowAttachments",null),l([d()],ie.prototype,"shouldAllowAttachmentEditing",null),l([d()],ie.prototype,"updating",null),ie=yt=l([E("esri.widgets.Editor.CreateFeaturesWorkflow")],ie);const Ea=ie;let Ue=class extends G{constructor(e){super(e),this.creationInfo=null,this.edits=null,this.viewModel=null}};l([d()],Ue.prototype,"creationInfo",void 0),l([d()],Ue.prototype,"edits",void 0),l([d()],Ue.prototype,"viewModel",void 0),Ue=l([E("esri.widgets.Editor.CreateWorkflowData")],Ue);const Hn=Ue;function Ki(i){return i==null?null:JSON.stringify(i)}let oe=class extends Fe(G){constructor(e){super(e),this._baselineAttributesJSON=null,this._baselineGeometryJSON=null,this._stagedForDelete=!1,this.feature=null}get attributesModified(){const e=this.feature?.attributes;return e!=null&&this._baselineAttributesJSON!==this._stringifyAttributes(e)}get geometryModified(){const e=this.feature?.geometry;return e!=null&&this._baselineGeometryJSON!==this._stringifyGeometry(e)}get stagedForDelete(){return this._stagedForDelete}get modified(){return this.attributesModified||this.geometryModified||this._stagedForDelete}stageDelete(){this._stagedForDelete=!0}unstageDelete(){this._stagedForDelete=!1}trackChanges(){const{feature:e}=this;if(!e)return;const{attributes:t,geometry:a}=e;this._baselineAttributesJSON=this._stringifyAttributes(t),this._baselineGeometryJSON=this._stringifyGeometry(a),this.notifyChange("attributesModified"),this.notifyChange("geometryModified")}updateAttributes(e){const{feature:t}=this;t&&(t.attributes=e,this.notifyChange("attributesModified"))}updateGeometry(e){const{feature:t}=this;t&&(t.geometry=e,this.notifyChange("geometryModified"))}_stringifyAttributes(e){return Ki(e)}_stringifyGeometry(e){return Ki(e?.type==="mesh"?{transform:e.transform,vertexSpace:e.vertexSpace}:e)}};l([d()],oe.prototype,"_stagedForDelete",void 0),l([d()],oe.prototype,"attributesModified",null),l([d()],oe.prototype,"feature",void 0),l([d()],oe.prototype,"geometryModified",null),l([d()],oe.prototype,"modified",null),oe=l([E("esri.widgets.Editor.Edits")],oe);var Zt;let we=Zt=class extends At{constructor(i){super(i),this.type="create"}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&ka(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get hasPendingEdits(){return!0}get helpMessage(){if(this.stepId!=="editing-new-feature")return;const{creationInfo:i,viewModel:e}=this.data,t=e.sketchViewModel.createGraphic?.geometry,a=i.layer.geometryType;return ca(a,t,e.view)}get reliesOnOwnerAdminPrivileges(){const{layer:i}=this.data.creationInfo,e=i.capabilities?.operations.supportsAdd,t=$e(i)?.operations.supportsAdd;return oi(i)&&!i.editingEnabled||!!t&&!e}static create(i,e,t){const a=new Zt({data:new Hn({edits:new oe,viewModel:i}),onCommit:async s=>{await t(s.creationInfo.layer,{addFeatures:[s.edits.feature]})}});return a._set("steps",this._createWorkflowSteps(a,e)),a}static _createWorkflowSteps(i,e="awaiting-feature-creation-info"){const{data:t,handles:a}=i,s=new Map,n=mi(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){t.creationInfo=null,t.edits.feature=null,t.viewModel.featureTemplatesViewModel.select(null),a.add(t.viewModel.featureTemplatesViewModel.on("select",({item:r})=>{r&&(t.creationInfo=r,t.viewModel.activeWorkflow?.next())}),this.id)},async tearDown(){a.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){a.add(await En(t.viewModel.sketchViewModel,t.creationInfo,r=>{t.edits.feature=r,t.viewModel.activeWorkflow?.next()},s),this.id)},async tearDown(){a.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const r=t.edits.feature,o=r.sourceLayer,u=t.viewModel,p=u.sketchViewModel,c=pi(u.layerInfos,o),h=c?.formTemplate,{spatialReference:m}=u.view;u.featureFormViewModel.set({arcadeEditType:"INSERT",feature:r,formTemplate:h,spatialReference:m}),p.allowDeleteKey=!1,Fa(u.attachmentsViewModel);const y=Vt(r);await ot({graphic:r,sketchViewModel:p,sourceLayer:o,visualVariables:y,webStyleCache:s});const g=p.on("update",async w=>{const _=w.graphics[0];if(w.state==="complete")return ot({graphic:_,sketchViewModel:p,sourceLayer:o,visualVariables:y,webStyleCache:s});await hi(p.view,_,w,y,s);const v=_.attributes;if(y.rotation!=null){const{field:b}=y.rotation;u.featureFormViewModel.setValue(b,v[b])}if(y.size!=null){const{field:b}=y.size;u.featureFormViewModel.setValue(b,v[b])}});a.add([t.viewModel.featureFormViewModel.on("value-change",async()=>{t.edits.updateAttributes(t.viewModel.featureFormViewModel.getValues()),r.attributes=t.edits.feature.attributes,p.view.type==="3d"&&await Ie(r,s)}),g,T(()=>t.viewModel.attachmentsViewModel.mode,w=>{w==="add"&&t.viewModel.activeWorkflow.go("adding-attachment"),w==="edit"&&t.viewModel.activeWorkflow.go("editing-attachment")})],this.id)},async tearDown(r){r.canceled&&t.viewModel.sketchViewModel.layer.removeAll(),a.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){t.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){t.viewModel.attachmentsViewModel.mode="view"}})});return Ia(t,n)}};l([d()],we.prototype,"shouldShowAttachments",null),l([d()],we.prototype,"shouldAllowAttachmentEditing",null),l([d()],we.prototype,"hasPendingEdits",null),l([d()],we.prototype,"helpMessage",null),l([d()],we.prototype,"reliesOnOwnerAdminPrivileges",null),we=Zt=l([E("esri.widgets.Editor.CreateWorkflow")],we);const qn=we;var gt;let _e=gt=class extends G{constructor(i){super(i),this.attachmentsCapabilities=null,this.editableItem=null,this.edits=null,this.formTemplate=null,this.viewModel=null}static async create(i){const e=gt._makeConstructorProps(i);return new gt(e)}static _makeConstructorProps(i){const{feature:e,viewModel:t}=i,a=t.editableItems.find(u=>u.layer===e.layer);if(!a)throw new R("no-editableItem-found","The EditorViewModel provided did not have an EditableItem associated with the specified Graphic's layer");const s=pi(t.layerInfos,e.sourceLayer),n=a.supports,r=n.includes("create"),o=n.includes("update");return{attachmentsCapabilities:{editing:!0,operations:{add:r||o,update:o,delete:o}},editableItem:a,edits:new oe({feature:e}),formTemplate:s?.formTemplate,viewModel:t}}};l([d()],_e.prototype,"attachmentsCapabilities",void 0),l([d()],_e.prototype,"editableItem",void 0),l([d()],_e.prototype,"edits",void 0),l([d()],_e.prototype,"formTemplate",void 0),l([d()],_e.prototype,"viewModel",void 0),_e=gt=l([E("esri.widgets.Editor.UpdateRecordWorkflowData")],_e);const Ma=_e;var wt;let _t=wt=class extends Ma{constructor(i){super(i)}static async create(i){const{feature:e,viewModel:t}=i,{view:a}=t;if(!a)throw new R("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const s=await lt(a,e.layer);return new wt({...wt._makeConstructorProps(i),layerView:s})}};l([d()],_t.prototype,"layerView",void 0),_t=wt=l([E("esri.widgets.Editor.UpdateFeatureWorkflowData")],_t);const zn=_t;var Xt;const vt={exit:Symbol()},Jn="esri.widgets.Editor.UpdateRecordWorkflow";let z=Xt=class extends At{constructor(i){super(i),this.fullFeature=null,this.type="update-table-record"}async initialize(){const{data:i}=this,{edits:e}=i,t=e.feature,a=new AbortController;this.addHandles(as(a)),this.updatingHandles.addPromise($n(t,i.viewModel.view.spatialReference,a.signal).then(s=>{ss(a)||this._onFullFeatureLoaded(s)},s=>this.cancel({force:!0,error:new R("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:s}})})))}get editableItem(){return this.data.editableItem}get hasPendingEdits(){return this.data.edits.modified}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get updating(){return this.updatingHandles.updating}get reliesOnOwnerAdminPrivileges(){const{layer:i}=this.editableItem,e=i.capabilities?.operations.supportsUpdate,t=$e(i)?.operations.supportsUpdate;return oi(i)&&!i.editingEnabled||!!t&&!e}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel(),this._configureFeatureFormViewModel()}exit(i){this.removeHandles(vt.exit)}_configureAttachmentsViewModel(){const{data:i,fullFeature:e}=this,{attachmentsCapabilities:t,viewModel:a}=i,{attachmentsViewModel:s}=a;s.set({capabilities:t,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles(T(()=>s.mode,n=>{switch(n){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}),vt.exit)}_configureFeatureFormViewModel(){const{edits:i,formTemplate:e,viewModel:{featureFormViewModel:t,view:a}}=this.data;t.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,map:a?.map,spatialReference:a.spatialReference}),this.addHandles(t.on("value-change",()=>{i.updateAttributes(t.getValues()),this.fullFeature.attributes=i.feature.attributes}),vt.exit)}_onFullFeatureLoaded(i){this.fullFeature=i;const{edits:e}=this.data;e.updateAttributes(i.attributes),e.trackChanges()}static async create(i){const e=new Xt({data:await Ma.create(i),onCommit:this._onCommitFactory(i.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(i){const{attachmentsViewModel:e}=i.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};z._onCommitFactory=i=>async e=>{const{edits:t}=e,{feature:a}=t;if(!a)return;const s=a.sourceLayer,n=a.clone();if(!t.attributesModified||t.stagedForDelete){const o=s.objectIdField;if(n.attributes={[o]:a.getAttribute(o)},ni()&&ri()&&s.type==="scene"&&s.infoFor3D!=null){const u=s.associatedLayer?.globalIdField;u!=null&&n.setAttribute(u,a.getAttribute(u))}}t.geometryModified&&!t.stagedForDelete||(n.geometry=null);const r=t.stagedForDelete?"deleteFeatures":"updateFeatures";await i(s,{[r]:[n]})},l([d()],z.prototype,"editableItem",null),l([d()],z.prototype,"fullFeature",void 0),l([d()],z.prototype,"hasPendingEdits",null),l([d()],z.prototype,"shouldShowAttachments",null),l([d()],z.prototype,"shouldAllowAttachmentEditing",null),l([d()],z.prototype,"updating",null),l([d()],z.prototype,"reliesOnOwnerAdminPrivileges",null),z=Xt=l([E(Jn)],z);var ei;const ee={...vt,highlights:Symbol(),interactiveGraphics:Symbol(),geometryGraphics:Symbol()};let bt=ei=class extends z{constructor(i){super(i),this.type="update-feature",this._layerViewEditSession=null,this._webStyleCache=new Map}async initialize(){const{edits:{feature:i},layerView:e}=this.data;Un(e)&&(this._layerViewEditSession=e.createInteractiveEditSession(i))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(ee.interactiveGraphics);try{const i=this.data.edits.stagedForDelete;await super.commit(),this.removeHandles(ee.geometryGraphics);const e=this._layerViewEditSession;i?e?.rollback():e?.commit()}catch(i){throw this.removeHandles(ee.geometryGraphics),await this._configureSketchViewModel(),new R("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:i})}}async enter(){await super.enter(),this.data.editableItem.geometryUpdatesEnabled?this.hasHandles(ee.interactiveGraphics)||await this._configureSketchViewModel():this._configureHighlight()}exit(i={removeSketchHandles:!0}){super.exit(i),i.removeSketchHandles&&this.removeHandles([ee.geometryGraphics,ee.interactiveGraphics])}_configureFeatureFormViewModel(){super._configureFeatureFormViewModel();const{_layerViewEditSession:i}=this,{viewModel:e}=this.data;this.addHandles(e.featureFormViewModel.on("value-change",t=>{i?.setAttribute(t.fieldName,t.value)}),ee.exit)}_configureHighlight(){const{edits:i,layerView:e}=this.data;oa(e)&&this.addHandles(e.highlight(i.feature),ee.highlights)}async _configureSketchViewModel(){const{data:i,_layerViewEditSession:e}=this,{edits:t,viewModel:a}=i,s=t.feature,{featureFormViewModel:n,sketchViewModel:r,view:o}=a;r.allowDeleteKey=!1;const u=Vt(s),{interactive:p,visual:c}=await xn(s,u,r,o,({geometry:h,attributes:m},y)=>{if(t.updateAttributes(m),t.updateGeometry(h),n.feature.geometry=h,u.rotation!=null){const{field:w}=u.rotation;n.setValue(w,m[w])}if(u.size!=null){const{field:w}=u.size;n.setValue(w,m[w])}const{sourceLayer:g}=s;g!=null&&g.type==="scene"&&g.infoFor3D!=null&&ni()&&ri()&&e&&h!=null&&h.type==="mesh"&&e.setGeometry(h),(y.type==="undo"||y.type==="redo"||y.type==="update"&&y.toolEventInfo!=null&&Ca(y.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()},this._webStyleCache);this.addHandles(p,ee.interactiveGraphics),this.addHandles(c,ee.geometryGraphics)}_onFullFeatureLoaded(i){super._onFullFeatureLoaded(i);const{edits:e}=this.data;e.updateGeometry(i.geometry),e.trackChanges()}static async create(i){const e=new ei({data:await zn.create(i),onCommit:this._onCommitFactory(i.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}};l([d()],bt.prototype,"_layerViewEditSession",void 0),bt=ei=l([E("esri.widgets.Editor.UpdateFeatureWorkflow")],bt);let ve=class extends G{constructor(i){super(i),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.candidates=null,this.rootFeature=null,this.viewModel=null}};l([d()],ve.prototype,"addAttachmentsCallback",void 0),l([d()],ve.prototype,"applyEditsCallback",void 0),l([d()],ve.prototype,"candidates",void 0),l([d()],ve.prototype,"rootFeature",void 0),l([d()],ve.prototype,"viewModel",void 0),ve=l([E("esri.widgets.Editor.UpdateWorkflowData")],ve);const Kn=ve;var ti;const Qi="candidate-highlight",Va="esri.widgets.Editor.UpdateWorkflow",Qn=de.getLogger(Va);let B=ti=class extends At{constructor(i){super(i),this._workflowStack=new ns(e=>{let t;for(t of e);return t}),this.type="update"}get activeEditableItem(){const{activeWorkflow:i}=this;return Yi(i)?i.data.editableItem:void 0}get activeWorkflow(){return this._workflowStack.last()}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return!!this.activeEditableItem?.supports.includes("update")}get hasPendingEdits(){return Array.from(this._workflowStack).some(i=>i.hasPendingEdits)}get helpMessage(){return this.stepId==="awaiting-feature-to-update"?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditableItem?.hasInvalidFormTemplate}get hasUnsupportedFields(){return!!this.activeEditableItem?.hasUnsupportedFields}get updating(){return this.updatingHandles.updating}async back(i=()=>Promise.resolve(!0)){const{featureFormViewModel:e}=this.data.viewModel;if(e.relationshipId==null)if(this.activeWorkflow){if(this.activeWorkflow.hasPendingEdits&&!await i())return;this.activeWorkflow.hasPreviousStep?await this.activeWorkflow.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.relationshipId=null}async cancelActiveWorkflow(i){await this.activeWorkflow?.cancel(i),await this._popWorkflow()}async commit(){await this._drainWorkflowStack(i=>i.commit()),await super.commit()}static create(i,e,t){const a=new ti({data:new Kn({applyEditsCallback:t,viewModel:i}),onCommit:async()=>{}});return a._set("steps",this._createWorkflowSteps(a,e)),a}async save(){this.nestedWorkflowCount>1?(await this.activeWorkflow?.commit(),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(i){try{const e=await this._createNestedCreateFeaturesWorkflow(i);await this._pushWorkflow(e)}catch(e){throw new R("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:e})}}async startUpdating(i){try{const e=await this._createNestedUpdateWorkflow(i);await this._pushWorkflow(e)}catch(e){throw new R("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:e})}}async deleteActiveFeature(){const{activeWorkflow:i}=this;if(!i)throw new R("editor:nothing-to-delete","There is no feature to delete");Yi(i)?await i.deleteAndCommit():await i.cancel(),this.nestedWorkflowCount===1?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack(i=>i.cancel({force:!0}))}async _createNestedCreateFeaturesWorkflow(i){const{relatedLayer:e}=i,{addAttachmentsCallback:t,applyEditsCallback:a,viewModel:s}=this.data;if(!ai(e))throw new R("editor:unsupported-layer","Editing is not supported on the provided layer");const n=new dt({sourceLayer:e,attributes:this._makeRelatedRecordAttributes(i)});return Ea.create({addAttachmentsCallback:t,applyEditsCallback:a,creationInfo:{layer:e,initialFeature:n,maxFeatures:1},startAt:"creating-features",viewModel:s})}async _createNestedUpdateWorkflow(i){const e=He(i.sourceLayer)?z:bt,{applyEditsCallback:t,viewModel:a}=this.data,s=await e.create({feature:i,viewModel:a,applyEdits:t});return await H(()=>!s.updating),s}async _drainWorkflowStack(i){const e=this._workflowStack,t=[];for(;e.length>0;){const a=e.pop(),s=i(a).then(()=>a.destroy());this.updatingHandles.addPromise(s),t.push(s)}await Promise.all(t)}_highlight(i){this._removeHighlight();const e=this.data.viewModel.view;if(!e||!i)return;const t=i&&e.allLayerViews.items.find(({layer:a})=>a===i.layer||i.layer?.type==="subtype-sublayer"&&i.layer?.parent===a);oa(t)&&this.handles.add(t.highlight(i),Qi)}_makeRelatedRecordAttributes(i){const{parentFeature:e,relatedLayer:t,relationshipId:a}=i;if(!Fs(e))return;const s=t.relationships?.find(u=>u.id===a);if(!s)return void Ke("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if(s.role==="origin")return void Ke("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const n=e.sourceLayer;s.relatedTableId!==n.layerId&&Ke("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const r=n.relationships?.find(u=>u.id===a);if(!r)return void Ke("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const o=e.getAttribute(r.keyField);return o||Ke("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[s.keyField]:o}}async _popWorkflow(){this._workflowStack.pop()?.destroy();const i=await this._reconcileWorkflowStack();if(i.failureCount>0)throw new R("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",i)}async _pushWorkflow(i){const e=this._workflowRequiresSketchViewModel(i);this.activeWorkflow?.exit({removeSketchHandles:e}),await i.start(),this._workflowStack.push(i);const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new R("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",t)}async _reconcileWorkflowStack(){const i=this._workflowStack;try{const e=i.peek();return await e?.enter(),{activeWorkflow:e,failureCount:0}}catch{i.pop().destroy();const{activeWorkflow:t,failureCount:a}=await this._reconcileWorkflowStack();return{activeWorkflow:t,failureCount:a+1}}}_removeHighlight(){this.handles.remove(Qi)}_workflowRequiresSketchViewModel(i){const{type:e}=i;return e==="update-features"||e==="create-features"&&!He(i.data.creationInfo?.layer)}static _createWorkflowSteps(i,e="awaiting-feature-to-update"){const{data:t,handles:a}=i;return mi(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:s}=t.viewModel,n=t.viewModel.view;let r=null;a.add(W(()=>{r=kt(r)}),this.id),t.rootFeature=null,t.candidates=[];const o=n.on("immediate-click",async u=>{s.location=u.mapPoint,s.visible=!0,r?.abort();const{editableItems:p}=t.viewModel;r=new AbortController;const c=await new Promise((h,m)=>{rs(r?.signal,()=>m(os())),h(Tn(p,n,u,r?.signal))});qe(r),t.candidates=c.reduce((h,m)=>m.error?h:[...h,...m.value],[]),s.visible=t.candidates.length===1,t.candidates.length!==0&&(t.candidates.length===1?(t.rootFeature=t.candidates[0],i.go("editing-existing-feature").catch(()=>{}).then(()=>s.visible=!1)):i.next())});n.focus(),a.add(o,this.id)},async tearDown(){a.remove(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){t.rootFeature=null,a.add([T(()=>t.rootFeature,s=>i._highlight(s),bi),W(()=>i._removeHighlight())],this.id)},async tearDown(){a.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:s,viewModel:n}=i.data;if(!s)throw new R("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await i.startUpdating(s),n.spinnerViewModel.visible=!1;const r=ta(async()=>{await H(()=>!i.updating),i.previous()}),{featureFormViewModel:o}=t.viewModel,u=o.relatedRecordCallbacks;o.relatedRecordCallbacks={addRelatedRecord:async p=>{await i.startCreatingRelatedRecord(p),o.relationshipId=null},editRelatedRecord:async({relatedFeature:p})=>{await i.startUpdating(p),o.relationshipId=null},showAllRelatedRecords:p=>o.relationshipId=p.relationshipId},a.add([W(()=>o.relatedRecordCallbacks=u),T(()=>i.nestedWorkflowCount,(p,c)=>{p===0&&c!==0&&r()},bi)],this.id)},async tearDown(){await i.cancelAll(),a.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){t.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){t.viewModel.attachmentsViewModel.mode="view"}})})}};l([d()],B.prototype,"activeEditableItem",null),l([d()],B.prototype,"activeWorkflow",null),l([d()],B.prototype,"nestedWorkflowCount",null),l([d()],B.prototype,"shouldShowAttachments",null),l([d()],B.prototype,"shouldAllowAttachmentEditing",null),l([d()],B.prototype,"hasPendingEdits",null),l([d()],B.prototype,"helpMessage",null),l([d()],B.prototype,"reliesOnOwnerAdminPrivileges",null),l([d()],B.prototype,"hasInvalidFormTemplate",null),l([d()],B.prototype,"hasUnsupportedFields",null),l([d()],B.prototype,"updating",null),B=ti=l([E(Va)],B);const Ke=(i,e)=>Qn.warn(`editor:${i}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),Yi=i=>!!i&&/update-/.test(i.type),Yn=B,Aa="esri.widgets.Editor.EditorViewModel",it=de.getLogger(Aa),Ta=["create","create-features","update"];function ne(i,e,t){it.error(new R(i,e,t))}function Zn(i,e){return i?i.find(t=>t.layer===e):void 0}let V=class extends Fe(Mt.EventedAccessor){constructor(e){super(e),this._editableItems=new rt,this._sketchGraphicsLayer=new Ss({listMode:"hide",internal:!0}),this._updateEditableItemsTask=null,this.activeWorkflow=null,this._activityQueue=[],this.failures=[],this.attachmentsViewModel=new hs({capabilities:{editing:!0}}),this.featureFormViewModel=new wa,this.featureTemplatesViewModel=new Jt,this.sketchViewModel=new Rs({layer:this._sketchGraphicsLayer}),this.spinnerViewModel=new ms,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.useDeprecatedCreateWorkflow=!1,this.back=async()=>{this.canGoBack&&(this.activeWorkflow?.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>{const{featureFormViewModel:t}=this;if(t.submit(),!t.submittable)return;const a=t.getValues();t.validateContingencyConstraints(a,{includeIncompleteViolations:!0}).length>0||await this.activeWorkflow?.save()},this.selectFeature=(t,a=!1)=>{const s=this.activeWorkflow;this._candidateCommitted||s?.type!=="update"||(s.data.rootFeature=t,a&&(s.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([T(()=>{const e=this.view?.map?.editableLayers.filter(({parent:s,visible:n})=>s&&"visible"in s?n&&s.visible:n),t=this.view?.allLayerViews,a=t?.filter(s=>!!e?.includes(s.layer)&&!s.suspended);return[e,a,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditableItems(),Z),De(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),De(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),De(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)}),Ne(()=>this.view?.map,e=>e.add(this._sketchGraphicsLayer),Z),T(()=>this._editableItems.toArray(),()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:t}=e;e.type!=="create"?e.type==="update"&&(t==="awaiting-feature-to-update"&&!this.canUpdate||t==="awaiting-update-feature-candidate"&&!e.data.candidates.some(a=>{const s=this._editableItems.find(n=>n.layer===a.layer);return s&&s.supports.includes("update")}))&&this._cancelWorkflow():t!=="awaiting-feature-creation-info"||this.canCreate||this._cancelWorkflow()}),T(()=>this.page,(e,t)=>{const a=this.pageStack.slice(),s=a.indexOf(e);s===-1&&t?a.push(t):a.splice(s),this.pageStack=a}),Ne(()=>this.state==="awaiting-update-feature-candidate",()=>this._candidateCommitted=!1),De(()=>this.featureTemplatesViewModel,"select",async({item:e,oldItem:t})=>{const{activeWorkflow:a}=this,s=!!e&&e.id===t?.id,n=a?.type==="create-features"&&a.data.upload?.error;if(a)try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return this.featureTemplatesViewModel.select(t,{emit:!1})}if(!e||s&&!n)return;const r={layer:e.layer,template:e.template};if(e.supportsUpload)return this.startCreateFeaturesWorkflow(r);this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(r):this.startCreateFeaturesWorkflowAtFeatureCreation(r)}),De(()=>this.view,"key-down",e=>{e.key==="Escape"&&this.activeWorkflow?.keyboardCancellationEnabled&&this.back()})])}destroy(){this._cancelWorkflow().then(()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null}),this._updateEditableItemsTask=kt(this._updateEditableItemsTask)}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){e&&e.length!==0||(e=[...Ta]),this._set("allowedWorkflows",e)}get canCreate(){return this._editableItems.some(e=>e.supports.includes("create"))}get canUpdate(){return this._editableItems.some(({attachmentsOnUpdateEnabled:e,layer:t,supports:a})=>{const s=a.includes("update")||a.includes("delete")||e,n=t.parent,r=!(n&&"visible"in n)||!!n.visible;return t.visible&&r&&s})}get editableItems(){return this._editableItems}get labelOptions(){return this.sketchViewModel.labelOptions}set labelOptions(e){this.sketchViewModel.labelOptions=e}set layerInfos(e){e?.some(t=>("allowAttachments"in t&&It(it,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"}),!0)),this._set("layerInfos",e)}get snappingOptions(){return this.sketchViewModel.snappingOptions}set snappingOptions(e){this.sketchViewModel.snappingOptions=e}get state(){if(!this.get("view.ready")||this._editableItems.length===0)return"disabled";const e=this.attachmentsViewModel.mode;if(e==="add")return"adding-attachment";if(e==="edit")return"editing-attachment";const{activeWorkflow:t}=this;return t?t.stepId:"ready"}get syncing(){return this._activityQueue.length>0}get updating(){return this.updatingHandles.updating}get tooltipOptions(){return this.sketchViewModel.tooltipOptions}set tooltipOptions(e){this.sketchViewModel.tooltipOptions=e}set view(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get page(){const{activeWorkflow:e,state:t}=this;return t==="awaiting-feature-to-update"||t==="awaiting-feature-to-create"||e?.type==="create-features"&&e.numPendingFeatures===0?"ready":t??"disabled"}get selectedTemplateItem(){const{activeWorkflow:e}=this;if(e?.type==="create-features"&&e.numPendingFeatures===0){const t=e.data.creationInfo?.template;if(!t)return;for(const a of this.featureTemplatesViewModel.items)if("findByTemplate"in a){const s=a.findByTemplate(t);if(s)return s}else if(a.template===t)return a}}get featureFormDisabled(){const{activeWorkflow:e}=this;return e?.type==="update"&&e.activeEditableItem?.attributeUpdatesEnabled===!1}get canGoBack(){return this.activeWorkflow!=null&&!this.syncing}get shouldShowDeleteButton(){const{activeWorkflow:e}=this;return!!e&&e.type==="update"&&!!e.activeEditableItem?.supports.includes("delete")}get hasPendingEdits(){return this.activeWorkflow?.hasPendingEdits??!1}async startCreateWorkflowAtFeatureTypeSelection(){if(Be(it,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),await H(()=>!this.updating),!this.canCreate)return void ne("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateWorkflowAtFeatureCreation(e){if(Be(it,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),await H(()=>!this.updating),!this.canCreate)return void ne("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("awaiting-feature-to-create");t.data.creationInfo=e,await t.start(),this._set("activeWorkflow",t)}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,t="awaiting-feature-creation-info"){if(await H(()=>!this.updating),!this.canCreate)throw new R("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();const a=this._createCreateFeaturesWorkflow(e,t);await a.start(),this._set("activeWorkflow",a)}async startCreateWorkflowAtFeatureEdit(e){if(Be(it,"startCreateWorkflowAtFeatureEdit"),await H(()=>!this.updating),!this.canCreate)return void ne("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createCreateWorkflow("editing-new-feature");t.data.edits.feature=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureSelection(){if(await H(()=>!this.updating),!this.canUpdate)return void ne("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await H(()=>!this.updating),!this.canUpdate)return void ne("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("awaiting-update-feature-candidate");t.data.candidates=e,await t.start(),this._set("activeWorkflow",t)}async startUpdateWorkflowAtFeatureEdit(e){if(await H(()=>!this.updating),!this.canUpdate)return void ne("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const t=this._createUpdateWorkflow("editing-existing-feature");t.data.rootFeature=e,await t.start(),this._set("activeWorkflow",t)}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&e.type==="update"?await e.deleteActiveFeature():ne("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warn:!0,...e})}findEditableItemForLayer(e){const t=e.type==="subtype-sublayer"?e.parent:e;return this._editableItems.find(a=>a.layer===t)}itemHasInvalidFormTemplate(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasInvalidFormTemplate??!1)}itemHasUnsupportedFields(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasUnsupportedFields??!1)}refreshCreationTemplates(){const e=[];for(const{layer:t,supports:a}of this._editableItems)t.loaded&&a.includes("create")&&e.push(t);this.featureTemplatesViewModel.layers=e}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&this.state==="awaiting-feature-to-update"?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}async _updateEditableItems(){kt(this._updateEditableItemsTask);const e=aa(async t=>{const a=this.view?.allLayerViews,s=this.view?.map,n=s?.editableLayers.toArray()??[],r=s?.allTables.toArray().filter(us)??[];await Promise.all(r.map(m=>m.load()));const o=r.filter(m=>ai(m)),u=[...n.reverse(),...o.reverse()].filter(m=>m.geometryType!=="mesh"||this.view?.type==="3d");if(!a||!n)return;const p=[],c=[];for(const m of u){const y=a.find(w=>w.layer===m),g=y?p:c;if(m.type==="subtype-group"){await m.loadAll(),qe(t);for(let w=m.sublayers.length-1;w>=0;--w)g.push(this._makeEditableItemForLayer(m.sublayers.at(w),!!y?.suspended))}else g.push(this._makeEditableItemForLayer(m,!!y?.suspended))}if(t.aborted)return;const h=this._editableItems;this._editableItems=new rt(p.concat(c)),h.destroy()});this.updatingHandles.addPromise(e.promise),this._updateEditableItemsTask=e}async _cancelWorkflow(e){const t=this.activeWorkflow;if(!t)return void(e&&e.warn&&ne("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||e.force!==!1)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await t.cancel(e);await t.cancel(e),this._set("activeWorkflow",null)}_createCreateFeaturesWorkflow(e,t){return Ea.create({viewModel:this,creationInfo:e,startAt:t,applyEditsCallback:(a,s,n)=>this._applyEdits(a,s,n),addAttachmentsCallback:(a,s)=>this._addAttachments(a,s)})}_createCreateWorkflow(e){return qn.create(this,e,(t,a,s)=>this._applyEdits(t,a,s))}_createUpdateWorkflow(e){return Yn.create(this,e,(t,a)=>this._applyEdits(t,a))}_addAttachments(e,t){const a=t.map(s=>this._addAttachment(e,s.feature,s.attachment))??[];return Promise.all(a)}async _addAttachment(e,t,a){let s=null;if(e.type==="geojson"||e.type==="scene"||e.type==="oriented-imagery")throw new R("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation(async()=>(s=await e.addAttachment?.(t,a).catch(n=>{throw n?.error||n})??null,s)),s}async _applyEdits(e,t,a){let s=null;const n=e.url?await ls(e.url):null,r={returnServiceEditsOption:(!n||!ds(n))&&!RegExp("/hosted/","i").test(e.url)?"original-and-current-features":void 0,...a};return await this._queueOperation(async()=>{const o=await lt(this.view,e).catch(()=>null);return s=await e.applyEdits(t,r),o&&await H(()=>!o.updating),s}),s}_queueOperation(e){this._activityQueue.push(e),this.notifyChange("syncing");const t=(a,s)=>{const n=s.indexOf(a);n>-1&&s.splice(n,1)};return e().then(a=>{if("error"in a&&a.error)throw a.error;if("addFeatureResults"in a){const{addFeatureResults:s,deleteFeatureResults:n,updateFeatureResults:r}=a,o=s.find(u=>!!u.error)||r.find(u=>!!u.error)||n.find(u=>!!u.error);if(o)throw o.error}return a}).catch(a=>{ne("editing:operation-error","An error occurred.",{error:a});const s={error:a,retry:()=>(t(s,this.failures),this._queueOperation(e)),cancel:()=>{t(s,this.failures)}};this._set("failures",[...this.failures,s])}).then(()=>{t(e,this._activityQueue),this.notifyChange("syncing")})}_makeEditableItemForLayer(e,t=!0){const a=$e(e),s=a?.operations,n=Zn(this.layerInfos,e),r=ks(e),o=e.fields.some(({type:$})=>Cs.has($)),u=r||o,{allowedWorkflows:p}=this,c=p.includes("create")||p.includes("create-features"),h=p.includes("update"),m=$=>!n||n.enabled!==!1&&n[$]!==!1,y=c&&!!s?.supportsAdd&&m("addEnabled"),g=h&&!!s?.supportsUpdate&&m("updateEnabled"),w=!u&&h&&!!s?.supportsDelete&&m("deleteEnabled"),_=[];t||(y&&_.push("create"),g&&_.push("update"),w&&_.push("delete"));const v=g&&!u&&(!n||n.attributeUpdatesEnabled!==!1),b=g&&!u&&!!a?.editing?.supportsGeometryUpdate&&(!n||n.geometryUpdatesEnabled!==!1),F=!(!a?.data?.supportsAttachment||n&&n.allowAttachments===!1);return{layer:e,supports:_,attributeUpdatesEnabled:v,geometryUpdatesEnabled:b,hasAttachments:F,attachmentsOnCreateEnabled:F&&c&&(!n||n.attachmentsOnCreateEnabled!==!1),attachmentsOnUpdateEnabled:!u&&F&&(!n||n.attachmentsOnUpdateEnabled!==!1),hasInvalidFormTemplate:r,hasUnsupportedFields:o}}};l([d()],V.prototype,"_editableItems",void 0),l([d({readOnly:!0})],V.prototype,"activeWorkflow",void 0),l([d({readOnly:!0})],V.prototype,"_activityQueue",void 0),l([d({value:[...Ta]})],V.prototype,"allowedWorkflows",null),l([d({readOnly:!0})],V.prototype,"canCreate",null),l([d({readOnly:!0})],V.prototype,"canUpdate",null),l([d()],V.prototype,"editableItems",null),l([d({readOnly:!0})],V.prototype,"failures",void 0),l([d()],V.prototype,"attachmentsViewModel",void 0),l([d()],V.prototype,"featureFormViewModel",void 0),l([d()],V.prototype,"featureTemplatesViewModel",void 0),l([d()],V.prototype,"labelOptions",null),l([d()],V.prototype,"layerInfos",null),l([d()],V.prototype,"sketchViewModel",void 0),l([d()],V.prototype,"snappingOptions",null),l([d()],V.prototype,"spinnerViewModel",void 0),l([d()],V.prototype,"state",null),l([d({readOnly:!0})],V.prototype,"syncing",null),l([d()],V.prototype,"updating",null),l([d()],V.prototype,"tooltipOptions",null),l([d()],V.prototype,"view",null),l([d()],V.prototype,"pageStack",void 0),l([d()],V.prototype,"showDiscardEditsPrompt",void 0),l([d()],V.prototype,"_candidateCommitted",void 0),l([d()],V.prototype,"page",null),l([d()],V.prototype,"selectedTemplateItem",null),l([d()],V.prototype,"featureFormDisabled",null),l([d()],V.prototype,"canGoBack",null),l([d()],V.prototype,"shouldShowDeleteButton",null),l([d()],V.prototype,"hasPendingEdits",null),l([d()],V.prototype,"useDeprecatedCreateWorkflow",void 0),V=l([E(Aa)],V);const Xn=V,fi=i=>er(i)||tr(i),er=i=>{if(!("type"in i))return!1;switch(i.type){case"feature":case"geojson":case"csv":case"graphics":case"wfs":case"map-notes":case"oriented-imagery":case"scene":case"building-scene":return!0;default:return!1}},tr=i=>{const e=Vs(i);if(e!=null&&i.hasOwnProperty(e)&&i[e]!=null){for(const t of i[e])if(fi(t))return!0}return!1};var ii;let Y=ii=class extends As{constructor(i){super(i),this.children=new rt,this.parent=null}get allChildrenEnabled(){return this.children.every(i=>i.enabled)??!1}get childLayerIds(){return this.children.map(i=>i.layer.id).toArray()}get enabled(){return this.featureSource!=null&&this.featureSource.enabled}get featureSource(){const{layer:i,getFeatureSnappingSources:e}=this;return e().find(t=>t.layer===i)}get hasChildrenEnabled(){return this.children.some(i=>i.enabled)}_initializeChildLayers(i){if(!i)return;const e=i.filter(fi);super._initializeChildLayers(e)}_makeChildren(i){return i.map(e=>ua(e)?new ii({layer:e,parent:this,view:this.view,getFeatureSnappingSources:this.getFeatureSnappingSources}):null).filter(be).reverse()}};l([d()],Y.prototype,"allChildrenEnabled",null),l([d()],Y.prototype,"children",void 0),l([d()],Y.prototype,"childLayerIds",null),l([d()],Y.prototype,"enabled",null),l([d()],Y.prototype,"featureSource",null),l([d({constructOnly:!0})],Y.prototype,"getFeatureSnappingSources",void 0),l([d()],Y.prototype,"hasChildrenEnabled",null),l([d()],Y.prototype,"parent",void 0),Y=ii=l([E("esri.widgets.support.SnappingControls.SnappingListItem")],Y);let Ve=class extends Ts{constructor(){super(...arguments),this.featureSnappingSources=new rt}get operationalItemsFlat(){return this.operationalItems.flatten(i=>i.children)}get selectableItems(){return this.operationalItemsFlat.filter(i=>!i.children?.length)}_compileList(){const i=this.get("view.map.layers");if(!i)return;const e=i.filter(fi);this._watchLayersListMode(e);const t=this._getViewableLayers(e);t&&t.length?(this._createNewItems(t),this._removeItems(t),this._sortItems(t)):this._removeAllItems()}_createListItem(i){return new Y({layer:i,view:this.view,getFeatureSnappingSources:()=>this.featureSnappingSources})}};l([d()],Ve.prototype,"featureSnappingSources",void 0),l([d()],Ve.prototype,"operationalItems",void 0),l([d()],Ve.prototype,"operationalItemsFlat",null),l([d()],Ve.prototype,"selectableItems",null),Ve=l([E("esri.widgets.support.SnappingControls.SnappingLayerListViewModel")],Ve);const ir="esri.widgets.support.SnappingControls.SnappingControlsViewModel";let ae=class extends Fe(G){constructor(e){super(e),this.layerListViewModel=new Ve,this.snappingOptions=null,this.view=null}initialize(){this.handles.add([T(()=>({viewModel:this.layerListViewModel,view:this.view}),({viewModel:e,view:t})=>{e.view=t},Z),T(()=>({viewModel:this.layerListViewModel,sources:this.snappingOptions?.featureSources}),({viewModel:e,sources:t})=>{e.featureSnappingSources=t},Z)])}get allLayersEnabled(){return(this.layerListViewModel?.selectableItems??[]).every(e=>e.enabled)}get allLayersDisabled(){return(this.layerListViewModel?.selectableItems??[]).every(e=>!e.enabled)}get layersEnabledCount(){return this.layerListViewModel?.selectableItems?.filter(e=>e.enabled).length??0}get state(){return this.get("snappingOptions")?"ready":"disabled"}toggleSnappingForLayers(e,t){e?.forEach(a=>t?this.enableSnappingForLayer(a):this.disableSnappingForLayer(a))}toggleSnappingForAllLayers(e){this.layerListViewModel.selectableItems.forEach(({layer:{id:t}})=>{e?this.enableSnappingForLayer(t):this.disableSnappingForLayer(t)})}enableSnappingForLayer(e){(this._findSnappingSourceForLayer(e)??this._makeSnappingSourceForLayer(e)).enabled=!0}disableSnappingForLayer(e){const t=this._findSnappingSourceForLayer(e);t&&(t.enabled=!1)}updateEnabledFeatureSources(e){for(const t of this.snappingOptions.featureSources)ua(t.layer)&&(t.enabled=e.includes(t.layer.id))}_findSnappingSourceForLayer(e){return this.snappingOptions.featureSources.find(t=>t.layer.id===e)}_makeSnappingSourceForLayer(e){const t=this.layerListViewModel.operationalItemsFlat.find(s=>s.layer.id===e)?.layer;if(!t)throw new R("snapping-controls:layer-not-found",`cannot enable snapping for layer with id ${e} because no such layer was found in the view`);const a=new pa({layer:t});return this.snappingOptions.featureSources.add(a),a}};l([d()],ae.prototype,"allLayersEnabled",null),l([d()],ae.prototype,"allLayersDisabled",null),l([d({constructOnly:!0})],ae.prototype,"layerListViewModel",void 0),l([d()],ae.prototype,"layersEnabledCount",null),l([d()],ae.prototype,"snappingOptions",void 0),l([d()],ae.prototype,"state",null),l([d()],ae.prototype,"view",void 0),ae=l([E(ir)],ae);const ar=ae,Zi={header:!0,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0,layerListToggleLayersButton:!0},q="esri-snapping-controls",N={base:q,container:`${q}__container`,panel:`${q}__panel`,item:`${q}__item`,toggleBlock:`${q}__toggle-block`,layerListBlock:`${q}__layer-list-block`,layerList:`${q}__layer-list`,layerListFilter:`${q}__layer-list__filter`,layerListButton:`${q}__layer-list__button`,layerListItem:`${q}__layer-list__item`,layerListGroup:`${q}__layer-list__group`,nestedContainer:`${q}__nested-container`,disabled:"esri-disabled",esriWidget:"esri-widget",widgetIcon:"esri-icon-vertex-gps"},Qe={checked:"check-square-f",unchecked:"square",indeterminate:"minus-square"};let U=class extends ut{constructor(i,e){super((()=>{const{view:t,viewModel:a,snappingOptions:s,...n}=i;return n})(),e),this._defaultViewModel=null,this._layerListFilter=null,this.iconClass=N.widgetIcon,this.icon=null,this.layerListOpen=!0,this.messages=null,this.visibleElements={...Zi},this._onToggleLayersButtonClick=t=>{this.viewModel.toggleSnappingForAllLayers(!this.viewModel.allLayersEnabled),requestAnimationFrame(()=>t.target.setFocus())},i?.viewModel?this.viewModel=i.viewModel:(this._defaultViewModel=new ar({snappingOptions:i.snappingOptions,view:i.view}),this.viewModel=this._defaultViewModel)}destroy(){this._defaultViewModel=nt(this._defaultViewModel)}loadDependencies(){return ct({accordion:()=>I(()=>import("./calcite-accordion-e7dd9505.js"),["./calcite-accordion-e7dd9505.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url),"accordion-item":()=>I(()=>import("./calcite-accordion-item-8fe272b6.js"),["./calcite-accordion-item-8fe272b6.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./icon-3b706e0b.js"],import.meta.url),action:()=>I(()=>import("./calcite-action-fd95f258.js"),["./calcite-action-fd95f258.js","./action-9e20b9c8.js","./main-79e5ed80.js","./main-7772480e.css","./guid-4f97587b.js","./interactive-1607c36d.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./icon-3b706e0b.js","./loader-142f20e1.js"],import.meta.url),block:()=>I(()=>import("./calcite-block-28b862d1.js"),["./calcite-block-28b862d1.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./guid-4f97587b.js","./interactive-1607c36d.js","./t9n-460cb030.js","./key-89f6acdc.js","./focusTrapComponent-2107ee6f.js","./action-9e20b9c8.js","./loadable-7d140904.js","./icon-3b706e0b.js","./loader-142f20e1.js","./action-menu-adc47a20.js","./popover-a38f0fbf.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./FloatingArrow-52fee7c7.js","./scrim-13194b98.js"],import.meta.url),button:()=>I(()=>import("./calcite-button-d9045173.js"),["./calcite-button-d9045173.js","./button-a95c5efa.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./icon-3b706e0b.js","./loader-142f20e1.js","./guid-4f97587b.js"],import.meta.url),icon:()=>I(()=>import("./calcite-icon-b3dbf1c9.js"),["./calcite-icon-b3dbf1c9.js","./icon-3b706e0b.js","./main-79e5ed80.js","./main-7772480e.css","./observers-7949b362.js"],import.meta.url),input:()=>I(()=>import("./calcite-input-be8e458c.js"),["./calcite-input-be8e458c.js","./input-4cfd753f.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./observers-7949b362.js","./icon-3b706e0b.js","./progress-7a558d52.js"],import.meta.url),label:()=>I(()=>import("./calcite-label-b9d58e9b.js"),["./calcite-label-b9d58e9b.js","./main-79e5ed80.js","./main-7772480e.css","./label2-890d1a34.js"],import.meta.url),list:()=>I(()=>import("./calcite-list-d02b2044.js"),["./calcite-list-d02b2044.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./observers-7949b362.js","./utils3-e8f0e96c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js","./input-4cfd753f.js","./form-9c9dba1f.js","./label2-890d1a34.js","./progress-7a558d52.js","./loader-142f20e1.js","./guid-4f97587b.js","./scrim-13194b98.js"],import.meta.url),"list-item":()=>I(()=>import("./calcite-list-item-9a9b9029.js"),["./calcite-list-item-9a9b9029.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./utils3-e8f0e96c.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./loadable-7d140904.js","./action-9e20b9c8.js","./guid-4f97587b.js","./icon-3b706e0b.js","./loader-142f20e1.js"],import.meta.url),panel:()=>I(()=>import("./calcite-panel-a15a2ba3.js"),["./calcite-panel-a15a2ba3.js","./panel-83edb344.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./loadable-7d140904.js","./observers-7949b362.js","./action-menu-adc47a20.js","./guid-4f97587b.js","./key-89f6acdc.js","./action-9e20b9c8.js","./t9n-460cb030.js","./icon-3b706e0b.js","./loader-142f20e1.js","./popover-a38f0fbf.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./focusTrapComponent-2107ee6f.js","./FloatingArrow-52fee7c7.js","./scrim-13194b98.js"],import.meta.url),switch:()=>I(()=>import("./calcite-switch-6953ae95.js"),["./calcite-switch-6953ae95.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js"],import.meta.url)})}get label(){return this.messages?.widgetLabel??""}set label(i){this._overrideIfSome("label",i)}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(i){this.viewModel.snappingOptions=i}get view(){return this.viewModel.view}set view(i){this.viewModel.view=i}set viewModel(i){i!==this._get("viewModel")&&(this._defaultViewModel!=null&&this._defaultViewModel===i||(this._defaultViewModel=nt(this._defaultViewModel)),this._set("viewModel",i))}castVisibleElements(i){return{...Zi,...i}}render(){const{label:i,visibleElements:{header:e}}=this;return f("div",{"aria-label":i,class:this.classes(N.base,N.esriWidget)},f("div",{class:N.container},e?this._renderHeaderView():this._renderContent()))}_renderHeaderView(){return f("calcite-panel",{heading:this.label,class:N.panel},this._renderContent())}_renderContent(){return[this._renderToggles(),this._renderLayerList()]}_renderToggles(){const{visibleElements:{enabledToggle:i,selfEnabledToggle:e,featureEnabledToggle:t}}=this;return i||e||t?f("calcite-block",{class:N.toggleBlock,key:"toggle-block",heading:"",open:!0},this._renderEnabledToggle(),f("div",{class:N.nestedContainer},this._renderSelfEnabledToggle(),this._renderFeatureEnabledToggle())):null}_renderEnabledToggle(){if(!this.visibleElements.enabledToggle)return null;const{messages:{enableSnapping:i},viewModel:{snappingOptions:{enabled:e,enabledToggled:t}}}=this;return f("calcite-label",{layout:"inline-space-between"},i,f("calcite-switch",{checked:e,disabled:t,bind:this,onCalciteSwitchChange:this._enableSnappingSwitchChange}))}_renderSelfEnabledToggle(){if(!this.visibleElements.selfEnabledToggle)return null;const{messages:{geometryGuides:i},viewModel:{snappingOptions:{enabled:e,selfEnabled:t,enabledToggled:a}}}=this;return f("calcite-label",{layout:"inline-space-between",key:"self-enabled-toggle"},i,f("calcite-switch",{checked:t,disabled:a||!e,bind:this,onCalciteSwitchChange:this._selfEnabledSwitchChange}))}_renderFeatureEnabledToggle(){if(!this.visibleElements.featureEnabledToggle)return null;const{messages:{featureToFeature:i},viewModel:{snappingOptions:{enabled:e,featureEnabled:t,enabledToggled:a}}}=this;return f("calcite-label",{layout:"inline-space-between",key:"feature-enabled-toggle"},i,f("calcite-switch",{checked:t,disabled:a||!e,bind:this,onCalciteSwitchChange:this._featureEnabledSwitchChange}))}_renderLayerList(){if(!this.visibleElements.layerList)return null;const{messages:i,viewModel:e}=this,{snappingOptions:{enabled:t,enabledToggled:a}}=e,s=({target:{value:u}})=>this._layerListFilter=u===""?null:new RegExp(u,"i"),n=e.layerListViewModel.operationalItems.length>9?f("calcite-input",{class:N.layerListFilter,clearable:!0,placeholder:i?.searchLayers,onCalciteInputInput:s}):null,r=a||!t,o=this.layerListOpen&&!r;return f("calcite-block",{key:"list-block",heading:i.snappingLayers,disabled:r,class:N.layerListBlock,collapsible:!0,open:o,onCalciteBlockToggle:u=>this.layerListOpen=u.target.open},n,this._renderToggleLayersButton(),f("calcite-list",{class:N.layerList},this._renderLayerListItemCollection(e.layerListViewModel.operationalItems,this._layerListFilter)))}_renderLayerListItemCollection(i,e){return i.map(t=>{if(!e||this._itemTitleMatchesFilter(t,e))return t.children.length>0?this._renderLayerListItemGroup(t):this._renderLayerListItem(t);const a=t.children.filter(s=>this._itemTitleMatchesFilter(s,e));return a.length>0?this._renderLayerListItemGroup(t,a):null}).toArray().filter(be)}_renderToggleLayersButton(){if(!this.visibleElements.layerListToggleLayersButton)return null;const{viewModel:{allLayersEnabled:i},messages:e}=this,t=i?e.disableAllLayers:e.enableAllLayers;return f("calcite-button",{appearance:"transparent",class:N.layerListButton,label:t,name:"layer-toggle",scale:"m",onclick:this._onToggleLayersButtonClick},t)}_renderLayerListItem(i){const{messages:{untitledLayer:e}}=this,t=i.title||e,a=i.enabled,s=()=>{this._handleLayerListItemChange({checked:!a,value:i.layer.id})};return f("calcite-list-item",{class:N.layerListItem,label:t,key:`${this.id}-list-item-${i.uid}`,onCalciteListItemSelect:s},f("calcite-icon",{icon:a?Qe.checked:Qe.unchecked,slot:"content-start",scale:"s"}))}_renderLayerListItemGroup(i,e){const{allChildrenEnabled:t,children:a,hasChildrenEnabled:s,title:n}=i,r=this.messages,o=n||r.untitledLayer,u=n&&n!==""?n:cs(),p=!!e,c=e??a,h=t?Qe.checked:s?Qe.indeterminate:Qe.unchecked,m=t?r.disableAllLayers:r.enableAllLayers,y=()=>{this.viewModel.toggleSnappingForLayers(i.childLayerIds,!t)};return f("calcite-list-item",{class:N.layerListItem,key:u},f("calcite-accordion",{class:N.layerListGroup,appearance:"transparent"},f("calcite-accordion-item",{expanded:p,heading:o,key:i.uid},f("calcite-action",{scale:"m",slot:"actions-start",text:m,textEnabled:!1,onclick:y},f("calcite-icon",{icon:h,scale:"s"})),f("calcite-list",null,[...this._renderLayerListItemCollection(c)]))))}_enableSnappingSwitchChange(i){this.snappingOptions.enabled=i.target.checked}_featureEnabledSwitchChange(i){this.snappingOptions.featureEnabled=i.target.checked}_itemTitleMatchesFilter(i,e){return e!=null&&e.test(i.title)}_selfEnabledSwitchChange(i){this.snappingOptions.selfEnabled=i.target.checked}async _handleLayerListItemChange(i){i.checked?this.viewModel.enableSnappingForLayer(i.value):this.viewModel.disableSnappingForLayer(i.value)}};l([d()],U.prototype,"_defaultViewModel",void 0),l([d()],U.prototype,"_layerListFilter",void 0),l([d()],U.prototype,"iconClass",void 0),l([d()],U.prototype,"icon",void 0),l([d()],U.prototype,"label",null),l([d()],U.prototype,"layerListOpen",void 0),l([d(),se("esri/widgets/support/SnappingControls/t9n/SnappingControls")],U.prototype,"messages",void 0),l([d()],U.prototype,"snappingOptions",null),l([d()],U.prototype,"view",null),l([d()],U.prototype,"viewModel",null),l([d()],U.prototype,"visibleElements",void 0),l([si("visibleElements")],U.prototype,"castVisibleElements",null),U=l([E("esri.widgets.support.SnappingControls")],U);const sr=U,Xi={base:"esri-sketch-tooltip-controls",esriWidget:"esri-widget",widgetIcon:"esri-icon-gear"};let re=class extends ut{constructor(i){super(i),this.viewModel=null,this.iconClass=Xi.widgetIcon,this.icon=null,this._onEnabledChange=e=>{const t=e.target;this.tooltipOptions.enabled=t.checked}}loadDependencies(){return ct({block:()=>I(()=>import("./calcite-block-28b862d1.js"),["./calcite-block-28b862d1.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./guid-4f97587b.js","./interactive-1607c36d.js","./t9n-460cb030.js","./key-89f6acdc.js","./focusTrapComponent-2107ee6f.js","./action-9e20b9c8.js","./loadable-7d140904.js","./icon-3b706e0b.js","./loader-142f20e1.js","./action-menu-adc47a20.js","./popover-a38f0fbf.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./FloatingArrow-52fee7c7.js","./scrim-13194b98.js"],import.meta.url),label:()=>I(()=>import("./calcite-label-b9d58e9b.js"),["./calcite-label-b9d58e9b.js","./main-79e5ed80.js","./main-7772480e.css","./label2-890d1a34.js"],import.meta.url),switch:()=>I(()=>import("./calcite-switch-6953ae95.js"),["./calcite-switch-6953ae95.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-890d1a34.js","./loadable-7d140904.js"],import.meta.url)})}render(){return f("div",{class:Xi.base},f("calcite-block",{heading:"",open:!0},f("calcite-label",{layout:"inline-space-between"},this.messages?.enabledToggle,f("calcite-switch",{checked:this.tooltipOptions.enabled,onCalciteSwitchChange:this._onEnabledChange}))))}get label(){return this.messages?.widgetLabel??""}set label(i){this._overrideIfSome("label",i)}};l([d()],re.prototype,"viewModel",void 0),l([d()],re.prototype,"iconClass",void 0),l([d()],re.prototype,"icon",void 0),l([d()],re.prototype,"label",null),l([d(),se("esri/widgets/support/SketchTooltipControls/t9n/SketchTooltipControls")],re.prototype,"messages",void 0),l([d()],re.prototype,"tooltipOptions",void 0),re=l([E("esri.widgets.Editor.components.SketchTooltipControls")],re);const J="esri-editor",Oe=`${J}__panel`,Re=`${J}__prompt`,C={base:`${J} esri-widget esri-widget--panel`,actions:`${J}__actions`,helpMessage:`${J}__help-message`,panelToolbar:`${Oe}-toolbar`,panelContent:`${Oe}-content`,panelContentMessage:`${Oe}-content__message`,panelContentSection:`${Oe}-content__section`,panelContentSectionGroup:`${Oe}-content__section__group`,panelContentScrimContainer:`${Oe}-content__scrim-container`,settingsContainer:`${J}__settings`,featureTemplatesContainer:`${J}__feature-templates-container`,notice:`${J}__notice`,templateItemContentEnd:`${J}__template-item-content-end`,templateItemContentEndSuccess:`${J}__template-item-content-end--success`,templateItemContentEndError:`${J}__template-item-content-end--error`,templateItemLoader:`${J}__template-item-loader`,promptContainer:Re,promptHeader:`${Re}__header`,promptHeading:`${Re}__header__heading`,promptMessage:`${Re}__message`,promptDivider:`${Re}__divider`,promptActions:`${Re}__actions`,widgetIcon:"esri-icon-edit"},Nt={undoRedoButtons:!1,snappingControls:!0,snappingControlsElements:{header:!1,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0},sketchTooltipControls:!0};function nr(i){requestAnimationFrame(()=>i.setFocus())}const ft="exclamation-mark-triangle",$a="esri.widgets.Editor",jt=de.getLogger($a);let A=class extends Fe(ut){constructor(i,e){super(i,e),this._featureForm=new an,this._attachments=new fs({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new _n({enableListScroll:!1,renderItemContentEnd:t=>this._renderTemplateContentEnd(t),renderItemDescription:t=>this._renderTemplateDescription(t),renderItemLabel:t=>this._renderTemplateLabel(t),renderCustomGroupContent:t=>this._renderCustomTemplateGroupContent(t)}),this._filterText="",this._prompt=null,this._spinner=new ys,this.headingLevel=4,this.iconClass=C.widgetIcon,this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.supportingWidgetDefaults=null,this.viewModel=new Xn,this.visibleElements={...Nt},this._renderSelectIcon=()=>f("calcite-icon",{icon:"cursor",slot:"content-start"}),this.EditorPanel=({handleBack:t,heading:a,headingLevel:s,key:n},...r)=>{const{messagesCommon:o,viewModel:u,visibleElements:p}=this,c=u.sketchViewModel,h=u.syncing||this._attachments.submitting;return f("calcite-flow-item",{closable:!1,heading:a,headingLevel:s,key:n,loading:h,onCalciteFlowItemBack:t??void 0},f("div",{key:"panel-toolbar",class:C.panelToolbar},this._renderSettings(),p.undoRedoButtons&&[f("calcite-button",{key:"undo-button",label:o.undo,appearance:"transparent",kind:"neutral",alignment:"center",iconStart:"undo",scale:"l",disabled:!c.canUndo(),onclick:c.undo.bind(c)},o.undo),f("calcite-button",{key:"redo-button",label:o.redo,appearance:"transparent",kind:"neutral",alignment:"center",iconStart:"redo",scale:"l",disabled:!c.canRedo(),onclick:c.redo.bind(c)},o.redo)]),...r)},this._showDiscardEditsPrompt=()=>{const{messages:t,activeWorkflow:a}=this;if(a?.type==="create-features"&&Et(a.data.creationInfo))return this._showPrompt({title:t.cancelUploadTitle,message:t.cancelUploadWarningMessage,yesLabel:t.discardUpload,noLabel:t.continueUpload});const s=a?.type==="create";return this._showPrompt({title:t[s?"cancelAddTitle":"cancelEditTitle"],message:t[s?"cancelAddWarningMessage":"cancelEditWarningMessage"],yesLabel:t[s?"discardFeature":"discardEdits"],noLabel:t[s?"continueAdding":"continueEditing"]})},this._showGenericCancelPrompt=()=>{const{messages:t,messagesCommon:a}=this;return this._showPrompt({title:t.cancelRequestTitle,message:t.cancelRequestWarningMessage,yesLabel:a.form.yes,noLabel:a.form.no})},this._onToggleUpdateWorkflow=()=>this.viewModel.toggleUpdateWorkflow(),this._onAttachmentDeleteConfirm=async()=>{const t=this._attachments,{activeWorkflow:a}=this.viewModel;a&&(a.type==="create-features"?t.deleteFile():(await t.deleteAttachment(t.viewModel.activeAttachmentInfo),this._clearPrompt()),await a.back(),this._clearPrompt())},this._onAttachmentsError=t=>{this._prompt={title:this.messages.errorWarningTitle,message:t.message,context:"warning",actions:{primary:{label:this.messagesCommon.form.ok,action:this._clearPrompt}}}},this._clearPrompt=()=>{this._prompt=null},this._onBack=this._onBack.bind(this),this._onSave=this._onSave.bind(this),this._onDelete=this._onDelete.bind(this),this._onToggleUpdateWorkflow=this._onToggleUpdateWorkflow.bind(this),this._onAttachmentAdd=this._onAttachmentAdd.bind(this),this._onAttachmentUpdate=this._onAttachmentUpdate.bind(this),this._onAttachmentDelete=this._onAttachmentDelete.bind(this)}initialize(){this.addHandles([T(()=>Ze(this.headingLevel),i=>{this._featureForm.headingLevel=i,this._featureTemplates.headingLevel=i},Z),T(()=>this.viewModel.selectedTemplateItem,i=>this._featureTemplates.select(i,{emit:!1})),De(()=>this.viewModel.activeWorkflow,"cancel-request",({controller:i})=>{(this.viewModel.hasPendingEdits?this._showDiscardEditsPrompt():this._showGenericCancelPrompt()).then(e=>e?i.allow():i.deny())}),T(()=>this.viewModel,i=>{this._featureForm.viewModel=i?.featureFormViewModel??null,this._attachments.viewModel=i?.attachmentsViewModel??null,this._featureTemplates.viewModel=i?.featureTemplatesViewModel??null,this._spinner.viewModel=i?.spinnerViewModel??null,i.showDiscardEditsPrompt=this._showDiscardEditsPrompt},Z),T(()=>this.view,(i,e)=>{const t=`editor-${this.id}-spinner`;e?.ui.remove(this._spinner,t),i?.ui.add(this._spinner,{key:t,position:"manual"})},Z),Ne(()=>this.supportingWidgetDefaults,i=>{this._featureForm.set(i.featureForm),this._attachments.set(i.attachments),this._featureTemplates.set(i.featureTemplates),this.viewModel.sketchViewModel.set(i.sketch)},Z),Ne(()=>this._attachments?.error,i=>this._onAttachmentsError(i)),Ne(()=>this.viewModel?.failures,i=>{const{messages:e}=this,[{error:t,retry:a,cancel:s}]=i;this._prompt={title:e.errorWarningTitle,message:Ye(e.errorWarningMessageTemplate,{errorMessage:t.message}),context:"warning",actions:{primary:{label:e.retry,action:()=>{a(),this._clearPrompt()}},secondary:{label:e.ignore,action:()=>{s(),this._clearPrompt()}}}}}),T(()=>this.viewModel?.state,i=>{switch(i){case"awaiting-feature-to-update":case"ready":case"disabled":this._filterText="",this._featureTemplates.filterText=""}}),T(()=>this.viewModel.featureFormDisabled,i=>this._featureForm.disabled=i)])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()}loadDependencies(){return ct({accordion:()=>I(()=>import("./calcite-accordion-e7dd9505.js"),["./calcite-accordion-e7dd9505.js","./main-79e5ed80.js","./main-7772480e.css"],import.meta.url),"accordion-item":()=>I(()=>import("./calcite-accordion-item-8fe272b6.js"),["./calcite-accordion-item-8fe272b6.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./icon-3b706e0b.js"],import.meta.url),button:()=>I(()=>import("./calcite-button-d9045173.js"),["./calcite-button-d9045173.js","./button-a95c5efa.js","./main-79e5ed80.js","./main-7772480e.css","./form-9c9dba1f.js","./interactive-1607c36d.js","./label2-890d1a34.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./icon-3b706e0b.js","./loader-142f20e1.js","./guid-4f97587b.js"],import.meta.url),"flow-item":()=>I(()=>import("./calcite-flow-item-81369163.js"),["./calcite-flow-item-81369163.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./panel-83edb344.js","./action-menu-adc47a20.js","./guid-4f97587b.js","./action-9e20b9c8.js","./icon-3b706e0b.js","./loader-142f20e1.js","./popover-a38f0fbf.js","./openCloseComponent-2d424455.js","./debounce-c198f28b.js","./focusTrapComponent-2107ee6f.js","./FloatingArrow-52fee7c7.js","./scrim-13194b98.js","./tooltip-256c087d.js"],import.meta.url),flow:()=>I(()=>import("./calcite-flow-7cef4e79.js"),["./calcite-flow-7cef4e79.js","./main-79e5ed80.js","./main-7772480e.css","./observers-7949b362.js"],import.meta.url),icon:()=>I(()=>import("./calcite-icon-b3dbf1c9.js"),["./calcite-icon-b3dbf1c9.js","./icon-3b706e0b.js","./main-79e5ed80.js","./main-7772480e.css","./observers-7949b362.js"],import.meta.url),list:()=>I(()=>import("./calcite-list-d02b2044.js"),["./calcite-list-d02b2044.js","./main-79e5ed80.js","./main-7772480e.css","./interactive-1607c36d.js","./observers-7949b362.js","./utils3-e8f0e96c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js","./input-4cfd753f.js","./form-9c9dba1f.js","./label2-890d1a34.js","./progress-7a558d52.js","./loader-142f20e1.js","./guid-4f97587b.js","./scrim-13194b98.js"],import.meta.url),loader:()=>I(()=>import("./calcite-loader-6cec631f.js"),["./calcite-loader-6cec631f.js","./loader-142f20e1.js","./main-79e5ed80.js","./main-7772480e.css","./guid-4f97587b.js"],import.meta.url),notice:()=>I(()=>import("./calcite-notice-842cb611.js"),["./calcite-notice-842cb611.js","./main-79e5ed80.js","./main-7772480e.css","./conditionalSlot-7211d13e.js","./observers-7949b362.js","./loadable-7d140904.js","./t9n-460cb030.js","./key-89f6acdc.js","./icon-3b706e0b.js"],import.meta.url),scrim:()=>I(()=>import("./calcite-scrim-5c6fad96.js"),["./calcite-scrim-5c6fad96.js","./scrim-13194b98.js","./main-79e5ed80.js","./main-7772480e.css","./t9n-460cb030.js","./key-89f6acdc.js","./observers-7949b362.js","./loader-142f20e1.js","./guid-4f97587b.js"],import.meta.url)})}get _deleteButtonCommonInfo(){return{appearance:"outline",kind:"danger",type:"primary"}}get activeWorkflow(){return this.viewModel.activeWorkflow}get allowedWorkflows(){return this.viewModel.allowedWorkflows}set allowedWorkflows(i){this.viewModel.allowedWorkflows=i}get useDeprecatedCreateWorkflow(){return this.viewModel.useDeprecatedCreateWorkflow}set useDeprecatedCreateWorkflow(i){this.viewModel.useDeprecatedCreateWorkflow=i}get label(){return this.messages?.widgetLabel??""}set label(i){this._overrideIfSome("label",i)}get labelOptions(){return this.viewModel.labelOptions}set labelOptions(i){this.viewModel.labelOptions=i}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(i){this.viewModel.layerInfos=i}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(i){this.viewModel.snappingOptions=i}get tooltipOptions(){return this.viewModel.tooltipOptions}set tooltipOptions(i){this.viewModel.tooltipOptions=i}get view(){return this.viewModel.view}set view(i){this.viewModel.view=i}castVisibleElements(i){return{...Nt,...i,snappingControlsElements:{...Nt.snappingControlsElements,...i?.snappingControlsElements}}}startCreateWorkflowAtFeatureTypeSelection(){return Be(jt,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),this.viewModel.startCreateWorkflowAtFeatureTypeSelection()}startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()}startCreateWorkflowAtFeatureCreation(i){return Be(jt,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),this.viewModel.startCreateWorkflowAtFeatureCreation(i)}startCreateFeaturesWorkflowAtFeatureCreation(i){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(i)}startCreateWorkflowAtFeatureEdit(i){return Be(jt,"startCreateWorkflowAtFeatureEdit"),this.viewModel.startCreateWorkflowAtFeatureEdit(i)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(i){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(i)}startUpdateWorkflowAtFeatureEdit(i){return this.viewModel.startUpdateWorkflowAtFeatureEdit(i)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(i){return this.viewModel.cancelWorkflow(i)}render(){const{viewModel:i}=this;if(!i)return f("div",{key:"empty",class:C.base});const{state:e}=i;return f("div",{key:"base",class:C.base},f("calcite-flow",{key:"flow"},i.pageStack.map(t=>this._renderPage(t,e)),this._renderPage(i.page,e)),this._renderPrompt())}_renderPage(i,e){switch(i){case"disabled":break;case"ready":return this._renderLanding(e);case"awaiting-feature-creation-info":return this._renderTemplates(e);case"creating-features":case"editing-new-feature":case"editing-existing-feature":return this._renderAttributeEditing(e);case"awaiting-update-feature-candidate":return this._renderFeatureList(e);case"adding-attachment":return this._renderAttachmentAdding(e);case"editing-attachment":return this._renderAttachmentEditing(e)}return f("div",null)}_renderTemplates(i){const{EditorPanel:e,headingLevel:t,messages:a,_onBack:s}=this;return f(e,{active:this._isPanelActive(i),key:"templates-panel",handleBack:s,heading:a.selectTemplate,headingLevel:t},f("div",{key:"feature-templates",class:C.panelContent},this._featureTemplates.render()))}_renderAttributeEditing(i){const{activeWorkflow:e,EditorPanel:t,messages:a,messagesCommon:s,headingLevel:n,_onBack:r,viewModel:o}=this;if(!e)return null;const u=e.type,p="activeWorkflow"in e&&e.activeWorkflow,c=p?p.type:null,h=o.featureFormViewModel,m=p&&!p.hasPendingEdits||u==="update"&&!e.hasPendingEdits||o.syncing||h.updating,y=u==="update"?a.editFeature:a.createFeatures,g=u==="update"&&c!=="create-features"?s.update:s.create,w=u==="create-features"&&e.createFeatureState==="create-new",_=u==="create-features"?e.numPendingFeatures:0,v=_>1?Ye(a.createFeaturesTemplate,{numFeatures:_}):g,b=e.shouldShowAttachments&&!o.featureFormViewModel.activeRelationshipInput,F=h.inputs.every($=>!$.visible)&&!b?this._renderMessage(Ye(a.clickToFinishTemplate,{button:g})):f("div",{key:"panel-content-section",class:C.panelContentSection},this._renderNotices(e),f("div",{class:C.panelContentSectionGroup},this._featureForm.render(),b&&f("div",{key:"attachments"},f(Te,{level:Ze(n)},a.attachments),this._attachments.render())));return f(t,{active:this._isPanelActive(i),key:"attribute-editing-panel",heading:y,headingLevel:n,handleBack:r},f("div",{key:"panel-content",class:this.classes(C.panelContent,{[C.panelContentScrimContainer]:w})},F,w&&f("calcite-scrim",null)),this._renderFooterActions([{clickHandler:this._onSave,disabled:m,label:v,type:"primary"},o.shouldShowDeleteButton?{...this._deleteButtonCommonInfo,clickHandler:this._onDelete,disabled:o.syncing,label:s.delete}:null]))}_renderNotices(i){return[this._renderOwnerAdminNotice(i),this._renderInvalidFormTemplateNotice(i),this._renderInvalidDateFieldNotice(i)]}_renderOwnerAdminNotice(i){return i?.reliesOnOwnerAdminPrivileges&&this._renderNotice(this.messages.ownerAdminNotice)}_renderInvalidFormTemplateNotice(i){return i?.hasInvalidFormTemplate&&this._renderNotice(this.messages.formFieldUpdateError,{icon:ft})}_renderInvalidDateFieldNotice(i){return i?.hasUnsupportedFields&&this._renderNotice(this.messages.formFieldUnsupportedUpdateError,{icon:ft})}_renderNotice(i,e){return f("calcite-notice",{open:!0,scale:"s",class:C.notice,...e},f("div",{slot:"message"},i))}_renderCustomTemplateGroupContent(i){const{messages:e,viewModel:t}=this;let a=null;return i.group.items.some(s=>(t.itemHasUnsupportedFields(s)?a=e.formFieldUnsupportedCreateError:t.itemHasInvalidFormTemplate(s)&&(a=e.formFieldCreateError),a)),a?this._renderNotice(a,{icon:ft}):null}_renderAttachmentAdding(i){const{_attachments:e,EditorPanel:t,_onBack:a,headingLevel:s,messages:n,messagesCommon:r}=this;return f(t,{active:this._isPanelActive(i),key:"attachment-adding-panel",heading:n.addAttachment,headingLevel:s,handleBack:a},f("div",{key:"attachments",class:C.panelContent},e.render()),this._renderFooterActions([{label:e.submitting?r.cancel:r.add,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._onAttachmentAdd}]))}_renderAttachmentEditing(i){const{_attachments:e,EditorPanel:t,_onBack:a,activeWorkflow:s,headingLevel:n,messages:r,messagesCommon:o}=this;return s?f(t,{active:this._isPanelActive(i),key:"attachment-editing-panel",heading:r.editAttachment,headingLevel:n,handleBack:a},f("div",{key:"attachments",class:C.panelContent},e.render()),s.shouldAllowAttachmentEditing?this._renderFooterActions([{label:o.update,disabled:e.submitting||!e.selectedFile,type:"primary",clickHandler:this._onAttachmentUpdate},{...this._deleteButtonCommonInfo,clickHandler:this._onAttachmentDelete,disabled:e.submitting,label:o.delete}]):void 0):null}_renderMessage(i){return f("div",{key:"panel-content-message",class:C.panelContentMessage},i)}_renderFooterActions(i){return f("div",{key:"footer-actions",slot:"footer",class:C.actions},i.filter(be).map(({type:e,disabled:t,class:a,clickHandler:s,label:n,...r},o)=>f("calcite-button",{key:`action-${o}`,slot:"footer-actions",class:a,disabled:t??!1,onclick:s,width:"full",...r},n)))}_renderPrompt(){const i=this._prompt;if(!i)return null;const{title:e,message:t,context:a,actions:s}=i,n=s.secondary;let r;switch(a){case"danger":r="danger";break;case"info":r="brand";break;default:r="neutral"}const o=f("calcite-button",{afterCreate:nr,appearance:"solid",key:"prompt-primary-button",kind:r,onclick:s.primary.action,scale:"m",width:n?"half":"full"},s.primary.label),u=n&&f("calcite-button",{appearance:"outline",key:"prompt-secondary-button",kind:r,onclick:n.action,scale:"m",width:"half"},n.label);return f("calcite-scrim",{key:"prompt"},f("div",{class:`${C.promptContainer}--${a}`},f("div",{class:C.promptHeader},f("calcite-icon",{icon:ft}),f(Te,{class:C.promptHeading,level:this.headingLevel},e)),f("div",{class:C.promptMessage},t),f("div",{class:C.promptDivider}),f("div",{class:C.promptActions},u,o)))}_renderLanding(i){const{EditorPanel:e,headingLevel:t,messages:a,viewModel:s}=this,{canUpdate:n}=s,r=this._featureTemplates.viewModel.numberOfFeatureTemplates,o=!n&&r===0;return f(e,{active:this._isPanelActive(i),key:"landing-panel",heading:a.widgetLabel,headingLevel:t},f("div",{key:"landing-content",class:C.panelContent},n&&f("div",{key:"edit-actions",class:C.panelContentSection},this._renderUpdateActions(i)),r>0&&f("div",{key:"create-actions",class:C.panelContentSection},this._renderCreateActions()),o&&f("div",{key:"no-content",class:C.panelContentMessage},a.noEditableLayers)),this._renderFooterHelpMessages())}_renderFooterHelpMessages(){const{activeWorkflow:i,messages:e,view:t}=this,a=i?.helpMessage,s=a?e[t?.type==="3d"?"helpMessages3d":"helpMessages2d"]?.[a]:null;return s?f("div",{key:"footer-actions",slot:"footer",class:C.helpMessage},s):null}_renderUpdateActions(i){const{messages:e,messagesCommon:t}=this,a={id:"select",label:t.select};return f("div",{key:"update-actions"},f(Te,{level:Ze(this.headingLevel)},e.editFeatures),f("calcite-list",{selectionMode:"single",selectionAppearance:"border"},ci({grouped:!1,item:a,selectedItem:i==="awaiting-feature-to-update"?a:void 0,renderIcon:this._renderSelectIcon,onItemSelect:this._onToggleUpdateWorkflow})))}_renderCreateActions(){const{_featureTemplates:i,headingLevel:e,messages:t}=this;return f("div",{key:"create-actions"},f(Te,{level:Ze(e)},t.createFeatures),f("div",{key:"templates",class:C.featureTemplatesContainer},i.render()))}_renderTemplateLabel(i){return i.label}_renderTemplateDescription(i){const e=this._getUploadForTemplateItem(i);if(!e)return null;const{messages:t}=this;switch(e.state){case"pending":return t?.uploadPending;case"error":return t?.uploadError;default:return null}}_renderTemplateContentEnd(i){const e=this._getUploadForTemplateItem(i),t=f("calcite-icon",{key:"upload-icon",class:C.templateItemContentEnd,icon:"upload-to"});if(!e)return i.supportsUpload?t:null;switch(e.state){case"success":return f("calcite-icon",{key:"success-icon",class:this.classes(C.templateItemContentEnd,C.templateItemContentEndSuccess),icon:"check"});case"error":return f("calcite-icon",{key:"error-icon",class:this.classes(C.templateItemContentEnd,C.templateItemContentEndError),icon:"exclamation-mark-circle-f"});case"pending":return f("calcite-loader",{class:C.templateItemLoader,inline:!0,key:"loader",label:"",scale:"s",type:"indeterminate"});case"canceled":case"default":return t}}_getUploadForTemplateItem(i){const e=this.activeWorkflow;if(e?.type!=="create-features")return null;const{data:t}=e,{creationInfo:a,upload:s}=t;return a?.template===i.template&&a?.layer===i.layer?s:null}_renderFeatureList(i){const{EditorPanel:e,_onBack:t,headingLevel:a,messages:s,messagesTemplates:n,viewModel:{activeWorkflow:r,editableItems:o}}=this;if(r?.type!=="update")return null;const u=r.data.candidates,p=Ye(s.multipleFeaturesTemplate,{total:u.length}),c=new Map;let h=0;u.map(g=>({label:this._getLabel(g),id:g.attributes[g.layer.objectIdField],data:g})).filter(g=>{const{label:w,data:_}=g,v=this._filterText.toLowerCase(),{title:b}=_.layer,F=o.find(ke=>ke.layer===_.layer);if(!F)return null;const{attachmentsOnUpdateEnabled:$,supports:ce}=F;return(ce.includes("update")||ce.includes("delete")||$)&&(!v||w?.toLowerCase().includes(v)||b?.toLowerCase().includes(v))}).filter(be).forEach(g=>{h++;const w=g.data.layer;c.has(w)?c.get(w)?.items.push(g):c.set(w,{id:`${w.id}`,label:w.title??"",items:[g]})});const m=o.toArray().map(({layer:g})=>c.get(g)).filter(be),y=h>10||this._filterText.length>0;return f(e,{active:this._isPanelActive(i),key:"feature-list",heading:p,headingLevel:a,handleBack:t},f("div",{key:"feature-list",class:C.panelContent},f("div",{class:C.panelContentSection},va({enableListScroll:!1,filterEnabled:y,filterText:this._filterText,id:this.id,items:m,messages:{filterPlaceholder:n.filterPlaceholder,noItems:n.noItems,noMatches:n.noMatches},onFilterChange:g=>this._filterText=g,onItemMouseEnter:g=>this.viewModel.selectFeature(g.data),onItemMouseLeave:()=>this.viewModel.selectFeature(null),onItemSelect:g=>this.viewModel.selectFeature(g.data,!0)}))))}_isPanelActive(i){return this.viewModel.state===i}_renderSettings(){const i=this.visibleElements,e=i.snappingControls,t=i.sketchTooltipControls;return e||t?f("calcite-accordion",{key:"settings",class:C.settingsContainer,appearance:"transparent"},f("calcite-accordion-item",{heading:this.messagesCommon?.settings,iconStart:"gear"},t&&f(re,{tooltipOptions:this.tooltipOptions}),e&&f(sr,{snappingOptions:this.snappingOptions,view:this.view,visibleElements:i.snappingControlsElements,afterCreate:a=>a.layerListOpen=!1}))):null}_getLabel(i){const e=i.layer;if(!e)return null;const t=e.fieldsIndex.get(e.objectIdField),a=t.alias||t.name,{attributes:s}=i,n=ra(e);return n&&s[n]&&`${s[n]}`||`${a}: ${s[t.name]}`}_showPrompt({title:i,message:e,yesLabel:t,noLabel:a}){const s=ia(),{view:n}=this,r=n?.focused;return this._prompt={title:i,message:e,context:"danger",actions:{primary:{label:t,action:()=>s.resolve(!0)},secondary:{label:a,action:()=>s.resolve(!1)}}},s.promise.finally(()=>{this._clearPrompt(),r&&n?.focus()})}_onSave(){this.viewModel.saveWorkflow()}_onDelete(){const{messages:i,messagesCommon:e}=this;this._prompt={title:i.deleteWarningTitle,message:i.deleteWarningMessage,context:"danger",actions:{primary:{label:e.delete,action:()=>{this.deleteFeatureFromWorkflow(),this._clearPrompt()}},secondary:{label:i.keepFeature,action:this._clearPrompt}}}}async _onBack(i){return i?.stopPropagation(),this.viewModel.back()}_onAttachmentAdd(){const{activeWorkflow:i}=this.viewModel;i&&(i.type==="create-features"?(this._attachments.addFile(),i.back()):this._attachments.addAttachment().then(()=>i.back()))}_onAttachmentUpdate(){const{activeWorkflow:i}=this.viewModel;i&&(i.type==="create-features"?(this._attachments.updateFile(),i.back()):this._attachments.updateAttachment().then(()=>i.back()))}_onAttachmentDelete(){const{messages:i,messagesCommon:e}=this;this._prompt={title:i.deleteAttachmentWarningTitle,message:i.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:e.delete,action:this._onAttachmentDeleteConfirm},secondary:{label:i.keepAttachment,action:this._clearPrompt}}}}};l([d()],A.prototype,"_featureForm",void 0),l([d()],A.prototype,"_attachments",void 0),l([d()],A.prototype,"_featureTemplates",void 0),l([d()],A.prototype,"_filterText",void 0),l([d()],A.prototype,"_prompt",void 0),l([d()],A.prototype,"_spinner",void 0),l([d()],A.prototype,"_deleteButtonCommonInfo",null),l([d({readOnly:!0})],A.prototype,"activeWorkflow",null),l([d()],A.prototype,"allowedWorkflows",null),l([d()],A.prototype,"useDeprecatedCreateWorkflow",null),l([d()],A.prototype,"headingLevel",void 0),l([d()],A.prototype,"iconClass",void 0),l([d()],A.prototype,"label",null),l([d()],A.prototype,"labelOptions",null),l([d()],A.prototype,"layerInfos",null),l([d(),se("esri/widgets/Editor/t9n/Editor")],A.prototype,"messages",void 0),l([d(),se("esri/t9n/common")],A.prototype,"messagesCommon",void 0),l([d(),se("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],A.prototype,"messagesTemplates",void 0),l([d()],A.prototype,"snappingOptions",null),l([d()],A.prototype,"tooltipOptions",null),l([d()],A.prototype,"supportingWidgetDefaults",void 0),l([d()],A.prototype,"view",null),l([d(),li(["workflow-cancel","workflow-commit"])],A.prototype,"viewModel",void 0),l([d()],A.prototype,"visibleElements",void 0),l([si("visibleElements")],A.prototype,"castVisibleElements",null),l([Se()],A.prototype,"_onSave",null),l([Se()],A.prototype,"_onDelete",null),l([Se()],A.prototype,"_onBack",null),l([Se()],A.prototype,"_onAttachmentAdd",null),l([Se()],A.prototype,"_onAttachmentUpdate",null),l([Se()],A.prototype,"_onAttachmentDelete",null),A=l([E($a)],A);const rr=A,or=new rr({view:la});la.ui.add(or,"top-right");

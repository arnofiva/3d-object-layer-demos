import{op as Je,m9 as d,ma as Re,n1 as Qe,fa as ut,f9 as li,aD as f,aE as _,aF as ge,au as tt,dT as ri,cd as q,ca as Ve,tJ as ai,tK as ni,tL as oi,ov as ci,n3 as it,tM as di,cT as he,cU as yi,lK as Et,tN as ui,qe as Rt,ci as Ye,az as st,a_ as Vt,ib as hi,ch as Tt,ce as lt,dY as ke,cr as z,aU as pe,l$ as pi,tO as mi,fB as Y,eh as fi,dw as gi,lz as bi,c3 as ht,cD as Te,dZ as we,gS as vi,tP as _i,cY as Li,tQ as wi,m2 as Si,pR as $i,m7 as Ne,pP as Ci,du as Ii,n0 as Ei,f8 as J,ok as Be,tR as Ri,ol as rt,gN as Vi}from"./main-79e5ed80.js";import{m as Ti}from"./ExportImageParameters-7717516b.js";import{s as pt}from"./pixelRangeUtils-04f58c28.js";import{t as zi}from"./rendererConversion-22515807.js";import{A as xi,S as Ai,N as Fi,M as ki,E as Mi,V as Hi,C as mt,a as Ni,b as X,c as Bi,l as Di,g as Pi,t as Oi,f as qi,L as Ui}from"./symbolUtils-2e5baa60.js";import{u as De,a as zt,i as ft,n as Wi,l as qe,b as ji,o as Gi,c as Ji,d as Qi,r as Yi,p as gt,e as Ki,f as bt,s as Xi,g as vt}from"./utils-3be18bec.js";import{n as Me,s as Zi}from"./vmEvent-27fa49b3.js";import"./floorFilterUtils-73949d2d.js";import"./sublayerUtils-7f6367bc.js";import"./colorUtils-c0f43caf.js";const xt="esri-relationship-ramp",ie=`${xt}--diamond`,j=`${xt}--square`,es="http://www.w3.org/2000/svg",T={diamondContainer:`${ie}__container`,diamondLeftCol:`${ie}__left-column`,diamondRightCol:`${ie}__right-column`,diamondMidCol:`${ie}__middle-column`,diamondMidColLabel:`${ie}__middle-column--label`,diamondMidColRamp:`${ie}__middle-column--ramp`,squareTable:`${j}__table`,squareTableRow:`${j}__table-row`,squareTableCell:`${j}__table-cell`,squareTableLabel:`${j}__table-label`,squareTableLabelLeftBottom:`${j}__table-label--left-bottom`,squareTableLabelRightBottom:`${j}__table-label--right-bottom`,squareTableLabelLeftTop:`${j}__table-label--left-top`,squareTableLabelRightTop:`${j}__table-label--right-top`};function At(e,t,i={}){const{focus:l,labels:s}=e,r=!!l,a=ts(e,t,i),n={justifyContent:"center"},o=Je();return r?d("div",{class:T.diamondContainer,styles:n},d("div",{class:T.diamondLeftCol},o?s.right:s.left),d("div",{class:T.diamondMidCol},d("div",{class:T.diamondMidColLabel},s.top),a,d("div",{class:T.diamondMidColLabel},s.bottom)),d("div",{class:T.diamondRightCol},o?s.left:s.right)):d("div",{class:T.squareTable},d("div",{class:T.squareTableRow},d("div",{class:Re(T.squareTableCell,T.squareTableLabel,T.squareTableLabelRightBottom)},o?s.top:s.left),d("div",{class:T.squareTableCell}),d("div",{class:Re(T.squareTableCell,T.squareTableLabel,T.squareTableLabelLeftBottom)},o?s.left:s.top)),d("div",{class:T.squareTableRow},d("div",{class:T.squareTableCell}),a,d("div",{class:T.squareTableCell})),d("div",{class:T.squareTableRow},d("div",{class:Re(T.squareTableCell,T.squareTableLabel,T.squareTableLabelRightTop)},o?s.right:s.bottom),d("div",{class:T.squareTableCell}),d("div",{class:Re(T.squareTableCell,T.squareTableLabel,T.squareTableLabelLeftTop)},o?s.bottom:s.right)))}function _t(e,t,i){const l=`${i}_arrowStart`,s=`${i}_arrowEnd`,r=e==="left",a={markerStart:null,markerEnd:null};switch(t){case"HL":r?a.markerStart=`url(#${s})`:a.markerEnd=`url(#${l})`;break;case"LL":a.markerStart=`url(#${s})`;break;case"LH":r?a.markerEnd=`url(#${l})`:a.markerStart=`url(#${s})`;break;default:a.markerEnd=`url(#${l})`}return a}function ts(e,t,i={}){const{focus:l,numClasses:s,colors:r,rotation:a}=e,{opacity:n,effectList:o,ariaLabel:y}=i,c=i.size??60,p=!!l,m=Math.sqrt(c**2+c**2)+(p?0:5),g=[],w=[],u=[],h=(c||75)/s;for(let B=0;B<s;B++){const Ce=B*h;for(let Q=0;Q<s;Q++){const Ie=Q*h,ee=xi(r[B][Q]),te=Ai(null),be={type:"rect",x:Ie,y:Ce,width:h,height:h},ve=Fi(ee);ve&&g.push(ve);const _e=ki(be,ee.fill,te,null);_e&&w.push(_e),u.push(Mi(be))}}const L=10,b=15,C=15,E=10;let $=null;p||($="margin: -15px -15px -18px -15px");const I=_t("left",l,t),M=_t("right",l,t),H=Hi(u),N=mt(H,m,m,0,!1,a,!1),x=mt(H,m,m,0,!1,p?-45:null,!1),P={filter:Qe(o)??void 0,opacity:n==null?"":`${n}`};return d("div",{styles:P,class:p?T.diamondMidColRamp:T.squareTableCell},d("svg",{xmlns:es,width:m,height:m,style:$,"aria-labelledBy":y,role:"image",focusable:!1},d("defs",null,d("marker",{id:`${t}_arrowStart`,markerWidth:"10",markerHeight:"10",refX:"5",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"0,0 5,5 0,10",fill:"none",stroke:"#555555","stroke-width":"1"})),d("marker",{id:`${t}_arrowEnd`,markerWidth:"10",markerHeight:"10",refX:"0",refY:"5",markerUnits:"strokeWidth",orient:"auto"},d("polyline",{points:"5,0 0,5 5,10",fill:"none",stroke:"#555555","stroke-width":"1"})),g),d("g",{transform:N},w),d("g",{transform:x},d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":I.markerStart,"marker-end":I.markerEnd,x1:-L,y1:c-b,x2:-L,y2:b}),d("line",{fill:"none",stroke:"#555555","stroke-width":"1","marker-start":M.markerStart,"marker-end":M.markerEnd,x1:C,y1:c+E,x2:c-C,y2:c+E}))))}const Lt={HH:315,HL:45,LL:135,LH:225},is={2:[["HL","HH"],["LL","LH"]],3:[["HL","HM","HH"],["ML","MM","MH"],["LL","LM","LH"]],4:[["HL","HM1","HM2","HH"],["M2L","M2M1","M2M2","M2H"],["M1L","M1M1","M1M2","M1H"],["LL","LM1","LM2","LH"]]};function ss(e){if(!e)return;const{type:t}=e;if(t.includes("3d"))return Ni(e.symbolLayers.at(0));if(t==="simple-line"){const i=ut(e);return i&&i.color}if(e.type==="simple-marker"&&(e.style==="x"||e.style==="cross")){const i=ut(e);return i&&i.color}return li(e)}function ls(e,t){const i=t.HH.label,l=t.LL.label,s=t.HL.label,r=t.LH.label;switch(e){case"HH":default:return{top:i,bottom:l,left:s,right:r};case"HL":return{top:s,bottom:r,left:l,right:i};case"LL":return{top:l,bottom:i,left:r,right:s};case"LH":return{top:r,bottom:s,left:i,right:l}}}function rs(e){const{focus:t,infos:i,numClasses:l}=e,s=is[l],r={};i.forEach(n=>{r[n.value]={label:n.label,fill:ss(n.symbol)}});const a=[];for(let n=0;n<l;n++){const o=[];for(let y=0;y<l;y++){const c=r[s[n][y]];o.push(c.fill)}a.push(o)}return{type:"relationship-ramp",numClasses:l,focus:t,colors:a,labels:ls(t,r),rotation:Ft(t)}}function Ft(e){let t=Lt[e];return e&&t==null&&(t=Lt.HH),t||0}const $e=-1;let U=class extends tt{constructor(t){super(t),this._from=null,this._to=null,this._final=null,this._current=[],this._time=0,this.duration=ri("mapview-transitions-duration"),this.effects=[]}set effect(t){if(this._get("effect")!==(t=t||"")){this._set("effect",t);try{this._transitionTo(wt(t))}catch(i){this._transitionTo([]),q.getLogger(this).warn("Invalid Effect",{effect:t,error:i})}}}get hasEffects(){return this.transitioning||!!this.effects.length}set scale(t){this._updateForScale(t)}get transitioning(){return this._to!==null}canTransitionTo(t){try{return this.scale>0&&St(this._current,wt(t),this.scale)}catch{return!1}}transitionStep(t,i){this._applyTimeTransition(t),this._updateForScale(i)}endTransitions(){this._applyTimeTransition(this.duration)}_transitionTo(t){this.scale>0&&St(this._current,t,this.scale)?(this._final=t,this._to=Ve(t),as(this._current,this._to,this.scale),this._from=Ve(this._current),this._time=0):(this._from=this._to=this._final=null,this._current=t),this._set("effects",this._current[0]?Ve(this._current[0].effects):[])}_applyTimeTransition(t){if(!(this._to&&this._from&&this._current&&this._final))return;this._time+=t;const i=Math.min(1,this._time/this.duration);for(let l=0;l<this._current.length;l++){const s=this._current[l],r=this._from[l],a=this._to[l];s.scale=ns(r.scale,a.scale,i);for(let n=0;n<s.effects.length;n++){const o=s.effects[n],y=r.effects[n],c=a.effects[n];o.interpolate(y,c,i)}}i===1&&(this._current=this._final,this._set("effects",this._current[0]?Ve(this._current[0].effects):[]),this._from=this._to=this._final=null)}_updateForScale(t){if(this._set("scale",t),this._current.length===0)return;const i=this._current,l=this._current.length-1;let s,r,a=1;if(i.length===1||t>=i[0].scale)r=s=i[0].effects;else if(t<=i[l].scale)r=s=i[l].effects;else for(let n=0;n<l;n++){const o=i[n],y=i[n+1];if(o.scale>=t&&y.scale<=t){a=(t-o.scale)/(y.scale-o.scale),s=o.effects,r=y.effects;break}}for(let n=0;n<this.effects.length;n++)this.effects[n].interpolate(s[n],r[n],a)}};function wt(e){const t=ai(e)||[];return os(t)?[{scale:$e,effects:t}]:t}function St(e,t,i){return!e[0]?.effects||!t[0]?.effects?!0:!((e[0]?.scale===$e||t[0]?.scale===$e)&&(e.length>1||t.length>1)&&i<=0)&&ni(e[0].effects,t[0].effects)}function as(e,t,i){const l=e.length>t.length?e:t,s=e.length>t.length?t:e,r=s[s.length-1],a=r?.scale??i,n=r?.effects??[];for(let o=s.length;o<l.length;o++)s.push({scale:a,effects:[...n]});for(let o=0;o<l.length;o++)s[o].scale=s[o].scale===$e?i:s[o].scale,l[o].scale=l[o].scale===$e?i:l[o].scale,oi(s[o].effects,l[o].effects)}function ns(e,t,i){return e+(t-e)*i}function os(e){const t=e[0];return!!t&&"type"in t}f([_()],U.prototype,"_to",void 0),f([_()],U.prototype,"duration",void 0),f([_({value:""})],U.prototype,"effect",null),f([_({readOnly:!0})],U.prototype,"effects",void 0),f([_({readOnly:!0})],U.prototype,"hasEffects",null),f([_({value:0})],U.prototype,"scale",null),f([_({readOnly:!0})],U.prototype,"transitioning",null),U=f([ge("esri.layers.effects.EffectView")],U);const cs=(e,t)=>{const i=e.featuresTilingScheme.getClosestInfoForScale(e.scale).level;return t?.levels?t.levels[i]:null};function ds(e,t){if(!e||!("visualVariables"in e)||!e.visualVariables)return null;const i=e.visualVariables.find(s=>s.type==="size"),l=cs(t,i);return l?new ci({field:i.field,minSize:l[2].size,minDataValue:l[2].value,maxSize:l[3].size,maxDataValue:l[3].value}):null}const Ke=30,Xe=12,kt=[255,255,255],Mt=[200,200,200],ue=[128,128,128],ys=20,us=5;function hs(e){return e.declaredClass==="esri.symbols.SimpleMarkerSymbol"}function ps(e){return e.declaredClass==="esri.symbols.PictureMarkerSymbol"}function ms(e){return e.declaredClass==="esri.symbols.SimpleLineSymbol"}function fs(e){return e.declaredClass==="esri.symbols.TextSymbol"}function gs(e,t){const i=e.length-1;return e.map((l,s)=>Wi(l,s,i,t))}async function bs(e,t,i,l,s,r,a){const n=t.legendOptions,o=n&&n.customValues,y=a||await Ls(e,i),c=t.stops,p=!!y,m=!!o,g=t.minSize!=null&&t.maxSize!=null,w=c&&c.length>1,u=!!t.target;if(!p||!m&&!(g||w&&!u))return;const h=it(y);let L=!1,b=null,C=null;b=h&&!w?De([t.minDataValue,t.maxDataValue]):o??await Ss(t,y,l,s);const E=e?.authoringInfo,$=E?.type==="univariate-color-size",I=$&&E?.univariateTheme==="above-and-below";if(!b&&w&&(b=c.map(x=>x.value),L=c.some(x=>!!x.label),e.type==="flow"&&(b=De(b)),L&&(C=c.map(x=>x.label))),h&&b!=null&&b?.length>2&&!I&&(b=[b[0],b[b.length-1]]),!b)return null;$&&b?.length!==5&&(b=Bt({minSize:b[0],maxSize:b[b.length-1]}));const M=h?vs(e,b):null,H=di(y),N=L?null:gs(b,r);return(await Promise.all(b.map(async(x,P)=>{const B=h?M[P]:await ce(t,y,x,l,s);return{value:x,symbol:Is(I&&e.type==="class-breaks"?_s(e,P):y,B),label:L?C[P]:N[P],size:B,outlineSize:H}}))).reverse()}function vs(e,t){const i=e?.authoringInfo,l=i?.type==="univariate-color-size";let s=[Xe,Ke];if(l){const r=t[0],a=t[t.length-1],n=Xe,o=Ke;s=t.map(y=>n+(y-r)/(a-r)*(o-n))}return l&&i?.univariateTheme==="below"&&s.reverse(),s}function _s(e,t){const i=e.classBreakInfos,l=i.length,s=l<2||!(t>=2)?i[0].symbol.clone():i[l-1].symbol.clone();return e.visualVariables.some(r=>r.type==="color")&&(s.type.includes("3d")?Ht(s):Nt(s)),s}async function Ls(e,t){if(e.type==="flow")return zt(e,t);if(e.type==="pie-chart")return new he({color:null,outline:e.outline?.width?e.outline:new yi});let i=null,l=null;if(e.type==="simple")i=e.symbol;else if(e.type==="class-breaks"){const s=e.classBreakInfos;i=s&&s[0]&&s[0].symbol,l=s.length>1}else if(e.type==="unique-value"){const s=e.uniqueValueInfos;i=s?.[0]?.symbol,l=s!=null&&s.length>1}return!i||ws(i)?null:(i=i.clone(),(t||l)&&(i.type.includes("3d")?Ht(i):Nt(i)),i)}function ws(e){return e?Et(e)?!!e.symbolLayers&&e.symbolLayers.some(t=>t&&t.type==="fill"):e.type.includes("fill"):!1}function Ht(e){e.type==="line-3d"?e.symbolLayers.forEach(t=>{t.material={color:ue}}):e.symbolLayers.forEach(t=>{t.type!=="icon"||t.resource&&t.resource.href?t.material={color:Mt}:(t.material={color:kt},t.outline={color:ue,size:1.5})})}function Nt(e){const t=ui();e.type==="cim"?Rt(e,new Ye(Mt)):e.type.includes("line")?e.color=ue:(e.color=t?ue:kt,e.type==="simple-marker"&&(e.outline?e.outline?.color?.toHex()==="#ffffff"&&(e.outline.color=ue):e.outline={color:ue,width:1.5}))}async function Ss(e,t,i,l){const s=(await st(()=>import("./main-79e5ed80.js").then(n=>n.y4),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url)).getSizeRangeAtScale(e,i,l),r=s&&Bt(s);if(!s||!r)return;let a=r.map(n=>$s(n,e,s));a=De(a);for(let n=1;n<a.length-1;n++){const o=await Cs(e,t,a[n],a[n-1],i,l);o&&(a[n]=o[0],r[n]=o[1])}return a}function Bt(e){const t=e.minSize,i=e.maxSize,l=us,s=(i-t)/(l-1),r=[];for(let a=0;a<l;a++)r.push(t+s*a);return r}function $s(e,t,i){const l=i.minSize,s=i.maxSize,r=t.minDataValue,a=t.maxDataValue;let n;return e<=l?n=r:e>=s?n=a:n=(e-l)/(s-l)*(a-r)+r,n}async function Cs(e,t,i,l,s,r){const a=await ce(e,t,i,s,r),n=await ce(e,t,l,s,r),o=ft(i),y=o.fractional,c=ys;let p=o.integer,m=null,g=null;i>0&&i<1&&(m=10**y,p=ft(i*=m).integer);for(let w=p-1;w>=0;w--){const u=10**w;let h=Math.floor(i/u)*u,L=Math.ceil(i/u)*u;m!=null&&(h/=m,L/=m);let b=(h+L)/2;[,b]=De([h,b,L],{indexes:[1]});const C=await ce(e,t,h,s,r),E=await ce(e,t,L,s,r),$=await ce(e,t,b,s,r),I=qe(a,C,n,null),M=qe(a,E,n,null),H=qe(a,$,n,null);let N=I.previous<=c,x=M.previous<=c;if(N&&x&&(I.previous<=M.previous?(N=!0,x=!1):(x=!0,N=!1)),N?g=[h,C]:x?g=[L,E]:H.previous<=c&&(g=[b,$]),g)break}return g}async function ce(e,t,i,l,s){const{getSize:r}=await st(()=>import("./main-79e5ed80.js").then(a=>a.y4),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url);return r(e,i,{scale:l,view:s,shape:t.type==="simple-marker"?t.style:null})}function Is(e,t){const i=e.clone();if(Et(i))it(i)||i.symbolLayers.forEach(l=>{l.type!=="fill"&&(l.size=t)});else if(hs(i))i.size=t;else if(ps(i)){const l=i.width,s=i.height;i.height=t,i.width=t*(l/s)}else ms(i)?i.width=t:fs(i)&&i.font&&(i.font.size=t);return i}function Es(e){const i=Math.floor(Math.log10(Math.abs(e)))+1,l=i<4||i>6?4:i,s=1e6,r=Math.abs(e)>=s?"compact":"standard";return Vt(e,{notation:r,minimumSignificantDigits:2,maximumSignificantDigits:l})}const Rs="https://utility.arcgis.com/sharing/tools/legend",Vs="esri.layers.ImageryLayer",Ts="esri.layers.ImageryTileLayer",zs="esri.layers.WCSLayer",ze=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i,xs=new hi({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),xe=new he({size:6,outline:{color:[128,128,128,.5],width:.5}}),As=new Tt({style:"solid"});function Ze(e){return e.type==="flow"}function Dt(e){return e.type==="vector-field"}function Pt(e){return e.type==="raster-colormap"}function Ot(e){return e.type==="raster-stretch"}function qt(e){return e.type==="raster-shaded-relief"}function de(e){return e.declaredClass==="esri.renderers.SimpleRenderer"}function ye(e){return e.declaredClass==="esri.renderers.ClassBreaksRenderer"}function He(e){return e.declaredClass==="esri.renderers.UniqueValueRenderer"}function Ut(e){return e.declaredClass==="esri.renderers.HeatmapRenderer"}function Fs(e){return at(e)||nt(e)||ot(e)||ks(e)}function ks(e){return e.declaredClass==="esri.renderers.PointCloudRGBRenderer"}function at(e){return e.declaredClass==="esri.renderers.PointCloudClassBreaksRenderer"}function nt(e){return e.declaredClass==="esri.renderers.PointCloudStretchRenderer"}function ot(e){return e.declaredClass==="esri.renderers.PointCloudUniqueValueRenderer"}function Wt(e){return e.declaredClass==="esri.renderers.DotDensityRenderer"}function jt(e){return e.declaredClass==="esri.renderers.PieChartRenderer"}function Ms(e,t){return de(e)||ye(e)||He(e)||Ut(e)||Wt(e)||jt(e)?t.type==="2d"||zi(e):Ot(e)||Pt(e)||qt(e)||at(e)||nt(e)||ot(e)||Dt(e)||Ze(e)}function Hs(e){return e.declaredClass==="esri.layers.BuildingSceneLayer"}function Ue(e){return e.declaredClass==="esri.layers.SubtypeGroupLayer"}function Ns(e){return e.declaredClass==="esri.layers.VoxelLayer"}function Bs(e){return e.declaredClass==="esri.layers.WMSLayer"}function Ds(e){return e.declaredClass==="esri.layers.WMTSLayer"}function We(e){return e.declaredClass==="esri.layers.MapImageLayer"}function $t(e){return e.declaredClass==="esri.layers.TileLayer"}function se(e){return e.declaredClass===Vs}function Ae(e){return e.declaredClass===Ts}function Ps(e){return e.declaredClass===zs}function Os(e){return e.type==="stretch-ramp"}function qs(e){return("authoringInfo"in e?e?.authoringInfo:null)?.type==="univariate-color-size"}function Us(e){const t="authoringInfo"in e?e?.authoringInfo:null;return t?.type==="univariate-color-size"&&t?.univariateTheme==="above-and-below"}function Ct(e){return"sublayers"in e}async function W(e,t){const i=await $i("esri/widgets/Legend/t9n/Legend");return e!=="previewTemplateAriaLabel"||t||(e="previewAriaLabel"),Ne(i[e],{label:t})}const Ws=new he({style:"path",path:"M10,5 L5,0 0,5 M5,0 L5,15",size:15,outline:{width:1,color:[85,85,85,1]}});let le={},A=class extends tt{constructor(e){super(e),this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._webStyleSymbolCache=new Map,this._dotDensityUrlCache=new Map,this._scaleDrivenSizeVariable=null,this._hasClusterSizeVariable=!1,this.children=new lt,this.layerView=null,this.layer=null,this.legendElements=[],this.parent=null,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.sublayerIds=[],this.title=null,this.view=null}initialize(){const e=()=>this.notifyChange("ready");this.addHandles([ke(()=>this.children,"change",t=>{const{added:i,removed:l}=t;i.forEach(s=>{const r=`activeLayerInfo-ready-watcher-${s.layer.uid}`;this.addHandles(z(()=>s.ready,e,pe),r)}),l.forEach(s=>this.removeHandles(s.layer.uid)),e()})]),this.keepCacheOnDestroy||(le={})}destroy(){this._webStyleSymbolCache=null,this._dotDensityUrlCache=null,this._scaleDrivenSizeVariable=null,this.keepCacheOnDestroy||(le=null)}get effectList(){const e=this.layer;let t=null;return"effect"in e&&e.effect&&(t=new U,t.effect=e.effect,t.endTransitions(),t.scale=this.scale),t}get opacity(){const e=this.layer.opacity,t=this.parent?.opacity,i=this.layer.parent,l=i&&"uid"in i?this._getParentLayerOpacity(i):null;return t!=null?t*e:l!=null?l*e:e}get ready(){return this.layer===null||(this.children.length>0?this._isGroupActive():this.legendElements.length>0)}get scale(){return this.view?.scale??0}get isScaleDriven(){const e=this.layer;if(e===null)return!1;if("effect"in e&&e.effect&&Array.isArray(e.effect))return!0;if("featureReduction"in e&&e.featureReduction){if(e.featureReduction.type==="cluster")return!0;if(e.featureReduction.type==="binning"&&"renderer"in e.featureReduction&&e.featureReduction.renderer)return this._isRendererScaleDriven(e.featureReduction.renderer)}return"renderer"in e&&e.renderer?this._isRendererScaleDriven(e.renderer):this._isLayerScaleDriven(this.layer)}get version(){return this._get("version")+1}async buildLegendElementsForFeatureCollections(e){if(!(!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView()))return this.legendElements=[],void this.notifyChange("ready");const t=Array.from(e,i=>{if(pi(i))return this._getRendererLegendElements(i.renderer,{title:i.title});if(i.featureSet&&i.featureSet.features.length){const l=i.layerDefinition,s=l&&l.drawingInfo,r=s&&mi(s.renderer),a=xs.read(l.geometryType);return r?this._getRendererLegendElements(r,{title:i.name,geometryType:a}):(q.getLogger(this).warn("drawingInfo not available!"),null)}return null});try{const i=[];await Y(t).then(l=>{l.forEach(({value:s})=>s&&i.push(...s))}),this.legendElements=i,this.notifyChange("ready")}catch(i){q.getLogger(this).warn("error while building legend for layer!",i)}}async buildLegendElementsForRenderer(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getRendererLegendElements(e):[],this.notifyChange("ready")}catch(t){q.getLogger(this).warn("error while building legend for layer!",t)}}async buildLegendElementsForFeatureReduction(e){try{const t=!this.hideLayersNotInCurrentView||await this._isLayerInCurrentView();this.legendElements=t?await this._getLegendElementsForFeatureReduction(e):[],this.notifyChange("ready")}catch(t){q.getLogger(this).warn("error while building legend for layer!",t)}}async buildLegendElementsForTools(){const e=this.layer;if(Ns(e))this._constructLegendElementsForVoxellayer();else if(Ds(e))this._constructLegendElementsForWMTSlayer();else if(Bs(e))await this._constructLegendElementsForWMSSublayers();else if(Hs(e))await this._constructLegendElementsForBuildingSceneLayer();else if(We(e)||$t(e)||Ue(e))await this._constructLegendElementsForSublayers();else{this.removeHandles("imageryLayers-watcher");let t="default";se(e)&&(t=(e?.rasterFunction?.functionName||"default")+"_"+(e.bandIds?.length?e.bandIds.join(""):"###")),await this._getLegendLayers(`${e.uid}-${t}`).then(async i=>{this.legendElements=[],this.notifyChange("ready");const l=i.map(async s=>{if(se(e)||Ae(e)){const a=z(()=>["renderingRule"in e&&e.rasterFunction,e.bandIds],()=>fi(async()=>{le.default=null,e.renderer?await this.buildLegendElementsForRenderer(e.renderer):await this.buildLegendElementsForTools()})());this.addHandles(a,"imageryLayers-watcher")}const r=this._generateSymbolTableElementForLegendLayer(s);r&&r.infos.length&&(se(e)&&(r.title=e.title),this.legendElements.push(r)),this.notifyChange("ready")});await Y(l)}).catch(i=>{q.getLogger(this).warn("Request to server for legend has failed!",i)})}}async _isLayerInCurrentView(){const e=this.layer,t=this.layerView,i=t&&"createQuery"in t&&"queryFeatureCount"in t;if(!i&&!(t&&"createQuery"in e&&"queryFeatureCount"in e))return!0;await gi(()=>!t.updating);const l=i?"createQuery"in t&&t.createQuery():"createQuery"in e&&e.createQuery();return l?(l.geometry=this.view.extent,(i?"queryFeatureCount"in t&&await t.queryFeatureCount(l):"queryFeatureCount"in e&&await e.queryFeatureCount(l))!==0):!0}_getParentLayerOpacity(e){let t=1;const i=e.parent;return i&&"uid"in i&&(t=this._getParentLayerOpacity(i)),e.opacity*t}_isGroupActive(){const e=this.children;return!!e.length&&e.some(t=>t.ready)}_isRendererScaleDriven(e){if(e.type==="dot-density")return!0;const t="valueExpression"in e?e.valueExpression:null;if(ze.test(t))return!0;const i="visualVariables"in e?e.visualVariables:null;return!!i&&i.some(l=>this._isScaleDrivenSizeVariable(l))}_isScaleDrivenSizeVariable(e){if(e&&e.type!=="size")return!1;const t=e,i=t.minSize,l=t.maxSize;return typeof i=="object"&&i?this._isScaleDrivenSizeVariable(i):typeof l=="object"&&l?this._isScaleDrivenSizeVariable(l):!!t.expression||ze.test(t.valueExpression)}_isLayerScaleDriven(e){if("minScale"in e&&e.minScale>0||"maxScale"in e&&e.maxScale>0)return!0;if("sublayers"in e&&e.sublayers)return e.sublayers.some(i=>this._isLayerScaleDriven(i));const t=e.parent;if(e.loaded===!1&&t&&We(t)&&"source"in e&&e.source&&e.source.type==="map-layer"){for(const i of t.sourceJSON.layers??[])if(i.id===e.source.mapLayerId&&(i.minScale>0||i.maxScale>0))return!0}return!1}async _constructLegendElementsForVoxellayer(){this.legendElements=[],this.removeHandles("voxel-style-watcher"),this.removeHandles("voxel-current-variable");const e=this.layer;this.addHandles(z(()=>e.currentVariableId,()=>this._constructLegendElementsForVoxellayer()),"voxel-current-variable"),this.addHandles(z(()=>e.getVariableStyles(),()=>this._constructLegendElementsForVoxellayer()),"voxel-style-watcher");const t=e.getVariableStyle(null),i=[];if(t){if(t.uniqueValues?.length){const r=[];t.uniqueValues.forEach(a=>{a.enabled&&r.push({label:a.label||`${a.value}`,value:a.value,symbol:new Tt({color:a.color,outline:null})})}),r.length&&i.push({type:"symbol-table",title:t.label,infos:r})}else if(t.transferFunction){const{colorStops:r,stretchRange:a}=t.transferFunction,n=r.toArray().reverse(),o=a.map((c,p)=>`${p===0?ji:Gi} ${Es(c)}`).reverse(),y=n.map(c=>({color:c.color,value:null,label:null}));y[0].label=o[0],y[y.length-1].label=o[1],i.push({type:"color-ramp",title:t.label,infos:y,preview:X(n.map(c=>c.color),{ariaLabel:await W("previewColorRampAriaLabel")})})}}const l=e.opacity,s=i.reduce((r,a)=>[...r,...this._getAllInfos(a)],[]).filter(r=>!!r?.symbol).map(r=>this._getSymbolPreview(r,l));await Y(s),this.legendElements=i,this.notifyChange("ready")}_constructLegendElementsForWMTSlayer(){this.legendElements=[],this.removeHandles("wmts-activeLayer-watcher");const e=this.layer.activeLayer;if(this.addHandles(z(()=>{const{layer:t}=this;return t&&"activeLayer"in t&&t.activeLayer},()=>this._constructLegendElementsForWMTSlayer()),"wmts-activeLayer-watcher"),e.styleId&&e.styles){let t=null;e.styles.some(i=>e.styleId===i.id&&(t=i.legendUrl,!0)),t&&(this.legendElements=[{type:"symbol-table",title:e.title,infos:[{src:t,opacity:this.opacity}]}])}this.notifyChange("ready")}async _constructLegendElementsForWMSSublayers(){this.legendElements=[],this.removeHandles("wms-sublayers-watcher");const e=this.layer;let t=null;(e.customParameters||e.customLayerParameters)&&(t={...e.customParameters,...e.customLayerParameters}),this.addHandles(z(()=>{const{layer:i}=this;return i&&"sublayers"in i&&i.sublayers},()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher"),this.legendElements=await this._generateLegendElementsForWMSSublayers(e.sublayers,t),this.notifyChange("ready")}async _generateLegendElementsForWMSSublayers(e,t){const i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForWMSSublayers()),"wms-sublayers-watcher");const l=e.toArray();for(const s of l){const r=z(()=>[s.title,s.visible,s.legendEnabled],()=>this._constructLegendElementsForWMSSublayers());if(this.addHandles(r,"wms-sublayers-watcher"),!this.respectLayerVisibility||s.visible&&s.legendEnabled){const a=await this._generateSymbolTableElementForWMSSublayer(s,t);a&&a.infos.length&&i.unshift(a)}}return i}async _generateSymbolTableElementForWMSSublayer(e,t){if(!e.legendUrl&&e.sublayers){const i=(await this._generateLegendElementsForWMSSublayers(e.sublayers,t)).filter(l=>l);return{type:"symbol-table",title:e.title,infos:i}}return this._generateSymbolTableElementForLegendUrl(e,t)}async _generateSymbolTableElementForLegendUrl(e,t){let i=e.legendUrl;if(!i)return;const l={type:"symbol-table",title:e.title||e.name||String(e.id??""),infos:[]};t&&(i=bi(i,t));let s=null;const r=e.layer?.opacity;try{s=(await ht(i,{responseType:"image"})).data,s&&(s.style.opacity=r)}catch{}return l.infos.push({src:i,preview:s,opacity:r}),l}_getLegendLayers(e,t){const i=le&&le[e];return i?Promise.resolve(i):this._legendRequest(t).then(l=>{const s=l.layers;return le[e]=s,s})}_legendRequest(e){const t=this.layer;let i={f:"json",dynamicLayers:e};if(se(t)){const s=t.exportImageServiceParameters.rasterFunction;if(s&&(i.renderingRule=JSON.stringify(s.functionDefinition?.toJSON()||s.toJSON())),t.bandIds&&(i.bandIds=t.bandIds.join()),t.raster||t.viewId||t.customParameters){const{raster:r,viewId:a,customParameters:n}=t;i={raster:r,viewId:a,...i,...n}}}let l=t.url.replace(/(\/)+$/,"");if("version"in t&&+t.version>=10.01){const s=l.indexOf("?");s>-1?l=l.substring(0,s)+"/legend"+l.substring(s):l+="/legend"}else{const s=l.toLowerCase().indexOf("/rest/"),r=l.substring(0,s)+l.substring(s+5,l.length);l=Rs+"?soapUrl="+encodeURI(r)+"&returnbytes=true"}return ht(l,{query:i}).then(s=>s.data)}async _constructLegendElementsForBuildingSceneLayer(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;this.addHandles(z(()=>e.sublayers,()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForBuildingSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){q.getLogger(this).warn("Request to server for legend has failed!",t)}}async _generateLegendElementsForBuildingSublayers(e,t){let i=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForBuildingSceneLayer()),"sublayers-watcher");const l=e.toArray();for(const s of l){const r=z(()=>["renderer"in s&&s.renderer,s.opacity,s.title,s.visible],()=>this._constructLegendElementsForBuildingSceneLayer());if(this.addHandles(r,"sublayers-watcher"),!this.respectLayerVisibility||s.visible){const a=s&&s.opacity!=null?s.opacity:null,n=a!=null?a*t:t;if(s.type==="building-group"){const o={type:"symbol-table",title:s.title,infos:[]},y=await this._generateLegendElementsForBuildingSublayers(s.sublayers,n);o.infos.push(...y),i=[o,...i]}else s.renderer&&(i=[...await this._getRendererLegendElements(s.renderer,{title:s.title,opacity:n,sublayer:s}),...i])}}return i.filter(s=>!!s&&(!("infos"in s)||!s.infos||s.infos.length>0))}async _constructLegendElementsForSublayers(){this.legendElements=[],this.removeHandles("sublayers-watcher");const e=this.layer;if(We(e)||$t(e)||Ue(e)){this.addHandles(z(()=>e.sublayers,()=>this._constructLegendElementsForSublayers),"sublayers-watcher");try{this.legendElements=await this._generateLegendElementsForSublayers(e.sublayers,this.opacity),this.notifyChange("ready")}catch(t){q.getLogger(this).warn("Request to server for legend has failed!",t)}}}async _generateLegendElementsForSublayers(e,t,i){const l=this.layer;let s=[];this.addHandles(e.on("change",()=>this._constructLegendElementsForSublayers()),"sublayers-watcher");let r=e.toArray();!i&&this.sublayerIds&&this.sublayerIds.length&&(r=Ue(l)?this.sublayerIds.map(a=>l.findSublayerForSubtypeCode(a)).filter(Te):this.sublayerIds.map(a=>l.findSublayerById(a)).filter(Te));for(const a of r){const n=z(()=>[a.renderer,a.opacity,a.title,a.visible,a.legendEnabled],()=>this._constructLegendElementsForSublayers());if(this.addHandles(n,"sublayers-watcher"),!this.respectLayerVisibility||a.visible&&a.legendEnabled&&this._isSublayerInScale(a)){const o=a&&a.opacity!=null?a.opacity:null,y=o!=null?o*t:t,c=!Ct(a)||a.originIdOf("renderer")>we.SERVICE&&!a.sublayers;if(a.renderer&&c)await a.load(),s=[...await this._getRendererLegendElements(a.renderer,{title:a.title,opacity:y,sublayer:a}),...s];else if(Ct(a)){const p=await this._generateSymbolTableElementForSublayer(a,y,i);p&&s.unshift(p)}}}return s.filter(a=>!!a&&(!("infos"in a)||!a.infos||a.infos.length>0))}async _generateSymbolTableElementForSublayer(e,t,i){if(!i){i=new Map;const s=this.layer,r=e.source;let a=null;if(!(!r||r.type==="map-layer"&&r.mapLayerId===e.id&&(!r.gdbVersion||r.gdbVersion===("gdbVersion"in s&&s.gdbVersion)))||e.originIdOf("renderer")>we.SERVICE||e.originIdOf("labelingInfo")>we.SERVICE||e.originIdOf("labelsVisible")>we.SERVICE){const o=new Ti({layer:this.layer});a=o.hasDynamicLayers?o.dynamicLayers:null,o.destroy()}const n=a||`${s.uid}-default`;(await this._getLegendLayers(n,a)).forEach(o=>i.set(o.layerId,o))}const l=i.get(e.id);if((!l||l?.subLayerIds&&l.defaultVisibility)&&e.sublayers){const s=await this._generateLegendElementsForSublayers(e.sublayers,t,i);return{type:"symbol-table",title:e.title,infos:s}}return this._generateSymbolTableElementForLegendLayer(l,e,t)}_generateSymbolTableElementForLegendLayer(e,t,i){if(!e||!e.legend||this.respectLayerVisibility&&!this._isLegendLayerInScale(e,t))return null;const l=t?.renderer;let s=t?.title||e.layerName;if(l&&(!t||t?.originIdOf("renderer")>we.SERVICE)){const n=t?.title||this._getRendererTitle(l,t);n&&(s&&typeof n!="string"&&"title"in n&&(n.title=s),s=n)}const r={type:"symbol-table",title:s,legendType:e.legendType||null,infos:[]},a=t?this._sanitizeLegendForSublayer(e.legend.slice(),t):e.legend;return e.legendGroups&&e.legendGroups.length>0?e.legendGroups.forEach(n=>{const o={type:"symbol-table",title:n.heading,legendType:e.legendType||null,infos:this._generateSymbolTableElementInfosForLegendLayer(a.filter(y=>y.groupId===n.id),e.layerId,i)};o.infos?.length>0&&r.infos.push(o)}):r.infos=this._generateSymbolTableElementInfosForLegendLayer(a,e.layerId,i),r.infos.length>0?r:null}_generateSymbolTableElementInfosForLegendLayer(e,t,i){return e.map(l=>{let s=l.url;if(l.imageData&&l.imageData.length>0)s=`data:image/png;base64,${l.imageData}`;else{if(s.indexOf("http")===0)return null;s=vi(`${this.layer.url}/${t}/images/${s}`)}return{label:l.label,src:s,opacity:i??this.opacity,width:l.width,height:l.height}}).filter(Te)}_isSublayerInScale(e){const t=e.minScale||0,i=e.maxScale||0;return!(t>0&&t<this.scale||i>this.scale)}_isLegendLayerInScale(e,t){const i=t||this.layer;let l=null,s=null,r=!0;return!i.minScale&&i.minScale!==0||!i.maxScale&&i.maxScale!==0?(e.minScale===0&&i.tileInfo&&(l=i.tileInfo.lods[0].scale),e.maxScale===0&&i.tileInfo&&(s=i.tileInfo.lods[i.tileInfo.lods.length-1].scale)):(l=Math.min(i.minScale,e.minScale)||i.minScale||e.minScale,s=Math.max(i.maxScale,e.maxScale)),(l>0&&l<this.scale||s>this.scale)&&(r=!1),r}_sanitizeLegendForSublayer(e,t){if("version"in this.layer&&+this.layer.version<10.1||e.length===0)return e;const i=t.renderer,l=e.some(a=>a.values);let s=0,r=null;return l&&e.some((a,n)=>(a.values||(s=n,r=a,r.label||(r.label="others")),r!=null)),i?i.type==="unique-value"?r&&(e.splice(s,1),e.push(r)):i.type==="class-breaks"&&(r&&e.splice(s,1),e.reverse(),r&&e.push(r)):r&&(e.splice(s,1),e.push(r)),e}async _getRendererLegendElements(e,t={}){if(!Ms(e,this.view))return q.getLogger(this).warn(`Renderer of type '${e.type}' not supported!`),[];if(Fs(e))return this._constructPointCloudRendererLegendElements(e,t);if(Wt(e))return this._constructDotDensityRendererLegendElements(e);const i=await this._loadRenderer(e);return jt(i)?this._constructPieChartRendererLegendElements(i):this._constructRendererLegendElements(i,t)}async _getLegendElementsForFeatureReduction(e){let t=null;return e.type==="binning"?t=e.renderer:e.type==="cluster"&&(t=this._getClusterRenderer(e)),t?this._getRendererLegendElements(t):[]}_getPointCloudRendererTitle(e){return(e.legendOptions?.title||e.field)??""}async _constructPointCloudRendererLegendElements(e,t={}){const i=t.title,l=[];let s=null,r=null;if(at(e))s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorClassBreakInfos.forEach(n=>{s.infos.unshift({label:n.label||n.minValue+" - "+n.maxValue,value:[n.minValue,n.maxValue],symbol:this._getAppliedCloneSymbol(xe,n.color)})});else if(nt(e)){const n=e.stops;let o=null;if(n?.length&&(n.length===1&&(o=n[0].color),!o)){const c=n[0].value,p=n[n.length-1].value;c!=null&&p!=null&&(o=Ji(c+(p-c)/2,n))}s={type:"symbol-table",title:null,infos:[{label:null,value:null,symbol:this._getAppliedCloneSymbol(xe,o||xe.color)}]};const y=Qi(e.stops??[])??[];r={type:"color-ramp",title:i||this._getPointCloudRendererTitle(e),infos:y,preview:X(y.map(c=>c.color),{ariaLabel:await W("previewColorRampAriaLabel")})}}else ot(e)&&(s={type:"symbol-table",title:i||this._getPointCloudRendererTitle(e),infos:[]},e.colorUniqueValueInfos?.forEach(n=>{s.infos.push({label:n.label||n.values.join(", "),value:n.values.join(", "),symbol:this._getAppliedCloneSymbol(xe,n.color)})}));s&&s.infos.length&&l.push(s),r&&r.infos.length&&l.push(r);const a=l.reduce((n,o)=>[...n,...o.infos??[]],[]).filter(n=>!!n.symbol).map(n=>this._getSymbolPreview(n,this.opacity,{symbolConfig:{applyColorModulation:!!e.colorModulation}}));return Y(a).then(()=>l)}async _getElementInfoForDotDensity(e,t){const{color:i,label:l,valueExpressionTitle:s}=t,{backgroundColor:r,outline:a,dotSize:n}=e,o=this.effectList,y=o?.effects.map(L=>L.toJSON()),c=_i(y),p=await W("previewTemplateAriaLabel",l||s),m=n+"-"+i+"-"+r+"-"+(a&&JSON.stringify(a.toJSON()))+"-"+c,g=this._dotDensityUrlCache,w=g.has(m)?g.get(m):Bi(e,i,{ariaLabel:p});g.set(m,w);const u={shape:{type:"image",x:0,y:0,width:w.width,height:w.height,src:w.src},fill:null,stroke:null,offset:[0,0]},h=Di([[u]],[w.width,w.height],{effectView:this.effectList,ariaLabel:p});return{opacity:1,src:w.src,preview:h,width:w.width,height:w.height}}async _constructDotDensityRendererLegendElements(e){const t=e.calculateDotValue(this.view.scale),i=e.legendOptions&&e.legendOptions.unit,l={type:"symbol-table",title:{value:t&&Math.round(t),unit:i||""},infos:[]};for(const s of e.attributes){const r=await this._getElementInfoForDotDensity(e,s);r.label=s.label||s.valueExpressionTitle||s.field,l.infos.push(r)}return[l]}async _constructPieChartRendererLegendElements(e){const t=this.layer.opacity,i=[];let l=null;const s=e.outline;e.attributes.forEach(o=>{const y=new he({color:o.color,outline:s}),c=o.label||o.valueExpressionTitle||o.field;i.push({label:c,symbol:y})});const r=i.length?[...i]:[];if(e.othersCategory?.color&&e.othersCategory?.threshold!==0){const o=new he({color:e.othersCategory.color,outline:s});l=e.othersCategory.label||"Other",i.push({label:l,symbol:o})}if(e.defaultColor?.a){const o=new he({color:e.defaultColor,outline:s});i.push({label:e.defaultLabel,symbol:o})}const a=await this._getVisualVariableLegendElements(e,this.layer)||[];if(i.length){a.unshift({type:"symbol-table",title:null,infos:i});const o=r.filter(c=>c.label!==l).map(c=>c.symbol.color).filter(Boolean),y=Pi(o,{holePercentage:e.holePercentage,backgroundColor:e.backgroundFillSymbol?.color,effectList:this.effectList,outline:s,ariaLabel:await W("previewPieChartAriaLabel")});a.unshift({type:"pie-chart-ramp",title:this._getRendererTitle(e,this.layer),infos:i,preview:y})}const n=a.reduce((o,y)=>[...o,...this._getAllInfos(y)],[]).filter(o=>!!o?.symbol&&!o?.preview).map(o=>this._getSymbolPreview(o,t,{effectList:this.effectList}));return await Y(n),a}async _constructRendererLegendElements(e,t={}){const{title:i,sublayer:l}=t,s=l||this.layer;this._hasColorRamp=!1,this._hasOpacityRamp=!1,this._hasSizeRamp=!1,this._scaleDrivenSizeVariable=null;const r=await this._getVisualVariableLegendElements(e,s)||[],a={type:"symbol-table",title:i||this._getRendererTitle(e,s),infos:[]};let n=null,o=!1;const y=new Set;if(Ze(e)&&!this._hasSizeRamp){const u=await zt(e);a.infos.push({label:null,symbol:u})}else if(qs(e)){let u=i;const h=Us(e)?"univariate-above-and-below-ramp":"univariate-color-size-ramp",L=r.findIndex(I=>I.type==="color-ramp"),b=L!==-1?r.splice(L,1)[0]:null,C=r.findIndex(I=>I.type==="size-ramp"),E=C!==-1?r.splice(C,1)[0]:null,$=[];b&&(u=b.title,$.push(b)),E&&(u=E.title,$.push(E)),$.length>0&&r.push({type:h,title:u,infos:$})}else if(Ut(e)){const u=Yi(e);r.push({type:"heatmap-ramp",title:i||this._getRendererTitle(e,s),infos:u,preview:X(u.map(h=>h.color),{effectList:this.effectList,ariaLabel:await W("previewColorRampAriaLabel")})})}else if(He(e)){const u=e&&e.authoringInfo;if(u&&u.type==="relationship"){const{numClasses:h,field1:L,field2:b}=u,C=u.focus;if(h&&L&&b){const E=[L,b];let $=Ft(C)||0;for(const M of E){const{field:H,normalizationField:N,label:x}=M,P=x||{field:this._getFieldAlias(H,s),normField:N&&this._getFieldAlias(N,s)},B=Ws.clone();B.angle=$,a.infos.push({label:P,symbol:B}),y.add(B),$+=90}const I=rs({focus:C,numClasses:h,infos:e.uniqueValueInfos??[]});r.unshift(I)}}else if(se(this.layer)||Ae(this.layer))e.uniqueValueInfos?.forEach(h=>{h.symbol&&a.infos.push({label:h.label||h.value,value:h.value,symbol:h.symbol})});else{const{field:h,field2:L,field3:b,fieldDelimiter:C,valueExpression:E,defaultSymbol:$}=e,I=!(!h&&!E||!L&&!b),M=[];if(e.uniqueValueGroups?.forEach(H=>{const N={type:"symbol-table",title:H.heading,infos:[]};H.classes?.forEach(x=>{const{symbol:P,values:B}=x;if(P){const Ce=[],Q=[];for(const te of B??[]){const{value:be,value2:ve,value3:_e}=te,Le=[],Ee=[];(h||E)&&(Le.push(be),Ee.push(this._getDomainName(h,be,s))),L&&(Le.push(ve),Ee.push(this._getDomainName(L,ve,s))),b&&(Le.push(_e),Ee.push(this._getDomainName(b,_e,s))),Ce.push(I?Le.join(C||""):Le[0]),Q.push(Ee.join(" - "))}const Ie=Ce.join(", ");let ee=x.label;if(!ee){const te=Q.filter(Boolean);ee=te.length?te.join(", "):Ie}N.infos.push({label:ee,value:Ie,symbol:P})}}),N.infos.length&&M.push(N)}),M.length){const H=M[0];M.length===1&&"title"in H&&!H.title?a.infos.push(...H.infos??[]):($&&(M.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:$}]}),o=!0),a.infos.push(...M)),i||e.legendOptions&&e.legendOptions.title||e.valueExpressionTitle||(a.title=null)}}e.defaultSymbol&&!o&&(a.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0)}else if(ye(e))n=this._isUnclassedRenderer(e),(!n||!this._hasSizeRamp)&&(e.classBreakInfos.forEach(u=>{u.symbol&&a.infos.unshift({label:u.label||(n?null:u.minValue+" - "+u.maxValue),value:[u.minValue,u.maxValue],symbol:u.symbol})}),n&&(a.title=null),this._updateInfosforClassedSizeRenderer(e,a.infos)),e.defaultSymbol&&!n&&(a.infos.push({label:e.defaultLabel||"others",symbol:e.defaultSymbol}),o=!0);else if(Ot(e))if(Ae(this.layer)||Ps(this.layer)){const u=await this._constructTileImageryStretchRendererElements(e);Os(u)?r.push(u):a.infos=u}else{const u=this.layer;let h,L;if(e.statistics?.length){const I=e.statistics[0];gt(I)?(h=I.min,L=I.max):[h,L]=I}let b=[],C=u.serviceRasterInfo;if(u.rasterFunction)try{C=await u.generateRasterInfo(u.rasterFunction)}catch{}const E=C.keyProperties.BandProperties,$=pt(C.pixelType);if(C.bandCount===1){const I=u.bandIds?.[0]||0;h=h??(C.statistics?C.statistics[I].min:$[0]),L=L??(C.statistics?C.statistics[I].max:$[1]),h||L?r.push(await this._getStretchLegendElements(e,{min:h,max:L})):this._getServerSideLegend()}else u.bandIds&&u.bandIds.length===1?(h=h??(C.statistics?C.statistics[u.bandIds[0]].min:$[0]),L=L??(C.statistics?C.statistics[u.bandIds[0]].max:$[1]),h||L?r.push(await this._getStretchLegendElements(e,{min:h,max:L})):this._getServerSideLegend()):C.bandCount>=3?E&&E.length>=C.bandCount?u.bandIds&&u.bandIds.length===3?(b=u.bandIds.map(I=>E[I].BandName),a.infos=this._createSymbolTableElementMultiBand(b)):u.format==="lerc"?(b=[0,1,2].map(I=>E[I].BandName),a.infos=this._createSymbolTableElementMultiBand(b)):this._getServerSideLegend():u.format==="lerc"?(b=["band1","band2","band3"],a.infos=this._createSymbolTableElementMultiBand(b)):this._getServerSideLegend():this._getServerSideLegend()}else if(Pt(e))e.colormapInfos.forEach(u=>{a.infos.push({label:u.label,value:u.value,symbol:this._getAppliedCloneSymbol(As,u.color)})});else if(de(e)){let u=e.symbol;switch(t.geometryType){case"point":u="pointSymbol"in s?s.pointSymbol:null;break;case"polyline":u="lineSymbol"in s?s.lineSymbol:null;break;case"polygon":u="polygonSymbol"in s?s.polygonSymbol:null}const h=this._hasClusterSizeVariable&&this._getClusterSymbol()||!this._hasSizeRamp;e.symbol&&h&&a.infos.push({label:e.label,symbol:u})}else if(Dt(e)){e.outputUnit&&(this.title="("+e.toJSON().outputUnit+")"),a.title=e.attributeField;const u=e.getClassBreakInfos();u?.length?u.forEach(h=>{a.infos.push({label:h.minValue+" - "+h.maxValue,symbol:h.symbol})}):a.infos.push({label:e.attributeField,symbol:e.getDefaultSymbol()})}else qt(e)&&r.push(await this._getStretchLegendElements(e,{min:0,max:255}));const c=e.defaultSymbol;!c||o||de(e)||n&&!this._hasColorRamp&&!this._hasSizeRamp&&!this._hasOpacityRamp||r.push({type:"symbol-table",infos:[{label:e.defaultLabel||"others",symbol:c}]}),a.infos.length&&r.unshift(a);const p=t.opacity==null?this.opacity:t.opacity,m=this._isTallSymbol("visualVariables"in e?e.visualVariables:null),g=se(this.layer)||Ae(this.layer),w=r.reduce((u,h)=>[...u,...this._getAllInfos(h)],[]).filter(u=>!!u?.symbol).map(u=>this._getSymbolPreview(u,p,{isDefault:u.symbol===c,applyScaleDrivenSize:!y.has(u.symbol),symbolConfig:{isTall:m,isSquareFill:g},effectList:y.has(u.symbol)?null:this.effectList}));return e=null,await Y(w),r}_getServerSideLegend(){setTimeout(()=>this.buildLegendElementsForTools(),0)}_getAllInfos(e){const t=e?.infos;return t?t.reduce((i,l)=>i.concat(this._getAllInfos(l)),[]):[e]}async _constructTileImageryStretchRendererElements(e){const t=this.layer,{rasterInfo:i}=t.raster,l=i.bandCount||e.statistics.length;let s,r,a=[];const n=i.keyProperties&&i.keyProperties.BandProperties,o=e?.statistics?.length?e.statistics:i?.statistics;if(o){const c=o[0];gt(c)?(s=c.min,r=c.max):[s,r]=c}else{const c=pt(i.pixelType);s=c[0],r=c[1]}if(t.hasStandardTime()&&(s=t.getStandardTimeValue(s),r=t.getStandardTimeValue(r)),i.bandCount===1||t.bandIds?.length===1)return this._getStretchLegendElements(e,{min:s,max:r});function y(c){const p=(t?.bandIds?.length?t.bandIds:Array.from(Array(Math.min(i.bandCount,3)).keys())).map(m=>c&&c[m]&&c[m].BandName||"band"+(m+1));return p.length<3?p.push(p[1]):p.length>3&&p.splice(3),p}return a=n&&n.length>=l?y(n):y(),this._createSymbolTableElementMultiBand(a)}async _getStretchLegendElements(e,t){const i=e.colorRamp,l=Ki(i,t);return{type:"stretch-ramp",title:"",infos:l,preview:X(l.map(s=>s.color),{ariaLabel:await W("previewColorRampAriaLabel")})}}_getClusterSymbol(){const e=this.layer,t="featureReduction"in e&&e.featureReduction,i=t&&"symbol"in t&&t.renderer;return i&&i?.authoringInfo?.isAutoGenerated!==!0?null:t&&"symbol"in t?t.symbol:null}async _getSizeLegendElement(e,t,i,l){return{type:"size-ramp",title:this._hasClusterSizeVariable?this._getClusterTitle(t):e,infos:await bs(i,t,await bt(i),this.scale,this.view.type,!!l,this._hasClusterSizeVariable?this._getClusterSymbol():null)}}_createSymbolTableElementMultiBand(e){const t=[],i=["red","green","blue"];return e.forEach((l,s)=>{t.push({label:{colorName:i[s],bandName:l},src:Xi[s],opacity:this.opacity??1})}),t}_updateInfosforClassedSizeRenderer(e,t){const i=e.authoringInfo&&e.authoringInfo.type==="class-breaks-size",l=e.classBreakInfos.some(s=>it(s.symbol));if(i&&l){const s=Ke,r=Xe,a=e.classBreakInfos.length,n=(s-r)/(a>1?a-1:a);t.forEach((o,y)=>{o.size=s-n*y})}}_isTallSymbol(e){let t=!1,i=!1;if(e)for(let l=0;l<e.length&&(!t||!i);l++){const s=e[l];s.type==="size"&&(s.axis==="height"&&(t=!0),s.axis==="width-and-depth"&&(i=!0))}return t&&i}async _getSymbolPreview(e,t,i){let l=!i?.isDefault&&e.size==null&&this._hasSizeRamp?Li(Oi.size):e.size;if(this._scaleDrivenSizeVariable&&i?.applyScaleDrivenSize){const{getSize:s}=await st(()=>import("./main-79e5ed80.js").then(r=>r.y4),["./main-79e5ed80.js","./main-7772480e.css"],import.meta.url);l=s(this._scaleDrivenSizeVariable,null,{view:this.view.type,scale:this.scale,shape:e.symbol.type==="simple-marker"?e.symbol.style:null})}return qi(e.symbol,{size:l,opacity:t,scale:!1,symbolConfig:i?.symbolConfig,effectView:i?.effectList,ariaLabel:e.label&&typeof e.label!="string"?null:await W("previewTemplateAriaLabel",e.label)}).then(s=>(e.preview=s,e)).catch(()=>(e.preview=null,e))}_getClusterRenderer(e){this._hasClusterSizeVariable=!1;const t="renderer"in this.layer?this.layer.renderer:null,i=e.renderer?.clone()||t?.clone(),l=ds(this.layerView._effectiveRenderer,this.view);if(l&&i!=null&&"visualVariables"in i&&!i.visualVariables?.some(r=>r.type==="size"&&r.target!=="outline"&&!ze.test(r.valueExpression))){if("clusterMinSize"in e&&"clusterMaxSize"in e){const{clusterMinSize:a,clusterMaxSize:n}=e;l.legendOptions=new wi({showLegend:a!==n})}const r=i.visualVariables||[];i.visualVariables=r.concat([l]),this._hasClusterSizeVariable=!0}return i}async _loadRenderer(e){const t=[],i=e.clone(),l=await bt(i);if(ye(i)||He(i)){const s=(i.classBreakInfos||i.uniqueValueInfos).map(r=>this._fetchSymbol(r.symbol,l).then(a=>{r.symbol=a}).catch(()=>{r.symbol=null}));Array.prototype.push.apply(t,s)}return t.push(this._fetchSymbol(i.symbol||i.defaultSymbol,i.defaultSymbol?null:l).then(s=>{this._applySymbolToRenderer(i,s,de(i))}).catch(()=>{this._applySymbolToRenderer(i,null,de(i))})),Y(t).then(()=>i)}_applySymbolToRenderer(e,t,i){i?e.symbol=t:e.defaultSymbol=t}async _fetchSymbol(e,t){if(!e)throw new Error;if(e.type==="web-style"){const i=this._webStyleSymbolCache;try{const l=await(this.view.type==="2d"?e.fetchCIMSymbol({cache:i}):e.fetchSymbol({cache:i}));return this._getAppliedCloneSymbol(l,t)}catch{throw q.getLogger(this).warn("Fetching web-style failed!"),new Error}}return this._getAppliedCloneSymbol(e,t)}_getAppliedCloneSymbol(e,t){if(!e||!t)return e;const i=e.clone(),l=t&&t.toRgba();return i.type.includes("3d")?this._applyColorTo3dSymbol(i,l):i.type==="cim"?Rt(i,t):i.color&&(i.color=new Ye(l||i.color)),i}_applyColorTo3dSymbol(e,t){t&&e.symbolLayers.forEach(i=>{i&&(i.material||(i.material={}),i.material.color=new Ye(t))})}async _getVisualVariableLegendElements(e,t){if(!("visualVariables"in e)||!e.visualVariables||e.type==="vector-field")return null;const i=e.visualVariables,l=[],s=[],r=[];for(const c of i)c.type==="color"?l.push(c):c.type==="size"?s.push(c):c.type==="opacity"&&r.push(c);const a=[...l,...s,...r];let n,o;if(l.length===0&&ye(e)&&e.classBreakInfos&&e.classBreakInfos.length===1){const c=e.classBreakInfos[0];n=c&&c.symbol}if(l.length===0&&de(e)&&(n=e.symbol),n)if(n.type.includes("3d")){const c=n.symbolLayers.at(0);c.type==="water"?c.color!=null&&(o=c.color):c.material!=null&&c.material.color!=null&&(o=c.material.color)}else n.url||(o=n.color);const y=this.effectList;return(await Promise.all(a.map(async c=>{if(!c.legendOptions||c.legendOptions.showLegend!==!1){const p=Ze(e)?c.field:this._getRampTitle(c,t);let m=null;const g="getField"in t?t.getField?.(c.field):null,w=g&&Si(g);if(c.type==="color"){const u=await vt(c,null,w)??[];m={type:"color-ramp",title:p,infos:u,preview:X(u.map(h=>h.color),{effectList:y,ariaLabel:await W("previewColorRampAriaLabel")})},this._hasColorRamp||(this._hasColorRamp=u.length>0)}else if(c.type==="size"&&c.target!=="outline")ze.test(c.valueExpression)?this._hasClusterSizeVariable||(this._scaleDrivenSizeVariable=c):(m=await this._getSizeLegendElement(p,c,e,w),this._hasSizeRamp||(this._hasSizeRamp=!(m.infos==null||!m.infos.length)));else if(c.type==="opacity"){const u=await vt(c,o,w)??[];m={type:"opacity-ramp",title:p,infos:u,preview:X(u.map(h=>h.color),{effectList:y,ariaLabel:await W("previewColorRampAriaLabel")})},this._hasOpacityRamp||(this._hasOpacityRamp=u.length>0)}return m&&m.infos?m:null}}))).filter(Te)}_getDomainName(e,t,i){if(e&&typeof e!="function"){const l="getField"in i&&i.getField&&i.getField(e),s=l&&"getFieldDomain"in i&&i.getFieldDomain?i.getFieldDomain(l.name):null;return s?.type==="coded-value"?s.getName(t):null}return null}_getClusterTitle(e){const t=this.layer,i=e.field;if("featureReduction"in t&&t.featureReduction&&t.featureReduction.type==="cluster"){const l=t.featureReduction,s="popupTemplate"in l&&l.popupTemplate,r=s&&s.fieldInfos;if(r){for(const a of r)if(a.fieldName===i)return i==="cluster_count"?a.label||{showCount:!0}:a.label}}return{showCount:!0}}_getRampTitle(e,t){let i=e.field,l=e.normalizationField,s=!1,r=!1,a=!1,n=null;i=typeof i=="function"?null:i,l=typeof l=="function"?null:l;const o=e.legendOptions&&e.legendOptions.title;if(o!=null)n=o;else if(e.valueExpressionTitle)n=e.valueExpressionTitle;else{if("renderer"in t&&t.renderer&&"authoringInfo"in t.renderer&&t.renderer.authoringInfo&&t.renderer.authoringInfo.visualVariables){const y=t.renderer.authoringInfo.visualVariables;for(let c=0;c<y.length;c++){const p=y[c];if(p.type==="color"){if(p.style==="ratio"){s=!0;break}if(p.style==="percent"){r=!0;break}if(p.style==="percent-of-total"){a=!0;break}}}}n={field:i&&this._getFieldAlias(i,t),normField:l&&this._getFieldAlias(l,t),ratio:s,ratioPercent:r,ratioPercentTotal:a}}return n}_getRendererTitle(e,t){const i=e;if(i.legendOptions&&i.legendOptions.title)return i.legendOptions.title;if(i.valueExpressionTitle)return i.valueExpressionTitle;let l=i.field,s=null,r=null;if(ye(i)&&(s=i.normalizationField,r=i.normalizationType==="percent-of-total"),l=typeof l=="function"?null:l,s=typeof s=="function"?null:s,He(i)){const{field2:n,field3:o,fieldDelimiter:y}=i;let c=l&&this._getFieldAlias(l,t);return n&&(c=`<${c}>${y}<${this._getFieldAlias(n,t)}>`,o&&(c=`${c}${y}<${this._getFieldAlias(o,t)}>`)),c}let a=null;return(l||s)&&(a={field:l&&this._getFieldAlias(l,t),normField:s&&this._getFieldAlias(s,t),normByPct:r}),a}_getFieldAlias(e,t){const i="popupTemplate"in t?t.popupTemplate:null,l=i?.fieldInfos;let s;l&&l.some(c=>e===c.fieldName&&(s=c,!0));let r=null;"getField"in t&&t.getField?r=t.getField(e):"fieldsIndex"in t&&t.fieldsIndex&&(r=t.fieldsIndex.get(e));let a=null;const n="featureReduction"in t&&t.featureReduction;n&&(!s&&"popupTemplate"in n&&n.popupTemplate&&n.popupTemplate.fieldInfos&&n.popupTemplate.fieldInfos.some(c=>e?.toLowerCase()===c.fieldName?.toLowerCase()&&(s=c,!0)),"fields"in n&&n.fields&&(a=n.fields.find(c=>c.name?.toLowerCase()===e?.toLowerCase())));const o=s||r||a;let y=null;return o&&(y=s?.label||r?.alias||a?.alias||"name"in o&&o.name||"fieldName"in o&&o.fieldName||null),y}_isUnclassedRenderer(e){const t=e.visualVariables;let i=!1;return ye(e)&&e.classBreakInfos&&e.classBreakInfos.length===1&&t&&(i=e.field?t.some(l=>!(!l||e.field!==l.field||(e.normalizationField||l.normalizationField)&&e.normalizationField!==l.normalizationField)):!!t.length),i}};f([_()],A.prototype,"children",void 0),f([_({readOnly:!0})],A.prototype,"effectList",null),f([_()],A.prototype,"layerView",void 0),f([_()],A.prototype,"layer",void 0),f([_()],A.prototype,"legendElements",void 0),f([_({readOnly:!0})],A.prototype,"opacity",null),f([_()],A.prototype,"parent",void 0),f([_({readOnly:!0,dependsOn:[]})],A.prototype,"ready",null),f([_()],A.prototype,"hideLayersNotInCurrentView",void 0),f([_()],A.prototype,"keepCacheOnDestroy",void 0),f([_()],A.prototype,"respectLayerVisibility",void 0),f([_({readOnly:!0})],A.prototype,"scale",null),f([_()],A.prototype,"sublayerIds",void 0),f([_({readOnly:!0})],A.prototype,"isScaleDriven",null),f([_()],A.prototype,"title",void 0),f([_({readOnly:!0,dependsOn:["ready"],value:0})],A.prototype,"version",null),f([_()],A.prototype,"view",void 0),A=f([ge("esri.widgets.Legend.support.ActiveLayerInfo")],A);const Gt=A,K={state:"state",view:"view",allLayerViews:"all-layer-views",legendProperties:"legend-properties"},Jt=lt.ofType(Gt),js=["esri.layers.BuildingSceneLayer","esri.layers.CSVLayer","esri.layers.FeatureLayer","esri.layers.GeoJSONLayer","esri.layers.GeoRSSLayer","esri.layers.GroupLayer","esri.layers.HeatmapLayer","esri.layers.ImageryLayer","esri.layers.ImageryTileLayer","esri.layers.MapImageLayer","esri.layers.OGCFeatureLayer","esri.layers.PointCloudLayer","esri.layers.StreamLayer","esri.layers.SceneLayer","esri.layers.SubtypeGroupLayer","esri.layers.TileLayer","esri.layers.VoxelLayer","esri.layers.WFSLayer","esri.layers.WMSLayer","esri.layers.WMTSLayer","esri.layers.WCSLayer","esri.layers.LinkChartLayer","esri.layers.knowledgeGraph.KnowledgeGraphSublayer"],Qt="view.basemapView.baseLayerViews",Yt="view.groundView.layerViews",Kt="view.basemapView.referenceLayerViews",Gs=[Qt,Yt,"view.layerViews",Kt];let D=class extends tt{constructor(t){super(t),this._layerViewByLayerId={},this._layerInfosByLayerViewId={},this._activeLayerInfosByLayerViewId={},this._activeLayerInfosWithNoParent=new lt,this.activeLayerInfos=new Jt,this.basemapLegendVisible=!1,this.groundLegendVisible=!1,this.hideLayersNotInCurrentView=!1,this.keepCacheOnDestroy=!1,this.respectLayerVisibility=!0,this.layerInfos=[],this.view=null}initialize(){this.addHandles(z(()=>this.view,()=>this._viewHandles(),pe),K.view),this.addHandles(Ci(()=>this._refresh()))}destroy(){this._destroyViewActiveLayerInfos(),this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}_viewHandles(){this.removeHandles(K.state),this.view&&this.addHandles(z(()=>this.state,()=>this._stateHandles(),pe),K.state)}_stateHandles(){this._resetAll(),this.state==="ready"&&this._watchPropertiesAndAllLayerViews()}_resetAll(){this.removeHandles([K.allLayerViews,K.legendProperties]),this._destroyViewActiveLayerInfos(),this.activeLayerInfos.removeAll()}_destroyViewActiveLayerInfos(){Object.keys(this._activeLayerInfosByLayerViewId).forEach(this._destroyViewActiveLayerInfo,this)}_destroyViewActiveLayerInfo(t){this.removeHandles(t);const i=this._activeLayerInfosByLayerViewId[t];delete this._activeLayerInfosByLayerViewId[t],i&&i.parent&&i.parent.children.remove(i)}_watchPropertiesAndAllLayerViews(){const{view:t}=this;if(!t)return;const{allLayerViews:i}=t;i.length&&this._refresh(),this.addHandles(i.on("change",l=>this._allLayerViewsChangeHandle(l)),K.allLayerViews),this.addHandles(z(()=>[this.layerInfos,this.basemapLegendVisible,this.groundLegendVisible],()=>this._propertiesChangeHandle()),K.legendProperties)}_allLayerViewsChangeHandle(t){t.removed.forEach(i=>this._destroyViewActiveLayerInfo(i.uid)),this._refresh()}_propertiesChangeHandle(){this._destroyViewActiveLayerInfos(),this._refresh()}_refresh(){this._layerInfosByLayerViewId={},this.activeLayerInfos.removeAll(),this._generateLayerViews().filter(this._filterLayerViewsByLayerInfos,this).filter(this._isLayerViewSupported,this).forEach(this._generateActiveLayerInfo,this),this._sortActiveLayerInfos(this.activeLayerInfos)}_sortActiveLayerInfos(t){const i=this.view;if(t.length<2||!i)return;const l=[];t.forEach(r=>{if(!r.parent){const a=r.layer.parent,n=a&&"uid"in a&&this._layerViewByLayerId[a.uid],o=n&&this._activeLayerInfosByLayerViewId[n.uid];o&&t.includes(o)&&(l.push(r),r.parent=o,o.children.add(r),this._sortActiveLayerInfos(o.children))}}),t.removeMany(l);const s={};i.allLayerViews.forEach((r,a)=>s[r.layer.uid]=a),t.sort((r,a)=>{const n=s[r.layer.uid]||0;return(s[a.layer.uid]||0)-n})}_generateLayerViews(){const t=[];return Gs.filter(this._filterLayerViews,this).map(this.get,this).filter(i=>i!=null).forEach(this._collectLayerViews("layerViews",t)),t}_filterLayerViews(t){const i=!this.basemapLegendVisible&&(t===Qt||t===Kt),l=!this.groundLegendVisible&&t===Yt;return!i&&!l}_collectLayerViews(t,i){const l=s=>(s&&s.forEach(r=>{i.push(r),l(r[t])}),i);return l}_filterLayerViewsByLayerInfos(t){const i=this.layerInfos;return!i||!i.length||i.some(l=>this._hasLayerInfo(l,t))}_hasLayerInfo(t,i){const l=this._isLayerUIDMatching(t.layer,i.layer.uid);return l&&(this._layerInfosByLayerViewId[i.uid]=t),l}_isLayerUIDMatching(t,i){return t&&(t.uid===i||this._hasLayerUID(t.layers,i))}_hasLayerUID(t,i){return t&&t.some(l=>this._isLayerUIDMatching(l,i))}_isLayerViewSupported(t){return!!js.includes(t.layer.declaredClass)&&(this._layerViewByLayerId[t.layer.uid]=t,!0)}_generateActiveLayerInfo(t){this._isLayerActive(t)?this._buildActiveLayerInfo(t):(this.removeHandles(t.uid),this.addHandles(z(()=>[t.legendEnabled,t.layer?.legendEnabled],()=>this._layerActiveHandle(t)),t.uid))}_layerActiveHandle(t){this._isLayerActive(t)&&(this.removeHandles(t.uid),this._buildActiveLayerInfo(t))}_isLayerActive(t){return!this.respectLayerVisibility||t.legendEnabled&&t.get("layer.legendEnabled")}_buildActiveLayerInfo(t){const i=t.layer,l=t.uid,s=this._layerInfosByLayerViewId[l];let r=this._activeLayerInfosByLayerViewId[l];if(!r){const n=s&&s.title!==void 0&&s.layer.uid===i.uid;r=new Gt({layer:i,layerView:t,title:n?s.title:i.title,view:this.view,respectLayerVisibility:this.respectLayerVisibility,hideLayersNotInCurrentView:this.hideLayersNotInCurrentView,keepCacheOnDestroy:this.keepCacheOnDestroy,sublayerIds:s&&s.sublayerIds||[]}),this._activeLayerInfosByLayerViewId[l]=r}const a=i.parent&&"uid"in i.parent?this._layerViewByLayerId[i.parent?.uid]:null;if(r.parent=this._activeLayerInfosByLayerViewId[a?.uid],!this.hasHandles(l)){const n=[z(()=>i.title,o=>this._titleHandle(o,r)),z(()=>[i.opacity,"renderer"in i&&i.renderer,"pointSymbol"in i&&i.pointSymbol,"lineSymbol"in i&&i.lineSymbol,"polygonSymbol"in i&&i.polygonSymbol],()=>this._constructLegendElements(r)),Ii(()=>this.view?.stationary===!0,()=>this._scaleHandle(r),pe),z(()=>t._effectiveRenderer,()=>this._constructLegendElements(r)),z(()=>"effect"in i&&i.effect,()=>this._constructLegendElements(r))];if(this.respectLayerVisibility){const o=z(()=>t.legendEnabled,c=>this._legendEnabledHandle(c,r)),y=z(()=>i.legendEnabled,c=>this._legendEnabledHandle(c,r));n.push(o,y)}this.addHandles(n,l)}r.isScaleDriven||this._constructLegendElements(r),this._addActiveLayerInfo(r)}_titleHandle(t,i){i.title=t,this._constructLegendElements(i)}_legendEnabledHandle(t,i){t?this._addActiveLayerInfo(i):this._removeActiveLayerInfo(i)}_scaleHandle(t){(t.isScaleDriven||t.hideLayersNotInCurrentView)&&this._constructLegendElements(t)}_addActiveLayerInfo(t){const{layerView:i,layer:l}=t;if(this._isLayerActive(i)&&!this.activeLayerInfos.includes(t)){const s=t.parent;if(s)s.children.includes(t)||s.children.push(t),this._sortActiveLayerInfos(s.children);else{const r=this.layerInfos?.some(a=>a.layer.uid===l.uid);l.parent&&"uid"in l.parent&&!r?this._activeLayerInfosWithNoParent.add(t):(this.activeLayerInfos.add(t),this._sortActiveLayerInfos(this.activeLayerInfos))}if(this._activeLayerInfosWithNoParent.length){const r=[];this._activeLayerInfosWithNoParent.forEach(a=>{const n=a.layer.parent,o=n&&"uid"in n?this._layerViewByLayerId[n?.uid]:null,y=this._activeLayerInfosByLayerViewId[o?.uid];y&&(r.push(a),a.parent=y)}),r.length&&(this._activeLayerInfosWithNoParent.removeMany(r),r.forEach(a=>this._addActiveLayerInfo(a)))}}}_removeActiveLayerInfo(t){const i=t.parent;i?i.children.remove(t):this.activeLayerInfos.remove(t)}_constructLegendElements(t){const i=t.layer;"featureCollections"in i&&i.featureCollections?t.buildLegendElementsForFeatureCollections(i.featureCollections):"featureReduction"in i&&i.featureReduction&&"renderer"in i.featureReduction&&(i.featureReduction.type==="binning"||i.featureReduction.type==="cluster")?t.buildLegendElementsForFeatureReduction(i.featureReduction):"renderer"in i&&i.renderer&&!("sublayers"in i)?t.buildLegendElementsForRenderer(i.renderer):"url"in i&&i.url?t.buildLegendElementsForTools():t.children.forEach(l=>this._constructLegendElements(l))}};f([_({type:Jt})],D.prototype,"activeLayerInfos",void 0),f([_()],D.prototype,"basemapLegendVisible",void 0),f([_()],D.prototype,"groundLegendVisible",void 0),f([_()],D.prototype,"hideLayersNotInCurrentView",void 0),f([_()],D.prototype,"keepCacheOnDestroy",void 0),f([_()],D.prototype,"respectLayerVisibility",void 0),f([_()],D.prototype,"layerInfos",void 0),f([_({readOnly:!0})],D.prototype,"state",null),f([_()],D.prototype,"view",void 0),D=f([ge("esri.widgets.Legend.LegendViewModel")],D);const Js=D,R="esri-legend--card",re="esri-legend",v={activated:`${R}__carousel-indicator--activated`,base:R,stacked:`${re}--stacked`,carouselTitle:`${R}__carousel-title`,indicator:`${R}__carousel-indicator`,intervalSeparator:`${R}__interval-separator`,imageryLayerStretchedImage:`${R}__imagery-layer-image--stretched`,imageLabel:`${R}__image-label`,layerCaption:`${R}__layer-caption`,labelElement:`${R}__label-element`,layerRow:`${R}__layer-row`,labelCell:`${R}__label-cell`,message:`${R}__message`,rampLabel:`${R}__ramp-label`,section:`${R}__section`,relationshipSection:`${R}__relationship-section`,serviceCaptionText:`${R}__service-caption-text`,serviceContent:`${R}__service-content`,service:`${R}__service`,groupLayer:`${R}__group-layer`,groupLayerChild:`${R}__group-layer-child`,symbol:`${R}__symbol`,sizeRampRow:`${R}__size-ramp-row`,symbolRow:`${R}__symbol-row`,symbolCell:`${R}__symbol-cell`,indicatorContainer:`${R}__carousel-indicator-container`,intervalSeparatorsContainer:`${R}__interval-separators-container`,relationshipLabelContainer:`${R}__relationship-label-container`,labelContainer:`${R}__label-container`,serviceCaptionContainer:`${R}__service-caption-container`,symbolContainer:`${R}__symbol-container`,sizeRampContainer:`${R}__size-ramp-container`,sizeRampPreview:`${R}__size-ramp-preview`,pieChartRampPreview:`${R}__pie-chart-ramp-preview`,rampContainer:`${re}__ramps`,sizeRampHorizontal:`${re}__size-ramp--horizontal`,rampLabelsContainer:`${re}__ramp-labels`,layerInfo:`${re}__layer-cell ${re}__layer-cell--info`,univariateAboveAndBelowColorRamp:"esri-univariate-above-and-below-ramp__color--card",hidden:"esri-hidden"},Qs=Ei(),Xt=10,ct=20,Oe=10,dt=20,yt={univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",colorRamp:"esri-legend__color-ramp"};function Ys(e="vertical"){const t="stroke:rgb(200, 200, 200);stroke-width:1";return e==="vertical"?d("svg",{height:"4",width:"10"},d("line",{x1:"0",y1:"2",x2:"10",y2:"2",style:t})):d("svg",{height:"10",width:"10"},d("line",{x1:"5",y1:"0",x2:"5",y2:"10",style:t}))}function Ks(e,t="vertical"){const i=document.createElement("div");return i.style.height=`${ct}px`,i.className=yt.univariateAboveAndBelowSymbol,e!=null&&(i.style.opacity=e.toString()),Qs.append(i,Ys.bind(null,t)),i}function Zt(e,t,i="vertical",l){e.infos.forEach((s,r)=>{if(l&&r===2)s.preview=Ks(t,i);else{const a=J(s.size)+(i==="horizontal"?dt:Oe),n=s.preview,o=n?.tagName.toLowerCase()==="div",y=o?n:document.createElement("div");y.className=yt.univariateAboveAndBelowSymbol,i==="horizontal"?y.style.width=`${a}px`:y.style.height=`${a}px`,!o&&n&&y.appendChild(n),s.preview=y}})}function Pe(e,t="classic"){const i=e.infos;return t==="classic"?(J(i[0].size)+Oe)/2:(J(i[0].size)-J(i[i.length-1].size))/2}function me(e,t){if(!e)return null;const i=e.infos.map(s=>s.color),l=X(t.type==="full"?i:t.type==="above"?i.slice(0,3):i.slice(2,5),{width:t.width,height:t.height,align:t.rampAlignment,effectList:t.effectList,ariaLabel:t.ariaLabel});return l.className=yt.colorRamp,t.opacity!=null&&(l.style.opacity=t.opacity.toString()),l}function et(e,t,i,l="vertical"){let s=0;const r=e.infos,a=Math.floor(r.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?r.length-1:a;for(let y=n;y<=o;y++)i&&y===a?s+=l==="horizontal"?Xt:ct:s+=J(r[y].size)+(l==="horizontal"?dt:Oe);return Math.round(s)}function fe(e,t,i,l="vertical"){const s=et(e,t,i,l),r=e.infos,a=Math.floor(r.length/2),n=t==="full"||t==="above"?0:a,o=t==="full"||t==="below"?r.length-1:a,y=t==="full"?r[n].size+r[o].size:t==="above"?r[n].size:r[o].size,c=i?l==="vertical"?ct:Xt:0,p=l==="vertical"?Oe*(t==="full"?2:1):dt*(t==="full"?2:1);return Math.round(s-(J(y)/2+c/2+p/2))}function ei(e,t,i="vertical"){const l=e.infos;let s=l.find(({type:a})=>a==="size-ramp"),r=l.find(({type:a})=>a==="color-ramp");return s&&(s={...s},s.infos=[...s.infos],Zt(s,t,i,!0)),r&&(r={...r},r.infos=[...r.infos]),i==="horizontal"&&(s?.infos.reverse(),r?.infos.reverse()),{sizeRampElement:s,colorRampElement:r}}function ti(e,t="vertical"){const i=e.infos;let l=i.find(({type:r})=>r==="size-ramp"),s=i.find(({type:r})=>r==="color-ramp");return l&&(l={...l},l.infos=[...l.infos],Zt(l,null,t,!1)),s&&(s={...s},s.infos=[...s.infos]),t==="horizontal"&&(l?.infos.reverse(),s?.infos.reverse()),{sizeRampElement:l,colorRampElement:s}}function Xs(e,t){return t}function k(e){const t=this;e.appendChild(t)}function G(e,t,i){if(!t)return;if(typeof t=="string"||typeof t=="number")return t;if("value"in t||"unit"in t)return Ne(e.dotValue,t);if("colorName"in t&&"bandName"in t)return e[t.colorName]+": "+(e[t.bandName]||t.bandName);if("showCount"in t)return t.showCount?e.clusterCountTitle:void 0;let l=null;return Xs(t,i)?l=t.ratioPercentTotal?"showRatioPercentTotal":t.ratioPercent?"showRatioPercent":t.ratio?"showRatio":t.normField?"showNormField":t.field?"showField":null:ii(t,i)&&(l=t.normField?"showNormField":t.normByPct?"showNormPct":t.field?"showField":null),l?Ne(l==="showField"?"{field}":e[l],{field:t.field,normField:t.normField}):void 0}function ii(e,t){return!t}function si(e,t){return!!(t&&t==="Stretched"&&e.version>=10.3&&e.declaredClass==="esri.layers.ImageryLayer")}const Zs=25,el=25,tl=768,il=100;var Se;(function(e){e.Auto="auto",e.Stack="stack",e.SideBySide="side-by-side"})(Se||(Se={}));const sl="#ddd",ae=window.devicePixelRatio;function ll(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.at(t-1),l=i.resource&&i.resource.primitive;return l==="circle"||l==="cross"||l==="kite"||l==="sphere"||l==="cube"||l==="diamond"}{const t=e.style;return t==="circle"||t==="diamond"||t==="cross"}}}function rl(e){if(e){if(e.type.includes("3d")){const t=e.symbolLayers&&e.symbolLayers.length;if(!t)return;const i=e.symbolLayers.at(t-1).get("resource.primitive");return i==="triangle"||i==="cone"||i==="tetrahedron"}return e.style==="triangle"}}let O=class extends rt{constructor(e,t){super(e,t),this._hasIndicators=!1,this._selectedSectionName=null,this._sectionNames=[],this._sectionMap=new Map,this.activeLayerInfos=null,this.headingLevel=3,this.layout=Se.Stack,this.messages=null,this.messagesCommon=null,this.type="card",this.view=null}initialize(){this.addHandles(z(()=>this.activeLayerInfos,e=>{this.removeAllHandles(),this._watchForSectionChanges(e)}))}render(){const{view:e}=this;this._hasIndicators=this.layout===Se.Auto&&e&&e.container.clientWidth<=tl||this.layout===Se.Stack;const t=this.activeLayerInfos,i=t&&t.toArray().map(o=>this._renderLegendForLayer(o)).filter(o=>!!o);this._hasIndicators?this._selectedSectionName&&this._sectionNames.includes(this._selectedSectionName)||(this._selectedSectionName=this._sectionNames&&this._sectionNames[0]):this._selectedSectionName=null;const l=this._sectionNames.length,s=this._sectionNames.map((o,y)=>{const c=Ne(this.messagesCommon.pagination.pageText,{index:y+1,total:l});return d("div",{key:o,role:"tab",id:o,"aria-label":c,"aria-controls":`${o}-panel`,"aria-selected":(this._selectedSectionName===o).toString(),tabIndex:this._selectedSectionName===o?0:-1,title:c,onclick:this._selectSection,onkeydown:this._focusSection,bind:this,class:this.classes(v.indicator,{[v.activated]:this._selectedSectionName===o}),"data-section-name":o})}),r=this._hasIndicators&&l>1?d("div",{class:v.indicatorContainer,key:"carousel-navigation",role:"tablist"},s):null,a=this._hasIndicators?this._sectionMap.get(this._selectedSectionName):i&&i.length?i:null,n={[v.stacked]:this._hasIndicators};return d("div",{class:this.classes(v.base,n)},a||d("div",{class:v.message},this.messages.noLegend),r)}_selectSection(e){const t=e.target.getAttribute("data-section-name");t&&(this._selectedSectionName=t)}_focusSection(e){switch(e.key){case"ArrowLeft":case"ArrowRight":this._switchSectionOnArrowPress(e);break;case"Enter":case" ":this._selectSection(e)}}_switchSectionOnArrowPress(e){const t=e.key,i=t==="ArrowLeft"?-1:1,l=e.target.getAttribute("data-section-name"),s=this._sectionNames.indexOf(l),r=this._sectionNames;let a=null;s!==-1&&(r[s+i]?a=document.getElementById(r[s+i]):t==="ArrowLeft"?a=document.getElementById(r[r.length-1]):t==="ArrowRight"&&(a=document.getElementById(r[0])),a?.focus())}_watchForSectionChanges(e){if(this._generateSectionNames(),e){e.forEach(i=>{const l=`activeLayerInfo-${i.layer.uid}-version-change`;this.removeHandles(l),this._watchForSectionChanges(i.children),this.addHandles(z(()=>i.version,()=>this._generateSectionNames()),l)});const t="activeLayerInfos-collection-change";this.removeHandles(t),this.addHandles(e.on("change",()=>this._watchForSectionChanges(e)),t)}}_generateSectionNames(){this._sectionNames.length=0,this._selectedSectionName=null,this.activeLayerInfos&&this.activeLayerInfos.forEach(this._generateSectionNamesForActiveLayerInfo,this)}_getSectionName(e,t,i){return`${this.id}${e.uid}-type-${t.type}-${i}`}_generateSectionNamesForActiveLayerInfo(e){e.children.forEach(this._generateSectionNamesForActiveLayerInfo,this),e.legendElements&&e.legendElements.forEach((t,i)=>{this._sectionNames.push(this._getSectionName(e.layer,t,i))})}_renderLegendForLayer(e){if(!e.ready)return null;if(e.children.length){const t=e.children.map(i=>this._renderLegendForLayer(i)).toArray();return d("div",{key:e.layer.uid,class:this.classes(v.service,v.groupLayer)},d("div",{class:v.serviceCaptionContainer},e.title),t)}{const t=e.legendElements;if(t&&!t.length)return null;const i=t.some(r=>r.type==="relationship-ramp"),l=t.map((r,a)=>this._renderLegendForElement(r,e,a,i)).filter(r=>!!r);if(!l.length)return null;const s={[v.groupLayerChild]:!!e.parent};return d("div",{key:e.layer.uid,class:this.classes(v.service,s)},d("div",{class:v.serviceCaptionContainer},d("div",{class:v.serviceCaptionText},e.title)),d("div",{class:v.serviceContent},l))}}_renderLegendForElement(e,t,i,l=!1,s=!1){const r=e.type==="color-ramp",a=e.type==="opacity-ramp",n=e.type==="size-ramp",o=t.layer;let y=null;if(typeof e.title=="string")y=e.title;else if(e.title){const u=e.title,h=G(this.messages,u,r||a);y=u.title?`${u.title} (${h})`:h}const c=this._getSectionName(o,e,i),p=this._hasIndicators&&!s?d("div",null,d(Me,{level:this.headingLevel,class:v.carouselTitle},t.title),d(Me,{level:Zi(this.headingLevel),class:v.layerCaption},y)):y?d(Me,{level:this.headingLevel,class:v.layerCaption},y):null,m=t.effectList;let g=null;if(e.type==="symbol-table"){const u=e.infos.map((h,L)=>this._renderLegendForElementInfo(h,t,e.legendType,L)).filter(h=>!!h);if(u.length){const h=u[0].properties.classes&&u[0].properties.classes[v.symbolRow],L={[v.labelContainer]:!h&&!l,[v.relationshipLabelContainer]:l};g=d("div",{class:this.classes(L)},u)}}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"?g=this._renderLegendForRamp(e,o.opacity,m):n?g=this._renderSizeRamp(e,o.opacity):e.type==="pie-chart-ramp"?g=this._renderPieChartRamp(e):e.type==="relationship-ramp"?g=At(e,this.id,{opacity:o.opacity,effectList:m,ariaLabel:this.messages.previewRelationshipRampAriaLabel}):e.type==="univariate-above-and-below-ramp"?g=this._renderUnivariateAboveAndBelowRamp(e,o.opacity,m):e.type==="univariate-color-size-ramp"&&(g=this._renderUnivariateColorSizeRamp(e,o.opacity,m));if(!g)return null;const w=d("div",{key:c,class:v.section,id:`${c}-panel`,role:"tabpanel","aria-labelledby":c,tabIndex:0},[p,g]);return s||this._sectionMap.set(c,w),w}_renderPieChartRamp(e){return d("div",{class:v.pieChartRampPreview,bind:e.preview,afterCreate:k})}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:l,colorRampElement:s}=ei(e,t,"horizontal");if(!l)return null;const r=et(l,"full",!0,"horizontal"),a=fe(l,"above",!0,"horizontal"),n=fe(l,"below",!0,"horizontal"),o=12,y=this.messages?.previewColorRampAriaLabel,c=me(s,{width:a,height:o,rampAlignment:"horizontal",opacity:t,type:"above",effectList:i,ariaLabel:y}),p=me(s,{width:n,height:o,rampAlignment:"horizontal",opacity:t,type:"below",effectList:i,ariaLabel:y}),m=Pe(l,"card"),g=l.infos.map(E=>E.label),w=g.length-1,u=g.map((E,$)=>$===0||$===w?d("div",{key:$},E):null),h={display:"flex",flexDirection:"column"},L={display:"flex",flexDirection:"row"},b={marginTop:"3px",display:"flex"};Je(this.container)?b.marginRight=`${m}px`:b.marginLeft=`${m}px`;const C={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:v.layerRow,key:"size-ramp-preview",styles:h},d("div",{class:this.classes(v.symbolContainer,v.sizeRampHorizontal),styles:L},l.infos.map((E,$)=>d("div",{key:$,class:v.symbol,bind:E.preview,afterCreate:k}))),c?d("div",{class:v.univariateAboveAndBelowColorRamp,styles:b,key:"color-ramp-preview"},d("div",{bind:c,afterCreate:k}),d("div",{bind:p,afterCreate:k})):null,d("div",{class:v.layerInfo},d("div",{class:v.rampLabelsContainer,styles:C},u)))}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:l,colorRampElement:s}=ti(e,"horizontal");if(!l)return null;const r=et(l,"full",!1,"horizontal"),a=fe(l,"full",!1,"horizontal"),n=me(s,{width:a,height:12,rampAlignment:"horizontal",opacity:t,type:"full",effectList:i,ariaLabel:this.messages?.previewColorRampAriaLabel}),o=Pe(l,"card"),y=l.infos.length-1,c=l.infos.map((u,h)=>h===0||h===y?d("div",{key:h},u.label):null),p={display:"flex",flexDirection:"column"},m={display:"flex",flexDirection:"row"},g={marginTop:"3px",display:"flex"};Je(this.container)?g.marginRight=`${o}px`:g.marginLeft=`${o}px`;const w={width:`${r}px`,display:"flex",flexDirection:"row",justifyContent:"space-between"};return d("div",{class:v.layerRow,key:"size-ramp-preview",styles:p},d("div",{class:this.classes(v.symbolContainer,v.sizeRampHorizontal),styles:m},l.infos.map((u,h)=>d("div",{key:h,class:v.symbol,bind:u.preview,afterCreate:k}))),d("div",{class:v.univariateAboveAndBelowColorRamp,styles:g,key:"color-ramp-preview"},d("div",{bind:n,afterCreate:k})),d("div",{class:v.layerInfo},d("div",{class:v.rampLabelsContainer,styles:w},c)))}_renderLegendForElementInfo(e,t,i,l){const s=t.layer;if(e.type)return this._renderLegendForElement(e,t,l,!1,!0);const r=si(s,i);if(e.preview){if(!e.symbol||!e.symbol.type.includes("simple-fill")){if(!e.label)return d("div",{key:l,bind:e.preview,afterCreate:k});const C={[v.symbolCell]:this._hasIndicators};return d("div",{key:l,class:this.classes(v.layerRow,{[v.symbolRow]:this._hasIndicators})},d("div",{class:this.classes(C),bind:e.preview,afterCreate:k}),d("div",{class:this.classes(v.imageLabel,{[v.labelCell]:this._hasIndicators})},G(this.messages,e.label,!1)||""))}let a=255,n=255,o=255,y=0,c=255,p=255,m=255,g=0;const w=e.symbol.color&&e.symbol.color.a,u=e.symbol.outline&&e.symbol.outline.color&&e.symbol.outline.color.a;w&&(a=e.symbol.color.r,n=e.symbol.color.g,o=e.symbol.color.b,y=e.symbol.color.a*s.opacity),u&&(c=e.symbol.outline.color.r,p=e.symbol.outline.color.g,m=e.symbol.outline.color.b,g=e.symbol.outline.color.a*s.opacity);const h=e.symbol.color?.isBright??!0,L=h?"rgba(255, 255, 255, .6)":"rgba(0, 0, 0, .6)",b={background:w?`rgba(${a}, ${n}, ${o}, ${y})`:"none",color:h?"black":"white",textShadow:`-1px -1px 0 ${L},
                                              1px -1px 0 ${L},
                                              -1px 1px 0 ${L},
                                              1px 1px 0 ${L}`,border:u?`1px solid rgba(${c}, ${p}, ${m}, ${g})`:"none",filter:Qe(t.effectList)??void 0};return d("div",{key:l,class:v.layerRow},d("div",{class:v.labelElement,styles:b}," ",e.label," "))}if(e.src){const a=this._renderImage(e,s,r);return d("div",{key:l,class:v.layerRow},a,d("div",{class:v.imageLabel},e.label||""))}}_renderImage(e,t,i){const{label:l,src:s,opacity:r}=e,a={[v.imageryLayerStretchedImage]:i,[v.symbol]:!i},n={opacity:`${r??t.opacity}`};return d("img",{alt:G(this.messages,l,!1),"aria-label":G(this.messages,l,!1),src:s,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}_renderSizeRampLines(e){const t=e.infos,i=t[0],l=t[t.length-1],s=i.symbol,r=this._hasIndicators,a=J(i.size+i.outlineSize)*ae,n=J(l.size+l.outlineSize)*ae,o=r?a:a+50*ae,y=r?a/2+50*ae:a,c=rl(s),p=ll(s),m=document.createElement("canvas");m.width=o,m.height=y,m.style.width=m.width/ae+"px",m.style.height=m.height/ae+"px";const g=m.getContext("2d");if(r){g.beginPath();const w=0,u=0,h=o/2-n/2,L=y;g.moveTo(w,u),g.lineTo(h,L);const b=o,C=0,E=o/2+n/2,$=y;g.moveTo(b,C),g.lineTo(E,$)}else{g.beginPath();const w=0,u=y/2-n/2,h=o,L=0;g.moveTo(w,u),g.lineTo(h,L);const b=0,C=y/2+n/2,E=o,$=y;g.moveTo(b,C),g.lineTo(E,$)}return g.strokeStyle=sl,g.stroke(),d("div",{bind:m,afterCreate:k,styles:r?{display:"flex",marginTop:`-${c?0:p?a/2:0}px`,marginBottom:`-${c?n:p?n/2:0}px`}:{display:"flex",marginRight:`-${c?0:p?a/2:0}px`,marginLeft:`-${c?0:p?n/2:0}px`}})}_renderSizeRamp(e,t){const i=e.infos,l=i[0].label,s=i[i.length-1].label;let r=i[0].preview,a=i[i.length-1].preview;const n=this._hasIndicators,o={"flex-direction":n?"column":"row-reverse"};r&&(r=r.cloneNode(!0),r.style.display="flex"),a&&(a=a.cloneNode(!0),a.style.display="flex");const y={opacity:t!=null?`${t}`:""};return d("div",{class:this.classes(v.layerRow,{[v.sizeRampRow]:n})},d("div",{class:v.rampLabel},n?l:s),d("div",{class:v.sizeRampContainer,styles:o},d("div",{bind:r,afterCreate:k,class:v.sizeRampPreview,styles:y}),this._renderSizeRampLines(e),d("div",{bind:a,afterCreate:k,class:v.sizeRampContainer,styles:y})),d("div",{class:v.rampLabel},n?s:l))}_renderLegendForRamp(e,t,i){const l=e.infos,s=e.type==="heatmap-ramp",r=l.length-1,a=el,n=r>2&&!s?Zs*r:il,o=n+20,y=10,c=l.slice(0).reverse();c.forEach(($,I)=>{$.offset=s?$.ratio:I/r});const p=c.length-1,m=c.length%2!=0&&c[c.length/2|0],g=m&&d("div",{class:v.intervalSeparatorsContainer},d("div",{class:v.intervalSeparator},"|"),d("div",{class:v.rampLabel},m.label)),w=l[l.length-1].label,u=l[0].label,h=[[{shape:{type:"path",path:`M0 ${a/2} L${y} 0 L${y} ${a} Z`},fill:c[0].color,stroke:{width:0}},{shape:{type:"rect",x:y,y:0,width:n,height:a},fill:{type:"linear",x1:y,y1:0,x2:n+y,y2:0,colors:c},stroke:{width:0}},{shape:{type:"path",path:`M${n+y} 0 L${o} ${a/2} L${n+y} ${a} Z`},fill:c[p].color,stroke:{width:0}}]],L=Ui(h,o,a),{messages:b}=this,C={filter:Qe(i)??void 0,opacity:t==null?void 0:`${t}`},E={justifyContent:"center"};return d("div",{class:v.layerRow,styles:E},d("div",{class:v.rampLabel},s?b[w]:w),d("div",{class:v.symbolContainer},d("div",{styles:C},L),g),d("div",{class:v.rampLabel},s?b[u]:u))}};f([_()],O.prototype,"activeLayerInfos",void 0),f([_()],O.prototype,"headingLevel",void 0),f([_()],O.prototype,"layout",void 0),f([_(),Be("esri/widgets/Legend/t9n/Legend")],O.prototype,"messages",void 0),f([_(),Be("esri/t9n/common")],O.prototype,"messagesCommon",void 0),f([_({readOnly:!0})],O.prototype,"type",void 0),f([_()],O.prototype,"view",void 0),f([Ri()],O.prototype,"_selectSection",null),O=f([ge("esri.widgets.Legend.styles.Card")],O);const je=O,V="esri-legend",S={service:`${V}__service`,label:`${V}__service-label`,layer:`${V}__layer`,groupLayer:`${V}__group-layer`,groupLayerChild:`${V}__group-layer-child`,layerTable:`${V}__layer-table`,layerTableSizeRamp:`${V}__layer-table--size-ramp`,layerChildTable:`${V}__layer-child-table`,layerCaption:`${V}__layer-caption`,layerBody:`${V}__layer-body`,layerRow:`${V}__layer-row`,layerCell:`${V}__layer-cell`,layerInfo:`${V}__layer-cell ${V}__layer-cell--info`,imageryLayerStretchedImage:`${V}__imagery-layer-image--stretched`,imageryLayerCellStretched:`${V}__imagery-layer-cell--stretched`,imageryLayerInfoStretched:`${V}__imagery-layer-info--stretched`,symbolContainer:`${V}__layer-cell esri-legend__layer-cell--symbols`,symbol:`${V}__symbol`,rampContainer:`${V}__ramps`,sizeRamp:`${V}__size-ramp`,colorRamp:`${V}__color-ramp`,opacityRamp:`${V}__opacity-ramp`,borderlessRamp:`${V}__borderless-ramp`,rampTick:`${V}__ramp-tick`,rampFirstTick:`${V}__ramp-tick-first`,rampLastTick:`${V}__ramp-tick-last`,rampLabelsContainer:`${V}__ramp-labels`,rampLabel:`${V}__ramp-label`,univariateAboveAndBelowSymbol:"esri-univariate-above-and-below-ramp__symbol",univariateAboveAndBelowLabel:"esri-univariate-above-and-below-ramp__label",message:`${V}__message`,header:"esri-widget__heading",hidden:"esri-hidden"},al=`${V}__`,nl=24,It={display:"flex",alignItems:"flex-start"},Ge={marginLeft:"3px"},ne={display:"table-cell",verticalAlign:"middle"};let Z=class extends rt{constructor(e,t){super(e,t),this.activeLayerInfos=null,this.headingLevel=3,this.messages=null,this.type="classic"}render(){const e=this.activeLayerInfos,t=e&&e.toArray().map(i=>this._renderLegendForLayer(i)).filter(i=>!!i);return d("div",null,t&&t.length?t:d("div",{class:S.message},this.messages.noLegend))}_renderLegendForLayer(e){if(!e.ready)return null;const t=!!e.children.length,i=`${al}${e.layer.uid}-version-${e.version}`,l=e.title?Me({level:this.headingLevel,class:this.classes(S.header,S.label)},e.title):null;if(t){const s=e.children.map(r=>this._renderLegendForLayer(r)).toArray();return d("div",{key:i,class:this.classes(S.service,S.groupLayer)},l,s)}{const s=e.legendElements;if(s&&!s.length)return null;const r=s.map(n=>this._renderLegendForElement(n,e.layer,e.effectList)).filter(n=>!!n);if(!r.length)return null;const a={[S.groupLayerChild]:!!e.parent};return d("div",{key:i,class:this.classes(S.service,a),tabIndex:0},l,d("div",{class:S.layer},r))}}_renderLegendForElement(e,t,i,l){const s=e.type==="color-ramp",r=e.type==="opacity-ramp",a=e.type==="size-ramp";let n=null;if(e.type==="symbol-table"||a){const g=e.infos.map(w=>this._renderLegendForElementInfo(w,t,i,a,e.legendType)).filter(w=>!!w);g.length&&(n=d("div",{class:S.layerBody},g))}else e.type==="color-ramp"||e.type==="opacity-ramp"||e.type==="heatmap-ramp"||e.type==="stretch-ramp"?n=this._renderLegendForRamp(e,t.opacity):e.type==="relationship-ramp"?n=At(e,this.id,{opacity:t.opacity,effectList:i,ariaLabel:this.messages.previewRelationshipRampAriaLabel}):e.type==="pie-chart-ramp"?n=this._renderPieChartRamp(e):e.type==="univariate-above-and-below-ramp"?n=this._renderUnivariateAboveAndBelowRamp(e,t.opacity,i):e.type==="univariate-color-size-ramp"&&(n=this._renderUnivariateColorSizeRamp(e,t.opacity,i));if(!n)return null;const o=e.title;let y=null;if(typeof o=="string")y=o;else if(o){const g=G(this.messages,o,s||r);y=ii(o,s||r)&&o.title?`${o.title} (${g})`:g}const c=l?S.layerChildTable:S.layerTable,p=y?d("div",{class:S.layerCaption},y):null,m={[S.layerTableSizeRamp]:a||!l};return d("div",{class:this.classes(c,m)},p,n)}_renderPieChartRamp(e){return d("div",{bind:e.preview,afterCreate:k})}_renderUnivariateAboveAndBelowRamp(e,t,i){const{sizeRampElement:l,colorRampElement:s}=ei(e,t);if(!l)return null;const r=this.messages?.previewColorRampAriaLabel,a=fe(l,"above",!0),n=fe(l,"below",!0),o=12,y=me(s,{width:o,height:a,rampAlignment:"vertical",opacity:t,type:"above",effectList:i,ariaLabel:r}),c=me(s,{width:o,height:n,rampAlignment:"vertical",opacity:t,type:"below",effectList:i,ariaLabel:r}),p=Pe(l),m=l.infos.map($=>$.label),g=m.map(($,I)=>I===0?d("div",{key:I,class:$?y?S.univariateAboveAndBelowLabel:S.rampLabel:void 0},$):I===2?d("div",null):null),w=m.length-1,u=Math.floor(m.length/2),h=m.map(($,I)=>I===u||I===w?d("div",{key:I,class:$?y?S.univariateAboveAndBelowLabel:S.rampLabel:void 0},$):null),L={display:"table-cell",verticalAlign:"middle"},b={marginTop:`${p}px`},C={height:`${a}px`},E={height:`${n}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:It},d("div",{class:S.layerBody},l.infos.map(($,I)=>d("div",{class:this.classes(S.layerRow,S.sizeRamp)},d("div",{class:S.symbol,styles:L,bind:$.preview,afterCreate:k}),y||I%2!=0?null:d("div",{class:S.layerInfo},m[I])))),y?d("div",{styles:b,key:"color-ramp-preview"},d("div",{styles:Ge},d("div",{styles:ne},d("div",{class:S.rampContainer,bind:y,afterCreate:k})),d("div",{styles:ne},d("div",{class:S.rampLabelsContainer,styles:C},g))),d("div",{styles:Ge},d("div",{styles:ne},d("div",{class:S.rampContainer,bind:c,afterCreate:k})),d("div",{styles:ne},d("div",{class:S.rampLabelsContainer,styles:E},h)))):null)}_renderUnivariateColorSizeRamp(e,t,i){const{sizeRampElement:l,colorRampElement:s}=ti(e);if(!l)return null;const r=Pe(l),a=12,n=fe(l,"full",!1),o=me(s,{width:a,height:n,rampAlignment:"vertical",opacity:t,type:"full",effectList:i,ariaLabel:this.messages?.previewColorRampAriaLabel}),y=l.infos.length-1,c=l.infos.map((w,u)=>u===0||u===y?d("div",{key:u,class:w.label?s?S.univariateAboveAndBelowLabel:S.rampLabel:void 0},w.label):null),p={display:"table-cell",verticalAlign:"middle"},m={marginTop:`${r}px`},g={height:`${n}px`};return d("div",{key:"univariate-above-and-below-ramp-preview",styles:It},d("div",{class:S.layerBody},l.infos.map(w=>d("div",{class:this.classes(S.layerRow,S.sizeRamp)},d("div",{class:S.symbol,styles:p,bind:w.preview,afterCreate:k})))),d("div",{styles:m,key:"color-ramp-preview"},d("div",{styles:Ge},d("div",{styles:ne},d("div",{class:S.rampContainer,bind:o,afterCreate:k})),d("div",{styles:ne},d("div",{class:S.rampLabelsContainer,styles:g},c)))))}_renderLegendForRamp(e,t){const i=e.infos,l=e.type==="opacity-ramp",s=e.type==="heatmap-ramp",r=e.type==="stretch-ramp",a=e.preview,n=l?S.opacityRamp:"";a.className=`${S.colorRamp} ${n}`,t!=null&&(a.style.opacity=t.toString());const o=i.map(p=>d("div",{class:p.label?S.rampLabel:void 0},s?this.messages[p.label]||p.label:r?this._getStretchStopLabel(p):p.label)),y={width:`${nl}px`},c={height:a.style.height};return d("div",{class:S.layerRow},d("div",{class:S.symbolContainer,styles:y},d("div",{class:S.rampContainer,bind:a,afterCreate:k})),d("div",{class:S.layerInfo},d("div",{class:S.rampLabelsContainer,styles:c},o)))}_getStretchStopLabel(e){return e.label?this.messages[e.label]+": "+(typeof e.value=="string"?e.value:Vt(e.value,{style:"decimal",notation:e.value.toString().includes("e")?"scientific":"standard"})):""}_renderLegendForElementInfo(e,t,i,l,s){if(e.type)return this._renderLegendForElement(e,t,i,!0);let r=null;const a=si(t,s);if(e.preview?r=d("div",{class:S.symbol,bind:e.preview,afterCreate:k}):e.src&&(r=this._renderImage(e,t,a)),!r)return null;const n={[S.imageryLayerInfoStretched]:a},o={[S.imageryLayerInfoStretched]:a,[S.sizeRamp]:!a&&l};return d("div",{class:S.layerRow},d("div",{class:this.classes(S.symbolContainer,o)},r),d("div",{class:this.classes(S.layerInfo,n)},G(this.messages,e.label,!1)||""))}_renderImage(e,t,i){const{label:l,src:s,opacity:r}=e,a={[S.imageryLayerStretchedImage]:i,[S.symbol]:!i},n={opacity:`${r??t.opacity}`};return d("img",{alt:G(this.messages,l,!1),"aria-label":G(this.messages,l,!1),src:s,border:0,width:e.width,height:e.height,class:this.classes(a),styles:n})}};f([_()],Z.prototype,"activeLayerInfos",void 0),f([_()],Z.prototype,"headingLevel",void 0),f([_(),Be("esri/widgets/Legend/t9n/Legend")],Z.prototype,"messages",void 0),f([_({readOnly:!0})],Z.prototype,"type",void 0),Z=f([ge("esri.widgets.Legend.styles.Classic")],Z);const oe=Z,Fe={base:"esri-legend",widget:"esri-widget",panel:"esri-widget--panel",widgetIcon:"esri-icon-layer-list"};let F=class extends rt{constructor(e,t){super(e,t),this.headingLevel=3,this.iconClass=Fe.widgetIcon,this.icon=null,this.messages=null,this.style=new oe,this.viewModel=new Js}initialize(){this.addHandles([ke(()=>this.view,"resize",()=>this.scheduleRender()),ke(()=>this.activeLayerInfos,"change",()=>this._refreshActiveLayerInfos(this.activeLayerInfos)),z(()=>this.headingLevel,e=>{const{style:t}=this;t&&(t.headingLevel=e)}),z(()=>this.style,(e,t)=>{t&&e!==t&&t.destroy(),e&&(e.activeLayerInfos=this.activeLayerInfos,e.type==="card"&&(e.view=this.view),e.headingLevel=this.headingLevel)},pe)])}get activeLayerInfos(){return this.viewModel.activeLayerInfos}set activeLayerInfos(e){this.viewModel.activeLayerInfos=e}get basemapLegendVisible(){return this.viewModel.basemapLegendVisible}set basemapLegendVisible(e){this.viewModel.basemapLegendVisible=e}get groundLegendVisible(){return this.viewModel.groundLegendVisible}set groundLegendVisible(e){this.viewModel.groundLegendVisible=e}get hideLayersNotInCurrentView(){return this.viewModel.hideLayersNotInCurrentView}set hideLayersNotInCurrentView(e){this.viewModel.hideLayersNotInCurrentView=e}get keepCacheOnDestroy(){return this.viewModel.keepCacheOnDestroy}set keepCacheOnDestroy(e){this.viewModel.keepCacheOnDestroy=e}get respectLayerVisibility(){return this.viewModel.respectLayerVisibility}set respectLayerVisibility(e){this.viewModel.respectLayerVisibility=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}castStyle(e){if(e instanceof je||e instanceof oe)return e;if(typeof e=="string")return e==="card"?new je:new oe;if(e&&typeof e.type=="string"){const t={...e};return delete t.type,new(e.type==="card"?je:oe)(t)}return new oe}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){return d("div",{class:this.classes(Fe.base,Fe.widget,this.style instanceof oe?Fe.panel:null)},this.style.render())}_refreshActiveLayerInfos(e){e.forEach(t=>{this.removeHandles(`version_${t.layer.uid}`),this._renderOnActiveLayerInfoChange(t)}),this.scheduleRender()}_renderOnActiveLayerInfoChange(e){const t=z(()=>e.version,()=>this.scheduleRender());this.addHandles(t,`version_${e.layer.uid}`);const i=ke(()=>e.children,"change",()=>e.children.forEach(l=>this._renderOnActiveLayerInfoChange(l)),pe);this.addHandles(i,`version_${e.layer.uid}`),e.children.forEach(l=>this._renderOnActiveLayerInfoChange(l))}};f([_()],F.prototype,"activeLayerInfos",null),f([_()],F.prototype,"basemapLegendVisible",null),f([_()],F.prototype,"groundLegendVisible",null),f([_()],F.prototype,"headingLevel",void 0),f([_()],F.prototype,"hideLayersNotInCurrentView",null),f([_()],F.prototype,"keepCacheOnDestroy",null),f([_()],F.prototype,"respectLayerVisibility",null),f([_()],F.prototype,"iconClass",void 0),f([_()],F.prototype,"icon",void 0),f([_()],F.prototype,"label",null),f([_()],F.prototype,"layerInfos",null),f([_(),Be("esri/widgets/Legend/t9n/Legend")],F.prototype,"messages",void 0),f([_()],F.prototype,"style",void 0),f([Vi("style")],F.prototype,"castStyle",null),f([_()],F.prototype,"view",null),f([_()],F.prototype,"viewModel",void 0),F=f([ge("esri.widgets.Legend")],F);const _l=F;export{_l as default};

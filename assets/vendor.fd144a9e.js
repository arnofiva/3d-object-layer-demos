var uSe=Object.defineProperty,hSe=Object.defineProperties;var dSe=Object.getOwnPropertyDescriptors;var E3=Object.getOwnPropertySymbols;var WZ=Object.prototype.hasOwnProperty,XZ=Object.prototype.propertyIsEnumerable;var qZ=(e,t,i)=>t in e?uSe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i,F=(e,t)=>{for(var i in t||(t={}))WZ.call(t,i)&&qZ(e,i,t[i]);if(E3)for(var i of E3(t))XZ.call(t,i)&&qZ(e,i,t[i]);return e},ve=(e,t)=>hSe(e,dSe(t));var C3=(e,t)=>{var i={};for(var r in e)WZ.call(e,r)&&t.indexOf(r)<0&&(i[r]=e[r]);if(e!=null&&E3)for(var r of E3(e))t.indexOf(r)<0&&XZ.call(e,r)&&(i[r]=e[r]);return i};const DL={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function ble(e){return DL[e]||DL[e.toLowerCase()]}function cH(e){var t;return(t=DL[e])!=null?t:DL[e.toLowerCase()]}function pSe(e){return[...cH(e)]}function WU(e,t,i){i<0&&++i,i>1&&--i;const r=6*i;return r<1?e+(t-e)*r:2*i<1?t:3*i<2?e+(t-e)*(2/3-i)*6:e}function wle(e,t,i,r=1){const s=(e%360+360)%360/360,n=i<=.5?i*(t+1):i+t-i*t,o=2*i-n;return[Math.round(255*WU(o,n,s+1/3)),Math.round(255*WU(o,n,s)),Math.round(255*WU(o,n,s-1/3)),r]}function fSe(e){const t=e.length>5,i=t?8:4,r=(1<<i)-1,s=t?1:17,n=t?e.length===9:e.length===5;let o=Number("0x"+e.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&r,o>>=i,a[3]=s*l/255),l=o&r,o>>=i,a[2]=s*l,l=o&r,o>>=i,a[1]=s*l,l=o&r,o>>=i,a[0]=s*l,a}function O(){return[0,0,0]}function Is(e){return[e[0],e[1],e[2]]}function Fe(e,t,i){return[e,t,i]}function Ya(e){const t=O(),i=Math.min(3,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function uH(e,t){return new Float64Array(e,t,3)}function xle(){return O()}function Tle(){return Fe(1,1,1)}function Sle(){return Fe(1,0,0)}function Ele(){return Fe(0,1,0)}function hH(){return Fe(0,0,1)}const Ta=xle(),of=Tle(),mSe=Sle(),gSe=Ele(),Cle=hH();Object.freeze(Object.defineProperty({__proto__:null,create:O,clone:Is,fromValues:Fe,fromArray:Ya,createView:uH,zeros:xle,ones:Tle,unitX:Sle,unitY:Ele,unitZ:hH,ZEROS:Ta,ONES:of,UNIT_X:mSe,UNIT_Y:gSe,UNIT_Z:Cle},Symbol.toStringTag,{value:"Module"}));const Et=1e-6,Od=Math.random,ySe=Math.PI/180,vSe=180/Math.PI;function XF(e){return e*ySe}function _Se(e){return e*vSe}function bSe(e,t){return Math.abs(e-t)<=Et*Math.max(1,Math.abs(e),Math.abs(t))}Object.freeze(Object.defineProperty({__proto__:null,EPSILON:Et,RANDOM:Od,toRadian:XF,toDegree:_Se,equals:bSe},Symbol.toStringTag,{value:"Module"}));function Me(e){const t=e[0],i=e[1],r=e[2];return Math.sqrt(t*t+i*i+r*r)}function se(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function ie(e,t,i,r){return e[0]=t,e[1]=i,e[2]=r,e}function de(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e}function pe(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e}function YF(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e}function LL(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e}function wSe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e}function xSe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e}function XV(e,t){return e[0]=Math.abs(t[0]),e[1]=Math.abs(t[1]),e[2]=Math.abs(t[2]),e}function Ale(e,t){return e[0]=Math.sign(t[0]),e[1]=Math.sign(t[1]),e[2]=Math.sign(t[2]),e}function Rle(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e}function TSe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e}function SSe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e}function oe(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e}function j1(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e}function nr(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return Math.sqrt(i*i+r*r+s*s)}function $s(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function ba(e){const t=e[0],i=e[1],r=e[2];return t*t+i*i+r*r}function qo(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e}function ESe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e}function we(e,t){const i=t[0],r=t[1],s=t[2];let n=i*i+r*r+s*s;return n>0&&(n=1/Math.sqrt(n),e[0]=t[0]*n,e[1]=t[1]*n,e[2]=t[2]*n),e}function xe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function lt(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];return e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o,e}function en(e,t,i,r){const s=t[0],n=t[1],o=t[2];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e}function CSe(e,t,i,r,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return e[0]=t[0]*a+i[0]*l+r[0]*c+s[0]*h,e[1]=t[1]*a+i[1]*l+r[1]*c+s[1]*h,e[2]=t[2]*a+i[2]*l+r[2]*c+s[2]*h,e}function ASe(e,t,i,r,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return e[0]=t[0]*c+i[0]*h+r[0]*p+s[0]*f,e[1]=t[1]*c+i[1]*h+r[1]*p+s[1]*f,e[2]=t[2]*c+i[2]*h+r[2]*p+s[2]*f,e}function RSe(e,t){t=t||1;const i=2*Od()*Math.PI,r=2*Od()-1,s=Math.sqrt(1-r*r)*t;return e[0]=Math.cos(i)*s,e[1]=Math.sin(i)*s,e[2]=r*t,e}function Ue(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12],e[1]=i[1]*r+i[5]*s+i[9]*n+i[13],e[2]=i[2]*r+i[6]*s+i[10]*n+i[14],e}function ql(e,t,i){const r=t[0],s=t[1],n=t[2];return e[0]=r*i[0]+s*i[3]+n*i[6],e[1]=r*i[1]+s*i[4]+n*i[7],e[2]=r*i[2]+s*i[5]+n*i[8],e}function eu(e,t,i){const r=i[0],s=i[1],n=i[2],o=i[3],a=t[0],l=t[1],c=t[2];let h=s*c-n*l,p=n*a-r*c,f=r*l-s*a,m=s*f-n*p,y=n*h-r*f,v=r*p-s*h;const w=2*o;return h*=w,p*=w,f*=w,m*=2,y*=2,v*=2,e[0]=a+h+m,e[1]=l+p+y,e[2]=c+f+v,e}function MSe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0],n[1]=s[1]*Math.cos(r)-s[2]*Math.sin(r),n[2]=s[1]*Math.sin(r)+s[2]*Math.cos(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function OSe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[2]*Math.sin(r)+s[0]*Math.cos(r),n[1]=s[1],n[2]=s[2]*Math.cos(r)-s[0]*Math.sin(r),e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function PSe(e,t,i,r){const s=[],n=[];return s[0]=t[0]-i[0],s[1]=t[1]-i[1],s[2]=t[2]-i[2],n[0]=s[0]*Math.cos(r)-s[1]*Math.sin(r),n[1]=s[0]*Math.sin(r)+s[1]*Math.cos(r),n[2]=s[2],e[0]=n[0]+i[0],e[1]=n[1]+i[1],e[2]=n[2]+i[2],e}function ISe(e,t){se(A3,e),se(R3,t),we(A3,A3),we(R3,R3);const i=xe(A3,R3);return i>1?0:i<-1?Math.PI:Math.acos(i)}const A3=O(),R3=O();function $Se(e){return"vec3("+e[0]+", "+e[1]+", "+e[2]+")"}function tl(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function Tb(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=t[0],o=t[1],a=t[2];return Math.abs(i-n)<=Et*Math.max(1,Math.abs(i),Math.abs(n))&&Math.abs(r-o)<=Et*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(s-a)<=Et*Math.max(1,Math.abs(s),Math.abs(a))}function Og(e,t,i){const r=i[0]-t[0],s=i[1]-t[1],n=i[2]-t[2];let o=r*r+s*s+n*n;return o>0?(o=1/Math.sqrt(o),e[0]=r*o,e[1]=s*o,e[2]=n*o,e):(e[0]=0,e[1]=0,e[2]=0,e)}const Kl=pe,DSe=YF,LSe=LL,dH=nr,pH=$s,fH=Me,YV=ba,YZ=Object.freeze(Object.defineProperty({__proto__:null,length:Me,copy:se,set:ie,add:de,subtract:pe,multiply:YF,divide:LL,ceil:wSe,floor:xSe,abs:XV,sign:Ale,min:Rle,max:TSe,round:SSe,scale:oe,scaleAndAdd:j1,distance:nr,squaredDistance:$s,squaredLength:ba,negate:qo,inverse:ESe,normalize:we,dot:xe,cross:lt,lerp:en,hermite:CSe,bezier:ASe,random:RSe,transformMat4:Ue,transformMat3:ql,transformQuat:eu,rotateX:MSe,rotateY:OSe,rotateZ:PSe,angle:ISe,str:$Se,exactEquals:tl,equals:Tb,direction:Og,sub:Kl,mul:DSe,div:LSe,dist:dH,sqrDist:pH,len:fH,sqrLen:YV},Symbol.toStringTag,{value:"Module"}));function Pd(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function qi(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function mH(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function Mle(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function Ole(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e[2]=t[2]*i[2],e[3]=t[3]*i[3],e}function Ple(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e[2]=t[2]/i[2],e[3]=t[3]/i[3],e}function NSe(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e[2]=Math.ceil(t[2]),e[3]=Math.ceil(t[3]),e}function FSe(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e[2]=Math.floor(t[2]),e[3]=Math.floor(t[3]),e}function USe(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e[2]=Math.min(t[2],i[2]),e[3]=Math.min(t[3],i[3]),e}function kSe(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e[2]=Math.max(t[2],i[2]),e[3]=Math.max(t[3],i[3]),e}function zSe(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e[2]=Math.round(t[2]),e[3]=Math.round(t[3]),e}function hO(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function VSe(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}function Ile(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return Math.sqrt(i*i+r*r+s*s+n*n)}function NL(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2],n=t[3]-e[3];return i*i+r*r+s*s+n*n}function gH(e){const t=e[0],i=e[1],r=e[2],s=e[3];return Math.sqrt(t*t+i*i+r*r+s*s)}function yH(e){const t=e[0],i=e[1],r=e[2],s=e[3];return t*t+i*i+r*r+s*s}function BSe(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function GSe(e,t){return e[0]=1/t[0],e[1]=1/t[1],e[2]=1/t[2],e[3]=1/t[3],e}function $le(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*i+r*r+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),e[0]=i*o,e[1]=r*o,e[2]=s*o,e[3]=n*o),e}function Dle(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]+e[3]*t[3]}function ZF(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e[2]=o+r*(i[2]-o),e[3]=a+r*(i[3]-a),e}function jSe(e,t){let i,r,s,n,o,a;t=t||1;do i=2*Od()-1,r=2*Od()-1,o=i*i+r*r;while(o>=1);do s=2*Od()-1,n=2*Od()-1,a=s*s+n*n;while(a>=1);const l=Math.sqrt((1-o)/a);return e[0]=t*i,e[1]=t*r,e[2]=t*s*l,e[3]=t*n*l,e}function Qc(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3];return e[0]=i[0]*r+i[4]*s+i[8]*n+i[12]*o,e[1]=i[1]*r+i[5]*s+i[9]*n+i[13]*o,e[2]=i[2]*r+i[6]*s+i[10]*n+i[14]*o,e[3]=i[3]*r+i[7]*s+i[11]*n+i[15]*o,e}function HSe(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2],c=i[3],h=c*r+a*n-l*s,p=c*s+l*r-o*n,f=c*n+o*s-a*r,m=-o*r-a*s-l*n;return e[0]=h*c+m*-o+p*-l-f*-a,e[1]=p*c+m*-a+f*-o-h*-l,e[2]=f*c+m*-l+h*-a-p*-o,e[3]=t[3],e}function qSe(e){return"vec4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function kR(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function Lle(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=Et*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=Et*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=Et*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=Et*Math.max(1,Math.abs(n),Math.abs(c))}const WSe=Mle,XSe=Ole,YSe=Ple,ZSe=Ile,QSe=NL,JSe=gH,KSe=yH,Nle=Object.freeze(Object.defineProperty({__proto__:null,copy:Pd,set:qi,add:mH,subtract:Mle,multiply:Ole,divide:Ple,ceil:NSe,floor:FSe,min:USe,max:kSe,round:zSe,scale:hO,scaleAndAdd:VSe,distance:Ile,squaredDistance:NL,length:gH,squaredLength:yH,negate:BSe,inverse:GSe,normalize:$le,dot:Dle,lerp:ZF,random:jSe,transformMat4:Qc,transformQuat:HSe,str:qSe,exactEquals:kR,equals:Lle,sub:WSe,mul:XSe,div:YSe,dist:ZSe,sqrDist:QSe,len:JSe,sqrLen:KSe},Symbol.toStringTag,{value:"Module"})),ZZ=new Float32Array(1);function wS(e){--e;for(let t=1;t<32;t<<=1)e|=e>>t;return e+1}function $e(e,t,i){return Math.min(Math.max(e,t),i)}function xS(e){return(e&e-1)==0}function Pyt(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}function Iyt(e){return 10**Math.ceil(Math.LOG10E*Math.log(e))}function jt(e,t,i){return e+(t-e)*i}function $t(e){return e*Math.PI/180}function ec(e){return 180*e/Math.PI}function ZV(e,t=1e-6){return(e<0?-1:1)/Math.max(Math.abs(e),t)}function tn(e){return Math.acos($e(e,-1,1))}function Hd(e){return Math.asin($e(e,-1,1))}function e2e(e,t,i=1e-6){if(isNaN(e)||isNaN(t))return!1;if(e===t)return!0;const r=Math.abs(e-t),s=Math.abs(e),n=Math.abs(t);if(e===0||t===0||s<1e-12&&n<1e-12){if(r>.01*i)return!1}else if(r/(s+n)>i)return!1;return!0}function XT(e,t,i=1e-6){return isNaN(e)||isNaN(t)?!1:(e>t?e-t:t-e)<=i}function t2e(e){return Fle(Math.max(-QV,Math.min(e,QV)))}function Fle(e){return ZZ[0]=e,ZZ[0]}function TS(e,t,i){const r=$e((i-e)/(t-e),0,1);return r*r*(3-2*r)}function QZ(e,t){const i=Me(e),r=Hd(e[2]/i),s=Math.atan2(e[1]/i,e[0]/i);return ie(t,i,r,s),t}function $yt(e,t,i){return qi(e,t[0],t[1],t[2],t[3]*i)}function Dyt(e){const t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[3]*e[3]+e[4]*e[4]+e[5]*e[5],r=e[6]*e[6]+e[7]*e[7]+e[8]*e[8];return!(XT(t,1)&&XT(i,1)&&XT(r,1))}const QV=Fle(34028234663852886e22),P_=null;function _(e){return e!=null}function R(e){return e==null}function qs(e,t){return _(e)?t(e):P_}function Lyt(e){return e}function i2e(e,t){if(R(e))throw new Error(t);return e}function yt(e,t){return _(e)?e:typeof t=="function"?t():t}function Nyt(e,t){return _(e)?e:t}function ot(e){return _(e)&&e.destroy(),null}function Ye(e){return _(e)&&e.dispose(),null}function Ds(e){return _(e)&&e.remove(),null}function xh(e){return _(e)&&e.abort(),null}function Wi(e){return _(e)&&e.release(),null}function r2e(e,t,i){return _(e)&&_(t)?_(i)?i(e,t):e.equals(t):e===t}function s2e(e){return null}function Fyt(e,t){const i=new Array;return e.forEach(r=>{const s=t(r);_(s)&&i.push(s)}),i}function Uyt(e,t){const i=new Array;for(const r of e)i.push(Gc(r,null,t));return i}function kyt(e,t){for(const i of e)qs(i,t)}function Gc(e,t,i){return _(e)?i(e):t}function zyt(e){return e.filter(t=>_(t))}function Yr(e,...t){let i=e;for(let r=0;r<t.length&&i;++r)i=i[t[r]];return i}function Vyt(e){return e}let O0;function he(e){return typeof O0[e]=="function"?O0[e]=O0[e](globalThis):O0[e]}var hle,dle,ple,fle;O0=((hle=globalThis.dojoConfig)==null?void 0:hle.has)||((dle=globalThis.esriConfig)==null?void 0:dle.has)?F(F({},(ple=globalThis.dojoConfig)==null?void 0:ple.has),(fle=globalThis.esriConfig)==null?void 0:fle.has):{},he.add=(e,t,i,r)=>((r||O0[e]===void 0)&&(O0[e]=t),i&&he(e)),he.cache=O0,he.add("esri-deprecation-warnings",!0),(()=>{var t;he.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const e=typeof window!="undefined"&&typeof location!="undefined"&&typeof document!="undefined"&&window.location===location&&window.document===document;if(he.add("host-browser",e),he.add("host-node",typeof globalThis.process=="object"&&((t=globalThis.process.versions)==null?void 0:t.node)&&globalThis.process.versions.v8),he.add("dom",e),he("host-browser")){const i=navigator,r=i.userAgent,s=i.appVersion,n=parseFloat(s);if(he.add("wp",parseFloat(r.split("Windows Phone")[1])||void 0),he.add("msapp",parseFloat(r.split("MSAppHost/")[1])||void 0),he.add("khtml",s.includes("Konqueror")?n:void 0),he.add("edge",parseFloat(r.split("Edge/")[1])||void 0),he.add("opr",parseFloat(r.split("OPR/")[1])||void 0),he.add("webkit",!he("wp")&&!he("edge")&&parseFloat(r.split("WebKit/")[1])||void 0),he.add("chrome",!he("edge")&&!he("opr")&&parseFloat(r.split("Chrome/")[1])||void 0),he.add("android",!he("wp")&&parseFloat(r.split("Android ")[1])||void 0),he.add("safari",!s.includes("Safari")||he("wp")||he("chrome")||he("android")||he("edge")||he("opr")?void 0:parseFloat(s.split("Version/")[1])),he.add("mac",s.includes("Macintosh")),!he("wp")&&r.match(/(iPhone|iPod|iPad)/)){const o=RegExp.$1.replace(/P/,"p"),a=r.match(/OS ([\d_]+)/)?RegExp.$1:"1",l=parseFloat(a.replace(/_/,".").replace(/_/g,""));he.add(o,l),he.add("ios",l)}he.add("trident",parseFloat(s.split("Trident/")[1])||void 0),he("webkit")||(!r.includes("Gecko")||he("wp")||he("khtml")||he("trident")||he("edge")||he.add("mozilla",n),he("mozilla")&&he.add("ff",parseFloat(r.split("Firefox/")[1]||r.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const e=navigator.userAgent,t=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(e),i=/iPhone/i.test(e);t&&he.add("esri-mobile",t),i&&he.add("esri-iPhone",i),he.add("esri-geolocation",!!navigator.geolocation)}he.add("esri-canvas-svg-support",!he("trident")),he.add("esri-wasm","WebAssembly"in globalThis),he.add("esri-shared-array-buffer",()=>{const e="SharedArrayBuffer"in globalThis,t=globalThis.crossOriginIsolated===!1;return e&&!t}),he.add("wasm-simd",()=>{const e=[0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11];return WebAssembly.validate(new Uint8Array(e))}),he.add("esri-atomics","Atomics"in globalThis),he.add("esri-workers","Worker"in globalThis),he.add("web-feat:cache","caches"in globalThis),he.add("esri-workers-arraybuffer-transfer",!he("safari")||Number(he("safari"))>=12),he.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),he.add("featurelayer-simplify-payload-size-factors",[1,1,4]),he.add("featurelayer-snapshot-enabled",!0),he.add("featurelayer-snapshot-point-min-threshold",8e4),he.add("featurelayer-snapshot-point-max-threshold",4e5),he.add("featurelayer-snapshot-point-coverage",.1),he.add("featurelayer-advanced-symbols",!1),he.add("featurelayer-pbf",!0),he.add("featurelayer-pbf-statistics",!1),he.add("feature-layers-workers",!0),he.add("feature-polyline-generalization-factor",1),he.add("mapview-transitions-duration",200),he.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),he.add("mapserver-pbf-enabled",!1),he.add("mapimagelayer-popup-identify-max-tolerance",20),he.add("heatmap-allow-raster-fallback",!0),he.add("heatmap-force-raster",!1),he("host-webworker")||he("host-browser")&&(he.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),he.add("esri-image-decode",()=>{if("decode"in new Image){const e=new Image;return e.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void e.decode().then(()=>{he.add("esri-image-decode",!0,!0,!0)}).catch(()=>{he.add("esri-image-decode",!1,!0,!0)})}return!1}),he.add("esri-url-encodes-apostrophe",()=>{const e=window.document.createElement("a");return e.href="?'",e.href.includes("?%27")}))})();class nh{constructor(t=1){this._seed=t}set seed(t){this._seed=t==null?Math.random()*nh._m:t}getInt(){return this._seed=(nh._a*this._seed+nh._c)%nh._m,this._seed}getFloat(){return this.getInt()/(nh._m-1)}getIntRange(t,i){return Math.round(this.getFloatRange(t,i))}getFloatRange(t,i){const r=i-t;return t+this.getInt()/nh._m*r}}nh._m=2147483647,nh._a=48271,nh._c=0;function dO(e,t){return t?e.filter((i,r,s)=>s.findIndex(t.bind(null,i))===r):e.filter((i,r,s)=>s.indexOf(i)===r)}function uv(e,t,i){if(R(e)&&R(t))return!0;if(R(e)||R(t)||e.length!==t.length)return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function vH(e,t){let i=e.length!==t.length;e.length=t.length;for(let r=0;r<t.length;++r)e[r]!==t[r]&&(e[r]=t[r],i=!0);return i}function n2e(e,t,i){let r,s;return i?(r=t.filter(n=>!e.some(o=>i(o,n))),s=e.filter(n=>!t.some(o=>i(o,n)))):(r=t.filter(n=>!e.includes(n)),s=e.filter(n=>!t.includes(n))),{added:r,removed:s}}function o2e(e){return e&&typeof e.length=="number"}function a2e(e,t){const i=e.length;if(i===0)return[];const r=[];for(let s=0;s<i;s+=t)r.push(e.slice(s,s+t));return r}const l2e=!!Array.prototype.fill;function Byt(e,t){if(l2e)return new Array(e).fill(t);const i=new Array(e);for(let r=0;r<e;r++)i[r]=t;return i}function c2e(e,t){t===void 0&&(t=e,e=0);const i=new Array(t-e);for(let r=e;r<t;r++)i[r-e]=r;return i}function Ule(e,t,i){const r=e.length;let s=0,n=r-1;for(;s<n;){const a=s+Math.floor((n-s)/2);t>e[a]?s=a+1:n=a}const o=e[s];return i?t>=e[r-1]?-1:o===t?s:s-1:o===t?s:-1}function kle(e){return e.reduce((t,i)=>t.concat(i||[]),[])}class zle{constructor(){this.last=0}}const Vle=new zle;function Ble(e,t,i,r){r=r||Vle;const s=Math.max(0,r.last-10);for(let o=s;o<i;++o)if(e[o]===t)return r.last=o,o;const n=Math.min(s,i);for(let o=0;o<n;++o)if(e[o]===t)return r.last=o,o;return-1}function QF(e,t,i,r){const s=i==null?e.length:i,n=Ble(e,t,s,r);if(n!==-1)return e[n]=e[s-1],i==null&&e.pop(),t}const Uh=new Set;function u2e(e,t,i=e.length,r=t.length,s,n){if(r===0||i===0)return i;Uh.clear();for(let a=0;a<r;++a)Uh.add(t[a]);s=s||Vle;const o=Math.max(0,s.last-10);for(let a=o;a<i;++a)if(Uh.has(e[a])&&(n&&n.push(e[a]),Uh.delete(e[a]),e[a]=e[i-1],--i,--a,Uh.size===0||i===0))return Uh.clear(),i;for(let a=0;a<o;++a)if(Uh.has(e[a])&&(n&&n.push(e[a]),Uh.delete(e[a]),e[a]=e[i-1],--i,--a,Uh.size===0||i===0))return Uh.clear(),i;return Uh.clear(),i}function h2e(e){return e?(JZ.seed=e,()=>JZ.getFloat()):Math.random}function Gyt(e,t){const i=h2e(t);for(let r=e.length-1;r>0;r--){const s=Math.floor(i()*(r+1)),n=e[r];e[r]=e[s],e[s]=n}return e}const JZ=new nh;function _H(e,t){const i=e.indexOf(t);return i!==-1?(e.splice(i,1),t):null}function d2e(e,t){if(e.forEach)e.forEach(t);else for(let i=0;i<e.length;i++)t(e[i],i,e)}function bH(e,t,i){if(e.slice)return e.slice(t,i);t===void 0?t=0:(t<0&&(t+=e.length),t=Math.min(e.length,Math.max(0,t))),i===void 0?i=e.length:(i<0&&(i+=e.length),i=Math.min(e.length,Math.max(0,i)));const r=Math.max(0,i-t),s=new e.constructor(r);for(let n=0;n<r;n++)s[n]=e[t+n];return s}function pE(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}function p2e(e){return e instanceof Int8Array||e&&e.constructor&&e.constructor.name==="Int8Array"}function C1(e){return e instanceof Uint8Array||e&&e.constructor&&e.constructor.name==="Uint8Array"}function f2e(e){return e instanceof Uint8ClampedArray||e&&e.constructor&&e.constructor.name==="Uint8ClampedArray"}function Gle(e){return e instanceof Int16Array||e&&e.constructor&&e.constructor.name==="Int16Array"}function FL(e){return e instanceof Uint16Array||e&&e.constructor&&e.constructor.name==="Uint16Array"}function jle(e){return e instanceof Int32Array||e&&e.constructor&&e.constructor.name==="Int32Array"}function UL(e){return e instanceof Uint32Array||e&&e.constructor&&e.constructor.name==="Uint32Array"}function Hle(e){return e instanceof Float32Array||e&&e.constructor&&e.constructor.name==="Float32Array"}function qle(e){return e instanceof Float64Array||e&&e.constructor&&e.constructor.name==="Float64Array"}function m2e(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}function M3(e){return R(e)?0:128+e.buffer.byteLength+64}function Wle(e,t){let i;if(t)for(i in e)e.hasOwnProperty(i)&&(e[i]===void 0?delete e[i]:e[i]instanceof Object&&Wle(e[i],!0));else for(i in e)e.hasOwnProperty(i)&&e[i]===void 0&&delete e[i];return e}function te(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=Qle(e);if(_(t))return t;if(Xle(e))return e.clone();if(Yle(e))return e.map(te);if(Zle(e))return e.clone();const i={};for(const r of Object.getOwnPropertyNames(e))i[r]=te(e[r]);return i}function JV(e){if(!e||typeof e!="object"||typeof e=="function")return e;const t=Qle(e);if(_(t))return t;if(Yle(e)){let i=!0;const r=e.map(s=>{const n=JV(s);return s!=null&&n==null&&(i=!1),n});return i?r:null}if(Xle(e))return e.clone();if(!Zle(e)){const i=new(Object.getPrototypeOf(e)).constructor;for(const r of Object.getOwnPropertyNames(e)){const s=e[r],n=JV(s);if(s!=null&&n==null)return null;i[r]=n}return i}return null}function Xle(e){return typeof e.clone=="function"}function Yle(e){return typeof e.map=="function"&&typeof e.forEach=="function"}function Zle(e){return typeof e.notifyChange=="function"&&typeof e.watch=="function"}function KZ(e){if(Object.prototype.toString.call(e)!=="[object Object]")return!1;const t=Object.getPrototypeOf(e);return t===null||t===Object.prototype}function Qle(e){if(p2e(e)||C1(e)||f2e(e)||Gle(e)||FL(e)||jle(e)||UL(e)||Hle(e)||qle(e))return bH(e);if(e instanceof Date)return new Date(e.getTime());if(e instanceof ArrayBuffer)return e.slice(0,e.byteLength);if(e instanceof Map){const t=new Map;return e.forEach((i,r)=>{t.set(r,te(i))}),t}if(e instanceof Set){const t=new Set;return e.forEach(i=>{t.add(te(i))}),t}return null}function wH(e,t){return e===t||typeof e=="number"&&isNaN(e)&&typeof t=="number"&&isNaN(t)||typeof(e||{}).getTime=="function"&&typeof(t||{}).getTime=="function"&&e.getTime()===t.getTime()||!1}function g2e(e,t){return e===t||(e==null||typeof e=="string"?e===t:typeof e=="number"?e===t||typeof t=="number"&&isNaN(e)&&isNaN(t):e instanceof Date?t instanceof Date&&e.getTime()===t.getTime():Array.isArray(e)?Array.isArray(t)&&uv(e,t):e instanceof Set?t instanceof Set&&v2e(e,t):e instanceof Map?t instanceof Map&&_2e(e,t):!!KZ(e)&&KZ(t)&&y2e(e,t))}function y2e(e,t){if(e===null||t===null)return!1;const i=Object.keys(e);if(t===null||Object.keys(t).length!==i.length)return!1;for(const r of i)if(e[r]!==t[r]||!Object.prototype.hasOwnProperty.call(t,r))return!1;return!0}function v2e(e,t){if(e.size!==t.size)return!1;for(const i of e)if(!t.has(i))return!1;return!0}function _2e(e,t){if(e.size!==t.size)return!1;for(const[i,r]of e){const s=t.get(i);if(s!==r||s===void 0&&!t.has(i))return!1}return!0}function Jle(e,t,i=!1){return ece(e,t,i)}function N2(e,t){if(t!=null)return t[e]||Kle(e.split("."),!1,t)}function tc(e,t,i){const r=e.split("."),s=r.pop(),n=Kle(r,!0,i);n&&s&&(n[s]=t)}function Kle(e,t,i){let r=i;for(const s of e){if(r==null)return;if(!(s in r)){if(!t)return;r[s]={}}r=r[s]}return r}function ece(e,t,i){return t?Object.keys(t).reduce((r,s)=>{let n=r[s],o=t[s];return n===o?r:n===void 0?(r[s]=te(o),r):(Array.isArray(o)||Array.isArray(r)?(n=n?Array.isArray(n)?r[s]=n.concat():r[s]=[n]:r[s]=[],o&&(Array.isArray(o)||(o=[o]),i?o.forEach(a=>{n.includes(a)||n.push(a)}):r[s]=o.concat())):o&&typeof o=="object"?r[s]=ece(n,o,i):r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=o),r)},e||{}):e}var mle;const Ii={apiKey:void 0,applicationUrl:(mle=globalThis.location)==null?void 0:mle.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{crossOriginNoCorsDomains:null,httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,priority:"high",proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(Jle(Ii,globalThis.esriConfig,!0),delete Ii.has),!Ii.assetsPath){const e="4.24.5";Ii.assetsPath=`https://js.arcgis.com/${e.slice(0,-2)}/@arcgis/core/assets`}Ii.baseUrl&&console.warn("[esri.config]","baseUrl has been replaced by assetsPath"),Object.defineProperty(Ii,"baseUrl",{set(){console.warn("[esri.config]","baseUrl has been replaced by assetsPath")}}),Ii.request.corsEnabledServers=[],Ii.request.corsEnabledServers.push=function(){return console.warn("[esri.config]","request.corsEnabledServers is not supported and will be removed in a future release. See http://esriurl.com/cors8664"),0};const b2e=/\{([^\}]+)\}/g;function eQ(e){return e==null?"":e}function gf(e,t){return e.replace(b2e,typeof t=="object"?(i,r)=>eQ(N2(r,t)):(i,r)=>eQ(t(r)))}function tce(e,t){return e.replace(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,i=>t&&t.includes(i)?i:`\\${i}`)}function xH(e){let t=0;for(let i=0;i<e.length;i++)t=(t<<5)-t+e.charCodeAt(i),t|=0;return t}function jyt(e){return new DOMParser().parseFromString(e||"","text/html").body.innerText||""}const tQ={info:0,warn:1,error:2,none:3};class me{constructor(t){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},t.level!=null&&(this.level=t.level),t.writer!=null&&(this.writer=t.writer),this._module=t.module,me._loggers[this.module]=this;const i=this.module.lastIndexOf(".");i!==-1&&(this._parent=me.getLogger(this.module.slice(0,i)))}get module(){return this._module}get parent(){return this._parent}error(...t){this._log("error","always",...t)}warn(...t){this._log("warn","always",...t)}info(...t){this._log("info","always",...t)}errorOnce(...t){this._log("error","once",...t)}warnOnce(...t){this._log("warn","once",...t)}infoOnce(...t){this._log("info","once",...t)}errorOncePerTick(...t){this._log("error","oncePerTick",...t)}warnOncePerTick(...t){this._log("warn","oncePerTick",...t)}infoOncePerTick(...t){this._log("info","oncePerTick",...t)}get test(){const t=this;return{loggedMessages:t._loggedMessages,clearLoggedWarnings:()=>t._loggedMessages.warn.clear()}}static get testSingleton(){return{resetLoggers(t={}){const i=me._loggers;return me._loggers=t,i},set throttlingDisabled(t){me._throttlingDisabled=t}}}static getLogger(t){let i=me._loggers[t];return i||(i=new me({module:t})),i}_log(t,i,...r){if(!!this._matchLevel(t)){if(i!=="always"&&!me._throttlingDisabled){const s=this._argsToKey(r),n=this._loggedMessages[t].get(s);if(i==="once"&&n!=null||i==="oncePerTick"&&n&&n>=me._tickCounter)return;this._loggedMessages[t].set(s,me._tickCounter),me._scheduleTickCounterIncrement()}for(const s of Ii.log.interceptors)if(s(t,this.module,...r))return;this._inheritedWriter()(t,this.module,...r)}}_parentWithMember(t,i){let r=this;for(;_(r);){const s=r[t];if(_(s))return s;r=r.parent}return i}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(t,i,...r){console[t](`[${i}]`,...r)}_matchLevel(t){const i=Ii.log.level?Ii.log.level:"warn";return tQ[this._parentWithMember("level",i)]<=tQ[t]}_argsToKey(...t){const i=(r,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]";return xH(JSON.stringify(t,i))}static _scheduleTickCounterIncrement(){me._tickCounterScheduled||(me._tickCounterScheduled=!0,Promise.resolve().then(()=>{me._tickCounter++,me._tickCounterScheduled=!1}))}}me._loggers={},me._tickCounter=0,me._tickCounterScheduled=!1,me._throttlingDisabled=!1;function Ws(e,t){for(const[i,r]of e)if(t(r,i))return!0;return!1}function Hyt(e,t){for(const[i,r]of e)if(t(r,i))return r;return null}function TH(e,t,i){const r=e.get(t);if(r!==void 0)return r;const s=i();return e.set(t,s),s}const YT=me.getLogger("esri.core.Accessor");function w2e(e){return e==null?e:new Date(e)}function x2e(e){return e==null?e:!!e}function pO(e){return e==null?e:e.toString()}function oh(e){return e==null?e:(e=parseFloat(e),isNaN(e)?0:e)}function SH(e){return e==null?e:Math.round(parseFloat(e))}function ice(e){return e&&e.constructor&&e.constructor.__accessorMetadata__!==void 0}function kL(e,t){return t!=null&&e&&!(t instanceof e)}function rce(e){return e&&"isCollection"in e}function iQ(e){return e&&e.Type?typeof e.Type=="function"?e.Type:e.Type.base:null}function T2e(e,t){if(!t||!t.constructor||!rce(t.constructor))return KV(e,t)?t:new e(t);const i=iQ(e.prototype.itemType),r=iQ(t.constructor.prototype.itemType);return i?r?i===r?t:i.prototype.isPrototypeOf(r.prototype)?new e(t):(KV(e,t),t):new e(t):t}function KV(e,t){return!!ice(t)&&(YT.error("Accessor#set","Assigning an instance of '"+(t.declaredClass||"unknown")+"' which is not a subclass of '"+JF(e)+"'"),!0)}function SS(e,t){return t==null?t:rce(e)?T2e(e,t):kL(e,t)?KV(e,t)?t:new e(t):t}function JF(e){return e&&e.prototype&&e.prototype.declaredClass||"unknown"}const S2e=new WeakMap;function E2e(e){switch(e){case Number:return oh;case yr:return SH;case Boolean:return x2e;case String:return pO;case Date:return w2e;default:return TH(S2e,e,()=>SS.bind(null,e))}}function Qr(e,t){const i=E2e(e);return arguments.length===1?i:i(t)}function zR(e,t,i){return arguments.length===1?zR.bind(null,e):t&&(Array.isArray(t)?t.map(r=>e(r,i)):[e(t,i)])}function C2e(e,t){return arguments.length===1?zR(Qr.bind(null,e)):zR(Qr.bind(null,e),t)}function sce(e,t,i){return t!==0&&Array.isArray(i)?i.map(r=>sce(e,t-1,r)):e(i)}function zL(e,t,i){if(arguments.length===2)return zL.bind(null,e,t);if(!i)return i;let r=t,s=i=sce(e,t,i);for(;r>0&&Array.isArray(s);)r--,s=s[0];if(s!==void 0)for(let n=0;n<r;n++)i=[i];return i}function A2e(e,t,i){return arguments.length===2?zL(Qr.bind(null,e),t):zL(Qr.bind(null,e),t,i)}function nce(e){return!!Array.isArray(e)&&!e.some(t=>{const i=typeof t;return!(i==="string"||i==="number"||i==="function"&&e.length>1)})}function e8(e,t){if(arguments.length===2)return e8(e).call(null,t);const i=new Set,r=e.filter(a=>typeof a!="function"),s=e.filter(a=>typeof a=="function");for(const a of e)typeof a!="string"&&typeof a!="number"||i.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(i.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!kL(a,p))?a:(h&&r.length?(n||(n=r.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),YT.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>JF(p)).join(", ")),YT.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):YT.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function qd(e,t){if(arguments.length===2)return qd(e).call(null,t);const i={},r=[],s=[];for(const l in e.typeMap){const c=e.typeMap[l];i[l]=Qr(c),r.push(JF(c)),s.push(l)}const n=()=>`'${r.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof e.key=="string"?l=>l[e.key]:e.key;return l=>{if(e.base&&!kL(e.base,l)||l==null)return l;const c=a(l)||e.defaultKeyValue,h=i[c];if(!h)return YT.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!kL(e.typeMap[c],l))return l;if(typeof e.key=="string"&&!ice(l)){const p={};for(const f in l)f!==e.key&&(p[f]=l[f]);return h(p)}return h(l)}}class yr{}const qyt={native:e=>({type:"native",value:e}),array:e=>({type:"array",value:e}),oneOf:e=>({type:"one-of",values:e})};function R2e(e){if(!e||!("type"in e))return!1;switch(e.type){case"native":case"array":case"one-of":return!0}return!1}function oce(e){switch(e.type){case"native":return Qr(e.value);case"array":return zR(oce(e.value));case"one-of":return M2e(e);default:return null}}function M2e(e){let t=null;return(i,r)=>i8(i,e)?i:(t==null&&(t=t8(e)),YT.error("Accessor#set",`Invalid property value, value needs to be of type ${t}`),r&&(r.valid=!1),null)}function t8(e){switch(e.type){case"native":switch(e.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case yr:return"integer";case Date:return"date";default:return JF(e.value)}case"array":return`array of ${t8(e.value)}`;case"one-of":{const t=e.values.map(i=>t8(i));return`one of ${t.slice(0,t.length-1)} or ${t[t.length-1]}`}}return"unknown"}function i8(e,t){if(e==null)return!0;switch(t.type){case"native":switch(t.value){case Number:case yr:return typeof e=="number";case Boolean:return typeof e=="boolean";case String:return typeof e=="string"}return e instanceof t.value;case"array":return!!Array.isArray(e)&&!e.some(i=>!i8(i,t.value));case"one-of":return t.values.some(i=>i8(e,i))}}function O3(e){return $e(SH(e),0,255)}function P3(e,t,i){return e=Number(e),isNaN(e)?i:e<t?t:e>i?i:e}class an{constructor(t){this.r=255,this.g=255,this.b=255,this.a=1,t&&this.setColor(t)}static blendColors(t,i,r,s=new an){return s.r=Math.round(t.r+(i.r-t.r)*r),s.g=Math.round(t.g+(i.g-t.g)*r),s.b=Math.round(t.b+(i.b-t.b)*r),s.a=t.a+(i.a-t.a)*r,s._sanitize()}static fromRgb(t,i){const r=t.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(r){const s=r[2].split(/\s*,\s*/),n=r[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),an.fromArray(a,i)}return an.fromArray(s.map(a=>parseFloat(a)),i)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return an.fromArray(wle(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),i)}return null}static fromHex(t,i=new an){if(t.length!==4&&t.length!==7||t[0]!=="#")return null;const r=t.length===4?4:8,s=(1<<r)-1;let n=Number("0x"+t.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=r,i[o]=r===4?17*a:a}),i.a=1,i)}static fromArray(t,i=new an){return i._set(Number(t[0]),Number(t[1]),Number(t[2]),Number(t[3])),isNaN(i.a)&&(i.a=1),i._sanitize()}static fromString(t,i){const r=ble(t)?cH(t):null;return r&&an.fromArray(r,i)||an.fromRgb(t,i)||an.fromHex(t,i)}static fromJSON(t){return t&&new an([t[0],t[1],t[2],t[3]/255])}static toUnitRGB(t){return _(t)?[t.r/255,t.g/255,t.b/255]:null}static toUnitRGBA(t){return _(t)?[t.r/255,t.g/255,t.b/255,t.a!=null?t.a:1]:null}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(t){var i,r,s,n;return typeof t=="string"?an.fromString(t,this):Array.isArray(t)?an.fromArray(t,this):(this._set((i=t.r)!=null?i:0,(r=t.g)!=null?r:0,(s=t.b)!=null?s:0,(n=t.a)!=null?n:1),t instanceof an||this._sanitize()),this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const t=this.r.toString(16),i=this.g.toString(16),r=this.b.toString(16);return`#${t.length<2?"0"+t:t}${i.length<2?"0"+i:i}${r.length<2?"0"+r:r}`}toCss(t=!1){const i=this.r+", "+this.g+", "+this.b;return t?`rgba(${i}, ${this.a})`:`rgb(${i})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(t=an.AlphaMode.ALWAYS){const i=O3(this.r),r=O3(this.g),s=O3(this.b);return t===an.AlphaMode.ALWAYS||this.a!==1?[i,r,s,O3(255*this.a)]:[i,r,s]}clone(){return new an(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(t){return _(t)&&t.r===this.r&&t.g===this.g&&t.b===this.b&&t.a===this.a}_sanitize(){return this.r=Math.round(P3(this.r,0,255)),this.g=Math.round(P3(this.g,0,255)),this.b=Math.round(P3(this.b,0,255)),this.a=P3(this.a,0,1),this}_set(t,i,r,s){this.r=t,this.g=i,this.b=r,this.a=s}}an.prototype.declaredClass="esri.Color",function(e){var t;(t=e.AlphaMode||(e.AlphaMode={}))[t.ALWAYS=0]="ALWAYS",t[t.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}(an||(an={}));const qe=an;function KF(e){return e&&(typeof e.on=="function"||typeof e.addEventListener=="function")}function fO(e,t,i){if(!KF(e))throw new TypeError("target is not a Evented or EventTarget object");if("on"in e)return e.on(t,i);if(Array.isArray(t)){const r=t.slice();for(const s of r)e.addEventListener(s,i);return{remove(){for(const s of r)e.removeEventListener(s,i)}}}return e.addEventListener(t,i),{remove(){e.removeEventListener(t,i)}}}function ace(e,t,i){if(!KF(e))throw new TypeError("target is not a Evented or EventTarget object");if("once"in e)return e.once(t,i);const r=fO(e,t,s=>{r.remove(),i.call(e,s)});return{remove(){r.remove()}}}const O2e={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function A1({key:e}){return O2e[e]||e}function ES(e){return Th(()=>e.forEach(t=>_(t)&&t.remove()))}function Th(e){return{remove:()=>{e&&(e(),e=void 0)}}}function Wyt(e){return Th(_(e)?()=>e.destroy():void 0)}function P2e(e,t){const i=setTimeout(e,t);return Th(()=>clearTimeout(i))}function I2e(e){return{setTimeout:(t,i)=>{const r=e.setTimeout(t,i);return{remove:()=>e.clearTimeout(r)}}}}const e4=I2e(globalThis),rQ=new Set;function $2e(e,t,i=!1){i&&rQ.has(t)||(i&&rQ.add(t),e.warn(`\u{1F6D1} DEPRECATED - ${t}`))}function D2e(e,t,i={}){if(he("esri-deprecation-warnings")){const{moduleName:r}=i;lce(e,`Property: ${(r?r+"::":"")+t}`,i)}}function lce(e,t,i={}){if(he("esri-deprecation-warnings")){const{replacement:r,version:s,see:n,warnOnce:o}=i;let a=t;r&&(a+=`
	\u{1F6E0}\uFE0F Replacement: ${r}`),s&&(a+=`
	\u2699\uFE0F Version: ${s}`),n&&(a+=`
	\u{1F517} See ${n} for more details.`),$2e(e,a,o)}}function L2e(e,t){return e.replace(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,(i,r)=>{if(r==="")return"$";const s=N2(r,t),n=s==null?"":s;if(n===void 0)throw new Error(`could not find key "${r}" in template`);return n.toString()})}class t4{constructor(t,i,r){this.name=t,this.details=r,this.message=void 0,this instanceof t4&&(this.message=i&&L2e(i,r)||"")}toString(){return"["+this.name+"]: "+this.message}}class q extends t4{constructor(t,i,r){if(super(t,i,r),!(this instanceof q))return new q(t,i,r)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(t,i)=>{if(i&&typeof i=="object"&&typeof i.toJSON=="function")return i;try{return te(i)}catch{return"[object]"}}))}}catch(t){throw me.getLogger("esri.core.Error").error(t),t}return{name:this.name,message:this.message,details:this.details}}static fromJSON(t){return new q(t.name,t.message,t.details)}}q.prototype.type="error";function ui(e="Aborted"){return new q("AbortError",e)}function li(e,t="Aborted"){if(Xs(e))throw ui(t)}function i4(e){return _(e)?"aborted"in e?e:e.signal:e}function Xs(e){const t=i4(e);return _(t)&&t.aborted}function Pg(e){if(Gr(e))throw e}function r8(e){if(!Gr(e))throw e}function Wo(e,t){const i=i4(e);if(!R(i)){if(!i.aborted)return ace(i,"abort",()=>t());t()}}function r4(e,t){const i=i4(e);if(!R(i))return li(i),ace(i,"abort",()=>t(ui()))}function N2e(e,t){const i=i4(t);return R(i)?e:new Promise((r,s)=>{let n=Wo(t,()=>s(ui()));const o=()=>n=Ds(n);e.then(o,o),e.then(r,s)})}function Gr(e){return e&&e.name==="AbortError"}async function s8(e){try{return await e}catch(t){if(!Gr(t))throw t}}async function Xyt(e,t=me.getLogger("esri")){try{return await e}catch(i){Gr(i)||t.error(i)}}function hv(){let e=null;const t=new Promise((i,r)=>{e={promise:void 0,resolve:i,reject:r}});return e.promise=t,e}async function pn(e){if(!e)return;if(typeof e.forEach!="function"){const i=Object.keys(e),r=i.map(o=>e[o]),s=await pn(r),n={};return i.map((o,a)=>n[o]=s[a]),n}const t=e;return new Promise(i=>{const r=[];let s=t.length;s===0&&i(r),t.forEach(n=>{const o={promise:n||Promise.resolve(n)};r.push(o),o.promise.then(a=>{o.value=a}).catch(a=>{o.error=a}).then(()=>{--s,s===0&&i(r)})})})}async function F2e(e){return(await pn(e)).filter(t=>!!t.value).map(t=>t.value)}function CS(e,t,i){const r=new AbortController;return Wo(i,()=>r.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(t)},e);Wo(r,()=>{o&&(clearTimeout(o),n(ui()))})})}function vu(e){return e&&typeof e.then=="function"}function n8(e){return vu(e)?e:Promise.resolve(e)}function EH(e,t=-1){let i,r,s,n,o=null;const a=(...l)=>{if(i){r=l,n&&n.reject(ui()),n=hv();const f=n.promise;if(o){const m=o;o=null,m.abort()}return f}if(s=n||hv(),n=null,t>0){const f=new AbortController;i=n8(e(...l,f.signal));const m=i;CS(t).then(()=>{i===m&&(n?f.abort():o=f)})}else i=1,i=n8(e(...l));const c=()=>{const f=r;r=s=i=o=null,f!=null&&a(...f)},h=i,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function Wd(){let e,t;const i=new Promise((s,n)=>{e=s,t=n}),r=s=>{e(s)};return r.resolve=s=>e(s),r.reject=s=>t(s),r.timeout=(s,n)=>e4.setTimeout(()=>r.reject(n),s),r.promise=i,r}function Yyt(e,t){return e.then(t,t)}function mO(e,t){let i,r=new AbortController;const s=e(r.signal);let n={promise:s,finished:!1,abort:()=>{r&&(r.abort(),r=null)}};const o=()=>{n&&(n.finished=!0,n=null),_(i)&&(i.remove(),i=null),r=null};return s.then(o,o),i=Wo(t,()=>{_(n)&&n.abort()}),n}async function sQ(e){await Promise.resolve(),li(e)}function U2e(e){return e&&e.release&&typeof e.release=="function"}function k2e(e){return e&&e.acquire&&typeof e.acquire=="function"}class ys{constructor(t,i,r,s=1,n=0){if(this.ctor=t,this.acquireFunction=i,this.releaseFunction=r,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this.ctor)for(let o=0;o<n;o++)this._pool[o]=new this.ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...t){let i;if(ys.test.disabled)i=new this.ctor;else{if(this._pool.length===0){const r=this.allocationSize;for(let s=0;s<r;s++)this._pool[s]=new this.ctor}i=this._pool.pop()}return this.acquireFunction?this.acquireFunction(i,...t):k2e(i)&&i.acquire(...t),i}release(t){t&&!ys.test.disabled&&(this.releaseFunction?this.releaseFunction(t):U2e(t)&&t.release(),this._pool.push(t))}prune(t=this._initialSize){if(!(t>=this._pool.length)){for(let i=t;i<this._pool.length;++i){const r=this._pool[i];this._dispose(r)}this._pool.length=t}}_dispose(t){t.dispose&&typeof t.dispose=="function"&&t.dispose()}}ys.test={disabled:!1};function z2e(e){e.length=0}class Vl{constructor(t=50,i=50){this._pool=new ys(Array,void 0,z2e,i,t)}acquire(){return this._pool.acquire()}release(t){this._pool.release(t)}prune(){this._pool.prune(0)}static acquire(){return XU.acquire()}static release(t){return XU.release(t)}static prune(){XU.prune()}}const XU=new Vl(100);class cce extends ys{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=s2e(this._set)}acquire(...t){const i=super.acquire(...t);return this._set.delete(i),i}release(t){t&&!this._set.has(t)&&(super.release(t),this._set.add(t))}_dispose(t){this._set.delete(t),super._dispose(t)}}const I3=[];function AS(e){I3.push(e),I3.length===1&&queueMicrotask(()=>{const t=I3.slice();I3.length=0;for(const i of t)i()})}const V2e=29;class Q0{constructor(t,i=V2e){this.name=t,this._counter=0,this._items=new Array(i)}record(t){this._items[++this._counter%this._items.length]=t}get median(){return this._items.slice().sort((t,i)=>t-i)[Math.floor(this._items.length/2)]}get average(){return this._items.reduce((t,i)=>t+i,0)/this._items.length}get last(){return this._items[this._counter%this._items.length]}}var o8;(function(e){const t=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const m=n[h-1];if(l(m,f)<=0)break;n[c-1]=m,c=h}n[c-1]=f},i=(n,o)=>n<o?-1:n>o?1:0;function r(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=i);for(let h=a>>>1;h>o;h--)t(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,t(n,c,h,l),yield}}e.sort=r,e.iterableSort=s})(o8||(o8={}));const nQ=o8,B2e=1.5,G2e=1.1;class Bt{constructor(t){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new zle,t&&(t.initialSize&&(this.data=new Array(t.initialSize)),t.allocator&&(this._allocator=t.allocator),t.deallocator!==void 0&&(this._deallocator=t.deallocator),t.shrink&&(this._shrink=()=>oQ(this)))}toArray(){return this.data.slice(0,this.length)}filter(t){const i=new Array;for(let r=0;r<this._length;r++){const s=this.data[r];t(s)&&i.push(s)}return i}getItemAt(t){if(!(t<0||t>=this._length))return this.data[t]}includes(t,i){const r=this.data.indexOf(t,i);return r!==-1&&r<this.length}get length(){return this._length}set length(t){if(t>this._length){if(this._allocator){for(;this._length<t;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=t}else{if(this._deallocator)for(let i=t;i<this._length;++i)this.data[i]=this._deallocator(this.data[i]);this._length=t,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(t){this.data[this._length++]=t}pushArray(t,i=t.length){for(let r=0;r<i;r++)this.data[this._length++]=t[r]}fill(t,i){for(let r=0;r<i;r++)this.data[this._length++]=t}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const t=this.data[this._length];return++this._length,t}unshift(t){this.data.unshift(t),this._length++,oQ(this)}pop(){if(this.length===0)return;const t=this.data[this.length-1];return this.length=this.length-1,this._shrink(),t}remove(t){const i=Ble(this.data,t,this.length,this._hint);if(i!==-1)return this.data.splice(i,1),this.length=this.length-1,t}removeUnordered(t){const i=QF(this.data,t,this.length,this._hint);return i!==void 0&&(this.length=this.length-1),this._shrink(),i}removeUnorderedIndex(t){if(!(t>=this.length||t<0))return this.swapElements(t,this.length-1),this.pop()}removeUnorderedMany(t,i=t.length,r){this.length=u2e(this.data,t,this.length,i,this._hint,r),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(t,i){t>=this.length||i>=this.length||t===i||([this.data[t],this.data[i]]=[this.data[i],this.data[t]])}sort(t){nQ.sort(this.data,0,this.length,t)}iterableSort(t){return nQ.iterableSort(this.data,0,this.length,t)}some(t,i){for(let r=0;r<this.length;++r)if(t.call(i,this.data[r],r,this.data))return!0;return!1}filterInPlace(t,i){let r=0;for(let s=0;s<this._length;++s){const n=this.data[s];t.call(i,n,s,this.data)&&(this.data[s]=this.data[r],this.data[r]=n,r++)}if(this._deallocator)for(let s=r;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=r,this._shrink(),this}forAll(t,i){const r=this.length,s=this.data;for(let n=0;n<r;++n)t.call(i,s[n],n,s)}forEach(t,i){for(let r=0;r<this.length;++r)t.call(i,this.data[r],r,this.data)}map(t,i){const r=new Array(this.length);for(let s=0;s<this.length;++s)r[s]=t.call(i,this.data[s],s,this.data);return r}reduce(t,i){let r=i;for(let s=0;s<this.length;++s)r=t(r,this.data[s],s,this.data);return r}has(t){const i=this.length,r=this.data;for(let s=0;s<i;++s)if(r[s]===t)return!0;return!1}}function oQ(e){e.data.length>B2e*e.length&&(e.data.length=Math.floor(e.length*G2e))}function uce(e){return 1e3*e}function CH(e){return .001*e}class j2e{constructor(t){this.phases=t,this.paused=!1,this.ticks=-1,this.removed=!1}}class H2e{constructor(t){this.callback=t,this.isActive=!0}remove(){this.isActive=!1}}let a8=0,l8=0;const fE={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},c8=["prepare","preRender","render","postRender","update","finish"],u8=[],Sb=new Bt;class q2e{constructor(t){this._task=t}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}}const VL={frameTasks:Sb,willDispatch:!1,clearFrameTasks:W2e,dispatch:pce,executeFrameTasks:Y2e};function F2(e){const t=new H2e(e);return u8.push(t),VL.willDispatch||(VL.willDispatch=!0,AS(pce)),t}function Eb(e){const t=new j2e(e);return Sb.push(t),BL==null&&(a8=performance.now(),BL=requestAnimationFrame(hce)),new q2e(t)}let BL=null;function W2e(e=!1){Sb.forAll(t=>{t.removed=!0}),e&&dce()}function X2e(e){l8=Math.max(0,e)}function hce(){const e=performance.now();BL=null,BL=Sb.length>0?requestAnimationFrame(hce):null,VL.executeFrameTasks(e)}function Y2e(e){const t=e-a8;a8=e;const i=l8>0?l8:1e3/60,r=Math.max(0,t-i);for(let s=0;s<c8.length;s++){const n=performance.now(),o=c8[s];Sb.forAll(a=>{var l;a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(fE.time=e,fE.deltaTime=a.ticks===0?0:t,fE.elapsedFrameTime=performance.now()-e,fE.frameDuration=i-r,(l=a.phases[o])==null||l.call(a,fE)))}),Z2e[s].record(performance.now()-n)}dce(),Q2e.record(performance.now()-e)}const $3=new Bt;function dce(){Sb.forAll(e=>{e.removed&&$3.push(e)}),Sb.removeUnorderedMany($3.data,$3.length),$3.clear()}function pce(){for(;u8.length;){const e=u8.shift();e.isActive&&e.callback()}VL.willDispatch=!1}function Zyt(e=1,t){const i=Wd(),r=()=>{Xs(t)?i.reject(ui()):e===0?i():(--e,AS(()=>r()))};return r(),i.promise}const Z2e=c8.map(e=>new Q0(e)),Q2e=new Q0("total");function C$(e,t){for(const i of e.entries())if(t(i[0]))return!0;return!1}let J2e=0;const K2e=0;function sl(){return++J2e}function Ea(e){return e?e.__accessor__?e.__accessor__:e.propertyInvalidated?e:null:null}function eEe(e,t){return e!=null&&e.metadatas&&e.metadatas[t]!=null}function A$(e,t,i){return i?GL(e,t,{policy:i,path:""}):GL(e,t,null)}function GL(e,t,i){return t?Object.keys(t).reduce((r,s)=>{let n=null,o="merge";if(i&&(n=i.path?`${i.path}.${s}`:s,o=i.policy(n)),o==="replace")return r[s]=t[s],r;if(r[s]===void 0)return r[s]=te(t[s]),r;let a=r[s],l=t[s];if(a===l)return r;if(Array.isArray(l)||Array.isArray(r))a=a?Array.isArray(a)?r[s]=a.concat():r[s]=[a]:r[s]=[],l&&(Array.isArray(l)||(l=[l]),l.forEach(c=>{a.includes(c)||a.push(c)}));else if(l&&typeof l=="object")if(i){const c=i.path;i.path=n,r[s]=GL(a,l,i),i.path=c}else r[s]=GL(a,l,null);else r.hasOwnProperty(s)&&!t.hasOwnProperty(s)||(r[s]=l);return r},e||{}):e}function fce(e){return Array.isArray(e)?e:e.split(".")}function aQ(e){return e.includes(",")?e.split(",").map(t=>t.trim()):[e.trim()]}function tEe(e){if(Array.isArray(e)){const t=[];for(const i of e)t.push(...aQ(i));return t}return aQ(e)}function mce(e,t,i,r){const s=tEe(t);if(s.length!==1){const n=s.map(o=>r(e,o,i));return ES(n)}return r(e,s[0],i)}function AH(e){let t=!1;return()=>{t||(t=!0,e())}}function gce(e,t){const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const s=parseInt(i,10);if(!isNaN(s))return Array.isArray(t)?t[s]:t.getItemAt(s)}const r=Ea(t);return eEe(r,i)?r.get(i):t[i]}function yce(e,t,i){if(e==null)return e;const r=gce(t[i],e);return!r&&i<t.length-1?void 0:i===t.length-1?r:yce(r,t,i+1)}function gO(e,t,i=0){return typeof t!="string"||t.includes(".")?yce(e,fce(t),i):gce(t,e)}function jL(e,t){return gO(e,t)}function lQ(e,t){return gO(t,e)!==void 0}var fr;(function(e){e[e.Dirty=1]="Dirty",e[e.Overriden=2]="Overriden",e[e.Computing=4]="Computing",e[e.NonNullable=8]="NonNullable",e[e.HasDefaultValue=16]="HasDefaultValue",e[e.DepTrackingInitialized=32]="DepTrackingInitialized",e[e.AutoTracked=64]="AutoTracked",e[e.ExplicitlyTracking=128]="ExplicitlyTracking"})(fr||(fr={}));let HL,RC=[];const iEe=me.getLogger("esri.core.Accessor");function Yt(e){HL!==void 0&&HL.onObservableAccessed(e)}let R$=!1,M$=!1;function gg(e,t,i){if(R$)return RH(e,t,i);vce(e);const r=t.call(i);return _ce(),r}function rEe(e,t){return gg(void 0,e,t)}function RH(e,t,i){const r=R$;R$=!0,vce(e);let s=null;try{s=t.call(i)}catch(n){M$&&iEe.error(n)}return _ce(),R$=r,s}function vce(e){HL=e,RC.push(e)}function _ce(){const e=RC.pop();HL=RC.length>0?RC[RC.length-1]:void 0,e!==void 0&&e.onTrackingEnd()}function bce(e,t){if(t.flags&fr.DepTrackingInitialized)return;const i=M$;M$=!1,t.flags&fr.AutoTracked?RH(t,t.metadata.get,e):wce(e,t),M$=i}const sEe=[];function wce(e,t){t.flags&fr.ExplicitlyTracking||(t.flags|=fr.ExplicitlyTracking,RH(t,()=>{const i=t.metadata.dependsOn||sEe;for(const r of i)if(typeof r!="string"||r.includes(".")){const s=fce(r);for(let n=0,o=e;n<s.length&&o!=null&&typeof o=="object";++n)o=cQ(o,s[n],n!==s.length-1)}else cQ(e,r,!1)}),t.flags&=~fr.ExplicitlyTracking)}function cQ(e,t,i){var n;const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const o=parseInt(r,10);if(!isNaN(o))return Array.isArray(e)?e[o]:e.getItemAt(o)}const s=(n=Ea(e))==null?void 0:n.properties.get(r);return s&&(Yt(s),bce(e,s)),i?e[r]:void 0}class s4{constructor(t){this._notify=t,this._accessed=[],this._handles=[],this._invalidCount=0}destroy(){this._accessed.length=0,this.clear()}onInvalidated(){this._invalidCount++}onCommitted(){const t=this._invalidCount;if(t===1)return this._invalidCount=0,void this._notify();this._invalidCount=t>0?t-1:0}onObservableAccessed(t){this._accessed.includes(t)||this._accessed.push(t)}onTrackingEnd(){const t=this._handles,i=this._accessed;for(let r=0;r<i.length;++r)t.push(i[r].observe(this));i.length=0}clear(){const t=this._handles;for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}let ZT=!1;const qL=[];function xce(e,t){let i=new s4(n),r=null,s=!1;function n(){if(!i||s)return;if(ZT)return void Ece(n);const a=r;i.clear(),ZT=!0,s=!0,r=gg(i,e),s=!1,ZT=!1,t(r,a),Cce()}function o(){i&&(i.destroy(),i=null,r=null)}return s=!0,r=gg(i,e),s=!1,{remove:o}}function Tce(e,t){let i=new s4(s),r=null;function s(){t(r,o)}function n(){i&&(i.destroy(),i=null),r=null}function o(){return i?(i.clear(),r=gg(i,e),r):null}return o(),{remove:n}}function Sce(e){let t=new s4(r),i=!1;function r(){t&&!i&&(ZT?Ece(r):(t.clear(),ZT=!0,i=!0,gg(t,e),i=!1,ZT=!1,Cce()))}function s(){t&&(t.destroy(),t=null)}return i=!0,gg(t,e),i=!1,{remove:s}}function Ece(e){qL.includes(e)||qL.unshift(e)}function Cce(){for(;qL.length;)qL.pop()()}var qA;(function(e){e[e.Untracked=0]="Untracked",e[e.Tracked=1]="Tracked"})(qA||(qA={}));class VR{constructor(){this.uid=sl(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(t,i,r,s,n){return this.pool.acquire(qA.Untracked,t,i,r,s,n,wH)}static acquireTracked(t,i,r,s){return this.pool.acquire(qA.Tracked,t,i,r,null,null,s)}notify(t,i){this.type===qA.Untracked?this.callback.call(this.target,t,i,this.path,this.target):this.callback.call(null,t,i)}acquire(t,i,r,s,n,o,a){this.uid=sl(),this.removed=!1,this.type=t,this.oldValue=i,this.callback=r,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=sl(),this.removed=!0}}VR.pool=new cce(VR);const O$=new Vl,ig=new Set;let WL;function XL(e){ig.delete(e),ig.add(e),WL||(WL=F2(aEe))}function nEe(e){if(e.removed)return;const t=e.oldValue,i=e.getValue();e.equals(t,i)||(e.oldValue=i,e.notify(i,t))}function oEe(e){for(const t of ig.values())t.target===e&&(t.removed=!0)}function aEe(){let e=10;for(;WL&&e--;){WL=null;const t=lEe(),i=O$.acquire();for(const r of t){const s=r.uid;nEe(r),s===r.uid&&r.removed&&i.push(r)}for(const r of ig)r.removed&&(i.push(r),ig.delete(r));for(const r of i)VR.pool.release(r);O$.release(i),O$.release(t),h8.forEach(r=>r())}}function lEe(){const e=O$.acquire();e.length=ig.size;let t=0;for(const i of ig)e[t]=i,++t;return ig.clear(),e}const h8=new Set;function Ace(e){return h8.add(e),{remove(){h8.delete(e)}}}function cEe(e,t,i){let r=mce(e,t,i,(s,n,o)=>{let a,l,c=Tce(()=>gO(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?r.remove():(a||(a=VR.acquireUntracked(h,o,p,s,n),l=a.uid),XL(a))});return{remove:AH(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,XL(a)),a=null),r=c=null})}});return r}function uEe(e,t,i){const r=mce(e,t,i,(s,n,o)=>{let a=!1;return xce(()=>gO(s,n),(l,c)=>{s.__accessor__.destroyed?r.remove():a||(a=!0,wH(c,l)||o.call(s,l,c,n,s),a=!1)})});return r}function hEe(e,t,i,r=!1){return!e.__accessor__||e.__accessor__.destroyed?{remove(){}}:r?uEe(e,t,i):cEe(e,t,i)}function dEe(e,t,i){let r,s,n=Tce(e,(o,a)=>{r&&r.uid!==s?n.remove():(r||(r=VR.acquireTracked(o,t,a,i),s=r.uid),XL(r))});return{remove:AH(()=>{n.remove(),r&&(r.uid!==s||r.removed||(r.removed=!0,XL(r)),r=null),n=null})}}function pEe(e,t,i){let r=!1;return xce(e,(s,n)=>{r||(r=!0,i(n,s)||t(s,n),r=!1)})}function fEe(e,t,i=!1,r=g2e){return i?pEe(e,t,r):dEe(e,t,r)}function uQ(e){return C$(ig,t=>t.oldValue===e)}function ae(e,t,i={}){return MH(e,t,i,Rce)}function cl(e,t,i={}){return MH(e,t,i,Mce)}function MH(e,t,i={},r){let s=null;const n=i.once?(o,a)=>{r(o)&&(Ds(s),t(o,a))}:(o,a)=>{r(o)&&t(o,a)};if(s=fEe(e,n,i.sync,i.equals),i.initial){const o=e();n(o,o)}return s}function eo(e,t,i,r={}){let s=null,n=null,o=null;function a(){var h;s&&n&&(n.remove(),(h=r.onListenerRemove)==null||h.call(r,s),s=null,n=null)}function l(h){r.once&&r.once&&Ds(o),i(h)}const c=ae(e,(h,p)=>{var f;a(),KF(h)&&(s=h,n=fO(h,t,l),(f=r.onListenerAdd)==null||f.call(r,h))},{sync:r.sync,initial:!0});return o=Th(()=>{c.remove(),a()}),o}function BR(e,t){return mEe(e,Mce,t)}function mEe(e,t,i){if(Xs(i))return Promise.reject(ui());const r=e();if(t==null?void 0:t(r))return Promise.resolve(r);let s=null;function n(){s=Ds(s)}return new Promise((o,a)=>{s=ES([Wo(i,()=>{n(),a(ui())}),MH(e,l=>{n(),o(l)},{sync:!1,once:!0},t!=null?t:Rce)])})}function Rce(e){return!0}function Mce(e){return!!e}const rr={sync:!0},Ft={initial:!0},Ms={sync:!0,initial:!0};function u(e,t,i,r){var s,n=arguments.length,o=n<3?t:r===null?r=Object.getOwnPropertyDescriptor(t,i):r;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(e,t,i,r);else for(var a=e.length-1;a>=0;a--)(s=e[a])&&(o=(n<3?s(o):n>3?s(t,i,o):s(t,i))||o);return n>3&&o&&Object.defineProperty(t,i,o),o}function Qyt(e){const t=[];return function*(){yield*t;for(const i of e)t.push(i),yield i}}function Jyt(e,t){for(const i of e)if(i!=null&&t(i))return i}function Oce(e){return e!=null&&typeof e[Symbol.iterator]=="function"}var ef;(function(e){e[e.INITIALIZING=0]="INITIALIZING",e[e.CONSTRUCTING=1]="CONSTRUCTING",e[e.CONSTRUCTED=2]="CONSTRUCTED"})(ef||(ef={}));class hQ{constructor(t){this.autoDestroy=!1,this.properties=t}}function yO(e){let t=e.constructor.__accessorMetadata__;const i=Object.prototype.hasOwnProperty.call(e.constructor,"__accessorMetadata__");if(t){if(!i){const r=Object.create(t.properties),s=t.autoDestroy;for(const n in r)r[n]=te(r[n]);t=new hQ(r),t.autoDestroy=s,Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0})}}else t=new hQ({}),Object.defineProperty(e.constructor,"__accessorMetadata__",{value:t,enumerable:!1,configurable:!0,writable:!0});return e.constructor.__accessorMetadata__}function gEe(e){return yO(e).properties}function n4(e,t){const i=gEe(e);let r=i[t];return r||(r=i[t]={}),r}function yEe(e,t){return A$(e,t,_Ee)}const vEe=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function _Ee(e){return vEe.test(e)?"replace":"merge"}var Si;(function(e){e[e.DEFAULTS=0]="DEFAULTS",e[e.COMPUTED=1]="COMPUTED",e[e.SERVICE=2]="SERVICE",e[e.PORTAL_ITEM=3]="PORTAL_ITEM",e[e.WEB_SCENE=4]="WEB_SCENE",e[e.WEB_MAP=5]="WEB_MAP",e[e.USER=6]="USER"})(Si||(Si={}));const d8=Si.USER+1;function P0(e){switch(e){case"defaults":return Si.DEFAULTS;case"service":return Si.SERVICE;case"portal-item":return Si.PORTAL_ITEM;case"web-scene":return Si.WEB_SCENE;case"web-map":return Si.WEB_MAP;case"user":return Si.USER}}function YL(e){switch(e){case Si.DEFAULTS:return"defaults";case Si.SERVICE:return"service";case Si.PORTAL_ITEM:return"portal-item";case Si.WEB_SCENE:return"web-scene";case Si.WEB_MAP:return"web-map";case Si.USER:return"user"}return void 0}function bEe(e){return YL(e)}class Pce{constructor(t,i){this._observers=t,this._observer=i}remove(){_H(this._observers,this._observer)}}class dQ{constructor(t,i,r){this.properties=t,this.propertyName=i,this.metadata=r,this._observers=null,this._accessed=null,this._handles=null,this.flags=fr.Dirty|(r.nonNullable?fr.NonNullable:0)|(r.hasOwnProperty("value")?fr.HasDefaultValue:0)|(r.get===void 0?fr.DepTrackingInitialized:0)|(r.dependsOn===void 0?fr.AutoTracked:0)}destroy(){if(this.flags&fr.Dirty&&this._observers){const t=this._observers.slice();for(const i of t)i.onCommitted()}this._accessed=null,this._observers=null,this._clearObservationHandles()}getComputed(){Yt(this);const t=this.properties.store,i=this.propertyName,r=this.flags,s=t.get(i);if(r&fr.Computing||~r&fr.Dirty&&t.has(i))return s;this.flags|=fr.Computing;const n=this.properties.host;let o;r&fr.AutoTracked?o=gg(this,this.metadata.get,n):(wce(n,this),o=this.metadata.get.call(n)),t.set(i,o,Si.COMPUTED);const a=t.get(i);return a===s?this.flags&=~fr.Dirty:rEe(this.commit,this),this.flags&=~fr.Computing,a}onObservableAccessed(t){t!==this&&(this._accessed===null&&(this._accessed=[]),this._accessed.includes(t)||this._accessed.push(t))}onTrackingEnd(){this._clearObservationHandles(),this.flags|=fr.DepTrackingInitialized;const t=this._accessed;if(t===null)return;let i=this._handles;i===null&&(i=this._handles=[]);for(let r=0;r<t.length;++r)i.push(t[r].observe(this));t.length=0}observe(t){return this._observers===null&&(this._observers=[]),this._observers.includes(t)||this._observers.push(t),new Pce(this._observers,t)}notifyChange(){this.onInvalidated(),this.onCommitted()}invalidate(){this.onInvalidated()}onInvalidated(){~this.flags&fr.Overriden&&(this.flags|=fr.Dirty);const t=this._observers;if(t!==null)for(let i=0;i<t.length;++i)t[i].onInvalidated()}commit(){this.flags&=~fr.Dirty,this.onCommitted()}onCommitted(){if(this._observers===null)return;const t=this._observers.slice();for(let i=0;i<t.length;++i)t[i].onCommitted()}_clearObservationHandles(){const t=this._handles;if(t!==null){for(let i=0;i<t.length;++i)t[i].remove();t.length=0}}}class OH{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new OH;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,te(r))}),i}get(t){return this._values.get(t)}originOf(){return Si.USER}keys(){return[...this._values.keys()]}set(t,i){this._values.set(t,i)}delete(t){this._values.delete(t)}has(t){return this._values.has(t)}forEach(t){this._values.forEach(t)}}function D3(e,t,i){return e!==void 0}function pQ(e,t,i,r){return e!==void 0&&(!(i==null&&e.flags&fr.NonNullable)||(r.lifecycle,ef.INITIALIZING,!1))}function wEe(e){return e&&typeof e.destroy=="function"}me.getLogger("esri.core.accessorSupport.Properties");class xEe{constructor(t){this.host=t,this.properties=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=ef.INITIALIZING,this.store=new OH,this._origin=Si.USER;const i=this.host.constructor.__accessorMetadata__,r=i.properties;for(const s in r){const n=new dQ(this,s,r[s]);this.properties.set(s,n)}this.metadatas=r,this._autoDestroy=i.autoDestroy}initialize(){this.lifecycle=ef.CONSTRUCTING}constructed(){this.lifecycle=ef.CONSTRUCTED}destroy(){if(this.destroyed=!0,this._autoDestroy)for(const[t,i]of this.properties){const r=this.internalGet(t);r&&wEe(r)&&(r.destroy(),~i.flags&fr.NonNullable&&this._internalSet(i,null)),i.destroy()}else for(const[t,i]of this.properties)i.destroy()}get initialized(){return this.lifecycle!==ef.INITIALIZING}get(t){const i=this.properties.get(t);if(i.metadata.get)return i.getComputed();Yt(i);const r=this.store;return r.has(t)?r.get(t):i.metadata.value}originOf(t){const i=this.store.originOf(t);if(i===void 0){const r=this.properties.get(t);if(r!==void 0&&r.flags&fr.HasDefaultValue)return"defaults"}return YL(i)}has(t){return!!this.properties.has(t)&&this.store.has(t)}keys(){return[...this.properties.keys()]}internalGet(t){const i=this.properties.get(t);if(D3(i))return this.store.has(t)?this.store.get(t):i.metadata.value}internalSet(t,i){const r=this.properties.get(t);D3(r)&&this._internalSet(r,i)}getDependsInfo(t,i,r){const s=this.properties.get(i);if(!D3(s))return"";const n=new Set,o=gg({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>{var l;return(l=s.metadata.get)==null?void 0:l.call(t)});let a=`${r}${t.declaredClass.split(".").pop()}.${i}: ${o}
`;if(n.size===0)return a;r+="  ";for(const l of n){if(!(l instanceof dQ))continue;const c=l.properties.host,h=l.propertyName,p=Ea(c);a+=p?p.getDependsInfo(c,h,r):`${r}${h}: undefined
`}return a}setAtOrigin(t,i,r){const s=this.properties.get(t);if(D3(s))return this._setAtOrigin(s,i,r)}isOverridden(t){const i=this.properties.get(t);return i!==void 0&&!!(i.flags&fr.Overriden)}clearOverride(t){const i=this.properties.get(t);i!==void 0&&i.flags&fr.Overriden&&(i.flags&=~fr.Overriden,i.notifyChange())}override(t,i){const r=this.properties.get(t);if(!pQ(r,t,i,this))return;const s=r.metadata.cast;if(s){const n=this._cast(s,i),{valid:o,value:a}=n;if(YU.release(n),!o)return;i=a}r.flags|=fr.Overriden,this._internalSet(r,i)}set(t,i){const r=this.properties.get(t);if(!pQ(r,t,i,this))return;const s=r.metadata.cast;if(s){const o=this._cast(s,i),{valid:a,value:l}=o;if(YU.release(o),!a)return;i=l}const n=r.metadata.set;n?n.call(this.host,i):this._internalSet(r,i)}setDefaultOrigin(t){this._origin=P0(t)}getDefaultOrigin(){return YL(this._origin)}notifyChange(t){const i=this.properties.get(t);i!==void 0&&i.notifyChange()}invalidate(t){const i=this.properties.get(t);i!==void 0&&i.invalidate()}commit(t){const i=this.properties.get(t);i!==void 0&&i.commit()}_internalSet(t,i){const r=this.lifecycle!==ef.INITIALIZING?this._origin:Si.DEFAULTS;this._setAtOrigin(t,i,r)}_setAtOrigin(t,i,r){const s=this.store,n=t.propertyName;s.has(n,r)&&wH(i,s.get(n))&&~t.flags&fr.Overriden&&r===s.originOf(n)||(t.invalidate(),s.set(n,i,r),t.commit(),bce(this.host,t))}_cast(t,i){const r=YU.acquire();return r.valid=!0,r.value=i,t&&(r.value=t.call(this.host,i,r)),r}}class TEe{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}}const YU=new ys(TEe);function ZL(e,t,i){if(e&&t)if(typeof t=="object")for(const r of Object.getOwnPropertyNames(t))ZL(e,r,t[r]);else{if(t.includes(".")){const s=t.split("."),n=s.splice(s.length-1,1)[0];return void ZL(jL(e,s),n,i)}const r=e.__accessor__;r!=null&&SEe(t,r),e[t]=i}}function SEe(e,t){if(he("esri-unknown-property-errors")&&!EEe(e,t))throw new q("set:unknown-property",CEe(e,t))}function EEe(e,t){return t.metadatas[e]!=null}function CEe(e,t){return"setting unknown property '"+e+"' on instance of "+t.host.declaredClass}me.getLogger("esri.core.accessorSupport.set");function d(e={}){return(t,i)=>{if(t===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${t.name}.${i}. Accessor does not support static properties.`);const r=Object.getOwnPropertyDescriptor(t,i),s=n4(t,i);r&&(r.get||r.set?(s.get=r.get||s.get,s.set=r.set||s.set):"value"in r&&("value"in e&&me.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${i}" on "${t.constructor.name}" already defined in the metadata`,e),s.value=e.value=r.value)),e.readOnly!=null&&(s.readOnly=e.readOnly);const n=e.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=jL(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=jL(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){p!==void 0?this._override(i,p):this._clearOverride(i)}:function(p){ZL(this,l,p)})}const o=e.type,a=e.types;s.cast||(o?s.cast=AEe(o):a&&(Array.isArray(a)?s.cast=zR(qd(a[0])):s.cast=qd(a))),e.range&&(s.cast=REe(s.cast,e.range)),yEe(s,e)}}function Ice(e,t,i){const r=n4(e,i);r.json||(r.json={});let s=r.json;return t!==void 0&&(s.origins||(s.origins={}),s.origins[t]||(s.origins[t]={}),s=s.origins[t]),s}function AEe(e){let t=0,i=e;if(R2e(e))return oce(e);for(;Array.isArray(i)&&i.length===1&&typeof i[0]!="string"&&typeof i[0]!="number";)i=i[0],t++;const r=i;if(nce(r))return t===0?e8(r):zL(e8(r),t);if(t===1)return C2e(r);if(t>1)return A2e(r,t);const s=e;return s.from?s.from:Qr(s)}function REe(e,t){return i=>{let r=+e(i);return t.step!=null&&(r=Math.round(r/t.step)*t.step),t.min!=null&&(r=Math.max(t.min,r)),t.max!=null&&(r=Math.min(t.max,r)),r}}function MEe(e){if(e.json&&e.json.origins){const t=e.json.origins,i={"web-document":["web-scene","web-map"]};for(const r in i)if(t[r]){const s=t[r];i[r].forEach(n=>{t[n]=s}),delete t[r]}}}class lu extends t4{constructor(t,i,r){if(super(t,i,r),!(this instanceof lu))return new lu(t,i,r)}}lu.prototype.type="warning";function $ce(e){return!!e&&e.prototype&&e.prototype.declaredClass&&e.prototype.declaredClass.indexOf("esri.core.Collection")===0}const p8=me.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function fQ(e,t,i){var r,s;e&&(!i&&!t.read||((r=t.read)==null?void 0:r.reader)||((s=t.read)==null?void 0:s.enabled)===!1||IEe(e)&&tc("read.reader",U2(e),t))}function U2(e){var i,r,s;const t=(i=e.ndimArray)!=null?i:0;if(t>1)return PEe(e);if(t===1)return mQ(e);if("type"in e&&Lce(e.type)){const n=(s=(r=e.type.prototype)==null?void 0:r.itemType)==null?void 0:s.Type,o=mQ(typeof n=="function"?{type:n}:{types:n});return(a,l,c)=>{const h=o(a,l,c);return h&&new e.type(h)}}return PH(e)}function PH(e){return"type"in e?OEe(e.type):$Ee(e.types)}function OEe(e){return e.prototype.read?(t,i,r)=>{if(t==null)return t;const s=typeof t;if(s!=="object")return void p8.error(`Expected JSON value of type 'object' to deserialize type '${e.prototype.declaredClass}', but got '${s}'`);const n=new e;return n.read(t,r),n}:e.fromJSON}function Dce(e,t,i,r){return r!==0&&Array.isArray(t)?t.map(s=>Dce(e,s,i,r-1)):e(t,void 0,i)}function PEe(e){var s;const t=PH(e),i=Dce.bind(null,t),r=(s=e.ndimArray)!=null?s:0;return(n,o,a)=>{if(n==null)return n;n=i(n,a,r);let l=r,c=n;for(;l>0&&Array.isArray(c);)l--,c=c[0];if(c!==void 0)for(let h=0;h<l;h++)n=[n];return n}}function mQ(e){const t=PH(e);return(i,r,s)=>{if(i==null)return i;if(Array.isArray(i)){const o=[];for(const a of i){const l=t(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=t(i,void 0,s);return n!==void 0?[n]:void 0}}function Lce(e){if(!$ce(e))return!1;const t=e.prototype.itemType;return!(!t||!t.Type)&&(typeof t.Type=="function"?IH(t.Type):Nce(t.Type))}function IEe(e){return"types"in e?Nce(e.types):IH(e.type)}function IH(e){return!Array.isArray(e)&&!!e&&e.prototype&&("read"in e.prototype||"fromJSON"in e||Lce(e))}function Nce(e){for(const t in e.typeMap)if(!IH(e.typeMap[t]))return!1;return!0}function $Ee(e){var r;let t=null;const i=(r=e.errorContext)!=null?r:"type";return(s,n,o)=>{if(s==null)return s;const a=typeof s;if(a!=="object")return void p8.error(`Expected JSON value of type 'object' to deserialize, but got '${a}'`);t||(t=DEe(e));const l=e.key;if(typeof l!="string")return;const c=s[l],h=c?t[c]:e.defaultKeyValue?e.typeMap[e.defaultKeyValue]:void 0;if(!h){const f=`Type '${c||"unknown"}' is not supported`;return o&&o.messages&&s&&o.messages.push(new lu(`${i}:unsupported`,f,{definition:s,context:o})),void p8.error(f)}const p=new h;return p.read(s,o),p}}function DEe(e){var i,r;const t={};for(const s in e.typeMap){const n=e.typeMap[s],o=yO(n.prototype);if(typeof e.key=="function")continue;const a=o.properties[e.key];if(!a)continue;((i=a.json)==null?void 0:i.type)&&Array.isArray(a.json.type)&&a.json.type.length===1&&typeof a.json.type[0]=="string"&&(t[a.json.type[0]]=n);const l=(r=a.json)==null?void 0:r.write;if(!l||!l.writer){t[s]=n;continue}const c=l.target,h=typeof c=="string"?c:e.key,p={};l.writer(s,p,h),p[h]&&(t[p[h]]=n)}return t}function LEe(e){if(e.json||(e.json={}),yQ(e.json),vQ(e.json),gQ(e.json),e.json.origins)for(const t in e.json.origins)yQ(e.json.origins[t]),vQ(e.json.origins[t]),gQ(e.json.origins[t]);return!0}function gQ(e){e.name&&(e.read&&typeof e.read=="object"?e.read.source===void 0&&(e.read.source=e.name):e.read={source:e.name},e.write&&typeof e.write=="object"?e.write.target===void 0&&(e.write.target=e.name):e.write={target:e.name})}function yQ(e){typeof e.read=="boolean"?e.read={enabled:e.read}:typeof e.read=="function"?e.read={enabled:!0,reader:e.read}:e.read&&typeof e.read=="object"&&e.read.enabled===void 0&&(e.read.enabled=!0)}function vQ(e){typeof e.write=="boolean"?e.write={enabled:e.write}:typeof e.write=="function"?e.write={enabled:!0,writer:e.write}:e.write&&typeof e.write=="object"&&e.write.enabled===void 0&&(e.write.enabled=!0)}const NEe=me.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer");function _Q(e,t){var r;if(!t.write||t.write.writer||t.write.enabled===!1&&!t.write.overridePolicy)return;const i=(r=e==null?void 0:e.ndimArray)!=null?r:0;e&&(i===1||"type"in e&&$ce(e.type))?t.write.writer=kEe:i>1?t.write.writer=zEe(i):t.types?Array.isArray(t.types)?t.write.writer=UEe(t.types[0]):t.write.writer=FEe(t.types):t.write.writer=GR}function FEe(e){return(t,i,r,s)=>t?Fce(t,e,s)?GR(t,i,r,s):void 0:GR(t,i,r,s)}function Fce(e,t,i){var r,s;for(const n in t.typeMap)if(e instanceof t.typeMap[n])return!0;if(i==null?void 0:i.messages){const n=(r=t.errorContext)!=null?r:"type",o=`Values of type '${(s=typeof t.key!="function"?e[t.key]:e.declaredClass)!=null?s:"Unknown"}' cannot be written`;i&&i.messages&&e&&i.messages.push(new q(`${n}:unsupported`,o,{definition:e,context:i})),NEe.error(o)}return!1}function UEe(e){return(t,i,r,s)=>!t||!Array.isArray(t)?GR(t,i,r,s):GR(t.filter(n=>Fce(n,e,s)),i,r,s)}function GR(e,t,i,r){tc(i,QL(e,r),t)}function QL(e,t){return e&&typeof e.write=="function"?e.write({},t):e&&typeof e.toJSON=="function"?e.toJSON():typeof e=="number"?JL(e):e}function JL(e){return e===-1/0?-Number.MAX_VALUE:e===1/0?Number.MAX_VALUE:isNaN(e)?null:e}function kEe(e,t,i,r){let s;e===null?s=null:e&&typeof e.map=="function"?(s=e.map(n=>QL(n,r)),typeof s.toArray=="function"&&(s=s.toArray())):s=[QL(e,r)],tc(i,s,t)}function Uce(e,t,i){return i!==0&&Array.isArray(e)?e.map(r=>Uce(r,t,i-1)):QL(e,t)}function zEe(e){return(t,i,r,s)=>{let n;if(t===null)n=null;else{n=Uce(t,s,e);let o=e,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}tc(r,n,i)}}function f8(e,t){return $H(e,"read",t)}function kce(e,t){return $H(e,"write",t)}function $H(e,t,i){let r=e&&e.json;if(e&&e.json&&e.json.origins&&i){const s=e.json.origins[i.origin];s&&(t==="any"||t in s)&&(r=s)}return r}function VEe(e){const t=BEe(e);if(e.json.origins)for(const i in e.json.origins){const r=e.json.origins[i],s=r.types?GEe(r):t;fQ(s,r,!1),r.types&&!r.write&&e.json.write&&e.json.write.enabled&&(r.write=F({},e.json.write)),_Q(s,r)}fQ(t,e.json,!0),_Q(t,e.json)}function BEe(e){return e.json.types?m8(e.json):e.type?zce(e):m8(e)}function GEe(e){return e.type?zce(e):m8(e)}function zce(e){if(!e.type)return;let t=0,i=e.type;for(;Array.isArray(i)&&!nce(i);)i=i[0],t++;return{type:i,ndimArray:t}}function m8(e){if(!e.types)return;let t=0,i=e.types;for(;Array.isArray(i);)i=i[0],t++;return{types:i,ndimArray:t}}function jEe(e){LEe(e)&&(MEe(e),VEe(e))}const ZU=new Set,QU=new Set;function P(e){return t=>{t.prototype.declaredClass=e,qEe(t);const i=[],r=[];let s=t.prototype;for(;s;)s.hasOwnProperty("initialize")&&!ZU.has(s.initialize)&&(ZU.add(s.initialize),i.push(s.initialize)),s.hasOwnProperty("destroy")&&!QU.has(s.destroy)&&(QU.add(s.destroy),r.push(s.destroy)),s=Object.getPrototypeOf(s);ZU.clear(),QU.clear();class n extends t{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(i.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=i.length-1;l>=0;l--)i[l].call(this)}}),r.length){let l=!1;Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0;for(let c=0;c<r.length;c++)r[c].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=yO(t.prototype),n.prototype.declaredClass=e,n}}function HEe(e,t){return t.get==null?function(){const i=this.__accessor__.properties.get(e);if(i===void 0)return;Yt(i);const r=this.__accessor__.store;return r.has(e)?r.get(e):i.metadata.value}:function(){const i=this.__accessor__.properties.get(e);if(i!==void 0)return i.getComputed()}}function qEe(e){const t=e.prototype,i=yO(t).properties,r={};for(const s of Object.getOwnPropertyNames(i)){const n=i[s];jEe(n),r[s]={enumerable:!0,configurable:!0,get:HEe(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===ef.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(e.prototype,r)}var Vce;function WEe(e){var t;if(e==null)return{value:e};if(Array.isArray(e))return{type:[e[0]],value:null};switch(typeof e){case"object":return((t=e.constructor)==null?void 0:t.__accessorMetadata__)||e instanceof Date?{type:e.constructor,value:e}:e;case"boolean":return{type:Boolean,value:e};case"string":return{type:String,value:e};case"number":return{type:Number,value:e};case"function":return{type:e,value:null};default:return}}const MC=Symbol("Accessor-Handles");class Ee{constructor(...t){if(this[Vce]=null,this.constructor===Ee)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");Object.defineProperty(this,"__accessor__",{enumerable:!1,value:new xEe(this)}),t.length>0&&this.normalizeCtorArgs&&(this.__accessor__.ctorArgs=this.normalizeCtorArgs.apply(this,t))}static createSubclass(t={}){if(Array.isArray(t))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:i,declaredClass:r,constructor:s}=t;delete t.declaredClass,delete t.properties,delete t.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}yO(o.prototype);for(const a in t){const l=t[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:t[a]}for(const a in i){const l=WEe(i[a]);d(l)(o.prototype,a)}return P(r)(o)}postscript(t){const i=this.__accessor__,r=i.ctorArgs||t;i.initialize(),r&&(this.set(r),i.ctorArgs=null),i.constructed(),this.initialize()}initialize(){}destroy(){this.destroyed||(qs(this[MC],t=>{t.forEach(i=>i.remove())}),this[MC]=null,oEe(this),this.__accessor__.destroy())}get initialized(){return this.__accessor__&&this.__accessor__.initialized||!1}get constructed(){return this.__accessor__&&this.__accessor__.lifecycle===ef.CONSTRUCTED||!1}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(t){this.get(t)}get(t){return jL(this,t)}hasOwnProperty(t){return this.__accessor__?this.__accessor__.has(t):Object.prototype.hasOwnProperty.call(this,t)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(t,i){return ZL(this,t,i),this}watch(t,i,r){return hEe(this,t,i,r)}own(t){let i=this[MC];if(R(i)&&(i=this[MC]=new Set),Oce(t))for(const r of t)i.add(r);else i.add(t)}_clearOverride(t){return this.__accessor__.clearOverride(t)}_override(t,i){return this.__accessor__.override(t,i)}_isOverridden(t){return this.__accessor__.isOverridden(t)}notifyChange(t){this.__accessor__.notifyChange(t)}_get(t){return this.__accessor__.internalGet(t)}_set(t,i){return this.__accessor__.internalSet(t,i),this}}Vce=MC;me.getLogger("esri.core.Clonable");const oc=e=>{let t=class extends e{clone(){var l;const i=i2e(Ea(this),"unable to clone instance of non-accessor class"),r=i.metadatas,s=i.store,n={},o=new Map;for(const c in r){const h=r[c],p=s==null?void 0:s.originOf(c),f=h.clonable;if(h.readOnly||f===!1||p!==Si.USER&&p!==Si.DEFAULTS&&p!==Si.WEB_MAP&&p!==Si.WEB_SCENE)continue;const m=this[c];let y=null;y=typeof f=="function"?f(m):f==="reference"?m:JV(m),m!=null&&y==null||(p===Si.DEFAULTS?o.set(c,y):n[c]=y)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){const c=(l=Ea(a))==null?void 0:l.store;if(c)for(const[h,p]of o)c.set(h,p,Si.DEFAULTS)}return a}};return t=u([P("esri.core.Clonable")],t),t};let bQ=class extends oc(Ee){};bQ=u([P("esri.core.Clonable")],bQ);class dv{constructor(t,i){this.min=t,this.max=i,this.range=i-t}ndiff(t,i=0){return Math.ceil((t-i)/this.range)*this.range+i}_normalize(t,i,r,s=0,n=!1){return(r-=s)<t?r+=this.ndiff(t-r):r>i&&(r-=this.ndiff(r-i)),n&&r===i&&(r=t),r+s}normalize(t,i=0,r=!1){return this._normalize(this.min,this.max,t,i,r)}clamp(t,i=0){return $e(t-i,this.min,this.max)+i}monotonic(t,i,r){return t<i?i:i+this.ndiff(t-i,r)}minimalMonotonic(t,i,r){return this._normalize(t,t+this.range,i,r)}center(t,i,r){return i=this.monotonic(t,i,r),this.normalize((t+i)/2,r)}diff(t,i,r){return this.monotonic(t,i,r)-t}shortestSignedDiff(t,i){t=this.normalize(t);const r=(i=this.normalize(i))-t,s=i<t?this.minimalMonotonic(t,i)-t:i-this.minimalMonotonic(i,t);return Math.abs(r)<Math.abs(s)?r:s}contains(t,i,r){return i=this.minimalMonotonic(t,i),(r=this.minimalMonotonic(t,r))>t&&r<i}}function DH(e){for(const t in e){const i=e[t];i instanceof Function&&(e[t]=i.bind(e))}return e}const XEe=DH(new dv(0,2*Math.PI)),pv=DH(new dv(-Math.PI,Math.PI)),LH=DH(new dv(0,360));class NH{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(t){const i=new NH;return this._values.forEach((r,s)=>{t&&t.has(s)||i.set(s,te(r.value),r.origin)}),i}get(t,i){i=this._normalizeOrigin(i);const r=this._values.get(t);return i==null||(r==null?void 0:r.origin)===i?r==null?void 0:r.value:void 0}originOf(t){var i,r;return(r=(i=this._values.get(t))==null?void 0:i.origin)!=null?r:Si.USER}keys(t){t=this._normalizeOrigin(t);const i=[...this._values.keys()];return t==null?i:i.filter(r=>{var s;return((s=this._values.get(r))==null?void 0:s.origin)===t})}set(t,i,r){if((r=this._normalizeOrigin(r))===Si.DEFAULTS){const s=this._values.get(t);if(s&&s.origin!=null&&s.origin>r)return}this._values.set(t,new YEe(i,r))}delete(t,i){var r;(i=this._normalizeOrigin(i))!=null&&((r=this._values.get(t))==null?void 0:r.origin)!==i||this._values.delete(t)}has(t,i){var r;return(i=this._normalizeOrigin(i))!=null?((r=this._values.get(t))==null?void 0:r.origin)===i:this._values.has(t)}forEach(t){this._values.forEach(({value:i},r)=>t(i,r))}_normalizeOrigin(t){if(t!=null)return t===Si.DEFAULTS?t:Si.USER}}class YEe{constructor(t,i){this.value=t,this.origin=i}}function Bce(e,t,i){t.keys().forEach(s=>{i.set(s,t.get(s),Si.DEFAULTS)});const r=e.metadatas;Object.keys(r).forEach(s=>{e.internalGet(s)&&i.set(s,e.internalGet(s),Si.DEFAULTS)})}function ZEe(e,t,i){if(!e||!e.read||e.read.enabled===!1||!e.read.source)return!1;const r=e.read.source;if(typeof r=="string"){if(r===t||r.includes(".")&&r.indexOf(t)===0&&lQ(r,i))return!0}else for(const s of r)if(s===t||s.includes(".")&&s.indexOf(t)===0&&lQ(s,i))return!0;return!1}function QEe(e){return e&&(!e.read||e.read.enabled!==!1&&!e.read.source)}function JEe(e,t,i,r,s){let n=f8(t[i],s);QEe(n)&&(e[i]=!0);for(const o of Object.getOwnPropertyNames(t))n=f8(t[o],s),ZEe(n,i,r)&&(e[o]=!0)}function KEe(e,t,i,r){const s=i.metadatas,n=$H(s[t],"any",r),o=n&&n.default;if(o===void 0)return;const a=typeof o=="function"?o.call(e,t,r):o;a!==void 0&&i.set(t,a)}const Gce={origin:"service"};function jce(e,t,i=Gce){if(!t||typeof t!="object")return;const r=Ea(e),s=r.metadatas,n={};for(const o of Object.getOwnPropertyNames(t))JEe(n,s,o,t,i);r.setDefaultOrigin(i.origin);for(const o of Object.getOwnPropertyNames(n)){const a=f8(s[o],i).read,l=a&&a.source;let c;c=l&&typeof l=="string"?gO(t,l):t[o],a&&a.reader&&(c=a.reader.call(e,c,t,i)),c!==void 0&&r.set(o,c)}if(!i||!i.ignoreDefaults){r.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||KEe(e,o,r,i)}r.setDefaultOrigin("user")}function Hce(e,t,i,r=Gce){var n;const s=ve(F({},r),{messages:[]});i(s),(n=s.messages)==null||n.forEach(o=>{o.type!=="warning"||e.loaded?r&&r.messages&&r.messages.push(o):e.loadWarnings.push(o)})}const eCe=me.getLogger("esri.core.accessorSupport.write");function tCe(e,t,i,r,s){var o,a;const n={};return(a=(o=t.write)==null?void 0:o.writer)==null||a.call(e,r,n,i,s),n}function qce(e,t,i,r,s,n){if(!r||!r.write)return!1;const o=e.get(i);if(!s&&r.write.overridePolicy){const a=r.write.overridePolicy.call(e,o,i,n);a!==void 0&&(s=a)}if(s||(s=r.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new q("web-document-write:property-required",`Missing value for required property '${i}' on '${e.declaredClass}'`,{propertyName:i,target:e});return a&&n&&n.messages?n.messages.push(a):a&&!n&&eCe.error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||(!t.store.multipleOriginsSupported||t.store.originOf(i)===Si.DEFAULTS)&&iCe(e,i,n,r,o)||!s.ignoreOrigin&&n&&n.origin&&t.store.multipleOriginsSupported&&t.store.originOf(i)<P0(n.origin))}function iCe(e,t,i,r,s){const n=r.default;if(n===void 0)return!1;if(r.defaultEquals!=null)return r.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(e,t,i);return uv(o,s)}return!1}return n===s}function rCe(e,t,i,r){const s=Ea(e),n=s.metadatas,o=kce(n[t],r);return!!o&&qce(e,s,t,o,i,r)}function Wce(e,t,i){var n,o;if(e&&typeof e.toJSON=="function"&&(!e.toJSON.isDefaultToJSON||!e.write))return A$(t,e.toJSON(i));const r=Ea(e),s=r.metadatas;for(const a in s){const l=kce(s[a],i);if(!qce(e,r,a,l,void 0,i))continue;const c=e.get(a),h=tCe(e,l,l.write&&typeof l.write.target=="string"?l.write.target:a,c,i);Object.keys(h).length>0&&(t=A$(t,h),((o=(n=i==null?void 0:i.resources)==null?void 0:n.pendingOperations)==null?void 0:o.length)&&Promise.all(i.resources.pendingOperations).then(()=>A$(t,h)),i&&i.writtenProperties&&i.writtenProperties.push({target:e,propName:a,oldOrigin:bEe(r.store.originOf(a)),newOrigin:i.origin}))}return t}const vO=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ea(this),s=r.store,n=new NH;r.store=n,Bce(r,s,n)}read(i,r){jce(this,i,r)}write(i={},r){return Wce(this,i,r)}toJSON(i){return this.write({},i)}static fromJSON(i,r){return sCe.call(this,i,r)}};return t=u([P("esri.core.JSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function sCe(e,t){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const i=new this;return i.read(e,t),i}let fe=class extends vO(Ee){};fe=u([P("esri.core.JSONSupport")],fe);const nCe=Object.prototype.toString;function oCe(e){const t="__accessorMetadata__"in e?Qr(e):e;return function(...i){if(i.push(t),typeof i[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return aCe.apply(this,i)}}function aCe(e,t,i,r){n4(e,t).cast=r}function lCe(e){return(t,i)=>{n4(t,e).cast=t[i]}}function Ot(...e){if(e.length!==3||typeof e[1]!="string")return e.length===1&&nCe.call(e[0])==="[object Function]"?oCe(e[0]):e.length===1&&typeof e[0]=="string"?lCe(e[0]):void 0}function ke(e,t,i){let r,s;return t===void 0||Array.isArray(t)?(s=e,i=t,r=[void 0]):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;r.forEach(l=>{const c=Ice(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],i&&(c.read.source=(c.read.source||[]).concat(i))})}}function Be(e,t,i){let r,s;return t===void 0?(s=e,r=[void 0]):typeof t!="string"?(s=e,r=[void 0],i=t):(s=t,r=Array.isArray(e)?e:[e]),(n,o)=>{const a=n.constructor.prototype;for(const l of r){const c=Ice(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),i&&(c.write.target=i),c.write.writer=a[o]}}}var dh;(function(e){e[e.CGCS2000=4490]="CGCS2000",e[e.GCSMARS2000=104971]="GCSMARS2000",e[e.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",e[e.GCSMOON2000=104903]="GCSMOON2000"})(dh||(dh={}));let g;const L={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22332:0,22391:0,22392:0,22700:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(g=2e3;g<=2045;g++)L[g]=0;for(g=2056;g<=2065;g++)L[g]=0;for(g=2067;g<=2135;g++)L[g]=0;for(g=2137;g<=2154;g++)L[g]=0;for(g=2161;g<=2170;g++)L[g]=0;for(g=2172;g<=2193;g++)L[g]=0;for(g=2195;g<=2198;g++)L[g]=0;for(g=2200;g<=2203;g++)L[g]=0;for(g=2205;g<=2217;g++)L[g]=0;for(g=2222;g<=2224;g++)L[g]=1;for(g=2225;g<=2250;g++)L[g]=2;for(g=2251;g<=2253;g++)L[g]=1;for(g=2257;g<=2264;g++)L[g]=2;for(g=2274;g<=2279;g++)L[g]=2;for(g=2280;g<=2282;g++)L[g]=1;for(g=2283;g<=2289;g++)L[g]=2;for(g=2290;g<=2292;g++)L[g]=0;for(g=2308;g<=2313;g++)L[g]=0;for(g=2315;g<=2491;g++)L[g]=0;for(g=2494;g<=2866;g++)L[g]=0;for(g=2867;g<=2869;g++)L[g]=1;for(g=2870;g<=2888;g++)L[g]=2;for(g=2891;g<=2895;g++)L[g]=2;for(g=2896;g<=2898;g++)L[g]=1;for(g=2902;g<=2908;g++)L[g]=2;for(g=2915;g<=2920;g++)L[g]=2;for(g=2921;g<=2923;g++)L[g]=1;for(g=2924;g<=2930;g++)L[g]=2;for(g=2931;g<=2962;g++)L[g]=0;for(g=2964;g<=2968;g++)L[g]=2;for(g=2969;g<=2973;g++)L[g]=0;for(g=2975;g<=2991;g++)L[g]=0;for(g=2995;g<=3051;g++)L[g]=0;for(g=3054;g<=3079;g++)L[g]=0;for(g=3081;g<=3088;g++)L[g]=0;for(g=3092;g<=3101;g++)L[g]=0;for(g=3106;g<=3138;g++)L[g]=0;for(g=3146;g<=3151;g++)L[g]=0;for(g=3153;g<=3166;g++)L[g]=0;for(g=3168;g<=3172;g++)L[g]=0;for(g=3174;g<=3203;g++)L[g]=0;for(g=3294;g<=3358;g++)L[g]=0;for(g=3367;g<=3403;g++)L[g]=0;for(g=3408;g<=3416;g++)L[g]=0;for(g=3417;g<=3438;g++)L[g]=2;for(g=3441;g<=3446;g++)L[g]=2;for(g=3447;g<=3450;g++)L[g]=0;for(g=3451;g<=3459;g++)L[g]=2;for(g=3460;g<=3478;g++)L[g]=0;for(g=3554;g<=3559;g++)L[g]=0;for(g=3560;g<=3570;g++)L[g]=2;for(g=3571;g<=3581;g++)L[g]=0;for(g=3594;g<=3597;g++)L[g]=0;for(g=3601;g<=3604;g++)L[g]=0;for(g=3637;g<=3639;g++)L[g]=0;for(g=3665;g<=3667;g++)L[g]=0;for(g=3693;g<=3695;g++)L[g]=0;for(g=3701;g<=3727;g++)L[g]=0;for(g=3728;g<=3739;g++)L[g]=2;for(g=3740;g<=3751;g++)L[g]=0;for(g=3753;g<=3760;g++)L[g]=2;for(g=3761;g<=3773;g++)L[g]=0;for(g=3775;g<=3777;g++)L[g]=0;for(g=3779;g<=3781;g++)L[g]=0;for(g=3783;g<=3785;g++)L[g]=0;for(g=3788;g<=3791;g++)L[g]=0;for(g=3797;g<=3802;g++)L[g]=0;for(g=3814;g<=3816;g++)L[g]=0;for(g=3825;g<=3829;g++)L[g]=0;for(g=3832;g<=3841;g++)L[g]=0;for(g=3844;g<=3852;g++)L[g]=0;for(g=3873;g<=3885;g++)L[g]=0;for(g=3890;g<=3893;g++)L[g]=0;for(g=3907;g<=3912;g++)L[g]=0;for(g=3942;g<=3950;g++)L[g]=0;for(g=3968;g<=3970;g++)L[g]=0;for(g=3973;g<=3976;g++)L[g]=0;for(g=3986;g<=3989;g++)L[g]=0;for(g=3994;g<=3997;g++)L[g]=0;for(g=4048;g<=4051;g++)L[g]=0;for(g=4056;g<=4063;g++)L[g]=0;for(g=4093;g<=4096;g++)L[g]=0;for(g=4390;g<=4398;g++)L[g]=0;for(g=4399;g<=4413;g++)L[g]=2;for(g=4418;g<=4433;g++)L[g]=2;for(g=4455;g<=4457;g++)L[g]=2;for(g=4484;g<=4489;g++)L[g]=0;for(g=4491;g<=4554;g++)L[g]=0;for(g=4568;g<=4589;g++)L[g]=0;for(g=4652;g<=4656;g++)L[g]=0;for(g=4766;g<=4800;g++)L[g]=0;for(g=5014;g<=5016;g++)L[g]=0;for(g=5069;g<=5072;g++)L[g]=0;for(g=5105;g<=5130;g++)L[g]=0;for(g=5173;g<=5188;g++)L[g]=0;for(g=5253;g<=5259;g++)L[g]=0;for(g=5269;g<=5275;g++)L[g]=0;for(g=5292;g<=5311;g++)L[g]=0;for(g=5329;g<=5331;g++)L[g]=0;for(g=5343;g<=5349;g++)L[g]=0;for(g=5355;g<=5357;g++)L[g]=0;for(g=5387;g<=5389;g++)L[g]=0;for(g=5459;g<=5463;g++)L[g]=0;for(g=5479;g<=5482;g++)L[g]=0;for(g=5518;g<=5520;g++)L[g]=0;for(g=5530;g<=5539;g++)L[g]=0;for(g=5550;g<=5552;g++)L[g]=0;for(g=5562;g<=5583;g++)L[g]=0;for(g=5623;g<=5625;g++)L[g]=2;for(g=5631;g<=5639;g++)L[g]=0;for(g=5649;g<=5653;g++)L[g]=0;for(g=5663;g<=5680;g++)L[g]=0;for(g=5682;g<=5685;g++)L[g]=0;for(g=5875;g<=5877;g++)L[g]=0;for(g=5896;g<=5899;g++)L[g]=0;for(g=5921;g<=5940;g++)L[g]=0;for(g=6050;g<=6125;g++)L[g]=0;for(g=6244;g<=6275;g++)L[g]=0;for(g=6328;g<=6348;g++)L[g]=0;for(g=6350;g<=6356;g++)L[g]=0;for(g=6366;g<=6372;g++)L[g]=0;for(g=6381;g<=6387;g++)L[g]=0;for(g=6393;g<=6404;g++)L[g]=0;for(g=6480;g<=6483;g++)L[g]=0;for(g=6511;g<=6514;g++)L[g]=0;for(g=6579;g<=6581;g++)L[g]=0;for(g=6619;g<=6624;g++)L[g]=0;for(g=6625;g<=6627;g++)L[g]=2;for(g=6628;g<=6632;g++)L[g]=0;for(g=6634;g<=6637;g++)L[g]=0;for(g=6669;g<=6692;g++)L[g]=0;for(g=6707;g<=6709;g++)L[g]=0;for(g=6720;g<=6723;g++)L[g]=0;for(g=6732;g<=6738;g++)L[g]=0;for(g=6931;g<=6933;g++)L[g]=0;for(g=6956;g<=6959;g++)L[g]=0;for(g=7005;g<=7007;g++)L[g]=0;for(g=7057;g<=7070;g++)L[g]=2;for(g=7074;g<=7082;g++)L[g]=0;for(g=7109;g<=7118;g++)L[g]=0;for(g=7119;g<=7127;g++)L[g]=1;for(g=7374;g<=7376;g++)L[g]=0;for(g=7528;g<=7586;g++)L[g]=0;for(g=7587;g<=7645;g++)L[g]=2;for(g=7692;g<=7696;g++)L[g]=0;for(g=7755;g<=7787;g++)L[g]=0;for(g=7791;g<=7795;g++)L[g]=0;for(g=7799;g<=7801;g++)L[g]=0;for(g=7803;g<=7805;g++)L[g]=0;for(g=7825;g<=7831;g++)L[g]=0;for(g=7845;g<=7859;g++)L[g]=0;for(g=8013;g<=8032;g++)L[g]=0;for(g=8065;g<=8068;g++)L[g]=1;for(g=8518;g<=8529;g++)L[g]=2;for(g=8533;g<=8536;g++)L[g]=2;for(g=8538;g<=8540;g++)L[g]=2;for(g=8677;g<=8679;g++)L[g]=0;for(g=8836;g<=8840;g++)L[g]=0;for(g=8857;g<=8859;g++)L[g]=0;for(g=8908;g<=8910;g++)L[g]=0;for(g=9154;g<=9159;g++)L[g]=0;for(g=9205;g<=9218;g++)L[g]=0;for(g=9271;g<=9273;g++)L[g]=0;for(g=9295;g<=9297;g++)L[g]=0;for(g=9356;g<=9360;g++)L[g]=0;for(g=9404;g<=9407;g++)L[g]=0;for(g=9476;g<=9482;g++)L[g]=0;for(g=9487;g<=9494;g++)L[g]=0;for(g=9697;g<=9699;g++)L[g]=0;for(g=20002;g<=20032;g++)L[g]=0;for(g=20062;g<=20092;g++)L[g]=0;for(g=20135;g<=20138;g++)L[g]=0;for(g=20248;g<=20258;g++)L[g]=0;for(g=20348;g<=20358;g++)L[g]=0;for(g=20436;g<=20440;g++)L[g]=0;for(g=20822;g<=20824;g++)L[g]=0;for(g=20904;g<=20932;g++)L[g]=0;for(g=20934;g<=20936;g++)L[g]=0;for(g=21004;g<=21032;g++)L[g]=0;for(g=21035;g<=21037;g++)L[g]=0;for(g=21095;g<=21097;g++)L[g]=0;for(g=21148;g<=21150;g++)L[g]=0;for(g=21207;g<=21264;g++)L[g]=0;for(g=21307;g<=21364;g++)L[g]=0;for(g=21413;g<=21423;g++)L[g]=0;for(g=21453;g<=21463;g++)L[g]=0;for(g=21473;g<=21483;g++)L[g]=0;for(g=21780;g<=21782;g++)L[g]=0;for(g=21891;g<=21894;g++)L[g]=0;for(g=21896;g<=21899;g++)L[g]=0;for(g=22171;g<=22177;g++)L[g]=0;for(g=22181;g<=22187;g++)L[g]=0;for(g=22191;g<=22197;g++)L[g]=0;for(g=22234;g<=22236;g++)L[g]=0;for(g=22521;g<=22525;g++)L[g]=0;for(g=22991;g<=22994;g++)L[g]=0;for(g=23028;g<=23038;g++)L[g]=0;for(g=23830;g<=23853;g++)L[g]=0;for(g=23866;g<=23872;g++)L[g]=0;for(g=23877;g<=23884;g++)L[g]=0;for(g=23886;g<=23894;g++)L[g]=0;for(g=23946;g<=23948;g++)L[g]=0;for(g=24311;g<=24313;g++)L[g]=0;for(g=24342;g<=24347;g++)L[g]=0;for(g=24370;g<=24374;g++)L[g]=10;for(g=24375;g<=24381;g++)L[g]=0;for(g=24718;g<=24721;g++)L[g]=0;for(g=24817;g<=24821;g++)L[g]=0;for(g=24877;g<=24882;g++)L[g]=0;for(g=24891;g<=24893;g++)L[g]=0;for(g=25391;g<=25395;g++)L[g]=0;for(g=25828;g<=25838;g++)L[g]=0;for(g=26191;g<=26195;g++)L[g]=0;for(g=26391;g<=26393;g++)L[g]=0;for(g=26701;g<=26722;g++)L[g]=0;for(g=26729;g<=26799;g++)L[g]=2;for(g=26801;g<=26803;g++)L[g]=2;for(g=26811;g<=26813;g++)L[g]=2;for(g=26847;g<=26870;g++)L[g]=2;for(g=26891;g<=26899;g++)L[g]=0;for(g=26901;g<=26923;g++)L[g]=0;for(g=26929;g<=26946;g++)L[g]=0;for(g=26948;g<=26998;g++)L[g]=0;for(g=27037;g<=27040;g++)L[g]=0;for(g=27205;g<=27232;g++)L[g]=0;for(g=27258;g<=27260;g++)L[g]=0;for(g=27391;g<=27398;g++)L[g]=0;for(g=27561;g<=27564;g++)L[g]=0;for(g=27571;g<=27574;g++)L[g]=0;for(g=27581;g<=27584;g++)L[g]=0;for(g=27591;g<=27594;g++)L[g]=0;for(g=28191;g<=28193;g++)L[g]=0;for(g=28348;g<=28358;g++)L[g]=0;for(g=28402;g<=28432;g++)L[g]=0;for(g=28462;g<=28492;g++)L[g]=0;for(g=29118;g<=29122;g++)L[g]=0;for(g=29168;g<=29172;g++)L[g]=0;for(g=29177;g<=29185;g++)L[g]=0;for(g=29187;g<=29195;g++)L[g]=0;for(g=29900;g<=29903;g++)L[g]=0;for(g=30161;g<=30179;g++)L[g]=0;for(g=30491;g<=30494;g++)L[g]=0;for(g=30729;g<=30732;g++)L[g]=0;for(g=31251;g<=31259;g++)L[g]=0;for(g=31265;g<=31268;g++)L[g]=0;for(g=31275;g<=31279;g++)L[g]=0;for(g=31281;g<=31297;g++)L[g]=0;for(g=31461;g<=31469;g++)L[g]=0;for(g=31491;g<=31495;g++)L[g]=0;for(g=31917;g<=31922;g++)L[g]=0;for(g=31965;g<=32e3;g++)L[g]=0;for(g=32001;g<=32003;g++)L[g]=2;for(g=32005;g<=32031;g++)L[g]=2;for(g=32033;g<=32060;g++)L[g]=2;for(g=32064;g<=32067;g++)L[g]=2;for(g=32074;g<=32077;g++)L[g]=2;for(g=32081;g<=32086;g++)L[g]=0;for(g=32107;g<=32130;g++)L[g]=0;for(g=32133;g<=32158;g++)L[g]=0;for(g=32164;g<=32167;g++)L[g]=2;for(g=32180;g<=32199;g++)L[g]=0;for(g=32201;g<=32260;g++)L[g]=0;for(g=32301;g<=32360;g++)L[g]=0;for(g=32601;g<=32662;g++)L[g]=0;for(g=32664;g<=32667;g++)L[g]=2;for(g=32701;g<=32761;g++)L[g]=0;for(g=53001;g<=53004;g++)L[g]=0;for(g=53008;g<=53019;g++)L[g]=0;for(g=53021;g<=53032;g++)L[g]=0;for(g=53034;g<=53037;g++)L[g]=0;for(g=53042;g<=53046;g++)L[g]=0;for(g=53074;g<=53080;g++)L[g]=0;for(g=54001;g<=54004;g++)L[g]=0;for(g=54008;g<=54019;g++)L[g]=0;for(g=54021;g<=54032;g++)L[g]=0;for(g=54034;g<=54037;g++)L[g]=0;for(g=54042;g<=54046;g++)L[g]=0;for(g=54048;g<=54053;g++)L[g]=0;for(g=54074;g<=54080;g++)L[g]=0;for(g=54098;g<=54101;g++)L[g]=0;for(g=102001;g<=102040;g++)L[g]=0;for(g=102042;g<=102063;g++)L[g]=0;for(g=102065;g<=102067;g++)L[g]=0;for(g=102070;g<=102117;g++)L[g]=0;for(g=102122;g<=102216;g++)L[g]=0;for(g=102221;g<=102377;g++)L[g]=0;for(g=102382;g<=102388;g++)L[g]=0;for(g=102389;g<=102398;g++)L[g]=2;for(g=102399;g<=102444;g++)L[g]=0;for(g=102445;g<=102447;g++)L[g]=2;for(g=102448;g<=102458;g++)L[g]=0;for(g=102459;g<=102468;g++)L[g]=2;for(g=102469;g<=102499;g++)L[g]=0;for(g=102500;g<=102519;g++)L[g]=1;for(g=102520;g<=102524;g++)L[g]=0;for(g=102525;g<=102529;g++)L[g]=2;for(g=102530;g<=102588;g++)L[g]=0;for(g=102590;g<=102598;g++)L[g]=0;for(g=102601;g<=102603;g++)L[g]=0;for(g=102605;g<=102628;g++)L[g]=0;for(g=102629;g<=102646;g++)L[g]=2;for(g=102648;g<=102700;g++)L[g]=2;for(g=102701;g<=102703;g++)L[g]=0;for(g=102707;g<=102730;g++)L[g]=2;for(g=102733;g<=102758;g++)L[g]=2;for(g=102767;g<=102900;g++)L[g]=0;for(g=102901;g<=102933;g++)L[g]=2;for(g=102934;g<=102950;g++)L[g]=13;for(g=102951;g<=102955;g++)L[g]=0;for(g=102961;g<=102963;g++)L[g]=0;for(g=102965;g<=102969;g++)L[g]=0;for(g=102971;g<=102973;g++)L[g]=0;for(g=102975;g<=102989;g++)L[g]=0;for(g=102990;g<=102992;g++)L[g]=1;for(g=102997;g<=103002;g++)L[g]=0;for(g=103003;g<=103008;g++)L[g]=2;for(g=103009;g<=103011;g++)L[g]=0;for(g=103012;g<=103014;g++)L[g]=2;for(g=103019;g<=103021;g++)L[g]=0;for(g=103022;g<=103024;g++)L[g]=2;for(g=103029;g<=103031;g++)L[g]=0;for(g=103032;g<=103034;g++)L[g]=2;for(g=103065;g<=103068;g++)L[g]=0;for(g=103074;g<=103076;g++)L[g]=0;for(g=103077;g<=103079;g++)L[g]=1;for(g=103080;g<=103082;g++)L[g]=0;for(g=103083;g<=103085;g++)L[g]=2;for(g=103090;g<=103093;g++)L[g]=0;for(g=103097;g<=103099;g++)L[g]=0;for(g=103100;g<=103102;g++)L[g]=2;for(g=103107;g<=103109;g++)L[g]=0;for(g=103110;g<=103112;g++)L[g]=2;for(g=103113;g<=103116;g++)L[g]=0;for(g=103117;g<=103120;g++)L[g]=2;for(g=103153;g<=103157;g++)L[g]=0;for(g=103158;g<=103162;g++)L[g]=2;for(g=103163;g<=103165;g++)L[g]=0;for(g=103166;g<=103168;g++)L[g]=1;for(g=103169;g<=103171;g++)L[g]=2;for(g=103186;g<=103188;g++)L[g]=0;for(g=103189;g<=103191;g++)L[g]=2;for(g=103192;g<=103195;g++)L[g]=0;for(g=103196;g<=103199;g++)L[g]=2;for(g=103200;g<=103224;g++)L[g]=0;for(g=103225;g<=103227;g++)L[g]=1;for(g=103232;g<=103237;g++)L[g]=0;for(g=103238;g<=103243;g++)L[g]=2;for(g=103244;g<=103246;g++)L[g]=0;for(g=103247;g<=103249;g++)L[g]=2;for(g=103254;g<=103256;g++)L[g]=0;for(g=103257;g<=103259;g++)L[g]=2;for(g=103264;g<=103266;g++)L[g]=0;for(g=103267;g<=103269;g++)L[g]=2;for(g=103300;g<=103375;g++)L[g]=0;for(g=103381;g<=103383;g++)L[g]=0;for(g=103384;g<=103386;g++)L[g]=1;for(g=103387;g<=103389;g++)L[g]=0;for(g=103390;g<=103392;g++)L[g]=2;for(g=103397;g<=103399;g++)L[g]=0;for(g=103400;g<=103471;g++)L[g]=2;for(g=103476;g<=103478;g++)L[g]=0;for(g=103479;g<=103481;g++)L[g]=2;for(g=103486;g<=103488;g++)L[g]=0;for(g=103489;g<=103491;g++)L[g]=2;for(g=103492;g<=103495;g++)L[g]=0;for(g=103496;g<=103499;g++)L[g]=2;for(g=103528;g<=103543;g++)L[g]=0;for(g=103544;g<=103548;g++)L[g]=2;for(g=103549;g<=103551;g++)L[g]=0;for(g=103552;g<=103554;g++)L[g]=1;for(g=103555;g<=103557;g++)L[g]=2;for(g=103558;g<=103560;g++)L[g]=0;for(g=103571;g<=103573;g++)L[g]=0;for(g=103574;g<=103576;g++)L[g]=2;for(g=103577;g<=103580;g++)L[g]=0;for(g=103581;g<=103583;g++)L[g]=2;for(g=103595;g<=103694;g++)L[g]=0;for(g=103696;g<=103699;g++)L[g]=0;for(g=103700;g<=103793;g++)L[g]=2;for(g=103794;g<=103887;g++)L[g]=0;for(g=103900;g<=103971;g++)L[g]=2;const cCe={102113:!0,102100:!0,3857:!0,3785:!0},uCe={4326:!0,3785:!0,3857:!0,102113:!0,102100:!0,104905:!0,104971:!0},wQ='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',L3=[-20037508342788905e-9,20037508342788905e-9],N3=[-20037508342787e-6,20037508342787e-6],Xce={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:L3,origin:N3,dx:1e-5},102100:{wkTemplate:wQ,valid:L3,origin:N3,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:L3,origin:N3,dx:1e-5},3857:{wkTemplate:wQ,valid:L3,origin:N3,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function ac(e,t){return!R(e)&&!R(t)&&(e===t||(e.wkid!=null||t.wkid!=null?e.wkid===t.wkid||Cb(e)&&Cb(t)||t.latestWkid!=null&&e.wkid===t.latestWkid||e.latestWkid!=null&&t.wkid===e.latestWkid:!(!e.wkt||!t.wkt)&&e.wkt.toUpperCase()===t.wkt.toUpperCase()))}function J0(e){return ul(e)&&e.wkid&&Xce[e.wkid]||null}function Yce(e){return!!ul(e)&&(e.wkid?L[e.wkid]==null:!!e.wkt&&!!/^\s*GEOGCS/i.test(e.wkt))}function RS(e){return!(If(e)||$f(e))}function jR(e){return ul(e)&&e.wkid===4326}function Zce(e){return ul(e)&&e.wkid===dh.CGCS2000}function Cb(e){return ul(e)&&e.wkid!=null&&cCe[e.wkid]===!0}function HR(e){return ul(e)&&e.wkid===32662}function FH(e){return e===dh.GCSMARS2000||e===dh.GCSMARS2000_SPHERE}function If(e){return ul(e)&&e.wkid!=null&&FH(e.wkid)}function UH(e){return e===dh.GCSMOON2000}function $f(e){return ul(e)&&e.wkid!=null&&UH(e.wkid)}function hCe(e){return ul(e)&&e.wkid!=null&&uCe[e.wkid]===!0}function ul(e){return _(e)&&(e.wkid!=null&&e.wkid>=2e3||e.wkt!=null)}const dCe={wkid:4326,wkt:gf(Xce[4326].wkTemplate,{Central_Meridian:"0.0"})},pCe={wkid:102100,latestWkid:3857},fCe={wkid:32662};var wp;let br=wp=class extends fe{constructor(e){super(e),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}static fromJSON(e){if(!e)return null;if(e.wkid){if(e.wkid===102100)return wp.WebMercator;if(e.wkid===4326)return wp.WGS84}const t=new wp;return t.read(e),t}normalizeCtorArgs(e){return e&&typeof e=="object"?e:{[typeof e=="string"?"wkt":"wkid"]:e}}get isWGS84(){return jR(this)}get isWebMercator(){return Cb(this)}get isGeographic(){return Yce(this)}get isWrappable(){return hCe(this)}writeWkt(e,t){this.wkid||(t.wkt=e)}clone(){if(this===wp.WGS84)return wp.WGS84;if(this===wp.WebMercator)return wp.WebMercator;const e=new wp;return this.wkid!=null?(e.wkid=this.wkid,this.latestWkid!=null&&(e.latestWkid=this.latestWkid),this.vcsWkid!=null&&(e.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(e.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(e.wkt=this.wkt),this.imageCoordinateSystem&&(e.imageCoordinateSystem=te(this.imageCoordinateSystem)),e}equals(e){if(e==null)return!1;if(this.imageCoordinateSystem||e.imageCoordinateSystem){if(this.imageCoordinateSystem==null||e.imageCoordinateSystem==null)return!1;const{id:t,referenceServiceName:i}=e.imageCoordinateSystem,{geodataXform:r}=e.imageCoordinateSystem,s=this.imageCoordinateSystem;return t==null||r?JSON.stringify(s)===JSON.stringify(e.imageCoordinateSystem):i?s.id===t&&s.referenceServiceName===i:s.id===t}return ac(this,e)}toJSON(e){return this.write(void 0,e)}};br.GCS_NAD_1927=null,br.WGS84=null,br.WebMercator=null,br.PlateCarree=null,u([d({readOnly:!0})],br.prototype,"isWGS84",null),u([d({readOnly:!0})],br.prototype,"isWebMercator",null),u([d({readOnly:!0})],br.prototype,"isGeographic",null),u([d({readOnly:!0})],br.prototype,"isWrappable",null),u([d({type:yr,json:{write:!0}})],br.prototype,"latestWkid",void 0),u([d({type:yr,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt===null}}}}}}})],br.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid===null}}}}}}})],br.prototype,"wkt",void 0),u([Be("wkt"),Be("web-scene","wkt")],br.prototype,"writeWkt",null),u([d({type:yr,json:{write:!0}})],br.prototype,"vcsWkid",void 0),u([d({type:yr,json:{write:!0}})],br.prototype,"latestVcsWkid",void 0),u([d()],br.prototype,"imageCoordinateSystem",void 0),br=wp=u([P("esri.geometry.SpatialReference")],br),br.prototype.toJSON.isDefaultToJSON=!0,br.GCS_NAD_1927=new br({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),br.WGS84=new br(dCe),br.WebMercator=new br(pCe),br.PlateCarree=new br(fCe),Object.freeze&&(Object.freeze(br.GCS_NAD_1927),Object.freeze(br.WGS84),Object.freeze(br.WebMercator));const Xe=br;let xp=class extends fe{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=Xe.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,t){if(e instanceof Xe)return e;if(e!=null){const i=new Xe;return i.read(e,t),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,t){this.cache[e]=t}};u([d()],xp.prototype,"type",void 0),u([d({readOnly:!0})],xp.prototype,"cache",null),u([d({readOnly:!0})],xp.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],xp.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],xp.prototype,"hasZ",void 0),u([d({type:Xe,json:{write:!0}})],xp.prototype,"spatialReference",void 0),u([ke("spatialReference")],xp.prototype,"readSpatialReference",null),xp=u([P("esri.geometry.Geometry")],xp);const ic=xp;function mCe(e,t,i,r){var s;return e.x=e.x+t,e.y=e.y+i,r!=null&&(e.z=((s=e.z)!=null?s:0)+r),e}function gCe(e,t){const i=e.x-t.x,r=e.y-t.y,s=e.hasZ&&t.hasZ?e.z-t.z:0;return Math.sqrt(i*i+r*r+s*s)}class kH{constructor(t,i,r,s){this.semiMajorAxis=t,this.flattening=i,this.outerAtmosphereRimWidth=r;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}}const Ei=new kH(6378137,1/298.257223563,3e5,.006694379990137799),cf=new kH(3396190,1/169.8944472236118,23e4),yg=new kH(1737400,0,0),yCe=57.29577951308232,vCe=.017453292519943;function xQ(e){return e*yCe}function TQ(e){return e*vCe}function SQ(e){return e/Ei.radius}function KL(e){return Math.PI/2-2*Math.atan(Math.exp(-e/Ei.radius))}function g8(e){return e.wkid!=null||e.wkt!=null}const JU=[0,0];function eN(e,t,i,r,s){const n=e,o=s;if(o.spatialReference=i,"x"in n&&"x"in o)[o.x,o.y]=t(n.x,n.y,JU,r);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=t(n.xmin,n.ymin,JU,r),[o.xmax,o.ymax]=t(n.xmax,n.ymax,JU,r);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(t(p[f][0],p[f][1],[0,0],r)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=t(a[c][0],a[c][1],[0,0],r),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function K0(e,t){const i=e&&(g8(e)?e:e.spatialReference),r=t&&(g8(t)?t:t.spatialReference);return!(e&&"type"in e&&e.type==="mesh"||t&&"type"in t&&t.type==="mesh"||!i||!r)&&(!!ac(r,i)||Cb(r)&&jR(i)||Cb(i)&&jR(r))}function aw(e,t){if(R(e))return null;const i=e.spatialReference,r=t&&(g8(t)?t:t.spatialReference);return K0(i,r)?ac(i,r)?te(e):Cb(r)?eN(e,TT,Xe.WebMercator,!1,te(e)):jR(r)?eN(e,WA,Xe.WGS84,!1,te(e)):null:null}function TT(e,t,i=[0,0]){t>89.99999?t=89.99999:t<-89.99999&&(t=-89.99999);const r=TQ(t);return i[0]=TQ(e)*Ei.radius,i[1]=Ei.halfSemiMajorAxis*Math.log((1+Math.sin(r))/(1-Math.sin(r))),i}function WA(e,t,i=[0,0],r=!1){const s=xQ(e/Ei.radius);return i[0]=r?s:s-360*Math.floor((s+180)/360),i[1]=xQ(Math.PI/2-2*Math.atan(Math.exp(-t/Ei.radius))),i}function rg(e,t=!1,i=te(e)){return eN(e,TT,Xe.WebMercator,t,i)}function OC(e,t=!1,i=te(e)){return eN(e,WA,Xe.WGS84,t,i)}var P$;const mE=[0,0];function EQ(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}const F3=me.getLogger("esri.geometry.Point");let ka=P$=class extends ic{constructor(...e){super(...e),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}static copy(e,t){t._set("x",e._get("x")),t._set("y",e._get("y")),t._set("z",e._get("z")),t._set("m",e._get("m"));const i=e._get("spatialReference");t._set("spatialReference",Object.isFrozen(i)?i:i.clone())}normalizeCtorArgs(e,t,i,r,s){let n;if(Array.isArray(e))n=e,s=t,e=n[0],t=n[1],i=n[2],r=n[3];else if(e&&typeof e=="object"){if(n=e,e=n.x!=null?n.x:n.longitude,t=n.y!=null?n.y:n.latitude,i=n.z,r=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new Xe(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)F3.warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)F3.warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=TT(n.longitude,n.latitude,mE);e=a[0],t=a[1]}}}else EQ(i)?(s=i,i=null):EQ(r)&&(s=r,r=null);const o={x:e,y:t};return o.x==null&&o.y!=null?F3.warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&F3.warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),i!=null&&(o.z=i),r!=null&&(o.m=r),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(e){e!==(this._get("m")!==void 0)&&(this._set("m",e?0:void 0),this._set("hasM",e))}get hasZ(){return this.z!==void 0}set hasZ(e){e!==(this._get("z")!==void 0)&&(this._set("z",e?0:void 0),this._set("hasZ",e))}get latitude(){const{spatialReference:e,x:t,y:i}=this;if(e){if(e.isWebMercator)return WA(t,i,mE)[1];if(e.isGeographic)return i}return null}set latitude(e){const{spatialReference:t,x:i}=this;t&&(t.isWebMercator?this._set("y",TT(i,e,mE)[1]):t.isGeographic&&this._set("y",e),this._set("latitude",e))}get longitude(){const{x:e,y:t,spatialReference:i}=this;if(i){if(i.isWebMercator)return WA(e,t,mE)[0];if(i.isGeographic)return e}return null}set longitude(e){const{y:t,spatialReference:i}=this;i&&(i.isWebMercator?this._set("x",TT(e,t,mE)[0]):i.isGeographic&&this._set("x",e),this._set("longitude",e))}writeX(e,t,i){t[i]=isNaN(e)?"NaN":e}readX(e){return typeof e=="string"?NaN:e}clone(){const e=new P$;return e.x=this.x,e.y=this.y,e.z=this.z,e.m=this.m,e.spatialReference=this.spatialReference,e}copy(e){return P$.copy(e,this),this}equals(e){if(R(e))return!1;const{x:t,y:i,z:r,m:s,spatialReference:n}=this,{z:o,m:a}=e;let{x:l,y:c,spatialReference:h}=e;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=TT(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=WA(l,c),h=n}return t===l&&i===c&&r===o&&s===a&&n.wkid===h.wkid}offset(e,t,i){return mCe(this,e,t,i)}normalize(){if(!this.spatialReference)return this;const e=J0(this.spatialReference);if(!e)return this;let t=this.x;const[i,r]=e.valid,s=2*r;let n;return t>r?(n=Math.ceil(Math.abs(t-r)/s),t-=n*s):t<i&&(n=Math.ceil(Math.abs(t-i)/s),t+=n*s),this._set("x",t),this}distance(e){return gCe(this,e)}toArray(){const e=this.hasZ,t=this.hasM;return e&&t?[this.x,this.y,this.z,this.m]:e?[this.x,this.y,this.z]:t?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],ka.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],ka.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],ka.prototype,"hasZ",null),u([d({type:Number})],ka.prototype,"latitude",null),u([d({type:Number})],ka.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),Ot(e=>isNaN(e)?e:oh(e))],ka.prototype,"x",void 0),u([Be("x")],ka.prototype,"writeX",null),u([ke("x")],ka.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],ka.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],ka.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],ka.prototype,"m",void 0),ka=P$=u([P("esri.geometry.Point")],ka),ka.prototype.toJSON.isDefaultToJSON=!0;const nt=ka;let cm=class extends oc(fe){constructor(...e){super(...e),this.position=new nt([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,t,i,r){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const s={position:e};return t!=null&&(s.heading=t),i!=null&&(s.tilt=i),r!=null&&(s.fov=r),s}return e}writePosition(e,t,i,r){const s=e.clone();s.x=oh(e.x||0),s.y=oh(e.y||0),s.z=e.hasZ?oh(e.z||0):e.z,t[i]=s.write({},r)}readPosition(e,t){const i=new nt;return i.read(e,t),i.x=oh(i.x||0),i.y=oh(i.y||0),i.z=i.hasZ?oh(i.z||0):i.z,i}equals(e){return!!e&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:nt,json:{write:{isRequired:!0}}})],cm.prototype,"position",void 0),u([Be("position")],cm.prototype,"writePosition",null),u([ke("position")],cm.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Ot(e=>LH.normalize(oh(e)))],cm.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),Ot(e=>$e(oh(e),-180,180))],cm.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],cm.prototype,"fov",void 0),cm=u([P("esri.Camera")],cm);const rc=cm,KU=[0,0];function zH(e,t){return!!_(t)&&ma(e,t.x,t.y,t.z)}function Kyt(e,t){if(!t.points||t.points.length)return!1;for(const i of t.points)if(!MS(e,i))return!1;return!0}function _Ce(e,t){const{xmin:i,ymin:r,zmin:s,xmax:n,ymax:o,zmax:a}=t;return e.hasZ&&t.hasZ?ma(e,i,r,s)&&ma(e,i,o,s)&&ma(e,n,o,s)&&ma(e,n,r,s)&&ma(e,i,r,a)&&ma(e,i,o,a)&&ma(e,n,o,a)&&ma(e,n,r,a):ma(e,i,r)&&ma(e,i,o)&&ma(e,n,o)&&ma(e,n,r)}function MS(e,t){return ma(e,t[0],t[1])}function bCe(e,t){return ma(e,t[0],t[1],t[2])}function ma(e,t,i,r){return t>=e.xmin&&t<=e.xmax&&i>=e.ymin&&i<=e.ymax&&(r==null||!e.hasZ||r>=e.zmin&&r<=e.zmax)}function wCe(e,t){return KU[1]=t.y,KU[0]=t.x,xCe(e,KU)}function xCe(e,t){return Qce(e.rings,t)}function Qce(e,t){if(!e)return!1;if(TCe(e))return CQ(!1,e,t);let i=!1;for(let r=0,s=e.length;r<s;r++)i=CQ(i,e[r],t);return i}function TCe(e){return!Array.isArray(e[0][0])}function CQ(e,t,i){const[r,s]=i;let n=e,o=0;for(let a=0,l=t.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=t[a],[p,f]=t[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<r&&(n=!n)}return n}function SCe(e,t){return zH(e,t)}function ECe(e,t){const i=e.hasZ&&t.hasZ;let r,s,n;if(e.xmin<=t.xmin){if(r=t.xmin,e.xmax<r)return!1}else if(r=e.xmin,t.xmax<r)return!1;if(e.ymin<=t.ymin){if(s=t.ymin,e.ymax<s)return!1}else if(s=e.ymin,t.ymax<s)return!1;if(i&&t.hasZ){if(e.zmin<=t.zmin){if(n=t.zmin,e.zmax<n)return!1}else if(n=e.zmin,t.zmax<n)return!1}return!0}function CCe(e,t){const{points:i,hasZ:r}=t,s=r?bCe:MS;for(const n of i)if(s(e,n))return!0;return!1}const Ab=[0,0],Rb=[0,0],Mb=[0,0],Ob=[0,0],ACe=[Ab,Rb,Mb,Ob],Jce=[[Mb,Ab],[Ab,Rb],[Rb,Ob],[Ob,Mb]];function RCe(e,t){return MCe(e,t.rings)}function MCe(e,t){Ab[0]=e.xmin,Ab[1]=e.ymax,Rb[0]=e.xmax,Rb[1]=e.ymax,Mb[0]=e.xmin,Mb[1]=e.ymin,Ob[0]=e.xmax,Ob[1]=e.ymin;for(const i of ACe)if(Qce(t,i))return!0;for(const i of t){if(!i.length)continue;let r=i[0];if(MS(e,r))return!0;for(let s=1;s<i.length;s++){const n=i[s];if(MS(e,n)||Kce(r,n,Jce))return!0;r=n}}return!1}function OCe(e,t){Ab[0]=e.xmin,Ab[1]=e.ymax,Rb[0]=e.xmax,Rb[1]=e.ymax,Mb[0]=e.xmin,Mb[1]=e.ymin,Ob[0]=e.xmax,Ob[1]=e.ymin;const i=t.paths;for(const r of i){if(!i.length)continue;let s=r[0];if(MS(e,s))return!0;for(let n=1;n<r.length;n++){const o=r[n];if(MS(e,o)||Kce(s,o,Jce))return!0;s=o}}return!1}const ao=[0,0];function PCe(e){for(let t=0;t<e.length;t++){const i=e[t];for(let s=0;s<i.length-1;s++){const n=i[s],o=i[s+1];for(let a=t+1;a<e.length;a++)for(let l=0;l<e[a].length-1;l++){const c=e[a][l],h=e[a][l+1];if(y8(n,o,c,h,ao)&&!(ao[0]===n[0]&&ao[1]===n[1]||ao[0]===c[0]&&ao[1]===c[1]||ao[0]===o[0]&&ao[1]===o[1]||ao[0]===h[0]&&ao[1]===h[1]))return!0}}const r=i.length;if(!(r<=4))for(let s=0;s<r-3;s++){let n=r-1;s===0&&(n=r-2);const o=i[s],a=i[s+1];for(let l=s+2;l<n;l++){const c=i[l],h=i[l+1];if(y8(o,a,c,h,ao)&&!(ao[0]===o[0]&&ao[1]===o[1]||ao[0]===c[0]&&ao[1]===c[1]||ao[0]===a[0]&&ao[1]===a[1]||ao[0]===h[0]&&ao[1]===h[1]))return!0}}}return!1}function Kce(e,t,i){for(let r=0;r<i.length;r++)if(y8(e,t,i[r][0],i[r][1]))return!0;return!1}function y8(e,t,i,r,s){const[n,o]=e,[a,l]=t,[c,h]=i,[p,f]=r,m=p-c,y=n-c,v=a-n,w=f-h,b=o-h,S=l-o,T=w*v-m*S;if(T===0)return!1;const E=(m*b-w*y)/T,C=(v*b-S*y)/T;return E>=0&&E<=1&&C>=0&&C<=1&&(s&&(s[0]=n+E*(a-n),s[1]=o+E*(l-o)),!0)}function ICe(e){switch(e){case"esriGeometryEnvelope":case"extent":return ECe;case"esriGeometryMultipoint":case"multipoint":return CCe;case"esriGeometryPoint":case"point":return SCe;case"esriGeometryPolygon":case"polygon":return RCe;case"esriGeometryPolyline":case"polyline":return OCe}}var Nu;function $Ce(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}function qg(e,t,i){return t==null?i:i==null?t:e(t,i)}let Dn=Nu=class extends ic{constructor(...e){super(...e),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(e,t,i,r,s){return $Ce(e)?{spatialReference:e,xmin:0,ymin:0,xmax:0,ymax:0}:typeof e=="object"?(e.spatialReference=e.spatialReference==null?Xe.WGS84:e.spatialReference,e):{xmin:e,ymin:t,xmax:i,ymax:r,spatialReference:s==null?Xe.WGS84:s}}static fromBounds(e,t){return new Nu({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}static fromPoint(e){return new Nu({xmin:e.x,ymin:e.y,zmin:e.z,xmax:e.x,ymax:e.y,zmax:e.z,spatialReference:e.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const e=new nt({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(e.z=.5*(this.zmin+this.zmax)),this.hasM&&(e.m=.5*(this.mmin+this.mmax)),e}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(e){const t=this.center;return e.z!=null&&this.hasZ?this.offset(e.x-t.x,e.y-t.y,e.z-t.z):this.offset(e.x-t.x,e.y-t.y)}clone(){const e=new Nu;return e.xmin=this.xmin,e.ymin=this.ymin,e.xmax=this.xmax,e.ymax=this.ymax,e.spatialReference=this.spatialReference,this.zmin!=null&&(e.zmin=this.zmin,e.zmax=this.zmax),this.mmin!=null&&(e.mmin=this.mmin,e.mmax=this.mmax),e}contains(e){if(!e)return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&K0(t,i)&&(e=t.isWebMercator?rg(e):OC(e,!0)),e.type==="point"?zH(this,e):e.type==="extent"&&_Ce(this,e)}equals(e){if(this===e)return!0;if(R(e))return!1;const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&K0(t,i)&&(e=t.isWebMercator?rg(e):OC(e,!0)),this.xmin===e.xmin&&this.ymin===e.ymin&&this.zmin===e.zmin&&this.mmin===e.mmin&&this.xmax===e.xmax&&this.ymax===e.ymax&&this.zmax===e.zmax&&this.mmax===e.mmax}expand(e){const t=.5*(1-e),i=this.width*t,r=this.height*t;if(this.xmin+=i,this.ymin+=r,this.xmax-=i,this.ymax-=r,this.hasZ){const s=(this.zmax-this.zmin)*t;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*t;this.mmin+=s,this.mmax-=s}return this}intersects(e){if(R(e))return!1;e.type==="mesh"&&(e=e.extent);const t=this.spatialReference,i=e.spatialReference;return t&&i&&!t.equals(i)&&K0(t,i)&&(e=t.isWebMercator?rg(e):OC(e,!0)),ICe(e.type)(this,e)}normalize(){const e=this._normalize(!1,!0);return Array.isArray(e)?e:[e]}offset(e,t,i){return this.xmin+=e,this.ymin+=t,this.xmax+=e,this.ymax+=t,i!=null&&(this.zmin+=i,this.zmax+=i),this}shiftCentralMeridian(){return this._normalize(!0)}union(e){return this===e||(this.xmin=Math.min(this.xmin,e.xmin),this.ymin=Math.min(this.ymin,e.ymin),this.xmax=Math.max(this.xmax,e.xmax),this.ymax=Math.max(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=qg(Math.min,this.zmin,e.zmin),this.zmax=qg(Math.max,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=qg(Math.min,this.mmin,e.mmin),this.mmax=qg(Math.max,this.mmax,e.mmax))),this}intersection(e){return this===e?this:R(e)||!this.intersects(e)?null:(this.xmin=Math.max(this.xmin,e.xmin),this.ymin=Math.max(this.ymin,e.ymin),this.xmax=Math.min(this.xmax,e.xmax),this.ymax=Math.min(this.ymax,e.ymax),(this.hasZ||e.hasZ)&&(this.zmin=qg(Math.max,this.zmin,e.zmin),this.zmax=qg(Math.min,this.zmax,e.zmax)),(this.hasM||e.hasM)&&(this.mmin=qg(Math.max,this.mmin,e.mmin),this.mmax=qg(Math.min,this.mmax,e.mmax)),this)}toJSON(e){return this.write({},e)}_shiftCM(e=J0(this.spatialReference)){if(!e||!this.spatialReference)return this;const t=this.spatialReference,i=this._getCM(e);if(i){const r=t.isWebMercator?OC(i):i;this.xmin-=i.x,this.xmax-=i.x,t.isWebMercator||(r.x=this._normalizeX(r.x,e).x),this.spatialReference=new Xe(gf(t.isWGS84?e.altTemplate:e.wkTemplate,{Central_Meridian:r.x}))}return this}_getCM(e){let t=null;const[i,r]=e.valid,s=this.xmin,n=this.xmax;return s>=i&&s<=r&&n>=i&&n<=r||(t=this.center),t}_normalize(e,t,i){const r=this.spatialReference;if(!r)return this;if(!(i=i||J0(r)))return this;const s=this._getParts(i).map(a=>a.extent);if(s.length<2)return s[0]||this;if(s.length>2)return e?this._shiftCM(i):this.set({xmin:i.valid[0],xmax:i.valid[1]});if(e)return this._shiftCM(i);if(t)return s;let n=!0,o=!0;return s.forEach(a=>{a.hasZ||(n=!1),a.hasM||(o=!1)}),{rings:s.map(a=>{const l=[[a.xmin,a.ymin],[a.xmin,a.ymax],[a.xmax,a.ymax],[a.xmax,a.ymin],[a.xmin,a.ymin]];if(n){const c=(a.zmax-a.zmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}if(o){const c=(a.mmax-a.mmin)/2;for(let h=0;h<l.length;h++)l[h].push(c)}return l}),hasZ:n,hasM:o,spatialReference:r}}_getParts(e){let t=this.cache._parts;if(!t){t=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;e=e||J0(o);const[p,f]=e.valid;h=this._normalizeX(this.xmin,e);const m=h.x,y=h.frameId;h=this._normalizeX(this.xmax,e);const v=h.x,w=h.frameId,b=m===v&&a>0;if(a>2*f){const S=new Nu(l<c?m:v,s,f,n,o),T=new Nu(p,s,l<c?v:m,n,o),E=new Nu(0,s,f,n,o),C=new Nu(p,s,0,n,o),M=[],I=[];S.contains(E)&&M.push(y),S.contains(C)&&I.push(y),T.contains(E)&&M.push(w),T.contains(C)&&I.push(w);for(let N=y+1;N<w;N++)M.push(N),I.push(N);t.push({extent:S,frameIds:[y]},{extent:T,frameIds:[w]},{extent:E,frameIds:M},{extent:C,frameIds:I})}else m>v||b?t.push({extent:new Nu(m,s,f,n,o),frameIds:[y]},{extent:new Nu(p,s,v,n,o),frameIds:[w]}):t.push({extent:new Nu(m,s,v,n,o),frameIds:[y]});this.cache._parts=t}const i=this.hasZ,r=this.hasM;if(i||r){const s={};i&&(s.zmin=this.zmin,s.zmax=this.zmax),r&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<t.length;n++)t[n].extent.set(s)}return t}_normalizeX(e,t){const[i,r]=t.valid,s=2*r;let n,o=0;return e>r?(n=Math.ceil(Math.abs(e-r)/s),e-=n*s,o=n):e<i&&(n=Math.ceil(Math.abs(e-i)/s),e+=n*s,o=-n),{x:e,frameId:o}}};u([d({readOnly:!0})],Dn.prototype,"cache",null),u([d({readOnly:!0})],Dn.prototype,"center",null),u([d({readOnly:!0})],Dn.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],Dn.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],Dn.prototype,"hasZ",null),u([d({readOnly:!0})],Dn.prototype,"height",null),u([d({readOnly:!0})],Dn.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],Dn.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],Dn.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],Dn.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Dn.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],Dn.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],Dn.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],Dn.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Dn.prototype,"zmax",void 0),Dn=Nu=u([P("esri.geometry.Extent")],Dn),Dn.prototype.toJSON.isDefaultToJSON=!0;const ci=Dn;function OS(e,t,i=!1){let{hasM:r,hasZ:s}=e;Array.isArray(t)?t.length!==4||r||s?t.length===3&&i&&!r?(s=!0,r=!1):t.length===3&&r&&s&&(r=!1,s=!1):(r=!0,s=!0):(s=!s&&t.hasZ&&(!r||t.hasM),r=!r&&t.hasM&&(!s||t.hasZ)),e.hasZ=s,e.hasM=r}var v8;function AQ(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}function DCe(e){return e&&(e.declaredClass==="esri.geometry.SpatialReference"||e.wkid!=null)}let Py=v8=class extends ic{constructor(...e){super(...e),this.points=[],this.type="multipoint"}normalizeCtorArgs(e,t){if(!e&&!t)return null;const i={};Array.isArray(e)?(i.points=e,i.spatialReference=t):DCe(e)?i.spatialReference=e:(e.points&&(i.points=e.points),e.spatialReference&&(i.spatialReference=e.spatialReference),e.hasZ&&(i.hasZ=e.hasZ),e.hasM&&(i.hasM=e.hasM));const r=i.points&&i.points[0];return r&&(i.hasZ===void 0&&i.hasM===void 0?(i.hasZ=r.length>2,i.hasM=!1):i.hasZ===void 0?i.hasZ=r.length>3:i.hasM===void 0&&(i.hasM=r.length>3)),i}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const e=this.points;if(!e.length)return null;const t=new ci,i=this.hasZ,r=this.hasM,s=i?3:2,n=e[0],o=AQ(Math.min),a=AQ(Math.max);let l,c,h,p,[f,m]=n,[y,v]=n;for(let w=0,b=e.length;w<b;w++){const S=e[w],[T,E]=S;if(f=o(f,T),m=o(m,E),y=a(y,T),v=a(v,E),i&&S.length>2){const C=S[2];l=o(l,C),h=a(h,C)}if(r&&S.length>s){const C=S[s];c=o(c,C),p=a(p,C)}}return t.xmin=f,t.ymin=m,t.xmax=y,t.ymax=v,t.spatialReference=this.spatialReference,i?(t.zmin=l,t.zmax=h):(t.zmin=null,t.zmax=null),r?(t.mmin=c,t.mmax=p):(t.mmin=null,t.mmax=null),t}writePoints(e,t){t.points=te(this.points)}addPoint(e){return OS(this,e),Array.isArray(e)?this.points.push(e):this.points.push(e.toArray()),this.notifyChange("points"),this}clone(){const e={points:te(this.points),spatialReference:this.spatialReference};return this.hasZ&&(e.hasZ=!0),this.hasM&&(e.hasM=!0),new v8(e)}getPoint(e){if(!this._validateInputs(e))return null;const t=this.points[e],i={x:t[0],y:t[1],spatialReference:this.spatialReference};let r=2;return this.hasZ&&(i.z=t[2],r=3),this.hasM&&(i.m=t[r]),new nt(i)}removePoint(e){if(!this._validateInputs(e))return null;const t=new nt(this.points.splice(e,1)[0],this.spatialReference);return this.notifyChange("points"),t}setPoint(e,t){return this._validateInputs(e)?(OS(this,t),Array.isArray(t)||(t=t.toArray()),this.points[e]=t,this.notifyChange("points"),this):this}toJSON(e){return this.write({},e)}_validateInputs(e){return e!=null&&e>=0&&e<this.points.length}};u([d({readOnly:!0})],Py.prototype,"cache",null),u([d()],Py.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],Py.prototype,"points",void 0),u([Be("points")],Py.prototype,"writePoints",null),Py=v8=u([P("esri.geometry.Multipoint")],Py),Py.prototype.toJSON.isDefaultToJSON=!0;const lw=Py;function VH(e,t){const i=t[0]-e[0],r=t[1]-e[1];if(e.length>2&&t.length>2){const s=e[2]-t[2];return Math.sqrt(i*i+r*r+s*s)}return Math.sqrt(i*i+r*r)}function eue(e,t,i){const r=e[0]+i*(t[0]-e[0]),s=e[1]+i*(t[1]-e[1]);return e.length>2&&t.length>2?[r,s,e[2]+i*(t[2]-e[2])]:[r,s]}function LCe(e,t){return eue(e,t,.5)}function tue(e){const t=e.length;let i=0;for(let r=0;r<t-1;++r)i+=VH(e[r],e[r+1]);return i}function iue(e,t){if(t<=0)return e[0];const i=e.length;let r=0;for(let s=0;s<i-1;++s){const n=VH(e[s],e[s+1]);if(t-r<n){const o=(t-r)/n;return eue(e[s],e[s+1],o)}r+=n}return e[i-1]}function BH(e,t,i){const r=e.length;let s=0,n=0,o=0;for(let a=0;a<r;a++){const l=e[a],c=e[(a+1)%r];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&i&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&t&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function e0t(e){if("rings"in e)for(const t of e.rings)t.length<3||t[0][0]===t[t.length-1][0]&&t[0][1]===t[t.length-1][1]||t.push([t[0][0],t[0][1]])}function t0t(e){return e?e.hasZ?[e.xmax-e.xmin/2,e.ymax-e.ymin/2,e.zmax-e.zmin/2]:[e.xmax-e.xmin/2,e.ymax-e.ymin/2]:null}function NCe(e){return e?rue(e.rings,e.hasZ):null}function rue(e,t){if(!e||!e.length)return null;const i=[],r=[],s=t?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=e.length;n<o;n++){const a=FCe(e[n],t,s);a&&r.push(a)}if(r.sort((n,o)=>{let a=n[2]-o[2];return a===0&&t&&(a=n[4]-o[4]),a}),r.length&&(i[0]=r[0][0],i[1]=r[0][1],t&&(i[2]=r[0][3]),(i[0]<s[0]||i[0]>s[1]||i[1]<s[2]||i[1]>s[3]||t&&(i[2]<s[4]||i[2]>s[5]))&&(i.length=0)),!i.length){const n=e[0]&&e[0].length?UCe(e[0],t):null;if(!n)return null;i[0]=n[0],i[1]=n[1],t&&n.length>2&&(i[2]=n[2])}return i}function FCe(e,t,i){let r=0,s=0,n=0,o=0,a=0;const l=e.length?e[0][0]:0,c=e.length?e[0][1]:0,h=e.length&&t?e[0][2]:0;for(let f=0;f<e.length;f++){const m=e[f],y=e[(f+1)%e.length],[v,w,b]=m,S=v-l,T=w-c,E=t?b-h:void 0,[C,M,I]=y,N=C-l,D=M-c,z=t?I-h:void 0,V=S*D-N*T;if(o+=V,r+=(S+N)*V,s+=(T+D)*V,t&&m.length>2&&y.length>2){const k=S*z-N*E;n+=(E+z)*k,a+=k}v<i[0]&&(i[0]=v),v>i[1]&&(i[1]=v),w<i[2]&&(i[2]=w),w>i[3]&&(i[3]=w),t&&(b<i[4]&&(i[4]=b),b>i[5]&&(i[5]=b))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[r/(6*o)+l,s/(6*o)+c,o];return t&&(i[4]===i[5]||a===0?(p[3]=(i[4]+i[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function UCe(e,t){const i=t?[0,0,0]:[0,0],r=t?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=e.length;l<c-1;l++){const h=e[l],p=e[l+1];if(h&&p){i[0]=h[0],i[1]=h[1],r[0]=p[0],r[1]=p[1],t&&h.length>2&&p.length>2&&(i[2]=h[2],r[2]=p[2]);const f=VH(i,r);if(f){s+=f;const m=LCe(h,p);n+=f*m[0],o+=f*m[1],t&&m.length>2&&(a+=f*m[2])}}}return s>0?t?[n/s,o/s,a/s]:[n/s,o/s]:e.length?e[0]:null}function sue(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function nue(e){return e.points!==void 0}function oue(e){return e.x!==void 0&&e.y!==void 0}function aue(e){return e.paths!==void 0}function lue(e){return e.rings!==void 0}function cue(e){return(t,i)=>t==null?i:i==null?t:e(t,i)}const I0=cue(Math.min),$0=cue(Math.max);function i0t(e,t){return aue(t)?PS(e,t.paths,!1,!1):lue(t)?PS(e,t.rings,!1,!1):nue(t)?GH(e,t.points,!1,!1,!1,!1):sue(t)?uue(e,t):(oue(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.x,e[3]=t.y),e)}function r0t(e,t){return aue(t)?PS(e,t.paths,!0,!1):lue(t)?PS(e,t.rings,!0,!1):nue(t)?GH(e,t.points,!0,!1,!0,!1):sue(t)?uue(e,t,!0,!1,!0,!1):(oue(t)&&(e[0]=t.x,e[1]=t.y,e[2]=t.z,e[3]=t.x,e[4]=t.y,e[5]=t.z),e)}function PS(e,t,i,r){const s=i?3:2;if(!t.length||!t[0].length)return null;let n,o,a,l,[c,h]=t[0][0],[p,f]=t[0][0];for(let m=0;m<t.length;m++){const y=t[m];for(let v=0;v<y.length;v++){const w=y[v],[b,S]=w;if(c=I0(c,b),h=I0(h,S),p=$0(p,b),f=$0(f,S),i&&w.length>2){const T=w[2];n=I0(n,T),o=$0(o,T)}if(r&&w.length>s){const T=w[s];a=I0(n,T),l=$0(o,T)}}}return i?r?(e[0]=c,e[1]=h,e[2]=n,e[3]=a,e[4]=p,e[5]=f,e[6]=o,e[7]=l,e.length=8,e):(e[0]=c,e[1]=h,e[2]=n,e[3]=p,e[4]=f,e[5]=o,e.length=6,e):r?(e[0]=c,e[1]=h,e[2]=a,e[3]=p,e[4]=f,e[5]=l,e.length=6,e):(e[0]=c,e[1]=h,e[2]=p,e[3]=f,e.length=4,e)}function uue(e,t,i,r,s,n){const o=t.xmin,a=t.xmax,l=t.ymin,c=t.ymax;let h=t.zmin,p=t.zmax,f=t.mmin,m=t.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,m=m||0,e[0]=o,e[1]=l,e[2]=h,e[3]=f,e[4]=a,e[5]=c,e[6]=p,e[7]=m,e):(e[0]=o,e[1]=l,e[2]=h,e[3]=a,e[4]=c,e[5]=p,e)):n?(f=f||0,m=m||0,e[0]=o,e[1]=l,e[2]=f,e[3]=a,e[4]=c,e[5]=m,e):(e[0]=o,e[1]=l,e[2]=a,e[3]=c,e)}function GH(e,t,i,r,s,n){const o=i?3:2,a=r&&n,l=i&&s;if(!t.length||!t[0].length)return null;let c,h,p,f,[m,y]=t[0],[v,w]=t[0];for(let b=0;b<t.length;b++){const S=t[b],[T,E]=S;if(m=I0(m,T),y=I0(y,E),v=$0(v,T),w=$0(w,E),l&&S.length>2){const C=S[2];c=I0(c,C),h=$0(h,C)}if(a&&S.length>o){const C=S[o];p=I0(c,C),f=$0(h,C)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,e[0]=m,e[1]=y,e[2]=c,e[3]=p,e[4]=v,e[5]=w,e[6]=h,e[7]=f,e):(e[0]=m,e[1]=y,e[2]=c,e[3]=v,e[4]=w,e[5]=h,e)):n?(p=p||0,f=f||0,e[0]=m,e[1]=y,e[2]=p,e[3]=v,e[4]=w,e[5]=f,e):(e[0]=m,e[1]=y,e[2]=v,e[3]=w,e)}function kCe(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function zCe(e){return e.points!==void 0}function VCe(e){return e.x!==void 0&&e.y!==void 0}function BCe(e){return e.paths!==void 0}function GCe(e){return e.rings!==void 0}const jH=[];function hue(e,t,i,r){return{xmin:e,ymin:t,xmax:i,ymax:r}}function due(e,t,i,r,s,n){return{xmin:e,ymin:t,zmin:i,xmax:r,ymax:s,zmax:n}}function pue(e,t,i,r,s,n){return{xmin:e,ymin:t,mmin:i,xmax:r,ymax:s,mmax:n}}function fue(e,t,i,r,s,n,o,a){return{xmin:e,ymin:t,zmin:i,mmin:r,xmax:s,ymax:n,zmax:o,mmax:a}}function HH(e,t=!1,i=!1){return t?i?fue(e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7]):due(e[0],e[1],e[2],e[3],e[4],e[5]):i?pue(e[0],e[1],e[2],e[3],e[4],e[5]):hue(e[0],e[1],e[2],e[3])}function s0t(e){return e?kCe(e)?e:VCe(e)?HCe(e):GCe(e)?mue(e):BCe(e)?gue(e):zCe(e)?jCe(e):null:null}function jCe(e){const{hasZ:t,hasM:i,points:r}=e;return HH(GH(jH,r,t,i),t,i)}function HCe(e){const{x:t,y:i,z:r,m:s}=e,n=s!=null;return r!=null?n?fue(t,i,r,s,t,i,r,s):due(t,i,r,t,i,r):n?pue(t,i,s,t,i,s):hue(t,i,t,i)}function mue(e){const{hasZ:t,hasM:i,rings:r}=e,s=PS(jH,r,t,i);return s?HH(s,t,i):null}function gue(e){const{hasZ:t,hasM:i,paths:r}=e,s=PS(jH,r,t,i);return s?HH(s,t,i):null}var I$;function RQ(e){return!Array.isArray(e[0])}let Tp=I$=class extends ic{constructor(...e){super(...e),this.rings=[],this.type="polygon"}static fromExtent(e){const t=e.clone().normalize(),i=e.spatialReference;let r=!1,s=!1;for(const o of t)o.hasZ&&(r=!0),o.hasM&&(s=!0);const n={rings:t.map(o=>{const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(r&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:i};return r&&(n.hasZ=!0),s&&(n.hasM=!0),new I$(n)}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.rings?e.rings:null,t||(e.spatialReference?t=e.spatialReference:e.rings||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||Xe.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=n.length>3):i===void 0?i=r?n.length>3:n.length>2:r===void 0&&(r=i?n.length>3:n.length>2)),{rings:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const e=NCe(this);if(!e||isNaN(e[0])||isNaN(e[1])||this.hasZ&&isNaN(e[2]))return null;const t=new nt;return t.x=e[0],t.y=e[1],t.spatialReference=this.spatialReference,this.hasZ&&(t.z=e[2]),t}get extent(){const{spatialReference:e}=this,t=mue(this);if(!t)return null;const i=new ci(t);return i.spatialReference=e,i}get isSelfIntersecting(){return PCe(this.rings)}writeRings(e,t){t.rings=te(this.rings)}addRing(e){if(!e)return;const t=this.rings,i=t.length;if(RQ(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("rings"),this}clone(){const e=new I$;return e.spatialReference=this.spatialReference,e.rings=te(this.rings),e.hasZ=this.hasZ,e.hasM=this.hasM,e}equals(e){if(this===e)return!0;if(R(e))return!1;const t=this.spatialReference,i=e.spatialReference;if(_(t)!==_(i)||_(t)&&_(i)&&!t.equals(i)||this.rings.length!==e.rings.length)return!1;const r=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=e.rings[s];if(!uv(n,o,r))return!1}return!0}contains(e){if(!e)return!1;const t=aw(e,this.spatialReference);return wCe(this,_(t)?t:e)}isClockwise(e){let t;return t=RQ(e)?e.map(i=>this.hasZ?this.hasM?[i.x,i.y,i.z,i.m]:[i.x,i.y,i.z]:[i.x,i.y]):e,BH(t,this.hasM,this.hasZ)}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.rings[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new nt(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new nt(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new nt(i[0],i[1],i[2],i[3],this.spatialReference):new nt(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(OS(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e].splice(t,0,i),this.notifyChange("rings"),this):this}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new nt(this.rings[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("rings"),i}removeRing(e){if(!this._validateInputs(e,null))return null;const t=this.rings.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new nt(s,i));return this.notifyChange("rings"),r}setPoint(e,t,i){return this._validateInputs(e,t)?(OS(this,i),Array.isArray(i)||(i=i.toArray()),this.rings[e][t]=i,this.notifyChange("rings"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.rings.length)return!1;if(t!=null){const r=this.rings[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],Tp.prototype,"cache",null),u([d({readOnly:!0})],Tp.prototype,"centroid",null),u([d({readOnly:!0})],Tp.prototype,"extent",null),u([d({readOnly:!0})],Tp.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Tp.prototype,"rings",void 0),u([Be("rings")],Tp.prototype,"writeRings",null),Tp=I$=u([P("esri.geometry.Polygon")],Tp),Tp.prototype.toJSON.isDefaultToJSON=!0;const cu=Tp;var _8;function qCe(e){return!Array.isArray(e[0])}let Iy=_8=class extends ic{constructor(...e){super(...e),this.paths=[],this.type="polyline"}normalizeCtorArgs(e,t){let i,r,s=null,n=null;return e&&!Array.isArray(e)?(s=e.paths?e.paths:null,t||(e.spatialReference?t=e.spatialReference:e.paths||(t=e)),i=e.hasZ,r=e.hasM):s=e,s=s||[],t=t||Xe.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(i===void 0&&r===void 0?(i=n.length>2,r=!1):i===void 0?i=!r&&n.length>3:r===void 0&&(r=!i&&n.length>3)),{paths:s,spatialReference:t,hasZ:i,hasM:r}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:e}=this,t=gue(this);if(!t)return null;const i=new ci(t);return i.spatialReference=e,i}writePaths(e,t){t.paths=te(this.paths)}addPath(e){if(!e)return;const t=this.paths,i=t.length;if(qCe(e)){const r=[];for(let s=0,n=e.length;s<n;s++)r[s]=e[s].toArray();t[i]=r}else t[i]=e.concat();return this.notifyChange("paths"),this}clone(){const e=new _8;return e.spatialReference=this.spatialReference,e.paths=te(this.paths),e.hasZ=this.hasZ,e.hasM=this.hasM,e}getPoint(e,t){if(!this._validateInputs(e,t))return null;const i=this.paths[e][t],r=this.hasZ,s=this.hasM;return r&&!s?new nt(i[0],i[1],i[2],void 0,this.spatialReference):s&&!r?new nt(i[0],i[1],void 0,i[2],this.spatialReference):r&&s?new nt(i[0],i[1],i[2],i[3],this.spatialReference):new nt(i[0],i[1],this.spatialReference)}insertPoint(e,t,i){return this._validateInputs(e,t,!0)?(OS(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e].splice(t,0,i),this.notifyChange("paths"),this):this}removePath(e){if(!this._validateInputs(e,null))return null;const t=this.paths.splice(e,1)[0],i=this.spatialReference,r=t.map(s=>new nt(s,i));return this.notifyChange("paths"),r}removePoint(e,t){if(!this._validateInputs(e,t))return null;const i=new nt(this.paths[e].splice(t,1)[0],this.spatialReference);return this.notifyChange("paths"),i}setPoint(e,t,i){return this._validateInputs(e,t)?(OS(this,i),Array.isArray(i)||(i=i.toArray()),this.paths[e][t]=i,this.notifyChange("paths"),this):this}_validateInputs(e,t,i=!1){if(e==null||e<0||e>=this.paths.length)return!1;if(t!=null){const r=this.paths[e];if(i&&(t<0||t>r.length)||!i&&(t<0||t>=r.length))return!1}return!0}toJSON(e){return this.write({},e)}};u([d({readOnly:!0})],Iy.prototype,"cache",null),u([d({readOnly:!0})],Iy.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],Iy.prototype,"paths",void 0),u([Be("paths")],Iy.prototype,"writePaths",null),Iy=_8=u([P("esri.geometry.Polyline")],Iy),Iy.prototype.toJSON.isDefaultToJSON=!0;const Jc=Iy;class _i{constructor(t,i={ignoreUnknown:!1,useNumericKeys:!1}){this.jsonToAPI=t,this.options=i,this.apiValues=[],this.jsonValues=[],this.apiToJSON=this._invertMap(t),this.apiValues=this._getKeysSorted(this.apiToJSON),this.jsonValues=this._getKeysSorted(this.jsonToAPI),this.read=r=>this.fromJSON(r),this.write=(r,s,n)=>{const o=this.toJSON(r);o!==void 0&&tc(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(t){if(this.apiToJSON.hasOwnProperty(t)){const i=this.apiToJSON[t];return this.options.useNumericKeys?+i:i}return this.options.ignoreUnknown?void 0:t}fromJSON(t){return this.jsonToAPI.hasOwnProperty(t)?this.jsonToAPI[t]:this.options.ignoreUnknown?void 0:t}_invertMap(t){const i={};for(const r in t)i[t[r]]=r;return i}_getKeysSorted(t){const i=[];for(const r in t)i.push(r);return i.sort(),i}}function Zo(){return function(e,t){return new _i(e,F({ignoreUnknown:!0},t))}}const yue=Zo()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),MQ=Zo()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function vue(e){return e.xmin!==void 0&&e.ymin!==void 0&&e.xmax!==void 0&&e.ymax!==void 0}function qH(e){return e.points!==void 0}function WH(e){return e.x!==void 0&&e.y!==void 0}function XH(e){return e.paths!==void 0}function lb(e){return e.rings!==void 0}function yf(e){return R(e)?null:e instanceof ic?e:WH(e)?nt.fromJSON(e):XH(e)?Jc.fromJSON(e):lb(e)?cu.fromJSON(e):qH(e)?lw.fromJSON(e):vue(e)?ci.fromJSON(e):null}function k2(e){return e?WH(e)?"esriGeometryPoint":XH(e)?"esriGeometryPolyline":lb(e)?"esriGeometryPolygon":vue(e)?"esriGeometryEnvelope":qH(e)?"esriGeometryMultipoint":null:null}const WCe={esriGeometryPoint:nt,esriGeometryPolyline:Jc,esriGeometryPolygon:cu,esriGeometryEnvelope:ci,esriGeometryMultipoint:lw};function _ue(e){return e&&WCe[e]||null}const cw={base:ic,key:"type",typeMap:{extent:ci,multipoint:lw,point:nt,polyline:Jc,polygon:cu}};qd(cw);class QT{constructor(){this._emitter=new QT.EventEmitter(this)}emit(t,i){return this._emitter.emit(t,i)}on(t,i){return this._emitter.on(t,i)}once(t,i){return this._emitter.once(t,i)}hasEventListener(t){return this._emitter.hasEventListener(t)}}(function(e){class t{constructor(s=null){this.target=s,this._listenersMap=null}clear(){this._listenersMap&&this._listenersMap.clear(),this._listenersMap=null}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this.target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return ES(a)}if(s.includes(","))throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}e.EventEmitter=t,e.EventedMixin=r=>{let s=class extends r{constructor(){super(...arguments),this._emitter=new t}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([P("esri.core.Evented")],s),s};let i=class extends Ee{constructor(){super(...arguments),this._emitter=new QT.EventEmitter(this)}destroy(){this._emitter.clear()}emit(r,s){return this._emitter.emit(r,s)}on(r,s){return this._emitter.on(r,s)}once(r,s){return this._emitter.once(r,s)}hasEventListener(r){return this._emitter.hasEventListener(r)}};i=u([P("esri.core.Evented")],i),e.EventedAccessor=i})(QT||(QT={}));const us=QT;var ji;(function(e){e[e.ADD=1]="ADD",e[e.REMOVE=2]="REMOVE",e[e.MOVE=4]="MOVE"})(ji||(ji={}));function YH(e){return(t,i)=>{t[i]=e}}class bue{constructor(){this._observers=[]}observe(t){return this._observers.includes(t)||this._observers.push(t),new Pce(this._observers,t)}notify(){const t=this._observers.slice();for(let i=0;i<t.length;++i){const r=t[i];r.onInvalidated(),r.onCommitted()}}}var Gm;class XCe{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(t){this.defaultPrevented=!1,this.item=t}}const Tu=new ys(XCe,void 0,e=>{e.item=null,e.target=null,e.defaultPrevented=!1,e.cancellable=!1}),YCe=()=>{};function ek(e){return e?e instanceof R1?e.toArray():e.length?Array.prototype.slice.apply(e):[]:[]}function tk(e){if(e&&e.length)return e[0]}function ZCe(e,t,i,r){const s=Math.min(e.length-i,t.length-r);let n=0;for(;n<s&&e[i+n]===t[r+n];)n++;return n}function wue(e,t,i,r){t&&t.forEach((s,n,o)=>{e.push(s),wue(e,i.call(r,s,n,o),i,r)})}const Wg=new Set,Xg=new Set,Yg=new Set,ik=new Map;let QCe=0,R1=Gm=class extends us.EventedAccessor{constructor(e){super(e),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new bue,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:QCe++})}static isCollection(e){return e!=null&&e instanceof Gm}normalizeCtorArgs(e){return e?Array.isArray(e)||e instanceof Gm?{items:e}:e:{}}destroy(){this.removeAll()}*[Symbol.iterator](){yield*this.items}get items(){return Yt(this._observable),this._items}set items(e){this._emitBeforeChanges(ji.ADD)||(this._splice(0,this.length,ek(e)),this._emitAfterChanges(ji.ADD))}hasEventListener(e){return e==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(e)}on(e,t){if(e==="change"){const i=this._chgListeners,r={removed:!1,callback:t};return i.push(r),this._notifications&&this._notifications.push({listeners:i.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=YCe,r.removed=!0,i.splice(i.indexOf(r),1)}}}return this._emitter.on(e,t)}once(e,t){const i=this.on(e,t);return{remove(){i.remove()}}}add(e,t){if(Yt(this._observable),this._emitBeforeChanges(ji.ADD))return this;const i=this.getNextIndex(t!=null?t:null);return this._splice(i,0,[e]),this._emitAfterChanges(ji.ADD),this}addMany(e,t=this._items.length){if(Yt(this._observable),!e||!e.length)return this;if(this._emitBeforeChanges(ji.ADD))return this;const i=this.getNextIndex(t);return this._splice(i,0,ek(e)),this._emitAfterChanges(ji.ADD),this}at(e){if(Yt(this._observable),(e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this._items[e]}removeAll(){if(Yt(this._observable),!this.length||this._emitBeforeChanges(ji.REMOVE))return[];const e=this._splice(0,this.length)||[];return this._emitAfterChanges(ji.REMOVE),e}clone(){return Yt(this._observable),this._createNewInstance({items:this._items.map(te)})}concat(...e){Yt(this._observable);const t=e.map(ek);return this._createNewInstance({items:this._items.concat(...t)})}drain(e,t){if(Yt(this._observable),!this.length||this._emitBeforeChanges(ji.REMOVE))return;const i=this._splice(0,this.length),r=i.length;for(let s=0;s<r;s++)e.call(t,i[s],s,i);this._emitAfterChanges(ji.REMOVE)}every(e,t){return Yt(this._observable),this._items.every(e,t)}filter(e,t){let i;return Yt(this._observable),i=arguments.length===2?this._items.filter(e,t):this._items.filter(e),this._createNewInstance({items:i})}find(e,t){return Yt(this._observable),this._items.find(e,t)}findIndex(e,t){return Yt(this._observable),this._items.findIndex(e,t)}flatten(e,t){Yt(this._observable);const i=[];return wue(i,this,e,t),new Gm(i)}forEach(e,t){return Yt(this._observable),this._items.forEach(e,t)}getItemAt(e){return Yt(this._observable),this._items[e]}getNextIndex(e){Yt(this._observable);const t=this.length;return(e=e==null?t:e)<0?e=0:e>t&&(e=t),e}includes(e,t=0){return Yt(this._observable),this._items.includes(e,t)}indexOf(e,t=0){return Yt(this._observable),this._items.indexOf(e,t)}join(e=","){return Yt(this._observable),this._items.join(e)}lastIndexOf(e,t=this.length-1){return Yt(this._observable),this._items.lastIndexOf(e,t)}map(e,t){Yt(this._observable);const i=this._items.map(e,t);return new Gm({items:i})}reorder(e,t=this.length-1){Yt(this._observable);const i=this.indexOf(e);if(i!==-1){if(t<0?t=0:t>=this.length&&(t=this.length-1),i!==t){if(this._emitBeforeChanges(ji.MOVE))return e;this._splice(i,1),this._splice(t,0,[e]),this._emitAfterChanges(ji.MOVE)}return e}}pop(){if(Yt(this._observable),!this.length||this._emitBeforeChanges(ji.REMOVE))return;const e=tk(this._splice(this.length-1,1));return this._emitAfterChanges(ji.REMOVE),e}push(...e){return Yt(this._observable),this._emitBeforeChanges(ji.ADD)||(this._splice(this.length,0,e),this._emitAfterChanges(ji.ADD)),this.length}reduce(e,t){Yt(this._observable);const i=this._items;return arguments.length===2?i.reduce(e,t):i.reduce(e)}reduceRight(e,t){Yt(this._observable);const i=this._items;return arguments.length===2?i.reduceRight(e,t):i.reduceRight(e)}remove(e){return Yt(this._observable),this.removeAt(this.indexOf(e))}removeAt(e){if(Yt(this._observable),e<0||e>=this.length||this._emitBeforeChanges(ji.REMOVE))return;const t=tk(this._splice(e,1));return this._emitAfterChanges(ji.REMOVE),t}removeMany(e){if(Yt(this._observable),!e||!e.length||this._emitBeforeChanges(ji.REMOVE))return[];const t=e instanceof Gm?e.toArray():e,i=this._items,r=[],s=t.length;for(let n=0;n<s;n++){const o=t[n],a=i.indexOf(o);if(a>-1){const l=1+ZCe(t,i,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&r.push.apply(r,c),n+=l-1}}return this._emitAfterChanges(ji.REMOVE),r}reverse(){if(Yt(this._observable),this._emitBeforeChanges(ji.MOVE))return this;const e=this._splice(0,this.length);return e&&(e.reverse(),this._splice(0,0,e)),this._emitAfterChanges(ji.MOVE),this}shift(){if(Yt(this._observable),!this.length||this._emitBeforeChanges(ji.REMOVE))return;const e=tk(this._splice(0,1));return this._emitAfterChanges(ji.REMOVE),e}slice(e=0,t=this.length){return Yt(this._observable),this._createNewInstance({items:this._items.slice(e,t)})}some(e,t){return Yt(this._observable),this._items.some(e,t)}sort(e){if(Yt(this._observable),!this.length||this._emitBeforeChanges(ji.MOVE))return this;const t=this._splice(0,this.length);return arguments.length?t.sort(e):t.sort(),this._splice(0,0,t),this._emitAfterChanges(ji.MOVE),this}splice(e,t,...i){Yt(this._observable);const r=(t?ji.REMOVE:0)|(i.length?ji.ADD:0);if(this._emitBeforeChanges(r))return[];const s=this._splice(e,t,i)||[];return this._emitAfterChanges(r),s}toArray(){return Yt(this._observable),this._items.slice()}toJSON(){return Yt(this._observable),this.toArray()}toLocaleString(){return Yt(this._observable),this._items.toLocaleString()}toString(){return Yt(this._observable),this._items.toString()}unshift(...e){return Yt(this._observable),!e.length||this._emitBeforeChanges(ji.ADD)||(this._splice(0,0,e),this._emitAfterChanges(ji.ADD)),this.length}_createNewInstance(e){return new this.constructor(e)}_splice(e,t,i){const r=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=F2(()=>this._dispatchChange())),t){if(o=r.splice(e,t),this.hasEventListener("before-remove")){const a=Tu.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),r.splice(e,0,n),e+=1,l-=1,c-=1);Tu.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=Tu.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);Tu.release(a)}}if(i&&i.length){if(s){const h=[];for(const p of i){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}i=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=e===this.length;if(a||l){const h=Tu.acquire();h.target=this,h.cancellable=!0;const p=Tu.acquire();p.target=this,p.cancellable=!1;for(const f of i)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?r.push(f):r.splice(e++,0,f),this._set("length",r.length),p.reset(f),this.emit("after-add",p));Tu.release(p),Tu.release(h)}else{if(c)for(const h of i)r.push(h);else r.splice(e,0,...i);this._set("length",r.length)}}return(i&&i.length||o&&o.length)&&this._notifyChangeEvent(i,o),o}_emitBeforeChanges(e){let t=!1;if(this.hasEventListener("before-changes")){const i=Tu.acquire();i.target=this,i.cancellable=!0,i.type=e,this.emit("before-changes",i),t=i.defaultPrevented,Tu.release(i)}return t}_emitAfterChanges(e){if(this.hasEventListener("after-changes")){const t=Tu.acquire();t.target=this,t.cancellable=!1,t.type=e,this.emit("after-changes",t),Tu.release(t)}this._observable.notify()}_notifyChangeEvent(e,t){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:e,removed:t})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const e=this._notifications;this._notifications=null;for(const t of e){const i=t.changes;Wg.clear(),Xg.clear(),Yg.clear();for(const{added:l,removed:c}of i){if(l)if(Yg.size===0&&Xg.size===0)for(const h of l)Wg.add(h);else for(const h of l)Xg.has(h)?(Yg.add(h),Xg.delete(h)):Yg.has(h)||Wg.add(h);if(c)if(Yg.size===0&&Wg.size===0)for(const h of c)Xg.add(h);else for(const h of c)Wg.has(h)?Wg.delete(h):(Yg.delete(h),Xg.add(h))}const r=Vl.acquire();Wg.forEach(l=>{r.push(l)});const s=Vl.acquire();Xg.forEach(l=>{s.push(l)});const n=this._items,o=t.items,a=Vl.acquire();if(Yg.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),t.listeners&&(r.length||s.length||a.length)){const l={target:this,added:r,removed:s,moved:a},c=t.listeners.length;for(let h=0;h<c;h++){const p=t.listeners[h];p.removed||p.callback.call(this,l)}}Vl.release(r),Vl.release(s),Vl.release(a)}Wg.clear(),Xg.clear(),Yg.clear()}};R1.ofType=e=>{if(!e)return Gm;if(ik.has(e))return ik.get(e);let t=null;if(typeof e=="function")t=e.prototype.declaredClass;else if(e.base)t=e.base.prototype.declaredClass;else for(const r in e.typeMap){const s=e.typeMap[r].prototype.declaredClass;t?t+=` | ${s}`:t=s}let i=class extends Gm{};return u([YH({Type:e,ensureType:typeof e=="function"?Qr(e):qd(e)})],i.prototype,"itemType",void 0),i=u([P(`esri.core.Collection<${t}>`)],i),ik.set(e,i),i},u([d()],R1.prototype,"length",void 0),u([d()],R1.prototype,"items",null),R1=Gm=u([P("esri.core.Collection")],R1);const at=R1;var IS;function JCe(e,t){switch(e.type){case"range":{const i="range"in e?e.range[0]:e.minValue,r="range"in e?e.range[1]:e.maxValue;if(+t<i||+t>r)return IS.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(e.codedValues==null||e.codedValues.every(i=>i==null||i.code!==t))return IS.INVALID_CODED_VALUE}return null}(function(e){e.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",e.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(IS||(IS={}));let rk;function vf(){return rk||(rk=(async()=>{const e=await import("./arcadeUtils.ad069cdf.js").then(function(t){return t.t});return{arcade:e.arcade,arcadeUtils:e,Dictionary:e.Dictionary,Feature:e.arcadeFeature}})()),rk}const KCe=(e,t,i)=>_O.create(e,t,i,null,["$feature"]),eAe=(e,t,i)=>_O.create(e,t,i,null,["$feature","$view"]),tAe=(e,t,i,r)=>_O.create(e,t,i,r,["$feature","$view"]);class _O{constructor(t,i,r,s,n,o,a,l){this.script=t,this.evaluate=n;const c=Array.isArray(a)?a:a.fields;this.fields=c,this._syntaxTree=s,this._arcade=i,this._arcadeDictionary=r,this._arcadeFeature=o,this._spatialReference=l,this._referencesGeometry=i.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(t,i,r,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await vf(),h=Xe.fromJSON(i),p=a.parseScript(t,o),f=n.reduce((C,M)=>ve(F({},C),{[M]:null}),{});let m=null;_(s)&&(m=new c(s),m.immutable=!0,f.$config=null);const y=a.scriptUsesGeometryEngine(p)&&a.enableGeometrySupport(),v=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),w=a.scriptIsAsync(p)&&a.enableAsyncSupport(),b={vars:f,spatialReference:h,useAsync:!!w},S=new c;S.immutable=!1,S.setField("scale",0);const T=a.compileScript(p,b),E=C=>("$view"in C&&C.$view&&(S.setField("scale",C.$view.scale),C.$view=S),m&&(C.$config=m),T({vars:C,spatialReference:h}));return await Promise.all([y,v,w]),new _O(t,a,c,p,E,new l,r,h)}repurposeFeature(t){return t.geometry&&!t.geometry.spatialReference&&(t.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(t.geometry,t.attributes,{fields:this.fields}),this._arcadeFeature}createDictionary(){return new this._arcadeDictionary}referencesMember(t){return this._arcade.referencesMember(this._syntaxTree,t)}referencesFunction(t){return this._arcade.referencesFunction(this._syntaxTree,t)}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}extractFieldLiterals(){return this._arcade.extractExpectedFieldLiterals(this._syntaxTree)}}const iAe=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],rAe=["field","normalizationField"];function OQ(e,t){if(e!=null&&t!=null){for(const i of Array.isArray(e)?e:[e])if(PQ(iAe,i,t),"visualVariables"in i&&i.visualVariables)for(const r of i.visualVariables)PQ(rAe,r,t)}}function PQ(e,t,i){if(e)for(const r of e){const s=N2(r,t),n=s&&typeof s!="function"&&i.get(s);n&&tc(r,n.name,t)}}function xue(e,t){if(e!=null&&(t==null?void 0:t.fields.length))if("startField"in e){const i=t.get(e.startField),r=t.get(e.endField);e.startField=i&&i.name||null,e.endField=r&&r.name||null}else{const i=t.get(e.startTimeField),r=t.get(e.endTimeField);e.startTimeField=i&&i.name||null,e.endTimeField=r&&r.name||null}}const sk=new Set;function Tue(e,t){return e&&t?(sk.clear(),qR(sk,e,t),Array.from(sk).sort()):[]}function qR(e,t,i){var r;if(i)if((r=t==null?void 0:t.fields)==null?void 0:r.length)if(i.includes("*"))for(const{name:s}of t.fields)e.add(s);else for(const s of i)_h(e,t,s);else{if(i.includes("*"))return e.clear(),void e.add("*");for(const s of i)e.add(s)}}function _h(e,t,i){if(typeof i=="string")if(t){const r=t.get(i);r&&e.add(r.name)}else e.add(i)}function n0t(e,t){return R(t)||R(e)?[]:t.includes("*")?e.fields.map(i=>i.name):t}async function hl(e,t,i){var n;if(!i)return;const{arcadeUtils:r}=await vf(),s=r.extractFieldNames(i,(n=t==null?void 0:t.fields)==null?void 0:n.map(o=>o.name));for(const o of s)_h(e,t,o)}async function Sue(e,t,i){if(i&&i!=="1=1"){const r=(await import("./WhereClause.6eb5053b.js")).WhereClause.create(i,t);if(!r.isStandardized)throw new q("fieldUtils:collectFilterFields","Where clause is not standardized",{where:i});qR(e,t,r.fieldNames)}}function sAe({displayField:e,fields:t}){return e||(t&&t.length?nk(t,"name-or-title")||nk(t,"unique-identifier")||nk(t,"type-or-category")||nAe(t):null)}function nAe(e){for(const t of e){if(!t||!t.name)continue;const i=t.name.toLowerCase();if(i.includes("name")||i.includes("title"))return t.name}return null}function nk(e,t){for(const i of e)if(i&&i.valueType&&i.valueType===t)return i.name;return null}async function o0t(e,t){if(!t)return;const i=N2("elevationInfo.featureExpressionInfo",t);return i?i.collectRequiredFields(e,t.fieldsIndex):void 0}async function oAe(e,t,i){i.outStatistic.onStatisticValueExpression?hl(e,t,i.outStatistic.onStatisticValueExpression):e.add(i.outStatistic.onStatisticField)}async function a0t(e,t,i){var s,n;if(!t||!i||!("fields"in i))return;const r=[];if(((s=i.popupTemplate)==null?void 0:s.expressionInfos)&&r.push(...i.popupTemplate.expressionInfos.map(o=>hl(e,t.fieldsIndex,o.expression))),Array.isArray((n=i.popupTemplate)==null?void 0:n.content)){const o=i.popupTemplate.content;for(const a of o)a.type==="expression"&&a.expressionInfo&&r.push(hl(e,t.fieldsIndex,a.expressionInfo.expression))}i.fields&&r.push(...i.fields.map(o=>oAe(e,t.fieldsIndex,o))),await Promise.all(r)}async function l0t(e,t,i){t&&(t.timeInfo&&_(i)&&i.timeExtent&&qR(e,t.fieldsIndex,[t.timeInfo.startField,t.timeInfo.endField]),t.floorInfo&&qR(e,t.fieldsIndex,[t.floorInfo.floorField]),_(i)&&_(i.where)&&await Sue(e,t.fieldsIndex,i.where))}async function c0t(e,t,i){t&&i&&await Promise.all(i.map(r=>aAe(e,t,r)))}async function aAe(e,t,i){t&&i&&(i.valueExpression?await hl(e,t.fieldsIndex,i.valueExpression):i.field&&_h(e,t.fieldsIndex,i.field))}function u0t(e){if(!e)return[];const t="editFieldsInfo"in e&&e.editFieldsInfo;return t?Tue(e.fieldsIndex,[t&&t.creatorField,t&&t.creationDateField,t&&t.editorField,t&&t.editDateField]):[]}async function h0t(e,t){const{labelingInfo:i,fieldsIndex:r}=t;i&&i.length&&await Promise.all(i.map(s=>lAe(e,r,s)))}async function lAe(e,t,i){if(!i)return;const r=i.getLabelExpression(),s=i.where;if(r.type==="arcade")await hl(e,t,r.expression);else{const n=r.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{_h(e,t,o.slice(1,-1))})}await Sue(e,t,s)}function cAe(e){const t=e.defaultValue;return t!==void 0&&Aue(e,t)?t:e.nullable?null:void 0}function Eue(e){return typeof e=="number"&&!isNaN(e)&&isFinite(e)}function uAe(e){return e===null||Eue(e)}const ZH="isInteger"in Number?Number.isInteger:e=>typeof e=="number"&&isFinite(e)&&Math.floor(e)===e;function hAe(e){return e===null||ZH(e)}function Cue(e){return e!=null&&typeof e=="string"}function dAe(e){return e===null||Cue(e)}function pAe(){return!0}function Aue(e,t){let i;switch(e.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":i=e.nullable?hAe:ZH;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":i=e.nullable?uAe:Eue;break;case"string":case"esriFieldTypeString":i=e.nullable?dAe:Cue;break;default:i=pAe}return arguments.length===1?i:i(t)}const fAe=["integer","small-integer","single","double"],mAe=new Set([...fAe,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]);function o4(e){return e!=null&&mAe.has(e.type)}function d0t(e){return e!=null&&(e.type==="string"||e.type==="esriFieldTypeString")}var tN,iN;function p0t(e){return e==null||typeof e=="number"&&isNaN(e)?null:e}function f0t(e,t){return e.nullable&&t===null?null:o4(e)&&!gAe(e.type,Number(t))?tN.OUT_OF_RANGE:Aue(e,t)?e.domain?JCe(e.domain,t):null:iN.INVALID_TYPE}function gAe(e,t){const i=typeof e=="string"?Rue(e):e;return!!i&&(i.isInteger?ZH(t)&&t>=i.min&&t<=i.max:t>=i.min&&t<=i.max)}function Rue(e){switch(e){case"esriFieldTypeSmallInteger":case"small-integer":return yAe;case"esriFieldTypeInteger":case"integer":return vAe;case"esriFieldTypeSingle":case"single":return _Ae;case"esriFieldTypeDouble":case"double":return bAe}}(function(e){e.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(tN||(tN={})),function(e){e.INVALID_TYPE="type-validation-error::invalid-type"}(iN||(iN={}));const yAe={min:-32768,max:32767,isInteger:!0},vAe={min:-2147483648,max:2147483647,isInteger:!0},_Ae={min:-34e37,max:12e37,isInteger:!1},bAe={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function m0t(e,t,i){switch(e){case IS.INVALID_CODED_VALUE:return`Value ${i} is not in the coded domain - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case IS.VALUE_OUT_OF_RANGE:return`Value ${i} is out of the range of valid values - field: ${t.name}, domain: ${JSON.stringify(t.domain)}`;case iN.INVALID_TYPE:return`Value ${i} is not a valid value for the field type - field: ${t.name}, type: ${t.type}, nullable: ${t.nullable}`;case tN.OUT_OF_RANGE:{const{min:r,max:s}=Rue(t.type);return`Value ${i} is out of range for the number type - field: ${t.name}, type: ${t.type}, value range is ${r} to ${s}`}}}function wAe(e,t){return!xAe(e,t,null)}function xAe(e,t,i){if(!t||!t.attributes||!e){if(_(i))for(const n of e)i.add(n);return!0}const r=t.attributes;let s=!1;for(const n of e)if(!(n in r)){if(s=!0,!_(i))break;i.add(n)}return s}function Mue(e){return["raster.itempixelvalue","raster.servicepixelvalue"].some(t=>e.toLowerCase().startsWith(t))}let $$=class extends fe{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression"],readOnly:!0,json:{read:!1,write:!0}})],$$.prototype,"type",void 0),$$=u([P("esri.popup.content.Content")],$$);const uw=$$;var b8;let I_=b8=class extends uw{constructor(e){super(e),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new b8({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],I_.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],I_.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],I_.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],I_.prototype,"type",void 0),I_=b8=u([P("esri.popup.content.AttachmentsContent")],I_);const WR=I_;var w8;let $_=w8=class extends uw{constructor(e){super(e),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new w8({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?te(this.outFields):null})}};u([d()],$_.prototype,"creator",void 0),u([d()],$_.prototype,"destroyer",void 0),u([d()],$_.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],$_.prototype,"type",void 0),$_=w8=u([P("esri.popup.content.CustomContent")],$_);const TAe=$_;var x8;let Ax=x8=class extends fe{constructor(e){super(e),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new x8({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],Ax.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],Ax.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],Ax.prototype,"returnType",void 0),Ax=x8=u([P("esri.popup.ElementExpressionInfo")],Ax);const Oue=Ax;var T8;let PC=T8=class extends uw{constructor(e){super(e),this.expressionInfo=null,this.type="expression"}clone(){var e;return new T8({expressionInfo:(e=this.expressionInfo)==null?void 0:e.clone()})}};u([d({type:Oue,json:{write:!0}})],PC.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],PC.prototype,"type",void 0),PC=T8=u([P("esri.popup.content.ExpressionContent")],PC);const QH=PC;function ct(e,t={}){var s;const i=e instanceof _i?e:new _i(e,t),r={type:((s=t==null?void 0:t.ignoreUnknown)!=null?s:1)?i.apiValues:String,json:{type:i.jsonValues,read:!(t==null?void 0:t.readOnly)&&{reader:i.read},write:{writer:i.write}}};return(t==null?void 0:t.readOnly)!==void 0&&(r.readOnly=!!t.readOnly),(t==null?void 0:t.default)!==void 0&&(r.json.default=t.default),(t==null?void 0:t.name)!==void 0&&(r.json.name=t.name),d(r)}const XR=Zo()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});XR.toJSON.bind(XR);XR.fromJSON.bind(XR);let XA;var gle,yle,vle;const ok=(vle=(gle=globalThis.esriConfig)==null?void 0:gle.locale)!=null?vle:(yle=globalThis.dojoConfig)==null?void 0:yle.locale;function Pue(){var e,t;return(t=ok!=null?ok:(e=globalThis.navigator)==null?void 0:e.language)!=null?t:"en"}function tu(){return XA===void 0&&(XA=Pue()),XA}const YA=[];function SAe(e){return YA.push(e),{remove(){YA.splice(YA.indexOf(e),1)}}}const S8=[];function JH(e){return S8.push(e),{remove(){YA.splice(S8.indexOf(e),1)}}}function EAe(){const e=Pue();XA!==e&&(XA=e,[...S8].forEach(t=>{t.call(null,e)}),[...YA].forEach(t=>{t.call(null,e)}))}var _le;(_le=globalThis.addEventListener)==null||_le.call(globalThis,"languagechange",EAe);const tp={year:"numeric",month:"numeric",day:"numeric"},gE={year:"numeric",month:"long",day:"numeric"},yE={year:"numeric",month:"short",day:"numeric"},vE={year:"numeric",month:"long",weekday:"long",day:"numeric"},Fu={hour:"numeric",minute:"numeric"},kh=ve(F({},Fu),{second:"numeric"}),KH={"short-date":tp,"short-date-short-time":F(F({},tp),Fu),"short-date-short-time-24":ve(F(F({},tp),Fu),{hour12:!1}),"short-date-long-time":F(F({},tp),kh),"short-date-long-time-24":ve(F(F({},tp),kh),{hour12:!1}),"short-date-le":tp,"short-date-le-short-time":F(F({},tp),Fu),"short-date-le-short-time-24":ve(F(F({},tp),Fu),{hour12:!1}),"short-date-le-long-time":F(F({},tp),kh),"short-date-le-long-time-24":ve(F(F({},tp),kh),{hour12:!1}),"long-month-day-year":gE,"long-month-day-year-short-time":F(F({},gE),Fu),"long-month-day-year-short-time-24":ve(F(F({},gE),Fu),{hour12:!1}),"long-month-day-year-long-time":F(F({},gE),kh),"long-month-day-year-long-time-24":ve(F(F({},gE),kh),{hour12:!1}),"day-short-month-year":yE,"day-short-month-year-short-time":F(F({},yE),Fu),"day-short-month-year-short-time-24":ve(F(F({},yE),Fu),{hour12:!1}),"day-short-month-year-long-time":F(F({},yE),kh),"day-short-month-year-long-time-24":ve(F(F({},yE),kh),{hour12:!1}),"long-date":vE,"long-date-short-time":F(F({},vE),Fu),"long-date-short-time-24":ve(F(F({},vE),Fu),{hour12:!1}),"long-date-long-time":F(F({},vE),kh),"long-date-long-time-24":ve(F(F({},vE),kh),{hour12:!1}),"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":Fu,"long-time":kh},YR=Zo()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"});YR.apiValues;YR.toJSON.bind(YR);YR.fromJSON.bind(YR);const CAe={ar:"ar-u-nu-latn-ca-gregory"};let D$=new WeakMap,Iue=KH["short-date-short-time"];function AAe(e){const t=e||Iue;if(!D$.has(t)){const i=tu(),r=CAe[tu()]||i;D$.set(t,new Intl.DateTimeFormat(r,t))}return D$.get(t)}function a4(e){return KH[e]||null}function _f(e,t){return AAe(t).format(e)}JH(()=>{D$=new WeakMap,Iue=KH["short-date-short-time"]});const RAe={ar:"ar-u-nu-latn"};let L$=new WeakMap,$ue={};function MAe(e){const t=e||$ue;if(!L$.has(t)){const i=tu(),r=RAe[tu()]||i;L$.set(t,new Intl.NumberFormat(r,e))}return L$.get(t)}function Due(e={}){const t={};return e.digitSeparator!=null&&(t.useGrouping=e.digitSeparator),e.places!=null&&(t.minimumFractionDigits=t.maximumFractionDigits=e.places),t}function bf(e,t){return e===-0&&(e=0),MAe(t).format(e)}JH(()=>{L$=new WeakMap,$ue={}});var E8;let D_=E8=class extends fe{constructor(e){super(e),this.dateFormat=null,this.dateTimeFormatOptions=null,this.digitSeparator=!1,this.places=null}clone(){return new E8({dateFormat:this.dateFormat,digitSeparator:this.digitSeparator,places:this.places})}format(e){return this.dateFormat?_f(e,F(F({},a4(this.dateFormat)),this.dateTimeFormatOptions)):bf(e,Due(this))}formatRasterPixelValue(e){let t,i;return e.trim().includes(",")?(t=",",i=t+" ",this._formatDelimitedString(e,t,i,this)):e.trim().includes(";")?(t=";",i=t+" ",this._formatDelimitedString(e,t,i,this)):e.trim().includes(" ")?(t=i=" ",this._formatDelimitedString(e,t,i,this)):this.format(Number(e))}_formatDelimitedString(e,t,i,r){return e&&t&&i&&r?e.trim().split(t).map(s=>this.format(Number(s))).join(i):e}};u([ct(XR)],D_.prototype,"dateFormat",void 0),u([d({type:Object,json:{read:!1}})],D_.prototype,"dateTimeFormatOptions",void 0),u([d({type:Boolean,json:{write:!0}})],D_.prototype,"digitSeparator",void 0),u([d({type:yr,json:{write:!0}})],D_.prototype,"places",void 0),D_=E8=u([P("esri.popup.support.FieldInfoFormat")],D_);const ST=D_;var C8;let Xh=C8=class extends fe{constructor(e){super(e),this.fieldName=null,this.format=null,this.isEditable=!1,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new C8({fieldName:this.fieldName,format:this.format?te(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Xh.prototype,"fieldName",void 0),u([d({type:ST,json:{write:!0}})],Xh.prototype,"format",void 0),u([d({type:Boolean,json:{write:!0,default:!1}})],Xh.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],Xh.prototype,"label",void 0),u([ct(new _i({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],Xh.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],Xh.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Xh.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],Xh.prototype,"visible",void 0),Xh=C8=u([P("esri.popup.FieldInfo")],Xh);const bO=Xh;var A8;let um=A8=class extends uw{constructor(e){super(e),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(e,t){t.fieldInfos=e&&e.map(i=>i.toJSON())}clone(){return new A8(te({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],um.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],um.prototype,"description",void 0),u([d({type:[bO]})],um.prototype,"fieldInfos",void 0),u([Be("fieldInfos")],um.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],um.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],um.prototype,"type",void 0),um=A8=u([P("esri.popup.content.FieldsContent")],um);const $S=um;let L_=class extends fe{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],L_.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],L_.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],L_.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],L_.prototype,"type",void 0),L_=u([P("esri.popup.content.mixins.MediaInfo")],L_);const eq=L_;var R8;let Rx=R8=class extends Ee{constructor(e){super(e),this.fieldName=null,this.tooltip=null,this.value=null}clone(){return new R8({fieldName:this.fieldName,tooltip:this.tooltip,value:this.value})}};u([d()],Rx.prototype,"fieldName",void 0),u([d()],Rx.prototype,"tooltip",void 0),u([d()],Rx.prototype,"value",void 0),Rx=R8=u([P("esri.popup.content.support.ChartMediaInfoValueSeries")],Rx);const Lue=Rx;var M8;let N_=M8=class extends fe{constructor(e){super(e),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new M8({fields:te(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],N_.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],N_.prototype,"normalizeField",void 0),u([d({type:[Lue],json:{read:!1}})],N_.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],N_.prototype,"tooltipField",void 0),N_=M8=u([P("esri.popup.content.support.ChartMediaInfoValue")],N_);const OAe=N_;let IC=class extends eq{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],IC.prototype,"type",void 0),u([d({type:OAe,json:{write:!0}})],IC.prototype,"value",void 0),IC=u([P("esri.popup.content.mixins.ChartMediaInfo")],IC);const l4=IC,c4=Zo()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var O8;let N$=O8=class extends l4{constructor(e){super(e),this.type="bar-chart"}clone(){return new O8({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:c4.write}})],N$.prototype,"type",void 0),N$=O8=u([P("esri.popup.content.BarChartMediaInfo")],N$);const Nue=N$;var P8;let F$=P8=class extends l4{constructor(e){super(e),this.type="column-chart"}clone(){return new P8({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:c4.write}})],F$.prototype,"type",void 0),F$=P8=u([P("esri.popup.content.ColumnChartMediaInfo")],F$);const Fue=F$;var I8;let $C=I8=class extends fe{constructor(e){super(e),this.linkURL=null,this.sourceURL=null}clone(){return new I8({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],$C.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],$C.prototype,"sourceURL",void 0),$C=I8=u([P("esri.popup.content.support.ImageMediaInfoValue")],$C);const PAe=$C;var $8;let Mx=$8=class extends eq{constructor(e){super(e),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new $8({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],Mx.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],Mx.prototype,"type",void 0),u([d({type:PAe,json:{write:!0}})],Mx.prototype,"value",void 0),Mx=$8=u([P("esri.popup.content.ImageMediaInfo")],Mx);const Uue=Mx;var D8;let U$=D8=class extends l4{constructor(e){super(e),this.type="line-chart"}clone(){return new D8({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:c4.write}})],U$.prototype,"type",void 0),U$=D8=u([P("esri.popup.content.LineChartMediaInfo")],U$);const kue=U$;var L8;let k$=L8=class extends l4{constructor(e){super(e),this.type="pie-chart"}clone(){return new L8({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:c4.write}})],k$.prototype,"type",void 0),k$=L8=u([P("esri.popup.content.PieChartMediaInfo")],k$);const zue=k$,Vue={base:eq,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":Nue,"column-chart":Fue,"line-chart":kue,"pie-chart":zue,image:Uue}};var N8;let Yh=N8=class extends uw{constructor(e){super(e),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(e){return e&&e.map(t=>t.type==="image"?Uue.fromJSON(t):t.type==="barchart"?Nue.fromJSON(t):t.type==="columnchart"?Fue.fromJSON(t):t.type==="linechart"?kue.fromJSON(t):t.type==="piechart"?zue.fromJSON(t):void 0).filter(Boolean)}writeMediaInfos(e,t){t.mediaInfos=e&&e.map(i=>i.toJSON())}clone(){return new N8(te({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],Yh.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],Yh.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Yh.prototype,"description",void 0),u([d({types:[Vue]})],Yh.prototype,"mediaInfos",void 0),u([ke("mediaInfos")],Yh.prototype,"readMediaInfos",null),u([Be("mediaInfos")],Yh.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],Yh.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],Yh.prototype,"type",void 0),Yh=N8=u([P("esri.popup.content.MediaContent")],Yh);const ZR=Yh;var F8;let DC=F8=class extends uw{constructor(e){super(e),this.text=null,this.type="text"}clone(){return new F8({text:this.text})}};u([d({type:String,json:{write:!0}})],DC.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],DC.prototype,"type",void 0),DC=F8=u([P("esri.popup.content.TextContent")],DC);const DS=DC,IAe={base:null,key:"type",typeMap:{attachment:WR,media:ZR,text:DS,expression:QH,field:$S}};var U8;let F_=U8=class extends fe{constructor(e){super(e),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new U8({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],F_.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],F_.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],F_.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],F_.prototype,"returnType",void 0),F_=U8=u([P("esri.popup.ExpressionInfo")],F_);const Bue=F_;var k8;let LC=k8=class extends fe{constructor(e){super(e),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new k8({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],LC.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],LC.prototype,"showNoDataRecords",void 0),LC=k8=u([P("esri.popup.LayerOptions")],LC);const $Ae=LC;var z8;let NC=z8=class extends fe{constructor(e){super(e),this.field=null,this.order=null}clone(){return new z8({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],NC.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],NC.prototype,"order",void 0),NC=z8=u([P("esri.popup.support.RelatedRecordsInfoFieldOrder")],NC);const Gue=NC;var V8;let FC=V8=class extends fe{constructor(e){super(e),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new V8({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?te(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],FC.prototype,"showRelatedRecords",void 0),u([d({type:[Gue],json:{write:!0}})],FC.prototype,"orderByFields",void 0),FC=V8=u([P("esri.popup.RelatedRecordsInfo")],FC);const DAe=FC;let LAe=0;const tq=e=>{let t=class extends e{constructor(...i){super(...i),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+LAe++})}};return t=u([P("esri.core.Identifiable")],t),t};let IQ=class extends tq(class{}){};IQ=u([P("esri.core.Identifiable")],IQ);var B8;let Zh=B8=class extends tq(Ee){constructor(e){super(e),this.active=!1,this.className=null,this.disabled=!1,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new B8({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],Zh.prototype,"active",void 0),u([d()],Zh.prototype,"className",void 0),u([d()],Zh.prototype,"disabled",void 0),u([d()],Zh.prototype,"id",void 0),u([d()],Zh.prototype,"indicator",void 0),u([d()],Zh.prototype,"title",void 0),u([d()],Zh.prototype,"type",void 0),u([d()],Zh.prototype,"visible",void 0),Zh=B8=u([P("esri.support.actions.ActionBase")],Zh);const u4=Zh;var G8;let z$=G8=class extends u4{constructor(e){super(e),this.image=null,this.type="button"}clone(){return new G8({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],z$.prototype,"image",void 0),z$=G8=u([P("esri.support.Action.ActionButton")],z$);const z2=z$;var j8;let UC=j8=class extends u4{constructor(e){super(e),this.image=null,this.type="toggle",this.value=!1}clone(){return new j8({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],UC.prototype,"image",void 0),u([d()],UC.prototype,"value",void 0),UC=j8=u([P("esri.support.Action.ActionToggle")],UC);const jue=UC;var H8;const NAe=at.ofType({key:"type",defaultKeyValue:"button",base:u4,typeMap:{button:z2,toggle:jue}}),FAe={base:uw,key:"type",typeMap:{media:ZR,custom:TAe,text:DS,attachments:WR,fields:$S,expression:QH}},Hue="esri.PopupTemplate",UAe=me.getLogger(Hue),kAe=["attachments","fields","media","text","expression"];let gn=H8=class extends fe{constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title="",this.relatedRecordsInfo=null}castContent(e){return Array.isArray(e)?e.map(t=>qd(FAe,t)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||vu(e)?e:(UAe.error("content error","unsupported content value",{value:e}),null)}readContent(e,t){const{popupElements:i}=t;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(t):this._readPopupInfo(t)}writeContent(e,t,i,r){typeof e!="string"?Array.isArray(e)&&(t.popupElements=e.filter(s=>kAe.includes(s.type)).map(s=>s&&s.toJSON(r)),t.popupElements.forEach(s=>{s.type==="attachments"?this._writeAttachmentContent(t):s.type==="media"?this._writeMediaContent(s,t):s.type==="text"&&this._writeTextContent(s,t)})):t.description=e}writeFieldInfos(e,t,i,r){const{content:s}=this,n=Array.isArray(s)?s:null;if(e){const o=n?n.filter(l=>l.type==="fields"):[],a=o.length&&o.every(l=>{var c;return(c=l.fieldInfos)==null?void 0:c.length});t.fieldInfos=e.filter(Boolean).map(l=>{const c=l.toJSON(r);return a&&(c.visible=!1),c})}if(n)for(const o of n)o.type==="fields"&&this._writeFieldsContent(o,t)}writeLayerOptions(e,t,i,r){t[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(r)}writeTitle(e,t){t.title=e||""}clone(){const{actions:e}=this,t=e?te(e.toArray()):[];return new H8({actions:t,content:Array.isArray(this.content)?te(this.content):this.content,expressionInfos:Array.isArray(this.expressionInfos)?te(this.expressionInfos):null,fieldInfos:Array.isArray(this.fieldInfos)?te(this.fieldInfos):null,layerOptions:this.layerOptions?te(this.layerOptions):null,lastEditInfoEnabled:this.lastEditInfoEnabled,outFields:Array.isArray(this.outFields)?te(this.outFields):null,overwriteActions:this.overwriteActions,returnGeometry:this.returnGeometry,title:this.title,relatedRecordsInfo:this.relatedRecordsInfo?te(this.relatedRecordsInfo):null})}async collectRequiredFields(e,t){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,t,[...i,...this._getContentExpressionInfos(this.content,i)]),qR(e,t,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const t=new Set;return await this.collectRequiredFields(t,e),[...t].sort()}_writeFieldsContent(e,t){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=te(e.fieldInfos);Array.isArray(t.fieldInfos)?i.forEach(r=>{const s=t.fieldInfos.find(n=>n.fieldName.toLowerCase()===r.fieldName.toLowerCase());s?s.visible=!0:t.fieldInfos.push(r)}):t.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeTextContent(e,t){!t.description&&e.text&&(t.description=e.text)}_writeMediaContent(e,t){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=te(e.mediaInfos);Array.isArray(t.mediaInfos)?t.mediaInfos=[...t.mediaInfos,...i]:t.mediaInfos=i}_readPopupInfoElements({description:e,mediaInfos:t,popupElements:i}){const r={description:!1,mediaInfos:!1};return i.map(s=>s.type==="media"?(s.mediaInfos||!t||r.mediaInfos||(s.mediaInfos=t,r.mediaInfos=!0),ZR.fromJSON(s)):s.type==="text"?(s.text||!e||r.description||(s.text=e,r.description=!0),DS.fromJSON(s)):s.type==="attachments"?WR.fromJSON(s):s.type==="fields"?$S.fromJSON(s):s.type==="expression"?QH.fromJSON(s):void 0).filter(Boolean)}_readPopupInfo({description:e,mediaInfos:t,showAttachments:i}){const r=[];return e?r.push(new DS({text:e})):r.push(new $S),Array.isArray(t)&&t.length&&r.push(ZR.fromJSON({mediaInfos:t})),i&&r.push(WR.fromJSON({displayType:"auto"})),r.length?r:e}_getContentElementFields(e){const t=e==null?void 0:e.type;if(t==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(t==="custom")return e.outFields||[];if(t==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos||this.fieldInfos)];if(t==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((r,s)=>[...r,...this._getMediaInfoFields(s)],[])]}return t==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:t,title:i,value:r}=e,s=r||{},{fields:n=[],normalizeField:o,tooltipField:a,sourceURL:l,linkURL:c}=s,h=[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(l),...this._extractFieldNames(c),...n];return o&&h.push(o),a&&h.push(a),h}_getContentExpressionInfos(e,t){return Array.isArray(e)?e.reduce((i,r)=>[...i,...r.type==="expression"&&r.expressionInfo?[r.expressionInfo]:[]],t):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((t,i)=>[...t,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,t,i){i&&await Promise.all(i.map(r=>hl(e,t,r.expression)))}_getFieldInfoFields(e){return e?e.filter(t=>t.visible===void 0||!!t.visible).map(t=>t.fieldName).filter(t=>!t.includes("relationships/")&&!t.includes("expression/")):[]}_getActionsFields(e){return e?e.toArray().reduce((t,i)=>[...t,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:t,title:i,type:r}=e,s=r==="button"||r==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(t),...this._extractFieldNames(s)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const t=/{[^}]*}/g,i=e.match(t);if(!i)return[];const r=/\{(\w+):.+\}/,s=i.filter(n=>!(n.indexOf("{relationships/")===0||n.indexOf("{expression/")===0)).map(n=>n.replace(r,"{$1}"));return s?s.map(n=>n.slice(1,-1)):[]}};u([d({type:NAe})],gn.prototype,"actions",void 0),u([d()],gn.prototype,"content",void 0),u([Ot("content")],gn.prototype,"castContent",null),u([ke("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments"])],gn.prototype,"readContent",null),u([Be("content",{popupElements:{type:at.ofType(IAe)},showAttachments:{type:Boolean},mediaInfos:{type:at.ofType(Vue)},description:{type:String}})],gn.prototype,"writeContent",null),u([d({type:[Bue],json:{write:!0}})],gn.prototype,"expressionInfos",void 0),u([d({type:[bO]})],gn.prototype,"fieldInfos",void 0),u([Be("fieldInfos")],gn.prototype,"writeFieldInfos",null),u([d({type:$Ae})],gn.prototype,"layerOptions",void 0),u([Be("layerOptions")],gn.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],gn.prototype,"lastEditInfoEnabled",void 0),u([d()],gn.prototype,"outFields",void 0),u([d()],gn.prototype,"overwriteActions",void 0),u([d()],gn.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],gn.prototype,"title",void 0),u([Be("title")],gn.prototype,"writeTitle",null),u([d({type:DAe,json:{write:!0}})],gn.prototype,"relatedRecordsInfo",void 0),gn=H8=u([P(Hue)],gn);const wO=gn,$Q=new _i({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let zAe=0,Ox=class extends fe{constructor(e){super(e),this.id="sym"+zAe++,this.type=null,this.color=new qe([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,t){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:$Q.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:$Q.write}}})],Ox.prototype,"type",void 0),u([d({type:qe,json:{write:{allowNull:!0}}})],Ox.prototype,"color",void 0),u([ke("color")],Ox.prototype,"readColor",null),Ox=u([P("esri.symbols.Symbol")],Ox);const lc=Ox;var q8;let $y=q8=class extends lc{constructor(e){super(e),this.data=null,this.type="cim"}readData(e,t){return t}writeData(e,t){if(e)for(const i in e)t[i]=e[i]}async collectRequiredFields(e,t){if(this.data.type==="CIMSymbolReference"){const i=this.data.primitiveOverrides;if(i){const r=i.map(s=>{const n=s.valueExpressionInfo;return hl(e,t,n.expression)});await Promise.all(r)}}}clone(){return new q8({data:te(this.data)})}hash(){return xH(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],$y.prototype,"color",void 0),u([d({json:{write:!0}})],$y.prototype,"data",void 0),u([ke("data",["symbol"])],$y.prototype,"readData",null),u([Be("data",{})],$y.prototype,"writeData",null),u([ct({CIMSymbolReference:"cim"},{readOnly:!0})],$y.prototype,"type",void 0),$y=q8=u([P("esri.symbols.CIMSymbol")],$y);const V2=$y;let Px=class extends fe{constructor(e){super(e),this.enabled=!0,this.type=null}writeEnabled(e,t,i){e||(t[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],Px.prototype,"enabled",void 0),u([Be("enabled")],Px.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],Px.prototype,"type",void 0),Px=u([P("esri.symbols.Symbol3DLayer")],Px);const Df=Px,VAe=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,BAe="screenUtils.toPt: input not recognized!",que=96;function Jn(e){return e?e/72*que:0}function uu(e){return e?72*e/que:0}function Zi(e){if(typeof e=="string"){const t=e.match(VAe);if(t){const i=Number(t[1]),r=t[3]&&t[3].toLowerCase(),s=e.charAt(0)==="-",n=r==="px"?uu(i):i;return s?-n:n}return console.warn(BAe),null}return e}function Xd(e=0,t=0){return{x:e,y:t}}function Vr(e=0,t=0){return[e,t]}function GAe(e=0,t=0){return[e,t]}function wo(e=0,t=0,i=0){return[e,t,i]}function g0t(e){return e}function y0t(e){return e}function v0t(e){return e}function qm(e,t){return t?(t[0]=e.x,t[1]=e.y,t.length>2&&(t[2]=0),t):[e.x,e.y]}function xO(e){const t=SH(100*(1-e));return Math.max(0,Math.min(t,100))}function LS(e){const t=1-e/100;return Math.max(0,Math.min(t,1))}function jAe(e,t){const i=t.transparency!=null?LS(t.transparency):1,r=t.color;return r&&Array.isArray(r)?new qe([r[0]||0,r[1]||0,r[2]||0,i]):null}function HAe(e,t){t.color=e.toJSON().slice(0,3);const i=xO(e.a);i!==0&&(t.transparency=i)}const Ig={type:qe,json:{type:[yr],default:null,read:{source:["color","transparency"],reader:jAe},write:{target:{color:{type:[yr]},transparency:{type:yr}},writer:HAe}}},wf={type:Number,cast:Zi,json:{write:!0}};let U_=class extends fe{constructor(e){super(e),this.color=new qe([0,0,0,1]),this.extensionLength=0,this.size=uu(1)}clone(){}cloneProperties(){return{color:te(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],U_.prototype,"type",void 0),u([d(Ig)],U_.prototype,"color",void 0),u([d(ve(F({},wf),{json:{write:{overridePolicy:e=>({enabled:!!e})}}}))],U_.prototype,"extensionLength",void 0),u([d(wf)],U_.prototype,"size",void 0),U_=u([P("esri.symbols.edges.Edges3D")],U_);const iq=U_;var W8;let V$=W8=class extends iq{constructor(e){super(e),this.type="sketch"}clone(){return new W8(this.cloneProperties())}};u([ct({sketch:"sketch"},{readOnly:!0})],V$.prototype,"type",void 0),V$=W8=u([P("esri.symbols.edges.SketchEdges3D")],V$);const qAe=V$;var X8;let B$=X8=class extends iq{constructor(e){super(e),this.type="solid"}clone(){return new X8(this.cloneProperties())}};u([ct({solid:"solid"},{readOnly:!0})],B$.prototype,"type",void 0),B$=X8=u([P("esri.symbols.support.SolidEdges3D")],B$);const WAe=B$,Wue={types:{key:"type",base:iq,typeMap:{solid:WAe,sketch:qAe}},json:{write:!0}};var Y8;let iu=Y8=class extends fe{constructor(e){super(e),this.color=null}clone(){const e={color:_(this.color)?this.color.clone():null};return new Y8(e)}};u([d(Ig)],iu.prototype,"color",void 0),iu=Y8=u([P("esri.symbols.support.Symbol3DMaterial")],iu);var Z8;let Dy=Z8=class extends Df{constructor(e){super(e),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new Z8({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([ct({Extrude:"extrude"},{readOnly:!0})],Dy.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],Dy.prototype,"size",void 0),u([d({type:iu,json:{write:!0}})],Dy.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],Dy.prototype,"castShadows",void 0),u([d(Wue)],Dy.prototype,"edges",void 0),Dy=Z8=u([P("esri.symbols.ExtrudeSymbol3DLayer")],Dy);const Xue=Dy;let kC=class extends lc{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([ct({esriSLS:"simple-line"},{readOnly:!0})],kC.prototype,"type",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],kC.prototype,"width",void 0),kC=u([P("esri.symbols.LineSymbol")],kC);const XAe=kC,YAe=["begin","end","begin-end"],Yue=["arrow","circle","square","diamond","cross","x"];var Q8;let Sp=Q8=class extends fe{constructor(e){super(e),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(e,t,i,r){t[i]=(r==null?void 0:r.origin)==="web-map"?"arrow":e}set color(e){this._set("color",e)}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}writeColor(e,t,i,r){(r==null?void 0:r.origin)==="web-map"||(t[i]=e)}clone(){return new Q8({color:te(this.color),placement:this.placement,style:this.style})}hash(){var e;return`${this.placement}.${(e=this.color)==null?void 0:e.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],Sp.prototype,"placement",void 0),u([ct({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],Sp.prototype,"type",void 0),u([d({type:Yue})],Sp.prototype,"style",void 0),u([Be("style")],Sp.prototype,"writeStyle",null),u([d({type:qe,value:null,json:{write:{allowNull:!0}}})],Sp.prototype,"color",null),u([ke("color")],Sp.prototype,"readColor",null),u([Be("color")],Sp.prototype,"writeColor",null),Sp=Q8=u([P("esri.symbols.LineSymbolMarker")],Sp);const ZAe=Sp;var J8;const ak=new _i({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let hm=J8=class extends XAe{constructor(...e){super(...e),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(e,t,i,r,s,n){if(e&&typeof e!="string")return e;const o={};return e!=null&&(o.style=e),t!=null&&(o.color=t),i!=null&&(o.width=Zi(i)),r!=null&&(o.cap=r),s!=null&&(o.join=s),n!=null&&(o.miterLimit=Zi(n)),o}clone(){var e;return new J8({color:te(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:(e=this.marker)==null?void 0:e.clone()})}hash(){var e,t;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${(t=this.marker)==null?void 0:t.hash()}`}};u([ct({esriSLS:"simple-line"},{readOnly:!0})],hm.prototype,"type",void 0),u([d({type:ak.apiValues,json:{read:ak.read,write:ak.write}})],hm.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],hm.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(e,t,i)=>({enabled:e!=="round"&&(i==null||i.origin==null)})}}})],hm.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":ZAe}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],hm.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],hm.prototype,"miterLimit",void 0),hm=J8=u([P("esri.symbols.SimpleLineSymbol")],hm);const Ih=hm;let zC=class extends lc{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Ih}},json:{default:null,write:!0}})],zC.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],zC.prototype,"type",void 0),zC=u([P("esri.symbols.FillSymbol")],zC);const Zue=zC;let G$=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],G$.prototype,"type",void 0),G$=u([P("esri.symbols.patterns.LinePattern3D")],G$);const Que=G$,QAe=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var K8;const JAe=Zo()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let VC=K8=class extends Que{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new K8(e)}};u([d({type:["style"]})],VC.prototype,"type",void 0),u([ct(JAe),d({type:QAe})],VC.prototype,"style",void 0),VC=K8=u([P("esri.symbols.patterns.LineStylePattern3D")],VC);const rq=VC;let j$=class extends fe{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],j$.prototype,"type",void 0),j$=u([P("esri.symbols.patterns.Pattern3D")],j$);const Jue=j$,KAe=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var eB;let BC=eB=class extends Jue{constructor(e){super(e),this.type="style",this.style="solid"}clone(){const e={style:this.style};return new eB(e)}};u([d({type:["style"]})],BC.prototype,"type",void 0),u([d({type:KAe,json:{read:!0,write:!0}})],BC.prototype,"style",void 0),BC=eB=u([P("esri.symbols.patterns.StylePattern3D")],BC);const Kue=BC,eRe={types:{key:"type",base:Jue,typeMap:{style:Kue}},json:{write:!0}},ehe={types:{key:"type",base:Que,typeMap:{style:rq}},json:{write:!0}},ZA=new qe("white");new qe("black");const tRe=new qe([255,255,255,0]);function iRe(e){return e.r===0&&e.g===0&&e.b===0}var tB;let QA=tB=class extends iu{constructor(e){super(e),this.colorMixMode=null}clone(){const e={color:_(this.color)?this.color.clone():null,colorMixMode:this.colorMixMode};return new tB(e)}};u([ct({multiply:"multiply",replace:"replace",tint:"tint"})],QA.prototype,"colorMixMode",void 0),QA=tB=u([P("esri.symbols.support.Symbol3DFillMaterial")],QA);function Dt(e=oRe){return[e[0],e[1],e[2],e[3]]}function _0t(e){return[e[0],e[1],e[2],e[3]]}function vg(e,t){return e!==t&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3]),e}function sq(e,t,i,r,s=Dt()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function the(e,t=Dt()){return t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax,t}function h4(e,t){return new ci({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:t})}function JT(e,t){t[0]<e[0]&&(e[0]=t[0]),t[0]>e[2]&&(e[2]=t[0]),t[1]<e[1]&&(e[1]=t[1]),t[1]>e[3]&&(e[3]=t[1])}function cb(e,t,i){if(R(t))vg(i,e);else if("length"in t)rB(t)?(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[2]),i[3]=Math.max(e[3],t[3])):t.length!==2&&t.length!==3||(i[0]=Math.min(e[0],t[0]),i[1]=Math.min(e[1],t[1]),i[2]=Math.max(e[2],t[0]),i[3]=Math.max(e[3],t[1]));else switch(t.type){case"extent":i[0]=Math.min(e[0],t.xmin),i[1]=Math.min(e[1],t.ymin),i[2]=Math.max(e[2],t.xmax),i[3]=Math.max(e[3],t.ymax);break;case"point":i[0]=Math.min(e[0],t.x),i[1]=Math.min(e[1],t.y),i[2]=Math.max(e[2],t.x),i[3]=Math.max(e[3],t.y)}}function lk(e,t,i=e){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3];for(let l=0;l<r;l++){const c=t[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return i[0]=s,i[1]=n,i[2]=o,i[3]=a,i}function iB(e){for(let t=0;t<4;t++)if(!isFinite(e[t]))return!1;return!0}function Wc(e){return R(e)||e[0]>=e[2]?0:e[2]-e[0]}function Yd(e){return e[1]>=e[3]?0:e[3]-e[1]}function ihe(e){return Wc(e)*Yd(e)}function nq(e,t=[0,0]){return t[0]=(e[0]+e[2])/2,t[1]=(e[1]+e[3])/2,t}function rhe(e,t){return oq(e,t[0],t[1])}function DQ(e,t){const i=t[3],r=.5*(e[0]+e[2]),s=Math.abs(t[0]-r),n=.5*(e[2]-e[0]);if(s>i+n)return!1;const o=.5*(e[1]+e[3]),a=.5*(e[3]-e[1]),l=Math.abs(t[1]-o);if(l>i+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=i*i}function b0t(e,t,i){const r=e[0],s=e[1],n=e[2],o=e[3],{x:a,y:l}=t,{x:c,y:h}=i,p=(w,b)=>(h-l)*w+(a-c)*b+(c*l-a*h)<0,f=p(r,o),m=p(n,o),y=p(n,s),v=p(r,s);return!(f===m&&m===y&&y===v&&v===f||a<r&&c<r||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function w0t(e,t){return oq(e,t.x,t.y)}function oq(e,t,i){return t>=e[0]&&i>=e[1]&&t<=e[2]&&i<=e[3]}function GC(e,t,i,r){return t>=e[0]-r&&i>=e[1]-r&&t<=e[2]+r&&i<=e[3]+r}function rRe(e,t,i){return t[0]>=e[0]-i&&t[1]>=e[1]-i&&t[0]<=e[2]+i&&t[1]<=e[3]+i}function TO(e,t){return Math.max(t[0],e[0])<=Math.min(t[2],e[2])&&Math.max(t[1],e[1])<=Math.min(t[3],e[3])}function LQ(e,t){return t[0]>=e[0]&&t[2]<=e[2]&&t[1]>=e[1]&&t[3]<=e[3]}function H$(e,t,i){if(R(t))return vg(i,e);const r=t[0],s=t[1],n=t[2],o=t[3];return i[0]=$e(e[0],r,n),i[1]=$e(e[1],s,o),i[2]=$e(e[2],r,n),i[3]=$e(e[3],s,o),i}function sRe(e,t){const i=(e[0]+e[2])/2,r=(e[1]+e[3])/2,s=Math.max(Math.abs(t[0]-i)-Wc(e)/2,0),n=Math.max(Math.abs(t[1]-r)-Yd(e)/2,0);return Math.sqrt(s*s+n*n)}function rN(e,t,i,r=e){return r[0]=e[0]+t,r[1]=e[1]+i,r[2]=e[2]+t,r[3]=e[3]+i,r}function hu(e){return e?vg(e,sB):Dt(sB)}function rB(e){return e!=null&&e.length===4}function nRe(e){return!(Wc(e)!==0&&isFinite(e[0])||Yd(e)!==0&&isFinite(e[1]))}function ub(e,t){return rB(e)&&rB(t)?e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]:e===t}const x0t=[-1/0,-1/0,1/0,1/0],sB=[1/0,1/0,-1/0,-1/0],oRe=[0,0,0,0];function Ls(e=lhe){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function Pb(e,t,i,r,s,n,o=Ls()){return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function T0t(e,t){const i=isFinite(e[2])||isFinite(e[5]);return new ci(i?{xmin:e[0],xmax:e[3],ymin:e[1],ymax:e[4],zmin:e[2],zmax:e[5],spatialReference:t}:{xmin:e[0],xmax:e[3],ymin:e[1],ymax:e[4],spatialReference:t})}function NS(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[3]),e[4]=Math.max(e[4],t[4]),e[5]=Math.max(e[5],t[5])}function aRe(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[3]=Math.max(e[3],t[2]),e[4]=Math.max(e[4],t[3])}function xf(e,t){e[0]=Math.min(e[0],t[0]),e[1]=Math.min(e[1],t[1]),e[2]=Math.min(e[2],t[2]),e[3]=Math.max(e[3],t[0]),e[4]=Math.max(e[4],t[1]),e[5]=Math.max(e[5],t[2])}function Kc(e,t,i=0,r=t.length/3){let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];for(let h=0;h<r;h++)s=Math.min(s,t[i+3*h]),n=Math.min(n,t[i+3*h+1]),o=Math.min(o,t[i+3*h+2]),a=Math.max(a,t[i+3*h]),l=Math.max(l,t[i+3*h+1]),c=Math.max(c,t[i+3*h+2]);e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function ck(e,t,i){const r=t.length;let s=e[0],n=e[1],o=e[2],a=e[3],l=e[4],c=e[5];if(i)for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<r;h++){const p=t[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}e[0]=s,e[1]=n,e[2]=o,e[3]=a,e[4]=l,e[5]=c}function lRe(e){for(let t=0;t<6;t++)if(!isFinite(e[t]))return!1;return!0}function hw(e){return e[0]>=e[3]?0:e[3]-e[0]}function dw(e){return e[1]>=e[4]?0:e[4]-e[1]}function $v(e){return e[2]>=e[5]?0:e[5]-e[2]}function she(e){const t=hw(e),i=$v(e),r=dw(e);return Math.sqrt(t*t+i*i+r*r)}function Id(e,t=[0,0,0]){return t[0]=e[0]+hw(e)/2,t[1]=e[1]+dw(e)/2,t[2]=e[2]+$v(e)/2,t}function U3(e,t=[0,0,0]){return t[0]=hw(e),t[1]=dw(e),t[2]=$v(e),t}function cRe(e){return Math.max(hw(e),$v(e),dw(e))}function aq(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[0]<=e[3]&&t[1]<=e[4]&&t[2]<=e[5]}function S0t(e,t){return t[0]>=e[0]&&t[1]>=e[1]&&t[2]>=e[2]&&t[3]<=e[3]&&t[4]<=e[4]&&t[5]<=e[5]}function uRe(e,t){return Math.max(t[0],e[0])<=Math.min(t[3],e[3])&&Math.max(t[1],e[1])<=Math.min(t[4],e[4])&&Math.max(t[2],e[2])<=Math.min(t[5],e[5])}function $d(e,t){return!!R(t)||uRe(e,t)}function nhe(e,t,i,r,s=e){return s[0]=e[0]+t,s[1]=e[1]+i,s[2]=e[2]+r,s[3]=e[3]+t,s[4]=e[4]+i,s[5]=e[5]+r,s}function E0t(e,t,i=e){const r=e[0]+hw(e)/2,s=e[1]+dw(e)/2,n=e[2]+$v(e)/2;return i[0]=r+(e[0]-r)*t,i[1]=s+(e[1]-s)*t,i[2]=n+(e[2]-n)*t,i[3]=r+(e[3]-r)*t,i[4]=s+(e[4]-s)*t,i[5]=n+(e[5]-n)*t,i}function ohe(e,t,i=e){return i[0]=t[0],i[1]=t[1],i[2]=t[2],i!==e&&(i[3]=e[3],i[4]=e[4],i[5]=e[5]),i}function ahe(e,t,i=e){return i[3]=t[0],i[4]=t[1],i[5]=t[2],i!==e&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),e}function d4(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function cr(e){return e?d4(e,FQ):Ls(FQ)}function lq(e,t){return t||(t=Dt()),t[0]=e[0],t[1]=e[1],t[2]=e[3],t[3]=e[4],t}function C0t(e,t){return e[0]=t[0],e[1]=t[1],e[2]=Number.NEGATIVE_INFINITY,e[3]=t[2],e[4]=t[3],e[5]=Number.POSITIVE_INFINITY,e}function NQ(e){return e.length===6}function p4(e){return hw(e)===0&&dw(e)===0&&$v(e)===0}function A0t(e,t,i){if(R(e)||R(t))return e===t;if(!NQ(e)||!NQ(t))return!1;if(i){for(let r=0;r<e.length;r++)if(!i(e[r],t[r]))return!1}else for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0}function hRe(e,t,i,r,s,n){return Pb(e,t,i,r,s,n,dRe)}const R0t=[-1/0,-1/0,-1/0,1/0,1/0,1/0],FQ=[1/0,1/0,1/0,-1/0,-1/0,-1/0],lhe=[0,0,0,0,0,0],dRe=Ls();function uk(e,{isPrimitive:t,width:i,depth:r,height:s}){const n=t?10:1;if(i==null&&s==null&&r==null)return[n*e[0],n*e[1],n*e[2]];const o=Fe(i,r,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/e[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=e[l]*a);return o}const pRe=Pb(-.5,-.5,-.5,.5,.5,.5),fRe=Pb(-.5,-.5,0,.5,.5,1),mRe=Pb(-.5,-.5,0,.5,.5,.5);function gRe(e){switch(e){case"sphere":case"cube":case"diamond":return pRe;case"cylinder":case"cone":case"inverted-cone":return fRe;case"tetrahedron":return mRe;default:return}}const cq=["butt","square","round"],yRe=[...cq,"none"],che=["miter","bevel","round"];var nB;let k_=nB=class extends fe{constructor(e){super(e),this.color=new qe([0,0,0,1]),this.size=uu(1),this.pattern=null,this.patternCap="butt"}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size,pattern:_(this.pattern)?this.pattern.clone():null,patternCap:this.patternCap};return new nB(e)}};u([d(Ig)],k_.prototype,"color",void 0),u([d(wf)],k_.prototype,"size",void 0),u([d(ehe)],k_.prototype,"pattern",void 0),u([d({type:cq,json:{default:"butt",write:{overridePolicy(){return{enabled:_(this.pattern)}}}}})],k_.prototype,"patternCap",void 0),k_=nB=u([P("esri.symbols.support.Symbol3DOutline")],k_);var q$;let dm=q$=class extends Df{constructor(e){super(e),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const e={edges:_(this.edges)?this.edges.clone():null,enabled:this.enabled,material:_(this.material)?this.material.clone():null,pattern:_(this.pattern)?this.pattern.clone():null,castShadows:this.castShadows,outline:_(this.outline)?this.outline.clone():null};return new q$(e)}static fromSimpleFillSymbol(e){var r,s,n,o,a,l;const t=e.outline&&e.outline.style&&e.outline.style!=="inside-frame"&&e.outline.style!=="solid"?new rq({style:e.outline.style}):null,i={size:(s=(r=e.outline)==null?void 0:r.width)!=null?s:0,color:((o=(n=e.outline)==null?void 0:n.color)!=null?o:ZA).clone(),pattern:t};return t&&((a=e.outline)==null?void 0:a.cap)&&(i.patternCap=e.outline.cap),new q$({material:new QA({color:((l=e.color)!=null?l:tRe).clone()}),pattern:e.style&&e.style!=="solid"?new Kue({style:e.style}):null,outline:i})}};u([ct({Fill:"fill"},{readOnly:!0})],dm.prototype,"type",void 0),u([d({type:QA,json:{write:!0}})],dm.prototype,"material",void 0),u([d(eRe)],dm.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],dm.prototype,"castShadows",void 0),u([d({type:k_,json:{write:!0}})],dm.prototype,"outline",void 0),u([d(Wue)],dm.prototype,"edges",void 0),dm=q$=u([P("esri.symbols.FillSymbol3DLayer")],dm);const f4=dm,vRe=["none","underline","line-through"],_Re=["normal","italic","oblique"],bRe=["normal","lighter","bold","bolder"],uhe={type:Number,cast:e=>{const t=oh(e);return t===0?1:$e(t,.1,4)},nonNullable:!0},wRe=["left","right","center"],xRe=["baseline","top","middle","bottom"],hhe={type:wRe,nonNullable:!0},dhe={type:xRe,nonNullable:!0};var oB;let pm=oB=class extends fe{constructor(e){super(e),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(e){return Zi(e)}clone(){return new oB({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:vRe,json:{default:"none",write:!0}})],pm.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],pm.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.textSymbol3D})}}})],pm.prototype,"size",void 0),u([Ot("size")],pm.prototype,"castSize",null),u([d({type:_Re,json:{default:"normal",write:!0}})],pm.prototype,"style",void 0),u([d({type:bRe,json:{default:"normal",write:!0}})],pm.prototype,"weight",void 0),pm=oB=u([P("esri.symbols.Font")],pm);const m4=pm,TRe=me.getLogger("esri.core.urlUtils"),B2=Ii.request,UQ="esri/config: esriConfig.request.proxyUrl is not set.",phe=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,fhe=/^\s*http:/i,SRe=/^\s*https:/i,ERe=/^\s*file:/i,CRe=/:\d+$/,ARe=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,RRe=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),MRe=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");class KT{constructor(t=""){this.uri=t,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let i=this.uri.match(RRe);this.scheme=i[2]||(i[1]?"":null),this.authority=i[4]||(i[3]?"":null),this.path=i[5],this.query=i[7]||(i[6]?"":null),this.fragment=i[9]||(i[8]?"":null),this.authority!=null&&(i=this.authority.match(MRe),this.user=i[3]||null,this.password=i[4]||null,this.host=i[6]||i[7],this.port=i[9]||null)}toString(){return this.uri}}const k3={},ORe=new KT(Ii.applicationUrl);let wa=ORe;const PRe=IRe();let uq=PRe;const hq=()=>wa,M0t=()=>uq;function IRe(){const e=wa.path,t=e.substring(0,e.lastIndexOf(e.split("/")[e.split("/").length-1]));return`${`${wa.scheme}://${wa.host}${wa.port!=null?`:${wa.port}`:""}`}${t}`}function hn(e){const t={path:null,query:null},i=new KT(e),r=e.indexOf("?");return i.query===null?t.path=e:(t.path=e.substring(0,r),t.query=mhe(i.query)),i.fragment&&(t.hash=i.fragment,i.query===null&&(t.path=t.path.substring(0,t.path.length-(i.fragment.length+1)))),t}function mhe(e){const t=e.split("&"),i={};for(const r of t){if(!r)continue;const s=r.indexOf("=");let n,o;s<0?(n=decodeURIComponent(r),o=""):(n=decodeURIComponent(r.slice(0,s)),o=decodeURIComponent(r.slice(s+1)));let a=i[n];typeof a=="string"&&(a=i[n]=[a]),Array.isArray(a)?a.push(o):i[n]=o}return i}function kQ(e){return e&&typeof e=="object"&&"toJSON"in e&&typeof e.toJSON=="function"}function QR(e,t){return e?t&&typeof t=="function"?Object.keys(e).map(i=>encodeURIComponent(i)+"="+encodeURIComponent(t(i,e[i]))).join("&"):Object.keys(e).map(i=>{const r=e[i];if(r==null)return"";const s=encodeURIComponent(i)+"=",n=t&&t[i];return n?s+encodeURIComponent(n(r)):Array.isArray(r)?r.map(o=>kQ(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):kQ(r)?s+encodeURIComponent(JSON.stringify(r)):s+encodeURIComponent(r)}).filter(i=>i).join("&"):""}function $Re(e=!1){let t,i=B2.proxyUrl;if(typeof e=="string"){t=kRe(e);const r=g4(e);r&&(i=r.proxyUrl)}else t=!!e;if(!i)throw TRe.warn(UQ),new q("urlutils:proxy-not-set",UQ);return t&&aB()&&(i=gq(i)),hn(i)}function O0t(e){const t=g4(e);let i,r;if(t){const s=dq(t.proxyUrl);i=s.path,r=s.query?mhe(s.query):null}if(i){const s=hn(e);e=i+"?"+s.path;const n=QR(F(F({},r),s.query));n&&(e=`${e}?${n}`)}return e}const _E={path:"",query:""};function dq(e){const t=e.indexOf("?");return t!==-1?(_E.path=e.slice(0,t),_E.query=e.slice(t+1)):(_E.path=e,_E.query=null),_E}function ghe(e){return e=(e=sN(e=HRe(e=dq(e).path),!0)).toLowerCase()}function DRe(e){const t={proxyUrl:e.proxyUrl,urlPrefix:ghe(e.urlPrefix)},i=B2.proxyRules,r=t.urlPrefix;let s=i.length;for(let n=0;n<i.length;n++){const o=i[n].urlPrefix;if(r.indexOf(o)===0){if(r.length===o.length)return-1;s=n;break}o.indexOf(r)===0&&(s=n+1)}return i.splice(s,0,t),s}function g4(e){const t=B2.proxyRules,i=ghe(e);for(let r=0;r<t.length;r++)if(i.indexOf(t[r].urlPrefix)===0)return t[r]}function yhe(e,t){return e=zQ(e),t=zQ(t),sN(e)===sN(t)}function zQ(e){const t=(e=bh(e)).indexOf("/sharing");return t>0?e.substring(0,t):e.replace(/\/+$/,"")}function vhe(e){const t=r=>r==null||r instanceof RegExp&&r.test(e)||typeof r=="string"&&e.startsWith(r),i=B2.interceptors;if(i){for(const r of i)if(Array.isArray(r.urls)){if(r.urls.some(t))return r}else if(t(r.urls))return r}return null}function JR(e,t,i=!1){const r=cB(e),s=cB(t);return!(!i&&r.scheme!==s.scheme)&&r.host!=null&&s.host!=null&&r.host.toLowerCase()===s.host.toLowerCase()&&r.port===s.port}function pq(e){if(typeof e=="string"){if(!ru(e))return!0;e=cB(e)}if(JR(e,wa))return!0;const t=B2.trustedServers||[];for(let i=0;i<t.length;i++){const r=LRe(t[i]);for(let s=0;s<r.length;s++)if(JR(e,r[s]))return!0}return!1}function LRe(e){return k3[e]||(mq(e)||Tf(e)?k3[e]=[new KT(gh(e))]:k3[e]=[new KT(`http://${e}`),new KT(`https://${e}`)]),k3[e]}function gh(e,t=uq,i){return Tf(e)?i&&i.preserveProtocolRelative?e:wa.scheme==="http"&&wa.authority===zd(e).slice(2)?`http:${e}`:`https:${e}`:mq(e)?e:du(e[0]==="/"?GRe(t):t,e)}function fq(e,t=uq,i){if(!ru(e))return e;const r=bh(e),s=r.toLowerCase(),n=bh(t).toLowerCase().replace(/\/+$/,""),o=i?bh(i).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return e;const a=(p,f,m)=>(m=p.indexOf(f,m))===-1?p.length:m;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return e;e=r.slice(c);const h=n.slice(c-1).replace(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)e=`../${e}`;else e=`./${e}`;return e}function bh(e){return e=XRe(e=WRe(e=qRe(e=gh(e=e.trim()))))}function du(...e){const t=e.filter(_);if(!t||!t.length)return;const i=[];if(ru(t[0])){const s=t[0],n=s.indexOf("//");n!==-1&&(i.push(s.slice(0,n+1)),VRe(t[0])&&(i[0]+="/"),t[0]=s.slice(n+2))}else t[0][0]==="/"&&i.push("");const r=t.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<r.length;s++){const n=r[s];n===".."&&i.length>0&&i[i.length-1]!==".."?i.pop():(!n&&s===r.length-1||n&&(n!=="."||i.length===0))&&i.push(n)}return i.join("/")}function zd(e,t=!1){if(FS(e)||Lf(e))return null;let i=e.indexOf("://");if(i===-1&&Tf(e))i=2;else{if(i===-1)return null;i+=3}const r=e.indexOf("/",i);return r!==-1&&(e=e.slice(0,r)),t&&(e=sN(e,!0)),e}function ru(e){return Tf(e)||mq(e)}function FS(e){return e!=null&&e.slice(0,5)==="blob:"}function Lf(e){return e.slice(0,5)==="data:"}function _he(e){const t=y4(e);if(!t||!t.isBase64)return null;const i=atob(t.data),r=new Uint8Array(i.length);for(let s=0;s<i.length;s++)r[s]=i.charCodeAt(s);return r.buffer}function P0t(e){return btoa(String.fromCharCode.apply(null,e)).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}const NRe=/^data:(.*?)(;base64)?,(.*)$/;function y4(e){const t=e.match(NRe);if(!t)return null;const[,i,r,s]=t;return{mediaType:i,isBase64:!!r,data:s}}function bhe(e){return e.isBase64?`data:${e.mediaType};base64,${e.data}`:`data:${e.mediaType},${e.data}`}function I0t(e,t){FRe(e,t)||URe(e,t)}function FRe(e,t){if(!e)return!1;const i=document.createElement("a");if(!("download"in i))return!1;const r=URL.createObjectURL(e);return i.download=t,i.href=r,i.style.display="none",document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(r),!0}function URe(e,t){return!!window.navigator.msSaveOrOpenBlob&&window.navigator.msSaveOrOpenBlob(e,t)}function Tf(e){return e!=null&&e!==void 0&&e[0]==="/"&&e[1]==="/"}function mq(e){return phe.test(e)}function kRe(e){return SRe.test(e)||wa.scheme==="https"&&Tf(e)}function zRe(e){return fhe.test(e)||wa.scheme==="http"&&Tf(e)}function VRe(e){return ERe.test(e)}function gq(e){return Tf(e)?`https:${e}`:e.replace(fhe,"https:")}function BRe(){return wa.scheme==="http"}function aB(){return wa.scheme==="https"}function sN(e,t=!1){return Tf(e)?e.slice(2):(e=e.replace(phe,""),t&&e.length>1&&e[0]==="/"&&e[1]==="/"&&(e=e.slice(2)),e)}function GRe(e){const t=e.indexOf("//"),i=e.indexOf("/",t+2);return i===-1?e:e.slice(0,i)}function jRe(e){let t=0;if(ru(e)){const r=e.indexOf("//");r!==-1&&(t=r+2)}const i=e.lastIndexOf("/");return i<t?e:e.slice(0,i+1)}function $0t(e,t){if(!e)return"";const i=hn(e).path.replace(/\/+$/,""),r=i.substring(i.lastIndexOf("/")+1);if(!(t==null?void 0:t.length))return r;const s=new RegExp(`.(${t.join("|")})$`,"ig");return r.replace(s,"")}function HRe(e){return e&&e[e.length-1]==="/"?e:`${e}/`}function whe(e){return e.replace(/\/+$/,"")}function qRe(e){if(/^https?:\/\//i.test(e)){const t=dq(e);e=(e=t.path.replace(/\/{2,}/g,"/")).replace("/","//"),t.query&&(e+=`?${t.query}`)}return e}function WRe(e){return e.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function XRe(e){const t=B2.httpsDomains;if(!zRe(e))return e;const i=e.indexOf("/",7);let r;if(r=i===-1?e:e.slice(0,i),r=r.toLowerCase().slice(7),CRe.test(r)){if(!r.endsWith(":80"))return e;r=r.slice(0,-3),e=e.replace(":80","")}return BRe()&&r===wa.authority&&!ARe.test(e)||(aB()&&r===wa.authority||t&&t.some(s=>r===s||r.endsWith(`.${s}`))||aB()&&!g4(e))&&(e=gq(e)),e}function lB(e,t,i){if(!(t&&i&&e&&ru(e)))return e;const r=e.indexOf("//"),s=e.indexOf("/",r+2),n=e.indexOf(":",r+2),o=Math.min(s<0?e.length:s,n<0?e.length:n);return e.slice(r+2,o).toLowerCase()!==t.toLowerCase()?e:`${e.slice(0,r+2)}${i}${e.slice(o)}`}function cB(e){return typeof e=="string"?new KT(gh(e)):(e.scheme||(e.scheme=wa.scheme),e)}function yq(e){return QRe.test(e)}function xhe(e,t){const i=hn(e),r=Object.keys(i.query||{});return r.length>0&&t&&t.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${r.join(", ")}.`),i.path}function vq(e,t,i){const r=hn(e),s=r.query||{};return s[t]=String(i),`${r.path}?${QR(s)}`}function hk(e,t){const i=hn(e),r=i.query||{};for(const n in t)r[n]=t[n];const s=QR(r);return s?`${i.path}?${s}`:i.path}function YRe(e){if(R(e))return null;const t=e.match(ZRe);return t?t[1]:null}const ZRe=/.*?\.([^\/]*)$/,QRe=/(^data:image\/svg|\.svg$)/i;function G2(e,t){const i=t&&t.url&&t.url.path;if(e&&i&&(e=gh(e,i,{preserveProtocolRelative:!0}),t.portalItem&&t.readResourcePaths)){const r=fq(e,t.portalItem.itemUrl);KRe.test(r)&&t.readResourcePaths.push(t.portalItem.resourceFromPath(r).path)}return uB(e,t&&t.portal)}function Ib(e,t,i=KR.YES){if(!e)return e;!ru(e)&&t&&t.blockedRelativeUrls&&t.blockedRelativeUrls.push(e);let r=gh(e);if(t){const s=t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.rootPath||t.url&&t.url.path;if(s){const n=uB(s,t.portal);r=fq(uB(r,t.portal),n,n),r!==e&&t.verifyItemRelativeUrls&&t.verifyItemRelativeUrls.writtenUrls.push(r)}}return r=The(r,t&&t.portal),ru(r)&&(r=bh(r)),(t==null?void 0:t.resources)&&(t==null?void 0:t.portalItem)&&!ru(r)&&!Lf(r)&&i===KR.YES&&t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(r)}),r}function _q(e,t,i){return G2(e,i)}function fv(e,t,i,r){const s=Ib(e,r);s!==void 0&&(t[i]=s)}const JRe=/\/items\/([^\/]+)\/resources\//,KRe=/^\.\/resources\//;function eMe(e){const t=_(e)?e.match(JRe):null;return _(t)?t[1]:null}function The(e,t){return t&&!t.isPortal&&t.urlKey&&t.customBaseUrl?lB(e,`${t.urlKey}.${t.customBaseUrl}`,t.portalHostname):e}function uB(e,t){if(!t||t.isPortal||!t.urlKey||!t.customBaseUrl)return e;const i=`${t.urlKey}.${t.customBaseUrl}`,r=hq();return JR(r,`${r.scheme}://${i}`)?lB(e,t.portalHostname,i):lB(e,i,t.portalHostname)}var KR;(function(e){e[e.YES=0]="YES",e[e.NO=1]="NO"})(KR||(KR={}));const D0t=Object.freeze(Object.defineProperty({__proto__:null,fromJSON:G2,toJSON:Ib,read:_q,write:fv,itemIdFromResourceUrl:eMe,ensureMainOnlineDomain:The,get MarkKeep(){return KR}},Symbol.toStringTag,{value:"Module"}));var hB;const tMe=Zo()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let z_=hB=class extends fe{constructor(e){super(e)}readHref(e,t,i){return e?G2(e,i):t.dataURI}writeHref(e,t,i,r){e&&(Lf(e)?t.dataURI=e:(t.href=Ib(e,r),ru(t.href)&&(t.href=bh(t.href))))}clone(){return new hB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],z_.prototype,"href",void 0),u([ke("href")],z_.prototype,"readHref",null),u([Be("href",{href:{type:String},dataURI:{type:String}})],z_.prototype,"writeHref",null),u([ct(tMe)],z_.prototype,"primitive",void 0),z_=hB=u([P("esri.symbols.support.IconSymbol3DLayerResource")],z_);const iMe="circle";var dB;let ET=dB=class extends Ee{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new dB({x:this.x,y:this.y})}};u([d({type:Number})],ET.prototype,"x",void 0),u([d({type:Number})],ET.prototype,"y",void 0),ET=dB=u([P("esri.symbols.support.Symbol3DAnchorPosition2D")],ET);var pB;let jC=pB=class extends fe{constructor(e){super(e),this.color=new qe([0,0,0,1]),this.size=uu(1)}clone(){const e={color:_(this.color)?this.color.clone():null,size:this.size};return new pB(e)}};u([d(Ig)],jC.prototype,"color",void 0),u([d(wf)],jC.prototype,"size",void 0),jC=pB=u([P("esri.symbols.support.Symbol3DIconOutline")],jC);var Ix;const rMe=me.getLogger("esri.symbols.IconSymbol3DLayer");let Ep=Ix=class extends Df{constructor(e){super(e),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=void 0,this.outline=void 0}clone(){return new Ix({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:_(this.material)?this.material.clone():null,outline:_(this.outline)?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(e){const t=e.color||ZA,i=VQ(e),r=e.outline&&e.outline.width>0?{size:e.outline.width,color:(e.outline.color||ZA).clone()}:null;return new Ix({size:e.size,resource:{primitive:nMe(e.style)},material:{color:t},outline:r,anchor:i?"relative":void 0,anchorPosition:i})}static fromPictureMarkerSymbol(e){const t=!e.color||iRe(e.color)?ZA:e.color,i=VQ(e);return new Ix({size:e.width<=e.height?e.height:e.width,resource:{href:e.url},material:{color:t.clone()},anchor:i?"relative":void 0,anchorPosition:i})}static fromCIMSymbol(e){return new Ix({resource:{href:bhe({mediaType:"application/json",data:JSON.stringify(e.data)})}})}};function VQ(e){const t="width"in e?e.width:e.size,i="height"in e?e.height:e.size,r=BQ(e.xoffset),s=BQ(e.yoffset);return(r||s)&&t&&i?{x:-r/t,y:s/i}:null}function BQ(e){return isFinite(e)?e:0}u([d({type:iu,json:{write:!0}})],Ep.prototype,"material",void 0),u([d({type:z_,json:{write:!0}})],Ep.prototype,"resource",void 0),u([ct({Icon:"icon"},{readOnly:!0})],Ep.prototype,"type",void 0),u([d(wf)],Ep.prototype,"size",void 0),u([ct({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],Ep.prototype,"anchor",void 0),u([d({type:ET,json:{type:[Number],read:{reader:e=>new ET({x:e[0],y:e[1]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],Ep.prototype,"anchorPosition",void 0),u([d({type:jC,json:{write:!0}})],Ep.prototype,"outline",void 0),Ep=Ix=u([P("esri.symbols.IconSymbol3DLayer")],Ep);const sMe={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function nMe(e){return sMe[e]||(rMe.warn(`${e} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const D0=Ep;function _g(e,t,i=at){return t||(t=new i),t===e||(t.removeAll(),oMe(e)?t.addMany(e):e&&t.add(e)),t}function bq(e){return e}function oMe(e){return e&&(Array.isArray(e)||"items"in e&&Array.isArray(e.items))}const She="20220630",Ehe="5a46844c5ac1b721521da79fb0304de9e8457e2c",wq="4.24",aMe={async request(e,t){var a;const{default:i}=await Promise.resolve().then(function(){return TMe}),r=e.options,s=r.responseType;r.signal=t==null?void 0:t.signal,r.responseType=s==="native"||s==="native-request-init"?"native-request-init":["blob","json","text"].includes(s)&&((a=vhe(e.url))==null?void 0:a.after)?s:"array-buffer";const n=await i(e.url,r),o={data:n.data,ssl:n.ssl};switch(n.requestOptions.responseType){case"native-request-init":return delete o.data.signal,o;case"blob":o.data=await o.data.arrayBuffer();break;case"json":o.data=new TextEncoder().encode(JSON.stringify(o.data)).buffer;break;case"text":o.data=new TextEncoder().encode(o.data).buffer}return{result:o,transferList:[o.data]}}};let Ps;function L0t(e){Ps=e}function N0t(e){const t=Ps&&Ps.findCredential(e);return t&&t.token?vq(e,"token",t.token):e}he("host-webworker")||(he("edge")||he("trident"))&&console.warn("Deprecated browser - see http://esriurl.com/oldbrowser");const lMe=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function Che(e){const t=zd(e,!0);return t&&t.endsWith(".arcgis.com")&&!lMe.includes(t)&&!e.endsWith("/sharing/rest/generateToken")}function Ahe(e,t,i=!1,r){return new Promise((s,n)=>{if(Xs(r))return void n(GQ());let o=()=>{c(),n(new Error(`Unable to load ${t}`))},a=()=>{const h=e;c(),s(h)},l=()=>{if(!e)return;const h=e;c(),h.src="",n(GQ())};const c=()=>{he("esri-image-decode")||(e.removeEventListener("error",o),e.removeEventListener("load",a)),o=null,a=null,e=null,_(r)&&r.removeEventListener("abort",l),l=null,i&&URL.revokeObjectURL(t)};_(r)&&r.addEventListener("abort",l),he("esri-image-decode")?e.decode().then(a,o):(e.addEventListener("error",o),e.addEventListener("load",a))})}function GQ(){try{return new DOMException("Aborted","AbortError")}catch{const e=new Error;return e.name="AbortError",e}}function cMe(e){Ii.request.crossOriginNoCorsDomains||(Ii.request.crossOriginNoCorsDomains={});const t=Ii.request.crossOriginNoCorsDomains;for(let i of e)i=i.toLowerCase(),/^https?:\/\//.test(i)?t[zd(i)]=0:(t[zd("http://"+i)]=0,t[zd("https://"+i)]=0)}function uMe(e){const t=Ii.request.crossOriginNoCorsDomains;if(t){let i=zd(e);if(i)return i=i.toLowerCase(),!JR(i,hq())&&t[i]<Date.now()-36e5}return!1}async function hMe(e){var r;const t=Ii.request.crossOriginNoCorsDomains;t&&(t[zd(e).toLowerCase()]=Date.now());const i=hn(e);e=i.path,((r=i.query)==null?void 0:r.f)==="json"&&(e+="?f=json");try{await fetch(e,{mode:"no-cors",credentials:"include"})}catch{}}async function ur(e,t){var c;const i=Lf(e),r=FS(e);r||i||(e=bh(e));const s={url:e,requestOptions:F({},t)};let n=vhe(e);if(n){const h=await _Me(n,s);if(h!=null)return{data:h,getHeader:xq,requestOptions:s.requestOptions,url:s.url};n.after||n.error||(n=null)}if(e=s.url,(t=s.requestOptions).responseType==="image"){if(he("host-webworker")||he("host-node"))throw Dd("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s)}else if(i)throw Dd("request:invalid-parameters",new Error("Data URLs are not supported for responseType = "+t.responseType),s);if(t.method==="head"){if(t.body)throw Dd("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),s);if(i||r)throw Dd("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),s)}if(await gMe(),nN)return nN.execute(e,t);const o=new AbortController;Wo(t,()=>o.abort());const a={controller:o,credential:null,credentialToken:null,fetchOptions:null,hasToken:!1,interceptor:n,params:s,redoRequest:!1,useIdentity:vd.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},l=await wMe(a);return(c=n==null?void 0:n.after)==null||c.call(n,l),l}let nN;const vd=Ii.request,Rhe="FormData"in globalThis,dMe=[499,498,403,401],pMe=["COM_0056","COM_0057","SB_0008"],fMe=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],xq=()=>null,fB=Symbol();function mMe(e){const t=zd(e);t&&!ur._corsServers.includes(t)&&ur._corsServers.push(t)}function jQ(e){const t=zd(e);return!t||t.endsWith(".arcgis.com")||ur._corsServers.includes(t)||pq(t)}function Dd(e,t,i,r){let s="Error";const n={url:i.url,requestOptions:i.requestOptions,getHeader:xq,ssl:!1};if(t instanceof q)return t.details?(t.details=te(t.details),t.details.url=i.url,t.details.requestOptions=i.requestOptions):t.details=n,t;if(t){const o=r&&(c=>r.headers.get(c)),a=r&&r.status,l=t.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(t.httpCode!=null?t.httpCode:t.code)||a||0,n.subCode=t.subcode,n.messageCode=t.messageCode,typeof t.details=="string"?n.messages=[t.details]:n.messages=t.details,n.raw=fB in t?t[fB]:t}return Gr(t)?ui():new q(e,s,n)}async function gMe(){he("host-webworker")?nN||(nN=await import("./request.e523b242.js")):ur._abortableFetch||(ur._abortableFetch=globalThis.fetch.bind(globalThis))}async function mB(){Ps||await import("./IdentityManager.a250be1b.js")}async function yMe(e){var a;const t=e.params.url,i=e.params.requestOptions,r=e.controller.signal,s=i.body;let n=null,o=null;if(Rhe&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(n=new FormData(s))),typeof s=="string"&&(o=s),e.fetchOptions={cache:i.cacheBust&&!ur._abortableFetch.polyfill?"no-cache":"default",credentials:"same-origin",headers:i.headers||{},method:i.method==="head"?"HEAD":"GET",mode:"cors",priority:vd.priority,redirect:"follow",signal:r},(n||o)&&(e.fetchOptions.body=n||o),i.authMode==="anonymous"&&(e.useIdentity=!1),e.hasToken=!!(/token=/i.test(t)||((a=i.query)==null?void 0:a.token)||(n==null?void 0:n.get("token"))),!e.hasToken&&Ii.apiKey&&Che(t)&&(i.query||(i.query={}),i.query.token=Ii.apiKey,e.hasToken=!0),e.useIdentity&&!e.hasToken&&!e.credentialToken&&!Mhe(t)&&!Xs(r)){let l;i.authMode==="immediate"?(await mB(),l=await Ps.getCredential(t,{signal:r}),e.credential=l):i.authMode==="no-prompt"?(await mB(),l=await Ps.getCredential(t,{prompt:!1,signal:r}).catch(()=>{}),e.credential=l):Ps&&(l=Ps.findCredential(t)),l&&(e.credentialToken=l.token,e.useSSL=!!l.ssl)}}function Mhe(e){return fMe.some(t=>t.test(e))}async function vMe(e){let t=e.params.url;const i=e.params.requestOptions,r=e.fetchOptions,s=FS(t)||Lf(t),n=i.responseType||"json",o=s?0:i.timeout!=null?i.timeout:vd.timeout;let a=!1;if(!s){e.useSSL&&(t=gq(t)),i.cacheBust&&r.cache==="default"&&(t=vq(t,"request.preventCache",Date.now()));let f=F({},i.query);e.credentialToken&&(f.token=e.credentialToken);let m=QR(f);he("esri-url-encodes-apostrophe")&&(m=m.replace(/'/g,"%27"));const y=t.length+1+m.length;let v;a=i.method==="delete"||i.method==="post"||i.method==="put"||!!i.body||y>vd.maxUrlLength;const w=i.useProxy||!!g4(t);if(w){const b=$Re(t);v=b.path,!a&&v.length+1+y>vd.maxUrlLength&&(a=!0),b.query&&(f=F(F({},b.query),f))}if(r.method==="HEAD"&&(a||w)){if(a)throw y>vd.maxUrlLength?Dd("request:invalid-parameters",new Error("URL exceeds maximum length"),e.params):Dd("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),e.params);if(w)throw Dd("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),e.params)}if(a?(r.method=i.method==="delete"?"DELETE":i.method==="put"?"PUT":"POST",i.body?t=hk(t,f):(r.body=QR(f),r.headers["Content-Type"]="application/x-www-form-urlencoded")):t=hk(t,f),w&&(e.useProxy=!0,t=`${v}?${t}`),f.token&&Rhe&&r.body instanceof FormData&&!/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(t)&&r.body.set("token",f.token),i.hasOwnProperty("withCredentials"))e.withCredentials=i.withCredentials;else if(!JR(t,hq())){if(pq(t))e.withCredentials=!0;else if(Ps){const b=Ps.findServerInfo(t);b&&b.webTierAuth&&(e.withCredentials=!0)}}e.withCredentials&&(r.credentials="include",uMe(t)&&await hMe(a?hk(t,f):t))}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,e.controller.abort()},o));try{if(i.responseType==="native-request-init")c=r,c.url=t;else if(i.responseType!=="image"||r.cache!=="default"||r.method!=="GET"||a||bMe(i.headers)||!s&&!e.useProxy&&vd.proxyUrl&&!jQ(t)){if(l=await ur._abortableFetch(t,r),e.useProxy||mMe(t),i.responseType==="native")c=l;else if(r.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=HQ(c,"application/xml");break;case"document":c=HQ(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const m=await new Response(c).json();m.error&&(c=m)}catch{}}n==="image"&&c instanceof Blob&&(c=await qQ(URL.createObjectURL(c),e,!0))}}else c=await l.text()}else c=await qQ(t,e)}catch(f){if(f.name==="AbortError")throw p?new Error("Timeout exceeded"):ui("Request canceled");if(!(!l&&f instanceof TypeError&&vd.proxyUrl)||i.body||i.method==="delete"||i.method==="head"||i.method==="post"||i.method==="put"||e.useProxy||jQ(t))throw f;e.redoRequest=!0,DRe({proxyUrl:vd.proxyUrl,urlPrefix:zd(t)})}finally{h&&clearTimeout(h)}return[l,c]}async function _Me(e,t){if(e.responseData!=null)return e.responseData;if(e.headers&&(t.requestOptions.headers=F(F({},t.requestOptions.headers),e.headers)),e.query&&(t.requestOptions.query=F(F({},t.requestOptions.query),e.query)),e.before){let i,r;try{r=await e.before(t)}catch(s){i=Dd("request:interceptor",s,t)}if((r instanceof Error||r instanceof q)&&(i=Dd("request:interceptor",r,t)),i)throw e.error&&e.error(i),i;return r}}function bMe(e){if(e){for(const t of Object.getOwnPropertyNames(e))if(e[t])return!0}return!1}function HQ(e,t){let i;try{i=new DOMParser().parseFromString(e,t)}catch{}if(!i||i.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return i}async function wMe(e){var n;let t,i;await yMe(e);try{do[t,i]=await vMe(e);while(!await xMe(e,t,i))}catch(o){const a=Dd("request:server",o,e.params,t);throw a.details.ssl=e.useSSL,e.interceptor&&e.interceptor.error&&e.interceptor.error(a),a}const r=e.params.url;if(i&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(r)){if(!e.hasToken&&!e.credentialToken&&((n=i.user)==null?void 0:n.username)&&!pq(r)){const o=zd(r,!0);o&&vd.trustedServers.push(o)}Array.isArray(i.authorizedCrossOriginNoCorsDomains)&&cMe(i.authorizedCrossOriginNoCorsDomains)}const s=e.credential;if(s&&Ps){const o=Ps.findServerInfo(s.server);let a=o&&o.owningSystemUrl;if(a){a=a.replace(/\/?$/,"/sharing");const l=Ps.findCredential(a,s.userId);l&&Ps._getIdenticalSvcIdx(a,l)===-1&&l.resources.unshift(a)}}return{data:i,getHeader:t?o=>t.headers.get(o):xq,requestOptions:e.params.requestOptions,ssl:e.useSSL,url:e.params.url}}async function xMe(e,t,i){if(e.redoRequest)return e.redoRequest=!1,!1;const r=e.params.requestOptions;if(!t||r.responseType==="native"||r.responseType==="native-request-init")return!0;let s,n,o,a;if(!t.ok)throw s=new Error(`Unable to load ${t.url} status: ${t.status}`),s[fB]=i,s;(i==null?void 0:i.error)&&(s=i.error),s&&(n=Number(s.code),o=s.hasOwnProperty("subcode")?Number(s.subcode):null,a=s.messageCode,a=a&&a.toUpperCase());const l=r.authMode;if(n===403&&(o===4||s.message&&s.message.toLowerCase().includes("ssl")&&!s.message.toLowerCase().includes("permission"))){if(!e.useSSL)return e.useSSL=!0,!1}else if(!e.hasToken&&e.useIdentity&&(l!=="no-prompt"||n===498)&&dMe.includes(n)&&!Mhe(e.params.url)&&(n!==403||!pMe.includes(a)&&(o==null||o===2&&e.credentialToken))){await mB();try{const c=await Ps.getCredential(e.params.url,{error:Dd("request:server",s,e.params),prompt:l!=="no-prompt",signal:e.controller.signal,token:e.credentialToken});return e.credential=c,e.credentialToken=c.token,e.useSSL=e.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return e.credential=null,e.credentialToken=null,!1;s=c}}if(s)throw s;return!0}function qQ(e,t,i=!1){const r=t.controller.signal,s=new Image;return t.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.fetchPriority=vd.priority,s.src=e,Ahe(s,e,i,r)}ur._abortableFetch=null,ur._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];var TMe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:ur}),u0;(function(e){e[e.PENDING=0]="PENDING",e[e.RESOLVED=1]="RESOLVED",e[e.REJECTED=2]="REJECTED"})(u0||(u0={}));class SMe{constructor(t){this.instance=t,this._resolver=hv(),this._status=u0.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=u0.RESOLVED,this._cleanUp()},()=>{this._status=u0.REJECTED,this._cleanUp()})}addResolvingPromise(t){this._resolvingPromises.push(t),this._tryResolve()}isResolved(){return this._status===u0.RESOLVED}isRejected(){return this._status===u0.REJECTED}isFulfilled(){return this._status!==u0.PENDING}abort(){this._resolver.reject(ui())}when(t,i){return this._resolver.promise.then(t,i)}_cleanUp(){this._allPromise=this._resolvingPromises=this._allPromise=null}_tryResolve(){if(this.isFulfilled())return;const t=hv(),i=[...this._resolvingPromises,t.promise],r=this._allPromise=Promise.all(i);r.then(()=>{this.isFulfilled()||this._allPromise!==r||this._resolver.resolve(this.instance)},s=>{this.isFulfilled()||this._allPromise!==r||Gr(s)||this._resolver.reject(s)}),t.resolve()}}const SO=e=>{let t=class extends e{constructor(...i){super(...i),this._promiseProps=new SMe(this),this.addResolvingPromise(Promise.resolve())}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(i,r){return new Promise((s,n)=>{this._promiseProps.when(s,n)}).then(i,r)}catch(i){return this.when(null,i)}addResolvingPromise(i){i&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in i?i.when():i)}};return t=u([P("esri.core.Promise")],t),t};let oN=class extends SO(Ee){};oN=u([P("esri.core.Promise")],oN);const EMe="not-loaded",CMe="loading",AMe="failed",WQ="loaded",Ohe=e=>{let t=class extends e{constructor(...i){super(...i),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(r=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=r4(n,l);this.destroyed&&l(new q("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this._promiseProps.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===EMe){this._set("loadStatus",CMe);const a=this._loadController=new AbortController;s({signal:a.signal}),Wo(a.signal,()=>{this._promiseProps.abort()})}return r(),o}})),this.when(()=>{this._set("loadStatus",WQ),this._loadController=null},r=>{this._set("loadStatus",AMe),this._set("loadError",r),this._loadController=null})}get loaded(){return this.loadStatus===WQ}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){var i;return this.isFulfilled()||(this._set("loadError",new q("load:cancelled","Cancelled")),(i=this._loadController)==null||i.abort()),this}};return u([d({readOnly:!0})],t.prototype,"loaded",null),u([d({readOnly:!0})],t.prototype,"loadError",void 0),u([d({clonable:!1})],t.prototype,"loadStatus",void 0),u([d({type:[lu],readOnly:!0})],t.prototype,"loadWarnings",null),t=u([P("esri.core.Loadable")],t),t};let HC=class extends Ohe(oN){};HC=u([P("esri.core.Loadable")],HC),function(e){function t(i){return!(!i||!i.load)}e.LoadableMixin=Ohe,e.isLoadable=t}(HC||(HC={}));const Sf=HC;var gB;const RMe=new _i({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let Uu=gB=class extends Ee{constructor(e){super(e),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(e){e!=="asc"&&e!=="desc"||this._set("sortOrder",e)}clone(){return new gB({categories:this.categories?te(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(e,t){let i,r;if(this.categories&&(i=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o)),this.extent){const o=aw(this.extent,Xe.WGS84);_(o)&&(r=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&e.extraQuery&&(s="("+s+")"+e.extraQuery);const n={categories:i,bbox:r,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>RMe.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:F(F({},t),n)}}};u([d()],Uu.prototype,"categories",void 0),u([d()],Uu.prototype,"disableExtraQuery",void 0),u([d({type:ci})],Uu.prototype,"extent",void 0),u([d()],Uu.prototype,"filter",void 0),u([d()],Uu.prototype,"num",void 0),u([d()],Uu.prototype,"query",void 0),u([d()],Uu.prototype,"sortField",void 0),u([d()],Uu.prototype,"sortOrder",null),u([d()],Uu.prototype,"start",void 0),Uu=gB=u([P("esri.portal.PortalQueryParams")],Uu);const Wm=Uu;let V_=class extends Ee{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],V_.prototype,"nextQueryParams",void 0),u([d()],V_.prototype,"queryParams",void 0),u([d()],V_.prototype,"results",void 0),u([d()],V_.prototype,"total",void 0),V_=u([P("esri.portal.PortalQueryResult")],V_);const MMe=V_;let fm=class extends fe{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new q("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],fm.prototype,"created",void 0),u([d()],fm.prototype,"id",void 0),u([d()],fm.prototype,"portal",void 0),u([d()],fm.prototype,"title",void 0),u([d({readOnly:!0})],fm.prototype,"url",null),u([d()],fm.prototype,"username",void 0),fm=u([P("esri.portal.PortalFolder")],fm);const OMe=fm;let Ln=class extends fe{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return this.portal._request(this.url+"/categorySchema",e).then(t=>{const i=t.categorySchema||[];return i.some(r=>r.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return this.portal._request(this.url+"/users",e)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,t){let i=Qr(Wm,e);return parseFloat(this.portal.currentVersion)>5?(i=i||new Wm,this.portal._queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",t)):(i=i?i.clone():new Wm,i.query="group:"+this.id+(i.query?" "+i.query:""),this.portal.queryItems(i,t))}_fetchCategorySchemaSet(e,t){return this.portal._fetchSelf(this.portal.authMode,!0,t).then(i=>{const r=i.contentCategorySetsGroupQuery;if(r){const s=new Wm;return s.disableExtraQuery=!0,s.num=1,s.query=r,this.portal.queryGroups(s,t)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(i=>{if(i.total){const r=i.results[0],s=new Wm;return s.num=1,s.query=`typekeywords:"${e}"`,r.queryItems(s,t)}throw new q("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(i=>i.total?i.results[0].fetchData("json",t).then(r=>{const s=r&&r.categorySchema;return s&&s.length?s:[]}):[])}};u([d()],Ln.prototype,"access",void 0),u([d({type:Date})],Ln.prototype,"created",void 0),u([d()],Ln.prototype,"description",void 0),u([d()],Ln.prototype,"id",void 0),u([d()],Ln.prototype,"isInvitationOnly",void 0),u([d({type:Date})],Ln.prototype,"modified",void 0),u([d()],Ln.prototype,"owner",void 0),u([d()],Ln.prototype,"portal",void 0),u([d()],Ln.prototype,"snippet",void 0),u([d()],Ln.prototype,"sortField",void 0),u([d()],Ln.prototype,"sortOrder",void 0),u([d()],Ln.prototype,"tags",void 0),u([d()],Ln.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ln.prototype,"thumbnailUrl",null),u([d()],Ln.prototype,"title",void 0),u([d({readOnly:!0})],Ln.prototype,"url",null),Ln=u([P("esri.portal.PortalGroup")],Ln);const yB=Ln;var PMe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:yB}),vB;let Hr=vB=class extends fe{constructor(...e){super(...e),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const e=this.url,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userContentUrl(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}`:null}get url(){const e=this.get("portal.restUrl");return e?`${e}/community/users/${this.username}`:null}addItem(e){const t=e&&e.item,i=e&&e.data,r=e&&e.folder,s={method:"post"};t&&(s.query=t.createPostQuery(),i!=null&&(typeof i=="string"?s.query.text=i:typeof i=="object"&&(s.query.text=JSON.stringify(i))));let n=this.userContentUrl;return r&&(n+="/"+(typeof r=="string"?r:r.id)),this.portal._request(n+"/addItem",s).then(o=>(t.id=o.id,t.portal=this.portal,t.loaded?t.reload():t.load()))}deleteItem(e){let t=this.userContentUrl;return e.ownerFolder&&(t+="/"+e.ownerFolder),this.portal._request(t+`/items/${e.id}/delete`,{method:"post"}).then(()=>{e.id=null,e.portal=null})}deleteItems(e){const t=this.userContentUrl+"/deleteItems",i=e.map(r=>r.id);if(i.length){const r={method:"post",query:{items:i.join(",")}};return this.portal._request(t,r).then(()=>{e.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const e={query:{num:1}};return this.portal._request(this.userContentUrl,e).then(t=>{let i;return i=t&&t.folders?t.folders.map(r=>{const s=OMe.fromJSON(r);return s.portal=this.portal,s}):[],i})}fetchGroups(){return this.portal._request(this.url).then(e=>{let t;return t=e&&e.groups?e.groups.map(i=>{const r=yB.fromJSON(i);return r.portal=this.portal,r}):[],t})}fetchItems(e){e||(e={});let t,i=this.userContentUrl;return e.folder&&(i+="/"+e.folder.id),Promise.resolve().then(function(){return vye}).then(({default:r})=>{t=r;const s={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal._request(i,{query:s})}).then(r=>{let s;return r&&r.items?(s=r.items.map(n=>{const o=t.fromJSON(n);return o.portal=this.portal,o}),Promise.all(s.map(n=>n.load())).catch(n=>n).then(()=>({items:s,nextStart:r.nextStart,total:r.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal._request(this.url+"/tags").then(e=>e.tags)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}queryFavorites(e){return this.favGroupId?(this._favGroup||(this._favGroup=new yB({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(e)):Promise.reject(new q("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new q("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");const t=new vB;return t.sourceJSON=e,t.read(e),t}};u([d()],Hr.prototype,"access",void 0),u([d({type:Date})],Hr.prototype,"created",void 0),u([d()],Hr.prototype,"culture",void 0),u([d()],Hr.prototype,"description",void 0),u([d()],Hr.prototype,"email",void 0),u([d()],Hr.prototype,"favGroupId",void 0),u([d()],Hr.prototype,"fullName",void 0),u([d({type:Date})],Hr.prototype,"modified",void 0),u([d()],Hr.prototype,"orgId",void 0),u([d()],Hr.prototype,"portal",void 0),u([d()],Hr.prototype,"preferredView",void 0),u([d()],Hr.prototype,"privileges",void 0),u([d()],Hr.prototype,"region",void 0),u([d()],Hr.prototype,"role",void 0),u([d()],Hr.prototype,"roleId",void 0),u([d()],Hr.prototype,"sourceJSON",void 0),u([d()],Hr.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Hr.prototype,"thumbnailUrl",null),u([d()],Hr.prototype,"units",void 0),u([d({readOnly:!0})],Hr.prototype,"userContentUrl",null),u([d({readOnly:!0})],Hr.prototype,"url",null),u([d()],Hr.prototype,"username",void 0),u([d()],Hr.prototype,"userType",void 0),Hr=vB=u([P("esri.portal.PortalUser")],Hr);const Tq=Hr;var IMe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Tq}),Tc;let dk;const XQ={PortalGroup:()=>Promise.resolve().then(function(){return PMe}),PortalItem:()=>Promise.resolve().then(function(){return vye}),PortalUser:()=>Promise.resolve().then(function(){return IMe})};let Ge=Tc=class extends vO(Sf){constructor(e){super(e),this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=Ii.portalUrl,this.urlKey=null,this.user=null,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(e){return typeof e=="string"?{url:e}:e}destroy(){this._esriId_credentialCreateHandle&&(this._esriId_credentialCreateHandle.remove(),this._esriId_credentialCreateHandle=null)}readAuthorizedCrossOriginDomains(e){if(e)for(const t of e)Ii.request.trustedServers.includes(t)||Ii.request.trustedServers.push(t);return e}readDefaultBasemap(e){return this._readBasemap(e)}readDefaultDevBasemap(e){return this._readBasemap(e)}readDefaultVectorBasemap(e){return this._readBasemap(e)}get extraQuery(){const e=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!e?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get restUrl(){let e=this.url;if(e){const t=e.indexOf("/sharing");e=t>0?e.substring(0,t):this.url.replace(/\/+$/,""),e+="/sharing/rest"}return e}get thumbnailUrl(){const e=this.restUrl,t=this.thumbnail;return e&&t?this._normalizeSSL(e+"/portals/self/resources/"+t):null}readUrlKey(e){return e&&e.toLowerCase()}readUser(e){let t=null;return e&&(t=Tq.fromJSON(e),t.portal=this),t}load(e){const t=Promise.resolve().then(function(){return BBe}).then(({default:i})=>{li(e),dk=i}).then(()=>this.sourceJSON?this.sourceJSON:this._fetchSelf(this.authMode,!1,e)).then(i=>{if(Ps){const r=Ps;this.credential=r.findCredential(this.restUrl),this.credential||this.authMode!==Tc.AUTH_MODE_AUTO||(this._esriId_credentialCreateHandle=r.on("credential-create",()=>{r.findCredential(this.restUrl)&&this._signIn()}))}this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}async createElevationLayers(){await this.load();const e=this._getHelperService("defaultElevationLayers"),t=(await import("./ElevationLayer.dc989605.js")).default;return e?e.map(i=>new t({id:i.id,url:i.url})):[]}fetchBasemaps(e,t){const i=new Wm;return i.query=e||(Ii.apiKey&&Che(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),i.disableExtraQuery=!0,this.queryGroups(i,t).then(r=>{if(i.num=100,i.query='type:"Web Map" -type:"Web Application"',r.total){const s=r.results[0];return i.sortField=s.sortField||"name",i.sortOrder=s.sortOrder||"desc",s.queryItems(i,t)}return null}).then(r=>{let s;return s=r&&r.total?r.results.filter(n=>n.type==="Web Map").map(n=>new dk({portalItem:n})):[],s})}fetchCategorySchema(e){return this.hasCategorySchema?this._request(this.restUrl+"/portals/self/categorySchema",e).then(t=>t.categorySchema):Xs(e)?Promise.reject(ui()):Promise.resolve([])}fetchFeaturedGroups(e){const t=this.featuredGroups,i=new Wm;if(i.num=100,i.sortField="title",t&&t.length){const r=[];for(const s of t)r.push(`(title:"${s.title}" AND owner:${s.owner})`);return i.query=r.join(" OR "),this.queryGroups(i,e).then(s=>s.results)}return Xs(e)?Promise.reject(ui()):Promise.resolve([])}fetchRegions(e){var i;const t=((i=this.user)==null?void 0:i.culture)||this.culture||tu();return this._request(this.restUrl+"/portals/regions",ve(F({},e),{query:{culture:t}}))}fetchSettings(e){var i;const t=((i=this.user)==null?void 0:i.culture)||this.culture||tu();return this._request(this.restUrl+"/portals/self/settings",ve(F({},e),{query:{culture:t}}))}static getDefault(){return Tc._default&&!Tc._default.destroyed||(Tc._default=new Tc),Tc._default}queryGroups(e,t){return this._queryPortal("/community/groups",e,"PortalGroup",t)}queryItems(e,t){return this._queryPortal("/search",e,"PortalItem",t)}queryUsers(e,t){return e.sortField||(e.sortField="username"),this._queryPortal("/community/users",e,"PortalUser",t)}toJSON(){throw new q("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Tc({sourceJSON:e})}_getHelperService(e){const t=this.helperServices&&this.helperServices[e];if(!t)throw new q("portal:service-not-found",`The \`helperServices\` do not include an entry named "${e}"`);return t}_getHelperServiceUrl(e){const t=this._getHelperService(e);if(!t.url)throw new q("portal:service-url-not-found",`The \`helperServices\` entry "${e}" does not include a \`url\` value`);return t.url}_fetchSelf(e=this.authMode,t=!1,i){const r=this.restUrl+"/portals/self",s=F({authMode:e,query:{culture:tu().toLowerCase()}},i);return s.authMode==="auto"&&(s.authMode="no-prompt"),t&&(s.query.default=!0),this._request(r,s)}_queryPortal(e,t,i,r){const s=Qr(Wm,t),n=o=>this._request(this.restUrl+e,F(F({},s.toRequestOptions(this)),r)).then(a=>{const l=s.clone();return l.start=a.nextStart,new MMe({nextQueryParams:l,queryParams:s,total:a.total,results:Tc._resultsToTypedArray(o,{portal:this},a,r)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(Pg(l),a)));return i&&XQ[i]?XQ[i]().then(({default:o})=>(li(r),n(o))):n()}_signIn(){if(this.authMode===Tc.AUTH_MODE_ANONYMOUS)return Promise.reject(new q("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const e=t=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(t||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=t,this._fetchSelf("immediate"))):this.user&&this.credential===t?null:(this.credential=t,this._fetchSelf("immediate"))).then(i=>{i&&(this.sourceJSON=i,this.read(i))});return Ps?Ps.getCredential(this.restUrl).then(t=>e(t)):e(this.credential)}_normalizeSSL(e){return e.replace(/^http:/i,"https:").replace(":7080",":7443")}_normalizeUrl(e){const t=this.credential&&this.credential.token;return this._normalizeSSL(t?e+(e.includes("?")?"&":"?")+"token="+t:e)}_requestToTypedArray(e,t,i){return this._request(e,t).then(r=>{const s=Tc._resultsToTypedArray(i,{portal:this},r);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():r)).then(()=>s,()=>s)})}_readBasemap(e){if(e){const t=dk.fromJSON(e);return t.portalItem={portal:this},t}return null}_request(e,t={}){const i=F({f:"json"},t.query),{authMode:r=this.authMode===Tc.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=t,c={authMode:r,body:s,cacheBust:n,method:o,query:i,responseType:a,timeout:0,signal:l};return ur(this._normalizeSSL(e),c).then(h=>h.data)}static _resultsToTypedArray(e,t,i,r){let s;if(i){const n=_(r)?r.signal:null;s=i.listings||i.notifications||i.userInvitations||i.tags||i.items||i.groups||i.comments||i.provisions||i.results||i.relatedItems||i,(e||t)&&(s=s.map(o=>{const a=Object.assign(e?e.fromJSON(o):o,t);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};Ge.AUTH_MODE_ANONYMOUS="anonymous",Ge.AUTH_MODE_AUTO="auto",Ge.AUTH_MODE_IMMEDIATE="immediate",u([d()],Ge.prototype,"access",void 0),u([d()],Ge.prototype,"allSSL",void 0),u([d()],Ge.prototype,"authMode",void 0),u([d()],Ge.prototype,"authorizedCrossOriginDomains",void 0),u([ke("authorizedCrossOriginDomains")],Ge.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],Ge.prototype,"basemapGalleryGroupQuery",void 0),u([d()],Ge.prototype,"bingKey",void 0),u([d()],Ge.prototype,"canListApps",void 0),u([d()],Ge.prototype,"canListData",void 0),u([d()],Ge.prototype,"canListPreProvisionedItems",void 0),u([d()],Ge.prototype,"canProvisionDirectPurchase",void 0),u([d()],Ge.prototype,"canSearchPublic",void 0),u([d()],Ge.prototype,"canShareBingPublic",void 0),u([d()],Ge.prototype,"canSharePublic",void 0),u([d()],Ge.prototype,"canSignInArcGIS",void 0),u([d()],Ge.prototype,"canSignInIDP",void 0),u([d()],Ge.prototype,"colorSetsGroupQuery",void 0),u([d()],Ge.prototype,"commentsEnabled",void 0),u([d({type:Date})],Ge.prototype,"created",void 0),u([d()],Ge.prototype,"credential",void 0),u([d()],Ge.prototype,"culture",void 0),u([d()],Ge.prototype,"currentVersion",void 0),u([d()],Ge.prototype,"customBaseUrl",void 0),u([d()],Ge.prototype,"defaultBasemap",void 0),u([ke("defaultBasemap")],Ge.prototype,"readDefaultBasemap",null),u([d()],Ge.prototype,"defaultDevBasemap",void 0),u([ke("defaultDevBasemap")],Ge.prototype,"readDefaultDevBasemap",null),u([d({type:ci})],Ge.prototype,"defaultExtent",void 0),u([d()],Ge.prototype,"defaultVectorBasemap",void 0),u([ke("defaultVectorBasemap")],Ge.prototype,"readDefaultVectorBasemap",null),u([d()],Ge.prototype,"description",void 0),u([d()],Ge.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],Ge.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],Ge.prototype,"extraQuery",null),u([d()],Ge.prototype,"featuredGroups",void 0),u([d()],Ge.prototype,"featuredItemsGroupQuery",void 0),u([d()],Ge.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],Ge.prototype,"livingAtlasGroupQuery",void 0),u([d()],Ge.prototype,"hasCategorySchema",void 0),u([d()],Ge.prototype,"helpBase",void 0),u([d()],Ge.prototype,"helperServices",void 0),u([d()],Ge.prototype,"helpMap",void 0),u([d()],Ge.prototype,"homePageFeaturedContent",void 0),u([d()],Ge.prototype,"homePageFeaturedContentCount",void 0),u([d()],Ge.prototype,"httpPort",void 0),u([d()],Ge.prototype,"httpsPort",void 0),u([d()],Ge.prototype,"id",void 0),u([d()],Ge.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],Ge.prototype,"isOrganization",null),u([d()],Ge.prototype,"isPortal",void 0),u([d()],Ge.prototype,"isReadOnly",void 0),u([d()],Ge.prototype,"layerTemplatesGroupQuery",void 0),u([d()],Ge.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],Ge.prototype,"modified",void 0),u([d()],Ge.prototype,"name",void 0),u([d()],Ge.prototype,"portalHostname",void 0),u([d()],Ge.prototype,"portalMode",void 0),u([d()],Ge.prototype,"portalProperties",void 0),u([d()],Ge.prototype,"region",void 0),u([d({readOnly:!0})],Ge.prototype,"restUrl",null),u([d()],Ge.prototype,"rotatorPanels",void 0),u([d()],Ge.prototype,"showHomePageDescription",void 0),u([d()],Ge.prototype,"sourceJSON",void 0),u([d()],Ge.prototype,"staticImagesUrl",void 0),u([d({json:{name:"2DStylesGroupQuery"}})],Ge.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],Ge.prototype,"stylesGroupQuery3d",void 0),u([d()],Ge.prototype,"supportsHostedServices",void 0),u([d()],Ge.prototype,"symbolSetsGroupQuery",void 0),u([d()],Ge.prototype,"templatesGroupQuery",void 0),u([d()],Ge.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Ge.prototype,"thumbnailUrl",null),u([d()],Ge.prototype,"units",void 0),u([d()],Ge.prototype,"url",void 0),u([d()],Ge.prototype,"urlKey",void 0),u([ke("urlKey")],Ge.prototype,"readUrlKey",null),u([d()],Ge.prototype,"user",void 0),u([ke("user")],Ge.prototype,"readUser",null),u([d()],Ge.prototype,"useStandardizedQuery",void 0),u([d()],Ge.prototype,"useVectorBasemaps",void 0),u([d()],Ge.prototype,"vectorBasemapGalleryGroupQuery",void 0),Ge=Tc=u([P("esri.portal.Portal")],Ge);const Kn=Ge;let B_=class extends oc(fe){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return _(e)&&e.placement===this.placement&&e.style===this.style&&(R(this.color)&&R(e.color)||_(this.color)&&_(e.color)&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],B_.prototype,"type",void 0),u([d({type:YAe,json:{default:"begin-end",write:!0}})],B_.prototype,"placement",void 0),u([d({type:Yue,json:{default:"arrow",write:!0}})],B_.prototype,"style",void 0),u([d({type:qe,json:{type:[yr],default:null,write:!0}})],B_.prototype,"color",void 0),B_=u([P("esri.symbols.LineStyleMarker3D")],B_);const _B=B_;var W$;let Cp=W$=class extends Df{constructor(e){super(e),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=uu(1),this.pattern=null,this.marker=null}clone(){const e={enabled:this.enabled,material:_(this.material)?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:_(this.pattern)?this.pattern.clone():null,marker:_(this.marker)?this.marker.clone():null};return new W$(e)}static fromSimpleLineSymbol(e){var i,r,s;const t={enabled:!0,size:(i=e.width)!=null?i:uu(1),cap:e.cap||"butt",join:e.join||"miter",pattern:e.style&&e.style!=="inside-frame"?new rq({style:e.style}):null,material:new iu({color:(e.color||ZA).clone()}),marker:e.marker?new _B({placement:e.marker.placement,style:e.marker.style,color:(s=(r=e.marker.color)==null?void 0:r.clone())!=null?s:null}):null};return new W$(t)}};u([d({type:iu,json:{write:!0}})],Cp.prototype,"material",void 0),u([ct({Line:"line"},{readOnly:!0})],Cp.prototype,"type",void 0),u([d({type:che,json:{write:!0,default:"miter"}})],Cp.prototype,"join",void 0),u([d({type:cq,json:{write:!0,default:"butt"}})],Cp.prototype,"cap",void 0),u([d(wf)],Cp.prototype,"size",void 0),u([d(ehe)],Cp.prototype,"pattern",void 0),u([d({types:{key:"type",base:_B,typeMap:{style:_B}},json:{write:!0}})],Cp.prototype,"marker",void 0),Cp=W$=u([P("esri.symbols.LineSymbol3DLayer")],Cp);const EO=Cp;var bB;const $Me=Zo()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let qC=bB=class extends fe{clone(){return new bB({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:_q,write:fv}})],qC.prototype,"href",void 0),u([ct($Me)],qC.prototype,"primitive",void 0),qC=bB=u([P("esri.symbols.support.ObjectSymbol3DLayerResource")],qC);const Phe="sphere";var wB;let M1=wB=class extends Ee{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new wB({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],M1.prototype,"x",void 0),u([d({type:Number})],M1.prototype,"y",void 0),u([d({type:Number})],M1.prototype,"z",void 0),M1=wB=u([P("esri.symbols.support.Symbol3DAnchorPosition3D")],M1);var xB;let ra=xB=class extends Df{constructor(e){super(e),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new xB({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:iu,json:{write:!0}})],ra.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],ra.prototype,"castShadows",void 0),u([d({type:qC,json:{write:!0}})],ra.prototype,"resource",void 0),u([ct({Object:"object"},{readOnly:!0})],ra.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"depth",void 0),u([ct({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],ra.prototype,"anchor",void 0),u([d({type:M1,json:{type:[Number],read:{reader:e=>new M1({x:e[0],y:e[1],z:e[2]})},write:{writer:(e,t)=>{t.anchorPosition=[e.x,e.y,e.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],ra.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],ra.prototype,"roll",void 0),u([d({readOnly:!0})],ra.prototype,"isPrimitive",null),ra=xB=u([P("esri.symbols.ObjectSymbol3DLayer")],ra);const Sq=ra;var TB;let za=TB=class extends Df{constructor(e){super(e),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(e,t){return e!=null?e:t.height==null&&t.size!=null?t.size:void 0}readHeight(e,t){return e!=null?e:t.width==null&&t.size!=null?t.size:void 0}clone(){return new TB({enabled:this.enabled,material:_(this.material)?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:iu,json:{write:!0}})],za.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],za.prototype,"castShadows",void 0),u([ct({Path:"path"},{readOnly:!0})],za.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],za.prototype,"profile",void 0),u([d({type:che,json:{write:!0,default:"miter"}})],za.prototype,"join",void 0),u([d({type:yRe,json:{write:!0,default:"butt"}})],za.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],za.prototype,"width",void 0),u([ke("width",["width","size","height"])],za.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],za.prototype,"height",void 0),u([ke("height",["height","size","width"])],za.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],za.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],za.prototype,"profileRotation",void 0),za=TB=u([P("esri.symbols.PathSymbol3DLayer")],za);const Eq=za;var SB;let CT=SB=class extends fe{constructor(){super(...arguments),this.color=new qe([0,0,0,1]),this.size=0}clone(){const e={color:te(this.color),size:this.size};return new SB(e)}};u([d(Ig)],CT.prototype,"color",void 0),u([d(wf)],CT.prototype,"size",void 0),CT=SB=u([P("esri.symbols.support.Symbol3DHalo")],CT);let JA=class extends oc(fe){constructor(e){super(e),this.color=null}};u([d(Ig)],JA.prototype,"color",void 0),JA=u([P("esri.symbols.support.Symbol3DTextBackground")],JA);var X$;let Tl=X$=class extends Df{constructor(e){super(e),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(e){_(e)&&_(this._userSize)&&(e.size=this._userSize),this._set("font",e)}writeFont(e,t,i,r){const s=ve(F({},r),{textSymbol3D:!0});t.font=e.write({},s),delete t.font.size}get size(){return _(this._userSize)?this._userSize:_(this.font)&&this.font.size!=null?this.font.size:9}set size(e){this._userSize=e,_(this.font)&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const e=new X$({enabled:this.enabled,font:this.font&&te(this.font),halo:this.halo&&te(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:_(this.material)?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:te(this.background)});return e._userSize=this._userSize,e}static fromTextSymbol(e){return new X$({font:_(e.font)?e.font.clone():new m4,halo:DMe(e.haloColor,e.haloSize),horizontalAlignment:e.horizontalAlignment,lineHeight:e.lineHeight,material:e.color?new iu({color:e.color.clone()}):null,text:e.text,verticalAlignment:e.verticalAlignment,background:e.backgroundColor?new JA({color:e.backgroundColor.clone()}):null})}};function DMe(e,t){return e&&t>0?new CT({color:te(e),size:t}):null}u([d({type:m4,json:{write:!0}})],Tl.prototype,"font",null),u([Be("font")],Tl.prototype,"writeFont",null),u([d({type:CT,json:{write:!0}})],Tl.prototype,"halo",void 0),u([d(ve(F({},hhe),{json:{default:"center",write:!0}}))],Tl.prototype,"horizontalAlignment",void 0),u([d(ve(F({},uhe),{json:{default:1,write:!0}}))],Tl.prototype,"lineHeight",void 0),u([d({type:iu,json:{write:!0}})],Tl.prototype,"material",void 0),u([d({type:JA,json:{write:!0}})],Tl.prototype,"background",void 0),u([d(wf)],Tl.prototype,"size",null),u([d({type:String,json:{write:!0}})],Tl.prototype,"text",void 0),u([ct({Text:"text"},{readOnly:!0})],Tl.prototype,"type",void 0),u([d(ve(F({},dhe),{json:{default:"baseline",write:!0}}))],Tl.prototype,"verticalAlignment",void 0),Tl=X$=u([P("esri.symbols.TextSymbol3DLayer")],Tl);const pw=Tl;var EB;let Ly=EB=class extends Df{constructor(e){super(e),this.color=CB.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new EB({color:te(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:qe,nonNullable:!0,json:{type:[yr],write:(e,t,i)=>t[i]=e.toArray(qe.AlphaMode.UNLESS_OPAQUE),default:()=>CB.clone(),defaultEquals:e=>e.toCss(!0)===CB.toCss(!0)}})],Ly.prototype,"color",void 0),u([ct({Water:"water"},{readOnly:!0})],Ly.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],Ly.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],Ly.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],Ly.prototype,"waveStrength",void 0),Ly=EB=u([P("esri.symbols.WaterSymbol3DLayer")],Ly);const CB=new qe([0,119,190]),Ihe=Ly;var AB;let G_=AB=class extends Ee{constructor(){super(...arguments),this.portal=null}clone(){return new AB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],G_.prototype,"name",void 0),u([d({type:String})],G_.prototype,"styleUrl",void 0),u([d({type:String})],G_.prototype,"styleName",void 0),u([d({type:Kn})],G_.prototype,"portal",void 0),G_=AB=u([P("esri.symbols.support.StyleOrigin")],G_);const RB=G_;var MB;let KA=MB=class extends Ee{clone(){return new MB({url:this.url})}};u([d({type:String})],KA.prototype,"url",void 0),KA=MB=u([P("esri.symbols.support.Thumbnail")],KA);const $he={icon:D0,object:Sq,line:EO,path:Eq,fill:f4,extrude:Xue,text:pw,water:Ihe},LMe=at.ofType({base:Df,key:"type",typeMap:$he,errorContext:"symbol-layer"}),NMe=me.getLogger("esri.symbols.Symbol3D");let Ap=class extends lc{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const t=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=t&&t.type||at;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.initialized&&NMe.error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){_g(e,this._get("symbolLayers"))}readStyleOrigin(e,t,i){if(e.styleUrl&&e.name){const r=G2(e.styleUrl,i);return new RB({styleUrl:r,name:e.name})}if(e.styleName&&e.name)return new RB({portal:i&&i.portal||Kn.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new lu("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,t,i,r){if(e.styleUrl&&e.name){let s=Ib(e.styleUrl,r);ru(s)&&(s=bh(s)),t.styleOrigin={styleUrl:s,name:e.name}}else e.styleName&&e.name&&(e.portal&&r&&r.portal&&!yhe(e.portal.restUrl,r.portal.restUrl)?r&&r.messages&&r.messages.push(new lu("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):t.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof Df||e&&$he[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],Ap.prototype,"color",null),u([d({type:LMe,nonNullable:!0,json:{write:!0}}),Ot(bq)],Ap.prototype,"symbolLayers",null),u([d({type:RB})],Ap.prototype,"styleOrigin",void 0),u([ke("styleOrigin")],Ap.prototype,"readStyleOrigin",null),u([Be("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],Ap.prototype,"writeStyleOrigin",null),u([d({type:KA,json:{read:!1}})],Ap.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],Ap.prototype,"type",void 0),Ap=u([P("esri.symbols.Symbol3D")],Ap);const j2=Ap;let WC=class extends fe{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],WC.prototype,"type",void 0),u([d({readOnly:!0})],WC.prototype,"visible",void 0),WC=u([P("esri.symbols.callouts.Callout3D")],WC);const Dhe=WC;var OB;let Y$=OB=class extends fe{constructor(){super(...arguments),this.color=new qe("white")}clone(){return new OB({color:te(this.color)})}};u([d(Ig)],Y$.prototype,"color",void 0),Y$=OB=u([P("esri.symbols.callouts.LineCallout3DBorder")],Y$);const Lhe=Y$;Object.freeze(Object.defineProperty({__proto__:null,default:Lhe},Symbol.toStringTag,{value:"Module"}));var PB;let Ny=PB=class extends Dhe{constructor(e){super(e),this.type="line",this.color=new qe([0,0,0,1]),this.size=uu(1),this.border=null}get visible(){return this.size>0&&_(this.color)&&this.color.a>0}clone(){return new PB({color:te(this.color),size:this.size,border:te(this.border)})}};u([ct({line:"line"},{readOnly:!0})],Ny.prototype,"type",void 0),u([d(Ig)],Ny.prototype,"color",void 0),u([d(wf)],Ny.prototype,"size",void 0),u([d({type:Lhe,json:{write:!0}})],Ny.prototype,"border",void 0),u([d({readOnly:!0})],Ny.prototype,"visible",null),Ny=PB=u([P("esri.symbols.callouts.LineCallout3D")],Ny);const FMe=Ny;function Cq(e){if(!e)return!1;const t=e.verticalOffset;return!!t&&!(t.screenLength<=0||t.maxWorldLength<=0)}function Nhe(e){if(!e||!e.supportsCallout||!e.supportsCallout())return!1;const t=e.callout;return!!t&&!!t.visible&&!!Cq(e)}function Aq(e){return e.type==="point-3d"||e.type==="label-3d"}function Fhe(e){return e.horizontalAlignment==="center"}const Uhe={types:{key:"type",base:Dhe,typeMap:{line:FMe}},json:{write:!0}};var IB;let O1=IB=class extends fe{constructor(){super(...arguments),this.screenLength=0,this.minWorldLength=0}clone(){return new IB({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(wf)],O1.prototype,"screenLength",void 0),u([d({type:Number,json:{write:!0,default:0}})],O1.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],O1.prototype,"maxWorldLength",void 0),O1=IB=u([P("esri.symbols.support.Symbol3DVerticalOffset")],O1);var Z$;const khe=at.ofType({base:null,key:"type",typeMap:{text:pw}});let Fy=Z$=class extends j2{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new khe,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return Nhe(this)}hasVisibleVerticalOffset(){return Cq(this)}clone(){return new Z$({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail),callout:te(this.callout),verticalOffset:te(this.verticalOffset)})}static fromTextSymbol(e){return new Z$({symbolLayers:[pw.fromTextSymbol(e)]})}};u([d({type:O1,json:{write:!0}})],Fy.prototype,"verticalOffset",void 0),u([d(Uhe)],Fy.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],Fy.prototype,"styleOrigin",void 0),u([d({type:khe})],Fy.prototype,"symbolLayers",void 0),u([ct({LabelSymbol3D:"label-3d"},{readOnly:!0})],Fy.prototype,"type",void 0),Fy=Z$=u([P("esri.symbols.LabelSymbol3D")],Fy);const v4=Fy;var Q$;const zhe=at.ofType({base:null,key:"type",typeMap:{line:EO,path:Eq}}),UMe=at.ofType({base:null,key:"type",typeMap:{line:EO,path:Eq}});let XC=Q$=class extends j2{constructor(e){super(e),this.symbolLayers=new zhe,this.type="line-3d"}clone(){return new Q$({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromSimpleLineSymbol(e){return new Q$({symbolLayers:[EO.fromSimpleLineSymbol(e)]})}};u([d({type:zhe,json:{type:UMe}})],XC.prototype,"symbolLayers",void 0),u([ct({LineSymbol3D:"line-3d"},{readOnly:!0})],XC.prototype,"type",void 0),XC=Q$=u([P("esri.symbols.LineSymbol3D")],XC);const _4=XC;let Uy=class extends lc{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],Uy.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],Uy.prototype,"type",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Uy.prototype,"xoffset",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Uy.prototype,"yoffset",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Zi(e),json:{write:!0}})],Uy.prototype,"size",void 0),Uy=u([P("esri.symbols.MarkerSymbol")],Uy);const Vhe=Uy;var $B;const Bhe=at.ofType({base:null,key:"type",typeMap:{fill:f4}});let YC=$B=class extends j2{constructor(e){super(e),this.symbolLayers=new Bhe,this.type="mesh-3d"}clone(){return new $B({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}};u([d({type:Bhe})],YC.prototype,"symbolLayers",void 0),u([ct({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],YC.prototype,"type",void 0),YC=$B=u([P("esri.symbols.MeshSymbol3D")],YC);const Rq=YC;function kMe(e,t,i){return t.imageData?bhe({mediaType:t.contentType||"image/png",isBase64:!0,data:t.imageData}):Ghe(t.url,i)}function Ghe(e,t){return VMe(t)&&!ru(e)&&t.layer.parsedUrl?du(t.layer.parsedUrl.path,"images",e):G2(e,t)}function zMe(e,t,i,r){if(Lf(e)){const s=y4(e);t.contentType=s.mediaType,t.imageData=s.data,i&&i.imageData===t.imageData&&i.url&&fv(i.url,t,"url",r)}else fv(e,t,"url",r)}const jhe={json:{read:{source:["imageData","url"],reader:kMe},write:{writer(e,t,i,r){zMe(e,t,this.source,r)}}}},Hhe={readOnly:!0,json:{read:{source:["imageData","url"],reader(e,t,i){const r={};return t.imageData&&(r.imageData=t.imageData),t.contentType&&(r.contentType=t.contentType),t.url&&(r.url=Ghe(t.url,i)),r}}}};function VMe(e){return e&&(e.origin==="service"||e.origin==="portal-item")&&e.layer&&(e.layer.type==="feature"||e.layer.type==="stream")}var DB;let ku=DB=class extends Zue{constructor(...e){super(...e),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string"&&e.imageData==null)return e;const s={};return e&&(s.url=e),t&&(s.outline=t),i!=null&&(s.width=Zi(i)),r!=null&&(s.height=Zi(r)),s}clone(){const e=new DB({color:te(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return e._set("source",te(this.source)),e}hash(){var e;return`${super.hash()}.${(e=this.color)==null?void 0:e.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([ct({esriPFS:"picture-fill"},{readOnly:!0})],ku.prototype,"type",void 0),u([d(jhe)],ku.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],ku.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],ku.prototype,"yscale",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ku.prototype,"width",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ku.prototype,"height",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ku.prototype,"xoffset",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ku.prototype,"yoffset",void 0),u([d(Hhe)],ku.prototype,"source",void 0),ku=DB=u([P("esri.symbols.PictureFillSymbol")],ku);const qhe=ku;var LB;let Qh=LB=class extends Vhe{constructor(...e){super(...e),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string"&&e.imageData==null)return e;const r={};return e&&(r.url=e),t!=null&&(r.width=Zi(t)),i!=null&&(r.height=Zi(i)),r}readHeight(e,t){return t.size||e}readWidth(e,t){return t.size||e}clone(){const e=new LB({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return e._set("source",te(this.source)),e}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],Qh.prototype,"color",void 0),u([ct({esriPMS:"picture-marker"},{readOnly:!0})],Qh.prototype,"type",void 0),u([d(jhe)],Qh.prototype,"url",void 0),u([d(Hhe)],Qh.prototype,"source",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Qh.prototype,"height",void 0),u([ke("height",["height","size"])],Qh.prototype,"readHeight",null),u([d({type:Number,cast:Zi,json:{write:!0}})],Qh.prototype,"width",void 0),u([d({json:{write:!1}})],Qh.prototype,"size",void 0),Qh=LB=u([P("esri.symbols.PictureMarkerSymbol")],Qh);const b4=Qh;var ky;const Whe=at.ofType({base:null,key:"type",typeMap:{icon:D0,object:Sq,text:pw}});let j_=ky=class extends j2{constructor(e){super(e),this.verticalOffset=null,this.callout=null,this.symbolLayers=new Whe,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const e of this.symbolLayers.items)switch(e.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return Nhe(this)}hasVisibleVerticalOffset(){return Cq(this)}clone(){return new ky({verticalOffset:te(this.verticalOffset),callout:te(this.callout),styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromSimpleMarkerSymbol(e){return new ky({symbolLayers:[D0.fromSimpleMarkerSymbol(e)]})}static fromPictureMarkerSymbol(e){return new ky({symbolLayers:[D0.fromPictureMarkerSymbol(e)]})}static fromCIMSymbol(e){var i,r;return((r=(i=e.data)==null?void 0:i.symbol)==null?void 0:r.type)!=="CIMPointSymbol"?null:e.data.symbol.callout?new ky({symbolLayers:[D0.fromCIMSymbol(e)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}):new ky({symbolLayers:[D0.fromCIMSymbol(e)]})}static fromTextSymbol(e){return new ky({symbolLayers:[pw.fromTextSymbol(e)]})}};u([d({type:O1,json:{write:!0}})],j_.prototype,"verticalOffset",void 0),u([d(Uhe)],j_.prototype,"callout",void 0),u([d({type:Whe,json:{origins:{"web-scene":{write:!0}}}})],j_.prototype,"symbolLayers",void 0),u([ct({PointSymbol3D:"point-3d"},{readOnly:!0})],j_.prototype,"type",void 0),j_=ky=u([P("esri.symbols.PointSymbol3D")],j_);const L0=j_;var ZC;const Xhe=at.ofType({base:null,key:"type",typeMap:{extrude:Xue,fill:f4,icon:D0,line:EO,object:Sq,text:pw,water:Ihe}});let QC=ZC=class extends j2{constructor(e){super(e),this.symbolLayers=new Xhe,this.type="polygon-3d"}clone(){return new ZC({styleOrigin:te(this.styleOrigin),symbolLayers:te(this.symbolLayers),thumbnail:te(this.thumbnail)})}static fromJSON(e){const t=new ZC;if(t.read(e),t.symbolLayers.length===2&&t.symbolLayers.getItemAt(0).type==="fill"&&t.symbolLayers.getItemAt(1).type==="line"){const i=t.symbolLayers.getItemAt(0),r=t.symbolLayers.getItemAt(1);!r.enabled||e.symbolLayers&&e.symbolLayers[1]&&e.symbolLayers[1].enable===!1||(i.outline={size:r.size,color:_(r.material)?r.material.color:null}),t.symbolLayers.removeAt(1)}return t}static fromSimpleFillSymbol(e){return new ZC({symbolLayers:[f4.fromSimpleFillSymbol(e)]})}};u([d({type:Xhe,json:{write:!0}})],QC.prototype,"symbolLayers",void 0),u([ct({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],QC.prototype,"type",void 0),QC=ZC=u([P("esri.symbols.PolygonSymbol3D")],QC);const CO=QC;var NB;const pk=new _i({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let H_=NB=class extends Zue{constructor(...e){super(...e),this.color=new qe([0,0,0,.25]),this.outline=new Ih,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.style=e),t&&(r.outline=t),i&&(r.color=i),r}clone(){return new NB({color:te(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],H_.prototype,"color",void 0),u([d()],H_.prototype,"outline",void 0),u([ct({esriSFS:"simple-fill"},{readOnly:!0})],H_.prototype,"type",void 0),u([d({type:pk.apiValues,json:{read:pk.read,write:pk.write}})],H_.prototype,"style",void 0),H_=NB=u([P("esri.symbols.SimpleFillSymbol")],H_);const Dv=H_;var FB;const fk=new _i({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let Rp=FB=class extends Vhe{constructor(...e){super(...e),this.color=new qe([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new Ih}normalizeCtorArgs(e,t,i,r){if(e&&typeof e!="string")return e;const s={};return e&&(s.style=e),t!=null&&(s.size=Zi(t)),i&&(s.outline=i),r&&(s.color=r),s}writeColor(e,t){e&&this.style!=="x"&&this.style!=="cross"&&(t.color=e.toJSON()),e===null&&(t.color=null)}set path(e){this.style="path",this._set("path",e)}clone(){return new FB({angle:this.angle,color:te(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){var e;return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${(e=this.outline)==null?void 0:e.hash()}`}};u([d()],Rp.prototype,"color",void 0),u([Be("color")],Rp.prototype,"writeColor",null),u([ct({esriSMS:"simple-marker"},{readOnly:!0})],Rp.prototype,"type",void 0),u([d()],Rp.prototype,"size",void 0),u([d({type:fk.apiValues,json:{read:fk.read,write:fk.write}})],Rp.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],Rp.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Ih}},json:{default:null,write:!0}})],Rp.prototype,"outline",void 0),Rp=FB=u([P("esri.symbols.SimpleMarkerSymbol")],Rp);const Lv=Rp;var UB;let ts=UB=class extends lc{constructor(...e){super(...e),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new m4,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(e,t,i){if(e&&typeof e!="string")return e;const r={};return e&&(r.text=e),t&&(r.font=t),i&&(r.color=i),r}writeLineWidth(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}castLineWidth(e){return Zi(e)}writeLineHeight(e,t,i,r){r&&typeof r!="string"?r.origin:t[i]=e}clone(){return new UB({angle:this.angle,backgroundColor:te(this.backgroundColor),borderLineColor:te(this.borderLineColor),borderLineSize:this.borderLineSize,color:te(this.color),font:this.font&&this.font.clone(),haloColor:te(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${this.color.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:qe,json:{write:!0}})],ts.prototype,"backgroundColor",void 0),u([d({type:qe,json:{write:!0}})],ts.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0}})],ts.prototype,"borderLineSize",void 0),u([d({type:m4,json:{write:!0}})],ts.prototype,"font",void 0),u([d(ve(F({},hhe),{json:{write:!0}}))],ts.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],ts.prototype,"kerning",void 0),u([d({type:qe,json:{write:!0}})],ts.prototype,"haloColor",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ts.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],ts.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],ts.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],ts.prototype,"text",void 0),u([ct({esriTS:"text"},{readOnly:!0})],ts.prototype,"type",void 0),u([d(ve(F({},dhe),{json:{write:!0}}))],ts.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ts.prototype,"xoffset",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],ts.prototype,"yoffset",void 0),u([d({type:Number,json:{read:e=>e&&-1*e,write:(e,t)=>t.angle=e&&-1*e}})],ts.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],ts.prototype,"width",void 0),u([d({type:Number})],ts.prototype,"lineWidth",void 0),u([Be("lineWidth")],ts.prototype,"writeLineWidth",null),u([Ot("lineWidth")],ts.prototype,"castLineWidth",null),u([d(uhe)],ts.prototype,"lineHeight",void 0),u([Be("lineHeight")],ts.prototype,"writeLineHeight",null),ts=UB=u([P("esri.symbols.TextSymbol")],ts);const H2=ts;var kB;const BMe=me.getLogger("esri.symbols.WebStyleSymbol");let Jh=kB=class extends lc{constructor(e){super(e),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}get fetchCacheKey(){const e=_(this.portal)?this.portal:Kn.getDefault(),t=e.user?e.user.username:null;return`${this.styleName}:${this.styleUrl}:${this.name}:${t}:${e.url}`}read(e,t){this.portal=t?t.portal:void 0,super.read(e,t)}clone(){return new kB({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(e){return this._fetchSymbol("webRef",e)}fetchCIMSymbol(e){return this._fetchSymbol("cimRef",e)}async _fetchSymbol(e,t){const i=_(t)?t.cache:null,r=i?this.fetchCacheKey:null;if(_(i)){const a=i.get(r);if(a)return a.clone()}const s=await GMe();li(t);const n=s.resolveWebStyleSymbol(this,{portal:this.portal},e,t);n.catch(a=>{BMe.error("#fetchSymbol()","Failed to create symbol from style",a)});const o=await n;return e==="webRef"&&o.type==="point-3d"||e==="cimRef"&&o.type==="cim"?(_(i)&&i.set(r,o.clone()),o):null}};function GMe(){return import("./webStyleSymbolUtils.c8d73d99.js")}u([d({json:{write:!1}})],Jh.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Jh.prototype,"styleName",void 0),u([d({type:Kn,json:{write:!1}})],Jh.prototype,"portal",void 0),u([d({type:String,json:{read:_q,write:fv}})],Jh.prototype,"styleUrl",void 0),u([d({type:KA,json:{read:!1}})],Jh.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],Jh.prototype,"name",void 0),u([ct({styleSymbolReference:"web-style"},{readOnly:!0})],Jh.prototype,"type",void 0),u([d()],Jh.prototype,"fetchCacheKey",null),Jh=kB=u([P("esri.symbols.WebStyleSymbol")],Jh);const fw=Jh;function w4(e){if(!e)return!1;switch(e.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function US(e){if(!e)return!1;switch(e.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const hb={base:lc,key:"type",typeMap:{"simple-fill":Dv,"picture-fill":qhe,"picture-marker":b4,"simple-line":Ih,"simple-marker":Lv,text:H2,"label-3d":v4,"line-3d":_4,"mesh-3d":Rq,"point-3d":L0,"polygon-3d":CO,"web-style":fw,cim:V2},errorContext:"symbol"},jMe={base:lc,key:"type",typeMap:{"picture-marker":b4,"simple-marker":Lv,text:H2,"web-style":fw,cim:V2},errorContext:"symbol"},HMe=U2({types:hb}),Yhe={base:lc,key:"type",typeMap:{"simple-fill":Dv,"picture-fill":qhe,"picture-marker":b4,"simple-line":Ih,"simple-marker":Lv,text:H2,"line-3d":_4,"mesh-3d":Rq,"point-3d":L0,"polygon-3d":CO,"web-style":fw,cim:V2},errorContext:"symbol"},qMe={base:lc,key:"type",typeMap:{text:H2,"label-3d":v4},errorContext:"symbol"},YQ={base:lc,key:"type",typeMap:{"line-3d":_4,"mesh-3d":Rq,"point-3d":L0,"polygon-3d":CO,"web-style":fw,cim:V2},errorContext:"symbol"},WMe={base:lc,key:"type",typeMap:{"label-3d":v4},errorContext:"symbol"},Zhe=qd(hb);function XMe(e){if(!e)return null;const t={};for(const i in e){const r=yf(e[i]);r&&(t[i]=r)}return Object.keys(t).length!==0?t:null}function YMe(e){if(!_(e))return null;const t={};for(const i in e){const r=e[i];r&&(t[i]=r.toJSON())}return Object.keys(t).length!==0?t:null}let Sl=class extends oc(fe){constructor(...e){super(...e),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:sl(),configurable:!0})}normalizeCtorArgs(e,t,i,r){return e&&!e.declaredClass?e:{geometry:e,symbol:t,attributes:i,popupTemplate:r}}set aggregateGeometries(e){const t=this._get("aggregateGeometries");JSON.stringify(t)!==JSON.stringify(e)&&this._set("aggregateGeometries",e)}set attributes(e){const t=this._get("attributes");t!==e&&(this._set("attributes",e),this._notifyLayer("attributes",t,e))}set geometry(e){const t=this._get("geometry");t!==e&&(this._set("geometry",e),this._notifyLayer("geometry",t,e))}set symbol(e){const t=this._get("symbol");t!==e&&(this._set("symbol",e),this._notifyLayer("symbol",t,e))}set visible(e){const t=this._get("visible");t!==e&&(this._set("visible",e),this._notifyLayer("visible",t,e))}getEffectivePopupTemplate(e=!1){if(this.popupTemplate)return this.popupTemplate;for(const t of[this.sourceLayer,this.layer])if(t){if("popupTemplate"in t&&t.popupTemplate)return t.popupTemplate;if(e&&"defaultPopupTemplate"in t&&_(t.defaultPopupTemplate))return t.defaultPopupTemplate}return null}getAttribute(e){return this.attributes&&this.attributes[e]}setAttribute(e,t){if(this.attributes){const i=this.getAttribute(e);this.attributes[e]=t,this._notifyLayer("attributes",i,t,e)}else this.attributes={[e]:t},this._notifyLayer("attributes",void 0,t,e)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:YMe(this.aggregateGeometries),geometry:_(this.geometry)?this.geometry.toJSON():null,symbol:_(this.symbol)?this.symbol.toJSON():null,attributes:F({},this.attributes),popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(){_(this.geometry)&&this.geometry.type==="mesh"&&this._notifyLayer("transform",this.geometry.transform,this.geometry.transform)}_notifyLayer(e,t,i,r){if(!this.layer||!("graphicChanged"in this.layer))return;const s={graphic:this,property:e,oldValue:t,newValue:i};e==="attributes"&&(s.attributeName=r),this.layer.graphicChanged(s)}};u([d({value:null,json:{read:XMe}})],Sl.prototype,"aggregateGeometries",null),u([d({value:null})],Sl.prototype,"attributes",null),u([d({value:null,types:cw,json:{read:yf}})],Sl.prototype,"geometry",null),u([d({type:Boolean})],Sl.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],Sl.prototype,"layer",void 0),u([d({type:wO})],Sl.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],Sl.prototype,"sourceLayer",void 0),u([d({value:null,types:hb})],Sl.prototype,"symbol",null),u([d({type:Boolean,value:!0})],Sl.prototype,"visible",null),Sl=u([P("esri.Graphic")],Sl),function(e){e.generateUID=sl}(Sl||(Sl={}));const Ca=Sl;var zB;let zy=zB=class extends fe{constructor(e){super(e),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(e){return(e%=360)<0&&(e+=360),e}clone(){return new zB({rotation:this.rotation,scale:this.scale,targetGeometry:_(this.targetGeometry)?this.targetGeometry.clone():null,camera:_(this.camera)?this.camera.clone():null})}};function mk(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:mk}}}}})],zy.prototype,"rotation",void 0),u([Ot("rotation")],zy.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:mk}}}}})],zy.prototype,"scale",void 0),u([d({types:cw,json:{read:yf,write:!0,origins:{"web-scene":{read:yf,write:{overridePolicy:mk}}}}})],zy.prototype,"targetGeometry",void 0),u([d({type:rc,json:{write:!0}})],zy.prototype,"camera",void 0),zy=zB=u([P("esri.Viewpoint")],zy);const sc=zy;function x4(e){return typeof e=="string"?document.getElementById(e):e}function Qhe(e){for(;e.hasChildNodes();)e.removeChild(e.firstChild)}function ZQ(e,t){const i=t.parentNode;i&&i.insertBefore(e,t)}function QQ(e,t){for(;;){const i=e.firstChild;if(!i)break;t.appendChild(i)}}class VB{constructor(t=i=>i.values().next().value){this._peeker=t,this._items=new Set}get length(){return this._items.size}clear(){this._items.clear()}last(){if(this._items.size===0)return;let t;for(t of this._items);return t}peek(){if(this._items.size!==0)return this._peeker(this._items)}push(t){this.contains(t)||this._items.add(t)}contains(t){return this._items.has(t)}pop(){if(this.length===0)return;const t=this.peek();return this._items.delete(t),t}popLast(){if(this.length===0)return;const t=this.last();return this._items.delete(t),t}remove(t){this._items.delete(t)}filter(t){return this._items.forEach(i=>{t(i)||this._items.delete(i)}),this}}var nl;(function(e){e[e.HANDSHAKE=0]="HANDSHAKE",e[e.OPEN=1]="OPEN",e[e.OPENED=2]="OPENED",e[e.RESPONSE=3]="RESPONSE",e[e.INVOKE=4]="INVOKE",e[e.ABORT=5]="ABORT",e[e.CLOSE=6]="CLOSE",e[e.OPEN_PORT=7]="OPEN_PORT",e[e.ON=8]="ON"})(nl||(nl={}));let ZMe=0;function Jhe(){return ZMe++}function QMe(e){return e&&typeof e=="object"&&("result"in e||"transferList"in e)}function aN(e){return e?typeof e=="string"?JSON.stringify({name:"message",message:e}):e.toJSON?JSON.stringify(e):JSON.stringify({name:e.name,message:e.message,details:e.details||{stack:e.stack}}):null}function Khe(e,t,i,r){if(t.type===nl.OPEN_PORT)return void e.postMessage(t,[t.port]);if(t.type!==nl.INVOKE&&t.type!==nl.RESPONSE)return void e.postMessage(t);let s;QMe(i)?(s=JQ(i.transferList),t.data=i.result):(s=JQ(r),t.data=i),s?e.postMessage(t,s):e.postMessage(t)}function eM(e){if(!e)return null;const t=e.data;return t?typeof t=="string"?JSON.parse(t):t:null}function JQ(e){if(!e||!e.length)return null;if(he("esri-workers-arraybuffer-transfer"))return e;const t=e.filter(i=>!JMe(i));return t.length?t:null}function JMe(e){return e instanceof ArrayBuffer||e&&e.constructor&&e.constructor.name==="ArrayBuffer"}const KMe={statsWorker:()=>import("./statsWorker.d9f09f1d.js"),geometryEngineWorker:()=>import("./geometryEngineWorker.6b706bcf.js"),CSVSourceWorker:()=>import("./CSVSourceWorker.f884b1f5.js"),EdgeProcessingWorker:()=>Promise.resolve().then(function(){return bpt}),ElevationSamplerWorker:()=>import("./ElevationSamplerWorker.6cc624ee.js"),FeatureServiceSnappingSourceWorker:()=>import("./FeatureServiceSnappingSourceWorker.4e8ad436.js"),GeoJSONSourceWorker:()=>import("./GeoJSONSourceWorker.4851fba2.js"),LercWorker:()=>import("./LercWorker.40c5aaaf.js"),MemorySourceWorker:()=>import("./MemorySourceWorker.bf298817.js"),PBFDecoderWorker:()=>import("./PBFDecoderWorker.86c5f34f.js"),Pipeline:()=>import("./Pipeline.a23f8c3f.js").then(function(e){return e.P}),PointCloudWorker:()=>import("./PointCloudWorker.cd0c80dd.js"),RasterWorker:()=>import("./RasterWorker.f9b90b40.js"),SceneLayerSnappingSourceWorker:()=>import("./SceneLayerSnappingSourceWorker.616e1c11.js"),SceneLayerWorker:()=>import("./SceneLayerWorker.8c0cf440.js").then(function(e){return e.S}),WFSSourceWorker:()=>import("./WFSSourceWorker.dc11cadb.js"),WorkerTileHandler:()=>import("./WorkerTileHandler.7a8f0f24.js")},{CLOSE:KQ,ABORT:eJ,INVOKE:tJ,RESPONSE:bE,OPEN_PORT:iJ,ON:eOe}=nl,tOe=2;class iOe{constructor(t){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=t,this._timer=null,this._process=this._process.bind(this)}push(t){t.type===nl.ABORT?this._cancelledJobIds.add(t.jobId):(this._invokeMessages.push(t),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const t of this._invokeMessages)this._cancelledJobIds.has(t.jobId)||this._invoke(t);this._cancelledJobIds.clear(),this._invokeMessages.length=0}}class Gl{constructor(t,i,r){this._port=t,this._getNextJob=r,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new iOe(s=>this._onInvokeMessage(s)),this._client=i.client,this._onMessage=this._onMessage.bind(this),this._channel=i.channel,this._schedule=i.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}static connect(t){const i=new MessageChannel;let r;r=typeof t=="function"?new t:"default"in t&&typeof t.default=="function"?new t.default:t;const s=new Gl(i.port1,{channel:i,client:r},()=>null);return typeof r=="object"&&"remoteClient"in r&&(r.remoteClient=s),Gl.clients.set(s,r),i.port2}static loadWorker(t){const i=KMe[t];return i?i():Promise.resolve(null)}close(){this._post({type:KQ}),this._close()}isBusy(){return this._outJobs.size>0}invoke(t,i,r){const s=r&&r.signal,n=r&&r.transferList;if(!this._port)return Promise.reject(new q("worker:port-closed",`Cannot call invoke('${t}'), port is closed`,{methodName:t,data:i}));const o=Jhe();return new Promise((a,l)=>{if(Xs(s))return this._processWork(),void l(ui());const c=Wo(s,()=>{const p=this._outJobs.get(o);p&&(this._outJobs.delete(o),this._processWork(),Ds(p.abortHandle),this._post({type:eJ,jobId:o}),l(ui()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:t};this._outJobs.set(o,h),this._post({type:tJ,jobId:o,methodName:t,abortable:s!=null},i,n)})}on(t,i){const r=new MessageChannel;function s(n){i(n.data)}return this._port.postMessage({type:nl.ON,eventType:t,port:r.port2},[r.port2]),r.port1.addEventListener("message",s),r.port1.start(),{remove(){r.port1.postMessage({type:nl.CLOSE}),r.port1.close(),r.port1.removeEventListener("message",s)}}}jobAdded(){this._processWork()}openPort(){const t=new MessageChannel;return this._post({type:iJ,port:t.port2}),t.port1}_processWork(){if(this._outJobs.size>=tOe)return;const t=this._getNextJob();if(!t)return;const{methodName:i,data:r,invokeOptions:s,deferred:n}=t;this.invoke(i,r,s).then(o=>n.resolve(o)).catch(o=>n.reject(o))}_close(){this._channel&&(this._channel=null),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(t=>{Ds(t.abortHandle),t.reject(ui(`Worker closing, aborting job calling '${t.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=this._client=this._schedule=null}_onMessage(t){_(this._schedule)?this._schedule(()=>this._processMessage(t)):this._processMessage(t)}_processMessage(t){const i=eM(t);if(i)switch(i.type){case bE:this._onResponseMessage(i);break;case tJ:this._invokeQueue.push(i);break;case eJ:this._onAbortMessage(i);break;case KQ:this._onCloseMessage();break;case iJ:this._onOpenPortMessage(i);break;case eOe:this._onOnMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);this._invokeQueue.push(t),s&&(s.controller&&s.controller.abort(),i.delete(r))}_onCloseMessage(){const t=this._client;this._close(),t&&"destroy"in t&&Gl.clients.get(this)===t&&t.destroy(),Gl.clients.delete(this),t&&t.remoteClient&&(t.remoteClient=null)}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[i];try{if(!h&&i&&i.includes(".")){const p=i.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${i} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:bE,jobId:r,error:aN(p)})}vu(l)?(a.set(r,{controller:o,promise:l}),l.then(p=>{a.has(r)&&(a.delete(r),this._post({type:bE,jobId:r},p))},p=>{a.has(r)&&(a.delete(r),Gr(p)||this._post({type:bE,jobId:r,error:aN(p||{message:`Error encountered at method ${i}`})}))})):this._post({type:bE,jobId:r},l)}_onOpenPortMessage(t){new Gl(t.port,{client:this._client},()=>null)}_onOnMessage(t){const{port:i}=t,r=this._client.on(t.eventType,n=>{i.postMessage(n)}),s=fO(t.port,"message",n=>{eM(n).type===nl.CLOSE&&(s.remove(),r.remove(),i.close())})}_onResponseMessage(t){const{jobId:i,error:r,data:s}=t,n=this._outJobs;if(!n.has(i))return;const o=n.get(i);this._processWork(),n.delete(i),Ds(o.abortHandle),r?o.reject(q.fromJSON(JSON.parse(r))):o.resolve(s)}_post(t,i,r){return Khe(this._port,t,i,r)}}Gl.kernelInfo={revision:Ehe,version:wq,buildDate:She},Gl.clients=new Map;const rOe=me.getLogger("esri.core.workers.Connection");class sOe{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new VB}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(t,i){return new Promise((r,s)=>{let n=!0;const o=a=>{li(i.signal),n&&(n=!1,a())};this._clients.length=t.length,this._clientPromises.length=t.length,this._inUseClients.length=t.length;for(let a=0;a<t.length;++a){const l=t[a];vu(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new Gl(c,i,()=>this._ongoingJobsQueue.pop()),o(r),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new Gl(l,i,()=>this._ongoingJobsQueue.pop()),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(r))}})}broadcast(t,i,r){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a.invoke(t,i,r))}return s}close(){let t;for(;t=this._ongoingJobsQueue.pop();)t.deferred.reject(ui(`Worker closing, aborting job calling '${t.methodName}'`));for(const i of this._clientPromises)i.then(r=>r.close());this._clients.length=0,this._clientPromises.length=0}invoke(t,i,r){let s=null;Array.isArray(r)?(rOe.warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:r}):s=r;const n=hv();this._ongoingJobsQueue.push({methodName:t,data:i,invokeOptions:s,deferred:n});for(let o=0;o<this._clientPromises.length;o++){const a=this._clients[o];a?a.jobAdded():this._clientPromises[o].then(l=>l.jobAdded())}return n.promise}on(t,i){return Promise.all(this._clientPromises).then(()=>ES(this._clients.map(r=>r.on(t,i))))}openPorts(){return new Promise(t=>{const i=new Array(this._clientPromises.length);let r=i.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{i[s]=n.openPort(),--r==0&&t(i)})})}get test(){return{numClients:this._clients.length}}}const nOe=me.getLogger("esri.assets");function oOe(e,t){return ur(Mi(e),t)}function Mi(e){if(!Ii.assetsPath)throw nOe.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new q("assets:path-not-set","config.assetsPath is not set");return du(Ii.assetsPath,e)}const ede=me.getLogger("esri.intl");function mm(e,t,i={}){const{format:r={}}=i;return gf(e,s=>aOe(s,t,r))}function aOe(e,t,i){let r,s;const n=e.indexOf(":");if(n===-1?r=e.trim():(r=e.slice(0,n).trim(),s=e.slice(n+1).trim()),!r)return"";const o=N2(r,t);if(o==null)return"";const a=i[s]||i[r];return a?lOe(o,a):s?cOe(o,s):Mq(o)}function lOe(e,t){switch(t.type){case"date":return _f(e,t.intlOptions);case"number":return bf(e,t.intlOptions);default:return ede.warn("missing format descriptor for key {key}"),Mq(e)}}function cOe(e,t){switch(t.toLowerCase()){case"dateformat":return _f(e);case"numberformat":return bf(e);default:return ede.warn(`inline format is unsupported since 4.12: ${t}`),/^(dateformat|datestring)/i.test(t)?_f(e):/^numberformat/i.test(t)?bf(e):Mq(e)}}function Mq(e){switch(typeof e){case"string":return e;case"number":return bf(e);case"boolean":return""+e;default:return e instanceof Date?_f(e):""}}const rJ=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,uOe={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function sJ(e){var t;return(t=uOe[e])!=null?t:!1}const JC=[],eS=new Map;function nJ(e){for(const t of eS.keys())ide(e.pattern,t)&&eS.delete(t)}function hOe(e){return JC.includes(e)||(nJ(e),JC.unshift(e)),{remove(){const t=JC.indexOf(e);t>-1&&(JC.splice(t,1),nJ(e))}}}async function tde(e){const t=tu();eS.has(e)||eS.set(e,pOe(e,t));const i=eS.get(e);return await fOe.add(i),i}function dOe(e){if(!rJ.test(e))return null;const[,t,i]=rJ.exec(e),r=t+(i?"-"+i.toUpperCase():"");return sJ(r)?r:sJ(t)?t:null}async function pOe(e,t){const i=[];for(const r of JC)if(ide(r.pattern,e))try{return await r.fetchMessageBundle(e,t)}catch(s){i.push(s)}throw i.length?new q("intl:message-bundle-error",`Errors occurred while loading "${e}"`,{errors:i}):new q("intl:no-message-bundle-loader",`No loader found for message bundle "${e}"`)}function ide(e,t){return typeof e=="string"?t.startsWith(e):e.test(t)}JH(()=>{eS.clear()});const fOe=new class{constructor(){this._numLoading=0}async waitForAll(){this._dfd&&await this._dfd.promise}add(e){return this._increase(),e.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=hv())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}};async function mOe(e,t,i,r){const s=t.exec(i);if(!s)throw new q("esri-intl:invalid-bundle",`Bundle id "${i}" is not compatible with the pattern "${t}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=dOe(r),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await oJ(e(c))}catch(p){if(c===l)throw new q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:p});try{h=await oJ(e(l))}catch(f){throw new q("intl:unknown-bundle",`Bundle "${i}" cannot be loaded`,{error:f})}}return h}async function oJ(e){if(_(aJ.fetchBundleAsset))return aJ.fetchBundleAsset(e);const t=await ur(e,{responseType:"text"});return JSON.parse(t.data)}class gOe{constructor({base:t="",pattern:i,location:r=new URL(window.location.href)}){let s;s=typeof r=="string"?n=>new URL(n,new URL(r,window.location.href)).href:r instanceof URL?n=>new URL(n,r).href:r,this.pattern=typeof i=="string"?new RegExp(`^${i}`):i,this.getAssetUrl=s,t=t?t.endsWith("/")?t:t+"/":"",this.matcher=new RegExp(`^${t}(?:(.*)/)?(.*)$`)}fetchMessageBundle(t,i){return mOe(this.getAssetUrl,this.matcher,t,i)}}function yOe(e){return new gOe(e)}const aJ={};hOe(yOe({pattern:"esri/",location:Mi}));const lJ={};function vOe(e,t){for(const i of e)if(i.name===t.name)return;e.push(t)}function _Oe(e){var i;const t={async:e.async,isDebug:e.isDebug,locale:e.locale,baseUrl:e.baseUrl,has:F({},e.has),map:F({},e.map),packages:e.packages&&e.packages.concat()||[],paths:F({},e.paths)};return e.hasOwnProperty("async")||(t.async=!0),e.hasOwnProperty("isDebug")||(t.isDebug=!1),e.baseUrl||(t.baseUrl=lJ.baseUrl),(i=lJ.packages)==null||i.forEach(r=>{vOe(t.packages,r)}),t}class bOe{constructor(){const t=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(i=>{this[i]=(...r)=>t[i](...r)})}}class J${constructor(){this._dispatcher=new bOe,this._workerPostMessage({type:nl.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(t){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=t,t&&this.addEventListener("message",t)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(t){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=t,t&&this.addEventListener("messageerror",t)}get onerror(){return this._onerrorHandler}set onerror(t){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=t,t&&this.addEventListener("error",t)}postMessage(t){AS(()=>{this._workerMessageHandler(new MessageEvent("message",{data:t}))})}dispatchEvent(t){return this._dispatcher.dispatchEvent(t)}addEventListener(t,i,r){this._dispatcher.addEventListener(t,i,r)}removeEventListener(t,i,r){this._dispatcher.removeEventListener(t,i,r)}_workerPostMessage(t){AS(()=>{this.dispatchEvent(new MessageEvent("message",{data:t}))})}async _workerMessageHandler(t){const i=eM(t);if(i&&i.type===nl.OPEN){const{modulePath:r,jobId:s}=i;let n=await Gl.loadWorker(r);n||(n=await import(r));const o=Gl.connect(n);this._workerPostMessage({type:nl.OPENED,jobId:s,data:o})}}}const BB=me.getLogger("esri.core.workers"),{HANDSHAKE:wOe}=nl,xOe='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,i)=>{if(t){if(t.aborted)return i(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:5,jobId:n}),i(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:i}),self.postMessage({type:4,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,buildDate:r,version:t}=configuration.kernelInfo,{revision:n,buildDate:i,version:s}=e.kernelInfo;o!==n&&console.warn(`[esri.core.workers] Version mismatch detected between ArcGIS API for JavaScript and assets:\\nAPI version: ${t} [Date: ${r}, Revision: ${o.slice(0,8)}]\nAssets version: ${s} [Date: ${i}, Revision: ${n.slice(0,8)}]`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case 1:let e;function t(o){const t=e.connect(o);self.postMessage({type:2,jobId:r,data:t},[t])}"function"==typeof define&&define.amd?require([workerPath],(r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((r=>(e=r.default,checkWorkerRevision(e),e.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((r=>{e=r.default||r,checkWorkerRevision(e),e.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),e=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(e),e.loadWorker(o.modulePath).then(t));break;case 3:if(outgoing.has(r)){const e=outgoing.get(r);outgoing.delete(r),o.error?e.reject(JSON.parse(o.error)):e.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let z3,V3;const cJ="Failed to create Worker. Fallback to execute module in main thread";async function TOe(){if(!he("esri-workers")||(he("mozilla"),0))return uJ(new J$);if(!z3&&!V3)try{const t=xOe.replace('"{CONFIGURATION}"',`'${SOe()}'`);z3=URL.createObjectURL(new Blob([t],{type:"text/javascript"}))}catch(t){V3=t||{}}let e;if(z3)try{e=new Worker(z3,{name:"esri-worker-"+EOe++})}catch{BB.warn(cJ,V3),e=new J$}else BB.warn(cJ,V3),e=new J$;return uJ(e)}async function uJ(e){return new Promise(t=>{function i(s){const n=eM(s);n&&n.type===wOe&&(e.removeEventListener("message",i),e.removeEventListener("error",r),t(e))}function r(s){s.preventDefault(),e.removeEventListener("message",i),e.removeEventListener("error",r),BB.warn("Failed to create Worker. Fallback to execute module in main thread",s),(e=new J$).addEventListener("message",i),e.addEventListener("error",r)}e.addEventListener("message",i),e.addEventListener("error",r)})}function SOe(){let e;if(Ii.default!=null){const s=F({},Ii);delete s.default,e=JSON.parse(JSON.stringify(s))}else e=JSON.parse(JSON.stringify(Ii));e.assetsPath=gh(e.assetsPath),e.request.interceptors=[],e.log.interceptors=[],e.locale=tu(),e.has={"esri-csp-restrictions":he("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":he("esri-2d-update-debug"),"esri-2d-query-centroid-enabled":he("esri-2d-query-centroid-enabled"),"featurelayer-pbf":he("featurelayer-pbf"),"featurelayer-simplify-thresholds":he("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":he("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":he("featurelayer-simplify-mobile-factor"),"esri-atomics":he("esri-atomics"),"esri-shared-array-buffer":he("esri-shared-array-buffer"),"esri-tiles-debug":he("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":he("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":he("feature-polyline-generalization-factor"),"host-webworker":1},e.workers.loaderUrl&&(e.workers.loaderUrl=gh(e.workers.loaderUrl)),e.workers.workerPath?e.workers.workerPath=gh(e.workers.workerPath):e.workers.workerPath=gh(Mi("esri/core/workers/RemoteClient.js")),e.workers.useDynamicImport=!1;const t=Ii.workers.loaderConfig,i=_Oe({baseUrl:t==null?void 0:t.baseUrl,locale:tu(),has:F({"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1},t==null?void 0:t.has),map:F({},t==null?void 0:t.map),paths:F({},t==null?void 0:t.paths),packages:(t==null?void 0:t.packages)||[]}),r={version:wq,buildDate:She,revision:Ehe};return JSON.stringify({esriConfig:e,loaderConfig:i,kernelInfo:r})}let EOe=0;const COe=me.getLogger("esri.core.workers"),{ABORT:hJ,INVOKE:AOe,OPEN:ROe,OPENED:MOe,RESPONSE:wE}=nl;class Oq{constructor(t,i){this._outJobs=new Map,this._inJobs=new Map,this.worker=t,this.id=i,t.addEventListener("message",this._onMessage.bind(this)),t.addEventListener("error",r=>{r.preventDefault(),COe.error(r)})}static async create(t){const i=await TOe();return new Oq(i,t)}terminate(){this.worker.terminate()}async open(t,i={}){const{signal:r}=i,s=Jhe();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:r4(r,()=>{this._outJobs.delete(s),this._post({type:hJ,jobId:s})})};this._outJobs.set(s,a),this._post({type:ROe,jobId:s,modulePath:t})})}_onMessage(t){const i=eM(t);if(i)switch(i.type){case MOe:this._onOpenedMessage(i);break;case wE:this._onResponseMessage(i);break;case hJ:this._onAbortMessage(i);break;case AOe:this._onInvokeMessage(i)}}_onAbortMessage(t){const i=this._inJobs,r=t.jobId,s=i.get(r);s&&(s.controller&&s.controller.abort(),i.delete(r))}_onInvokeMessage(t){const{methodName:i,jobId:r,data:s,abortable:n}=t,o=n?new AbortController:null,a=this._inJobs,l=aMe[i];let c;try{if(typeof l!="function")throw new TypeError(`${i} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:wE,jobId:r,error:aN(h)})}vu(c)?(a.set(r,{controller:o,promise:c}),c.then(h=>{a.has(r)&&(a.delete(r),this._post({type:wE,jobId:r},h))},h=>{a.has(r)&&(a.delete(r),h||(h={message:"Error encountered at method"+i}),Gr(h)||this._post({type:wE,jobId:r,error:aN(h||{message:`Error encountered at method ${i}`})}))})):this._post({type:wE,jobId:r},c)}_onOpenedMessage(t){const{jobId:i,data:r}=t,s=this._outJobs.get(i);s&&(this._outJobs.delete(i),Ds(s.abortHandle),s.resolve(r))}_onResponseMessage(t){const{jobId:i,error:r,data:s}=t,n=this._outJobs.get(i);n&&(this._outJobs.delete(i),Ds(n.abortHandle),r?n.reject(q.fromJSON(JSON.parse(r))):n.resolve(s))}_post(t,i,r){return Khe(this.worker,t,i,r)}}let H1=he("esri-workers-debug")?1:he("host-browser")?navigator.hardwareConcurrency-1:0;H1||(H1=he("safari")&&he("mac")||he("trident")?7:2);let dJ=0;const K$=[];function OOe(){sde()}async function B3(e,t){const i=new sOe;return await i.open(e,t),i}async function rde(e,t={}){if(typeof e!="string")throw new q("workers:undefined-module","modulePath is missing");let i=t.strategy||"distributed";if(he("host-webworker")&&!he("esri-workers")&&(i="local"),i==="local"){let r=await Gl.loadWorker(e);r||(r=await import(e)),li(t.signal);const s=t.client||r;return B3([Gl.connect(r)],ve(F({},t),{client:s}))}if(await sde(),li(t.signal),i==="dedicated"){const r=dJ++%H1;return B3([await K$[r].open(e,t)],t)}if(t.maxNumWorkers&&t.maxNumWorkers>0){const r=Math.min(t.maxNumWorkers,H1);if(r<H1){const s=new Array(r);for(let n=0;n<r;++n){const o=dJ++%H1;s[n]=K$[o].open(e,t)}return B3(s,t)}}return B3(K$.map(r=>r.open(e,t)),t)}let G3=null;async function sde(){if(G3)return G3;new AbortController;const e=[];for(let t=0;t<H1;t++){const i=Oq.create(t).then(r=>(K$[t]=r,r));e.push(i)}return G3=Promise.all(e),G3}let eD=class extends Ee{constructor(e){super(e),this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(t=>{e+=t.length}),e}add(e,t){if(!this._isHandle(e)&&!Array.isArray(e)&&!at.isCollection(e))return this;const i=this._getOrCreateGroup(t);return Array.isArray(e)||at.isCollection(e)?e.forEach(r=>this._isHandle(r)&&i.push(r)):i.push(e),this.notifyChange("size"),this}forEach(e,t){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&t&&i.forEach(t)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(Array.isArray(e)||at.isCollection(e))return e.forEach(this.remove,this),this;if(!this.has(e))return this;const t=this._getGroup(e);for(let i=0;i<t.length;i++)t[i].remove();return this._deleteGroup(e),this.notifyChange("size"),this}removeAll(){return this._groups.forEach(e=>{for(let t=0;t<e.length;t++)e[t].remove()}),this._groups.clear(),this.notifyChange("size"),this}_isHandle(e){return e&&!!e.remove}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const t=[];return this._groups.set(this._ensureGroupKey(e),t),t}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_deleteGroup(e){return this._groups.delete(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}};u([d({readOnly:!0})],eD.prototype,"size",null),eD=u([P("esri.core.Handles")],eD);const qt=eD;let uf=class extends Ee{constructor(){super(...arguments),this.updating=!1,this.handleId=0,this.handles=new qt,this.scheduleHandleId=0,this.pendingPromises=new Set}destroy(){this.removeAll(),this.handles.destroy()}add(e,t,i={}){return this._installWatch(e,t,i,ae)}addWhen(e,t,i={}){return this._installWatch(e,t,i,cl)}addOnCollectionChange(e,t,{initial:i=!1,final:r=!1}={}){const s=++this.handleId;return this.handles.add([eo(e,"after-changes",this._createSyncUpdatingCallback(),rr),eo(e,"change",t,{onListenerAdd:i?n=>t({added:n.toArray(),removed:[]}):void 0,onListenerRemove:r?n=>t({added:[],removed:n.toArray()}):void 0})],s),{remove:()=>this.handles.remove(s)}}addPromise(e){if(R(e))return e;const t=++this.handleId;this.handles.add({remove:()=>{this.pendingPromises.delete(e)&&(this.pendingPromises.size!==0||this.handles.has(j3)||this._set("updating",!1))}},t),this.pendingPromises.add(e),this._set("updating",!0);const i=()=>this.handles.remove(t);return e.then(i,i),e}removeAll(){this.pendingPromises.clear(),this.handles.removeAll(),this._set("updating",!1)}_installWatch(e,t,i={},r){const s=++this.handleId;i.sync||this._installSyncUpdatingWatch(e,s);const n=r(e,t,i);return this.handles.add(n,s),{remove:()=>this.handles.remove(s)}}_installSyncUpdatingWatch(e,t){const i=this._createSyncUpdatingCallback(),r=ae(e,i,{sync:!0,equals:()=>!1});return this.handles.add(r,t),r}_createSyncUpdatingCallback(){return()=>{this.handles.remove(j3),++this.scheduleHandleId;const e=this.scheduleHandleId;this._get("updating")||this._set("updating",!0),this.handles.add(F2(()=>{e===this.scheduleHandleId&&(this._set("updating",this.pendingPromises.size>0),this.handles.remove(j3))}),j3)}}};u([d({readOnly:!0})],uf.prototype,"updating",void 0),uf=u([P("esri.core.support.WatchUpdatingTracking")],uf);const j3=-42;var pJ;(function(e){e[e.NONE=0]="NONE",e[e.SYNC=1]="SYNC",e[e.INIT=2]="INIT"})(pJ||(pJ={}));const mw=e=>{let t=class extends e{destroy(){var i,r;this.destroyed||((i=this._get("handles"))==null||i.destroy(),(r=this._get("updatingHandles"))==null||r.destroy())}get handles(){return this._get("handles")||new qt}get updatingHandles(){return this._get("updatingHandles")||new uf}};return u([d({readOnly:!0})],t.prototype,"handles",null),u([d({readOnly:!0})],t.prototype,"updatingHandles",null),t=u([P("esri.core.HandleOwner")],t),t};let kS=class extends mw(Ee){};kS=u([P("esri.core.HandleOwner")],kS);me.getLogger("esri.core.support.OwningCollection");let eR=class extends mw(at){constructor(e){super(e),this.handles.add([this.on("before-add",t=>{R(t.item)&&t.preventDefault()}),this.on("after-add",t=>this._own(t.item)),this.on("after-remove",t=>this._release(t.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(at.ofType(this.itemType.Type))(e):new at(e)}};function GB(e,t){return{type:e,cast:bq,set(i){const r=_g(i,this._get(t),e);r.owner=this,this._set(t,r)}}}u([d()],eR.prototype,"owner",null),eR=u([P("esri.core.support.OwningCollection")],eR);function Pq(e){return new Xe({wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${e.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`})}const nde=Pq(Ei),lN=Pq(cf),cN=Pq(yg),POe=new Xe({wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${Ei.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`});function Ef(e){return e&&(If(e)||e===lN)?lN:e&&($f(e)||e===cN)?cN:nde}function vi(e){return e&&(If(e)||e===lN)?cf:e&&($f(e)||e===cN)?yg:Ei}function F0t(e){return FH(e)?cf:UH(e)?yg:Ei}const ode=39.37,IOe=Ei.radius*Math.PI/200,ade=/UNIT\[([^\]]+)\]\]$/i,db=L,lde=/UNIT\[([^\]]+)\]/i,$Oe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),DOe=Zo()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),ip=e=>e*e,Zg=e=>e*e*e,tM={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:ip(.001)},"square-centimeters":{inBaseUnits:ip(.01)},"square-decimeters":{inBaseUnits:ip(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:ip(1e3)},"square-inches":{inBaseUnits:ip(.0254)},"square-feet":{inBaseUnits:ip(.3048)},"square-yards":{inBaseUnits:ip(.9144)},"square-miles":{inBaseUnits:ip(1609.344)},"square-us-feet":{inBaseUnits:ip(1200/3937)},acres:{inBaseUnits:.0015625*ip(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*Zg(.001)},"cubic-centimeters":{inBaseUnits:1e3*Zg(.01)},"cubic-decimeters":{inBaseUnits:1e3*Zg(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*Zg(1e3)},"cubic-inches":{inBaseUnits:1e3*Zg(.0254)},"cubic-feet":{inBaseUnits:1e3*Zg(.3048)},"cubic-yards":{inBaseUnits:1e3*Zg(.9144)},"cubic-miles":{inBaseUnits:1e3*Zg(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},LOe=(()=>{const e={};for(const t in tM)for(const i in tM[t].units)e[i]=t;return e})();function NOe(e,t,i){return e*tM[i].units[t].inBaseUnits}function FOe(e,t,i){return e/tM[i].units[t].inBaseUnits}const UOe=["metric","imperial","inches","feet","yards","miles","nautical-miles","us-feet","meters","kilometers"];function jB(e){const t=LOe[e];if(!t)throw new Error("unknown type");return t}function fJ(e,t=null){return t=t||jB(e),tM[t].baseUnit===e}function Hs(e,t,i){if(t===i)return e;const r=jB(t);if(r!==jB(i))throw new Error("incompatible units");const s=fJ(t,r)?e:NOe(e,t,r);return fJ(i,r)?s:FOe(s,i,r)}function kOe(e,t){const i=Hs(e,t,"meters");return Math.abs(i)<3e3?"meters":"kilometers"}function zOe(e,t){const i=Hs(e,t,"meters");return Math.abs(i)<1e5?"meters":"kilometers"}function VOe(e,t){const i=Hs(e,t,"feet");return Math.abs(i)<1e3?"feet":"miles"}function BOe(e,t){const i=Hs(e,t,"feet");return Math.abs(i)<1e5?"feet":"miles"}function U0t(e,t){const i=Hs(e,t,"square-meters");return Math.abs(i)<3e6?"square-meters":"square-kilometers"}function k0t(e,t){const i=Hs(e,t,"square-feet");return Math.abs(i)<1e6?"square-feet":"square-miles"}function GOe(e,t,i){return Hs(e,t,"meters")/(i*Math.PI/180)}function cde(e){return DOe.fromJSON(e.toLowerCase())||null}function zS(e){if(e&&typeof e=="object"&&!RS(e))return 1;const t=cc(e);return t>1e5?1:t}function jOe(e){return cc(e)>=(e instanceof Xe?vi(e).metersPerDegree:1e5)?"meters":Iq(e)}function cc(e,t=Ei.metersPerDegree){return yt(HOe(e,!0),t)}function HOe(e,t=!1){let i,r,s=null;if(e!=null&&(typeof e=="object"?(i=e.wkid,r=e.wkt):typeof e=="number"?i=e:typeof e=="string"&&(r=e)),i){if(FH(i))return cf.metersPerDegree;if(UH(i))return yg.metersPerDegree;s=db.values[db[i]],!s&&t&&$Oe.has(i)&&(s=IOe)}else r&&(dde(r)?s=mJ(ade.exec(r),s):hde(r)&&(s=mJ(lde.exec(r),s)));return s}function mJ(e,t){return e&&e[1]?ude(e[1]):t}function ude(e){return parseFloat(e.split(",")[1])}function Iq(e){let t,i,r=null;if(e!=null&&(typeof e=="object"?(t=e.wkid,i=e.wkt):typeof e=="number"?t=e:typeof e=="string"&&(i=e)),t)r=db.units[db[t]];else if(i){const s=dde(i)?ade:hde(i)?lde:null;if(s){const n=s.exec(i);n&&n[1]&&(r=WOe(n[1]))}}return _(r)?cde(r):null}function z0t(e){const t=Iq(e);return R(t)||!UOe.includes(t)?null:t}function hde(e){return/^GEOCCS/i.test(e)}function dde(e){return/^PROJCS/i.test(e)}const qOe=1e-7;function WOe(e){const t=/[\\"\\']{1}([^\\"\\']+)/.exec(e);let i=t&&t[1];if(!i||!db.units.includes(i)){const r=ude(e);i=null;const s=db.values;for(let n=0;n<s.length;++n)if(Math.abs(r-s[n])<qOe){i=db.units[n];break}}return i}function XOe(e){const t=Iq(e);if(R(t))return null;switch(t){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric"}return null}function V0t(e){var s,n,o;const t="metric";if(R(e))return t;const i=e.map,r=i&&"portalItem"in i?(s=i.portalItem)==null?void 0:s.portal:null;if(r)switch((o=(n=r==null?void 0:r.user)==null?void 0:n.units)!=null?o:r.units){case t:return t;case"english":return"imperial"}return yt(XOe(e.spatialReference),t)}const pde={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},fde={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},YOe=Zo()(pde),ZOe=Zo()(fde);Zo()(F(F({},pde),fde));var KC;const uN=Zo()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),mde=uN.jsonValues.slice();QF(mde,"orthometric");const tR=Zo()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let Kh=KC=class extends fe{constructor(e){super(e),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(e,t,i){return uN.write(e,t,i)}readHeightModel(e,t,i){return uN.read(e)||(i&&i.messages&&i.messages.push(QOe(e,{context:i})),null)}readHeightUnit(e,t,i){return tR.read(e)||(i&&i.messages&&i.messages.push(gJ(e,{context:i})),null)}readHeightUnitService(e,t,i){return cde(e)||tR.read(e)||(i&&i.messages&&i.messages.push(gJ(e,{context:i})),null)}readVertCRS(e,t){return t.vertCRS||t.ellipsoid||t.geoid}clone(){return new KC({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(e){return!!e&&(this===e||this.heightModel===e.heightModel&&this.heightUnit===e.heightUnit&&this.vertCRS===e.vertCRS)}static deriveUnitFromSR(e,t){const i=jOe(t);return new KC({heightModel:e.heightModel,heightUnit:i,vertCRS:e.vertCRS})}write(e,t){return t=F({origin:"web-scene"},t),super.write(e,t)}static fromJSON(e){if(!e)return null;const t=new KC;return t.read(e,{origin:"web-scene"}),t}};function gJ(e,t){return new lu("height-unit:unsupported",`Height unit of value '${e}' is not supported`,t)}function QOe(e,t){return new lu("height-model:unsupported",`Height model of value '${e}' is not supported`,t)}u([d({type:uN.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:mde,default:"ellipsoidal"}}}})],Kh.prototype,"heightModel",void 0),u([Be("web-scene","heightModel")],Kh.prototype,"writeHeightModel",null),u([ke(["web-scene","service"],"heightModel")],Kh.prototype,"readHeightModel",null),u([d({type:tR.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:tR.jsonValues,write:tR.write}}}})],Kh.prototype,"heightUnit",void 0),u([ke("web-scene","heightUnit")],Kh.prototype,"readHeightUnit",null),u([ke("service","heightUnit")],Kh.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],Kh.prototype,"vertCRS",void 0),u([ke("service","vertCRS",["vertCRS","ellipsoid","geoid"])],Kh.prototype,"readVertCRS",null),Kh=KC=u([P("esri.geometry.HeightModelInfo")],Kh);const Nv=Kh;function ms(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Nf(e,t,i,r,s,n,o,a,l,c,h,p,f,m,y,v,w){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e[9]=h,e[10]=p,e[11]=f,e[12]=m,e[13]=y,e[14]=v,e[15]=w,e}function Cf(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function dl(e,t){if(e===t){const i=t[1],r=t[2],s=t[3],n=t[6],o=t[7],a=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=i,e[6]=t[9],e[7]=t[13],e[8]=r,e[9]=n,e[11]=t[14],e[12]=s,e[13]=o,e[14]=a}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15];return e}function cs(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],y=t[12],v=t[13],w=t[14],b=t[15],S=i*a-r*o,T=i*l-s*o,E=i*c-n*o,C=r*l-s*a,M=r*c-n*a,I=s*c-n*l,N=h*v-p*y,D=h*w-f*y,z=h*b-m*y,V=p*w-f*v,k=p*b-m*v,Y=f*b-m*w;let Z=S*Y-T*k+E*V+C*z-M*D+I*N;return Z?(Z=1/Z,e[0]=(a*Y-l*k+c*V)*Z,e[1]=(s*k-r*Y-n*V)*Z,e[2]=(v*I-w*M+b*C)*Z,e[3]=(f*M-p*I-m*C)*Z,e[4]=(l*z-o*Y-c*D)*Z,e[5]=(i*Y-s*z+n*D)*Z,e[6]=(w*E-y*I-b*T)*Z,e[7]=(h*I-f*E+m*T)*Z,e[8]=(o*k-a*z+c*N)*Z,e[9]=(r*z-i*k-n*N)*Z,e[10]=(y*M-v*E+b*S)*Z,e[11]=(p*E-h*M-m*S)*Z,e[12]=(a*D-o*V-l*N)*Z,e[13]=(i*V-r*D+s*N)*Z,e[14]=(v*T-y*C-w*S)*Z,e[15]=(h*C-p*T+f*S)*Z,e):null}function JOe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],y=t[12],v=t[13],w=t[14],b=t[15];return e[0]=a*(f*b-m*w)-p*(l*b-c*w)+v*(l*m-c*f),e[1]=-(r*(f*b-m*w)-p*(s*b-n*w)+v*(s*m-n*f)),e[2]=r*(l*b-c*w)-a*(s*b-n*w)+v*(s*c-n*l),e[3]=-(r*(l*m-c*f)-a*(s*m-n*f)+p*(s*c-n*l)),e[4]=-(o*(f*b-m*w)-h*(l*b-c*w)+y*(l*m-c*f)),e[5]=i*(f*b-m*w)-h*(s*b-n*w)+y*(s*m-n*f),e[6]=-(i*(l*b-c*w)-o*(s*b-n*w)+y*(s*c-n*l)),e[7]=i*(l*m-c*f)-o*(s*m-n*f)+h*(s*c-n*l),e[8]=o*(p*b-m*v)-h*(a*b-c*v)+y*(a*m-c*p),e[9]=-(i*(p*b-m*v)-h*(r*b-n*v)+y*(r*m-n*p)),e[10]=i*(a*b-c*v)-o*(r*b-n*v)+y*(r*c-n*a),e[11]=-(i*(a*m-c*p)-o*(r*m-n*p)+h*(r*c-n*a)),e[12]=-(o*(p*w-f*v)-h*(a*w-l*v)+y*(a*f-l*p)),e[13]=i*(p*w-f*v)-h*(r*w-s*v)+y*(r*f-s*p),e[14]=-(i*(a*w-l*v)-o*(r*w-s*v)+y*(r*l-s*a)),e[15]=i*(a*f-l*p)-o*(r*f-s*p)+h*(r*l-s*a),e}function KOe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11],m=e[12],y=e[13],v=e[14],w=e[15];return(t*o-i*n)*(p*w-f*v)-(t*a-r*n)*(h*w-f*y)+(t*l-s*n)*(h*v-p*y)+(i*a-r*o)*(c*w-f*m)-(i*l-s*o)*(c*v-p*m)+(r*l-s*a)*(c*y-h*m)}function Nr(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=t[9],m=t[10],y=t[11],v=t[12],w=t[13],b=t[14],S=t[15];let T=i[0],E=i[1],C=i[2],M=i[3];return e[0]=T*r+E*a+C*p+M*v,e[1]=T*s+E*l+C*f+M*w,e[2]=T*n+E*c+C*m+M*b,e[3]=T*o+E*h+C*y+M*S,T=i[4],E=i[5],C=i[6],M=i[7],e[4]=T*r+E*a+C*p+M*v,e[5]=T*s+E*l+C*f+M*w,e[6]=T*n+E*c+C*m+M*b,e[7]=T*o+E*h+C*y+M*S,T=i[8],E=i[9],C=i[10],M=i[11],e[8]=T*r+E*a+C*p+M*v,e[9]=T*s+E*l+C*f+M*w,e[10]=T*n+E*c+C*m+M*b,e[11]=T*o+E*h+C*y+M*S,T=i[12],E=i[13],C=i[14],M=i[15],e[12]=T*r+E*a+C*p+M*v,e[13]=T*s+E*l+C*f+M*w,e[14]=T*n+E*c+C*m+M*b,e[15]=T*o+E*h+C*y+M*S,e}function Aa(e,t,i){const r=i[0],s=i[1],n=i[2];if(t===e)e[12]=t[0]*r+t[4]*s+t[8]*n+t[12],e[13]=t[1]*r+t[5]*s+t[9]*n+t[13],e[14]=t[2]*r+t[6]*s+t[10]*n+t[14],e[15]=t[3]*r+t[7]*s+t[11]*n+t[15];else{const o=t[0],a=t[1],l=t[2],c=t[3],h=t[4],p=t[5],f=t[6],m=t[7],y=t[8],v=t[9],w=t[10],b=t[11];e[0]=o,e[1]=a,e[2]=l,e[3]=c,e[4]=h,e[5]=p,e[6]=f,e[7]=m,e[8]=y,e[9]=v,e[10]=w,e[11]=b,e[12]=o*r+h*s+y*n+t[12],e[13]=a*r+p*s+v*n+t[13],e[14]=l*r+f*s+w*n+t[14],e[15]=c*r+m*s+b*n+t[15]}return e}function T4(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*s,e[5]=t[5]*s,e[6]=t[6]*s,e[7]=t[7]*s,e[8]=t[8]*n,e[9]=t[9]*n,e[10]=t[10]*n,e[11]=t[11]*n,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Wl(e,t,i,r){let s,n,o,a,l,c,h,p,f,m,y,v,w,b,S,T,E,C,M,I,N,D,z,V,k=r[0],Y=r[1],Z=r[2],le=Math.sqrt(k*k+Y*Y+Z*Z);return le<Et?null:(le=1/le,k*=le,Y*=le,Z*=le,s=Math.sin(i),n=Math.cos(i),o=1-n,a=t[0],l=t[1],c=t[2],h=t[3],p=t[4],f=t[5],m=t[6],y=t[7],v=t[8],w=t[9],b=t[10],S=t[11],T=k*k*o+n,E=Y*k*o+Z*s,C=Z*k*o-Y*s,M=k*Y*o-Z*s,I=Y*Y*o+n,N=Z*Y*o+k*s,D=k*Z*o+Y*s,z=Y*Z*o-k*s,V=Z*Z*o+n,e[0]=a*T+p*E+v*C,e[1]=l*T+f*E+w*C,e[2]=c*T+m*E+b*C,e[3]=h*T+y*E+S*C,e[4]=a*M+p*I+v*N,e[5]=l*M+f*I+w*N,e[6]=c*M+m*I+b*N,e[7]=h*M+y*I+S*N,e[8]=a*D+p*z+v*V,e[9]=l*D+f*z+w*V,e[10]=c*D+m*z+b*V,e[11]=h*D+y*z+S*V,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e)}function VS(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=n*s+c*r,e[5]=o*s+h*r,e[6]=a*s+p*r,e[7]=l*s+f*r,e[8]=c*s-n*r,e[9]=h*s-o*r,e[10]=p*s-a*r,e[11]=f*s-l*r,e}function S4(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[8],h=t[9],p=t[10],f=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s-c*r,e[1]=o*s-h*r,e[2]=a*s-p*r,e[3]=l*s-f*r,e[8]=n*r+c*s,e[9]=o*r+h*s,e[10]=a*r+p*s,e[11]=l*r+f*s,e}function BS(e,t,i){const r=Math.sin(i),s=Math.cos(i),n=t[0],o=t[1],a=t[2],l=t[3],c=t[4],h=t[5],p=t[6],f=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=n*s+c*r,e[1]=o*s+h*r,e[2]=a*s+p*r,e[3]=l*s+f*r,e[4]=c*s-n*r,e[5]=h*s-o*r,e[6]=p*s-a*r,e[7]=f*s-l*r,e}function E4(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=t[0],e[13]=t[1],e[14]=t[2],e[15]=1,e}function e3e(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=t[1],e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=t[2],e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function pu(e,t,i){let r,s,n,o=i[0],a=i[1],l=i[2],c=Math.sqrt(o*o+a*a+l*l);return c<Et?null:(c=1/c,o*=c,a*=c,l*=c,r=Math.sin(t),s=Math.cos(t),n=1-s,e[0]=o*o*n+s,e[1]=a*o*n+l*r,e[2]=l*o*n-a*r,e[3]=0,e[4]=o*a*n-l*r,e[5]=a*a*n+s,e[6]=l*a*n+o*r,e[7]=0,e[8]=o*l*n+a*r,e[9]=a*l*n-o*r,e[10]=l*l*n+s,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e)}function gde(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=r,e[6]=i,e[7]=0,e[8]=0,e[9]=-i,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function t3e(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=0,e[2]=-i,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=i,e[9]=0,e[10]=r,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function yde(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=0,e[4]=-i,e[5]=r,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function vde(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=r+r,l=s+s,c=n+n,h=r*a,p=r*l,f=r*c,m=s*l,y=s*c,v=n*c,w=o*a,b=o*l,S=o*c;return e[0]=1-(m+v),e[1]=p+S,e[2]=f-b,e[3]=0,e[4]=p-S,e[5]=1-(h+v),e[6]=y+w,e[7]=0,e[8]=f+b,e[9]=y-w,e[10]=1-(h+m),e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function i3e(e,t){const i=r3e,r=-t[0],s=-t[1],n=-t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=r*r+s*s+n*n+o*o;return p>0?(i[0]=2*(a*o+h*r+l*n-c*s)/p,i[1]=2*(l*o+h*s+c*r-a*n)/p,i[2]=2*(c*o+h*n+a*s-l*r)/p):(i[0]=2*(a*o+h*r+l*n-c*s),i[1]=2*(l*o+h*s+c*r-a*n),i[2]=2*(c*o+h*n+a*s-l*r)),vde(e,t,i),e}const r3e=O();function s3e(e,t){return e[0]=t[12],e[1]=t[13],e[2]=t[14],e}function _de(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return e[0]=Math.sqrt(i*i+r*r+s*s),e[1]=Math.sqrt(n*n+o*o+a*a),e[2]=Math.sqrt(l*l+c*c+h*h),e}function n3e(e,t){const i=t[0]+t[5]+t[10];let r=0;return i>0?(r=2*Math.sqrt(i+1),e[3]=.25*r,e[0]=(t[6]-t[9])/r,e[1]=(t[8]-t[2])/r,e[2]=(t[1]-t[4])/r):t[0]>t[5]&&t[0]>t[10]?(r=2*Math.sqrt(1+t[0]-t[5]-t[10]),e[3]=(t[6]-t[9])/r,e[0]=.25*r,e[1]=(t[1]+t[4])/r,e[2]=(t[8]+t[2])/r):t[5]>t[10]?(r=2*Math.sqrt(1+t[5]-t[0]-t[10]),e[3]=(t[8]-t[2])/r,e[0]=(t[1]+t[4])/r,e[1]=.25*r,e[2]=(t[6]+t[9])/r):(r=2*Math.sqrt(1+t[10]-t[0]-t[5]),e[3]=(t[1]-t[4])/r,e[0]=(t[8]+t[2])/r,e[1]=(t[6]+t[9])/r,e[2]=.25*r),e}function o3e(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,m=s*h,y=n*c,v=n*h,w=o*h,b=a*l,S=a*c,T=a*h,E=r[0],C=r[1],M=r[2];return e[0]=(1-(y+w))*E,e[1]=(f+T)*E,e[2]=(m-S)*E,e[3]=0,e[4]=(f-T)*C,e[5]=(1-(p+w))*C,e[6]=(v+b)*C,e[7]=0,e[8]=(m+S)*M,e[9]=(v-b)*M,e[10]=(1-(p+y))*M,e[11]=0,e[12]=i[0],e[13]=i[1],e[14]=i[2],e[15]=1,e}function a3e(e,t,i,r,s){const n=t[0],o=t[1],a=t[2],l=t[3],c=n+n,h=o+o,p=a+a,f=n*c,m=n*h,y=n*p,v=o*h,w=o*p,b=a*p,S=l*c,T=l*h,E=l*p,C=r[0],M=r[1],I=r[2],N=s[0],D=s[1],z=s[2],V=(1-(v+b))*C,k=(m+E)*C,Y=(y-T)*C,Z=(m-E)*M,le=(1-(f+b))*M,ne=(w+S)*M,$=(y+T)*I,U=(w-S)*I,B=(1-(f+v))*I;return e[0]=V,e[1]=k,e[2]=Y,e[3]=0,e[4]=Z,e[5]=le,e[6]=ne,e[7]=0,e[8]=$,e[9]=U,e[10]=B,e[11]=0,e[12]=i[0]+N-(V*N+Z*D+$*z),e[13]=i[1]+D-(k*N+le*D+U*z),e[14]=i[2]+z-(Y*N+ne*D+B*z),e[15]=1,e}function l3e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,m=s*a,y=s*l,v=n*o,w=n*a,b=n*l;return e[0]=1-p-y,e[1]=h+b,e[2]=f-w,e[3]=0,e[4]=h-b,e[5]=1-c-y,e[6]=m+v,e[7]=0,e[8]=f+w,e[9]=m-v,e[10]=1-c-p,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1,e}function bde(e,t,i,r,s,n,o){const a=1/(i-t),l=1/(s-r),c=1/(n-o);return e[0]=2*n*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*n*l,e[6]=0,e[7]=0,e[8]=(i+t)*a,e[9]=(s+r)*l,e[10]=(o+n)*c,e[11]=-1,e[12]=0,e[13]=0,e[14]=o*n*2*c,e[15]=0,e}function c3e(e,t,i,r,s){const n=1/Math.tan(t/2);let o;return e[0]=n/i,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=n,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,s!=null&&s!==1/0?(o=1/(r-s),e[10]=(s+r)*o,e[14]=2*s*r*o):(e[10]=-1,e[14]=-2*r),e}function u3e(e,t,i,r){const s=Math.tan(t.upDegrees*Math.PI/180),n=Math.tan(t.downDegrees*Math.PI/180),o=Math.tan(t.leftDegrees*Math.PI/180),a=Math.tan(t.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return e[0]=l,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=c,e[6]=0,e[7]=0,e[8]=-(o-a)*l*.5,e[9]=(s-n)*c*.5,e[10]=r/(i-r),e[11]=-1,e[12]=0,e[13]=0,e[14]=r*i/(i-r),e[15]=0,e}function $q(e,t,i,r,s,n,o){const a=1/(t-i),l=1/(r-s),c=1/(n-o);return e[0]=-2*a,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*c,e[11]=0,e[12]=(t+i)*a,e[13]=(s+r)*l,e[14]=(o+n)*c,e[15]=1,e}function C4(e,t,i,r){let s,n,o,a,l,c,h,p,f,m;const y=t[0],v=t[1],w=t[2],b=r[0],S=r[1],T=r[2],E=i[0],C=i[1],M=i[2];return Math.abs(y-E)<Et&&Math.abs(v-C)<Et&&Math.abs(w-M)<Et?Cf(e):(h=y-E,p=v-C,f=w-M,m=1/Math.sqrt(h*h+p*p+f*f),h*=m,p*=m,f*=m,s=S*f-T*p,n=T*h-b*f,o=b*p-S*h,m=Math.sqrt(s*s+n*n+o*o),m?(m=1/m,s*=m,n*=m,o*=m):(s=0,n=0,o=0),a=p*o-f*n,l=f*s-h*o,c=h*n-p*s,m=Math.sqrt(a*a+l*l+c*c),m?(m=1/m,a*=m,l*=m,c*=m):(a=0,l=0,c=0),e[0]=s,e[1]=a,e[2]=h,e[3]=0,e[4]=n,e[5]=l,e[6]=p,e[7]=0,e[8]=o,e[9]=c,e[10]=f,e[11]=0,e[12]=-(s*y+n*v+o*w),e[13]=-(a*y+l*v+c*w),e[14]=-(h*y+p*v+f*w),e[15]=1,e)}function wde(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=r[0],l=r[1],c=r[2];let h=s-i[0],p=n-i[1],f=o-i[2],m=h*h+p*p+f*f;m>0&&(m=1/Math.sqrt(m),h*=m,p*=m,f*=m);let y=l*f-c*p,v=c*h-a*f,w=a*p-l*h;return m=y*y+v*v+w*w,m>0&&(m=1/Math.sqrt(m),y*=m,v*=m,w*=m),e[0]=y,e[1]=v,e[2]=w,e[3]=0,e[4]=p*w-f*v,e[5]=f*y-h*w,e[6]=h*v-p*y,e[7]=0,e[8]=h,e[9]=p,e[10]=f,e[11]=0,e[12]=s,e[13]=n,e[14]=o,e[15]=1,e}function h3e(e){return"mat4("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+", "+e[9]+", "+e[10]+", "+e[11]+", "+e[12]+", "+e[13]+", "+e[14]+", "+e[15]+")"}function d3e(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2+e[9]**2+e[10]**2+e[11]**2+e[12]**2+e[13]**2+e[14]**2+e[15]**2)}function p3e(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e[9]=t[9]+i[9],e[10]=t[10]+i[10],e[11]=t[11]+i[11],e[12]=t[12]+i[12],e[13]=t[13]+i[13],e[14]=t[14]+i[14],e[15]=t[15]+i[15],e}function xde(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e[9]=t[9]-i[9],e[10]=t[10]-i[10],e[11]=t[11]-i[11],e[12]=t[12]-i[12],e[13]=t[13]-i[13],e[14]=t[14]-i[14],e[15]=t[15]-i[15],e}function f3e(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e[9]=t[9]*i,e[10]=t[10]*i,e[11]=t[11]*i,e[12]=t[12]*i,e[13]=t[13]*i,e[14]=t[14]*i,e[15]=t[15]*i,e}function m3e(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e[9]=t[9]+i[9]*r,e[10]=t[10]+i[10]*r,e[11]=t[11]+i[11]*r,e[12]=t[12]+i[12]*r,e[13]=t[13]+i[13]*r,e[14]=t[14]+i[14]*r,e[15]=t[15]+i[15]*r,e}function g3e(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]&&e[9]===t[9]&&e[10]===t[10]&&e[11]===t[11]&&e[12]===t[12]&&e[13]===t[13]&&e[14]===t[14]&&e[15]===t[15]}function Tde(e,t){if(e===t)return!0;const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],y=e[12],v=e[13],w=e[14],b=e[15],S=t[0],T=t[1],E=t[2],C=t[3],M=t[4],I=t[5],N=t[6],D=t[7],z=t[8],V=t[9],k=t[10],Y=t[11],Z=t[12],le=t[13],ne=t[14],$=t[15];return Math.abs(i-S)<=Et*Math.max(1,Math.abs(i),Math.abs(S))&&Math.abs(r-T)<=Et*Math.max(1,Math.abs(r),Math.abs(T))&&Math.abs(s-E)<=Et*Math.max(1,Math.abs(s),Math.abs(E))&&Math.abs(n-C)<=Et*Math.max(1,Math.abs(n),Math.abs(C))&&Math.abs(o-M)<=Et*Math.max(1,Math.abs(o),Math.abs(M))&&Math.abs(a-I)<=Et*Math.max(1,Math.abs(a),Math.abs(I))&&Math.abs(l-N)<=Et*Math.max(1,Math.abs(l),Math.abs(N))&&Math.abs(c-D)<=Et*Math.max(1,Math.abs(c),Math.abs(D))&&Math.abs(h-z)<=Et*Math.max(1,Math.abs(h),Math.abs(z))&&Math.abs(p-V)<=Et*Math.max(1,Math.abs(p),Math.abs(V))&&Math.abs(f-k)<=Et*Math.max(1,Math.abs(f),Math.abs(k))&&Math.abs(m-Y)<=Et*Math.max(1,Math.abs(m),Math.abs(Y))&&Math.abs(y-Z)<=Et*Math.max(1,Math.abs(y),Math.abs(Z))&&Math.abs(v-le)<=Et*Math.max(1,Math.abs(v),Math.abs(le))&&Math.abs(w-ne)<=Et*Math.max(1,Math.abs(w),Math.abs(ne))&&Math.abs(b-$)<=Et*Math.max(1,Math.abs(b),Math.abs($))}function Dq(e){const t=Et,i=e[0],r=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const y3e=Nr,v3e=xde;Object.freeze(Object.defineProperty({__proto__:null,copy:ms,set:Nf,identity:Cf,transpose:dl,invert:cs,adjoint:JOe,determinant:KOe,multiply:Nr,translate:Aa,scale:T4,rotate:Wl,rotateX:VS,rotateY:S4,rotateZ:BS,fromTranslation:E4,fromScaling:e3e,fromRotation:pu,fromXRotation:gde,fromYRotation:t3e,fromZRotation:yde,fromRotationTranslation:vde,fromQuat2:i3e,getTranslation:s3e,getScaling:_de,getRotation:n3e,fromRotationTranslationScale:o3e,fromRotationTranslationScaleOrigin:a3e,fromQuat:l3e,frustum:bde,perspective:c3e,perspectiveFromFieldOfView:u3e,ortho:$q,lookAt:C4,targetTo:wde,str:h3e,frob:d3e,add:p3e,subtract:xde,multiplyScalar:f3e,multiplyScalarAndAdd:m3e,exactEquals:g3e,equals:Tde,isOrthoNormal:Dq,mul:y3e,sub:v3e},Symbol.toStringTag,{value:"Module"}));let gk,re=null;function Sde(){return!!re}function _3e(){return!!he("esri-wasm")}function Ede(){return gk||(gk=import("./pe-wasm.41ba155b.js").then(e=>e.p).then(({default:e})=>e({locateFile:t=>Mi(`esri/geometry/support/${t}`)})).then(e=>{Ade(e)}),gk)}var HB,rs,qB;(function(e){function t(n,o,a){re.ensureCache.prepare();const l=P1(a),c=a===l,h=re.ensureFloat64(l),p=re._pe_geog_to_proj(re.getPointer(n),o,h);return p&&x0(a,o,h,c),p}function i(n,o,a,l){switch(l){case rs.PE_TRANSFORM_P_TO_G:return r(n,o,a);case rs.PE_TRANSFORM_G_TO_P:return t(n,o,a)}return 0}function r(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){re.ensureCache.prepare();const c=P1(a),h=a===c,p=re.ensureFloat64(c),f=re._pe_proj_to_geog_center(re.getPointer(n),o,p,l);return f&&x0(a,o,p,h),f}e.geogToProj=t,e.projGeog=i,e.projToGeog=r,e.projToGeogCenter=s})(HB||(HB={})),function(e){function t(){e.PE_BUFFER_MAX=re.PeDefs.prototype.PE_BUFFER_MAX,e.PE_NAME_MAX=re.PeDefs.prototype.PE_NAME_MAX,e.PE_MGRS_MAX=re.PeDefs.prototype.PE_MGRS_MAX,e.PE_USNG_MAX=re.PeDefs.prototype.PE_USNG_MAX,e.PE_DD_MAX=re.PeDefs.prototype.PE_DD_MAX,e.PE_DDM_MAX=re.PeDefs.prototype.PE_DDM_MAX,e.PE_DMS_MAX=re.PeDefs.prototype.PE_DMS_MAX,e.PE_UTM_MAX=re.PeDefs.prototype.PE_UTM_MAX,e.PE_PARM_MAX=re.PeDefs.prototype.PE_PARM_MAX,e.PE_TYPE_NONE=re.PeDefs.prototype.PE_TYPE_NONE,e.PE_TYPE_GEOGCS=re.PeDefs.prototype.PE_TYPE_GEOGCS,e.PE_TYPE_PROJCS=re.PeDefs.prototype.PE_TYPE_PROJCS,e.PE_TYPE_GEOGTRAN=re.PeDefs.prototype.PE_TYPE_GEOGTRAN,e.PE_TYPE_COORDSYS=re.PeDefs.prototype.PE_TYPE_COORDSYS,e.PE_TYPE_UNIT=re.PeDefs.prototype.PE_TYPE_UNIT,e.PE_TYPE_LINUNIT=re.PeDefs.prototype.PE_TYPE_LINUNIT,e.PE_STR_OPTS_NONE=re.PeDefs.prototype.PE_STR_OPTS_NONE,e.PE_STR_AUTH_NONE=re.PeDefs.prototype.PE_STR_AUTH_NONE,e.PE_STR_AUTH_TOP=re.PeDefs.prototype.PE_STR_AUTH_TOP,e.PE_STR_NAME_CANON=re.PeDefs.prototype.PE_STR_NAME_CANON,e.PE_PARM_X0=re.PeDefs.prototype.PE_PARM_X0,e.PE_PARM_ND=re.PeDefs.prototype.PE_PARM_ND,e.PE_TRANSFORM_1_TO_2=re.PeDefs.prototype.PE_TRANSFORM_1_TO_2,e.PE_TRANSFORM_2_TO_1=re.PeDefs.prototype.PE_TRANSFORM_2_TO_1,e.PE_TRANSFORM_P_TO_G=re.PeDefs.prototype.PE_TRANSFORM_P_TO_G,e.PE_TRANSFORM_G_TO_P=re.PeDefs.prototype.PE_TRANSFORM_G_TO_P,e.PE_HORIZON_RECT=re.PeDefs.prototype.PE_HORIZON_RECT,e.PE_HORIZON_POLY=re.PeDefs.prototype.PE_HORIZON_POLY,e.PE_HORIZON_LINE=re.PeDefs.prototype.PE_HORIZON_LINE,e.PE_HORIZON_DELTA=re.PeDefs.prototype.PE_HORIZON_DELTA}e.init=t}(rs||(rs={})),function(e){const t={},i={},r=m=>{if(m){const y=m.getType();switch(y){case rs.PE_TYPE_GEOGCS:m=re.castObject(m,re.PeGeogcs);break;case rs.PE_TYPE_PROJCS:m=re.castObject(m,re.PeProjcs);break;case rs.PE_TYPE_GEOGTRAN:m=re.castObject(m,re.PeGeogtran);break;default:y&rs.PE_TYPE_UNIT&&(m=re.castObject(m,re.PeUnit))}}return m};function s(){re.PeFactory.prototype.initialize(null)}function n(m){return o(rs.PE_TYPE_COORDSYS,m)}function o(m,y){let v=null,w=t[m];if(w||(w={},t[m]=w),w.hasOwnProperty(String(y)))v=w[y];else{const b=re.PeFactory.prototype.factoryByType(m,y);re.compare(b,re.NULL)||(v=b,w[y]=v)}return v=r(v),v}function a(m,y){let v=null,w=i[m];if(w||(w={},i[m]=w),w.hasOwnProperty(y))v=w[y];else{const b=re.PeFactory.prototype.fromString(m,y);re.compare(b,re.NULL)||(v=b,w[y]=v)}return v=r(v),v}function l(m){return o(rs.PE_TYPE_GEOGCS,m)}function c(m){return o(rs.PE_TYPE_GEOGTRAN,m)}function h(m){return re.PeFactory.prototype.getCode(m)}function p(m){return o(rs.PE_TYPE_PROJCS,m)}function f(m){return o(rs.PE_TYPE_UNIT,m)}e.initialize=s,e.coordsys=n,e.factoryByType=o,e.fromString=a,e.geogcs=l,e.geogtran=c,e.getCode=h,e.projcs=p,e.unit=f}(qB||(qB={}));let Cde=null;var hN,WB,XB,YB,dN,ZB,pN,fN,QB;function Ade(e){function t(n,o,a){n[o]=a(n[o])}re=e,rs.init(),hN.init(),dN.init(),pN.init(),fN.init(),Cde=class extends re.PeGCSExtent{destroy(){re.destroy(this)}};const i=[re.PeDatum,re.PeGeogcs,re.PeGeogtran,re.PeObject,re.PeParameter,re.PePrimem,re.PeProjcs,re.PeSpheroid,re.PeUnit];for(const n of i)t(n.prototype,"getName",o=>function(){return o.call(this,new Array(rs.PE_NAME_MAX))});for(const n of[re.PeGeogtran,re.PeProjcs])t(n.prototype,"getParameters",o=>function(){const a=new Array(rs.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=re.getValue(l,"*");a[c]=h?re.wrapPointer(h,re.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});t(re.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return x0(a,o,n.call(this)),a}),t(re.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=re._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+o*p,re.PeGTlistExtendedGTs))}}return a}});const r=re._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!re.compare(l,re.NULL)){a=[l];const c=l.getNump();if(c>1){const h=re.getPointer(l);for(let p=1;p<c;p++)a.push(re.wrapPointer(h+r*p,re.PeHorizon))}}return o.set(n,a),a};t(re.PeProjcs.prototype,"horizonGcsGenerate",s),t(re.PeProjcs.prototype,"horizonPcsGenerate",s),re.PeObject.prototype.toString=function(n=rs.PE_STR_OPTS_NONE){re.ensureCache.prepare();const o=re.getPointer(this),a=re.ensureInt8(new Array(rs.PE_BUFFER_MAX));return re.UTF8ToString(re._pe_object_to_string_ext(o,n,a))}}function qf(e){if(!e)return;const t=re.getClass(e);if(!t)return;const i=re.getCache(t);if(!i)return;const r=re.getPointer(e);r&&delete i[r]}function H3(e,t){const i=[],r=new Array(t);for(let s=0;s<e;s++)i.push(re.ensureInt8(r));return i}function P1(e){let t;return Array.isArray(e[0])?(t=[],e.forEach(i=>{t.push(i[0],i[1])})):t=e,t}function x0(e,t,i,r=!1){if(r)for(let s=0;s<2*t;s++)e[s]=re.getValue(i+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=e.length===0;for(let n=0;n<t;n++)s&&(e[n]=new Array(2)),e[n][0]=re.getValue(i,"double"),e[n][1]=re.getValue(i+Float64Array.BYTES_PER_ELEMENT,"double"),i+=2*Float64Array.BYTES_PER_ELEMENT}}(function(e){let t;function i(){e.PE_GTLIST_OPTS_COMMON=re.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,t=re._pe_getPeGTlistExtendedEntrySize()}function r(s,n,o,a,l,c){let h=null;const p=new re.PeInteger(c);try{const f=re.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const m=re.getPointer(f);for(let y=1;y<c;y++)h.push(re.wrapPointer(m+t*y,re.PeGTlistExtendedEntry))}}finally{re.destroy(p)}return h}e.init=i,e.getGTlist=r})(hN||(hN={})),function(e){function t(i){if(i&&i.length){for(const r of i)qf(r),r.getEntries().forEach(s=>{qf(s);const n=s.getGeogtran();qf(n),n.getParameters().forEach(qf),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{qf(o);const a=o.getDatum();qf(a),qf(a.getSpheroid()),qf(o.getPrimem()),qf(o.getUnit())})});re.PeGTlistExtendedEntry.prototype.Delete(i[0])}}e.destroy=t}(WB||(WB={})),function(e){function t(i,r,s,n,o){re.ensureCache.prepare();const a=P1(s),l=s===a,c=re.ensureFloat64(a);let h=0;n&&(h=re.ensureFloat64(n));const p=re._pe_geog_to_geog(re.getPointer(i),r,c,h,o);return p&&x0(s,r,c,l),p}e.geogToGeog=t}(XB||(XB={})),function(e){const t=(c,h,p,f,m,y)=>{let v,w;switch(re.ensureCache.prepare(),c){case"dd":v=re._pe_geog_to_dd,w=rs.PE_DD_MAX;break;case"ddm":v=re._pe_geog_to_ddm,w=rs.PE_DDM_MAX;break;case"dms":v=re._pe_geog_to_dms,w=rs.PE_DMS_MAX}let b=0;h&&(b=re.getPointer(h));const S=P1(f),T=re.ensureFloat64(S),E=H3(p,w),C=v(b,p,T,m,re.ensureInt32(E));if(C)for(let M=0;M<p;M++)y[M]=re.UTF8ToString(E[M]);return C},i=(c,h,p,f,m)=>{let y;switch(re.ensureCache.prepare(),c){case"dd":y=re._pe_dd_to_geog;break;case"ddm":y=re._pe_ddm_to_geog;break;case"dms":y=re._pe_dms_to_geog}let v=0;h&&(v=re.getPointer(h));const w=f.map(E=>re.ensureString(E)),b=re.ensureInt32(w),S=re.ensureFloat64(new Array(2*p)),T=y(v,p,b,S);return T&&x0(m,p,S),T};function r(c,h,p,f,m){return t("dms",c,h,p,f,m)}function s(c,h,p,f){return i("dms",c,h,p,f)}function n(c,h,p,f,m){return t("ddm",c,h,p,f,m)}function o(c,h,p,f){return i("ddm",c,h,p,f)}function a(c,h,p,f,m){return t("dd",c,h,p,f,m)}function l(c,h,p,f){return i("dd",c,h,p,f)}e.geogToDms=r,e.dmsToGeog=s,e.geogToDdm=n,e.ddmToGeog=o,e.geogToDd=a,e.ddToGeog=l}(YB||(YB={})),function(e){function t(){e.PE_MGRS_STYLE_NEW=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,e.PE_MGRS_STYLE_OLD=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,e.PE_MGRS_STYLE_AUTO=re.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,e.PE_MGRS_180_ZONE_1_PLUS=re.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,e.PE_MGRS_ADD_SPACES=re.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function i(s,n,o,a,l,c,h){re.ensureCache.prepare();let p=0;s&&(p=re.getPointer(s));const f=P1(o),m=re.ensureFloat64(f),y=H3(n,rs.PE_MGRS_MAX),v=re.ensureInt32(y),w=re._pe_geog_to_mgrs_extended(p,n,m,a,l,c,v);if(w)for(let b=0;b<n;b++)h[b]=re.UTF8ToString(y[b]);return w}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),m=re._pe_mgrs_to_geog_extended(c,n,p,a,f);return m&&x0(l,n,f),m}e.init=t,e.geogToMgrsExtended=i,e.mgrsToGeogExtended=r}(dN||(dN={})),function(e){function t(r,s,n,o,a,l,c){re.ensureCache.prepare();let h=0;r&&(h=re.getPointer(r));const p=P1(n),f=re.ensureFloat64(p),m=H3(s,rs.PE_MGRS_MAX),y=re.ensureInt32(m),v=re._pe_geog_to_usng(h,s,f,o,a,l,y);if(v)for(let w=0;w<s;w++)c[w]=re.UTF8ToString(m[w]);return v}function i(r,s,n,o){re.ensureCache.prepare();let a=0;r&&(a=re.getPointer(r));const l=n.map(f=>re.ensureString(f)),c=re.ensureInt32(l),h=re.ensureFloat64(new Array(2*s)),p=re._pe_usng_to_geog(a,s,c,h);return p&&x0(o,s,h),p}e.geogToUsng=t,e.usngToGeog=i}(ZB||(ZB={})),function(e){function t(){e.PE_UTM_OPTS_NONE=re.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,e.PE_UTM_OPTS_ADD_SPACES=re.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,e.PE_UTM_OPTS_NS=re.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function i(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=P1(o),p=re.ensureFloat64(h),f=H3(n,rs.PE_UTM_MAX),m=re.ensureInt32(f),y=re._pe_geog_to_utm(c,n,p,a,m);if(y)for(let v=0;v<n;v++)l[v]=re.UTF8ToString(f[v]);return y}function r(s,n,o,a,l){re.ensureCache.prepare();let c=0;s&&(c=re.getPointer(s));const h=o.map(y=>re.ensureString(y)),p=re.ensureInt32(h),f=re.ensureFloat64(new Array(2*n)),m=re._pe_utm_to_geog(c,n,p,a,f);return m&&x0(l,n,f),m}e.init=t,e.geogToUtm=i,e.utmToGeog=r}(pN||(pN={})),function(e){const t=new Map;function i(){e.PE_PCSINFO_OPTION_NONE=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,e.PE_PCSINFO_OPTION_DOMAIN=re.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,e.PE_POLE_OUTSIDE_BOUNDARY=re.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,e.PE_POLE_POINT=re.PePCSInfo.prototype.PE_POLE_POINT}function r(s,n=e.PE_PCSINFO_OPTION_DOMAIN){let o,a;return t.has(s)&&(a=t.get(s),a[n]&&(o=a[n])),o||(o=re.PePCSInfo.prototype.generate(s,n),a||(a=[],t.set(s,a)),a[n]=o),o}e.init=i,e.generate=r}(fN||(fN={})),function(e){function t(){return re.PeVersion.prototype.version_string()}e.versionString=t}(QB||(QB={}));const b3e=Object.freeze(Object.defineProperty({__proto__:null,get _pe(){return re},isLoaded:Sde,isSupported:_3e,load:Ede,get PeCSTransformations(){return HB},get PeDefs(){return rs},get PeFactory(){return qB},get PeGCSExtent(){return Cde},get PeGTlistExtended(){return hN},get PeGTlistExtendedEntry(){return WB},get PeGTTransformations(){return XB},get PeNotationDms(){return YB},get PeNotationMgrs(){return dN},get PeNotationUsng(){return ZB},get PeNotationUtm(){return pN},get PePCSInfo(){return fN},get PeVersion(){return QB},_init:Ade},Symbol.toStringTag,{value:"Module"})),B0t=Math.PI/180,G0t=/SPHEROID\[([^\]]+)]/i,Qg=Ei.radius,zh=Ei.eccentricitySquared,w3e={a1:Qg*zh,a2:Qg*zh*Qg*zh,a3:Qg*zh*zh/2,a4:Qg*zh*Qg*zh*2.5,a5:Qg*zh+Qg*zh*zh/2,a6:1-zh},j0t={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:Ei.radius,f:Ei.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:yg.radius,f:yg.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:cf.radius,f:cf.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:cf.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let q3=0;class tS{constructor(t=null){this.uid=q3++,t?(this._wkt=t.wkt!==void 0?t.wkt:null,this._wkid=t.wkid!==void 0?t.wkid:-1,this._isInverse=t.isInverse!==void 0&&t.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}static fromGE(t){const i=new tS;return i._wkt=t.wkt,i._wkid=t.wkid,i._isInverse=t.isInverse,i}get wkt(){return this._wkt}set wkt(t){this._wkt=t,this.uid=q3++}get wkid(){return this._wkid}set wkid(t){this._wkid=t,this.uid=q3++}get isInverse(){return this._isInverse}set isInverse(t){this._isInverse=t,this.uid=q3++}getInverse(){const t=new tS;return t._wkt=this.wkt,t._wkid=this._wkid,t._isInverse=!this.isInverse,t}}class N0{constructor(t){if(this.steps=[],this._cached_projection={},this._chain="",this._gtlistentry=null,t&&t.steps)for(const i of t.steps)i instanceof tS?this.steps.push(i):this.steps.push(new tS({wkid:i.wkid,wkt:i.wkt,isInverse:i.isInverse}))}static cacheKey(t,i){return[t.wkid!==void 0&&t.wkid!==null?t.wkid.toString():"-1",t.wkt!==void 0&&t.wkt!==null?t.wkt.toString():"",i.wkid!==void 0&&i.wkid!==null?i.wkid.toString():"-1",i.wkt!==void 0&&i.wkt!==null?i.wkt.toString():""].join(",")}static fromGE(t){const i=new N0;let r="";for(const s of t.steps){const n=tS.fromGE(s);i.steps.push(n),r+=n.uid.toString()+","}return i._cached_projection={},i._gtlistentry=null,i._chain=r,i}getInverse(){const t=new N0;t.steps=[];for(let i=this.steps.length-1;i>=0;i--){const r=this.steps[i];t.steps.push(r.getInverse())}return t}getGTListEntry(){let t="";for(const i of this.steps)t+=i.uid.toString()+",";return t!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=t),this._gtlistentry}assignCachedGe(t,i,r){this._cached_projection[N0.cacheKey(t,i)]=r}getCachedGeTransformation(t,i){let r="";for(const n of this.steps)r+=n.uid.toString()+",";r!==this._chain&&(this._gtlistentry=null,this._cached_projection={},this._chain=r);const s=this._cached_projection[N0.cacheKey(t,i)];return s===void 0?null:s}}function Rde(e,t,i){if(R(t)||R(i)||i.vcsWkid||ac(t,i))return null;const r=zS(t)/zS(i);if(r===1)return null;switch(e){case"point":case"esriGeometryPoint":return s=>x3e(s,r);case"polyline":case"esriGeometryPolyline":return s=>S3e(s,r);case"polygon":case"esriGeometryPolygon":return s=>T3e(s,r);case"multipoint":case"esriGeometryMultipoint":return s=>E3e(s,r);case"extent":case"esriGeometryExtent":return s=>C3e(s,r);default:return null}}function x3e(e,t){e&&e.z!=null&&(e.z*=t)}function T3e(e,t){if(e)for(const i of e.rings)for(const r of i)r.length>2&&(r[2]*=t)}function S3e(e,t){if(e)for(const i of e.paths)for(const r of i)r.length>2&&(r[2]*=t)}function E3e(e,t){if(e)for(const i of e.points)i.length>2&&(i[2]*=t)}function C3e(e,t){e&&e.zmin!=null&&e.zmax!=null&&(e.zmin*=t,e.zmax*=t)}let ev=null,mN=null,yk=null,vk={};const Mde=new bue;function Lq(){return!!ev&&Sde()}function gN(e){return R(yk)&&(yk=Promise.all([Ede(),import("./geometryEngineBase.f43341a0.js").then(t=>t.g),import("./hydrated.66823a44.js")])),yk.then(([,t,{hydratedAdapter:i}])=>{li(e),mN=i,ev=t.default,ev._enableProjection(b3e),Mde.notify()})}function AO(e,t,i=null,r=null){return Array.isArray(e)?e.length===0?[]:yJ(mN,e,e[0].spatialReference,t,i,r):yJ(mN,[e],e.spatialReference,t,i,r)[0]}function yJ(e,t,i,r,s=null,n=null){if(R(i)||R(r))return t;if(bg(i,r,s))return t.map(o=>Ode(o,i,r));if(R(s)){const o=N0.cacheKey(i,r);vk[o]!==void 0?s=vk[o]:(s=A3e(i,r,null),R(s)&&(s=new N0),vk[o]=s)}if(R(ev))throw new Nq;return _(n)?ev._project(e,t,i,r,s,n):ev._project(e,t,i,r,s)}function H0t(e,t){return R(e)?{pending:null,geometry:null}:ac(e.spatialReference,t)?{pending:null,geometry:e}:ul(e.spatialReference)&&ul(t)?bg(e.spatialReference,t)||Lq()?{pending:null,geometry:R3e(e,t)}:(Yt(Mde),{pending:gN(),geometry:null}):{pending:null,geometry:null}}function A3e(e,t,i=null){if(R(ev))throw new Nq;if(R(e)||R(t))return null;const r=ev._getTransformation(mN,e,t,i,i==null?void 0:i.spatialReference);return r!==null?N0.fromGE(r):null}class Nq extends q{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var Q;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",e[e.WGS84=2]="WGS84",e[e.WEB_MERCATOR=3]="WEB_MERCATOR",e[e.WGS84_ECEF=4]="WGS84_ECEF",e[e.CGCS2000=5]="CGCS2000",e[e.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",e[e.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",e[e.GCSMARS2000=8]="GCSMARS2000",e[e.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",e[e.GCSMOON2000=10]="GCSMOON2000",e[e.LON_LAT=11]="LON_LAT",e[e.PLATE_CARREE=12]="PLATE_CARREE"})(Q||(Q={}));function R3e(e,t){try{const i=AO(e,t);if(i==null)return null;"xmin"in e&&"xmin"in i&&(i.zmin=e.zmin,i.zmax=e.zmax);const r=Rde(i.type,e.spatialReference,t);return _(r)&&r(i),i}catch(i){if(!(i instanceof Nq))throw i;return null}}function bg(e,t,i){return!i&&(!!ac(e,t)||ul(e)&&ul(t)&&!!zq(e,t,Bq))}async function q0t(e,t,i,r){if(Lq())return sQ(r);if(Array.isArray(e)){for(const{source:s,dest:n,geographicTransformation:o}of e)if(!bg(s,n,o))return gN(r)}else if(!bg(e,t,i))return gN(r);return sQ(r)}function W0t(e,t){switch(zq(e,t,Bq)){case pr:return"copy3";case U0:return"wgs84ToSphericalECEF";case $b:return"wgs84ToWebMercator";case F0:return"wgs84ToPlateCarree";case z0:return"wgs84ToWGS84ECEF";case pb:return"webMercatorToWGS84";case Nde:return"webMercatorToSphericalECEF";case Fde:return"webMercatorToWGS84ECEF";case Ude:return"webMercatorToPlateCarree";case V0:return"wgs84ECEFToWGS84";case Vde:return"wgs84ECEFToSphericalECEF";case Bde:return"wgs84ECEFToWebMercator";case k0:return"sphericalECEFToWGS84";case kde:return"sphericalECEFToWebMercator";case t9:return"sphericalMarsPCPFToMars2000";case e9:return"sphericalMoonPCPFToMoon2000";case zde:return"sphericalECEFToWGS84ECEF";case KB:return"mars2000ToSphericalPCPF";case JB:return"moon2000ToSphericalPCPF";default:return null}}function Ode(e,t,i){return e?"x"in e?Pde(e,t,new nt,i,0):"xmin"in e?I3e(e,t,new ci,i,0):"rings"in e?Ide(e,t,new cu,i,0):"paths"in e?P3e(e,t,new Jc,i,0):"points"in e?O3e(e,t,new lw,i,0):null:null}function M3e(e,t,i=t.spatialReference,r=0){return!R(i)&&_(Pde(e,e.spatialReference,t,i,r))}function Pde(e,t,i,r,s){Ui[0]=e.x,Ui[1]=e.y;const n=e.z;return Ui[2]=n!==void 0?n:s,ar(Ui,t,0,Ui,r,0,1)?(i.x=Ui[0],i.y=Ui[1],i.spatialReference=r,n===void 0?(i.z=void 0,i.hasZ=!1):(i.z=Ui[2],i.hasZ=!0),e.m===void 0?(i.m=void 0,i.hasM=!1):(i.m=e.m,i.hasM=!0),i):null}function O3e(e,t,i,r,s){const{points:n,hasZ:o,hasM:a}=e,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!ar(h,t,0,h,r,0,c))return null;for(let p=0;p<c;++p){const f=3*p,m=h[f],y=h[f+1];o&&a?l.push([m,y,h[f+2],n[p][3]]):o?l.push([m,y,h[f+2]]):a?l.push([m,y,n[p][2]]):l.push([m,y])}return i.points=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i}function P3e(e,t,i,r,s){const{paths:n,hasZ:o,hasM:a}=e,l=[];return Dde(n,o,a,t,l,r,s)?(i.paths=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function X0t(e,t,i=t.spatialReference,r=0){return _(i)&&_(Ide(e,e.spatialReference,t,i,r))}function Ide(e,t,i,r,s){const{rings:n,hasZ:o,hasM:a}=e,l=[];return Dde(n,o,a,t,l,r,s)?(i.rings=l,i.spatialReference=r,i.hasZ=o,i.hasM=a,i):null}function I3e(e,t,i,r,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=e;return vJ(n,o,c?e.zmin:s,t,Ui,r)?(i.xmin=Ui[0],i.ymin=Ui[1],c&&(i.zmin=Ui[2]),vJ(a,l,c?e.zmax:s,t,Ui,r)?(i.xmax=Ui[0],i.ymax=Ui[1],c&&(i.zmax=Ui[2]),h&&(i.mmin=e.mmin,i.mmax=e.mmax),i.spatialReference=r,i):null):null}function mv(e,t,i){if(R(t)||R(i))return null;const r=new nt({spatialReference:i});return ar(e,t,0,Ui,i,0,1)?(r.x=Ui[0],r.y=Ui[1],r.z=Ui[2],r):null}function $de(e,t,i){return ar(e,t,0,Ui,i.spatialReference,0,1)?(i.x=Ui[0],i.y=Ui[1],i.z=Ui[2],i):null}function Mn(e,t,i,r=0){Ui[0]=e.x,Ui[1]=e.y;const s=e.z;return Ui[2]=s!==void 0?s:r,ar(Ui,e.spatialReference,0,t,i,0,1)}function vJ(e,t,i,r,s,n){return zr[0]=e,zr[1]=t,zr[2]=i,ar(zr,r,0,s,n,0,1)}function Js(e,t,i,r){return!(R(t)||R(r)||e.length<2)&&(e.length===2&&(zr[0]=e[0],zr[1]=e[1],zr[2]=0,e=zr),ar(e,t,0,i,r,0,1))}function $3e(e,t){Ui[0]=e.x,Ui[1]=e.y;const i=e.z;return Ui[2]=i!==void 0?i:0,D3e(Ui,e.spatialReference,t)}function D3e(e,t,i){return L3e(e,t,i)}function L3e(e,t,i){if(R(t))return!1;const r=gv(t,R4),s=af[r][Q.WGS84_COMPARABLE_LON_LAT];return!R(s)&&(s(e,0,zr,0),i!==zr&&(i[0]=zr[0],i[1]=zr[1],i.length>2&&(i[2]=zr[2])),!0)}function ar(e,t,i,r,s,n,o=1){const a=zq(t,s,Bq);if(R(a))return!1;if(a===pr){if(e===r&&i===n)return!0;const c=i+3*o;for(let h=i,p=n;h<c;h++,p++)r[p]=e[h];return!0}const l=i+3*o;for(let c=i,h=n;c<l;c+=3,h+=3)a(e,c,r,h);return!0}function Y0t(e,t,i,r,s){se(Ui,e),de(W3,e,t),Js(Ui,i,Ui,s),Js(W3,i,W3,s),pe(r,W3,Ui),we(r,r)}function Dde(e,t,i,r,s,n,o=0){const a=new Array;for(const c of e)for(const h of c)a.push(h[0],h[1],t?h[2]:o);if(!ar(a,r,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of e){const h=new Array;for(const p of c)t&&i?h.push([a[l++],a[l++],a[l++],p[3]]):t?h.push([a[l++],a[l++],a[l++]]):i?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function N3e(e,t,i,r){if(R(t)||R(r))return!1;const s=Gde(t,r,j3e);if(s.projector===pr)return i[0]=e[0],i[1]=e[1],i[2]=e[2],i[3]=e[3],!0;if(R(s.projector))return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===Q.WEB_MERCATOR){const a=af[n.spatialReferenceId][Q.WGS84];return!R(a)&&(a(e,0,gd,0),$b(gd,0,i,0),i[3]=_J(gd[1],e[2],e[3],Ei.radius),!0)}if(n.spatialReferenceId!==Q.WGS84&&n.spatialReferenceId!==Q.CGCS2000||o.spatialReferenceId!==Q.PLATE_CARREE)s.projector(e,0,i,0),i[3]=e[3]*n.metersPerUnit/o.metersPerUnit;else{const a=af[n.spatialReferenceId][Q.SPHERICAL_ECEF],l=af[Q.SPHERICAL_ECEF][Q.PLATE_CARREE];let c=e[3];_(a)&&_(l)&&(c=_J(e[1],e[2],e[3],Ei.radius)),s.projector(e,0,i,0),i[3]=c}return!0}function _J(e,t,i,r){const s=r+t;if(s<r/2||i>s)return Number.MAX_VALUE;const n=Math.abs(Ld*e)+Math.asin(i/s);return n>=Math.PI/2?Number.MAX_VALUE:i/Math.cos(n)}function A4(e,t,i,r){return e!=null&&(ac(t,r)?(vg(i,e),!0):(zr[0]=e[0],zr[1]=e[1],zr[2]=0,!!ar(zr,t,0,zr,r,0,1)&&(i[0]=zr[0],i[1]=zr[1],zr[0]=e[2],zr[1]=e[3],zr[2]=0,!!ar(zr,t,0,zr,r,0,1)&&(i[2]=zr[0],i[3]=zr[1],!0))))}function Z0t(e,t,i,r){if(R(t)||R(r))return!1;const s=gv(t,R4),n=gv(r,jde);if(s===n&&s!==Q.UNKNOWN||ac(t,r))return i[0]=1,i[1]=1,i[2]=1,!0;if(s===Q.SPHERICAL_ECEF){const o=Me(e),a=o/Math.sqrt(e[0]*e[0]+e[1]*e[1]),l=o/Ei.radius;if(n===Q.WEB_MERCATOR)return i[0]=a*l,i[1]=a*l,i[2]=1,!0;if(n===Q.WGS84||n===Q.CGCS2000){const c=iR;return i[0]=c*a*l,i[1]=c*l,i[2]=1,!0}}else if(s===Q.PLATE_CARREE){if(n===Q.WGS84||n===Q.CGCS2000)return i[0]=iR,i[1]=iR,i[2]=1,!0;if(n===Q.WEB_MERCATOR){const o=e[1]/Ei.radius;return i[0]=1,i[1]=1/Math.cos(o),i[2]=1,!0}}return!1}function fu(e,t,i,r){if(R(e)||R(r))return!1;const s=gv(e,R4),n=gv(r,jde);if(s===n&&!bJ(n)&&(s!==Q.UNKNOWN||ac(e,r)))return E4(i,t),!0;if(bJ(n)){const o=af[s][Q.LON_LAT],a=af[Q.LON_LAT][n];return!R(o)&&!R(a)&&(o(t,0,gd,0),a(gd,0,Jg,0),Lde(Ld*gd[0],Ld*gd[1],i),i[12]=Jg[0],i[13]=Jg[1],i[14]=Jg[2],!0)}if((n===Q.WEB_MERCATOR||n===Q.PLATE_CARREE)&&(s===Q.WGS84||s===Q.CGCS2000&&n===Q.PLATE_CARREE||s===Q.SPHERICAL_ECEF||s===Q.WEB_MERCATOR)){const o=af[s][Q.LON_LAT],a=af[Q.LON_LAT][n];return!R(o)&&!R(a)&&(o(t,0,gd,0),a(gd,0,Jg,0),s===Q.SPHERICAL_ECEF?F3e(Ld*gd[0],Ld*gd[1],i):Cf(i),i[12]=Jg[0],i[13]=Jg[1],i[14]=Jg[2],!0)}return!1}function bJ(e){return e===Q.SPHERICAL_ECEF||e===Q.SPHERICAL_MARS_PCPF||e===Q.SPHERICAL_MOON_PCPF}function Lde(e,t,i){const r=Math.sin(e),s=Math.cos(e),n=Math.sin(t),o=Math.cos(t),a=i;return a[0]=-r,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*r,a[9]=o*r,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function F3e(e,t,i){return Lde(e,t,i),dl(i,i),i}function gv(e,t){return t.spatialReference===e?t.spatialReferenceId:(t.spatialReference=e,"metersPerUnit"in t&&(t.metersPerUnit=cc(e,1)),e.wkt===nde.wkt?t.spatialReferenceId=Q.SPHERICAL_ECEF:jR(e)?t.spatialReferenceId=Q.WGS84:Cb(e)?t.spatialReferenceId=Q.WEB_MERCATOR:HR(e)?t.spatialReferenceId=Q.PLATE_CARREE:e.wkt===POe.wkt?t.spatialReferenceId=Q.WGS84_ECEF:e.wkid===dh.CGCS2000?t.spatialReferenceId=Q.CGCS2000:e.wkt===lN.wkt?t.spatialReferenceId=Q.SPHERICAL_MARS_PCPF:e.wkt===cN.wkt?t.spatialReferenceId=Q.SPHERICAL_MOON_PCPF:If(e)?t.spatialReferenceId=Q.GCSMARS2000:$f(e)?t.spatialReferenceId=Q.GCSMOON2000:t.spatialReferenceId=Q.UNKNOWN)}function pr(e,t,i,r){e!==i&&(i[r++]=e[t++],i[r++]=e[t++],i[r]=e[t])}function pb(e,t,i,r){i[r++]=GS*(e[t++]/Ei.radius),i[r++]=GS*(Math.PI/2-2*Math.atan(Math.exp(-e[t++]/Ei.radius))),i[r]=e[t]}function Nde(e,t,i,r){pb(e,t,i,r),U0(i,r,i,r)}function Fde(e,t,i,r){pb(e,t,i,r),z0(i,r,i,r)}function Fq(e,t,i,r,s){const n=.4999999*Math.PI,o=$e(Ld*e[t+1],-n,n),a=Math.sin(o);i[r++]=Ld*e[t]*s.radius,i[r++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),i[r]=e[t+2]}function $b(e,t,i,r){Fq(e,t,i,r,Ei)}const wJ=Ei.radius*Math.PI/180,iR=180/(Ei.radius*Math.PI);function F0(e,t,i,r){i[r]=e[t]*wJ,i[r+1]=e[t+1]*wJ,i[r+2]=e[t+2]}function q1(e,t,i,r){i[r]=e[t]*iR,i[r+1]=e[t+1]*iR,i[r+2]=e[t+2]}function Ude(e,t,i,r){pb(e,t,i,r),F0(i,r,i,r)}function U3e(e,t,i,r){V0(e,t,i,r),F0(i,r,i,r)}function k3e(e,t,i,r){k0(e,t,i,r),F0(i,r,i,r)}function z3e(e,t,i,r){q1(e,t,i,r),U0(i,r,i,r)}function V3e(e,t,i,r){q1(e,t,i,r),$b(i,r,i,r)}function B3e(e,t,i,r){q1(e,t,i,r),z0(i,r,i,r)}function Db(e){if(R(e))return!1;const t=gv(e,R4);return!!af[t][Q.WGS84_COMPARABLE_LON_LAT]}function xE(e,t,i,r){const s=Math.cos(i);e[0]=Math.cos(t)*s*r,e[1]=Math.sin(t)*s*r,e[2]=Math.sin(i)*r}function Uq(e,t,i,r,s){const n=s+e[t+2],o=Ld*e[t+1],a=Ld*e[t],l=Math.cos(o);i[r++]=Math.cos(a)*l*n,i[r++]=Math.sin(a)*l*n,i[r]=Math.sin(o)*n}function JB(e,t,i,r){Uq(e,t,i,r,yg.radius)}function KB(e,t,i,r){Uq(e,t,i,r,cf.radius)}function U0(e,t,i,r){Uq(e,t,i,r,Ei.radius)}function kq(e,t,i,r,s){const n=e[t],o=e[t+1],a=e[t+2],l=Math.sqrt(n*n+o*o+a*a),c=Hd(a/(l===0?1:l)),h=Math.atan2(o,n);i[r++]=GS*h,i[r++]=GS*c,i[r]=l-s}function e9(e,t,i,r){kq(e,t,i,r,yg.radius)}function t9(e,t,i,r){kq(e,t,i,r,cf.radius)}function k0(e,t,i,r){kq(e,t,i,r,Ei.radius)}function kde(e,t,i,r){k0(e,t,i,r),$b(i,r,i,r)}function zde(e,t,i,r){k0(e,t,i,r),z0(i,r,i,r)}function G3e(e,t,i,r,s){const n=Ld*e[t],o=Ld*e[t+1],a=e[t+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);i[r++]=(h+a)*c*Math.cos(n),i[r++]=(h+a)*c*Math.sin(n),i[r++]=(h*(1-s.eccentricitySquared)+a)*l}function z0(e,t,i,r){G3e(e,t,i,r,Ei)}function V0(e,t,i,r){const s=w3e,n=e[t],o=e[t+1],a=e[t+2];let l,c,h,p,f,m,y,v,w,b,S,T,E,C,M,I,N,D,z,V,k;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),V=Math.atan2(o,n),m=a*a/p,y=c/p,C=s.a2/f,M=s.a3-s.a4/f,y>.3?(v=l/f*(1+y*(s.a1+C+m*M)/f),z=Math.asin(v),b=v*v,w=Math.sqrt(1-b)):(w=h/f*(1-m*(s.a5-C-y*M)/f),z=Math.acos(w),b=1-w*w,v=Math.sqrt(b)),S=1-Ei.eccentricitySquared*b,T=Ei.radius/Math.sqrt(S),E=s.a6*T,C=h-T*w,M=l-E*v,N=w*C+v*M,I=w*M-v*C,D=I/(E/S+N),z+=D,k=N+I*D/2,a<0&&(z=-z),i[r++]=GS*V,i[r++]=GS*z,i[r]=k}function Vde(e,t,i,r){V0(e,t,i,r),U0(i,r,i,r)}function Bde(e,t,i,r){V0(e,t,i,r),$b(i,r,i,r)}const af={[Q.WGS84]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:pr,[Q.SPHERICAL_ECEF]:U0,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:$b,[Q.PLATE_CARREE]:F0,[Q.WGS84]:pr,[Q.WGS84_ECEF]:z0},[Q.CGCS2000]:{[Q.CGCS2000]:pr,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:pr,[Q.SPHERICAL_ECEF]:U0,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:F0,[Q.WGS84]:null,[Q.WGS84_ECEF]:z0},[Q.GCSMARS2000]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:pr,[Q.GCSMOON2000]:null,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:null,[Q.SPHERICAL_ECEF]:null,[Q.SPHERICAL_MARS_PCPF]:KB,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:null,[Q.WGS84]:null,[Q.WGS84_ECEF]:null},[Q.GCSMOON2000]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:pr,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:null,[Q.SPHERICAL_ECEF]:null,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:JB,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:null,[Q.WGS84]:null,[Q.WGS84_ECEF]:null},[Q.WEB_MERCATOR]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:pb,[Q.WGS84_COMPARABLE_LON_LAT]:pb,[Q.SPHERICAL_ECEF]:Nde,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:pr,[Q.PLATE_CARREE]:Ude,[Q.WGS84]:pb,[Q.WGS84_ECEF]:Fde},[Q.WGS84_ECEF]:{[Q.CGCS2000]:V0,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:V0,[Q.WGS84_COMPARABLE_LON_LAT]:V0,[Q.SPHERICAL_ECEF]:Vde,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:Bde,[Q.PLATE_CARREE]:U3e,[Q.WGS84]:V0,[Q.WGS84_ECEF]:pr},[Q.SPHERICAL_ECEF]:{[Q.CGCS2000]:k0,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:k0,[Q.WGS84_COMPARABLE_LON_LAT]:k0,[Q.SPHERICAL_ECEF]:pr,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:kde,[Q.PLATE_CARREE]:k3e,[Q.WGS84]:k0,[Q.WGS84_ECEF]:zde},[Q.SPHERICAL_MARS_PCPF]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:t9,[Q.GCSMOON2000]:null,[Q.LON_LAT]:t9,[Q.WGS84_COMPARABLE_LON_LAT]:null,[Q.SPHERICAL_ECEF]:null,[Q.SPHERICAL_MARS_PCPF]:pr,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:null,[Q.WGS84]:null,[Q.WGS84_ECEF]:null},[Q.SPHERICAL_MOON_PCPF]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:e9,[Q.LON_LAT]:e9,[Q.WGS84_COMPARABLE_LON_LAT]:null,[Q.SPHERICAL_ECEF]:null,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:pr,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:null,[Q.WGS84]:null,[Q.WGS84_ECEF]:null},[Q.UNKNOWN]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:null,[Q.WGS84_COMPARABLE_LON_LAT]:null,[Q.SPHERICAL_ECEF]:null,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:pr,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:null,[Q.WGS84]:null,[Q.WGS84_ECEF]:null},[Q.LON_LAT]:{[Q.CGCS2000]:pr,[Q.GCSMARS2000]:pr,[Q.GCSMOON2000]:pr,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:pr,[Q.SPHERICAL_ECEF]:U0,[Q.SPHERICAL_MARS_PCPF]:KB,[Q.SPHERICAL_MOON_PCPF]:JB,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:$b,[Q.PLATE_CARREE]:F0,[Q.WGS84]:pr,[Q.WGS84_ECEF]:z0},[Q.WGS84_COMPARABLE_LON_LAT]:{[Q.CGCS2000]:null,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:pr,[Q.WGS84_COMPARABLE_LON_LAT]:pr,[Q.SPHERICAL_ECEF]:U0,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:null,[Q.PLATE_CARREE]:F0,[Q.WGS84]:pr,[Q.WGS84_ECEF]:z0},[Q.PLATE_CARREE]:{[Q.CGCS2000]:q1,[Q.GCSMARS2000]:null,[Q.GCSMOON2000]:null,[Q.LON_LAT]:q1,[Q.WGS84_COMPARABLE_LON_LAT]:q1,[Q.SPHERICAL_ECEF]:z3e,[Q.SPHERICAL_MARS_PCPF]:null,[Q.SPHERICAL_MOON_PCPF]:null,[Q.UNKNOWN]:null,[Q.WEB_MERCATOR]:V3e,[Q.PLATE_CARREE]:pr,[Q.WGS84]:q1,[Q.WGS84_ECEF]:B3e}};function zq(e,t,i=Vq()){return R(e)||R(t)?null:Gde(e,t,i).projector}function Gde(e,t,i){if(R(e)||R(t)||i.source.spatialReference===e&&i.dest.spatialReference===t)return i;const r=gv(e,i.source),s=gv(t,i.dest);return r===Q.UNKNOWN&&s===Q.UNKNOWN?ac(e,t)?i.projector=pr:i.projector=null:i.projector=af[r][s],i}function Vq(){return{source:{spatialReference:null,spatialReferenceId:Q.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:Q.UNKNOWN,metersPerUnit:1},projector:pr}}const R4={spatialReference:null,spatialReferenceId:Q.UNKNOWN},jde={spatialReference:null,spatialReferenceId:Q.UNKNOWN},Bq=Vq(),j3e=Vq(),Ld=$t(1),GS=ec(1),zr=O(),gd=O(),Jg=O(),Ui=O(),W3=O();class $g{constructor(t){this.allocator=t,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&AS(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const t=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*xJ);this._items.length=Math.min(t,this._items.length),this._itemsPtr=0}_grow(){for(let t=0;t<Math.max(8,Math.min(this._items.length,xJ));t++)this._items.push(this.allocator())}}const xJ=1024;function Ae(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function fb(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8],e[9],e[10],e[11],e[12],e[13],e[14],e[15]]}function Gq(e,t,i,r,s,n,o,a,l,c,h,p,f,m,y,v){return[e,t,i,r,s,n,o,a,l,c,h,p,f,m,y,v]}function Hde(e,t){return new Float64Array(e,t,16)}const Ks=Ae();Object.freeze(Object.defineProperty({__proto__:null,create:Ae,clone:fb,fromValues:Gq,createView:Hde,IDENTITY:Ks},Symbol.toStringTag,{value:"Module"}));var su;(function(e){e[e.X=0]="X",e[e.Y=1]="Y",e[e.Z=2]="Z"})(su||(su={}));function H3e(e){return 32+e.length}function q3e(){return 16}function qde(e){if(!e)return 0;let t=32;for(const i in e)if(e.hasOwnProperty(i)){const r=e[i];switch(typeof r){case"string":t+=H3e(r);break;case"number":t+=q3e();break;case"boolean":t+=4}}return t}function Q0t(e,t){return 32+e.length*t}var jS;(function(e){e[e.KILOBYTES=1024]="KILOBYTES",e[e.MEGABYTES=1048576]="MEGABYTES",e[e.GIGABYTES=1073741824]="GIGABYTES"})(jS||(jS={}));function Sr(){return[1,0,0,0,1,0,0,0,1]}function W3e(e){return[e[0],e[1],e[2],e[3],e[4],e[5],e[6],e[7],e[8]]}function X3e(e,t,i,r,s,n,o,a,l){return[e,t,i,r,s,n,o,a,l]}function Wde(e,t){return new Float64Array(e,t,9)}Object.freeze(Object.defineProperty({__proto__:null,create:Sr,clone:W3e,fromValues:X3e,createView:Wde},Symbol.toStringTag,{value:"Module"}));function Dg(){return[0,0,0,1]}function Y3e(e){return[e[0],e[1],e[2],e[3]]}function Z3e(e,t,i,r){return[e,t,i,r]}function Xde(e,t){return new Float64Array(e,t,4)}const Q3e=Dg();Object.freeze(Object.defineProperty({__proto__:null,create:Dg,clone:Y3e,fromValues:Z3e,createView:Xde,IDENTITY:Q3e},Symbol.toStringTag,{value:"Module"}));function tt(){return[0,0]}function eA(e){return[e[0],e[1]]}function Oi(e,t){return[e,t]}function Yde(e){const t=tt(),i=Math.min(2,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function Zde(e,t){return new Float64Array(e,t,2)}function Qde(){return tt()}function Jde(){return Oi(1,1)}function Kde(){return Oi(1,0)}function epe(){return Oi(0,1)}const Sh=Qde(),tpe=Jde(),J3e=Kde(),K3e=epe();Object.freeze(Object.defineProperty({__proto__:null,create:tt,clone:eA,fromValues:Oi,fromArray:Yde,createView:Zde,zeros:Qde,ones:Jde,unitX:Kde,unitY:epe,ZEROS:Sh,ONES:tpe,UNIT_X:J3e,UNIT_Y:K3e},Symbol.toStringTag,{value:"Module"}));function Gt(){return[0,0,0,0]}function M4(e){return[e[0],e[1],e[2],e[3]]}function fi(e,t,i,r){return[e,t,i,r]}function jq(e){const t=Gt(),i=Math.min(4,e.length);for(let r=0;r<i;++r)t[r]=e[r];return t}function ipe(e,t){return new Float64Array(e,t,4)}function rpe(){return Gt()}function spe(){return fi(1,1,1,1)}function npe(){return fi(1,0,0,0)}function ope(){return fi(0,1,0,0)}function ape(){return fi(0,0,1,0)}function lpe(){return fi(0,0,0,1)}const hf=rpe(),ph=spe(),ePe=npe(),tPe=ope(),iPe=ape(),rPe=lpe();Object.freeze(Object.defineProperty({__proto__:null,create:Gt,clone:M4,fromValues:fi,fromArray:jq,createView:ipe,zeros:rpe,ones:spe,unitX:npe,unitY:ope,unitZ:ape,unitW:lpe,ZEROS:hf,ONES:ph,UNIT_X:ePe,UNIT_Y:tPe,UNIT_Z:iPe,UNIT_W:rPe},Symbol.toStringTag,{value:"Module"}));class jc{constructor(t,i,r){this.itemByteSize=t,this.itemCreate=i,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(r/this.itemByteSize)}get(){this._itemsPtr===0&&AS(()=>this._reset());const t=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=t;){const i=new ArrayBuffer(this._itemsPerBuffer*this.itemByteSize);for(let r=0;r<this._itemsPerBuffer;++r)this._items.push(this.itemCreate(i,r*this.itemByteSize));this._buffers.push(i)}return this._items[this._itemsPtr++]}_reset(){const t=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>t;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(t=Ew){return new jc(16,Zde,t)}static createVec3f64(t=Ew){return new jc(24,uH,t)}static createVec4f64(t=Ew){return new jc(32,ipe,t)}static createMat3f64(t=Ew){return new jc(72,Wde,t)}static createMat4f64(t=Ew){return new jc(128,Hde,t)}static createQuatf64(t=Ew){return new jc(32,Xde,t)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this.itemByteSize}}}const Ew=4*jS.KILOBYTES,J0t=jc.createVec2f64(),He=jc.createVec3f64(),Hq=jc.createVec4f64();jc.createMat3f64();const qq=jc.createMat4f64(),K0t=jc.createQuatf64();function Ff(e){return e?{origin:Is(e.origin),vector:Is(e.vector)}:{origin:O(),vector:O()}}function sPe(e,t){const i=oPe.get();return i.origin=e,i.vector=t,i}function evt(e,t=Ff()){return nPe(e.origin,e.vector,t)}function nPe(e,t,i=Ff()){return se(i.origin,e),se(i.vector,t),i}function mb(e,t,i=Ff()){return se(i.origin,e),pe(i.vector,t,e),i}function Wq(e,t){const i=pe(He.get(),t,e.origin),r=xe(e.vector,i),s=xe(e.vector,e.vector),n=$e(r/s,0,1),o=pe(He.get(),oe(He.get(),e.vector,n),i);return xe(o,o)}function tvt(e,t,i){return i9(e,t,0,1,i)}function ivt(e,t,i){return de(i,e.origin,oe(i,e.vector,t))}function i9(e,t,i,r,s){const{vector:n,origin:o}=e,a=pe(He.get(),t,o),l=xe(n,a)/ba(n);return oe(s,n,$e(l,i,r)),de(s,s,e.origin)}function rvt(e,t){if(upe(e,sPe(t.origin,t.direction),!1,yN)){const{tA:i,pB:r,distance2:s}=yN;if(i>=0&&i<=1)return s;if(i<0)return $s(e.origin,r);if(i>1)return $s(de(He.get(),e.origin,e.vector),r)}return null}function cpe(e,t,i){return!!upe(e,t,!0,yN)&&(se(i,yN.pA),!0)}function upe(e,t,i,r){const n=e.origin,o=de(He.get(),n,e.vector),a=t.origin,l=de(He.get(),a,t.vector),c=He.get(),h=He.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=He.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],m=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],y=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],v=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],w=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*v-m*m;if(Math.abs(w)<1e-6)return!1;let b=(f*m-y*v)/w,S=(f+m*b)/v;i&&(b=$e(b,0,1),S=$e(S,0,1));const T=He.get(),E=He.get();return T[0]=n[0]+b*p[0],T[1]=n[1]+b*p[1],T[2]=n[2]+b*p[2],E[0]=a[0]+S*h[0],E[1]=a[1]+S*h[1],E[2]=a[2]+S*h[2],r.tA=b,r.tB=S,r.pA=T,r.pB=E,r.distance2=$s(T,E),!0}const yN={tA:0,tB:0,pA:O(),pB:O(),distance2:0},oPe=new $g(()=>({origin:null,vector:null}));function Yn(e){return e?{origin:Is(e.origin),direction:Is(e.direction)}:{origin:O(),direction:O()}}function svt(e,t){return uv(e.origin,t.origin)&&uv(e.direction,t.direction)}function mu(e,t){const i=hPe.get();return i.origin=e,i.direction=t,i}function vN(e,t=Yn()){return hpe(e.origin,e.direction,t)}function aPe(e,t,i=Yn()){return se(i.origin,e),pe(i.direction,t,e),i}function hpe(e,t,i=Yn()){return se(i.origin,e),se(i.direction,t),i}function lPe(e,t){const i=lt(He.get(),we(He.get(),e.direction),pe(He.get(),t,e.origin));return xe(i,i)}function cPe(e,t,i){const r=xe(e.direction,pe(i,t,e.origin));return de(i,e.origin,oe(i,e.direction,r)),i}function uPe(){return{origin:null,direction:null}}const hPe=new $g(uPe);function rR(e,t){return xe(e,t)/Me(e)}function Xq(e,t){const i=xe(e,t)/(Me(e)*Me(t));return-tn(i)}function dPe(e,t,i){we(X3,e),we(_k,t);const r=xe(X3,_k),s=tn(r),n=lt(X3,X3,_k);return xe(n,i)<0?2*Math.PI-s:s}const X3=O(),_k=O(),pPe=me.getLogger("esri.geometry.support.sphere");function fn(){return Gt()}function HS(e,t=fn()){return Pd(t,e)}function dpe(e,t){return fi(e[0],e[1],e[2],t)}function fPe(e){return e}function ppe(e){e[0]=e[1]=e[2]=e[3]=0}function O4(e,t){return e[0]=e[1]=e[2]=0,e[3]=t,e}function sg(e){return e[3]}function mPe(e){return e}function fpe(e,t,i,r){return fi(e,t,i,r)}function gPe(e,t,i){return e!==i&&se(i,e),i[3]=e[3]+t,i}function yPe(e,t,i){return pPe.error("sphere.setExtent is not yet supported"),e===i?i:HS(e,i)}function Fv(e,t,i){if(R(t))return!1;const{origin:r,direction:s}=t,n=vPe;n[0]=r[0]-e[0],n[1]=r[1]-e[1],n[2]=r[2]-e[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2],a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-e[3]*e[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(i&&(i[0]=r[0]+s[0]*h,i[1]=r[1]+s[1]*h,i[2]=r[2]+s[2]*h),!0)}const vPe=O();function r9(e,t){return Fv(e,t,null)}function _Pe(e,t,i){if(Fv(e,t,i))return i;const r=q2(e,t,He.get());return de(i,t.origin,oe(He.get(),t.direction,nr(t.origin,r)/Me(t.direction))),i}function q2(e,t,i){const r=He.get(),s=qq.get();lt(r,t.origin,t.direction);const n=sg(e);lt(i,r,t.origin),oe(i,i,1/Me(i)*n);const o=ype(e,t.origin),a=Xq(t.origin,i);return pu(s,a+o,r),Ue(i,i,s),i}function bPe(e,t,i){return Fv(e,t,i)?i:(cPe(t,e,i),mpe(e,i,i))}function mpe(e,t,i){const r=pe(He.get(),t,e),s=oe(He.get(),r,e[3]/Me(r));return de(i,s,e)}function gpe(e,t){const i=pe(He.get(),t,e),r=ba(i),s=e[3]*e[3];return Math.sqrt(Math.abs(r-s))}function ype(e,t){const i=pe(He.get(),t,e),r=Me(i),s=sg(e),n=s+Math.abs(s-r);return tn(s/n)}const bk=O();function vpe(e,t,i,r){const s=pe(bk,t,e);switch(i){case su.X:{const n=QZ(s,bk)[2];return ie(r,-Math.sin(n),Math.cos(n),0)}case su.Y:{const n=QZ(s,bk),o=n[1],a=n[2],l=Math.sin(o);return ie(r,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case su.Z:return we(r,s);default:return}}function _pe(e,t){const i=pe(s9,t,e);return Me(i)-e[3]}function wPe(e,t,i,r){const s=_pe(e,t),n=vpe(e,t,su.Z,s9),o=oe(s9,n,i-s);return de(r,t,o)}function xPe(e,t){const i=$s(e,t),r=sg(e);return i<=r*r}const s9=O(),P4=fn(),TPe=Object.freeze(Object.defineProperty({__proto__:null,create:fn,copy:HS,fromCenterAndRadius:dpe,wrap:fPe,clear:ppe,fromRadius:O4,getRadius:sg,getCenter:mPe,fromValues:fpe,elevate:gPe,setExtent:yPe,intersectRay:Fv,intersectsRay:r9,intersectRayClosestSilhouette:_Pe,closestPointOnSilhouette:q2,closestPoint:bPe,projectPoint:mpe,distanceToSilhouette:gpe,angleToSilhouette:ype,axisAt:vpe,altitudeAt:_pe,setAltitudeAt:wPe,containsPoint:xPe,tmpSphere:P4},Symbol.toStringTag,{value:"Module"}));function Lb(e){const t=e[0]*e[0]+e[4]*e[4]+e[8]*e[8],i=e[1]*e[1]+e[5]*e[5]+e[9]*e[9],r=e[2]*e[2]+e[6]*e[6]+e[10]*e[10];return Math.sqrt(Math.max(t,i,r))}function SPe(e,t){const i=Math.sqrt(t[0]*t[0]+t[4]*t[4]+t[8]*t[8]),r=Math.sqrt(t[1]*t[1]+t[5]*t[5]+t[9]*t[9]),s=Math.sqrt(t[2]*t[2]+t[6]*t[6]+t[10]*t[10]);return ie(e,i,r,s),e}function nvt(e,t,i){i=i||e;const r=xe(e,t);ie(i,e[0]-r*t[0],e[1]-r*t[1],e[2]-r*t[2]),we(i,i)}function ovt(e,t,i){Math.abs(e[0])>Math.abs(e[1])?ie(t,0,1,0):ie(t,1,0,0),lt(i,e,t),we(t,t),lt(t,i,e),we(i,i)}function EPe(e,t){return(e%t+t)%t}function Y3(e,t,i,r,s,n){const o=e+(t-e)*s;return o+(i+(r-i)*s-o)*n}function CPe(e,t,i,r=O()){const s=Me(e),n=Me(t),o=xe(e,t)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-i)*s+i*n)/Math.sin(a),c=l/s*Math.sin((1-i)*a),h=l/n*Math.sin(i*a);return oe(W1,e,c),oe(X1,t,h),de(r,W1,X1)}return en(r,e,t,i)}function avt(e,t,i,r=O(),s=O()){const n=Me(e),o=Me(t),a=xe(e,t)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(i*l),p=Math.sin((1-i)*l),f=(1-i)*n+i*o;{const m=f/c,y=m/o*h;oe(W1,e,m/n*p),oe(X1,t,y),de(r,W1,X1)}{const m=1/n*(-Math.cos((1-i)*l)*l*f+p*(-n+o));oe(W1,e,m);const y=1/o*(Math.cos(i*l)*l*f+h*(-n+o));oe(X1,t,y),de(s,W1,X1),oe(s,s,1/c)}return s}return en(r,e,t,i),pe(s,t,e),we(s,s),s}function tD(e,t,i){e=we(W1,e),t=we(X1,t);const r=tn(xe(e,t));if(i){const s=lt(APe,e,t);if(xe(s,i)<0)return-r}return r}function iD(e){const t=e.length;return i=>{if(i<=e[0][0])return e[0][1];if(i>=e[t-1][0])return e[t-1][1];let r=1;for(;i>e[r][0];)r++;const s=e[r-1][0],n=e[r][0],o=(n-i)/(n-s);return o*e[r-1][1]+(1-o)*e[r][1]}}function lvt(e,t,i,r){pe(TJ,t,e),pe(SJ,i,e),lt(r,TJ,SJ),we(r,r),r[3]=-xe(e,r)}const TJ=O(),SJ=O(),APe=O(),W1=O(),X1=O();function gi(e=tA){return[e[0],e[1],e[2],e[3]]}function RPe(e=tA[0],t=tA[1],i=tA[2],r=tA[3]){return Yq(e,t,i,r,Hq.get())}function I4(e,t){return Yq(t[0],t[1],t[2],t[3],e)}function Yq(e,t,i,r,s=gi()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function bpe(e,t,i){return se(i,e),i[3]=t,i}function qS(e,t,i){const r=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],s=Math.abs(r-1)>1e-5&&r>1e-12?1/Math.sqrt(r):1;return i[0]=t[0]*s,i[1]=t[1]*s,i[2]=t[2]*s,i[3]=-(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]),i}function Bo(e,t,i,r=gi()){const s=i[0]-t[0],n=i[1]-t[1],o=i[2]-t[2],a=e[0]-t[0],l=e[1]-t[1],c=e[2]-t[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,m=h*h+p*p+f*f,y=Math.abs(m-1)>1e-5&&m>1e-12?1/Math.sqrt(m):1;return r[0]=h*y,r[1]=p*y,r[2]=f*y,r[3]=-(r[0]*e[0]+r[1]*e[1]+r[2]*e[2]),r}function wpe(e,t,i,r,s){if(e.count<3)return!1;e.getVec(i,TE);let n=r,o=!1;for(;n<e.count-1&&!o;)e.getVec(n,Cw),n++,o=!tl(TE,Cw);if(!o)return!1;for(n=Math.max(n,s),o=!1;n<e.count&&!o;)e.getVec(n,I1),n++,pe(Z3,TE,Cw),we(Z3,Z3),pe(Q3,Cw,I1),we(Q3,Q3),o=!tl(TE,I1)&&!tl(Cw,I1)&&Math.abs(xe(Z3,Q3))<MPe;return o?(Bo(TE,Cw,I1,t),!0):(i!==0||r!==1||s!==2)&&wpe(e,t,0,1,2)}const MPe=.99619469809,TE=O(),Cw=O(),I1=O(),Z3=O(),Q3=O();function n9(e,t,i){return t!==e&&I4(e,t),e[3]=-xe(e,i),e}function o9(e,t){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function iM(e,t,i,r){return lt(I1,t,e),qS(i,I1,r)}function cvt(e,t,i,r){return $4(e,t,pe(He.get(),i,t),NPe,r)}function gw(e,t,i){return!!_(t)&&$4(e,t.origin,t.direction,FPe,i)}function OPe(e,t,i){return $4(e,t.origin,t.vector,df.NONE,i)}function PPe(e,t,i){return $4(e,t.origin,t.vector,df.CLAMP,i)}function xpe(e,t){return ir(e,t)>=0}function IPe(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];return e[0]*(e[0]>0?i:n)+e[1]*(e[1]>0?r:o)+e[2]*(e[2]>0?s:a)+e[3]>=0}function $Pe(e,t){const i=xe(e,t.ray.direction),r=-ir(e,t.ray.origin);if(r<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return r>0;if((r<0||i<0)&&!(r<0&&i<0))return!0;const s=r/i;return i>0?s<t.c1&&(t.c1=s):s>t.c0&&(t.c0=s),t.c0<=t.c1}function DPe(e,t){const i=xe(e,t.ray.direction),r=-ir(e,t.ray.origin);if(i>-1e-6&&i<1e-6)return r>0;const s=r/i;return i>0?s<t.c1&&(t.c1=s):s>t.c0&&(t.c0=s),t.c0<=t.c1}function LPe(e,t,i){const r=oe(He.get(),e,-e[3]),s=a9(e,pe(He.get(),t,r),He.get());return de(i,s,r),i}function a9(e,t,i){const r=oe(He.get(),e,xe(e,t));return pe(i,t,r),i}function ir(e,t){return xe(e,t)+e[3]}function $4(e,t,i,r,s){const n=xe(e,i);if(n===0)return!1;let o=-(xe(e,t)+e[3])/n;return r&df.CLAMP&&(o=$e(o,0,1)),!(!(r&df.INFINITE_MIN)&&o<0||!(r&df.INFINITE_MAX)&&o>1)&&(de(s,t,oe(s,i,o)),!0)}function uvt(e){return e}const tA=[0,0,1,0];var df;(function(e){e[e.NONE=0]="NONE",e[e.CLAMP=1]="CLAMP",e[e.INFINITE_MIN=4]="INFINITE_MIN",e[e.INFINITE_MAX=8]="INFINITE_MAX"})(df||(df={}));const NPe=df.INFINITE_MIN|df.INFINITE_MAX,FPe=df.INFINITE_MAX,wk=me.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");class Tpe{constructor(){this.plane=gi(),this.origin=O(),this.basis1=O(),this.basis2=O()}}function Uv(e=Dpe){return{plane:gi(e.plane),origin:Is(e.origin),basis1:Is(e.basis1),basis2:Is(e.basis2)}}function UPe(e,t,i){const r=ZPe.get();return r.origin=e,r.basis1=t,r.basis2=i,r.plane=RPe(0,0,0,0),D4(r),r}function yw(e,t=Uv()){return Zq(e.origin,e.basis1,e.basis2,t)}function kPe(e,t){se(t.origin,e.origin),se(t.basis1,e.basis1),se(t.basis2,e.basis2),I4(t.plane,e.plane)}function Zq(e,t,i,r=Uv()){return se(r.origin,e),se(r.basis1,t),se(r.basis2,i),D4(r),XPe(r,"fromValues()"),r}function D4(e){iM(e.basis2,e.basis1,e.origin,e.plane)}function Spe(e,t,i){e!==i&&yw(e,i);const r=oe(He.get(),wg(e),t);return de(i.origin,i.origin,r),i.plane[3]-=t,i}function zPe(e,t,i){return Epe(t,i),Spe(i,eW(e,e.origin),i),i}function Epe(e,t=Uv()){const i=(e[2]-e[0])/2,r=(e[3]-e[1])/2;return ie(t.origin,e[0]+i,e[1]+r,0),ie(t.basis1,i,0,0),ie(t.basis2,0,r,0),Yq(0,0,1,0,t.plane),t}function Qq(e,t,i){return!!gw(e.plane,t,i)&&Ipe(e,i)}function VPe(e,t,i){if(Qq(e,t,i))return i;const r=Cpe(e,t,He.get());return de(i,t.origin,oe(He.get(),t.direction,nr(t.origin,r)/Me(t.direction))),i}function Cpe(e,t,i){const r=_N.get();$pe(e,t,r,_N.get());let s=Number.POSITIVE_INFINITY;for(const n of iW){const o=tW(e,n,L4.get()),a=He.get();if(OPe(r,o,a)){const l=Og(He.get(),t.origin,a),c=Math.abs(tn(xe(t.direction,l)));c<s&&(s=c,se(i,a))}}return s===Number.POSITIVE_INFINITY?Ape(e,t,i):i}function Ape(e,t,i){if(Qq(e,t,i))return i;const r=_N.get(),s=_N.get();$pe(e,t,r,s);let n=Number.POSITIVE_INFINITY;for(const o of iW){const a=tW(e,o,L4.get()),l=He.get();if(PPe(r,a,l)){const c=lPe(t,l);if(!xpe(s,l))continue;c<n&&(n=c,se(i,l))}}return Jq(e,t.origin)<n&&Rpe(e,t.origin,i),i}function Rpe(e,t,i){const r=LPe(e.plane,t,He.get()),s=i9(EJ(e,e.basis1),r,-1,1,He.get()),n=i9(EJ(e,e.basis2),r,-1,1,He.get());return pe(i,de(He.get(),s,n),e.origin),i}function Mpe(e,t,i){const{origin:r,basis1:s,basis2:n}=e,o=pe(He.get(),t,r),a=rR(s,o),l=rR(n,o),c=rR(wg(e),o);return ie(i,a,l,c)}function Jq(e,t){const i=Mpe(e,t,He.get()),{basis1:r,basis2:s}=e,n=Me(r),o=Me(s),a=Math.max(Math.abs(i[0])-n,0),l=Math.max(Math.abs(i[1])-o,0),c=i[2];return a*a+l*l+c*c}function BPe(e,t){return Math.sqrt(Jq(e,t))}function GPe(e,t){let i=Number.NEGATIVE_INFINITY;for(const r of iW){const s=tW(e,r,L4.get()),n=Wq(s,t);n>i&&(i=n)}return Math.sqrt(i)}function Kq(e,t){return xpe(e.plane,t)&&Ipe(e,t)}function jPe(e,t,i,r){return WPe(e,i,r)}function eW(e,t){const i=-e.plane[3];return rR(wg(e),t)-i}function HPe(e,t,i,r){const s=eW(e,t),n=oe(YPe,wg(e),i-s);return de(r,t,n),r}function Ope(e,t){return tl(e.basis1,t.basis1)&&tl(e.basis2,t.basis2)&&tl(e.origin,t.origin)}function Ppe(e,t,i){return e!==i&&yw(e,i),cs(Aw,t),dl(Aw,Aw),Ue(i.basis1,e.basis1,Aw),Ue(i.basis2,e.basis2,Aw),Ue(i.plane,e.plane,Aw),Ue(i.origin,e.origin,t),n9(i.plane,i.plane,i.origin),i}function qPe(e,t,i,r){return e!==r&&yw(e,r),pu(xk,t,i),Ue(r.basis1,e.basis1,xk),Ue(r.basis2,e.basis2,xk),D4(r),r}function wg(e){return e.plane}function WPe(e,t,i){switch(t){case su.X:se(i,e.basis1),we(i,i);break;case su.Y:se(i,e.basis2),we(i,i);break;case su.Z:se(i,wg(e))}return i}function Ipe(e,t){const i=pe(He.get(),t,e.origin),r=ba(e.basis1),s=ba(e.basis2),n=xe(e.basis1,i),o=xe(e.basis2,i);return-n-r<0&&n-r<0&&-o-s<0&&o-s<0}function EJ(e,t){const i=L4.get();return se(i.origin,e.origin),se(i.vector,t),i}function tW(e,t,i){const{basis1:r,basis2:s,origin:n}=e,o=oe(He.get(),r,t.origin[0]),a=oe(He.get(),s,t.origin[1]);de(i.origin,o,a),de(i.origin,i.origin,n);const l=oe(He.get(),r,t.direction[0]),c=oe(He.get(),s,t.direction[1]);return oe(i.vector,de(l,l,c),2),i}function XPe(e,t){Math.abs(xe(e.basis1,e.basis2)/(Me(e.basis1)*Me(e.basis2)))>1e-6&&wk.warn(t,"Provided basis vectors are not perpendicular"),Math.abs(xe(e.basis1,wg(e)))>1e-6&&wk.warn(t,"Basis vectors and plane normal are not perpendicular"),Math.abs(-xe(wg(e),e.origin)-e.plane[3])>1e-6&&wk.warn(t,"Plane offset is not consistent with plane origin")}function $pe(e,t,i,r){const s=wg(e);iM(s,t.direction,t.origin,i),iM(i,s,t.origin,r)}const Dpe={plane:gi(),origin:Fe(0,0,0),basis1:Fe(1,0,0),basis2:Fe(0,1,0)},_N=new $g(gi),L4=new $g(Ff),YPe=O(),ZPe=new $g(()=>({origin:null,basis1:null,basis2:null,plane:null})),iW=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],Aw=Ae(),xk=Ae(),QPe=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:Tpe,create:Uv,wrap:UPe,copy:yw,copyWithoutVerify:kPe,fromValues:Zq,updateUnboundedPlane:D4,elevate:Spe,setExtent:zPe,fromAABoundingRect:Epe,intersectRay:Qq,intersectRayClosestSilhouette:VPe,closestPointOnSilhouette:Cpe,closestPoint:Ape,projectPoint:Rpe,projectPointLocal:Mpe,distance2:Jq,distance:BPe,distanceToSilhouette:GPe,extrusionContainsPoint:Kq,axisAt:jPe,altitudeAt:eW,setAltitudeAt:HPe,equals:Ope,transform:Ppe,rotate:qPe,normal:wg,UP:Dpe},Symbol.toStringTag,{value:"Module"}));function JPe(e){const{value:t,operations:i}=e;return{operations:i,value:i.create(t)}}function KPe(e,t,i){return e.operations.setExtent(e.value,t,i.value),i}function eIe(e){return{operations:e,value:e.create()}}function Lpe(e,t,i=eIe(e)){return i.operations=e,e.copy(t,i.value),i}function tIe(e){return Lpe(TPe,fpe(0,0,0,vi(e).radius))}const CJ=2**50;function iIe(){return Lpe(QPe,Zq([0,0,0],[CJ,0,0],[0,CJ,0]))}function rIe(e,t,i){return e.operations.axisAt(e.value,t,su.Z,i)}function sIe(e,t,i,r){return e.operations.axisAt(e.value,t,i,r)}function nIe(e,t,i){return e.operations.intersectRay(e.value,t,i)}function oIe(e,t,i){return e.operations.intersectRayClosestSilhouette(e.value,t,i)}function aIe(e,t){return e.operations.altitudeAt(e.value,t)}function Npe(e,t,i,r){return e.operations.setAltitudeAt(e.value,t,i,r)}function lIe(e,t,i,r){return t!==r&&ms(r,t),ie(Rw,r[12],r[13],r[14]),Npe(e,Rw,i,Rw),r[12]=Rw[0],r[13]=Rw[1],r[14]=Rw[2],r}function Tk(e,t,i){return e.operations.elevate(e.value,t,i.value)}const Rw=O();function AJ(e,t,i,r,s){return s[0]=xe(e,t),s[1]=xe(e,i),s[2]=xe(e,r),s}function l9(e,t,i,r,s){se(i,e),se(J3,t),we(J3,J3),lt(r,J3,i),lt(s,r,i)}function Fpe(e,t){return e?Ef(t):t.isGeographic?Xe.PlateCarree:t}const J3=O(),Upe=96;function hvt(e,t){const i=t||e.extent,r=e.width,s=cc(i&&i.spatialReference);return i&&r?i.width/r*s*ode*Upe:0}function kpe(e,t){return e/(cc(t)*ode*Upe)}function sR(e){const t=e==null?void 0:e.type;return t==="base-tile"||t==="tile"||t==="elevation"||t==="imagery-tile"||t==="base-elevation"||t==="open-street-map"||t==="wcs"||t==="web-tile"||t==="wmts"||t==="vector-tile"}function RJ(e){return(e==null?void 0:e.type)==="voxel"}function MJ(e){return(e==null?void 0:e.type)==="imagery-tile"}function zpe(e){var t;return((t=e.parent)==null?void 0:t.declaredClass)==="esri.Basemap"&&e.parent.baseLayers.includes(e)}function rW(e){var t;return(e==null?void 0:e.type)==="feature"&&!e.url&&((t=e.source)==null?void 0:t.type)==="memory"}function dvt(e){var t;return(e==null?void 0:e.type)==="feature"&&((t=e.source)==null?void 0:t.type)==="feature-layer"}function c9(e){return e.labelsVisible===!0&&e.labelingInfo!=null&&e.labelingInfo.length>0}function cIe(e){if(e.activeLayer){const t=e.activeLayer.tileMatrixSet;if(t)return t;const i=e.activeLayer.tileMatrixSets;if(i)return i}return null}const uIe=me.getLogger("esri.support.AnalysesCollection");let WS=class extends eR{constructor(e){super(e),this.handles.add(this.on("before-add",t=>{R(t.item)||t.item.parent===this.owner&&(uIe.warn("Analysis inside the collection must be unique. Not adding this element again."),t.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};WS=u([P("esri.support.AnalysesCollection")],WS);const rD={widthBreakpoint:{getValue(e){const t=e.viewSize[0],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(e){const t=e.viewSize[1],i=e.breakpoints,r=this.values;return t<=i.xsmall?r.xsmall:t<=i.small?r.small:t<=i.medium?r.medium:t<=i.large?r.large:r.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(e){const t=e.viewSize,i=t[0],r=t[1],s=this.values;return r>=i?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},Sk={xsmall:544,small:768,medium:992,large:1200};function hIe(e){const t=e;return t&&t.xsmall<t.small&&t.small<t.medium&&t.medium<t.large}function Ek(e,t){return t?rD[e].valueToClassName[t].split(" "):[]}const dIe=e=>{let t=class extends e{constructor(...i){super(...i),this._breakpointsHandles=new qt,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=Sk}initialize(){this._breakpointsHandles.add(ae(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),Ft))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=ot(this._breakpointsHandles))}set breakpoints(i){if(i===this._get("breakpoints"))return;const r=hIe(i);if(!r){const s=JSON.stringify(Sk,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}i=r?i:Sk,this._set("breakpoints",F({},i))}_updateClassNames(){if(!this.container)return;const i=Vl.acquire(),r=Vl.acquire();let s,n=!1;for(s in rD){const o=this[s],a=rD[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,Ek(s,o).forEach(l=>r.push(l)),Ek(s,a).forEach(l=>i.push(l)))}n&&(this._applyClassNameChanges(i,r),Vl.release(i),Vl.release(r))}_applyClassNameChanges(i,r){const s=this.container;s&&(r.forEach(n=>s.classList.remove(n)),i.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const i=this.container;if(!i)return;let r;for(r in rD)Ek(r,this[r]).forEach(s=>i.classList.remove(s))}};return u([d()],t.prototype,"breakpoints",null),u([d()],t.prototype,"orientation",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),u([d()],t.prototype,"heightBreakpoint",void 0),t=u([P("esri.views.BreakpointsOwner")],t),t};/*!
 * @esri/arcgis-html-sanitizer - v2.10.0 - Tue Mar 15 2022 16:38:25 GMT-0400 (Eastern Daylight Time)
 * Copyright (c) 2022 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2017 Zongmin Lei() <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 * 
 * Lodash/isPlainObject
 * Copyright (c) JS Foundation and other contributors <https://js.foundation/>
 * MIT License, see https://raw.githubusercontent.com/lodash/lodash/4.17.10-npm/LICENSE for details
 */var pIe="[object Object]";function fIe(e){var t=!1;if(e!=null&&typeof e.toString!="function")try{t=!!(e+"")}catch{}return t}function mIe(e,t){return function(i){return e(t(i))}}var gIe=Function.prototype,Vpe=Object.prototype,Bpe=gIe.toString,yIe=Vpe.hasOwnProperty,vIe=Bpe.call(Object),_Ie=Vpe.toString,bIe=mIe(Object.getPrototypeOf,Object);function wIe(e){return!!e&&typeof e=="object"}function xIe(e){if(!wIe(e)||_Ie.call(e)!=pIe||fIe(e))return!1;var t=bIe(e);if(t===null)return!0;var i=yIe.call(t,"constructor")&&t.constructor;return typeof i=="function"&&i instanceof i&&Bpe.call(i)==vIe}var TIe=xIe,$1={exports:{}},Fs={},rM={exports:{}},vw={};function Gpe(){var e={};return e["align-content"]=!1,e["align-items"]=!1,e["align-self"]=!1,e["alignment-adjust"]=!1,e["alignment-baseline"]=!1,e.all=!1,e["anchor-point"]=!1,e.animation=!1,e["animation-delay"]=!1,e["animation-direction"]=!1,e["animation-duration"]=!1,e["animation-fill-mode"]=!1,e["animation-iteration-count"]=!1,e["animation-name"]=!1,e["animation-play-state"]=!1,e["animation-timing-function"]=!1,e.azimuth=!1,e["backface-visibility"]=!1,e.background=!0,e["background-attachment"]=!0,e["background-clip"]=!0,e["background-color"]=!0,e["background-image"]=!0,e["background-origin"]=!0,e["background-position"]=!0,e["background-repeat"]=!0,e["background-size"]=!0,e["baseline-shift"]=!1,e.binding=!1,e.bleed=!1,e["bookmark-label"]=!1,e["bookmark-level"]=!1,e["bookmark-state"]=!1,e.border=!0,e["border-bottom"]=!0,e["border-bottom-color"]=!0,e["border-bottom-left-radius"]=!0,e["border-bottom-right-radius"]=!0,e["border-bottom-style"]=!0,e["border-bottom-width"]=!0,e["border-collapse"]=!0,e["border-color"]=!0,e["border-image"]=!0,e["border-image-outset"]=!0,e["border-image-repeat"]=!0,e["border-image-slice"]=!0,e["border-image-source"]=!0,e["border-image-width"]=!0,e["border-left"]=!0,e["border-left-color"]=!0,e["border-left-style"]=!0,e["border-left-width"]=!0,e["border-radius"]=!0,e["border-right"]=!0,e["border-right-color"]=!0,e["border-right-style"]=!0,e["border-right-width"]=!0,e["border-spacing"]=!0,e["border-style"]=!0,e["border-top"]=!0,e["border-top-color"]=!0,e["border-top-left-radius"]=!0,e["border-top-right-radius"]=!0,e["border-top-style"]=!0,e["border-top-width"]=!0,e["border-width"]=!0,e.bottom=!1,e["box-decoration-break"]=!0,e["box-shadow"]=!0,e["box-sizing"]=!0,e["box-snap"]=!0,e["box-suppress"]=!0,e["break-after"]=!0,e["break-before"]=!0,e["break-inside"]=!0,e["caption-side"]=!1,e.chains=!1,e.clear=!0,e.clip=!1,e["clip-path"]=!1,e["clip-rule"]=!1,e.color=!0,e["color-interpolation-filters"]=!0,e["column-count"]=!1,e["column-fill"]=!1,e["column-gap"]=!1,e["column-rule"]=!1,e["column-rule-color"]=!1,e["column-rule-style"]=!1,e["column-rule-width"]=!1,e["column-span"]=!1,e["column-width"]=!1,e.columns=!1,e.contain=!1,e.content=!1,e["counter-increment"]=!1,e["counter-reset"]=!1,e["counter-set"]=!1,e.crop=!1,e.cue=!1,e["cue-after"]=!1,e["cue-before"]=!1,e.cursor=!1,e.direction=!1,e.display=!0,e["display-inside"]=!0,e["display-list"]=!0,e["display-outside"]=!0,e["dominant-baseline"]=!1,e.elevation=!1,e["empty-cells"]=!1,e.filter=!1,e.flex=!1,e["flex-basis"]=!1,e["flex-direction"]=!1,e["flex-flow"]=!1,e["flex-grow"]=!1,e["flex-shrink"]=!1,e["flex-wrap"]=!1,e.float=!1,e["float-offset"]=!1,e["flood-color"]=!1,e["flood-opacity"]=!1,e["flow-from"]=!1,e["flow-into"]=!1,e.font=!0,e["font-family"]=!0,e["font-feature-settings"]=!0,e["font-kerning"]=!0,e["font-language-override"]=!0,e["font-size"]=!0,e["font-size-adjust"]=!0,e["font-stretch"]=!0,e["font-style"]=!0,e["font-synthesis"]=!0,e["font-variant"]=!0,e["font-variant-alternates"]=!0,e["font-variant-caps"]=!0,e["font-variant-east-asian"]=!0,e["font-variant-ligatures"]=!0,e["font-variant-numeric"]=!0,e["font-variant-position"]=!0,e["font-weight"]=!0,e.grid=!1,e["grid-area"]=!1,e["grid-auto-columns"]=!1,e["grid-auto-flow"]=!1,e["grid-auto-rows"]=!1,e["grid-column"]=!1,e["grid-column-end"]=!1,e["grid-column-start"]=!1,e["grid-row"]=!1,e["grid-row-end"]=!1,e["grid-row-start"]=!1,e["grid-template"]=!1,e["grid-template-areas"]=!1,e["grid-template-columns"]=!1,e["grid-template-rows"]=!1,e["hanging-punctuation"]=!1,e.height=!0,e.hyphens=!1,e.icon=!1,e["image-orientation"]=!1,e["image-resolution"]=!1,e["ime-mode"]=!1,e["initial-letters"]=!1,e["inline-box-align"]=!1,e["justify-content"]=!1,e["justify-items"]=!1,e["justify-self"]=!1,e.left=!1,e["letter-spacing"]=!0,e["lighting-color"]=!0,e["line-box-contain"]=!1,e["line-break"]=!1,e["line-grid"]=!1,e["line-height"]=!1,e["line-snap"]=!1,e["line-stacking"]=!1,e["line-stacking-ruby"]=!1,e["line-stacking-shift"]=!1,e["line-stacking-strategy"]=!1,e["list-style"]=!0,e["list-style-image"]=!0,e["list-style-position"]=!0,e["list-style-type"]=!0,e.margin=!0,e["margin-bottom"]=!0,e["margin-left"]=!0,e["margin-right"]=!0,e["margin-top"]=!0,e["marker-offset"]=!1,e["marker-side"]=!1,e.marks=!1,e.mask=!1,e["mask-box"]=!1,e["mask-box-outset"]=!1,e["mask-box-repeat"]=!1,e["mask-box-slice"]=!1,e["mask-box-source"]=!1,e["mask-box-width"]=!1,e["mask-clip"]=!1,e["mask-image"]=!1,e["mask-origin"]=!1,e["mask-position"]=!1,e["mask-repeat"]=!1,e["mask-size"]=!1,e["mask-source-type"]=!1,e["mask-type"]=!1,e["max-height"]=!0,e["max-lines"]=!1,e["max-width"]=!0,e["min-height"]=!0,e["min-width"]=!0,e["move-to"]=!1,e["nav-down"]=!1,e["nav-index"]=!1,e["nav-left"]=!1,e["nav-right"]=!1,e["nav-up"]=!1,e["object-fit"]=!1,e["object-position"]=!1,e.opacity=!1,e.order=!1,e.orphans=!1,e.outline=!1,e["outline-color"]=!1,e["outline-offset"]=!1,e["outline-style"]=!1,e["outline-width"]=!1,e.overflow=!1,e["overflow-wrap"]=!1,e["overflow-x"]=!1,e["overflow-y"]=!1,e.padding=!0,e["padding-bottom"]=!0,e["padding-left"]=!0,e["padding-right"]=!0,e["padding-top"]=!0,e.page=!1,e["page-break-after"]=!1,e["page-break-before"]=!1,e["page-break-inside"]=!1,e["page-policy"]=!1,e.pause=!1,e["pause-after"]=!1,e["pause-before"]=!1,e.perspective=!1,e["perspective-origin"]=!1,e.pitch=!1,e["pitch-range"]=!1,e["play-during"]=!1,e.position=!1,e["presentation-level"]=!1,e.quotes=!1,e["region-fragment"]=!1,e.resize=!1,e.rest=!1,e["rest-after"]=!1,e["rest-before"]=!1,e.richness=!1,e.right=!1,e.rotation=!1,e["rotation-point"]=!1,e["ruby-align"]=!1,e["ruby-merge"]=!1,e["ruby-position"]=!1,e["shape-image-threshold"]=!1,e["shape-outside"]=!1,e["shape-margin"]=!1,e.size=!1,e.speak=!1,e["speak-as"]=!1,e["speak-header"]=!1,e["speak-numeral"]=!1,e["speak-punctuation"]=!1,e["speech-rate"]=!1,e.stress=!1,e["string-set"]=!1,e["tab-size"]=!1,e["table-layout"]=!1,e["text-align"]=!0,e["text-align-last"]=!0,e["text-combine-upright"]=!0,e["text-decoration"]=!0,e["text-decoration-color"]=!0,e["text-decoration-line"]=!0,e["text-decoration-skip"]=!0,e["text-decoration-style"]=!0,e["text-emphasis"]=!0,e["text-emphasis-color"]=!0,e["text-emphasis-position"]=!0,e["text-emphasis-style"]=!0,e["text-height"]=!0,e["text-indent"]=!0,e["text-justify"]=!0,e["text-orientation"]=!0,e["text-overflow"]=!0,e["text-shadow"]=!0,e["text-space-collapse"]=!0,e["text-transform"]=!0,e["text-underline-position"]=!0,e["text-wrap"]=!0,e.top=!1,e.transform=!1,e["transform-origin"]=!1,e["transform-style"]=!1,e.transition=!1,e["transition-delay"]=!1,e["transition-duration"]=!1,e["transition-property"]=!1,e["transition-timing-function"]=!1,e["unicode-bidi"]=!1,e["vertical-align"]=!1,e.visibility=!1,e["voice-balance"]=!1,e["voice-duration"]=!1,e["voice-family"]=!1,e["voice-pitch"]=!1,e["voice-range"]=!1,e["voice-rate"]=!1,e["voice-stress"]=!1,e["voice-volume"]=!1,e.volume=!1,e["white-space"]=!1,e.widows=!1,e.width=!0,e["will-change"]=!1,e["word-break"]=!0,e["word-spacing"]=!0,e["word-wrap"]=!0,e["wrap-flow"]=!1,e["wrap-through"]=!1,e["writing-mode"]=!1,e["z-index"]=!1,e}function SIe(e,t,i){}function EIe(e,t,i){}var CIe=/javascript\s*\:/img;function AIe(e,t){return CIe.test(t)?"":t}vw.whiteList=Gpe();vw.getDefaultWhiteList=Gpe;vw.onAttr=SIe;vw.onIgnoreAttr=EIe;vw.safeAttrValue=AIe;var RIe={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(e){return String.prototype.trimRight?e.trimRight():e.replace(/(\s*$)/g,"")}},SE=RIe;function MIe(e,t){e=SE.trimRight(e),e[e.length-1]!==";"&&(e+=";");var i=e.length,r=!1,s=0,n=0,o="";function a(){if(!r){var h=SE.trim(e.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=SE.trim(h.slice(0,p)),m=SE.trim(h.slice(p+1));if(f){var y=t(s,o.length,f,m,h);y&&(o+=y+"; ")}}}s=n+1}for(;n<i;n++){var l=e[n];if(l==="/"&&e[n+1]==="*"){var c=e.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,r=!1}else l==="("?r=!0:l===")"?r=!1:l===";"?r||a():l===`
`&&a()}return SE.trim(o)}var OIe=MIe,K3=vw,PIe=OIe;function OJ(e){return e==null}function IIe(e){var t={};for(var i in e)t[i]=e[i];return t}function jpe(e){e=IIe(e||{}),e.whiteList=e.whiteList||K3.whiteList,e.onAttr=e.onAttr||K3.onAttr,e.onIgnoreAttr=e.onIgnoreAttr||K3.onIgnoreAttr,e.safeAttrValue=e.safeAttrValue||K3.safeAttrValue,this.options=e}jpe.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onAttr,n=i.onIgnoreAttr,o=i.safeAttrValue,a=PIe(e,function(l,c,h,p,f){var m=r[h],y=!1;if(m===!0?y=m:typeof m=="function"?y=m(p):m instanceof RegExp&&(y=m.test(p)),y!==!0&&(y=!1),p=o(h,p),!!p){var v={position:c,sourcePosition:l,source:f,isWhite:y};if(y){var w=s(h,p,v);return OJ(w)?h+":"+p:w}else{var w=n(h,p,v);if(!OJ(w))return w}}});return a};var $Ie=jpe;(function(e,t){var i=vw,r=$Ie;function s(o,a){var l=new r(a);return l.process(o)}t=e.exports=s,t.FilterCSS=r;for(var n in i)t[n]=i[n]})(rM,rM.exports);var sW={indexOf:function(e,t){var i,r;if(Array.prototype.indexOf)return e.indexOf(t);for(i=0,r=e.length;i<r;i++)if(e[i]===t)return i;return-1},forEach:function(e,t,i){var r,s;if(Array.prototype.forEach)return e.forEach(t,i);for(r=0,s=e.length;r<s;r++)t.call(i,e[r],r,e)},trim:function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(e){var t=/\s|\n|\t/,i=t.exec(e);return i?i.index:-1}},DIe=rM.exports.FilterCSS,LIe=rM.exports.getDefaultWhiteList,bN=sW;function Hpe(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var qpe=new DIe;function NIe(e,t,i){}function FIe(e,t,i){}function UIe(e,t,i){}function kIe(e,t,i){}function Wpe(e){return e.replace(VIe,"&lt;").replace(BIe,"&gt;")}function zIe(e,t,i,r){if(i=Kpe(i),t==="href"||t==="src"){if(i=bN.trim(i),i==="#")return"#";if(!(i.substr(0,7)==="http://"||i.substr(0,8)==="https://"||i.substr(0,7)==="mailto:"||i.substr(0,4)==="tel:"||i.substr(0,11)==="data:image/"||i.substr(0,6)==="ftp://"||i.substr(0,2)==="./"||i.substr(0,3)==="../"||i[0]==="#"||i[0]==="/"))return""}else if(t==="background"){if(eP.lastIndex=0,eP.test(i))return""}else if(t==="style"){if(PJ.lastIndex=0,PJ.test(i)||(IJ.lastIndex=0,IJ.test(i)&&(eP.lastIndex=0,eP.test(i))))return"";r!==!1&&(r=r||qpe,i=r.process(i))}return i=efe(i),i}var VIe=/</g,BIe=/>/g,GIe=/"/g,jIe=/&quot;/g,HIe=/&#([a-zA-Z0-9]*);?/gim,qIe=/&colon;?/gim,WIe=/&newline;?/gim,eP=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a)\:/gi,PJ=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,IJ=/u\s*r\s*l\s*\(.*/gi;function Xpe(e){return e.replace(GIe,"&quot;")}function Ype(e){return e.replace(jIe,'"')}function Zpe(e){return e.replace(HIe,function(i,r){return r[0]==="x"||r[0]==="X"?String.fromCharCode(parseInt(r.substr(1),16)):String.fromCharCode(parseInt(r,10))})}function Qpe(e){return e.replace(qIe,":").replace(WIe," ")}function Jpe(e){for(var t="",i=0,r=e.length;i<r;i++)t+=e.charCodeAt(i)<32?" ":e.charAt(i);return bN.trim(t)}function Kpe(e){return e=Ype(e),e=Zpe(e),e=Qpe(e),e=Jpe(e),e}function efe(e){return e=Xpe(e),e=Wpe(e),e}function XIe(){return""}function YIe(e,t){typeof t!="function"&&(t=function(){});var i=!Array.isArray(e);function r(o){return i?!0:bN.indexOf(e,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(r(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return t(o,a,l)},remove:function(o){var a="",l=0;return bN.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function ZIe(e){for(var t="",i=0;i<e.length;){var r=e.indexOf("<!--",i);if(r===-1){t+=e.slice(i);break}t+=e.slice(i,r);var s=e.indexOf("-->",r);if(s===-1)break;i=s+3}return t}function QIe(e){var t=e.split("");return t=t.filter(function(i){var r=i.charCodeAt(0);return r===127?!1:r<=31?r===10||r===13:!0}),t.join("")}Fs.whiteList=Hpe();Fs.getDefaultWhiteList=Hpe;Fs.onTag=NIe;Fs.onIgnoreTag=FIe;Fs.onTagAttr=UIe;Fs.onIgnoreTagAttr=kIe;Fs.safeAttrValue=zIe;Fs.escapeHtml=Wpe;Fs.escapeQuote=Xpe;Fs.unescapeQuote=Ype;Fs.escapeHtmlEntities=Zpe;Fs.escapeDangerHtml5Entities=Qpe;Fs.clearNonPrintableCharacter=Jpe;Fs.friendlyAttrValue=Kpe;Fs.escapeAttrValue=efe;Fs.onIgnoreTagStripAll=XIe;Fs.StripTagBody=YIe;Fs.stripCommentTag=ZIe;Fs.stripBlankChar=QIe;Fs.cssFilter=qpe;Fs.getDefaultCSSWhiteList=LIe;var N4={},h0=sW;function JIe(e){var t=h0.spaceIndex(e);if(t===-1)var i=e.slice(1,-1);else var i=e.slice(1,t+1);return i=h0.trim(i).toLowerCase(),i.slice(0,1)==="/"&&(i=i.slice(1)),i.slice(-1)==="/"&&(i=i.slice(0,-1)),i}function KIe(e){return e.slice(0,2)==="</"}function e$e(e,t,i){var r="",s=0,n=!1,o=!1,a=0,l=e.length,c="",h="";e:for(a=0;a<l;a++){var p=e.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){r+=i(e.slice(s,a)),n=a,s=a;continue}if(p===">"){r+=i(e.slice(s,n)),h=e.slice(n,a+1),c=JIe(h),r+=t(n,r.length,c,h,KIe(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,m=e.charAt(a-f);m.trim()===""||m==="=";){if(m==="="){o=p;continue e}m=e.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<e.length&&(r+=i(e.substr(s))),r}var t$e=/[^a-zA-Z0-9_:\.\-]/gim;function i$e(e,t){var i=0,r=[],s=!1,n=e.length;function o(p,f){if(p=h0.trim(p),p=p.replace(t$e,"").toLowerCase(),!(p.length<1)){var m=t(p,f||"");m&&r.push(m)}}for(var a=0;a<n;a++){var l=e.charAt(a),c,h;if(s===!1&&l==="="){s=e.slice(i,a),i=a+1;continue}if(s!==!1&&a===i&&(l==='"'||l==="'")&&e.charAt(a-1)==="="){if(h=e.indexOf(l,a+1),h===-1)break;c=h0.trim(e.slice(i+1,h)),o(s,c),s=!1,a=h,i=a+1;continue}if(/\s|\n|\t/.test(l))if(e=e.replace(/\s|\n|\t/g," "),s===!1)if(h=r$e(e,a),h===-1){c=h0.trim(e.slice(i,a)),o(c),s=!1,i=a+1;continue}else{a=h-1;continue}else if(h=s$e(e,a-1),h===-1){c=h0.trim(e.slice(i,a)),c=$J(c),o(s,c),s=!1,i=a+1;continue}else continue}return i<e.length&&(s===!1?o(e.slice(i)):o(s,$J(h0.trim(e.slice(i))))),h0.trim(r.join(" "))}function r$e(e,t){for(;t<e.length;t++){var i=e[t];if(i!==" ")return i==="="?t:-1}}function s$e(e,t){for(;t>0;t--){var i=e[t];if(i!==" ")return i==="="?t:-1}}function n$e(e){return e[0]==='"'&&e[e.length-1]==='"'||e[0]==="'"&&e[e.length-1]==="'"}function $J(e){return n$e(e)?e.substr(1,e.length-2):e}N4.parseTag=e$e;N4.parseAttr=i$e;var o$e=rM.exports.FilterCSS,yd=Fs,tfe=N4,a$e=tfe.parseTag,l$e=tfe.parseAttr,sD=sW;function tP(e){return e==null}function c$e(e){var t=sD.spaceIndex(e);if(t===-1)return{html:"",closing:e[e.length-2]==="/"};e=sD.trim(e.slice(t+1,-1));var i=e[e.length-1]==="/";return i&&(e=sD.trim(e.slice(0,-1))),{html:e,closing:i}}function u$e(e){var t={};for(var i in e)t[i]=e[i];return t}function ife(e){e=u$e(e||{}),e.stripIgnoreTag&&(e.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),e.onIgnoreTag=yd.onIgnoreTagStripAll),e.whiteList=e.whiteList||e.allowList||yd.whiteList,e.onTag=e.onTag||yd.onTag,e.onTagAttr=e.onTagAttr||yd.onTagAttr,e.onIgnoreTag=e.onIgnoreTag||yd.onIgnoreTag,e.onIgnoreTagAttr=e.onIgnoreTagAttr||yd.onIgnoreTagAttr,e.safeAttrValue=e.safeAttrValue||yd.safeAttrValue,e.escapeHtml=e.escapeHtml||yd.escapeHtml,this.options=e,e.css===!1?this.cssFilter=!1:(e.css=e.css||{},this.cssFilter=new o$e(e.css))}ife.prototype.process=function(e){if(e=e||"",e=e.toString(),!e)return"";var t=this,i=t.options,r=i.whiteList,s=i.onTag,n=i.onIgnoreTag,o=i.onTagAttr,a=i.onIgnoreTagAttr,l=i.safeAttrValue,c=i.escapeHtml,h=t.cssFilter;i.stripBlankChar&&(e=yd.stripBlankChar(e)),i.allowCommentTag||(e=yd.stripCommentTag(e));var p=!1;if(i.stripIgnoreTagBody){var p=yd.StripTagBody(i.stripIgnoreTagBody,n);n=p.onIgnoreTag}var f=a$e(e,function(m,y,v,w,b){var S={sourcePosition:m,position:y,isClosing:b,isWhite:r.hasOwnProperty(v)},T=s(v,w,S);if(!tP(T))return T;if(S.isWhite){if(S.isClosing)return"</"+v+">";var E=c$e(w),C=r[v],M=l$e(E.html,function(N,D){var z=sD.indexOf(C,N)!==-1,V=o(v,N,D,z);if(!tP(V))return V;if(z)return D=l(v,N,D,h),D?N+'="'+D+'"':N;var V=a(v,N,D,z);return tP(V)?void 0:V}),w="<"+v;return M&&(w+=" "+M),E.closing&&(w+=" /"),w+=">",w}else{var T=n(v,w,S);return tP(T)?c(w):T}},c);return p&&(f=p.remove(f)),f};var h$e=ife;(function(e,t){var i=Fs,r=N4,s=h$e;function n(l,c){var h=new s(c);return h.process(l)}t=e.exports=n,t.filterXSS=n,t.FilterXSS=s;for(var o in i)t[o]=i[o];for(var o in r)t[o]=r[o];function a(){return typeof self!="undefined"&&typeof DedicatedWorkerGlobalScope!="undefined"&&self instanceof DedicatedWorkerGlobalScope}a()&&(self.filterXSS=e.exports)})($1,$1.exports);var d$e=function(){function e(t,i){var r=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?r.sanitizeUrl(a):$1.exports.safeAttrValue(n,o,a,l)}};var s;t&&!i?s=t:t&&i?(s=Object.create(this.arcgisFilterOptions),Object.keys(t).forEach(function(n){n==="whiteList"?s.whiteList=r._extendObjectOfArrays([r.arcgisWhiteList,t.whiteList||{}]):s[n]=t[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new $1.exports.FilterXSS(s)}return e.prototype.sanitize=function(t,i){switch(i===void 0&&(i={}),typeof t){case"number":return isNaN(t)||!isFinite(t)?null:t;case"boolean":return t;case"string":return this._xssFilter.process(t);case"object":return this._iterateOverObject(t,i);default:return i.allowUndefined&&typeof t=="undefined"?void 0:null}},e.prototype.sanitizeUrl=function(t,i){var r=(i!=null?i:{}).isProtocolRequired,s=r===void 0?!0:r,n=this._trim(t.substring(0,t.indexOf(":"))),o=t==="/",a=/^#/.test(t),l=n&&this.allowedProtocols.indexOf(n.toLowerCase())>-1;return o||a||l?$1.exports.escapeAttrValue(t):!n&&!s?$1.exports.escapeAttrValue("https://".concat(t)):""},e.prototype.sanitizeHTMLAttribute=function(t,i,r,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(t,i,r,s):$1.exports.safeAttrValue(t,i,r,s)},e.prototype.validate=function(t,i){i===void 0&&(i={});var r=this.sanitize(t,i);return{isValid:t===r,sanitized:r}},e.prototype._extendObjectOfArrays=function(t){var i={};return t.forEach(function(r){Object.keys(r).forEach(function(s){Array.isArray(r[s])&&Array.isArray(i[s])?i[s]=i[s].concat(r[s]):i[s]=r[s]})}),i},e.prototype._iterateOverObject=function(t,i){var r=this;i===void 0&&(i={});try{var s=!1,n=void 0;if(Array.isArray(t))n=t.reduce(function(a,l){var c=r.validate(l,i);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(TIe(t)){var o=Object.keys(t);n=o.reduce(function(a,l){var c=t[l],h=r.validate(c,i);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return i.allowUndefined&&typeof t=="undefined"?void 0:null;return s?n:t}catch{return null}},e.prototype._trim=function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},e}();const F4=new Map;function rfe(){F4.clear()}function p$e(e){return F4.get(e)}function f$e(e,t){F4.set(e,t)}function Ck(e){F4.delete(e)}var Nb,XS,m$e=function(e){if("WebkitTransition"in e.style)Nb="webkitTransitionEnd",XS="webkitAnimationEnd";else{if(!("transition"in e.style))throw new Error("Your browser is not supported!");Nb="transitionend",XS="animationend"}},sfe=function(e){Nb||m$e(e)},g$e=function(e,t){return t===void 0&&(t=e+"-active"),function(i){sfe(i);var r=!1,s=function(n){r||(r=!0,i.removeEventListener(Nb,s),i.removeEventListener(XS,s),i.classList.remove(e),i.classList.remove(t))};i.classList.add(e),i.addEventListener(Nb,s),i.addEventListener(XS,s),requestAnimationFrame(function(){i.classList.add(t)})}},y$e=function(e,t){return t===void 0&&(t=e+"-active"),function(i,r){sfe(i);var s=!1,n=function(o){s||(s=!0,i.removeEventListener(Nb,n),i.removeEventListener(XS,n),r())};i.classList.add(e),i.addEventListener(Nb,n),i.addEventListener(XS,n),requestAnimationFrame(function(){i.classList.add(t)})}};const v$e=me.getLogger("esri.widgets.support.widgetUtils");function nfe(e){const t=Vl.acquire();for(let r=0;r<arguments.length;r++){const s=arguments[r],n=typeof s;if(n==="string")t.push(s);else if(Array.isArray(s))t.push.apply(t,s);else if(n==="object")for(const o in s)s[o]&&t.push(o)}const i=t.join(" ");return Vl.release(t),i}(()=>{const e=new Map,t=new ResizeObserver(i=>{rfe();for(const r of i)e.get(r.target)(r)});return(i,r,s)=>(e.has(i)&&v$e.error("Already observing element",i),e.set(i,r),t.observe(i,s),Th(()=>{t.unobserve(i),e.delete(i)}))})();function B0(e){const t=e==null?void 0:e.closest("[dir]");return t!==null&&t instanceof HTMLElement&&t.dir==="rtl"||document.dir==="rtl"}function DJ(e){const t="data-node-ref";this[e.getAttribute(t)]=null}function u9(e){const t="data-node-ref";this[e.getAttribute(t)]=e}function _$e(e,t){return(e==="enter"?g$e:y$e)(t)}const b$e=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],w$e=b$e.reduce((e,t)=>(e[t]=[],e),{}),x$e=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],ofe=new d$e({whiteList:w$e,onTagAttr:(e,t,i)=>{const r=`${t}="${i}"`;if(x$e.includes(t))return r},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function T$e(e){return e==="Enter"||e===" "}const afe="http://www.w3.org/",U4=`${afe}2000/svg`,lfe=`${afe}1999/xlink`;let wN,LJ=[],nW=(e,t)=>{let i={};return Object.keys(e).forEach(r=>{i[r]=e[r]}),t&&Object.keys(t).forEach(r=>{i[r]=t[r]}),i},oW=(e,t)=>e.vnodeSelector===t.vnodeSelector&&(e.properties&&t.properties?e.properties.key===t.properties.key&&e.properties.bind===t.properties.bind:!e.properties&&!t.properties),cfe=e=>{if(typeof e!="string")throw new Error("Style values must be strings")},S$e=(e,t,i)=>{if(t.vnodeSelector!==""){for(let r=i;r<e.length;r++)if(oW(e[r],t))return r}return-1},Ak=(e,t,i,r)=>{let s=e[t];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n?n.key===void 0?n.bind:n.key:void 0)){for(let o=0;o<e.length;o++)if(o!==t){let a=e[o];if(oW(a,s))throw new Error(`${i.vnodeSelector} had a ${s.vnodeSelector} child ${r==="added"?r:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},E$e=e=>{if(e.properties){let t=e.properties.enterAnimation;t&&t(e.domNode,e.properties)}},h9=[],d9=!1,ufe=e=>{(e.children||[]).forEach(ufe),e.properties&&e.properties.afterRemoved&&e.properties.afterRemoved.apply(e.properties.bind||e.properties,[e.domNode])},NJ=()=>{d9=!1,h9.forEach(ufe),h9.length=0},FJ=e=>{h9.push(e),d9||(d9=!0,typeof window!="undefined"&&"requestIdleCallback"in window?window.requestIdleCallback(NJ,{timeout:16}):setTimeout(NJ,16))},UJ=e=>{let t=e.domNode;if(e.properties){let i=e.properties.exitAnimation;if(i)return t.style.pointerEvents="none",void i(t,()=>{t.parentNode&&(t.parentNode.removeChild(t),FJ(e))},e.properties)}t.parentNode&&(t.parentNode.removeChild(t),FJ(e))},C$e=(e,t,i)=>{if(!t)return;let r=i.eventHandlerInterceptor,s=Object.keys(t),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=t[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")p9(e,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&e.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],m=l[f];m&&(cfe(m),i.styleApplyer(e,f,m))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(r&&(l=r(a,l,e,t)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),e[a]=l):i.namespace===U4?a==="href"?e.setAttributeNS(lfe,a,l):e.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?e[a]=ofe.sanitize(l):e.setAttribute(a,l):e[a]=l}}},A$e=(e,t,i)=>{if(t)for(let r of t)AT(r,e,void 0,i)},hfe=(e,t,i)=>{A$e(e,t.children,i),t.text&&(e.textContent=t.text),C$e(e,t.properties,i),t.properties&&t.properties.afterCreate&&t.properties.afterCreate.apply(t.properties.bind||t.properties,[e,i,t.vnodeSelector,t.properties,t.children])},AT=(e,t,i,r)=>{let s,n=0,o=e.vnodeSelector,a=t.ownerDocument;if(o==="")s=e.domNode=a.createTextNode(e.text),i!==void 0?t.insertBefore(s,i):t.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(r=nW(r,{namespace:U4})),r.namespace!==void 0?s=e.domNode=a.createElementNS(r.namespace,p):(s=e.domNode=e.domNode||a.createElement(p),p==="input"&&e.properties&&e.properties.type!==void 0&&s.setAttribute("type",e.properties.type)),i!==void 0?t.insertBefore(s,i):s.parentNode!==t&&t.appendChild(s)),n=l+1}}hfe(s,e,r)}},p9=(e,t,i)=>{t&&t.split(" ").forEach(r=>{r&&e.classList.toggle(r,i)})},R$e=(e,t,i,r)=>{if(!i)return;let s=!1,n=Object.keys(i),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=i[l],h=t[l];if(l==="class")h!==c&&(p9(e,h,!1),p9(e,c,!0));else if(l==="classes"){let p=e.classList,f=Object.keys(c),m=f.length;for(let y=0;y<m;y++){let v=f[y],w=!!c[v];w!==!!h[v]&&(s=!0,w?p.add(v):p.remove(v))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let m=0;m<f;m++){let y=p[m],v=c[y];v!==h[y]&&(s=!0,v?(cfe(v),r.styleApplyer(e,y,v)):r.styleApplyer(e,y,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=e[l];p!==c&&(e["oninput-value"]?p===e["oninput-value"]:c!==h)&&(e[l]=c,e["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&r.eventHandlerInterceptor||(r.namespace===U4?l==="href"?e.setAttributeNS(lfe,l,c):e.setAttribute(l,c):p==="string"?l==="innerHTML"?e[l]=ofe.sanitize(c):l==="role"&&c===""?e.removeAttribute(l):e.setAttribute(l,c):e[l]!==c&&(e[l]=c),s=!0)}}return s},M$e=(e,t,i,r,s)=>{if(i===r)return!1;r=r||LJ;let n,o=(i=i||LJ).length,a=r.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?i[l]:void 0,f=r[c];if(p!==void 0&&oW(p,f))h=wN(p,f,s)||h,l++;else{let m=S$e(i,f,l+1);if(m>=0){for(n=l;n<m;n++)UJ(i[n]),Ak(i,n,e,"removed");h=wN(i[m],f,s)||h,l=m+1}else AT(f,t,l<o?i[l].domNode:void 0,s),E$e(f),Ak(r,c,e,"added")}c++}if(o>l)for(n=l;n<o;n++)UJ(i[n]),Ak(i,n,e,"removed");return h};wN=(e,t,i)=>{let r=e.domNode,s=!1;if(e===t)return!1;let n=!1;if(t.vnodeSelector===""){if(t.text!==e.text){let o=r.ownerDocument.createTextNode(t.text);return r.parentNode.replaceChild(o,r),t.domNode=o,s=!0,s}t.domNode=r}else t.vnodeSelector.lastIndexOf("svg",0)===0&&(i=nW(i,{namespace:U4})),e.text!==t.text&&(n=!0,t.text===void 0?r.removeChild(r.firstChild):r.textContent=t.text),t.domNode=r,n=M$e(t,r,e.children,t.children,i)||n,n=R$e(r,e.properties,t.properties,i)||n,t.properties&&t.properties.afterUpdate&&t.properties.afterUpdate.apply(t.properties.bind||t.properties,[r,i,t.vnodeSelector,t.properties,t.children]);return n&&t.properties&&t.properties.updateAnimation&&t.properties.updateAnimation(r,t.properties,e.properties),s};let EE=(e,t)=>({getLastRender:()=>e,update:i=>{if(e.vnodeSelector!==i.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let r=e;e=i,wN(r,i,t)},domNode:e.domNode});const O$e={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{t.charAt(0)==="-"?e.style.setProperty(t,i):e.style[t]=i}};let $x=e=>nW(O$e,e),G0={create:(e,t)=>(t=$x(t),AT(e,document.createElement("div"),void 0,t),EE(e,t)),append:(e,t,i)=>(i=$x(i),AT(t,e,void 0,i),EE(t,i)),insertBefore:(e,t,i)=>(i=$x(i),AT(t,e.parentNode,e,i),EE(t,i)),merge:(e,t,i)=>(i=$x(i),t.domNode=e,hfe(e,t,i),EE(t,i)),replace:(e,t,i)=>(i=$x(i),AT(t,e.parentNode,e,i),e.parentNode.removeChild(e),EE(t,i))},dfe,P$e=(e,t)=>{let i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i};dfe=Array.prototype.find?(e,t)=>e.find(t):(e,t)=>e.filter(t)[0];let I$e=(e,t)=>{let i=e;return t.forEach(r=>{i=i&&i.children?dfe(i.children,s=>s.domNode===r):void 0}),i},$$e=(e,t,i)=>{let r=function(s){i("domEvent",s);let n=t(),o=P$e(s.currentTarget,n.domNode);o.reverse();let a,l=I$e(n.getLastRender(),o);return e.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),i("domEventProcessed",s),a};return(s,n,o,a)=>r},f9=e=>{let t,i,r=$x(e),s=r.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,m)=>{let y,v=()=>y;r.eventHandlerInterceptor=$$e(t,v,s),y=p(f,m(),r),a.push(y),l.push(m)},h=()=>{if(i=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return t={renderNow:h,scheduleRender:()=>{i||o||(i=requestAnimationFrame(h))},stop:()=>{i&&(cancelAnimationFrame(i),i=void 0),o=!0},resume:()=>{o=!1,n=!0,t.scheduleRender()},append:(p,f)=>{c(G0.append,p,f)},insertBefore:(p,f)=>{c(G0.insertBefore,p,f)},merge:(p,f)=>{c(G0.merge,p,f)},replace:(p,f)=>{c(G0.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},t},Vy=class extends Ee{constructor(){super(...arguments),this.items=new at,this._watchUpdatingTracking=new uf,this._callbacks=new Map,this._projector=f9(),this._hiddenProjector=f9()}get needsRender(){return this.items.length>0}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,t=>{for(const i of t.added){const r=()=>i.render();this._callbacks.set(i,r),this._projector.append(this.surface,r)}for(const i of t.removed){const r=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(r.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const t=this._hiddenSurface,i=this._hiddenProjector;let r=null;const s=()=>(r=e.render(),r);i.append(t,s),i.renderNow();const n={left:0,top:0,right:0,bottom:0};if(r&&r.domNode){const o=r.domNode.getBoundingClientRect();n.left=o.left,n.top=o.top,n.right=o.right,n.bottom=o.bottom}for(i.detach(s);t.firstChild;)t.removeChild(t.firstChild);return n}overlaps(e,t){const i=this.computeBoundingRect(e),r=this.computeBoundingRect(t);return Math.max(i.left,r.left)<=Math.min(i.right,r.right)&&Math.max(i.top,r.top)<=Math.min(i.bottom,r.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const t=e.getContext("2d");t.save(),t.font=`10px ${getComputedStyle(this.surface).fontFamily}`,this.items.forEach(i=>{t.save(),i.renderCanvas(t),t.restore()}),t.restore()}};u([d({readOnly:!0})],Vy.prototype,"surface",void 0),u([d({readOnly:!0})],Vy.prototype,"items",void 0),u([d({readOnly:!0})],Vy.prototype,"needsRender",null),u([d({readOnly:!0})],Vy.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0,aliasOf:"_watchUpdatingTracking.updating"})],Vy.prototype,"updating",void 0),Vy=u([P("esri.views.overlay.ViewOverlay")],Vy);const kJ=Vy;function aW(e,t,i,r){let s=null,n=1e3;typeof t=="number"?(n=t,r=i):(s=t!=null?t:null,n=i);let o,a=0;const l=()=>{a=0,e.apply(r,o)},c=(...h)=>{s&&s.apply(r,h),o=h,n?a||(a=setTimeout(l,n)):l()};return c.remove=()=>{a&&(clearTimeout(a),a=0)},c.forceUpdate=()=>{a&&(clearTimeout(a),l())},c.hasPendingUpdates=()=>!!a,c}function wt(e,t){const i=t?ve(F({},t),{source:e}):e;return d({aliasOf:i})}const D$e="randomUUID"in crypto;function pfe(){if(D$e)return crypto.randomUUID();const e=crypto.getRandomValues(new Uint16Array(8));e[3]=4095&e[3]|16384,e[4]=16383&e[4]|32768;const t=i=>e[i].toString(16);return t(0)+t(1)+"-"+t(2)+"-"+t(3)+"-"+t(4)+"-"+t(5)+t(6)+t(7)}const L$e={handleInterceptedEvent:(e,t,i,r)=>(e.scheduleRender(),t.properties[`on${r.type}`].apply(t.properties.bind||i,[r]))},N$e={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(e,t,i)=>{e.style[t]=i}},F$e=e=>F(F({},N$e),e),U$e=(e,t)=>{const i=[];for(;e&&e!==t;)i.push(e),e=e.parentNode;return i},k$e=(e,t)=>e.find(t),zJ=(e,t,i=!1)=>{let r=e;return t.forEach((s,n)=>{const o=(r==null?void 0:r.children)?k$e(r.children,a=>a.domNode===s):void 0;i&&!o&&n!==t.length-1||(r=o)}),r},z$e=e=>{let t;const i=F(F({},L$e),e),r=F$e(i),s=r.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,m,y)=>{var b;let v;r.eventHandlerInterceptor=(S,T,E,C)=>function(M){let I;s("domEvent",M);const N=U$e(M.currentTarget,v.domNode),D=N.some(V=>{var k;return customElements.get((k=V==null?void 0:V.tagName)==null?void 0:k.toLowerCase())});if(M.eventPhase===Event.CAPTURING_PHASE||!D)N.reverse(),I=zJ(v.getLastRender(),N);else{const V=M.composedPath(),k=V.slice(V.indexOf(M.currentTarget),V.indexOf(v.domNode)).filter(Y=>Y.getRootNode()===Y.ownerDocument).reverse();I=zJ(v.getLastRender(),k,!0)}let z;return I&&(z=i.handleInterceptedEvent(t,I,this,M)),s("domEventProcessed",M),z},(b=i.postProcessProjectionOptions)==null||b.call(i,r);const w=y();v=f(m,w,r),l.push(v),c.push(y),i.afterFirstVNodeRendered&&i.afterFirstVNodeRendered(v,w)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const m=c[f]();s("rendered",void 0),l[f].update(m),s("patched",void 0)}s("renderDone",void 0),o=!0}};return i.modifyDoRenderImplementation&&(p=i.modifyDoRenderImplementation(p,l,c)),t={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,t.scheduleRender()},append:(f,m)=>{h(G0.append,f,m)},insertBefore:(f,m)=>{h(G0.insertBefore,f,m)},merge:(f,m)=>{h(G0.merge,f,m)},replace:(f,m)=>{h(G0.replace,f,m)},detach:f=>{for(let m=0;m<c.length;m++)if(c[m]===f)return c.splice(m,1),l.splice(m,1)[0];throw new Error("renderFunction was not found")}},t},Ti={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let Dx,ffe,k4,mfe=!1,xN=!1,lW=!1,Nc=!1,VJ=null,m9=!1;const W2=typeof window!="undefined"?window:{};Ti.cssVarShim&&W2.CSS;const Vd=W2.document||{head:{}},V$e=W2.HTMLElement||class{},Xo={$flags$:0,$resourcesUrl$:"",jmp:e=>e(),raf:e=>requestAnimationFrame(e),ael:(e,t,i,r)=>e.addEventListener(t,i,r),rel:(e,t,i,r)=>e.removeEventListener(t,i,r),ce:(e,t)=>new CustomEvent(e,t)},TN=Ti.shadowDomShim&&Ti.shadowDom?(()=>(Vd.head.attachShadow+"").indexOf("[native")>-1)():!0,B$e=(()=>{let e=!1;try{Vd.addEventListener("e",null,Object.defineProperty({},"passive",{get(){e=!0}}))}catch{}return e})(),G$e=e=>Promise.resolve(e),j$e=Ti.constructableCSS?(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replace=="function"}catch{}return!1})():!1,gfe=(e,t,i,r)=>{i&&i.map(([s,n,o])=>{const a=q$e(e,s),l=H$e(t,o),c=W$e(s);Xo.ael(a,n,l,c),(t.$rmListeners$=t.$rmListeners$||[]).push(()=>Xo.rel(a,n,l,c))})},H$e=(e,t)=>i=>{try{Ti.lazyLoad||e.$hostElement$[t](i)}catch(r){RO(r)}},q$e=(e,t)=>t&4?Vd:t&8?W2:t&16?Vd.body:e,W$e=e=>B$e?{passive:(e&1)!==0,capture:(e&2)!==0}:(e&2)!==0,BJ="http://www.w3.org/1999/xlink",Fb=(e,t="")=>()=>{},GJ=new WeakMap,X$e=(e,t,i)=>{let r=CN.get(e);j$e&&i?(r=r||new CSSStyleSheet,r.replace(t)):r=t,CN.set(e,r)},Y$e=(e,t,i,r)=>{let s=yfe(t,i),n=CN.get(s);if(e=e.nodeType===11?e:Vd,n)if(typeof n=="string"){e=e.head||e;let o=GJ.get(e),a;o||GJ.set(e,o=new Set),o.has(s)||(a=Vd.createElement("style"),a.innerHTML=n,e.insertBefore(a,e.querySelector("link")),o&&o.add(s))}else e.adoptedStyleSheets.includes(n)||(e.adoptedStyleSheets=[...e.adoptedStyleSheets,n]);return s},Z$e=e=>{const t=e.$cmpMeta$,i=e.$hostElement$,r=t.$flags$,s=Fb("attachStyles",t.$tagName$),n=Y$e(TN&&i.shadowRoot?i.shadowRoot:i.getRootNode(),t,e.$modeName$);r&10&&(i["s-sc"]=n,i.classList.add(n+"-h"),r&2&&i.classList.add(n+"-s")),s()},yfe=(e,t)=>"sc-"+(t&&e.$flags$&32?e.$tagName$+"-"+t:e.$tagName$),Q$e=e=>ADe.map(t=>t(e)).find(t=>!!t),jJ={},J$e="http://www.w3.org/2000/svg",K$e="http://www.w3.org/1999/xhtml",eDe=e=>e!=null,cW=e=>(e=typeof e,e==="object"||e==="function"),Wu=(e,t,...i)=>{let r=null,s=null,n=null,o=!1,a=!1,l=[];const c=p=>{for(let f=0;f<p.length;f++)r=p[f],Array.isArray(r)?c(r):r!=null&&typeof r!="boolean"&&((o=typeof e!="function"&&!cW(r))&&(r=String(r)),o&&a?l[l.length-1].$text$+=r:l.push(o?SN(null,r):r),a=o)};if(c(i),t&&(Ti.isDev&&e==="input"&&rDe(t),Ti.vdomKey&&t.key&&(s=t.key),Ti.slotRelocation&&t.name&&(n=t.name),Ti.vdomClass)){const p=t.className||t.class;p&&(t.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}if(Ti.isDev&&l.some(_fe)&&CDe(`The <Host> must be the single root component. Make sure:
- You are NOT using hostData() and <Host> in the same component.
- <Host> is used once, and it's the single root component of the render() function.`),Ti.vdomFunctional&&typeof e=="function")return e(t===null?{}:t,l,tDe);const h=SN(e,null);return h.$attrs$=t,l.length>0&&(h.$children$=l),Ti.vdomKey&&(h.$key$=s),Ti.slotRelocation&&(h.$name$=n),h},SN=(e,t)=>{const i={$flags$:0,$tag$:e,$text$:t,$elm$:null,$children$:null};return Ti.vdomAttribute&&(i.$attrs$=null),Ti.vdomKey&&(i.$key$=null),Ti.slotRelocation&&(i.$name$=null),i},vfe={},_fe=e=>e&&e.$tag$===vfe,tDe={forEach:(e,t)=>e.map(HJ).forEach(t),map:(e,t)=>e.map(HJ).map(t).map(iDe)},HJ=e=>({vattrs:e.$attrs$,vchildren:e.$children$,vkey:e.$key$,vname:e.$name$,vtag:e.$tag$,vtext:e.$text$}),iDe=e=>{if(typeof e.vtag=="function"){const i=Object.assign({},e.vattrs);return e.vkey&&(i.key=e.vkey),e.vname&&(i.name=e.vname),Wu(e.vtag,i,...e.vchildren||[])}const t=SN(e.vtag,e.vtext);return t.$attrs$=e.vattrs,t.$children$=e.vchildren,t.$key$=e.vkey,t.$name$=e.vname,t},rDe=e=>{const t=Object.keys(e),i=t.indexOf("value");if(i===-1)return;const r=t.indexOf("type"),s=t.indexOf("min"),n=t.indexOf("max"),o=t.indexOf("step");(i<r||i<s||i<n||i<o)&&Mfe('The "value" prop of <input> should be set after "min", "max", "type" and "step"')},qJ=(e,t,i,r,s,n)=>{if(i!==r){let o=ZJ(e,t),a=t.toLowerCase();if(t==="class"){const l=e.classList,c=WJ(i),h=WJ(r);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(t==="style"){for(const l in i)(!r||r[l]==null)&&(l.includes("-")?e.style.removeProperty(l):e.style[l]="");for(const l in r)(!i||r[l]!==i[l])&&(l.includes("-")?e.style.setProperty(l,r[l]):e.style[l]=r[l])}else if(t!=="key")if(t==="ref")r&&r(e);else if(!e.__lookupSetter__(t)&&t[0]==="o"&&t[1]==="n")t[2]==="-"?t=t.slice(3):ZJ(W2,a)?t=a.slice(2):t=a[2]+t.slice(3),i&&Xo.rel(e,t,i,!1),r&&Xo.ael(e,t,r,!1);else{const l=cW(r);if((o||l&&r!==null)&&!s)try{if(e.tagName.includes("-"))e[t]=r;else{let h=r==null?"":r;t==="list"?o=!1:(i==null||e[t]!=h)&&(e[t]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(t=a,c=!0),r==null||r===!1?(r!==!1||e.getAttribute(t)==="")&&(c?e.removeAttributeNS(BJ,t):e.removeAttribute(t)):(!o||n&4||s)&&!l&&(r=r===!0?"":r,c?e.setAttributeNS(BJ,t,r):e.setAttribute(t,r))}}},sDe=/\s/,WJ=e=>e?e.split(sDe):[],bfe=(e,t,i,r)=>{const s=t.$elm$.nodeType===11&&t.$elm$.host?t.$elm$.host:t.$elm$,n=e&&e.$attrs$||jJ,o=t.$attrs$||jJ;for(r in n)r in o||qJ(s,r,n[r],void 0,i,t.$flags$);for(r in o)qJ(s,r,n[r],o[r],i,t.$flags$)},EN=(e,t,i,r)=>{let s=t.$children$[i],n=0,o,a,l;if(mfe||(lW=!0,s.$tag$==="slot"&&(Dx&&r.classList.add(Dx+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=Vd.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=Vd.createTextNode("");else{if(Nc||(Nc=s.$tag$==="svg"),o=s.$elm$=Vd.createElementNS(Nc?J$e:K$e,s.$flags$&2?"slot-fb":s.$tag$),Nc&&s.$tag$==="foreignObject"&&(Nc=!1),bfe(null,s,Nc),eDe(Dx)&&o["s-si"]!==Dx&&o.classList.add(o["s-si"]=Dx),s.$children$)for(n=0;n<s.$children$.length;++n)a=EN(e,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?Nc=!1:o.tagName==="foreignObject"&&(Nc=!0)}return o["s-hn"]=k4,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=ffe,o["s-sn"]=s.$name$||"",l=e&&e.$children$&&e.$children$[i],l&&l.$tag$===s.$tag$&&e.$elm$&&sM(e.$elm$,!1)),o},sM=(e,t)=>{Xo.$flags$|=1;const i=e.childNodes;for(let r=i.length-1;r>=0;r--){const s=i[r];s["s-hn"]!==k4&&s["s-ol"]&&(Tfe(s).insertBefore(s,uW(s)),s["s-ol"].remove(),s["s-ol"]=void 0,lW=!0),t&&sM(s,t)}Xo.$flags$&=-2},wfe=(e,t,i,r,s,n)=>{let o=e["s-cr"]&&e["s-cr"].parentNode||e,a;for(o.shadowRoot&&o.tagName===k4&&(o=o.shadowRoot);s<=n;++s)r[s]&&(a=EN(null,i,s,e),a&&(r[s].$elm$=a,o.insertBefore(a,uW(t))))},xfe=(e,t,i,r,s)=>{for(;t<=i;++t)(r=e[t])&&(s=r.$elm$,Cfe(r),xN=!0,s["s-ol"]?s["s-ol"].remove():sM(s,!0),s.remove())},nDe=(e,t,i,r)=>{let s=0,n=0,o=0,a=0,l=t.length-1,c=t[0],h=t[l],p=r.length-1,f=r[0],m=r[p],y,v;for(;s<=l&&n<=p;)if(c==null)c=t[++s];else if(h==null)h=t[--l];else if(f==null)f=r[++n];else if(m==null)m=r[--p];else if(iP(c,f))Lx(c,f),c=t[++s],f=r[++n];else if(iP(h,m))Lx(h,m),h=t[--l],m=r[--p];else if(iP(c,m))(c.$tag$==="slot"||m.$tag$==="slot")&&sM(c.$elm$.parentNode,!1),Lx(c,m),e.insertBefore(c.$elm$,h.$elm$.nextSibling),c=t[++s],m=r[--p];else if(iP(h,f))(c.$tag$==="slot"||m.$tag$==="slot")&&sM(h.$elm$.parentNode,!1),Lx(h,f),e.insertBefore(h.$elm$,c.$elm$),h=t[--l],f=r[++n];else{for(o=-1,a=s;a<=l;++a)if(t[a]&&t[a].$key$!==null&&t[a].$key$===f.$key$){o=a;break}o>=0?(v=t[o],v.$tag$!==f.$tag$?y=EN(t&&t[n],i,o,e):(Lx(v,f),t[o]=void 0,y=v.$elm$),f=r[++n]):(y=EN(t&&t[n],i,n,e),f=r[++n]),y&&Tfe(c.$elm$).insertBefore(y,uW(c.$elm$))}s>l?wfe(e,r[p+1]==null?null:r[p+1].$elm$,i,r,n,p):n>p&&xfe(t,s,l)},iP=(e,t)=>e.$tag$===t.$tag$?e.$tag$==="slot"?e.$name$===t.$name$:e.$key$===t.$key$:!1,uW=e=>e&&e["s-ol"]||e,Tfe=e=>(e["s-ol"]?e["s-ol"]:e).parentNode,Lx=(e,t)=>{const i=t.$elm$=e.$elm$,r=e.$children$,s=t.$children$,n=t.$tag$,o=t.$text$;let a;o===null?(Nc=n==="svg"?!0:n==="foreignObject"?!1:Nc,n==="slot"||bfe(e,t,Nc),r!==null&&s!==null?nDe(i,r,t,s):s!==null?(e.$text$!==null&&(i.textContent=""),wfe(i,null,t,s,0,s.length-1)):r!==null&&xfe(r,0,r.length-1),Nc&&n==="svg"&&(Nc=!1)):(a=i["s-cr"])?a.parentNode.textContent=o:e.$text$!==o&&(i.data=o)},Sfe=e=>{let t=e.childNodes,i,r,s,n,o,a;for(r=0,s=t.length;r<s;r++)if(i=t[r],i.nodeType===1){if(i["s-sr"]){for(o=i["s-sn"],i.hidden=!1,n=0;n<s;n++)if(a=t[n].nodeType,t[n]["s-hn"]!==i["s-hn"]||o!==""){if(a===1&&o===t[n].getAttribute("slot")){i.hidden=!0;break}}else if(a===1||a===3&&t[n].textContent.trim()!==""){i.hidden=!0;break}}Sfe(i)}},xd=[],Efe=e=>{let t,i,r,s,n,o,a=0,l=e.childNodes,c=l.length;for(;a<c;a++){if(t=l[a],t["s-sr"]&&(i=t["s-cr"])&&i.parentNode)for(r=i.parentNode.childNodes,s=t["s-sn"],o=r.length-1;o>=0;o--)i=r[o],!i["s-cn"]&&!i["s-nr"]&&i["s-hn"]!==t["s-hn"]&&(XJ(i,s)?(n=xd.find(h=>h.$nodeToRelocate$===i),xN=!0,i["s-sn"]=i["s-sn"]||s,n?n.$slotRefNode$=t:xd.push({$slotRefNode$:t,$nodeToRelocate$:i}),i["s-sr"]&&xd.map(h=>{XJ(h.$nodeToRelocate$,i["s-sn"])&&(n=xd.find(p=>p.$nodeToRelocate$===i),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):xd.some(h=>h.$nodeToRelocate$===i)||xd.push({$nodeToRelocate$:i}));t.nodeType===1&&Efe(t)}},XJ=(e,t)=>e.nodeType===1?e.getAttribute("slot")===null&&t===""||e.getAttribute("slot")===t:e["s-sn"]===t?!0:t==="",Cfe=e=>{e.$attrs$&&e.$attrs$.ref&&e.$attrs$.ref(null),e.$children$&&e.$children$.map(Cfe)},oDe=(e,t)=>{const i=e.$hostElement$,r=e.$cmpMeta$,s=e.$vnode$||SN(null,null),n=_fe(t)?t:Wu(null,null,t);k4=i.tagName,r.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},r.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=i[o])),n.$tag$=null,n.$flags$|=4,e.$vnode$=n,n.$elm$=s.$elm$=i.shadowRoot||i,Dx=i["s-sc"],ffe=i["s-cr"],mfe=TN&&(r.$flags$&1)!==0,xN=!1,Lx(s,n);{if(Xo.$flags$|=1,lW){Efe(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<xd.length;f++)o=xd[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=Vd.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<xd.length;f++)if(o=xd[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}xN&&Sfe(n.$elm$),Xo.$flags$&=-2,xd.length=0}},aDe=e=>Ti.lazyLoad?X2(e).$hostElement$:e,pvt=(e,t,i)=>{const r=aDe(e);return{emit:s=>(Ti.isDev&&!r.isConnected&&Mfe(`The "${t}" event was emitted, but the dispatcher node is no longer connected to the dom.`),lDe(r,t,{bubbles:!!(i&4),composed:!!(i&2),cancelable:!!(i&1),detail:s}))}},lDe=(e,t,i)=>{const r=Xo.ce(t,i);return e.dispatchEvent(r),r},cDe=(e,t)=>{},hW=(e,t)=>(e.$flags$|=16,cDe(e,e.$ancestorComponent$),ODe(()=>uDe(e,t))),uDe=(e,t)=>{const i=e.$hostElement$,r=Fb("scheduleUpdate",e.$cmpMeta$.$tagName$),s=i;let n;return t?n=iS(s,"componentWillLoad"):n=iS(s,"componentWillUpdate"),n=YJ(n,()=>iS(s,"componentWillRender")),r(),YJ(n,()=>hDe(e,s,t))},hDe=async(e,t,i)=>{const r=e.$hostElement$,s=Fb("update",e.$cmpMeta$.$tagName$);r["s-rc"],i&&Z$e(e);const n=Fb("render",e.$cmpMeta$.$tagName$);dDe(e,t,r),n(),s(),pDe(e)},dDe=(e,t,i)=>{try{VJ=t,t=t.render&&t.render(),e.$flags$&=-17,e.$flags$|=2,(Ti.hasRenderFn||Ti.reflect)&&(Ti.vdomRender||Ti.reflect)&&(Ti.hydrateServerSide||oDe(e,t))}catch(a){RO(a,e.$hostElement$)}return VJ=null,null},pDe=e=>{const t=e.$cmpMeta$.$tagName$,i=e.$hostElement$,r=Fb("postUpdate",t),s=i;e.$ancestorComponent$,iS(s,"componentDidRender"),e.$flags$&64?(iS(s,"componentDidUpdate"),r()):(e.$flags$|=64,iS(s,"componentDidLoad"),r())},fvt=e=>{if(Ti.updatable){const t=X2(e),i=t.$hostElement$.isConnected;return i&&(t.$flags$&18)===2&&hW(t,!1),i}return!1},iS=(e,t,i)=>{if(e&&e[t])try{return e[t](i)}catch(r){RO(r)}},YJ=(e,t)=>e&&e.then?e.then(t):t(),fDe=(e,t)=>e!=null&&!cW(e)?t&4?e==="false"?!1:e===""||!!e:t&2?parseFloat(e):t&1?String(e):e:e,mDe=(e,t)=>X2(e).$instanceValues$.get(t),gDe=(e,t,i,r)=>{const s=X2(e),n=e,o=s.$instanceValues$.get(t),a=s.$flags$,l=n;i=fDe(i,r.$members$[t][0]);const c=Number.isNaN(o)&&Number.isNaN(i);if(i!==o&&!c){s.$instanceValues$.set(t,i);{if(r.$watchers$&&a&128){const p=r.$watchers$[t];p&&p.map(f=>{try{l[f](i,o,t)}catch(m){RO(m,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(i,o,t)===!1)return;hW(s,!1)}}}},yDe=(e,t,i)=>{if(t.$members$){e.watchers&&(t.$watchers$=e.watchers);const r=Object.entries(t.$members$),s=e.prototype;r.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return mDe(this,n)},set(a){gDe(this,n,a,t)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){Xo.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},e.observedAttributes=r.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&t.$attrsToReflect$.push([o,l]),l})}}return e},vDe=async(e,t,i,r,s)=>{if((t.$flags$&32)===0&&(s=e.constructor,t.$flags$|=32,customElements.whenDefined(i.$tagName$).then(()=>t.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[t.$modeName$=Q$e(e)]);const a=yfe(i,t.$modeName$);if(!CN.has(a)){const l=Fb("registerStyles",i.$tagName$);X$e(a,o,!!(i.$flags$&1)),l()}}t.$ancestorComponent$,(()=>hW(t,!0))()},_De=e=>{},bDe=e=>{if((Xo.$flags$&1)===0){const t=X2(e),i=t.$cmpMeta$,r=Fb("connectedCallback",i.$tagName$);t.$flags$&1?(gfe(e,t,i.$listeners$),_De(t.$lazyInstance$)):(t.$flags$|=1,i.$flags$&12&&wDe(e),i.$members$&&Object.entries(i.$members$).map(([s,[n]])=>{if(n&31&&e.hasOwnProperty(s)){const o=e[s];delete e[s],e[s]=o}}),vDe(e,t,i)),r()}},wDe=e=>{const t=e["s-cr"]=Vd.createComment("");t["s-cn"]=!0,e.insertBefore(t,e.firstChild)},xDe=e=>{if((Xo.$flags$&1)===0){const t=X2(e);t.$rmListeners$&&(t.$rmListeners$.map(i=>i()),t.$rmListeners$=void 0)}},TDe=(e,t)=>{const i={$flags$:t[0],$tagName$:t[1]};Ti.member&&(i.$members$=t[2]),Ti.hostListener&&(i.$listeners$=t[3]),Ti.watchCallback&&(i.$watchers$=e.$watchers$),Ti.reflect&&(i.$attrsToReflect$=[]),Ti.shadowDom&&!TN&&i.$flags$&1&&(i.$flags$|=8);const r=e.prototype.connectedCallback,s=e.prototype.disconnectedCallback;return Object.assign(e.prototype,{__registerHost(){EDe(this,i)},connectedCallback(){bDe(this),Ti.connectedCallback&&r&&r.call(this)},disconnectedCallback(){xDe(this),Ti.disconnectedCallback&&s&&s.call(this)},__attachShadow(){TN?Ti.shadowDelegatesFocus?this.attachShadow({mode:"open",delegatesFocus:!!(i.$flags$&16)}):this.attachShadow({mode:"open"}):this.shadowRoot=this}}),e.is=i.$tagName$,yDe(e,i)},mvt=e=>{const t=new URL(e,Xo.$resourcesUrl$);return t.origin!==W2.location.origin?t.href:t.pathname},SDe=e=>Xo.$resourcesUrl$=e,Afe=new WeakMap,X2=e=>Afe.get(e),EDe=(e,t)=>{const i={$flags$:0,$hostElement$:e,$cmpMeta$:t,$instanceValues$:new Map};return Ti.isDev&&(i.$renderCount$=0),Ti.method&&Ti.lazyLoad&&(i.$onInstancePromise$=new Promise(r=>i.$onInstanceResolve$=r)),Ti.asyncLoading&&(i.$onReadyPromise$=new Promise(r=>i.$onReadyResolve$=r),e["s-p"]=[],e["s-rc"]=[]),gfe(e,i,t.$listeners$),Afe.set(e,i)},ZJ=(e,t)=>t in e,RO=(e,t)=>(0,console.error)(e,t),Rfe=Ti.isTesting?["STENCIL:"]:["%cstencil","color: white;background:#4c47ff;font-weight: bold; font-size:10px; padding:2px 6px; border-radius: 5px"],CDe=(...e)=>console.error(...Rfe,...e),Mfe=(...e)=>console.warn(...Rfe,...e),CN=new Map,ADe=[],QJ=[],Ofe=[],RDe=(e,t)=>i=>{e.push(i),m9||(m9=!0,t&&Xo.$flags$&4?MDe(g9):Xo.raf(g9))},JJ=e=>{for(let t=0;t<e.length;t++)try{e[t](performance.now())}catch(i){RO(i)}e.length=0},g9=()=>{JJ(QJ),JJ(Ofe),(m9=QJ.length>0)&&Xo.raf(g9)},MDe=e=>G$e().then(e),ODe=RDe(Ofe,!0),gvt={isDev:!!Ti.isDev,isBrowser:!0,isServer:!1,isTesting:!!Ti.isTesting};let Pfe;function PDe(){SDe(gh(Mi(Pfe)))}Pfe="components/assets";const Ife=Symbol("widget"),IDe=[],$De={},AN=new WeakMap;function $fe(e,t){let i=t.children;if(i&&i.length)for(let s=0;s<i.length;++s)i[s]=$fe(e,i[s]);else i=IDe;const r=t.vnodeSelector;if(dW(r)){const s=t.properties||$De,n=s.key||r;return{vnodeSelector:"div",properties:{key:n,afterCreate:DDe,afterUpdate:LDe,afterRemoved:Dfe,parentWidget:e,widgetConstructor:r,widgetProperties:ve(F({},s),{key:n,children:i})},children:void 0,text:void 0,domNode:null}}return t}function DDe(e,t,i,{parentWidget:r,widgetConstructor:s,widgetProperties:n}){var a;const o=new s(n);o.container=e,AN.set(e,o),(a=o.afterCreate)==null||a.call(o,o,e),r._internalHandles.add(Th(()=>Dfe(e)))}function LDe(e,t,i,{widgetProperties:r}){var n;const s=AN.get(e);s&&(s.set(r),(n=s.afterUpdate)==null||n.call(s,s,e))}function Dfe(e){const t=AN.get(e);t&&(t.destroy(),AN.delete(e))}function dW(e){return typeof e=="function"&&e[Ife]}const KJ=new Set;function NDe(e){KJ.add(e),e.finally(()=>KJ.delete(e))}const Lfe="esri.widgets.Widget",FDe=me.getLogger(Lfe);let UDe=0;const kDe={widgetIcon:"esri-icon-checkbox-unchecked"};function Nfe(e,t){for(const i in t)e[i]!=null&&(typeof e[i]=="object"&&typeof t[i]=="object"?Nfe(e[i],t[i]):e[i]=t[i]);return e}const zDe=z$e({postProcessProjectionOptions(e){const t=e.eventHandlerInterceptor,i=/capture$/i;e.eventHandlerInterceptor=(r,s,n,o)=>{const a=t(r,s,n,o),l=i.test(r);if(!((r=r.replace(i,"")).toLowerCase()in n)||l){const c=r[2].toLowerCase()+r.slice(3),h=m=>a.call(n,m);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=m=>{f==null||f(m),p()}}return a}},handleInterceptedEvent(e,t,i,r){const{eventPhase:s,type:n}=r,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=t.properties;(a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,a in l))&&(rfe(),e.scheduleRender(),l[a].call(l.bind||i,r))}});let Rk=!1,yn=class extends SO(us.EventedAccessor){constructor(e,t){super(e,t),this._attached=!1,this._internalHandles=new qt,this._projector=zDe,this._readyForTrueRender=!1,this.domNode=null,this.iconClass=kDe.widgetIcon,this.label=this.declaredClass.split(".").pop(),this.visible=!0,this.key=this,this._loadLocale=EH(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const n=await pn(this._messageBundleProps.map(async({bundlePath:o,propertyName:a})=>{let l=await tde(o);this.uiStrings&&Object.keys(this.uiStrings)&&(l=Nfe(te(l),this.uiStrings)),this[a]=l}));for(const o of n)o.error&&FDe.error("widget-intl:locale-error",this.declaredClass,o.error)}await this.loadLocale()}),PDe();const i="esri-widget-uid-"+pfe(),r=this.render.bind(this);this._trackingTarget=new s4(()=>this.scheduleRender());const s=()=>{var h;if(!this._readyForTrueRender||this.destroyed)return null;if(!this.visible)return{vnodeSelector:"div",properties:{key:i,class:"",styles:{display:"none"}},domNode:void 0,children:void 0,text:void 0};const n=r();let{properties:o}=n;o||(n.properties=o={});let{key:a,styles:l}=o;a||(o.key=i),l||(o.styles=l={}),l.display||(l.display="");let c=0;return(h=n.children)==null||h.forEach(p=>{if(dW(p.vnodeSelector))return;let{properties:f}=p;f||(p.properties=f={}),f.key||(f.key=`${this.id}--${c++}`)}),$fe(this,n)};this.render=()=>{if(Rk)return s();let n=p$e(this);if(n)return n;this._trackingTarget.clear(),Rk=!0;try{n=gg(this._trackingTarget,s)}catch(o){throw console.error(o),o}finally{Rk=!1}return f$e(this,n),n},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()})),NDe(this._resourcesFetch)}normalizeCtorArgs(e,t){const i=F({},e);return t&&(i.container=t),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(r8)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(ot(this._trackingTarget),ot(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,Ck(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return x4(e)}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+UDe++}set id(e){e&&this._set("id",e)}get renderable(){return this._resourcesFetch}get test(){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(Ck(this),this._projector.scheduleRender())}classes(...e){return nfe.apply(this,e)}renderNow(){Ck(this),this._projector.renderNow()}_postInitialize(){var t;if(this.destroyed)return;this.scheduleRender(),((t=this._delegatedEventNames)==null?void 0:t.length)&&this._internalHandles.add(ae(()=>this.viewModel,(i,r)=>{r&&this._internalHandles.remove("delegated-events"),i&&KF(i)&&this._internalHandles.add(this._delegatedEventNames.map(s=>fO(i,s,n=>{this.emit(s,n)})),"delegated-events")},Ft)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(r8),this.scheduleRender()};this._internalHandles.add([SAe(e),ae(()=>this.uiStrings,e),cl(()=>this.container,i=>{this.destroyed||this._attach(i)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){e&&this._attached&&(this._projector.detach(this.render),e.parentNode&&e.parentNode.removeChild(e),this._attached=!1)}};yn[Ife]=!0,u([d()],yn.prototype,"_readyForTrueRender",void 0),u([d({value:null})],yn.prototype,"container",null),u([Ot("container")],yn.prototype,"castContainer",null),u([d({aliasOf:"container"})],yn.prototype,"domNode",void 0),u([d()],yn.prototype,"iconClass",void 0),u([d()],yn.prototype,"id",null),u([d()],yn.prototype,"label",void 0),u([d()],yn.prototype,"renderable",null),u([d()],yn.prototype,"uiStrings",void 0),u([d()],yn.prototype,"viewModel",void 0),u([d()],yn.prototype,"visible",void 0),u([d()],yn.prototype,"key",void 0),u([d()],yn.prototype,"children",void 0),u([d()],yn.prototype,"afterCreate",void 0),u([d()],yn.prototype,"afterUpdate",void 0),u([d()],yn.prototype,"afterRemoved",void 0),yn=u([P(Lfe)],yn);const ml=yn;function VDe(e,t,i){return e.units[t][i]}function z4(e,t,i,r=2,s="abbr"){return`${bf(t,{minimumFractionDigits:r,maximumFractionDigits:r})} ${VDe(e,i,s)}`}function yvt(e,t,i,r=2,s="abbr"){const n=kOe(t,i);return z4(e,Hs(t,i,n),n,r,s)}function vvt(e,t,i,r=2,s="abbr"){const n=zOe(t,i);return z4(e,Hs(t,i,n),n,r,s)}function _vt(e,t,i,r=2,s="abbr"){const n=VOe(t,i);return z4(e,Hs(t,i,n),n,r,s)}function bvt(e,t,i,r=2,s="abbr"){const n=BOe(t,i);return z4(e,Hs(t,i,n),n,r,s)}const eK=["B","kB","MB","GB","TB"];function BDe(e,t){let i=t===0?0:Math.floor(Math.log(t)/Math.log(jS.KILOBYTES));i=$e(i,0,eK.length-1);const r=bf(t/jS.KILOBYTES**i,{maximumFractionDigits:2});return gf(e.units.bytes[eK[i]],{fileSize:r})}function GDe(e){const{exifInfo:t,exifName:i,tagName:r}=e;if(!t||!i||!r)return null;const s=t.find(n=>n.name===i);return s?jDe({tagName:r,tags:s.tags}):null}function jDe(e){const{tagName:t,tags:i}=e;if(!i||!t)return null;const r=i.find(s=>s.name===t);return r&&r.value||null}var y9;const HDe={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let El=y9=class extends fe{constructor(e){super(e),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:e}=this,t=GDe({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:e});return HDe[t]||null}clone(){return new y9({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],El.prototype,"contentType",void 0),u([d()],El.prototype,"exifInfo",void 0),u([d({readOnly:!0})],El.prototype,"orientationInfo",null),u([d({type:yr})],El.prototype,"id",void 0),u([d({type:String})],El.prototype,"globalId",void 0),u([d({type:String})],El.prototype,"keywords",void 0),u([d({type:String})],El.prototype,"name",void 0),u([d({json:{read:!1}})],El.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],El.prototype,"parentObjectId",void 0),u([d({type:yr})],El.prototype,"size",void 0),u([d({json:{read:!1}})],El.prototype,"url",void 0),El=y9=u([P("esri.layers.support.AttachmentInfo")],El);const qDe=El;var v9;let po=v9=class extends fe{constructor(e){super(e),this.attachmentTypes=null,this.attachmentsWhere=null,this.cacheHint=void 0,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new v9(te({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,cacheHint:this.cacheHint,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],po.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],po.prototype,"attachmentsWhere",void 0),u([d({type:Boolean,json:{write:!0}})],po.prototype,"cacheHint",void 0),u([d({type:[String],json:{write:!0}})],po.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],po.prototype,"globalIds",void 0),u([d({json:{write:!0}})],po.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],po.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],po.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],po.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],po.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],po.prototype,"start",void 0),u([Be("start"),Be("num")],po.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],po.prototype,"where",void 0),po=v9=u([P("esri.rest.support.AttachmentQuery")],po),po.from=Qr(po);const _9=po,WDe="esri.widgets.Feature.support.featureUtils",tK=me.getLogger(WDe),XDe=/href=(""|'')/gi,YDe=/(\{([^\{\r\n]+)\})/g,ZDe=/\'/g,Ffe=/^\s*expression\//i,QDe=/(\n)/gi,JDe=/[\u00A0-\u9999<>\&]/gim,KDe=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,eLe=/^(?:mailto:|tel:)/,Ufe="relationships/",b9=a4("short-date-short-time");function kfe(e){if(!R(e))return e.get("sourceLayer")||e.get("layer")}async function RN(e,t){return typeof e=="function"?e.call(null,t):e}function zfe(e=""){if(e)return!eLe.test(e.trim().toLowerCase())}function Vfe(e){return!!e&&Ffe.test(e)}function tLe(e,t){if(!Vfe(t)||!e)return null;const i=t.replace(Ffe,"").toLowerCase();let r;return e.some(s=>s.name.toLowerCase()===i&&(r=s,!0)),r}function Bfe(e,t){const i=tLe(t,e==null?void 0:e.fieldName);return i?i.title||null:e?e.label||e.fieldName:null}function iLe(e,t){const i=t.get(e.toLowerCase());return`{${i&&i.fieldName||e}}`}function rLe(e){return e.replace(XDe,"")}function MN(e,t){const i=pW(t,e);return i?i.name:e}function sLe(e,t){return e&&e.map(i=>MN(i,t))}function pW(e,t){return e&&typeof e.getField=="function"?e.getField(t):null}function Gfe(e){return`${e}`.trim()}function Y1({attributes:e,globalAttributes:t,layer:i,text:r,expressionAttributes:s,fieldInfoMap:n}){return r?w9({formattedAttributes:t,template:lLe(r,F(F(F({},t),s),e),i),fieldInfoMap:n}):""}function w9({formattedAttributes:e,template:t,fieldInfoMap:i}){return Gfe(rLe(gf(gf(t,r=>iLe(r,i)),e)))}function nLe(e,t,i=!1){const r=t[e];if(typeof r=="string"){const s="%27",n=(i?encodeURIComponent(r):r).replace(ZDe,s);t[e]=n}}function oLe(e,t=!1){const i=F({},e);return Object.keys(i).forEach(r=>nLe(r,i,t)),i}function aLe(e,t,i){const r=(t=Gfe(t))&&t[0]!=="{";return gf(e,oLe(i,r))}function x9(e,t){return e.replace(YDe,(i,r,s)=>{const n=pW(t,s);return n?`{${n.name}}`:r})}function lLe(e,t,i){const r=x9(e,i);return r&&r.replace(KDe,(s,n,o)=>aLe(s,n||o,t))}function cLe(e,t){if(typeof e=="string"&&t&&t.dateFormat==null&&(t.places!=null||t.digitSeparator!=null)){const i=Number(e);if(!isNaN(i))return i}return e}function uLe(e){return(e==null?void 0:e.type)==="feature"}function iK(e){return!!(e==null?void 0:e.layer)}function hLe(e){return(e==null?void 0:e.type)==="map-image"}function dLe(e,t){var c;const i=t.fieldInfos,r=t.fieldName,s=(c=jfe(i,r))==null?void 0:c.clone(),n=t.preventPlacesFormatting,o=t.layer,a=pW(o,r);if(s&&(a==null?void 0:a.type)==="date"){const h=s.format||new ST;h.dateFormat=h.dateFormat||"short-date-short-time",h.dateTimeFormatOptions=!iK(o)&&uLe(o)&&o.datesInUnknownTimezone||iK(o)&&hLe(o.layer)&&o.layer.datesInUnknownTimezone?{timeZone:"UTC"}:null,s.format=h}const l=s&&s.format;return typeof e=="string"&&Mue(r)&&l?l.formatRasterPixelValue(e):typeof(e=cLe(e,l))=="string"||e==null||l==null?MO(e):n?bf(e,ve(F({},Due(l)),{minimumFractionDigits:0,maximumFractionDigits:20})):l.format(e)}function jfe(e,t){if(!e||!e.length||!t)return;const i=t.toLowerCase();let r;return e.some(s=>!(!s.fieldName||s.fieldName.toLowerCase()!==i)&&(r=s,!0)),r}function pLe({fieldName:e,graphic:t,layer:i}){if(Zm(e)||!i||typeof i.getFeatureType!="function")return null;const{typeIdField:r}=i;if(!r||e!==r)return null;const s=i.getFeatureType(t);return s?s.name:null}function fLe({fieldName:e,value:t,graphic:i,layer:r}){if(Zm(e)||!r||typeof r.getFieldDomain!="function")return null;const s=r.getFieldDomain(e,{feature:i});return s&&s.type==="coded-value"?s.getName(t):null}function mLe(e,t){const{creatorField:i,creationDateField:r,editorField:s,editDateField:n}=e;if(!t)return;const o=t[n];if(typeof o=="number"){const l=t[s];return{type:"edit",date:_f(o,b9),user:l}}const a=t[r];if(typeof a=="number"){const l=t[i];return{type:"create",date:_f(a,b9),user:l}}return null}function gLe(e,t){const i=new Map;return e&&e.forEach(r=>{const s=MN(r.fieldName,t);r.fieldName=s,i.set(s.toLowerCase(),r)}),i}function rK(e){const t=[];if(!e)return t;const{fieldInfos:i,content:r}=e;return i&&t.push(...i),r&&Array.isArray(r)&&r.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&t.push(...n)}}),t}function fW(e){return e.replace(JDe,t=>`&#${t.charCodeAt(0)};`)}function MO(e){return typeof e=="string"?e.replace(QDe,'<br class="esri-text-new-line" />'):e}function Hfe(e){const{value:t,fieldName:i,fieldInfos:r,fieldInfoMap:s,layer:n,graphic:o}=e;if(t==null)return"";const a=fLe({fieldName:i,value:t,graphic:o,layer:n});if(a)return a;const l=pLe({fieldName:i,graphic:o,layer:n});if(l)return l;if(s.get(i.toLowerCase()))return dLe(t,{fieldInfos:r||Array.from(s.values()),fieldName:i,layer:n});const c=n&&n.fieldsIndex;return c&&c.isDateField(i)?_f(t,b9):MO(t)}function Mk({fieldInfos:e,attributes:t,layer:i,graphic:r,fieldInfoMap:s,relatedInfos:n}){const o={};return n==null||n.forEach(a=>wLe({attributes:o,relatedInfo:a,fieldInfoMap:s,fieldInfos:e,layer:i})),Object.keys(t).forEach(a=>{const l=t[a];o[a]=Hfe({fieldName:a,fieldInfos:e,fieldInfoMap:s,layer:i,value:l,graphic:r})}),o}async function yLe(e,t){var h,p;const{layer:i,graphic:r,outFields:s,objectIds:n,returnGeometry:o,spatialReference:a}=e,l=n[0];if(typeof l!="number"&&typeof l!="string"){const f="Could not query required fields for the specified feature. The feature's ID is invalid.",m={layer:i,graphic:r,objectId:l,requiredFields:s};return tK.warn(f,m),null}if(!((p=(h=i.capabilities)==null?void 0:h.operations)==null?void 0:p.supportsQuery)){const f="The specified layer cannot be queried. The following fields will not be available.",m={layer:i,graphic:r,requiredFields:s,returnGeometry:o};return tK.warn(f,m),null}const c=i.createQuery();return c.objectIds=n,c.outFields=(s==null?void 0:s.length)?s:[i.objectIdField],c.returnGeometry=!!o,c.returnZ=!!o,c.returnM=!!o,c.outSpatialReference=a,(await i.queryFeatures(c,t)).features[0]}async function vLe(e){var r;if(!((r=e.expressionInfos)==null?void 0:r.length))return!1;const t=await vf(),{arcadeUtils:{hasGeometryFunctions:i}}=t;return i(e)}async function _Le({graphic:e,popupTemplate:t,layer:i,spatialReference:r},s){if(!i||!t||(typeof i.load=="function"&&await i.load(s),!e.attributes))return;const n=e.attributes[i.objectIdField];if(n==null)return;const o=[n],a=await t.getRequiredFields(i.fieldsIndex),l=wAe(a,e),c=l?[]:a,h=t.returnGeometry||await vLe(t);if(l&&!h)return;const p=await yLe({layer:i,graphic:e,outFields:c,objectIds:o,returnGeometry:h,spatialReference:r},s);p&&(p.geometry&&(e.geometry=p.geometry),p.attributes&&(e.attributes=F(F({},e.attributes),p.attributes)))}function Zm(e=""){return!!e&&e.includes(Ufe)}function bLe(e){return e?`${Ufe}${e.layerId}/${e.fieldName}`:""}function sK({attributes:e,graphic:t,relatedInfo:i,fieldInfos:r,fieldInfoMap:s,layer:n}){e&&t&&i&&Object.keys(t.attributes).forEach(o=>{const a=bLe({layerId:i.relation.id.toString(),fieldName:o}),l=t.attributes[o];e[a]=Hfe({fieldName:a,fieldInfos:r,fieldInfoMap:s,layer:n,value:l,graphic:t})})}function wLe({attributes:e,relatedInfo:t,fieldInfoMap:i,fieldInfos:r,layer:s}){e&&t&&(t.relatedFeatures&&t.relatedFeatures&&t.relatedFeatures.forEach(n=>sK({attributes:e,graphic:n,relatedInfo:t,fieldInfoMap:i,fieldInfos:r,layer:s})),t.relatedStatsFeatures&&t.relatedStatsFeatures&&t.relatedStatsFeatures.forEach(n=>sK({attributes:e,graphic:n,relatedInfo:t,fieldInfoMap:i,fieldInfos:r,layer:s})))}const nK=e=>{if(!e)return!1;const t=e.toUpperCase();return t.includes("CURRENT_TIMESTAMP")||t.includes("CURRENT_DATE")||t.includes("CURRENT_TIME")},qfe=({layer:e,method:t,query:i,definitionExpression:r})=>{var o,a;if(!((a=(o=e.capabilities)==null?void 0:o.query)==null?void 0:a.supportsCacheHint)||t==="attachments")return;const s=_(i.where)&&i.where,n=_(i.geometry)&&i.geometry;nK(r)||nK(s)||(n==null?void 0:n.type)==="extent"||i.resultType==="tile"||(i.cacheHint=!0)},xLe=({query:e,layer:t,method:i})=>{qfe({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},TLe=({queryPayload:e,layer:t,method:i})=>{qfe({layer:t,method:i,query:e,definitionExpression:`${t.definitionExpression} ${t.serviceDefinitionExpression}`})},oK={editing:!1,operations:{add:!0,update:!0,delete:!0}},Wfe=at.ofType(qDe),SLe="graphic.layer.capabilities.operations.supportsResizeAttachments";let ed=class extends Ee{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.abilities=F({},oK),this.activeAttachmentInfo=null,this.attachmentInfos=new Wfe,this.graphic=null,this.mode="view",this.own(ae(()=>this.graphic,()=>this._graphicChanged(),Ft))}destroy(){this._attachmentLayer=null,this.graphic=null}castAbilities(e){return F(F({},oK),e)}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){return this.get(SLe)||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:t}=this;if(!e||typeof e.queryAttachments!="function")throw new q("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getFeatureId(),r=new _9({objectIds:[i],returnMetadata:!0}),s=[],n=e.queryAttachments(r).then(a=>a[i]||s).catch(()=>s);this._getAttachmentsPromise=n,this.notifyChange("state");const o=await n;return t.removeAll(),o.length&&t.addMany(o),this._getAttachmentsPromise=null,this.notifyChange("state"),o}async addAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new q("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!s.operations.add)throw new q("invalid-abilities","addAttachment(): add abilities are required.");if(!t||typeof t.addAttachment!="function")throw new q("invalid-layer","addAttachment(): A valid layer is required.");const n=t.addAttachment(r,e).then(a=>this._queryAttachment(a.objectId)),o=await n;return i.add(o),o}async deleteAttachment(e){const{_attachmentLayer:t,attachmentInfos:i,graphic:r,abilities:s}=this;if(!e)throw new q("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!s.operations.delete)throw new q("invalid-abilities","deleteAttachment(): delete abilities are required.");if(!t||typeof t.deleteAttachments!="function")throw new q("invalid-layer","deleteAttachment(): A valid layer is required.");const n=t.deleteAttachments(r,[e.id]).then(()=>e),o=await n;return i.remove(o),o}async updateAttachment(e,t=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:r,graphic:s,abilities:n}=this;if(!e)throw new q("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!t)throw new q("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:t});if(!n.operations.update)throw new q("invalid-abilities","updateAttachment(): Update abilities are required.");const o=r.findIndex(c=>c===t);if(!i||typeof i.updateAttachment!="function")throw new q("invalid-layer","updateAttachment(): A valid layer is required.");const a=i.updateAttachment(s,t.id,e).then(c=>this._queryAttachment(c.objectId)),l=await a;return r.splice(o,1,l),l}async _queryAttachment(e){if(!e)throw new q("invalid-attachment-id","Could not query attachment.");const{_attachmentLayer:t}=this,i=this._getFeatureId(),r=new _9({objectIds:[i],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return t.queryAttachments(r).then(s=>s[i][0])}_getFeatureId(){const{_attachmentLayer:e,graphic:t}=this;if(!e||!t)return null;const{objectIdField:i}=e,{attributes:r}=t;return r&&r[i]}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,t=kfe(e);this._attachmentLayer=t?t.type==="scene"&&_(t.associatedLayer)?t.associatedLayer:t:null}};u([d()],ed.prototype,"abilities",void 0),u([Ot("abilities")],ed.prototype,"castAbilities",null),u([d()],ed.prototype,"activeAttachmentInfo",void 0),u([d({readOnly:!0,type:Wfe})],ed.prototype,"attachmentInfos",void 0),u([d({type:Ca})],ed.prototype,"graphic",void 0),u([d()],ed.prototype,"mode",void 0),u([d({readOnly:!0})],ed.prototype,"state",null),u([d({readOnly:!0})],ed.prototype,"supportsResizeAttachments",null),ed=u([P("esri.widgets.Attachments.AttachmentsViewModel")],ed);const mW=ed;function ELe(e){const t=e.toLowerCase();return t==="image/bmp"||t==="image/emf"||t==="image/exif"||t==="image/gif"||t==="image/x-icon"||t==="image/jpeg"||t==="image/png"||t==="image/tiff"||t==="image/x-wmf"}function CLe(e){const t=Mi("esri/themes/base/images/files/");return e?e==="text/plain"?`${t}text-32.svg`:e==="application/pdf"?`${t}pdf-32.svg`:e==="text/csv"?`${t}csv-32.svg`:e==="application/gpx+xml"?`${t}gpx-32.svg`:e==="application/x-dwf"?`${t}cad-32.svg`:e==="application/postscript"||e==="application/json"||e==="text/xml"||e==="model/vrml"?`${t}code-32.svg`:e==="application/x-zip-compressed"||e==="application/x-7z-compressed"||e==="application/x-gzip"||e==="application/x-tar"||e==="application/x-gtar"||e==="application/x-bzip2"||e==="application/gzip"||e==="application/x-compress"||e==="application/x-apple-diskimage"||e==="application/x-rar-compressed"||e==="application/zip"?`${t}zip-32.svg`:e.includes("image/")?`${t}image-32.svg`:e.includes("audio/")?`${t}sound-32.svg`:e.includes("video/")?`${t}video-32.svg`:e.includes("msexcel")||e.includes("ms-excel")||e.includes("spreadsheetml")?`${t}excel-32.svg`:e.includes("msword")||e.includes("ms-word")||e.includes("wordprocessingml")?`${t}word-32.svg`:e.includes("powerpoint")||e.includes("presentationml")?`${t}report-32.svg`:`${t}generic-32.svg`:`${t}generic-32.svg`}function Ql(e){return(t,i)=>{t.hasOwnProperty("_messageBundleProps")||(t._messageBundleProps=t._messageBundleProps?t._messageBundleProps.slice():[]),t._messageBundleProps.push({bundlePath:e,propertyName:i})}}var ALe=function(e){return{vnodeSelector:"",properties:void 0,children:void 0,text:e.toString(),domNode:null}},Xfe=function(e,t){for(var i=0,r=e.length;i<r;i++){var s=e[i];Array.isArray(s)?Xfe(s,t):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=ALe(s)),t.push(s))}},RLe=function(e,t){for(var i=[],r=2;r<arguments.length;r++)i[r-2]=arguments[r];if(i.length===1&&typeof i[0]=="string")return{vnodeSelector:e,properties:t||void 0,children:void 0,text:i[0],domNode:null};var s=[];return Xfe(i,s),{vnodeSelector:e,properties:t||void 0,children:s,text:void 0,domNode:null}};function ue(e,t,...i){return typeof e!="function"||dW(e)?RLe(e,t,...i):e(t,...i)}const aK={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},et={base:"esri-attachments",loaderContainer:"esri-attachments__loader-container",loader:"esri-attachments__loader",fadeIn:"esri-attachments--fade-in",container:"esri-attachments__container",containerList:"esri-attachments__container--list",containerPreview:"esri-attachments__container--preview",actions:"esri-attachments__actions",deleteButton:"esri-attachments__delete-button",addAttachmentButton:"esri-attachments__add-attachment-button",errorMessage:"esri-attachments__error-message",items:"esri-attachments__items",item:"esri-attachments__item",itemButton:"esri-attachments__item-button",itemMask:"esri-attachments__item-mask",itemMaskIcon:"esri-attachments__item-mask--icon",itemImage:"esri-attachments__image",itemImageResizable:"esri-attachments__image--resizable",itemLabel:"esri-attachments__label",itemFilename:"esri-attachments__filename",itemChevronIcon:"esri-attachments__item-chevron-icon",itemLink:"esri-attachments__item-link",itemLinkOverlay:"esri-attachments__item-link-overlay",itemLinkOverlayIcon:"esri-attachments__item-link-overlay-icon",itemEditIcon:"esri-attachments__item-edit-icon",itemAddIcon:"esri-attachments__item-add-icon",itemAddButton:"esri-attachments__item-add-button",formNode:"esri-attachments__form-node",fileFieldset:"esri-attachments__file-fieldset",fileLabel:"esri-attachments__file-label",fileName:"esri-attachments__file-name",fileInput:"esri-attachments__file-input",metadata:"esri-attachments__metadata",metadataFieldset:"esri-attachments__metadata-fieldset",progressBar:"esri-attachments__progress-bar",esriWidget:"esri-widget",esriButton:"esri-button",buttonDisabled:"esri-button--disabled",esriButtonSecondary:"esri-button--secondary",esriButtonTertiary:"esri-button--tertiary",esriButtonThird:"esri-button--third",esriButtonSmall:"esri-button--small",esriButtonHalf:"esri-button--half",empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},Ok=window.CSS;let sa=class extends ml{constructor(e,t){super(e,t),this.abilities=null,this.displayType="auto",this.graphic=null,this.label=void 0,this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=new mW,this.visibleElements=F({},aK),this._supportsImageOrientation=Ok&&Ok.supports&&Ok.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.own([eo(()=>{var e;return(e=this.viewModel)==null?void 0:e.attachmentInfos},"change",()=>this.scheduleRender()),ae(()=>{var e;return(e=this.viewModel)==null?void 0:e.mode},()=>this._modeChanged(),Ft)])}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}castVisibleElements(e){return F(F({},aK),e)}addAttachment(){const{_addAttachmentForm:e,viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:t}=this;return this._set("submitting",!0),this._set("error",null),t.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),t.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:t}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(t).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new q("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}render(){const{submitting:e,viewModel:t}=this,{state:i}=t;return ue("div",{class:this.classes(et.base,et.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:t}=this;return e&&t.errorMessage?ue("div",{key:"error-message",class:et.errorMessage},e.message):null}renderAttachments(){const{mode:e,activeAttachmentInfo:t}=this.viewModel;return e==="add"?this.renderAddForm():e==="edit"?this.renderDetailsForm(t):this.renderAttachmentContainer()}renderLoading(){return ue("div",{class:et.loaderContainer,key:"loader"},ue("div",{class:et.loader}))}renderProgressBar(){return this.visibleElements.progressBar?ue("div",{class:et.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:t}=this,i=e||!t,r=this.visibleElements.cancelAddButton?ue("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(et.esriButton,et.esriButtonTertiary,et.esriButtonSmall,et.esriButtonHalf,e&&et.buttonDisabled)},this.messages.cancel):null,s=this.visibleElements.addSubmitButton?ue("button",{type:"submit",disabled:i,class:this.classes(et.esriButton,et.esriButtonSecondary,et.esriButtonSmall,et.esriButtonHalf,{[et.buttonDisabled]:i})},this.messages.add):null,n=t?ue("span",{key:"file-name",class:et.fileName},t.name):null,o=ue("form",{bind:this,afterCreate:u9,afterRemoved:DJ,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},ue("fieldset",{class:et.fileFieldset},n,ue("label",{class:this.classes(et.fileLabel,et.esriButton,et.esriButtonSecondary)},t?this.messages.changeFile:this.messages.selectFile,ue("input",{class:et.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),s,r);return ue("div",{key:"add-form-container",class:et.formNode},o)}renderDetailsForm(e){const{visibleElements:t,viewModel:i,selectedFile:r,submitting:s}=this,{contentType:n,size:o,url:a}=e,{abilities:l}=i,c=s||!r,h=l.editing&&l.operations.delete&&t.deleteButton?ue("button",{key:"delete-button",type:"button",disabled:s,bind:this,onclick:S=>this._submitDeleteAttachment(S,e),class:this.classes(et.esriButton,et.esriButtonSmall,et.esriButtonTertiary,et.deleteButton,{[et.buttonDisabled]:s})},this.messages.delete):null,p=l.editing&&l.operations.update&&t.updateButton?ue("button",{disabled:c,key:"update-button",type:"submit",class:this.classes(et.esriButton,et.esriButtonSmall,et.esriButtonThird,{[et.buttonDisabled]:c})},this.messages.update):null,f=this.visibleElements.cancelUpdateButton?ue("button",{disabled:s,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(et.esriButton,et.esriButtonSmall,et.esriButtonTertiary,et.esriButtonThird,{[et.buttonDisabled]:s})},this.messages.cancel):null,m=r?ue("span",{key:"file-name",class:et.fileName},r.name):null,y=l.editing&&l.operations.update?ue("fieldset",{key:"file",class:et.fileFieldset},m,ue("label",{class:this.classes(et.fileLabel,et.esriButton,et.esriButtonSecondary)},this.messages.changeFile,ue("input",{class:et.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):null,v=ue("fieldset",{key:"size",class:et.metadataFieldset},ue("label",null,BDe(this.messagesUnits,o))),w=ue("fieldset",{key:"content-type",class:et.metadataFieldset},ue("label",null,n)),b=ue("form",{bind:this,afterCreate:u9,afterRemoved:DJ,"data-node-ref":"_updateAttachmentForm",onsubmit:this._submitUpdateAttachment},ue("div",{class:et.metadata},v,w),y,ue("div",{class:et.actions},h,f,p));return ue("div",{key:"edit-form-container",class:et.formNode},ue("a",{class:et.itemLink,href:a,rel:"noreferrer",target:"_blank"},this.renderImageMask({attachmentInfo:e,size:400}),ue("div",{class:et.itemLinkOverlay},ue("span",{class:et.itemLinkOverlayIcon},ue("svg",{xmlns:"http://www.w3.org/2000/svg",width:"32",height:"32",viewBox:"0 0 32 32"},ue("path",{d:"M28 13h1v16H3V3h16v1H4v24h24zm-5-9h4.293L15.646 15.638l.707.707L28 4.707V9h1V3h-6z"}),ue("path",{fill:"none",d:"M0 0h32v32H0z"}))))),b)}renderImageMask({attachmentInfo:e,size:t}){const{supportsResizeAttachments:i}=this.viewModel,{contentType:r,name:s,url:n}=e,o=i&&ELe(r),a=this._getCSSTransform(e,o),l=a?{transform:a,"image-orientation":"none"}:{},c=n.includes("?")?"&":"?",h=o?`${n}${c}w=${t}`:CLe(r),p={[et.itemMaskIcon]:!o},f={[et.itemImageResizable]:i};return ue("div",{class:this.classes(p,et.itemMask)},ue("img",{styles:l,alt:s,src:h,class:this.classes(f,et.itemImage)}))}renderAttachmentInfo({attachmentInfo:e,displayType:t}){const{viewModel:i}=this,{abilities:r}=i,{name:s,url:n}=e,o=this.renderImageMask({attachmentInfo:e,size:t==="list"?48:400}),a=r.editing?ue("span",{"aria-hidden":"true",class:this.classes(et.itemChevronIcon,B0(this.container)?et.iconLeft:et.iconRight)}):null,l=[o,ue("label",{class:et.itemLabel},ue("span",{class:et.itemFilename},s||this.messages.noTitle),a)],c=r.editing?ue("button",{key:"details-button",bind:this,class:et.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},l):ue("a",{key:"details-link",class:et.itemButton,href:n,target:"_blank"},l);return ue("li",{class:et.item,key:e},c)}renderAttachmentContainer(){const{effectiveDisplayType:e,viewModel:t,visibleElements:i}=this,{attachmentInfos:r,abilities:s}=t,n=r&&r.length,o={[et.containerList]:e!=="preview",[et.containerPreview]:e==="preview"},a=s.editing&&s.operations.add&&i.addButton?ue("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(et.esriButton,et.esriButtonTertiary,et.addAttachmentButton),type:"button"},ue("span",{"aria-hidden":"true",class:this.classes(et.itemAddIcon,et.iconPlus)}),this.messages.add):null,l=n?ue("ul",{class:et.items},r.toArray().map(c=>this.renderAttachmentInfo({attachmentInfo:c,displayType:e}))):ue("div",{class:et.empty},this.messages.noAttachments);return ue("div",{key:"attachments-container",class:this.classes(et.container,o)},l,a)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const t=e.target,i=t&&t.files&&t.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,t){e.preventDefault(),this.deleteAttachment(t)}_submitAddAttachment(e){e.preventDefault(),this.addAttachment()}_submitUpdateAttachment(e){e.preventDefault(),this.updateAttachment()}_startEditAttachment(e){const{viewModel:t}=this;t.activeAttachmentInfo=e,t.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e,t){const{orientationInfo:i}=e;return!this._supportsImageOrientation&&t&&i?[i.rotation?`rotate(${i.rotation}deg)`:"",i.mirrored?"scaleX(-1)":""].join(" "):""}};u([wt("viewModel.abilities")],sa.prototype,"abilities",void 0),u([d()],sa.prototype,"displayType",void 0),u([d({readOnly:!0})],sa.prototype,"effectiveDisplayType",null),u([wt("viewModel.graphic")],sa.prototype,"graphic",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],sa.prototype,"label",void 0),u([d(),Ql("esri/widgets/Attachments/t9n/Attachments")],sa.prototype,"messages",void 0),u([d(),Ql("esri/core/t9n/Units")],sa.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],sa.prototype,"selectedFile",void 0),u([d({readOnly:!0})],sa.prototype,"submitting",void 0),u([d({readOnly:!0})],sa.prototype,"error",void 0),u([d({type:mW})],sa.prototype,"viewModel",void 0),u([d()],sa.prototype,"visibleElements",void 0),u([Ot("visibleElements")],sa.prototype,"castVisibleElements",null),sa=u([P("esri.widgets.Attachments")],sa);const MLe=sa;let iA=class extends mW{constructor(e){super(e),this.description=null,this.title=null}};u([d()],iA.prototype,"description",void 0),u([d()],iA.prototype,"title",void 0),iA=u([P("esri.widgets.Feature.FeatureAttachments.FeatureAttachmentsViewModel")],iA);const gW=iA,OLe={heading:"esri-widget__heading"};function yW(e,t){const i=PLe(e.level),r=`h${i}`;return delete e.level,ue(r,ve(F({},e),{class:nfe(OLe.heading,e.class),role:"heading","aria-level":String(i)}),t)}function PLe(e){return $e(Math.ceil(e),1,6)}const Pk={base:"esri-feature-element-info",title:"esri-feature-element-info__title",description:"esri-feature-element-info__description"};let Nx=class extends ml{constructor(e,t){super(e,t),this.description=null,this.headingLevel=2,this.title=null}render(){return ue("div",{class:Pk.base},this.renderTitle(),this.renderDescription())}renderTitle(){const{title:e}=this;return e?ue(yW,{level:this.headingLevel,class:Pk.title},e):null}renderDescription(){const{description:e}=this;return e?ue("div",{key:"description",class:Pk.description},e):null}};u([d()],Nx.prototype,"description",void 0),u([d()],Nx.prototype,"headingLevel",void 0),u([d()],Nx.prototype,"title",void 0),Nx=u([P("esri.widgets.Feature.support.FeatureElementInfo")],Nx);const vW=Nx,ILe={base:"esri-feature-attachments"};let Mp=class extends ml{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attachmentsWidget=new MLe,this.description=null,this.displayType=null,this.graphic=null,this.headingLevel=2,this.title=null,this.viewModel=new gW}initialize(){this._featureElementInfo=new vW,this.own([ae(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.description,(t=this.viewModel)==null?void 0:t.title,this.headingLevel]},()=>this._setupFeatureElementInfo(),Ft),ae(()=>{var e;return(e=this.viewModel)==null?void 0:e.graphic},e=>this.attachmentsWidget.graphic=e,Ft)])}destroy(){this.attachmentsWidget.destroy(),this._featureElementInfo.destroy()}render(){var t;const{attachmentsWidget:e}=this;return ue("div",{class:ILe.base},(t=this._featureElementInfo)==null?void 0:t.render(),e==null?void 0:e.render())}_setupFeatureElementInfo(){const{description:e,title:t,headingLevel:i}=this;this._featureElementInfo.set({description:e,title:t,headingLevel:i})}};u([d({readOnly:!0})],Mp.prototype,"attachmentsWidget",void 0),u([wt("viewModel.description")],Mp.prototype,"description",void 0),u([wt("attachmentsWidget.displayType")],Mp.prototype,"displayType",void 0),u([wt("viewModel.graphic")],Mp.prototype,"graphic",void 0),u([d()],Mp.prototype,"headingLevel",void 0),u([wt("viewModel.title")],Mp.prototype,"title",void 0),u([d({type:gW})],Mp.prototype,"viewModel",void 0),Mp=u([P("esri.widgets.Feature.FeatureAttachments")],Mp);const $Le=Mp;let By=class extends mw(Ee){constructor(e){super(e),this._loadingPromise=null,this.created=null,this.creator=null,this.destroyer=null,this.graphic=null,this.handles.add(ae(()=>this.creator,t=>{this._destroyContent(),this._createContent(t)},Ft))}destroy(){this._destroyContent()}get state(){return this._loadingPromise?"loading":"ready"}_destroyContent(){const{created:e,graphic:t,destroyer:i}=this;e&&(RN(i,{graphic:t}).catch(()=>null),this._set("created",null))}async _createContent(e){const{graphic:t}=this,i=RN(e,{graphic:t}).catch(()=>null);this._loadingPromise=i,this.notifyChange("state");const r=await i;i===this._loadingPromise&&(this._loadingPromise=null,this.notifyChange("state"),this._set("created",r))}};u([d({readOnly:!0})],By.prototype,"created",void 0),u([d()],By.prototype,"creator",void 0),u([d()],By.prototype,"destroyer",void 0),u([d({type:Ca})],By.prototype,"graphic",void 0),u([d({readOnly:!0})],By.prototype,"state",null),By=u([P("esri.widgets.Feature.FeatureContent.FeatureContentViewModel")],By);const ON=By;function Zu(){return function(e,t){if(!e[t])throw new TypeError(`Cannot auto bind undefined function '${t}'`);return{value:LLe(e[t])}}}function DLe(e){const{type:t}=e;return e instanceof KeyboardEvent||t==="keyup"||t==="keydown"||t==="keypress"}function LLe(e){return function(t,...i){DLe(t)?T$e(t.key)&&(t.preventDefault(),t.stopPropagation(),t.target.click()):e.call(this,t,...i)}}function NLe(e){return e.split(",").map(t=>t.trim())}function FLe(e){return t=>{t.hasOwnProperty("_delegatedEventNames")||(t._delegatedEventNames=t._delegatedEventNames?t._delegatedEventNames.slice():[]);const i=t._delegatedEventNames,r=Array.isArray(e)?e:NLe(e);i.push(...r)}}const Yfe="calcite-theme-";function ULe(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-theme-name").replace(/\s|'|"/g,"")}function Zfe(){return ULe().startsWith("dark")}function kLe(){return`${Yfe}${Zfe()?"dark":"light"}`}function zLe(e){VLe(e),e.classList.add(kLe())}function VLe(e){Array.from(e.classList).forEach(t=>{t.startsWith(Yfe)&&e.classList.remove(t)})}function Qfe(e){return e&&typeof e.render=="function"}function BLe(e){return e&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}const Ik={base:"esri-feature-content",loaderContainer:"esri-feature-content__loader-container",loader:"esri-feature-content__loader"};let Fx=class extends ml{constructor(e,t){super(e,t),this.creator=null,this.graphic=null,this.viewModel=null,this._addTargetToAnchors=i=>{Array.from(i.querySelectorAll("a")).forEach(r=>{zfe(r.href)&&!r.hasAttribute("target")&&r.setAttribute("target","_blank")})}}renderLoading(){return ue("div",{class:Ik.loaderContainer,key:"loader"},ue("div",{class:Ik.loader}))}renderCreated(){var t;const e=(t=this.viewModel)==null?void 0:t.created;return e?e instanceof HTMLElement?ue("div",{key:e,bind:e,afterCreate:this._attachToNode}):Qfe(e)?ue("div",{key:e},!e.destroyed&&e.render()):ue("div",{key:e,innerHTML:e,afterCreate:this._addTargetToAnchors}):null}render(){var t;const e=(t=this.viewModel)==null?void 0:t.state;return ue("div",{class:Ik.base},e==="loading"?this.renderLoading():this.renderCreated())}_attachToNode(e){const t=this;e.appendChild(t)}};u([wt("viewModel.creator")],Fx.prototype,"creator",void 0),u([wt("viewModel.graphic")],Fx.prototype,"graphic",void 0),u([d({type:ON})],Fx.prototype,"viewModel",void 0),Fx=u([P("esri.widgets.Feature.FeatureContent")],Fx);const nD=Fx;let gm=class extends Ee{constructor(e){super(e),this.attributes=null,this.expressionInfos=null,this.description=null,this.fieldInfos=null,this.title=null}get formattedFieldInfos(){const{expressionInfos:e,fieldInfos:t}=this,i=[];return t==null||t.forEach(r=>{if(!(!r.hasOwnProperty("visible")||r.visible))return;const s=r.clone();s.label=Bfe(s,e),i.push(s)}),i}};u([d()],gm.prototype,"attributes",void 0),u([d({type:[Bue]})],gm.prototype,"expressionInfos",void 0),u([d()],gm.prototype,"description",void 0),u([d({type:[bO]})],gm.prototype,"fieldInfos",void 0),u([d({readOnly:!0})],gm.prototype,"formattedFieldInfos",null),u([d()],gm.prototype,"title",void 0),gm=u([P("esri.widgets.Feature.FeatureFields.FeatureFieldsViewModel")],gm);const V4=gm,GLe=[{pattern:/^\s*(https?:\/\/([^\s]+))\s*$/i,target:"_blank",label:"{messages.view}"},{pattern:/^\s*(tel:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(mailto:([^\s]+))\s*$/i,label:"{hierPart}"},{pattern:/^\s*(arcgis-appstudio-player:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"App Studio Player"},{pattern:/^\s*(arcgis-collector:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Collector"},{pattern:/^\s*(arcgis-explorer:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Explorer"},{pattern:/^\s*(arcgis-navigator:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Navigator"},{pattern:/^\s*(arcgis-survey123:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Survey123"},{pattern:/^\s*(arcgis-trek2there:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Trek2There"},{pattern:/^\s*(arcgis-workforce:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Workforce"},{pattern:/^\s*(iform:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"iForm"},{pattern:/^\s*(flow:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"FlowFinity"},{pattern:/^\s*(lfmobile:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Laserfische"},{pattern:/^\s*(mspbi:\/\/([^\s]+))\s*$/i,label:"{messages.openInApp}",appName:"Microsoft Power Bi"}];function jLe(e){let t=null;return GLe.some(i=>(i.pattern.test(e)&&(t=i),!!t)),t}function HLe(e,t){if(typeof t!="string"||!t)return t;const i=jLe(t);if(!i)return t;const r=t.match(i.pattern),s=r&&r[2],n=gf(gf(i.label,{messages:e,hierPart:s}),{appName:i.appName}),o=i.target?` target="${i.target}"`:"",a=i.target==="_blank"?' rel="noreferrer"':"";return t.replace(i.pattern,`<a${o} href="$1"${a}>${n}</a>`)}const CE={base:"esri-feature-fields",fieldHeader:"esri-feature-fields__field-header",fieldData:"esri-feature-fields__field-data",fieldDataDate:"esri-feature-fields__field-data--date",esriTable:"esri-widget__table"};let td=class extends ml{constructor(e,t){super(e,t),this._featureElementInfo=null,this.attributes=null,this.description=null,this.expressionInfos=null,this.fieldInfos=null,this.title=null,this.viewModel=new V4,this.messages=null,this.messagesURIUtils=null}initialize(){this._featureElementInfo=new vW,this.own(ae(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.description,(t=this.viewModel)==null?void 0:t.title]},()=>this._setupFeatureElementInfo(),Ft))}destroy(){this._featureElementInfo.destroy()}renderFieldInfo(e,t){const{attributes:i}=this.viewModel,r=e.fieldName,s=e.label||r,n=i?i[r]==null?"":i[r]:"",o=!(!e.format||!e.format.dateFormat),a=typeof n=="number"&&!o?this._forceLTR(n):HLe(this.messagesURIUtils,n),l={[CE.fieldDataDate]:o};return ue("tr",{key:`fields-element-info-row-${r}-${t}`},ue("th",{key:`fields-element-info-row-header-${r}-${t}`,class:CE.fieldHeader,innerHTML:s}),ue("td",{key:`fields-element-info-row-data-${r}-${t}`,class:this.classes(CE.fieldData,l),innerHTML:a}))}renderFields(){const{formattedFieldInfos:e}=this.viewModel;return(e==null?void 0:e.length)?ue("table",{class:CE.esriTable,summary:this.messages.fieldsSummary},ue("tbody",null,e.map((t,i)=>this.renderFieldInfo(t,i)))):null}render(){var e;return ue("div",{class:CE.base},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderFields())}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_forceLTR(e){return`&lrm;${e}`}};u([wt("viewModel.attributes")],td.prototype,"attributes",void 0),u([wt("viewModel.description")],td.prototype,"description",void 0),u([wt("viewModel.expressionInfos")],td.prototype,"expressionInfos",void 0),u([wt("viewModel.fieldInfos")],td.prototype,"fieldInfos",void 0),u([wt("viewModel.title")],td.prototype,"title",void 0),u([d({type:V4})],td.prototype,"viewModel",void 0),u([d(),Ql("esri/widgets/Feature/t9n/Feature")],td.prototype,"messages",void 0),u([d(),Ql("esri/widgets/support/t9n/uriUtils")],td.prototype,"messagesURIUtils",void 0),td=u([P("esri.widgets.Feature.FeatureFields")],td);const Jfe=td,qLe={maximumFractionDigits:20};function WLe(e){return bf(e,qLe)}var T9;let q_=T9=class extends fe{constructor(e){super(e),this.color=null,this.label=null,this.value=null}writeValue(e,t,i){t[i]=e==null?0:e}clone(){return new T9({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:qe,json:{type:[yr],write:!0}})],q_.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],q_.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],q_.prototype,"value",void 0),u([Be("value")],q_.prototype,"writeValue",null),q_=T9=u([P("esri.renderers.visualVariables.support.ColorStop")],q_);const XLe=q_;function B4(e,t,i){return pn(e.map((r,s)=>t.apply(i,[r,s])))}async function YLe(e,t,i){return(await pn(e.map((r,s)=>t.apply(i,[r,s])))).map(r=>r.value)}async function nc(e){if(R(e))return{ok:!1,error:new Error("no promise provided")};try{return{ok:!0,value:await e}}catch(t){return{ok:!1,error:t}}}async function wvt(e){try{return{ok:!0,value:await e}}catch(t){return Pg(t),{ok:!1,error:t}}}function xvt(e){if(e.ok===!0)return e.value;throw e.error}function OO(){const e=new Float32Array(16);return e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function ZLe(e){const t=new Float32Array(16);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function QLe(e,t,i,r,s,n,o,a,l,c,h,p,f,m,y,v){const w=new Float32Array(16);return w[0]=e,w[1]=t,w[2]=i,w[3]=r,w[4]=s,w[5]=n,w[6]=o,w[7]=a,w[8]=l,w[9]=c,w[10]=h,w[11]=p,w[12]=f,w[13]=m,w[14]=y,w[15]=v,w}function JLe(e,t){return new Float32Array(e,t,16)}const KLe=OO();Object.freeze(Object.defineProperty({__proto__:null,create:OO,clone:ZLe,fromValues:QLe,createView:JLe,IDENTITY:KLe},Symbol.toStringTag,{value:"Module"}));const eNe=(e,t)=>{const i=Nf(e,t,0,0,0,0,t,0,0,0,0,t,0,0,0,0,1);return dl(i,i)},tNe=(e,t)=>{const i=Nf(e,t,0,0,.5-.5*t,0,t,0,.5-.5*t,0,0,t,.5-.5*t,0,0,0,1);return dl(i,i)},iNe=(e,t)=>{const i=1-t,r=Nf(e,.2126+.7874*i,.7152-.7152*i,.0722-.0722*i,0,.2126-.2126*i,.7152+.2848*i,.0722-.0722*i,0,.2126-.2126*i,.7152-.7152*i,.0722+.9278*i,0,0,0,0,1);return dl(r,r)},rNe=(e,t)=>{const i=Math.sin(t*Math.PI/180),r=Math.cos(t*Math.PI/180),s=Nf(e,.213+.787*r-.213*i,.715-.715*r-.715*i,.072-.072*r+.928*i,0,.213-.213*r+.143*i,.715+.285*r+.14*i,.072-.072*r-.283*i,0,.213-.213*r-.787*i,.715-.715*r+.715*i,.072+.928*r+.072*i,0,0,0,0,1);return dl(s,s)},sNe=(e,t)=>{const i=1-2*t,r=Nf(e,i,0,0,t,0,i,0,t,0,0,i,t,0,0,0,1);return dl(r,r)},nNe=(e,t)=>{const i=Nf(e,.213+.787*t,.715-.715*t,.072-.072*t,0,.213-.213*t,.715+.285*t,.072-.072*t,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,1);return dl(i,i)},oNe=(e,t)=>{const i=1-t,r=Nf(e,.393+.607*i,.769-.769*i,.189-.189*i,0,.349-.349*i,.686+.314*i,.168-.168*i,0,.272-.272*i,.534-.534*i,.131+.869*i,0,0,0,0,1);return dl(r,r)};class G4{constructor(t,i,r){this.strength=t,this.radius=i,this.threshold=r,this.type="bloom"}interpolate(t,i,r){this.strength=Ul(t.strength,i.strength,r),this.radius=Ul(t.radius,i.radius,r),this.threshold=Ul(t.threshold,i.threshold,r)}clone(){return new G4(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:nR(this.radius),strength:this.strength,threshold:this.threshold}}}class j4{constructor(t){this.radius=t,this.type="blur"}interpolate(t,i,r){this.radius=Math.round(Ul(t.radius,i.radius,r))}clone(){return new j4(this.radius)}toJSON(){return{type:"blur",radius:nR(this.radius)}}}class nM{constructor(t,i){this.type=t,this.amount=i,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.amount=Ul(t.amount,i.amount,r),this._updateMatrix()}clone(){return new nM(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const t=this._colorMatrix||OO();switch(this.type){case"brightness":this._colorMatrix=eNe(t,this.amount);break;case"contrast":this._colorMatrix=tNe(t,this.amount);break;case"grayscale":this._colorMatrix=iNe(t,this.amount);break;case"invert":this._colorMatrix=sNe(t,this.amount);break;case"saturate":this._colorMatrix=nNe(t,this.amount);break;case"sepia":this._colorMatrix=oNe(t,this.amount)}}}class H4{constructor(t,i,r,s){this.offsetX=t,this.offsetY=i,this.blurRadius=r,this.color=s,this.type="drop-shadow"}interpolate(t,i,r){this.offsetX=Ul(t.offsetX,i.offsetX,r),this.offsetY=Ul(t.offsetY,i.offsetY,r),this.blurRadius=Ul(t.blurRadius,i.blurRadius,r),this.color[0]=Math.round(Ul(t.color[0],i.color[0],r)),this.color[1]=Math.round(Ul(t.color[1],i.color[1],r)),this.color[2]=Math.round(Ul(t.color[2],i.color[2],r)),this.color[3]=Ul(t.color[3],i.color[3],r)}clone(){return new H4(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const t=[...this.color];return t[3]*=255,{type:"drop-shadow",xoffset:nR(this.offsetX),yoffset:nR(this.offsetY),blurRadius:nR(this.blurRadius),color:t}}}class q4{constructor(t){this.angle=t,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(t,i,r){this.angle=Ul(t.angle,i.angle,r),this._updateMatrix()}clone(){return new q4(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const t=this._colorMatrix||OO();this._colorMatrix=rNe(t,this.angle)}}class W4{constructor(t){this.amount=t,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(t,i,r){this.amount=Ul(t.amount,i.amount,r)}clone(){return new W4(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}}function Ul(e,t,i){return e+(t-e)*i}function nR(e){return Math.round(1e3*uu(e))/1e3}function aNe(e){switch(e.type){case"grayscale":case"sepia":case"invert":return new nM(e.type,0);case"saturate":case"brightness":case"contrast":return new nM(e.type,1);case"opacity":return new W4(1);case"hue-rotate":return new q4(0);case"blur":return new j4(0);case"drop-shadow":return new H4(0,0,0,[...cH("transparent")]);case"bloom":return new G4(0,0,1)}}var Tvt=typeof globalThis!="undefined"?globalThis:typeof window!="undefined"?window:typeof global!="undefined"?global:typeof self!="undefined"?self:{};function Svt(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}function Evt(e){throw new Error('Could not dynamically require "'+e+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}function lNe(e,t){const i=e.length>t.length?e:t;return(e.length>t.length?t:e).every((r,s)=>r.type===i[s].type)}function cNe(e,t){const i=e.length>t.length?e:t,r=e.length>t.length?t:e;for(let s=r.length;s<i.length;s++)r.push(aNe(i[s]))}function uNe(e){const t=e[0];return!!t&&"type"in t}var lK,cK,Kfe={exports:{}};function eme(e){if(!e||e.length===0)return null;if(typeof e=="string"){const i=uK(e);return i&&i.length!==0?i:null}const t=e.map(i=>{if(!Number.isFinite(i.scale)||i.scale<=0)throw new q("effect:invalid-scale","scale must be finite and greater than 0",{stop:i});return{scale:i.scale,effects:uK(i.value)}});t.sort((i,r)=>r.effects.length-i.effects.length);for(let i=0;i<t.length-1;i++){if(!lNe(t[i].effects,t[i+1].effects))throw new q("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:t[i].effects,b:t[i+1].effects});cNe(t[i].effects,t[i+1].effects)}return t.sort((i,r)=>r.scale-i.scale),t}function uK(e){let t;if(!e)return[];try{t=Kfe.exports.parse(e)}catch(i){throw new q("effect:invalid-syntax","Invalid effect syntax",{value:e,error:i})}return t.map(i=>hNe(i))}function hNe(e){try{switch(e.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return dNe(e);case"opacity":return pNe(e);case"hue-rotate":return fNe(e);case"blur":return mNe(e);case"drop-shadow":return gNe(e);case"bloom":return yNe(e)}}catch(t){throw t.details.filter=e,t}throw new q("effect:unknown-effect",`Effect '${e.name}' is not supported`,{effect:e})}function dNe(e){let t=1;return Y2(e.parameters,1),e.parameters.length===1&&(t=_d(e.parameters[0])),new nM(e.name,t)}function pNe(e){let t=1;return Y2(e.parameters,1),e.parameters.length===1&&(t=_d(e.parameters[0])),new W4(t)}function fNe(e){let t=0;return Y2(e.parameters,1),e.parameters.length===1&&(t=TNe(e.parameters[0])),new q4(t)}function mNe(e){let t=0;return Y2(e.parameters,1),e.parameters.length===1&&(t=wW(e.parameters[0]),PO(t,e.parameters[0])),new j4(t)}function gNe(e){const t=[];let i=null;for(const r of e.parameters)if(r.type==="color"){if(t.length&&Object.freeze(t),i)throw new q("effect:type-error","Accepts only one color",{});i=SNe(r)}else{const s=wW(r);if(Object.isFrozen(t))throw new q("effect:type-error","<length> parameters not consecutive",{lengths:t});t.push(s),t.length===3&&PO(s,r)}if(t.length<2||t.length>3)throw new q("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${t.length}}`,{lengths:t});return new H4(t[0],t[1],t[2]||0,i||tme("black"))}function yNe(e){let t=1,i=0,r=0;return Y2(e.parameters,3),e.parameters[0]&&(t=_d(e.parameters[0])),e.parameters[1]&&(i=wW(e.parameters[1]),PO(i,e.parameters[1])),e.parameters[2]&&(r=_d(e.parameters[2])),new G4(t,i,r)}function Y2(e,t){if(e.length>t)throw new q("effect:type-error",`Function supports up to ${t} parameters, Actual: ${e.length}`,{parameters:e})}function X4(e){if(e.type==="color")return"<color>";if(e.unit){if(bW[e.unit])return"<length>";if(_W[e.unit])return"<angle>";if(e.unit==="%")return"<percentage>"}return"<double>"}function PO(e,t){if(e<0)throw new q("effect:type-error",`Negative values are not allowed, Actual: ${e}`,{term:t})}function vNe(e){if(e.type!=="quantity"||e.unit!==null)throw new q("effect:type-error",`Expected <double>, Actual: ${X4(e)}`,{term:e})}function _Ne(e){if(e.type!=="quantity"||e.unit!==null&&e.unit!=="%")throw new q("effect:type-error",`Expected <double> or <percentage>, Actual: ${X4(e)}`,{term:e})}cK=function(){function e(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function t(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,t.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function i(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function r(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:jZ},h=jZ,p="none",f=")",m=",",y="(",v="%",w="px",b="cm",S="mm",T="in",E="pt",C="pc",M="deg",I="rad",N="grad",D="turn",z="#",V=".",k="e",Y=/^[ \t\n\r]/,Z=/^[a-z\-]/,le=/^[0-9a-fA-F]/,ne=/^[+\-]/,$=/^[0-9]/,U=Fh("none"),B=mn("none",!1),H=mn(")",!1),W=mn(",",!1),K=Fh("whitespace"),j=Xv([" ","	",`
`,"\r"],!1,!1),ee=Fh("function"),ye=mn("(",!1),Te=Fh("identifier"),Ne=Xv([["a","z"],"-"],!1,!1),_e=Fh("percentage"),ge=mn("%",!1),Ce=Fh("length"),Le=mn("px",!1),Ri=mn("cm",!1),Li=mn("mm",!1),ii=mn("in",!1),Ni=mn("pt",!1),ni=mn("pc",!1),Fi=Fh("angle"),Fr=mn("deg",!1),es=mn("rad",!1),rt=mn("grad",!1),Er=mn("turn",!1),Pn=Fh("number"),Oa=Fh("color"),Qo=mn("#",!1),Lh=Xv([["0","9"],["a","f"],["A","F"]],!1,!1),Nh=Xv(["+","-"],!1,!1),Jo=Xv([["0","9"]],!1,!1),jv=mn(".",!1),kU=mn("e",!1),zU=function(){return[]},h3=function(X,be){return{type:"function",name:X,parameters:be||[]}},d3=function(X,be){return be.length>0?cSe(X,be,3):[X]},p3=function(X){return{type:"quantity",value:X.value,unit:X.unit}},f3=function(X){return{type:"color",colorType:X.type,value:X.value}},VU=function(X){return X},BU=function(){return Wv()},GU=function(X){return{value:X,unit:"%"}},jU=function(X){return{value:X,unit:"px"}},hE=function(X){return{value:X,unit:"cm"}},m3=function(X){return{value:X,unit:"mm"}},g3=function(X){return{value:X,unit:"in"}},y3=function(X){return{value:X,unit:"pt"}},Ci=function(X){return{value:X,unit:"pc"}},Ro=function(X){return{value:X,unit:"deg"}},no=function(X){return{value:X,unit:"rad"}},gl=function(X){return{value:X,unit:"grad"}},Hv=function(X){return{value:X,unit:"turn"}},v3=function(X){return{value:X,unit:null}},_3=function(){return{type:"hex",value:Wv()}},b3=function(X){return{type:"function",value:X}},w3=function(){return{type:"named",value:Wv()}},ep=function(){return parseFloat(Wv())},ce=0,Cr=0,Sw=[{line:1,column:1}],bu=0,qv=[],ut=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function Wv(){return s.substring(Cr,ce)}function mn(X,be){return{type:"literal",text:X,ignoreCase:be}}function Xv(X,be,Oe){return{type:"class",parts:X,inverted:be,ignoreCase:Oe}}function x3(){return{type:"end"}}function Fh(X){return{type:"other",description:X}}function dE(X){var be,Oe=Sw[X];if(Oe)return Oe;for(be=X-1;!Sw[be];)be--;for(Oe={line:(Oe=Sw[be]).line,column:Oe.column};be<X;)s.charCodeAt(be)===10?(Oe.line++,Oe.column=1):Oe.column++,be++;return Sw[X]=Oe,Oe}function T3(X,be){var Oe=dE(X),pi=dE(be);return{source:l,start:{offset:X,line:Oe.line,column:Oe.column},end:{offset:be,line:pi.line,column:pi.column}}}function Wt(X){ce<bu||(ce>bu&&(bu=ce,qv=[]),qv.push(X))}function JTe(X,be,Oe){return new t(t.buildMessage(X,be),X,be,Oe)}function jZ(){var X;return(X=KTe())===a&&(X=eSe()),X}function KTe(){var X,be;return ut++,X=ce,oo(),s.substr(ce,4)===p?(be=p,ce+=4):(be=a,ut===0&&Wt(B)),be!==a?(oo(),Cr=X,X=zU()):(ce=X,X=a),ut--,X===a&&ut===0&&Wt(U),X}function eSe(){var X,be;if(X=[],(be=HU())!==a)for(;be!==a;)X.push(be),be=HU();else X=a;return X}function HU(){var X,be,Oe,pi;return X=ce,oo(),(be=iSe())!==a?(oo(),(Oe=tSe())===a&&(Oe=null),oo(),s.charCodeAt(ce)===41?(pi=f,ce++):(pi=a,ut===0&&Wt(H)),pi!==a?(oo(),Cr=X,X=h3(be,Oe)):(ce=X,X=a)):(ce=X,X=a),X}function tSe(){var X,be,Oe,pi,Mo,_s,xu,S3;if(X=ce,(be=qU())!==a){for(Oe=[],pi=ce,Mo=oo(),s.charCodeAt(ce)===44?(_s=m,ce++):(_s=a,ut===0&&Wt(W)),_s===a&&(_s=null),xu=oo(),(S3=qU())!==a?pi=Mo=[Mo,_s,xu,S3]:(ce=pi,pi=a);pi!==a;)Oe.push(pi),pi=ce,Mo=oo(),s.charCodeAt(ce)===44?(_s=m,ce++):(_s=a,ut===0&&Wt(W)),_s===a&&(_s=null),xu=oo(),(S3=qU())!==a?pi=Mo=[Mo,_s,xu,S3]:(ce=pi,pi=a);Cr=X,X=d3(be,Oe)}else ce=X,X=a;return X}function qU(){var X,be;return X=ce,(be=rSe())===a&&(be=sSe())===a&&(be=nSe())===a&&(be=oSe()),be!==a&&(Cr=X,be=p3(be)),(X=be)===a&&(X=ce,(be=aSe())!==a&&(Cr=X,be=f3(be)),X=be),X}function oo(){var X,be;for(ut++,X=[],Y.test(s.charAt(ce))?(be=s.charAt(ce),ce++):(be=a,ut===0&&Wt(j));be!==a;)X.push(be),Y.test(s.charAt(ce))?(be=s.charAt(ce),ce++):(be=a,ut===0&&Wt(j));return ut--,be=a,ut===0&&Wt(K),X}function iSe(){var X,be,Oe;return ut++,X=ce,(be=HZ())!==a?(s.charCodeAt(ce)===40?(Oe=y,ce++):(Oe=a,ut===0&&Wt(ye)),Oe!==a?(Cr=X,X=VU(be)):(ce=X,X=a)):(ce=X,X=a),ut--,X===a&&(be=a,ut===0&&Wt(ee)),X}function HZ(){var X,be,Oe;if(ut++,X=ce,be=[],Z.test(s.charAt(ce))?(Oe=s.charAt(ce),ce++):(Oe=a,ut===0&&Wt(Ne)),Oe!==a)for(;Oe!==a;)be.push(Oe),Z.test(s.charAt(ce))?(Oe=s.charAt(ce),ce++):(Oe=a,ut===0&&Wt(Ne));else be=a;return be!==a&&(Cr=X,be=BU()),ut--,(X=be)===a&&(be=a,ut===0&&Wt(Te)),X}function rSe(){var X,be,Oe;return ut++,X=ce,oo(),(be=wu())!==a?(s.charCodeAt(ce)===37?(Oe=v,ce++):(Oe=a,ut===0&&Wt(ge)),Oe!==a?(Cr=X,X=GU(be)):(ce=X,X=a)):(ce=X,X=a),ut--,X===a&&ut===0&&Wt(_e),X}function sSe(){var X,be,Oe;return ut++,X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===w?(Oe=w,ce+=2):(Oe=a,ut===0&&Wt(Le)),Oe!==a?(Cr=X,X=jU(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===b?(Oe=b,ce+=2):(Oe=a,ut===0&&Wt(Ri)),Oe!==a?(Cr=X,X=hE(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===S?(Oe=S,ce+=2):(Oe=a,ut===0&&Wt(Li)),Oe!==a?(Cr=X,X=m3(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===T?(Oe=T,ce+=2):(Oe=a,ut===0&&Wt(ii)),Oe!==a?(Cr=X,X=g3(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===E?(Oe=E,ce+=2):(Oe=a,ut===0&&Wt(Ni)),Oe!==a?(Cr=X,X=y3(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,oo(),(be=wu())!==a?(s.substr(ce,2)===C?(Oe=C,ce+=2):(Oe=a,ut===0&&Wt(ni)),Oe!==a?(Cr=X,X=Ci(be)):(ce=X,X=a)):(ce=X,X=a)))))),ut--,X===a&&ut===0&&Wt(Ce),X}function nSe(){var X,be,Oe;return ut++,X=ce,(be=wu())!==a?(s.substr(ce,3)===M?(Oe=M,ce+=3):(Oe=a,ut===0&&Wt(Fr)),Oe!==a?(Cr=X,X=Ro(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(be=wu())!==a?(s.substr(ce,3)===I?(Oe=I,ce+=3):(Oe=a,ut===0&&Wt(es)),Oe!==a?(Cr=X,X=no(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(be=wu())!==a?(s.substr(ce,4)===N?(Oe=N,ce+=4):(Oe=a,ut===0&&Wt(rt)),Oe!==a?(Cr=X,X=gl(be)):(ce=X,X=a)):(ce=X,X=a),X===a&&(X=ce,(be=wu())!==a?(s.substr(ce,4)===D?(Oe=D,ce+=4):(Oe=a,ut===0&&Wt(Er)),Oe!==a?(Cr=X,X=Hv(be)):(ce=X,X=a)):(ce=X,X=a)))),ut--,X===a&&(be=a,ut===0&&Wt(Fi)),X}function oSe(){var X,be;return ut++,X=ce,oo(),(be=wu())!==a?(Cr=X,X=v3(be)):(ce=X,X=a),ut--,X===a&&ut===0&&Wt(Pn),X}function aSe(){var X,be,Oe,pi;if(ut++,X=ce,s.charCodeAt(ce)===35?(be=z,ce++):(be=a,ut===0&&Wt(Qo)),be!==a){if(Oe=[],le.test(s.charAt(ce))?(pi=s.charAt(ce),ce++):(pi=a,ut===0&&Wt(Lh)),pi!==a)for(;pi!==a;)Oe.push(pi),le.test(s.charAt(ce))?(pi=s.charAt(ce),ce++):(pi=a,ut===0&&Wt(Lh));else Oe=a;Oe!==a?(Cr=X,X=_3()):(ce=X,X=a)}else ce=X,X=a;return X===a&&(X=ce,(be=HU())!==a&&(Cr=X,be=b3(be)),(X=be)===a&&(X=ce,(be=HZ())!==a&&(Cr=X,be=w3()),X=be)),ut--,X===a&&(be=a,ut===0&&Wt(Oa)),X}function wu(){var X,be,Oe,pi,Mo,_s,xu;for(X=ce,ne.test(s.charAt(ce))?(s.charAt(ce),ce++):ut===0&&Wt(Nh),be=ce,Oe=[],$.test(s.charAt(ce))?(pi=s.charAt(ce),ce++):(pi=a,ut===0&&Wt(Jo));pi!==a;)Oe.push(pi),$.test(s.charAt(ce))?(pi=s.charAt(ce),ce++):(pi=a,ut===0&&Wt(Jo));if(s.charCodeAt(ce)===46?(pi=V,ce++):(pi=a,ut===0&&Wt(jv)),pi!==a){if(Mo=[],$.test(s.charAt(ce))?(_s=s.charAt(ce),ce++):(_s=a,ut===0&&Wt(Jo)),_s!==a)for(;_s!==a;)Mo.push(_s),$.test(s.charAt(ce))?(_s=s.charAt(ce),ce++):(_s=a,ut===0&&Wt(Jo));else Mo=a;Mo!==a?be=Oe=[Oe,pi,Mo]:(ce=be,be=a)}else ce=be,be=a;if(be===a)if(be=[],$.test(s.charAt(ce))?(Oe=s.charAt(ce),ce++):(Oe=a,ut===0&&Wt(Jo)),Oe!==a)for(;Oe!==a;)be.push(Oe),$.test(s.charAt(ce))?(Oe=s.charAt(ce),ce++):(Oe=a,ut===0&&Wt(Jo));else be=a;if(be!==a){if(Oe=ce,s.charCodeAt(ce)===101?(pi=k,ce++):(pi=a,ut===0&&Wt(kU)),pi!==a){if(ne.test(s.charAt(ce))?(Mo=s.charAt(ce),ce++):(Mo=a,ut===0&&Wt(Nh)),Mo===a&&(Mo=null),_s=[],$.test(s.charAt(ce))?(xu=s.charAt(ce),ce++):(xu=a,ut===0&&Wt(Jo)),xu!==a)for(;xu!==a;)_s.push(xu),$.test(s.charAt(ce))?(xu=s.charAt(ce),ce++):(xu=a,ut===0&&Wt(Jo));else _s=a;_s!==a?Oe=pi=[pi,Mo,_s]:(ce=Oe,Oe=a)}else ce=Oe,Oe=a;Oe===a&&(Oe=null),Cr=X,X=ep()}else ce=X,X=a;return X}function lSe(X,be){return X.map(function(Oe){return Oe[be]})}function cSe(X,be,Oe){return[X].concat(lSe(be,Oe))}if((o=h())!==a&&ce===s.length)return o;throw o!==a&&ce<s.length&&Wt(x3()),JTe(qv,bu<s.length?s.charAt(bu):null,bu<s.length?T3(bu,bu+1):T3(bu,bu))}return e(t,Error),t.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source+":"+l.line+":"+l.column;if(a){var h=this.location.end,p=i("",l.line.toString().length),f=a[l.line-1],m=l.line===h.line?h.column:f.length+1;n+=`
 --> `+c+`
`+p+` |
`+l.line+" | "+f+`
`+p+" | "+i("",l.column-1)+i("",m-l.column,"^")}else n+=`
 at `+c}return n},t.buildMessage=function(s,n){var o={literal:function(m){return'"'+l(m.text)+'"'},class:function(m){var y=m.parts.map(function(v){return Array.isArray(v)?c(v[0])+"-"+c(v[1]):c(v)});return"["+(m.inverted?"^":"")+y+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(m){return m.description}};function a(m){return m.charCodeAt(0).toString(16).toUpperCase()}function l(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function c(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(y){return"\\x0"+a(y)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(y){return"\\x"+a(y)})}function h(m){return o[m.type](m)}function p(m){var y,v,w=m.map(h);if(w.sort(),w.length>0){for(y=1,v=1;y<w.length;y++)w[y-1]!==w[y]&&(w[v]=w[y],v++);w.length=v}switch(w.length){case 1:return w[0];case 2:return w[0]+" or "+w[1];default:return w.slice(0,-1).join(", ")+", or "+w[w.length-1]}}function f(m){return m?'"'+l(m)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:t,parse:r}},(lK=Kfe).exports&&(lK.exports=cK());const _W={deg:1,grad:.9,rad:180/Math.PI,turn:360};function bNe(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&_W[e.unit]!=null))throw new q("effect:type-error",`Expected <angle>, Actual: ${X4(e)}`,{term:e})}const bW={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function wNe(e){if(e.type!=="quantity"||!(e.value===0&&e.unit===null||e.unit&&bW[e.unit]!=null))throw new q("effect:type-error",`Expected <length>, Actual: ${X4(e)}`,{term:e})}function _d(e){_Ne(e);const t=e.value;return PO(t,e),e.unit==="%"?.01*t:t}function xNe(e){return vNe(e),PO(e.value,e),e.value}function TNe(e){return bNe(e),e.value*_W[e.unit]||0}function wW(e){return wNe(e),e.value*bW[e.unit]||0}function SNe(e){switch(e.colorType){case"hex":return fSe(e.value);case"named":return tme(e.value);case"function":return ANe(e.value)}}function tme(e){if(!ble(e))throw new q("effect:unknown-color",`color '${e}' isn't valid`,{namedColor:e});return pSe(e)}const ENe=/^rgba?/i,CNe=/^hsla?/i;function ANe(e){if(Y2(e.parameters,4),ENe.test(e.name))return[_d(e.parameters[0]),_d(e.parameters[1]),_d(e.parameters[2]),e.parameters[3]?_d(e.parameters[3]):1];if(CNe.test(e.name))return wle(xNe(e.parameters[0]),_d(e.parameters[1]),_d(e.parameters[2]),e.parameters[3]?_d(e.parameters[3]):1);throw new q("effect:syntax-error",`Invalid color function '${e.name}'`,{colorFunction:e})}function xW(e,t,i){var r;try{return MNe(e)}catch(s){(r=i==null?void 0:i.messages)==null||r.push(s)}return null}function TW(e,t,i,r){try{const s=RNe(e);tc(i,s,t)}catch(s){r.messages&&r.messages.push(s)}}function RNe(e){const t=eme(e);return t?uNe(t)?t.map(i=>i.toJSON()):t.map(({scale:i,effects:r})=>({scale:i,value:r.map(s=>s.toJSON())})):null}function MNe(e){if(!e||e.length===0)return null;if(ONe(e)){const t=[];for(const i of e)t.push({scale:i.scale,value:hK(i.value)});return t}return hK(e)}function ONe(e){const t=e[0];return!!t&&"scale"in t}function hK(e){if(!e||!e.length)return"";const t=[];for(const i of e){let r=[];switch(i.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":r=[Wf(i,"amount")];break;case"blur":r=[Wf(i,"radius","pt")];break;case"hue-rotate":r=[Wf(i,"angle","deg")];break;case"drop-shadow":r=[Wf(i,"xoffset","pt"),Wf(i,"yoffset","pt"),Wf(i,"blurRadius","pt"),PNe(i,"color")];break;case"bloom":r=[Wf(i,"strength"),Wf(i,"radius","pt"),Wf(i,"threshold")]}const s=`${i.type}(${r.filter(Boolean).join(" ")})`;eme(s),t.push(s)}return t.join(" ")}function Wf(e,t,i){if(e[t]==null)throw new q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});return i?e[t]+i:""+e[t]}function PNe(e,t){if(e[t]==null)throw new q("effect:missing-parameter",`Missing parameter '${t}' in ${e.type} effect`,{effect:e});const i=e[t];return`rgba(${i[0]||0}, ${i[1]||0}, ${i[2]||0}, ${i[3]/255||0})`}const oD=-3;var jm;(function(e){e[e.ALL=0]="ALL",e[e.SOME=1]="SOME"})(jm||(jm={}));class INe{constructor(t,i,r){this._namespace=t,this._storage=i,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),this._namespace+=":",r&&(this._storage.registerRemoveFunc(this._namespace,r),this._removeFunc=!0)}destroy(){this._storage.clear(this._namespace),this._removeFunc&&this._storage.deregisterRemoveFunc(this._namespace),this._storage.deregister(this),this._storage=null}get namespace(){return this._namespace.slice(0,-1)}get hitRate(){return this._hit/(this._hit+this._miss)}get size(){return this._storage.size}get maxSize(){return this._storage.maxSize}resetHitRate(){this._hit=this._miss=0}put(t,i,r,s=0){this._storage.put(this._namespace+t,i,r,s)}get(t){const i=this._storage.get(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}pop(t){const i=this._storage.pop(this._namespace+t);return i===void 0?++this._miss:++this._hit,i}updateSize(t,i,r){this._storage.updateSize(this._namespace+t,i,r)}clear(){this._storage.clear(this._namespace)}clearAll(){this._storage.clearAll()}getStats(){return this._storage.getStats()}resetStats(){this._storage.resetStats()}}class SW{constructor(t=10485760){this._maxSize=t,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new Bt,this._users=new Bt}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(t){this._users.push(t)}deregister(t){this._users.removeUnordered(t)}registerRemoveFunc(t,i){this._removeFuncs.push([t,i])}deregisterRemoveFunc(t){this._removeFuncs.filterInPlace(i=>i[0]!==t)}get size(){return this._size}get maxSize(){return this._maxSize}set maxSize(t){this._maxSize=Math.max(t,0),this._checkSizeLimit()}put(t,i,r,s){const n=this._db.get(t);if(n&&(this._size-=n.size,this._db.delete(t),n.entry!==i&&this._notifyRemove(t,n.entry,jm.ALL)),r>this._maxSize)return void this._notifyRemove(t,i,jm.ALL);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!r||r<0)return void console.warn("Refusing to cache entry with invalid size "+r);const o=1+Math.max(s,oD)-oD;this._db.set(t,{entry:i,size:r,lifetime:o,lives:o}),this._size+=r,this._checkSizeLimit()}updateSize(t,i,r){const s=this._db.get(t);if(s&&s.entry===i){for(this._size-=s.size;r>this._maxSize;){const n=this._notifyRemove(t,i,jm.SOME);if(!(_(n)&&n>0))return void this._db.delete(t);r=n}s.size=r,this._size+=r,this._checkSizeLimit()}}pop(t){const i=this._db.get(t);if(i)return this._size-=i.size,this._db.delete(t),++this._hit,i.entry;++this._miss}get(t){const i=this._db.get(t);if(i!==void 0)return this._db.delete(t),i.lives=i.lifetime,this._db.set(t,i),++this._hit,i.entry;++this._miss}getStats(){const t={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},i={},r=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;r[l]=(r[l]||0)+o.size,this._users.forAll(c=>{const h=c.namespace;if(a.startsWith(h)){const p=i[h]||0;i[h]=p+o.size}})});const s={};this._users.forAll(o=>{const a=o.namespace;if(!isNaN(o.hitRate)&&o.hitRate>0){const l=i[a]||0;i[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(i);n.sort((o,a)=>i[a]-i[o]),n.forEach(o=>t[o]=Math.round(i[o]/2**20)+"MB / "+s[o]);for(let o=r.length-1;o>=0;--o){const a=r[o];a&&(t["Priority "+(o+oD-1)]=Math.round(a/this.size*100)+"%")}return t}resetStats(){this._hit=this._miss=0,this._users.forAll(t=>t.resetHitRate())}clear(t){this._db.forEach((i,r)=>{r.startsWith(t)&&(this._size-=i.size,this._db.delete(r),this._notifyRemove(r,i.entry,jm.ALL))})}clearAll(){this._db.forEach((t,i)=>this._notifyRemove(i,t.entry,jm.ALL)),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(t,i,r){let s;return this._removeFuncs.some(n=>{if(t.startsWith(n[0])){const o=n[1](i,r);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimit(){if(!(this._size<=this._maxSize))for(const[t,i]of this._db){if(this._db.delete(t),i.lives<=1){this._size-=i.size;const r=this._notifyRemove(t,i.entry,jm.SOME);_(r)&&r>0&&(this._size+=r,i.lives=i.lifetime,i.size=r,this._db.set(t,i))}else--i.lives,this._db.set(t,i);if(this._size<=.9*this.maxSize)return}}}class $Ne{constructor(t,i){this._storage=new SW,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i){this._storage.put(t,i,1,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}}function DNe(e){return typeof e=="function"}function Cvt(e,t,i,r){return DNe(e)?e(t,i,r):e}function Avt(e){return[e.r,e.g,e.b,e.a]}function Rvt(e,t,i){const r=` /-,
`,s=l=>{let c=l.length;for(;c--;)if(!r.includes(l.charAt(c)))return!1;return!0},n=[];let o=0,a=-1;do if(a=t.indexOf("[",o),a>=o){if(a>o){const l=t.substr(o,a-o);n.push([l,null,s(l)])}if(o=a+1,a=t.indexOf("]",o),a>=o){if(a>o){const l=e[t.substr(o,a-o)];l&&n.push([null,l,!1])}o=a+1}}while(a!==-1);if(o<t.length-1){const l=t.substr(o);n.push([l,null,s(l)])}return l=>{let c="",h=null;for(const p of n){const[f,m,y]=p;if(f)y?h=f:(h&&(c+=h,h=null),c+=f);else{const v=l.attributes[m];v&&(h&&(c+=h,h=null),c+=v)}}return LNe(c,i)}}function LNe(e,t){switch(typeof e!="string"&&(e=String(e)),t){case"LowerCase":return e.toLowerCase();case"Allcaps":return e.toUpperCase();default:return e}}function Mvt(e,t,i,r,s,n,o=!0){const a=t/s,l=i/n,c=Math.ceil(a/2),h=Math.ceil(l/2);for(let p=0;p<n;p++)for(let f=0;f<s;f++){const m=4*(f+(o?n-p-1:p)*s);let y=0,v=0,w=0,b=0,S=0,T=0,E=0;const C=(p+.5)*l;for(let M=Math.floor(p*l);M<(p+1)*l;M++){const I=Math.abs(C-(M+.5))/h,N=(f+.5)*a,D=I*I;for(let z=Math.floor(f*a);z<(f+1)*a;z++){let V=Math.abs(N-(z+.5))/c;const k=Math.sqrt(D+V*V);k>=-1&&k<=1&&(y=2*k*k*k-3*k*k+1,y>0&&(V=4*(z+M*t),E+=y*e[V+3],w+=y,e[V+3]<255&&(y=y*e[V+3]/250),b+=y*e[V],S+=y*e[V+1],T+=y*e[V+2],v+=y))}}r[m]=b/v,r[m+1]=S/v,r[m+2]=T/v,r[m+3]=E/w}}function Ovt(e){return e?{r:e[0],g:e[1],b:e[2],a:e[3]/255}:{r:0,g:0,b:0,a:0}}function NNe(e){return e.type==="CIMMarkerPlacementAlongLineRandomSize"||e.type==="CIMMarkerPlacementAlongLineSameSize"||e.type==="CIMMarkerPlacementAlongLineVariableSize"||e.type==="CIMMarkerPlacementAtExtremities"||e.type==="CIMMarkerPlacementAtMeasuredUnits"||e.type==="CIMMarkerPlacementAtRatioPositions"||e.type==="CIMMarkerPlacementOnLine"||e.type==="CIMMarkerPlacementOnVertices"}const Pvt=e=>isNaN(e)||!e?0:e,Ivt=e=>{if(!e)return!1;for(const t of e)switch(t.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":return!0}return!1};function $vt(){return import("./geometryEngineJSON.2762c1dd.js")}function ime(e,t,i,r){if(e.type!=="CIMTextSymbol"){if(i&&e.effects)for(const s of e.effects)kNe(s,t);if(e.symbolLayers)for(const s of e.symbolLayers)switch(s.type){case"CIMPictureMarker":case"CIMVectorMarker":FNe(s,t,r);break;case"CIMPictureStroke":case"CIMSolidStroke":!(r==null?void 0:r.preserveOutlineWidth)&&s.width&&(s.width*=t);break;case"CIMPictureFill":s.height&&(s.height*=t),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t);break;case"CIMHatchFill":ime(s.lineSymbol,t,!0,ve(F({},r),{preserveOutlineWidth:!1})),s.offsetX&&(s.offsetX*=t),s.offsetY&&(s.offsetY*=t),s.separation&&(s.separation*=t)}}else e.height*=t}function FNe(e,t,i){if(e.markerPlacement&&UNe(e.markerPlacement,t),e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.anchorPoint&&e.anchorPointUnits==="Absolute"&&(e.anchorPoint={x:e.anchorPoint.x*t,y:e.anchorPoint.y*t}),e.size*=t,e.type==="CIMVectorMarker"&&e.markerGraphics)for(const r of e.markerGraphics)e.scaleSymbolsProportionally||ime(r.symbol,t,!0,i)}function UNe(e,t){switch(NNe(e)&&e.offset&&(e.offset*=t),e.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementAlongLineVariableSize":if(e.maxRandomOffset&&(e.maxRandomOffset*=t),e.placementTemplate&&e.placementTemplate.length){const i=e.placementTemplate.map(r=>r*t);e.placementTemplate=i}break;case"CIMMarkerPlacementOnLine":e.startPointOffset&&(e.startPointOffset*=t);break;case"CIMMarkerPlacementAtExtremities":e.offsetAlongLine&&(e.offsetAlongLine*=t);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":e.beginPosition&&(e.beginPosition*=t),e.endPosition&&(e.endPosition*=t);break;case"CIMMarkerPlacementPolygonCenter":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMMarkerPlacementInsidePolygon":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t),e.stepX&&(e.stepX*=t),e.stepY&&(e.stepY*=t)}}function kNe(e,t){switch(e.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":e.width&&(e.width*=t);break;case"CIMGeometricEffectBuffer":e.size&&(e.size*=t);break;case"CIMGeometricEffectCut":e.beginCut&&(e.beginCut*=t),e.endCut&&(e.endCut*=t),e.middleCut&&(e.middleCut*=t);break;case"CIMGeometricEffectDashes":if(e.customEndingOffset&&(e.customEndingOffset*=t),e.offsetAlongLine&&(e.offsetAlongLine*=t),e.dashTemplate&&e.dashTemplate.length){const i=e.dashTemplate.map(r=>r*t);e.dashTemplate=i}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":e.length&&(e.length*=t);break;case"CIMGeometricEffectMove":e.offsetX&&(e.offsetX*=t),e.offsetY&&(e.offsetY*=t);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":e.offset&&(e.offset*=t);break;case"CIMGeometricEffectRegularPolygon":e.radius&&(e.radius*=t);break;case"CIMGeometricEffectTaperedPolygon":e.fromWidth&&(e.fromWidth*=t),e.length&&(e.length*=t),e.toWidth&&(e.toWidth*=t);break;case"CIMGeometricEffectWave":e.amplitude&&(e.amplitude*=t),e.period&&(e.period*=t)}}new $Ne(1e3);new qe([128,128,128]);const dK=/\/resource\/(.*?)\.svg$/,zNe=new qe("white");function VNe(e,t){const i=t.resource.href;return!he("esri-canvas-svg-support")&&e.styleOrigin&&dK.test(i)?i.replace(dK,"/resource/png/$1.png"):i}function Mw(e,t){if(!e)return null;let i=null;return US(e)?i=BNe(e):w4(e)&&(i=e.color?new qe(e.color):null),i?oM(i,t):null}function BNe(e){const t=e.symbolLayers;if(!t)return null;let i=null;return t.forEach(r=>{r.type==="object"&&r.resource.href!=null||(i=r.type==="water"?r.color:_(r.material)?r.material.color:null)}),i?new qe(i):null}function oM(e,t){if(t==null)return e;const i=e.toRgba();return i[3]=i[3]*t,new qe(i)}function GNe(e,t,i){const r=e.symbolLayers;if(!r)return;const s=n=>{const o=_(n)?n:null;return oM(t=t||o||i!=null&&zNe,i)};r.forEach(n=>{if(n.type!=="object"||n.resource.href==null||t)if(n.type==="water")n.color=s(n.color);else{const o=_(n.material)?n.material.color:null,a=s(o);R(n.material)?n.material=new iu({color:a}):n.material.color=a,i!=null&&"outline"in n&&_(n.outline)&&_(n.outline.color)&&(n.outline.color=oM(n.outline.color,i))}})}function jNe(e,t,i){(t=t||e.color)&&(e.color=oM(t,i)),i!=null&&"outline"in e&&e.outline&&e.outline.color&&(e.outline.color=oM(e.outline.color,i))}function $k(e,t,i){e&&(t||i!=null)&&(t&&(t=new qe(t)),US(e)?GNe(e,t,i):w4(e)&&jNe(e,t,i))}async function HNe(e,t){const i=e.symbolLayers;i&&await B4(i,async r=>qNe(r,t))}async function qNe(e,t){switch(e.type){case"extrude":XNe(e,t);break;case"icon":case"line":case"text":WNe(e,t);break;case"path":ZNe(e,t);break;case"object":await YNe(e,t)}}function WNe(e,t){const i=rme(t);_(i)&&(e.size=i)}function rme(e){for(const t of e)if(typeof t=="number")return t;return null}function XNe(e,t){e.size=typeof t[2]=="number"?t[2]:0}async function YNe(e,t){const{resourceSize:i,symbolSize:r}=await QNe(e),s=sme(t,i,r);e.width=oR(t[0],r[0],i[0],s),e.depth=oR(t[1],r[1],i[1],s),e.height=oR(t[2],r[2],i[2],s)}function ZNe(e,t){const i=sme(t,of,[e.width,void 0,e.height]);e.width=oR(t[0],e.width,1,i),e.height=oR(t[2],e.height,1,i)}function sme(e,t,i){for(let r=0;r<3;r++){const s=e[r];switch(s){case"symbol-value":return i[r]!=null?i[r]/t[r]:1;case"proportional":break;default:if(s&&t[r])return s/t[r]}}return 1}async function QNe(e){const t=await import("./symbolLayerUtils.2b013a30.js"),i=await t.computeObjectLayerResourceSize(e,10),{width:r,height:s,depth:n}=e,o=[r,n,s];let a=1;for(let l=0;l<3;l++)if(o[l]!=null){a=o[l]/i[l];break}for(let l=0;l<3;l++)o[l]==null&&(o[l]=i[l]*a);return{resourceSize:i,symbolSize:o}}function oR(e,t,i,r){switch(e){case"proportional":return i*r;case"symbol-value":return t!=null?t:i;default:return e}}function JNe(e,t){const i=rme(t);if(!R(i))switch(e.type){case"simple-marker":e.size=i;break;case"picture-marker":{const r=e.width/e.height;r>1?(e.width=i,e.height=i*r):(e.width=i*r,e.height=i);break}case"simple-line":e.width=i;break;case"text":e.font.size=i}}async function KNe(e,t){if(e&&t)return US(e)?HNe(e,t):void(w4(e)&&JNe(e,t))}function eFe(e,t,i){if(e&&t!=null)if(US(e)){const r=e.symbolLayers;r&&r.forEach(s=>{if(s&&s.type==="object")switch(i){case"tilt":s.tilt=t;break;case"roll":s.roll=t;break;default:s.heading=t}})}else w4(e)&&(e.type!=="simple-marker"&&e.type!=="picture-marker"&&e.type!=="text"||(e.angle=t))}const tFe="<",iFe=">",rFe=a4("short-date");function sFe(e,t,i,r){let s="";t===0?s=`${tFe} `:t===i&&(s=`${iFe} `);let n=null;return n=r?_f(e,rFe):WLe(e),s+n}const nFe=new qe([64,64,64]);function oFe(e,t){const i=[],r=e.length-1;return e.length===5?i.push(0,2,4):i.push(0,r),e.map((s,n)=>i.includes(n)?sFe(s,n,r,t):null)}async function aFe(e,t,i){let r=!1,s=[],n=[];if(e.stops){const c=e.stops;s=c.map(h=>h.value),r=c.some(h=>!!h.label),r&&(n=c.map(h=>h.label))}const o=s[0],a=s[s.length-1];if(o==null&&a==null)return null;const l=r?null:oFe(s,i);return(await Promise.all(s.map(async(c,h)=>({value:c,color:e.type==="opacity"?await lFe(c,e,t):(await Promise.resolve().then(function(){return QW})).getColor(e,c),label:r?n[h]:l[h]})))).reverse()}async function lFe(e,t,i=nFe){const r=new qe(i),s=(await Promise.resolve().then(function(){return QW})).getOpacity(t,e);return s!=null&&(r.a=s),r}var S9;let rA=S9=class extends fe{constructor(e){super(e),this.color=null,this.ratio=null}clone(){return new S9({color:this.color,ratio:this.ratio})}};u([d({type:qe,json:{type:[yr],default:null,write:!0}})],rA.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],rA.prototype,"ratio",void 0),rA=S9=u([P("esri.renderers.support.HeatmapColorStop")],rA);const aR=rA;function cFe(e){if(!e.colorStops)return[];const t=[...e.colorStops].filter(r=>{var s;return((s=r.color)==null?void 0:s.a)>0});let i=t.length-1;if(t&&t[0]){const r=t[i];r&&r.ratio!==1&&(t.push(new aR({ratio:1,color:r.color})),i++)}return t.map((r,s)=>{var o,a;let n="";return s===0?n=((o=e.legendOptions)==null?void 0:o.minLabel)||"low":s===i&&(n=((a=e.legendOptions)==null?void 0:a.maxLabel)||"high"),{color:r.color,label:n,ratio:r.ratio}}).reverse()}me.getLogger("esri.renderers.support.utils");function dc(e,t,i){TH(e,t,()=>[]).push(...i)}async function uFe(e){var i,r;const t=new Map;if("visualVariables"in e&&e.visualVariables){const s=e.visualVariables.filter(n=>n.type==="color");for(const n of s){const o=n.field||n.valueExpression,a=(await aFe(n)).map(l=>l.color);dc(t,o,a)}}if(e.type==="heatmap"){const s=cFe(e).map(n=>n.color);dc(t,e.field,s)}else if(e.type==="pie-chart"){for(const s of e.attributes)dc(t,s.field,[s.color]);dc(t,null,[(i=e==null?void 0:e.othersCategory)==null?void 0:i.color,Mw(e.backgroundFillSymbol,null)])}else if(e.type==="dot-density"){for(const s of e.attributes)dc(t,s.field,[s.color]);dc(t,null,[e.backgroundColor])}else if(e.type==="unique-value")if(((r=e.authoringInfo)==null?void 0:r.type)==="predominance")for(const s of e.uniqueValueInfos)dc(t,s.value.toString(),[Mw(s.symbol,null)]);else{const s=e.uniqueValueInfos.map(c=>Mw(c.symbol,null)),{field:n,field2:o,field3:a,valueExpression:l}=e;(n||l)&&dc(t,n||l,s),o&&dc(t,o,s),a&&dc(t,a,s)}else if(e.type==="class-breaks"){const s=e.classBreakInfos.map(n=>Mw(n.symbol,null));dc(t,e.field||e.valueExpression,s)}else e.type==="simple"&&dc(t,null,[Mw(e.symbol,null)]);return"defaultSymbol"in e&&e.defaultSymbol&&dc(t,null,[Mw(e.defaultSymbol,null)]),t.forEach((s,n)=>{const o=dO(s.filter(Boolean),(a,l)=>JSON.stringify(a)===JSON.stringify(l));t.set(n,o)}),t}var E9;let sA=E9=class extends fe{constructor(e){super(e),this.name=null,this.code=null}clone(){return new E9({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],sA.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],sA.prototype,"code",void 0),sA=E9=u([P("esri.layers.support.CodedValue")],sA);const hFe=new _i({inherited:"inherited",codedValue:"coded-value",range:"range"});let nA=class extends fe{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],nA.prototype,"name",void 0),u([ct(hFe)],nA.prototype,"type",void 0),nA=u([P("esri.layers.support.Domain")],nA);const Y4=nA;var C9;let oA=C9=class extends Y4{constructor(e){super(e),this.codedValues=null,this.type="coded-value"}getName(e){let t=null;if(this.codedValues){const i=String(e);this.codedValues.some(r=>(String(r.code)===i&&(t=r.name),!!t))}return t}clone(){return new C9({codedValues:te(this.codedValues),name:this.name})}};u([d({type:[sA],json:{write:!0}})],oA.prototype,"codedValues",void 0),u([ct({codedValue:"coded-value"})],oA.prototype,"type",void 0),oA=C9=u([P("esri.layers.support.CodedValueDomain")],oA);const nme=oA;var A9;let aD=A9=class extends Y4{constructor(e){super(e),this.type="inherited"}clone(){return new A9}};u([ct({inherited:"inherited"})],aD.prototype,"type",void 0),aD=A9=u([P("esri.layers.support.InheritedDomain")],aD);const ome=aD;var R9;let Ux=R9=class extends Y4{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new R9({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(e,t,i){t[i]=[this.minValue||0,e]}}}})],Ux.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(e,t)=>t.range&&t.range[0]},write:{target:"range",writer(e,t,i){t[i]=[e,this.maxValue||0]}}}})],Ux.prototype,"minValue",void 0),u([ct({range:"range"})],Ux.prototype,"type",void 0),Ux=R9=u([P("esri.layers.support.RangeDomain")],Ux);const ame=Ux,lme={key:"type",base:Y4,typeMap:{range:ame,"coded-value":nme,inherited:ome}};function EW(e){if(!e||!e.type)return null;switch(e.type){case"range":return ame.fromJSON(e);case"codedValue":return nme.fromJSON(e);case"inherited":return ome.fromJSON(e)}return null}const CW=new _i({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml"});var M9;const dFe=new _i({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let Va=M9=class extends fe{constructor(e){super(e),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null}readDescription(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?i.value:null}readValueType(e,{description:t}){let i;try{i=JSON.parse(t)}catch{}return i?dFe.fromJSON(i.fieldValueType):null}clone(){return new M9({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType})}};u([d({type:String,json:{write:!0}})],Va.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],Va.prototype,"defaultValue",void 0),u([d()],Va.prototype,"description",void 0),u([ke("description")],Va.prototype,"readDescription",null),u([d({types:lme,json:{read:{reader:EW},write:!0}})],Va.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Va.prototype,"editable",void 0),u([d({type:yr,json:{write:!0}})],Va.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],Va.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],Va.prototype,"nullable",void 0),u([ct(CW)],Va.prototype,"type",void 0),u([d()],Va.prototype,"valueType",void 0),u([ke("valueType",["description"])],Va.prototype,"readValueType",null),Va=M9=u([P("esri.layers.support.Field")],Va);const IO=Va;var O9;let kx=O9=class extends fe{constructor(e){super(e),this.type="map-layer"}clone(){const{mapLayerId:e,gdbVersion:t}=this;return new O9({mapLayerId:e,gdbVersion:t})}};u([ct({mapLayer:"map-layer"})],kx.prototype,"type",void 0),u([d({type:yr,json:{write:!0}})],kx.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],kx.prototype,"gdbVersion",void 0),kx=O9=u([P("esri.layers.support.source.MapLayerSource")],kx);var P9;let ym=P9=class extends fe{constructor(e){super(e),this.type="query-table"}clone(){var o;const{workspaceId:e,query:t,oidFields:i,spatialReference:r,geometryType:s}=this,n={workspaceId:e,query:t,oidFields:i,spatialReference:(o=r==null?void 0:r.clone())!=null?o:void 0,geometryType:s};return new P9(n)}};u([ct({queryTable:"query-table"})],ym.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],ym.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],ym.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],ym.prototype,"oidFields",void 0),u([d({type:Xe,json:{write:!0}})],ym.prototype,"spatialReference",void 0),u([ct(yue)],ym.prototype,"geometryType",void 0),ym=P9=u([P("esri.layers.support.source.QueryTableDataSource")],ym);var I9;let zx=I9=class extends fe{constructor(e){super(e),this.type="raster"}clone(){const{workspaceId:e,dataSourceName:t}=this;return new I9({workspaceId:e,dataSourceName:t})}};u([ct({raster:"raster"})],zx.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],zx.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],zx.prototype,"workspaceId",void 0),zx=I9=u([P("esri.layers.support.source.RasterDataSource")],zx);var $9;let W_=$9=class extends fe{constructor(e){super(e),this.type="table"}clone(){const{workspaceId:e,gdbVersion:t,dataSourceName:i}=this;return new $9({workspaceId:e,gdbVersion:t,dataSourceName:i})}};u([ct({table:"table"})],W_.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],W_.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],W_.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],W_.prototype,"dataSourceName",void 0),W_=$9=u([P("esri.layers.support.source.TableDataSource")],W_);var D9,L9;const pFe=Zo()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let Sc=D9=class extends fe{constructor(e){super(e),this.type="join-table"}readLeftTableSource(e,t,i){return pK()(e,t,i)}castLeftTableSource(e){return qd(N9(),e)}readRightTableSource(e,t,i){return pK()(e,t,i)}castRightTableSource(e){return qd(N9(),e)}clone(){var o,a;const{leftTableKey:e,rightTableKey:t,leftTableSource:i,rightTableSource:r,joinType:s}=this,n={leftTableKey:e,rightTableKey:t,leftTableSource:(o=i==null?void 0:i.clone())!=null?o:void 0,rightTableSource:(a=r==null?void 0:r.clone())!=null?a:void 0,joinType:s};return new D9(n)}};u([ct({joinTable:"join-table"})],Sc.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Sc.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],Sc.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],Sc.prototype,"leftTableSource",void 0),u([ke("leftTableSource")],Sc.prototype,"readLeftTableSource",null),u([Ot("leftTableSource")],Sc.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],Sc.prototype,"rightTableSource",void 0),u([ke("rightTableSource")],Sc.prototype,"readRightTableSource",null),u([Ot("rightTableSource")],Sc.prototype,"castRightTableSource",null),u([ct(pFe)],Sc.prototype,"joinType",void 0),Sc=D9=u([P("esri.layers.support.source.JoinTableDataSource")],Sc);let Dk=null;function pK(){return Dk||(Dk=U2({types:N9()})),Dk}let Lk=null;function N9(){return Lk||(Lk={key:"type",base:null,typeMap:{"data-layer":bd,"map-layer":kx}}),Lk}const fFe={key:"type",base:null,typeMap:{"join-table":Sc,"query-table":ym,raster:zx,table:W_}};let bd=L9=class extends fe{constructor(e){super(e),this.type="data-layer"}clone(){const{fields:e,dataSource:t}=this;return new L9({fields:e,dataSource:t})}};u([ct({dataLayer:"data-layer"})],bd.prototype,"type",void 0),u([d({type:[IO],json:{write:!0}})],bd.prototype,"fields",void 0),u([d({types:fFe,json:{write:!0}})],bd.prototype,"dataSource",void 0),bd=L9=u([P("esri.layers.support.source.DataLayerSource")],bd),bd.from=Qr(bd);function mFe(e,t){return t?ve(F({},t),{query:F(F({},e),t.query)}):{query:e}}function cme(e){return typeof e=="string"?hn(e):te(e)}function gFe(e,t,i){const r={};for(const s in e){if(s==="declaredClass")continue;const n=e[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){r[s]=[];for(let o=0;o<n.length;o++)r[s][o]=gFe(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(i&&i[s]);r[s]=t?o:JSON.stringify(o)}else r[s]=t?n:JSON.stringify(n);else r[s]=n}return r}const rP={102100:{maxX:20037508342788905e-9,minX:-20037508342788905e-9,plus180Line:new Jc({paths:[[[20037508342788905e-9,-20037508342788905e-9],[20037508342788905e-9,20037508342788905e-9]]],spatialReference:Xe.WebMercator}),minus180Line:new Jc({paths:[[[-20037508342788905e-9,-20037508342788905e-9],[-20037508342788905e-9,20037508342788905e-9]]],spatialReference:Xe.WebMercator})},4326:{maxX:180,minX:-180,plus180Line:new Jc({paths:[[[180,-180],[180,180]]],spatialReference:Xe.WGS84}),minus180Line:new Jc({paths:[[[-180,-180],[-180,180]]],spatialReference:Xe.WGS84})}};function Z1(e,t){return Math.ceil((e-t)/(2*t))}function ume(e,t){const i=lR(e);for(const r of i)for(const s of r)s[0]+=t;return e}function lR(e){return lb(e)?e.rings:e.paths}async function yFe(e,t,i,r){const s=typeof e=="string"?hn(e):e,n=t[0].spatialReference,o=ve(F({},r),{query:ve(F({},s.query),{f:"json",sr:JSON.stringify(n),target:JSON.stringify({geometryType:k2(t[0]),geometries:t}),cutter:JSON.stringify(i)})}),a=await ur(s.path+"/cut",o),{cutIndexes:l,geometries:c=[]}=a.data;return{cutIndexes:l,geometries:c.map(h=>{const p=yf(h);return p.spatialReference=n,p})}}async function vFe(e,t,i){const r=typeof e=="string"?hn(e):e,s=t[0].spatialReference,n=k2(t[0]),o=ve(F({},i),{query:ve(F({},r.query),{f:"json",sr:s.wkid?s.wkid:JSON.stringify(s),geometries:JSON.stringify(_Fe(t))})});return bFe((await ur(r.path+"/simplify",o)).data,n,s)}function _Fe(e){return{geometryType:k2(e[0]),geometries:e.map(t=>t.toJSON())}}function bFe(e,t,i){const r=_ue(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}const hme=me.getLogger("esri.geometry.support.normalizeUtils");function wFe(e){return e.type==="polygon"}function xFe(e){return e[0].type==="polygon"}function TFe(e){return e[0].type==="polyline"}function SFe(e,t){if(!(e instanceof Jc||e instanceof cu)){const s="straightLineDensify: the input geometry is neither polyline nor polygon";throw hme.error(s),new q(s)}const i=lR(e),r=[];for(const s of i){const n=[];r.push(n),n.push([s[0][0],s[0][1]]);for(let o=0;o<s.length-1;o++){const a=s[o][0],l=s[o][1],c=s[o+1][0],h=s[o+1][1],p=Math.sqrt((c-a)*(c-a)+(h-l)*(h-l)),f=(h-l)/p,m=(c-a)/p,y=p/t;if(y>1){for(let S=1;S<=y-1;S++){const T=S*t,E=m*T+a,C=f*T+l;n.push([E,C])}const v=(p+Math.floor(y-1)*t)/2,w=m*v+a,b=f*v+l;n.push([w,b])}n.push([c,h])}}return wFe(e)?new cu({rings:r,spatialReference:e.spatialReference}):new Jc({paths:r,spatialReference:e.spatialReference})}function fK(e,t,i){if(t){const r=SFe(e,1e6);e=OC(r,!0)}return i&&(e=ume(e,i)),e}function mK(e,t,i){if(Array.isArray(e)){const r=e[0];if(r>t){const s=Z1(r,t);e[0]=r+s*(-2*t)}else if(r<i){const s=Z1(r,i);e[0]=r+s*(-2*i)}}else{const r=e.x;if(r>t){const s=Z1(r,t);e=e.clone().offset(s*(-2*t),0)}else if(r<i){const s=Z1(r,i);e=e.clone().offset(s*(-2*i),0)}}return e}function EFe(e,t){let i=-1;for(let r=0;r<t.cutIndexes.length;r++){const s=t.cutIndexes[r],n=t.geometries[r],o=lR(n);for(let a=0;a<o.length;a++){const l=o[a];l.some(c=>{if(c[0]<180)return!0;{let h=0;for(let f=0;f<l.length;f++){const m=l[f][0];h=m>h?m:h}h=Number(h.toFixed(9));const p=-360*Z1(h,180);for(let f=0;f<l.length;f++){const m=n.getPoint(a,f);n.setPoint(a,f,m.clone().offset(p,0))}return!0}})}if(s===i){if(xFe(e))for(const a of lR(n))e[s]=e[s].addRing(a);else if(TFe(e))for(const a of lR(n))e[s]=e[s].addPath(a)}else i=s,e[s]=n}return e}async function dme(e,t,i){var E;if(!Array.isArray(e))return dme([e],t);t&&typeof t!="string"&&hme.warn("normalizeCentralMeridian()","The url object is deprecated, use the url string instead");const r=typeof t=="string"?t:(E=t==null?void 0:t.url)!=null?E:Ii.geometryServiceUrl;let s,n,o,a,l,c,h,p,f=0;const m=[],y=[];for(const C of e)if(R(C))y.push(C);else if(s||(s=C.spatialReference,n=J0(s),o=s.isWebMercator,c=o?102100:4326,a=rP[c].maxX,l=rP[c].minX,h=rP[c].plus180Line,p=rP[c].minus180Line),n)if(C.type==="mesh")y.push(C);else if(C.type==="point")y.push(mK(C.clone(),a,l));else if(C.type==="multipoint"){const M=C.clone();M.points=M.points.map(I=>mK(I,a,l)),y.push(M)}else if(C.type==="extent"){const M=C.clone()._normalize(!1,!1,n);y.push(M.rings?new cu(M):M)}else if(C.extent){const M=C.extent,I=Z1(M.xmin,l)*(2*a);let N=I===0?C.clone():ume(C.clone(),I);M.offset(I,0),M.intersects(h)&&M.xmax!==a?(f=M.xmax>f?M.xmax:f,N=fK(N,o),m.push(N),y.push("cut")):M.intersects(p)&&M.xmin!==l?(f=M.xmax*(2*a)>f?M.xmax*(2*a):f,N=fK(N,o,360),m.push(N),y.push("cut")):y.push(N)}else y.push(C.clone());else y.push(C);let v=Z1(f,a),w=-90;const b=v,S=new Jc;for(;v>0;){const C=360*v-180;S.addPath([[C,w],[C,-1*w]]),w*=-1,v--}if(m.length>0&&b>0){const C=EFe(m,await yFe(r,m,S,i)),M=[],I=[];for(let z=0;z<y.length;z++){const V=y[z];if(V!=="cut")I.push(V);else{const k=C.shift(),Y=e[z];_(Y)&&Y.type==="polygon"&&Y.rings&&Y.rings.length>1&&k.rings.length>=Y.rings.length?(M.push(k),I.push("simplify")):I.push(o?rg(k):k)}}if(!M.length)return I;const N=await vFe(r,M,i),D=[];for(let z=0;z<I.length;z++){const V=I[z];V!=="simplify"?D.push(V):D.push(o?rg(N.shift()):N.shift())}return D}const T=[];for(let C=0;C<y.length;C++){const M=y[C];if(M!=="cut")T.push(M);else{const I=m.shift();T.push(o===!0?rg(I):I)}}return T}function pme(e){const t={};for(const i in e){if(i==="declaredClass")continue;const r=e[i];if(r!=null&&typeof r!="function")if(Array.isArray(r)){t[i]=[];for(let s=0;s<r.length;s++)t[i][s]=pme(r[s])}else typeof r=="object"?r.toJSON&&(t[i]=JSON.stringify(r)):t[i]=r}return t}var d0;(function(e){e[e.varint=0]="varint",e[e.fixed64=1]="fixed64",e[e.delimited=2]="delimited",e[e.fixed32=5]="fixed32",e[e.unknown=99]="unknown"})(d0||(d0={}));const gK=4294967296,CFe=new TextDecoder("utf-8"),AFe=he("safari")||he("ios")?6:he("ff")?12:32;class gb{constructor(t,i,r=0,s=t?t.byteLength:0){this._tag=0,this._dataType=d0.unknown,this._init(t,i,r,s)}_init(t,i,r,s){this._data=t,this._dataView=i,this._pos=r,this._end=s}clone(){return new gb(this._data,this._dataView,this._pos,this._end)}pos(){return this._pos}move(t){this._pos=t}nextTag(t){for(;;){if(this._pos===this._end)return!1;const i=this._decodeVarint();if(this._tag=i>>3,this._dataType=7&i,!t||t===this._tag)break;this.skip()}return!0}next(){if(this._pos===this._end)return!1;const t=this._decodeVarint();return this._tag=t>>3,this._dataType=7&t,!0}empty(){return this._pos>=this._end}tag(){return this._tag}getInt32(){return this._decodeVarint()}getInt64(){return this._decodeVarint()}getUInt32(){let t=4294967295;return t=(127&this._data[this._pos])>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<7)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<14)>>>0,this._data[this._pos++]<128?t:(t=(t|(127&this._data[this._pos])<<21)>>>0,this._data[this._pos++]<128?t:(t=(t|(15&this._data[this._pos])<<28)>>>0,this._data[this._pos++]<128?t:void 0))))}getUInt64(){return this._decodeVarint()}getSInt32(){const t=this.getUInt32();return t>>>1^-(1&t)|0}getSInt64(){return this._decodeSVarint()}getBool(){const t=this._data[this._pos]!==0;return this._skip(1),t}getEnum(){return this._decodeVarint()}getFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getUint32(i+4,!0)*gK;return this._skip(8),r}getSFixed64(){const t=this._dataView,i=this._pos,r=t.getUint32(i,!0)+t.getInt32(i+4,!0)*gK;return this._skip(8),r}getDouble(){const t=this._dataView.getFloat64(this._pos,!0);return this._skip(8),t}getFixed32(){const t=this._dataView.getUint32(this._pos,!0);return this._skip(4),t}getSFixed32(){const t=this._dataView.getInt32(this._pos,!0);return this._skip(4),t}getFloat(){const t=this._dataView.getFloat32(this._pos,!0);return this._skip(4),t}getString(){const t=this._getLength(),i=this._pos,r=this._toString(this._data,i,i+t);return this._skip(t),r}getBytes(){const t=this._getLength(),i=this._pos,r=this._toBytes(this._data,i,i+t);return this._skip(t),r}getLength(){return this._getLengthUnsafe()}processMessageWithArgs(t,i,r,s){const n=this.getMessage(),o=t(n,i,r,s);return n.release(),o}processMessage(t){const i=this.getMessage(),r=t(i);return i.release(),r}getMessage(){const t=this._getLength(),i=gb.pool.acquire();return i._init(this._data,this._dataView,this._pos,this._pos+t),this._skip(t),i}release(){gb.pool.release(this)}dataType(){return this._dataType}skip(){switch(this._dataType){case d0.varint:this._decodeVarint();break;case d0.fixed64:this._skip(8);break;case d0.delimited:this._skip(this._getLength());break;case d0.fixed32:this._skip(4);break;default:throw new Error("Invalid data type!")}}skipLen(t){this._skip(t)}_skip(t){if(this._pos+t>this._end)throw new Error("Attempt to skip past the end of buffer!");this._pos+=t}_decodeVarint(){const t=this._data;let i,r=this._pos,s=0;if(this._end-r>=10)do{if(i=t[r++],s|=127&i,(128&i)==0||(i=t[r++],s|=(127&i)<<7,(128&i)==0)||(i=t[r++],s|=(127&i)<<14,(128&i)==0)||(i=t[r++],s|=(127&i)<<21,(128&i)==0)||(i=t[r++],s+=268435456*(127&i),(128&i)==0)||(i=t[r++],s+=34359738368*(127&i),(128&i)==0)||(i=t[r++],s+=4398046511104*(127&i),(128&i)==0)||(i=t[r++],s+=562949953421312*(127&i),(128&i)==0)||(i=t[r++],s+=72057594037927940*(127&i),(128&i)==0)||(i=t[r++],s+=9223372036854776e3*(127&i),(128&i)==0))break;throw new Error("Varint too long!")}while(0);else{let n=1;for(;r!==this._end&&(i=t[r],(128&i)!=0);)++r,s+=(127&i)*n,n*=128;if(r===this._end)throw new Error("Varint overrun!");++r,s+=i*n}return this._pos=r,s}_decodeSVarint(){const t=this._decodeVarint();return t%2?-(t+1)/2:t/2}_getLength(){if(this._dataType!==d0.delimited)throw new Error("Not a delimited data type!");return this._decodeVarint()}_getLengthUnsafe(){return this.getUInt32()}_toString(t,i,r){if((r=Math.min(this._end,r))-i>AFe){const o=t.subarray(i,r);return CFe.decode(o)}let s="",n="";for(let o=i;o<r;++o){const a=t[o];128&a?n+="%"+a.toString(16):(s+=decodeURIComponent(n)+String.fromCharCode(a),n="")}return n.length&&(s+=decodeURIComponent(n)),s}_toBytes(t,i,r){return r=Math.min(this._end,r),new Uint8Array(t.buffer,i,r-i)}}gb.pool=new ys(gb,null,e=>{e._data=null,e._dataView=null});class ol{constructor(t=[],i=[],r=!1){this.lengths=t!=null?t:[],this.coords=i!=null?i:[],this.hasIndeterminateRingOrder=r}static fromRect(t){const[i,r,s,n]=t,o=s-i,a=n-r;return new ol([5],[i,r,o,0,0,a,-o,0,0,-a])}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((t,i)=>t+i)}forEachVertex(t){let i=0;this.lengths.length||t(this.coords[0],this.coords[1]);for(let r=0;r<this.lengths.length;r++){const s=this.lengths[r];for(let n=0;n<s;n++)t(this.coords[2*(n+i)],this.coords[2*(n+i)+1]);i+=s}}clone(t){return t?(t.set(this.coords),new ol(this.lengths.slice(),t,this.hasIndeterminateRingOrder)):new ol(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}}class Af{constructor(t=null,i={},r,s){this.geometry=t,this.attributes=i,this.centroid=r,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const t=new Af(this.geometry,this.attributes,this.centroid,this.objectId);return t.displayId=this.displayId,t.geohashX=this.geohashX,t.geohashY=this.geohashY,t}}function RFe(e){return!(R(e.geometry)||!e.geometry.coords||!e.geometry.coords.length)}class Dvt extends Af{}class Z4{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const t=new Z4;return t.objectIdFieldName=this.objectIdFieldName,t.globalIdFieldName=this.globalIdFieldName,t.geohashFieldName=this.geohashFieldName,t.geometryProperties=this.geometryProperties,t.geometryType=this.geometryType,t.spatialReference=this.spatialReference,t.hasZ=this.hasZ,t.hasM=this.hasM,t.features=this.features,t.fields=this.fields,t.transform=this.transform,t.exceededTransferLimit=this.exceededTransferLimit,t.uniqueIdField=this.uniqueIdField,t.queryGeometry=this.queryGeometry,t.queryGeometryType=this.queryGeometryType,t}}const fme=["esriGeometryPoint","esriGeometryMultipoint","esriGeometryPolyline","esriGeometryPolygon"];class Lvt{constructor(t){this.options=t,this.geometryTypes=fme,this._coordinatePtr=0,this._vertexDimension=0}createFeatureResult(){return new Z4}prepareFeatures(t){this._vertexDimension=2,t.hasZ&&this._vertexDimension++,t.hasM&&this._vertexDimension++}finishFeatureResult(t){if(!t||!t.features||!t.hasZ||!this.options.sourceSpatialReference||!t.spatialReference||ac(t.spatialReference,this.options.sourceSpatialReference)||t.spatialReference.vcsWkid)return;const i=zS(this.options.sourceSpatialReference)/zS(t.spatialReference);if(i!==1)for(const r of t.features){if(!RFe(r))continue;const s=r.geometry.coords;for(let n=2;n<s.length;n+=3)s[n]*=i}}addFeature(t,i){t.features.push(i)}createFeature(){return new Af}createSpatialReference(){return{wkid:0}}createGeometry(){return new ol}addField(t,i){t.fields.push(i)}allocateCoordinates(t){t.coords.length=t.lengths.reduce((i,r)=>i+r,0)*this._vertexDimension,this._coordinatePtr=0}addCoordinate(t,i){t.coords[this._coordinatePtr++]=i}addCoordinatePoint(t,i){t.coords.push(i)}addLength(t,i){t.lengths.push(i)}addQueryGeometry(t,i){t.queryGeometry=i.queryGeometry,t.queryGeometryType=i.queryGeometryType}createPointGeometry(){return new ol}}const yK=["esriFieldTypeSmallInteger","esriFieldTypeInteger","esriFieldTypeSingle","esriFieldTypeDouble","esriFieldTypeString","esriFieldTypeDate","esriFieldTypeOID","esriFieldTypeGeometry","esriFieldTypeBlob","esriFieldTypeRaster","esriFieldTypeGUID","esriFieldTypeGlobalID","esriFieldTypeXML"],vK=["sqlTypeBigInt","sqlTypeBinary","sqlTypeBit","sqlTypeChar","sqlTypeDate","sqlTypeDecimal","sqlTypeDouble","sqlTypeFloat","sqlTypeGeometry","sqlTypeGUID","sqlTypeInteger","sqlTypeLongNVarchar","sqlTypeLongVarbinary","sqlTypeLongVarchar","sqlTypeNChar","sqlTypeNVarchar","sqlTypeOther","sqlTypeReal","sqlTypeSmallInt","sqlTypeSqlXml","sqlTypeTime","sqlTypeTimestamp","sqlTypeTimestamp2","sqlTypeTinyInt","sqlTypeVarbinary","sqlTypeVarchar"],_K=["upperLeft","lowerLeft"];function bK(e){return e>=yK.length?null:yK[e]}function MFe(e){return e>=vK.length?null:vK[e]}function wK(e){return e>=_K.length?null:_K[e]}function xK(e,t){return t>=e.geometryTypes.length?null:e.geometryTypes[t]}function OFe(e,t,i){const s=t.createPointGeometry(i);for(;e.next();)switch(e.tag()){case 3:{const n=e.getUInt32(),o=e.pos()+n;let a=0;for(;e.pos()<o;)t.addCoordinatePoint(s,e.getSInt64(),a++);break}default:e.skip()}return s}function PFe(e,t,i){const n=t.createGeometry(i),o=2+(i.hasZ?1:0)+(i.hasM?1:0);for(;e.next();)switch(e.tag()){case 2:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(;e.pos()<l;)t.addLength(n,e.getUInt32(),c++);break}case 3:{const a=e.getUInt32(),l=e.pos()+a;let c=0;for(t.allocateCoordinates(n);e.pos()<l;)t.addCoordinate(n,e.getSInt64(),c),c++,c===o&&(c=0);break}default:e.skip()}return n}function IFe(e){const s=new ol;let n="esriGeometryPoint";for(;e.next();)switch(e.tag()){case 2:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.lengths.push(e.getUInt32());break}case 3:{const o=e.getUInt32(),a=e.pos()+o;for(;e.pos()<a;)s.coords.push(e.getSInt64());break}case 1:n=fme[e.getEnum()];break;default:e.skip()}return{queryGeometry:s,queryGeometryType:n}}function $Fe(e){for(;e.next();)switch(e.tag()){case 1:return e.getString();case 2:return e.getFloat();case 3:return e.getDouble();case 4:return e.getSInt32();case 5:return e.getUInt32();case 6:return e.getInt64();case 7:return e.getUInt64();case 8:return e.getSInt64();case 9:return e.getBool();default:return e.skip(),null}return null}function DFe(e){const a={type:bK(0)};for(;e.next();)switch(e.tag()){case 1:a.name=e.getString();break;case 2:a.type=bK(e.getEnum());break;case 3:a.alias=e.getString();break;case 4:a.sqlType=MFe(e.getEnum());break;case 5:e.skip();break;case 6:a.defaultValue=e.getString();break;default:e.skip()}return a}function LFe(e){const r={};for(;e.next();)switch(e.tag()){case 1:r.name=e.getString();break;case 2:r.isSystemMaintained=e.getBool();break;default:e.skip()}return r}function NFe(e,t,i,r){const a=t.createFeature(i);let l=0;for(;e.next();)switch(e.tag()){case 1:{const c=r[l++].name;a.attributes[c]=e.processMessage($Fe);break}case 2:a.geometry=e.processMessageWithArgs(PFe,t,i);break;case 4:a.centroid=e.processMessageWithArgs(OFe,t,i);break;default:e.skip()}return a}function FFe(e){const n=[1,1,1,1];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function UFe(e){const n=[0,0,0,0];for(;e.next();)switch(e.tag()){case 1:n[0]=e.getDouble();break;case 2:n[1]=e.getDouble();break;case 4:n[2]=e.getDouble();break;case 3:n[3]=e.getDouble();break;default:e.skip()}return n}function kFe(e){const s={originPosition:wK(0)};for(;e.next();)switch(e.tag()){case 1:s.originPosition=wK(e.getEnum());break;case 2:s.scale=e.processMessage(FFe);break;case 3:s.translate=e.processMessage(UFe);break;default:e.skip()}return s}function zFe(e){const s={};for(;e.next();)switch(e.tag()){case 1:s.shapeAreaFieldName=e.getString();break;case 2:s.shapeLengthFieldName=e.getString();break;case 3:s.units=e.getString();break;default:e.skip()}return s}function VFe(e,t){const a=t.createSpatialReference();for(;e.next();)switch(e.tag()){case 1:a.wkid=e.getUInt32();break;case 5:a.wkt=e.getString();break;case 2:a.latestWkid=e.getUInt32();break;case 3:a.vcsWkid=e.getUInt32();break;case 4:a.latestVcsWkid=e.getUInt32();break;default:e.skip()}return a}function BFe(e,t){const v=t.createFeatureResult();v.geometryType=xK(t,0);let w=!1;for(;e.next();)switch(e.tag()){case 1:v.objectIdFieldName=e.getString();break;case 3:v.globalIdFieldName=e.getString();break;case 4:v.geohashFieldName=e.getString();break;case 5:v.geometryProperties=e.processMessage(zFe);break;case 7:v.geometryType=xK(t,e.getEnum());break;case 8:v.spatialReference=e.processMessageWithArgs(VFe,t);break;case 10:v.hasZ=e.getBool();break;case 11:v.hasM=e.getBool();break;case 12:v.transform=e.processMessage(kFe);break;case 9:{const b=e.getBool();v.exceededTransferLimit=b;break}case 13:t.addField(v,e.processMessage(DFe));break;case 15:w||(t.prepareFeatures(v),w=!0),t.addFeature(v,e.processMessageWithArgs(NFe,t,v,v.fields));break;case 2:v.uniqueIdField=e.processMessage(LFe);break;default:e.skip()}return t.finishFeatureResult(v),v}function GFe(e,t){const s={};let n=null;for(;e.next();)switch(e.tag()){case 4:n=e.processMessageWithArgs(IFe);break;case 1:s.featureResult=e.processMessageWithArgs(BFe,t);break;default:e.skip()}return _(n)&&s.featureResult&&t.addQueryGeometry(s,n),s}function jFe(e,t){try{const r=new gb(new Uint8Array(e),new DataView(e)),s={};for(;r.next();)r.tag()===2?s.queryResult=r.processMessageWithArgs(GFe,t):r.skip();return s}catch(i){throw new q("query:parsing-pbf","Error while parsing FeatureSet PBF payload",{error:i})}}function HFe(e,t){const i=jFe(e,t),r=i.queryResult.featureResult,s=i.queryResult.queryGeometry,n=i.queryResult.queryGeometryType;if(r&&r.features&&r.features.length&&r.objectIdFieldName){const o=r.objectIdFieldName;for(const a of r.features)a.attributes&&(a.objectId=a.attributes[o])}return r&&(r.queryGeometry=s,r.queryGeometryType=n),r}function F9(e,t,i){if(!i||!i.features||!i.hasZ)return;const r=Rde(i.geometryType,t,e.outSpatialReference);if(!R(r))for(const s of i.features)r(s.geometry)}const TK="Layer does not support extent calculation.";function mme(e,t){if(t&&e.type==="extent")return`${e.xmin},${e.ymin},${e.xmax},${e.ymax}`;if(t&&e.type==="point")return`${e.x},${e.y}`;const i=e.toJSON();return delete i.spatialReference,JSON.stringify(i)}function gme(e,t){const i=e.geometry,r=e.toJSON();delete r.compactGeometryEnabled,delete r.defaultSpatialReferenceEnabled;const s=r;let n,o,a;if(_(i)&&(o=i.spatialReference,a=i.spatialReference.wkid||JSON.stringify(i.spatialReference),s.geometryType=k2(i),s.geometry=mme(i,e.compactGeometryEnabled),s.inSR=a),r.groupByFieldsForStatistics&&(s.groupByFieldsForStatistics=r.groupByFieldsForStatistics.join(",")),r.objectIds&&(s.objectIds=r.objectIds.join(",")),r.orderByFields&&(s.orderByFields=r.orderByFields.join(",")),!r.outFields||!r.returnDistinctValues&&((t==null?void 0:t.returnCountOnly)||(t==null?void 0:t.returnExtentOnly)||(t==null?void 0:t.returnIdsOnly))?delete s.outFields:r.outFields.includes("*")?s.outFields="*":s.outFields=r.outFields.join(","),r.outSR?(s.outSR=r.outSR.wkid||JSON.stringify(r.outSR),n=e.outSpatialReference):i&&(r.returnGeometry||r.returnCentroid)&&(s.outSR=s.inSR,n=o),r.returnGeometry&&delete r.returnGeometry,r.outStatistics&&(s.outStatistics=JSON.stringify(r.outStatistics)),r.pixelSize&&(s.pixelSize=JSON.stringify(r.pixelSize)),r.quantizationParameters&&(e.defaultSpatialReferenceEnabled&&_(o)&&_(e.quantizationParameters)&&_(e.quantizationParameters.extent)&&o.equals(e.quantizationParameters.extent.spatialReference)&&delete r.quantizationParameters.extent.spatialReference,s.quantizationParameters=JSON.stringify(r.quantizationParameters)),r.parameterValues&&(s.parameterValues=JSON.stringify(r.parameterValues)),r.rangeValues&&(s.rangeValues=JSON.stringify(r.rangeValues)),r.dynamicDataSource&&(s.layer=JSON.stringify({source:r.dynamicDataSource}),delete r.dynamicDataSource),r.timeExtent){const l=r.timeExtent,{start:c,end:h}=l;c==null&&h==null||(s.time=c===h?c:`${c==null?"null":c},${h==null?"null":h}`),delete r.timeExtent}return e.defaultSpatialReferenceEnabled&&_(o)&&_(n)&&o.equals(n)&&(s.defaultSR=s.inSR,delete s.inSR,delete s.outSR),s}async function yme(e,t,i,r){const s=_(t.timeExtent)&&t.timeExtent.isEmpty?{data:{features:[]}}:await Z2(e,t,"json",r);return F9(t,i,s.data),s}async function qFe(e,t,i,r){if(_(t.timeExtent)&&t.timeExtent.isEmpty)return{data:i.createFeatureResult()};const s=await vme(e,t,r),n=s;return n.data=HFe(s.data,i),n}function vme(e,t,i){return Z2(e,t,"pbf",i)}function WFe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{objectIds:[]}}):Z2(e,t,"json",i,{returnIdsOnly:!0})}function XFe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0}}):Z2(e,t,"json",i,{returnIdsOnly:!0,returnCountOnly:!0})}function YFe(e,t,i){return _(t.timeExtent)&&t.timeExtent.isEmpty?Promise.resolve({data:{count:0,extent:null}}):Z2(e,t,"json",i,{returnExtentOnly:!0,returnCountOnly:!0}).then(r=>{const s=r.data;if(s.hasOwnProperty("extent"))return r;if(s.features)throw new Error(TK);if(s.hasOwnProperty("count"))throw new Error(TK);return r})}function Z2(e,t,i,r={},s={}){const n=typeof e=="string"?hn(e):e,o=t.geometry?[t.geometry]:[];return r.responseType=i==="pbf"?"array-buffer":"json",dme(o,null,r).then(a=>{const l=a&&a[0];_(l)&&((t=t.clone()).geometry=l);const c=pme(F(F(ve(F({},n.query),{f:i}),s),gme(t,s)));return ur(du(n.path,"query"),ve(F({},r),{query:F(F({},c),r.query)}))})}var Nvt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",encodeGeometry:mme,executeQuery:yme,executeQueryForCount:XFe,executeQueryForExtent:YFe,executeQueryForIds:WFe,executeQueryPBF:qFe,executeQueryPBFBuffer:vme,queryToQueryStringParameters:gme,runQuery:Z2}),U9;const k9=new _i({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let fo=U9=class extends fe{constructor(e){super(e),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(e,t){var s;const i=Xe.fromJSON(t.spatialReference),r=[];for(let n=0;n<e.length;n++){const o=e[n],a=Ca.fromJSON(o),l=o.geometry&&o.geometry.spatialReference;_(a.geometry)&&!l&&(a.geometry.spatialReference=i);const c=o.aggregateGeometries,h=a.aggregateGeometries;if(c&&_(h))for(const p in h){const f=h[p],m=(s=c[p])==null?void 0:s.spatialReference;_(f)&&!m&&(f.spatialReference=i)}r.push(a)}return r}writeGeometryType(e,t,i,r){if(e)return void k9.write(e,t,i,r);const{features:s}=this;if(s){for(const n of s)if(n&&_(n.geometry))return void k9.write(n.geometry.type,t,i,r)}}readQueryGeometry(e,t){if(!e)return null;const i=!!e.spatialReference,r=yf(e);return!i&&t.spatialReference&&(r.spatialReference=Xe.fromJSON(t.spatialReference)),r}writeSpatialReference(e,t){if(e)return void(t.spatialReference=e.toJSON());const{features:i}=this;if(i){for(const r of i)if(r&&_(r.geometry)&&r.geometry.spatialReference)return void(t.spatialReference=r.geometry.spatialReference.toJSON())}}clone(){return new U9(this.cloneProperties())}cloneProperties(){return te({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(e){const t=this.write();if(t.features&&Array.isArray(e)&&e.length>0)for(let i=0;i<t.features.length;i++){const r=t.features[i];if(r.geometry){const s=e&&e[i];r.geometry=s&&s.toJSON()||r.geometry}}return t}quantize(e){const{scale:[t,i],translate:[r,s]}=e,n=c=>Math.round((c-r)/t),o=c=>Math.round((s-c)/i),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=e,this}unquantize(){const{geometryType:e,features:t,transform:i}=this;if(!i)return this;const{translate:[r,s],scale:[n,o]}=i,a=h=>h*n+r,l=h=>s-h*o,c=this._getHydrationFunction(e,a,l);for(const{geometry:h}of t)_(h)&&c(h);return this.transform=null,this}_quantizePoints(e,t,i){let r,s;const n=[];for(let o=0,a=e.length;o<a;o++){const l=e[o];if(o>0){const c=t(l[0]),h=i(l[1]);c===r&&h===s||(n.push([c-r,h-s]),r=c,s=h)}else r=t(l[0]),s=i(l[1]),n.push([r,s])}return n.length>0?n:null}_getQuantizationFunction(e,t,i){return e==="point"?r=>(r.x=t(r.x),r.y=i(r.y),r):e==="polyline"||e==="polygon"?r=>{const s=lb(r)?r.rings:r.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,t,i);c&&n.push(c)}return n.length>0?(lb(r)?r.rings=n:r.paths=n,r):null}:e==="multipoint"?r=>{const s=this._quantizePoints(r.points,t,i);return s.length>0?(r.points=s,r):null}:e==="extent"?r=>r:null}_getHydrationFunction(e,t,i){return e==="point"?r=>{r.x=t(r.x),r.y=i(r.y)}:e==="polyline"||e==="polygon"?r=>{const s=lb(r)?r.rings:r.paths;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];for(let h=0,p=c.length;h<p;h++){const f=c[h];h>0?(n+=f[0],o+=f[1]):(n=f[0],o=f[1]),f[0]=t(n),f[1]=i(o)}}}:e==="extent"?r=>{r.xmin=t(r.xmin),r.ymin=i(r.ymin),r.xmax=t(r.xmax),r.ymax=i(r.ymax)}:e==="multipoint"?r=>{const s=r.points;let n,o;for(let a=0,l=s.length;a<l;a++){const c=s[a];a>0?(n+=c[0],o+=c[1]):(n=c[0],o=c[1]),c[0]=t(n),c[1]=i(o)}}:void 0}};u([d({type:String,json:{write:!0}})],fo.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],fo.prototype,"exceededTransferLimit",void 0),u([d({type:[Ca],json:{write:!0}})],fo.prototype,"features",void 0),u([ke("features")],fo.prototype,"readFeatures",null),u([d({type:[IO],json:{write:!0}})],fo.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:k9.read}}})],fo.prototype,"geometryType",void 0),u([Be("geometryType")],fo.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],fo.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],fo.prototype,"hasZ",void 0),u([d({types:cw,json:{write:!0}})],fo.prototype,"queryGeometry",void 0),u([ke("queryGeometry")],fo.prototype,"readQueryGeometry",null),u([d({type:Xe,json:{write:!0}})],fo.prototype,"spatialReference",void 0),u([Be("spatialReference")],fo.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],fo.prototype,"transform",void 0),fo=U9=u([P("esri.rest.support.FeatureSet")],fo),fo.prototype.toJSON.isDefaultToJSON=!0;const Q4=fo;var Fvt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Q4});const SK={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},ZFe={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function QFe(e,t){const i=new Date(e,t+1,1);return i.setDate(0),i.getDate()}function yb(e,t,i){const r=new Date(e.getTime());if(t&&i){const s=ZFe[i],{getter:n,setter:o,multiplier:a}=s;if(i==="months"){const l=QFe(r.getFullYear(),r.getMonth()+t);r.getDate()>l&&r.setDate(l)}r[o](r[n]()+t*a)}return r}function EK(e,t){switch(t){case"milliseconds":return new Date(e.getTime());case"seconds":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds());case"minutes":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes());case"hours":return new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours());case"days":return new Date(e.getFullYear(),e.getMonth(),e.getDate());case"weeks":return new Date(e.getFullYear(),e.getMonth(),e.getDate()-e.getDay());case"months":return new Date(e.getFullYear(),e.getMonth(),1);case"years":return new Date(e.getFullYear(),0,1);case"decades":return new Date(e.getFullYear()-e.getFullYear()%10,0,1);case"centuries":return new Date(e.getFullYear()-e.getFullYear()%100,0,1);default:return new Date}}function JFe(e,t,i){return e===0?0:e*SK[t]/SK[i]}var id;let Dc=id=class extends fe{constructor(e){super(e),this.end=null,this.start=null}static get allTime(){return CK}static get empty(){return KFe}readEnd(e,t){return t.end!=null?new Date(t.end):null}writeEnd(e,t){t.end=e?e.getTime():null}get isAllTime(){return this.equals(id.allTime)}get isEmpty(){return this.equals(id.empty)}readStart(e,t){return t.start!=null?new Date(t.start):null}writeStart(e,t){t.start=e?e.getTime():null}clone(){return new id({end:this.end,start:this.start})}equals(e){if(!e)return!1;const t=_(this.start)?this.start.getTime():this.start,i=_(this.end)?this.end.getTime():this.end,r=_(e.start)?e.start.getTime():e.start,s=_(e.end)?e.end.getTime():e.end;return t===r&&i===s}expandTo(e){if(this.isEmpty||this.isAllTime)return this.clone();const t=qs(this.start,r=>EK(r,e)),i=qs(this.end,r=>yb(EK(r,e),1,e));return new id({start:t,end:i})}intersection(e){if(!e)return this.clone();if(this.isEmpty||e.isEmpty)return id.empty;if(this.isAllTime)return e.clone();if(e.isAllTime)return this.clone();const t=Gc(this.start,-1/0,a=>a.getTime()),i=Gc(this.end,1/0,a=>a.getTime()),r=Gc(e.start,-1/0,a=>a.getTime()),s=Gc(e.end,1/0,a=>a.getTime());let n,o;if(r>=t&&r<=i?n=r:t>=r&&t<=s&&(n=t),i>=r&&i<=s?o=i:s>=t&&s<=i&&(o=s),!isNaN(n)&&!isNaN(o)){const a=new id;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return id.empty}offset(e,t){if(this.isEmpty||this.isAllTime)return this.clone();const i=new id,{start:r,end:s}=this;return _(r)&&(i.start=yb(r,e,t)),_(s)&&(i.end=yb(s,e,t)),i}union(e){if(!e||e.isEmpty)return this.clone();if(this.isEmpty)return e.clone();if(this.isAllTime||e.isAllTime)return CK.clone();const t=_(this.start)&&_(e.start)?new Date(Math.min(this.start.getTime(),e.start.getTime())):null,i=_(this.end)&&_(e.end)?new Date(Math.max(this.end.getTime(),e.end.getTime())):null;return new id({start:t,end:i})}};u([d({type:Date,json:{write:{allowNull:!0}}})],Dc.prototype,"end",void 0),u([ke("end")],Dc.prototype,"readEnd",null),u([Be("end")],Dc.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],Dc.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],Dc.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],Dc.prototype,"start",void 0),u([ke("start")],Dc.prototype,"readStart",null),u([Be("start")],Dc.prototype,"writeStart",null),Dc=id=u([P("esri.TimeExtent")],Dc);const CK=new Dc,KFe=new Dc({start:void 0,end:void 0}),Uf=Dc;var z9;const AK=new _i({upperLeft:"upper-left",lowerLeft:"lower-left"});let X_=z9=class extends fe{constructor(e){super(e),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new z9(te({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:ci,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],X_.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],X_.prototype,"mode",void 0),u([d({type:String,json:{read:AK.read,write:AK.write}})],X_.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],X_.prototype,"tolerance",void 0),X_=z9=u([P("esri.rest.support.QuantizationParameters")],X_);const e4e=X_;var V9;const RK=new _i({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let rd=V9=class extends fe{constructor(e){super(e),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(e,t){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(t.statisticParameters=te(e))}clone(){return new V9({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:te(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],rd.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],rd.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],rd.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],rd.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],rd.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:RK.read},write:{target:"statisticType",writer:RK.write}}})],rd.prototype,"statisticType",void 0),u([d({type:Object})],rd.prototype,"statisticParameters",void 0),u([Be("statisticParameters")],rd.prototype,"writeStatisticParameters",null),rd=V9=u([P("esri.rest.support.StatisticDefinition")],rd);const _me=rd;var rS;const t4e=new _i({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),i4e=new _i({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let At=rS=class extends fe{constructor(e){super(e),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}static from(e){return SS(rS,e)}castDatumTransformation(e){return typeof e=="number"||typeof e=="object"?e:null}writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeParameterValues(e,t){if(e){const i={};for(const r in e){const s=e[r];Array.isArray(s)?i[r]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?i[r]=s.getTime():i[r]=s}t.parameterValues=i}}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,t.where="1=1"}writeWhere(e,t){t.where=e||"1=1"}clone(){return new rS(te({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:_(this.historicMoment)?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};At.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],At.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],At.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],At.prototype,"datumTransformation",void 0),u([Ot("datumTransformation")],At.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],At.prototype,"distance",void 0),u([d({type:bd,json:{write:!0}})],At.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],At.prototype,"formatOf3DObjects",void 0),u([d({type:String,json:{write:!0}})],At.prototype,"gdbVersion",void 0),u([d({types:cw,json:{read:yf,write:!0}})],At.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],At.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],At.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],At.prototype,"having",void 0),u([d({type:Date})],At.prototype,"historicMoment",void 0),u([Be("historicMoment")],At.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],At.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:e=>e<1?1:e>rS.MAX_MAX_RECORD_COUNT_FACTOR?rS.MAX_MAX_RECORD_COUNT_FACTOR:e,json:{write:{overridePolicy:e=>({enabled:e>1})}}})],At.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],At.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],At.prototype,"num",void 0),u([d({json:{write:!0}})],At.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],At.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],At.prototype,"outFields",void 0),u([d({type:Xe,json:{name:"outSR",write:!0}})],At.prototype,"outSpatialReference",void 0),u([d({type:[_me],json:{write:{enabled:!0,overridePolicy(){return{enabled:_(this.outStatistics)&&this.outStatistics.length>0}}}}})],At.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],At.prototype,"parameterValues",void 0),u([Be("parameterValues")],At.prototype,"writeParameterValues",null),u([d({type:nt,json:{write:!0}})],At.prototype,"pixelSize",void 0),u([d({type:e4e,json:{write:!0}})],At.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],At.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],At.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],At.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],At.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],At.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],At.prototype,"returnZ",void 0),u([d({type:Xe,json:{write:!0}})],At.prototype,"sourceSpatialReference",void 0),u([ct(t4e,{ignoreUnknown:!1,name:"spatialRel"})],At.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],At.prototype,"start",void 0),u([Be("start"),Be("num")],At.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],At.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],At.prototype,"text",void 0),u([d({type:Uf,json:{write:!0}})],At.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],At.prototype,"timeReferenceUnknownClient",void 0),u([ct(i4e,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],At.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(e){return{enabled:e!=null||this.start>0}}}}})],At.prototype,"where",void 0),u([Be("where")],At.prototype,"writeWhere",null),At=rS=u([P("esri.rest.support.Query")],At);const Cd=At;async function Nk(e,t,i){const r=await r4e(e,t,i);return Q4.fromJSON(r)}async function r4e(e,t,i){const r=cme(e),s=F({},i),n=Cd.from(t),{data:o}=await yme(r,n,n.sourceSpatialReference,s);return o}function Yo(e,t){return e?t?4:3:t?3:2}const $O=me.getLogger("esri.layers.graphics.featureConversionUtils"),bme={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0},wme=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n},PN=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2]},s4e=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+3]},xme=(e,t,i,r,s,n)=>{e[i]=s,e[i+1]=n,e[i+2]=t[r+2],e[i+3]=t[r+3]};function AW(e,t,i,r){if(e){if(i)return t&&r?xme:PN;if(t&&r)return s4e}else if(t&&r)return PN;return wme}function Fk({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function Uk({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function MK({scale:e,translate:t},i){return i*e[0]+t[0]}function OK({scale:e,translate:t},i){return t[1]-i*e[1]}function Uvt(e,t,i){return e?t?i?OW(e):RW(e):i?MW(e):J4(e):null}function J4(e){const t=e.coords;return{x:t[0],y:t[1]}}function Tme(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e}function RW(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2]}}function n4e(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e}function MW(e){const t=e.coords;return{x:t[0],y:t[1],m:t[2]}}function o4e(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.m,e}function OW(e){const t=e.coords;return{x:t[0],y:t[1],z:t[2],m:t[3]}}function a4e(e,t){return e.coords[0]=t.x,e.coords[1]=t.y,e.coords[2]=t.z,e.coords[3]=t.m,e}function l4e(e,t,i,r){let s=J4;i&&r?s=OW:i?s=RW:r&&(s=MW);for(const n of t){const{geometry:o,attributes:a}=n,l=_(o)?s(o):null;e.push({attributes:a,geometry:l})}return e}function PW(e,t){return e&&t?a4e:e?n4e:t?o4e:Tme}function c4e(e,t,i,r,s){const n=PW(i,r);for(const o of t){const{geometry:a,attributes:l}=o;let c;a&&(c=n(new ol,a)),e.push(new Af(c,l,null,l[s]))}return e}function kvt(e,t,i=PW(t.z!=null,t.m!=null)){return i(e,t)}function u4e(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;n&&(a=Sme(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Sme(e,t,i){if(R(e))return null;const r=Yo(t,i),s=[];for(let n=0;n<e.coords.length;n+=r){const o=[];for(let a=0;a<r;a++)o.push(e.coords[n+a]);s.push(o)}return t?i?{points:s,hasZ:t,hasM:i}:{points:s,hasZ:t}:i?{points:s,hasM:i}:{points:s}}function h4e(e,t,i,r,s){const n=Yo(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Eme(new ol,a,n)),e.push(new Af(c,l,null,l[s]))}return e}function Eme(e,t,i=Yo(t.hasZ,t.hasM)){e.lengths[0]=t.points.length;const r=e.coords;let s=0;for(const n of t.points)for(let o=0;o<i;o++)r[s++]=n[o];return e}function d4e(e,t,i,r){for(const s of t){const{geometry:n,attributes:o}=s;let a;_(n)&&(a=Cme(n,i,r)),e.push({attributes:o,geometry:a})}return e}function Cme(e,t,i){if(!e)return null;const r=Yo(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{paths:o,hasZ:t,hasM:i}:{paths:o,hasZ:t}:i?{paths:o,hasM:i}:{paths:o}}function p4e(e,t,i,r,s){const n=Yo(i,r);for(const o of t){const a=o.geometry,l=o.attributes;let c;a&&(c=Ame(new ol,a,n)),e.push(new Af(c,l,null,l[s]))}return e}function Ame(e,t,i=Yo(t.hasZ,t.hasM)){const{lengths:r,coords:s}=e;let n=0;for(const o of t.paths){for(const a of o)for(let l=0;l<i;l++)s[n++]=a[l];r.push(o.length)}return e}function f4e(e,t,i,r){for(const s of t){const{geometry:n,attributes:o,centroid:a}=s;let l;if(_(n)&&(l=Rme(n,i,r)),_(a)){const c=J4(a);e.push({attributes:o,centroid:c,geometry:l})}else e.push({attributes:o,geometry:l})}return e}function Rme(e,t,i){if(!e)return null;const r=Yo(t,i),{coords:s,lengths:n}=e,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<r;f++)p.push(s[a++]);c.push(p)}o.push(c)}return t?i?{rings:o,hasZ:t,hasM:i}:{rings:o,hasZ:t}:i?{rings:o,hasM:i}:{rings:o}}function m4e(e,t,i,r,s){for(const n of t){const o=n.geometry,a=n.centroid,l=n.attributes;let c;o&&(c=Mme(new ol,o,i,r)),_(a)?e.push(new Af(c,l,Tme(new ol,a),l[s])):e.push(new Af(c,l,null,l[s]))}return e}function Mme(e,t,i=t.hasZ,r=t.hasM){return g4e(e,t.rings,i,r),e}function g4e(e,t,i,r){const s=Yo(i,r),{lengths:n,coords:o}=e;let a=0;n.length=o.length=0;for(const l of t){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return e}const sS=[],cR=[];function zvt(e,t,i,r,s){sS[0]=e;const[n]=Ome(cR,sS,t,i,r,s);return sS.length=cR.length=0,n}function Ome(e,t,i,r,s,n){if(e.length=0,!i){for(const o of t){const a=o.attributes[n];e.push(new Af(null,o.attributes,null,a))}return e}switch(i){case"esriGeometryPoint":return c4e(e,t,r,s,n);case"esriGeometryMultipoint":return h4e(e,t,r,s,n);case"esriGeometryPolyline":return p4e(e,t,r,s,n);case"esriGeometryPolygon":return m4e(e,t,r,s,n);default:$O.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${i}'`)),e.length=0}return e}function Vvt(e,t,i,r){cR[0]=e,Pme(sS,cR,t,i,r);const s=sS[0];return sS.length=cR.length=0,s}function y4e(e,t,i){if(R(e))return null;const r=new ol;return"hasZ"in e&&t==null&&(t=e.hasZ),"hasM"in e&&i==null&&(i=e.hasM),WH(e)?PW(t!=null?t:e.z!=null,i!=null?i:e.m!=null)(r,e):lb(e)?Mme(r,e,t,i):XH(e)?Ame(r,e,Yo(t,i)):qH(e)?Eme(r,e,Yo(t,i)):void $O.error("convertFromGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${e}'`))}function v4e(e,t,i,r){const s=e&&("coords"in e?e:e.geometry);if(R(s))return null;switch(t){case"esriGeometryPoint":{let n=J4;return i&&r?n=OW:i?n=RW:r&&(n=MW),n(s)}case"esriGeometryMultipoint":return Sme(s,i,r);case"esriGeometryPolyline":return Cme(s,i,r);case"esriGeometryPolygon":return Rme(s,i,r);default:return void $O.error("convertToGeometry:unknown-geometry",new q(`Unable to parse unknown geometry type '${t}'`))}}function _4e(e,t){for(const i of t)e.push({attributes:i.attributes});return e}function Pme(e,t,i,r,s){if(e.length=0,R(i))return _4e(e,t);switch(i){case"esriGeometryPoint":return l4e(e,t,r,s);case"esriGeometryMultipoint":return u4e(e,t,r,s);case"esriGeometryPolyline":return d4e(e,t,r,s);case"esriGeometryPolygon":return f4e(e,t,r,s);default:$O.error("convertToFeatureSet:unknown-geometry",new q(`Unable to parse unknown geometry type '${i}'`))}return e}function Bvt(e){const{objectIdFieldName:t,spatialReference:i,transform:r,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=e,m={features:Pme([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:t,spatialReference:i,uniqueIdField:h,queryGeometry:v4e(p,f,!1,!1)};return r&&(m.transform=r),c&&(m.exceededTransferLimit=c),n&&(m.hasM=n),o&&(m.hasZ=o),m}function Gvt(e,t){const i=new Z4,{hasM:r,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=e;return p&&(i.fields=p),i.geometryType=l,i.objectIdFieldName=o||t,i.spatialReference=a,i.objectIdFieldName?(n&&Ome(i.features,n,l,s,r,i.objectIdFieldName),c&&(i.exceededTransferLimit=c),r&&(i.hasM=r),s&&(i.hasZ=s),h&&(i.transform=h),i):($O.error(new q("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),i)}function jvt(e){const{transform:t,features:i,hasM:r,hasZ:s}=e;if(!t)return e;for(const n of i)_(n.geometry)&&IK(n.geometry,n.geometry,r,s,t),_(n.centroid)&&IK(n.centroid,n.centroid,r,s,t);return e.transform=null,e}function Hvt(e,t){const{geometryType:i,features:r,hasM:s,hasZ:n}=t;if(!e)return t;for(let o=0;o<r.length;o++){const a=r[o],l=a.weakClone();l.geometry=new ol,PK(l.geometry,a.geometry,s,n,i,e),a.centroid&&(l.centroid=new ol,PK(l.centroid,a.centroid,s,n,"esriGeometryPoint",e)),r[o]=l}return t.transform=e,t}function PK(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),R(t)||!t.coords.length)return null;const l=bme[s],{coords:c,lengths:h}=t,p=Yo(i,r),f=Yo(i&&o,r&&a),m=AW(i,r,o,a);if(!h.length)return m(e.coords,c,0,0,Fk(n,c[0]),Uk(n,c[1])),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y,v,w,b,S=0,T=0,E=T;for(const C of h){if(C<l)continue;let M=0;T=E,w=y=Fk(n,c[S]),b=v=Uk(n,c[S+1]),m(e.coords,c,T,S,w,b),M++,S+=p,T+=f;for(let I=1;I<C;I++,S+=p)w=Fk(n,c[S]),b=Uk(n,c[S+1]),w===y&&b===v||(m(e.coords,c,T,S,w-y,b-v),T+=f,M++,y=w,v=b);M>=l&&(e.lengths.push(M),E=T)}return e.coords.length=E,e.coords.length?e:null}function qvt(e,t,i,r,s,n,o=i,a=r){if(e.lengths.length&&(e.lengths.length=0),e.coords.length&&(e.coords.length=0),!t||!t.coords.length)return null;const l=bme[s],{coords:c,lengths:h}=t,p=Yo(i,r),f=Yo(i&&o,r&&a),m=AW(i,r,o,a);if(!h.length)return m(e.coords,c,0,0,c[0],c[1]),e.lengths.length&&(e.lengths.length=0),e.coords.length=p,e;let y=0;const v=n*n;for(const w of h){if(w<l){y+=w*p;continue}const b=e.coords.length/f,S=y,T=y+(w-1)*p;m(e.coords,c,e.coords.length,S,c[S],c[S+1]),B9(e.coords,c,p,v,m,S,T),m(e.coords,c,e.coords.length,T,c[T],c[T+1]);const E=e.coords.length/f-b;E>=l?e.lengths.push(E):e.coords.length=b*f,y+=w*p}return e.coords.length?e:null}function b4e(e,t,i,r){const s=e[t],n=e[t+1],o=e[i],a=e[i+1],l=e[r],c=e[r+1];let h=o,p=a,f=l-h,m=c-p;if(f!==0||m!==0){const y=((s-h)*f+(n-p)*m)/(f*f+m*m);y>1?(h=l,p=c):y>0&&(h+=f*y,p+=m*y)}return f=s-h,m=n-p,f*f+m*m}function B9(e,t,i,r,s,n,o){let a,l=r,c=0;for(let h=n+i;h<o;h+=i)a=b4e(t,h,n,o),a>l&&(c=h,l=a);l>r&&(c-n>i&&B9(e,t,i,r,s,n,c),s(e,t,e.length,c,t[c],t[c+1]),o-c>i&&B9(e,t,i,r,s,c,o))}function Wvt(e,t,i,r){if(R(t)||!t.coords||!t.coords.length)return null;const s=Yo(i,r);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(t&&t.coords){const c=t.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return e[0]=n,e[1]=o,e[2]=a,e[3]=l,e}function IK(e,t,i,r,s){const{coords:n,lengths:o}=t,a=i?r?xme:PN:r?PN:wme,l=Yo(i,r);if(!n.length)return e!==t&&(e.lengths.length=0,e.coords.length=0),e;if(!o.length)return a(e.coords,n,0,0,MK(s,n[0]),OK(s,n[1])),e!==t&&(e.lengths.length=0,e.coords.length=l),e;const[c,h]=s.scale;let p=0;for(let f=0;f<o.length;f++){const m=o[f];e.lengths[f]=m;let y=MK(s,n[p]),v=OK(s,n[p+1]);a(e.coords,n,p,p,y,v),p+=l;for(let w=1;w<m;w++,p+=l)y+=n[p]*c,v-=n[p+1]*h,a(e.coords,n,p,p,y,v)}return e!==t&&(e.lengths.length=o.length,e.coords.length=n.length),e}function Xvt(e,t,i,r,s,n){const o=Yo(i,r),a=AW(i,r,s,n),l=t.coords;e.coords.length=0,e.lengths.length=0,e.lengths.push(...t.lengths);for(let c=0;c<l.length;c+=o)a(e.coords,l,e.coords.length,c,l[c],l[c+1]);return e}function w4e(e,t,i,r){let s=0,n=e[r*t],o=e[r*(t+1)];for(let a=1;a<i;a++){const l=n+e[r*(t+a)],c=o+e[r*(t+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function Yvt(e,t){const{coords:i,lengths:r}=e;let s=0,n=0;for(let o=0;o<r.length;o++)n+=w4e(i,s,r[o],t),s+=o;return Math.abs(n)}function Zvt(e,t){if(R(e))return null;const i=e.clone(),r=e.coords,s=e.lengths;let n=0;for(let o=0;o<s.length;o++){const a=s[o];let l=r[t*n],c=r[t*n+1];for(let h=1;h<a;h++){const p=l+r[t*(n+h)],f=c+r[t*(n+h)+1];i.coords[t*(n+h)]=p,i.coords[t*(n+h)+1]=f,l=p,c=f}n+=a}return i}var G9;let hs=G9=class extends fe{constructor(e){super(e),this.cacheHint=void 0,this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(e,t){t.historicMoment=e&&e.getTime()}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(t.definitionExpression="1=1")}clone(){return new G9(te({cacheHint:this.cacheHint,dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:Boolean,json:{write:!0}})],hs.prototype,"cacheHint",void 0),u([d({type:bd,json:{write:!0}})],hs.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],hs.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],hs.prototype,"geometryPrecision",void 0),u([d({type:Date})],hs.prototype,"historicMoment",void 0),u([Be("historicMoment")],hs.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],hs.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],hs.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],hs.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],hs.prototype,"outFields",void 0),u([d({type:Xe,json:{read:{source:"outSR"},write:{target:"outSR"}}})],hs.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],hs.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],hs.prototype,"start",void 0),u([Be("start"),Be("num")],hs.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],hs.prototype,"num",void 0),u([d({json:{write:!0}})],hs.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],hs.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],hs.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],hs.prototype,"where",void 0),hs=G9=u([P("esri.rest.support.RelationshipQuery")],hs),hs.from=Qr(hs);const j9=hs;var H9;let Vx=H9=class extends fe{constructor(e){super(e),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new H9({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],Vx.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],Vx.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],Vx.prototype,"orderByFields",void 0),Vx=H9=u([P("esri.rest.support.TopFilter")],Vx);const x4e=Vx;var q9;const $K=new _i({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),DK=new _i({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let qr=q9=class extends fe{constructor(e){super(e),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(e,t){t.resultOffset=this.start,t.resultRecordCount=this.num||10}clone(){return new q9(te({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],qr.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:e=>({enabled:e>0})}}})],qr.prototype,"distance",void 0),u([d({types:cw,json:{read:yf,write:!0}})],qr.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],qr.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],qr.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],qr.prototype,"num",void 0),u([d({json:{write:!0}})],qr.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],qr.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],qr.prototype,"outFields",void 0),u([d({type:Xe,json:{read:{source:"outSR"},write:{target:"outSR"}}})],qr.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],qr.prototype,"resultType",void 0),u([d({json:{write:!0}})],qr.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],qr.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:e=>({enabled:e})}}})],qr.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],qr.prototype,"start",void 0),u([Be("start"),Be("num")],qr.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:$K.read},write:{target:"spatialRel",writer:$K.write}}})],qr.prototype,"spatialRelationship",void 0),u([d({type:Uf,json:{write:!0}})],qr.prototype,"timeExtent",void 0),u([d({type:x4e,json:{write:!0}})],qr.prototype,"topFilter",void 0),u([d({type:String,json:{read:DK.read,write:{writer:DK.write,overridePolicy(e){return{enabled:e&&this.distance>0}}}}})],qr.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],qr.prototype,"where",void 0),qr=q9=u([P("esri.rest.support.TopFeaturesQuery")],qr),qr.from=Qr(qr);const sP=qr,T4e="esri.widgets.Feature.support.relatedFeatureUtils",LK=me.getLogger(T4e),NK=new Map;function W9(e){if(!Zm(e))return null;const[t,i]=e.split("/").slice(1);return{layerId:t,fieldName:i}}function S4e(e,t){if(!t.relationships)return null;let i=null;const{relationships:r}=t;return r.some(s=>s.id===parseInt(e,10)&&(i=s,!0)),i}function E4e({originRelationship:e,relationships:t,layerId:i}){let r;return t&&t.some(s=>(`${s.relatedTableId}`===i&&s.id===e.id&&(r=s),!!r)),r}function C4e(e,t){const i=t.toLowerCase();for(const r in e)if(r.toLowerCase()===i)return e[r];return null}function A4e(e,t){const i=S4e(e,t);if(!!i)return{url:`${t.url}/${i.relatedTableId}`,sourceSpatialReference:t.spatialReference,relation:i,relatedFields:[],outStatistics:[]}}function R4e(e,t){if(!t||!e)return;const{features:i,statsFeatures:r}=e,s=i&&i.value;t.relatedFeatures=s?s.features:[];const n=r&&r.value;t.relatedStatsFeatures=n?n.features:[]}function M4e(e,t,i,r){const s=new j9;return s.outFields=["*"],s.relationshipId=typeof t.id=="number"?t.id:parseInt(t.id,10),s.objectIds=[e.attributes[i.objectIdField]],i.queryRelatedFeatures(s,r)}function O4e(e,t,i){let r=0;const s=[];for(;r<t.length;)s.push(`${e} IN (${t.slice(r,i+r)})`),r+=i;return s.join(" OR ")}async function P4e(e,t,i,r){const s=i.layerId.toString(),{layerInfo:n,relation:o,relatedFields:a,outStatistics:l,url:c,sourceSpatialReference:h}=t,p=E4e({originRelationship:o,relationships:n.relationships,layerId:s});if(p.relationshipTableId&&p.keyFieldInRelationshipTable){const m=(await M4e(e,p,i,r))[e.attributes[i.objectIdField]];if(!m)return null;const y=m.features.map(v=>v.attributes[n.objectIdField]);if((l==null?void 0:l.length)>0&&n.supportsStatistics){const v=new Cd;v.where=O4e(n.objectIdField,y,1e3),v.outFields=a,v.outStatistics=l,v.sourceSpatialReference=h;const w={features:Promise.resolve(m),statsFeatures:Nk(c,v)};return pn(w)}}const f=p==null?void 0:p.keyField;if(f){const m=o4(N4e(n.fields,f)),y=C4e(e.attributes,o.keyField),v=m?`${f}=${y}`:`${f}='${y}'`,w=Nk(c,new Cd({where:v,outFields:t.relatedFields,sourceSpatialReference:h}),r),b=t.outStatistics&&t.outStatistics.length>0&&n.supportsStatistics?Nk(c,new Cd({where:v,outFields:t.relatedFields,outStatistics:t.outStatistics,sourceSpatialReference:h}),r):null,S={features:w};return b&&(S.statsFeatures=b),pn(S)}return null}function I4e(e,t){return ur(e,{query:{f:"json"},signal:t&&t.signal})}function $4e({relatedInfos:e,layer:t},i){const r={};return e.forEach((s,n)=>{const{relation:o}=s;if(!o){const p=new q("relation-required","A relation is required on a layer to retrieve related records.");throw LK.error(p),p}const{relatedTableId:a}=o;if(typeof a!="number"){const p=new q("A related table ID is required on a layer to retrieve related records.");throw LK.error(p),p}const l=`${t.url}/${a}`,c=NK.get(l),h=c||I4e(l,i);c||NK.set(l,h),r[n]=h}),pn(r)}function D4e({graphic:e,relatedInfos:t,layer:i},r){const s={};return t.forEach((n,o)=>{n.layerInfo&&(s[o]=P4e(e,n,i,r))}),pn(s)}function L4e({relatedInfo:e,fieldName:t,fieldInfo:i}){if(e.relatedFields.push(t),i.statisticType){const r=new _me({statisticType:i.statisticType,onStatisticField:t,outStatisticFieldName:t});e.outStatistics.push(r)}}function N4e(e,t){if(e!=null){t=t.toLowerCase();for(const i of e)if(i&&i.name.toLowerCase()===t)return i}return null}const FK={chartAnimation:!0};let Nn=class extends Ee{constructor(e){super(e),this.abilities=F({},FK),this.activeMediaInfoIndex=0,this.attributes=null,this.description=null,this.fieldInfoMap=null,this.formattedAttributes=null,this.expressionAttributes=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null}castAbilities(e){return F(F({},FK),e)}get activeMediaInfo(){return this.formattedMediaInfos[this.activeMediaInfoIndex]||null}get formattedMediaInfos(){return this._formatMediaInfos()||[]}get formattedMediaInfoCount(){return this.formattedMediaInfos.length}setActiveMedia(e){this._setContentElementMedia(e)}next(){this._pageContentElementMedia(1)}previous(){this._pageContentElementMedia(-1)}_setContentElementMedia(e){const{formattedMediaInfoCount:t}=this,i=(e+t)%t;this.activeMediaInfoIndex=i}_pageContentElementMedia(e){const{activeMediaInfoIndex:t}=this,i=t+e;this._setContentElementMedia(i)}_formatMediaInfos(){const{attributes:e,mediaInfos:t,formattedAttributes:i,expressionAttributes:r,fieldInfoMap:s,layer:n}=this;return t==null?void 0:t.map(o=>{const a=o==null?void 0:o.clone();if(!a)return null;if(a.title=Y1({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.title}),a.caption=Y1({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.caption}),a.altText=Y1({attributes:e,fieldInfoMap:s,globalAttributes:i,expressionAttributes:r,layer:n,text:a.altText}),a.type==="image"){const{value:l}=a;return this._setImageValue({value:l,formattedAttributes:i,layer:n}),a.value.sourceURL?a:void 0}if(a.type==="pie-chart"||a.type==="line-chart"||a.type==="column-chart"||a.type==="bar-chart"){const{value:l}=a;return this._setChartValue({value:l,chartType:a.type,attributes:e,formattedAttributes:i,layer:n}),a}return null}).filter(Boolean)}_setImageValue(e){const{fieldInfoMap:t}=this,{value:i,formattedAttributes:r,layer:s}=e,{linkURL:n,sourceURL:o}=i;if(o){const a=x9(o,s);i.sourceURL=w9({formattedAttributes:r,template:a,fieldInfoMap:t})}if(n){const a=x9(n,s);i.linkURL=w9({formattedAttributes:r,template:a,fieldInfoMap:t})}}_setChartValue(e){const{value:t,attributes:i,formattedAttributes:r,chartType:s,layer:n}=e,{popupTemplate:o,relatedInfos:a}=this,{fields:l,normalizeField:c}=t;if(t.fields=sLe(l,n),c&&(t.normalizeField=MN(c,n)),!l.some(p=>!!(r[p]!=null||Zm(p)&&a.size)))return;const h=o==null?void 0:o.fieldInfos;l.forEach(p=>{if(Zm(p))return void(t.series=[...t.series,...this._getRelatedChartInfos({fieldInfos:h,fieldName:p,formattedAttributes:r,chartType:s,value:t})]);const f=this._getChartOption({value:t,attributes:i,chartType:s,formattedAttributes:r,fieldName:p,fieldInfos:h});t.series.push(f)})}_getRelatedChartInfos(e){var y;const{fieldInfos:t,fieldName:i,formattedAttributes:r,chartType:s,value:n}=e,o=[],a=W9(i),{layerId:l,fieldName:c}=a,h=(y=this.relatedInfos)==null?void 0:y.get(l.toString());if(!h)return o;const{relatedFeatures:p,relation:f}=h;if(!f||!p)return o;const{cardinality:m}=f;return p.forEach(v=>{const{attributes:w}=v;w&&Object.keys(w).forEach(b=>{b===c&&o.push(this._getChartOption({value:n,attributes:w,formattedAttributes:r,fieldName:i,chartType:s,relatedFieldName:b,fieldInfos:t}))})}),m==="one-to-many"||m==="many-to-many"?o:[o[0]]}_getTooltip({label:e,value:t,chartType:i}){return i==="pie-chart"?`${e}`:`${e}: ${t}`}_getChartOption(e){var T,E,C,M,I,N;const{value:t,attributes:i,formattedAttributes:r,fieldName:s,relatedFieldName:n,fieldInfos:o,chartType:a}=e,{layer:l,fieldInfoMap:c}=this,{normalizeField:h,tooltipField:p}=t,f=h?Zm(h)?i[W9(h).fieldName]:i[h]:null,m=n&&i[n]!==void 0?i[n]:i[s]!==void 0?i[s]:r[s],y=new Lue({fieldName:s,value:m===void 0?null:m&&f?m/f:m});if(Zm(s)){const D=c.get(s.toLowerCase()),z=c.get(p.toLowerCase()),V=(T=D==null?void 0:D.fieldName)!=null?T:s,k=(I=(M=(C=r[(E=z==null?void 0:z.fieldName)!=null?E:p])!=null?C:D==null?void 0:D.label)!=null?M:D==null?void 0:D.fieldName)!=null?I:n,Y=r[V];return y.tooltip=this._getTooltip({label:k,value:Y,chartType:a}),y}const v=jfe(o,s),w=MN(s,l),b=p&&r[p]!==void 0?r[p]:Bfe(v||new bO({fieldName:w}),(N=this.popupTemplate)==null?void 0:N.expressionInfos),S=r[w];return y.tooltip=this._getTooltip({label:b,value:S,chartType:a}),y}};u([d()],Nn.prototype,"abilities",void 0),u([Ot("abilities")],Nn.prototype,"castAbilities",null),u([d()],Nn.prototype,"activeMediaInfoIndex",void 0),u([d({readOnly:!0})],Nn.prototype,"activeMediaInfo",null),u([d()],Nn.prototype,"attributes",void 0),u([d()],Nn.prototype,"description",void 0),u([d()],Nn.prototype,"fieldInfoMap",void 0),u([d()],Nn.prototype,"formattedAttributes",void 0),u([d()],Nn.prototype,"expressionAttributes",void 0),u([d({readOnly:!0})],Nn.prototype,"formattedMediaInfos",null),u([d()],Nn.prototype,"layer",void 0),u([d({readOnly:!0})],Nn.prototype,"formattedMediaInfoCount",null),u([d()],Nn.prototype,"mediaInfos",void 0),u([d()],Nn.prototype,"popupTemplate",void 0),u([d()],Nn.prototype,"relatedInfos",void 0),u([d()],Nn.prototype,"title",void 0),Nn=u([P("esri.widgets.Feature.FeatureMedia.FeatureMediaViewModel")],Nn);const Q1=Nn;var UK=["#ffffff","#858585","#ffbebe","#ffebbe","#ffebaf","#ffffbe","#e9ffbe","#d3ffbe","#beffe8","#bee8ff","#bed2ff","#e8beff","#ffbee8","#ebebeb","#707070","#ff7f7f","#ffa77f","#ffd37f","#ffff73","#d1ff73","#a3ff73","#73ffdf","#73dfff","#73b2ff","#df73ff","#ff73df","#d6d6d6","#5c5c5c","#ff0000","#ff5500","#ffaa00","#ffff00","#aaff00","#55ff00","#00ffc5","#00c5ff","#0070ff","#c500ff","#ff00c5","#c2c2c2","#474747","#e60000","#e64c00","#e69800","#e6e600","#98e600","#4ce600","#00e6a9","#00a9e6","#005ce6","#a900e6","#e600a9","#adadad","#242424","#a80000","#a83800","#a87000","#a8a800","#70a800","#38a800","#00a884","#0084a8","#004da8","#8400a8","#a80084","#999999","#1a1a1a","#730000","#732600","#734c00","#737300","#4c7300","#267300","#00734c","#004c73","#002673","#4c0073","#73004"],F4e=[].concat(UK.slice(30,39),UK.slice(28,30).reverse()),U4e=[{name:"default",colors:F4e},{name:"cat-dark",colors:["#ed5151","#149ece","#a7c636","#9e559c","#fc921f","#ffde3e","#f789d8","#b7814a","#3caf99","#6b6bd6","#b54779","#7f7f7f"]},{name:"tropical-bliss",colors:["#fce138","#ff9399","#fcd27e","#f1983c","#a553b7","#b1a9d0","#6ecffc","#4c81cd","#fc6f84","#fc3e5a","#6af689","#48885c"]},{name:"desert-blooms",colors:["#102432","#144d59","#ffc730","#ed9310","#a64f1b","#661510","#d9351a","#b31515","#4a0932","#8c213f","#18382e","#2c6954"]},{name:"under-the-sea",colors:["#bf9727","#607100","#00734c","#704489","#01acca","#024e76","#f09100","#ea311f","#c6004b","#7570b3","#666666","#333333"]},{name:"vibrant-rainbow",colors:["#fffb00","#f5cb11","#9fd40c","#46e39c","#32b8a6","#7ff2fa","#ac08cc","#dd33ff","#eb7200","#e8a784","#bf2e2e","#6c7000"]},{name:"ocean-bay",colors:["#191921","#11495c","#78b1c2","#454f4b","#8f8f82","#9be0c0","#87b051","#f7ec88","#ebdcc1","#dbb658","#c43541","#75351e"]},{name:"prairie-summer",colors:["#332424","#751555","#d47013","#d68989","#211173","#82aad6","#7bfaeb","#6ec9a8","#6b6408","#eada40","#ccc54a","#1fc235"]},{name:"pastel-chalk",colors:["#fffd99","#f5e6a4","#c1d48c","#b8e3d0","#a0b8b5","#cbf7fa","#d791f2","#dfc1eb","#f2b983","#e8c4b2","#bf8e8e","#94995c"]},{name:"seq-yellow-orange-red-bright",colors:["#910000","#b1260b","#c0370f","#e05919","#ef6a1d","#ff7b22","#ffa143","#ffb454","#ffda74","#ffed85"]},{name:"seq-reds-bright",colors:["#57453b","#7b4238","#9f4036","#c23d33","#d7483c","#ec5244","#f3696c","#f9816c","#ffc4ae","#fff0dc"]},{name:"seq-purples-bright",colors:["#4e465c","#5a4a78","#695291","#775baa","#8663c3","#946bdc","#aa89e8","#c1a6f3","#d7c4ff","#e6e1ff"]},{name:"seq-blues-bright",colors:["#404d54","#435c6c","#48799d","#4b88b6","#4d96ce","#50a5e7","#74bbed","#98d0f3","#bce6f9","#e6faff"]},{name:"seq-greens-bright",colors:["#39544c","#386757","#368165","#359b73","#33b581","#4bc392","#64d2a2","#7ce0b3","#cbf6d9","#f4ffea"]},{name:"seq-browns-bright",colors:["#524834","#715b38","#8f6e3c","#ae8140","#cc9444","#eba748","#eeb664","#f0c47f","#f9e0b7","#fff8eb"]}];const kK="en-us",IW=new Map([["ar",()=>import("./ar.2c24e6e7.js").then(e=>e.a)],["bg-bg",()=>import("./bg_BG.26f97987.js").then(e=>e.b)],["bs-ba",()=>import("./bs_BA.067aeb87.js").then(e=>e.b)],["ca-es",()=>import("./ca_ES.32273339.js").then(e=>e.c)],["cs-cz",()=>import("./cs_CZ.9ea7af22.js").then(e=>e.c)],["da-dk",()=>import("./da_DK.595949cc.js").then(e=>e.d)],["de-de",()=>import("./de_DE.3368ec63.js").then(e=>e.d)],["de-ch",()=>import("./de_CH.f3f3eefd.js").then(e=>e.d)],["el-gr",()=>import("./el_GR.e7eb7eda.js").then(e=>e.e)],["en-us",()=>import("./en_US.878ec796.js").then(e=>e.e)],["en-ca",()=>import("./en_CA.267653be.js").then(e=>e.e)],["es-es",()=>import("./es_ES.3e740d13.js").then(e=>e.e)],["et-ee",()=>import("./et_EE.509c7ad7.js").then(e=>e.e)],["fi-fi",()=>import("./fi_FI.2fba4ec6.js").then(e=>e.f)],["fr-fr",()=>import("./fr_FR.84b31d1d.js").then(e=>e.f)],["he-il",()=>import("./he_IL.2bd410c9.js").then(e=>e.h)],["hr-hr",()=>import("./hr_HR.a1a0a03f.js").then(e=>e.h)],["hu-hu",()=>import("./hu_HU.eec3a11e.js").then(e=>e.h)],["id-id",()=>import("./id_ID.398eaaa5.js").then(e=>e.i)],["it-it",()=>import("./it_IT.0db9f8e0.js").then(e=>e.i)],["ja-jp",()=>import("./ja_JP.42e20576.js").then(e=>e.j)],["ko-kr",()=>import("./ko_KR.aefaeaaf.js").then(e=>e.k)],["lt-lt",()=>import("./lt_LT.33ba7406.js").then(e=>e.l)],["lv-lv",()=>import("./lv_LV.73b99a6d.js").then(e=>e.l)],["nb-no",()=>import("./nb_NO.96acc8ef.js").then(e=>e.n)],["nl-nl",()=>import("./nl_NL.7d9c5ef7.js").then(e=>e.n)],["pl-pl",()=>import("./pl_PL.3c705b25.js").then(e=>e.p)],["pt-br",()=>import("./pt_BR.469bdad2.js").then(e=>e.p)],["pt-pt",()=>import("./pt_PT.ddad9610.js").then(e=>e.p)],["ro-ro",()=>import("./ro_RO.8c930254.js").then(e=>e.r)],["ru-ru",()=>import("./ru_RU.bc1a7882.js").then(e=>e.r)],["sk-sk",()=>import("./sk_SK.6a3289fb.js").then(e=>e.s)],["sl-sl",()=>import("./sl_SL.f9723f20.js").then(e=>e.s)],["sr-rs",()=>import("./sr_RS.c2768e44.js").then(e=>e.s)],["sv-se",()=>import("./sv_SE.34c2ff2f.js").then(e=>e.s)],["th-th",()=>import("./th_TH.ab88e5de.js").then(e=>e.t)],["tr-tr",()=>import("./tr_TR.91ae454a.js").then(e=>e.t)],["uk-ua",()=>import("./uk_UA.60d85fb6.js").then(e=>e.u)],["vi-vn",()=>import("./vi_VN.177c6414.js").then(e=>e.v)],["zh-cn",()=>import("./zh_Hans.a86daa1b.js").then(e=>e.z)],["zh-hk",()=>import("./zh_Hant.b844c5a1.js").then(e=>e.z)],["zh-tw",()=>import("./zh_Hant.b844c5a1.js").then(e=>e.z)]]);function k4e(e){const t=e.split("-")[0].toLowerCase();let i=null;for(const r of IW.keys())if(r.startsWith(t)){i=r;break}return i}function z4e(e){return e?IW.has(e.toLowerCase())?e.toLowerCase():k4e(e)||kK:kK}let Ow,AE;async function V4e(e=tu()){if(e=z4e(e),Ow&&e===AE)return Ow;Ow=import("./index.67eb2a65.js").then(t=>t.i),AE=e;try{const[t,i]=await Promise.all([Ow,IW.get(AE)()]);AE===e&&(t.am4core.options.defaultLocale=i.default),t.am4core.options.suppressWarnings=!0,t.am4core.options.autoDispose=!0}catch{return Ow=null,AE=null,null}return Ow}function B4e(e,t="default"){const i=U4e.find(r=>r.name===t);return i?i.colors.map(r=>e.color(r)):null}const bs={base:"esri-feature-media",mediaContainer:"esri-feature-media__container",mediaItemContainer:"esri-feature-media__item-container",mediaItem:"esri-feature-media__item",mediaItemTitle:"esri-feature-media__item-title",mediaItemCaption:"esri-feature-media__item-caption",mediaPrevious:"esri-feature-media__previous",mediaPreviousIconLTR:"esri-feature-media__previous-icon",mediaPreviousIconRTL:"esri-feature-media__previous-icon--rtl",mediaNext:"esri-feature-media__next",mediaNextIconLTR:"esri-feature-media__next-icon",mediaNextIconRTL:"esri-feature-media__next-icon--rtl",mediaChart:"esri-feature-media__chart",mediaButton:"esri-feature-media__button",mediaIcon:"esri-feature-media__icon",iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow"},kk=.05,zk=.95,Vk=15,Xf="color",Kg="tooltip",RE="value",zK="default-line-value";let Cl=class extends ml{constructor(e,t){super(e,t),this._refreshTimer=null,this._refreshIntervalInfo=null,this._featureElementInfo=null,this.attributes=null,this.activeMediaInfoIndex=null,this.description=null,this.fieldInfoMap=null,this.layer=null,this.mediaInfos=null,this.popupTemplate=null,this.relatedInfos=null,this.title=null,this.viewModel=new Q1,this.messages=null,this._getChartDependencies=async i=>{const r=await V4e(),{destroyed:s,viewModel:n}=this;if(s||!n||!i)return;const{activeMediaInfo:o}=n,a=await this._getRendererColors(r);this._renderChart({chartDiv:i,mediaInfo:o,chartsModule:r,colorMap:a})}}initialize(){this._featureElementInfo=new vW,this.own([ae(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.activeMediaInfo,(t=this.viewModel)==null?void 0:t.activeMediaInfoIndex]},()=>this._setupMediaRefreshTimer(),Ft),ae(()=>{var e,t;return[(e=this.viewModel)==null?void 0:e.description,(t=this.viewModel)==null?void 0:t.title]},()=>this._setupFeatureElementInfo(),Ft)])}destroy(){this._clearMediaRefreshTimer(),this._featureElementInfo.destroy()}render(){var e;return ue("div",{bind:this,class:bs.base,onkeyup:this._handleMediaKeyup},(e=this._featureElementInfo)==null?void 0:e.render(),this.renderMedia())}renderMedia(){const{formattedMediaInfoCount:e}=this.viewModel;return e?ue("div",{key:"media-element-container",class:bs.mediaContainer},this.renderMediaPageButton("previous"),this.renderMediaInfo(),this.renderMediaPageButton("next")):null}renderImageMediaInfo(e){const{_refreshIntervalInfo:t}=this,{activeMediaInfoIndex:i,formattedMediaInfoCount:r}=this.viewModel,{value:s,refreshInterval:n,altText:o,title:a,type:l}=e,{sourceURL:c,linkURL:h}=s,p=zfe(h)?"_blank":"_self",f=p==="_blank"?"noreferrer":"",m=n?t:null,y=m?m.timestamp:0,v=m?m.sourceURL:c,w=ue("img",{alt:o||a,key:`media-${l}-${i}-${r}-${y}`,src:v});return(h?ue("a",{title:a,href:h,rel:f,target:p},w):null)||w}renderChartMediaInfo(e){const{activeMediaInfoIndex:t,formattedMediaInfoCount:i}=this.viewModel;return ue("div",{key:`media-${e.type}-${t}-${i}`,bind:this,class:bs.mediaChart,afterCreate:this._getChartDependencies})}renderMediaInfoType(){const{activeMediaInfo:e}=this.viewModel;return e?e.type==="image"?this.renderImageMediaInfo(e):e.type.includes("chart")?this.renderChartMediaInfo(e):null:null}renderMediaInfo(){const{activeMediaInfo:e}=this.viewModel;if(!e)return null;const t=e.title?ue("div",{key:"media-title",class:bs.mediaItemTitle,innerHTML:e.title}):null,i=e.caption?ue("div",{key:"media-caption",class:bs.mediaItemCaption,innerHTML:e.caption}):null;return ue("div",{key:"media-container",class:bs.mediaItemContainer},ue("div",{key:"media-item-container",class:bs.mediaItem},this.renderMediaInfoType()),t,i)}renderMediaPageButton(e){if(this.viewModel.formattedMediaInfoCount<2)return null;const t=e==="previous",i=t?this.messages.previous:this.messages.next,r=t?this.classes(bs.mediaButton,bs.mediaPrevious):this.classes(bs.mediaButton,bs.mediaNext),s=t?this.classes(bs.mediaIcon,bs.mediaPreviousIconLTR,bs.iconLeftTriangleArrow):this.classes(bs.mediaIcon,bs.mediaNextIconLTR,bs.iconRightTriangleArrow),n=t?this.classes(bs.mediaIcon,bs.mediaPreviousIconRTL,bs.iconRightTriangleArrow):this.classes(bs.mediaIcon,bs.mediaNextIconRTL,bs.iconLeftTriangleArrow),o=t?"media-previous":"media-next",a=t?this._previous:this._next;return ue("button",{type:"button",key:o,title:i,"aria-label":i,tabIndex:0,class:r,bind:this,onclick:a},ue("span",{"aria-hidden":"true",class:s}),ue("span",{"aria-hidden":"true",class:n}))}_setupFeatureElementInfo(){const{description:e,title:t}=this;this._featureElementInfo.set({description:e,title:t})}_next(){this.viewModel.next()}_previous(){this.viewModel.previous()}async _getRendererColors(e){var n;const{am4core:t}=e,i=(n=this.viewModel)==null?void 0:n.layer,r=new Map;if(!i)return r;const s=await uFe(i.renderer);return s.delete(null),Array.from(s.values()).every(o=>(o==null?void 0:o.length)===1)&&(r.set(zK,t.color({r:50,g:50,b:50,a:1})),Array.from(s.keys()).forEach(o=>{o&&r.set(o,t.color(s.get(o)[0].toCss(!0)))})),r}_handleMediaKeyup(e){const t=A1(e);t==="ArrowLeft"&&(e.stopPropagation(),this.viewModel.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.viewModel.next())}_renderChart(e){const{abilities:t}=this.viewModel,{chartsModule:i,chartDiv:r,mediaInfo:s,colorMap:n}=e,{value:o,type:a}=s,{am4core:l}=i,c=B4e(l);function h(m){m instanceof l.ColorSet&&c&&(m.list=c)}Zfe()&&l.useTheme(i.am4themes_dark);const p=window.matchMedia("(prefers-reduced-motion: reduce)");t.chartAnimation&&!p.matches?l.useTheme(i.am4themes_animated):l.unuseTheme(i.am4themes_animated),l.useTheme(h);const f=a==="pie-chart"?this._createPieChart(e):this._createXYChart(e);r.setAttribute("aria-label",s.altText||s.title),f.data=o.series.map(m=>({[Kg]:m.tooltip,[RE]:m.value,[Xf]:n.get(m.fieldName)})).filter(m=>a!=="pie-chart"||m.value>0)}_customizeChartTooltip(e,t){e.label.wrap=!0,e.label.maxWidth=200,e.autoTextColor=!1,e.getFillFromObject=!1,e.label.fill=t.color("#ffffff"),e.background.fill=t.color({r:0,g:0,b:0,a:.7})}_createPieChart(e){const{chartDiv:t,chartsModule:i}=e,{am4core:r,am4charts:s}=i,n=r.create(t,s.PieChart);n.rtl=B0(this.container);const o=n.series.push(new s.PieSeries);return o.labels.template.disabled=!0,o.ticks.template.disabled=!0,o.dataFields.value=RE,o.dataFields.category=Kg,this._customizeChartTooltip(o.tooltip,r),o.slices.template.tooltipText=n.rtl?"{category}: %{value.percent.formatNumber('#.0')}":"{category}: {value.percent.formatNumber('#.0')}%",o.slices.template.propertyFields.fill=Xf,o.slices.template.propertyFields.stroke=Xf,n}_getMinSeriesValue(e){let t=0;return e.forEach(i=>t=Math.min(i.value,t)),t}_createColumnChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.xAxes.push(new o.CategoryAxis);a.dataFields.category=Kg,a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dy=-a.tooltip.contentHeight});const l=e.yAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=kk,l.renderer.maxLabelPosition=zk,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueY=RE,h.dataFields.categoryX=Kg,h.columns.template.propertyFields.fill=Xf,h.columns.template.propertyFields.stroke=Xf,e.cursor=new o.XYCursor,s.series.length>Vk&&(e.scrollbarX=new n.Scrollbar)}_createBarChart(e,t){const{chartsModule:i,mediaInfo:r}=t,{value:s}=r,{am4core:n,am4charts:o}=i,a=e.yAxes.push(new o.CategoryAxis);a.dataFields.category=Kg,a.renderer.inversed=!0,a.renderer.labels.template.disabled=!0,this._customizeChartTooltip(a.tooltip,n),a.tooltip.events.on("sizechanged",()=>{a.tooltip.dx=a.tooltip.contentWidth});const l=e.xAxes.push(new o.ValueAxis),c=l.renderer.labels.template;l.renderer.minLabelPosition=kk,l.renderer.maxLabelPosition=zk,l.min=this._getMinSeriesValue(s.series),this._customizeChartTooltip(l.tooltip,n),c.wrap=!0;const h=e.series.push(new o.ColumnSeries);h.dataFields.valueX=RE,h.dataFields.categoryY=Kg,h.columns.template.propertyFields.fill=Xf,h.columns.template.propertyFields.stroke=Xf,e.cursor=new o.XYCursor,s.series.length>Vk&&(e.scrollbarY=new n.Scrollbar)}_createLineChart(e,t){const{chartsModule:i,mediaInfo:r,colorMap:s}=t,{value:n}=r,{am4core:o,am4charts:a}=i,l=e.xAxes.push(new a.CategoryAxis);l.dataFields.category=Kg,l.renderer.labels.template.disabled=!0,this._customizeChartTooltip(l.tooltip,o),l.tooltip.events.on("sizechanged",()=>{l.tooltip.dy=-l.tooltip.contentHeight});const c=e.yAxes.push(new a.ValueAxis),h=c.renderer.labels.template;c.renderer.minLabelPosition=kk,c.renderer.maxLabelPosition=zk,c.min=this._getMinSeriesValue(n.series),this._customizeChartTooltip(c.tooltip,o),h.wrap=!0;const p=e.series.push(new a.LineSeries);p.dataFields.categoryX=Kg,p.dataFields.valueY=RE,p.strokeWidth=1;const f=s.get(zK);f&&(p.stroke=f);const m=p.bullets.push(new a.CircleBullet);m.propertyFields.fill=Xf,m.propertyFields.stroke=Xf,e.cursor=new a.XYCursor,n.series.length>Vk&&(e.scrollbarX=new o.Scrollbar)}_createXYChart(e){const{chartDiv:t,chartsModule:i,mediaInfo:r}=e,{type:s}=r,{am4core:n,am4charts:o}=i,a=n.create(t,o.XYChart);return a.rtl=B0(this.container),s==="column-chart"&&this._createColumnChart(a,e),s==="bar-chart"&&this._createBarChart(a,e),s==="line-chart"&&this._createLineChart(a,e),a}_clearMediaRefreshTimer(){const{_refreshTimer:e}=this;e&&(clearTimeout(e),this._refreshTimer=null)}_updateMediaInfoTimestamp(e){const t=Date.now();this._refreshIntervalInfo={timestamp:t,sourceURL:this._getImageSource(e,t)},this.scheduleRender()}_setupMediaRefreshTimer(){this._clearMediaRefreshTimer();const{activeMediaInfo:e}=this.viewModel;e&&e.type==="image"&&e.refreshInterval&&this._setRefreshTimeout(e)}_setRefreshTimeout(e){const{refreshInterval:t,value:i}=e;if(!t)return;const r=6e4*t;this._updateMediaInfoTimestamp(i.sourceURL);const s=setInterval(()=>{this._updateMediaInfoTimestamp(i.sourceURL)},r);this._refreshTimer=s}_getImageSource(e,t){const i=e.includes("?")?"&":"?",[r,s=""]=e.split("#");return`${r}${i}timestamp=${t}${s?"#":""}${s}`}};u([wt("viewModel.attributes")],Cl.prototype,"attributes",void 0),u([wt("viewModel.activeMediaInfoIndex")],Cl.prototype,"activeMediaInfoIndex",void 0),u([wt("viewModel.description")],Cl.prototype,"description",void 0),u([wt("viewModel.fieldInfoMap")],Cl.prototype,"fieldInfoMap",void 0),u([wt("viewModel.layer")],Cl.prototype,"layer",void 0),u([wt("viewModel.mediaInfos")],Cl.prototype,"mediaInfos",void 0),u([wt("viewModel.popupTemplate")],Cl.prototype,"popupTemplate",void 0),u([wt("viewModel.relatedInfos")],Cl.prototype,"relatedInfos",void 0),u([wt("viewModel.title")],Cl.prototype,"title",void 0),u([d({type:Q1})],Cl.prototype,"viewModel",void 0),u([d(),Ql("esri/widgets/Feature/t9n/Feature")],Cl.prototype,"messages",void 0),Cl=u([P("esri.widgets.Feature.FeatureMedia")],Cl);const Ime=Cl;class G4e{constructor(t,i){this.definition=null,this.context=null,this.definition=t,this.context=i}}class kf{constructor(t=[]){this._elements=t}length(){return this._elements.length}get(t){return this._elements[t]}toArray(){const t=[];for(let i=0;i<this.length();i++)t.push(this.get(i));return t}}class _w extends kf{constructor(t,i,r,s,n,o){super(t),this._lazyPt=[],this._hasZ=!1,this._hasM=!1,this._spRef=i,this._hasZ=r,this._hasM=s,this._cacheId=n,this._partId=o}get(t){if(this._lazyPt[t]===void 0){const i=this._elements[t];if(i===void 0)return;const r=this._hasZ,s=this._hasM;let n=null;n=r&&!s?new nt(i[0],i[1],i[2],void 0,this._spRef):s&&!r?new nt(i[0],i[1],void 0,i[2],this._spRef):r&&s?new nt(i[0],i[1],i[2],i[3],this._spRef):new nt(i[0],i[1],this._spRef),n.cache._arcadeCacheId=this._cacheId.toString()+"-"+this._partId.toString()+"-"+t.toString(),this._lazyPt[t]=n}return this._lazyPt[t]}equalityTest(t){return t===this||t!==null&&t instanceof _w&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()+"-"+this._partId.toString()}}class $W extends kf{constructor(t,i,r,s,n){super(t),this._lazyPath=[],this._hasZ=!1,this._hasM=!1,this._hasZ=r,this._hasM=s,this._spRef=i,this._cacheId=n}get(t){if(this._lazyPath[t]===void 0){const i=this._elements[t];if(i===void 0)return;this._lazyPath[t]=new _w(i,this._spRef,this._hasZ,this._hasM,this._cacheId,t)}return this._lazyPath[t]}equalityTest(t){return t===this||t!==null&&t instanceof $W&&t.getUniqueHash()===this.getUniqueHash()}getUniqueHash(){return this._cacheId.toString()}}class bw extends Error{}class j4e extends bw{constructor(t){super(`Invalid DateTime: ${t.toMessage()}`)}}class H4e extends bw{constructor(t){super(`Invalid Interval: ${t.toMessage()}`)}}class q4e extends bw{constructor(t){super(`Invalid Duration: ${t.toMessage()}`)}}class aA extends bw{}class $me extends bw{constructor(t){super(`Invalid unit ${t}`)}}class ah extends bw{}class ey extends bw{constructor(){super("Zone is an abstract class")}}const Ze="numeric",Zd="short",nu="long",X9={year:Ze,month:Ze,day:Ze},Dme={year:Ze,month:Zd,day:Ze},W4e={year:Ze,month:Zd,day:Ze,weekday:Zd},Lme={year:Ze,month:nu,day:Ze},Nme={year:Ze,month:nu,day:Ze,weekday:nu},Fme={hour:Ze,minute:Ze},Ume={hour:Ze,minute:Ze,second:Ze},kme={hour:Ze,minute:Ze,second:Ze,timeZoneName:Zd},zme={hour:Ze,minute:Ze,second:Ze,timeZoneName:nu},Vme={hour:Ze,minute:Ze,hourCycle:"h23"},Bme={hour:Ze,minute:Ze,second:Ze,hourCycle:"h23"},Gme={hour:Ze,minute:Ze,second:Ze,hourCycle:"h23",timeZoneName:Zd},jme={hour:Ze,minute:Ze,second:Ze,hourCycle:"h23",timeZoneName:nu},Hme={year:Ze,month:Ze,day:Ze,hour:Ze,minute:Ze},qme={year:Ze,month:Ze,day:Ze,hour:Ze,minute:Ze,second:Ze},Wme={year:Ze,month:Zd,day:Ze,hour:Ze,minute:Ze},Xme={year:Ze,month:Zd,day:Ze,hour:Ze,minute:Ze,second:Ze},X4e={year:Ze,month:Zd,day:Ze,weekday:Zd,hour:Ze,minute:Ze},Yme={year:Ze,month:nu,day:Ze,hour:Ze,minute:Ze,timeZoneName:Zd},Zme={year:Ze,month:nu,day:Ze,hour:Ze,minute:Ze,second:Ze,timeZoneName:Zd},Qme={year:Ze,month:nu,day:Ze,weekday:nu,hour:Ze,minute:Ze,timeZoneName:nu},Jme={year:Ze,month:nu,day:Ze,weekday:nu,hour:Ze,minute:Ze,second:Ze,timeZoneName:nu};function Hi(e){return typeof e=="undefined"}function vb(e){return typeof e=="number"}function K4(e){return typeof e=="number"&&e%1===0}function Y4e(e){return typeof e=="string"}function Z4e(e){return Object.prototype.toString.call(e)==="[object Date]"}function Kme(){try{return typeof Intl!="undefined"&&!!Intl.RelativeTimeFormat}catch{return!1}}function Q4e(e){return Array.isArray(e)?e:[e]}function VK(e,t,i){if(e.length!==0)return e.reduce((r,s)=>{const n=[t(s),s];return r&&i(r[0],n[0])===r[0]?r:n},null)[1]}function J4e(e,t){return t.reduce((i,r)=>(i[r]=e[r],i),{})}function YS(e,t){return Object.prototype.hasOwnProperty.call(e,t)}function Qm(e,t,i){return K4(e)&&e>=t&&e<=i}function K4e(e,t){return e-t*Math.floor(e/t)}function En(e,t=2){const i=e<0;let r;return i?r="-"+(""+-e).padStart(t,"0"):r=(""+e).padStart(t,"0"),r}function p0(e){if(!(Hi(e)||e===null||e===""))return parseInt(e,10)}function Yv(e){if(!(Hi(e)||e===null||e===""))return parseFloat(e)}function DW(e){if(!(Hi(e)||e===null||e==="")){const t=parseFloat("0."+e)*1e3;return Math.floor(t)}}function LW(e,t,i=!1){const r=10**t;return(i?Math.trunc:Math.round)(e*r)/r}function DO(e){return e%4===0&&(e%100!==0||e%400===0)}function uR(e){return DO(e)?366:365}function IN(e,t){const i=K4e(t-1,12)+1,r=e+(t-i)/12;return i===2?DO(r)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][i-1]}function NW(e){let t=Date.UTC(e.year,e.month-1,e.day,e.hour,e.minute,e.second,e.millisecond);return e.year<100&&e.year>=0&&(t=new Date(t),t.setUTCFullYear(t.getUTCFullYear()-1900)),+t}function $N(e){const t=(e+Math.floor(e/4)-Math.floor(e/100)+Math.floor(e/400))%7,i=e-1,r=(i+Math.floor(i/4)-Math.floor(i/100)+Math.floor(i/400))%7;return t===4||r===3?53:52}function Y9(e){return e>99?e:e>60?1900+e:2e3+e}function ege(e,t,i,r=null){const s=new Date(e),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};r&&(n.timeZone=r);const o=F({timeZoneName:t},n),a=new Intl.DateTimeFormat(i,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function e5(e,t){let i=parseInt(e,10);Number.isNaN(i)&&(i=0);const r=parseInt(t,10)||0,s=i<0||Object.is(i,-0)?-r:r;return i*60+s}function tge(e){const t=Number(e);if(typeof e=="boolean"||e===""||Number.isNaN(t))throw new ah(`Invalid unit value ${e}`);return t}function DN(e,t){const i={};for(const r in e)if(YS(e,r)){const s=e[r];if(s==null)continue;i[t(r)]=tge(s)}return i}function hR(e,t){const i=Math.trunc(Math.abs(e/60)),r=Math.trunc(Math.abs(e%60)),s=e>=0?"+":"-";switch(t){case"short":return`${s}${En(i,2)}:${En(r,2)}`;case"narrow":return`${s}${i}${r>0?`:${r}`:""}`;case"techie":return`${s}${En(i,2)}${En(r,2)}`;default:throw new RangeError(`Value format ${t} is out of range for property format`)}}function t5(e){return J4e(e,["hour","minute","second","millisecond"])}const ige=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/,e5e=["January","February","March","April","May","June","July","August","September","October","November","December"],rge=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],t5e=["J","F","M","A","M","J","J","A","S","O","N","D"];function sge(e){switch(e){case"narrow":return[...t5e];case"short":return[...rge];case"long":return[...e5e];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const nge=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],oge=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],i5e=["M","T","W","T","F","S","S"];function age(e){switch(e){case"narrow":return[...i5e];case"short":return[...oge];case"long":return[...nge];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const lge=["AM","PM"],r5e=["Before Christ","Anno Domini"],s5e=["BC","AD"],n5e=["B","A"];function cge(e){switch(e){case"narrow":return[...n5e];case"short":return[...s5e];case"long":return[...r5e];default:return null}}function o5e(e){return lge[e.hour<12?0:1]}function a5e(e,t){return age(t)[e.weekday-1]}function l5e(e,t){return sge(t)[e.month-1]}function c5e(e,t){return cge(t)[e.year<0?0:1]}function u5e(e,t,i="always",r=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(e)===-1;if(i==="auto"&&n){const p=e==="days";switch(t){case 1:return p?"tomorrow":`next ${s[e][0]}`;case-1:return p?"yesterday":`last ${s[e][0]}`;case 0:return p?"today":`this ${s[e][0]}`}}const o=Object.is(t,-0)||t<0,a=Math.abs(t),l=a===1,c=s[e],h=r?l?c[1]:c[2]||c[1]:l?s[e][0]:e;return o?`${a} ${h} ago`:`in ${a} ${h}`}function BK(e,t){let i="";for(const r of e)r.literal?i+=r.val:i+=t(r.val);return i}const h5e={D:X9,DD:Dme,DDD:Lme,DDDD:Nme,t:Fme,tt:Ume,ttt:kme,tttt:zme,T:Vme,TT:Bme,TTT:Gme,TTTT:jme,f:Hme,ff:Wme,fff:Yme,ffff:Qme,F:qme,FF:Xme,FFF:Zme,FFFF:Jme};class Xl{static create(t,i={}){return new Xl(t,i)}static parseFormat(t){let i=null,r="",s=!1;const n=[];for(let o=0;o<t.length;o++){const a=t.charAt(o);a==="'"?(r.length>0&&n.push({literal:s,val:r}),i=null,r="",s=!s):s||a===i?r+=a:(r.length>0&&n.push({literal:!1,val:r}),r=a,i=a)}return r.length>0&&n.push({literal:s,val:r}),n}static macroTokenToFormatOpts(t){return h5e[t]}constructor(t,i){this.opts=i,this.loc=t,this.systemLoc=null}formatWithSystemDefault(t,i){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(t,F(F({},this.opts),i)).format()}formatDateTime(t,i={}){return this.loc.dtFormatter(t,F(F({},this.opts),i)).format()}formatDateTimeParts(t,i={}){return this.loc.dtFormatter(t,F(F({},this.opts),i)).formatToParts()}resolvedOptions(t,i={}){return this.loc.dtFormatter(t,F(F({},this.opts),i)).resolvedOptions()}num(t,i=0){if(this.opts.forceSimple)return En(t,i);const r=F({},this.opts);return i>0&&(r.padTo=i),this.loc.numberFormatter(r).format(t)}formatDateTimeFromString(t,i){const r=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(m,y)=>this.loc.extract(t,m,y),o=m=>t.isOffsetFixed&&t.offset===0&&m.allowZ?"Z":t.isValid?t.zone.formatOffset(t.ts,m.format):"",a=()=>r?o5e(t):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(m,y)=>r?l5e(t,m):n(y?{month:m}:{month:m,day:"numeric"},"month"),c=(m,y)=>r?a5e(t,m):n(y?{weekday:m}:{weekday:m,month:"long",day:"numeric"},"weekday"),h=m=>{const y=Xl.macroTokenToFormatOpts(m);return y?this.formatWithSystemDefault(t,y):m},p=m=>r?c5e(t,m):n({era:m},"era"),f=m=>{switch(m){case"S":return this.num(t.millisecond);case"u":case"SSS":return this.num(t.millisecond,3);case"s":return this.num(t.second);case"ss":return this.num(t.second,2);case"uu":return this.num(Math.floor(t.millisecond/10),2);case"uuu":return this.num(Math.floor(t.millisecond/100));case"m":return this.num(t.minute);case"mm":return this.num(t.minute,2);case"h":return this.num(t.hour%12===0?12:t.hour%12);case"hh":return this.num(t.hour%12===0?12:t.hour%12,2);case"H":return this.num(t.hour);case"HH":return this.num(t.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return t.zone.offsetName(t.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return t.zone.offsetName(t.ts,{format:"long",locale:this.loc.locale});case"z":return t.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(t.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(t.day,2);case"c":return this.num(t.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(t.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(t.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(t.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(t.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(t.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(t.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(t.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(t.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(t.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(t.weekYear.toString().slice(-2),2);case"kkkk":return this.num(t.weekYear,4);case"W":return this.num(t.weekNumber);case"WW":return this.num(t.weekNumber,2);case"o":return this.num(t.ordinal);case"ooo":return this.num(t.ordinal,3);case"q":return this.num(t.quarter);case"qq":return this.num(t.quarter,2);case"X":return this.num(Math.floor(t.ts/1e3));case"x":return this.num(t.ts);default:return h(m)}};return BK(Xl.parseFormat(i),f)}formatDurationFromString(t,i){const r=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=r(c);return h?this.num(l.get(h),c.length):c},n=Xl.parseFormat(i),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=t.shiftTo(...o.map(r).filter(l=>l));return BK(n,s(a))}}class Nd{constructor(t,i){this.reason=t,this.explanation=i}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}class LO{get type(){throw new ey}get name(){throw new ey}get ianaName(){return this.name}get isUniversal(){throw new ey}offsetName(t,i){throw new ey}formatOffset(t,i){throw new ey}offset(t){throw new ey}equals(t){throw new ey}get isValid(){throw new ey}}let Bk=null;class FW extends LO{static get instance(){return Bk===null&&(Bk=new FW),Bk}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return ege(t,i,r)}formatOffset(t,i){return hR(this.offset(t),i)}offset(t){return-new Date(t).getTimezoneOffset()}equals(t){return t.type==="system"}get isValid(){return!0}}let lD={};function d5e(e){return lD[e]||(lD[e]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:e,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"})),lD[e]}const p5e={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function f5e(e,t){const i=e.format(t).replace(/\u200E/g,""),r=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(i),[,s,n,o,a,l,c,h]=r;return[o,s,n,a,l,c,h]}function m5e(e,t){const i=e.formatToParts(t),r=[];for(let s=0;s<i.length;s++){const{type:n,value:o}=i[s],a=p5e[n];n==="era"?r[a]=o:Hi(a)||(r[a]=parseInt(o,10))}return r}let nP={};class xg extends LO{static create(t){return nP[t]||(nP[t]=new xg(t)),nP[t]}static resetCache(){nP={},lD={}}static isValidSpecifier(t){return this.isValidZone(t)}static isValidZone(t){if(!t)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:t}).format(),!0}catch{return!1}}constructor(t){super();this.zoneName=t,this.valid=xg.isValidZone(t)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(t,{format:i,locale:r}){return ege(t,i,r,this.name)}formatOffset(t,i){return hR(this.offset(t),i)}offset(t){const i=new Date(t);if(isNaN(i))return NaN;const r=d5e(this.name);let[s,n,o,a,l,c,h]=r.formatToParts?m5e(r,i):f5e(r,i);a==="BC"&&(s=-Math.abs(s)+1);const f=NW({year:s,month:n,day:o,hour:l===24?0:l,minute:c,second:h,millisecond:0});let m=+i;const y=m%1e3;return m-=y>=0?y:1e3+y,(f-m)/(60*1e3)}equals(t){return t.type==="iana"&&t.name===this.name}get isValid(){return this.valid}}let Gk=null;class il extends LO{static get utcInstance(){return Gk===null&&(Gk=new il(0)),Gk}static instance(t){return t===0?il.utcInstance:new il(t)}static parseSpecifier(t){if(t){const i=t.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(i)return new il(e5(i[1],i[2]))}return null}constructor(t){super();this.fixed=t}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${hR(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${hR(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(t,i){return hR(this.fixed,i)}get isUniversal(){return!0}offset(){return this.fixed}equals(t){return t.type==="fixed"&&t.fixed===this.fixed}get isValid(){return!0}}class g5e extends LO{constructor(t){super();this.zoneName=t}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function T0(e,t){if(Hi(e)||e===null)return t;if(e instanceof LO)return e;if(Y4e(e)){const i=e.toLowerCase();return i==="local"||i==="system"?t:i==="utc"||i==="gmt"?il.utcInstance:il.parseSpecifier(i)||xg.create(e)}else return vb(e)?il.instance(e):typeof e=="object"&&e.offset&&typeof e.offset=="number"?e:new g5e(e)}let GK=()=>Date.now(),jK="system",HK=null,qK=null,WK=null,XK;class jn{static get now(){return GK}static set now(t){GK=t}static set defaultZone(t){jK=t}static get defaultZone(){return T0(jK,FW.instance)}static get defaultLocale(){return HK}static set defaultLocale(t){HK=t}static get defaultNumberingSystem(){return qK}static set defaultNumberingSystem(t){qK=t}static get defaultOutputCalendar(){return WK}static set defaultOutputCalendar(t){WK=t}static get throwOnInvalid(){return XK}static set throwOnInvalid(t){XK=t}static resetCaches(){As.resetCache(),xg.resetCache()}}let YK={};function y5e(e,t={}){const i=JSON.stringify([e,t]);let r=YK[i];return r||(r=new Intl.ListFormat(e,t),YK[i]=r),r}let Z9={};function Q9(e,t={}){const i=JSON.stringify([e,t]);let r=Z9[i];return r||(r=new Intl.DateTimeFormat(e,t),Z9[i]=r),r}let J9={};function v5e(e,t={}){const i=JSON.stringify([e,t]);let r=J9[i];return r||(r=new Intl.NumberFormat(e,t),J9[i]=r),r}let K9={};function _5e(e,t={}){const o=t,{base:i}=o,r=C3(o,["base"]),s=JSON.stringify([e,r]);let n=K9[s];return n||(n=new Intl.RelativeTimeFormat(e,t),K9[s]=n),n}let lA=null;function b5e(){return lA||(lA=new Intl.DateTimeFormat().resolvedOptions().locale,lA)}function w5e(e){const t=e.indexOf("-u-");if(t===-1)return[e];{let i;const r=e.substring(0,t);try{i=Q9(e).resolvedOptions()}catch{i=Q9(r).resolvedOptions()}const{numberingSystem:s,calendar:n}=i;return[r,s,n]}}function x5e(e,t,i){return(i||t)&&(e+="-u",i&&(e+=`-ca-${i}`),t&&(e+=`-nu-${t}`)),e}function T5e(e){const t=[];for(let i=1;i<=12;i++){const r=Qt.utc(2016,i,1);t.push(e(r))}return t}function S5e(e){const t=[];for(let i=1;i<=7;i++){const r=Qt.utc(2016,11,13+i);t.push(e(r))}return t}function oP(e,t,i,r,s){const n=e.listingMode(i);return n==="error"?null:n==="en"?r(t):s(t)}function E5e(e){return e.numberingSystem&&e.numberingSystem!=="latn"?!1:e.numberingSystem==="latn"||!e.locale||e.locale.startsWith("en")||new Intl.DateTimeFormat(e.intl).resolvedOptions().numberingSystem==="latn"}class C5e{constructor(t,i,r){this.padTo=r.padTo||0,this.floor=r.floor||!1;const a=r,{padTo:s,floor:n}=a,o=C3(a,["padTo","floor"]);if(!i||Object.keys(o).length>0){const l=F({useGrouping:!1},r);r.padTo>0&&(l.minimumIntegerDigits=r.padTo),this.inf=v5e(t,l)}}format(t){if(this.inf){const i=this.floor?Math.floor(t):t;return this.inf.format(i)}else{const i=this.floor?Math.floor(t):LW(t,3);return En(i,this.padTo)}}}class A5e{constructor(t,i,r){this.opts=r;let s;if(t.zone.isUniversal){const o=-1*(t.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;t.offset!==0&&xg.create(a).valid?(s=a,this.dt=t):(s="UTC",r.timeZoneName?this.dt=t:this.dt=t.offset===0?t:Qt.fromMillis(t.ts+t.offset*60*1e3))}else t.zone.type==="system"?this.dt=t:(this.dt=t,s=t.zone.name);const n=F({},this.opts);s&&(n.timeZone=s),this.dtf=Q9(i,n)}format(){return this.dtf.format(this.dt.toJSDate())}formatToParts(){return this.dtf.formatToParts(this.dt.toJSDate())}resolvedOptions(){return this.dtf.resolvedOptions()}}class R5e{constructor(t,i,r){this.opts=F({style:"long"},r),!i&&Kme()&&(this.rtf=_5e(t,r))}format(t,i){return this.rtf?this.rtf.format(t,i):u5e(i,t,this.opts.numeric,this.opts.style!=="long")}formatToParts(t,i){return this.rtf?this.rtf.formatToParts(t,i):[]}}class As{static fromOpts(t){return As.create(t.locale,t.numberingSystem,t.outputCalendar,t.defaultToEN)}static create(t,i,r,s=!1){const n=t||jn.defaultLocale,o=n||(s?"en-US":b5e()),a=i||jn.defaultNumberingSystem,l=r||jn.defaultOutputCalendar;return new As(o,a,l,n)}static resetCache(){lA=null,Z9={},J9={},K9={}}static fromObject({locale:t,numberingSystem:i,outputCalendar:r}={}){return As.create(t,i,r)}constructor(t,i,r,s){const[n,o,a]=w5e(t);this.locale=n,this.numberingSystem=i||o||null,this.outputCalendar=r||a||null,this.intl=x5e(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=E5e(this)),this.fastNumbersCached}listingMode(){const t=this.isEnglish(),i=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return t&&i?"en":"intl"}clone(t){return!t||Object.getOwnPropertyNames(t).length===0?this:As.create(t.locale||this.specifiedLocale,t.numberingSystem||this.numberingSystem,t.outputCalendar||this.outputCalendar,t.defaultToEN||!1)}redefaultToEN(t={}){return this.clone(ve(F({},t),{defaultToEN:!0}))}redefaultToSystem(t={}){return this.clone(ve(F({},t),{defaultToEN:!1}))}months(t,i=!1,r=!0){return oP(this,t,r,sge,()=>{const s=i?{month:t,day:"numeric"}:{month:t},n=i?"format":"standalone";return this.monthsCache[n][t]||(this.monthsCache[n][t]=T5e(o=>this.extract(o,s,"month"))),this.monthsCache[n][t]})}weekdays(t,i=!1,r=!0){return oP(this,t,r,age,()=>{const s=i?{weekday:t,year:"numeric",month:"long",day:"numeric"}:{weekday:t},n=i?"format":"standalone";return this.weekdaysCache[n][t]||(this.weekdaysCache[n][t]=S5e(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][t]})}meridiems(t=!0){return oP(this,void 0,t,()=>lge,()=>{if(!this.meridiemCache){const i={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[Qt.utc(2016,11,13,9),Qt.utc(2016,11,13,19)].map(r=>this.extract(r,i,"dayperiod"))}return this.meridiemCache})}eras(t,i=!0){return oP(this,t,i,cge,()=>{const r={era:t};return this.eraCache[t]||(this.eraCache[t]=[Qt.utc(-40,1,1),Qt.utc(2017,1,1)].map(s=>this.extract(s,r,"era"))),this.eraCache[t]})}extract(t,i,r){const s=this.dtFormatter(t,i),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===r);return o?o.value:null}numberFormatter(t={}){return new C5e(this.intl,t.forceSimple||this.fastNumbers,t)}dtFormatter(t,i={}){return new A5e(t,this.intl,i)}relFormatter(t={}){return new R5e(this.intl,this.isEnglish(),t)}listFormatter(t={}){return y5e(this.intl,t)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(t){return this.locale===t.locale&&this.numberingSystem===t.numberingSystem&&this.outputCalendar===t.outputCalendar}}function Q2(...e){const t=e.reduce((i,r)=>i+r.source,"");return RegExp(`^${t}$`)}function J2(...e){return t=>e.reduce(([i,r,s],n)=>{const[o,a,l]=n(t,s);return[F(F({},i),o),a||r,l]},[{},null,1]).slice(0,2)}function K2(e,...t){if(e==null)return[null,null];for(const[i,r]of t){const s=i.exec(e);if(s)return r(s)}return[null,null]}function uge(...e){return(t,i)=>{const r={};let s;for(s=0;s<e.length;s++)r[e[s]]=p0(t[i+s]);return[r,null,i+s]}}const hge=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,M5e=`(?:${hge.source}?(?:\\[(${ige.source})\\])?)?`,UW=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,dge=RegExp(`${UW.source}${M5e}`),kW=RegExp(`(?:T${dge.source})?`),O5e=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,P5e=/(\d{4})-?W(\d\d)(?:-?(\d))?/,I5e=/(\d{4})-?(\d{3})/,$5e=uge("weekYear","weekNumber","weekDay"),D5e=uge("year","ordinal"),L5e=/(\d{4})-(\d\d)-(\d\d)/,pge=RegExp(`${UW.source} ?(?:${hge.source}|(${ige.source}))?`),N5e=RegExp(`(?: ${pge.source})?`);function nS(e,t,i){const r=e[t];return Hi(r)?i:p0(r)}function F5e(e,t){return[{year:nS(e,t),month:nS(e,t+1,1),day:nS(e,t+2,1)},null,t+3]}function eE(e,t){return[{hours:nS(e,t,0),minutes:nS(e,t+1,0),seconds:nS(e,t+2,0),milliseconds:DW(e[t+3])},null,t+4]}function NO(e,t){const i=!e[t]&&!e[t+1],r=e5(e[t+1],e[t+2]),s=i?null:il.instance(r);return[{},s,t+3]}function FO(e,t){const i=e[t]?xg.create(e[t]):null;return[{},i,t+1]}const U5e=RegExp(`^T?${UW.source}$`),k5e=/^-?P(?:(?:(-?\d{1,9}(?:\.\d{1,9})?)Y)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,9}(?:\.\d{1,9})?)W)?(?:(-?\d{1,9}(?:\.\d{1,9})?)D)?(?:T(?:(-?\d{1,9}(?:\.\d{1,9})?)H)?(?:(-?\d{1,9}(?:\.\d{1,9})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,9}))?S)?)?)$/;function z5e(e){const[t,i,r,s,n,o,a,l,c]=e,h=t[0]==="-",p=l&&l[0]==="-",f=(m,y=!1)=>m!==void 0&&(y||m&&h)?-m:m;return[{years:f(Yv(i)),months:f(Yv(r)),weeks:f(Yv(s)),days:f(Yv(n)),hours:f(Yv(o)),minutes:f(Yv(a)),seconds:f(Yv(l),l==="-0"),milliseconds:f(DW(c),p)}]}const V5e={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function zW(e,t,i,r,s,n,o){const a={year:t.length===2?Y9(p0(t)):p0(t),month:rge.indexOf(i)+1,day:p0(r),hour:p0(s),minute:p0(n)};return o&&(a.second=p0(o)),e&&(a.weekday=e.length>3?nge.indexOf(e)+1:oge.indexOf(e)+1),a}const B5e=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function G5e(e){const[,t,i,r,s,n,o,a,l,c,h,p]=e,f=zW(t,s,r,i,n,o,a);let m;return l?m=V5e[l]:c?m=0:m=e5(h,p),[f,new il(m)]}function j5e(e){return e.replace(/\([^)]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const H5e=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,q5e=/^(Monday|Tuesday|Wedsday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,W5e=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function ZK(e){const[,t,i,r,s,n,o,a]=e;return[zW(t,s,r,i,n,o,a),il.utcInstance]}function X5e(e){const[,t,i,r,s,n,o,a]=e;return[zW(t,a,i,r,s,n,o),il.utcInstance]}const Y5e=Q2(O5e,kW),Z5e=Q2(P5e,kW),Q5e=Q2(I5e,kW),J5e=Q2(dge),fge=J2(F5e,eE,NO,FO),K5e=J2($5e,eE,NO,FO),eUe=J2(D5e,eE,NO,FO),tUe=J2(eE,NO,FO);function iUe(e){return K2(e,[Y5e,fge],[Z5e,K5e],[Q5e,eUe],[J5e,tUe])}function rUe(e){return K2(j5e(e),[B5e,G5e])}function sUe(e){return K2(e,[H5e,ZK],[q5e,ZK],[W5e,X5e])}function nUe(e){return K2(e,[k5e,z5e])}const oUe=J2(eE);function aUe(e){return K2(e,[U5e,oUe])}const lUe=Q2(L5e,N5e),cUe=Q2(pge),uUe=J2(eE,NO,FO);function hUe(e){return K2(e,[lUe,fge],[cUe,uUe])}const dUe="Invalid Duration",mge={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},pUe=F({years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3}},mge),Su=146097/400,Pw=146097/4800,fUe=F({years:{quarters:4,months:12,weeks:Su/7,days:Su,hours:Su*24,minutes:Su*24*60,seconds:Su*24*60*60,milliseconds:Su*24*60*60*1e3},quarters:{months:3,weeks:Su/28,days:Su/4,hours:Su*24/4,minutes:Su*24*60/4,seconds:Su*24*60*60/4,milliseconds:Su*24*60*60*1e3/4},months:{weeks:Pw/7,days:Pw,hours:Pw*24,minutes:Pw*24*60,seconds:Pw*24*60*60,milliseconds:Pw*24*60*60*1e3}},mge),Y_=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],mUe=Y_.slice(0).reverse();function Zv(e,t,i=!1){const r={values:i?t.values:F(F({},e.values),t.values||{}),loc:e.loc.clone(t.loc),conversionAccuracy:t.conversionAccuracy||e.conversionAccuracy};return new er(r)}function gUe(e){return e<0?Math.floor(e):Math.ceil(e)}function gge(e,t,i,r,s){const n=e[s][i],o=t[i]/n,a=Math.sign(o)===Math.sign(r[s]),l=!a&&r[s]!==0&&Math.abs(o)<=1?gUe(o):Math.trunc(o);r[s]+=l,t[i]-=l*n}function yUe(e,t){mUe.reduce((i,r)=>Hi(t[r])?i:(i&&gge(e,t,i,t,r),r),null)}class er{constructor(t){const i=t.conversionAccuracy==="longterm"||!1;this.values=t.values,this.loc=t.loc||As.create(),this.conversionAccuracy=i?"longterm":"casual",this.invalid=t.invalid||null,this.matrix=i?fUe:pUe,this.isLuxonDuration=!0}static fromMillis(t,i){return er.fromObject({milliseconds:t},i)}static fromObject(t,i={}){if(t==null||typeof t!="object")throw new ah(`Duration.fromObject: argument expected to be an object, got ${t===null?"null":typeof t}`);return new er({values:DN(t,er.normalizeUnit),loc:As.fromObject(i),conversionAccuracy:i.conversionAccuracy})}static fromDurationLike(t){if(vb(t))return er.fromMillis(t);if(er.isDuration(t))return t;if(typeof t=="object")return er.fromObject(t);throw new ah(`Unknown duration argument ${t} of type ${typeof t}`)}static fromISO(t,i){const[r]=nUe(t);return r?er.fromObject(r,i):er.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static fromISOTime(t,i){const[r]=aUe(t);return r?er.fromObject(r,i):er.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static invalid(t,i=null){if(!t)throw new ah("need to specify a reason the Duration is invalid");const r=t instanceof Nd?t:new Nd(t,i);if(jn.throwOnInvalid)throw new q4e(r);return new er({invalid:r})}static normalizeUnit(t){const i={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[t&&t.toLowerCase()];if(!i)throw new $me(t);return i}static isDuration(t){return t&&t.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(t,i={}){const r=ve(F({},i),{floor:i.round!==!1&&i.floor!==!1});return this.isValid?Xl.create(this.loc,r).formatDurationFromString(this,t):dUe}toHuman(t={}){const i=Y_.map(r=>{const s=this.values[r];return Hi(s)?null:this.loc.numberFormatter(ve(F({style:"unit",unitDisplay:"long"},t),{unit:r.slice(0,-1)})).format(s)}).filter(r=>r);return this.loc.listFormatter(F({type:"conjunction",style:t.listStyle||"narrow"},t)).format(i)}toObject(){return this.isValid?F({},this.values):{}}toISO(){if(!this.isValid)return null;let t="P";return this.years!==0&&(t+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(t+=this.months+this.quarters*3+"M"),this.weeks!==0&&(t+=this.weeks+"W"),this.days!==0&&(t+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(t+="T"),this.hours!==0&&(t+=this.hours+"H"),this.minutes!==0&&(t+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(t+=LW(this.seconds+this.milliseconds/1e3,3)+"S"),t==="P"&&(t+="T0S"),t}toISOTime(t={}){if(!this.isValid)return null;const i=this.toMillis();if(i<0||i>=864e5)return null;t=F({suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended"},t);const r=this.shiftTo("hours","minutes","seconds","milliseconds");let s=t.format==="basic"?"hhmm":"hh:mm";(!t.suppressSeconds||r.seconds!==0||r.milliseconds!==0)&&(s+=t.format==="basic"?"ss":":ss",(!t.suppressMilliseconds||r.milliseconds!==0)&&(s+=".SSS"));let n=r.toFormat(s);return t.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(t){if(!this.isValid)return this;const i=er.fromDurationLike(t),r={};for(const s of Y_)(YS(i.values,s)||YS(this.values,s))&&(r[s]=i.get(s)+this.get(s));return Zv(this,{values:r},!0)}minus(t){if(!this.isValid)return this;const i=er.fromDurationLike(t);return this.plus(i.negate())}mapUnits(t){if(!this.isValid)return this;const i={};for(const r of Object.keys(this.values))i[r]=tge(t(this.values[r],r));return Zv(this,{values:i},!0)}get(t){return this[er.normalizeUnit(t)]}set(t){if(!this.isValid)return this;const i=F(F({},this.values),DN(t,er.normalizeUnit));return Zv(this,{values:i})}reconfigure({locale:t,numberingSystem:i,conversionAccuracy:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i}),n={loc:s};return r&&(n.conversionAccuracy=r),Zv(this,n)}as(t){return this.isValid?this.shiftTo(t).get(t):NaN}normalize(){if(!this.isValid)return this;const t=this.toObject();return yUe(this.matrix,t),Zv(this,{values:t},!0)}shiftTo(...t){if(!this.isValid)return this;if(t.length===0)return this;t=t.map(o=>er.normalizeUnit(o));const i={},r={},s=this.toObject();let n;for(const o of Y_)if(t.indexOf(o)>=0){n=o;let a=0;for(const c in r)a+=this.matrix[c][o]*r[c],r[c]=0;vb(s[o])&&(a+=s[o]);const l=Math.trunc(a);i[o]=l,r[o]=(a*1e3-l*1e3)/1e3;for(const c in s)Y_.indexOf(c)>Y_.indexOf(o)&&gge(this.matrix,s,c,i,o)}else vb(s[o])&&(r[o]=s[o]);for(const o in r)r[o]!==0&&(i[n]+=o===n?r[o]:r[o]/this.matrix[n][o]);return Zv(this,{values:i},!0).normalize()}negate(){if(!this.isValid)return this;const t={};for(const i of Object.keys(this.values))t[i]=this.values[i]===0?0:-this.values[i];return Zv(this,{values:t},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(t){if(!this.isValid||!t.isValid||!this.loc.equals(t.loc))return!1;function i(r,s){return r===void 0||r===0?s===void 0||s===0:r===s}for(const r of Y_)if(!i(this.values[r],t.values[r]))return!1;return!0}}const ME="Invalid Interval";function vUe(e,t){return!e||!e.isValid?Vs.invalid("missing or invalid start"):!t||!t.isValid?Vs.invalid("missing or invalid end"):t<e?Vs.invalid("end before start",`The end of an interval must be after its start, but you had start=${e.toISO()} and end=${t.toISO()}`):null}class Vs{constructor(t){this.s=t.start,this.e=t.end,this.invalid=t.invalid||null,this.isLuxonInterval=!0}static invalid(t,i=null){if(!t)throw new ah("need to specify a reason the Interval is invalid");const r=t instanceof Nd?t:new Nd(t,i);if(jn.throwOnInvalid)throw new H4e(r);return new Vs({invalid:r})}static fromDateTimes(t,i){const r=IE(t),s=IE(i),n=vUe(r,s);return n==null?new Vs({start:r,end:s}):n}static after(t,i){const r=er.fromDurationLike(i),s=IE(t);return Vs.fromDateTimes(s,s.plus(r))}static before(t,i){const r=er.fromDurationLike(i),s=IE(t);return Vs.fromDateTimes(s.minus(r),s)}static fromISO(t,i){const[r,s]=(t||"").split("/",2);if(r&&s){let n,o;try{n=Qt.fromISO(r,i),o=n.isValid}catch{o=!1}let a,l;try{a=Qt.fromISO(s,i),l=a.isValid}catch{l=!1}if(o&&l)return Vs.fromDateTimes(n,a);if(o){const c=er.fromISO(s,i);if(c.isValid)return Vs.after(n,c)}else if(l){const c=er.fromISO(r,i);if(c.isValid)return Vs.before(a,c)}}return Vs.invalid("unparsable",`the input "${t}" can't be parsed as ISO 8601`)}static isInterval(t){return t&&t.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(t="milliseconds"){return this.isValid?this.toDuration(t).get(t):NaN}count(t="milliseconds"){if(!this.isValid)return NaN;const i=this.start.startOf(t),r=this.end.startOf(t);return Math.floor(r.diff(i,t).get(t))+1}hasSame(t){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,t):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(t){return this.isValid?this.s>t:!1}isBefore(t){return this.isValid?this.e<=t:!1}contains(t){return this.isValid?this.s<=t&&this.e>t:!1}set({start:t,end:i}={}){return this.isValid?Vs.fromDateTimes(t||this.s,i||this.e):this}splitAt(...t){if(!this.isValid)return[];const i=t.map(IE).filter(o=>this.contains(o)).sort(),r=[];let{s}=this,n=0;for(;s<this.e;){const o=i[n]||this.e,a=+o>+this.e?this.e:o;r.push(Vs.fromDateTimes(s,a)),s=a,n+=1}return r}splitBy(t){const i=er.fromDurationLike(t);if(!this.isValid||!i.isValid||i.as("milliseconds")===0)return[];let{s:r}=this,s=1,n;const o=[];for(;r<this.e;){const a=this.start.plus(i.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(Vs.fromDateTimes(r,n)),r=n,s+=1}return o}divideEqually(t){return this.isValid?this.splitBy(this.length()/t).slice(0,t):[]}overlaps(t){return this.e>t.s&&this.s<t.e}abutsStart(t){return this.isValid?+this.e==+t.s:!1}abutsEnd(t){return this.isValid?+t.e==+this.s:!1}engulfs(t){return this.isValid?this.s<=t.s&&this.e>=t.e:!1}equals(t){return!this.isValid||!t.isValid?!1:this.s.equals(t.s)&&this.e.equals(t.e)}intersection(t){if(!this.isValid)return this;const i=this.s>t.s?this.s:t.s,r=this.e<t.e?this.e:t.e;return i>=r?null:Vs.fromDateTimes(i,r)}union(t){if(!this.isValid)return this;const i=this.s<t.s?this.s:t.s,r=this.e>t.e?this.e:t.e;return Vs.fromDateTimes(i,r)}static merge(t){const[i,r]=t.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return r&&i.push(r),i}static xor(t){let i=null,r=0;const s=[],n=t.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)r+=l.type==="s"?1:-1,r===1?i=l.time:(i&&+i!=+l.time&&s.push(Vs.fromDateTimes(i,l.time)),i=null);return Vs.merge(s)}difference(...t){return Vs.xor([this].concat(t)).map(i=>this.intersection(i)).filter(i=>i&&!i.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} \u2013 ${this.e.toISO()})`:ME}toISO(t){return this.isValid?`${this.s.toISO(t)}/${this.e.toISO(t)}`:ME}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:ME}toISOTime(t){return this.isValid?`${this.s.toISOTime(t)}/${this.e.toISOTime(t)}`:ME}toFormat(t,{separator:i=" \u2013 "}={}){return this.isValid?`${this.s.toFormat(t)}${i}${this.e.toFormat(t)}`:ME}toDuration(t,i){return this.isValid?this.e.diff(this.s,t,i):er.invalid(this.invalidReason)}mapEndpoints(t){return Vs.fromDateTimes(t(this.s),t(this.e))}}class aP{static hasDST(t=jn.defaultZone){const i=Qt.now().setZone(t).set({month:12});return!t.isUniversal&&i.offset!==i.set({month:6}).offset}static isValidIANAZone(t){return xg.isValidZone(t)}static normalizeZone(t){return T0(t,jn.defaultZone)}static months(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||As.create(i,r,n)).months(t)}static monthsFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||As.create(i,r,n)).months(t,!0)}static weekdays(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||As.create(i,r,null)).weekdays(t)}static weekdaysFormat(t="long",{locale:i=null,numberingSystem:r=null,locObj:s=null}={}){return(s||As.create(i,r,null)).weekdays(t,!0)}static meridiems({locale:t=null}={}){return As.create(t).meridiems()}static eras(t="short",{locale:i=null}={}){return As.create(i,null,"gregory").eras(t)}static features(){return{relative:Kme()}}}function QK(e,t){const i=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),r=i(t)-i(e);return Math.floor(er.fromMillis(r).as("days"))}function _Ue(e,t,i){const r=[["years",(a,l)=>l.year-a.year],["quarters",(a,l)=>l.quarter-a.quarter],["months",(a,l)=>l.month-a.month+(l.year-a.year)*12],["weeks",(a,l)=>{const c=QK(a,l);return(c-c%7)/7}],["days",QK]],s={};let n,o;for(const[a,l]of r)if(i.indexOf(a)>=0){n=a;let c=l(e,t);o=e.plus({[a]:c}),o>t?(e=e.plus({[a]:c-1}),c-=1):e=o,s[a]=c}return[e,s,o,n]}function bUe(e,t,i,r){let[s,n,o,a]=_Ue(e,t,i);const l=t-s,c=i.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<t&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=er.fromObject(n,r);return c.length>0?er.fromMillis(l,r).shiftTo(...c).plus(h):h}const VW={arab:"[\u0660-\u0669]",arabext:"[\u06F0-\u06F9]",bali:"[\u1B50-\u1B59]",beng:"[\u09E6-\u09EF]",deva:"[\u0966-\u096F]",fullwide:"[\uFF10-\uFF19]",gujr:"[\u0AE6-\u0AEF]",hanidec:"[\u3007|\u4E00|\u4E8C|\u4E09|\u56DB|\u4E94|\u516D|\u4E03|\u516B|\u4E5D]",khmr:"[\u17E0-\u17E9]",knda:"[\u0CE6-\u0CEF]",laoo:"[\u0ED0-\u0ED9]",limb:"[\u1946-\u194F]",mlym:"[\u0D66-\u0D6F]",mong:"[\u1810-\u1819]",mymr:"[\u1040-\u1049]",orya:"[\u0B66-\u0B6F]",tamldec:"[\u0BE6-\u0BEF]",telu:"[\u0C66-\u0C6F]",thai:"[\u0E50-\u0E59]",tibt:"[\u0F20-\u0F29]",latn:"\\d"},JK={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},wUe=VW.hanidec.replace(/[\[|\]]/g,"").split("");function xUe(e){let t=parseInt(e,10);if(isNaN(t)){t="";for(let i=0;i<e.length;i++){const r=e.charCodeAt(i);if(e[i].search(VW.hanidec)!==-1)t+=wUe.indexOf(e[i]);else for(const s in JK){const[n,o]=JK[s];r>=n&&r<=o&&(t+=r-n)}}return parseInt(t,10)}else return t}function Vh({numberingSystem:e},t=""){return new RegExp(`${VW[e||"latn"]}${t}`)}const TUe="missing Intl.DateTimeFormat.formatToParts support";function dr(e,t=i=>i){return{regex:e,deser:([i])=>t(xUe(i))}}const SUe=String.fromCharCode(160),yge=`[ ${SUe}]`,vge=new RegExp(yge,"g");function EUe(e){return e.replace(/\./g,"\\.?").replace(vge,yge)}function KK(e){return e.replace(/\./g,"").replace(vge," ").toLowerCase()}function Bh(e,t){return e===null?null:{regex:RegExp(e.map(EUe).join("|")),deser:([i])=>e.findIndex(r=>KK(i)===KK(r))+t}}function eee(e,t){return{regex:e,deser:([,i,r])=>e5(i,r),groups:t}}function jk(e){return{regex:e,deser:([t])=>t}}function CUe(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function AUe(e,t){const i=Vh(t),r=Vh(t,"{2}"),s=Vh(t,"{3}"),n=Vh(t,"{4}"),o=Vh(t,"{6}"),a=Vh(t,"{1,2}"),l=Vh(t,"{1,3}"),c=Vh(t,"{1,6}"),h=Vh(t,"{1,9}"),p=Vh(t,"{2,4}"),f=Vh(t,"{4,6}"),m=w=>({regex:RegExp(CUe(w.val)),deser:([b])=>b,literal:!0}),v=(w=>{if(e.literal)return m(w);switch(w.val){case"G":return Bh(t.eras("short",!1),0);case"GG":return Bh(t.eras("long",!1),0);case"y":return dr(c);case"yy":return dr(p,Y9);case"yyyy":return dr(n);case"yyyyy":return dr(f);case"yyyyyy":return dr(o);case"M":return dr(a);case"MM":return dr(r);case"MMM":return Bh(t.months("short",!0,!1),1);case"MMMM":return Bh(t.months("long",!0,!1),1);case"L":return dr(a);case"LL":return dr(r);case"LLL":return Bh(t.months("short",!1,!1),1);case"LLLL":return Bh(t.months("long",!1,!1),1);case"d":return dr(a);case"dd":return dr(r);case"o":return dr(l);case"ooo":return dr(s);case"HH":return dr(r);case"H":return dr(a);case"hh":return dr(r);case"h":return dr(a);case"mm":return dr(r);case"m":return dr(a);case"q":return dr(a);case"qq":return dr(r);case"s":return dr(a);case"ss":return dr(r);case"S":return dr(l);case"SSS":return dr(s);case"u":return jk(h);case"uu":return jk(a);case"uuu":return dr(i);case"a":return Bh(t.meridiems(),0);case"kkkk":return dr(n);case"kk":return dr(p,Y9);case"W":return dr(a);case"WW":return dr(r);case"E":case"c":return dr(i);case"EEE":return Bh(t.weekdays("short",!1,!1),1);case"EEEE":return Bh(t.weekdays("long",!1,!1),1);case"ccc":return Bh(t.weekdays("short",!0,!1),1);case"cccc":return Bh(t.weekdays("long",!0,!1),1);case"Z":case"ZZ":return eee(new RegExp(`([+-]${a.source})(?::(${r.source}))?`),2);case"ZZZ":return eee(new RegExp(`([+-]${a.source})(${r.source})?`),2);case"z":return jk(/[a-z_+-/]{1,256}?/i);default:return m(w)}})(e)||{invalidReason:TUe};return v.token=e,v}const RUe={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"}};function MUe(e,t,i){const{type:r,value:s}=e;if(r==="literal")return{literal:!0,val:s};const n=i[r];let o=RUe[r];if(typeof o=="object"&&(o=o[n]),o)return{literal:!1,val:o}}function OUe(e){return[`^${e.map(i=>i.regex).reduce((i,r)=>`${i}(${r.source})`,"")}$`,e]}function PUe(e,t,i){const r=e.match(t);if(r){const s={};let n=1;for(const o in i)if(YS(i,o)){const a=i[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(r.slice(n,n+l))),n+=l}return[r,s]}else return[r,{}]}function IUe(e){const t=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let i=null,r;return Hi(e.z)||(i=xg.create(e.z)),Hi(e.Z)||(i||(i=new il(e.Z)),r=e.Z),Hi(e.q)||(e.M=(e.q-1)*3+1),Hi(e.h)||(e.h<12&&e.a===1?e.h+=12:e.h===12&&e.a===0&&(e.h=0)),e.G===0&&e.y&&(e.y=-e.y),Hi(e.u)||(e.S=DW(e.u)),[Object.keys(e).reduce((n,o)=>{const a=t(o);return a&&(n[a]=e[o]),n},{}),i,r]}let Hk=null;function $Ue(){return Hk||(Hk=Qt.fromMillis(1555555555555)),Hk}function DUe(e,t){if(e.literal)return e;const i=Xl.macroTokenToFormatOpts(e.val);if(!i)return e;const n=Xl.create(t,i).formatDateTimeParts($Ue()).map(o=>MUe(o,t,i));return n.includes(void 0)?e:n}function LUe(e,t){return Array.prototype.concat(...e.map(i=>DUe(i,t)))}function _ge(e,t,i){const r=LUe(Xl.parseFormat(i),e),s=r.map(o=>AUe(o,e)),n=s.find(o=>o.invalidReason);if(n)return{input:t,tokens:r,invalidReason:n.invalidReason};{const[o,a]=OUe(s),l=RegExp(o,"i"),[c,h]=PUe(t,l,a),[p,f,m]=h?IUe(h):[null,null,void 0];if(YS(h,"a")&&YS(h,"H"))throw new aA("Can't include meridiem when specifying 24-hour format");return{input:t,tokens:r,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:m}}}function NUe(e,t,i){const{result:r,zone:s,specificOffset:n,invalidReason:o}=_ge(e,t,i);return[r,s,n,o]}const bge=[0,31,59,90,120,151,181,212,243,273,304,334],wge=[0,31,60,91,121,152,182,213,244,274,305,335];function yh(e,t){return new Nd("unit out of range",`you specified ${t} (of type ${typeof t}) as a ${e}, which is invalid`)}function xge(e,t,i){const r=new Date(Date.UTC(e,t-1,i));e<100&&e>=0&&r.setUTCFullYear(r.getUTCFullYear()-1900);const s=r.getUTCDay();return s===0?7:s}function Tge(e,t,i){return i+(DO(e)?wge:bge)[t-1]}function Sge(e,t){const i=DO(e)?wge:bge,r=i.findIndex(n=>n<t),s=t-i[r];return{month:r+1,day:s}}function eG(e){const{year:t,month:i,day:r}=e,s=Tge(t,i,r),n=xge(t,i,r);let o=Math.floor((s-n+10)/7),a;return o<1?(a=t-1,o=$N(a)):o>$N(t)?(a=t+1,o=1):a=t,F({weekYear:a,weekNumber:o,weekday:n},t5(e))}function tee(e){const{weekYear:t,weekNumber:i,weekday:r}=e,s=xge(t,1,4),n=uR(t);let o=i*7+r-s-3,a;o<1?(a=t-1,o+=uR(a)):o>n?(a=t+1,o-=uR(t)):a=t;const{month:l,day:c}=Sge(a,o);return F({year:a,month:l,day:c},t5(e))}function qk(e){const{year:t,month:i,day:r}=e,s=Tge(t,i,r);return F({year:t,ordinal:s},t5(e))}function iee(e){const{year:t,ordinal:i}=e,{month:r,day:s}=Sge(t,i);return F({year:t,month:r,day:s},t5(e))}function FUe(e){const t=K4(e.weekYear),i=Qm(e.weekNumber,1,$N(e.weekYear)),r=Qm(e.weekday,1,7);return t?i?r?!1:yh("weekday",e.weekday):yh("week",e.week):yh("weekYear",e.weekYear)}function UUe(e){const t=K4(e.year),i=Qm(e.ordinal,1,uR(e.year));return t?i?!1:yh("ordinal",e.ordinal):yh("year",e.year)}function Ege(e){const t=K4(e.year),i=Qm(e.month,1,12),r=Qm(e.day,1,IN(e.year,e.month));return t?i?r?!1:yh("day",e.day):yh("month",e.month):yh("year",e.year)}function Cge(e){const{hour:t,minute:i,second:r,millisecond:s}=e,n=Qm(t,0,23)||t===24&&i===0&&r===0&&s===0,o=Qm(i,0,59),a=Qm(r,0,59),l=Qm(s,0,999);return n?o?a?l?!1:yh("millisecond",s):yh("second",r):yh("minute",i):yh("hour",t)}const Wk="Invalid DateTime",ree=864e13;function lP(e){return new Nd("unsupported zone",`the zone "${e.name}" is not supported`)}function Xk(e){return e.weekData===null&&(e.weekData=eG(e.c)),e.weekData}function OE(e,t){const i={ts:e.ts,zone:e.zone,c:e.c,o:e.o,loc:e.loc,invalid:e.invalid};return new Qt(ve(F(F({},i),t),{old:i}))}function Age(e,t,i){let r=e-t*60*1e3;const s=i.offset(r);if(t===s)return[r,t];r-=(s-t)*60*1e3;const n=i.offset(r);return s===n?[r,s]:[e-Math.min(s,n)*60*1e3,Math.max(s,n)]}function see(e,t){e+=t*60*1e3;const i=new Date(e);return{year:i.getUTCFullYear(),month:i.getUTCMonth()+1,day:i.getUTCDate(),hour:i.getUTCHours(),minute:i.getUTCMinutes(),second:i.getUTCSeconds(),millisecond:i.getUTCMilliseconds()}}function cD(e,t,i){return Age(NW(e),t,i)}function nee(e,t){const i=e.o,r=e.c.year+Math.trunc(t.years),s=e.c.month+Math.trunc(t.months)+Math.trunc(t.quarters)*3,n=ve(F({},e.c),{year:r,month:s,day:Math.min(e.c.day,IN(r,s))+Math.trunc(t.days)+Math.trunc(t.weeks)*7}),o=er.fromObject({years:t.years-Math.trunc(t.years),quarters:t.quarters-Math.trunc(t.quarters),months:t.months-Math.trunc(t.months),weeks:t.weeks-Math.trunc(t.weeks),days:t.days-Math.trunc(t.days),hours:t.hours,minutes:t.minutes,seconds:t.seconds,milliseconds:t.milliseconds}).as("milliseconds"),a=NW(n);let[l,c]=Age(a,i,e.zone);return o!==0&&(l+=o,c=e.zone.offset(l)),{ts:l,o:c}}function PE(e,t,i,r,s,n){const{setZone:o,zone:a}=i;if(e&&Object.keys(e).length!==0){const l=t||a,c=Qt.fromObject(e,ve(F({},i),{zone:l,specificOffset:n}));return o?c:c.setZone(a)}else return Qt.invalid(new Nd("unparsable",`the input "${s}" can't be parsed as ${r}`))}function cP(e,t,i=!0){return e.isValid?Xl.create(As.create("en-US"),{allowZ:i,forceSimple:!0}).formatDateTimeFromString(e,t):null}function Yk(e,t){const i=e.c.year>9999||e.c.year<0;let r="";return i&&e.c.year>=0&&(r+="+"),r+=En(e.c.year,i?6:4),t?(r+="-",r+=En(e.c.month),r+="-",r+=En(e.c.day)):(r+=En(e.c.month),r+=En(e.c.day)),r}function oee(e,t,i,r,s,n){let o=En(e.c.hour);return t?(o+=":",o+=En(e.c.minute),(e.c.second!==0||!i)&&(o+=":")):o+=En(e.c.minute),(e.c.second!==0||!i)&&(o+=En(e.c.second),(e.c.millisecond!==0||!r)&&(o+=".",o+=En(e.c.millisecond,3))),s&&(e.isOffsetFixed&&e.offset===0&&!n?o+="Z":e.o<0?(o+="-",o+=En(Math.trunc(-e.o/60)),o+=":",o+=En(Math.trunc(-e.o%60))):(o+="+",o+=En(Math.trunc(e.o/60)),o+=":",o+=En(Math.trunc(e.o%60)))),n&&(o+="["+e.zone.ianaName+"]"),o}const Rge={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},kUe={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},zUe={ordinal:1,hour:0,minute:0,second:0,millisecond:0},Mge=["year","month","day","hour","minute","second","millisecond"],VUe=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],BUe=["year","ordinal","hour","minute","second","millisecond"];function aee(e){const t={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[e.toLowerCase()];if(!t)throw new $me(e);return t}function lee(e,t){const i=T0(t.zone,jn.defaultZone),r=As.fromObject(t),s=jn.now();let n,o;if(Hi(e.year))n=s;else{for(const c of Mge)Hi(e[c])&&(e[c]=Rge[c]);const a=Ege(e)||Cge(e);if(a)return Qt.invalid(a);const l=i.offset(s);[n,o]=cD(e,l,i)}return new Qt({ts:n,zone:i,loc:r,o})}function cee(e,t,i){const r=Hi(i.round)?!0:i.round,s=(o,a)=>(o=LW(o,r||i.calendary?0:2,!0),t.loc.clone(i).relFormatter(i).format(o,a)),n=o=>i.calendary?t.hasSame(e,o)?0:t.startOf(o).diff(e.startOf(o),o).get(o):t.diff(e,o).get(o);if(i.unit)return s(n(i.unit),i.unit);for(const o of i.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(e>t?-0:0,i.units[i.units.length-1])}function uee(e){let t={},i;return e.length>0&&typeof e[e.length-1]=="object"?(t=e[e.length-1],i=Array.from(e).slice(0,e.length-1)):i=Array.from(e),[t,i]}class Qt{constructor(t){const i=t.zone||jn.defaultZone;let r=t.invalid||(Number.isNaN(t.ts)?new Nd("invalid input"):null)||(i.isValid?null:lP(i));this.ts=Hi(t.ts)?jn.now():t.ts;let s=null,n=null;if(!r)if(t.old&&t.old.ts===this.ts&&t.old.zone.equals(i))[s,n]=[t.old.c,t.old.o];else{const a=i.offset(this.ts);s=see(this.ts,a),r=Number.isNaN(s.year)?new Nd("invalid input"):null,s=r?null:s,n=r?null:a}this._zone=i,this.loc=t.loc||As.create(),this.invalid=r,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new Qt({})}static local(){const[t,i]=uee(arguments),[r,s,n,o,a,l,c]=i;return lee({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static utc(){const[t,i]=uee(arguments),[r,s,n,o,a,l,c]=i;return t.zone=il.utcInstance,lee({year:r,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},t)}static fromJSDate(t,i={}){const r=Z4e(t)?t.valueOf():NaN;if(Number.isNaN(r))return Qt.invalid("invalid input");const s=T0(i.zone,jn.defaultZone);return s.isValid?new Qt({ts:r,zone:s,loc:As.fromObject(i)}):Qt.invalid(lP(s))}static fromMillis(t,i={}){if(vb(t))return t<-ree||t>ree?Qt.invalid("Timestamp out of range"):new Qt({ts:t,zone:T0(i.zone,jn.defaultZone),loc:As.fromObject(i)});throw new ah(`fromMillis requires a numerical input, but received a ${typeof t} with value ${t}`)}static fromSeconds(t,i={}){if(vb(t))return new Qt({ts:t*1e3,zone:T0(i.zone,jn.defaultZone),loc:As.fromObject(i)});throw new ah("fromSeconds requires a numerical input")}static fromObject(t,i={}){t=t||{};const r=T0(i.zone,jn.defaultZone);if(!r.isValid)return Qt.invalid(lP(r));const s=jn.now(),n=Hi(i.specificOffset)?r.offset(s):i.specificOffset,o=DN(t,aee),a=!Hi(o.ordinal),l=!Hi(o.year),c=!Hi(o.month)||!Hi(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=As.fromObject(i);if((h||a)&&p)throw new aA("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new aA("Can't mix ordinal dates with month/day");const m=p||o.weekday&&!h;let y,v,w=see(s,n);m?(y=VUe,v=kUe,w=eG(w)):a?(y=BUe,v=zUe,w=qk(w)):(y=Mge,v=Rge);let b=!1;for(const N of y){const D=o[N];Hi(D)?b?o[N]=v[N]:o[N]=w[N]:b=!0}const S=m?FUe(o):a?UUe(o):Ege(o),T=S||Cge(o);if(T)return Qt.invalid(T);const E=m?tee(o):a?iee(o):o,[C,M]=cD(E,n,r),I=new Qt({ts:C,zone:r,o:M,loc:f});return o.weekday&&h&&t.weekday!==I.weekday?Qt.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${I.toISO()}`):I}static fromISO(t,i={}){const[r,s]=iUe(t);return PE(r,s,i,"ISO 8601",t)}static fromRFC2822(t,i={}){const[r,s]=rUe(t);return PE(r,s,i,"RFC 2822",t)}static fromHTTP(t,i={}){const[r,s]=sUe(t);return PE(r,s,i,"HTTP",i)}static fromFormat(t,i,r={}){if(Hi(t)||Hi(i))throw new ah("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=r,o=As.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=NUe(o,t,i);return h?Qt.invalid(h):PE(a,l,r,`format ${i}`,t,c)}static fromString(t,i,r={}){return Qt.fromFormat(t,i,r)}static fromSQL(t,i={}){const[r,s]=hUe(t);return PE(r,s,i,"SQL",t)}static invalid(t,i=null){if(!t)throw new ah("need to specify a reason the DateTime is invalid");const r=t instanceof Nd?t:new Nd(t,i);if(jn.throwOnInvalid)throw new j4e(r);return new Qt({invalid:r})}static isDateTime(t){return t&&t.isLuxonDateTime||!1}get(t){return this[t]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?Xk(this).weekYear:NaN}get weekNumber(){return this.isValid?Xk(this).weekNumber:NaN}get weekday(){return this.isValid?Xk(this).weekday:NaN}get ordinal(){return this.isValid?qk(this.c).ordinal:NaN}get monthShort(){return this.isValid?aP.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?aP.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?aP.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?aP.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return DO(this.year)}get daysInMonth(){return IN(this.year,this.month)}get daysInYear(){return this.isValid?uR(this.year):NaN}get weeksInWeekYear(){return this.isValid?$N(this.weekYear):NaN}resolvedLocaleOptions(t={}){const{locale:i,numberingSystem:r,calendar:s}=Xl.create(this.loc.clone(t),t).resolvedOptions(this);return{locale:i,numberingSystem:r,outputCalendar:s}}toUTC(t=0,i={}){return this.setZone(il.instance(t),i)}toLocal(){return this.setZone(jn.defaultZone)}setZone(t,{keepLocalTime:i=!1,keepCalendarTime:r=!1}={}){if(t=T0(t,jn.defaultZone),t.equals(this.zone))return this;if(t.isValid){let s=this.ts;if(i||r){const n=t.offset(this.ts),o=this.toObject();[s]=cD(o,n,t)}return OE(this,{ts:s,zone:t})}else return Qt.invalid(lP(t))}reconfigure({locale:t,numberingSystem:i,outputCalendar:r}={}){const s=this.loc.clone({locale:t,numberingSystem:i,outputCalendar:r});return OE(this,{loc:s})}setLocale(t){return this.reconfigure({locale:t})}set(t){if(!this.isValid)return this;const i=DN(t,aee),r=!Hi(i.weekYear)||!Hi(i.weekNumber)||!Hi(i.weekday),s=!Hi(i.ordinal),n=!Hi(i.year),o=!Hi(i.month)||!Hi(i.day),a=n||o,l=i.weekYear||i.weekNumber;if((a||s)&&l)throw new aA("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new aA("Can't mix ordinal dates with month/day");let c;r?c=tee(F(F({},eG(this.c)),i)):Hi(i.ordinal)?(c=F(F({},this.toObject()),i),Hi(i.day)&&(c.day=Math.min(IN(c.year,c.month),c.day))):c=iee(F(F({},qk(this.c)),i));const[h,p]=cD(c,this.o,this.zone);return OE(this,{ts:h,o:p})}plus(t){if(!this.isValid)return this;const i=er.fromDurationLike(t);return OE(this,nee(this,i))}minus(t){if(!this.isValid)return this;const i=er.fromDurationLike(t).negate();return OE(this,nee(this,i))}startOf(t){if(!this.isValid)return this;const i={},r=er.normalizeUnit(t);switch(r){case"years":i.month=1;case"quarters":case"months":i.day=1;case"weeks":case"days":i.hour=0;case"hours":i.minute=0;case"minutes":i.second=0;case"seconds":i.millisecond=0;break}if(r==="weeks"&&(i.weekday=1),r==="quarters"){const s=Math.ceil(this.month/3);i.month=(s-1)*3+1}return this.set(i)}endOf(t){return this.isValid?this.plus({[t]:1}).startOf(t).minus(1):this}toFormat(t,i={}){return this.isValid?Xl.create(this.loc.redefaultToEN(i)).formatDateTimeFromString(this,t):Wk}toLocaleString(t=X9,i={}){return this.isValid?Xl.create(this.loc.clone(i),t).formatDateTime(this):Wk}toLocaleParts(t={}){return this.isValid?Xl.create(this.loc.clone(t),t).formatDateTimeParts(this):[]}toISO({format:t="extended",suppressSeconds:i=!1,suppressMilliseconds:r=!1,includeOffset:s=!0,extendedZone:n=!1}={}){if(!this.isValid)return null;const o=t==="extended";let a=Yk(this,o);return a+="T",a+=oee(this,o,i,r,s,n),a}toISODate({format:t="extended"}={}){return this.isValid?Yk(this,t==="extended"):null}toISOWeekDate(){return cP(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:t=!1,suppressSeconds:i=!1,includeOffset:r=!0,includePrefix:s=!1,extendedZone:n=!1,format:o="extended"}={}){return this.isValid?(s?"T":"")+oee(this,o==="extended",i,t,r,n):null}toRFC2822(){return cP(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return cP(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?Yk(this,!0):null}toSQLTime({includeOffset:t=!0,includeZone:i=!1,includeOffsetSpace:r=!0}={}){let s="HH:mm:ss.SSS";return(i||t)&&(r&&(s+=" "),i?s+="z":t&&(s+="ZZ")),cP(this,s,!0)}toSQL(t={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(t)}`:null}toString(){return this.isValid?this.toISO():Wk}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(t={}){if(!this.isValid)return{};const i=F({},this.c);return t.includeConfig&&(i.outputCalendar=this.outputCalendar,i.numberingSystem=this.loc.numberingSystem,i.locale=this.loc.locale),i}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(t,i="milliseconds",r={}){if(!this.isValid||!t.isValid)return er.invalid("created by diffing an invalid DateTime");const s=F({locale:this.locale,numberingSystem:this.numberingSystem},r),n=Q4e(i).map(er.normalizeUnit),o=t.valueOf()>this.valueOf(),a=o?this:t,l=o?t:this,c=bUe(a,l,n,s);return o?c.negate():c}diffNow(t="milliseconds",i={}){return this.diff(Qt.now(),t,i)}until(t){return this.isValid?Vs.fromDateTimes(this,t):this}hasSame(t,i){if(!this.isValid)return!1;const r=t.valueOf(),s=this.setZone(t.zone,{keepLocalTime:!0});return s.startOf(i)<=r&&r<=s.endOf(i)}equals(t){return this.isValid&&t.isValid&&this.valueOf()===t.valueOf()&&this.zone.equals(t.zone)&&this.loc.equals(t.loc)}toRelative(t={}){if(!this.isValid)return null;const i=t.base||Qt.fromObject({},{zone:this.zone}),r=t.padding?this<i?-t.padding:t.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=t.unit;return Array.isArray(t.unit)&&(s=t.unit,n=void 0),cee(i,this.plus(r),ve(F({},t),{numeric:"always",units:s,unit:n}))}toRelativeCalendar(t={}){return this.isValid?cee(t.base||Qt.fromObject({},{zone:this.zone}),this,ve(F({},t),{numeric:"auto",units:["years","months","days"],calendary:!0})):null}static min(...t){if(!t.every(Qt.isDateTime))throw new ah("min requires all arguments be DateTimes");return VK(t,i=>i.valueOf(),Math.min)}static max(...t){if(!t.every(Qt.isDateTime))throw new ah("max requires all arguments be DateTimes");return VK(t,i=>i.valueOf(),Math.max)}static fromFormatExplain(t,i,r={}){const{locale:s=null,numberingSystem:n=null}=r,o=As.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return _ge(o,t,i)}static fromStringExplain(t,i,r={}){return Qt.fromFormatExplain(t,i,r)}static get DATE_SHORT(){return X9}static get DATE_MED(){return Dme}static get DATE_MED_WITH_WEEKDAY(){return W4e}static get DATE_FULL(){return Lme}static get DATE_HUGE(){return Nme}static get TIME_SIMPLE(){return Fme}static get TIME_WITH_SECONDS(){return Ume}static get TIME_WITH_SHORT_OFFSET(){return kme}static get TIME_WITH_LONG_OFFSET(){return zme}static get TIME_24_SIMPLE(){return Vme}static get TIME_24_WITH_SECONDS(){return Bme}static get TIME_24_WITH_SHORT_OFFSET(){return Gme}static get TIME_24_WITH_LONG_OFFSET(){return jme}static get DATETIME_SHORT(){return Hme}static get DATETIME_SHORT_WITH_SECONDS(){return qme}static get DATETIME_MED(){return Wme}static get DATETIME_MED_WITH_SECONDS(){return Xme}static get DATETIME_MED_WITH_WEEKDAY(){return X4e}static get DATETIME_FULL(){return Yme}static get DATETIME_FULL_WITH_SECONDS(){return Zme}static get DATETIME_HUGE(){return Qme}static get DATETIME_HUGE_WITH_SECONDS(){return Jme}}function IE(e){if(Qt.isDateTime(e))return e;if(e&&e.valueOf&&vb(e.valueOf()))return Qt.fromJSDate(e);if(e&&typeof e=="object")return Qt.fromObject(e);throw new ah(`Unknown datetime argument: ${e}, of type ${typeof e}`)}const Zk={ar:[".",","],bg:[",","\xA0"],bs:[",","."],ca:[",","."],cs:[",","\xA0"],da:[",","."],de:[",","."],"de-ch":[".","\u2019"],el:[",","."],en:[".",","],"en-au":[".",","],es:[",","."],"es-mx":[".",","],et:[",","\xA0"],fi:[",","\xA0"],fr:[",","\u202F"],"fr-ch":[",","\u202F"],he:[".",","],hi:[".",",","#,##,##0.###"],hr:[",","."],hu:[",","\xA0"],id:[",","."],it:[",","."],"it-ch":[".","\u2019"],ja:[".",","],ko:[".",","],lt:[",","\xA0"],lv:[",","\xA0"],mk:[",","."],nb:[",","\xA0"],nl:[",","."],pl:[",","\xA0"],pt:[",","."],"pt-pt":[",","\xA0"],ro:[",","."],ru:[",","\xA0"],sk:[",","\xA0"],sl:[",","."],sr:[",","."],sv:[",","\xA0"],th:[".",","],tr:[",","."],uk:[",","\xA0"],vi:[",","."],zh:[".",","]};function Oge(e){e||(e=tu());let t=e in Zk;if(!t){const n=e.split("-");n.length>1&&n[0]in Zk&&(e=n[0],t=!0),t||(e="en")}const[i,r,s="#,##0.###"]=Zk[e];return{decimal:i,group:r,pattern:s}}function GUe(e,t){const i=Oge((t=F({},t)).locale);t.customs=i;const r=t.pattern||i.pattern;return isNaN(e)||Math.abs(e)===1/0?null:jUe(e,r,t)}const Pge=/[#0,]*[#0](?:\.0*#*)?/;function jUe(e,t,i){const r=(i=i||{}).customs.group,s=i.customs.decimal,n=t.split(";"),o=n[0];if((t=n[e<0?1:0]||"-"+o).includes("%"))e*=100;else if(t.includes("\u2030"))e*=1e3;else{if(t.includes("\xA4"))throw new Error("currency notation not supported");if(t.includes("E"))throw new Error("exponential notation not supported")}const a=Pge,l=o.match(a);if(!l)throw new Error("unable to find a number expression in pattern: "+t);return i.fractional===!1&&(i.places=0),t.replace(a,HUe(e,l[0],{decimal:s,group:r,places:i.places,round:i.round}))}function HUe(e,t,i){(i=i||{}).places===!0&&(i.places=0),i.places===1/0&&(i.places=6);const r=t.split("."),s=typeof i.places=="string"&&i.places.indexOf(",");let n=i.places;s?n=i.places.substring(s+1):n>=0||(n=(r[1]||[]).length),i.round<0||(e=Number(e.toFixed(Number(n))));const o=String(Math.abs(e)).split("."),a=o[1]||"";if(r[1]||i.places){s&&(i.places=i.places.substring(0,s));const y=i.places!==void 0?i.places:r[1]&&r[1].lastIndexOf("0")+1;y>a.length&&(o[1]=a.padEnd(Number(y),"0")),n<a.length&&(o[1]=a.substr(0,Number(n)))}else o[1]&&o.pop();const l=r[0].replace(",","");let c=l.indexOf("0");c!==-1&&(c=l.length-c,c>o[0].length&&(o[0]=o[0].padStart(c,"0")),l.includes("#")||(o[0]=o[0].substr(o[0].length-c)));let h,p,f=r[0].lastIndexOf(",");if(f!==-1){h=r[0].length-f-1;const y=r[0].substr(0,f);f=y.lastIndexOf(","),f!==-1&&(p=y.length-f-1)}const m=[];for(let y=o[0];y;){const v=y.length-h;m.push(v>0?y.substr(v):y),y=v>0?y.slice(0,v):"",p&&(h=p,p=void 0)}return o[0]=m.reverse().join(i.group||","),o.join(i.decimal||".")}function qUe(e){const t=Oge((e=e||{}).locale),i=e.pattern||t.pattern,r=t.group,s=t.decimal;let n=1;if(i.includes("%"))n/=100;else if(i.includes("\u2030"))n/=1e3;else if(i.includes("\xA4"))throw new Error("currency notation not supported");const o=i.split(";");return o.length===1&&o.push("-"+o[0]),{regexp:aM(o,l=>(l="(?:"+tce(l,".")+")").replace(Pge,c=>{const h={signed:!1,separator:e.strict?r:[r,""],fractional:e.fractional,decimal:s,exponent:!1},p=c.split(".");let f=e.places;p.length===1&&n!==1&&(p[1]="###"),p.length===1||f===0?h.fractional=!1:(f===void 0&&(f=e.pattern?p[1].lastIndexOf("0")+1:1/0),f&&e.fractional==null&&(h.fractional=!0),!e.places&&f<p[1].length&&(f+=","+p[1].length),h.places=f);const m=p[0].split(",");return m.length>1&&(h.groupSize=m.pop().length,m.length>1&&(h.groupSize2=m.pop().length)),"("+XUe(h)+")"}),!0).replace(/[\xa0 ]/g,"[\\s\\xa0]"),group:r,decimal:s,factor:n}}function WUe(e,t){const i=qUe(t),r=new RegExp("^"+i.regexp+"$").exec(e);if(!r)return NaN;let s=r[1];if(!r[1]){if(!r[2])return NaN;s=r[2],i.factor*=-1}return s=s.replace(new RegExp("["+i.group+"\\s\\xa0]","g"),"").replace(i.decimal,"."),Number(s)*i.factor}function XUe(e){"places"in(e=e||{})||(e.places=1/0),typeof e.decimal!="string"&&(e.decimal="."),"fractional"in e&&!/^0/.test(String(e.places))||(e.fractional=[!0,!1]),"exponent"in e||(e.exponent=[!0,!1]),"eSigned"in e||(e.eSigned=[!0,!1]);const t=hee(e),i=aM(e.fractional,s=>{let n="";return s&&e.places!==0&&(n="\\"+e.decimal,e.places===1/0?n="(?:"+n+"\\d+)?":n+="\\d{"+e.places+"}"),n},!0);let r=t+i;return i&&(r="(?:(?:"+r+")|(?:"+i+"))"),r+aM(e.exponent,s=>s?"([eE]"+hee({signed:e.eSigned})+")":"")}function hee(e){return"signed"in(e=e||{})||(e.signed=[!0,!1]),"separator"in e?"groupSize"in e||(e.groupSize=3):e.separator="",aM(e.signed,t=>t?"[-+]":"",!0)+aM(e.separator,t=>{if(!t)return"(?:\\d+)";(t=tce(t))===" "?t="\\s":t==="\xA0"&&(t="\\s\\xa0");const i=e.groupSize,r=e.groupSize2;if(r){const s="(?:0|[1-9]\\d{0,"+(r-1)+"}(?:["+t+"]\\d{"+r+"})*["+t+"]\\d{"+i+"})";return i-r>0?"(?:"+s+"|(?:0|[1-9]\\d{0,"+(i-1)+"}))":s}return"(?:0|[1-9]\\d{0,"+(i-1)+"}(?:["+t+"]\\d{"+i+"})*)"},!0)}const aM=(e,t,i)=>{if(!(e instanceof Array))return t(e);const r=[];for(let s=0;s<e.length;s++)r.push(t(e[s]));return YUe(r.join("|"),i)},YUe=(e,t)=>"("+(t?"?:":"")+e+")";var dee,pee;function Qvt(e){return IO.fromJSON(e.toJSON())}function ZUe(e){return e.toJSON?e.toJSON():e}function Jvt(e){return typeof e=="string"||e instanceof String}function Kvt(e){return typeof e=="number"}function fee(e){return e instanceof Date}function e_t(e,t){return e===t||!(!fee(e)||!fee(t))&&e.getTime()===t.getTime()}function t_t(e){if(e===void 0)return null;if(typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 109404;case"miles":case"mile":return 109413;case"kilometers":case"kilometer":case"km":return 109414}return null}function i_t(e){if(e===null)return null;switch(e.type){case"polygon":case"multipoint":case"polyline":return e.extent;case"point":return new ci({xmin:e.x,ymin:e.y,xmax:e.x,ymax:e.y,spatialReference:e.spatialReference});case"extent":return e}return null}function r_t(e){if(e===void 0)return null;if(typeof e=="number"||typeof e=="number")return e;switch(e.toLowerCase()){case"meters":case"meter":return 9001;case"miles":case"mile":return 9035;case"kilometers":case"kilometer":case"km":return 9036}return null}(function(e){e[e.Standardised=0]="Standardised",e[e.StandardisedNoInterval=1]="StandardisedNoInterval",e[e.SqlServer=2]="SqlServer",e[e.Oracle=3]="Oracle",e[e.Postgres=4]="Postgres",e[e.PGDB=5]="PGDB",e[e.FILEGDB=6]="FILEGDB",e[e.NotEvaluated=7]="NotEvaluated"})(dee||(dee={})),function(e){e[e.InFeatureSet=0]="InFeatureSet",e[e.NotInFeatureSet=1]="NotInFeatureSet",e[e.Unknown=2]="Unknown"}(pee||(pee={}));const s_t=1e3,n_t={point:"point",polygon:"polygon",polyline:"polyline",multipoint:"multipoint",extent:"extent",esriGeometryPoint:"point",esriGeometryPolygon:"polygon",esriGeometryPolyline:"polyline",esriGeometryMultipoint:"multipoint",esriGeometryEnvelope:"extent",envelope:"extent"},mee={point:"esriGeometryPoint",polygon:"esriGeometryPolygon",polyline:"esriGeometryPolyline",multipoint:"esriGeometryMultipoint",extent:"esriGeometryEnvelope",esriGeometryPoint:"esriGeometryPoint",esriGeometryPolygon:"esriGeometryPolygon",esriGeometryPolyline:"esriGeometryPolyline",esriGeometryMultipoint:"esriGeometryMultipoint",esriGeometryEnvelope:"esriGeometryEnvelope",envelope:"esriGeometryEnvelope"},o_t={"small-integer":"esriFieldTypeSmallInteger",integer:"esriFieldTypeInteger",long:"esriFieldTypeLong",single:"esriFieldTypeSingle",double:"esriFieldTypeDouble",string:"esriFieldTypeString",date:"esriFieldTypeDate",oid:"esriFieldTypeOID",geometry:"esriFieldTypeGeometry",blob:"esriFieldTypeBlob",raster:"esriFieldTypeRaster",guid:"esriFieldTypeGUID","global-id":"esriFieldTypeGlobalID",xml:"eesriFieldTypeXML",esriFieldTypeSmallInteger:"esriFieldTypeSmallInteger",esriFieldTypeInteger:"esriFieldTypeInteger",esriFieldTypeLong:"esriFieldTypeLong",esriFieldTypeSingle:"esriFieldTypeSingle",esriFieldTypeDouble:"esriFieldTypeDouble",esriFieldTypeString:"esriFieldTypeString",esriFieldTypeDate:"esriFieldTypeDate",esriFieldTypeOID:"esriFieldTypeOID",esriFieldTypeGeometry:"esriFieldTypeGeometry",esriFieldTypeBlob:"esriFieldTypeBlob",esriFieldTypeRaster:"esriFieldTypeRaster",esriFieldTypeGUID:"esriFieldTypeGUID",esriFieldTypeGlobalID:"esriFieldTypeGlobalID",esriFieldTypeXML:"eesriFieldTypeXML"};function a_t(e){return e===void 0?"":e=(e=(e=e.replace(/\/featureserver\/[0-9]*/i,"/FeatureServer")).replace(/\/mapserver\/[0-9]*/i,"/MapServer")).split("?")[0]}function l_t(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.includes(a)){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],m=o(a[f]);m&&(c&&(c+=","),c+=JSON.stringify(f)+":"+m)}return n.splice(h,1),"{"+c+"}"}(e)}class Ige{constructor(t){this.value=t}}class $ge{constructor(t){this.value=t}}class BW{constructor(t){this.fn=t}}class GW{constructor(t,i){this.paramCount=i,this.fn=t}}const QUe=BW,JUe=$ge,KUe=Ige,eke=GW,Vc={type:"VOID"},tke={type:"BREAK"},ike={type:"CONTINUE"};function lM(e,t,i){return t===""||t==null||t===i||t===i?e:e=e.split(t).join(i)}function jW(e){return e instanceof BW||e instanceof G4e||e instanceof GW}function LN(e){return!!Vo(e)||!!Qa(e)||!!ya(e)||!!Za(e)||e===null||e===Vc||typeof e=="number"}function rke(e,t){return e===void 0?t:e}function Vo(e){return typeof e=="string"||e instanceof String}function Za(e){return typeof e=="boolean"}function Qa(e){return typeof e=="number"}function ske(e){return typeof e=="number"&&isFinite(e)&&Math.floor(e)===e}function Eh(e){return e instanceof Array}function nke(e){return(e==null?void 0:e.arcadeDeclaredClass)==="esri.arcade.Feature"}function oke(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureset.support.FeatureSet")===!0}function ake(e){return(e&&e.declaredRootClass&&e.declaredRootClass==="esri.arcade.featureSetCollection")===!0}function Ub(e){return e instanceof kf}function ya(e){return e instanceof Date}function lke(e,t,i){if(e.length<t||e.length>i)throw new Error("Function called with wrong number of Parameters")}function cke(e){return e<0?-Math.round(-e):Math.round(e)}function uke(){let e=Date.now();return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){const i=(e+16*Math.random())%16|0;return e=Math.floor(e/16),(t==="x"?i:3&i|8).toString(16)})}function HW(e,t){return isNaN(e)===!1?t==null||t===""?e.toString():(t=lM(t,"\u2030",""),t=lM(t,"\xA4",""),GUe(e,{pattern:t})):e.toString()}function i5(e,t){const i=Qt.fromJSDate(e);return t==null||t===""?i.toISO({suppressMilliseconds:!0}):i.toFormat(Dge(t),{locale:tu(),numberingSystem:"latn"})}function Dge(e){e=e.replace(/LTS|LT|LL?L?L?|l{1,4}/g,"[$&]");let t="";const i=/(\[[^\[]*\])|(\\)?([Hh]mm(ss)?|Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|W[o|W]?|Qo?|N{1,5}|YYYYYY|YYYYY|YYYY|YY|y{2,4}|yo?|gg(ggg?)?|GG(GGG?)?|e|E|a|A|hh?|HH?|kk?|mm?|ss?|S{1,9}|x|X|zz?|ZZ?|.)/g;for(const r of e.match(i))switch(r){case"D":t+="d";break;case"DD":t+="dd";break;case"DDD":t+="o";break;case"d":t+="c";break;case"ddd":t+="ccc";break;case"dddd":t+="cccc";break;case"M":t+="L";break;case"MM":t+="LL";break;case"MMM":t+="LLL";break;case"MMMM":t+="LLLL";break;case"YY":t+="yy";break;case"Y":case"YYYY":t+="yyyy";break;case"Q":t+="q";break;case"Z":t+="ZZ";break;case"ZZ":t+="ZZZ";break;case"S":t+="'S'";break;case"SS":t+="'SS'";break;case"SSS":t+="u";break;case"A":case"a":t+="a";break;case"m":case"mm":case"h":case"hh":case"H":case"HH":case"s":case"ss":case"X":case"x":t+=r;break;default:r.length>=2&&r.slice(0,1)==="["&&r.slice(-1)==="]"?t+=`'${r.slice(1,-1)}'`:t+=`'${r}'`}return t}function _r(e,t,i){switch(i){case">":return e>t;case"<":return e<t;case">=":return e>=t;case"<=":return e<=t}return!1}function hke(e,t,i){if(e===null){if(t===null||t===Vc)return _r(null,null,i);if(Qa(t))return _r(0,t,i);if(Vo(t)||Za(t))return _r(0,Es(t),i);if(ya(t))return _r(0,t.getTime(),i)}if(e===Vc){if(t===null||t===Vc)return _r(null,null,i);if(Qa(t))return _r(0,t,i);if(Vo(t)||Za(t))return _r(0,Es(t),i);if(ya(t))return _r(0,t.getTime(),i)}else if(Qa(e)){if(Qa(t))return _r(e,t,i);if(Za(t))return _r(e,Es(t),i);if(t===null||t===Vc)return _r(e,0,i);if(Vo(t))return _r(e,Es(t),i);if(ya(t))return _r(e,t.getTime(),i)}else if(Vo(e)){if(Vo(t))return _r(tv(e),tv(t),i);if(ya(t))return _r(Es(e),t.getTime(),i);if(Qa(t))return _r(Es(e),t,i);if(t===null||t===Vc)return _r(Es(e),0,i);if(Za(t))return _r(Es(e),Es(t),i)}else if(ya(e)){if(ya(t))return _r(e,t,i);if(t===null||t===Vc)return _r(e.getTime(),0,i);if(Qa(t))return _r(e.getTime(),t,i);if(Za(t)||Vo(t))return _r(e.getTime(),Es(t),i)}else if(Za(e)){if(Za(t))return _r(e,t,i);if(Qa(t))return _r(Es(e),Es(t),i);if(ya(t))return _r(Es(e),t.getTime(),i);if(t===null||t===Vc)return _r(Es(e),0,i);if(Vo(t))return _r(Es(e),Es(t),i)}return!!Lge(e,t)&&(i==="<="||i===">=")}function Lge(e,t){if(e===t||e===null&&t===Vc||t===null&&e===Vc)return!0;if(ya(e)&&ya(t))return e.getTime()===t.getTime();if(e instanceof $W||e instanceof _w)return e.equalityTest(t);if(e instanceof nt&&t instanceof nt){const i=e.cache._arcadeCacheId,r=t.cache._arcadeCacheId;if(i!=null)return i===r}return e!==void 0&&t!==void 0&&e!==null&&t!==null&&typeof e=="object"&&typeof t=="object"&&(e._arcadeCacheId===t._arcadeCacheId&&e._arcadeCacheId!==void 0&&e._arcadeCacheId!==null||e._underlyingGraphic===t._underlyingGraphic&&e._underlyingGraphic!==void 0&&e._underlyingGraphic!==null)}function tv(e,t){if(Vo(e))return e;if(e===null)return"";if(Qa(e))return HW(e,t);if(Za(e))return e.toString();if(ya(e))return i5(e,t);if(e instanceof ic)return JSON.stringify(e.toJSON());if(Eh(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=NN(e[r]);return"["+i.join(",")+"]"}if(e instanceof kf){const i=[];for(let r=0;r<e.length();r++)i[r]=NN(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():jW(e)?"object, Function":""}function dke(e){const t=[];if(Eh(e)===!1)return null;if(e instanceof kf){for(let i=0;i<e.length();i++)t[i]=Es(e.get(i));return t}for(let i=0;i<e.length;i++)t[i]=Es(e[i]);return t}function uD(e,t){if(Vo(e))return e;if(e===null)return"";if(Qa(e))return HW(e,t);if(Za(e))return e.toString();if(ya(e))return i5(e,t);if(e instanceof ic)return e instanceof ci?'{"xmin":'+e.xmin.toString()+',"ymin":'+e.ymin.toString()+","+(e.hasZ?'"zmin":'+e.zmin.toString()+",":"")+(e.hasM?'"mmin":'+e.mmin.toString()+",":"")+'"xmax":'+e.xmax.toString()+',"ymax":'+e.ymax.toString()+","+(e.hasZ?'"zmax":'+e.zmax.toString()+",":"")+(e.hasM?'"mmax":'+e.mmax.toString()+",":"")+'"spatialReference":'+tG(e.spatialReference)+"}":tG(e.toJSON(),(i,r)=>i.key===r.key?0:i.key==="spatialReference"?1:r.key==="spatialReference"||i.key<r.key?-1:i.key>r.key?1:0);if(Eh(e)){const i=[];for(let r=0;r<e.length;r++)i[r]=NN(e[r]);return"["+i.join(",")+"]"}if(e instanceof kf){const i=[];for(let r=0;r<e.length();r++)i[r]=NN(e.get(r));return"["+i.join(",")+"]"}return e!==null&&typeof e=="object"&&e.castToText!==void 0?e.castToText():jW(e)?"object, Function":""}function NN(e){if(e===null)return"null";if(Za(e)||Qa(e)||Vo(e))return JSON.stringify(e);if(e instanceof ic||e instanceof kf||e instanceof Array)return uD(e);if(e instanceof Date)return JSON.stringify(i5(e,""));if(e!==null&&typeof e=="object"){if(e.castToText!==void 0)return e.castToText()}else if(e===Vc)return"null";return"null"}function Es(e,t){return Qa(e)?e:e===null||e===""?0:ya(e)?NaN:Za(e)?e?1:0:Eh(e)||e===""||e===void 0?NaN:t!==void 0&&Vo(e)?(t=lM(t,"\u2030",""),t=lM(t,"\xA4",""),WUe(e,{pattern:t})):e===Vc?0:Number(e)}function pke(e){if(ya(e))return e;if(Vo(e)){const t=Nge(e);if(t)return t.toJSDate()}return null}function fke(e){return ya(e)?Qt.fromJSDate(e):Vo(e)?Nge(e):null}function Nge(e){const t=/ (\d\d)/;let i=Qt.fromISO(e);return i.isValid||t.test(e)&&(e=e.replace(t,"T$1"),i=Qt.fromISO(e),i.isValid)?i:null}function mke(e){return Za(e)?e:Vo(e)?(e=e.toLowerCase())==="true":!!Qa(e)&&e!==0&&!isNaN(e)}function gke(e,t){return R(e)?null:(e.spatialReference!==null&&e.spatialReference!==void 0||(e.spatialReference=t),e)}function yke(e){if(e===null)return null;if(e instanceof nt)return e.x==="NaN"||e.x===null||isNaN(e.x)?null:e;if(e instanceof cu){if(e.rings.length===0)return null;for(const t of e.rings)if(t.length>0)return e;return null}if(e instanceof Jc){if(e.paths.length===0)return null;for(const t of e.paths)if(t.length>0)return e;return null}return e instanceof lw?e.points.length===0?null:e:e instanceof ci?e.xmin==="NaN"||e.xmin===null||isNaN(e.xmin)?null:e:null}function Fge(e,t){if(!e||!e.domain)return t;let i=null;if(e.field.type==="string"||e.field.type==="esriFieldTypeString")t=tv(t);else{if(t==null)return null;if(t==="")return t;t=Es(t)}for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.code===t&&(i=s)}return i===null?t:i.name}function Uge(e,t){if(!e||!e.domain)return t;let i=null;t=tv(t);for(let r=0;r<e.domain.codedValues.length;r++){const s=e.domain.codedValues[r];s.name===t&&(i=s)}return i===null?t:i.code}function r5(e,t,i=null,r=null){if(!t||!t.fields)return null;let s,n,o=null;for(let a=0;a<t.fields.length;a++){const l=t.fields[a];l.name.toLowerCase()===e.toString().toLowerCase()&&(o=l)}if(o===null)throw new Error("Field not found");return r===null&&i&&t.typeIdField&&(r=i.hasField(t.typeIdField)?i.field(t.typeIdField):null),r!=null&&t.types.some(function(a){return a.id===r&&(s=a.domains&&a.domains[o.name],s&&s.type==="inherited"&&(s=gee(o.name,t),n=!0),!0)}),n||s||(s=gee(e,t)),{field:o,domain:s}}function gee(e,t){let i;return t.fields.some(function(r){return r.name.toLowerCase()===e.toLowerCase()&&(i=r.domain),!!i}),i}function tG(e,t){t||(t={}),typeof t=="function"&&(t={cmp:t});const i=typeof t.cycles=="boolean"&&t.cycles,r=t.cmp&&(s=t.cmp,function(o){return function(a,l){const c={key:a,value:o[a]},h={key:l,value:o[l]};return s(c,h)}});var s;const n=[];return function o(a){if(a&&a.toJSON&&typeof a.toJSON=="function"&&(a=a.toJSON()),a===void 0)return;if(typeof a=="number")return isFinite(a)?""+a:"null";if(typeof a!="object")return JSON.stringify(a);let l,c;if(Array.isArray(a)){for(c="[",l=0;l<a.length;l++)l&&(c+=","),c+=o(a[l])||"null";return c+"]"}if(a===null)return"null";if(n.includes(a)){if(i)return JSON.stringify("__cycle__");throw new TypeError("Converting circular structure to JSON")}const h=n.push(a)-1,p=Object.keys(a).sort(r&&r(a));for(c="",l=0;l<p.length;l++){const f=p[l],m=o(a[f]);m&&(c&&(c+=","),c+=JSON.stringify(f)+":"+m)}return n.splice(h,1),"{"+c+"}"}(e)}function vke(e){if(e===null)return null;const t=[];for(const i of e)i&&i.arcadeDeclaredClass&&i.arcadeDeclaredClass==="esri.arcade.Feature"?t.push(i.geometry()):t.push(i);return t}function ZS(e,t){if(!(t instanceof nt))throw new Error("Invalid Argument");e.push(t.hasZ?t.hasM?[t.x,t.y,t.z,t.m]:[t.x,t.y,t.z]:[t.x,t.y])}function _ke(e,t){if(Eh(e)||Ub(e)){let i=!1,r=!1,s=[],n=t;if(Eh(e)){for(const o of e)ZS(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ,r=e[0].hasM)}else if(e instanceof _w)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else{if(!Ub(e))throw new Error("Invalid Argument");for(const o of e.toArray())ZS(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:(BH(s,r,i)===!1&&(s=s.slice(0).reverse()),new cu({rings:[s],spatialReference:n,hasZ:i,hasM:r}))}return e}function bke(e,t){if(Eh(e)||Ub(e)){let i=!1,r=!1,s=[],n=t;if(Eh(e)){for(const o of e)ZS(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof _w)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(Ub(e)){for(const o of e.toArray())ZS(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new Jc({paths:[s],spatialReference:n,hasZ:i,hasM:r})}return e}function wke(e,t){if(Eh(e)||Ub(e)){let i=!1,r=!1,s=[],n=t;if(Eh(e)){for(const o of e)ZS(s,o);s.length>0&&(n=e[0].spatialReference,i=e[0].hasZ===!0,r=e[0].hasM===!0)}else if(e instanceof _w)s=e._elements,s.length>0&&(i=e._hasZ,r=e._hasM,n=e.get(0).spatialReference);else if(Ub(e)){for(const o of e.toArray())ZS(s,o);s.length>0&&(n=e.get(0).spatialReference,i=e.get(0).hasZ===!0,r=e.get(0).hasM===!0)}return s.length===0?null:new lw({points:s,spatialReference:n,hasZ:i,hasM:r})}return e}function xke(e,t=!1){const i=[];if(e===null)return i;if(Eh(e)===!0){for(let r=0;r<e.length;r++){const s=tv(e[r]);s===""&&t!==!0||i.push(s)}return i}if(e instanceof kf){for(let r=0;r<e.length();r++){const s=tv(e.get(r));s===""&&t!==!0||i.push(s)}return i}if(LN(e)){const r=tv(e);return r===""&&t!==!0||i.push(r),i}return[]}let Qk=0;function Tke(e){return Qk++,Qk%100==0?(Qk=0,new Promise(t=>{setTimeout(()=>{t(e)},0)})):e}function Ske(e,t,i){switch(i){case"&":return e&t;case"|":return e|t;case"^":return e^t;case"<<":return e<<t;case">>":return e>>t;case">>>":return e>>>t}}function cM(e,t=null){return e==null?null:Za(e)||Qa(e)||Vo(e)?e:e instanceof ic?(t==null?void 0:t.keepGeometryType)===!0?e:e.toJSON():e instanceof kf?e.toArray().map(i=>cM(i,t)):e instanceof Array?e.map(i=>cM(i,t)):e instanceof Date?e:e!==null&&typeof e=="object"&&e.castAsJson!==void 0?e.castAsJson(t):null}async function Eke(e,t,i,r,s){const n=await qW(e,t,i);s[r]=n}async function qW(e,t=null,i=null){if(e instanceof kf&&(e=e.toArray()),e==null)return null;if(LN(e)||e instanceof ic||e instanceof Date)return cM(e,i);if(e instanceof Array){const r=[],s=[];for(const n of e)n===null||LN(n)||n instanceof ic||n instanceof Date?s.push(cM(n,i)):(s.push(null),r.push(Eke(n,t,i,s.length-1,s)));return r.length>0&&await Promise.all(r),s}return e!==null&&typeof e=="object"&&e.castAsJsonAsync!==void 0?e.castAsJsonAsync(t,i):null}function Cke(e,t,i){const r=e.fullSchema();return r===null||!r.fields?null:r5(t,r,e,i)}function Ake(e){const t=e.fullSchema();return t===null?null:t.fields&&t.typeIdField?{subtypeField:t.typeIdField,subtypes:t.types?t.types.map(i=>({name:i.name,code:i.id})):[]}:null}function Rke(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;const n=r5(t,s,e,r);if(i===void 0)try{i=e.field(t)}catch{return null}return Fge(n,i)}function Mke(e,t,i,r){const s=e.fullSchema();if(s===null||!s.fields)return null;if(i===void 0){try{i=e.field(t)}catch{return null}return i}return Uge(r5(t,s,e,r),i)}function Oke(e){const t=e.fullSchema();if(t===null||!t.fields)return null;const i=[];for(const r of t.fields)i.push(ZUe(r));return{objectIdField:t.objectIdField,globalIdField:t.globalIdField,geometryType:mee[t.geometryType]===void 0?"":mee[t.geometryType],fields:i}}const c_t=Object.freeze(Object.defineProperty({__proto__:null,ReturnResultE:Ige,ImplicitResultE:$ge,NativeFunctionE:BW,SizzleFunctionE:GW,NativeFunction:QUe,ImplicitResult:JUe,ReturnResult:KUe,SizzleFunction:eke,voidOperation:Vc,breakResult:tke,continueResult:ike,multiReplace:lM,isFunctionParameter:jW,isSimpleType:LN,defaultUndefined:rke,isString:Vo,isBoolean:Za,isNumber:Qa,isInteger:ske,isArray:Eh,isFeature:nke,isFeatureSet:oke,isFeatureSetCollection:ake,isImmutableArray:Ub,isDate:ya,pcCheck:lke,absRound:cke,generateUUID:uke,formatNumber:HW,formatDate:i5,standardiseDateFormat:Dge,greaterThanLessThan:hke,equalityTest:Lge,toString:tv,toNumberArray:dke,toStringExplicit:uD,toNumber:Es,toDate:pke,toDateTime:fke,toBoolean:mke,fixSpatialReference:gke,fixNullGeometry:yke,getDomainValue:Fge,getDomainCode:Uge,getDomain:r5,stableStringify:tG,autoCastFeatureToGeometry:vke,autoCastArrayOfPointsToPolygon:_ke,autoCastArrayOfPointsToPolyline:bke,autoCastArrayOfPointsToMultiPoint:wke,toStringArray:xke,tick:Tke,binaryOperator:Ske,castAsJson:cM,castAsJsonAsync:qW,featureFullDomain:Cke,featureSubtypes:Ake,featureDomainValueLookup:Rke,featureDomainCodeLookup:Mke,featureSchema:Oke},Symbol.toStringTag,{value:"Module"}));var iG;let cA=iG=class extends fe{constructor(e){super(e),this.minValue=0,this.maxValue=0}clone(){return new iG({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],cA.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],cA.prototype,"maxValue",void 0),cA=iG=u([P("esri.renderer.support.AuthoringInfoClassBreakInfo")],cA);var rG;let f0=rG=class extends fe{constructor(e){super(e),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new rG({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:te(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],f0.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],f0.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],f0.prototype,"label",void 0),u([d({type:[cA],json:{write:!0}})],f0.prototype,"classBreakInfos",void 0),f0=rG=u([P("esri.renderers.support.AuthoringInfoFieldInfo")],f0);var sG;const uP=new _i({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),hP=new _i({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),yee={key:e=>typeof e=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},vee=["high-to-low","above-and-below","centered-on","extremes"],_ee=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],bee=["seconds","minutes","hours","days","months","years"];let Al=sG=class extends fe{constructor(e){super(e),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(e){return typeof e=="string"||typeof e=="number"?e:null}castStartTime(e){return typeof e=="string"||typeof e=="number"?e:null}get style(){return this.type==="color"?this._get("style"):null}set style(e){this._set("style",e)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(e){this._set("theme",e)}clone(){return new sG({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:yee,json:{write:!0}})],Al.prototype,"endTime",void 0),u([Ot("endTime")],Al.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],Al.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],Al.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],Al.prototype,"minSliderValue",void 0),u([d({types:yee,json:{write:!0}})],Al.prototype,"startTime",void 0),u([Ot("startTime")],Al.prototype,"castStartTime",null),u([d({type:uP.apiValues,value:null,json:{type:uP.jsonValues,read:uP.read,write:uP.write}})],Al.prototype,"style",null),u([d({type:_ee,value:null,json:{type:_ee,origins:{"web-scene":{type:vee,write:{writer:(e,t)=>{vee.includes(e)&&(t.theme=e)}}}},write:!0}})],Al.prototype,"theme",null),u([d({type:hP.apiValues,json:{type:hP.jsonValues,read:hP.read,write:hP.write}})],Al.prototype,"type",void 0),u([d({type:bee,json:{type:bee,write:!0}})],Al.prototype,"units",void 0),Al=sG=u([P("esri.renderers.support.AuthoringInfoVisualVariable")],Al);const Pke=Al;let hD=class extends fe{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],hD.prototype,"type",void 0),hD=u([P("esri.rest.support.ColorRamp")],hD);const WW=hD;var nG;let Z_=nG=class extends WW{constructor(e){super(e),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new nG({fromColor:te(this.fromColor),toColor:te(this.toColor),algorithm:this.algorithm})}};u([ct({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],Z_.prototype,"algorithm",void 0),u([d({type:qe,json:{type:[yr],write:!0}})],Z_.prototype,"fromColor",void 0),u([d({type:qe,json:{type:[yr],write:!0}})],Z_.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],Z_.prototype,"type",void 0),Z_=nG=u([P("esri.rest.support.AlgorithmicColorRamp")],Z_);const XW=Z_;var oG;let uA=oG=class extends WW{constructor(e){super(e),this.colorRamps=null,this.type="multipart"}clone(){return new oG({colorRamps:te(this.colorRamps)})}};u([d({type:[XW],json:{write:!0}})],uA.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],uA.prototype,"type",void 0),uA=oG=u([P("esri.rest.support.MultipartColorRamp")],uA);const kge=uA,Ike={key:"type",base:WW,typeMap:{algorithmic:XW,multipart:kge}};function $ke(e){return e&&e.type?e.type==="algorithmic"?XW.fromJSON(e):e.type==="multipart"?kge.fromJSON(e):null:null}var aG;const Qv=new _i({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),dP=new _i({pieChart:"pie-chart",classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),wee=new _i({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),xee=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],Dke=["high-to-low","above-and-below","above","below","90-10"],Lke=["flow-line","wave-front"],Nke=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let nn=aG=class extends fe{constructor(e){super(e),this.colorRamp=null,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const e=this._get("classificationMethod"),t=this.type;return t&&t!=="relationship"?t==="class-breaks-size"||t==="class-breaks-color"?e||"manual":null:e}set classificationMethod(e){this._set("classificationMethod",e)}readColorRamp(e){if(e)return $ke(e)}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(e){this._set("fields",e)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(e){this._set("field1",e)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(e){this._set("field2",e)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(e){this._set("flowTheme",e)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(e){this._set("focus",e)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(e){this._set("numClasses",e)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(e){this._set("statistics",e)}get standardDeviationInterval(){const e=this.type;return e&&e!=="relationship"&&e!=="class-breaks-size"&&e!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(e){this._set("standardDeviationInterval",e)}get type(){return this._get("type")}set type(e){let t=e;e==="classed-size"?t="class-breaks-size":e==="classed-color"&&(t="class-breaks-color"),this._set("type",t)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(e){this._set("univariateSymbolStyle",e)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(e){this._set("univariateTheme",e)}clone(){return new aG({classificationMethod:this.classificationMethod,colorRamp:te(this.colorRamp),fields:this.fields&&this.fields.slice(0),field1:te(this.field1),field2:te(this.field2),focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(e=>e.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:Qv.apiValues,value:null,json:{type:Qv.jsonValues,read:Qv.read,write:Qv.write,origins:{"web-document":{default:"manual",type:Qv.jsonValues,read:Qv.read,write:Qv.write}}}})],nn.prototype,"classificationMethod",null),u([d({types:Ike,json:{write:!0}})],nn.prototype,"colorRamp",void 0),u([ke("colorRamp")],nn.prototype,"readColorRamp",null),u([d({type:[String],value:null,json:{write:!0}})],nn.prototype,"fields",null),u([d({type:f0,value:null,json:{write:!0}})],nn.prototype,"field1",null),u([d({type:f0,value:null,json:{write:!0}})],nn.prototype,"field2",null),u([d({type:Lke,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],nn.prototype,"focus",null),u([d({type:Number,value:null,json:{type:yr,write:!0}})],nn.prototype,"numClasses",null),u([d({type:xee,json:{type:xee,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],nn.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],nn.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],nn.prototype,"standardDeviationInterval",null),u([d({type:dP.apiValues,value:null,json:{type:dP.jsonValues,read:dP.read,write:dP.write,origins:{"web-scene":{type:wee.jsonValues,write:{writer:wee.write,overridePolicy:e=>({enabled:e!=="flow"})}}}}})],nn.prototype,"type",null),u([d({type:[Pke],json:{write:!0}})],nn.prototype,"visualVariables",void 0),u([d({type:Nke,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"univariateSymbolStyle",null),u([d({type:Dke,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],nn.prototype,"univariateTheme",null),nn=aG=u([P("esri.renderers.support.AuthoringInfo")],nn);const zge=nn,Jk=new _i({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let hA=class extends fe{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const t=new Set;return await this.collectRequiredFields(t,e),Array.from(t).sort()}getSymbol(e,t){}async getSymbolAsync(e,t){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:zge,json:{write:!0}})],hA.prototype,"authoringInfo",void 0),u([d({type:Jk.apiValues,readOnly:!0,json:{type:Jk.jsonValues,read:!1,write:{writer:Jk.write,ignoreOrigin:!0}}})],hA.prototype,"type",void 0),hA=u([P("esri.renderers.Renderer")],hA);const Lg=hA;var lG;let oS=lG=class extends fe{constructor(){super(...arguments),this.title=null}clone(){return new lG({title:this.title})}};u([d({type:String,json:{write:!0}})],oS.prototype,"title",void 0),oS=lG=u([P("esri.renderers.support.LegendOptions")],oS);var cG;let dD=cG=class extends oS{constructor(){super(...arguments),this.showLegend=null}clone(){return new cG({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],dD.prototype,"showLegend",void 0),dD=cG=u([P("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],dD);const Vge=dD,Fke=me.getLogger("esri.renderers.visualVariables.VisualVariable"),Kk=new _i({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let sd=class extends fe{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(Fke.error(".field: field must be a string value"),null):pO(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],sd.prototype,"index",void 0),u([d({type:Kk.apiValues,readOnly:!0,json:{read:Kk.read,write:Kk.write}})],sd.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],sd.prototype,"field",void 0),u([Ot("field")],sd.prototype,"castField",null),u([d({type:String,json:{write:!0}})],sd.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],sd.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],sd.prototype,"arcadeRequired",null),u([d({type:Vge,json:{write:!0}})],sd.prototype,"legendOptions",void 0),sd=u([P("esri.renderers.visualVariables.VisualVariable")],sd);const UO=sd;var uG;let Q_=uG=class extends UO{constructor(e){super(e),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new uG({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Q_.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],Q_.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Q_.prototype,"normalizationField",void 0),u([d({type:[XLe],json:{write:!0}})],Q_.prototype,"stops",null),Q_=uG=u([P("esri.renderers.visualVariables.ColorVariable")],Q_);const Bge=Q_;var hG;let Gy=hG=class extends fe{constructor(e){super(e),this.label=null,this.opacity=null,this.value=null}readOpacity(e,t){return LS(t.transparency)}writeOpacity(e,t,i){t[i]=xO(e)}clone(){return new hG({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],Gy.prototype,"label",void 0),u([d({type:Number,json:{type:yr,write:{target:"transparency"}}})],Gy.prototype,"opacity",void 0),u([ke("opacity",["transparency"])],Gy.prototype,"readOpacity",null),u([Be("opacity")],Gy.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],Gy.prototype,"value",void 0),Gy=hG=u([P("esri.renderers.visualVariables.support.OpacityStop")],Gy);const Uke=Gy;var dG;let J_=dG=class extends UO{constructor(e){super(e),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(e){e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value),this._set("stops",e)}clone(){return new dG({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(e=>e.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],J_.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],J_.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],J_.prototype,"normalizationField",void 0),u([d({type:[Uke],json:{write:!0}})],J_.prototype,"stops",null),J_=dG=u([P("esri.renderers.visualVariables.OpacityVariable")],J_);const Gge=J_;var pG;let vm=pG=class extends UO{constructor(e){super(e),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(e,t,i,r){if(r&&r.messages){const s=`visualVariables[${this.index}]`;r.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:r}))}}clone(){return new pG({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],vm.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],vm.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],vm.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],vm.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],vm.prototype,"valueExpressionTitle",void 0),u([Be("web-scene","valueExpressionTitle")],vm.prototype,"writeValueExpressionTitleWebScene",null),vm=pG=u([P("esri.renderers.visualVariables.RotationVariable")],vm);const jge=vm;var fG;let Bx=fG=class extends fe{constructor(e){super(e),this.label=null,this.size=null,this.value=null}clone(){return new fG({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],Bx.prototype,"label",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Bx.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],Bx.prototype,"value",void 0),Bx=fG=u([P("esri.renderers.visualVariables.support.SizeStop")],Bx);const kke=Bx;var mG;let pD=mG=class extends Vge{constructor(){super(...arguments),this.customValues=null}clone(){return new mG({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],pD.prototype,"customValues",void 0),pD=mG=u([P("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],pD);const zke=pD;var ng,qn;function RT(e){return e&&e.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function uM(e){return e!=null&&!isNaN(e)&&isFinite(e)}function Hge(e){return e.valueExpression?ng.Expression:e.field&&typeof e.field=="string"?ng.Field:ng.Unknown}function Vke(e,t){const i=t||Hge(e),r=e.valueUnit||"unknown";return i===ng.Unknown?qn.Constant:e.stops?qn.Stops:e.minSize!=null&&e.maxSize!=null&&e.minDataValue!=null&&e.maxDataValue!=null?qn.ClampedLinear:r==="unknown"?e.minSize!=null&&e.minDataValue!=null?e.minSize&&e.minDataValue?qn.Proportional:qn.Additive:qn.Identity:qn.RealWorldSize}(function(e){e.Unknown="unknown",e.Expression="expression",e.Field="field"})(ng||(ng={})),function(e){e.Unknown="unknown",e.Stops="stops",e.ClampedLinear="clamped-linear",e.Proportional="proportional",e.Additive="additive",e.Constant="constant",e.Identity="identity",e.RealWorldSize="real-world-size"}(qn||(qn={}));function u_t(e){}function Bke(e){return()=>e}const QS={inches:Hs(1,"meters","inches"),feet:Hs(1,"meters","feet"),"us-feet":Hs(1,"meters","us-feet"),yards:Hs(1,"meters","yards"),miles:Hs(1,"meters","miles"),"nautical-miles":Hs(1,"meters","nautical-miles"),millimeters:Hs(1,"meters","millimeters"),centimeters:Hs(1,"meters","centimeters"),decimeters:Hs(1,"meters","decimeters"),meters:Hs(1,"meters","meters"),kilometers:Hs(1,"meters","kilometers"),"decimal-degrees":1/GOe(1,"meters",Ei.radius)},yv=me.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),Tee=new Ca,fD=Math.PI,qge=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function Wge(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="color"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void yv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].color}if(typeof a!="number")if(h){if(R(i)||R(i.arcade))return void yv.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,w=v.getViewInfo(y),b=v.createExecContext(n,w);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,b)}else o&&(a=o[l]);const f=r.normalizationField,m=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=ZW(a,c);if(y){const v=y[0],w=y[1],b=v===w?r.stops[v].color:qe.blendColors(r.stops[v].color,r.stops[w].color,y[2],_(i)?i.color:void 0);return new qe(b)}}}function Xge(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(y=>y.type==="opacity"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void yv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof t=="number",n=s?null:t,o=n&&n.attributes;let a=s?t:null;const l=r.field,{ipData:c,hasExpression:h}=r.cache;let p=r.cache.compiledFunc;if(!l&&!h){const y=r.stops;return y&&y[0]&&y[0].opacity}if(typeof a!="number")if(h){if(R(i)||R(i.arcade))return void yv.error("Use of arcade expressions requires an arcade context");const y={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},v=i.arcade.arcadeUtils,w=v.getViewInfo(y),b=v.createExecContext(n,w);if(!p){const S=v.createSyntaxTree(r.valueExpression);p=v.createFunction(S),r.cache.compiledFunc=p}a=v.executeFunction(p,b)}else o&&(a=o[l]);const f=r.normalizationField,m=o?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const y=ZW(a,c);if(y){const v=y[0],w=y[1];if(v===w)return r.stops[v].opacity;{const b=r.stops[v].opacity;return b+(r.stops[w].opacity-b)*y[2]}}}}function Yge(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(m=>m.type==="rotation"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void yv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=r.axis||"heading",n=s==="heading"&&r.rotationType==="arithmetic"?90:0,o=s==="heading"&&r.rotationType==="arithmetic"?-1:1,a=typeof t=="number"?null:t,l=a&&a.attributes,c=r.field,{hasExpression:h}=r.cache;let p=r.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(R(i)||R(i.arcade))return void yv.error("Use of arcade expressions requires an arcade context");const m={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},y=i.arcade.arcadeUtils,v=y.getViewInfo(m),w=y.createExecContext(a,v);if(!p){const b=y.createSyntaxTree(r.valueExpression);p=y.createFunction(b),r.cache.compiledFunc=p}f=y.executeFunction(p,w)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function Gke(e,t,i){const r=typeof t=="number",s=r?null:t,n=s&&s.attributes;let o=r?t:null;const{isScaleDriven:a}=e.cache;let l=e.cache.compiledFunc;if(a){const h=_(i)?i.scale:void 0,p=_(i)?i.view:void 0;o=h==null||p==="3d"?jke(e):h}else if(!r)switch(e.inputValueType){case ng.Expression:{if(R(i)||R(i.arcade))return void yv.error("Use of arcade expressions requires an arcade context");const h={viewingMode:i.viewingMode,scale:i.scale,spatialReference:i.spatialReference},p=i.arcade.arcadeUtils,f=p.getViewInfo(h),m=p.createExecContext(s,f);if(!l){const y=p.createSyntaxTree(e.valueExpression);l=p.createFunction(y),e.cache.compiledFunc=l}o=p.executeFunction(l,m);break}case ng.Field:n&&(o=n[e.field]);break;case ng.Unknown:o=null}if(!uM(o))return null;if(r||!e.normalizationField)return o;const c=n?parseFloat(n[e.normalizationField]):null;return uM(c)&&c!==0?o/c:null}function jke(e){let t=null,i=null;const r=e.stops;return r?(t=r[0].value,i=r[r.length-1].value):(t=e.minDataValue||0,i=e.maxDataValue||0),(t+i)/2}function s5(e,t,i){const r="visualVariables"in e&&e.visualVariables?e.visualVariables.find(n=>n.type==="size"):e;if(!r)return;if(r.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void yv.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=Qge(Gke(r,t,i),r,t,i,r.cache.ipData);return s==null||isNaN(s)?0:s}function Jl(e,t,i){return e==null?null:RT(e)?s5(e,t,i):uM(e)?e:null}function Zge(e,t,i){return uM(i)&&e>i?i:uM(t)&&e<t?t:e}function Hke(e,t,i,r){return e+(Jl(t.minSize,i,r)||t.minDataValue)}function qke(e,t,i){const r=e.stops;let s=r&&r.length&&r[0].size;return s==null&&(s=e.minSize),Jl(s,t,i)}function Wke(e,t,i,r){const s=(e-t.minDataValue)/(t.maxDataValue-t.minDataValue),n=Jl(t.minSize,i,r),o=Jl(t.maxSize,i,r),a=_(r)?r.shape:void 0;if(e<=t.minDataValue)return n;if(e>=t.maxDataValue)return o;if(t.scaleBy==="area"&&a){const l=a==="circle",c=l?fD*(n/2)**2:n*n,h=c+s*((l?fD*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/fD):Math.sqrt(h)}return n+s*(o-n)}function Xke(e,t,i,r){const s=_(r)?r.shape:void 0,n=e/t.minDataValue,o=Jl(t.minSize,i,r),a=Jl(t.maxSize,i,r);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,Zge(l,o,a)}function Yke(e,t,i,r,s){const[n,o,a]=ZW(e,s);if(n===o)return Jl(t.stops[n].size,i,r);{const l=Jl(t.stops[n].size,i,r);return l+(Jl(t.stops[o].size,i,r)-l)*a}}function Zke(e,t,i,r){const s=(_(r)&&r.resolution?r.resolution:1)*QS[t.valueUnit],n=Jl(t.minSize,i,r),o=Jl(t.maxSize,i,r),{valueRepresentation:a}=t;let l=null;return l=a==="area"?2*Math.sqrt(e/fD)/s:a==="radius"||a==="distance"?2*e/s:e/s,Zge(l,n,o)}function Qge(e,t,i,r,s){switch(t.transformationType){case qn.Additive:return Hke(e,t,i,r);case qn.Constant:return qke(t,i,r);case qn.ClampedLinear:return Wke(e,t,i,r);case qn.Proportional:return Xke(e,t,i,r);case qn.Stops:return Yke(e,t,i,r,s);case qn.RealWorldSize:return Zke(e,t,i,r);case qn.Identity:return e;case qn.Unknown:return null}}function Qke(e,t,i){const{isScaleDriven:r}=e.cache;if(!(r&&i==="3d"||t))return null;const s={scale:t,view:i};let n=Jl(e.minSize,Tee,s),o=Jl(e.maxSize,Tee,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function YW(e,t,i){if(!e.visualVariables)return;const r=[],s=[],n=[],o=[],a=[];for(const l of e.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=Wge(l,t,i);r.push({variable:l,value:c})}),n.forEach(l=>{const c=Xge(l,t,i);r.push({variable:l,value:c})}),a.forEach(l=>{const c=Yge(l,t,i);r.push({variable:l,value:c})}),o.forEach(l=>{const c=s5(l,t,i);r.push({variable:l,value:c})}),r.filter(l=>l.value!=null)}function ZW(e,t){if(!t)return;let i=0,r=t.length-1;return t.some((s,n)=>e<s?(r=n,!0):(i=n,!1)),[i,r,(e-t[i])/(t[r]-t[i])]}function Jke(e,t,i){const r=["proportional","proportional","proportional"];for(const s of e){const n=s.useSymbolValue?"symbol-value":s5(s,t,i);switch(s.axis){case"width":r[0]=n;break;case"depth":r[1]=n;break;case"height":r[2]=n;break;case"width-and-depth":r[0]=n,r[1]=n;break;case"all":case void 0:case null:r[0]=n,r[1]=n,r[2]=n;break;default:s.axis}}return r}var QW=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getAllSizes:Jke,getColor:Wge,getOpacity:Xge,getRotationAngle:Yge,getSize:s5,getSizeForValue:Qge,getSizeFromNumberOrVariable:Jl,getSizeRangeAtScale:Qke,getVisualVariableValues:YW,viewScaleRE:qge}),gG;const Iw=me.getLogger("esri.renderers.visualVariables.SizeVariable"),pP=new _i({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),yG=new _i({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function See(e){if(e!=null)return typeof e=="string"||typeof e=="number"?Zi(e):e.type==="size"?RT(e)?e:(delete(e=F({},e)).type,new Ki(e)):void 0}function Eee(e,t,i){if(typeof e!="object")return e;const r=new Ki;return r.read(e,i),r}let Ki=gG=class extends UO{constructor(e){super(e),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:qge.test(this.valueExpression)}}set expression(e){Iw.warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),e==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",e)):this._set("expression",null)}set index(e){RT(this.maxSize)&&(this.maxSize.index=`visualVariables[${e}].maxSize`),RT(this.minSize)&&(this.minSize.index=`visualVariables[${e}].minSize`),this._set("index",e)}get inputValueType(){return Hge(this)}set maxDataValue(e){e&&this.stops&&(Iw.warn("cannot set maxDataValue when stops is not null."),e=null),this._set("maxDataValue",e)}set maxSize(e){e&&this.stops&&(Iw.warn("cannot set maxSize when stops is not null."),e=null),this._set("maxSize",e)}castMaxSize(e){return See(e)}readMaxSize(e,t,i){return Eee(e,t,i)}set minDataValue(e){e&&this.stops&&(Iw.warn("cannot set minDataValue when stops is not null."),e=null),this._set("minDataValue",e)}set minSize(e){e&&this.stops&&(Iw.warn("cannot set minSize when stops is not null."),e=null),this._set("minSize",e)}castMinSize(e){return See(e)}readMinSize(e,t,i){return Eee(e,t,i)}get arcadeRequired(){return!!this.valueExpression||this.minSize&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(e){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?e&&Array.isArray(e)&&(e=e.filter(t=>!!t)).sort((t,i)=>t.value-i.value):e&&(Iw.warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),e=null),this._set("stops",e)}get transformationType(){return Vke(this,this.inputValueType)}readValueExpression(e,t){return e||t.expression&&"$view.scale"}writeValueExpressionWebScene(e,t,i,r){if(e==="$view.scale"){if(r&&r.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;r.messages.push(new q("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:r}))}}else t[i]=e}readValueUnit(e){return e?yG.read(e):null}clone(){return new gG({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:RT(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:RT(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(e=>e.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===qn.ClampedLinear){const{minSize:e,maxSize:t}=this;return this.minSize=t,this.maxSize=e,this}if(this.transformationType===qn.Stops){const e=this.stops,t=e.map(r=>r.size).reverse(),i=e.length;for(let r=0;r<i;r++)e[r].size=t[r];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(e=>e.value||0)}};u([d({readOnly:!0})],Ki.prototype,"cache",null),u([d({type:pP.apiValues,json:{type:pP.jsonValues,origins:{"web-map":{read:!1}},read:pP.read,write:pP.write}})],Ki.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],Ki.prototype,"expression",null),u([d()],Ki.prototype,"index",null),u([d({type:String,readOnly:!0})],Ki.prototype,"inputValueType",null),u([d({type:zke,json:{write:!0}})],Ki.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],Ki.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Ki.prototype,"maxSize",null),u([Ot("maxSize")],Ki.prototype,"castMaxSize",null),u([ke("maxSize")],Ki.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],Ki.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Ki.prototype,"minSize",null),u([Ot("minSize")],Ki.prototype,"castMinSize",null),u([ke("minSize")],Ki.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],Ki.prototype,"normalizationField",void 0),u([d({readOnly:!0})],Ki.prototype,"arcadeRequired",null),u([d({type:String})],Ki.prototype,"scaleBy",void 0),u([d({type:[kke],value:null,json:{write:!0}})],Ki.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],Ki.prototype,"target",void 0),u([d({type:String,readOnly:!0})],Ki.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],Ki.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],Ki.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],Ki.prototype,"valueExpression",void 0),u([ke("valueExpression",["valueExpression","expression"])],Ki.prototype,"readValueExpression",null),u([Be("web-scene","valueExpression")],Ki.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],Ki.prototype,"valueRepresentation",void 0),u([d({type:yG.apiValues,json:{write:yG.write,origins:{"web-map":{read:!1},"web-scene":{write:!0}}}})],Ki.prototype,"valueUnit",void 0),u([ke("valueUnit")],Ki.prototype,"readValueUnit",null),Ki=gG=u([P("esri.renderers.visualVariables.SizeVariable")],Ki);const Jge=Ki,Kke=me.getLogger("esri.renderers.visualVariables.VisualVariableFactory"),e6e={color:Bge,size:Jge,opacity:Gge,rotation:jge},t6e=new _i({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),i6e=/^\[([^\]]+)\]$/i;let mD=class extends Ee{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(t=>!!t))&&e.length){for(const t of e)switch(t.type){case"color":this.colorVariables.push(t);break;case"opacity":this.opacityVariables.push(t);break;case"rotation":this.rotationVariables.push(t);break;case"size":this.sizeVariables.push(t)}this.sizeVariables.length&&this.sizeVariables.some(t=>!!t.target)&&e.sort((t,i)=>{let r=null;return r=t.target===i.target?0:t.target?1:-1,r});for(let t=0;t<e.length;t++)e[t].index=t;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,t,i){const{rotationExpression:r,rotationType:s}=t,n=r&&r.match(i6e),o=n&&n[1];if(o&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:s,field:o})),e)return e.map(a=>{const l=t6e.read(a.type),c=e6e[l];c||(Kke.warn(`Unknown variable type: ${l}`),i&&i.messages&&i.messages.push(new lu("visual-variable:unsupported",`visualVariable of type '${l}' is not supported`,{definition:a,context:i})));const h=new c;return h.read(a,i),h})}writeVariables(e,t){const i=[];for(const r of e){const s=r.toJSON(t);s&&i.push(s)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],mD.prototype,"visualVariables",null),mD=u([P("esri.renderers.visualVariables.VisualVariableFactory")],mD);const r6e=mD,s6e={base:UO,key:"type",typeMap:{opacity:Gge,color:Bge,rotation:jge,size:Jge}},tE=e=>{let t=class extends e{constructor(){super(...arguments),this._vvFactory=new r6e}set visualVariables(i){this._vvFactory.visualVariables=i,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(i,r,s){return this._vvFactory.readVariables(i,r,s)}writeVisualVariables(i,r,s,n){r[s]=this._vvFactory.writeVariables(i,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const i of this.visualVariables)if(i.arcadeRequired)return!0;return!1}hasVisualVariables(i,r){return i?this.getVisualVariablesForType(i,r).length>0:this.getVisualVariablesForType("size",r).length>0||this.getVisualVariablesForType("color",r).length>0||this.getVisualVariablesForType("opacity",r).length>0||this.getVisualVariablesForType("rotation",r).length>0}getVisualVariablesForType(i,r){const s=this.visualVariables;return s?s.filter(n=>n.type===i&&(typeof r=="string"?n.target===r:r!==!1||!n.target)):[]}async collectVVRequiredFields(i,r){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&_h(i,r,n.field),n.normalizationField&&_h(i,r,n.normalizationField),n.valueExpression&&await hl(i,r,n.valueExpression))}};return u([d({types:[s6e],value:null,json:{write:!0}})],t.prototype,"visualVariables",null),u([ke("visualVariables",["visualVariables","rotationType","rotationExpression"])],t.prototype,"readVisualVariables",null),u([Be("visualVariables")],t.prototype,"writeVisualVariables",null),t=u([P("esri.renderers.mixins.VisualVariablesMixin")],t),t},$E={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function n6e(e,t=$E){var a,l;if(!e)return{symbol:null};const{retainId:i=$E.retainId,ignoreDrivers:r=$E.ignoreDrivers,hasLabelingContext:s=$E.hasLabelingContext,retainCIM:n=$E.retainCIM}=t;let o;if(US(e)||e instanceof fw)o=e.clone();else if(e.type==="cim"){const c=(l=(a=e.data)==null?void 0:a.symbol)==null?void 0:l.type;if(c!=="CIMPointSymbol")return{error:new q("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${c||"unknown"}' is unsupported in 3D`,{symbol:e})};o=n?e.clone():L0.fromCIMSymbol(e)}else if(e instanceof Ih)o=_4.fromSimpleLineSymbol(e);else if(e instanceof Lv)o=L0.fromSimpleMarkerSymbol(e);else if(e instanceof b4)o=L0.fromPictureMarkerSymbol(e);else if(e instanceof Dv)o=CO.fromSimpleFillSymbol(e);else{if(!(e instanceof H2))return{error:new q("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${e.type||e.declaredClass}' is unsupported in 3D`,{symbol:e})};o=s?v4.fromTextSymbol(e):L0.fromTextSymbol(e)}if(i&&o.type!=="cim"&&(o.id=e.id),r&&US(o))for(let c=0;c<o.symbolLayers.length;++c)o.symbolLayers.getItemAt(c)._ignoreDrivers=!0;return{symbol:o}}const o6e=["building-scene","integrated-mesh","point-cloud","scene"];function FN(e,t,i,r){const s=Kge(e,{},{context:r,isLabelSymbol:!1});_(s)&&(t[i]=s)}function Cee(e,t,i,r){const s=Kge(e,{},{context:r,isLabelSymbol:!0});_(s)&&(t[i]=s)}function Aee(e){return e instanceof j2||e instanceof fw}function Kge(e,t,i){var a;if(R(e))return null;const{context:r,isLabelSymbol:s}=i,n=r==null?void 0:r.origin,o=r==null?void 0:r.messages;if(n==="web-scene"&&!Aee(e)){const l=n6e(e,{retainCIM:!0,hasLabelingContext:s});return _(l.symbol)?l.symbol.write(t,r):(o==null||o.push(new q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:e,context:r,error:l.error})),null)}return(n==="web-map"||n==="portal-item"&&!o6e.includes((a=r==null?void 0:r.layer)==null?void 0:a.type))&&Aee(e)?(o==null||o.push(new q("symbol:unsupported",`Symbols of type '${e.declaredClass}' are not supported in web maps and portal items. Use 2D symbology and CIMSymbol instead when working with MapView`,{symbol:e,context:r})),null):e.write(t,r)}function h_t(e,t){return HMe(e,null,t)}const kO={types:Yhe,json:{write:{writer:FN},origins:{"web-scene":{types:YQ,write:{writer:FN},read:{reader:U2({types:YQ})}}}}},eye={types:{base:lc,key:"type",typeMap:{"simple-fill":hb.typeMap["simple-fill"],"picture-fill":hb.typeMap["picture-fill"],"polygon-3d":hb.typeMap["polygon-3d"]}},json:{write:{writer:FN},origins:{"web-scene":{type:CO,write:{writer:FN}}}}};var vG;let jy=vG=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new vG({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${e}`}};u([d({type:String,json:{write:!0}})],jy.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],jy.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],jy.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],jy.prototype,"maxValue",void 0),u([d(kO)],jy.prototype,"symbol",void 0),jy=vG=u([P("esri.renderers.support.ClassBreakInfo")],jy);const UN=jy;var _G;const fP=me.getLogger("esri.renderers.ClassBreaksRenderer"),tye="log",gD="percent-of-total",yD="field",mP=new _i({esriNormalizeByLog:tye,esriNormalizeByPercentOfTotal:gD,esriNormalizeByField:yD}),a6e=Qr(UN);let vn=_G=class extends tE(Lg){constructor(e){super(e),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(e,t,i){if(!Array.isArray(e))return;let r=t.minValue;return e.map(s=>{const n=new UN;return n.read(s,i),n.minValue==null&&(n.minValue=r),n.maxValue==null&&(n.maxValue=n.minValue),r=n.maxValue,n})}writeClassBreakInfos(e,t,i,r){const s=e.map(n=>n.write({},r));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),t[i]=s}castField(e){return e==null?e:typeof e=="function"?(fP.error(".field: field must be a string value"),null):pO(e)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let e=this._get("normalizationType");const t=!!this.normalizationField,i=this.normalizationTotal!=null;return t||i?(e=t&&yD||i&&gD||null,t&&i&&fP.warn("warning: both normalizationField and normalizationTotal are set!")):e!==yD&&e!==gD||(e=null),e}set normalizationType(e){this._set("normalizationType",e)}addClassBreakInfo(e,t,i){let r=null;r=typeof e=="number"?new UN({minValue:e,maxValue:t,symbol:Zhe(i)}):a6e(te(e)),this.classBreakInfos.push(r),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(e,t){const i=this.classBreakInfos.length;for(let r=0;r<i;r++){const s=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(s[0]===e&&s[1]===t){this.classBreakInfos.splice(r,1);break}}}getBreakIndex(e,t){return this.valueExpression&&(R(t)||R(t.arcade))&&fP.warn(""),this.valueExpression?this._getBreakIndexForExpression(e,t):this._getBreakIndexForField(e)}async getClassBreakInfo(e,t){let i=t;this.valueExpression&&(R(t)||R(t.arcade))&&(i=ve(F({},i),{arcade:await vf()}));const r=this.getBreakIndex(e,i);return r!==-1?this.classBreakInfos[r]:null}getSymbol(e,t){if(this.valueExpression&&(R(t)||R(t.arcade)))return void fP.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this.getBreakIndex(e,t);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(R(t)||R(t.arcade))){const s=await vf(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=ve(F({},i),{arcade:s})}const r=this.getBreakIndex(e,i);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}getSymbols(){const e=[];return this.classBreakInfos.forEach(t=>{t.symbol&&e.push(t.symbol)}),this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){const e=JSON.stringify(this.backgroundFillSymbol),t=JSON.stringify(this.defaultSymbol),i=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${e}.${t}.${this.classBreakInfos.reduce((r,s)=>r+s.getMeshHash(),"")}.${i}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new _G({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:te(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:te(this.visualVariables),legendOptions:te(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),hl(e,t,this.valueExpression)];_h(e,t,this.field),_h(e,t,this.normalizationField),await Promise.all(i)}_getBreakIndexForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=yt(t,{});let o=this._compiledValueExpression.valueExpression===this.valueExpression?this._compiledValueExpression.compiledFunction:null;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._compiledValueExpression.compiledFunction=o}this._compiledValueExpression.valueExpression=this.valueExpression;const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._getBreakIndexfromInfos(l)}_getBreakIndexForField(e){const t=this.field,i=e.attributes,r=this.normalizationType;let s=parseFloat(i[t]);if(r){const n=this.normalizationTotal,o=parseFloat(i[this.normalizationField]);if(r===tye)s=Math.log(s)*Math.LOG10E;else if(r!==gD||isNaN(n)){if(r===yD&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(e){const t=this.isMaxInclusive;if(e!=null&&typeof e=="number"&&!isNaN(e))for(let i=0;i<this.classBreakInfos.length;i++){const r=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(r[0]<=e&&(t?e<=r[1]:e<r[1]))return i}return-1}_areClassBreaksConsecutive(){const e=this.classBreakInfos,t=e.length;for(let i=1;i<t;i++)if(e[i-1].maxValue!==e[i].minValue)return!1;return!0}};u([d(eye)],vn.prototype,"backgroundFillSymbol",void 0),u([d({type:[UN]})],vn.prototype,"classBreakInfos",void 0),u([ke("classBreakInfos")],vn.prototype,"readClassBreakInfos",null),u([Be("classBreakInfos")],vn.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],vn.prototype,"defaultLabel",void 0),u([d(kO)],vn.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],vn.prototype,"field",void 0),u([Ot("field")],vn.prototype,"castField",null),u([d({type:Boolean})],vn.prototype,"isMaxInclusive",void 0),u([d({type:oS,json:{write:!0}})],vn.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],vn.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],vn.prototype,"normalizationField",void 0),u([d({type:Number,cast:e=>oh(e),json:{write:!0}})],vn.prototype,"normalizationTotal",void 0),u([d({type:mP.apiValues,value:null,json:{type:mP.jsonValues,read:mP.read,write:mP.write}})],vn.prototype,"normalizationType",null),u([ct({classBreaks:"class-breaks"})],vn.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],vn.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],vn.prototype,"valueExpressionTitle",void 0),vn=_G=u([P("esri.renderers.ClassBreaksRenderer")],vn);const iye=vn;class l6e{constructor(t,i){this._storage=new SW,this._storage.maxSize=t,i&&this._storage.registerRemoveFunc("",i)}put(t,i,r){this._storage.put(t,i,r,1)}pop(t){return this._storage.pop(t)}get(t){return this._storage.get(t)}clear(){this._storage.clearAll()}destroy(){this._storage.destroy()}get maxSize(){return this._storage.maxSize}set maxSize(t){this._storage.maxSize=t}}const Ree=me.getLogger("esri.renderers.support.DictionaryLoader"),c6e={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};class JW{constructor(t,i,r){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new l6e(100),this.url=t,this.config=i,this.fieldMap=r}getSymbolFields(){return this._symbolFields}async getSymbolAsync(t,i){let r;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(i));try{r=await this._dictionaryPromise}catch(m){if(Gr(m))return this._dictionaryPromise=null,null}const s={};if(this.fieldMap)for(const m of this._symbolFields){const y=this.fieldMap[m];if(y&&t.attributes[y]!=null){const v=""+t.attributes[y];s[m]=v}else s[m]=""}const n=r(s,i);if(!n||typeof n!="string")return null;const o=xH(n).toString(),a=this._symbolCache.get(o);if(a)return a.catch(()=>{this._symbolCache.pop(o)}),a;const l=n.split(";"),c=[],h=[];for(const m of l)if(m)if(m.includes("po:")){const y=m.substr(3).split("|");if(y.length===3){const v=y[0],w=y[1];let b=y[2];if(w==="DashTemplate")b=b.split(" ").map(S=>Number(S));else if(w==="Color"){const S=new qe(b).toRgba();b=[S[0],S[1],S[2],255*S[3]]}else b=Number(b);h.push({primitiveName:v,propertyName:w,value:b})}}else if(m.includes("|")){for(const y of m.split("|"))if(this._itemNames.has(y)){c.push(y);break}}else this._itemNames.has(m)&&c.push(m);const p=!_(t.geometry)||!t.geometry.hasZ&&t.geometry.type==="point",f=this._cimPartsToCIMSymbol(c,h,p,i);return this._symbolCache.put(o,f,1),f}async fetchResources(t){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void Ree.error("no valid URL!");const i=ur(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:_(t)?t.signal:null}),[{data:r}]=await Promise.all([i,vf()]);if(!r)throw this._dictionaryPromise=null,new q("esri.renderers.DictionaryRenderer","Bad dictionary data!");const s=r.expression,n=r.authoringInfo;this._refSymbolUrlTemplate=this.url+"/"+r.cimRefTemplateUrl,this._itemNames=new Set(r.itemsNames),this._symbolFields=n.symbol;const o={};if(this.config){const l=this.config;for(const c in l)o[c]=l[c]}if(n.configuration)for(const l of n.configuration)o.hasOwnProperty(l.name)||(o[l.name]=l.value);const a=[];if(_(t)&&t.fields&&this.fieldMap)for(const l of this._symbolFields){const c=this.fieldMap[l],h=t.fields.filter(p=>p.name===c);h.length>0&&a.push(ve(F({},h[0]),{name:l}))}return this._dictionaryPromise=tAe(s,_(t)?t.spatialReference:null,a,o).then(l=>{const c={scale:0};return(h,p)=>{const f=l.repurposeFeature({geometry:null,attributes:h});return c.scale=_(p)?p.scale:void 0,l.evaluate({$feature:f,$view:c})}}).catch(l=>(Ree.error("Creating dictinoary expression failed:",l),null)),this._dictionaryPromise}async _cimPartsToCIMSymbol(t,i,r,s){const n=new Array(t.length);for(let l=0;l<t.length;l++)n[l]=this._getSymbolPart(t[l],s);const o=await Promise.all(n),a=this.fieldMap;for(const l of o)rye(l,a);return new V2({data:this._combineSymbolParts(o,i,r)})}async _getSymbolPart(t,i){if(this._ongoingRequests.has(t))return this._ongoingRequests.get(t).then(n=>n.data);const r=this._refSymbolUrlTemplate.replace(/\{itemName\}/gi,t),s=ur(r,F({responseType:"json",query:{f:"json"}},i));this._ongoingRequests.set(t,s);try{return(await s).data}catch(n){throw this._ongoingRequests.delete(t),n}}_combineSymbolParts(t,i,r){if(!t||t.length===0)return null;const s=F({},t[0]);if(t.length>1){s.symbolLayers=[];for(const n of t){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return r&&(s.callout=c6e),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:i}}}function rye(e,t){if(!e)return;const i=e.symbolLayers;if(!i)return;let r=i.length;for(;r--;){const s=i[r];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&u6e(s,t)}}function u6e(e,t){const i=e.markerGraphics;if(i)for(const r of i){if(!r)continue;const s=r.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":rye(s,t);break;case"CIMTextSymbol":s.fieldMap=t}}}var d_t=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",DictionaryLoader:JW}),bG;let nd=bG=class extends tE(Lg){constructor(e){super(e),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new JW(this.url,this.config,this.fieldMap)}writeData(e,t){e&&(t.scalingExpressionInfo={expression:e,returnType:"number"})}writeVisualVariables(e,t,i,r){(r==null?void 0:r.origin)||super.writeVisualVariables(e,t,i,r)}clone(){return new bG({config:te(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:te(this.fieldMap),url:te(this.url),visualVariables:te(this.visualVariables)})}async getSymbolAsync(e,t){return this._loader.getSymbolAsync(e,t)}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t),this.scaleExpression&&await hl(e,t,this.scaleExpression);for(const i in this.fieldMap){const r=this.fieldMap[i];t.has(r)&&e.add(r)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:JW})],nd.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],nd.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],nd.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],nd.prototype,"scaleExpression",void 0),u([Be("scaleExpression")],nd.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(e){return{enabled:!!e&&!!this.scaleExpression}}}}})],nd.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],nd.prototype,"url",void 0),u([Be("visualVariables")],nd.prototype,"writeVisualVariables",null),nd=bG=u([P("esri.renderers.DictionaryRenderer")],nd);const h6e=nd;var wG;const d6e=me.getLogger("esri.renderers.support.AttributeColorInfo");let _m=wG=class extends fe{constructor(e){super(e),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(e){return e==null?e:typeof e=="function"?(d6e.error(".field: field must be a string value"),null):pO(e)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new wG({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:qe,json:{type:[Number],write:!0}})],_m.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],_m.prototype,"field",void 0),u([Ot("field")],_m.prototype,"castField",null),u([d({type:String,json:{write:!0}})],_m.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],_m.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],_m.prototype,"valueExpressionTitle",void 0),_m=wG=u([P("esri.renderers.support.AttributeColorInfo")],_m);const sye=_m;var xG;let vD=xG=class extends fe{constructor(){super(...arguments),this.unit=null}clone(){return new xG({unit:this.unit})}};u([d({type:String,json:{write:!0}})],vD.prototype,"unit",void 0),vD=xG=u([P("esri.renderers.support.DotDensityLegendOptions")],vD);const p6e=vD;var TG;let na=TG=class extends tE(Lg){constructor(e){super(e),this.attributes=null,this.backgroundColor=new qe([0,0,0,0]),this.blendDots=!0,this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new Ih,this.dotValue=null,this.referenceDotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(e){if(this.referenceScale==null)return this.dotValue;const t=e/this.referenceScale*this.dotValue;return t<1?1:t}getSymbol(){return new Dv({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes&&this.attributes.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new TG({attributes:te(this.attributes),backgroundColor:te(this.backgroundColor),dotBlendingEnabled:te(this.dotBlendingEnabled),dotShape:te(this.dotShape),dotSize:te(this.dotSize),dotValue:te(this.dotValue),legendOptions:te(this.legendOptions),outline:te(this.outline),referenceScale:te(this.referenceScale),visualVariables:te(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){return`${this.attributes.map(e=>e.field||e.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const i of this.attributes)i.valueExpression&&await hl(e,t,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[sye],json:{write:!0}})],na.prototype,"attributes",void 0),u([d({type:qe,json:{write:!0}})],na.prototype,"backgroundColor",void 0),u([d({type:Boolean}),wt("dotBlendingEnabled")],na.prototype,"blendDots",void 0),u([d({type:Boolean,json:{write:!0}})],na.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],na.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1}}}})],na.prototype,"dotSize",void 0),u([d({type:p6e,json:{write:!0}})],na.prototype,"legendOptions",void 0),u([d({type:Ih,json:{default:null,write:!0}})],na.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],na.prototype,"dotValue",void 0),u([d({type:Number}),wt("dotValue")],na.prototype,"referenceDotValue",void 0),u([d({type:Number,json:{write:!0}})],na.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],na.prototype,"seed",void 0),u([ct({dotDensity:"dot-density"})],na.prototype,"type",void 0),na=TG=u([P("esri.renderers.DotDensityRenderer")],na);const f6e=na;let Gx=class extends oc(fe){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};u([d({type:String,json:{write:!0}})],Gx.prototype,"minLabel",void 0),u([d({type:String,json:{write:!0}})],Gx.prototype,"maxLabel",void 0),u([d({type:String,json:{write:!0}})],Gx.prototype,"title",void 0),Gx=u([P("esri.renderers.support.HeatmapLegendOptions")],Gx);const KW=2.4;function m6e(e){return uu(e*KW)}function g6e(e){return Jn(e)/KW}function y6e(e,t,i,r){let{color:s,ratio:n}=t,{color:o,ratio:a}=i;a===n&&(a===1?n-=1e-6:a+=1e-6);const l=$e((r-n)/(a-n),0,1);ZF(e,s.toArray(),o.toArray(),l)}function p_t(e){const i=new Uint8ClampedArray(2048);if(e=e.filter(({ratio:a})=>a>=0&&a<=1).sort((a,l)=>a.ratio-l.ratio).map(({color:a,ratio:l})=>({color:a,ratio:Math.max(l,.001)})),e.length<1)return i;let r=e[0],s=e[0],n=1;const o=Gt();for(let a=0;a<512;a++){const l=(a+.5)/512;for(;l>s.ratio&&n<e.length;)r=s,s=e[n++];y6e(o,r,s,l),i.set(o,4*a)}return i}function f_t(e,t,i,r){const{radius:s,fieldOffset:n,field:o}=t,a=Math.round(Jn(s)),l=new Float64Array(i*r);let c,h=Number.NEGATIVE_INFINITY;const p=_6e(o,n),f=new Set;for(const m of e){const y=m.getCursor();for(;y.next();){const v=y.getObjectId();if(f.has(v))continue;f.add(v);const w=y.readLegacyPointGeometry(),b=128;if(w.x<-b||w.x>=i+b||w.y<-b||w.y>r+b)continue;const S=+p(y),T=Math.max(0,Math.round(w.x)-a),E=Math.max(0,Math.round(w.y)-a),C=Math.min(r,Math.round(w.y)+a),M=Math.min(i,Math.round(w.x)+a);for(let I=E;I<C;I++)for(let N=T;N<M;N++){const D=I*i+N,z=v6e(w.x-N,w.y-I,a);c=l[D]+=z*S,c>h&&(h=c)}}}return{matrix:l.buffer,max:h}}function v6e(e,t,i){const r=Math.sqrt(e**2+t**2)/i;return r>1?0:3/(Math.PI*i**2)*(1-r**2)**2}function m_t(e,t){return typeof e=="function"?e:e?typeof t=="string"?i=>-1*+i[e]:i=>+i[e]+t:()=>1}function _6e(e,t){return e!=null?typeof t=="string"?i=>-1*+i.readAttribute(e):i=>+i.readAttribute(e)+t:i=>1}var SG;const b6e=me.getLogger("esri.renderers.HeatmapRenderer");function Mee(e){if(e!=null){const{maxDensity:i,minDensity:r,radius:s}=e;if(i!=null||r!=null||s!=null){const t=e,{blurRadius:n,maxPixelIntensity:o,minPixelIntensity:a}=t;return C3(t,["blurRadius","maxPixelIntensity","minPixelIntensity"])}}return e}let Fn=SG=class extends Lg{constructor(e){super(e),this.authoringInfo=null,this.colorStops=[new aR({ratio:0,color:new qe("rgba(255, 140, 0, 0)")}),new aR({ratio:.75,color:new qe("rgba(255, 140, 0, 1)")}),new aR({ratio:.9,color:new qe("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(e){return Mee(e)}get blurRadius(){return g6e(this.radius)}set blurRadius(e){const t=this.maxPixelIntensity,i=this.minPixelIntensity;this._set("radius",m6e(e)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",t*this._pixelIntensityToDensity),this._set("minDensity",i*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(e){this._set("maxDensity",e*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(e){this._set("minDensity",e*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(KW**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(e,t){this._warnedProps[e]||Ea(this).getDefaultOrigin()==="user"&&(this._warnedProps[e]=!0,F2(()=>{D2e(b6e,e,{replacement:`${String(t)} (suggested value: ${this._get(t)})`,version:"4.24"})}))}read(e,t){e=Mee(e),super.read(e,t)}getSymbol(){const e=this.referenceScale!==0?5:1,t=Math.min(this.radius*e,uu(256));return new Lv({size:t})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(e,t){const i=this.field,r=this.valueExpression;i&&typeof i=="string"&&await _h(e,t,i),r&&typeof r=="string"&&await hl(e,t,r)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new SG({colorStops:te(this.colorStops),field:this.field,legendOptions:te(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:zge,json:{write:!1}})],Fn.prototype,"authoringInfo",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Fn.prototype,"blurRadius",null),u([d({type:[aR],json:{write:!0}})],Fn.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],Fn.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(e,t,i)=>({enabled:i==null})},origins:{"web-scene":{write:!1}}}})],Fn.prototype,"fieldOffset",void 0),u([d({type:Gx,json:{write:!0}})],Fn.prototype,"legendOptions",void 0),u([d({type:Number,json:{write:!0}})],Fn.prototype,"maxDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Fn.prototype,"maxPixelIntensity",null),u([d({type:Number,json:{write:!0}})],Fn.prototype,"minDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Fn.prototype,"minPixelIntensity",null),u([d({type:Number,cast:Zi,json:{write:!0}})],Fn.prototype,"radius",void 0),u([d({type:Number,range:{min:0},json:{default:0,write:!0}})],Fn.prototype,"referenceScale",void 0),u([ct({heatmap:"heatmap"})],Fn.prototype,"type",void 0),u([d({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],Fn.prototype,"valueExpression",void 0),u([d({type:String})],Fn.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],Fn.prototype,"_pixelIntensityToDensity",null),Fn=SG=u([P("esri.renderers.HeatmapRenderer")],Fn);const nye=Fn;let D1=class extends oc(fe){constructor(){super(...arguments),this.color=new qe([0,0,0,0]),this.label=null,this.threshold=0}};u([d({type:qe,json:{write:!0}})],D1.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],D1.prototype,"label",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],D1.prototype,"threshold",void 0),D1=u([P("esri.renderers.support.OthersCategory")],D1);let _D=class extends oc(fe){constructor(){super(...arguments),this.title=null}};u([d({type:String,json:{write:!0}})],_D.prototype,"title",void 0),_D=u([P("esri.renderers.support.PieChartLegendOptions")],_D);let Ec=class extends tE(oc(Lg)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new qe([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new D1,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){var e;return new Lv({size:this.size?this.size/2+(((e=this.outline)==null?void 0:e.width)||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,t)=>e+JSON.stringify(t),"")}async collectRequiredFields(e,t){await this.collectVVRequiredFields(e,t);for(const i of this.attributes)i.valueExpression&&await hl(e,t,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[sye],json:{write:!0}})],Ec.prototype,"attributes",void 0),u([d({type:Dv,json:{default:null,write:!0}})],Ec.prototype,"backgroundFillSymbol",void 0),u([d({type:qe,json:{write:!0}})],Ec.prototype,"defaultColor",void 0),u([d({type:String,json:{write:!0}})],Ec.prototype,"defaultLabel",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],Ec.prototype,"holePercentage",void 0),u([d({type:D1,json:{write:!0}})],Ec.prototype,"othersCategory",void 0),u([d({type:_D,json:{write:!0}})],Ec.prototype,"legendOptions",void 0),u([d({type:Ih,json:{default:null,write:!0}})],Ec.prototype,"outline",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Ec.prototype,"size",void 0),u([ct({pieChart:"pie-chart"})],Ec.prototype,"type",void 0),Ec=u([P("esri.renderers.PieChartRenderer")],Ec);const w6e=Ec;var EG;let K_=EG=class extends tE(Lg){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(e,t){await Promise.all([this.collectSymbolFields(e,t),this.collectVVRequiredFields(e,t)])}async collectSymbolFields(e,t){await Promise.all(this.getSymbols().map(i=>i.collectRequiredFields(e,t)))}getSymbol(e,t){return this.symbol}async getSymbolAsync(e,t){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,t)=>e+JSON.stringify(t),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new EG({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:te(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],K_.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],K_.prototype,"label",void 0),u([d(kO)],K_.prototype,"symbol",void 0),u([ct({simple:"simple"})],K_.prototype,"type",void 0),K_=EG=u([P("esri.renderers.SimpleRenderer")],K_);const eX=K_,x6e=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function CG(e){return e instanceof Ee}function Oee(e){return e instanceof at?Object.keys(e.items):CG(e)?Ea(e).keys():e?Object.keys(e):[]}function gP(e,t){return e instanceof at?e.items[t]:e[t]}function T6e(e,t){return!(!Array.isArray(e)||!Array.isArray(t))&&e.length!==t.length}function dR(e){return e?e.declaredClass:null}function oye(e,t){const i=e.diff;if(i&&typeof i=="function")return i(e,t);const r=Oee(e),s=Oee(t);if(r.length===0&&s.length===0)return;if(!r.length||!s.length||T6e(e,t))return{type:"complete",oldValue:e,newValue:t};const n=s.filter(p=>!r.includes(p)),o=r.filter(p=>!s.includes(p)),a=r.filter(p=>s.includes(p)&&gP(e,p)!==gP(t,p)).concat(n,o).sort(),l=dR(e);if(l&&x6e.includes(l)&&a.length)return{type:"complete",oldValue:e,newValue:t};let c;const h=CG(e)&&CG(t);for(const p of a){const f=gP(e,p),m=gP(t,p);let y;if((h||typeof f!="function"&&typeof m!="function")&&f!==m&&(f!=null||m!=null)){if(i&&i[p]&&typeof i[p]=="function")y=i[p](f,m);else if(f instanceof Date&&m instanceof Date){if(f.getTime()===m.getTime())continue;y={type:"complete",oldValue:f,newValue:m}}else y=typeof f=="object"&&typeof m=="object"&&dR(f)===dR(m)?oye(f,m):{type:"complete",oldValue:f,newValue:m};_(y)&&(_(c)?c.diff[p]=y:c={type:"partial",diff:{[p]:y}})}}return c}function S6e(e,t){if(R(e))return!1;const i=t.split(".");let r=e;for(const s of i){if(r.type==="complete")return!0;if(r.type!=="partial")return!1;{const n=r.diff[s];if(!n)return!1;r=n}}return!0}function g_t(e,t){for(const i of t)if(S6e(e,i))return!0;return!1}function E6e(e,t){if(!(typeof e=="function"||typeof t=="function"||R(e)&&R(t)))return R(e)||R(t)||typeof e=="object"&&typeof t=="object"&&dR(e)!==dR(t)?{type:"complete",oldValue:e,newValue:t}:oye(e,t)}function yP(e){if(R(e))return!0;switch(e.type){case"complete":return!1;case"collection":{const t=e;for(const i of t.added)if(!yP(i))return!1;for(const i of t.removed)if(!yP(i))return!1;for(const i of t.changed)if(!yP(i))return!1;return!0}case"partial":for(const t in e.diff)if(!yP(e.diff[t]))return!1;return!0}}var AG;let Hy=AG=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.value=null}castValue(e){return e==null||typeof e=="string"||typeof e=="number"?e:`${e}`}clone(){return new AG({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const e=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${e}`}};u([d({type:String,json:{write:!0}})],Hy.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Hy.prototype,"label",void 0),u([d(kO)],Hy.prototype,"symbol",void 0),u([d({json:{type:String,write:{writer:(e,t)=>{t.value=e==null?void 0:e.toString()}}}})],Hy.prototype,"value",void 0),u([Ot("value")],Hy.prototype,"castValue",null),Hy=AG=u([P("esri.renderers.support.UniqueValueInfo")],Hy);const kN=Hy,C6e=()=>!!he("enable-feature:force-wosr"),y_t=()=>!!he("enable-feature:direct-3d-object-feature-layer-display"),e6={};async function A6e(e,t){try{return{data:(await P6e(e,t)).data,baseUrl:jRe(e),styleUrl:e}}catch(i){return Pg(i),null}}function R6e(e,t,i){const r=_(t.portal)?t.portal:Kn.getDefault();let s;const n=`${r.url} - ${r.user&&r.user.username} - ${e}`;return e6[n]||(e6[n]=M6e(e,r,i).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl,styleName:e}))),e6[n]}function M6e(e,t,i){return t.load(i).then(()=>{const r=new Wm({disableExtraQuery:!0,query:`owner:${Pee} AND type:${Iee} AND typekeywords:"${e}"`});return t.queryItems(r,i)}).then(({results:r})=>{let s=null;const n=e.toLowerCase();if(r&&Array.isArray(r)){for(const o of r)if(o.typeKeywords.some(a=>a.toLowerCase()===n)&&o.type===Iee&&o.owner===Pee){s=o;break}}if(!s)throw new q("symbolstyleutils:style-not-found",`The style '${e}' could not be found`,{styleName:e});return s.load(i)})}function O6e(e,t,i){return e.styleUrl?A6e(e.styleUrl,i):e.styleName?R6e(e.styleName,t,i):Promise.reject(new q("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function v_t(e){return e===null||e.type==="CIMSymbolReference"?e:{type:"CIMSymbolReference",symbol:e}}function __t(e,t){if(t==="cimRef")return e.cimRef;if(e.formatInfos&&!C6e()){for(const i of e.formatInfos)if(i.type==="gltf")return i.href}return e.webRef}function P6e(e,t){const i=F({responseType:"json",query:{f:"json"}},t);return ur(bh(e),i)}const Pee="esri_en",Iee="Style",b_t="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var dA;const Jv=me.getLogger("esri.renderers.UniqueValueRenderer"),I6e=Qr(kN);let ws=dA=class extends tE(Lg){constructor(e){super(e),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this.type="unique-value",this.backgroundFillSymbol=null,this.field=null,this.field2=null,this.field3=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.fieldDelimiter=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(t,i){if(!t&&!i)return;if(!t||!i)return{type:"complete",oldValue:t,newValue:i};let r=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<i.length;n++){const o=t.find(a=>a.value===i[n].value);o?E6e(o,i[n])?(s.changed.push({type:"complete",oldValue:o,newValue:i[n]}),r=!0):s.unchanged.push({oldValue:o,newValue:i[n]}):(s.added.push(i[n]),r=!0)}for(let n=0;n<t.length;n++)i.find(o=>o.value===t[n].value)||(s.removed.push(t[n]),r=!0);return r?s:void 0}},this._set("uniqueValueInfos",[])}get _cache(){return{compiledFunc:null}}castField(e){return e==null||typeof e=="function"?e:pO(e)}writeField(e,t,i,r){typeof e=="string"?t[i]=e:r&&r.messages?r.messages.push(new q("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):Jv.error(".field: cannot write field to JSON since it's not a string value")}set defaultSymbol(e){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",e)}readPortal(e,t,i){return i.portal||Kn.getDefault()}readStyleOrigin(e,t,i){if(t.styleName)return Object.freeze({styleName:t.styleName});if(t.styleUrl){const r=G2(t.styleUrl,i);return Object.freeze({styleUrl:r})}}writeStyleOrigin(e,t,i,r){e.styleName?t.styleName=e.styleName:e.styleUrl&&(t.styleUrl=Ib(e.styleUrl,r))}set uniqueValueInfos(e){this.styleOrigin?Jv.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",e),this._updateValueInfoMap())}addUniqueValueInfo(e,t){if(this.styleOrigin)return void Jv.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let i;i=typeof e=="object"?I6e(e):new kN({value:e,symbol:Zhe(t)}),this.uniqueValueInfos.push(i),this._valueInfoMap[i.value]=i}removeUniqueValueInfo(e){if(this.styleOrigin)Jv.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");else for(let t=0;t<this.uniqueValueInfos.length;t++)if(this.uniqueValueInfos[t].value===e+""){delete this._valueInfoMap[e],this.uniqueValueInfos.splice(t,1);break}}async getUniqueValueInfo(e,t){let i=t;return this.valueExpression&&(R(t)||R(t.arcade))&&(i=ve(F({},i),{arcade:await vf()})),this._getUniqueValueInfo(e,i)}getSymbol(e,t){if(this.valueExpression&&(R(t)||R(t.arcade)))return void Jv.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const i=this._getUniqueValueInfo(e,t);return i&&i.symbol||this.defaultSymbol}async getSymbolAsync(e,t){let i=t;if(this.valueExpression&&(R(i)||R(i.arcade))){const s=await vf(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),i=ve(F({},i),{arcade:s})}const r=this._getUniqueValueInfo(e,i);return r&&r.symbol||this.defaultSymbol}getSymbols(){const e=[];for(const t of this.uniqueValueInfos)t.symbol&&e.push(t.symbol);return this.defaultSymbol&&e.push(this.defaultSymbol),e}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,t)=>e+t.getAttributeHash(),"")}getMeshHash(){return`${JSON.stringify(this.backgroundFillSymbol)}.${JSON.stringify(this.defaultSymbol)}.${this.uniqueValueInfos.reduce((e,t)=>e+t.getMeshHash(),"")}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const e=new dA({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:te(this.defaultSymbol),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:te(this.visualVariables),legendOptions:te(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:te(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(e._isDefaultSymbolDerived=!0),e._set("portal",this.portal);const t=te(this.uniqueValueInfos);return this.styleOrigin&&(e._set("styleOrigin",Object.freeze(te(this.styleOrigin))),Object.freeze(t)),e._set("uniqueValueInfos",t),e._updateValueInfoMap(),e}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(e,t){const i=[this.collectVVRequiredFields(e,t),this.collectSymbolFields(e,t)];await Promise.all(i)}async collectSymbolFields(e,t){const i=[...this.getSymbols().map(r=>r.collectRequiredFields(e,t)),hl(e,t,this.valueExpression)];_h(e,t,this.field),_h(e,t,this.field2),_h(e,t,this.field3),await Promise.all(i)}populateFromStyle(){return O6e(this.styleOrigin,{portal:this.portal}).then(e=>{const t=[];return this._valueInfoMap={},e&&e.data&&Array.isArray(e.data.items)&&e.data.items.forEach(i=>{const r=new fw({styleUrl:e.styleUrl,styleName:e.styleName,portal:this.portal,name:i.name});this.defaultSymbol||i.name!==e.data.defaultItem||(this.defaultSymbol=r,this._isDefaultSymbolDerived=!0);const s=new kN({value:i.name,symbol:r});t.push(s),this._valueInfoMap[i.name]=s}),this._set("uniqueValueInfos",Object.freeze(t)),!this.defaultSymbol&&this.uniqueValueInfos.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateValueInfoMap(){this._valueInfoMap={},this.uniqueValueInfos.forEach(e=>this._valueInfoMap[e.value+""]=e)}_getUniqueValueInfo(e,t){return this.valueExpression?this._getUnqiueValueInfoForExpression(e,t):this._getUnqiueValueInfoForFields(e)}_getUnqiueValueInfoForExpression(e,t){const{viewingMode:i,scale:r,spatialReference:s,arcade:n}=yt(t,{});let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(e,a.getViewInfo({viewingMode:i,scale:r,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(e){const t=this.field,i=e.attributes;let r;if(typeof t!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];t&&o.push(i[t]),s&&o.push(i[s]),n&&o.push(i[n]),r=o.join(this.fieldDelimiter||"")}else typeof t=="function"?r=t(e):t&&(r=i[t]);return this._valueInfoMap[r+""]}static fromPortalStyle(e,t){const i=new dA(t&&t.properties);i._set("styleOrigin",Object.freeze({styleName:e})),i._set("portal",t&&t.portal||Kn.getDefault());const r=i.populateFromStyle();return r.catch(s=>{Jv.error(`#fromPortalStyle('${e}'[, ...])`,"Failed to create unique value renderer from style name",s)}),r}static fromStyleUrl(e,t){const i=new dA(t&&t.properties);i._set("styleOrigin",Object.freeze({styleUrl:e}));const r=i.populateFromStyle();return r.catch(s=>{Jv.error(`#fromStyleUrl('${e}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),r}};u([d({readOnly:!0})],ws.prototype,"_cache",null),u([ct({uniqueValue:"unique-value"})],ws.prototype,"type",void 0),u([d(eye)],ws.prototype,"backgroundFillSymbol",void 0),u([d({json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],ws.prototype,"field",void 0),u([Ot("field")],ws.prototype,"castField",null),u([Be("field")],ws.prototype,"writeField",null),u([d({type:String,json:{write:!0}})],ws.prototype,"field2",void 0),u([d({type:String,json:{write:!0}})],ws.prototype,"field3",void 0),u([d({type:String,json:{write:!0}})],ws.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],ws.prototype,"valueExpressionTitle",void 0),u([d({type:oS,json:{write:!0}})],ws.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],ws.prototype,"defaultLabel",void 0),u([d(Jle(F({},kO),{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],ws.prototype,"defaultSymbol",null),u([d({type:String,json:{write:!0}})],ws.prototype,"fieldDelimiter",void 0),u([d({type:Kn,readOnly:!0})],ws.prototype,"portal",void 0),u([ke("portal",["styleName"])],ws.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],ws.prototype,"styleOrigin",void 0),u([ke("styleOrigin",["styleName","styleUrl"])],ws.prototype,"readStyleOrigin",null),u([Be("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],ws.prototype,"writeStyleOrigin",null),u([d({type:[kN],json:{write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],ws.prototype,"uniqueValueInfos",null),ws=dA=u([P("esri.renderers.UniqueValueRenderer")],ws);const tX=ws,n5={key:"type",base:Lg,typeMap:{heatmap:nye,simple:eX,"unique-value":tX,"class-breaks":iye,"dot-density":f6e,dictionary:h6e,"pie-chart":w6e},errorContext:"renderer"},$6e={key:"type",base:Lg,typeMap:{simple:eX,"unique-value":tX,"class-breaks":iye,heatmap:nye},errorContext:"renderer"},D6e=U2({types:n5});function L6e(e,t,i){return e?e&&(e.styleName||e.styleUrl)&&e.type!=="uniqueValue"?(i&&i.messages&&i.messages.push(new lu("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+e.type+"'",{definition:e,context:i})),null):D6e(e,t,i):null}class iX{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(d8),this._values=new Map,this.multipleOriginsSupported=!0}clone(t){const i=new iX,r=this._originStores[Si.DEFAULTS];r&&r.forEach((s,n)=>{i.set(n,te(s),Si.DEFAULTS)});for(let s=Si.SERVICE;s<d8;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{t&&t.has(a)||i.set(a,te(o),s)})}return i}get(t,i){const r=i===void 0?this._values:this._originStores[i];return r?r.get(t):void 0}keys(t){const i=t==null?this._values:this._originStores[t];return i?[...i.keys()]:[]}set(t,i,r=Si.USER){let s=this._originStores[r];if(s||(s=new Map,this._originStores[r]=s),s.set(t,i),!this._values.has(t)||this._propertyOriginMap.get(t)<=r){const n=this._values.get(t);return this._values.set(t,i),this._propertyOriginMap.set(t,r),n!==i}return!1}delete(t,i=Si.USER){const r=this._originStores[i];if(!r)return;const s=r.get(t);if(r.delete(t),this._values.has(t)&&this._propertyOriginMap.get(t)===i){this._values.delete(t);for(let n=i-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(t)){this._values.set(t,o.get(t)),this._propertyOriginMap.set(t,n);break}}}return s}has(t,i){const r=i===void 0?this._values:this._originStores[i];return!!r&&r.has(t)}revert(t,i){for(;i>0&&!this.has(t,i);)--i;const r=this._originStores[i],s=r&&r.get(t),n=this._values.get(t);return this._values.set(t,s),this._propertyOriginMap.set(t,i),n!==s}originOf(t){return this._propertyOriginMap.get(t)||Si.DEFAULTS}forEach(t){this._values.forEach(t)}}const aye=e=>{let t=class extends e{constructor(...i){super(...i);const r=Ea(this),s=r.store,n=new iX;r.store=n,Bce(r,s,n)}read(i,r){jce(this,i,r)}getAtOrigin(i,r){const s=t6(this),n=P0(r);if(typeof i=="string")return s.get(i,n);const o={};return i.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(i){return YL(this.originIdOf(i))}originIdOf(i){return t6(this).originOf(i)}revert(i,r){const s=t6(this),n=P0(r),o=Ea(this);let a;a=typeof i=="string"?i==="*"?s.keys(n):[i]:i,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return t=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],t),t};function t6(e){return Ea(e).store}let $ee=class extends aye(Ee){};$ee=u([P("esri.core.ReadOnlyMultiOriginJSONSupport")],$ee);const N6e=e=>{let t=class extends e{constructor(...i){super(...i)}clear(i,r="user"){return i6(this).delete(i,P0(r))}write(i={},r){return Wce(this,i=i||{},r),i}setAtOrigin(i,r,s){Ea(this).setAtOrigin(i,r,P0(s))}removeOrigin(i){const r=i6(this),s=P0(i),n=r.keys(s);for(const o of n)r.originOf(o)===s&&r.set(o,r.get(o,s),Si.USER)}updateOrigin(i,r){const s=i6(this),n=P0(r),o=this.get(i);for(let a=n+1;a<d8;++a)s.delete(i,a);s.set(i,o,n)}toJSON(i){return this.write({},i)}};return t=u([P("esri.core.WriteableMultiOriginJSONSupport")],t),t.prototype.toJSON.isDefaultToJSON=!0,t};function i6(e){return Ea(e).store}const rX=e=>{let t=class extends N6e(aye(e)){constructor(...i){super(...i)}};return t=u([P("esri.core.MultiOriginJSONSupport")],t),t};let RG=class extends rX(Ee){};RG=u([P("esri.core.MultiOriginJSONSupport")],RG);async function F6e(e,t){const{WhereClause:i}=await import("./WhereClause.6eb5053b.js");return i.create(e,t)}function U6e(e,t){return _(e)?_(t)?`(${e}) AND (${t})`:e:t}var MG;let e1=MG=class extends fe{constructor(e){super(e),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new MG({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],e1.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],e1.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],e1.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],e1.prototype,"title",void 0),e1=MG=u([P("esri.form.ExpressionInfo")],e1);const k6e=e1;let t1=class extends fe{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],t1.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],t1.prototype,"label",void 0),u([d()],t1.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],t1.prototype,"visibilityExpression",void 0),t1=u([P("esri.form.elements.Element")],t1);const JS=t1;var OG;let bD=OG=class extends fe{constructor(e){super(e),this.type=null}clone(){return new OG({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],bD.prototype,"type",void 0),bD=OG=u([P("esri.form.elements.inputs.AttachmentInput")],bD);const z6e=bD;var PG;let i1=PG=class extends JS{constructor(e){super(e),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new PG({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],i1.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],i1.prototype,"editable",void 0),u([d({type:z6e,json:{read:{source:"inputType"},write:{target:"inputType"}}})],i1.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],i1.prototype,"type",void 0),i1=PG=u([P("esri.form.elements.AttachmentElement")],i1);const Dee=i1;let wD=class extends fe{constructor(e){super(e),this.type=null}};u([d()],wD.prototype,"type",void 0),wD=u([P("esri.form.elements.inputs.Input")],wD);const iE=wD;let pA=class extends iE{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],pA.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],pA.prototype,"minLength",void 0),pA=u([P("esri.form.elements.inputs.TextInput")],pA);const sX=pA;var IG;let xD=IG=class extends sX{constructor(e){super(e),this.type="barcode-scanner"}clone(){return new IG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],xD.prototype,"type",void 0),xD=IG=u([P("esri.form.elements.inputs.BarcodeScannerInput")],xD);const V6e=xD;var $G;let jx=$G=class extends iE{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="combo-box"}clone(){return new $G({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],jx.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],jx.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],jx.prototype,"type",void 0),jx=$G=u([P("esri.form.elements.inputs.ComboBoxInput")],jx);const B6e=jx;var DG;function Lee(e){return e!=null?new Date(e):null}function Nee(e){return e?e.getTime():null}let od=DG=class extends iE{constructor(e){super(e),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(e,t){return Lee(t.max)}writeMax(e,t){t.max=Nee(e)}readMin(e,t){return Lee(t.min)}writeMin(e,t){t.min=Nee(e)}clone(){return new DG({includeTime:this.includeTime,max:this.max,min:this.min,type:this.type})}};u([d({type:Boolean,json:{write:!0}})],od.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],od.prototype,"max",void 0),u([ke("max")],od.prototype,"readMax",null),u([Be("max")],od.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],od.prototype,"min",void 0),u([ke("min")],od.prototype,"readMin",null),u([Be("min")],od.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],od.prototype,"type",void 0),od=DG=u([P("esri.form.elements.inputs.DateTimePickerInput")],od);const G6e=od;var LG;let Hx=LG=class extends iE{constructor(e){super(e),this.noValueOptionLabel=null,this.showNoValueOption=!1,this.type="radio-buttons"}clone(){return new LG({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],Hx.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],Hx.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],Hx.prototype,"type",void 0),Hx=LG=u([P("esri.form.elements.inputs.RadioButtonsInput")],Hx);const j6e=Hx;var NG;let qx=NG=class extends iE{constructor(e){super(e),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new NG({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],qx.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],qx.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],qx.prototype,"type",void 0),qx=NG=u([P("esri.form.elements.inputs.SwitchInput")],qx);const H6e=qx;var FG;let TD=FG=class extends sX{constructor(e){super(e),this.type="text-area"}clone(){return new FG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],TD.prototype,"type",void 0),TD=FG=u([P("esri.form.elements.inputs.TextAreaInput")],TD);const q6e=TD;var UG;let SD=UG=class extends sX{constructor(e){super(e),this.type="text-box"}clone(){return new UG({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],SD.prototype,"type",void 0),SD=UG=u([P("esri.form.elements.inputs.TextBoxInput")],SD);const W6e=SD,X6e={base:iE,key:"type",typeMap:{"barcode-scanner":V6e,"combo-box":B6e,"datetime-picker":G6e,"radio-buttons":j6e,switch:H6e,"text-area":q6e,"text-box":W6e}};var kG;let zu=kG=class extends JS{constructor(e){super(e),this.domain=null,this.editable=!0,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}clone(){return new kG({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:lme,json:{read:{reader:EW},write:!0}})],zu.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],zu.prototype,"editable",void 0),u([d({type:String,json:{write:!0}})],zu.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],zu.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],zu.prototype,"hint",void 0),u([d({types:X6e,json:{read:{source:"inputType"},write:{target:"inputType"}}})],zu.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],zu.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],zu.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],zu.prototype,"valueExpression",void 0),zu=kG=u([P("esri.form.elements.FieldElement")],zu);const Fee=zu;var zG;let bm=zG=class extends JS{constructor(e){super(e),this.displayCount=null,this.displayType="list",this.editable=!0,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new zG({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editable:this.editable,label:this.label,orderByFields:te(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],bm.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],bm.prototype,"displayType",void 0),u([d({type:Boolean,json:{write:!0}})],bm.prototype,"editable",void 0),u([d({type:[Gue],json:{write:!0}})],bm.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],bm.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],bm.prototype,"type",void 0),bm=zG=u([P("esri.form.elements.RelationshipElement")],bm);const Uee=bm;function lye(e){return{typesWithGroup:{base:JS,key:"type",typeMap:{attachment:Dee,field:Fee,group:e,relationship:Uee}},typesWithoutGroup:{base:JS,key:"type",typeMap:{attachment:Dee,field:Fee,relationship:Uee}}}}function cye(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>r[s.type].fromJSON(s))}function uye(e,t,i=!0){if(!e)return null;const r=i?t.typesWithGroup.typeMap:t.typesWithoutGroup.typeMap;return e.filter(s=>r[s.type]).map(s=>s.toJSON())}function hye(e,t,i=!0){return e?e.map(r=>qd(i?t.typesWithGroup:t.typesWithoutGroup,r)):null}var VG;let Hp=VG=class extends JS{constructor(e){super(e),this.elements=null,this.initialState="expanded",this.type="group"}castElements(e){return hye(e,r6,!1)}readElements(e,t){return cye(t.formElements,r6,!1)}writeElements(e,t){t.formElements=uye(e,r6,!1)}clone(){return new VG({description:this.description,elements:te(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Hp.prototype,"elements",void 0),u([Ot("elements")],Hp.prototype,"castElements",null),u([ke("elements",["formElements"])],Hp.prototype,"readElements",null),u([Be("elements")],Hp.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Hp.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Hp.prototype,"type",void 0),Hp=VG=u([P("esri.form.elements.GroupElement")],Hp);const r6=lye(Hp),Y6e=Hp;var BG;const s6=lye(Y6e);let Op=BG=class extends fe{constructor(e){super(e),this.description=null,this.elements=null,this.expressionInfos=null,this.title=null}castElements(e){return hye(e,s6)}readElements(e,t){return cye(t.formElements,s6)}writeElements(e,t){t.formElements=uye(e,s6)}clone(){return new BG({description:this.description,expressionInfos:te(this.expressionInfos),elements:te(this.elements),title:this.title})}};u([d({type:String,json:{write:!0}})],Op.prototype,"description",void 0),u([d({json:{write:!0}})],Op.prototype,"elements",void 0),u([Ot("elements")],Op.prototype,"castElements",null),u([ke("elements",["formElements"])],Op.prototype,"readElements",null),u([Be("elements")],Op.prototype,"writeElements",null),u([d({type:[k6e],json:{write:!0}})],Op.prototype,"expressionInfos",void 0),u([d({type:String,json:{write:!0}})],Op.prototype,"title",void 0),Op=BG=u([P("esri.form.FormTemplate")],Op);const Z6e=Op,Q6e=me.getLogger("esri.layers.support.fromPortalItem");async function J6e(e){const t="portalItem"in e?e:{portalItem:e},i=await import("./portalLayers.36c54f26.js");try{return await i.fromItem(t)}catch(r){const s=t&&t.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||Ii.portalUrl;throw Q6e.error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",r),r}}let K6e=0,Un=class extends us.EventedMixin(tq(Sf)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new ci(-180,-90,180,90,Xe.WGS84),this.id=Date.now().toString(16)+"-layer-"+K6e++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=Xe.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const t=typeof e=="string"?{url:e}:e;return(await import("./arcgisLayers.7b58f6cd.js")).fromUrl(t)}static fromPortalItem(e){return J6e(e)}initialize(){this.when().catch(e=>{var t,i;Gr(e)||me.getLogger(this.declaredClass).error("#load()",`Failed to load layer (title: '${(t=this.title)!=null?t:"no title"}', id: '${(i=this.id)!=null?i:"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,t=this.parent;"layers"in t&&t.layers.includes(e)?t.layers.remove(e):"tables"in t&&t.tables.includes(e)?t.tables.remove(e):"baseLayers"in t&&t.baseLayers.includes(e)?t.baseLayers.remove(e):"baseLayers"in t&&t.referenceLayers.includes(e)&&t.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){const e=this.url;return e?hn(e):null}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await ur(e,{query:{f:"json"},responseType:"json"})).data;throw new q("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],Un.prototype,"attributionDataUrl",void 0),u([d({type:ci})],Un.prototype,"fullExtent",void 0),u([d({readOnly:!0})],Un.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],Un.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],Un.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],Un.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],Un.prototype,"opacity",void 0),u([d({clonable:!1})],Un.prototype,"parent",void 0),u([d({readOnly:!0})],Un.prototype,"parsedUrl",null),u([d({type:Boolean})],Un.prototype,"popupEnabled",void 0),u([d({type:Boolean})],Un.prototype,"attributionVisible",void 0),u([d({type:Xe})],Un.prototype,"spatialReference",void 0),u([d({type:String})],Un.prototype,"title",void 0),u([d({readOnly:!0,json:{read:!1}})],Un.prototype,"type",void 0),u([d()],Un.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],Un.prototype,"visible",void 0),Un=u([P("esri.layers.Layer")],Un);const hM=Un;function kee(e,t,i){if(e.hasM==null||e.hasZ)for(const r of t)for(const s of r)s.length>2&&(s[2]*=i)}function eze(e,t,i){if(!e&&!t||!i)return;const r=zS(i);zee(e,i,r),zee(t,i,r)}function zee(e,t,i){if(e)for(const r of e)tze(r.geometry,t,i)}function tze(e,t,i){if(R(e)||!e.spatialReference||ac(e.spatialReference,t))return;const r=zS(e.spatialReference)/i;if(r!==1){if("x"in e)e.z!=null&&(e.z*=r);else if("rings"in e)kee(e,e.rings,r);else if("paths"in e)kee(e,e.paths,r);else if("points"in e&&(e.hasM==null||e.hasZ))for(const s of e.points)s.length>2&&(s[2]*=r)}}let ize=0;const n6=me.getLogger("esri.layers.graphics.sources.MemorySource");let Nm=class extends Sf.LoadableMixin(SO(mw(at))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const t=_(e)?e.signal:null;return this.addResolvingPromise(this._startWorker(t)),Promise.resolve(this)}destroy(){var e;(e=this._connection)==null||e.close(),this._connection=null}get workerGeometryType(){var t;const e=(t=this.layer)==null?void 0:t.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,t={}){await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);F9(e,this.layer.spatialReference,i);const r=Q4.fromJSON(i);if(!this._requiresClientGraphicMapping())return r;const s=this.layer.objectIdField;for(const n of r.features){const o=n.attributes[s],a=this._idToClientGraphic.get(o);a&&(n.geometry=a.geometry)}return r.geometryType=this.layer.geometryType,r}async queryFeaturesJSON(e,t={}){if(this._requiresClientGraphicMapping())throw new q("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(t);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,t);return F9(e,this.layer.spatialReference,i),i}queryFeatureCount(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,t))}queryObjectIds(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,t))}queryExtent(e,t={}){return this.load(t).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,t)).then(i=>({count:i.count,extent:ci.fromJSON(i.extent)}))}querySnapping(e,t={}){return this.load(t).then(()=>this._connection.invoke("querySnapping",e,t))}async _applyEdits(e){if(!this._connection)throw new q("feature-layer-source:edit-failure","Memory source not loaded");const t=this.layer.objectIdField;let i=null;const r=[],s=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const n=c=>"objectId"in c&&c.objectId!=null?c.objectId:"attributes"in c&&c.attributes[t]!=null?c.attributes[t]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const c of e.deleteFeatures){const h=n(c);h!=null&&r.push(h)}const o=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const c of e.updateFeatures)if(s.push(this._serializeFeature(c)),o){const h=n(c);h!=null&&o.set(h,c)}}eze(i?i.features:null,s,this.layer.spatialReference);const{fullExtent:a,featureEditResults:l}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:s,deletes:r});return this.fullExtent=a,i&&i.finish(l.uidToObjectId),this._updateClientGraphicIds(o,l),this._createEditsResult(l)}async _prepareClientMapping(e,t){if(this.layerOrSourceGeometryType!=="mesh"||R(e))return;const i=[];for(const{geometry:r}of e)!_(r)||r.type!=="mesh"||r.hasExtent||r.loaded||i.push(r.load({signal:t}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,t){if(this._idToClientGraphic){if(e)for(const i of t.updateResults){if(!i.success)continue;const r=e.get(i.objectId);r!=null&&this._addIdToClientGraphic(r)}for(const i of t.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const t=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:t?new q("feature-layer-source:edit-failure",t.description,{code:t.code}):null}}_prepareAddFeatures(e){const t=new Map,i=new Array(e.length);let r=null;for(let n=0;n<e.length;n++){const o=e[n],a=this._serializeFeature(o);!r&&_(o.geometry)&&(r=o.geometry.type),i[n]=a,t.set(`${a.uid}`,o)}const s=this;return{features:i,inferredGeometryType:r,finish(n){const o=s.sourceJSON.objectIdField;for(const a in n){const l=n[a],c=t.get(a);c&&(c.attributes||(c.attributes={}),l===-1?delete c.attributes[o]:c.attributes[o]=l,s._addIdToClientGraphic(c))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const t=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[t];i!=null&&this._idToClientGraphic.set(i,e)}get layerOrSourceGeometryType(){var e,t,i;return(i=(e=this.layer)==null?void 0:e.geometryType)!=null?i:(t=this.sourceJSON)==null?void 0:t.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this.layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:t}=e,i=this._geometryForSerialization(e),r=(ize++).toString();return i?{uid:r,geometry:i.toJSON(),attributes:t}:{uid:r,attributes:t}}_geometryForSerialization(e){const{geometry:t}=e;return R(t)?null:this._geometryRequiresClientGraphicMapping(t)?t.extent?cu.fromExtent(t.extent):null:t}async _startWorker(e){this._connection=await rde("MemorySourceWorker",{strategy:he("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:t,spatialReference:i,objectIdField:r,hasM:s,hasZ:n,timeInfo:o}=this.layer,a=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const l=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",f=>{n6.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),f.preventDefault()}));const c={features:l.features,fields:t&&t.map(f=>f.toJSON()),geometryType:MQ.toJSON(this.workerGeometryType),hasM:this.layerOrSourceGeometryType!=="mesh"&&s,hasZ:this.layerOrSourceGeometryType==="mesh"||n,objectIdField:r,spatialReference:a?null:i&&i.toJSON(),timeInfo:o?o.toJSON():null},h=await this._connection.invoke("load",c,{signal:e});for(const f of h.warnings)n6.warn(f.message,{layer:this.layer,warning:f});h.featureErrors.length&&n6.warn(`Encountered ${h.featureErrors.length} validation errors while loading features`,h.featureErrors);const p=h.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(l.inferredGeometryType)&&(p.geometryType=MQ.toJSON(l.inferredGeometryType)),this.sourceJSON=p,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),l.finish(h.assignedObjectIds)}};u([YH({Type:Ca,ensureType:Qr(Ca)})],Nm.prototype,"itemType",void 0),u([d()],Nm.prototype,"type",void 0),u([d({constructOnly:!0})],Nm.prototype,"layer",void 0),u([d({readOnly:!0})],Nm.prototype,"workerGeometryType",null),u([d()],Nm.prototype,"sourceJSON",void 0),Nm=u([P("esri.layers.graphics.sources.MemorySource")],Nm);function rze(e){return"portalItem"in e}const sze=e=>{let t=class extends e{get apiKey(){var i;return this._isOverridden("apiKey")?this._get("apiKey"):rze(this)?(i=this.portalItem)==null?void 0:i.apiKey:null}set apiKey(i){i!=null?this._override("apiKey",i):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],t.prototype,"apiKey",null),t=u([P("esri.layers.mixins.APIKeyMixin")],t),t},dye={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},pye=Object.values(dye),fye=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${pye.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),nze=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${pye.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),oze=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function w_t(e){return!!fye.test(e)}function KS(e){if(R(e))return null;const t=hn(e),i=t.path.match(fye)||t.path.match(nze);if(!i)return null;const[,r,s,n,o]=i,a=s.indexOf("/");return{title:nX(a!==-1?s.slice(a+1):s),serverType:dye[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:r}}}function aze(e){const t=hn(e).path.match(oze);return t?{serviceUrl:t[1],sublayerId:Number(t[2])}:null}function nX(e){return(e=e.replace(/\s*[/_]+\s*/g," "))[0].toUpperCase()+e.slice(1)}function lze(e,t){const i=[];if(e){const r=KS(e);_(r)&&r.title&&i.push(r.title)}if(t){const r=nX(t);i.push(r)}if(i.length===2){if(i[0].toLowerCase().includes(i[1].toLowerCase()))return i[0];if(i[1].toLowerCase().includes(i[0].toLowerCase()))return i[1]}return i.join(" - ")}function mye(e){if(!e)return!1;const t=".arcgis.com/",i="//services",r="//tiles",s="//features",n=(e=e.toLowerCase()).includes(t),o=e.includes(i)||e.includes(r)||e.includes(s);return n&&o}function cze(e,t){return e&&whe(xhe(e,t))}function uze(e){let{url:t}=e;if(!t)return{url:t};t=xhe(t,e.logger);const i=hn(t),r=KS(i.path);let s;if(_(r))r.sublayer!=null&&e.layer.layerId==null&&(s=r.sublayer),t=r.url.path;else if(e.nonStandardUrlAllowed){const n=aze(i.path);_(n)&&(t=n.serviceUrl,s=n.sublayerId)}return{url:whe(t),layerId:s}}function hze(e,t,i,r,s){fv(t,r,"url",s),r.url&&e.layerId!=null&&(r.url=du(r.url,i,e.layerId.toString()))}function x_t(e){if(!e)return!1;const t=e.toLowerCase(),i=t.includes("/services/"),r=t.includes("/mapserver/wmsserver"),s=t.includes("/imageserver/wmsserver"),n=t.includes("/wmsserver");return i&&(r||s||n)}const dze=e=>{let t=class extends e{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const i=KS(this.url);if(_(i)&&i.title)return i.title}return this._get("title")||""}set title(i){this._set("title",i)}set url(i){this._set("url",cze(i,me.getLogger(this.declaredClass)))}};return u([d()],t.prototype,"title",null),u([d({type:String})],t.prototype,"url",null),t=u([P("esri.layers.mixins.ArcGISService")],t),t},Vee={read:{reader:xW},write:{allowNull:!0,writer:TW}},pze=e=>{let t=class extends e{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0},"portal-item":{read:!0,write:!0}}}})],t.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":Vee,"portal-item":Vee}}})],t.prototype,"effect",void 0),t=u([P("esri.layers.mixins.BlendLayer")],t),t},fze=e=>{let t=class extends e{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:i=>({enabled:!!(i&&Object.keys(i).length>0)})}}})],t.prototype,"customParameters",void 0),t=u([P("esri.layers.mixins.CustomParametersMixin")],t),t};var GG;const o6=new _i({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),a6=new _i({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Pp=GG=class extends fe{constructor(e){super(e),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(e={}){const{where:t,geometry:i,spatialRelationship:r,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new Cd(F({geometry:te(i),objectIds:te(n),spatialRelationship:r,timeExtent:te(s),where:t,units:o,distance:a},e))}clone(){const{where:e,geometry:t,spatialRelationship:i,timeExtent:r,objectIds:s,units:n,distance:o}=this;return new GG({geometry:te(t),objectIds:te(s),spatialRelationship:i,timeExtent:te(r),where:e,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],Pp.prototype,"where",void 0),u([d({types:cw,json:{write:!0}})],Pp.prototype,"geometry",void 0),u([d({type:o6.apiValues,json:{name:"spatialRel",read:{reader:o6.read},write:{allowNull:!1,writer:o6.write,overridePolicy(){return{enabled:_(this.geometry)}}}}})],Pp.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],Pp.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],Pp.prototype,"objectIds",void 0),u([d({type:a6.apiValues,json:{read:a6.read,write:{writer:a6.write,overridePolicy(e){return{enabled:e!=null&&this.geometry!=null}}}}})],Pp.prototype,"units",void 0),u([d({type:Uf,json:{write:!0}})],Pp.prototype,"timeExtent",void 0),Pp=GG=u([P("esri.layers.support.FeatureFilter")],Pp);const mze=Pp;var jG;const Bee={read:{reader:xW},write:{writer:TW,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}},Gee={read:{reader:xW},write:{writer:TW,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}},jee={name:"showExcludedLabels",default:!0};let r1=jG=class extends fe{constructor(e){super(e),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(e,t){var r,s;const i=super.write(e,t);if(t==null?void 0:t.origin){if(i.filter){const n=Object.keys(i.filter);if(n.length>1||n[0]!=="where")return(r=t.messages)==null||r.push(new q("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:t.layer,effect:this})),null}if("showExcludedLabels"in i)return(s=t.messages)==null||s.push(new q("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:t.layer,effect:this})),null}return i}clone(){return new jG({filter:_(this.filter)&&this.filter.clone(),includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:mze,json:{write:{allowNull:!0,writer(e,t,i,r){const s=e==null?void 0:e.write({},r);s&&Object.keys(s).length!==0?tc(i,s,t):tc(i,null,t)}}}})],r1.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":Bee,"portal-item":Bee}}})],r1.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":Gee,"portal-item":Gee}}})],r1.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":jee,"portal-item":jee}}})],r1.prototype,"excludedLabelsVisible",void 0),r1=jG=u([P("esri.layers.support.FeatureEffect")],r1);const gze=r1,Hee={write:{allowNull:!0}},yze=e=>{let t=class extends e{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:gze,json:{origins:{"web-map":Hee,"portal-item":Hee}}})],t.prototype,"featureEffect",void 0),t=u([P("esri.layers.mixins.FeatureEffectLayer")],t),t},vze={"web-scene/operational-layers":{ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0,LineOfSightLayer:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":{ArcGISAnnotationLayer:!0,ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,OGCFeatureLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},"web-map/basemap":{ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},"web-map/tables":{ArcGISFeatureLayer:!0},"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0}};function _ze(e){if(!e)return e;const{start:t,end:i}=e;return new Uf({start:_(t)?yb(t,-t.getTimezoneOffset(),"minutes"):t,end:_(i)?yb(i,-i.getTimezoneOffset(),"minutes"):i})}function bze(e){if(!e)return e;const{start:t,end:i}=e;return new Uf({start:_(t)?yb(t,t.getTimezoneOffset(),"minutes"):t,end:_(i)?yb(i,i.getTimezoneOffset(),"minutes"):i})}var HG;let fA=HG=class extends fe{async collectRequiredFields(e,t){return hl(e,t,this.expression)}clone(){return new HG({expression:this.expression,title:this.title})}equals(e){return this.expression===e.expression&&this.title===e.title}};u([d({type:String,json:{write:!0}})],fA.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],fA.prototype,"title",void 0),fA=HG=u([P("esri.layers.support.FeatureExpressionInfo")],fA);const qee=fA;function wze(e){return QS[e]!=null}function xze(e){return 1/(QS[e]||1)}function Tze(){const e=Object.keys(QS);return e.sort(),e}const Sze=Tze();var qG;const vP=Zo()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),Wee=new _i({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let wm=qG=class extends fe{constructor(){super(...arguments),this.offset=null}readFeatureExpressionInfo(e,t){return e!=null?e:t.featureExpression&&t.featureExpression.value===0?{expression:"0"}:void 0}writeFeatureExpressionInfo(e,t,i,r){t[i]=e.write({},r),e.expression==="0"&&(t.featureExpression={value:0})}get mode(){const{offset:e,featureExpressionInfo:t}=this;return this._isOverridden("mode")?this._get("mode"):_(e)||t?"relative-to-ground":"on-the-ground"}set mode(e){this._override("mode",e)}set unit(e){this._set("unit",e)}write(e,t){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(e,t):null}clone(){return new qG({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}equals(e){return this.mode===e.mode&&this.offset===e.offset&&this.unit===e.unit&&r2e(this.featureExpressionInfo,e.featureExpressionInfo)}};u([d({type:qee,json:{write:!0}})],wm.prototype,"featureExpressionInfo",void 0),u([ke("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],wm.prototype,"readFeatureExpressionInfo",null),u([Be("featureExpressionInfo",{featureExpressionInfo:{type:qee},"featureExpression.value":{type:[0]}})],wm.prototype,"writeFeatureExpressionInfo",null),u([d({type:vP.apiValues,nonNullable:!0,json:{type:vP.jsonValues,read:vP.read,write:{writer:vP.write,isRequired:!0}}})],wm.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],wm.prototype,"offset",void 0),u([d({type:Sze,json:{type:String,read:Wee.read,write:Wee.write}})],wm.prototype,"unit",null),wm=qG=u([P("esri.layers.support.ElevationInfo")],wm);const Eze=wm,Cze={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},oX={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(e,t)=>!t.disablePopup},write:{enabled:!0,writer(e,t,i){t[i]=!e}}}},aX={type:Boolean,value:!0,json:{name:"showLabels",write:!0}},Aze={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:fv}}},Rze={type:Boolean,value:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},Mze={value:null,type:Eze,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function T_t(e){return{type:e,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const ED={type:Number,json:{origins:{"web-document":{write:!0,read:!0},"portal-item":{write:!0}}}},Oze=ve(F({},ED),{json:ve(F({},ED.json),{origins:{"web-document":ve(F({},ED.json.origins["web-document"]),{write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}})},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(e,t,i)=>i&&i.origin!=="service"||!t.drawingInfo||t.drawingInfo.transparency===void 0?t.layerDefinition&&t.layerDefinition.drawingInfo&&t.layerDefinition.drawingInfo.transparency!==void 0?LS(t.layerDefinition.drawingInfo.transparency):void 0:LS(t.drawingInfo.transparency)}})}),S_t={type:Uf,readOnly:!0,get(){var a,l;if(!((a=this.layer)==null?void 0:a.timeInfo))return null;const{datesInUnknownTimezone:e,timeOffset:t,useViewTime:i}=this.layer,r=(l=this.view)==null?void 0:l.timeExtent;let s=this.layer.timeExtent;e&&(s=bze(s));let n=i?r&&s?r.intersection(s):r||s:s;if(!n||n.isEmpty||n.isAllTime)return n;t&&(n=n.offset(-t.value,t.unit)),e&&(n=_ze(n));const o=this._get("timeExtent");return n.equals(o)?o:n}},E_t={type:ci,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(e,t)=>{const i=ci.fromJSON(e);return t.spatialReference!=null&&typeof t.spatialReference=="object"&&(i.spatialReference=Xe.fromJSON(t.spatialReference)),i}}}},read:!1}},Pze={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},Ize={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},$ze={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},gye={json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}},Dze=e=>{let t=class extends e{constructor(){super(...arguments),this.title=null}writeListMode(i,r,s,n){(n&&n.layerContainerType==="ground"||i&&rCe(this,s,{},n))&&(r[s]=i)}writeOperationalLayerType(i,r,s,n){!i||n&&n.layerContainerType==="tables"||(r.layerType=i)}writeTitle(i,r){r.title=i||"Layer"}read(i,r){r&&(r.layer=this),Hce(this,i,s=>super.read(i,s),r)}write(i,r){var o,a;if(r==null?void 0:r.origin){const l=`${r.origin}/${r.layerContainerType||"operational-layers"}`,c=vze[l];let h=c&&c[this.operationalLayerType];if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&l==="web-scene/operational-layers"&&(h=!1),!h)return(o=r.messages)==null||o.push(new q("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${l}'`,{layer:this})),null}const s=super.write(i,ve(F({},r),{layer:this})),n=!!r&&!!r.messages&&!!r.messages.filter(l=>l instanceof q&&l.name==="web-document-write:property-required").length;return FS(s==null?void 0:s.url)?((a=r==null?void 0:r.messages)==null||a.push(new q("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&n?null:s}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],t.prototype,"id",void 0),u([d(gye)],t.prototype,"listMode",void 0),u([Be("listMode")],t.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],t.prototype,"operationalLayerType",void 0),u([Be("operationalLayerType")],t.prototype,"writeOperationalLayerType",null),u([d(ED)],t.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],t.prototype,"title",void 0),u([Be([void 0,"web-scene"],"title")],t.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],t.prototype,"visible",void 0),t=u([P("esri.layers.mixins.OperationalLayer")],t),t};function Lze(e){return"operationalLayerType"in e}var WG;const l6=new _i({asc:"ascending",desc:"descending"});let Wx=WG=class extends fe{constructor(e){super(e),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new WG({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],Wx.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Wx.prototype,"valueExpression",void 0),u([d({type:l6.apiValues,json:{read:l6.read,write:l6.write}})],Wx.prototype,"order",void 0),Wx=WG=u([P("esri.layers.support.OrderByInfo")],Wx);const yye=Wx;function Nze(e,t,i){if(!e)return null;const r=e.find(n=>!!n.field);if(!r)return null;const s=new yye;return s.read(r,i),[s]}function Fze(e,t,i,r){const s=e.find(n=>!!n.field);s&&tc(i,[s.toJSON()],t)}const Uze=e=>{let t=class extends e{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[yye],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:Nze},write:{target:"layerDefinition.orderBy",writer:Fze}}})],t.prototype,"orderBy",void 0),t=u([P("esri.layers.mixins.OrderedLayer")],t),t},kze=me.getLogger("esri.portal.PortalItemResource");let qy=class extends Ee{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?ve(F({},e),{path:this._normalizePath(e.path,e.portalItem)}):e}set path(e){_(e)&&ru(e)?kze.error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",t){const i=this.url;if(R(i))throw new q("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal._request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:Yr(t,"signal")})}async update(e,t){return(await Promise.resolve().then(function(){return jA})).addOrUpdateResource(this,"update",e,t)}hasPath(){return _(this.path)}_normalizePath(e,t){return R(e)?e:(e=e.replace(/^\/+/,""),_(t)&&ru(e)&&(e=fq(e,t.itemUrl)),e.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],qy.prototype,"portalItem",void 0),u([d({type:String,value:null})],qy.prototype,"path",null),u([Ot("path")],qy.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],qy.prototype,"url",null),u([d({type:String,readOnly:!0})],qy.prototype,"itemRelativeUrl",null),qy=u([P("esri.portal.PortalItemResource")],qy);const zze=qy;let mA=class extends Ee{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],mA.prototype,"created",void 0),u([d()],mA.prototype,"rating",void 0),mA=u([P("esri.portal.PortalRating")],mA);const c6=mA;var Xx;let ri=Xx=class extends vO(Sf){constructor(e){super(e),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.spatialReference=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}static from(e){return SS(Xx,e)}destroy(){this.portal=null}get displayName(){const e=this.type,t=this.typeKeywords||[];let i=e;return e==="Feature Service"||e==="Feature Collection"?i=t.includes("Table")?"Table":t.includes("Route Layer")?"Route Layer":t.includes("Markup")?"Markup":"Feature Layer":e==="Image Service"?i=t.includes("Elevation 3D Layer")?"Elevation Layer":t.includes("Tiled Imagery")?"Tiled Imagery Layer":"Imagery Layer":e==="Scene Service"?i="Scene Layer":e==="Video Service"?i="Video Layer":e==="Scene Package"?i="Scene Layer Package":e==="Stream Service"?i="Feature Layer":e==="Geoprocessing Service"&&this.portal&&this.portal.isPortal?i=t.includes("Web Tool")?"Tool":"Geoprocessing Service":e==="Geocoding Service"?i="Locator":e==="Geoenrichment Service"?i="GeoEnrichment Service":e==="Microsoft Powerpoint"?i="Microsoft PowerPoint":e==="GeoJson"?i="GeoJSON":e==="Globe Service"?i="Globe Layer":e==="Vector Tile Service"?i="Tile Layer":e==="netCDF"?i="NetCDF":e==="Map Service"?i=t.includes("Spatiotemporal")||!t.includes("Hosted Service")&&!t.includes("Tiled")||t.includes("Relational")?"Map Image Layer":"Tile Layer":e&&e.toLowerCase().includes("add in")?i=e.replace(/(add in)/gi,"Add-In"):e==="datastore catalog service"?i="Big Data File Share":e==="Compact Tile Package"?i="Tile Package (tpkx)":e==="OGCFeatureServer"?i="OGC Feature Layer":e==="web mapping application"&&t.includes("configurableApp")&&(i="Instant App"),i}readExtent(e){return e&&e.length?new ci(e[0][0],e[0][1],e[1][0],e[1][1]):null}get iconUrl(){const e=this.type&&this.type.toLowerCase()||"",t=this.typeKeywords||[],i="esri/images/portal/",r="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return e.indexOf("service")>0||e==="feature collection"||e==="kml"||e==="wms"||e==="wmts"||e==="wfs"?(n=t.includes("Hosted Service"),e==="feature service"||e==="feature collection"||e==="kml"||e==="wfs"?(o=t.includes("Table"),a=t.includes("Route Layer"),l=t.includes("Markup"),c=t.includes("Spatiotemporal"),h=t.includes("UtilityNetwork"),s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=e==="map service"||e==="wms"||e==="wmts"?n||t.includes("Tiled")||e==="wmts"?"maptiles":"mapimages":e==="scene service"?t.includes("Line")?"sceneweblayerline":t.includes("3DObject")?"sceneweblayermultipatch":t.includes("Point")?"sceneweblayerpoint":t.includes("IntegratedMesh")?"sceneweblayermesh":t.includes("PointCloud")?"sceneweblayerpointcloud":t.includes("Polygon")?"sceneweblayerpolygon":t.includes("Building")?"sceneweblayerbuilding":t.includes("Voxel")?"sceneweblayervoxel":"sceneweblayer":e==="image service"?t.includes("Elevation 3D Layer")?"elevationlayer":t.includes("Tiled Imagery")?"tiledimagerylayer":"imagery":e==="stream service"?"streamlayer":e==="video service"?"mediaservice":e==="vector tile service"?"vectortile":e==="datastore catalog service"?"datastorecollection":e==="geocoding service"?"geocodeservice":e==="geoprocessing service"?t.includes("Web Tool")&&this.portal&&this.portal.isPortal?"tool":"layers":e==="geodata service"?"geodataservice":"layers"):s=e==="web map"||e==="cityengine web scene"?"maps":e==="web scene"?t.includes("ViewingMode-Local")?"webscenelocal":"websceneglobal":e==="web mapping application"&&t.includes("configurableApp")?"instantapps":e==="web mapping application"||e==="mobile application"||e==="application"||e==="operation view"||e==="desktop application"?"apps":e==="map document"||e==="map package"||e==="published map"||e==="scene document"||e==="globe document"||e==="basemap package"||e==="mobile basemap package"||e==="mobile map package"||e==="project package"||e==="project template"||e==="pro map"||e==="layout"||e==="layer"&&t.includes("ArcGIS Pro")||e==="explorer map"&&t.indexOf("Explorer Document")?"mapsgray":e==="service definition"||e==="csv"||e==="shapefile"||e==="cad drawing"||e==="geojson"||e==="360 vr experience"||e==="netcdf"||e==="administrative report"?"datafiles":e==="explorer add in"||e==="desktop add in"||e==="windows viewer add in"||e==="windows viewer configuration"?"appsgray":e==="arcgis pro add in"||e==="arcgis pro configuration"?"addindesktop":e==="rule package"||e==="file geodatabase"||e==="sqlite geodatabase"||e==="csv collection"||e==="kml collection"||e==="windows mobile package"||e==="map template"||e==="desktop application template"||e==="gml"||e==="arcpad package"||e==="code sample"||e==="form"||e==="document link"||e==="earth configuration"||e==="operations dashboard add in"||e==="rules package"||e==="image"||e==="workflow manager package"||e==="explorer map"&&t.includes("Explorer Mapping Application")||t.includes("Document")?"datafilesgray":e==="network analysis service"||e==="geoprocessing service"||e==="geodata service"||e==="geometry service"||e==="geoprocessing package"||e==="locator package"||e==="geoprocessing sample"||e==="workflow manager service"?"toolsgray":e==="layer"||e==="layer package"||e==="explorer layer"?"layersgray":e==="scene package"?"scenepackage":e==="mobile scene package"?"mobilescenepackage":e==="tile package"||e==="compact tile package"?"tilepackage":e==="task file"?"taskfile":e==="report template"?"report-template":e==="statistical data collection"?"statisticaldatacollection":e==="insights workbook"?"workbook":e==="insights model"?"insightsmodel":e==="insights page"?"insightspage":e==="insights theme"?"insightstheme":e==="hub initiative"?"hubinitiative":e==="hubpage"?"hubpage":e==="hub event"?"hubevent":e==="hub site application"?"hubsite":e==="hub project"?"hubproject":e==="relational database connection"?"relationaldatabaseconnection":e==="big data file share"?"datastorecollection":e==="image collection"?"imagecollection":e==="style"?"style":e==="desktop style"?"desktopstyle":e==="dashboard"?"dashboard":e==="raster function template"?"rasterprocessingtemplate":e==="vector tile package"?"vectortilepackage":e==="ortho mapping project"?"orthomappingproject":e==="ortho mapping template"?"orthomappingtemplate":e==="solution"?"solutions":e==="geopackage"?"geopackage":e==="deep learning package"?"deeplearningpackage":e==="real time analytic"?"realtimeanalytics":e==="big data analytic"?"bigdataanalytics":e==="feed"?"feed":e==="excalibur imagery project"?"excaliburimageryproject":e==="notebook"?"notebook":e==="storymap"?"storymap":e==="survey123 add in"?"survey123addin":e==="mission"?"mission":e==="mission report"?"missionreport":e==="quickcapture project"?"quickcaptureproject":e==="pro report"?"proreport":e==="urban model"?"urbanmodel":e==="web experience"?"experiencebuilder":e==="web experience template"?"webexperiencetemplate":e==="experience builder widget"?"experiencebuilderwidget":e==="experience builder widget package"?"experiencebuilderwidgetpackage":e==="workflow"?"workflow":e==="insights script"?"insightsscript":e==="kernel gateway connection"?"kernelgatewayconnection":e==="hub initiative template"?"hubinitiativetemplate":e==="storymap theme"?"storymaptheme":e==="knowledge graph"?"knowledgegraph":e==="native application"?"nativeapp":e==="native application installer"?"nativeappinstaller":e==="link chart"?"linkchart":e==="investigation"?"investigation":e==="ogcfeatureserver"?"features":e==="pro project"?"proproject":e==="insights workbook package"?"insightsworkbookpackage":e==="apache parquet"?"apacheparquet":e==="notebook code snippets"?"notebookcodesnippets":e==="suitability model"?"suitabilitymodel":e==="esri classifier definition"?"classifierdefinition":e==="esri classification schema"?"classificationschema":e==="insights data engineering workbook"?"dataengineeringworkbook":e==="insights data engineering model"?"dataengineeringmodel":e==="deep learning studio project"?"deeplearningproject":"maps",s?Mi(i+s+r+".png"):null}get isLayer(){return["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","WMTS","WMS"].includes(this.type)}get itemUrl(){const e=this.get("portal.restUrl");return e&&this.id?`${e}/content/items/${this.id}`:null}get thumbnailUrl(){const e=this.itemUrl,t=this.thumbnail;return e&&t?this.portal._normalizeUrl(`${e}/info/${t}?f=json`):null}get userItemUrl(){const e=this.get("portal.restUrl");if(!e)return null;const t=this.owner||this.get("portal.user.username");return t?`${e}/content/users/${this.ownerFolder?`${t}/${this.ownerFolder}`:t}/items/${this.id}`:null}load(e){this.portal||(this.portal=Kn.getDefault());const t=this.portal.load(e).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?this.portal._request(this.itemUrl,{signal:_(e)?e.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(t),Promise.resolve(this)}addRating(e){const t={method:"post",query:{}};return e instanceof c6&&(e=e.rating),isNaN(e)||typeof e!="number"||(t.query.rating=e),this.portal._request(this.itemUrl+"/addRating",t).then(()=>new c6({rating:e,created:new Date}))}clone(){const e={access:this.access,accessInformation:this.accessInformation,applicationProxies:te(this.applicationProxies),avgRating:this.avgRating,categories:te(this.categories),created:te(this.created),culture:this.culture,description:this.description,extent:te(this.extent),groupCategories:te(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:te(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:te(this.screenshots),size:this.size,snippet:this.snippet,spatialReference:this.spatialReference,tags:te(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:te(this.typeKeywords),url:this.url};return this.loaded&&(e.loadStatus="loaded"),new Xx({sourceJSON:this.sourceJSON}).set(e)}createPostQuery(){const e=this.toJSON();for(const i of["tags","typeKeywords","categories"])e[i]&&(e[i]=e[i].join(", "));const{extent:t}=e;return t&&(e.extent=JSON.stringify(t)),e}deleteRating(){return this.portal._request(this.itemUrl+"/deleteRating",{method:"post"}).then(()=>{})}fetchData(e="json",t){return this.portal._request(this.itemUrl+"/data",ve(F({responseType:e},t),{query:{token:this.apiKey}}))}fetchRating(e){return this.portal._request(this.itemUrl+"/rating",F({query:{token:this.apiKey}},e)).then(t=>t.rating!=null?(t.created=new Date(t.created),new c6(t)):null)}fetchRelatedItems(e,t){return this.portal._requestToTypedArray(this.itemUrl+"/relatedItems",F({query:ve(F({},e),{token:this.apiKey})},t),Xx)}getThumbnailUrl(e){let t=this.thumbnailUrl;return t&&e&&(t+=`&w=${e}`),t}reload(){return this.portal._request(this.itemUrl,{cacheBust:!0,query:{token:this.apiKey}}).then(e=>(this.sourceJSON=e,this.read(e),this))}update(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e&&e.data,i={method:"post"};i.query=this.createPostQuery();for(const r in i.query)i.query[r]===null&&(i.query[r]="");return i.query.clearEmptyFields=!0,t!=null&&(typeof t=="string"?i.query.text=t:typeof t=="object"&&(i.query.text=JSON.stringify(t))),this.portal._request(`${this.userItemUrl}/update`,i).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}updateThumbnail(e){return this.id?this.load().then(()=>this.portal._signIn()).then(()=>{const t=e.thumbnail,i=e.filename,r={method:"post"};if(typeof t=="string")Lf(t)?r.query={data:t}:r.query={url:gh(t)},_(i)&&(r.query.filename=i);else{const s=new FormData;_(i)?s.append("file",t,i):s.append("file",t),r.body=s}return this.portal._request(`${this.userItemUrl}/updateThumbnail`,r).then(()=>this.reload())}):Promise.reject(new q("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(e={},t){return(await Promise.resolve().then(function(){return jA})).fetchResources(this,e,t)}async addResource(e,t,i){const r=await Promise.resolve().then(function(){return jA});return e.portalItem=this,r.addOrUpdateResource(e,"add",t,i)}async removeResource(e,t){const i=await Promise.resolve().then(function(){return jA});if(e.portalItem&&e.portalItem.itemUrl!==this.itemUrl)throw new q("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return i.removeResource(this,e,t)}async removeAllResources(e){return(await Promise.resolve().then(function(){return jA})).removeAllResources(this,e)}resourceFromPath(e){return new zze({portalItem:this,path:e})}toJSON(){const e=this.extent,t={accessInformation:this.accessInformation,categories:te(this.categories),created:this.created&&this.created.getTime(),description:this.description,extent:e&&[[e.xmin,e.ymin],[e.xmax,e.ymax]],id:this.id,licenseInfo:this.licenseInfo,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,spatialReference:this.spatialReference,tags:te(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:te(this.typeKeywords),url:this.url};return Wle(t)}static fromJSON(e){if(!e)return null;if(e.declaredClass)throw new Error("JSON object is already hydrated");return new Xx({sourceJSON:e})}_getPostQuery(){const e=this.toJSON();for(const t in e)t==="tags"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="typeKeywords"&&e[t]!==null&&(e[t]=e[t].join(", ")),t==="extent"&&e[t]&&(e[t]=JSON.stringify(e[t]));return e}};u([d({type:["private","shared","org","public"]})],ri.prototype,"access",void 0),u([d()],ri.prototype,"accessInformation",void 0),u([d({type:String})],ri.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],ri.prototype,"applicationProxies",void 0),u([d()],ri.prototype,"avgRating",void 0),u([d()],ri.prototype,"categories",void 0),u([d({type:Date})],ri.prototype,"created",void 0),u([d()],ri.prototype,"culture",void 0),u([d()],ri.prototype,"description",void 0),u([d({readOnly:!0})],ri.prototype,"displayName",null),u([d({type:ci})],ri.prototype,"extent",void 0),u([ke("extent")],ri.prototype,"readExtent",null),u([d()],ri.prototype,"groupCategories",void 0),u([d({readOnly:!0})],ri.prototype,"iconUrl",null),u([d()],ri.prototype,"id",void 0),u([d({readOnly:!0})],ri.prototype,"isLayer",null),u([d()],ri.prototype,"itemControl",void 0),u([d({readOnly:!0})],ri.prototype,"itemUrl",null),u([d()],ri.prototype,"licenseInfo",void 0),u([d({type:Date})],ri.prototype,"modified",void 0),u([d()],ri.prototype,"name",void 0),u([d()],ri.prototype,"numComments",void 0),u([d()],ri.prototype,"numRatings",void 0),u([d()],ri.prototype,"numViews",void 0),u([d()],ri.prototype,"owner",void 0),u([d()],ri.prototype,"ownerFolder",void 0),u([d({type:Kn})],ri.prototype,"portal",void 0),u([d()],ri.prototype,"screenshots",void 0),u([d()],ri.prototype,"size",void 0),u([d()],ri.prototype,"snippet",void 0),u([d()],ri.prototype,"sourceJSON",void 0),u([d({type:String})],ri.prototype,"spatialReference",void 0),u([d()],ri.prototype,"tags",void 0),u([d()],ri.prototype,"thumbnail",void 0),u([d({readOnly:!0})],ri.prototype,"thumbnailUrl",null),u([d()],ri.prototype,"title",void 0),u([d()],ri.prototype,"type",void 0),u([d()],ri.prototype,"typeKeywords",void 0),u([d({type:String,json:{read(e,t){var r;if(t.type!=="KML")return e;const i=(r=this.portal)==null?void 0:r.restUrl;return e||(e=i&&this.id?`${i}/content/items/${this.id}/data`:null),e}}})],ri.prototype,"url",void 0),u([d({readOnly:!0})],ri.prototype,"userItemUrl",null),ri=Xx=u([P("esri.portal.PortalItem")],ri);const e2=ri;var vye=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:e2});const Vze=me.getLogger("esri.layers.mixins.PortalLayer"),Bze=e=>{let t=class extends e{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0}destroy(){var i;(i=this.portalItem)==null||i.destroy(),this.portalItem=null}set portalItem(i){i!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",i))}readPortalItem(i,r,s){if(r.itemId)return new e2({id:r.itemId,portal:s&&s.portal})}writePortalItem(i,r){i&&i.id&&(r.itemId=i.id)}async loadFromPortal(i,r){if(this.portalItem&&this.portalItem.id)try{const s=await import("./layersLoader.b2f852e4.js").then(function(n){return n.l});return li(r),await s.load({instance:this,supportedTypes:i.supportedTypes,validateItem:i.validateItem,supportsData:i.supportsData},r)}catch(s){throw Gr(s)||Vze.warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(i){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(i).catch(r=>(Pg(r),!0)))}async _fetchUserHasEditingPrivileges(i){const r=this.url?Ps==null?void 0:Ps.findCredential(this.url):null;if(!r)return!0;const s=_P.credential===r?_P.user:await this._fetchEditingUser(i);return _P.credential=r,_P.user=s,R(s)||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(i){var h,p;const r=(p=(h=this.portalItem)==null?void 0:h.portal)==null?void 0:p.user;if(r)return r;const s=Ps.findServerInfo(this.url);if(!(s==null?void 0:s.owningSystemUrl))return null;const n=`${s.owningSystemUrl}/sharing/rest`,o=Kn.getDefault();if(o&&o.loaded&&bh(o.restUrl)===bh(n))return o.user;const a=`${n}/community/self`,l=_(i)?i.signal:null,c=await nc(ur(a,{authMode:"no-prompt",query:{f:"json"},signal:l}));return c.ok?Tq.fromJSON(c.value.data):null}read(i,r){r&&(r.layer=this),super.read(i,r)}write(i,r){const s=r&&r.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||Kn.getDefault());return s&&n&&!yhe(n.restUrl,s.restUrl)?(r.messages&&r.messages.push(new q("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(i,ve(F({},r),{layer:this}))}};return u([d({type:e2})],t.prototype,"portalItem",null),u([ke("web-document","portalItem",["itemId"])],t.prototype,"readPortalItem",null),u([Be("web-document","portalItem",{itemId:{type:String}})],t.prototype,"writePortalItem",null),u([d({clonable:!1})],t.prototype,"resourceReferences",void 0),u([d({readOnly:!0})],t.prototype,"userHasEditingPrivileges",void 0),t=u([P("esri.layers.mixins.PortalLayer")],t),t},_P={credential:null,user:null},dM=new at,pR=new WeakMap;function Gze(e){_ye(e)&&dM.push(e)}function jze(e){_ye(e)&&dM.includes(e)&&dM.remove(e)}function _ye(e){return e&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function bye(e,t){return Number.isFinite(e)&&Number.isFinite(t)?t<=0?e:bye(t,e%t):0}let u6=0,bP=0;function Hze(){var t;const e=Date.now();for(const i of dM)i.refreshInterval&&e-((t=pR.get(i))!=null?t:0)+5>=6e4*i.refreshInterval&&(pR.set(i,e),i.refresh(e))}Sce(()=>{const e=Date.now();let t=0;for(const i of dM)t=bye(Math.round(6e4*i.refreshInterval),t),i.refreshInterval?pR.get(i)||pR.set(i,e):pR.delete(i);if(t!==bP){if(bP=t,clearInterval(u6),bP===0)return void(u6=0);u6=setInterval(Hze,bP)}});function qze(e){return e&&typeof e=="object"&&"refreshTimestamp"in e&&"refresh"in e}const Wze=e=>{let t=class extends e{constructor(...i){super(...i),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=EH(()=>this.hasDataChanged()),this.when().then(()=>{Gze(this)},()=>{})}destroy(){jze(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(i=Date.now()){s8(this._debounceHasDataChanged()).then(r=>{r&&this._set("refreshTimestamp",i),this.emit("refresh",{dataChanged:r})},r=>{me.getLogger(this.declaredClass).error(r),this.emit("refresh",{dataChanged:!1,error:r})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:i=>i>=.1?i:i<=0?0:.1,json:{write:!0}})],t.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],t.prototype,"refreshTimestamp",void 0),u([d()],t.prototype,"refreshParameters",null),t=u([P("esri.layers.mixins.RefreshableLayer")],t),t},Xze=e=>{let t=class extends e{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const i={minScale:this.minScale,maxScale:this.maxScale},r=this.parent;r&&"effectiveScaleRange"in r&&Yze(i,r.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===i.minScale&&s.maxScale===i.maxScale?s:i}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],t.prototype,"maxScale",void 0),u([d({readOnly:!0})],t.prototype,"effectiveScaleRange",null),t=u([P("esri.layers.mixins.ScaleRangeLayer")],t),t};function Yze(e,t){return e.minScale=e.minScale>0?t.minScale>0?Math.min(e.minScale,t.minScale):e.minScale:t.minScale,e.maxScale=e.maxScale>0?t.maxScale>0?Math.max(e.maxScale,t.maxScale):e.maxScale:t.maxScale,e}const J1=Zo()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});var XG;let gA=XG=class extends fe{constructor(e){super(e),this.value=0,this.unit="milliseconds"}toMilliseconds(){return JFe(this.value,this.unit,"milliseconds")}clone(){return new XG({value:this.value,unit:this.unit})}};u([d({type:Number,json:{write:!0},nonNullable:!0})],gA.prototype,"value",void 0),u([d({type:J1.apiValues,json:{type:J1.jsonValues,read:J1.read,write:J1.write},nonNullable:!0})],gA.prototype,"unit",void 0),gA=XG=u([P("esri.TimeInterval")],gA);const pM=gA;var YG;let Yx=YG=class extends fe{constructor(e){super(e),this.respectsDaylightSaving=!1,this.timezone=null}readRespectsDaylightSaving(e,t){return t.respectsDaylightSaving!==void 0?t.respectsDaylightSaving:t.respectDaylightSaving!==void 0&&t.respectDaylightSaving}clone(){const{respectsDaylightSaving:e,timezone:t}=this;return new YG({respectsDaylightSaving:e,timezone:t})}};u([d({type:Boolean,json:{write:!0}})],Yx.prototype,"respectsDaylightSaving",void 0),u([ke("respectsDaylightSaving",["respectsDaylightSaving","respectDaylightSaving"])],Yx.prototype,"readRespectsDaylightSaving",null),u([d({type:String,json:{read:{source:"timeZone"},write:{target:"timeZone"}}})],Yx.prototype,"timezone",void 0),Yx=YG=u([P("esri.layers.support.TimeReference")],Yx);const Zze=Yx;var ZG;let oa=ZG=class extends fe{constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,t){if(!t.timeExtent||!Array.isArray(t.timeExtent)||t.timeExtent.length!==2)return null;const i=new Date(t.timeExtent[0]),r=new Date(t.timeExtent[1]);return new Uf({start:i,end:r})}writeFullTimeExtent(e,t){e&&_(e.start)&&_(e.end)?t.timeExtent=[e.start.getTime(),e.end.getTime()]:t.timeExtent=null}readInterval(e,t){return t.timeInterval&&t.timeIntervalUnits?new pM({value:t.timeInterval,unit:J1.fromJSON(t.timeIntervalUnits)}):t.defaultTimeInterval&&t.defaultTimeIntervalUnits?new pM({value:t.defaultTimeInterval,unit:J1.fromJSON(t.defaultTimeIntervalUnits)}):null}writeInterval(e,t){if(e){const i=e.toJSON();t.timeInterval=i.value,t.timeIntervalUnits=i.unit}else t.timeInterval=null,t.timeIntervalUnits=null}clone(){const{cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:n,fullTimeExtent:o,trackIdField:a,useTime:l}=this;return new ZG({cumulative:e,endField:t,hasLiveData:i,interval:r,startField:s,timeReference:te(n),fullTimeExtent:te(o),trackIdField:a,useTime:l})}};u([d({type:Boolean,json:{read:{source:"exportOptions.timeDataCumulative"},write:{target:"exportOptions.timeDataCumulative"}}})],oa.prototype,"cumulative",void 0),u([d({type:String,json:{read:{source:"endTimeField"},write:{target:"endTimeField",allowNull:!0}}})],oa.prototype,"endField",void 0),u([d({type:Uf,json:{write:{enabled:!0,allowNull:!0}}})],oa.prototype,"fullTimeExtent",void 0),u([ke("fullTimeExtent",["timeExtent"])],oa.prototype,"readFullTimeExtent",null),u([Be("fullTimeExtent")],oa.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],oa.prototype,"hasLiveData",void 0),u([d({type:pM,json:{write:{enabled:!0,allowNull:!0}}})],oa.prototype,"interval",void 0),u([ke("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],oa.prototype,"readInterval",null),u([Be("interval")],oa.prototype,"writeInterval",null),u([d({type:String,json:{read:{source:"startTimeField"},write:{target:"startTimeField",allowNull:!0}}})],oa.prototype,"startField",void 0),u([d({type:Zze,json:{write:{enabled:!0,allowNull:!0}}})],oa.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],oa.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{read:{source:"exportOptions.useTime"},write:{target:"exportOptions.useTime"}}})],oa.prototype,"useTime",void 0),oa=ZG=u([P("esri.layers.support.TimeInfo")],oa);const wye=oa,Qze=e=>{let t=class extends e{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(i,r){const s=r.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=J1.fromJSON(s.timeOffsetUnits);return n&&o?new pM({value:n,unit:o}):null}set timeInfo(i){xue(i,this.fieldsIndex),this._set("timeInfo",i)}};return u([d({type:Uf,json:{write:!1}})],t.prototype,"timeExtent",void 0),u([d({type:pM})],t.prototype,"timeOffset",void 0),u([ke("service","timeOffset",["timeInfo.exportOptions"])],t.prototype,"readOffset",null),u([d({value:null,type:wye,json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],t.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],t.prototype,"useViewTime",void 0),t=u([P("esri.layers.mixins.TemporalLayer")],t),t};var QG;let Fm=QG=class extends fe{constructor(e){super(e)}clone(){const{name:e,fields:t,isAscending:i,isUnique:r,description:s}=this;return new QG({name:e,fields:t,isAscending:i,isUnique:r,description:s})}};u([d({constructOnly:!0})],Fm.prototype,"name",void 0),u([d({constructOnly:!0})],Fm.prototype,"fields",void 0),u([d({constructOnly:!0})],Fm.prototype,"isAscending",void 0),u([d({constructOnly:!0})],Fm.prototype,"isUnique",void 0),u([d({constructOnly:!0})],Fm.prototype,"description",void 0),Fm=QG=u([P("esri.layers.support.FeatureIndex")],Fm);let iv=class extends fe{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],iv.prototype,"type",void 0),iv=u([P("esri.layers.support.FeatureReduction")],iv);var JG;let Zx=JG=class extends fe{constructor(){super(...arguments),this.statisticType=null,this.onStatisticField=null,this.onStatisticValueExpression=null}clone(){return new JG({statisticType:this.statisticType,onStatisticField:this.onStatisticField,onStatisticValueExpression:this.onStatisticValueExpression})}};u([d({type:String,json:{write:!0}})],Zx.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Zx.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],Zx.prototype,"onStatisticValueExpression",void 0),Zx=JG=u([P("esri.layers.support.OutStatistic")],Zx);const Jze=Zx;var KG;let yA=KG=class extends fe{constructor(){super(...arguments),this.name=null,this.outStatistic=null}clone(){return new KG({name:this.name,outStatistic:this.outStatistic.clone()})}};u([d({type:String,json:{write:!0}})],yA.prototype,"name",void 0),u([d({type:Jze,json:{write:!0}})],yA.prototype,"outStatistic",void 0),yA=KG=u([P("esri.layers.support.AggregateField")],yA);const xye=yA,lX="__begin__",cX="__end__",Kze=new RegExp(lX,"ig"),eVe=new RegExp(cX,"ig"),Xee=new RegExp("^"+lX,"i"),Yee=new RegExp(cX+"$","i"),zN='"',tVe=zN+" + ",iVe=" + "+zN;function rVe(e){return e.replace(new RegExp("\\[","g"),"{").replace(new RegExp("\\]","g"),"}")}function sVe(e){return e.replace(new RegExp("\\{","g"),"[").replace(new RegExp("\\}","g"),"]")}function o5(e){const t={expression:"",type:"none"};return e.labelExpressionInfo?e.labelExpressionInfo.value?(t.expression=e.labelExpressionInfo.value,t.type="conventional"):e.labelExpressionInfo.expression&&(t.expression=e.labelExpressionInfo.expression,t.type="arcade"):e.labelExpression!=null&&(t.expression=rVe(e.labelExpression),t.type="conventional"),t}function nVe(e){const t=o5(e);if(!t)return null;switch(t.type){case"conventional":return e7(t.expression);case"arcade":return t.expression}return null}function oVe(e){const t=o5(e);if(!t)return null;switch(t.type){case"conventional":return lVe(t.expression);case"arcade":return uX(t.expression)}return null}function e7(e){let t;return e?(t=gf(e,i=>lX+'$feature["'+i+'"]'+cX),t=Xee.test(t)?t.replace(Xee,""):zN+t,t=Yee.test(t)?t.replace(Yee,""):t+zN,t=t.replace(Kze,tVe).replace(eVe,iVe)):t='""',t}const aVe=/^\s*\{([^}]+)\}\s*$/i;function lVe(e){const t=e.match(aVe);return t&&t[1].trim()||null}const cVe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,uVe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,hVe=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function uX(e){if(!e)return null;let t=cVe.exec(e)||uVe.exec(e);return t?t[1]||t[3]:(t=hVe.exec(e),t?t[2]:null)}var t7;let Wy=t7=class extends fe{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(e,t){return t.value?e7(t.value):e}writeExpression(e,t,i){this.value!=null&&(e=e7(this.value)),e!=null&&(t[i]=e)}clone(){return new t7({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],Wy.prototype,"expression",void 0),u([ke("expression",["expression","value"])],Wy.prototype,"readExpression",null),u([Be("expression")],Wy.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],Wy.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],Wy.prototype,"value",void 0),Wy=t7=u([P("esri.layers.support.LabelExpressionInfo")],Wy);const Tye=Wy,Sye=[252,146,31,255],C_t=[153,153,153,255],dVe={type:"esriSMS",style:"esriSMSCircle",size:6,color:Sye,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},pVe={type:"esriSLS",style:"esriSLSSolid",width:.75,color:Sye},fVe={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},mVe={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},gVe={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},yVe={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},vVe={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},A_t=Lv.fromJSON(dVe),R_t=Ih.fromJSON(pVe),M_t=Dv.fromJSON(fVe),_Ve=H2.fromJSON(mVe);Lv.fromJSON(gVe);Ih.fromJSON(yVe);Dv.fromJSON(vVe);var i7;const wP=new _i({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function Eye(e){var t;return!e||e.origin!=="service"&&((t=e.layer)==null?void 0:t.type)!=="map-image"}function bVe(e){return(e==null?void 0:e.type)==="map-image"}function Cye(e){var t,i;return!!bVe(e)&&!!((i=(t=e.capabilities)==null?void 0:t.exportMap)==null?void 0:i.supportsArcadeExpressionForLabeling)}function wVe(e){return Eye(e)||Cye(e.layer)}let zs=i7=class extends fe{constructor(e){super(e),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=_Ve,this.useCodedValues=void 0,this.where=null}static evaluateWhere(e,t){const i=(r,s,n)=>{switch(s){case"=":return r==n;case"<>":return r!=n;case">":return r>n;case">=":return r>=n;case"<":return r<n;case"<=":return r<=n}return!1};try{if(e==null)return!0;const r=e.split(" ");if(r.length===3)return i(t[r[0]],r[1],r[2]);if(r.length===7){const s=i(t[r[0]],r[1],r[2]),n=r[3],o=i(t[r[4]],r[5],r[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+e)}}readLabelExpression(e,t){const i=t.labelExpressionInfo;if(!i||!i.value&&!i.expression)return e}writeLabelExpression(e,t,i){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)e=sVe(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const r=uX(this.labelExpressionInfo.expression);r&&(e="["+r+"]")}}e!=null&&(t[i]=e)}writeLabelExpressionInfo(e,t,i,r){if(e==null&&this.labelExpression!=null&&Eye(r))e=new Tye({expression:this.getLabelExpressionArcade()});else if(!e)return;const s=e.toJSON(r);s.expression&&(t[i]=s)}writeMaxScale(e,t){(e||this.minScale)&&(t.maxScale=e)}writeMinScale(e,t){(e||this.maxScale)&&(t.minScale=e)}getLabelExpression(){return o5(this)}getLabelExpressionArcade(){return nVe(this)}getLabelExpressionSingleField(){return oVe(this)}hash(){return JSON.stringify(this)}clone(){return new i7({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:te(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:te(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],zs.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],zs.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1}}}})],zs.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(e,t,i){return this.labelExpressionInfo&&(i==null?void 0:i.origin)==="service"&&Cye(i.layer)?{enabled:!1}:{allowNull:!0}}}}})],zs.prototype,"labelExpression",void 0),u([ke("labelExpression")],zs.prototype,"readLabelExpression",null),u([Be("labelExpression")],zs.prototype,"writeLabelExpression",null),u([d({type:Tye,json:{write:{overridePolicy:(e,t,i)=>wVe(i)?{allowNull:!0}:{enabled:!1}}}})],zs.prototype,"labelExpressionInfo",void 0),u([Be("labelExpressionInfo")],zs.prototype,"writeLabelExpressionInfo",null),u([d({type:wP.apiValues,json:{type:wP.jsonValues,read:wP.read,write:wP.write}})],zs.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],zs.prototype,"labelPosition",void 0),u([d({type:Number})],zs.prototype,"maxScale",void 0),u([Be("maxScale")],zs.prototype,"writeMaxScale",null),u([d({type:Number})],zs.prototype,"minScale",void 0),u([Be("minScale")],zs.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:!1}}}})],zs.prototype,"repeatLabel",void 0),u([d({type:Number,cast:Zi,json:{write:!0,origins:{"web-scene":{write:!1}}}})],zs.prototype,"repeatLabelDistance",void 0),u([d({types:qMe,json:{origins:{"web-scene":{types:WMe,write:Cee,default:null}},write:Cee,default:null}})],zs.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],zs.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],zs.prototype,"where",void 0),zs=i7=u([P("esri.layers.support.LabelClass")],zs);const a5=zs;var r7;let ad=r7=class extends iv{constructor(e){super(e),this.type="binning",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}clone(){return new r7({fields:te(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:te(this.labelingInfo),labelsVisible:this.labelsVisible,popupEnabled:this.popupEnabled,popupTemplate:te(this.popupTemplate),renderer:te(this.renderer)})}};u([ct({binning:"binning"})],ad.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],ad.prototype,"fixedBinLevel",void 0),u([d({type:[a5],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],ad.prototype,"labelingInfo",void 0),u([d(aX)],ad.prototype,"labelsVisible",void 0),u([d(oX)],ad.prototype,"popupEnabled",void 0),u([d({type:wO,json:{name:"popupInfo",write:!0}})],ad.prototype,"popupTemplate",void 0),u([d({type:[xye],json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],ad.prototype,"fields",void 0),u([d({types:n5,json:{write:!0}})],ad.prototype,"renderer",void 0),ad=r7=u([P("esri.layers.support.FeatureReductionBinning")],ad);const xVe=ad;var s7;let Rl=s7=class extends fe{constructor(e){super(e),this.type="cluster",this.clusterRadius=Zi("80px"),this.clusterMinSize=Zi("12px"),this.clusterMaxSize=Zi("50px"),this.popupEnabled=!0,this.popupTemplate=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}clone(){return new s7({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:te(this.labelingInfo),labelsVisible:this.labelsVisible,fields:te(this.fields),renderer:te(this.renderer),popupEnabled:this.popupEnabled,popupTemplate:te(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],Rl.prototype,"type",void 0),u([d({type:Number,cast:e=>e==="auto"?e:Zi(e),json:{write:!0}})],Rl.prototype,"clusterRadius",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Rl.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:Zi,json:{write:!0}})],Rl.prototype,"clusterMaxSize",void 0),u([d(oX)],Rl.prototype,"popupEnabled",void 0),u([d({type:wO,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],Rl.prototype,"popupTemplate",void 0),u([d({types:n5,json:{write:!0}})],Rl.prototype,"renderer",void 0),u([d({types:jMe})],Rl.prototype,"symbol",void 0),u([d({type:[a5],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],Rl.prototype,"labelingInfo",void 0),u([d(aX)],Rl.prototype,"labelsVisible",void 0),u([d({type:[xye],json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],Rl.prototype,"fields",void 0),Rl=s7=u([P("esri.layers.support.FeatureReductionCluster")],Rl);const Aye=Rl;var n7;let CD=n7=class extends iv{constructor(e){super(e),this.type="selection"}clone(){return new n7}};u([d({type:["selection"]})],CD.prototype,"type",void 0),CD=n7=u([P("esri.layers.support.FeatureReductionSelection")],CD);const Zee=CD,Qee={key:"type",base:iv,typeMap:{selection:Aye}},TVe={types:{key:"type",base:iv,typeMap:{selection:Zee,cluster:Aye,binning:xVe}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:Qee},"portal-item":{types:Qee},"web-scene":{types:{key:"type",base:iv,typeMap:{selection:Zee}}}}}},Jee=new _i({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let Xy=class extends oc(fe){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],Xy.prototype,"name",void 0),u([d({json:{write:!0}})],Xy.prototype,"description",void 0),u([d({json:{read:Jee.read,write:Jee.write}})],Xy.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],Xy.prototype,"prototype",void 0),u([d({json:{write:!0}})],Xy.prototype,"thumbnail",void 0),Xy=u([P("esri.layers.support.FeatureTemplate")],Xy);const hX=Xy;let xm=class extends oc(fe){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const t={};for(const i of Object.keys(e))t[i]=EW(e[i]);return t}writeDomains(e,t){var r;const i={};for(const s of Object.keys(e))e[s]&&(i[s]=(r=e[s])==null?void 0:r.toJSON());t.domains=i}};u([d({json:{write:!0}})],xm.prototype,"id",void 0),u([d({json:{write:!0}})],xm.prototype,"name",void 0),u([d({json:{write:!0}})],xm.prototype,"domains",void 0),u([ke("domains")],xm.prototype,"readDomains",null),u([Be("domains")],xm.prototype,"writeDomains",null),u([d({type:[hX],json:{write:!0}})],xm.prototype,"templates",void 0),xm=u([P("esri.layers.support.FeatureType")],xm);const Rye=xm;function SVe(e){return e.type==="date"||e.type==="esriFieldTypeDate"}function Kee(e){return e.type==="oid"||e.type==="esriFieldTypeOID"}function ete(e){return e.type==="global-id"||e.type==="esriFieldTypeGlobalID"}class EVe{constructor(t){if(this.fields=t,this._fieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!t)return;const i=[];for(const r of t){const s=r&&r.name;if(s){const n=tte(s);this._fieldsMap.set(s,r),this._fieldsMap.set(n,r),i.push(n),SVe(r)?(this.dateFields.push(r),this._dateFieldsSet.add(r)):o4(r)&&(this._numericFieldsSet.add(r),this.numericFields.push(r)),Kee(r)||ete(r)||(r.editable=r.editable==null||!!r.editable,r.nullable=r.nullable==null||!!r.nullable)}}i.sort(),this.uid=i.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const t of this.fields)Kee(t)||ete(t)||t.nullable||cAe(t)!==void 0||this._requiredFields.push(t)}return this._requiredFields}has(t){return this.get(t)!=null}get(t){return t!=null?this._fieldsMap.get(t)||this._fieldsMap.get(tte(t)):void 0}isDateField(t){return this._dateFieldsSet.has(this.get(t))}isNumericField(t){return this._numericFieldsSet.has(this.get(t))}normalizeFieldName(t){const i=this.get(t);if(i)return i.name}}function tte(e){return e.toLowerCase().trim()}const CVe=me.getLogger("esri.layers.support.fieldProperties");function AVe(){return{fields:{type:[IO],value:null},fieldsIndex:{readOnly:!0,get(){return new EVe(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(e){this._userOutFields=e,this.notifyChange("outFields")},get:function(){const e=this._userOutFields;if(!e||!e.length)return null;if(e.includes("*"))return["*"];if(!this.fields)return e;for(const t of e)this.fieldsIndex.has(t)||CVe.error("field-attributes-layer:invalid-field",`Invalid field ${t} found in outFields`,{layer:this,outFields:e});return Tue(this.fieldsIndex,e)}}}}let Qx=class extends oc(fe){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],Qx.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],Qx.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:e=>YOe.read(e)||ZOe.read(e)}})],Qx.prototype,"units",void 0),Qx=u([P("esri.layers.support.GeometryFieldsInfo")],Qx);const RVe=Qx,MVe=/\[([^\[\]]+)\]/gi;function ite(e,t,i){return e?e.map(r=>{const s=new a5;if(s.read(r,i),s.labelExpression){const n=t.fields||t.layerDefinition&&t.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replace(MVe,(o,a)=>`[${OVe(a,n)}]`)}return s}):null}function OVe(e,t){if(!t)return e;const i=e.toLowerCase();for(let r=0;r<t.length;r++){const s=t[r].name;if(s.toLowerCase()===i)return s}return e}var o7;let Jx=o7=class extends fe{constructor(e){super(e),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new at}clone(){return new o7({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],Jx.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],Jx.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],Jx.prototype,"viewAllLevelIds",void 0),Jx=o7=u([P("esri.layers.support.LayerFloorInfo")],Jx);const PVe=Jx,rte=new _i({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),ste=new _i({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let Vu=class extends oc(fe){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:rte.read,write:rte.write}})],Vu.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],Vu.prototype,"relationshipTableId",void 0),u([d({json:{read:ste.read,write:ste.write}})],Vu.prototype,"role",void 0),Vu=u([P("esri.layers.support.Relationship")],Vu);const IVe=Vu,ld=[];function $Ve(e,t){if(mye(e.url))return!0;const{wkid:i}=t;for(const r of ld){if(e.version>=r[0])return!0;if(typeof r[1]=="function"&&(r[1]=r[1]()),r[1].has(i))return!1}return!0}ld.push([10.91,()=>{const e=new Set([9709,9716,9741,9761,9766]);for(let t=9712;t<=9713;t++)e.add(t);for(let t=9748;t<=9749;t++)e.add(t);for(let t=20904;t<=20932;t++)e.add(t);for(let t=21004;t<=21032;t++)e.add(t);for(let t=21207;t<=21264;t++)e.add(t);for(let t=21307;t<=21364;t++)e.add(t);for(let t=102759;t<=102760;t++)e.add(t);for(let t=102901;t<=102955;t++)e.add(t);return e}]),ld.push([10.9,()=>{const e=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let t=9356;t<=9360;t++)e.add(t);for(let t=9404;t<=9407;t++)e.add(t);for(let t=9476;t<=9482;t++)e.add(t);for(let t=9487;t<=9494;t++)e.add(t);for(let t=9697;t<=9699;t++)e.add(t);return e}]),ld.push([10.81,()=>{const e=new Set([9265,9333,103598,103699]);for(let t=9248;t<=9254;t++)e.add(t);for(let t=9271;t<=9273;t++)e.add(t);for(let t=9284;t<=9285;t++)e.add(t);for(let t=21453;t<=21463;t++)e.add(t);return e}]),ld.push([10.8,()=>{const e=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let t=8035;t<=8036;t++)e.add(t);for(let t=8455;t<=8456;t++)e.add(t);for(let t=8518;t<=8529;t++)e.add(t);for(let t=8533;t<=8536;t++)e.add(t);for(let t=8538;t<=8540;t++)e.add(t);for(let t=8677;t<=8679;t++)e.add(t);for(let t=8902;t<=8903;t++)e.add(t);for(let t=8907;t<=8910;t++)e.add(t);for(let t=8949;t<=8951;t++)e.add(t);for(let t=8972;t<=8987;t++)e.add(t);for(let t=9039;t<=9040;t++)e.add(t);for(let t=9068;t<=9069;t++)e.add(t);for(let t=9140;t<=9141;t++)e.add(t);for(let t=9148;t<=9150;t++)e.add(t);for(let t=9153;t<=9159;t++)e.add(t);for(let t=9205;t<=9218;t++)e.add(t);for(let t=9221;t<=9222;t++)e.add(t);for(let t=54098;t<=54101;t++)e.add(t);return e}]),ld.push([10.71,()=>{const e=new Set([6316]);for(let t=8351;t<=8353;t++)e.add(t);for(let t=9294;t<=9297;t++)e.add(t);for(let t=103586;t<=103594;t++)e.add(t);for(let t=103696;t<=103698;t++)e.add(t);return e}]),ld.push([10.7,()=>{const e=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let t=8065;t<=8068;t++)e.add(t);for(let t=8082;t<=8083;t++)e.add(t);for(let t=8379;t<=8385;t++)e.add(t);for(let t=8836;t<=8840;t++)e.add(t);for(let t=8857;t<=8860;t++)e.add(t);for(let t=53035;t<=53037;t++)e.add(t);for(let t=54090;t<=54091;t++)e.add(t);for(let t=102498;t<=102499;t++)e.add(t);return e}]),ld.push([10.61,()=>new Set([102497])]),ld.push([10.6,()=>{const e=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let t=7755;t<=7787;t++)e.add(t);for(let t=7791;t<=7795;t++)e.add(t);for(let t=7799;t<=7801;t++)e.add(t);for(let t=7825;t<=7831;t++)e.add(t);for(let t=7877;t<=7878;t++)e.add(t);for(let t=7882;t<=7883;t++)e.add(t);for(let t=7991;t<=7992;t++)e.add(t);for(let t=8042;t<=8043;t++)e.add(t);for(let t=8058;t<=8059;t++)e.add(t);for(let t=8311;t<=8348;t++)e.add(t);for(let t=9060;t<=9067;t++)e.add(t);for(let t=102562;t<=102568;t++)e.add(t);for(let t=102799;t<=102900;t++)e.add(t);return e}]),ld.push([10.51,()=>{const e=new Set([7683,7881,7886,7899,8888,9e3]);for(let t=8013;t<=8032;t++)e.add(t);for(let t=9053;t<=9057;t++)e.add(t);for(let t=104017;t<=104018;t++)e.add(t);for(let t=104971;t<=104974;t++)e.add(t);return e}]),ld.push([10.5,()=>{const e=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let t=4087;t<=4088;t++)e.add(t);for(let t=5896;t<=5899;t++)e.add(t);for(let t=7005;t<=7007;t++)e.add(t);for(let t=7057;t<=7070;t++)e.add(t);for(let t=7073;t<=7082;t++)e.add(t);for(let t=7109;t<=7128;t++)e.add(t);for(let t=7844;t<=7859;t++)e.add(t);return e}]);async function DVe(e,t,i){const r=e&&e.getAtOrigin&&e.getAtOrigin("renderer",t.origin);if(r&&r.type==="unique-value"&&r.styleOrigin){const s=await nc(r.populateFromStyle());if(li(i),s.ok===!1){const n=s.error;t&&t.messages&&t.messages.push(new lu("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:t})),e.clear("renderer",t.origin)}}}const LVe=["oid","global-id"],NVe=["oid","global-id","guid"];function FVe({displayField:e,editFieldsInfo:t,fields:i,objectIdField:r,title:s},n){if(!i)return null;const o=GVe({editFieldsInfo:t,fields:i,objectIdField:r},n);if(!o.length)return null;const a=qVe({titleBase:s,fields:i,displayField:e}),l=HVe();return new wO({title:a,content:l,fieldInfos:o})}const UVe=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i],kVe=(e,{editFieldsInfo:t,objectIdField:i,visibleFieldNames:r})=>r?r.has(e.name):!Mye(e.name,t)&&(!i||e.name!==i)&&!LVe.includes(e.type)&&!UVe.some(s=>s.test(e.name));function zVe(e,t){const i=e;return t&&(e=e.filter(r=>!t.includes(r.type))),e===i&&(e=e.slice()),e.sort(VVe),e}function VVe(e,t){return e.type==="oid"?-1:t.type==="oid"?1:nte(e)?-1:nte(t)?1:(e.alias||e.name).toLocaleLowerCase().localeCompare((t.alias||t.name).toLocaleLowerCase())}function Mye(e,t){if(!e||!t)return!1;const{creationDateField:i,creatorField:r,editDateField:s,editorField:n}=t;return[i&&i.toLowerCase(),r&&r.toLowerCase(),s&&s.toLowerCase(),n&&n.toLowerCase()].includes(e.toLowerCase())}function BVe(e,t){return e.editable&&!NVe.includes(e.type)&&!Mye(e.name,t)}function GVe({editFieldsInfo:e,fields:t,objectIdField:i},r){return zVe(t,(r==null?void 0:r.ignoreFieldTypes)||WVe).map(s=>new bO({fieldName:s.name,isEditable:BVe(s,e),label:s.alias,format:jVe(s),visible:kVe(s,{editFieldsInfo:e,objectIdField:i,visibleFieldNames:r==null?void 0:r.visibleFieldNames})}))}function jVe(e){switch(e.type){case"small-integer":case"integer":case"single":return new ST({digitSeparator:!0,places:0});case"double":return new ST({digitSeparator:!0,places:2});case"date":return new ST({dateFormat:"long-month-day-year"});default:return e.type==="string"&&Mue(e.name)?new ST({digitSeparator:!0,places:0}):null}}function HVe(){return[new $S,new WR]}function qVe(e){const t=sAe(e),{titleBase:i}=e;return t?`${i}: {${t.trim()}}`:i}function nte(e){return(e.name&&e.name.toLowerCase())==="name"?!0:(e.alias&&e.alias.toLowerCase())==="name"||void 0}const WVe=["geometry","blob","raster","guid","xml"],h6=new _i({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"}),XVe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"},ks="FeatureLayer",ote=me.getLogger("esri.layers.FeatureLayer");function xP(e,t){return new q("layer:unsupported",`Layer (${e.title}, ${e.id}) of type '${e.declaredClass}' ${t}`,{layer:e})}function ate(e){return e&&e instanceof at}function Lt(e,t,i){return!!(e&&e.hasOwnProperty(t)?e[t]:i)}function TP(e,t,i){return e&&e.hasOwnProperty(t)?e[t]:i}function YVe(e){var i;const t=(i=e==null?void 0:e.supportedSpatialAggregationStatistics)==null?void 0:i.map(r=>r.toLowerCase());return{envelope:!!(t==null?void 0:t.includes("envelopeaggregate")),centroid:!!(t==null?void 0:t.includes("centroidaggregate")),convexHull:!!(t==null?void 0:t.includes("convexhullaggregate"))}}function DE(e,t){var r;const i=(r=e==null?void 0:e.supportedOperationsWithCacheHint)==null?void 0:r.map(s=>s.toLowerCase());return!!(i==null?void 0:i.includes(t.toLowerCase()))}const d6=AVe();function p6(e,t,i){const r=!!(i==null?void 0:i.writeLayerSchema);return{enabled:r,ignoreOrigin:r}}let Ie=class extends yze(pze(Uze(Qze(Xze(Wze(dze(Dze(Bze(rX(fze(sze(oc(hM))))))))))))){constructor(...e){super(...e),this._handles=new qt,this.capabilities=null,this.charts=null,this.copyright=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.dynamicDataSource=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.featureReduction=null,this.fields=null,this.fieldsIndex=null,this.floorInfo=null,this.formTemplate=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.layerId=void 0,this.legendEnabled=!0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.screenSizePerspectiveEnabled=!0,this.serviceDefinitionExpression=null,this.spatialReference=Xe.WGS84,this.subtypeCode=null,this.subtypeField=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.trackIdField=null,this.type="feature",this.typeIdField=null,this.types=null,this.indexes=new(at.ofType(Fm)),this.userIsAdmin=!1,this.version=void 0,this.visible=!0}destroy(){var e;(e=this.source)==null||e.destroy(),this._handles=ot(this._handles)}normalizeCtorArgs(e,t){return typeof e=="string"?F({url:e},t):e}load(e){const t=_(e)?e.signal:null;if(this.portalItem&&this.portalItem.loaded&&this.source)return void this.addResolvingPromise(this.createGraphicsSource(t).then(r=>this._initLayerProperties(r)));const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch(Pg).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const r=await this._fetchFirstLayerId(t);r!=null&&(this.layerId=r)}if(!this.url&&!this._hasMemorySource())throw new q("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this._initLayerProperties(await this.createGraphicsSource(t))}).then(()=>this.finishLoadEditablePortalLayer(e));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(e,t){return t=t.layerDefinition||t,{analytics:this._readAnalyticsCapabilities(t),attachment:this._readAttachmentCapabilities(t),data:this._readDataCapabilities(t),metadata:this._readMetadataCapabilities(t),operations:this._readOperationsCapabilities(t.capabilities||e,t),query:this._readQueryCapabilities(t),queryRelated:this._readQueryRelatedCapabilities(t),queryTopFeatures:this._readQueryTopFeaturesCapabilities(t),editing:this._readEditingCapabilities(t)}}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")||0)+1}get editingEnabled(){return!(this.loaded&&!this.capabilities.operations.supportsEditing)&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(e){e!=null?this._override("editingEnabled",e):this._clearOverride("editingEnabled")}readEditingEnabled(e,t){return this._readEditingEnabled(t,!1)}readEditingEnabledFromWebMap(e,t,i){return this._readEditingEnabled(t,!0,i)}writeEditingEnabled(e,t){this._writeEditingEnabled(e,t,!1)}writeEditingEnabledToWebMap(e,t,i,r){this._writeEditingEnabled(e,t,!0,r)}readEditingInfo(e,t){const{editingInfo:i}=t;return i?{lastEditDate:i.lastEditDate!=null?new Date(i.lastEditDate):null}:null}readIsTable(e,t){return(t=t&&t.layerDefinition||t).type==="Table"||!t.geometryType}writeIsTable(e,t,i,r){(r==null?void 0:r.writeLayerSchema)&&tc(i,e?"Table":"Feature Layer",t)}readMinScale(e,t){return t.effectiveMinScale||e||0}readMaxScale(e,t){return t.effectiveMaxScale||e||0}readGlobalIdFieldFromService(e,t){if((t=t.layerDefinition||t).globalIdField)return t.globalIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeGlobalID")return i.name}}readObjectIdFieldFromService(e,t){if((t=t.layerDefinition||t).objectIdField)return t.objectIdField;if(t.fields){for(const i of t.fields)if(i.type==="esriFieldTypeOID")return i.name}}get parsedUrl(){const e=this.url?hn(this.url):null;return e!=null&&(this.dynamicDataSource!=null?e.path=du(e.path,"dynamicLayer"):this.layerId!=null&&(e.path=du(e.path,this.layerId.toString()))),e}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){OQ(e,this.fieldsIndex),this._set("renderer",e)}readRenderer(e,t,i){const r=(t=t.layerDefinition||t).drawingInfo&&t.drawingInfo.renderer||void 0;if(r){const s=L6e(r,t,i)||void 0;return s||ote.error("Failed to create renderer",{rendererDefinition:t.drawingInfo.renderer,layer:this,context:i}),s}if(t.defaultSymbol)return t.types&&t.types.length?new tX({defaultSymbol:f6(t.defaultSymbol,t,i),field:t.typeIdField,uniqueValueInfos:t.types.map(s=>({id:s.id,symbol:f6(s.symbol,s,i)}))}):new eX({symbol:f6(t.defaultSymbol,t,i)})}set source(e){const t=this._get("source");t!==e&&(ate(t)&&this._resetMemorySource(t),ate(e)&&this._initMemorySource(e),this._set("source",e))}castSource(e){return e?Array.isArray(e)||e instanceof at?new Nm({layer:this,items:e}):e:null}readSource(e,t){const i=Q4.fromJSON(t.featureSet);return new Nm({layer:this,items:i&&i.features||[]})}readServiceDefinitionExpression(e,t){return t.definitionQuery||t.definitionExpression}readTemplates(e,t){const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e=e&&e.map(n=>hX.fromJSON(n)),this._fixTemplates(e,r),this._fixTemplates(e,s),e}readTitle(e,t){const i=t.layerDefinition&&t.layerDefinition.name||t.name,r=t.title||t.layerDefinition&&t.layerDefinition.title;if(i){const s=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?lze(this.url,i):i;let n=i;if(!n&&this.url){const o=KS(this.url);_(o)&&(n=o.title)}return n?(this.sublayerTitleMode==="item-title-and-service-name"&&s&&s!==n&&(n=s+" - "+n),nX(n)):void 0}if(this.sublayerTitleMode==="item-title"&&r)return r}readTitleFromWebMap(e,t){return t.title||t.layerDefinition&&t.layerDefinition.name}readTypeIdField(e,t){let i=(t=t.layerDefinition||t).typeIdField;if(i&&t.fields){i=i.toLowerCase();const r=t.fields.find(s=>s.name.toLowerCase()===i);r&&(i=r.name)}return i}readTypes(e,t){e=(t=t.layerDefinition||t).types;const i=t.editFieldsInfo,r=i&&i.creatorField,s=i&&i.editorField;return e&&e.map(n=>(n=Rye.fromJSON(n),this._fixTemplates(n.templates,r),this._fixTemplates(n.templates,s),n))}set url(e){const t=uze({layer:this,url:e,nonStandardUrlAllowed:!0,logger:ote});this._set("url",t.url),t.layerId!=null&&this._set("layerId",t.layerId)}writeUrl(e,t,i,r){hze(this,e,null,t,r)}readVersion(e,t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}readVisible(e,t){return t.layerDefinition&&t.layerDefinition.defaultVisibility!=null?!!t.layerDefinition.defaultVisibility:t.visibility!=null?!!t.visibility:void 0}addAttachment(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("addAttachment"in this.source))throw new q(ks,"Layer source does not support addAttachment capability");return this.source.addAttachment(e,t)})}updateAttachment(e,t,i){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("updateAttachment"in this.source))throw new q(ks,"Layer source does not support updateAttachment capability");return this.source.updateAttachment(e,t,i)})}async applyEdits(e,t){const i=await import("./editingSupport.8dbbfd56.js");return await this.load(),i.applyEdits(this,this.source,e,t)}on(e,t){return super.on(e,t)}createPopupTemplate(e){return FVe(this,e)}async createGraphicsSource(e){if(this._hasMemorySource())return this.source.load({signal:e});const{default:t}=await N2e(import("./FeatureLayerSource.9398b496.js"),e);return new t({layer:this}).load({signal:e})}createQuery(){const e=new Cd,t=this.get("capabilities.data"),i=this.get("capabilities.query");e.dynamicDataSource=this.dynamicDataSource,e.historicMoment=this.historicMoment,e.gdbVersion=this.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),t&&(t.supportsZ&&this.returnZ!=null&&(e.returnZ=this.returnZ),t.supportsM&&this.returnM!=null&&(e.returnM=this.returnM)),e.outFields=["*"];const r=_(this.subtypeCode)?`${this.subtypeField} = ${this.subtypeCode}`:null,s=U6e(this.definitionExpression,r);e.where=s||"1=1";const{timeOffset:n,timeExtent:o}=this;return e.timeExtent=n!=null&&o!=null?o.offset(-n.value,n.unit):o||null,e.multipatchOption=this.geometryType==="multipatch"?"xyFootprint":null,e}deleteAttachments(e,t){return this.load().then(()=>this._checkAttachmentSupport(e)).then(()=>{if(!("deleteAttachments"in this.source))throw new q(ks,"Layer source does not support deleteAttachments capability");return this.source.deleteAttachments(e,t)})}fetchRecomputedExtents(e){return this.load({signal:e==null?void 0:e.signal}).then(()=>{if(this.source.fetchRecomputedExtents)return this.source.fetchRecomputedExtents(e);throw new q(ks,"Layer source does not support fetchUpdates capability")})}getFeatureType(e){const{typeIdField:t,types:i}=this;if(!t||!e)return null;const r=e.attributes?e.attributes[t]:void 0;if(r==null)return null;let s=null;return i.some(n=>{const{id:o}=n;return o!=null&&(o.toString()===r.toString()&&(s=n),!!s)}),s}getFieldDomain(e,t){const i=t&&t.feature,r=this.getFeatureType(i);if(r){const s=r.domains&&r.domains[e];if(s&&s.type!=="inherited")return s}return this._getLayerDomain(e)}getField(e){return this.fieldsIndex.get(e)}queryAttachments(e,t){return e=_9.from(e),this.load().then(()=>{if(!this.get("capabilities.data.supportsAttachment"))throw new q(ks,"this layer doesn't support attachments");const{attachmentTypes:i,objectIds:r,globalIds:s,num:n,size:o,start:a,where:l}=e;if(!this.get("capabilities.operations.supportsQueryAttachments")){const c=r&&r.length>1,h=i&&i.length,p=s&&s.length,f=o&&o.length;if(c||h||p||f||n||a||l)throw new q(ks,"when 'supportsQueryAttachments' is false, only objectIds of length 1 are supported",e)}if(!(r&&r.length||l))throw new q(ks,"'objectIds' or 'where' are required to perform attachment query",e);if(!("queryAttachments"in this.source))throw new q(ks,"Layer source does not support queryAttachments capability",e);return this.source.queryAttachments(e)})}queryFeatures(e,t){return this.load().then(()=>this.source.queryFeatures(Cd.from(e)||this.createQuery(),t)).then(i=>{if(i==null?void 0:i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i})}queryObjectIds(e,t){return this.load().then(()=>{if(this.source.queryObjectIds)return this.source.queryObjectIds(Cd.from(e)||this.createQuery(),t);throw new q(ks,"Layer source does not support queryObjectIds capability")})}queryFeatureCount(e,t){return this.load().then(()=>{if(this.source.queryFeatureCount)return this.source.queryFeatureCount(Cd.from(e)||this.createQuery(),t);throw new q(ks,"Layer source does not support queryFeatureCount capability")})}queryExtent(e,t){return this.load().then(()=>{if(this.source.queryExtent)return this.source.queryExtent(Cd.from(e)||this.createQuery(),t);throw new q(ks,"Layer source does not support queryExtent capability")})}queryRelatedFeatures(e,t){return this.load().then(()=>{if("queryRelatedFeatures"in this.source)return this.source.queryRelatedFeatures(j9.from(e),t);throw new q(ks,"Layer source does not support queryRelatedFeatures capability")})}queryRelatedFeaturesCount(e,t){return this.load().then(()=>{if("queryRelatedFeaturesCount"in this.source)return this.source.queryRelatedFeaturesCount(j9.from(e),t);throw new q(ks,"Layer source does not support queryRelatedFeaturesCount capability")})}queryTopFeatures(e,t){return this.load().then(()=>{if("queryTopFeatures"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopFeatures(sP.from(e),t).then(i=>{if(i==null?void 0:i.features)for(const r of i.features)r.layer=r.sourceLayer=this;return i});throw new q(ks,"Layer source does not support queryTopFeatures capability")})}queryTopObjectIds(e,t){return this.load().then(()=>{if("queryTopObjectIds"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopObjectIds(sP.from(e),t);throw new q(ks,"Layer source does not support queryTopObjectIds capability")})}queryTopFeaturesExtent(e,t){return this.load().then(()=>{if("queryTopExtents"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopExtents(sP.from(e),t);throw new q(ks,"Layer source does not support queryTopExtents capability")})}queryTopFeatureCount(e,t){return this.load().then(()=>{if("queryTopCount"in this.source&&this.get("capabilities.query.supportsTopFeaturesQuery"))return this.source.queryTopCount(sP.from(e),t);throw new q(ks,"Layer source does not support queryFeatureCount capability")})}read(e,t){const i=e.featureCollection;if(i){const r=i.layers;r&&r.length===1&&(super.read(r[0],t),i.showLegend!=null&&super.read({showLegend:i.showLegend},t))}super.read(e,t),t&&t.origin==="service"&&this.revert(["objectIdField","fields","timeInfo","spatialReference"],"service")}write(e,t){var n;t=ve(F({},t),{writeLayerSchema:(n=t==null?void 0:t.writeLayerSchema)!=null?n:this._hasMemorySource()});const{origin:i,layerContainerType:r,messages:s}=t;if(this.dynamicDataSource)return s==null||s.push(xP(this,"using a dynamic data source cannot be written to web scenes, web maps and feature service items")),null;if(this.isTable){if(i==="web-scene"||i==="web-map"&&r!=="tables")return s==null||s.push(xP(this,"using a table source cannot be written to web scenes and web maps")),null;if(this._hasMemorySource())return s==null||s.push(xP(this,"using an in-memory table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&i==="web-map"&&r==="tables")return s==null||s.push(xP(this,"using a non-table source cannot be written to tables in web maps")),null;return super.write(e,t)}clone(){if(this._hasMemorySource())throw new q(ks,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(e){return!!this.loaded&&(this.source.type==="memory"||$Ve(this,e))}async save(e){return(await import("./featureLayerUtils.eb21aa19.js")).save(this,e)}async saveAs(e,t){return(await import("./featureLayerUtils.eb21aa19.js")).saveAs(this,e,t)}_readEditingEnabled(e,t,i){var s;let r=(s=e.layerDefinition)==null?void 0:s.capabilities;return r?this._hasEditingCapability(r):(r=e.capabilities,t&&(i==null?void 0:i.origin)==="web-map"&&!this._hasMemorySource()&&r?this._hasEditingCapability(r):void 0)}_hasEditingCapability(e){return e.toLowerCase().split(",").map(t=>t.trim()).includes("editing")}_writeEditingEnabled(e,t,i,r){var s,n;if(!e){const o=((n=(s=this.capabilities)==null?void 0:s.operations)==null?void 0:n.supportsSync)?"Query,Sync":"Query";tc("layerDefinition.capabilities",o,t),i&&!(r==null?void 0:r.writeLayerSchema)&&(t.capabilities=o)}}_checkAttachmentSupport(e){const{attributes:t}=e,{objectIdField:i}=this;return this.get("capabilities.data.supportsAttachment")?e?t?t[i]?void 0:Promise.reject(new q(ks,`feature is missing the identifying attribute ${i}`)):Promise.reject(new q(ks,"'attributes' are required on a feature to query attachments")):Promise.reject(new q(ks,"A feature is required to add/delete/update attachments")):Promise.reject(new q(ks,"this layer doesn't support attachments"))}_getLayerDomain(e){const t=this.fieldsIndex.get(e);return t?t.domain:null}_fetchFirstLayerId(e){return ur(this.url,{query:ve(F({f:"json"},this.customParameters),{token:this.apiKey}),responseType:"json",signal:e}).then(t=>{const i=t.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async _initLayerProperties(e){return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",url:this.parsedUrl})),this._verifySource(),this._verifyFields(),OQ(this.renderer,this.fieldsIndex),xue(this.timeInfo,this.fieldsIndex),DVe(this,{origin:"service"})}async hasDataChanged(){var e,t;if((e=this.source)==null?void 0:e.refresh)try{const{dataChanged:i,updates:r}=await((t=this.source)==null?void 0:t.refresh());if(_(r)&&(this.sourceJSON=F(F({},this.sourceJSON),r),this.read(r,{origin:"service",url:this.parsedUrl})),i)return!0}catch{}if(this.definitionExpression)try{return(await F6e(this.definitionExpression,this.fieldsIndex)).hasDateFunctions}catch{}return!1}_verifyFields(){var t;const e=this.parsedUrl&&this.parsedUrl.path||"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||e.search(/\/FeatureServer\//i)!==-1||((t=this.fields)==null?void 0:t.some(i=>i.type==="geometry"))||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")}_fixTemplates(e,t){e&&e.forEach(i=>{const r=i.prototype&&i.prototype.attributes;r&&t&&delete r[t]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new q("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new q("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(e){e.forEach(t=>{t.layer=this,t.sourceLayer=this}),this._handles.add([e.on("after-add",t=>{t.item.layer=this,t.item.sourceLayer=this}),e.on("after-remove",t=>{t.item.layer=null,t.item.sourceLayer=null})],"fl-source")}_resetMemorySource(e){e.forEach(t=>{t.layer=null,t.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}_readAnalyticsCapabilities(e){return{supportsCacheHint:DE(e.advancedQueryCapabilities,"queryAnalytics")}}_readAttachmentCapabilities(e){const t=e.attachmentProperties,i={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:DE(e.advancedQueryCapabilities,"queryAttachments"),supportsResize:Lt(e,"supportsAttachmentsResizing",!1)};return t&&Array.isArray(t)&&t.forEach(r=>{const s=XVe[r.name];s&&(i[s]=!!r.isEnabled)}),i}_readDataCapabilities(e){return{isVersioned:Lt(e,"isDataVersioned",!1),supportsAttachment:Lt(e,"hasAttachments",!1),supportsM:Lt(e,"hasM",!1),supportsZ:Lt(e,"hasZ",!1)}}_readMetadataCapabilities(e){return{supportsAdvancedFieldProperties:Lt(e,"supportsFieldDescriptionProperty",!1)}}_readOperationsCapabilities(e,t){const i=e?e.toLowerCase().split(",").map(p=>p.trim()):[],r=this.url?KS(this.url):null,s=i.includes(_(r)&&r.serverType==="MapServer"?"data":"query"),n=i.includes("editing")&&!t.datesInUnknownTimezone;let o=n&&i.includes("create"),a=n&&i.includes("delete"),l=n&&i.includes("update");const c=i.includes("changetracking"),h=t.advancedQueryCapabilities;return n&&!(o||a||l)&&(o=a=l=!0),{supportsCalculate:Lt(t,"supportsCalculate",!1),supportsTruncate:Lt(t,"supportsTruncate",!1),supportsValidateSql:Lt(t,"supportsValidateSql",!1),supportsAdd:o,supportsDelete:a,supportsEditing:n,supportsChangeTracking:c,supportsQuery:s,supportsQueryAnalytics:Lt(h,"supportsQueryAnalytic",!1),supportsQueryAttachments:Lt(h,"supportsQueryAttachments",!1),supportsQueryTopFeatures:Lt(h,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:Lt(t,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:l,supportsExceedsLimitStatistics:Lt(t,"supportsExceedsLimitStatistics",!1)}}_readQueryCapabilities(e){var l;const t=e.advancedQueryCapabilities,i=e.ownershipBasedAccessControlForFeatures,r=e.archivingInfo,s=(l=this.url)==null?void 0:l.includes("MapServer"),n=!he("mapserver-pbf-enabled")&&s&&this.version<10.81,o=mye(this.url),a=(e.supportedQueryFormats||"").split(",").reduce((c,h)=>{const p=h.toLowerCase().trim();return p&&c.add(p),c},new Set);return{supportsStatistics:Lt(t,"supportsStatistics",e.supportsStatistics),supportsPercentileStatistics:Lt(t,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:Lt(t,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:YVe(t),supportsCentroid:Lt(t,"supportsReturningGeometryCentroid",!1),supportsDistance:Lt(t,"supportsQueryWithDistance",!1),supportsDistinct:Lt(t,"supportsDistinct",e.supportsAdvancedQueries),supportsExtent:Lt(t,"supportsReturningQueryExtent",!1),supportsGeometryProperties:Lt(t,"supportsReturningGeometryProperties",!1),supportsHavingClause:Lt(t,"supportsHavingClause",!1),supportsOrderBy:Lt(t,"supportsOrderBy",e.supportsAdvancedQueries),supportsPagination:Lt(t,"supportsPagination",!1),supportsQuantization:Lt(e,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:Lt(e,"supportsQuantizationEditMode",!1),supportsQueryGeometry:Lt(e,"supportsReturningQueryGeometry",!1),supportsResultType:Lt(t,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:Lt(t,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:Lt(t,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:Lt(e,"useStandardizedQueries",!1),supportsTopFeaturesQuery:Lt(t,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:Lt(i,"allowOthersToQuery",!0),supportsHistoricMoment:Lt(r,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:!n&&a.has("pbf"),supportsDisjointSpatialRelationship:Lt(t,"supportsDisjointSpatialRel",!1),supportsCacheHint:Lt(t,"supportsQueryWithCacheHint",!1)||DE(t,"query"),supportsDefaultSpatialReference:Lt(t,"supportsDefaultSR",!1),supportsCompactGeometry:o,maxRecordCountFactor:TP(e,"maxRecordCountFactor",void 0),maxRecordCount:TP(e,"maxRecordCount",void 0),standardMaxRecordCount:TP(e,"standardMaxRecordCount",void 0),tileMaxRecordCount:TP(e,"tileMaxRecordCount",void 0)}}_readQueryRelatedCapabilities(e){const t=e.advancedQueryCapabilities,i=Lt(t,"supportsAdvancedQueryRelated",!1);return{supportsPagination:Lt(t,"supportsQueryRelatedPagination",!1),supportsCount:i,supportsOrderBy:i,supportsCacheHint:DE(t,"queryRelated")}}_readQueryTopFeaturesCapabilities(e){return{supportsCacheHint:DE(e.advancedQueryCapabilities,"queryTopFilter")}}_readEditingCapabilities(e){const t=e.ownershipBasedAccessControlForFeatures;return{supportsGeometryUpdate:Lt(e,"allowGeometryUpdates",!0),supportsGlobalId:Lt(e,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:Lt(e,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:Lt(e,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:Lt(e,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:Lt(e,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:Lt(t,"allowAnonymousToDelete",!0),supportsDeleteByOthers:Lt(t,"allowOthersToDelete",!0),supportsUpdateByAnonymous:Lt(t,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:Lt(t,"allowOthersToUpdate",!0)}}};u([d({readOnly:!0,json:{read:!1}})],Ie.prototype,"capabilities",void 0),u([ke("service","capabilities",["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"])],Ie.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Ie.prototype,"charts",void 0),u([d({readOnly:!0})],Ie.prototype,"createQueryVersion",null),u([d({type:String,json:{read:{source:"layerDefinition.copyrightText"},origins:{service:{read:{source:"copyrightText"}}}}})],Ie.prototype,"copyright",void 0),u([d({type:Boolean})],Ie.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{read:{source:"layerDefinition.displayField"},origins:{service:{read:{source:"displayField"}}}}})],Ie.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],Ie.prototype,"definitionExpression",void 0),u([d({types:hb,readOnly:!0})],Ie.prototype,"defaultSymbol",void 0),u([d({type:bd})],Ie.prototype,"dynamicDataSource",void 0),u([d({readOnly:!0})],Ie.prototype,"editFieldsInfo",void 0),u([d({type:Boolean})],Ie.prototype,"editingEnabled",null),u([ke(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],Ie.prototype,"readEditingEnabled",null),u([ke("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],Ie.prototype,"readEditingEnabledFromWebMap",null),u([Be(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],Ie.prototype,"writeEditingEnabled",null),u([Be("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],Ie.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],Ie.prototype,"editingInfo",void 0),u([ke("editingInfo")],Ie.prototype,"readEditingInfo",null),u([d((()=>{const e=te(Mze),t=e.json.origins;return t["web-map"]={read:!1,write:!1},t["portal-item"]={read:!1,write:!1},e})())],Ie.prototype,"elevationInfo",void 0),u([d(TVe)],Ie.prototype,"featureReduction",void 0),u([d(ve(F({},d6.fields),{json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:p6}}}}}))],Ie.prototype,"fields",void 0),u([d(d6.fieldsIndex)],Ie.prototype,"fieldsIndex",void 0),u([d({type:PVe,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],Ie.prototype,"floorInfo",void 0),u([d({type:Z6e,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],Ie.prototype,"formTemplate",void 0),u([d({type:ci,json:{origins:{service:{read:{source:"extent"}}},read:{source:"layerDefinition.extent"}}})],Ie.prototype,"fullExtent",void 0),u([d()],Ie.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:RVe,json:{read:{source:"geometryProperties"}}})],Ie.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:h6.read},"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:p6,writer(e,t,i){const r=e?h6.toJSON(e):null;r&&tc(i,r,t)}}}},read:{source:"layerDefinition.geometryType",reader:h6.read}}})],Ie.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasM"}}})],Ie.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}},read:{source:"layerDefinition.hasZ"}}})],Ie.prototype,"hasZ",void 0),u([d({readOnly:!0,type:Nv})],Ie.prototype,"heightModelInfo",void 0),u([d({type:Date})],Ie.prototype,"historicMoment",void 0),u([d(Pze)],Ie.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],Ie.prototype,"infoFor3D",void 0),u([d({readOnly:!0,json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],Ie.prototype,"isTable",void 0),u([ke("service","isTable",["type","geometryType"]),ke("isTable",["layerDefinition.type","layerDefinition.geometryType"])],Ie.prototype,"readIsTable",null),u([Be("web-map","isTable")],Ie.prototype,"writeIsTable",null),u([d(aX)],Ie.prototype,"labelsVisible",void 0),u([d({type:[a5],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:ite},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:ite},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],Ie.prototype,"labelingInfo",void 0),u([d((()=>{const e=te(Oze);return e.json.origins["portal-item"]={write:{target:"layerDefinition.drawingInfo.transparency",writer(t,i,r){tc(r,xO(t),i)}}},e})())],Ie.prototype,"opacity",void 0),u([d({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{read:!1,write:{target:"id"}}},read:!1}})],Ie.prototype,"layerId",void 0),u([d(Rze)],Ie.prototype,"legendEnabled",void 0),u([d({type:["show","hide"],json:(()=>{const e=te(gye.json);return e.origins["portal-item"]={read:!1,write:!1},e})()})],Ie.prototype,"listMode",void 0),u([d(Ize)],Ie.prototype,"minScale",void 0),u([ke("service","minScale",["minScale","effectiveMinScale"])],Ie.prototype,"readMinScale",null),u([d($ze)],Ie.prototype,"maxScale",void 0),u([ke("service","maxScale",["maxScale","effectiveMaxScale"])],Ie.prototype,"readMaxScale",null),u([d({type:String})],Ie.prototype,"globalIdField",void 0),u([ke("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"]),ke("service","globalIdField",["globalIdField","fields"])],Ie.prototype,"readGlobalIdFieldFromService",null),u([d({type:String,json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:p6}}}}})],Ie.prototype,"objectIdField",void 0),u([ke("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"]),ke("service","objectIdField",["objectIdField","fields"])],Ie.prototype,"readObjectIdFieldFromService",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],Ie.prototype,"operationalLayerType",void 0),u([d(d6.outFields)],Ie.prototype,"outFields",void 0),u([d({readOnly:!0})],Ie.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Ie.prototype,"path",void 0),u([d(oX)],Ie.prototype,"popupEnabled",void 0),u([d({type:wO,json:{name:"popupInfo",write:!0}})],Ie.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],Ie.prototype,"defaultPopupTemplate",null),u([d({type:[IVe],readOnly:!0})],Ie.prototype,"relationships",void 0),u([d({types:n5,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:$6e,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(e,t,i)=>({ignoreOrigin:i==null?void 0:i.writeLayerSchema})}}})],Ie.prototype,"renderer",null),u([ke("service","renderer",["drawingInfo.renderer","defaultSymbol"]),ke("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],Ie.prototype,"readRenderer",null),u([d()],Ie.prototype,"sourceJSON",void 0),u([d({type:Boolean})],Ie.prototype,"returnM",void 0),u([d({type:Boolean})],Ie.prototype,"returnZ",void 0),u([d((()=>{const e=te(Cze);return e.json.origins["portal-item"]={read:!1,write:!1},e})())],Ie.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],Ie.prototype,"source",null),u([Ot("source")],Ie.prototype,"castSource",null),u([ke("portal-item","source",["featureSet"]),ke("web-map","source",["featureSet"])],Ie.prototype,"readSource",null),u([d({readOnly:!0})],Ie.prototype,"serviceDefinitionExpression",void 0),u([ke("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],Ie.prototype,"readServiceDefinitionExpression",null),u([d({type:Xe,json:{origins:{service:{read:{source:"extent.spatialReference"}}},read:{source:"layerDefinition.extent.spatialReference"}}})],Ie.prototype,"spatialReference",void 0),u([d({type:Number})],Ie.prototype,"subtypeCode",void 0),u([d({type:String,json:{origins:{service:{read:!0}}}})],Ie.prototype,"subtypeField",void 0),u([d({type:[hX]})],Ie.prototype,"templates",void 0),u([ke("templates",["editFieldsInfo","creatorField","editorField","templates"])],Ie.prototype,"readTemplates",null),u([d({type:wye})],Ie.prototype,"timeInfo",void 0),u([d()],Ie.prototype,"title",void 0),u([ke("service","title",["name"]),ke("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],Ie.prototype,"readTitle",null),u([ke("web-map","title",["layerDefinition.name","title"])],Ie.prototype,"readTitleFromWebMap",null),u([d({type:String})],Ie.prototype,"sublayerTitleMode",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],Ie.prototype,"trackIdField",void 0),u([d({json:{read:!1}})],Ie.prototype,"type",void 0),u([d({type:String})],Ie.prototype,"typeIdField",void 0),u([ke("service","typeIdField"),ke("typeIdField",["layerDefinition.typeIdField"])],Ie.prototype,"readTypeIdField",null),u([d({type:[Rye]})],Ie.prototype,"types",void 0),u([ke("service","types",["types"]),ke("types",["layerDefinition.types"])],Ie.prototype,"readTypes",null),u([d({readOnly:!0,json:{write:!1}})],Ie.prototype,"serverGens",void 0),u([d({type:at.ofType(Fm),readOnly:!0})],Ie.prototype,"indexes",void 0),u([d(Aze)],Ie.prototype,"url",null),u([Be("url")],Ie.prototype,"writeUrl",null),u([d({readOnly:!0})],Ie.prototype,"userIsAdmin",void 0),u([d({json:{origins:{service:{read:!0}},read:!1}})],Ie.prototype,"version",void 0),u([ke("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],Ie.prototype,"readVersion",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],Ie.prototype,"visible",void 0),u([ke("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],Ie.prototype,"readVisible",null),Ie=u([P("esri.layers.FeatureLayer")],Ie);const f6=U2({types:Yhe}),Oye=Ie;var O_t=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:Oye});const ZVe=["$datastore","$map","$layer","$aggregatedfeatures"],QVe="esri.widgets.Feature.support.arcadeFeatureUtils",JVe=me.getLogger(QVe);function KVe(e){return typeof e=="string"?MO(fW(e)):Array.isArray(e)?e8e(e):(e==null?void 0:e.declaredClass)==="esri.arcade.Dictionary"?t8e(e):e}function e8e(e){return`<ul class="esri-widget__list">${e.map(t=>`<li>${typeof t=="string"?MO(fW(t)):t}</li>`).join("")}</ul>`}function t8e(e){return`<table class="esri-widget__table">${e.keys().map(t=>{const i=e.field(t);return`<tr><th>${t}</th><td>${typeof i=="string"?MO(fW(i)):i}</td></tr>`}).join("")}</table>`}function i8e({aggregatedFeatures:e,arcadeUtils:t,featureSetVars:i,context:r,viewInfo:s,map:n,graphic:o,interceptor:a}){i.forEach(l=>{const c=l.toLowerCase(),h={map:n,spatialReference:s.sr,interceptor:a};if(c==="$map"&&(r.vars[c]=t.convertMapToFeatureSetCollection(h)),c==="$layer"&&(r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:o.sourceLayer,spatialReference:s.sr,interceptor:a})),c==="$datastore"&&(r.vars[c]=t.convertServiceUrlToWorkspace({url:o.sourceLayer.url,spatialReference:s.sr,interceptor:a})),c==="$aggregatedfeatures"){const p=o.layer,{fields:f,objectIdField:m,geometryType:y,spatialReference:v,displayField:w}=p,b=new Oye(ve(F({fields:f,objectIdField:m,geometryType:y,spatialReference:v,displayField:w},p.type==="feature"?{templates:p.templates,typeIdField:p.typeIdField,types:p.types}:null),{source:e}));r.vars[c]=t.convertFeatureLayerToFeatureSet({layer:b,spatialReference:s.sr,interceptor:a})}})}function Pye(){return import("./arcadeUtils.ad069cdf.js").then(function(e){return e.t})}async function r8e({graphic:e,view:t}){const{isAggregate:i,layer:r}=e;if(!i||!r||(t==null?void 0:t.type)!=="2d")return[];const s=await t.whenLayerView(r);if(!s.createQuery||!s.queryFeatures)return[];const n=s.createQuery();n.aggregateIds=[e.getObjectId()];const{features:o}=await s.queryFeatures(n);return o}async function Iye({expressionInfo:e,arcadeUtils:t,interceptor:i,spatialReference:r,map:s,graphic:n,view:o}){if(!e||!e.expression)return null;const a=t.createSyntaxTree(e.expression),l=ZVe.filter(m=>t.hasVariable(a,m)),[c]=await Promise.all([r8e({graphic:n,view:o}),t.loadScriptDependencies(a,!0,l)]),h=t.getViewInfo({spatialReference:r}),p=t.createExecContext(n,h);p.interceptor=i,p.useAsync=!0,i8e({aggregatedFeatures:c,arcadeUtils:t,featureSetVars:l,context:p,viewInfo:h,map:s,graphic:n,interceptor:i});const f=t.createFunction(a,p);return t.executeAsyncFunction(f,p).catch(m=>JVe.error("arcade-execution-error",{error:m,graphic:n,expressionInfo:e}))}async function s8e({expressionInfos:e,spatialReference:t,graphic:i,interceptor:r,map:s,view:n}){if(!e||!e.length)return{};const o=await Pye(),a={};for(const h of e)a[`expression/${h.name}`]=Iye({expressionInfo:h,arcadeUtils:o,interceptor:r,spatialReference:t,map:s,graphic:i,view:n});const l=await pn(a),c={};for(const h in l)c[h]=KVe(l[h].value);return c}const n8e=1;let Cc=class extends mw(Ee){constructor(e){super(e),this._abortController=null,this.expressionInfo=null,this.graphic=null,this.contentElement=null,this.contentElementViewModel=null,this.interceptor=null,this.view=null,this._cancelQuery=()=>{const{_abortController:t}=this;t&&t.abort(),this._abortController=null},this._createVM=()=>{var r,s;const t=(r=this.contentElement)==null?void 0:r.type;(s=this.contentElementViewModel)==null||s.destroy();const i=t==="fields"?new V4:t==="media"?new Q1:t==="text"?new ON:null;this._set("contentElementViewModel",i)},this._compile=async()=>{this._cancelQuery();const t=new AbortController;this._abortController=t,await this._compileExpression(),this._abortController===t&&(this._abortController=null)},this._compileThrottled=aW(this._compile,n8e,this),this._compileExpression=async()=>{const{expressionInfo:t,graphic:i,interceptor:r,spatialReference:s,map:n,view:o,_abortController:a}=this;if(!(t&&i&&s&&n))return void this._set("contentElement",null);const l=await Pye();if(a!==this._abortController)return;const c=await Iye({arcadeUtils:l,expressionInfo:t,graphic:i,interceptor:r,map:n,spatialReference:s,view:o});if(!c||c.declaredClass!=="esri.arcade.Dictionary")return void this._set("contentElement",null);const h=await qW(c,a.signal),p=h==null?void 0:h.type,f=p==="media"?ZR.fromJSON(h):p==="text"?DS.fromJSON(h):p==="fields"?$S.fromJSON(h):null;this._set("contentElement",f)},this.handles.add([ae(()=>[this.expressionInfo,this.graphic,this.map,this.spatialReference,this.view],()=>this._compileThrottled(),Ft),ae(()=>[this.contentElement],()=>this._createVM(),Ft)])}destroy(){var e;this._cancelQuery(),(e=this.contentElementViewModel)==null||e.destroy(),this._set("contentElementViewModel",null),this._set("contentElement",null)}get spatialReference(){var e;return((e=this.view)==null?void 0:e.spatialReference)||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get state(){const{_abortController:e,contentElement:t,contentElementViewModel:i}=this;return e?"loading":t||i?"ready":"disabled"}get map(){var e;return((e=this.view)==null?void 0:e.map)||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}};u([d()],Cc.prototype,"_abortController",void 0),u([d({type:Oue})],Cc.prototype,"expressionInfo",void 0),u([d({type:Ca})],Cc.prototype,"graphic",void 0),u([d({readOnly:!0})],Cc.prototype,"contentElement",void 0),u([d({readOnly:!0})],Cc.prototype,"contentElementViewModel",void 0),u([d()],Cc.prototype,"interceptor",void 0),u([d()],Cc.prototype,"spatialReference",null),u([d({readOnly:!0})],Cc.prototype,"state",null),u([d()],Cc.prototype,"map",null),u([d()],Cc.prototype,"view",void 0),Cc=u([P("esri.widgets.Feature.FeatureExpression.FeatureExpressionViewModel")],Cc);const dX=Cc,SP={iconLoading:"esri-icon-loading-indicator esri-rotating",base:"esri-feature-expression",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"};let AD=class extends ml{constructor(e,t){super(e,t),this.viewModel=new dX}initialize(){this.own(ae(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentElementViewModel},()=>this._setupExpressionWidget(),Ft))}destroy(){this._destroyContentWidget()}renderLoading(){return ue("div",{key:"loading-container",class:SP.loadingSpinnerContainer},ue("span",{class:this.classes(SP.iconLoading,SP.spinner)}))}render(){var t;const{state:e}=this.viewModel;return ue("div",{class:SP.base},e==="loading"?this.renderLoading():e==="disabled"?null:(t=this._contentWidget)==null?void 0:t.render())}_destroyContentWidget(){const{_contentWidget:e}=this;e&&(e.viewModel=null,e.destroy()),this._contentWidget=null}_setupExpressionWidget(){const{contentElementViewModel:e,contentElement:t}=this.viewModel,i=t==null?void 0:t.type;this._destroyContentWidget();const r=e?i==="fields"?new Jfe({viewModel:e}):i==="media"?new Ime({viewModel:e}):i==="text"?new nD({viewModel:e}):null:null;this._contentWidget=r,this.scheduleRender()}};u([d({type:dX})],AD.prototype,"viewModel",void 0),AD=u([P("esri.widgets.Feature.FeatureExpression")],AD);const o8e=AD;class a8e{constructor(t,i){this.preLayerQueryCallback=t,this.preRequestCallback=i,this.preLayerQueryCallback||(this.preLayerQueryCallback=r=>{}),this.preRequestCallback||(this.preLayerQueryCallback=r=>{})}}var RD;const l8e=1,lte="content-view-models",$ye="esri.widgets.FeatureViewModel",c8e=me.getLogger($ye),cte={attachmentsContent:!0,chartAnimation:!0,customContent:!0,expressionContent:!0,fieldsContent:!0,mediaContent:!0,textContent:!0};let ds=RD=class extends Ee{constructor(e){super(e),this._handles=new qt,this._error=null,this._featureAbortController=null,this.graphicChangedThrottled=aW(this._graphicChanged,l8e,this),this._expressionAttributes=null,this._graphicExpressionAttributes=null,this.abilities=F({},cte),this.content=null,this.contentViewModels=[],this.defaultPopupTemplateEnabled=!1,this.formattedAttributes=null,this.lastEditInfo=null,this.relatedInfos=new Map,this.title="",this.view=null,this._isAllowedContentType=t=>{const{abilities:i}=this;return t.type==="attachments"&&i.attachmentsContent||t.type==="custom"&&i.customContent||t.type==="fields"&&i.fieldsContent||t.type==="media"&&i.mediaContent||t.type==="text"&&i.textContent||t.type==="expression"&&i.expressionContent},this._handles.add(ae(()=>[this.graphic,this._effectivePopupTemplate,this.abilities],()=>this.graphicChangedThrottled(),Ft))}destroy(){this._clear(),this._cancelFeatureQuery(),this._error=null,this._handles.destroy(),this._handles=null,this.graphic=null,this._destroyContentViewModels(),this.relatedInfos.clear()}get _effectivePopupTemplate(){return _(this.graphic)?this.graphic.getEffectivePopupTemplate(this.defaultPopupTemplateEnabled):null}get _fieldInfoMap(){return gLe(rK(this._effectivePopupTemplate),this._sourceLayer)}get _sourceLayer(){return kfe(this.graphic)}castAbilities(e){return F(F({},cte),e)}get state(){return this.graphic?this._error?"error":this.waitingForContent?"loading":"ready":"disabled"}set graphic(e){this._set("graphic",e?e.clone():null)}get spatialReference(){return this.get("view.spatialReference")||null}set spatialReference(e){e!==void 0?this._override("spatialReference",e):this._clearOverride("spatialReference")}get map(){return this.get("view.map")||null}set map(e){e!==void 0?this._override("map",e):this._clearOverride("map")}get waitingForContent(){return!!this._featureAbortController}setActiveMedia(e,t){const i=this.contentViewModels[e];i instanceof Q1&&i.setActiveMedia(t)}nextMedia(e){const t=this.contentViewModels[e];t instanceof Q1&&t.next()}previousMedia(e){const t=this.contentViewModels[e];t instanceof Q1&&t.previous()}_clear(){this._set("title",""),this._set("content",null),this._set("formattedAttributes",null)}async _graphicChanged(){this._cancelFeatureQuery(),this._error=null,this._clear();const{graphic:e}=this;if(!e)return;const t=new AbortController;this._featureAbortController=t;try{await this._queryFeature({signal:t.signal})}catch(i){Gr(i)||(this._error=i,c8e.error("error","The popupTemplate could not be displayed for this feature.",{error:i,graphic:e,popupTemplate:this._effectivePopupTemplate}))}this._featureAbortController===t&&(this._featureAbortController=null)}_cancelFeatureQuery(){const{_featureAbortController:e}=this;e&&e.abort(),this._featureAbortController=null}_compileContentElement(e,t){return e.type==="attachments"?this._compileAttachments(e,t):e.type==="custom"?this._compileCustom(e,t):e.type==="fields"?this._compileFields(e,t):e.type==="media"?this._compileMedia(e,t):e.type==="text"?this._compileText(e,t):e.type==="expression"?this._compileExpression(e,t):void 0}_compileContent(e){if(this._destroyContentViewModels(),this.graphic)return Array.isArray(e)?e.filter(this._isAllowedContentType).map((t,i)=>this._compileContentElement(t,i)):typeof e=="string"?this._compileText(new DS({text:e}),0).text:e}_destroyContentViewModels(){var e;(e=this._handles)==null||e.remove(lte),this.contentViewModels.forEach(t=>t&&!t.destroyed&&t.destroy()),this._set("contentViewModels",[])}_setExpressionContentVM(e,t){const{formattedAttributes:i}=this,{contentElement:r,contentElementViewModel:s}=e,n=r==null?void 0:r.type;s&&n&&(n==="fields"&&(this._createFieldsFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createFieldsVMParams(r,t))),n==="media"&&(this._createMediaFormattedAttributes({contentElement:r,contentElementIndex:t,formattedAttributes:i}),s.set(this._createMediaVMParams(r,t))),n==="text"&&s.set(this._createTextVMParams(r)))}_compileExpression(e,t){const{expressionInfo:i}=e,{graphic:r,map:s,spatialReference:n,view:o}=this,a=new dX({expressionInfo:i,graphic:r,interceptor:RD.interceptor,map:s,spatialReference:n,view:o});return this.contentViewModels[t]=a,this._handles.add(ae(()=>a.contentElementViewModel,()=>this._setExpressionContentVM(a,t),Ft),lte),e}_compileAttachments(e,t){const{graphic:i}=this,{description:r,title:s}=e;return this.contentViewModels[t]=new gW(F({graphic:i},this._compileTitleAndDesc({title:s,description:r}))),e}_compileCustom(e,t){const{graphic:i}=this,{creator:r,destroyer:s}=e;return this.contentViewModels[t]=new ON({graphic:i,creator:r,destroyer:s}),e}_compileTitleAndDesc({title:e,description:t}){const{_fieldInfoMap:i,_sourceLayer:r,graphic:s,formattedAttributes:n,_expressionAttributes:o}=this,{attributes:a}=s,l=n.global;return{title:Y1({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:e}),description:Y1({attributes:a,fieldInfoMap:i,globalAttributes:l,expressionAttributes:o,layer:r,text:t})}}_createFieldsVMParams(e,t){var c;const{_effectivePopupTemplate:i,formattedAttributes:r}=this,s=F(F({},r.global),r.content[t]),n=(c=(e==null?void 0:e.fieldInfos)||(i==null?void 0:i.fieldInfos))==null?void 0:c.filter(({fieldName:h})=>Vfe(h)||Zm(h)||s.hasOwnProperty(h)),o=i==null?void 0:i.expressionInfos,{description:a,title:l}=e;return F({attributes:s,expressionInfos:o,fieldInfos:n},this._compileTitleAndDesc({title:l,description:a}))}_compileFields(e,t){const i=e.clone(),r=new V4(this._createFieldsVMParams(e,t));return this.contentViewModels[t]=r,i.fieldInfos=r.formattedFieldInfos.slice(0),i}_createMediaVMParams(e,t){const{abilities:i,graphic:r,_fieldInfoMap:s,formattedAttributes:n,_effectivePopupTemplate:o,relatedInfos:a,_sourceLayer:l,_expressionAttributes:c}=this,{attributes:h}=r,{description:p,mediaInfos:f,title:m}=e;return F({abilities:{chartAnimation:i.chartAnimation},activeMediaInfoIndex:e.activeMediaInfoIndex||0,attributes:h,layer:l,fieldInfoMap:s,formattedAttributes:F(F({},n.global),n.content[t]),expressionAttributes:c,mediaInfos:f,popupTemplate:o,relatedInfos:a},this._compileTitleAndDesc({title:m,description:p}))}_compileMedia(e,t){const i=e.clone(),r=new Q1(this._createMediaVMParams(e,t));return i.mediaInfos=r.formattedMediaInfos.slice(0),this.contentViewModels[t]=r,i}_createTextVMParams(e){const{graphic:t,_fieldInfoMap:i,_sourceLayer:r,_expressionAttributes:s}=this;if(e&&e.text){const{attributes:n}=t,o=this.formattedAttributes.global;e.text=Y1({attributes:n,fieldInfoMap:i,globalAttributes:o,expressionAttributes:s,layer:r,text:e.text})}return{graphic:t,creator:e.text}}_compileText(e,t){const i=e.clone();return this.contentViewModels[t]=new ON(this._createTextVMParams(i)),i}_compileLastEditInfo(){const{_effectivePopupTemplate:e,_sourceLayer:t,graphic:i}=this;if(!e)return;const{lastEditInfoEnabled:r}=e,s=t==null?void 0:t.editFieldsInfo;return r&&s?mLe(s,i.attributes):void 0}_compileTitle(e){const{_fieldInfoMap:t,_sourceLayer:i,graphic:r,_expressionAttributes:s}=this,{attributes:n}=r,o=this.formattedAttributes.global;return Y1({attributes:n,fieldInfoMap:t,globalAttributes:o,expressionAttributes:s,layer:i,text:e})}async _getTitle(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.title;return RN(i,{graphic:t})}async _getContent(){const{_effectivePopupTemplate:e,graphic:t}=this,i=e==null?void 0:e.content;return RN(i,{graphic:t})}async _queryFeature(e){const{_featureAbortController:t,_sourceLayer:i,graphic:r,_effectivePopupTemplate:s,spatialReference:n,map:o,view:a}=this,{content:{value:l},title:{value:c}}=await pn({content:this._getContent(),title:this._getTitle()});if(t!==this._featureAbortController||!r)return;await _Le({graphic:r,popupTemplate:s,layer:i,spatialReference:n},e);const{expressionAttributes:{value:h}}=await pn({checkForRelatedFeatures:this._checkForRelatedFeatures(e),expressionAttributes:s8e({expressionInfos:s==null?void 0:s.expressionInfos,spatialReference:n,graphic:r,map:o,interceptor:RD.interceptor,view:a})});t===this._featureAbortController&&r&&(this._expressionAttributes=h,this._graphicExpressionAttributes=F(F({},r.attributes),h),this._set("formattedAttributes",this._createFormattedAttributes(l)),this._set("title",this._compileTitle(c)),this._set("lastEditInfo",this._compileLastEditInfo()||null),this._set("content",this._compileContent(l)||null))}_createMediaFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){const{_effectivePopupTemplate:r,graphic:s,relatedInfos:n,_sourceLayer:o,_fieldInfoMap:a,_graphicExpressionAttributes:l}=this;i.content[t]=Mk({fieldInfos:r==null?void 0:r.fieldInfos,graphic:s,attributes:F(F({},l),e.attributes),layer:o,fieldInfoMap:a,relatedInfos:n})}_createFieldsFormattedAttributes({contentElement:e,contentElementIndex:t,formattedAttributes:i}){if(e.fieldInfos){const{graphic:r,relatedInfos:s,_sourceLayer:n,_fieldInfoMap:o,_graphicExpressionAttributes:a}=this;i.content[t]=Mk({fieldInfos:e.fieldInfos,graphic:r,attributes:F(F({},a),e.attributes),layer:n,fieldInfoMap:o,relatedInfos:s})}}_createFormattedAttributes(e){const{_effectivePopupTemplate:t,graphic:i,relatedInfos:r,_sourceLayer:s,_fieldInfoMap:n,_graphicExpressionAttributes:o}=this,a=t==null?void 0:t.fieldInfos,l={global:Mk({fieldInfos:a,graphic:i,attributes:o,layer:s,fieldInfoMap:n,relatedInfos:r}),content:[]};return Array.isArray(e)&&e.forEach((c,h)=>{c.type==="fields"&&this._createFieldsFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l}),c.type==="media"&&this._createMediaFormattedAttributes({contentElement:c,contentElementIndex:h,formattedAttributes:l})}),l}_checkForRelatedFeatures(e){const{graphic:t,_effectivePopupTemplate:i}=this;return this._queryRelatedInfos(t,rK(i),e)}async _queryRelatedInfos(e,t,i){const{relatedInfos:r,_sourceLayer:s}=this;r.clear();const n=_(s.associatedLayer)?await s.associatedLayer.load(i):s;if(!n)return;const o=t.filter(c=>c&&Zm(c.fieldName));if(!o||!o.length)return;t.forEach(c=>this._configureRelatedInfo(c,n));const a=await $4e({relatedInfos:r,layer:n},i);Object.keys(a).forEach(c=>{var f;const h=r.get(c.toString()),p=(f=a[c])==null?void 0:f.value;h&&p&&(h.layerInfo=p.data)});const l=await D4e({graphic:e,relatedInfos:r,layer:n},i);Object.keys(l).forEach(c=>{var h;R4e((h=l[c])==null?void 0:h.value,r.get(c.toString()))})}_configureRelatedInfo(e,t){const{relatedInfos:i}=this,r=W9(e.fieldName);if(!r)return;const{layerId:s,fieldName:n}=r;if(!s)return;const o=i.get(s.toString())||A4e(s,t);o&&(L4e({relatedInfo:o,fieldName:n,fieldInfo:e}),this.relatedInfos.set(s,o))}};ds.interceptor=new a8e(xLe,TLe),u([d()],ds.prototype,"_error",void 0),u([d()],ds.prototype,"_featureAbortController",void 0),u([d({readOnly:!0})],ds.prototype,"_effectivePopupTemplate",null),u([d({readOnly:!0})],ds.prototype,"_fieldInfoMap",null),u([d({readOnly:!0})],ds.prototype,"_sourceLayer",null),u([d()],ds.prototype,"abilities",void 0),u([Ot("abilities")],ds.prototype,"castAbilities",null),u([d({readOnly:!0})],ds.prototype,"content",void 0),u([d({readOnly:!0})],ds.prototype,"contentViewModels",void 0),u([d({type:Boolean})],ds.prototype,"defaultPopupTemplateEnabled",void 0),u([d({readOnly:!0})],ds.prototype,"state",null),u([d({readOnly:!0})],ds.prototype,"formattedAttributes",void 0),u([d({type:Ca,value:null})],ds.prototype,"graphic",null),u([d({readOnly:!0})],ds.prototype,"lastEditInfo",void 0),u([d({readOnly:!0})],ds.prototype,"relatedInfos",void 0),u([d()],ds.prototype,"spatialReference",null),u([d({readOnly:!0})],ds.prototype,"title",void 0),u([d()],ds.prototype,"map",null),u([d({readOnly:!0})],ds.prototype,"waitingForContent",null),u([d()],ds.prototype,"view",void 0),ds=RD=u([P($ye)],ds);const pX=ds,Dye=e=>{let t=class extends e{constructor(){super(...arguments),this.renderNodeContent=i=>Qfe(i)&&!i.destroyed?ue("div",{key:i},i.render()):i instanceof HTMLElement?ue("div",{key:i,bind:i,afterCreate:this._attachToNode}):BLe(i)?ue("div",{key:i,bind:i.domNode,afterCreate:this._attachToNode}):null}_attachToNode(i){const r=this;i.appendChild(r)}};return t=u([P("esri.widgets.Feature.ContentMixin")],t),t},Oo={iconText:"esri-icon-font-fallback-text",iconLoading:"esri-icon-loading-indicator esri-rotating",esriTable:"esri-widget__table",esriWidget:"esri-widget",base:"esri-feature",container:"esri-feature__size-container",title:"esri-feature__title",main:"esri-feature__main-container",btn:"esri-feature__button",icon:"esri-feature__icon",content:"esri-feature__content",contentElement:"esri-feature__content-element",text:"esri-feature__text",lastEditedInfo:"esri-feature__last-edited-info",fields:"esri-feature__fields",fieldHeader:"esri-feature__field-header",fieldData:"esri-feature__field-data",fieldDataDate:"esri-feature__field-data--date",loadingSpinnerContainer:"esri-feature__loading-container",spinner:"esri-feature__loading-spinner"},ute={title:!0,content:!0,lastEditedInfo:!0};let No=class extends Dye(ml){constructor(e,t){super(e,t),this._contentWidgets=[],this.graphic=null,this.defaultPopupTemplateEnabled=!1,this.headingLevel=2,this.label=void 0,this.messages=null,this.messagesCommon=null,this.messagesURIUtils=null,this.spatialReference=null,this.title=null,this.visibleElements=F({},ute),this.map=null,this.view=null,this.viewModel=new pX}initialize(){this.own(ae(()=>{var e;return(e=this.viewModel)==null?void 0:e.contentViewModels},()=>this._setupContentWidgets(),Ft))}loadDependencies(){return import("./calcite-notice.f57e4c08.js")}destroy(){this._destroyContentWidgets()}castVisibleElements(e){return F(F({},ute),e)}render(){const{state:e}=this.viewModel,t=ue("div",{class:Oo.container,key:"container"},this.renderTitle(),e==="error"?this.renderError():e==="loading"?this.renderLoading():this.renderContentContainer());return ue("div",{class:this.classes(Oo.base,Oo.esriWidget)},t)}setActiveMedia(e,t){this.viewModel.setActiveMedia(e,t)}nextMedia(e){this.viewModel.nextMedia(e)}previousMedia(e){this.viewModel.previousMedia(e)}renderError(){const{messagesCommon:e,messages:t,visibleElements:i}=this;return ue("calcite-notice",{active:!0,color:"red",icon:"exclamation-mark-circle",scale:"s"},i.title?ue("div",{key:"error-title",slot:"title"},e.errorMessage):null,ue("div",{key:"error-message",slot:"message"},t.loadingError))}renderLoading(){return ue("div",{key:"loading-container",class:Oo.loadingSpinnerContainer},ue("span",{class:this.classes(Oo.iconLoading,Oo.spinner)}))}renderContentContainer(){const{visibleElements:e}=this;return e.content?ue("div",{class:Oo.main},[this.renderContent(),this.renderLastEditInfo()]):null}renderTitle(){const{visibleElements:e,title:t}=this;return e.title?ue(yW,{level:this.headingLevel,class:Oo.title,innerHTML:t}):null}renderContent(){const e=this.viewModel.content,t="content";if(!e)return null;if(Array.isArray(e))return e.length?ue("div",{key:`${t}-content-elements`},e.map(this.renderContentElement,this)):null;if(typeof e=="string"){const i=this._contentWidgets[0];return!i||i.destroyed?null:ue("div",{key:`${t}-content`},i.render())}return this.renderNodeContent(e)}renderContentElement(e,t){const{visibleElements:i}=this;if(typeof i.content!="boolean"&&!i.content[e.type])return null;switch(e.type){case"attachments":return this.renderAttachments(t);case"custom":return this.renderCustom(e,t);case"fields":return this.renderFields(t);case"media":return this.renderMedia(t);case"text":return this.renderText(e,t);case"expression":return this.renderExpression(t);default:return null}}renderAttachments(e){const t=this._contentWidgets[e];if(!t||t.destroyed)return null;const{state:i,attachmentInfos:r}=t.viewModel;return i==="loading"||r.length>0?ue("div",{key:this._buildKey("attachments-element",e),class:this.classes(Oo.contentElement)},t.render()):null}renderExpression(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:ue("div",{key:this._buildKey("expression-element",e),class:Oo.contentElement},t.render())}renderCustom(e,t){const{creator:i}=e,r=this._contentWidgets[t];return!r||r.destroyed?null:i?ue("div",{key:this._buildKey("custom-element",t),class:Oo.contentElement},r.render()):null}renderFields(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:ue("div",{key:this._buildKey("fields-element",e),class:Oo.contentElement},t.render())}renderMedia(e){const t=this._contentWidgets[e];return!t||t.destroyed?null:ue("div",{key:this._buildKey("media-element",e),class:Oo.contentElement},t.render())}renderLastEditInfo(){const{visibleElements:e,messages:t}=this,{lastEditInfo:i}=this.viewModel;if(!i||!e.lastEditedInfo)return null;const{date:r,user:s}=i,n=i.type==="edit"?s?t.lastEditedByUser:t.lastEdited:s?t.lastCreatedByUser:t.lastCreated,o=mm(n,{date:r,user:s});return ue("div",{key:"edit-info-element",class:this.classes(Oo.lastEditedInfo,Oo.contentElement)},o)}renderText(e,t){const i=e.text,r=this._contentWidgets[t];return!r||r.destroyed?null:i?ue("div",{key:this._buildKey("text-element",t),class:this.classes(Oo.contentElement,Oo.text)},r.render()):null}_buildKey(e,...t){return`${e}__${this.get("viewModel.graphic.uid")||"0"}-${t.join("-")}`}_destroyContentWidget(e){e&&(e.viewModel=null,!e.destroyed&&e.destroy())}_destroyContentWidgets(){this._contentWidgets.forEach(e=>this._destroyContentWidget(e)),this._contentWidgets=[]}_setupContentWidgets(){this._destroyContentWidgets();const{headingLevel:e,visibleElements:t}=this,i=this.get("viewModel.content"),{contentViewModels:r}=this.viewModel;if(Array.isArray(i))i.forEach((s,n)=>{s.type==="attachments"&&(this._contentWidgets[n]=new $Le({displayType:s.displayType,headingLevel:t.title?e+1:e,viewModel:r[n]})),s.type==="fields"&&(this._contentWidgets[n]=new Jfe({viewModel:r[n]})),s.type==="media"&&(this._contentWidgets[n]=new Ime({viewModel:r[n]})),s.type==="text"&&(this._contentWidgets[n]=new nD({viewModel:r[n]})),s.type==="custom"&&(this._contentWidgets[n]=new nD({viewModel:r[n]})),s.type==="expression"&&(this._contentWidgets[n]=new o8e({viewModel:r[n]}))},this);else{const s=r[0];s&&!s.destroyed&&(this._contentWidgets[0]=new nD({viewModel:s}))}this.scheduleRender()}};u([wt("viewModel.graphic")],No.prototype,"graphic",void 0),u([wt("viewModel.defaultPopupTemplateEnabled")],No.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],No.prototype,"headingLevel",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],No.prototype,"label",void 0),u([d(),Ql("esri/widgets/Feature/t9n/Feature")],No.prototype,"messages",void 0),u([d(),Ql("esri/t9n/common")],No.prototype,"messagesCommon",void 0),u([d(),Ql("esri/widgets/support/t9n/uriUtils")],No.prototype,"messagesURIUtils",void 0),u([wt("viewModel.spatialReference")],No.prototype,"spatialReference",void 0),u([wt("viewModel.title")],No.prototype,"title",void 0),u([d()],No.prototype,"visibleElements",void 0),u([Ot("visibleElements")],No.prototype,"castVisibleElements",null),u([wt("viewModel.map")],No.prototype,"map",void 0),u([wt("viewModel.view")],No.prototype,"view",void 0),u([d({type:pX})],No.prototype,"viewModel",void 0),No=u([P("esri.widgets.Feature")],No);const u8e=No;var Lye;const MD=Symbol("anchorHandles");let s1=class extends us.EventedAccessor{constructor(e){super(e),this[Lye]=new qt,this.location=null,this.screenLocationEnabled=!1,this.view=null,this[MD].add([cl(()=>qs(this.screenLocationEnabled?this.view:null,t=>[t.size,t.type==="3d"?t.camera:t.viewpoint]),()=>this.notifyChange("screenLocation")),ae(()=>this.screenLocation,(t,i)=>{_(t)&&_(i)&&this.emit("view-change")})])}destroy(){this.view=null,this[MD]=ot(this[MD])}get screenLocation(){const{location:e,view:t,screenLocationEnabled:i}=this;return i&&_(e)&&_(t)&&t.ready?t.toScreen(e):null}};Lye=MD,u([d()],s1.prototype,"location",void 0),u([d()],s1.prototype,"screenLocation",null),u([d()],s1.prototype,"screenLocationEnabled",void 0),u([d()],s1.prototype,"view",void 0),s1=u([P("esri.widgets.support.AnchorElementViewModel")],s1);const Nye=s1,h8e="esri.widgets.CompassViewModel";let OD=class extends Nye{constructor(e){super(e),this.visible=!1}};u([d()],OD.prototype,"visible",void 0),OD=u([P(h8e)],OD);const Fye=OD,m6={base:"esri-spinner",spinnerStart:"esri-spinner--start",spinnerFinish:"esri-spinner--finish"};let n1=class extends ml{constructor(e,t){super(e,t),this._animationDelay=500,this._animationPromise=null,this.location=null,this.view=null,this.viewModel=new Fye,this.visible=!1}initialize(){this.own([ae(()=>this.visible,e=>this._visibleChange(e))])}destroy(){this._animationPromise=null}show(e){const{location:t,promise:i}=e;t&&(this.viewModel.location=t),this.visible=!0;const r=()=>this.hide();i&&i.catch(()=>{}).then(r)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:t}=this.viewModel,i=!!t,r=e&&i,s=!e&&i,n={[m6.spinnerStart]:r,[m6.spinnerFinish]:s},o=this._getPositionStyles();return ue("div",{class:this.classes(m6.base,n),styles:o})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const t=CS(this._animationDelay);this._animationPromise=t,t.catch(()=>{}).then(()=>{this._animationPromise===t&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:t}=this.viewModel;if(R(t)||R(e))return{};const{padding:i}=t;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([wt("viewModel.location")],n1.prototype,"location",void 0),u([wt("viewModel.view")],n1.prototype,"view",void 0),u([d({type:Fye})],n1.prototype,"viewModel",void 0),u([wt("viewModel.visible")],n1.prototype,"visible",void 0),n1=u([P("esri.widgets.Spinner")],n1);const d8e=n1;var hte;(function(e){e[e.size=22]="size",e[e.lineWidth=50]="lineWidth",e[e.maxSize=120]="maxSize",e[e.maxOutlineSize=80]="maxOutlineSize",e[e.tallSymbolWidth=20]="tallSymbolWidth"})(hte||(hte={}));function p8e(e){return"r"in e&&"g"in e&&"b"in e}function Uye(e){return"h"in e&&"s"in e&&"v"in e}function kye(e){return"l"in e&&"a"in e&&"b"in e}function zye(e){return"l"in e&&"c"in e&&"h"in e}function f8e(e){return"x"in e&&"y"in e&&"z"in e}const m8e=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],g8e=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function Vye(e,t){const i=[];let r,s;if(e[0].length!==t.length)throw"dimensions do not match";const n=e.length,o=e[0].length;let a=0;for(r=0;r<n;r++){for(a=0,s=0;s<o;s++)a+=e[r][s]*t[s];i.push(a)}return i}function Bye(e){const t=[e.r/255,e.g/255,e.b/255].map(r=>r<=.04045?r/12.92:((r+.055)/1.055)**2.4),i=Vye(m8e,t);return{x:100*i[0],y:100*i[1],z:100*i[2]}}function fX(e){const t=Vye(g8e,[e.x/100,e.y/100,e.z/100]).map(i=>{const r=i<=.0031308?12.92*i:1.055*i**.4166666666666667-.055;return Math.min(1,Math.max(r,0))});return{r:Math.round(255*t[0]),g:Math.round(255*t[1]),b:Math.round(255*t[2])}}function Gye(e){const t=[e.x/95.047,e.y/100,e.z/108.883].map(i=>i>.008856451679035631?i**.3333333333333333:7.787037037037035*i+.13793103448275862);return{l:116*t[1]-16,a:500*(t[0]-t[1]),b:200*(t[1]-t[2])}}function jye(e){const t=e.l,i=[(t+16)/116+e.a/500,(t+16)/116,(t+16)/116-e.b/200].map(r=>r>6/29?r**3:3*(6/29)**2*(r-4/29));return{x:95.047*i[0],y:100*i[1],z:108.883*i[2]}}function y8e(e){const t=e.l,i=e.a,r=e.b,s=Math.sqrt(i*i+r*r);let n=Math.atan2(r,i);return n=n>0?n:n+2*Math.PI,{l:t,c:s,h:n}}function v8e(e){const t=e.l,i=e.c,r=e.h;return{l:t,a:i*Math.cos(r),b:i*Math.sin(r)}}function _8e(e){return Gye(Bye(e))}function b8e(e){return fX(jye(e))}function w8e(e){return y8e(Gye(Bye(e)))}function x8e(e){return fX(jye(v8e(e)))}function T8e(e){const t=e.r,i=e.g,r=e.b,s=Math.max(t,i,r),n=s-Math.min(t,i,r);let o=s,a=n===0?0:s===t?(i-r)/n%6:s===i?(r-t)/n+2:(t-i)/n+4,l=n===0?0:n/o;return a<0&&(a+=6),a*=60,l*=100,o*=100/255,{h:a,s:l,v:o}}function S8e(e){const t=(e.h+360)%360/60,i=e.s/100,r=e.v/100*255,s=r*i,n=s*(1-Math.abs(t%2-1));let o;switch(Math.floor(t)){case 0:o={r:s,g:n,b:0};break;case 1:o={r:n,g:s,b:0};break;case 2:o={r:0,g:s,b:n};break;case 3:o={r:0,g:n,b:s};break;case 4:o={r:n,g:0,b:s};break;case 5:case 6:o={r:s,g:0,b:n};break;default:o={r:0,g:0,b:0}}return o.r=Math.round(o.r+r-s),o.g=Math.round(o.g+r-s),o.b=Math.round(o.b+r-s),o}function mX(e){return p8e(e)?e:zye(e)?x8e(e):kye(e)?b8e(e):f8e(e)?fX(e):Uye(e)?S8e(e):e}function P_t(e){return Uye(e)?e:T8e(mX(e))}function I_t(e){return kye(e)?e:_8e(mX(e))}function $_t(e){return zye(e)?e:w8e(mX(e))}function Hye(){const e=new Float32Array(6);return e[0]=1,e[3]=1,e}function E8e(e){const t=new Float32Array(6);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function C8e(e,t,i,r,s,n){const o=new Float32Array(6);return o[0]=e,o[1]=t,o[2]=i,o[3]=r,o[4]=s,o[5]=n,o}function A8e(e,t){return new Float32Array(e,t,6)}function qye(e,t,i,r){const s=t[r],n=t[r+1];e[r]=i[0]*s+i[2]*n+i[4],e[r+1]=i[1]*s+i[3]*n+i[5]}function R8e(e,t,i,r=0,s=0,n=2){const o=s||t.length/n;for(let a=r;a<o;a++)qye(e,t,i,a*n)}Object.freeze(Object.defineProperty({__proto__:null,create:Hye,clone:E8e,fromValues:C8e,createView:A8e,transform:qye,transformMany:R8e},Symbol.toStringTag,{value:"Module"}));function M8e(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function O8e(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=0,e[5]=0,e}function P8e(e,t,i,r,s,n,o){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e}function Wye(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5];let l=i*n-r*s;return l?(l=1/l,e[0]=n*l,e[1]=-r*l,e[2]=-s*l,e[3]=i*l,e[4]=(s*a-n*o)*l,e[5]=(r*o-i*a)*l,e):null}function I8e(e){return e[0]*e[3]-e[1]*e[2]}function Xye(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1],p=i[2],f=i[3],m=i[4],y=i[5];return e[0]=r*c+n*h,e[1]=s*c+o*h,e[2]=r*p+n*f,e[3]=s*p+o*f,e[4]=r*m+n*y+a,e[5]=s*m+o*y+l,e}function gX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=Math.sin(i),h=Math.cos(i);return e[0]=r*h+n*c,e[1]=s*h+o*c,e[2]=r*-c+n*h,e[3]=s*-c+o*h,e[4]=a,e[5]=l,e}function Yye(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r*c,e[1]=s*c,e[2]=n*h,e[3]=o*h,e[4]=a,e[5]=l,e}function yX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=i[0],h=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=r*c+n*h+a,e[5]=s*c+o*h+l,e}function $8e(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e[4]=0,e[5]=0,e}function D8e(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e[4]=0,e[5]=0,e}function vX(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e[4]=t[0],e[5]=t[1],e}function L8e(e){return"mat2d("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+")"}function N8e(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+1)}function F8e(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e}function Zye(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e}function U8e(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e}function k8e(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e}function z8e(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]}function V8e(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=t[0],c=t[1],h=t[2],p=t[3],f=t[4],m=t[5];return Math.abs(i-l)<=Et*Math.max(1,Math.abs(i),Math.abs(l))&&Math.abs(r-c)<=Et*Math.max(1,Math.abs(r),Math.abs(c))&&Math.abs(s-h)<=Et*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=Et*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=Et*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-m)<=Et*Math.max(1,Math.abs(a),Math.abs(m))}const B8e=Xye,G8e=Zye;Object.freeze(Object.defineProperty({__proto__:null,copy:M8e,identity:O8e,set:P8e,invert:Wye,determinant:I8e,multiply:Xye,rotate:gX,scale:Yye,translate:yX,fromRotation:$8e,fromScaling:D8e,fromTranslation:vX,str:L8e,frob:N8e,add:F8e,subtract:Zye,multiplyScalar:U8e,multiplyScalarAndAdd:k8e,exactEquals:z8e,equals:V8e,mul:B8e,sub:G8e},Symbol.toStringTag,{value:"Module"}));const dte=he("android");he("chrome")||dte&&dte>=4;f9();function Qye(e){return e&&"opacity"in e?e.opacity*Qye(e.parent):1}async function j8e(e,t){var w;if(!e)return;const i=e.sourceLayer,r=(w=_(t)&&t.useSourceLayer?i:e.layer)!=null?w:i,s=Qye(r);if(_(e.symbol)&&(!_(t)||t.ignoreGraphicSymbol!==!0)){const b=e.symbol.type==="web-style"?await e.symbol.fetchSymbol(ve(F({},t),{cache:_(t)?t.webStyleCache:null})):e.symbol.clone();return $k(b,null,s),b}const n=_(t)&&t.renderer||r&&"renderer"in r&&r.renderer;let o=n&&"getSymbolAsync"in n?await n.getSymbolAsync(e,t):null;if(!o)return;if(o=o.type==="web-style"?await o.fetchSymbol(ve(F({},t),{cache:_(t)?t.webStyleCache:null})):o.clone(),!("visualVariables"in n)||!n.visualVariables||!n.visualVariables.length)return $k(o,null,s),o;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&(R(t)||R(t.arcade))){const b=F({},t);b.arcade=await vf(),t=b}const a=await Promise.resolve().then(function(){return QW}),l=[],c=[],h=[],p=[];for(const b of n.visualVariables)switch(b.type){case"color":l.push(b);break;case"opacity":c.push(b);break;case"rotation":p.push(b);break;case"size":b.target||h.push(b)}const f=!!l.length&&l[l.length-1],m=f?a.getColor(f,e,t):null,y=!!c.length&&c[c.length-1];let v=y?a.getOpacity(y,e,t):null;if(s!=null&&(v=v!=null?v*s:s),$k(o,m,v),h.length){const b=a.getAllSizes(h,e,t);await KNe(o,b)}for(const b of p)eFe(o,a.getRotationAngle(b,e,t),b.axis);return o}class Tg{constructor(t,i){this.owner=i,this.properties={},this.afterDispatchHandle=null;for(const r in t){const s=t[r],n=new cce(s,null,null,2,2);this.properties[r]={pool:n,acquired:[]}}this.afterDispatchHandle=Ace(()=>this._release())}destroy(){this.afterDispatchHandle&&(this.afterDispatchHandle.remove(),this.afterDispatchHandle=null);for(const t in this.properties){const i=this.properties[t];for(const r of i.acquired)uQ(r)||i.pool.release(r);i.pool.destroy(),i.pool=null,i.acquired=null}this.properties=null,this.owner=null}get(t){const i=this.owner._get(t),r=this.properties[t];let s=r.pool.acquire();for(r.acquired.push(s);s===i;)r.acquired.push(s),s=r.pool.acquire();return s}_release(){for(const t in this.properties){const i=this.properties[t];let r=0;for(const s of i.acquired)uQ(s)?i.acquired[r++]=s:i.pool.release(s);i.acquired.length=r}}}const H8e=he("mac")?"Meta":"Ctrl",l5={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let e=48;e<58;e++)l5[e]=String.fromCharCode(e);for(let e=1;e<25;e++)l5[111+e]=`F${e}`;for(let e=65;e<91;e++)l5[e]=[String.fromCharCode(e+32),String.fromCharCode(e)];function q8e(e){if(e.key!==void 0)return A1(e);const t=l5[e.keyCode];return Array.isArray(t)?e.shiftKey?t[1]:t[0]:t}function W8e(e){switch(e){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}class X8e{constructor(t,i=[]){this.eventType=t,this.keyModifiers=i}matches(t){if(t.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const i=t.modifiers;for(const r of this.keyModifiers)if(!i.has(r))return!1;return!0}}const pte=me.getLogger("esri.views.input.InputHandler");class Ao{constructor(t){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=t}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const t in this._incoming){const i=this._incoming[t];for(const r of i)this._incomingEventMatches.push(r.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(t=>t.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(t){this._manager?pte.error("This InputHandler has already been registered with an InputManager"):(t.setEventCallback(i=>this._handleEvent(i)),t.setUninstallCallback(()=>this._onUninstall()),this._manager=t)}onUninstall(){}registerIncoming(t,i,r){let s;typeof i=="function"?(r=i,s=[]):s=i||[];const n=typeof t=="string"?new X8e(t,s):t,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new Y8e(n,r,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&!p.includes(h)&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(t){if(this._outgoing[t])throw Error("There is already a callback registered for this outgoing InputEvent: "+t);const i=new Z8e(t,{onEmit:(r,s,n,o)=>{this._manager.emit(r.eventType,s,n,o)},onRemove:r=>{delete this._outgoing[r.eventType],this._manager.updateDependencies()}});return this._outgoing[t]=i,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),i}startCapturingPointer(t){this._manager.setPointerCapture(t,!0)}stopCapturingPointer(t){this._manager.setPointerCapture(t,!1)}refreshHasPendingInputs(){this._manager.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):pte.error("This InputHandler is not registered with an InputManager")}_handleEvent(t){const i=this._incoming[t.type];if(i){for(const r of i)if(r.match.matches(t)&&(r.callback(t),t.shouldStopPropagation()))break}}}class Y8e{constructor(t,i,r){this.match=t,this._callback=i,this._handler=r}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}}class Z8e{constructor(t,i){this.eventType=t,this._removed=!1,this._handler=i}emit(t,i,r){this._removed||this._handler.onEmit(this,t,i,r)}remove(){this._removed=!0,this._handler.onRemove(this)}}class Q8e extends Ao{constructor(t){super(!0),this._onChange=t,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",i=>{const r=i.data.native.pointerType==="touch";this._setValue(r?"touch":"mouse",i.data.x,i.data.y)})}_setValue(t,i,r){t===this._value&&this._x===i&&this._y===r||(this._value=t,this._x=i,this._y=r,this._onChange(t,i,r))}}const g6=me.getLogger("esri.views.input.InputManager");let Yy=class extends Ee{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=H8e,this.latestPointerType="mouse",this._propertiesPool=new Tg({latestPointerLocation:K8e},this),this.latestPointerLocation=null,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const t of e)this.uninstallHandlers(t);this.eventSource=null,this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}installHandlers(e,t,i=rv.INTERNAL){if(this._nameToGroup[e])return void g6.error("There is already an InputHandler group registered under the name `"+e+"`");if(t.length===0)return void g6.error("Can't register a group of zero handlers");const r={name:e,handlers:t.map(s=>({handler:s,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=r;for(let s=r.handlers.length-1;s>=0;s--){const n=r.handlers[s];this._handlers.push(n),n.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(o,a,l,c,h)=>{this._emitInputEvent(n.priorityIndex+1,o,a,l,h,c)},setPointerCapture:(o,a)=>{this._setPointerCapture(r,n,o,a)},setEventCallback:o=>{n.eventCallback=o},setUninstallCallback:o=>{n.uninstallCallback=o},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const t=this._nameToGroup[e];t?(t.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):g6.error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,t=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const r=this._handlers[i];r.priorityIndex=i,this._handlersPriority.push(r)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const r=this._handlersPriority[i];r.priorityIndex=i;let s=r.handler.hasSideEffects;if(!s){for(const n of r.handler.outgoingEventTypes)if(e.has(n)){s=!0;break}}if(s)for(const n of r.handler.incomingEventMatches){e.add(n.eventType);for(const o of n.keyModifiers)W8e(o)||t.add(o)}r.active=s}this._sourceEvents=e,this._keyModifiers=t,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,t,i){this._get("latestPointerType")!==e&&this._set("latestPointerType",e);const r=this._get("latestPointerLocation");if(R(r)||r.x!==t||r.y!==i){const s=this._propertiesPool.get("latestPointerLocation");s.x=t,s.y=i,this._set("latestPointerLocation",s)}}_onEventReceived(e,t){if(e==="pointer-capture-lost"){const s=t;this._pointerCaptures.delete(s.native.pointerId)}this._updateKeyModifiers(e,t);const i=this.test.timestamp!=null?this.test.timestamp:t.native?t.native.timestamp:void 0,r=t.native?t.native.cancelable:void 0;this._emitInputEventFromSource(e,t,i,r)}_updateKeyModifiers(e,t){if(!t)return;let i=!1;const r=()=>{if(!i){const o=new Set;this._activeKeyModifiers.forEach(a=>{o.add(a)}),this._activeKeyModifiers=o,i=!0}},s=(o,a)=>{a&&!this._activeKeyModifiers.has(o)?(r(),this._activeKeyModifiers.add(o)):!a&&this._activeKeyModifiers.has(o)&&(r(),this._activeKeyModifiers.delete(o))};if(e==="key-down"||e==="key-up"){const o=t.key;this._keyModifiers.has(o)&&s(o,e==="key-down")}const n=t.native;s("Alt",!(!n||!n.altKey)),s("Ctrl",!(!n||!n.ctrlKey)),s("Shift",!(!n||!n.shiftKey)),s("Meta",!(!n||!n.metaKey)),s("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new Q8e((e,t,i)=>this._setLatestPointer(e,t,i)),this.installHandlers("input-manager-logic",[this._latestPointerHandler],rv.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,rv.INTERNAL)}_setPointerCapture(e,t,i,r){const s=e.name+"-"+t.priorityIndex,n=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,n),r?(n.add(s),n.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):n.has(s)&&(n.delete(s),n.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,t,i,r){this._emitInputEvent(0,e,t,i,r)}_emitInputEvent(e,t,i,r,s,n){const o=r!==void 0?r:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),a=s!==void 0&&s,l={event:new J8e(t,i,o,n||this._activeKeyModifiers,a),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(l):this._doNewPropagation(l)}_doNewPropagation(e){this._currentPropagation={events:new VB,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){const e=this._currentPropagation;if(e){for(;this._currentPropagation.events.length>0;){const{event:t,priorityIndex:i}=this._currentPropagation.events.pop(),r=t.data&&t.data.eventId;if(!(r!=null&&this._stoppedPropagationEventIds.has(r)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!t.shouldStopPropagation()&&e.currentHandler.eventCallback(t),t.shouldStopPropagation()){r!=null&&this._stoppedPropagationEventIds.add(r);break}if(t.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:t,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const t=new VB;for(t.push(e);this._currentPropagation.events.length;)t.push(this._currentPropagation.events.pop());this._currentPropagation.events=t,this._currentPropagation.currentHandler=null}_compareHandlerPriority(e,t){if(e.handler.hasSideEffects!==t.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==t.groupPriority)return e.groupPriority>t.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const r of t.handler.incomingEventMatches){if(i.eventType!==r.eventType)continue;const s=i.keyModifiers.filter(n=>r.keyModifiers.includes(n));if(s.length===i.keyModifiers.length!=(s.length===r.keyModifiers.length))return i.keyModifiers.length>r.keyModifiers.length?-1:1}return e.priorityIndex>t.priorityIndex?-1:1}_sortHandlersPriority(e){const t=[];for(const i of e){let r=0;for(;r<t.length&&this._compareHandlerPriority(i,t[r])>=0;)r++;t.splice(r,0,i)}return t}get debug(){const e=t=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},t(),this._setPointerCapture=i};return{injectEvent:(t,i)=>{e(()=>{this._onEventReceived(t,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],Yy.prototype,"hasPendingInputs",null),u([d()],Yy.prototype,"eventSource",void 0),u([d()],Yy.prototype,"recognizers",void 0),u([d({readOnly:!0})],Yy.prototype,"latestPointerType",void 0),u([d({readOnly:!0})],Yy.prototype,"latestPointerLocation",void 0),Yy=u([P("esri.views.input.InputManager")],Yy);class J8e{constructor(t,i,r,s,n){this.type=t,this.data=i,this.timestamp=r,this.modifiers=s,this.cancelable=n,this._propagationState=m0.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=m0.STOPPED}shouldStopPropagation(){return(this._propagationState&m0.STOPPED)!=0}async(t){this._propagationState|=m0.PAUSED;const i=(r,s)=>{this._propagationState&=~m0.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw r;return r};return(typeof t=="function"?t():t).then(r=>i(r,!1),r=>i(r,!0))}shouldPausePropagation(t){return!!(this._propagationState&m0.PAUSED)&&(this._resumeCallback=t,!0)}preventDefault(){this.data.native.preventDefault()}}var m0;(function(e){e[e.NONE=0]="NONE",e[e.STOPPED=1]="STOPPED",e[e.PAUSED=2]="PAUSED"})(m0||(m0={}));const rv={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};class K8e{}function fte(e){return e&&typeof e.highlight=="function"}function eBe(e){return e&&typeof e.maskOccludee=="function"}function D_t(e,t,i){return R(e)||e>i&&(t===0||e<t)}function L_t(e,t){return e>0||t>0}function N_t(e){var i,r;const t=e.effectiveScaleRange;return{minScale:(i=t==null?void 0:t.minScale)!=null?i:0,maxScale:(r=t==null?void 0:t.maxScale)!=null?r:0}}const c5={iconZoom:"esri-icon-zoom-in-magnifying-glass",iconTrash:"esri-icon-trash",iconBrowseClusteredFeatures:"esri-icon-table"},K1=new z2({id:"zoom-to-feature",title:"{messages.zoom}",className:c5.iconZoom}),mte=new z2({id:"remove-selected-feature",title:"{messages.remove}",className:c5.iconTrash}),MT=new z2({id:"zoom-to-clustered-features",title:"{messages.zoom}",className:c5.iconZoom}),OT=new z2({id:"browse-clustered-features",title:"{messages.browseClusteredFeatures}",className:c5.iconBrowseClusteredFeatures}),tBe="esri.widgets.Popup.PopupViewModel",VN=me.getLogger(tBe),iBe=e=>{const{event:t,view:i}=e,{action:r}=t,s=i&&i.popup;if(!r)return Promise.reject(new q("trigger-action:missing-arguments","Event has no action"));if(!s)return Promise.reject(new q("trigger-action:missing-arguments","view.popup is missing"));const{disabled:n,id:o}=r;if(!o)return Promise.reject(new q("trigger-action:invalid-action","action.id is missing"));if(n)return Promise.reject(new q("trigger-action:invalid-action","Action is disabled"));if(o===K1.id)return sBe(s.viewModel).catch(r8);if(o===MT.id)return nBe(s.viewModel);if(o===OT.id)return s.featureMenuOpen=!s.featureMenuOpen,s.viewModel.browseClusterEnabled=!s.viewModel.browseClusterEnabled,Promise.resolve();if(s.viewModel.browseClusterEnabled=!1,o===mte.id){s.close();const{selectedFeature:a}=s;if(!a)return Promise.reject(new q(`trigger-action:${mte.id}`,"selectedFeature is required",{selectedFeature:a}));const{sourceLayer:l}=a;return l?l.remove(a):i.graphics.remove(a),Promise.resolve()}return Promise.resolve()};function Jye(e){const{selectedFeature:t,location:i,view:r}=e;return r?r.type==="3d"?t||i:e.get("selectedFeature.geometry")||i:null}function L1(e){var t,i;return(e==null?void 0:e.isAggregate)&&((i=(t=e==null?void 0:e.sourceLayer)==null?void 0:t.featureReduction)==null?void 0:i.type)==="cluster"}function rBe(e,t){if((t==null?void 0:t.type)!=="3d"||!e||e.declaredClass!=="esri.Graphic")return!0;const i=t.getViewForGraphic(e);if(i&&"whenGraphicBounds"in i){let r=!1;return i.whenGraphicBounds(e,{useViewElevation:!0}).then(s=>{r=!s||!s.boundingBox||s.boundingBox[0]===s.boundingBox[3]&&s.boundingBox[1]===s.boundingBox[4]&&s.boundingBox[2]===s.boundingBox[5]}).catch(()=>{const s=new q("zoom-to:invalid-graphic","Could not zoom to the location of the graphic.",{graphic:e});VN.error(s)}),r}return!0}async function sBe(e){const{location:t,selectedFeature:i,view:r,zoomFactor:s}=e,n=Jye(e);if(!n){const c=new q("zoom-to:invalid-target-or-view","Cannot zoom to location without a target and view.",{target:n,view:r});throw VN.error(c),c}const o=r.scale/s,a=e.get("selectedFeature.geometry")||t,l=a&&a.type==="point"&&rBe(i,r);K1.active=!0,K1.disabled=!0;try{await e.view.goTo({target:n,scale:l?o:void 0})}finally{K1.active=!1,K1.disabled=!1,e.zoomToLocation=null,l&&(e.location=a)}}async function nBe(e){const{selectedFeature:t,view:i}=e;if((i==null?void 0:i.type)!=="2d"){const a=new q("zoomToCluster:invalid-view","View must be 2d MapView.",{view:i});throw VN.error(a),a}if(!L1(t)){const a=new q("zoomToCluster:invalid-selectedFeature","Selected feature must represent an aggregate/cluster graphic.",{selectedFeature:t});throw VN.error(a),a}const r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],MT.active=!0,MT.disabled=!0;const{extent:o}=await s.queryExtent(n);await i.goTo({target:o}),MT.active=!1,MT.disabled=!1}async function oBe(e){const{selectedFeature:t,view:i}=e,r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()];const{extent:o}=await s.queryExtent(n);e.selectedClusterBoundaryFeature.geometry=o,i.graphics.add(e.selectedClusterBoundaryFeature)}async function aBe(e){const{selectedFeature:t,view:i}=e,r=t.sourceLayer,s=await i.whenLayerView(r),n=s.createQuery();n.aggregateIds=[t.getObjectId()],OT.active=!0,OT.disabled=!0;const{features:o}=await s.queryFeatures(n);OT.active=!1,OT.disabled=!1,i.popup.open({features:[t].concat(o),featureMenuOpen:!0})}function lBe(e){const t=e.features.filter(i=>L1(i));t.length&&(e.features=t)}const Kye=e=>{let t=class extends e{constructor(...i){super(...i),this.goToOverride=null,this.view=null}callGoTo(i){const{view:r}=this;return this.goToOverride?this.goToOverride(r,i):r.goTo(i.target,i.options)}};return u([d()],t.prototype,"goToOverride",void 0),u([d()],t.prototype,"view",void 0),t=u([P("esri.widgets.support.GoTo")],t),t},fR=at.ofType({key:"type",defaultKeyValue:"button",base:u4,typeMap:{button:z2,toggle:jue}}),cBe=()=>[K1.clone()],uBe=()=>[MT.clone(),OT.clone()],e0e="esri.widgets.Popup.PopupViewModel",EP=me.getLogger(e0e);let bi=class extends Kye(Nye){constructor(e){super(e),this._handles=new qt,this._pendingPromises=new Set,this._fetchFeaturesController=null,this._selectedClusterFeature=null,this.featurePage=null,this.actions=new fR,this.activeFeature=null,this.defaultPopupTemplateEnabled=!1,this.autoCloseEnabled=!1,this.autoOpenEnabled=!0,this.browseClusterEnabled=!1,this.content=null,this.featuresPerPage=20,this.featureViewModelAbilities=null,this.featureViewModels=[],this.highlightEnabled=!0,this.includeDefaultActions=!0,this.selectedClusterBoundaryFeature=new Ca({symbol:new Dv({outline:{width:1.5,color:"cyan"},style:"none"})}),this.title=null,this.updateLocationEnabled=!1,this.view=null,this.visible=!1,this.zoomFactor=4,this.zoomToLocation=null}get isLoadingFeature(){return this.featureViewModels.some(e=>e.waitingForContent)}initialize(){this._handles.add([ae(()=>[this.autoOpenEnabled,this.view],()=>this._autoOpenEnabledChange()),this.on("view-change",()=>this._autoClose()),ae(()=>[this.highlightEnabled,this.selectedFeature,this.visible,this.view],()=>this._highlightSelectedFeature()),ae(()=>[this.highlightEnabled,this.activeFeature,this.visible,this.view],()=>this._highlightActiveFeature()),ae(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.animation)==null?void 0:t.state},e=>this._animationStateChange(e)),ae(()=>this.location,e=>this._locationChange(e)),ae(()=>this.selectedFeature,e=>this._selectedFeatureChange(e)),ae(()=>[this.selectedFeatureIndex,this.featureCount,this.featuresPerPage],()=>this._selectedFeatureIndexChange()),ae(()=>[this.featurePage,this.selectedFeatureIndex,this.featureCount,this.featuresPerPage,this.featureViewModels],()=>this._setGraphicOnFeatureViewModels()),ae(()=>this.featureViewModels,()=>this._featureViewModelsChange()),this.on("trigger-action",e=>iBe({event:e,view:this.view})),cl(()=>!this.waitingForResult,()=>this._waitingForResultChange(),rr),ae(()=>{var e,t;return[this.features,(e=this.view)==null?void 0:e.map,(t=this.view)==null?void 0:t.spatialReference]},()=>this._updateFeatureVMs()),ae(()=>{var e;return(e=this.view)==null?void 0:e.scale},()=>this._viewScaleChange()),cl(()=>!this.visible,()=>this.browseClusterEnabled=!1),ae(()=>this.browseClusterEnabled,e=>e?this.enableClusterBrowsing():this.disableClusterBrowsing())])}destroy(){this._cancelFetchingFeatures(),this._handles.destroy(),this._handles=null,this._pendingPromises.clear(),this.browseClusterEnabled=!1,this.view=null}get active(){return!(!this.visible||this.waitingForResult)}get allActions(){const e=this._get("allActions")||new fR;e.removeAll();const{actions:t,defaultActions:i,defaultPopupTemplateEnabled:r,includeDefaultActions:s,selectedFeature:n}=this,o=s?i.concat(t):t,a=n&&(typeof n.getEffectivePopupTemplate=="function"&&n.getEffectivePopupTemplate(r)||n.popupTemplate),l=a&&a.actions,c=a&&a.overwriteActions?l:l?l.concat(o):o;return c&&c.filter(Boolean).forEach(h=>e.add(h)),e}get defaultActions(){const e=this._get("defaultActions")||new fR;return e.removeAll(),e.addMany(L1(this.selectedFeature)?uBe():cBe()),e}get featureCount(){return this.features.length}get features(){return this._get("features")||[]}set features(e){const t=e||[];this._set("features",t);const{pendingPromisesCount:i,promiseCount:r,selectedFeatureIndex:s}=this,n=r&&t.length;n&&i&&s===-1?this.selectedFeatureIndex=0:n&&s!==-1||(this.selectedFeatureIndex=t.length?0:-1)}get location(){return this._get("location")||null}set location(e){const t=this.get("view.spatialReference.isWebMercator");e&&e.get("spatialReference.isWGS84")&&t&&(e=rg(e)),this._set("location",e)}get pendingPromisesCount(){return this._pendingPromises.size}get waitingForResult(){return!(!(!!this._fetchFeaturesController||this.pendingPromisesCount>0)||this.featureCount!==0)}get promiseCount(){return this.promises.length}get promises(){return this._get("promises")||[]}set promises(e){if(this._pendingPromises.clear(),this.features=[],!Array.isArray(e)||!e.length)return this._set("promises",[]),void this.notifyChange("pendingPromisesCount");this._set("promises",e),(e=e.slice(0)).forEach(t=>{this._pendingPromises.add(t);const i=s=>{this._pendingPromises.has(t)&&this._updateFeatures(s),this._updatePendingPromises(t)},r=()=>this._updatePendingPromises(t);t.then(i,r)}),this.notifyChange("pendingPromisesCount")}get selectedFeature(){const{features:e,selectedFeatureIndex:t}=this;return t===-1?null:e[t]||null}get selectedFeatureIndex(){const e=this._get("selectedFeatureIndex");return typeof e=="number"?e:-1}set selectedFeatureIndex(e){const{featureCount:t}=this;e=isNaN(e)||e<-1||!t?-1:(e+t)%t,this.activeFeature=null,this._set("selectedFeatureIndex",e)}get selectedFeatureViewModel(){return this.featureViewModels[this.selectedFeatureIndex]||null}get state(){return this.get("view.ready")?"ready":"disabled"}centerAtLocation(){const{view:e}=this,t=Jye(this);if(!t){const i=new q("center-at-location:invalid-target-or-view","Cannot center at a location without a target and view.",{target:t,view:e});return EP.error(i),Promise.reject(i)}return this.callGoTo({target:{target:t,scale:e.scale}})}clear(){this.set({promises:[],features:[],content:null,title:null,location:null,activeFeature:null})}fetchFeatures(e,t){const{view:i}=this;if(!i||!e){const r=new q("fetch-features:invalid-screenpoint-or-view","Cannot fetch features without a screenPoint and view.",{screenPoint:e,view:i});return EP.error(r),Promise.reject(r)}return i.fetchPopupFeatures(e,{event:t&&t.event,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,signal:t&&t.signal})}open(e){const t=ve(F({updateLocationEnabled:!1,promises:[],fetchFeatures:!1},e),{visible:!0}),{fetchFeatures:i}=t;delete t.fetchFeatures,i&&this._setFetchFeaturesPromises(t.location);const r=["actionsMenuOpen","collapsed","featureMenuOpen"];for(const s of r)delete t[s];this.set(t)}triggerAction(e){const t=this.allActions.getItemAt(e);t&&!t.disabled&&this.emit("trigger-action",{action:t})}next(){return this.selectedFeatureIndex=this.selectedFeatureIndex+1,this}previous(){return this.selectedFeatureIndex=this.selectedFeatureIndex-1,this}disableClusterBrowsing(){lBe(this),this._clearBrowsedClusterGraphics()}async enableClusterBrowsing(){const{view:e,selectedFeature:t}=this;(e==null?void 0:e.type)==="2d"?L1(t)?(await oBe(this),await aBe(this)):EP.warn("enableClusterBrowsing:invalid-selectedFeature: Selected feature must represent an aggregate/cluster graphic.",t):EP.warn("enableClusterBrowsing:invalid-view: View must be 2d MapView.",t)}_animationStateChange(e){this.zoomToLocation||(K1.disabled=e==="waiting-for-target")}_clearBrowsedClusterGraphics(){var t;const e=(t=this.view)==null?void 0:t.graphics;e&&(e.remove(this.selectedClusterBoundaryFeature),e.remove(this._selectedClusterFeature)),this._selectedClusterFeature=null,this.selectedClusterBoundaryFeature.geometry=null}_viewScaleChange(){if(L1(this.selectedFeature))return this.browseClusterEnabled=!1,this.visible=!1,void this.clear();this.browseClusterEnabled&&(this.features=[this.selectedFeature])}_locationChange(e){const{selectedFeature:t,updateLocationEnabled:i}=this;i&&e&&(!t||t.geometry)&&this.centerAtLocation()}_selectedFeatureIndexChange(){this.featurePage=this.featureCount>1?Math.floor(this.selectedFeatureIndex/this.featuresPerPage)+1:null}_featureViewModelsChange(){this.featurePage=this.featureCount>1?1:null}_setGraphicOnFeatureViewModels(){const{features:e,featureCount:t,featurePage:i,featuresPerPage:r,featureViewModels:s}=this;if(i===null)return;const n=((i-1)*r+t)%t,o=n+r;s.slice(n,o).forEach((a,l)=>{a&&!a.graphic&&(a.graphic=e[n+l])})}async _selectedFeatureChange(e){if(!e)return;const{location:t,updateLocationEnabled:i,view:r}=this;if(this.browseClusterEnabled)return this._selectedClusterFeature&&(r.graphics.remove(this._selectedClusterFeature),this._selectedClusterFeature=null),L1(e)?void 0:(e.symbol=await j8e(e),this._selectedClusterFeature=e,void r.graphics.add(this._selectedClusterFeature));!i&&t||!e.geometry?i&&!e.geometry&&this.centerAtLocation().then(()=>{this.location=r.center.clone()}):this.location=this._getPointFromGeometry(e.geometry)}_waitingForResultChange(){!this.featureCount&&this.promises&&(this.visible=!1)}_setFetchFeaturesPromises(e){return this._fetchFeaturesWithController(this._getScreenPoint(e||this.location)).then(t=>{const{clientOnlyGraphics:i,promisesPerLayerView:r}=t,s=Promise.resolve(i),n=r.map(o=>o.promise);this.promises=[s,...n]})}_destroyFeatureVMs(){this.featureViewModels.forEach(e=>e&&!e.destroyed&&e.destroy()),this._set("featureViewModels",[])}_updateFeatureVMs(){const{selectedFeature:e,features:t,featureViewModels:i}=this;if(L1(e)||(this.browseClusterEnabled=!1),this._destroyFeatureVMs(),!t||!t.length)return;const r=i.slice(0),s=[];t.forEach((n,o)=>{var l,c;if(!n)return;let a=null;if(r.some((h,p)=>(h&&h.graphic===n&&(a=h,r.splice(p,1)),!!a)),a)s[o]=a;else{const h=new pX({abilities:this.featureViewModelAbilities,defaultPopupTemplateEnabled:this.defaultPopupTemplateEnabled,spatialReference:(l=this.view)==null?void 0:l.spatialReference,graphic:n===e?n:null,map:(c=this.view)==null?void 0:c.map,view:this.view});s[o]=h}}),r.forEach(n=>n&&!n.destroyed&&n.destroy()),this._set("featureViewModels",s)}_getScreenPoint(e){const{view:t}=this;return t&&e&&typeof t.toScreen=="function"?t.toScreen(e):null}_autoOpenEnabledChange(){const e="auto-fetch-features",{_handles:t,autoOpenEnabled:i}=this;if(t.remove(e),i&&this.view){const r=this.view.on("click",s=>{s.pointerType==="mouse"&&s.button!==0||this._fetchFeaturesAndOpen(s)},rv.WIDGET);t.add(r,e)}}_cancelFetchingFeatures(){const e=this._fetchFeaturesController;e&&e.abort(),this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}_fetchFeaturesWithController(e,t){this._cancelFetchingFeatures();const i=new AbortController,{signal:r}=i;this._fetchFeaturesController=i,this.notifyChange("waitingForResult");const s=this.fetchFeatures(e,{signal:r,event:t});return s.catch(()=>{}).then(()=>{this._fetchFeaturesController=null,this.notifyChange("waitingForResult")}),s}_fetchFeaturesAndOpen(e){const{screenPoint:t,mapPoint:i}=e,{view:r}=this;this._fetchFeaturesWithController(t,e).then(s=>{const{clientOnlyGraphics:n,promisesPerLayerView:o,location:a}=s,l=[Promise.resolve(n),...o.map(c=>c.promise)];return r.popup.open({location:a||i,promises:l}),s})}_updatePendingPromises(e){e&&this._pendingPromises.has(e)&&(this._pendingPromises.delete(e),this.notifyChange("pendingPromisesCount"))}_autoClose(){this.autoCloseEnabled&&(this.visible=!1)}_getPointFromGeometry(e){return R(e)?null:e.type==="point"?e:e.type==="extent"?e.center:e.type==="polygon"?e.centroid:e.type==="multipoint"||e.type==="polyline"?e.extent.center:null}async _getLayerView(e,t){return await e.when(),e.whenLayerView(t)}_getHighlightLayer(e){const{layer:t,sourceLayer:i}=e;return(i==null?void 0:i.type)==="map-notes"||(i==null?void 0:i.type)==="subtype-group"?i:t}_getHighlightTarget(e,t){const i=t.type==="imagery"?void 0:"objectIdField"in t&&t.objectIdField,r=e.attributes;return r&&i&&r[i]||e}async _highlightActiveFeature(){const e="highlight-active-feature";this._handles.remove(e);const{highlightEnabled:t,view:i,activeFeature:r,visible:s}=this;if(!(r&&i&&t&&s))return;const n=this._getHighlightLayer(r);if(!(n&&n instanceof hM))return;const o=this._getLayerView(i,n);this._highlightActiveFeaturePromise=o;const a=await o;if(!(a&&fte(a)&&this._highlightActiveFeaturePromise===o&&this.activeFeature&&this.highlightEnabled))return;const l=a.highlight(this._getHighlightTarget(r,n));this._handles.add(l,e)}async _highlightSelectedFeature(){const e="highlight-selected-feature";this._handles.remove(e);const{selectedFeature:t,highlightEnabled:i,view:r,visible:s}=this;if(!(t&&r&&i&&s))return;const n=this._getHighlightLayer(t);if(!(n&&n instanceof hM))return;const o=this._getLayerView(r,n);this._highlightSelectedFeaturePromise=o;const a=await o;if(!(a&&fte(a)&&this._highlightSelectedFeaturePromise===o&&this.selectedFeature&&this.highlightEnabled&&this.visible))return;const l=a.highlight(this._getHighlightTarget(t,n));this._handles.add(l,e)}_updateFeatures(e){const{features:t}=this;if(!e||!e.length)return;if(!t.length)return void(this.features=e);const i=e.filter(r=>!t.includes(r));this.features=t.concat(i)}};u([d()],bi.prototype,"featurePage",void 0),u([d()],bi.prototype,"isLoadingFeature",null),u([d({type:fR})],bi.prototype,"actions",void 0),u([d({readOnly:!0})],bi.prototype,"active",null),u([d()],bi.prototype,"activeFeature",void 0),u([d({readOnly:!0})],bi.prototype,"allActions",null),u([d({type:Boolean})],bi.prototype,"defaultPopupTemplateEnabled",void 0),u([d()],bi.prototype,"autoCloseEnabled",void 0),u([d()],bi.prototype,"autoOpenEnabled",void 0),u([d()],bi.prototype,"browseClusterEnabled",void 0),u([d()],bi.prototype,"content",void 0),u([d({type:fR,readOnly:!0})],bi.prototype,"defaultActions",null),u([d({readOnly:!0})],bi.prototype,"featureCount",null),u([d()],bi.prototype,"features",null),u([d()],bi.prototype,"featuresPerPage",void 0),u([d()],bi.prototype,"featureViewModelAbilities",void 0),u([d({readOnly:!0})],bi.prototype,"featureViewModels",void 0),u([d()],bi.prototype,"highlightEnabled",void 0),u([d()],bi.prototype,"includeDefaultActions",void 0),u([d({type:nt})],bi.prototype,"location",null),u([d({readOnly:!0})],bi.prototype,"pendingPromisesCount",null),u([d({readOnly:!0})],bi.prototype,"selectedClusterBoundaryFeature",void 0),u([d({readOnly:!0})],bi.prototype,"waitingForResult",null),u([d({readOnly:!0})],bi.prototype,"promiseCount",null),u([d()],bi.prototype,"promises",null),u([d({value:null,readOnly:!0})],bi.prototype,"selectedFeature",null),u([d({value:-1})],bi.prototype,"selectedFeatureIndex",null),u([d({readOnly:!0})],bi.prototype,"selectedFeatureViewModel",null),u([d({readOnly:!0})],bi.prototype,"state",null),u([d()],bi.prototype,"title",void 0),u([d()],bi.prototype,"updateLocationEnabled",void 0),u([d()],bi.prototype,"view",void 0),u([d()],bi.prototype,"visible",void 0),u([d()],bi.prototype,"zoomFactor",void 0),u([d()],bi.prototype,"zoomToLocation",void 0),u([d()],bi.prototype,"centerAtLocation",null),bi=u([P(e0e)],bi);const t0e=bi,gte="selected-index",hBe=0,yte="popup-spinner",Pe={iconLeftTriangleArrow:"esri-icon-left-triangle-arrow",iconRightTriangleArrow:"esri-icon-right-triangle-arrow",iconDockToTop:"esri-icon-maximize",iconDockToBottom:"esri-icon-dock-bottom",iconDockToLeft:"esri-icon-dock-left",iconDockToRight:"esri-icon-dock-right",iconClose:"esri-icon-close",iconUndock:"esri-icon-minimize",iconCheckMark:"esri-icon-check-mark",iconLoading:"esri-icon-loading-indicator",iconDefaultAction:"esri-icon-default-action",iconActionsMenu:"esri-icon-handle-horizontal",rotating:"esri-rotating",base:"esri-popup",widget:"esri-widget",main:"esri-popup__main-container",loadingContainer:"esri-popup__loading-container",isCollapsible:"esri-popup--is-collapsible",isCollapsed:"esri-popup--is-collapsed",shadow:"esri-popup--shadow",isDocked:"esri-popup--is-docked",isDockedTopLeft:"esri-popup--is-docked-top-left",isDockedTopCenter:"esri-popup--is-docked-top-center",isDockedTopRight:"esri-popup--is-docked-top-right",isDockedBottomLeft:"esri-popup--is-docked-bottom-left",isDockedBottomCenter:"esri-popup--is-docked-bottom-center",isDockedBottomRight:"esri-popup--is-docked-bottom-right",alignTopCenter:"esri-popup--aligned-top-center",alignBottomCenter:"esri-popup--aligned-bottom-center",alignTopLeft:"esri-popup--aligned-top-left",alignBottomLeft:"esri-popup--aligned-bottom-left",alignTopRight:"esri-popup--aligned-top-right",alignBottomRight:"esri-popup--aligned-bottom-right",isFeatureMenuOpen:"esri-popup--feature-menu-open",isActionsMenuOpen:"esri-popup--actions-menu-open",hasFeatureUpdated:"esri-popup--feature-updated",header:"esri-popup__header",headerButtons:"esri-popup__header-buttons",headerContainer:"esri-popup__header-container",headerContainerButton:"esri-popup__header-container--button",headerTitle:"esri-popup__header-title",content:"esri-popup__content",footer:"esri-popup__footer",footerHasPagination:"esri-popup__footer--has-pagination",footerHasActions:"esri-popup__footer--has-actions",footerHasActionsMenu:"esri-popup__footer--has-actions-menu",button:"esri-popup__button",buttonDisabled:"esri-popup__button--disabled",buttonDock:"esri-popup__button--dock",icon:"esri-popup__icon",iconDock:"esri-popup__icon--dock-icon",inlineActionsContainer:"esri-popup__inline-actions-container",actionsMenuButton:"esri-popup__actions-menu-button",actions:"esri-popup__actions",action:"esri-popup__action",actionImage:"esri-popup__action-image",actionText:"esri-popup__action-text",actionToggle:"esri-popup__action-toggle",actionToggleOn:"esri-popup__action-toggle--on",pointer:"esri-popup__pointer",pointerDirection:"esri-popup__pointer-direction",navigation:"esri-popup__navigation",paginationPrevious:"esri-popup__pagination-previous",paginationNext:"esri-popup__pagination-next",paginationPreviousIconLTR:"esri-popup__pagination-previous-icon",paginationPreviousIconRTL:"esri-popup__pagination-previous-icon--rtl",paginationNextIconLTR:"esri-popup__pagination-next-icon",paginationNextIconRTL:"esri-popup__pagination-next-icon--rtl",featureMenu:"esri-popup__feature-menu",featureMenuList:"esri-popup__feature-menu-list",featureMenuItem:"esri-popup__feature-menu-item",featureMenuViewport:"esri-popup__feature-menu-viewport",featureMenuHeader:"esri-popup__feature-menu-header",featureMenuNote:"esri-popup__feature-menu-note",featureMenuSelected:"esri-popup__feature-menu-item--selected",featureMenuButton:"esri-popup__feature-menu-button",featureMenuTitle:"esri-popup__feature-menu-title",featureMenuObserver:"esri-popup__feature-menu-observer",featureMenuLoader:"esri-popup__feature-menu-loader",collapseButton:"esri-popup__collapse-button"},vte={buttonEnabled:!0,position:"auto",breakpoint:{width:544}},_te="esri-popup";function Yf(e,t){return t===void 0?`${_te}__${e}`:`${_te}__${e}-${t}`}const i0e="esri.widgets.Popup",bte=me.getLogger(i0e),wte={closeButton:!0,featureNavigation:!0};let Tt=class extends Dye(ml){constructor(e,t){super(e,t),this._blurClose=!1,this._blurContainer=!1,this._containerNode=null,this._mainContainerNode=null,this._featureMenuNode=null,this._actionsMenuNode=null,this._focusClose=!1,this._focusContainer=!1,this._focusDockButton=!1,this._focusFeatureMenuButton=!1,this._focusActionsMenuButton=!1,this._focusFirstFeature=!1,this._focusFirstAction=!1,this._handles=new qt,this._pointerOffsetInPx=16,this._spinner=null,this._feature=null,this._featureMenuIntersectionObserverCallback=([i])=>{(i==null?void 0:i.isIntersecting)&&this.viewModel.featurePage++},this._featureMenuIntersectionObserver=new IntersectionObserver(this._featureMenuIntersectionObserverCallback,{root:window.document}),this._displaySpinnerThrottled=aW(()=>this._displaySpinner(),hBe),this.actions=null,this.alignment="auto",this.autoCloseEnabled=null,this.autoOpenEnabled=null,this.defaultPopupTemplateEnabled=null,this.content=null,this.collapsed=!1,this.collapseEnabled=!0,this.dockEnabled=!1,this.featureCount=null,this.featureMenuOpen=!1,this.features=null,this.goToOverride=null,this.headingLevel=2,this.highlightEnabled=null,this.location=null,this.label=void 0,this.maxInlineActions=3,this.messages=null,this.messagesCommon=null,this.promises=null,this.selectedFeature=null,this.selectedFeatureIndex=null,this.spinnerEnabled=!0,this.title=null,this.updateLocationEnabled=null,this.view=null,this.viewModel=new t0e,this.visible=null,this.visibleElements=F({},wte),this._addSelectedFeatureIndexHandle(),this.own([ae(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},()=>this._positionContainer()),ae(()=>{var i;return[(i=this.viewModel)==null?void 0:i.active,this.dockEnabled]},()=>this._toggleScreenLocationEnabled()),ae(()=>{var i;return(i=this.viewModel)==null?void 0:i.screenLocation},(i,r)=>{!!i!=!!r&&this.reposition()}),ae(()=>{var i,r,s,n,o,a;return[(r=(i=this.viewModel)==null?void 0:i.view)==null?void 0:r.padding,(n=(s=this.viewModel)==null?void 0:s.view)==null?void 0:n.size,(o=this.viewModel)==null?void 0:o.active,(a=this.viewModel)==null?void 0:a.location,this.alignment]},()=>this.reposition()),ae(()=>this.spinnerEnabled,i=>this._spinnerEnabledChange(i)),ae(()=>{var i,r;return(r=(i=this.viewModel)==null?void 0:i.view)==null?void 0:r.size},(i,r)=>this._updateDockEnabledForViewSize(i,r)),ae(()=>{var i;return(i=this.viewModel)==null?void 0:i.view},(i,r)=>this._viewChange(i,r)),ae(()=>{var i,r;return(r=(i=this.viewModel)==null?void 0:i.view)==null?void 0:r.ready},(i,r)=>this._viewReadyChange(i,r)),ae(()=>{var i,r;return[(i=this.viewModel)==null?void 0:i.waitingForResult,(r=this.viewModel)==null?void 0:r.location]},()=>{this._hideSpinner(),this._displaySpinnerThrottled()}),ae(()=>{var i,r,s,n;return[(r=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:r.title,(n=(s=this.selectedFeatureWidget)==null?void 0:s.viewModel)==null?void 0:n.state]},()=>this._setTitleFromFeatureWidget()),ae(()=>{var i,r,s,n;return[(r=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:r.content,(n=(s=this.selectedFeatureWidget)==null?void 0:s.viewModel)==null?void 0:n.state]},()=>this._setContentFromFeatureWidget()),cl(()=>!this.collapsed,()=>{var i,r;((r=(i=this.viewModel)==null?void 0:i.view)==null?void 0:r.widthBreakpoint)==="xsmall"&&this.viewModel.active&&this.collapseEnabled&&this.viewModel.centerAtLocation()}),eo(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},"change",()=>this._watchActions()),ae(()=>{var i;return(i=this.viewModel)==null?void 0:i.allActions},()=>this._watchActions(),Ft),ae(()=>{var i;return(i=this.viewModel)==null?void 0:i.featureViewModels},()=>this._featureMenuViewportScrollTop())])}destroy(){var e,t;this._destroySelectedFeatureWidget(),this._destroySpinner(),(e=this._handles)==null||e.destroy(),this._unobserveFeatureMenuObserver(),(t=this._featureMenuIntersectionObserver)==null||t.disconnect(),this._handles=null}get actionsMenuId(){return`${this.id}-actions-menu`}get actionsMenuButtonId(){return`${this.id}-actions-menu-button`}get featureMenuId(){return`${this.id}-feature-menu`}get titleId(){return`${this.id}-popup-title`}get contentId(){return`${this.id}-popup-content`}get hasContent(){var e,t,i,r,s,n,o;return!!(this.selectedFeatureWidget?((t=(e=this.selectedFeatureWidget)==null?void 0:e.viewModel)==null?void 0:t.waitingForContent)||((r=(i=this.selectedFeatureWidget)==null?void 0:i.viewModel)==null?void 0:r.state)==="error"||((n=(s=this.selectedFeatureWidget)==null?void 0:s.viewModel)==null?void 0:n.content):(o=this.viewModel)==null?void 0:o.content)}get featureNavigationVisible(){return this.viewModel.active&&this.viewModel.featureCount>1&&this.visibleElements.featureNavigation}get collapsible(){return!!(this.collapseEnabled&&this.viewModel.title&&this.hasContent)}get featureMenuVisible(){return this.featureNavigationVisible&&this.featureMenuOpen}get contentCollapsed(){return this.collapsible&&!this.featureMenuVisible&&this.collapsed}get dividedActions(){return this._divideActions()}set actionsMenuOpen(e){this._set("actionsMenuOpen",!!e)}get actionsMenuOpen(){return!!this.viewModel.active&&this._get("actionsMenuOpen")}get currentAlignment(){return this._getCurrentAlignment()}get currentDockPosition(){return this._getCurrentDockPosition()}get dockOptions(){return this._get("dockOptions")||vte}set dockOptions(e){const t=F({},vte),i=this.get("viewModel.view.breakpoints"),r={};i&&(r.width=i.xsmall,r.height=i.xsmall);const s=F(F({},t),e),n=F(F({},t.breakpoint),r),{breakpoint:o}=s;o===!0?s.breakpoint=n:typeof o=="object"&&(s.breakpoint=F(F({},n),o)),this._set("dockOptions",s),this._setCurrentDockPosition(),this.reposition()}get selectedFeatureWidget(){const{_feature:e,visibleElements:t,headingLevel:i}=this,{selectedFeatureViewModel:r}=this.viewModel,s=ve(F({},t),{title:!1});return r?(e?(e.viewModel=r,e.visibleElements=s):this._feature=new u8e({headingLevel:i+1,viewModel:r,visibleElements:s}),this._feature):null}castVisibleElements(e){return F(F({},wte),e)}blur(){const{active:e}=this.viewModel;e||bte.warn("Popup can only be blurred when currently active."),this.visibleElements.closeButton?this._blurClose=!0:this._blurContainer=!0,this.scheduleRender()}clear(){this.viewModel.clear()}close(){this.visible=!1}fetchFeatures(e,t){return this.viewModel.fetchFeatures(e,t)}focus(){const{active:e}=this.viewModel;e||bte.warn("Popup can only be focused when currently active."),this.visibleElements.closeButton?this._focusClose=!0:this._focusContainer=!0,this.scheduleRender()}next(){return this.viewModel.next()}open(e){var s,n;this._handles.remove(gte);const t=!!e&&!!e.featureMenuOpen,i=!!e&&!!e.actionsMenuOpen,r={collapsed:!!e&&!!e.collapsed,actionsMenuOpen:i,featureMenuOpen:t};((n=(s=this.viewModel)==null?void 0:s.view)==null?void 0:n.widthBreakpoint)==="xsmall"&&(r.collapsed=!0),this.set(r),this.viewModel.open(e),this._shouldFocus(e),this._addSelectedFeatureIndexHandle()}previous(){return this.viewModel.previous()}reposition(){this.renderNow(),this._positionContainer(),this._setCurrentAlignment()}triggerAction(e){this.viewModel.triggerAction(e)}render(){var y,v,w,b;const{actionsMenuOpen:e,dockEnabled:t,featureMenuVisible:i,dividedActions:r,currentAlignment:s,currentDockPosition:n}=this,{active:o}=this.viewModel,{menuActions:a}=r,l=o&&a.length>1&&e,c=o&&t,h=o&&!t,p=(v=(y=this.selectedFeature)==null?void 0:y.layer)==null?void 0:v.title,f=(b=(w=this.selectedFeature)==null?void 0:w.layer)==null?void 0:b.id,m={[Pe.alignTopCenter]:s==="top-center",[Pe.alignBottomCenter]:s==="bottom-center",[Pe.alignTopLeft]:s==="top-left",[Pe.alignBottomLeft]:s==="bottom-left",[Pe.alignTopRight]:s==="top-right",[Pe.alignBottomRight]:s==="bottom-right",[Pe.isDocked]:c,[Pe.shadow]:h,[Pe.isDockedTopLeft]:n==="top-left",[Pe.isDockedTopCenter]:n==="top-center",[Pe.isDockedTopRight]:n==="top-right",[Pe.isDockedBottomLeft]:n==="bottom-left",[Pe.isDockedBottomCenter]:n==="bottom-center",[Pe.isDockedBottomRight]:n==="bottom-right",[Pe.isFeatureMenuOpen]:i,[Pe.isActionsMenuOpen]:l};return ue("div",{class:this.classes(Pe.base,m),role:"presentation","data-layer-title":p,"data-layer-id":f,bind:this,afterCreate:this._positionContainer,afterUpdate:this._positionContainer},o?[this.renderMainContainer(),this.renderPointer()]:null)}renderLoadingIcon(){return ue("span",{"aria-hidden":"true",class:this.classes(Pe.icon,Pe.iconLoading,Pe.rotating)})}renderNavigationLoading(){const{messagesCommon:e}=this;return this.viewModel.pendingPromisesCount?ue("div",{key:Yf("loading-container"),role:"presentation",class:Pe.loadingContainer,"aria-label":e.loading,title:e.loading},this.renderLoadingIcon()):null}renderPreviousIcon(){const e=B0(this.container),t={[Pe.iconRightTriangleArrow]:e,[Pe.paginationPreviousIconRTL]:e,[Pe.iconLeftTriangleArrow]:!e,[Pe.paginationPreviousIconLTR]:!e};return ue("span",{"aria-hidden":"true",class:this.classes(Pe.icon,t)})}renderPreviousButton(){const{messages:e}=this;return ue("div",{role:"button",tabIndex:0,bind:this,onclick:this._previous,onkeydown:this._previous,class:this.classes(Pe.button,Pe.paginationPrevious),"aria-label":e.previous,title:e.previous},this.renderPreviousIcon())}renderNextIcon(){const e=B0(this.container),t={[Pe.iconLeftTriangleArrow]:e,[Pe.paginationNextIconRTL]:e,[Pe.iconRightTriangleArrow]:!e,[Pe.paginationNextIconLTR]:!e};return ue("span",{"aria-hidden":"true",class:this.classes(Pe.icon,t)})}renderNextButton(){const{messages:e}=this;return ue("div",{role:"button",tabIndex:0,bind:this,onclick:this._next,onkeydown:this._next,class:this.classes(Pe.button,Pe.paginationNext),"aria-label":e.next,title:e.next},this.renderNextIcon())}renderFeatureMenuButton(){const{featureMenuOpen:e,featureMenuId:t,messagesCommon:i}=this,{featureCount:r,selectedFeatureIndex:s}=this.viewModel;return ue("div",{role:"button",tabIndex:0,bind:this,onclick:this._toggleFeatureMenu,onkeydown:this._toggleFeatureMenu,afterCreate:this._focusFeatureMenuButtonNode,afterUpdate:this._focusFeatureMenuButtonNode,class:this.classes(Pe.button,Pe.featureMenuButton),"aria-haspopup":"true","aria-controls":t,"aria-expanded":e.toString(),"aria-label":i.menu,title:i.menu},this._getPageText(r,s))}renderNavigationButtons(){return this.featureNavigationVisible?[this.renderPreviousButton(),this.renderNavigationLoading()||this.renderFeatureMenuButton(),this.renderNextButton()]:null}renderDockIcon(){const{dockEnabled:e}=this,t=this._wouldDockTo(),i={[Pe.iconUndock]:e,[Pe.iconDock]:!e,[Pe.iconDockToRight]:!e&&(t==="top-right"||t==="bottom-right"),[Pe.iconDockToLeft]:!e&&(t==="top-left"||t==="bottom-left"),[Pe.iconDockToTop]:!e&&t==="top-center",[Pe.iconDockToBottom]:!e&&t==="bottom-center"};return ue("span",{"aria-hidden":"true",class:this.classes(i,Pe.icon)})}renderDockButton(){var s,n,o;const{dockEnabled:e,messages:t}=this,i=(n=(s=this.viewModel)==null?void 0:s.view)==null?void 0:n.widthBreakpoint,r=e?t.undock:t.dock;return i!=="xsmall"&&((o=this.dockOptions)==null?void 0:o.buttonEnabled)?ue("div",{role:"button","aria-label":r,title:r,tabIndex:0,bind:this,onclick:this._toggleDockEnabled,onkeydown:this._toggleDockEnabled,afterCreate:this._focusDockButtonNode,afterUpdate:this._focusDockButtonNode,class:this.classes(Pe.button,Pe.buttonDock)},this.renderDockIcon()):null}renderTitle(){const{title:e}=this.viewModel,{titleId:t,collapsible:i,contentCollapsed:r,messagesCommon:s}=this,n={[Pe.headerContainerButton]:i},o=ue(yW,{level:this.headingLevel,class:Pe.headerTitle,innerHTML:e}),a=i?ue("button",{key:`${e}--collapsible`,id:t,title:r?s.expand:s.collapse,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Pe.headerContainer,n),"aria-expanded":r?"false":"true",onclick:this._toggleCollapsed,type:"button"},o):ue("div",{key:e,id:t,bind:this,enterAnimation:this._createFeatureUpdatedAnimation(),class:this.classes(Pe.headerContainer,n)},o);return e?a:null}renderCloseIcon(){return ue("span",{"aria-hidden":"true",class:this.classes(Pe.icon,Pe.iconClose)})}renderCloseButton(){const{visibleElements:e,messagesCommon:t}=this;return e.closeButton?ue("div",{role:"button",tabIndex:0,bind:this,onclick:this._close,onkeydown:this._close,class:Pe.button,"aria-label":t.close,title:t.close,afterCreate:this._closeButtonNodeUpdated,afterUpdate:this._closeButtonNodeUpdated},this.renderCloseIcon()):null}renderHeader(){return ue("header",{class:Pe.header},this.renderTitle(),ue("div",{class:Pe.headerButtons},this.renderDockButton(),this.renderCloseButton()))}renderContentContainer(){const{contentId:e,hasContent:t,contentCollapsed:i}=this,{content:r}=this.viewModel;return t&&!i?ue("article",{key:r,enterAnimation:this._createFeatureUpdatedAnimation(),id:e,class:Pe.content},this.renderContent()):null}renderActionsMenuButton(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r,messagesCommon:s}=this,n=i?s.close:s.open,{menuActions:o}=r;return o.length?ue("div",{key:Yf("actions-menu-button"),class:this.classes(Pe.button,Pe.actionsMenuButton),role:"button",id:t,"aria-haspopup":"true","aria-controls":i?e:null,tabIndex:0,bind:this,onclick:this._toggleActionsMenu,onkeydown:this._toggleActionsMenu,afterCreate:this._focusActionsMenuButtonNode,afterUpdate:this._focusActionsMenuButtonNode,"aria-label":n,title:n},ue("span",{"aria-hidden":"true",class:Pe.iconActionsMenu})):null}renderMenuActions(){const{actionsMenuId:e,actionsMenuButtonId:t,actionsMenuOpen:i,dividedActions:r}=this,{menuActions:s}=r;return s.length&&i?ue("ul",{id:e,role:"menu","aria-labelledby":t,key:Yf("actions"),class:Pe.actions,bind:this,onkeyup:this._handleActionMenuKeyup,afterCreate:this._actionsMenuNodeUpdated,afterUpdate:this._actionsMenuNodeUpdated},s.toArray().map(n=>this.renderAction({action:n,type:"menu-item"}))):null}renderInlineActions(){const{inlineActions:e}=this.dividedActions;return!!e.length&&e.toArray().map(t=>this.renderAction({action:t,type:"inline"}))}renderInlineActionsContainer(){const{inlineActions:e,menuActions:t}=this.dividedActions,i=!!e.length,r=!!t.length;return i||r?ue("div",{key:"inline-actions-container","data-inline-actions":i.toString(),"data-menu-actions":r.toString(),class:Pe.inlineActionsContainer},this.renderInlineActions(),this.renderActionsMenuButton(),this.renderMenuActions()):null}renderNavigation(){return this.featureNavigationVisible?ue("section",{key:Yf("navigation"),class:this.classes(Pe.navigation)},this.renderNavigationButtons()):null}renderFooter(){const{featureNavigationVisible:e,dividedActions:t}=this,{inlineActions:i,menuActions:r}=t,s=!!i.length,n=!!r.length,o={[Pe.footerHasPagination]:e,[Pe.footerHasActions]:s,[Pe.footerHasActionsMenu]:n};return e||s?ue("div",{key:Yf("feature-buttons"),class:this.classes(Pe.footer,o)},this.renderInlineActionsContainer(),this.renderNavigation()):null}renderFeatureMenuContainer(){const{messages:e}=this,{featureViewModels:t,isLoadingFeature:i}=this.viewModel,r=mm(e.selectedFeatures,{total:t.length});return ue("section",{key:Yf("menu"),class:Pe.featureMenu},ue("strong",{class:Pe.featureMenuHeader},r),ue("nav",{bind:this,class:Pe.featureMenuViewport,"data-node-ref":"_featureMenuViewportNode",afterCreate:u9},this.renderFeatureMenu(),ue("div",{class:Pe.featureMenuObserver,bind:this,afterCreate:this._featureMenuIntersectionObserverCreated}),i?ue("div",{class:Pe.featureMenuLoader},this.renderLoadingIcon()):null))}renderPointer(){return this.dockEnabled?null:ue("div",{key:Yf("pointer"),class:Pe.pointer,role:"presentation"},ue("div",{class:this.classes(Pe.pointerDirection,Pe.shadow)}))}renderMainContainer(){const{dockEnabled:e,currentAlignment:t,currentDockPosition:i,titleId:r,contentId:s,collapsible:n,hasContent:o,contentCollapsed:a,visibleElements:l}=this,{title:c}=this.viewModel,h=t==="bottom-left"||t==="bottom-center"||t==="bottom-right"||i==="top-left"||i==="top-center"||i==="top-right",p=t==="top-left"||t==="top-center"||t==="top-right"||i==="bottom-left"||i==="bottom-center"||i==="bottom-right",f={[Pe.shadow]:e,[Pe.isCollapsible]:n,[Pe.isCollapsed]:a};return ue("div",{class:this.classes(Pe.main,Pe.widget,f),tabIndex:l.closeButton?null:-1,role:"dialog","aria-labelledby":c?r:"","aria-describedby":o&&!a?s:"",bind:this,onkeyup:this._handleMainKeyup,afterCreate:this._mainContainerNodeUpdated,afterUpdate:this._mainContainerNodeUpdated},h?this.renderFooter():null,h?this.renderFeatureMenuContainer():null,this.renderHeader(),this.renderContentContainer(),p?this.renderFooter():null,p?this.renderFeatureMenuContainer():null)}renderContent(){var t;const e=(t=this.viewModel)==null?void 0:t.content;return e?typeof e=="string"?ue("div",{key:e,innerHTML:e}):this.renderNodeContent(e):null}renderActionText(e){return ue("span",{key:"text",class:Pe.actionText},e)}renderActionIcon(e){const t=this._getActionClass(e),i=this._getActionImage(e),r={[Pe.iconLoading]:e.active,[Pe.rotating]:e.active,[Pe.icon]:!!t,[Pe.actionImage]:!e.active&&!!i};return t&&(r[t]=!e.active),ue("span",{key:"icon","aria-hidden":"true",class:this.classes(Pe.icon,r),styles:this._getIconStyles(i)})}renderAction(e){const{action:t,type:i}=e,r=this._getActionTitle(t),s={[Pe.action]:t.type!=="toggle",[Pe.actionToggle]:t.type==="toggle",[Pe.actionToggleOn]:t.type==="toggle"&&t.value,[Pe.buttonDisabled]:t.disabled},n=[this.renderActionIcon(t),this.renderActionText(r)],o=i==="menu-item"?ue("li",{key:t.uid,role:"menuitem",tabIndex:0,title:r,"aria-label":r,class:this.classes(Pe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n):ue("div",{key:t.uid,role:"button",tabIndex:0,title:r,"aria-label":r,class:this.classes(Pe.button,s),onkeyup:this._handleActionMenuItemKeyup,bind:this,"data-action-uid":t.uid,onclick:this._triggerAction,onkeydown:this._triggerAction},n);return t.visible?o:null}renderFeatureMenuItem(e,t){const{messages:i,messagesCommon:r}=this,{selectedFeatureIndex:s,selectedFeatureViewModel:n}=this.viewModel,o=e===n,a={[Pe.featureMenuSelected]:o},l=o?ue("span",{key:Yf(`feature-menu-selected-feature-${s}`),title:i.selectedFeature,"aria-label":i.selectedFeature,class:Pe.iconCheckMark}):null,c=ue("span",{innerHTML:e.title||r.untitled});return ue("li",{role:"menuitem",tabIndex:-1,key:Yf(`feature-menu-feature-${s}`),class:this.classes(a,Pe.featureMenuItem),bind:this,"data-feature-index":t,onblur:this._removeActiveFeature,onfocus:this._setActiveFeature,onkeyup:this._handleFeatureMenuItemKeyup,onclick:this._selectFeature,onkeydown:this._selectFeature,onmouseover:this._setActiveFeature,onmouseleave:this._removeActiveFeature},ue("span",{class:Pe.featureMenuTitle},c,l))}renderFeatureMenu(){const{featureMenuId:e}=this,{featureViewModels:t}=this.viewModel;return t.length>1?ue("ol",{class:Pe.featureMenuList,id:e,bind:this,afterCreate:this._featureMenuNodeUpdated,afterUpdate:this._featureMenuNodeUpdated,onkeyup:this._handleFeatureMenuKeyup,role:"menu"},t.filter(i=>!!i.graphic).map((i,r)=>this.renderFeatureMenuItem(i,r))):null}_getActionTitle(e){const{messages:t,selectedFeature:i,messagesCommon:r}=this,{id:s}=e,n=i==null?void 0:i.attributes,o=s==="zoom-to-feature"?mm(e.title,{messages:t}):s==="remove-selected-feature"?mm(e.title,{messages:r}):s==="zoom-to-clustered-features"||s==="browse-clustered-features"?mm(e.title,{messages:t}):e.title;return o&&n?mm(o,n):o}_getActionClass(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{className:r,image:s}=e,n=s||r?r:Pe.iconDefaultAction;return n&&i?mm(n,i):n}_getActionImage(e){const{selectedFeature:t}=this,i=t==null?void 0:t.attributes,{image:r}=e;return r&&i?mm(r,i):r}_createFeatureUpdatedAnimation(){return _$e("enter",Pe.hasFeatureUpdated)}_getInlineActionCount(){const{maxInlineActions:e,featureNavigationVisible:t}=this;if(typeof e!="number")return null;const i=Math.round(e);return Math.max(t?i-1:i,0)}_watchActions(){const{allActions:e}=this.viewModel;this.notifyChange("dividedActions");const t="actions";this._handles.remove(t),e&&e.forEach(i=>{this._handles.add(ae(()=>[i.uid,i.active,i.className,i.disabled,i.id,i.title,i.image,i.visible],()=>this.scheduleRender()),t)})}_divideActions(){const{allActions:e}=this.viewModel,t=e.filter(n=>n.visible),i=this._getInlineActionCount(),r=i===null,s=i===0;return{inlineActions:r?t.slice(0):s?new at:t.slice(0,i),menuActions:r?new at:s?t.slice(0):t.slice(i)}}_featureMenuOpenChanged(e){e?this._focusFirstFeature=!0:this._focusFeatureMenuButton=!0}_actionsMenuOpenChanged(e){e?this._focusFirstAction=!0:this._focusActionsMenuButton=!0}_setTitleFromFeatureWidget(){var i,r;const{selectedFeatureWidget:e,messagesCommon:t}=this;e&&(this.viewModel.title=((i=e.viewModel)==null?void 0:i.state)==="error"?t.errorMessage:((r=e.viewModel)==null?void 0:r.title)||"")}_setContentFromFeatureWidget(){const{selectedFeatureWidget:e}=this;e&&(this.viewModel.content=e)}_unobserveFeatureMenuObserver(){this._featureMenuIntersectionObserverNode&&this._featureMenuIntersectionObserver.unobserve(this._featureMenuIntersectionObserverNode)}_featureMenuIntersectionObserverCreated(e){this._unobserveFeatureMenuObserver(),this._featureMenuIntersectionObserver.observe(e),this._featureMenuIntersectionObserverNode=e}_handleFeatureMenuKeyup(e){A1(e)==="Escape"&&(e.stopPropagation(),this._focusFeatureMenuButton=!0,this.featureMenuOpen=!1,this.scheduleRender())}_handleActionMenuKeyup(e){A1(e)==="Escape"&&(e.stopPropagation(),this._focusActionsMenuButton=!0,this.actionsMenuOpen=!1,this.scheduleRender())}_setActiveFeature(e){const{viewModel:t}=this,i=e.currentTarget["data-feature-index"];t.activeFeature=t.features[i]||null}_removeActiveFeature(){this.viewModel.activeFeature=null}_handleFeatureMenuItemKeyup(e){const t=A1(e),{_featureMenuNode:i}=this,r=e.currentTarget["data-feature-index"];if(!i)return;const s=i.querySelectorAll("li"),n=s.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),s[s.length-1].focus()):(e.stopPropagation(),s[0].focus()):(e.stopPropagation(),s[(r+1+n)%n].focus()):(e.stopPropagation(),s[(r-1+n)%n].focus())}_handleActionMenuItemKeyup(e){const t=A1(e),{_actionsMenuNode:i}=this,r=e.currentTarget.dataset.actionUid,{menuActions:s}=this.dividedActions,n=s.findIndex(l=>l.uid===r);if(!i)return;const o=i.querySelectorAll("li"),a=o.length;t!=="ArrowUp"?t!=="ArrowDown"?t!=="Home"?t!=="End"||(e.stopPropagation(),o[o.length-1].focus()):(e.stopPropagation(),o[0].focus()):(e.stopPropagation(),o[(n+1+a)%a].focus()):(e.stopPropagation(),o[(n-1+a)%a].focus())}_handleMainKeyup(e){const t=A1(e);t==="ArrowLeft"&&(e.stopPropagation(),this.previous()),t==="ArrowRight"&&(e.stopPropagation(),this.next())}_spinnerEnabledChange(e){if(this._destroySpinner(),!e)return;const t=this.get("viewModel.view");this._createSpinner(t)}_hideSpinner(){const{_spinner:e}=this;e&&(e.location=null,e.hide())}_displaySpinner(){const{_spinner:e}=this;if(!e)return;const{location:t,waitingForResult:i}=this.viewModel;i?e.show({location:t}):e.hide()}_getIconStyles(e){return{"background-image":e?`url(${e})`:""}}async _shouldFocus(e){e.shouldFocus&&(await BR(()=>{var t;return((t=this.viewModel)==null?void 0:t.active)===!0}),this.focus())}_addSelectedFeatureIndexHandle(){const e=ae(()=>{var t;return(t=this.viewModel)==null?void 0:t.selectedFeatureIndex},(t,i)=>this._selectedFeatureIndexUpdated(t,i));this._handles.add(e,gte)}_selectedFeatureIndexUpdated(e,t){const{featureCount:i}=this;i&&e!==t&&e!==-1&&(this.actionsMenuOpen=!1,this.featureMenuOpen=!1)}_destroySelectedFeatureWidget(){const{_feature:e}=this;e&&(e.viewModel=null,e&&!e.destroyed&&e.destroy()),this._feature=null}_isScreenLocationWithinView(e,t){return e.x>-1&&e.y>-1&&e.x<=t.width&&e.y<=t.height}_isOutsideView(e){const{popupHeight:t,popupWidth:i,screenLocation:r,side:s,view:n}=e;if(isNaN(i)||isNaN(t)||!n||!r)return!1;const o=n.padding;return s==="right"&&r.x+i/2>n.width-o.right||s==="left"&&r.x-i/2<o.left||s==="top"&&r.y-t<o.top||s==="bottom"&&r.y+t>n.height-o.bottom}_calculateAutoAlignment(e){if(e!=="auto")return e;const{_pointerOffsetInPx:t,_containerNode:i,_mainContainerNode:r,viewModel:s}=this,{screenLocation:n,view:o}=s;if(R(n)||!o||!i)return"top-center";if(!this._isScreenLocationWithinView(n,o))return this._get("currentAlignment")||"top-center";function a(T){return parseInt(T.replace(/[^-\d\.]/g,""),10)}const l=r?window.getComputedStyle(r,null):null,c=l?a(l.getPropertyValue("max-height")):0,h=l?a(l.getPropertyValue("height")):0,{height:p,width:f}=i.getBoundingClientRect(),m=f+t,y=Math.max(p,c,h)+t,v=this._isOutsideView({popupHeight:y,popupWidth:m,screenLocation:n,side:"right",view:o}),w=this._isOutsideView({popupHeight:y,popupWidth:m,screenLocation:n,side:"left",view:o}),b=this._isOutsideView({popupHeight:y,popupWidth:m,screenLocation:n,side:"top",view:o}),S=this._isOutsideView({popupHeight:y,popupWidth:m,screenLocation:n,side:"bottom",view:o});return w?b?"bottom-right":"top-right":v?b?"bottom-left":"top-left":b?S?"top-center":"bottom-center":"top-center"}_callCurrentAlignment(e){return typeof e=="function"?e.call(this):e}_getCurrentAlignment(){const{alignment:e,dockEnabled:t}=this;return t||!this.viewModel.active?null:this._calculatePositionResult(this._calculateAutoAlignment(this._callCurrentAlignment(e)))}_setCurrentAlignment(){this._set("currentAlignment",this._getCurrentAlignment())}_setCurrentDockPosition(){this._set("currentDockPosition",this._getCurrentDockPosition())}_calculatePositionResult(e){const t=["left","right"];return B0(this.container)&&t.reverse(),e.replace(/leading/gi,t[0]).replace(/trailing/gi,t[1])}_callDockPosition(e){return typeof e=="function"?e.call(this):e}_getDockPosition(){var e;return this._calculatePositionResult(this._calculateAutoDockPosition(this._callDockPosition((e=this.dockOptions)==null?void 0:e.position)))}_getCurrentDockPosition(){return this.dockEnabled&&this.viewModel.active?this._getDockPosition():null}_wouldDockTo(){return this.dockEnabled?null:this._getDockPosition()}_calculateAutoDockPosition(e){var o;if(e!=="auto")return e;const t=(o=this.viewModel)==null?void 0:o.view,i=B0(this.container)?"top-left":"top-right";if(!t)return i;const r=t.padding||{left:0,right:0,top:0,bottom:0},s=t.width-r.left-r.right,{breakpoints:n}=t;return n&&s<=n.xsmall?"bottom-center":i}_positionContainer(e=this._containerNode){if(e&&(this._containerNode=e),!e)return;const{screenLocation:t}=this.viewModel,{width:i}=e.getBoundingClientRect(),r=this._calculatePositionStyle(t,i);r&&(e.style.top=r.top,e.style.left=r.left,e.style.bottom=r.bottom,e.style.right=r.right)}_calculateFullWidth(e){const{currentAlignment:t,_pointerOffsetInPx:i}=this;return t==="top-left"||t==="bottom-left"||t==="top-right"||t==="bottom-right"?e+i:e}_calculateAlignmentPosition(e,t,i,r){const{currentAlignment:s,_pointerOffsetInPx:n}=this,o=r/2,a=i.height-t,l=i.width-e,{padding:c}=this.view;return s==="bottom-center"?{top:t+n-c.top,left:e-o-c.left}:s==="top-left"?{bottom:a+n-c.bottom,right:l+n-c.right}:s==="bottom-left"?{top:t+n-c.top,right:l+n-c.right}:s==="top-right"?{bottom:a+n-c.bottom,left:e+n-c.left}:s==="bottom-right"?{top:t+n-c.top,left:e+n-c.left}:s==="top-center"?{bottom:a+n-c.bottom,left:e-o-c.left}:void 0}_calculatePositionStyle(e,t){const{dockEnabled:i,view:r}=this;if(!r)return;if(i)return{left:"",top:"",right:"",bottom:""};if(R(e)||!t)return;const s=this._calculateFullWidth(t),n=this._calculateAlignmentPosition(e.x,e.y,r,s);return n?{top:n.top!==void 0?`${n.top}px`:"auto",left:n.left!==void 0?`${n.left}px`:"auto",bottom:n.bottom!==void 0?`${n.bottom}px`:"auto",right:n.right!==void 0?`${n.right}px`:"auto"}:void 0}_viewChange(e,t){e&&t&&(this.close(),this.clear())}_viewReadyChange(e,t){if(e){const i=this.get("viewModel.view");this._wireUpView(i)}else t&&(this.close(),this.clear())}_wireUpView(e){if(this._destroySpinner(),!e)return;const{spinnerEnabled:t}=this;t&&this._createSpinner(e),this._setDockEnabledForViewSize(this.dockOptions)}_dockingThresholdCrossed(e,t,i){const[r,s]=e,[n,o]=t,{width:a,height:l}=i;return r<=a&&n>a||r>a&&n<=a||s<=l&&o>l||s>l&&o<=l}_updateDockEnabledForViewSize(e,t){if(!e||!t)return;const i=this.get("viewModel.view.padding")||{left:0,right:0,top:0,bottom:0},r=i.left+i.right,s=i.top+i.bottom,n=[],o=[];n[0]=e[0]-r,n[1]=e[1]-s,o[0]=t[0]-r,o[1]=t[1]-s;const{dockOptions:a}=this,l=a.breakpoint;this._dockingThresholdCrossed(n,o,l)&&this._setDockEnabledForViewSize(a),this._setCurrentDockPosition()}_focusDockButtonNode(e){this._focusDockButton&&(this._focusDockButton=!1,e.focus())}_closeButtonNodeUpdated(e){return this._focusClose?(this._focusClose=!1,void e.focus()):this._blurClose?(this._blurClose=!1,void e.blur()):void 0}_mainContainerNodeUpdated(e){return this._mainContainerNode=e,this._focusContainer?(this._focusContainer=!1,void e.focus()):this._blurContainer?(this._blurContainer=!1,void e.blur()):void 0}_featureMenuNodeUpdated(e){if(this._featureMenuNode=e,!e||!this._focusFirstFeature)return;this._focusFirstFeature=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_actionsMenuNodeUpdated(e){if(this._actionsMenuNode=e,!e||!this._focusFirstAction)return;this._focusFirstAction=!1;const t=e.querySelectorAll("li");t.length&&t[0].focus()}_focusFeatureMenuButtonNode(e){this._focusFeatureMenuButton&&(this._focusFeatureMenuButton=!1,e.focus())}_focusActionsMenuButtonNode(e){this._focusActionsMenuButton&&(this._focusActionsMenuButton=!1,e.focus())}_featureMenuViewportScrollTop(){this._featureMenuViewportNode&&(this._featureMenuViewportNode.scrollTop=0)}_toggleScreenLocationEnabled(){const{dockEnabled:e,viewModel:t}=this;if(!t)return;const i=t.active&&!e;t.screenLocationEnabled=i}_shouldDockAtCurrentViewSize(e){var a,l;const t=e.breakpoint,i=(l=(a=this.viewModel)==null?void 0:a.view)==null?void 0:l.ui;if(!i)return!1;const{width:r,height:s}=i;if(isNaN(r)||isNaN(s))return!1;const n=t.hasOwnProperty("width")&&r<=t.width,o=t.hasOwnProperty("height")&&s<=t.height;return n||o}_setDockEnabledForViewSize(e){e.breakpoint&&(this.dockEnabled=this._shouldDockAtCurrentViewSize(e))}_getPageText(e,t){return this.featureNavigationVisible?mm(this.messages.pageText,{index:t+1,total:e}):null}_destroySpinner(){const{_spinner:e,view:t}=this;e&&(t&&t.ui&&t.ui.remove(this._spinner,yte),e.destroy(),this._spinner=null)}_createSpinner(e){e&&(this._spinner=new d8e({view:e}),e.ui.add(this._spinner,{key:yte,position:"manual"}))}_toggleCollapsed(){this.collapsed=!this.collapsed}_close(){this.close(),this.view&&this.view.focus()}_toggleDockEnabled(){this.dockEnabled=!this.dockEnabled,this._focusDockButton=!0,this.scheduleRender()}_toggleFeatureMenu(){const e=!this.featureMenuOpen;this._featureMenuOpenChanged(e),this.actionsMenuOpen=!1,this.featureMenuOpen=e}_toggleActionsMenu(){const e=!this.actionsMenuOpen;this._actionsMenuOpenChanged(e),this.featureMenuOpen=!1,this.actionsMenuOpen=e}_triggerAction(e){const t=e.currentTarget.dataset.actionUid,{allActions:i}=this.viewModel,r=i.findIndex(n=>n.uid===t),s=i.getItemAt(r);s&&s.type==="toggle"&&(s.value=!s.value),this.actionsMenuOpen=!1,this.viewModel.triggerAction(r)}_selectFeature(e){const t=e.currentTarget["data-feature-index"];isNaN(t)||(this.viewModel.selectedFeatureIndex=t),this.featureMenuOpen=!1,this._focusFeatureMenuButton=!0,this.scheduleRender()}_next(){this.next()}_previous(){this.previous()}};u([d({readOnly:!0})],Tt.prototype,"actionsMenuId",null),u([d({readOnly:!0})],Tt.prototype,"actionsMenuButtonId",null),u([d({readOnly:!0})],Tt.prototype,"featureMenuId",null),u([d({readOnly:!0})],Tt.prototype,"titleId",null),u([d({readOnly:!0})],Tt.prototype,"contentId",null),u([d({readOnly:!0})],Tt.prototype,"hasContent",null),u([d({readOnly:!0})],Tt.prototype,"featureNavigationVisible",null),u([d({readOnly:!0})],Tt.prototype,"collapsible",null),u([d({readOnly:!0})],Tt.prototype,"featureMenuVisible",null),u([d({readOnly:!0})],Tt.prototype,"contentCollapsed",null),u([d({readOnly:!0})],Tt.prototype,"dividedActions",null),u([wt("viewModel.actions")],Tt.prototype,"actions",void 0),u([d()],Tt.prototype,"actionsMenuOpen",null),u([d()],Tt.prototype,"alignment",void 0),u([wt("viewModel.autoCloseEnabled")],Tt.prototype,"autoCloseEnabled",void 0),u([wt("viewModel.autoOpenEnabled")],Tt.prototype,"autoOpenEnabled",void 0),u([wt("viewModel.defaultPopupTemplateEnabled")],Tt.prototype,"defaultPopupTemplateEnabled",void 0),u([wt("viewModel.content")],Tt.prototype,"content",void 0),u([d()],Tt.prototype,"collapsed",void 0),u([d()],Tt.prototype,"collapseEnabled",void 0),u([d({readOnly:!0})],Tt.prototype,"currentAlignment",null),u([d({readOnly:!0})],Tt.prototype,"currentDockPosition",null),u([d()],Tt.prototype,"dockOptions",null),u([d()],Tt.prototype,"dockEnabled",void 0),u([wt("viewModel.featureCount")],Tt.prototype,"featureCount",void 0),u([d()],Tt.prototype,"featureMenuOpen",void 0),u([wt("viewModel.features")],Tt.prototype,"features",void 0),u([wt("viewModel.goToOverride")],Tt.prototype,"goToOverride",void 0),u([d()],Tt.prototype,"headingLevel",void 0),u([wt("viewModel.highlightEnabled")],Tt.prototype,"highlightEnabled",void 0),u([wt("viewModel.location")],Tt.prototype,"location",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Tt.prototype,"label",void 0),u([d()],Tt.prototype,"maxInlineActions",void 0),u([d(),Ql("esri/widgets/Popup/t9n/Popup")],Tt.prototype,"messages",void 0),u([d(),Ql("esri/t9n/common")],Tt.prototype,"messagesCommon",void 0),u([wt("viewModel.promises")],Tt.prototype,"promises",void 0),u([wt("viewModel.selectedFeature")],Tt.prototype,"selectedFeature",void 0),u([wt("viewModel.selectedFeatureIndex")],Tt.prototype,"selectedFeatureIndex",void 0),u([d({readOnly:!0})],Tt.prototype,"selectedFeatureWidget",null),u([d()],Tt.prototype,"spinnerEnabled",void 0),u([wt("viewModel.title")],Tt.prototype,"title",void 0),u([wt("viewModel.updateLocationEnabled")],Tt.prototype,"updateLocationEnabled",void 0),u([wt("viewModel.view")],Tt.prototype,"view",void 0),u([d({type:t0e}),FLe(["triggerAction","trigger-action"])],Tt.prototype,"viewModel",void 0),u([wt("viewModel.visible")],Tt.prototype,"visible",void 0),u([d()],Tt.prototype,"visibleElements",void 0),u([Ot("visibleElements")],Tt.prototype,"castVisibleElements",null),u([Zu()],Tt.prototype,"_close",null),u([Zu()],Tt.prototype,"_toggleDockEnabled",null),u([Zu()],Tt.prototype,"_toggleFeatureMenu",null),u([Zu()],Tt.prototype,"_toggleActionsMenu",null),u([Zu()],Tt.prototype,"_triggerAction",null),u([Zu()],Tt.prototype,"_selectFeature",null),u([Zu()],Tt.prototype,"_next",null),u([Zu()],Tt.prototype,"_previous",null),Tt=u([P(i0e)],Tt);const xte=Tt,y6=[0,0];function dBe(e){const t=(e.ownerDocument||window.document).defaultView,i=e.getBoundingClientRect();return y6[0]=i.left+t.pageXOffset,y6[1]=i.top+t.pageYOffset,y6}function Tte(e){e&&(Qhe(e),e.parentNode&&e.parentNode.removeChild(e))}function pBe(e){const t=document.createElement("div");return e.appendChild(t),t}const LE=16,CP=750,fBe=512,mBe=2,gBe=e=>{let t=class extends e{constructor(...i){super(...i),this._freqInfo={freq:LE,time:CP},this._overlayRenderTaskHandle=null,this.height=0,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.handles.add([ae(()=>this.cursor,r=>{const{surface:s}=this;s&&s.setAttribute("data-cursor",r)}),ae(()=>this.interacting,r=>{const{surface:s}=this;s&&s.setAttribute("data-interacting",r.toString())})])}initialize(){this.handles.add(ae(()=>this.ui,(i,r)=>this._handleUIChange(i,r))),this._wireUI(this.ui),this.handles.add([this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui&&(this.ui.destroy(),this.ui=null),this.popup&&!this.popup.destroyed&&this.popup.destroy(),this.container=null)}set container(i){const r=this._get("container");if(r===i)return;const s="dom-size";if(this.handles.remove(s),this._stopMeasuring(),r&&(r.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay.destroy(),this._set("overlay",null),Tte(this.root),this._set("root",null),QQ(this.userContent,r),Tte(this.userContent),this._set("userContent",null)),i){i.classList.add("esri-view");const n=document.createElement("div");n.className="esri-view-user-storage",QQ(i,n),i.appendChild(n),this._set("userContent",n);const o=document.createElement("div");o.className="esri-view-root",i.insertBefore(o,i.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const l=new kJ;o.appendChild(l.surface),this._set("overlay",l),ae(()=>l.needsRender,c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=Eb({render:()=>{this.overlay.render()}}):this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null)}),this.forceDOMReadyCycle(),this.handles.add(ae(()=>this.size,c=>{const[h,p]=c,f="esri-view-surface--inset-outline";h>=document.body.clientWidth||p>=document.body.clientHeight?a.classList.add(f):a.classList.remove(f)},Ft),s),this._set("container",i),this._startMeasuring()}else this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),this._set("container",null)}get focused(){const i=document.activeElement===this.surface;return document.hasFocus()&&i}get popup(){return this._get("popup")||new xte({view:this})}set popup(i){const r=this._get("popup");r&&r!==i&&r.destroy(),this._set("popup",i)}get size(){return[this.width,this.height]}blur(){this.surface&&this.surface.blur()}focus(){this.surface&&this.surface.focus()}pageToContainer(i,r,s){const n=this.position;return i-=n[0],r-=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}containerToPage(i,r,s){const n=this.position;return i+=n[0],r+=n[1],s?(s[0]=i,s[1]=r):s=[i,r],s}_handleUIChange(i,r){r&&(this.handles.remove("ui"),r.destroy()),i&&this._wireUI(i),this._set("ui",i)}_wireUI(i){this.handles.remove("ui"),i&&(i.view=this,this.handles.add([ae(()=>this.root,r=>{i.container=r?pBe(r):null},Ft),ae(()=>this.popup,(r,s)=>{const n="popup",o="manual";s&&i.remove(s,n),r&&(r.view=i.view,i.add(r,{key:n,position:o}))},Ft)],"ui"))}_stopMeasuring(){this.handles.remove("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const i=this._freqInfo;i.freq=LE,i.time=CP,this.handles.add([(()=>{const r=()=>{i.freq=LE,i.time=CP};return window.addEventListener("resize",r),{remove(){window.removeEventListener("resize",r)}}})(),Eb({prepare:r=>{const s=this._measure(),n=this._freqInfo;if(n.time+=r.deltaTime,s&&(n.freq=LE,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?LE:Math.min(CP,n.freq*mBe),!s&&n.freq>=fBe&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const i=this.container,r=i?i.clientWidth:0,s=i?i.clientHeight:0;if(r===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return r===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",r),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:r,height:s}),!0)}_position(){const i=this.container,r=this.position,s=dBe(i);return(!r||s[0]!==r[0]||s[1]!==r[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d({value:null,cast:i=>x4(i)})],t.prototype,"container",null),u([d({readOnly:!0})],t.prototype,"focused",null),u([d({readOnly:!0})],t.prototype,"height",void 0),u([d({type:xte})],t.prototype,"popup",null),u([d({type:kJ})],t.prototype,"overlay",void 0),u([d({readOnly:!0})],t.prototype,"position",void 0),u([d({readOnly:!0})],t.prototype,"resizing",void 0),u([d({readOnly:!0})],t.prototype,"root",void 0),u([d({value:null,readOnly:!0})],t.prototype,"size",null),u([d({readOnly:!0})],t.prototype,"surface",void 0),u([d({readOnly:!0})],t.prototype,"suspended",void 0),u([d()],t.prototype,"ui",void 0),u([d({readOnly:!0})],t.prototype,"userContent",void 0),u([d({readOnly:!0})],t.prototype,"width",void 0),u([d()],t.prototype,"widthBreakpoint",void 0),t=u([P("esri.views.DOMContainer")],t),t};function F_t(e){return e&&"focus"in e}const _X=me.getLogger("esri.layers.support.ElevationSampler");class r0e{queryElevation(t){return s0e(t.clone(),this)}on(){return wBe}projectIfRequired(t,i){return n0e(t,i)}}class yBe extends r0e{constructor(t,i,r){super(),this.tile=t,this.noDataValue=r,this.extent=h4(t.tile.extent,i.spatialReference),this.extent.zmin=t.zmin,this.extent.zmax=t.zmax,this.aaExtent=t.tile.extent;const s=cc(i.spatialReference),n=i.lodAt(t.tile.level).resolution*s;this.demResolution={min:n,max:n}}get spatialReference(){return this.extent.spatialReference}contains(t){const i=this.projectIfRequired(t,this.spatialReference);return!R(i)&&this.containsAt(i.x,i.y)}containsAt(t,i){return oq(this.aaExtent,t,i)}elevationAt(t,i){if(!this.containsAt(t,i)){const r=this.extent,s=`${r.xmin}, ${r.ymin}, ${r.xmax}, ${r.ymax}`;return _X.warn("#elevationAt()",`Point used to sample elevation (${t}, ${i}) is outside of the sampler extent (${s})`),this.noDataValue}return yt(this.tile.sample(t,i),this.noDataValue)}}class U_t extends r0e{constructor(t,i,r){let s;super(),typeof i=="number"?(this.noDataValue=i,s=null):(s=i,this.noDataValue=r),this.samplers=s?t.map(o=>new yBe(o,s,this.noDataValue)):t;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=h4(Dt(),s.spatialReference),this.demResolution={min:0,max:0}}get spatialReference(){return this.extent.spatialReference}elevationAt(t,i){for(const r of this.samplers)if(r.containsAt(t,i))return r.elevationAt(t,i);return _X.warn("#elevationAt()",`Point used to sample elevation (${t}, ${i}) is outside of the sampler`),this.noDataValue}}function s0e(e,t){const i=n0e(e,t.spatialReference);if(!i)return null;switch(e.type){case"point":vBe(e,i,t);break;case"polyline":_Be(e,i,t);break;case"multipoint":bBe(e,i,t)}return e}function n0e(e,t){if(R(e))return null;const i=e.spatialReference;if(i.equals(t))return e;const r=aw(e,t);return r||_X.error(`Cannot project geometry spatial reference (wkid:${i.wkid}) to elevation sampler spatial reference (wkid:${t.wkid})`),r}function vBe(e,t,i){e.z=i.elevationAt(t.x,t.y)}function _Be(e,t,i){tf.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s],o=t.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];tf.x=c[0],tf.y=c[1],r&&(l[3]=l[2]),l[2]=i.elevationAt(tf.x,tf.y)}}e.hasZ=!0}function bBe(e,t,i){tf.spatialReference=t.spatialReference;const r=e.hasM&&!e.hasZ;for(let s=0;s<e.points.length;s++){const n=e.points[s],o=t.points[s];tf.x=o[0],tf.y=o[1],r&&(n[3]=n[2]),n[2]=i.elevationAt(tf.x,tf.y)}e.hasZ=!0}const tf=new nt,wBe={remove(){}};var a7;let Ip=a7=class extends fe{constructor(e){super(e),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new a7({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Ip.prototype,"cols",void 0),u([d({type:yr,json:{write:!0}})],Ip.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],Ip.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Ip.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],Ip.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Ip.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],Ip.prototype,"scale",void 0),Ip=a7=u([P("esri.layers.support.LOD")],Ip);const o0e=Ip;var Zy;const Ste=new _i({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let kn=Zy=class extends fe{constructor(e){super(e),this.dpi=96,this.format=null,this.origin=null,this.minScale=0,this.maxScale=0,this.size=null,this.spatialReference=null}static create(e={}){const{resolutionFactor:t=1,scales:i,size:r=256,spatialReference:s=Xe.WebMercator,numLODs:n=24}=e;if(!ul(s)){const p=[];if(i)for(let f=0;f<i.length;f++){const m=i[f];p.push({level:f,scale:m,resolution:m})}else{let f=5e-4;for(let m=n-1;m>=0;m--)p.unshift({level:m,scale:f,resolution:f}),f*=2}return new Zy({dpi:96,lods:p,origin:new nt(0,0,s),size:[r,r],spatialReference:s})}const o=J0(s),a=e.origin?new nt({x:e.origin.x,y:e.origin.y,spatialReference:s}):new nt(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(cc(s)*39.37*l),h=[];if(i)for(let p=0;p<i.length;p++){const f=i[p],m=f*c;h.push({level:p,scale:f,resolution:m})}else{let p=Yce(s)?512/r*5916575275917094e-7:256/r*591657527591555e-6;const f=Math.ceil(n/t);h.push({level:0,scale:p,resolution:p*c});for(let m=1;m<f;m++){const y=p/2**t,v=y*c;h.push({level:m,scale:y,resolution:v}),p=y}}return new Zy({dpi:l,lods:h,origin:a,size:[r,r],spatialReference:s})}get isWrappable(){const{spatialReference:e,origin:t}=this;if(e&&t){const i=J0(e);return e.isWrappable&&Math.abs(i.origin[0]-t.x)<=i.dx}return!1}readOrigin(e,t){return nt.fromJSON(F({spatialReference:t.spatialReference},e))}set lods(e){let t=0,i=0;const r=[];this._levelToLOD={},e&&(t=-1/0,i=1/0,e.forEach(s=>{r.push(s.scale),t=s.scale>t?s.scale:t,i=s.scale<i?s.scale:i,this._levelToLOD[s.level]=s})),this._set("scales",r),this._set("minScale",t),this._set("maxScale",i),this._set("lods",e),this._initializeUpsampleLevels()}readSize(e,t){return[t.cols,t.rows]}writeSize(e,t){t.cols=e[0],t.rows=e[1]}zoomToScale(e){const t=this.scales;if(e<=0)return t[0];if(e>=t.length-1)return t[t.length-1];{const i=Math.floor(e),r=i+1;return t[i]/(t[i]/t[r])**(e-i)}}scaleToZoom(e){const t=this.scales,i=t.length-1;let r=0;for(;r<i;r++){const s=t[r],n=t[r+1];if(s<=e)return r;if(n===e)return r+1;if(s>e&&n<e)return r+Math.log(s/e)/Math.log(s/n)}return r}snapScale(e,t=.95){const i=this.scaleToZoom(e);return i%Math.floor(i)>=t?this.zoomToScale(Math.ceil(i)):this.zoomToScale(Math.floor(i))}tileAt(e,t,i,r){const s=this.lodAt(e);if(!s)return null;let n,o;if(typeof t=="number")n=t,o=i;else if(ac(t.spatialReference,this.spatialReference))n=t.x,o=t.y,r=i;else{const c=aw(t,this.spatialReference);if(R(c))return null;n=c.x,o=c.y,r=i}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return r||(r={id:null,level:0,row:0,col:0,extent:Dt()}),r.level=e,r.row=Math.floor((this.origin.y-o)/l+.001),r.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(r),r}updateTileInfo(e,t=Zy.ExtrapolateOptions.NONE){let i=this.lodAt(e.level);if(!i&&t===Zy.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<e.level&&(i=o)}if(!i)return;const r=e.level-i.level,s=i.resolution*this.size[0]/2**r,n=i.resolution*this.size[1]/2**r;e.id=`${e.level}/${e.row}/${e.col}`,e.extent||(e.extent=Dt()),e.extent[0]=this.origin.x+e.col*s,e.extent[1]=this.origin.y-(e.row+1)*n,e.extent[2]=e.extent[0]+s,e.extent[3]=e.extent[1]+n}upsampleTile(e){const t=this._upsampleLevels[e.level];return!(!t||t.parentLevel===-1)&&(e.level=t.parentLevel,e.row=Math.floor(e.row/t.factor+.001),e.col=Math.floor(e.col/t.factor+.001),this.updateTileInfo(e),!0)}getTileBounds(e,t){const{resolution:i}=this.lodAt(t.level),r=i*this.size[0],s=i*this.size[1];return e[0]=this.origin.x+t.col*r,e[1]=this.origin.y-(t.row+1)*s,e[2]=e[0]+r,e[3]=e[1]+s,e}lodAt(e){return this._levelToLOD&&this._levelToLOD[e]||null}clone(){return Zy.fromJSON(this.write({}))}getOrCreateCompatible(e,t){if(this.size[0]===256&&this.size[1]===256)return e===256?this:null;const i=[],r=this.lods.length;for(let s=0;s<r;s++){const n=this.lods[s],o=n.resolution*t;i.push(new o0e({level:n.level,scale:n.scale,resolution:o}))}return new Zy({size:[e,e],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:i})}_initializeUpsampleLevels(){const e=this.lods;this._upsampleLevels=[];let t=null;for(let i=0;i<e.length;i++){const r=e[i];this._upsampleLevels[r.level]={parentLevel:t?t.level:-1,factor:t?t.resolution/r.resolution:0},t=r}}};u([d({type:Number,json:{write:!0}})],kn.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],kn.prototype,"dpi",void 0),u([d({type:String,json:{read:Ste.read,write:Ste.write,origins:{"web-scene":{read:!1,write:!1}}}})],kn.prototype,"format",void 0),u([d({readOnly:!0})],kn.prototype,"isWrappable",null),u([d({type:nt,json:{write:!0}})],kn.prototype,"origin",void 0),u([ke("origin")],kn.prototype,"readOrigin",null),u([d({type:[o0e],value:null,json:{write:!0}})],kn.prototype,"lods",null),u([d({readOnly:!0})],kn.prototype,"minScale",void 0),u([d({readOnly:!0})],kn.prototype,"maxScale",void 0),u([d({readOnly:!0})],kn.prototype,"scales",void 0),u([d({cast:e=>Array.isArray(e)?e:typeof e=="number"?[e,e]:[256,256]})],kn.prototype,"size",void 0),u([ke("size",["rows","cols"])],kn.prototype,"readSize",null),u([Be("size",{cols:{type:yr},rows:{type:yr}})],kn.prototype,"writeSize",null),u([d({type:Xe,json:{write:!0}})],kn.prototype,"spatialReference",void 0),kn=Zy=u([P("esri.layers.support.TileInfo")],kn),function(e){var t;(t=e.ExtrapolateOptions||(e.ExtrapolateOptions={}))[t.NONE=0]="NONE",t[t.POWER_OF_TWO=1]="POWER_OF_TWO"}(kn||(kn={}));const PD=kn,xBe=12;class Rr{constructor(t){const i=Rr.checkUnsupported(t);if(_(i))throw i;const r=t;this.spatialReference=r.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=Db(this.spatialReference)||If(this.spatialReference)||$f(this.spatialReference),this.origin=[r.origin.x,r.origin.y],this.pixelSize=r.size[0],this.dpi=r.dpi;const s=r.lods.reduce((c,h,p)=>(h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c),{min:1/0,minIndex:0,max:-1/0}),n=r.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*r.size[0],a*r.size[1]]},a/=2,l/=2}clone(){return new Rr(this.toTileInfo())}toTileInfo(){return new PD({dpi:this.dpi,origin:{x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference},size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((t,i)=>({level:i,scale:t.scale,resolution:t.resolution}))})}getExtent(t,i,r,s){const n=this.levels[t],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+r*o,s[2]=this.origin[0]+(r+1)*o,s[3]=this.origin[1]-i*a,s[1]=this.origin[1]-(i+1)*a}convertExtentToRadians(t,i){this._isWebMercator?(i[0]=SQ(t[0]),i[1]=KL(t[1]),i[2]=SQ(t[2]),i[3]=KL(t[3])):this._isGCS&&(i[0]=$t(t[0]),i[1]=$t(t[1]),i[2]=$t(t[2]),i[3]=$t(t[3]))}getExtentGeometry(t,i,r,s=new ci){return this.getExtent(t,i,r,rp),s.spatialReference=this.spatialReference,s.xmin=rp[0],s.ymin=rp[1],s.xmax=rp[2],s.ymax=rp[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(t){if(t==null)return!1;let i=!1;for(;this.levels.length<=t;){const r=this.levels[this.levels.length-1],s=r.resolution/2;this.levels.push({resolution:s,scale:r.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),i=!0}return i}capMaxLod(t){this.levels.length>t+1&&(this.levels.length=t+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(t){return this.levels[0].scale/2**t}levelAtScale(t){const i=this.levels[0].scale;return t>=i?0:Math.log(i/t)*Math.LOG2E}resolutionAtLevel(t){return this.levels[0].resolution/2**t}compatibleWith(t){if(!(t instanceof Rr)){if(Rr.checkUnsupported(t))return!1;t=new Rr(t)}if(!t.spatialReference.equals(this.spatialReference)||t.pixelSize!==this.pixelSize)return!1;const i=Math.min(this.levels.length,t.levels.length)-1,r=this.levels[i].resolution;let s=.5*r;return!XT(t.origin[0],this.origin[0],s)||!XT(t.origin[1],this.origin[1],s)?!1:(s=.5*r/2**i/this.pixelSize*xBe,XT(r,t.levels[i].resolution,s))}rootTilesInExtent(t,i=null,r=1/0){const s=new Array,n=this.levels[0].tileSize;if(R(t)||n[0]===0||n[1]===0)return s;Rr.computeRowColExtent(t,n,this.origin,rp);let o=rp[1],a=rp[3],l=rp[0],c=rp[2];const h=c-l,p=a-o;if(h*p>r){const f=Math.floor(Math.sqrt(r));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let m=l;m<c;m++)s.push([0,f,m]);return _(i)&&(i[0]=this.origin[0]+l*n[0],i[1]=this.origin[1]-a*n[1],i[2]=this.origin[0]+c*n[0],i[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(t,i,r,s){const n=.001*(t[2]-t[0]+(t[3]-t[1]));s[0]=Math.max(0,Math.floor((t[0]+n-r[0])/i[0])),s[2]=Math.max(0,Math.ceil((t[2]-n-r[0])/i[0])),s[1]=Math.max(0,Math.floor((r[1]-t[3]+n)/i[1])),s[3]=Math.max(0,Math.ceil((r[1]-t[1]-n)/i[1]))}static isPowerOfTwo(t){const i=t.lods,r=i[0].resolution*2**i[0].level;return!i.some(s=>!e2e(s.resolution,r/2**s.level))}static hasGapInLevels(t){const i=t.lods.map(r=>r.level);i.sort((r,s)=>r-s);for(let r=1;r<i.length;r++)if(i[r]!==i[0]+r)return!0;return!1}static tileSizeSupported(t){const i=t.size[1];return i===t.size[0]&&(i&i-1)==0&&i>=128&&i<=512}static hasOriginPerLODs(t){const i=t.origin;return t.lods.some(r=>r.origin!=null&&(r.origin[0]!==i.x||r.origin[1]!==i.y))}static getMissingTileInfoError(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(t){return R(t)?bX():t.lods.length<1?new q("tilingscheme:generic","Tiling scheme must have at least one level"):Rr.isPowerOfTwo(t)?Rr.hasGapInLevels(t)?new q("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):Rr.tileSizeSupported(t)?Rr.hasOriginPerLODs(t)?new q("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new q("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new q("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(t,i){const r=t[2]-t[0],s=t[3]-t[1],n=cc(i),o=1.2*Math.max(r,s),a=256,l=96,c=.0254,h=new Rr(new PD({size:[a,a],origin:{x:t[0]-.5*(o-r),y:t[3]+.5*(o-s)},lods:[{level:0,resolution:o/a,scale:1/(a/l*c/(o*n))}],spatialReference:i}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(t){const i=new Rr(Rr.WebMercatorAuxiliarySphereTileInfo);return i.ensureMaxLod(t),i}static makeGCSWithTileSize(t,i=256,r=16){const s=256/i,n=new Rr(new PD({size:[i,i],origin:{x:-180,y:90,spatialReference:t},spatialReference:t,lods:[{level:0,resolution:.703125*s,scale:295497598570834e-6*s}]}));return n.ensureMaxLod(r),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}}function bX(){return new q("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}Rr.WebMercatorAuxiliarySphereTileInfo=new PD({size:[256,256],origin:{x:-20037508342787e-6,y:20037508342787e-6,spatialReference:Xe.WebMercator},spatialReference:Xe.WebMercator,lods:[{level:0,resolution:156543.03392800014,scale:591657527591555e-6}]}),Rr.WebMercatorAuxiliarySphere=Rr.makeWebMercatorAuxiliarySphere(19);const rp=Dt(),PT=64,l7=512,TBe=2.5,fM=t2e(QV/10),a0e=4,SBe=4,ID=e=>e<4?3:SBe,l0e=Dt();Rr.WebMercatorAuxiliarySphere.getExtent(0,0,0,l0e);const EBe=Dt([-180,-90,180,90]),CBe="Cannot extend surface to encompass all layers because it would result in too many root tiles.",ABe="Surface extent is too large for tile resolution at level 0.",Qu=8,RBe=me.getLogger("esri.views.support.GroundViewElevationSampler");let Qy=class extends us.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=fM}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if(R(e.extent)||!e.spatialReference)return null;const t=h4(e.extent,e.spatialReference);return t.zmin=e.elevationBounds.min,t.zmax=e.elevationBounds.max,t}elevationAt(e,t){if(R(this.extent)||!ma(this.extent,e,t)){const i=_(this.extent)?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return RBe.warn("#elevationAt()",`Point used to sample elevation (${e}, ${t}) is outside of the sampler extent (${i})`),this.noDataValue}return yt(this.view.elevationProvider.getElevation(e,t,0,this.spatialReference,"ground"),this.noDataValue)}queryElevation(e){return s0e(e.clone(),this)}};u([d({readOnly:!0})],Qy.prototype,"demResolution",void 0),u([d({readOnly:!0})],Qy.prototype,"extent",null),u([d({readOnly:!0})],Qy.prototype,"noDataValue",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],Qy.prototype,"spatialReference",void 0),u([d({constructOnly:!0})],Qy.prototype,"view",void 0),Qy=u([P("esri.views.support.GroundViewElevationSampler")],Qy);const MBe=Qy;let Jy=class extends Ee{constructor(e){super(e),this.handles=new qt,this.view=null,this.layerViews=new at}initialize(){this.handles.add(cl(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground},e=>e.load())),this.handles.add(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this._set("view",null),this.handles&&(this.handles.destroy(),this.handles=null)}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new MBe({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.handles.remove("updating"),this.handles.add(this.layerViews.map(e=>ae(()=>e.updating,()=>this._updateUpdating(),rr)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],Jy.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],Jy.prototype,"updating",null),u([d({constructOnly:!0})],Jy.prototype,"view",void 0),u([d({type:at,readOnly:!0})],Jy.prototype,"layerViews",void 0),u([d({readOnly:!0})],Jy.prototype,"suspended",null),Jy=u([P("esri.views.GroundView")],Jy);const OBe=Jy,PBe=e=>{let t=class extends e{async fetchPopupFeatures(i,r){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(i,r),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,r),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:F2e([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}_queryLayerPopupFeatures(i,r,s){return r.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:_(s)?s.event:null,signal:_(s)?s.signal:null,defaultPopupTemplateEnabled:!!_(s)&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(i,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(i,r){return i&&!!i.getEffectivePopupTemplate(_(r)&&r.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(i,r){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(i,r),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(i,r){const{results:s,mapPoint:n}=await this.popupHitTest(i),o=s.filter(l=>l.type==="graphic"&&this._isValidPopupGraphic(l.graphic,r)),a=o.length?o[0].mapPoint:null;return{clientGraphics:o.map(l=>l.graphic),queryArea:n,location:n||a}}_getFetchPopupLayerViews(){const i=[];return this.allLayerViews.forEach(r=>{this._isValidPopupLayerView(r)&&i.push(r)}),_(this.graphicsView)&&this._isValidPopupLayerView(this.graphicsView)&&i.push(this.graphicsView),i.reverse()}_isValidPopupLayerView(i){return _(i)&&(!("layer"in i)||!i.suspended)&&"fetchPopupFeatures"in i}_graphicsPerFetchPopupLayerView(i,r){const s=[],n=new Map,o=r.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of i){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return t=u([P("esri.views.PopupView")],t),t};async function wX(e,t){return await e.load(),IBe(e,t)}async function IBe(e,t){const i=[],r=(...n)=>{for(const o of n)R(o)||(Array.isArray(o)?r(...o):at.isCollection(o)?o.forEach(a=>r(a)):Sf.isLoadable(o)&&i.push(o))};t(r);let s=null;if(await YLe(i,async n=>{(await nc($Be(n)?n.loadAll():n.load())).ok!==!1||s||(s=n)}),s)throw s.loadError;return e}function $Be(e){return"loadAll"in e&&typeof e.loadAll=="function"}async function DBe(e){if(!e)return;const t=e.includes("-vector")?e.slice(0,e.indexOf("-vector")):e,i=await tde("esri/t9n/basemaps");return i[e]||i[t]}const c7={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return Mi("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/30d6b8271e1849cd9c3042060001f425/resources/styles/root.json",layerType:"VectorTileLayer",title:"Hybrid Reference Layer",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return Mi("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Mi("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Mi("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return Mi("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return Mi("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return Mi("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return Mi("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return Mi("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return Mi("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return Mi("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return Mi("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return Mi("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return Mi("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return Mi("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return Mi("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]}},LBe=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),NBe=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","ogc-feature","route","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function FBe(e){return e.layerContainerType==="basemap"?LBe:e.layerContainerType==="operational-layers"?NBe:null}function UBe(e,t){if(t.restrictedWebMapWriting){const i=FBe(t);return!_(i)||i.has(e.type)&&!rW(e)}return!0}function kBe(e,t){if(rW(e)){const i=N2("featureCollection.layers",t),r=i&&i[0]&&i[0].layerDefinition;r&&v6(e,r)}else e.type==="stream"?v6(e,t.layerDefinition=t.layerDefinition||{}):e.type!=="group"&&v6(e,t)}function v6(e,t){"maxScale"in e&&(t.maxScale=JL(e.maxScale)),"minScale"in e&&(t.minScale=JL(e.minScale))}function zBe(e,t){if(kBe(e,t),"blendMode"in e&&(t.blendMode=e.blendMode,t.blendMode==="normal"&&delete t.blendMode),t.opacity=JL(e.opacity),t.title=e.title||"Layer",t.visibility=e.visible,"legendEnabled"in e&&e.type!=="wmts")if(rW(e)){const i=t.featureCollection;i&&(i.showLegend=e.legendEnabled)}else t.showLegend=e.legendEnabled}function Ete(e,t,i){if(!("write"in e)||!e.write)return i&&i.messages&&i.messages.push(new q("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted`,{layer:e})),null;if(UBe(e,i)){const r={};return e.write(r,i)?r:null}return _(t)&&zBe(e,t=te(t)),t}var $D;let VBe=0;const _6=me.getLogger("esri.Basemap");let Bu=$D=class extends vO(Sf){constructor(e){super(e),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+VBe++,this.baseLayers=new at,this.referenceLayers=new at;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type==="elevation"&&_6.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a basemap layer and will therefore be ignored.`)},i=r=>{r.parent=null};this.baseLayers.on("after-add",r=>t(r.item)),this.referenceLayers.on("after-add",r=>t(r.item)),this.baseLayers.on("after-remove",r=>i(r.item)),this.referenceLayers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{_6.error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){var i;const e=this.baseLayers.removeAll();for(const r of e)r.destroy();const t=this.referenceLayers.removeAll();for(const r of t)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),(i=this.portalItem)==null||i.destroy(),this.portalItem=null}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=F({},e)).resourceInfo),e}set baseLayers(e){this._set("baseLayers",_g(e,this._get("baseLayers")))}_writeBaseLayers(e,t,i){const r=[];e&&(i=ve(F({},i),{layerContainerType:"basemap"}),this.baseLayers.forEach(s=>{const n=Ete(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&r.push(n)}),this.referenceLayers.forEach(s=>{const n=Ete(s,i.webmap?i.webmap.getLayerJSONFromResourceInfo(s):null,i);_(n)&&(n.isReference=!0,r.push(n))})),t.baseMapLayers=r}set referenceLayers(e){this._set("referenceLayers",_g(e,this._get("referenceLayers")))}writeTitle(e,t){t.title=e||"Basemap"}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return wX(this,e=>{e(this.baseLayers,this.referenceLayers)})}clone(){const e={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.slice(),referenceLayers:this.referenceLayers.slice()};return this.loaded&&(e.loadStatus="loaded"),new $D({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}write(e,t){return e=e||{},t&&t.origin||(t=F({origin:"web-map"},t)),super.write(e,t),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(e.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(i=>{const r=te(i);return r.url&&Tf(r.url)&&(r.url=`https:${r.url}`),r.templateUrl&&Tf(r.templateUrl)&&(r.templateUrl=`https:${r.templateUrl}`),r})),e}async _loadFromSource(e){const{resourceInfo:t,portalItem:i}=this;li(e);const r=[];if(t){const s=t.context?t.context.url:null;if(r.push(this._loadLayersFromJSON(t.data,s,e)),t.data.id&&!t.data.title){const n=t.data.id;r.push(DBe(n).then(o=>{o&&this.read({title:o},t.context)}))}}else i&&r.push(this._loadFromItem(i,e));await Promise.all(r)}async _loadLayersFromJSON(e,t,i){const r=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||r&&r.portal||null,n=r&&r.origin==="web-scene"?"web-scene":"web-map",{populateOperationalLayers:o}=await import("./layersCreator.f5e21211.js"),a=[];if(li(i),e.baseMapLayers&&Array.isArray(e.baseMapLayers)){const l={context:{origin:n,url:t,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=o(this.baseLayers,e.baseMapLayers.filter(p=>!p.isReference),l);a.push(c);const h=o(this.referenceLayers,e.baseMapLayers.filter(p=>p.isReference),l);a.push(h)}await pn(a)}async _loadFromItem(e,t){const i=await e.load(t),r=await i.fetchData("json",t),s=hn(e.itemUrl);return this._set("resourceInfo",{data:r.baseMap,context:{origin:"web-map",portal:e.portal||Kn.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:r.spatialReference},this.resourceInfo.context),this.read({title:e.title,thumbnailUrl:e.thumbnailUrl},{origin:"portal-item",portal:e.portal||Kn.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,t)}static fromId(e){const t=c7[e];if(t){if(t.deprecated){let i=null;e==="dark-gray"?i="dark-gray-vector":e==="gray"?i="gray-vector":e==="streets"?i="streets-vector":e==="topo"&&(i="topo-vector"),lce(_6,`The ${e} basemap has entered mature support and is no longer being updated.`,{replacement:i,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return $D.fromJSON(t)}return null}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(e,t,i,r){this._writeBaseLayers(e,t,r)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:at}},writer(e,t,i,r){this._writeBaseLayers(e,t,r)}}}}}})],Bu.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],Bu.prototype,"id",void 0),u([d({type:e2})],Bu.prototype,"portalItem",void 0),u([d()],Bu.prototype,"referenceLayers",null),u([d({readOnly:!0})],Bu.prototype,"resourceInfo",void 0),u([d({type:Xe})],Bu.prototype,"spatialReference",void 0),u([d()],Bu.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],Bu.prototype,"title",void 0),u([Be("title")],Bu.prototype,"writeTitle",null),Bu=$D=u([P("esri.Basemap")],Bu);const t2=Bu;var BBe=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",default:t2}),u7;let DD=u7=class extends fe{constructor(e){super(e),this.type="none"}clone(){return new u7({type:this.type})}};u([ct({none:"none",stayAbove:"stay-above"})],DD.prototype,"type",void 0),DD=u7=u([P("esri.ground.NavigationConstraint")],DD);var h7;const Cte=me.getLogger("esri.Ground");let Tm=h7=class extends vO(Sf){constructor(e){super(e),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new at;const t=r=>{r.parent&&r.parent!==this&&"remove"in r.parent&&r.parent.remove(r),r.parent=this,r.type!=="elevation"&&r.type!=="base-elevation"&&Cte.error(`Layer '${r.title}, id:${r.id}' of type '${r.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},i=r=>{r.parent=null};this.layers.on("after-add",r=>t(r.item)),this.layers.on("after-remove",r=>i(r.item))}initialize(){this.when().catch(e=>{Cte.error("#load()","Failed to load ground",e)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const e=this.layers.removeAll();for(const t of e)t.destroy();this.layers.destroy()}normalizeCtorArgs(e){return e&&"resourceInfo"in e&&(this._set("resourceInfo",e.resourceInfo),delete(e=F({},e)).resourceInfo),e}set layers(e){this._set("layers",_g(e,this._get("layers")))}writeLayers(e,t,i,r){const s=[];e&&(r=ve(F({},r),{layerContainerType:"ground"}),e.forEach(n=>{if("write"in n){const o={};Bke(n)().write(o,r)&&s.push(o)}else r&&r.messages&&r.messages.push(new q("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),t.layers=s}load(e){return this.addResolvingPromise(this._loadFromSource(e)),Promise.resolve(this)}loadAll(){return wX(this,e=>{e(this.layers)})}async queryElevation(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.7e4349b3.js");li(t);const r=new i,s=this.layers.filter(Ate).toArray();return r.queryAll(s,e,t)}async createElevationSampler(e,t){await this.load({signal:t==null?void 0:t.signal});const{ElevationQuery:i}=await import("./ElevationQuery.7e4349b3.js");li(t);const r=new i,s=this.layers.filter(Ate).toArray();return r.createSamplerAll(s,e,t)}clone(){const e={opacity:this.opacity,surfaceColor:te(this.surfaceColor),navigationConstraint:te(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(e.loadStatus="loaded"),new h7({resourceInfo:this.resourceInfo}).set(e)}read(e,t){this.resourceInfo||this._set("resourceInfo",{data:e,context:t}),super.read(e,t)}_loadFromSource(e){const t=this.resourceInfo;return t?this._loadLayersFromJSON(t.data,t.context,e):Promise.resolve(null)}_loadLayersFromJSON(e,t,i){const r=t&&t.origin||"web-scene",s=t&&t.portal||null,n=t&&t.url||null;return import("./layersCreator.f5e21211.js").then(({populateOperationalLayers:o})=>{li(i);const a=[];if(e.layers&&Array.isArray(e.layers)){const l={context:{origin:r,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,e.layers,l))}return pn(a)}).then(()=>{})}};function GBe(e){return e&&"createElevationSampler"in e}function Ate(e){return e.type==="elevation"||GBe(e)}u([d({json:{read:!1}})],Tm.prototype,"layers",null),u([Be("layers")],Tm.prototype,"writeLayers",null),u([d({readOnly:!0})],Tm.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:yr,read:{reader:LS,source:"transparency"},write:{writer:(e,t)=>{t.transparency=xO(e)},target:"transparency"}}})],Tm.prototype,"opacity",void 0),u([d({type:qe,json:{type:[yr],write:(e,t)=>{t.surfaceColor=e.toJSON().slice(0,3)}}})],Tm.prototype,"surfaceColor",void 0),u([d({type:DD,json:{write:!0}})],Tm.prototype,"navigationConstraint",void 0),Tm=h7=u([P("esri.Ground")],Tm);const mM=Tm;let Kx=class extends mw(at){constructor(e){super(e),this.getCollections=null}initialize(){this.handles.add(Sce(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=_(this.getCollections)?this.getCollections():null;if(R(e))return void this.removeAll();let t=0;for(const i of e)_(i)&&(t=this._processCollection(t,i));this.splice(t,this.length)}_createNewInstance(e){return new at(e)}_processCollection(e,t){if(!t)return e;const i=this.itemFilterFunction?this.itemFilterFunction:r=>!!r;for(const r of t)if(r){if(i(r)){const s=this.indexOf(r,e);s>=0?s!==e&&this.reorder(r,e):this.add(r,e),++e}if(this.getChildrenFunction){const s=this.getChildrenFunction(r);if(Array.isArray(s))for(const n of s)e=this._processCollection(e,n);else e=this._processCollection(e,s)}}return e}};u([d()],Kx.prototype,"getCollections",void 0),u([d()],Kx.prototype,"getChildrenFunction",void 0),u([d()],Kx.prototype,"itemFilterFunction",void 0),Kx=u([P("esri.core.CollectionFlattener")],Kx);const i2=Kx;function jBe(e){var t;return!!(e&&e.loaded&&"capabilities"in e&&((t=e==null?void 0:e.capabilities)==null?void 0:t.operations)&&"supportsEditing"in e.capabilities.operations&&e.capabilities.operations.supportsEditing===!0)&&!("editingEnabled"in e&&!e.editingEnabled)}const Rte=me.getLogger("esri.support.basemapUtils");function HBe(){return{}}function qBe(e){for(const t in e){const i=e[t];(i==null?void 0:i.destroyed)===!1&&i.destroy(),delete e[t]}}function xX(e,t){let i;if(typeof e=="string"){if(!(e in c7)){const r=Object.entries(c7).filter(([s,n])=>Ii.apiKey&&!n.classic||!Ii.apiKey&&n.classic&&!n.deprecated).map(([s])=>`"${s}"`).join(", ");return Rte.warn(`Unable to find basemap definition for: ${e}. Try one of these: ${r}`),null}t&&(i=t[e]),i||(i=t2.fromId(e),t&&(t[e]=i))}else i=Qr(t2,e);return(i==null?void 0:i.destroyed)&&(Rte.warn("The provided basemap is already destroyed",{basemap:i}),i=null),i}function WBe(e,t=null){const i=xX(e);if(!i)return null;const r=new t2({id:i.id,title:i.title,baseLayers:i.baseLayers.slice(),referenceLayers:i.referenceLayers.slice()});return t&&(r.baseLayers=Mte(r.baseLayers,t.baseLayers),r.referenceLayers=Mte(r.referenceLayers,t.referenceLayers)),r.load().catch(()=>{}),r.portalItem=i.portalItem,r}function Mte(e,t){const i=new at;return e.forEach(r=>{const s=t.find(n=>XBe(Ote(r),Ote(n)))||r;i.includes(s)?i.push(r):i.push(s)}),i}function Ote(e){var t,i;return{type:e.type,url:YBe("urlTemplate"in e&&e.urlTemplate||e.url||"styleUrl"in e&&e.styleUrl),minScale:"minScale"in e&&e.minScale!=null?e.minScale:0,maxScale:"maxScale"in e&&e.maxScale!=null?e.maxScale:0,opacity:e.opacity!=null?e.opacity:1,visible:e.visible==null||!!e.visible,sublayers:e.type!=="map-image"&&e.type!=="wms"||!_(e.sublayers)||(t=e.sublayers)==null?void 0:t.map(r=>({id:r.id,visible:r.visible})),activeLayerId:e.type==="wmts"?(i=e.activeLayer)==null?void 0:i.id:void 0}}function XBe(e,t){if(e.type!==t.type||e.url!==t.url||e.minScale!==t.minScale||e.maxScale!==t.maxScale||e.visible!==t.visible||e.opacity!==t.opacity)return!1;if(_(e.activeLayerId)||_(t.activeLayerId))return e.activeLayerId===t.activeLayerId;if(_(e.sublayers)||_(t.sublayers)){if(R(e.sublayers)||R(t.sublayers)||e.sublayers.length!==t.sublayers.length)return!1;for(let i=0;i<e.sublayers.length;i++){const r=e.sublayers.at(i),s=t.sublayers.at(i);if(r.id!==s.id||r.visible!==s.visible)return!1}}return!0}function YBe(e){return e?bh(e).replace(/^\s*https?:/i,"").toLowerCase():""}function ZBe(e){return new i2({getCollections:()=>[e.tables,e.layers],getChildrenFunction:t=>{const i=[];return"tables"in t&&i.push(t.tables),"layers"in t&&i.push(t.layers),i},itemFilterFunction:t=>{const i=t.parent;return i&&"tables"in i&&i.tables.includes(t)}})}const QBe=me.getLogger("esri.support.groundUtils"),Pte={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function JBe(e){let t=null;if(typeof e=="string")if(e in Pte){const i=Pte[e];t=new mM({resourceInfo:{data:{layers:[i]}}})}else QBe.warn(`Unable to find ground definition for: ${e}. Try "world-elevation"`);else t=Qr(mM,e);return t}function d7(e,t,i){let r,s;if(e)for(let n=0,o=e.length;n<o;n++){if(r=e.getItemAt(n),r[t]===i)return r;if((r==null?void 0:r.type)==="group"&&(s=d7(r.layers,t,i),s))return s}}const Ite=me.getLogger("esri.support.LayersMixin"),KBe=e=>{let t=class extends e{constructor(...i){super(...i),this.layers=new at;const r=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||Ite.error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.layers.on("before-add",o=>r(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))}destroy(){const i=this.layers.removeAll();for(const r of i)this.layerRemoved(r),r.destroy();this.layers.destroy()}set layers(i){this._set("layers",_g(i,this._get("layers")))}add(i,r){const s=this.layers;if(r=s.getNextIndex(r),i instanceof hM){const n=i;n.parent===this?this.reorder(n,r):s.add(n,r)}else vu(i)?i.then(n=>{this.destroyed||this.add(n,r)}):Ite.error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(i,r){const s=this.layers;r=s.getNextIndex(r),i.slice().forEach(n=>{n.parent!==this?(s.add(n,r),r+=1):this.reorder(n,r)})}findLayerById(i){return d7(this.layers,"id",i)}findLayerByUid(i){return d7(this.layers,"uid",i)}remove(i){return this.layers.remove(i)}removeMany(i){return this.layers.removeMany(i)}removeAll(){return this.layers.removeAll()}reorder(i,r){return this.layers.reorder(i,r)}layerAdded(i){}layerRemoved(i){}};return u([d()],t.prototype,"layers",null),t=u([P("esri.support.LayersMixin")],t),t},c0e="esri.support.TablesMixin",e9e=me.getLogger(c0e);function p7(e,t,i){if(e)for(let r=0,s=e.length;r<s;r++){const n=e.getItemAt(r);if(n[t]===i)return n;if((n==null?void 0:n.type)==="group"){const o=p7(n.tables,t,i);if(o)return o}}}const t9e=e=>{let t=class extends e{constructor(...i){super(...i),this.tables=new at,this.tables.on("after-add",r=>{const s=r.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&e9e.error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",r=>{r.item.parent=null})}destroy(){const i=this.tables.removeAll();for(const r of i)r.destroy();this.tables.destroy()}set tables(i){this._set("tables",_g(i,this._get("tables")))}findTableById(i){return p7(this.tables,"id",i)}findTableByUid(i){return p7(this.tables,"uid",i)}};return u([d()],t.prototype,"tables",null),t=u([P(c0e)],t),t};let $p=class extends t9e(KBe(us.EventedMixin(Ee))){constructor(e){super(e),this.allLayers=new i2({getCollections:()=>{var t,i,r;return[(t=this.basemap)==null?void 0:t.baseLayers,(i=this.ground)==null?void 0:i.layers,this.layers,(r=this.basemap)==null?void 0:r.referenceLayers]},getChildrenFunction:t=>"layers"in t?t.layers:null}),this.allTables=ZBe(this),this.basemap=null,this.editableLayers=new i2({getCollections:()=>[this.allLayers],itemFilterFunction:jBe}),this.ground=new mM,this._basemapCache=HBe()}destroy(){var e,t;this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),(e=this.ground)==null||e.destroy(),(t=this.basemap)==null||t.destroy(),qBe(this._basemapCache),this._basemapCache=null}castBasemap(e){return xX(e,this._basemapCache)}castGround(e){const t=JBe(e);return R(t)?this._get("ground"):t}findLayerById(e){return this.allLayers.find(t=>t.id===e)}findTableById(e){return this.allTables.find(t=>t.id===e)}};u([d({readOnly:!0,dependsOn:[]})],$p.prototype,"allLayers",void 0),u([d({readOnly:!0})],$p.prototype,"allTables",void 0),u([d({type:t2})],$p.prototype,"basemap",void 0),u([Ot("basemap")],$p.prototype,"castBasemap",null),u([d({readOnly:!0})],$p.prototype,"editableLayers",void 0),u([d({type:mM,nonNullable:!0})],$p.prototype,"ground",void 0),u([Ot("ground")],$p.prototype,"castGround",null),$p=u([P("esri.Map")],$p);const u0e=$p;let mR=class extends eR{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([YH({Type:Ca,ensureType:Qr(Ca)})],mR.prototype,"itemType",void 0),mR=u([P("esri.support.GraphicsCollection")],mR);let Ky=class extends Ee{constructor(e){super(e),this.view=null,this.baseLayerViews=new at,this.referenceLayerViews=new at,this._loadingHandle=ae(()=>{var t,i;return(i=(t=this.view)==null?void 0:t.map)==null?void 0:i.basemap},t=>{t&&t.load().catch(()=>{})},Ft)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null)}get suspended(){return!this.view||this.view.suspended}get updating(){var t,i;if(this.view&&this.view.suspended)return!1;const e=(i=(t=this.view)==null?void 0:t.map)==null?void 0:i.basemap;return!!e&&!!e.loaded&&(this.baseLayerViews.some(r=>r.updating)||this.referenceLayerViews.some(r=>r.updating))}};u([d({constructOnly:!0})],Ky.prototype,"view",void 0),u([d({readOnly:!0})],Ky.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],Ky.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],Ky.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],Ky.prototype,"updating",null),Ky=u([P("esri.views.BasemapView")],Ky);const i9e=me.getLogger("esri.views.LayerViewManager");class r9e{constructor(t,i,r){this.layer=t,this.view=i,this.layerViewImporter=r,this._controller=new AbortController,this._deferred=hv(),this._started=!1,this.done=!1,Wo(this._controller.signal,()=>{const s=new q("cancelled:layerview-create","layerview creation cancelled",{layer:t});this._deferred.reject(s)})}get promise(){return this._deferred.promise}destroy(){this._controller.abort();const{layerView:t}=this;if(!t)return;const{layer:i,view:r}=this;i.emit("layerview-destroy",{view:r,layerView:t}),r.emit("layerview-destroy",{layer:i,layerView:t}),this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null}async start(){var s,n;if(this._started)return;this._started=!0;const{_controller:{signal:t},layer:i,view:r}=this;this._map=r.map;try{let o,a;if(await i.load({signal:t}),"prefetchResources"in i&&await i.prefetchResources({signal:t}),i.createLayerView)o=await i.createLayerView(r,{signal:t});else{if(!this.layerViewImporter.hasLayerViewModule(i))throw new q("layer:view-not-supported","No layerview implementation was found");const h=await this.layerViewImporter.importLayerView(i);li(t),o="default"in h?new h.default({layer:i,view:r}):new h({layer:i,view:r})}const l=()=>{a=Ds(a),o.destroyed||o.destroy(),o.layer=null,o.parent=null,o.view=null,this.done=!0};a=Wo(t,l),li(t);try{await o.when()}catch(h){throw l(),h}if(!((n=(s=this._map)==null?void 0:s.allLayers)==null?void 0:n.includes(i)))return l(),void this._deferred.reject(new q("view:no-layerview-for-layer","The layer has been removed from the map",{layer:i}));this.layerView=o,i.emit("layerview-create",{view:r,layerView:o}),r.emit("layerview-create",{layer:i,layerView:o}),this.done=!0,this._deferred.resolve(o)}catch(o){i.emit("layerview-create-error",{view:r,error:o}),r.emit("layerview-create-error",{layer:i,error:o}),this.done=!0,this._deferred.reject(new q("layerview:create-error","layerview creation failed",{layer:i,error:o}))}}}let Gu=class extends kS{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._watchUpdatingTracking=new uf,this.supportsGround=!0,this._preloadLayerViewModules=()=>{var i;const t=(i=this.view.map)==null?void 0:i.allLayers;if(t)for(const r of t)this.layerViewImporter.hasLayerViewModule(r)&&this.layerViewImporter.importLayerView(r)},this._reschedule=()=>(R(this._workPromise)&&(this._workPromise=hv()),this.handles.remove("reschedule"),this.handles.add(F2(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{var n,o,a;const t=this.view.map;if(this._map!==t&&(this.clear(),this._map=t),R(this._workPromise))return void this.notifyChange("updating");this.handles.remove("reschedule"),this.handles.remove("collection-change");const i=new i2({getCollections:()=>this._rootCollectionNames.map(l=>this.get(l)),getChildrenFunction:l=>l&&"layers"in l?l.layers:null});if(!i)return this._workPromise.resolve(),void(this._workPromise=null);for(const l of i)this._createLayerView(l);this._refreshCollections();for(const[l,c]of this._layerLayerViewInfoMap)i.includes(l)||(this._layerLayerViewInfoMap.delete(c.layer),c.destroy());const r=i.filter(l=>l.type==="group").map(l=>l.layers),s=[(n=t==null?void 0:t.ground)==null?void 0:n.layers,(o=t==null?void 0:t.basemap)==null?void 0:o.baseLayers,(a=t==null?void 0:t.basemap)==null?void 0:a.referenceLayers,t==null?void 0:t.layers,...r].filter(l=>!!l);this.handles.add(s.map(l=>this._watchUpdatingTracking.addOnCollectionChange(()=>l,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.handles.add([eo(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.allLayers},"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),ae(()=>{const e=this.view,t=e==null?void 0:e.map;return[t==null?void 0:t.basemap,t==null?void 0:t.ground,t==null?void 0:t.layers,e==null?void 0:e.ready]},()=>this._reschedule(),Ms)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),this._watchUpdatingTracking.destroy(),this._map=null}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return _(this._workPromise)||this._watchUpdatingTracking.updating||Ws(this._layerLayerViewInfoMap,e=>!e.done)}get updatingRemaining(){let e=0;for(const t of this._layerLayerViewInfoMap.values())t.done||++e;return e}clear(){if(!this.destroyed){for(const e of this._layerLayerViewInfoMap.values())e.destroy();this._layerLayerViewInfoMap.clear(),this._refreshCollections()}}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e))throw new q("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e});return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,t]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(t),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,t,i){if(!e||!t)return void(t&&t.removeAll());let r=0;for(const s of e){const n=this._layerLayerViewInfoMap.get(s);if(!n||!n.layerView)continue;const o=n.layerView;o.layer=s,o.parent=i,t.getItemAt(r)!==o&&t.splice(r,0,o),s.layers&&this._populateLayerViewsOwners(s.layers,o.layerViews,o),r+=1}r<t.length&&t.splice(r,t.length)}_createLayerView(e){if(this._layerLayerViewInfoMap.has(e))return this.view.ready&&this._layerLayerViewInfoMap.get(e).start(),this.notifyChange("updating"),void this.notifyChange("updatingRemaining");e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const t=new r9e(e,this.view,this.layerViewImporter);t.promise.then(()=>this._refreshCollections(),i=>{var r,s;i&&(Gr(i)||i.name==="cancelled:layerview-create")||i9e.error(`Failed to create layerview for layer title:'${(r=e.title)!=null?r:"no title"}', id:'${(s=e.id)!=null?s:"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,t),this.view.ready&&t.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],Gu.prototype,"_workPromise",void 0),u([d({readOnly:!0})],Gu.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],Gu.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],Gu.prototype,"_rootCollectionNames",null),u([d()],Gu.prototype,"layerViewImporter",void 0),u([d()],Gu.prototype,"supportsGround",void 0),u([d({readOnly:!0})],Gu.prototype,"updating",null),u([d({readOnly:!0})],Gu.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],Gu.prototype,"view",void 0),Gu=u([P("esri.views.LayerViewManager")],Gu);const s9e=Gu;let Ac=class extends Ee{constructor(e){super(e),this.factor=1.5,this.offset=Xd(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],Ac.prototype,"factor",void 0),u([d({nonNullable:!0})],Ac.prototype,"offset",void 0),u([d()],Ac.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],Ac.prototype,"size",void 0),u([d()],Ac.prototype,"maskUrl",void 0),u([d()],Ac.prototype,"maskEnabled",void 0),u([d()],Ac.prototype,"overlayUrl",void 0),u([d()],Ac.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],Ac.prototype,"version",null),u([d({type:Boolean})],Ac.prototype,"visible",void 0),Ac=u([P("esri.views.Magnifier")],Ac);const h0e=Ac;let LD=class extends Ee{constructor(){super(...arguments),this._tasks=new Array,this.running=!1}get length(){return this._tasks.length}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.push(new $te(r,s,e,t,i)))}unshift(e,t,i){return this.running=!0,new Promise((r,s)=>this._tasks.unshift(new $te(r,s,e,t,i)))}_process(e){if(this._tasks.length===0)return!1;const t=this._tasks.shift();try{const i=Xs(t.signal);if(i&&!t.abortCallback)t.reject(ui());else{const r=i?t.abortCallback(ui()):t.callback(e);vu(r)?r.then(t.resolve,t.reject):t.resolve(r)}}catch(i){t.reject(i)}return this.running=this._tasks.length>0,!0}cancelAll(){const e=ui();for(const t of this._tasks)if(t.abortCallback){const i=t.abortCallback(e);t.resolve(i)}else t.reject(e);this._tasks.length=0,this.running=!1}};u([d()],LD.prototype,"running",void 0),LD=u([P("esri.layers.support.PromiseQueue")],LD);class $te{constructor(t,i,r,s,n){this.resolve=t,this.reject=i,this.callback=r,this.signal=s,this.abortCallback=n}}let vA=class extends Ee{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],vA.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],vA.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),vA=u([P("esri.views.support.DebugFlags")],vA);const n9e=new vA,o9e=me.getLogger("esri.views.support.Scheduler");function a9e(){return new BN.Scheduler}var mt;(function(e){e.RESOURCE_CONTROLLER="schedule",e.SLIDE="slide",e.STREAM_DATA_LOADER="stream loader",e.ELEVATION_QUERY="elevation query",e.TERRAIN_SURFACE="terrain",e.SURFACE_GEOMETRY_UPDATES="surface geometry updates",e.GRAPHICS_CORE="Graphics3D",e.I3S_CONTROLLER="I3S",e.POINT_CLOUD_LAYER="point cloud",e.FEATURE_TILE_FETCHER="feature fetcher",e.OVERLAY="overlay",e.STAGE="stage",e.GRAPHICS_DECONFLICTOR="graphics deconflictor",e.FILTER_VISIBILITY="Graphics3D filter visibility",e.SCALE_VISIBILITY="Graphics3D scale visibility",e.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",e.POINT_OF_INTEREST_FREQUENT="POI frequent",e.POINT_OF_INTEREST_INFREQUENT="POI infrequent",e.LABELER="labeler",e.FEATURE_QUERY_ENGINE="feature query",e.FEATURE_TILE_TREE="feature tile tree",e.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",e.ELEVATION_ALIGNMENT="elevation alignment",e.TEXT_TEXTURE_ATLAS="text texture atlas",e.TEXTURE_UNLOAD="texture unload",e.LINE_OF_SIGHT_TOOL="line of sight tool",e.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",e.ELEVATION_PROFILE="elevation profile",e.SNAPPING="snapping",e.SHADOW_ACCUMULATOR="shadow accumulator",e.CLOUDS_GENERATOR="cloud generator",e[e.TEST_PRIO=1]="TEST_PRIO"})(mt||(mt={}));const Yp=0,Dte=new Map([[mt.RESOURCE_CONTROLLER,Yp],[mt.SLIDE,Yp],[mt.STREAM_DATA_LOADER,Yp],[mt.ELEVATION_QUERY,Yp],[mt.TERRAIN_SURFACE,1],[mt.SURFACE_GEOMETRY_UPDATES,1],[mt.GRAPHICS_CORE,2],[mt.I3S_CONTROLLER,2],[mt.POINT_CLOUD_LAYER,2],[mt.FEATURE_TILE_FETCHER,2],[mt.OVERLAY,4],[mt.STAGE,4],[mt.GRAPHICS_DECONFLICTOR,4],[mt.FILTER_VISIBILITY,4],[mt.SCALE_VISIBILITY,4],[mt.FRUSTUM_VISIBILITY,4],[mt.POINT_OF_INTEREST_FREQUENT,6],[mt.POINT_OF_INTEREST_INFREQUENT,30],[mt.LABELER,8],[mt.FEATURE_QUERY_ENGINE,8],[mt.FEATURE_TILE_TREE,16],[mt.FEATURE_TILE_TREE_ACTIVE,Yp],[mt.ELEVATION_ALIGNMENT,12],[mt.TEXT_TEXTURE_ATLAS,12],[mt.CLOUDS_GENERATOR,12],[mt.TEXTURE_UNLOAD,12],[mt.LINE_OF_SIGHT_TOOL,16],[mt.LINE_OF_SIGHT_TOOL_INTERACTIVE,Yp],[mt.SNAPPING,Yp],[mt.SHADOW_ACCUMULATOR,30]]);function Lte(e){return Dte.has(e)?Dte.get(e):typeof e=="number"?e:1}var xn;(function(e){e[e.ANIMATING=0]="ANIMATING",e[e.INTERACTING=1]="INTERACTING",e[e.IDLE=2]="IDLE"})(xn||(xn={}));const Nte=6.5,Fte=1,l9e=30,Ute=1e3/30,kte=100,zte=.9;var BN,Kv;(function(e){let t=class extends Ee{constructor(){super(),this.updating=!0,this._microTaskQueued=!1,this.performanceInfo={total:new Q0("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new r,this._state=xn.INTERACTING,this._tasks=new Bt,this._runQueue=new Bt,this._load=0,this._idleStateCallbacks=new Bt,this._idleUpdatesStartFired=!1,this._maxReschedule=AP,this._forceTask=!1,this._debug=!1,this._debugHandle=ae(()=>n9e.SCHEDULER_LOG_SLOW_TASKS,o=>this._debug=o,Ft);for(const o of Object.keys(mt))this.performanceInfo.tasks.set(mt[o],new Q0(mt[o]));let s;const n=this;this._test={get state(){return yt(s,n._state)},set state(o){s=o},FRAME_SAFETY_BUDGET:Nte,INTERACTING_BUDGET:Ute,IDLE_BUDGET:kte,get availableBudget(){return n._budget.budget},usedBudget:0,getBudget:()=>n._budget,setBudget:o=>n._budget=o,updateTask:o=>this._updateTask(o),getState:o=>this._getState(o),getRuntime:o=>this._getRuntime(o),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(s=>s.remove()),this._tasks.clear(),Ds(this._debugHandle),this._microTaskQueued=!1,this.updating=!1}activate(){this._budget.done||this._microTaskQueued||(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.done||(this._maxReschedule=AP,this._schedule(),this.frame()))}))}registerTask(s,n){const o=Lte(s),a=new i(this,s,n,o);return this._tasks.push(a),this.performanceInfo.tasks.has(s)||this.performanceInfo.tasks.set(s,new Q0(s)),a}registerIdleStateCallbacks(s,n){const o={idleBegin:s,idleEnd:n};this._idleStateCallbacks.push(o),this.state===xn.IDLE&&this._idleUpdatesStartFired&&o.idleBegin();const a=this;return{remove:()=>this._removeIdleStateCallbacks(o),set idleBegin(l){a._idleUpdatesStartFired&&(o.idleEnd(),a._state===xn.IDLE&&l()),o.idleBegin=l},set idleEnd(l){o.idleEnd=l}}}get load(){return this._load}set state(s){this._state!==s&&(this._state=s,this.state!==xn.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(n=>n.idleEnd())))}get state(){return R(this._test.state)?this._state:this._test.state}updateBudget(s){this._test.usedBudget=0;let n=Nte,o=s.frameDuration,a=Fte;switch(this.state){case xn.IDLE:n=0,o=Math.max(kte,s.frameDuration),a=l9e;break;case xn.INTERACTING:o=Math.max(Ute,s.frameDuration);case xn.ANIMATING:}return o=o-s.elapsedFrameTime-n,this.state!==xn.IDLE&&o<Fte&&!this._forceTask?(this._forceTask=!0,!1):(o=Math.max(o,a),this._budget.reset(o,this.state),this._maxReschedule=AP,this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case xn.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(s=>s.idleBegin())),this._runIdle();break;case xn.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(s){this._idleUpdatesStartFired&&s.idleEnd(),this._idleStateCallbacks.removeUnordered(s)}removeTask(s){this._tasks.removeUnordered(s),this._runQueue.removeUnordered(s)}_updateTask(s){this._tasks.forAll(n=>{n.name===s&&n.setPriority(s)})}_getState(s){if(this._runQueue.some(o=>o.name===s))return Kv.SCHEDULED;let n=Kv.IDLE;return this._tasks.forAll(o=>{o.name===s&&o.needsUpdate&&(o.schedulePriority<=1?n=Kv.READY:n!==Kv.READY&&(n=Kv.WAITING))}),n}_getRuntime(s){let n=0;return this._tasks.forAll(o=>{o.name===s&&(n+=o.runtime)}),n}_resetRuntimes(){this._tasks.forAll(s=>s.runtime=0)}_getRunning(){const s=new Map;if(this._tasks.forAll(o=>{o.needsUpdate&&s.set(o.name,(s.get(o.name)||0)+1)}),s.size===0)return null;let n="";return s.forEach((o,a)=>{n+=o>1?` ${o}x ${a}`:` ${a}`}),n}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const s=this._tasks.reduce((n,o)=>o.needsUpdate?++n:n,0);this._load=this._load*zte+s*(1-zte)}_schedule(){if(this._maxReschedule<=0)return!1;for(this._runQueue.filterInPlace(s=>!!s.needsUpdate||(s.schedulePriority=s.basePriority,!1)),this._tasks.forAll(s=>{s.basePriority===Yp&&s.needsUpdate&&!this._runQueue.includes(s)&&this._runQueue.unshift(s)});this._runQueue.length===0;){let s=!1,n=0;if(this._tasks.forAll(o=>{o.needsUpdate&&o.schedulePriority!==0&&o.basePriority!==Yp&&(s=!0,n=Math.max(n,o.basePriority),o.schedulePriority===1?(o.schedulePriority=0,this._runQueue.push(o)):--o.schedulePriority)}),!s)return this.updating=!1,!1;this._maxReschedule===AP&&(this._maxReschedule=n),--this._maxReschedule}return this.updating=!0,!0}_run(){const s=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const n=this._budget.now(),o=this._runQueue.pop();this._budget.resetProgress();try{o.task.runTask(this._budget)}catch(l){o9e.error(`Exception in task "${o.name}"`,l)}o.schedulePriority=o.basePriority;const a=this._budget.now()-n;if(o.runtime+=a,this._frameTaskTimes.set(o.priority,this._frameTaskTimes.get(o.priority)+a),this._debug&&this._budget.elapsed>2*this._budget.budget&&console.log("Task",o.name,"used",this._budget.elapsed,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this.updating=this._tasks.some(l=>l.needsUpdate),void this._recordFrameTaskTimes(this._budget.now()-s)}while(this._schedule());this.updating=this._tasks.some(n=>n.needsUpdate),this._recordFrameTaskTimes(this._budget.now()-s)}_startFrameTaskTimes(){for(const s of Object.keys(mt))this._frameTaskTimes.set(mt[s],0)}_recordFrameTaskTimes(s){this._frameTaskTimes.forEach((n,o)=>this.performanceInfo.tasks.get(o).record(n)),this.performanceInfo.total.record(s)}get test(){return this._test}};u([d()],t.prototype,"updating",void 0),t=u([P("esri.views.support.Scheduler")],t),e.Scheduler=t;let i=class extends Ee{constructor(s,n,o,a){super({}),this._scheduler=s,this.name=n,this._basePriority=a,this.runtime=0,this._queue=new LD,this._handles=new qt,this.schedulePriority=this._basePriority,this.task=_(o)?o:this._queue,this._handles.add(cl(()=>this.task.running,()=>s.activate()))}get updating(){return this._queue.running}normalizeCtorArgs(){return{}}remove(){this.processQueue(rE),this._scheduler.removeTask(this),this.schedule=r2.schedule,this.reschedule=r2.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(s){this.name=s;const n=Lte(s);this._basePriority!==Yp&&this.schedulePriority===0||(this.schedulePriority=n),this._basePriority=n}get priority(){return this.name}set priority(s){this.setPriority(s)}get needsUpdate(){return this.updating||this.task.running}schedule(s,n,o){return this._queue.push(s,n,o)}reschedule(s,n,o){return this._queue.unshift(s,n,o)}processQueue(s){this._queue.runTask(s)}};u([d({constructOnly:!0})],i.prototype,"task",void 0),u([d({readOnly:!0})],i.prototype,"updating",null),i=u([P("esri.views.support.SchedulerTask")],i);class r{constructor(){this._begin=typeof performance!="undefined"?performance.now():0,this._budget=0,this._state=xn.IDLE,this._didWork=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&(this._didWork=!0),!0)}get done(){return this._didWork&&this.elapsed>=this._budget&&this._enabled}get budget(){return this._budget}madeProgress(){this._didWork=!0}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this._didWork=!1}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return performance.now()-this._begin}resetProgress(){this._didWork=!1}get hasProgressed(){return this._didWork}}e.Budget=r})(BN||(BN={})),function(e){e.SCHEDULED="s",e.READY="r",e.WAITING="w",e.IDLE="i"}(Kv||(Kv={}));const rE=(()=>{const e=new BN.Budget;return e.enabled=!1,e})();class c9e{remove(){}processQueue(){}schedule(t,i,r){try{if(Xs(i)){const s=ui();return r?Promise.resolve(r(s)):Promise.reject(s)}return n8(t(rE))}catch(s){return Promise.reject(s)}}reschedule(t,i,r){return this.schedule(t,i,r)}}const r2=new c9e,AP=Number.MAX_SAFE_INTEGER;let IT=class extends Ee{constructor(e,t){var i;super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=(i=t==null?void 0:t.registerTask(mt.TEXTURE_UNLOAD))!=null?i:r2}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask.remove(),this._textureRequests.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests.clear()}get updating(){return this._frameTask.updating}fromData(e,t,i){const r=this.makeUid(e);let s=this._textureRequests.get(r);return s||(s={referenceCount:0,texture:t(),textureAsync:null,abortController:null,onRemove:i},this._stage&&(this._stage.add(s.texture),this._stage.loadImmediate(s.texture)),this._textureRequests.set(r,s)),s.referenceCount++,{uid:r,texture:s.texture,release:()=>this._release(r)}}_release(e){const t=this._textureRequests.get(e);t?(t.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),t.referenceCount--,t.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const t=this._textureRequests.get(e);!t||t.referenceCount>0||(this._releaseTextureRequest(t),this._textureRequests.delete(e))}_releaseTextureRequest(e){var t;e.onRemove&&e.onRemove(),e.texture?(t=this._stage)==null||t.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,t=null){return _(t)?`${e}.${t}px`:e}};u([d()],IT.prototype,"_frameTask",void 0),u([d()],IT.prototype,"updating",null),IT=u([P("esri.views.3d.support.TextureCollection")],IT);var Vte;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right"})(Vte||(Vte={}));const d0e=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],p0e={};function f0e(e){return!!p0e[e]}function u9e(e){for(const t of e)if(!f0e(t))return!1;return!0}d0e.forEach(e=>{p0e[e]=!0});class h9e{constructor(t){this.handlers=new Map,this.counter=0,this.handlerCounts=new Map,this.view=t,this.inputManager=null}connect(t){t&&this.disconnect(),this.inputManager=t,this.handlers.forEach(({handler:i,priority:r},s)=>this.inputManager.installHandlers(s,[i],r))}disconnect(){this.inputManager&&this.handlers.forEach((t,i)=>this.inputManager.uninstallHandlers(i)),this.inputManager=null}destroy(){this.disconnect(),this.handlers.clear(),this.view=null}on(t,i,r,s){const n=Array.isArray(t)?t:t.split(",");if(!u9e(n))return n.some(f0e)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(i)?a=i:(o=i,a=[]),typeof r=="function"?o=r:s=r,s=s!=null?s:rv.DEFAULT;const l=this._createUniqueGroupName(),c=new d9e(this.view,n,a,o);this.handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this.handlerCounts.get(h)||0;this.handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(t){return!!this.handlerCounts.get(t)}_removeHandler(t,i){if(this.handlers.has(t)){this.handlers.delete(t);for(const r of i){const s=this.handlerCounts.get(r);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",r):s===1?this.handlerCounts.delete(r):this.handlerCounts.set(r,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(t)}_createUniqueGroupName(){return this.counter+=1,`viewEvents_${this.counter}`}}class d9e extends Ao{constructor(t,i,r,s){super(!0),this.view=t;for(const n of i)switch(n){case"click":this.registerIncoming("click",r,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",r,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",r,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",r,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",r,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",r,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",r,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",r,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",r,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",r,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",r,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",r,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",r,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",r,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",r,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",r,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",r,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",r,o=>{s(this._wrapBlur(o))})}}_wrapFocus(t){return{type:"focus",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapBlur(t){return{type:"blur",timestamp:t.timestamp,native:t.data.native,cancelable:t.cancelable,stopPropagation:()=>t.stopPropagation(),async:i=>t.async(i),preventDefault:()=>t.preventDefault()}}_wrapClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:Xd(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,{cancelable:c,timestamp:h}=t;return{type:"double-click",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>t.stopPropagation(),async:p=>t.async(p),preventDefault:()=>t.preventDefault()}}_wrapImmediateClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapImmediateDoubleClick(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a,eventId:l}=t.data,c=a.pointerId,{cancelable:h,timestamp:p}=t;return{type:"immediate-double-click",pointerId:c,pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:f=>t.async(f),preventDefault:()=>t.preventDefault()}}_wrapHold(t){const{pointerType:i,button:r,buttons:s,x:n,y:o,native:a}=t.data,{cancelable:l,timestamp:c}=t;return{type:"hold",pointerType:i,button:r,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>t.stopPropagation(),async:h=>t.async(h),preventDefault:()=>t.preventDefault()}}_getMapPoint(t,i){return this.view.toMap(Xd(t,i),{exclude:[]})}_wrapDrag(t){const i=t.data,{x:r,y:s}=i.center,{action:n,pointerType:o,button:a}=i;if(n==="start"&&(this.latestDragStart=i),!this.latestDragStart)return;const l=i.pointer.native,c=i.buttons,{cancelable:h,timestamp:p}=t,f={x:this.latestDragStart.center.x,y:this.latestDragStart.center.y};return n==="end"&&(this.latestDragStart=void 0),{type:"drag",action:n,x:r,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:i.radius,angle:ec(i.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>t.stopPropagation(),async:m=>t.async(m),preventDefault:()=>t.preventDefault()}}_wrapKeyDown(t){const{key:i,repeat:r,native:s}=t.data,{cancelable:n,timestamp:o}=t;return{type:"key-down",key:i,repeat:r,native:s,timestamp:o,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:a=>t.async(a),preventDefault:()=>t.preventDefault()}}_wrapKeyUp(t){const{key:i,native:r}=t.data,{cancelable:s,timestamp:n}=t;return{type:"key-up",key:i,native:r,timestamp:n,cancelable:s,stopPropagation:()=>t.stopPropagation(),async:o=>t.async(o),preventDefault:()=>t.preventDefault()}}_wrapPointer(t,i){const{x:r,y:s,button:n,buttons:o,native:a,eventId:l}=t.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=t;return{type:i,x:r,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>t.stopPropagation(),async:m=>t.async(m),preventDefault:()=>t.preventDefault()}}_wrapPointerDrag(t){const{x:i,y:r,buttons:s,native:n,eventId:o}=t.data.currentEvent,{button:a}=t.data.startEvent,l=t.data.startEvent.native.pointerId,c=t.data.startEvent.native.pointerType,h=t.data.action,p={x:t.data.startEvent.x,y:t.data.startEvent.y},{cancelable:f,timestamp:m}=t;return{type:"pointer-drag",x:i,y:r,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:m,eventId:o,cancelable:f,stopPropagation:()=>t.stopPropagation(),async:y=>t.async(y),preventDefault:()=>t.preventDefault()}}_wrapMouseWheel(t){const{cancelable:i,data:r,timestamp:s}=t,{x:n,y:o,deltaY:a,native:l}=r;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:i,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}_wrapGamepad(t){const{action:i,state:r,device:s}=t.data,{cancelable:n,timestamp:o}=t,{buttons:a,axes:l}=r;return{type:"gamepad",device:s,timestamp:o,action:i,buttons:a,axes:l,cancelable:n,stopPropagation:()=>t.stopPropagation(),async:c=>t.async(c),preventDefault:()=>t.preventDefault()}}}var gM,Bte,Gte;(function(e){e[e.USER=0]="USER",e[e.MANAGER=1]="MANAGER"})(gM||(gM={})),function(e){e[e.None=0]="None",e[e.Unfocused=1]="Unfocused",e[e.Focused=2]="Focused",e[e.Unselected=4]="Unselected",e[e.Selected=8]="Selected",e[e.All=15]="All"}(Bte||(Bte={})),function(e){e[e.None=0]="None",e[e.Custom1=16]="Custom1",e[e.Custom2=32]="Custom2",e[e.Custom3=64]="Custom3",e[e.Custom4=128]="Custom4",e[e.Custom5=256]="Custom5",e[e.Custom6=512]="Custom6",e[e.Custom7=1024]="Custom7",e[e.Custom8=2048]="Custom8",e[e.Custom9=4096]="Custom9",e[e.Custom10=8192]="Custom10",e[e.Custom11=16384]="Custom11",e[e.Custom12=32768]="Custom12",e[e.All=65520]="All"}(Gte||(Gte={}));const p9e=me.getLogger("esri.views.interactive.interactiveToolUtils");function f9e(e){return[e.on("before-add",t=>{const i=t.item;if(i==null||e.includes(i))return p9e.warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void t.preventDefault();i.onAdd()}),e.on("after-remove",t=>{const i=t.item;i.visible=!1,i.active&&(i.view.activeTool=null),i.destroy()})]}function GN(e){return e.visible&&e.getEditableFlag(gM.USER)&&e.getEditableFlag(gM.MANAGER)}function Dp(e){return Xd(e.x,e.y)}function k_t(e){return Vr(e.x,e.y)}function m0e(e,t){const i=(e instanceof HTMLElement?e:e.surface).getBoundingClientRect();return Xd(t.clientX-i.left,t.clientY-i.top)}function jte(e,t){return t instanceof Event?m0e(e,t):Dp(t)}function Hte(e){if(e instanceof Event)return!0;if(typeof e=="object"&&"type"in e)switch(e.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}class m9e{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._currentlyActiveTool=null,this._revertToActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}handleInputEvent(t,i){const r=()=>t.stopPropagation();switch(t.type){case"pointer-move":qte(t.pointerType)&&this._pointerLocations.set(t.pointerId,{x:t.x,y:t.y,pointerType:t.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(r(),t.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!Wte(t))break;const s=Dp(t),n=this._intersect(s,t.pointerType,i.forEachTool);if(R(n))break;const o=this._findToolAndManipulatorByKey(n,i.forEachTool,RP),a=qs(o,c=>c.manipulator),l=qs(o,c=>c.tool);!(_(a)&&_(l)&&a.interactive)||a.grabbable&&a.grabbableForEvent(t)||!a.grabbing||a.dragging||this._ungrabManipulatorBeforeDragging(a,l,t),_(a)&&a.interactive&&a.grabbable&&a.grabbableForEvent(t)&&!a.grabbing&&(this._grabbedManipulators.set(t.pointerId,{key:n,start:s,pointerType:t.pointerType}),this._grabbedManipulators.size===1&&i.activeTool!==n.tool&&(this._currentlyActiveTool=i.activeTool,this._revertToActiveTool=!0,i.setActiveTool(n.tool)),a.grabbing=!0,a.events.emit("grab-changed",{action:"start",pointerType:t.pointerType,screenPoint:s}),r());break}case"pointer-up":this._handlePointerEnd(t,i);break;case"pointer-drag":{if(!Wte(t))break;const s=this._grabbedManipulators.get(t.pointerId),n=this._draggedManipulators.get(t.pointerId),o=qs(s||n,({key:h})=>h),a=this._findManipulatorByKey(o,i.forEachTool);if(R(a))break;const l=Dp(t);l.x=$e(l.x,0,i.view.width),l.y=$e(l.y,0,i.view.height);const c=(s||n).start;switch(t.action){case"start":case"update":t.action!=="update"&&this._grabbedManipulators.size!==1||(a.dragging=!0,n?a.events.emit("drag",{action:"update",start:c,screenPoint:l}):a.events.emit("drag",{action:"start",start:c,screenPoint:l,pointerType:t.pointerType}),this._draggedManipulators.set(t.pointerId,{key:o,start:c}));break;case"end":a.dragging=!1,n&&a.events.emit("drag",{action:"end",start:c,screenPoint:l}),this._draggedManipulators.delete(t.pointerId),this._handlePointerEnd(t,i)}r();break}case"immediate-click":{const s=Dp(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findToolAndManipulatorByKey(n,i.forEachTool,RP);if(g9e(t)||i.forEachTool(h=>{if((!_(o)||o.tool!==h||h.automaticManipulatorSelection)&&h.manipulators){let p=!1;h.manipulators.forEach(({manipulator:f})=>{f.selected&&(f.selected=!1,p=!0)}),p&&h.manipulatorSelectionChanged&&h.manipulatorSelectionChanged()}}),R(o))break;const{manipulator:a,tool:l}=o;if(!a.interactive)break;a.selectable&&l.automaticManipulatorSelection&&(a.selected=!a.selected,l.manipulatorSelectionChanged&&l.manipulatorSelectionChanged());const c=t.native.shiftKey;a.events.emit("immediate-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:c,stopPropagation:r});break}case"click":{const s=Dp(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit(t.type,{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a}),r();break}case"double-click":{const s=Dp(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}case"immediate-double-click":{const s=Dp(t),n=this._intersect(s,t.pointerType,i.forEachTool),o=this._findManipulatorByKey(n,i.forEachTool);if(R(o)||!o.interactive)break;const a=t.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:t.button,pointerType:t.pointerType,shiftKey:a,stopPropagation:r});break}}this._onFocusChange(i.forEachTool)}_ungrabManipulatorBeforeDragging(t,i,r){t.grabbing=!1,t.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:Dp(r)}),this._grabbedManipulators.forEach(({key:s},n)=>{s.tool===i&&i.manipulators.findById(s.manipulatorId)===t&&this._grabbedManipulators.delete(n)})}_handlePointerEnd(t,i){const r=qs(this._grabbedManipulators.get(t.pointerId),({key:n})=>n),s=this._findManipulatorByKey(r,i.forEachTool);_(s)&&!s.dragging&&(this._grabbedManipulators.size===1&&this._draggedManipulators.size===0&&this._revertToActiveTool&&(i.setActiveTool(this._currentlyActiveTool),this._revertToActiveTool=!1,this._currentlyActiveTool=null),s.grabbing&&(s.grabbing=!1,s.events.emit("grab-changed",{action:"end",pointerType:t.pointerType,screenPoint:Dp(t)})),this._grabbedManipulators.delete(t.pointerId))}_cursorFromMap(t,i){let r=null;return Ws(t,({key:s})=>{const n=this._findManipulatorByKey(s,i);return!!(_(n)&&n.interactive&&"cursor"in n&&n.cursor)&&(r=n.cursor,!0)}),r}_onFocusChange(t){this._updateCursor(t),this._updateFocusedManipulatorTools(t)}_updateCursor(t){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators,t)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators,t)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(t){const i=new Set;this._grabbedManipulators.forEach(({key:{tool:r}})=>{i.add(r)}),this._hoveredManipulators.forEach(({key:{tool:r}})=>{i.add(r)}),t(r=>{r.hasFocusedManipulators=i.has(r)})}clearPointers(t,i,r=!0,s){const n=o=>o.tool===t&&(R(s)||o.manipulatorId===s);this._grabbedManipulators.forEach(({key:o,pointerType:a},l)=>{if(n(o)){this._grabbedManipulators.delete(l);const c=this._findManipulatorByKey(o,i);_(c)&&(c.grabbing=!1,c.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:a}))}}),this._draggedManipulators.forEach(({key:o},a)=>{if(n(o)){this._draggedManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}}),r&&this._hoveredManipulators.forEach(({key:o},a)=>{if(n(o)){this._hoveredManipulators.delete(a);const l=this._findManipulatorByKey(o,i);_(l)&&(l.hovering=!1)}}),this._onFocusChange(i)}_intersect(t,i,r){let s=null;return r(n=>{if(n.manipulators==null||!GN(n))return!1;const o=n.manipulators.intersect(t,i);return!R(o)&&(s={manipulatorId:o.id,tool:n},!0)}),s}updateHoveredStateFromKnownPointers(t){this._pointerLocations.forEach((i,r)=>{this._updateHoveredStateForPointerAtScreenPosition(Xd(i.x,i.y),r,i.pointerType,t)})}handleHoverEvent(t,i){t.type!=="pointer-up"&&t.type!=="immediate-click"&&t.type!=="pointer-move"||!qte(t.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(Dp(t),t.pointerId,t.pointerType,i)}_updateHoveredStateForPointerAtScreenPosition(t,i,r,s){const n=this._intersect(t,r,s);let o=this._findManipulatorByKey(n,s);const a=qs(this._hoveredManipulators.get(i),({key:c})=>c),l=this._findManipulatorByKey(a,s);_(o)&&!o.interactive&&(o=null),l!==o&&(_(l)&&(l.hovering=!1),_(o)?(o.hovering=!0,this._hoveredManipulators.set(i,{key:n})):this._hoveredManipulators.delete(i),this._onFocusChange(s))}_findManipulatorByKey(t,i){return this._findToolAndManipulatorByKey(t,i,RP)?RP.manipulator:null}_findToolAndManipulatorByKey(t,i,r){return R(t)?null:(r.tool=null,r.manipulator=null,i(s=>{if(s!==t.tool||s.manipulators==null||!GN(s))return!1;const n=s.manipulators.findById(t.manipulatorId);return!!_(n)&&(r.manipulator=n,r.tool=s,!0)}),r.manipulator?r:null)}}function qte(e){return e==="mouse"}function Wte(e){return e.pointerType!=="mouse"||e.button===0}function g9e(e){return!!e.native.shiftKey}const RP={manipulator:null,tool:null},y9e=me.getLogger("esri.views.ToolViewManager"),Xte="attached",b6="tools";let Sm=class extends kS{constructor(e){super(e),this._manipulatorState=new m9e,this.tools=new at,this.cursor=null,this._forEachTool=t=>{for(const i of this.tools.items)if(t(i))return}}initialize(){this.handles.add([this.view.on(d0e,e=>{this._handleInputEvent(e)},rv.TOOL),...f9e(this.tools),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._forEachTool)}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}set activeTool(e){if(_(e)&&!this.view.ready)return void y9e.error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const t=this.activeTool;this._set("activeTool",e),_(t)&&t.deactivate(),_(e)&&e.activate(),this._removeIncompleteTools(e);const i=R(this.activeTool);for(const r of this.tools){r.setEditableFlag(gM.MANAGER,i||r===this.activeTool);const s=GN(r);!i&&s||this._manipulatorState.clearPointers(r,this._forEachTool,!s)}this._updateCursor()}get updating(){var e,t;return this.updatingHandles.updating||this.tools.some(i=>i.updating)||((t=(e=this.textures)==null?void 0:e.updating)!=null?t:!1)}attach(){this.view.type==="3d"?(this._set("textures",new IT(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([ae(()=>{const{state:e}=this.view;return"camera"in e&&e.camera},()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}),this.view.elevationProvider.on("elevation-change",e=>{this._forEachManipulator(t=>{t.onElevationChange!=null&&t.onElevationChange(e)})}),Th(()=>this._set("textures",ot(this.textures)))],Xte)):this.handles.add(ae(()=>this.view.extent,()=>{this._forEachManipulator(e=>{e.onViewChange!=null&&e.onViewChange()})}))}detach(){_(this.activeTool)&&(this.activeTool=null),this.tools.removeAll(),this.handles.remove(Xte)}_forEachManipulator(e){this._forEachTool(t=>{t.manipulators&&t.manipulators.forEach(({manipulator:i})=>e(i,t))})}_handleInputEvent(e){let t=!1;const i=ve(F({},e),{stopPropagation:()=>{t=!0,e.stopPropagation()}});_(this.activeTool)?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(r=>{!t&&r.visible&&r.handleInputEvent(i)}),!t&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:r=>{this.activeTool=r},view:this.view}),!t&&_(this.activeTool)&&this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor()}_refreshToolWatchers(){this.handles.remove(b6),this._forEachTool(e=>{if(e instanceof Ee){const t=ae(()=>[e.cursor,e.visible,e.editable],()=>{GN(e)||this._manipulatorState.clearPointers(e,this._forEachTool),this._updateCursor()});this.handles.add(t,b6)}e.manipulators&&this.handles.add(e.manipulators.on("change",t=>{t.removed.forEach(({id:i})=>{this._manipulatorState.clearPointers(e,this._forEachTool,!0,i)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}),b6)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateCursor(){const e=this._manipulatorState.cursor;let t=e;this._forEachTool(i=>!(!_(i.cursor)||!i.visible||!R(e)&&i.preferManipulatorCursor)&&(t=i.cursor,!0)),this._get("cursor")!==t&&this._set("cursor",t)}_removeIncompleteTools(e){this.tools.filter(t=>(R(e)||t!==e)&&!t.created&&t.removeIncompleteOnCancel).forEach(t=>{this.tools.remove(t)})}};u([d({constructOnly:!0,nonNullable:!0})],Sm.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],Sm.prototype,"textures",void 0),u([d({value:null})],Sm.prototype,"activeTool",null),u([d({readOnly:!0,type:at})],Sm.prototype,"tools",void 0),u([d({readOnly:!0})],Sm.prototype,"cursor",void 0),u([d({readOnly:!0})],Sm.prototype,"updating",null),Sm=u([P("esri.views.ToolViewManager")],Sm);const v9e=Sm;let eT=class extends Ee{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":_9e.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){return(navigator.getGamepads?navigator.getGamepads():[])[this.nativeIndex]}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return b9e[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],eT.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],eT.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],eT.prototype,"axisThreshold",null),eT=u([P("esri.views.input.gamepad.GamepadInputDevice")],eT);const _9e=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),b9e={standard:.15,spacemouse:.025,unknown:0},TX=eT;let _A=class extends Ee{constructor(...e){super(...e),this.devices=new at,this.enabledFocusMode="document"}};u([d({type:at.ofType(TX),readOnly:!0})],_A.prototype,"devices",void 0),u([d({type:["document","view","none"]})],_A.prototype,"enabledFocusMode",void 0),_A=u([P("esri.views.input.gamepad.GamepadSettings")],_A);const w9e=_A;let ND=class extends Ee{constructor(){super(...arguments),this.gamepad=new w9e}};u([d({readOnly:!0})],ND.prototype,"gamepad",void 0),ND=u([P("esri.views.input.Input")],ND);const x9e=ND;let e0=class extends Ee{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],e0.prototype,"enabled",void 0),u([d({type:TX})],e0.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],e0.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],e0.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],e0.prototype,"velocityFactor",void 0),e0=u([P("esri.views.navigation.gamepad.GamepadSettings")],e0);const g0e=e0;let o1=class extends Ee{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new g0e,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],o1.prototype,"browserTouchPanEnabled",void 0),u([d({type:g0e,nonNullable:!0})],o1.prototype,"gamepad",void 0),u([d({type:Boolean})],o1.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],o1.prototype,"mouseWheelZoomEnabled",void 0),o1=u([P("esri.views.navigation.Navigation")],o1);const y0e=o1;function T9e(e,t){if(!e)return null;if(!f7(e))return new q("webscene:unsupported-height-model-info","The vertical coordinate system of the scene is not supported",{heightModelInfo:e});const i=e.heightUnit,r=Nv.deriveUnitFromSR(e,t).heightUnit;return i!==r?new q("webscene:incompatible-height-unit",`The vertical units of the scene (${i}) must match the horizontal units of the scene (${r})`,{verticalUnit:i,horizontalUnit:r}):null}function z_t(e,t,i){const r=v0e(e),s=t,n=S9e(r,s,i);if(r){const o=Nv.deriveUnitFromSR(r,e.spatialReference).heightUnit;if(!i&&o!==r.heightUnit){const a=new q("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r,error:a})}}if(!E9e(e)||n===Ll.Unsupported)return new q("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:r});switch(n){case Ll.Units:{const o=r.heightUnit||"unknown",a=s.heightUnit||"unknown",l=new q("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case Ll.HeightModel:{const o=r.heightModel||"unknown",a=s.heightModel||"unknown",l=new q("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}case Ll.CRS:{const o=r.vertCRS||"unknown",a=s.vertCRS||"unknown",l=new q("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new q("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:r,sceneHeightModelInfo:s,error:l})}}return null}function S9e(e,t,i){if(!f7(e)||!f7(t))return Ll.Unsupported;if(e==null||t==null)return Ll.Ok;if(!i&&e.heightUnit!==t.heightUnit)return Ll.Units;if(e.heightModel!==t.heightModel)return Ll.HeightModel;switch(e.heightModel){case"gravity-related-height":return Ll.Ok;case"ellipsoidal":return e.vertCRS===t.vertCRS?Ll.Ok:Ll.CRS;default:return Ll.Unsupported}}var Ll;function f7(e){return e==null||e.heightModel!=null&&e.heightUnit!=null}function E9e(e){return"heightModelInfo"in e&&e.heightModelInfo!=null||e.spatialReference!=null||!w0e(e)}function v0e(e){const t=e.url&&KS(e.url);return!((e.spatialReference&&e.spatialReference.vcsWkid)==null&&_(t)&&t.serverType==="ImageServer")&&_0e(e)&&e.heightModelInfo?e.heightModelInfo:w0e(e)?Nv.deriveUnitFromSR(A9e,e.spatialReference):null}function _0e(e){return"heightModelInfo"in e}function b0e(e){if(e.type==="unknown"||!("capabilities"in e))return!1;switch(e.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"wfs":return!0;default:return!1}}function w0e(e){return b0e(e)?!!(e.capabilities&&e.capabilities.data&&e.capabilities.data.supportsZ):x0e(e)}function C9e(e){return e.layers!=null||x0e(e)||b0e(e)||_0e(e)}function x0e(e){switch(e.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"line-of-sight":case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(e){e[e.Ok=0]="Ok",e[e.Units=1]="Units",e[e.HeightModel=2]="HeightModel",e[e.CRS=3]="CRS",e[e.Unsupported=4]="Unsupported"})(Ll||(Ll={}));const A9e=new Nv({heightModel:"gravity-related-height"});var Ve;function Yte(e){return e==="global"?Ve.Global:Ve.Local}function w6(e){return e===Ve.Global?"global":"local"}(function(e){e[e.Global=1]="Global",e[e.Local=2]="Local"})(Ve||(Ve={}));let m7,x6=null;async function R9e(e){x6||(x6=Promise.resolve().then(function(){return Rat}).then(t=>m7=t)),await x6,li(e)}async function T0e(e,t,i,r){if(!e)return null;const s=e.spatialReference;return Lq()||bg(s,t)?AO(e,t):m7?m7.projectGeometry(e,t,i,r):(await Promise.race([R9e(r),gN(r)]),T0e(e,t,i,r))}let Ar=class extends Ee{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=xh(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return _(this.userSpatialReference)?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return R(this.userSpatialReference)||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){var i,r,s,n;const e=(i=this.map)==null?void 0:i.call(this),t=[];return _(this.priorityCollection)&&t.push(this.priorityCollection),t.push({parent:e==null?void 0:e.basemap,layers:(r=e==null?void 0:e.basemap)==null?void 0:r.baseLayers},{layers:e==null?void 0:e.layers},{parent:e==null?void 0:e.ground,layers:(s=e==null?void 0:e.ground)==null?void 0:s.layers},{parent:e==null?void 0:e.basemap,layers:(n=e==null?void 0:e.basemap)==null?void 0:n.referenceLayers}),t}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){var s;if(this.suspended)return(s=this._get("_spatialReferenceTask"))!=null?s:{updating:!1};const{layers:e,updating:t}=this._allLayers;let i=null;for(const n of e){const o=this._getSupportedSpatialReferences(n);if(o.length>0){const a=this._narrowDownSpatialReferenceCandidates(i,o);_(a)&&(i=a)}if(_(i)&&i.length===1)break}if(t&&(R(i)||i.length!==1))return{updating:!0};const r=this._pickSpatialReferenceCandidate(i);return{spatialReference:_(r)?r.spatialReference:null,viewingMode:_(r)?r.viewingMode:null,updating:!1}}get _tileInfoTask(){var i,r,s,n,o,a,l,c;if(!this.required.tileInfo)return(i=this._get("_tileInfoTask"))!=null?i:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:t}=this._collectLayers([{parent:(s=(r=this.map)==null?void 0:r.call(this))==null?void 0:s.basemap,layers:(a=(o=(n=this.map)==null?void 0:n.call(this))==null?void 0:o.basemap)==null?void 0:a.baseLayers},{layers:(c=(l=this.map)==null?void 0:l.call(this))==null?void 0:c.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const h=e[0].tileInfo;return{tileInfo:h&&h.spatialReference.equals(this.spatialReference)?h:null,updating:!1}}return{updating:t}}get _heightModelInfoTask(){var i,r,s,n;if(!this.required.heightModelInfo||this.suspended&&((i=this._get("_heightModelInfoTask"))==null?void 0:i.heightModelInfo))return(r=this._get("_heightModelInfoTask"))!=null?r:{updating:!1};const{layers:e,updating:t}=this._allLayers;for(const o of e)if(C9e(o)){const a=v0e(o);if(a)return{heightModelInfo:a,vcsWkid:(s=o.spatialReference)==null?void 0:s.vcsWkid,latestVcsWkid:(n=o.spatialReference)==null?void 0:n.latestVcsWkid,updating:!1}}return{updating:t}}get _extentCandidatesTask(){var r,s;if(this.suspended||!this.required.extent)return(r=this._get("_extentCandidatesTask"))!=null?r:{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,t=e.updating,i=[];for(const n of e.layers){const o="fullExtents"in n&&n.fullExtents||(_(n.fullExtent)?[n.fullExtent]:[]),a=this.requiresExtentInSpatialReference?null:o[0],l=(s=o.find(c=>c.spatialReference.equals(this.spatialReference)))!=null?s:a;if(l)return{candidates:[{extent:l,layer:n}],updating:!1};if(this._getSupportedSpatialReferences(n).length>0)for(const c of o)i.push({extent:c,layer:n})}return{candidates:i,updating:t}}get _extentTask(){const{candidates:e,updating:t}=this._extentCandidatesTask;if(t)return{updating:t};if(R(e)||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),r=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&r.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:_(this._projectExtentTask.task)&&!this._projectExtentTask.task.finished}:(_(this._projectExtentTask.task)&&(this._projectExtentTask.task=xh(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:r.clone(),task:mO(async s=>{try{const n=await T0e(i.extent,r,i.layer.portalItem,s);this._projectExtentTask=ve(F({},this._projectExtentTask),{task:null,output:n})}catch{if(Xs(s))return;this._projectExtentTask=ve(F({},this._projectExtentTask),{task:null})}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,t){if(R(e))return t;const i=[],r=(s,n)=>_(s)?_(n)?s===n&&s:s:n;for(const s of e)for(const n of t){if(!s.spatialReference.equals(n.spatialReference))continue;const o=r(s.viewingMode,n.viewingMode);if(o!==!1){i.push({spatialReference:s.spatialReference,viewingMode:o});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const t=this.defaultSpatialReference;return R(e)||e.length<1?_(t)?{spatialReference:t,viewingMode:null}:null:(_(t)&&e.length>1&&e.some(({spatialReference:i})=>i.equals(t))&&(e=e.filter(({spatialReference:i})=>i.equals(t))),e.length>1&&e.some(({viewingMode:i})=>i!==Ve.Local)&&(e=e.filter(({viewingMode:i})=>i!==Ve.Local)),e[0])}_getSupportedSpatialReferences(e){const t="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(t.length===0)return[];const i=[];for(const r of t){const s=this.getSpatialReferenceSupport({spatialReference:r,layer:e});if(_(s)){const n=_(s.constraints)?s.constraints:[{spatialReference:r,viewingMode:null}];for(const{spatialReference:o,viewingMode:a}of n)(!this.requiresExtentInSpatialReference||R(this.userSpatialReference)||o.equals(this.userSpatialReference))&&i.push({spatialReference:o,viewingMode:a})}}return i}_pickExtentCandidate(e){const t=this.spatialReference;return e.find(({extent:i})=>t.equals(i.spatialReference))||e[0]}_collectLayers(e){var i;if(this._loadMaybe((i=this.map)==null?void 0:i.call(this))!=="loaded")return{layers:[],updating:!0};const t={layers:[],preloading:-1,updating:!1};for(const r of e)if(this._collectCollection(r,t),t.preloading===this.sourcePreloadCount)break;return{layers:t.layers,updating:t.updating}}_collectCollection(e,t){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return t.updating=!0,void++t.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":t.updating=!0,++t.preloading;break;case"loaded":t.updating||t.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},t)}if(t.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e?e.loadStatus==="not-loaded"?(e.load(),"loading"):e.loadStatus:"loaded"}};u([d()],Ar.prototype,"required",void 0),u([d({constructOnly:!0})],Ar.prototype,"map",void 0),u([d({constructOnly:!0})],Ar.prototype,"getSpatialReferenceSupport",void 0),u([d()],Ar.prototype,"defaultSpatialReference",void 0),u([d()],Ar.prototype,"userSpatialReference",void 0),u([d()],Ar.prototype,"sourcePreloadCount",void 0),u([d()],Ar.prototype,"priorityCollection",void 0),u([d()],Ar.prototype,"requiresExtentInSpatialReference",void 0),u([d()],Ar.prototype,"suspended",void 0),u([d({readOnly:!0})],Ar.prototype,"ready",null),u([d({readOnly:!0})],Ar.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],Ar.prototype,"spatialReference",null),u([d({readOnly:!0})],Ar.prototype,"extent",null),u([d({readOnly:!0})],Ar.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Ar.prototype,"vcsWkid",null),u([d({readOnly:!0})],Ar.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],Ar.prototype,"viewingMode",null),u([d({readOnly:!0})],Ar.prototype,"tileInfo",null),u([d({readOnly:!0})],Ar.prototype,"mapCollections",null),u([d({readOnly:!0})],Ar.prototype,"_allLayers",null),u([d({readOnly:!0})],Ar.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],Ar.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],Ar.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],Ar.prototype,"_extentCandidatesTask",null),u([d()],Ar.prototype,"_extentTask",null),u([d()],Ar.prototype,"_projectExtentTask",void 0),Ar=u([P("esri.views.support.DefaultsFromMap")],Ar);var FD;const MP=me.getLogger("esri.views.View");let Mt=FD=class extends mw(us.EventedMixin(SO(Ee))){constructor(e){super(e),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new i2({getCollections:()=>{var t,i,r;return[(t=this.basemapView)==null?void 0:t.baseLayerViews,(i=this.groundView)==null?void 0:i.layerViews,this.layerViews,(r=this.basemapView)==null?void 0:r.referenceLayerViews]},getChildrenFunction:t=>t.layerViews}),this.groundView=null,this.animation=null,this.basemapView=null,this.fatalError=null,this.extent=null,this.graphics=new mR,this.analyses=new WS,this.navigating=!1,this.typeSpecificPreconditionsReady=!0,this.layerViews=new at,this.magnifier=new h0e,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new x9e,this.navigation=new y0e,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new h9e(this),this.persistableViewModels=new at,this._isValid=!1,this._readyCycleForced=!1,this.handles.add(ae(()=>this.preconditionsReady,t=>{var i,r;t?(this._currentSpatialReference=this.spatialReference,FD.views.add(this)):(this._currentSpatialReference=null,FD.views.remove(this)),this.notifyChange("spatialReference"),!t&&this.ready?((i=this.layerViewManager)==null||i.clear(),(r=this.toolViewManager)==null||r.detach(),_(this.analysisViewManager)&&this.analysisViewManager.detach(),this._teardown()):t&&!this.ready&&(this._startup(),_(this.analysisViewManager)&&this.analysisViewManager.attach(),this.toolViewManager.attach())},rr))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,BR(()=>this.ready)))),this.basemapView=new Ky({view:this}),this.layerViewManager=new s9e({view:this,layerViewImporter:{importLayerView:e=>this.importLayerView(e),hasLayerViewModule:e=>this.hasLayerViewModule(e)},supportsGround:this.supportsGround}),this.toolViewManager=new v9e({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([ae(()=>this.initialExtentRequired,e=>this.defaultsFromMap.required=ve(F({},this.defaultsFromMap.required),{extent:e}),{sync:!0,initial:!0}),ae(()=>this.ready,e=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=e,this.defaultsFromMap.userSpatialReference=e?this.spatialReference:this._userSpatialReference)},{sync:!0}),ae(()=>this._userSpatialReference,e=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=e)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let e=null;this.handles.add([ae(()=>{var t;return(t=this.defaultsFromMap)==null?void 0:t.ready},t=>{var r;const i=((r=this.map)==null?void 0:r.allLayers.length)>0;if(t&&!this.spatialReference&&i){if(_(e))return;const s=Th(()=>e=xh(e));e=mO(async n=>{try{await CS(this.spatialReferenceWarningDelay,null,n)}catch{return}finally{e=null}MP.warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(s,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){if(this.destroyed)return;this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=ot(this.graphics),this.analyses=ot(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),ot(this.analysisViewManager),this.toolViewManager=ot(this.toolViewManager),this.layerViewManager=ot(this.layerViewManager),this.basemapView=ot(this.basemapView),this.invalidate(),this._emitter.clear(),this.handles.removeAll();const e=this.map;this.map=null,e==null||e.destroy()}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return MP.error("#toMap()","Not implemented on this instance of View"),null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new Ar(F({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:e=>this.getSpatialReferenceSupport(e)},this._defaultsFromMapSettings))}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get preconditionsReady(){var e;return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||Sf.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!((e=this.defaultsFromMap)==null?void 0:e.ready)||!this.typeSpecificPreconditionsReady)}set map(e){e!==this._get("map")&&((e==null?void 0:e.destroyed)&&(MP.warn("#map","The provided map is already destroyed",{map:e}),e=null),Sf.isLoadable(e)&&e.load().catch(()=>{}),this.initialized&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",e))}get spatialReference(){var t,i;let e=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return e&&((i=(t=this.defaultsFromMap)==null?void 0:t.required)==null?void 0:i.heightModelInfo)&&(e=e.clone(),e.vcsWkid=this.defaultsFromMap.vcsWkid,e.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),e}set spatialReference(e){const t=!ac(e,this._get("spatialReference"));this._set("_userSpatialReference",e),t&&(this._set("spatialReference",e),this._spatialReferenceChanged(e))}_spatialReferenceChanged(e){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get initialExtent(){var e;return(e=this.defaultsFromMap)==null?void 0:e.extent}get cursor(){const e=this.toolViewManager?this.toolViewManager.cursor:null;return _(e)?e:this._cursor||"default"}set cursor(e){this._cursor=e,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(e){return this.layerViewManager.whenLayerView(e)}getDefaultSpatialReference(){var e;return(e=this.defaultsFromMap)==null?void 0:e.spatialReference}getDefaultHeightModelInfo(){var e,t,i;return(i=(t=this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)!=null?t:(e=this.defaultsFromMap)==null?void 0:e.heightModelInfo)!=null?i:null}importLayerView(e){throw new q("importLayerView() not implemented")}hasLayerViewModule(e){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(e){return _(this.getSpatialReferenceSupport({spatialReference:e}))}when(e,t){return this.isResolved()&&!this.ready&&MP.warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(e,t)}forceReadyCycle(){this.ready&&(cl(()=>this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(e){this.toolViewManager.tools.add(e),this.activeTool=e}tryFatalErrorRecovery(){this.fatalError=null}};Mt.views=new at,u([d()],Mt.prototype,"_userSpatialReference",void 0),u([wt("toolViewManager.activeTool")],Mt.prototype,"activeTool",void 0),u([d({readOnly:!0})],Mt.prototype,"allLayerViews",void 0),u([d()],Mt.prototype,"groundView",void 0),u([d()],Mt.prototype,"animation",void 0),u([d()],Mt.prototype,"basemapView",void 0),u([d({readOnly:!0})],Mt.prototype,"_defaultsFromMapSettings",null),u([d()],Mt.prototype,"defaultsFromMap",null),u([d()],Mt.prototype,"fatalError",void 0),u([d({type:ci})],Mt.prototype,"extent",void 0),u([d(GB(mR,"graphics"))],Mt.prototype,"graphics",void 0),u([d(GB(WS,"analyses"))],Mt.prototype,"analyses",void 0),u([d({readOnly:!0,type:Nv})],Mt.prototype,"heightModelInfo",null),u([d({readOnly:!0})],Mt.prototype,"interacting",null),u([d({readOnly:!0})],Mt.prototype,"navigating",void 0),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],Mt.prototype,"preconditionsReady",null),u([d({readOnly:!0})],Mt.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:at,readOnly:!0})],Mt.prototype,"layerViews",void 0),u([d({type:h0e})],Mt.prototype,"magnifier",void 0),u([d({value:null,type:u0e})],Mt.prototype,"map",null),u([d()],Mt.prototype,"padding",void 0),u([d({readOnly:!0})],Mt.prototype,"ready",void 0),u([d({type:Xe})],Mt.prototype,"spatialReference",null),u([d()],Mt.prototype,"spatialReferenceWarningDelay",void 0),u([d()],Mt.prototype,"stationary",null),u([d({readOnly:!0})],Mt.prototype,"supportsGround",void 0),u([d({type:Uf})],Mt.prototype,"timeExtent",void 0),u([wt("toolViewManager.tools")],Mt.prototype,"tools",void 0),u([d()],Mt.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],Mt.prototype,"type",void 0),u([d({type:Number})],Mt.prototype,"scale",void 0),u([d({readOnly:!0})],Mt.prototype,"updating",void 0),u([d({readOnly:!0})],Mt.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],Mt.prototype,"initialExtent",null),u([d()],Mt.prototype,"cursor",null),u([d({readOnly:!0})],Mt.prototype,"input",void 0),u([d({type:y0e,nonNullable:!0})],Mt.prototype,"navigation",void 0),u([d()],Mt.prototype,"layerViewManager",void 0),u([d()],Mt.prototype,"analysisViewManager",void 0),u([d()],Mt.prototype,"width",void 0),u([d()],Mt.prototype,"height",void 0),u([d({readOnly:!0})],Mt.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],Mt.prototype,"size",null),u([d({readOnly:!0})],Mt.prototype,"suspended",void 0),u([d({readOnly:!0})],Mt.prototype,"viewEvents",void 0),u([d({readOnly:!0})],Mt.prototype,"persistableViewModels",void 0),u([d()],Mt.prototype,"_isValid",void 0),u([d()],Mt.prototype,"_readyCycleForced",void 0),u([d()],Mt.prototype,"_currentSpatialReference",void 0),Mt=FD=u([P("esri.views.View")],Mt);const M9e=Mt;let t0=class extends oN{constructor(e){super(e),this.state="running",this.target=null}initialize(){this.addResolvingPromise(new Promise((e,t)=>this._dfd={resolve:e,reject:t}))}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._dfd.reject(new q("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._dfd.resolve())}update(e,t){t||(t=vu(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",t)}};u([d({readOnly:!0})],t0.prototype,"done",null),u([d({readOnly:!0,type:String})],t0.prototype,"state",void 0),u([d()],t0.prototype,"target",void 0),t0=u([P("esri.views.ViewAnimation")],t0),function(e){e.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(t0||(t0={}));const s2=t0,NE=()=>import("./TileLayerView3D.9de3ce42.js"),Zte=()=>import("./ElevationLayerView3D.a6533e31.js"),Qte={"base-dynamic":()=>import("./BaseDynamicLayerView3D.733d79a4.js"),"base-elevation":Zte,"base-tile":NE,"bing-maps":NE,"building-scene":()=>import("./BuildingSceneLayerView3D.294e8df0.js"),csv:()=>import("./CSVLayerView3D.c43a77e5.js"),elevation:Zte,feature:()=>import("./FeatureLayerView3D.297e86f0.js"),geojson:()=>import("./GeoJSONLayerView3D.da6653ff.js"),graphics:()=>import("./GraphicsLayerView3D.ac447a3e.js"),group:()=>import("./GroupLayerView.a7f1479a.js"),imagery:()=>import("./ImageryLayerView3D.64524019.js"),"integrated-mesh":()=>import("./IntegratedMeshLayerView3D.54a2ccc3.js"),"line-of-sight":()=>import("./LineOfSightLayerView3D.f0e6c7f4.js"),"map-image":()=>import("./MapImageLayerView3D.673828c4.js"),media:()=>import("./MediaLayerView3D.ce6bd012.js"),"ogc-feature":()=>import("./OGCFeatureLayerView3D.24102d90.js"),"open-street-map":NE,"point-cloud":()=>import("./PointCloudLayerView3D.0ba3aad9.js").then(function(e){return e.P}),voxel:()=>import("./VoxelLayerView3D.380d3aab.js"),route:()=>import("./RouteLayerView3D.ec646271.js"),scene:e=>e.profile==null||e.profile==="mesh-pyramids"?import("./SceneLayerView3D.816f6fc1.js"):import("./SceneLayerGraphicsView3D.62db0323.js"),stream:()=>import("./StreamLayerView3D.6744901a.js"),tile:NE,"imagery-tile":()=>import("./ImageryTileLayerView3D.b369fa44.js"),"vector-tile":()=>import("./VectorTileLayerView3D.88d9c929.js"),wcs:()=>import("./ImageryTileLayerView3D.b369fa44.js"),"web-tile":NE,wfs:()=>import("./WFSLayerView3D.00d74029.js"),wms:()=>import("./WMSLayerView3D.afe35684.js"),wmts:()=>import("./WMTSLayerView3D.3027f54d.js"),"geo-rss":null,kml:null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null};function O9e(e){const t=e.declaredClass?e.declaredClass.slice(e.declaredClass.lastIndexOf(".")+1):"Unknown",i=t.replace(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new q(`${i}:view-not-supported`,`${t} is not supported in 3D`)}const Jte={hasLayerViewModule:e=>_(Qte[e.type]),importLayerView:e=>{const t=Qte[e.type];if(R(t))throw O9e(e);return t(e)}},P9e=me.getLogger("esri.views.3d.analysis.AnalysisViewManager3D"),Kte="analyses-owner-handles";var $T,N1;(function(e){e[e.PENDING=0]="PENDING",e[e.CREATED=1]="CREATED"})($T||($T={})),function(e){e[e.ADDED=0]="ADDED",e[e.REMOVED=1]="REMOVED"}(N1||(N1={}));let a1=class extends kS{constructor(e){super(e),this._allAnalysisViews=new at,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=Wd(),this._analysisModules={"area-measurement":{module:null},dimensioning:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(ui("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(ui()),this._attachedToViewResolver=Wd(),this._attachedToViewResolver.promise.catch(()=>{})}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const t=this._items.get(e);if(R(t)||t.state.list===N1.REMOVED)throw new q("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return t.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),Kte)}_disconnectOwners(){this.handles.remove(Kte),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const r of e)this._addAnalysis(r);const t=e.on("after-add",r=>this._addAnalysis(r.item)),i=e.on("after-remove",r=>this._removeAnalysis(r.item));return{remove:()=>{t.remove(),i.remove();for(const r of e)this._removeAnalysis(r)}}}_addAnalysis(e){const t=this._items.get(e);if(t==null){const i={state:{view:$T.PENDING,list:N1.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=mO(r=>this._createAnalysisViewPromise(i,r))}else t.state.list=N1.ADDED}_removeAnalysis(e){const t=this._items.get(e);t!=null?(t.state.list=N1.REMOVED,this._scheduleUpdate()):P9e.error("Trying to remove analysis which was not added")}_scheduleUpdate(){_(this._scheduledUpdateHandle)||(this._scheduledUpdateHandle=F2(()=>this._update()))}_update(){this._scheduledUpdateHandle=Ds(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===N1.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case $T.PENDING:e.createAnalysisViewTask=xh(e.createAnalysisViewTask);break;case $T.CREATED:_(e.view)&&(this._allAnalysisViews.remove(e.view),e.view=ot(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,t){const i=e.analysis,r=i.type,s=this._analysisModules[r];if(this._creatingViewCount+=1,R(s.module))try{s.module=await this._loadAnalysisModule(r)}catch(o){throw this._creatingViewCount-=1,o}if(Xs(t))throw this._creatingViewCount-=1,ui("AnalysisView creation aborted");const n=new s.module.default({analysis:i,view:this.view});try{await n.when()}catch(o){throw this._creatingViewCount-=1,o}if(Xs(t))throw this._creatingViewCount-=1,n.destroy(),ui("AnalysisView creation aborted");return e.view=n,e.state.view=$T.CREATED,this._allAnalysisViews.add(n),this._creatingViewCount-=1,n}_loadAnalysisModule(e){switch(e){case"area-measurement":return import("./AreaMeasurementAnalysisView3D.5f17586e.js").then(function(t){return t.A});case"dimensioning":return import("./DimensioningAnalysisView3D.44a3999f.js").then(function(t){return t.D});case"direct-line-measurement":return import("./DirectLineMeasurementAnalysisView3D.bbe152e0.js").then(function(t){return t.D});case"line-of-sight":return import("./LineOfSightAnalysisView3D.d177a5ad.js");case"slice":return import("./SliceAnalysisView3D.75cc871c.js").then(function(t){return t.S})}}};u([d()],a1.prototype,"updating",null),u([d({constructOnly:!0})],a1.prototype,"view",void 0),u([d()],a1.prototype,"_allAnalysisViews",void 0),u([d()],a1.prototype,"_creatingViewCount",void 0),a1=u([P("esri.views.3d.analysis.AnalysisViewManager3D")],a1);const I9e=a1,$9e=me.getLogger("esri.views.3d.state.Constraints");let Em=class extends Ee{constructor(e){super(e),this.collision=new bA,this.distance=1/0,this.minimumPoiDistance=4}get altitude(){return this.mode===Ve.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ve.Local?this._set("altitude",e):$9e.warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?$e(e,this.altitude.min,this.altitude.max):e}clampTilt(e,t){if(!this.tilt)return t;const i=this.tilt(e);return $e(t,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ve.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(t,i=T6)=>(i.min=_o.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?iD([[4e3,_o.max],[1e4,$t(88)],[6e6,$t(88)]]):()=>_o.max;return(t,i=T6)=>(i.min=_o.min,i.max=e(t),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?iD([[4e3,_o.max],[5e4,$t(88)],[6e6,$t(88)],[2e7,_o.min]]):iD([[3e5,_o.max],[3e6,$t(88)],[6e6,$t(88)],[2e7,_o.min]]);return(t,i=T6)=>(i.min=_o.min,i.max=e(t),i)}};function D9e(e){return{min:-2e5,max:4*e.radius}}u([d()],Em.prototype,"altitude",null),u([d({readOnly:!0})],Em.prototype,"collision",void 0),u([d()],Em.prototype,"distance",void 0),u([d({readOnly:!0})],Em.prototype,"minimumPoiDistance",void 0),u([d()],Em.prototype,"tilt",void 0),u([d({constructOnly:!0})],Em.prototype,"mode",void 0),Em=u([P("esri.views.3d.state.Constraints")],Em);const eie=D9e(Ei),_o={min:$t(.5),max:$t(179.5)},T6={min:0,max:0};let bA=class extends Ee{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],bA.prototype,"enabled",void 0),u([d({type:Number})],bA.prototype,"elevationMargin",void 0),bA=u([P("esri.views.3d.state.Constraints.CollisionConstraint")],bA);let DT=class extends Ee{constructor(){super(...arguments),this.min=eie.min,this.max=eie.max}};u([d({type:Number})],DT.prototype,"min",void 0),u([d({type:Number})],DT.prototype,"max",void 0),DT=u([P("esri.views.3d.constraints.AltitudeConstraint")],DT);let Um=class extends Ee{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,t){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==t&&this._set("far",t))}};u([d({type:Number,value:1e-8})],Um.prototype,"near",null),u([Ot("near")],Um.prototype,"castNear",null),u([d({type:Number,value:1e-8})],Um.prototype,"far",null),u([Ot("far")],Um.prototype,"castFar",null),u([d({type:["auto","manual"]})],Um.prototype,"mode",void 0),Um=u([P("esri.views.3d.constraints.ClipDistanceConstraint")],Um);const g7={min:ec(_o.min),max:ec(_o.max)};let F1=class extends Ee{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return $e(e,g7.min,g7.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],F1.prototype,"mode",void 0),u([d({type:Number,value:g7.max})],F1.prototype,"max",null),u([Ot("max")],F1.prototype,"castMax",null),F1=u([P("esri.views.3d.constraints.TiltConstraint")],F1);let U1=class extends Ee{constructor(){super(...arguments),this.tilt=new F1,this.altitude=new DT,this.clipDistance=new Um}};u([d({type:F1})],U1.prototype,"tilt",void 0),u([d({type:DT})],U1.prototype,"altitude",void 0),u([d({type:Um})],U1.prototype,"clipDistance",void 0),U1=u([P("esri.views.3d.constraints.Constraints")],U1);var y7;let ju=y7=class extends fe{constructor(e){super(e),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(e,t){return t.datetime!=null&&new Date(t.datetime)||null}writeDate(e,t,i){t[i]=e.getTime()}readDirectShadowsEnabled(e,t){return!!t.directShadows}writedirectShadowsEnabled(e,t,i){e&&(t[i]=e)}writeDisplayUTCOffset(e,t){e!=null&&(t.displayUTCOffset=e)}clone(){return new y7(this.cloneConstructProperties())}cloneConstructProperties(){const e={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(e.date=new Date(this.date.getTime())),e}};u([d({readOnly:!0,type:["sun"],json:{write:!0}})],ju.prototype,"type",void 0),u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],ju.prototype,"date",void 0),u([ke("date",["datetime"])],ju.prototype,"readDate",null),u([Be("date")],ju.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],ju.prototype,"directShadowsEnabled",void 0),u([ke("directShadowsEnabled",["directShadows"])],ju.prototype,"readDirectShadowsEnabled",null),u([Be("directShadowsEnabled")],ju.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],ju.prototype,"displayUTCOffset",void 0),u([Be("displayUTCOffset")],ju.prototype,"writeDisplayUTCOffset",null),ju=y7=u([P("esri.webscene.SunLighting")],ju);const kb=ju;var tT;let Lp=tT=class extends us.EventedMixin(kb){constructor(e){super(e),this.cameraTrackingEnabled=!0,this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const t=new Date().getFullYear(),i=new Date("March 15, "+t+" 12:00:00 UTC");this._set("defaultDate",i),this._set("date",i)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(e){return new tT(e.cloneConstructProperties())}set defaultDate(e){const t=this._get("date")===this._get("defaultDate");e=new Date(e.getTime()),this._set("defaultDate",e),t&&this._set("date",e)}set date(e){e!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(e.getTime())))}autoUpdate(e,t){const i=tT.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=t.hours,this.positionTimezoneInfo.minutes=t.minutes,this.positionTimezoneInfo.seconds=t.seconds;let r=null;e!=null&&(this.positionTimezoneInfo.autoUpdated=!0,r=this.date&&this.date.getTime(),this._set("date",new Date(e.getTime())));const s=tT.calculateTimezoneOffset(this.positionTimezoneInfo);if(i!==s&&(S6.target=this,S6.timezoneOffset=s,this.emit("timezone-will-change",S6)),e!=null)return r!==e.getTime()}clone(){const e=this._get("date")===this._get("defaultDate"),t=new tT(ve(F({},this.cloneConstructProperties()),{defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled,ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}));return e&&t._set("date",t._get("defaultDate")),t.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,t.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,t.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,t.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,t}cloneWithWebsceneLighting(e){const t=this.clone();return e.date!=null&&(t.date=e.date),t.directShadowsEnabled=e.directShadowsEnabled,t.displayUTCOffset=e.displayUTCOffset,t}};u([d({type:Boolean})],Lp.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],Lp.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],Lp.prototype,"waterReflectionEnabled",void 0),u([d({type:Date})],Lp.prototype,"defaultDate",null),u([d({type:Date})],Lp.prototype,"date",null),Lp=tT=u([P("esri.views.3d.environment.SunLighting")],Lp),function(e){function t({hours:i,minutes:r,seconds:s}){return Math.round(i+r/60+s/3600)}e.calculateTimezoneOffset=t}(Lp||(Lp={}));const S6={target:null,timezoneOffset:0},i0=Lp;var v7;let wA=v7=class extends fe{constructor(e){super(e),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new v7(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([d({readOnly:!0,type:["virtual"],json:{write:!0}})],wA.prototype,"type",void 0),u([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],wA.prototype,"directShadowsEnabled",void 0),wA=v7=u([P("esri.webscene.VirtualLighting")],wA);const zO=wA;var UD;let xA=UD=class extends us.EventedMixin(zO){constructor(e){super(e),this.ambientOcclusionEnabled=!1,this.waterReflectionEnabled=!1}clone(){return new UD(ve(F({},this.cloneConstructProperties()),{ambientOcclusionEnabled:this.ambientOcclusionEnabled,waterReflectionEnabled:this.waterReflectionEnabled}))}static fromWebsceneLighting(e){return new UD(e.cloneConstructProperties())}cloneWithWebsceneLighting(e){const t=this.clone();return t.directShadowsEnabled=e.directShadowsEnabled,t}};u([d({type:Boolean})],xA.prototype,"ambientOcclusionEnabled",void 0),u([d({type:Boolean})],xA.prototype,"waterReflectionEnabled",void 0),xA=UD=u([P("esri.views.3d.environment.VirtualLighting")],xA);const TA=xA,L9e={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:i0,virtual:TA}};var _7;let gR=_7=class extends Ee{set quality(e){["low","high"].includes(e)&&this._set("quality",e)}clone(){return new _7({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],gR.prototype,"quality",null),gR=_7=u([P("esri.views.3d.environment.SceneViewAtmosphere")],gR);var b7;let SA=b7=class extends fe{constructor(e){super(e),this.type="sunny",this.cloudCover=.5}clone(){return new b7({cloudCover:this.cloudCover})}};u([ct({sunny:"sunny"})],SA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],SA.prototype,"cloudCover",void 0),SA=b7=u([P("esri.views.3d.environment.SunnyWeather")],SA);const jN=SA;var w7;let EA=w7=class extends fe{constructor(e){super(e),this.type="cloudy",this.cloudCover=.5}clone(){return new w7({cloudCover:this.cloudCover})}};u([ct({cloudy:"cloudy"})],EA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],EA.prototype,"cloudCover",void 0),EA=w7=u([P("esri.views.3d.environment.CloudyWeather")],EA);const N9e=EA;var x7;let CA=x7=class extends fe{constructor(e){super(e),this.type="foggy",this.fogStrength=.5}clone(){return new x7({fogStrength:this.fogStrength})}};u([ct({foggy:"foggy"})],CA.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],CA.prototype,"fogStrength",void 0),CA=x7=u([P("esri.views.3d.environment.FoggyWeather")],CA);const F9e=CA;var T7;let iT=T7=class extends fe{constructor(e){super(e),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new T7({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([ct({rainy:"rainy"})],iT.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],iT.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],iT.prototype,"precipitation",void 0),iT=T7=u([P("esri.views.3d.environment.RainyWeather")],iT);const U9e=iT;var S7;let l1=S7=class extends fe{constructor(e){super(e),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new S7({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([ct({snowy:"snowy"})],l1.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],l1.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],l1.prototype,"precipitation",void 0),u([d({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],l1.prototype,"snowCover",void 0),l1=S7=u([P("esri.views.3d.environment.SnowyWeather")],l1);const k9e=l1,SX={key:"type",base:jN,typeMap:{sunny:jN,cloudy:N9e,rainy:U9e,snowy:k9e,foggy:F9e}},z9e=Object.keys(SX.typeMap);function V9e(e,t){return!!z9e.includes(e)||(t.error(`"${e}" is not a valid weather type`),!1)}const rh=1e4,S0e={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:kb,virtual:zO}};let kD=class extends fe{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],kD.prototype,"type",void 0),kD=u([P("esri.webscene.background.Background")],kD);const E0e=kD;var E7;const B9e=ve(F({},Ig),{nonNullable:!0});let AA=E7=class extends E0e{constructor(e){super(e),this.type="color",this.color=new qe([0,0,0,1])}clone(){return new E7(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([ct({color:"color"},{readOnly:!0})],AA.prototype,"type",void 0),u([d(B9e)],AA.prototype,"color",void 0),AA=E7=u([P("esri.webscene.background.ColorBackground")],AA);const C0e=AA,tie={base:E0e,key:"type",typeMap:{color:C0e}};function G9e(e){return(t,i,r)=>{if(!t)return t;for(const s in e.typeMap)if(t.type===s){const n=new e.typeMap[s];return n.read(t,r),n}}}const j9e={types:tie,json:{read:G9e(tie),write:{overridePolicy:(e,t,i)=>({enabled:!i||!i.isPresentation})}}};var C7;const H9e=me.getLogger("esri.webscene.Environment"),iie=(e,t,i)=>({enabled:!i||!i.isPresentation});let r0=C7=class extends fe{constructor(e){super(e),this.lighting=new kb,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(e){V9e(e==null?void 0:e.type,H9e)&&this._set("weather",e)}clone(){return new C7(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?zO.prototype.clone.call(this.lighting):kb.prototype.clone.call(this.lighting),background:te(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([d({types:S0e,nonNullable:!0,json:{write:!0}})],r0.prototype,"lighting",void 0),u([d(j9e)],r0.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:iie}}})],r0.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:iie}}})],r0.prototype,"starsEnabled",void 0),u([d({types:SX,nonNullable:!0,json:{write:!0},value:new jN})],r0.prototype,"weather",null),r0=C7=u([P("esri.webscene.Environment")],r0);const n2=r0;var RA;let rT=RA=class extends n2{constructor(e){super(e),this.atmosphere=new gR,this.lighting=new i0}static fromWebsceneEnvironment(e){const t=e.cloneConstructProperties();return new RA(ve(F({},t),{lighting:t.lighting.type==="virtual"?TA.fromWebsceneLighting(t.lighting):i0.fromWebsceneLighting(t.lighting)}))}castLighting(e){return this._convertLighting(e)}applyLighting(e){this.lighting=this._convertLighting(e)}_convertLighting(e){return e?e instanceof i0||e instanceof TA?e:e instanceof kb?this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(e):new i0(e.cloneConstructProperties()):e instanceof zO?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e):new TA(e.cloneConstructProperties()):qd(L9e,e):new i0}clone(){return new RA({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:te(this.background)})}cloneWithWebsceneEnvironment(e){return new RA(ve(F({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:te(this.background)},e.cloneConstructProperties()),{lighting:this._getLighting(e)}))}_getLighting(e){return e.lighting.type==="sun"?this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(e.lighting):i0.fromWebsceneLighting(e.lighting):e.lighting.type==="virtual"?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(e.lighting):TA.fromWebsceneLighting(e.lighting):i0.fromWebsceneLighting(e.lighting)}};u([d({type:gR,json:{read:!1},nonNullable:!0})],rT.prototype,"atmosphere",void 0),u([d({nonNullable:!0})],rT.prototype,"lighting",void 0),u([Ot("lighting")],rT.prototype,"castLighting",null),rT=RA=u([P("esri.views.3d.environment.SceneViewEnvironment")],rT);const sT=rT;function ro(e,t){return e[0]=t[0],e[1]=t[1],e}function hi(e,t,i){return e[0]=t,e[1]=i,e}function wd(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e}function rf(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e}function A0e(e,t,i){return e[0]=t[0]*i[0],e[1]=t[1]*i[1],e}function R0e(e,t,i){return e[0]=t[0]/i[0],e[1]=t[1]/i[1],e}function q9e(e,t){return e[0]=Math.ceil(t[0]),e[1]=Math.ceil(t[1]),e}function W9e(e,t){return e[0]=Math.floor(t[0]),e[1]=Math.floor(t[1]),e}function X9e(e,t,i){return e[0]=Math.min(t[0],i[0]),e[1]=Math.min(t[1],i[1]),e}function Y9e(e,t,i){return e[0]=Math.max(t[0],i[0]),e[1]=Math.max(t[1],i[1]),e}function Z9e(e,t){return e[0]=Math.round(t[0]),e[1]=Math.round(t[1]),e}function jl(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e}function Q9e(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e}function EX(e,t){const i=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(i*i+r*r)}function HN(e,t){const i=t[0]-e[0],r=t[1]-e[1];return i*i+r*r}function CX(e){const t=e[0],i=e[1];return Math.sqrt(t*t+i*i)}function M0e(e){const t=e[0],i=e[1];return t*t+i*i}function AX(e,t){return e[0]=-t[0],e[1]=-t[1],e}function J9e(e,t){return e[0]=1/t[0],e[1]=1/t[1],e}function yM(e,t){const i=t[0],r=t[1];let s=i*i+r*r;return s>0&&(s=1/Math.sqrt(s),e[0]=t[0]*s,e[1]=t[1]*s),e}function Bs(e,t){return e[0]*t[0]+e[1]*t[1]}function K9e(e,t,i){const r=t[0]*i[1]-t[1]*i[0];return e[0]=e[1]=0,e[2]=r,e}function nT(e,t,i,r){const s=t[0],n=t[1];return e[0]=s+r*(i[0]-s),e[1]=n+r*(i[1]-n),e}function eGe(e,t){t=t||1;const i=2*Od()*Math.PI;return e[0]=Math.cos(i)*t,e[1]=Math.sin(i)*t,e}function A7(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s,e[1]=i[1]*r+i[3]*s,e}function c1(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[2]*s+i[4],e[1]=i[1]*r+i[3]*s+i[5],e}function tGe(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[3]*s+i[6],e[1]=i[1]*r+i[4]*s+i[7],e}function iGe(e,t,i){const r=t[0],s=t[1];return e[0]=i[0]*r+i[4]*s+i[12],e[1]=i[1]*r+i[5]*s+i[13],e}function rGe(e,t,i,r){const s=t[0]-i[0],n=t[1]-i[1],o=Math.sin(r),a=Math.cos(r);return e[0]=s*a-n*o+i[0],e[1]=s*o+n*a+i[1],e}function sGe(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];let o=i*i+r*r;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(i*s+r*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function nGe(e){return"vec2("+e[0]+", "+e[1]+")"}function O0e(e,t){return e[0]===t[0]&&e[1]===t[1]}function oGe(e,t){const i=e[0],r=e[1],s=t[0],n=t[1];return Math.abs(i-s)<=Et*Math.max(1,Math.abs(i),Math.abs(s))&&Math.abs(r-n)<=Et*Math.max(1,Math.abs(r),Math.abs(n))}function aGe(e,t,i,r,s){let n=t[0]-i[0],o=t[1]-i[1];const a=(r[0]*n+r[1]*o)*(s-1);return n=r[0]*a,o=r[1]*a,e[0]=t[0]+n,e[1]=t[1]+o,e}const lGe=CX,cGe=rf,uGe=A0e,hGe=R0e,P0e=EX,dGe=HN,pGe=M0e;Object.freeze(Object.defineProperty({__proto__:null,copy:ro,set:hi,add:wd,subtract:rf,multiply:A0e,divide:R0e,ceil:q9e,floor:W9e,min:X9e,max:Y9e,round:Z9e,scale:jl,scaleAndAdd:Q9e,distance:EX,squaredDistance:HN,length:CX,squaredLength:M0e,negate:AX,inverse:J9e,normalize:yM,dot:Bs,cross:K9e,lerp:nT,random:eGe,transformMat2:A7,transformMat2d:c1,transformMat3:tGe,transformMat4:iGe,rotate:rGe,angle:sGe,str:nGe,exactEquals:O0e,equals:oGe,projectAndScale:aGe,len:lGe,sub:cGe,mul:uGe,div:hGe,dist:P0e,sqrDist:dGe,sqrLen:pGe},Symbol.toStringTag,{value:"Module"}));function I0e(e){return Math.min(1,Math.max(0,(e-1e5)/(1e6-1e5)))}const R7=1e4,$w=Fe(5802e-9,13558e-9,331e-7),E6=3,C6=Fe(65e-8*E6,1881e-9*E6,85e-9*E6),fGe=3996e-9,mGe=.085,zD=1e5;class Us{}function x(e,...t){let i="";for(let r=0;r<t.length;r++)i+=e[r]+t[r];return i+=e[e.length-1],i}(function(e){function t(r){return Math.round(r).toString()}function i(r){return r.toPrecision(8)}e.int=t,e.float=i})(x||(x={}));var A;(function(e){e.POSITION="position",e.NORMAL="normal",e.UV0="uv0",e.AUXPOS1="auxpos1",e.AUXPOS2="auxpos2",e.MAPPOS="mapPos",e.COLOR="color",e.SYMBOLCOLOR="symbolColor",e.SIZE="size",e.TANGENT="tangent",e.OFFSET="offset",e.SUBDIVISIONFACTOR="subdivisionFactor",e.COLORFEATUREATTRIBUTE="colorFeatureAttribute",e.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",e.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",e.DISTANCETOSTART="distanceToStart",e.UVMAPSPACE="uvMapSpace",e.BOUNDINGRECT="boundingRect",e.UVREGION="uvRegion",e.NORMALCOMPRESSED="normalCompressed",e.PROFILERIGHT="profileRight",e.PROFILEUP="profileUp",e.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",e.FEATUREVALUE="featureValue",e.MODELORIGINHI="modelOriginHi",e.MODELORIGINLO="modelOriginLo",e.MODEL="model",e.MODELNORMAL="modelNormal",e.INSTANCECOLOR="instanceColor",e.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",e.LOCALTRANSFORM="localTransform",e.GLOBALTRANSFORM="globalTransform",e.BOUNDINGSPHERE="boundingSphere",e.MODELORIGIN="modelOrigin",e.MODELSCALEFACTORS="modelScaleFactors",e.FEATUREATTRIBUTE="featureAttribute",e.STATE="state",e.LODLEVEL="lodLevel",e.POSITION0="position0",e.POSITION1="position1",e.NORMALA="normalA",e.NORMALB="normalB",e.COMPONENTINDEX="componentIndex",e.VARIANTOFFSET="variantOffset",e.VARIANTSTROKE="variantStroke",e.VARIANTEXTENSION="variantExtension",e.U8PADDING="u8padding",e.U16PADDING="u16padding",e.SIDENESS="sideness",e.START="start",e.END="end",e.UP="up",e.EXTRUDE="extrude"})(A||(A={}));var Zs;function og(e,t){switch(t.textureCoordinateType){case Zs.Default:return e.attributes.add(A.UV0,"vec2"),e.varyings.add("vuv0","vec2"),void e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case Zs.Atlas:return e.attributes.add(A.UV0,"vec2"),e.varyings.add("vuv0","vec2"),e.attributes.add(A.UVREGION,"vec4"),e.varyings.add("vuvRegion","vec4"),void e.vertex.code.add(x`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);case Zs.None:return void e.vertex.code.add(x`void forwardTextureCoordinates() {}`);default:t.textureCoordinateType;case Zs.COUNT:return}}(function(e){e[e.None=0]="None",e[e.Default=1]="Default",e[e.Atlas=2]="Atlas",e[e.COUNT=3]="COUNT"})(Zs||(Zs={}));function uc(e){e.code.add(x`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function gu(e){e.include(uc),e.code.add(x`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture2D(depthTex, uv)), nearFar);
}`)}function u5(e){e.fragment.code.add(x`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var $i;(function(e){e[e.Pass=0]="Pass",e[e.Draw=1]="Draw"})($i||($i={}));class jr{constructor(t,i,r,s,n=null){this.name=t,this.type=i,this.arraySize=n,this.bind={[$i.Pass]:null,[$i.Draw]:null},_(r)&&_(s)&&(this.bind[r]=s)}equals(t){return this.type===t.type&&this.name===t.name&&this.arraySize===t.arraySize}}class di extends jr{constructor(t,i){super(t,"vec2",$i.Pass,(r,s,n)=>r.setUniform2fv(t,i(s,n)))}}class ag extends jr{constructor(t){super(t,"vec2")}}class xt extends jr{constructor(t,i){super(t,"vec3",$i.Pass,(r,s,n)=>r.setUniform3fv(t,i(s,n)))}}class rl extends jr{constructor(t){super(t,"vec3")}}class xa extends jr{constructor(t){super(t,"vec4")}}class Pi extends jr{constructor(t){super(t,"float")}}class vr extends jr{constructor(t,i){super(t,"mat4",$i.Pass,(r,s,n)=>r.setUniformMatrix4fv(t,i(s,n)))}}const gGe=me.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");class $0e{constructor(){this.includedModules=new Map}include(t,i){if(this.includedModules.has(t)){const r=this.includedModules.get(t);if(r!==i){gGe.error("Trying to include shader module multiple times with different sets of options.");const s=new Set;for(const n of Object.keys(r))r[n]!==t[n]&&s.add(n);for(const n of Object.keys(t))r[n]!==t[n]&&s.add(n);s.forEach(n=>console.error(`  ${n}: current ${r[n]} new ${t[n]}`))}}else this.includedModules.set(t,i),t(this.builder,i)}}class Bi extends $0e{constructor(){super(...arguments),this.vertex=new rie,this.fragment=new rie,this.attributes=new _Ge,this.varyings=new bGe,this.extensions=new o2,this.constants=new ps}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(t){const i=this.extensions.generateSource(t),r=this.attributes.generateSource(t),s=this.varyings.generateSource(),n=t==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=t==="vertex"?xGe:wGe,c=this.constants.generateSource().concat(n.constants.generateSource());return`
${i.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${r.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}generateBind(t,i){const r=new Map;this.vertex.uniforms.entries.forEach(o=>{const a=o.bind[t];_(a)&&r.set(o.name,a)}),this.fragment.uniforms.entries.forEach(o=>{const a=o.bind[t];_(a)&&r.set(o.name,a)});const s=Array.from(r.values()),n=s.length;return(o,a)=>{for(let l=0;l<n;++l)s[l](i,o,a)}}}class yGe{constructor(){this._entries=new Map}add(t){if(!Array.isArray(t))return this._add(t);for(const i of t)this._add(i)}_add(t){if(this._entries.has(t.name)&&!this._entries.get(t.name).equals(t))throw new q(`Duplicate uniform name ${t.name} for different uniform type`);this._entries.set(t.name,t)}generateSource(){return Array.from(this._entries.values()).map(t=>_(t.arraySize)?`uniform ${t.type} ${t.name}[${t.arraySize}];`:`uniform ${t.type} ${t.name};`)}get entries(){return Array.from(this._entries.values())}}class vGe{constructor(){this._entries=new Array}add(t){this._entries.push(t)}generateSource(){return this._entries}}class rie extends $0e{constructor(){super(...arguments),this.uniforms=new yGe,this.code=new vGe,this.constants=new ps}get builder(){return this}}class _Ge{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(t){return t==="fragment"?[]:this._entries.map(i=>`attribute ${i[1]} ${i[0]};`)}}class bGe{constructor(){this._entries=new Array}add(t,i){this._entries.push([t,i])}generateSource(){return this._entries.map(t=>`varying ${t[1]} ${t[0]};`)}}class o2{constructor(){this._entries=new Set}add(t){this._entries.add(t)}generateSource(t){const i=t==="vertex"?o2.ALLOWLIST_VERTEX:o2.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(r=>i.includes(r)).map(r=>`#extension ${r} : enable`)}}o2.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],o2.ALLOWLIST_VERTEX=[];class ps{constructor(){this._entries=new Set}add(t,i,r){let s="ERROR_CONSTRUCTOR_STRING";switch(i){case"float":s=ps._numberToFloatStr(r);break;case"int":s=ps._numberToIntStr(r);break;case"bool":s=r.toString();break;case"vec2":s=`vec2(${ps._numberToFloatStr(r[0])},                            ${ps._numberToFloatStr(r[1])})`;break;case"vec3":s=`vec3(${ps._numberToFloatStr(r[0])},                            ${ps._numberToFloatStr(r[1])},                            ${ps._numberToFloatStr(r[2])})`;break;case"vec4":s=`vec4(${ps._numberToFloatStr(r[0])},                            ${ps._numberToFloatStr(r[1])},                            ${ps._numberToFloatStr(r[2])},                            ${ps._numberToFloatStr(r[3])})`;break;case"ivec2":s=`ivec2(${ps._numberToIntStr(r[0])},                             ${ps._numberToIntStr(r[1])})`;break;case"ivec3":s=`ivec3(${ps._numberToIntStr(r[0])},                             ${ps._numberToIntStr(r[1])},                             ${ps._numberToIntStr(r[2])})`;break;case"ivec4":s=`ivec4(${ps._numberToIntStr(r[0])},                             ${ps._numberToIntStr(r[1])},                             ${ps._numberToIntStr(r[2])},                             ${ps._numberToIntStr(r[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${i}(${Array.prototype.map.call(r,n=>ps._numberToFloatStr(n)).join(", ")})`}return this._entries.add(`const ${i} ${t} = ${s};`),this}static _numberToIntStr(t){return t.toFixed(0)}static _numberToFloatStr(t){return Number.isInteger(t)?t.toFixed(1):t.toString()}generateSource(){return Array.from(this._entries)}}const wGe=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif`,xGe=`precision highp float;
precision highp sampler2D;`;class $r extends jr{constructor(t){super(t,"sampler2D")}}function TGe(e){const t=new Bi;t.attributes.add(A.POSITION,"vec2"),t.include(og,{textureCoordinateType:Zs.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new vr("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new vr("inverseViewMatrix",(s,n)=>cs(SGe,n.camera.viewMatrix))]),i.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add([new xt("lightingMainDirection",(s,n)=>n.lighting.lightingMainDirection),new ag("radii"),new Pi("scaleHeight"),new rl("cameraPosition"),new xa("heightParameters"),new Pi("innerFadeDistance"),new Pi("altitudeFade"),new $r("depthTex"),new rl("betaRayleigh"),new rl("betaCombined"),new Pi("betaMie"),new Pi("hazeStrength")]),t.include(u5),e.haze&&(r.include(gu),r.uniforms.add(new di("nearFar",(s,n)=>n.camera.nearFar))),r.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(x`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),r.code.add(x`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),r.code.add(x`
    const int STEPS = 6;

    float getGlow(float dist, float radius, float intensity) {
      return pow(radius / max(dist, 1e-6), intensity);
    }

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${e.haze?x`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${e.haze?x``:" mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * "} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${e.haze?"":x`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.05968310365 * mumu;

      ${e.haze?x`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:x`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.11936620731 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie += getGlow(1.0 - mu, 5e-5, 3.0) * smoothstep(0.01, 0.1, length(scattering));
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
      vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
      if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
        return fragColor;
      }

      float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
      vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
      float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
      if (relDist > 1.0) {
        return surfaceColor;
      }

      return mix(gl_FragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${e.haze?x`
          vec4 depthSample = texture2D(depthTex, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;
            cameraSpaceRay *= -linearDepthFromTexture(depthTex, vuv0, nearFar);
            terrainDepth = max(0.0, length(cameraSpaceRay));
          }`:x`
          float depthSample = texture2D(depthTex, vuv0).r;
          if (depthSample != 1.0) {
            gl_FragColor = vec4(0);
            return;
          }`}

      ${e.haze?x`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);
            }
            float alpha = 1.0 - fadeOut;`:x`
            vec3 col = getAtmosphereColour(cameraPosition, rayDir, lightingMainDirection, terrainDepth);;
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}
      col = tonemapACES(col);
      gl_FragColor = delinearizeGamma(vec4(col, alpha));
      ${e.haze?"":x`
          if (depthSample == 1.0) {
            gl_FragColor = applyUndergroundAtmosphere(rayDir, lightingMainDirection, gl_FragColor);
          }`}
    }
  `),t}const SGe=Ae(),EGe=Object.freeze(Object.defineProperty({__proto__:null,build:TGe},Symbol.toStringTag,{value:"Module"}));class Qi{constructor(t,i){this._module=t,this._loadModule=i}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}}var Xi,Pt,Re,Sg,bt,Fd,a2,ht,hr,Jr,Ke,_t,pt,ze,ft,St,va,yi,Hc,Tn,Zr,xi;(function(e){e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(Xi||(Xi={})),function(e){e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Pt||(Pt={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Re||(Re={})),function(e){e[e.ADD=32774]="ADD",e[e.SUBTRACT=32778]="SUBTRACT",e[e.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(Sg||(Sg={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(bt||(bt={})),function(e){e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(Fd||(Fd={})),function(e){e[e.CW=2304]="CW",e[e.CCW=2305]="CCW"}(a2||(a2={})),function(e){e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT"}(ht||(ht={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(hr||(hr={})),function(e){e[e.ZERO=0]="ZERO",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP"}(Jr||(Jr={})),function(e){e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(Ke||(Ke={})),function(e){e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.REPEAT=10497]="REPEAT",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(_t||(_t={})),function(e){e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(pt||(pt={})),function(e){e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.RED=6403]="RED",e[e.RG=33319]="RG",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER"}(ze||(ze={})),function(e){e[e.RGBA4=32854]="RGBA4",e[e.R16F=33325]="R16F",e[e.RG16F=33327]="RG16F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.R32F=33326]="R32F",e[e.RG32F=33328]="RG32F",e[e.RGBA32F=34836]="RGBA32F",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB5_A1=32855]="RGB5_A1",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.RGB16F=34843]="RGB16F",e[e.RGB9_E5=35901]="RGB9_E5",e[e.SRGB8=35905]="SRGB8",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.RGB565=36194]="RGB565",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.RGB10_A2=32857]="RGB10_A2",e[e.RGB10_A2UI=36975]="RGB10_A2UI"}(ft||(ft={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.INT=5124]="INT",e[e.HALF_FLOAT=5131]="HALF_FLOAT",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(St||(St={})),function(e){e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(va||(va={})),function(e){e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_READ=35045]="STATIC_READ",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.STREAM_COPY=35042]="STREAM_COPY"}(yi||(yi={})),function(e){e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER"}(Hc||(Hc={})),function(e){e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(Tn||(Tn={})),function(e){e[e.TEXTURE=0]="TEXTURE",e[e.RENDER_BUFFER=1]="RENDER_BUFFER",e[e.CUBEMAP=2]="CUBEMAP"}(Zr||(Zr={})),function(e){e[e.NONE=0]="NONE",e[e.DEPTH_RENDER_BUFFER=1]="DEPTH_RENDER_BUFFER",e[e.STENCIL_RENDER_BUFFER=2]="STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_RENDER_BUFFER=3]="DEPTH_STENCIL_RENDER_BUFFER",e[e.DEPTH_STENCIL_TEXTURE=4]="DEPTH_STENCIL_TEXTURE"}(xi||(xi={}));const A6=33984;var dn,Lc;(function(e){e[e.Texture=0]="Texture",e[e.BufferObject=1]="BufferObject",e[e.VertexArrayObject=2]="VertexArrayObject",e[e.Shader=3]="Shader",e[e.Program=4]="Program",e[e.FramebufferObject=5]="FramebufferObject",e[e.Renderbuffer=6]="Renderbuffer",e[e.Sync=7]="Sync",e[e.COUNT=8]="COUNT"})(dn||(dn={})),function(e){e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(Lc||(Lc={}));const sie=33306;var Xr,nie,oie,aie,qN,M7,lie;(function(e){e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Xr||(Xr={})),function(e){e[e.FLOAT=5126]="FLOAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT=5124]="INT",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(nie||(nie={})),function(e){e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS"}(oie||(oie={})),function(e){e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED"}(aie||(aie={})),function(e){e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED"}(qN||(qN={})),function(e){e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(M7||(M7={})),function(e){e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}(lie||(lie={}));class lr{constructor(t,i,r){this.release=r,i&&(this.initializeConfiguration(t,i),this._configuration=i.snapshot()),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t.rctx.capabilities)}destroy(){this._program=Ye(this._program),this._pipeline=this._configuration=null}reload(t){Ye(this._program),this._program=this.initializeProgram(t),this._pipeline=this.initializePipeline(t.rctx.capabilities)}get program(){return this._program}get compiled(){return this.program.isCompiled}get key(){return this._configuration.key}get configuration(){return this._configuration}bindPass(t,i){this.program.bindPass(t,i)}bindDraw(t,i){this.program.bindDraw(t,i),this.program.rebindTextures()}bindPipelineState(t,i=null,r){t.setPipelineState(this.getPipelineState(i,r))}ensureAttributeLocations(t){this.program.assertCompatibleVertexAttributeLocations(t)}get primitiveType(){return Pt.TRIANGLES}getPipelineState(t,i){return this._pipeline}initializeConfiguration(t,i){}}const Di=new Map([[A.POSITION,0],[A.NORMAL,1],[A.UV0,2],[A.COLOR,3],[A.SIZE,4],[A.TANGENT,4],[A.AUXPOS1,5],[A.SYMBOLCOLOR,5],[A.AUXPOS2,6],[A.FEATUREATTRIBUTE,6],[A.INSTANCEFEATUREATTRIBUTE,6],[A.INSTANCECOLOR,7],[A.MODEL,8],[A.MODELNORMAL,12],[A.MODELORIGINHI,11],[A.MODELORIGINLO,15]]),CGe=me.getLogger("esri/views/webgl");function AGe(e,t){switch(t){case e.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case e.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case e.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case e.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case e.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case e.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const D0e=!!he("enable-feature:webgl-debug");function Ju(){return D0e}function vM(){return D0e}function j0(e){if(Ju()){const t=e.getError();if(t){const i=AGe(e,t),r=new Error().stack;CGe.error(new q("webgl-error","WebGL error occured",{message:i,stack:r}))}}}class Ji{constructor(t,i,r){this._context=t,this._locations=r,this._textures=new Map,this._freeTextureUnits=new Bt({deallocator:null}),this._glProgram=t.programCache.acquire(i.generate("vertex"),i.generate("fragment"),r),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=i.generateBind($i.Pass,this),this.bindDraw=i.generateBind($i.Draw,this),this._fragmentUniforms=Ju()?i.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get isCompiled(){return this._glProgram.isCompiled}setUniform1b(t,i){this._glProgram.setUniform1i(t,i?1:0)}setUniform1i(t,i){this._glProgram.setUniform1i(t,i)}setUniform1f(t,i){this._glProgram.setUniform1f(t,i)}setUniform2f(t,i,r){this._glProgram.setUniform2f(t,i,r)}setUniform2fv(t,i){this._glProgram.setUniform2fv(t,i)}setUniform3f(t,i,r,s){this._glProgram.setUniform3f(t,i,r,s)}setUniform3fv(t,i){this._glProgram.setUniform3fv(t,i)}setUniform4f(t,i,r,s,n){this._glProgram.setUniform4f(t,i,r,s,n)}setUniform4fv(t,i){this._glProgram.setUniform4fv(t,i)}setUniformMatrix3fv(t,i){this._glProgram.setUniformMatrix3fv(t,i)}setUniformMatrix4fv(t,i){this._glProgram.setUniformMatrix4fv(t,i)}setUniform1fv(t,i){this._glProgram.setUniform1fv(t,i)}setUniform1iv(t,i){this._glProgram.setUniform1iv(t,i)}setUniform2iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform3iv(t,i){this._glProgram.setUniform3iv(t,i)}setUniform4iv(t,i){this._glProgram.setUniform4iv(t,i)}assertCompatibleVertexAttributeLocations(t){t.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(t,i){if(R(i)||i.glName==null){const s=this._textures.get(t);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(t)),null}let r=this._textures.get(t);return r==null?(r=this._allocTextureUnit(i),this._textures.set(t,r)):r.texture=i,this._context.useProgram(this),this.setUniform1i(t,r.unit),this._context.bindTexture(i,r.unit),r.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((t,i)=>{this._context.bindTexture(t.texture,t.unit),this.setUniform1i(i,t.unit)}),_(this._fragmentUniforms)&&this._fragmentUniforms.forEach(t=>{t.type!=="sampler2D"&&t.type!=="samplerCube"||this._textures.has(t.name)||console.error(`Texture sampler ${t.name} has no bound texture`)})}_allocTextureUnit(t){return{texture:t,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(t){this._freeTextureUnits.push(t.unit)}}var or,zb,k1,gt,Rs,kl,al,l2,Eg,ll,sv,c2,sr,Vb;(function(e){e[e.None=0]="None",e[e.Front=1]="Front",e[e.Back=2]="Back",e[e.COUNT=3]="COUNT"})(or||(or={})),function(e){e[e.Less=0]="Less",e[e.Lequal=1]="Lequal",e[e.COUNT=2]="COUNT"}(zb||(zb={})),function(e){e[e.NONE=0]="NONE",e[e.SMAA=1]="SMAA"}(k1||(k1={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.FrontFace=2]="FrontFace",e[e.NONE=3]="NONE",e[e.COUNT=4]="COUNT"}(gt||(gt={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.UPDATE=1]="UPDATE"}(Rs||(Rs={})),function(e){e[e.NOT_LOADED=0]="NOT_LOADED",e[e.LOADING=1]="LOADING",e[e.LOADED=2]="LOADED"}(kl||(kl={})),function(e){e[e.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",e[e.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(al||(al={})),function(e){e[e.ASYNC=0]="ASYNC",e[e.SYNC=1]="SYNC"}(l2||(l2={})),function(e){e[e.Highlight=0]="Highlight",e[e.MaskOccludee=1]="MaskOccludee",e[e.COUNT=2]="COUNT"}(Eg||(Eg={})),function(e){e[e.Triangle=0]="Triangle",e[e.Point=1]="Point",e[e.Line=2]="Line"}(ll||(ll={})),function(e){e[e.STRETCH=1]="STRETCH",e[e.PAD=2]="PAD"}(sv||(sv={})),function(e){e[e.CHANGED=0]="CHANGED",e[e.UNCHANGED=1]="UNCHANGED"}(c2||(c2={})),function(e){e[e.Blend=0]="Blend",e[e.Opaque=1]="Opaque",e[e.Mask=2]="Mask",e[e.MaskBlend=3]="MaskBlend",e[e.COUNT=4]="COUNT"}(sr||(sr={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(Vb||(Vb={}));function zf(e,t,i=Sg.ADD,r=[0,0,0,0]){return{srcRgb:e,srcAlpha:e,dstRgb:t,dstAlpha:t,opRgb:i,opAlpha:i,color:{r:r[0],g:r[1],b:r[2],a:r[3]}}}function so(e,t,i,r,s=Sg.ADD,n=Sg.ADD,o=[0,0,0,0]){return{srcRgb:e,srcAlpha:t,dstRgb:i,dstAlpha:r,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const RX={face:Fd.BACK,mode:a2.CCW},L0e={face:Fd.FRONT,mode:a2.CCW},h5=e=>e===or.Back?RX:e===or.Front?L0e:null,pl={zNear:0,zFar:1},Jt={r:!0,g:!0,b:!0,a:!0};function RGe(e){return NGe.intern(e)}function MGe(e){return FGe.intern(e)}function OGe(e){return UGe.intern(e)}function PGe(e){return kGe.intern(e)}function IGe(e){return zGe.intern(e)}function $Ge(e){return VGe.intern(e)}function DGe(e){return BGe.intern(e)}function LGe(e){return GGe.intern(e)}function Ut(e){return jGe.intern(e)}class Ng{constructor(t,i){this.makeKey=t,this.makeRef=i,this.interns=new Map}intern(t){if(!t)return null;const i=this.makeKey(t),r=this.interns;return r.has(i)||r.set(i,this.makeRef(t)),r.get(i)}}function Fg(e){return"["+e.join(",")+"]"}const NGe=new Ng(N0e,e=>F({__tag:"Blending"},e));function N0e(e){return e?Fg([e.srcRgb,e.srcAlpha,e.dstRgb,e.dstAlpha,e.opRgb,e.opAlpha,e.color.r,e.color.g,e.color.b,e.color.a]):null}const FGe=new Ng(F0e,e=>F({__tag:"Culling"},e));function F0e(e){return e?Fg([e.face,e.mode]):null}const UGe=new Ng(U0e,e=>F({__tag:"PolygonOffset"},e));function U0e(e){return e?Fg([e.factor,e.units]):null}const kGe=new Ng(k0e,e=>F({__tag:"DepthTest"},e));function k0e(e){return e?Fg([e.func]):null}const zGe=new Ng(z0e,e=>F({__tag:"StencilTest"},e));function z0e(e){return e?Fg([e.function.func,e.function.ref,e.function.mask,e.operation.fail,e.operation.zFail,e.operation.zPass]):null}const VGe=new Ng(V0e,e=>F({__tag:"DepthWrite"},e));function V0e(e){return e?Fg([e.zNear,e.zFar]):null}const BGe=new Ng(B0e,e=>F({__tag:"ColorWrite"},e));function B0e(e){return e?Fg([e.r,e.g,e.b,e.a]):null}const GGe=new Ng(G0e,e=>F({__tag:"StencilWrite"},e));function G0e(e){return e?Fg([e.mask]):null}const jGe=new Ng(HGe,e=>({blending:RGe(e.blending),culling:MGe(e.culling),polygonOffset:OGe(e.polygonOffset),depthTest:PGe(e.depthTest),stencilTest:IGe(e.stencilTest),depthWrite:$Ge(e.depthWrite),colorWrite:DGe(e.colorWrite),stencilWrite:LGe(e.stencilWrite)}));function HGe(e){return e?Fg([N0e(e.blending),F0e(e.culling),U0e(e.polygonOffset),k0e(e.depthTest),z0e(e.stencilTest),V0e(e.depthWrite),B0e(e.colorWrite),G0e(e.stencilWrite)]):null}class qGe{constructor(t){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=t}setPipeline(t){(this._pipelineInvalid||t!==this._pipeline)&&(this._setBlending(t.blending),this._setCulling(t.culling),this._setPolygonOffset(t.polygonOffset),this._setDepthTest(t.depthTest),this._setStencilTest(t.stencilTest),this._setDepthWrite(t.depthWrite),this._setColorWrite(t.colorWrite),this._setStencilWrite(t.stencilWrite),this._pipeline=t),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(t){this._blending=this._setSubState(t,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(t){this._culling=this._setSubState(t,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(t){this._polygonOffset=this._setSubState(t,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(t){this._depthTest=this._setSubState(t,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(t){this._stencilTest=this._setSubState(t,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(t){this._depthWrite=this._setSubState(t,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(t){this._colorWrite=this._setSubState(t,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(t){this._stencilWrite=this._setSubState(t,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(t,i,r,s){return(r||t!==i)&&(s(t),this._pipelineInvalid=!0),t}}class _M extends lr{initializeProgram(t){const i=_M.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return this.configuration.haze?Ut({blending:so(Re.ONE,Re.ZERO,Re.ONE_MINUS_SRC_COLOR,Re.ONE),colorWrite:Jt}):Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}_M.shader=new Qi(EGe,()=>import("./ChapmanAtmosphere.glsl.c23f5027.js"));class Ra{constructor(){this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const t=this._parameterNames,i={key:this.key};for(const r of t)i[r]=this[r];return i}}function G(e={}){return(t,i)=>{var r,s;if(t._parameterNames=(r=t._parameterNames)!=null?r:[],t._parameterNames.push(i),e.constValue!=null)Object.defineProperty(t,i,{get:()=>e.constValue});else{const n=t._parameterNames.length-1,o=e.count||2,a=Math.ceil(Math.log2(o)),l=(s=t._parameterBits)!=null?s:[0];let c=0;for(;l[c]+a>16;)c++,c>=l.length&&l.push(0);t._parameterBits=l;const h=l[c],p=(1<<a)-1<<h;l[c]+=a,Object.defineProperty(t,i,{get(){return this[n]},set(f){if(this[n]!==f&&(this[n]=f,this._keyDirty=!0,this._parameterBits[c]=this._parameterBits[c]&~p|+f<<h&p,typeof f!="number"&&typeof f!="boolean"))throw"Configuration value for "+i+" must be boolean or number, got "+typeof f}})}}}class j0e extends Ra{constructor(){super(...arguments),this.haze=!1}}u([G()],j0e.prototype,"haze",void 0);class to{constructor(t,i,r,s,n,o=!1,a=0){this.name=t,this.count=i,this.type=r,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}}new to(A.POSITION,3,ht.FLOAT,0,12);new to(A.POSITION,3,ht.FLOAT,0,20),new to(A.UV0,2,ht.FLOAT,12,20);new to(A.POSITION,3,ht.FLOAT,0,32),new to(A.NORMAL,3,ht.FLOAT,12,32),new to(A.UV0,2,ht.FLOAT,24,32);new to(A.POSITION,3,ht.FLOAT,0,16),new to(A.COLOR,4,ht.UNSIGNED_BYTE,12,16);const MX=[new to(A.POSITION,2,ht.FLOAT,0,8)],VO=[new to(A.POSITION,2,ht.FLOAT,0,16),new to(A.UV0,2,ht.FLOAT,8,16)];var ai;function WGe(e,t,i={}){const r=H0e(e);for(;r.length>1;){const s=WN(t,r.shift(),i);if(_(s))return s}return XGe(t,r.shift(),i)}function H0e(e){const t=he("esri-force-webgl");if(t===ai.WEBGL1||t===ai.WEBGL2)return[t];switch(e){case"2d":return he("mac")&&he("chrome")?[ai.WEBGL1,ai.WEBGL2]:[ai.WEBGL2,ai.WEBGL1];case"3d":return[ai.WEBGL2,ai.WEBGL1]}}function XGe(e,t,i={}){if(!window.WebGLRenderingContext)return cie(e,YGe),null;const r=WN(e,t,i);return R(r)&&cie(e,ZGe),r}function WN(e,t,i={}){const r=t===ai.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];let s=null;for(const n of r){try{s=e.getContext(n,i)}catch{}if(s)break}return s}function cie(e,t){const i=e.parentNode;i&&(i.innerHTML='<table style="background-color: #8CE; width: 100%; height: 100%;"><tr><td align="center"><div style="display: table-cell; vertical-align: middle;"><div style="">'+t+"</div></div></td></tr></table>")}(function(e){e[e.WEBGL1=1]="WEBGL1",e[e.WEBGL2=2]="WEBGL2"})(ai||(ai={}));const YGe='This page requires a browser that supports WebGL.<br/><a href="http://get.webgl.org">Click here to upgrade your browser.</a>',ZGe=`It doesn't appear your computer can support WebGL.<br/><a href="http://get.webgl.org/troubleshooting/">Click here for more information.</a>`,pc=me.getLogger("esri.views.webgl.BufferObject");function QGe(e){return o2e(e)}class ti{constructor(t,i,r,s){this._context=t,this.bufferType=i,this.usage=r,this._glName=null,this._size=-1,this._indexType=void 0,t.instanceCounter.increment(dn.BufferObject,this),this._glName=this._context.gl.createBuffer(),j0(this._context.gl),s&&this.setData(s)}static createIndex(t,i,r){return new ti(t,bt.ELEMENT_ARRAY_BUFFER,i,r)}static createVertex(t,i,r){return new ti(t,bt.ARRAY_BUFFER,i,r)}static createUniform(t,i,r){if(t.type!==ai.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new ti(t,bt.UNIFORM_BUFFER,i,r)}static createPixelPack(t,i=yi.STREAM_READ,r){if(t.type!==ai.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new ti(t,bt.PIXEL_PACK_BUFFER,i);return r&&s.setSize(r),s}static createPixelUnpack(t,i=yi.STREAM_DRAW,r){if(t.type!==ai.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new ti(t,bt.PIXEL_UNPACK_BUFFER,i,r)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteSize(){return this.bufferType===bt.ELEMENT_ARRAY_BUFFER?this._indexType===ht.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===bt.ELEMENT_ARRAY_BUFFER||this.bufferType===bt.ARRAY_BUFFER}dispose(){var t;((t=this._context)==null?void 0:t.gl)?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(dn.BufferObject,this),this._context=null):this._glName&&pc.warn("Leaked WebGL buffer object")}setSize(t,i=null){if(t<=0&&pc.error("Buffer size needs to be positive!"),this.bufferType===bt.ELEMENT_ARRAY_BUFFER&&_(i))switch(this._indexType=i,i){case ht.UNSIGNED_SHORT:t*=2;break;case ht.UNSIGNED_INT:t*=4}this._setBufferData(t)}setData(t){if(!t)return;let i=t.byteLength;this.bufferType===bt.ELEMENT_ARRAY_BUFFER&&(FL(t)&&(i/=2,this._indexType=ht.UNSIGNED_SHORT),UL(t)&&(i/=4,this._indexType=ht.UNSIGNED_INT)),this._setBufferData(i,t)}_setBufferData(t,i=null){this._size=t;const r=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;_(i)?s.bufferData(this.bufferType,i,this.usage):s.bufferData(this.bufferType,t,this.usage),j0(s),this._isVAOAware&&this._context.bindVAO(r)}setSubData(t,i=0,r=0,s=t.byteLength){if(!t)return;(i<0||i>=this._size)&&pc.error("offset is out of range!");let n=i,o=r,a=s,l=t.byteLength;this.bufferType===bt.ELEMENT_ARRAY_BUFFER&&(FL(t)?(l/=2,n*=2,o*=2,a*=2):UL(t)&&(l/=4,n*=4,o*=4,a*=4)),s===void 0&&(s=l-1),r>=s&&pc.error("end must be bigger than start!"),i+r-s>this._size&&pc.error("An attempt to write beyond the end of the buffer!");const c=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const h=this._context.gl,p=ArrayBuffer.isView(t)?t.buffer:t,f=o===0&&a===t.byteLength?p:p.slice(o,a);h.bufferSubData(this.bufferType,n,f),j0(h),this._isVAOAware&&this._context.bindVAO(c)}setSubDataFromView(t,i,r,s){if(!t)return;(i<0||i>=this._size)&&pc.error("offset is out of range!"),r>=s&&pc.error("end must be bigger than start!"),i+r-s>this._size&&pc.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===ai.WEBGL2)o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,t,r,s-r);else{const a=r===0&&s===t.length?t:t.subarray(r,s);o.bufferSubData(this.bufferType,i*t.BYTES_PER_ELEMENT,a)}j0(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(t,i=0,r,s){if(this._context.type!==ai.WEBGL2)return void pc.error("Get buffer subdata is supported in WebGL2 only!");if(r<0||s<0)return void pc.error("Problem getting subdata: offset and length were less than zero!");const n=QGe(t)?t.BYTES_PER_ELEMENT:1;if(n*((r!=null?r:0)+(s!=null?s:0))>t.byteLength)return void pc.error("Problem getting subdata: offset and length exceeded destination size!");i+n*(s!=null?s:0)>this.byteSize&&pc.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,bt.COPY_READ_BUFFER),o.getBufferSubData(bt.COPY_READ_BUFFER,i,t,r,s),this._context.unbindBuffer(bt.COPY_READ_BUFFER)}async getSubDataAsync(t,i=0,r,s){this._context.type===ai.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(t,i,r,s)):pc.error("Get buffer subdata is supported in WebGL2 only!")}}function Cn(e){return window.WebGL2RenderingContext&&e instanceof window.WebGL2RenderingContext}const uie=4;class st{constructor(t,i,r=null){if(this._context=t,this.type="texture",this._glName=null,this._descriptor=void 0,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,t.instanceCounter.increment(dn.Texture,this),this._descriptor=F({target:pt.TEXTURE_2D,samplingMode:Ke.LINEAR,wrapMode:_t.REPEAT,flipped:!1,hasMipmap:!1,isOpaque:!1,unpackAlignment:4,preMultiplyAlpha:!1,isImmutable:!1},i),t.type!==ai.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),e_(this._descriptor.target)))throw new Error("3D and array textures are not supported in WebGL1");this._descriptor.target===pt.TEXTURE_CUBE_MAP?this._setDataCubeMap(r):this.setData(r)}get glName(){return this._glName}get descriptor(){return this._descriptor}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._context.gl&&this._glName&&(this._context.unbindTexture(this),this._context.gl.deleteTexture(this._glName),this._glName=null,this._context.instanceCounter.decrement(dn.Texture,this))}release(){this.dispose()}resize(t,i){const r=this._descriptor;if(r.width!==t||r.height!==i){if(this._wasImmutablyAllocated)throw new Error("Immutable textures can't be resized!");r.width=t,r.height=i,this._descriptor.target===pt.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(t=null){for(let i=pt.TEXTURE_CUBE_MAP_POSITIVE_X;i<=pt.TEXTURE_CUBE_MAP_NEGATIVE_Z;i++)this._setData(t,i)}setData(t){this._setData(t)}_setData(t,i){var c;if(!this._context||!this._context.gl)return;const r=this._context.gl;this._glName||(this._glName=r.createTexture()),t===void 0&&(t=null);const s=this._descriptor;i!=null||(i=s.target);const n=e_(i);t===null&&(s.width=s.width||uie,s.height=s.height||uie,n&&(s.depth=(c=s.depth)!=null?c:1));const o=this._context.bindTexture(this,st.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(st.TEXTURE_UNIT_FOR_UPDATES),st._validateTexture(this._context,s),this._configurePixelStorage();const a=s.pixelFormat;let l=s.internalFormat?s.internalFormat:this._deriveInternalFormat(a,s.dataType);if(R6(t)){let h=t.width,p=t.height;const f=1;t instanceof HTMLVideoElement&&(h=t.videoWidth,p=t.videoHeight),s.width&&s.height,n&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,l,s.hasMipmap,h,p,f),this._texImage(i,0,l,h,p,f,t),j0(r),s.hasMipmap&&this.generateMipmap(),s.width===void 0&&(s.width=h),s.height===void 0&&(s.height=p),n&&s.depth===void 0&&(s.depth=f)}else{const{width:h,height:p,depth:f}=s;if(h!=null&&p!=null||console.error("Width and height must be specified!"),n&&f==null&&console.error("Depth must be specified!"),s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(i,l,s.hasMipmap,h,p,f),r.DEPTH24_STENCIL8&&l===r.DEPTH_STENCIL&&(l=r.DEPTH24_STENCIL8),VD(t)){const m=t.levels,y=hie(i,h,p,f),v=Math.min(y-1,m.length-1);Cn(r)?r.texParameteri(s.target,r.TEXTURE_MAX_LEVEL,v):s.hasMipmap=s.hasMipmap&&y===m.length;const w=l;if(!KGe(w))throw new Error("Attempting to use compressed data with an umcompressed format!");this._forEachMipmapLevel((b,S,T,E)=>{const C=m[Math.min(b,m.length-1)];this._compressedTexImage(i,b,w,S,T,E,C)},v)}else _(t)?(this._texImage(i,0,l,h,p,f,t),j0(r),s.hasMipmap&&this.generateMipmap()):this._forEachMipmapLevel((m,y,v,w)=>{this._texImage(i,m,l,y,v,w,null),j0(r)})}st._applySamplingMode(r,this._descriptor),st._applyWrapMode(r,this._descriptor),st._applyAnisotropicFilteringParameters(this._context,this._descriptor),j0(r),this._context.bindTexture(o,st.TEXTURE_UNIT_FOR_UPDATES)}updateData(t,i,r,s,n,o){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const a=this._context.gl,l=this._descriptor,{pixelFormat:c,internalFormat:h,dataType:p,isImmutable:f,target:m}=l;if(f&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");const y=this._context.bindTexture(this,st.TEXTURE_UNIT_FOR_UPDATES);(i<0||r<0||s>l.width||n>l.height||i+s>l.width||r+n>l.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),R6(o)?a.texSubImage2D(m,t,i,r,c,p,o):VD(o)?a.compressedTexSubImage2D(m,t,i,r,s,n,h,o.levels[t]):a.texSubImage2D(m,t,i,r,s,n,c,p,o),this._context.bindTexture(y,st.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(t,i,r,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._context.gl;if(!Cn(c))throw new Error("3D textures are not supported in WebGL1");const h=this._descriptor,{pixelFormat:p,dataType:f,isImmutable:m,target:y,internalFormat:v}=h;if(m&&!this._wasImmutablyAllocated)throw new Error("Cannot update immutable texture before allocation!");e_(y)||console.warn("Attempting to set 3D texture data on a non-3D texture");const w=this._context.bindTexture(this,st.TEXTURE_UNIT_FOR_UPDATES);if(this._context.setActiveTexture(st.TEXTURE_UNIT_FOR_UPDATES),(i<0||r<0||s<0||n>h.width||o>h.height||a>h.depth||i+n>h.width||r+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),VD(l))l=l.levels[t],c.compressedTexSubImage3D(y,t,i,r,s,n,o,a,v,l);else{const b=l;c.texSubImage3D(y,t,i,r,s,n,o,a,p,f,b)}this._context.bindTexture(w,st.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const t=this._descriptor;if(!t.hasMipmap){if(this._wasImmutablyAllocated)throw new Error("Cannot add mipmaps to immutable texture after allocation");t.hasMipmap=!0,this._samplingModeDirty=!0,st._validateTexture(this._context,t)}t.samplingMode===Ke.LINEAR?(this._samplingModeDirty=!0,t.samplingMode=Ke.LINEAR_MIPMAP_NEAREST):t.samplingMode===Ke.NEAREST&&(this._samplingModeDirty=!0,t.samplingMode=Ke.NEAREST_MIPMAP_NEAREST);const i=this._context.bindTexture(this,st.TEXTURE_UNIT_FOR_UPDATES);this._context.setActiveTexture(st.TEXTURE_UNIT_FOR_UPDATES),this._context.gl.generateMipmap(t.target),this._context.bindTexture(i,st.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(t){t!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=t,this._samplingModeDirty=!0)}setWrapMode(t){t!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=t,st._validateTexture(this._context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const t=this._context.gl,i=this._descriptor;this._samplingModeDirty&&(st._applySamplingMode(t,i),this._samplingModeDirty=!1),this._wrapModeDirty&&(st._applyWrapMode(t,i),this._wrapModeDirty=!1)}_deriveInternalFormat(t,i){if(this._context.type===ai.WEBGL1)return t;switch(i){case St.FLOAT:switch(t){case ze.RGBA:return ft.RGBA32F;case ze.RGB:return ft.RGB32F;default:throw new Error("Unable to derive format")}case St.UNSIGNED_BYTE:switch(t){case ze.RGBA:return ft.RGBA8;case ze.RGB:return ft.RGB8}default:return t}}_configurePixelStorage(){const t=this._context.gl,{unpackAlignment:i,flipped:r,preMultiplyAlpha:s}=this._descriptor;t.pixelStorei(t.UNPACK_ALIGNMENT,i),t.pixelStorei(t.UNPACK_FLIP_Y_WEBGL,r?1:0),t.pixelStorei(t.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(t,i,r,s,n,o){const a=this._context.gl;if(!Cn(a))throw new Error("Immutable textures are not supported in WebGL1");if(!JGe(i))throw new Error("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=r?hie(t,s,n,o):1;e_(t)?a.texStorage3D(t,l,i,s,n,o):a.texStorage2D(t,l,i,s,n),this._wasImmutablyAllocated=!0}_texImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=this._context.type===ai.WEBGL2,p=e_(t),{isImmutable:f,pixelFormat:m,dataType:y}=this._descriptor;if(h&&(c=l),h||!R6(a))if(f){if(_(a)){const v=a;p?c.texSubImage3D(t,i,0,0,0,s,n,o,m,y,v):l.texSubImage2D(t,i,0,0,s,n,m,y,v)}}else{const v=a;p?c.texImage3D(t,i,r,s,n,o,0,m,y,v):l.texImage2D(t,i,r,s,n,0,m,y,v)}else l.texImage2D(t,0,r,m,y,a)}_compressedTexImage(t,i,r,s,n,o,a){const l=this._context.gl;let c=null;const h=e_(t),p=this._descriptor.isImmutable;if(h){if(this._context.type!==ai.WEBGL2)throw new Error("3D textures are not supported in WebGL1");c=l}p?_(a)&&(h?c.compressedTexSubImage3D(t,i,0,0,0,s,n,o,r,a):l.compressedTexSubImage2D(t,i,0,0,s,n,r,a)):h?c.compressedTexImage3D(t,i,r,s,n,o,0,a):l.compressedTexImage2D(t,i,r,s,n,0,a)}_forEachMipmapLevel(t,i=1/0){let{width:r,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===pt.TEXTURE_3D;for(let c=0;t(c,r,s,n),o&&(r!==1||s!==1||l&&n!==1)&&!(c>=i);++c)r=Math.max(1,r>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}static _validateTexture(t,i){(i.width<0||i.height<0||i.depth<0)&&console.error("Negative dimension parameters are not allowed!");const r=Cn(t.gl),s=xS(i.width)&&xS(i.height);r||!i.isImmutable&&!e_(i.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),r||s||(typeof i.wrapMode=="number"?i.wrapMode!==_t.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):i.wrapMode.s===_t.CLAMP_TO_EDGE&&i.wrapMode.t===_t.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),i.hasMipmap&&console.error("Mipmapping requires power-of-two textures!"))}static _applySamplingMode(t,i){let r=i.samplingMode,s=i.samplingMode;r===Ke.LINEAR_MIPMAP_NEAREST||r===Ke.LINEAR_MIPMAP_LINEAR?(r=Ke.LINEAR,i.hasMipmap||(s=Ke.LINEAR)):r!==Ke.NEAREST_MIPMAP_NEAREST&&r!==Ke.NEAREST_MIPMAP_LINEAR||(r=Ke.NEAREST,i.hasMipmap||(s=Ke.NEAREST)),t.texParameteri(i.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(i.target,t.TEXTURE_MIN_FILTER,s)}static _applyWrapMode(t,i){typeof i.wrapMode=="number"?(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode)):(t.texParameteri(i.target,t.TEXTURE_WRAP_S,i.wrapMode.s),t.texParameteri(i.target,t.TEXTURE_WRAP_T,i.wrapMode.t))}static _applyAnisotropicFilteringParameters(t,i){var s;const r=t.capabilities.textureFilterAnisotropic;!r||t.gl.texParameterf(i.target,r.TEXTURE_MAX_ANISOTROPY,(s=i.maxAnisotropy)!=null?s:1)}}function JGe(e){return e in ft}function KGe(e){return e in Xr}function VD(e){return _(e)&&"type"in e&&e.type==="compressed"}function e7e(e){return _(e)&&"byteLength"in e}function R6(e){return _(e)&&!VD(e)&&!e7e(e)}function e_(e){return e===pt.TEXTURE_3D||e===pt.TEXTURE_2D_ARRAY}function hie(e,t,i,r=1){let s=Math.max(t,i);return e===pt.TEXTURE_3D&&(s=Math.max(s,r)),Math.round(Math.log(s)/Math.LN2)+1}st.TEXTURE_UNIT_FOR_UPDATES=0;function die(e){const t=e.gl;switch(t.getError()){case t.NO_ERROR:return null;case t.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case t.INVALID_VALUE:return"A numeric argument is out of range";case t.INVALID_OPERATION:return"The specified command is not allowed for the current state";case t.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case t.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case t.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function xo(e,t){return e.vertexBuffers[t].size/t7e(e.layout[t])}function t7e(e){return e[0].stride}function OX(e,t,i,r,s=0){const n=e.gl,o=e.capabilities.instancing;e.bindBuffer(i);for(const a of r){const l=t.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function PX(e,t,i,r){const s=e.gl,n=e.capabilities.instancing;e.bindBuffer(i);for(const o of r){const a=t.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}e.unbindBuffer(bt.ARRAY_BUFFER)}function q0e(e){switch(e){case ze.ALPHA:case ze.LUMINANCE:case ze.RED:case ze.RED_INTEGER:case ft.R8:case ft.R8I:case ft.R8UI:case ft.R8_SNORM:case va.STENCIL_INDEX8:return 1;case ze.LUMINANCE_ALPHA:case ze.RG:case ze.RG_INTEGER:case ft.RGBA4:case ft.R16F:case ft.R16I:case ft.R16UI:case ft.RG8:case ft.RG8I:case ft.RG8UI:case ft.RG8_SNORM:case ft.RGB565:case ft.RGB5_A1:case va.DEPTH_COMPONENT16:return 2;case ze.DEPTH_COMPONENT:case ze.RGB:case ze.RGB_INTEGER:case ft.RGB8:case ft.RGB8I:case ft.RGB8UI:case ft.RGB8_SNORM:case ft.SRGB8:case va.DEPTH_COMPONENT24:return 3;case ze.DEPTH_STENCIL:case ze.RGBA:case ze.RGBA_INTEGER:case ft.RGBA8:case ft.R32F:case ft.R11F_G11F_B10F:case ft.RG16F:case ft.R32I:case ft.R32UI:case ft.RG16I:case ft.RG16UI:case ft.RGBA8I:case ft.RGBA8UI:case ft.RGBA8_SNORM:case ft.SRGB8_ALPHA8:case ft.RGB9_E5:case ft.RGB10_A2UI:case ft.RGB10_A2:case va.DEPTH_STENCIL:case va.DEPTH_COMPONENT32F:case va.DEPTH24_STENCIL8:return 4;case va.DEPTH32F_STENCIL8:return 5;case ft.RGB16F:case ft.RGB16I:case ft.RGB16UI:return 6;case ft.RG32F:case ft.RG32I:case ft.RG32UI:case ft.RGBA16F:case ft.RGBA16I:case ft.RGBA16UI:return 8;case ft.RGB32F:case ft.RGB32I:case ft.RGB32UI:return 12;case ft.RGBA32F:case ft.RGBA32I:case ft.RGBA32UI:return 16;case Xr.COMPRESSED_RGB_S3TC_DXT1_EXT:case Xr.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Xr.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Xr.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Xr.COMPRESSED_R11_EAC:case Xr.COMPRESSED_SIGNED_R11_EAC:case Xr.COMPRESSED_RGB8_ETC2:case Xr.COMPRESSED_SRGB8_ETC2:case Xr.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Xr.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Xr.COMPRESSED_RG11_EAC:case Xr.COMPRESSED_SIGNED_RG11_EAC:case Xr.COMPRESSED_RGBA8_ETC2_EAC:case Xr.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}function Bb(e){if(R(e))return 0;if("descriptor"in e)return e.glName?Bb(e.descriptor):0;const t=e.internalFormat||"pixelFormat"in e&&e.pixelFormat;if(!t)return 0;const i="hasMipmap"in e&&e.hasMipmap?1.3:1,r=e.width*e.height;return q0e(t)*r*i}const t_=me.getLogger("esri.views.webgl.VertexArrayObject");class Ns{constructor(t,i,r,s,n=null){this._context=t,this._locations=i,this._layout=r,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,t.instanceCounter.increment(dn.VertexArrayObject,this)}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get size(){return Object.keys(this._buffers).reduce((t,i)=>t+this._buffers[i].size,_(this._indexBuffer)?this._indexBuffer.size:0)}get layout(){return this._layout}get locations(){return this._locations}dispose(t=!0){var i,r;if(!this._context)return void((this._glName||t&&Object.getOwnPropertyNames(this._buffers).length>0)&&t_.warn("Leaked WebGL VAO"));if(this._glName){const s=(r=(i=this._context)==null?void 0:i.capabilities)==null?void 0:r.vao;s?(s.deleteVertexArray(this._glName),this._glName=null):t_.warn("Leaked WebGL VAO")}if(this._context.getBoundVAO()===this&&this._context.bindVAO(null),t){for(const s in this._buffers)this._buffers[s].dispose(),delete this._buffers[s];this._indexBuffer=Ye(this._indexBuffer)}this._context.instanceCounter.decrement(dn.VertexArrayObject,this),this._context=null}initialize(){if(this._initialized)return;const t=this._context.capabilities.vao;if(t){const i=t.createVertexArray();t.bindVertexArray(i),this._bindLayout(),t.bindVertexArray(null),this._glName=i}this._initialized=!0}bind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:t,_layout:i,_indexBuffer:r}=this;t||t_.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in t){const o=t[n];o||t_.error("Vertex buffer is uninitialized!");const a=i[n];a||t_.error("Vertex element descriptor is empty!"),OX(this._context,this._locations,o,a)}_(r)&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,r.glName):this._context.bindBuffer(r))}unbind(){this.initialize();const t=this._context.capabilities.vao;t?t.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:t,_layout:i}=this;t||t_.error("Vertex buffer dictionary is empty!");for(const r in t){const s=t[r];s||t_.error("Vertex buffer is uninitialized!");const n=i[r];PX(this._context,this._locations,s,n)}_(this._indexBuffer)&&this._context.unbindBuffer(this._indexBuffer.bufferType)}}function Ma(e,t=MX,i=Di,r=-1,s=1){let n=null;return t===VO?n=new Float32Array([r,r,0,0,s,r,1,0,r,s,0,1,s,s,1,1]):n=new Float32Array([r,r,s,r,r,s,s,s]),new Ns(e,i,{geometry:t},{geometry:ti.createVertex(e,yi.STATIC_DRAW,n)})}function i7e(e,t=MX,i=Di){const r=new Float32Array([-1,-1,3,-1,-1,3]);return new Ns(e,i,{geometry:t},{geometry:ti.createVertex(e,yi.STATIC_DRAW,r)})}const W0e=4;function X0e(e,t=W0e){return new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:t,height:t})}function r7e(e,t,i=W0e){const r=new Uint8Array(i*i*4);for(let s=0;s<r.length;s+=4)r[s+0]=255*t[0],r[s+1]=255*t[1],r[s+2]=255*t[2],r[s+3]=255*t[3];return new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:i,height:i},r)}function Y0e(e){return new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:1,height:1},new Uint8Array([255,255,255,255]))}class pie{constructor(t){this._view=t,this.type="realistic",this.canRender=!0,this._cameraPosition=O(),this._heightParameters=Gt(),this._betasRayleigh=O(),this._betasCombined=O(),this._scaleHeight=0,this._radii=tt(),this._cameraHeight=0,this._cameraHeightSq=0,this._cAtmosphere=0,this._innerFadeDistance=0,this._altitudeFade=0,this._lowerElevationBoundRadius=0,this._lowerBoundEarthRadius=Ei.radius,this._hazeStrength=1,this._darkenHaze=!1,this._updateRadius(Ei.radius)}destroy(){this._atmosphereTechnique=Wi(this._atmosphereTechnique),this._atmosphereHazeTechnique=Wi(this._atmosphereHazeTechnique),this._vao=Ye(this._vao),this._handles=ot(this._handles)}when(){return Promise.resolve()}initializeRenderContext(t){const i=t.renderContext.rctx,r=this._handles=new qt,s=this._view.basemapTerrain;_(s.rootTiles)&&this._updateElevation({spatialReference:s.spatialReference,tile:s.rootTiles[0],extent:s.rootTiles[0].extent,context:"ground"}),r.add(eo(()=>this._view.basemapTerrain,"elevation-change",o=>this._updateElevation(o),{onListenerAdd:()=>this._updateElevation()})),r.add(eo(()=>this._view.basemapTerrain,"elevation-bounds-change",()=>this._updateVisibleElevationBounds()));const n=new j0e;n.haze=!1,this._atmosphereTechnique=t.shaderTechniqueRepository.acquire(_M,n),n.haze=!0,this._atmosphereHazeTechnique=t.shaderTechniqueRepository.acquire(_M,n),this._vao=Ma(i,VO),this._scaleHeight=mGe*zD,ie(this._betasRayleigh,$w[0],$w[1],$w[2]),ie(this._betasCombined,$w[0]+C6[0],$w[1]+C6[1],$w[2]+C6[2])}render(t){this._render(t,this._atmosphereTechnique,t.offscreenRenderingHelper.depthTexture)}renderHaze(t,i){this._darkenHaze=i,this._render(t,this._atmosphereHazeTechnique,t.offscreenRenderingHelper.linearDepthTexture)}_render(t,i,r){this._update(t.bindParameters.camera);const s=t.rctx.bindTechnique(i,s7e,t.bindParameters);t.offscreenRenderingHelper.renderDepthDetached(()=>{s.bindTexture("depthTex",r),this._renderCommon(i.program,t)})}_renderCommon(t,i){if(R(this._vao))return;const r=i.rctx;t.setUniform4fv("heightParameters",this._heightParameters),t.setUniform3fv("cameraPosition",this._cameraPosition),t.setUniform2fv("radii",this._radii),t.setUniform1f("scaleHeight",this._scaleHeight),t.setUniform1f("betaMie",fGe),t.setUniform3fv("betaRayleigh",this._betasRayleigh),t.setUniform3fv("betaCombined",this._betasCombined),t.setUniform1f("innerFadeDistance",this._innerFadeDistance),t.setUniform1f("altitudeFade",this._altitudeFade),t.setUniform1f("hazeStrength",this._hazeStrength),r.bindVAO(this._vao),t.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Pt.TRIANGLE_STRIP,0,4)}_adjustRadiusForTesselation(t){return t*Math.cos(Math.PI/16/16)}_updateElevation(t){const i=t?t.tile:yt(this._view.basemapTerrain.rootTiles,[null])[0];if(R(i)||i.level!==0)return;const r=this._adjustRadiusForTesselation(Ei.radius+i.elevationBounds[0]);r!==this._lowerElevationBoundRadius&&(this._lowerElevationBoundRadius=r,this._lowerBoundEarthRadius=-1,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const t=this._adjustRadiusForTesselation(Ei.radius+this._view.basemapTerrain.elevationBounds.min);(this._lowerBoundEarthRadius<0||t<this._lowerBoundEarthRadius)&&this._updateRadius(t)}_updateRadius(t){this._lowerBoundEarthRadius=t,hi(this._radii,t,t+zD),this._innerFadeDistance=2*Math.sqrt((2*t-R7)*R7)}_update(t){if(R(t))return;this._cameraHeight=Me(t.eye),this._cameraHeightSq=this._cameraHeight*this._cameraHeight,this._cAtmosphere=this._cameraHeightSq-this._radii[1]*this._radii[1];const i=Math.min(1,Math.max(0,(this._cameraHeight-this._radii[0])/zD));this._heightParameters=fi(this._cameraHeight,this._cameraHeightSq,this._cAtmosphere,i),se(this._cameraPosition,t.eye),this._altitudeFade=I0e(this._cameraHeight-this._lowerBoundEarthRadius),this._hazeStrength=this._darkenHaze?jt(.6,1,TS(9500,10500,this._cameraHeight-Ei.radius)):1}static isSupported(t){return t.renderContext.rctx.capabilities.depthTexture}}const s7e=new Us;function n7e(e){return e[0]=0,e[1]=0,e[2]=0,e[3]=1,e}function Z0e(e,t,i){i*=.5;const r=Math.sin(i);return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=Math.cos(i),e}function Q0e(e,t){const i=2*Math.acos(t[3]),r=Math.sin(i/2);return r>Et?(e[0]=t[0]/r,e[1]=t[1]/r,e[2]=t[2]/r):(e[0]=1,e[1]=0,e[2]=0),i}function IX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*h+o*a+s*c-n*l,e[1]=s*h+o*l+n*a-r*c,e[2]=n*h+o*c+r*l-s*a,e[3]=o*h-r*a-s*l-n*c,e}function o7e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+o*a,e[1]=s*l+n*a,e[2]=n*l-s*a,e[3]=o*l-r*a,e}function a7e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l-n*a,e[1]=s*l+o*a,e[2]=n*l+r*a,e[3]=o*l-s*a,e}function l7e(e,t,i){i*=.5;const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+s*a,e[1]=s*l-r*a,e[2]=n*l+o*a,e[3]=o*l-n*a,e}function c7e(e,t){const i=t[0],r=t[1],s=t[2];return e[0]=i,e[1]=r,e[2]=s,e[3]=Math.sqrt(Math.abs(1-i*i-r*r-s*s)),e}function BD(e,t,i,r){const s=t[0],n=t[1],o=t[2],a=t[3];let l,c,h,p,f,m=i[0],y=i[1],v=i[2],w=i[3];return c=s*m+n*y+o*v+a*w,c<0&&(c=-c,m=-m,y=-y,v=-v,w=-w),1-c>Et?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-r)*l)/h,f=Math.sin(r*l)/h):(p=1-r,f=r),e[0]=p*s+f*m,e[1]=p*n+f*y,e[2]=p*o+f*v,e[3]=p*a+f*w,e}function u7e(e){const t=Od(),i=Od(),r=Od(),s=Math.sqrt(1-t),n=Math.sqrt(t);return e[0]=s*Math.sin(2*Math.PI*i),e[1]=s*Math.cos(2*Math.PI*i),e[2]=n*Math.sin(2*Math.PI*r),e[3]=n*Math.cos(2*Math.PI*r),e}function h7e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i*i+r*r+s*s+n*n,a=o?1/o:0;return e[0]=-i*a,e[1]=-r*a,e[2]=-s*a,e[3]=n*a,e}function Cg(e,t){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=t[3],e}function J0e(e,t){const i=t[0]+t[4]+t[8];let r;if(i>0)r=Math.sqrt(i+1),e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r;else{let s=0;t[4]>t[0]&&(s=1),t[8]>t[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;r=Math.sqrt(t[3*s+s]-t[3*n+n]-t[3*o+o]+1),e[s]=.5*r,r=.5/r,e[3]=(t[3*n+o]-t[3*o+n])*r,e[n]=(t[3*n+s]+t[3*s+n])*r,e[o]=(t[3*o+s]+t[3*s+o])*r}return e}function d7e(e,t,i,r){const s=.5*Math.PI/180;t*=s,i*=s,r*=s;const n=Math.sin(t),o=Math.cos(t),a=Math.sin(i),l=Math.cos(i),c=Math.sin(r),h=Math.cos(r);return e[0]=n*l*h-o*a*c,e[1]=o*a*h+n*l*c,e[2]=o*l*c-n*a*h,e[3]=o*l*h+n*a*c,e}function p7e(e){return"quat("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}const BO=Pd,f7e=qi,m7e=mH,g7e=IX,y7e=hO,v7e=Dle,_7e=ZF,K0e=gH,b7e=K0e,eve=yH,w7e=eve,$X=$le,x7e=kR,T7e=Lle;function S7e(e,t,i){const r=xe(t,i);return r<-.999999?(lt(sp,E7e,t),fH(sp)<1e-6&&lt(sp,C7e,t),we(sp,sp),Z0e(e,sp,Math.PI),e):r>.999999?(e[0]=0,e[1]=0,e[2]=0,e[3]=1,e):(lt(sp,t,i),e[0]=sp[0],e[1]=sp[1],e[2]=sp[2],e[3]=1+r,$X(e,e))}const sp=O(),E7e=Fe(1,0,0),C7e=Fe(0,1,0);function A7e(e,t,i,r,s,n){return BD(fie,t,s,n),BD(mie,i,r,n),BD(e,fie,mie,2*n*(1-n)),e}const fie=Dg(),mie=Dg();function R7e(e,t,i,r){const s=M7e;return s[0]=i[0],s[3]=i[1],s[6]=i[2],s[1]=r[0],s[4]=r[1],s[7]=r[2],s[2]=-t[0],s[5]=-t[1],s[8]=-t[2],$X(e,J0e(e,s))}const M7e=Sr();Object.freeze(Object.defineProperty({__proto__:null,identity:n7e,setAxisAngle:Z0e,getAxisAngle:Q0e,multiply:IX,rotateX:o7e,rotateY:a7e,rotateZ:l7e,calculateW:c7e,slerp:BD,random:u7e,invert:h7e,conjugate:Cg,fromMat3:J0e,fromEuler:d7e,str:p7e,copy:BO,set:f7e,add:m7e,mul:g7e,scale:y7e,dot:v7e,lerp:_7e,length:K0e,len:b7e,squaredLength:eve,sqrLen:w7e,normalize:$X,exactEquals:x7e,equals:T7e,rotationTo:S7e,sqlerp:A7e,setAxes:R7e},Symbol.toStringTag,{value:"Module"}));function sE(e=P7e){return[e[0],e[1],e[2],e[3]]}function bM(e,t){return O7e(e[0],e[1],e[2],t,Hq.get())}function O7e(e,t,i,r,s=sE()){return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function wM(e,t,i=sE()){return lt(i,e,t),we(i,i),i[3]=Xq(e,t),i}const P7e=[0,0,1,0];class I7e{constructor(){this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=O(),this.parallax={anchorPointClouds:O(),cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Ae()},this.parallaxNew={anchorPointClouds:O(),cloudsHeight:1e5,radiusCurvatureCorrectionFactor:0,transform:Ae()},this.crossFade={enabled:!1,factor:0,distanceThresholdFactor:.3},this.fadeInOut={stage:Gn.FINISHED,factor:0,distanceThresholdFactor:.6},this.fadeIn={stage:Ku.FINISHED,factor:0,distanceThresholdFactor:2},this.fadeInOutHeight={stage:nv.FINISHED,factor:-1}}}var Ku,Gn,nv;(function(e){e[e.FINISHED=0]="FINISHED",e[e.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",e[e.FADE_IN=2]="FADE_IN"})(Ku||(Ku={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.FADE_OUT=1]="FADE_OUT",e[e.SWITCH=2]="SWITCH",e[e.FADE_IN=3]="FADE_IN"}(Gn||(Gn={})),function(e){e[e.FINISHED=0]="FINISHED",e[e.HEIGHT_FADE=1]="HEIGHT_FADE"}(nv||(nv={}));function wi(){return new Float32Array(3)}function XN(e){const t=new Float32Array(3);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function Ai(e,t,i){const r=new Float32Array(3);return r[0]=e,r[1]=t,r[2]=i,r}function tve(e,t){return new Float32Array(e,t,3)}function DX(){return wi()}function ive(){return Ai(1,1,1)}function rve(){return Ai(1,0,0)}function sve(){return Ai(0,1,0)}function nve(){return Ai(0,0,1)}const $7e=DX(),D7e=ive(),L7e=rve(),N7e=sve(),F7e=nve();Object.freeze(Object.defineProperty({__proto__:null,create:wi,clone:XN,fromValues:Ai,createView:tve,zeros:DX,ones:ive,unitX:rve,unitY:sve,unitZ:nve,ZEROS:$7e,ONES:D7e,UNIT_X:L7e,UNIT_Y:N7e,UNIT_Z:F7e},Symbol.toStringTag,{value:"Module"}));function ove(e){e.extensions.add("GL_EXT_shader_texture_lod"),e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`#ifndef GL_EXT_shader_texture_lod
float calcMipMapLevel(const vec2 ddx, const vec2 ddy) {
float deltaMaxSqr = max(dot(ddx, ddx), dot(ddy, ddy));
return max(0.0, 0.5 * log2(deltaMaxSqr));
}
#endif
vec4 textureAtlasLookup(sampler2D texture, vec2 textureSize, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
#ifdef GL_EXT_shader_texture_lod
return texture2DGradEXT(texture, uvAtlas, dUVdx, dUVdy);
#else
vec2 dUVdxAuto = dFdx(uvAtlas);
vec2 dUVdyAuto = dFdy(uvAtlas);
float mipMapLevel = calcMipMapLevel(dUVdx * textureSize, dUVdy * textureSize);
float autoMipMapLevel = calcMipMapLevel(dUVdxAuto * textureSize, dUVdyAuto * textureSize);
return texture2D(texture, uvAtlas, mipMapLevel - autoMipMapLevel);
#endif
}`)}function LX(e,t){switch(e.include(og,t),e.fragment.code.add(x`
  struct TextureLookupParameter {
    vec2 uv;
    ${t.supportsTextureAtlas?"vec2 size;":""}
  } vtc;
  `),t.textureCoordinateType){case Zs.Default:return void e.fragment.code.add(x`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return texture2D(texture, params.uv);
}`);case Zs.Atlas:return e.include(ove),void e.fragment.code.add(x`vec4 textureLookup(sampler2D texture, TextureLookupParameter params) {
return textureAtlasLookup(texture, params.size, params.uv, vuvRegion);
}`);default:t.textureCoordinateType;case Zs.None:case Zs.COUNT:return}}class Sa extends jr{constructor(t,i){super(t,"vec3",$i.Draw,(r,s,n)=>r.setUniform3fv(t,i(s,n)))}}class NX extends jr{constructor(t,i){super(t,"vec2",$i.Draw,(r,s,n)=>r.setUniform2fv(t,i(s,n)))}}class FX extends jr{constructor(t,i){super(t,"sampler2D",$i.Draw,(r,s,n)=>r.bindTexture(t,i(s,n)))}}function yR(e,t,i){const r=[new FX(e,t)];if(i){const s=e+"Size";r.push(new NX(s,(n,o)=>{const a=t(n,o);return _(a)?hi(U7e,a.descriptor.width,a.descriptor.height):Sh}))}return r}const U7e=tt();class zt extends jr{constructor(t,i){super(t,"sampler2D",$i.Pass,(r,s,n)=>r.bindTexture(t,i(s,n)))}}function GD(e,t,i){const r=[new zt(e,t)];if(i){const s=e+"Size";r.push(new di(s,(n,o)=>{const a=t(n,o);return _(a)?hi(k7e,a.descriptor.width,a.descriptor.height):Sh}))}return r}const k7e=tt();class kv{constructor(t){this._material=t.material,this._techniqueRepository=t.techniqueRep,this._output=t.output}dispose(){this._techniqueRepository.release(this._technique)}get technique(){return this._technique}ensureTechnique(t,i,r=this._output){return this._technique=this._techniqueRepository.releaseAndAcquire(t,this._material.getConfiguration(r,i),this._technique),this._technique}ensureResources(t){return kl.LOADED}}class UX extends kv{constructor(t){super(t),this._numLoading=0,this._disposed=!1,this._textureRepository=t.textureRep,this._textureId=t.textureId,this._acquire(t.textureId,i=>this._texture=i),this._acquire(t.normalTextureId,i=>this._textureNormal=i),this._acquire(t.emissiveTextureId,i=>this._textureEmissive=i),this._acquire(t.occlusionTextureId,i=>this._textureOcclusion=i),this._acquire(t.metallicRoughnessTextureId,i=>this._textureMetallicRoughness=i)}dispose(){this._texture=Wi(this._texture),this._textureNormal=Wi(this._textureNormal),this._textureEmissive=Wi(this._textureEmissive),this._textureOcclusion=Wi(this._textureOcclusion),this._textureMetallicRoughness=Wi(this._textureMetallicRoughness),this._disposed=!0}ensureResources(t){return this._numLoading===0?kl.LOADED:kl.LOADING}get textureBindParameters(){return new ave(_(this._texture)?this._texture.glTexture:null,_(this._textureNormal)?this._textureNormal.glTexture:null,_(this._textureEmissive)?this._textureEmissive.glTexture:null,_(this._textureOcclusion)?this._textureOcclusion.glTexture:null,_(this._textureMetallicRoughness)?this._textureMetallicRoughness.glTexture:null)}updateTexture(t){(R(this._texture)||t!==this._texture.id)&&(this._texture=Wi(this._texture),this._textureId=t,this._acquire(this._textureId,i=>this._texture=i))}_acquire(t,i){if(R(t))return void i(null);const r=this._textureRepository.acquire(t);if(vu(r))return++this._numLoading,void r.then(s=>{if(this._disposed)return Wi(s),void i(null);i(s)}).finally(()=>--this._numLoading);i(r)}}class ave extends Us{constructor(t=null,i=null,r=null,s=null,n=null){super(),this.texture=t,this.textureNormal=i,this.textureEmissive=r,this.textureOcclusion=s,this.textureMetallicRoughness=n}}const V_t=Ai(0,.6,.2);var Rt;(function(e){e[e.Disabled=0]="Disabled",e[e.Normal=1]="Normal",e[e.Schematic=2]="Schematic",e[e.Water=3]="Water",e[e.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",e[e.COUNT=5]="COUNT"})(Rt||(Rt={}));function kX(e,t){const i=e.fragment,r=t.hasMetalnessAndRoughnessTexture||t.hasEmissionTexture||t.hasOcclusionTexture;if(t.pbrMode===Rt.Normal&&r&&e.include(LX,t),t.pbrMode!==Rt.Schematic)if(t.pbrMode!==Rt.Disabled){if(t.pbrMode===Rt.Normal){i.code.add(x`vec3 mrr;
vec3 emission;
float occlusion;`);const s=t.supportsTextureAtlas,n=t.pbrTextureBindType;t.hasMetalnessAndRoughnessTexture&&(i.uniforms.add(n===$i.Pass?GD("texMetallicRoughness",o=>o.textureMetallicRoughness,s):yR("texMetallicRoughness",o=>o.textureMetallicRoughness,s)),i.code.add(x`void applyMetallnessAndRoughness(TextureLookupParameter params) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, params).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),t.hasEmissionTexture&&(i.uniforms.add(n===$i.Pass?GD("texEmission",o=>o.textureEmissive,s):yR("texEmission",o=>o.textureEmissive,s)),i.code.add(x`void applyEmission(TextureLookupParameter params) {
emission *= textureLookup(texEmission, params).rgb;
}`)),t.hasOcclusionTexture?(i.uniforms.add(n===$i.Pass?GD("texOcclusion",o=>o.textureOcclusion,s):yR("texOcclusion",o=>o.textureOcclusion,s)),i.code.add(x`void applyOcclusion(TextureLookupParameter params) {
occlusion *= textureLookup(texOcclusion, params).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):i.code.add(x`float getBakedOcclusion() { return 1.0; }`),i.uniforms.add(n===$i.Pass?[new xt("emissionFactor",o=>o.emissiveFactor),new xt("mrrFactors",o=>o.mrrFactors)]:[new Sa("emissionFactor",o=>o.emissiveFactor),new Sa("mrrFactors",o=>o.mrrFactors)]),i.code.add(x`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;
      ${r?"vtc.uv = vuv0;":""}
      ${t.hasMetalnessAndRoughnessTexture?t.supportsTextureAtlas?"vtc.size = texMetallicRoughnessSize; applyMetallnessAndRoughness(vtc);":"applyMetallnessAndRoughness(vtc);":""}
      ${t.hasEmissionTexture?t.supportsTextureAtlas?"vtc.size = texEmissionSize; applyEmission(vtc);":"applyEmission(vtc);":""}
      ${t.hasOcclusionTexture?t.supportsTextureAtlas?"vtc.size = texOcclusionSize; applyOcclusion(vtc);":"applyOcclusion(vtc);":""}
    }
  `)}}else i.code.add(x`float getBakedOcclusion() { return 1.0; }`);else i.code.add(x`vec3 mrr = vec3(0.0, 0.6, 0.2);
vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}class ei extends jr{constructor(t,i){super(t,"vec4",$i.Pass,(r,s,n)=>r.setUniform4fv(t,i(s,n)))}}function zX(e,t){const i=e.fragment,r=t.lightingSphericalHarmonicsOrder!==void 0?t.lightingSphericalHarmonicsOrder:2;r===0?(i.uniforms.add(new xt("lightingAmbientSH0",(s,n)=>ie(gie,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0]))),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===1?(i.uniforms.add([new ei("lightingAmbientSH_R",(s,n)=>qi(Zf,n.lighting.sh.r[0],n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3])),new ei("lightingAmbientSH_G",(s,n)=>qi(Zf,n.lighting.sh.g[0],n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3])),new ei("lightingAmbientSH_B",(s,n)=>qi(Zf,n.lighting.sh.b[0],n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3]))]),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):r===2&&(i.uniforms.add([new xt("lightingAmbientSH0",(s,n)=>ie(gie,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0])),new ei("lightingAmbientSH_R1",(s,n)=>qi(Zf,n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3],n.lighting.sh.r[4])),new ei("lightingAmbientSH_G1",(s,n)=>qi(Zf,n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3],n.lighting.sh.g[4])),new ei("lightingAmbientSH_B1",(s,n)=>qi(Zf,n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3],n.lighting.sh.b[4])),new ei("lightingAmbientSH_R2",(s,n)=>qi(Zf,n.lighting.sh.r[5],n.lighting.sh.r[6],n.lighting.sh.r[7],n.lighting.sh.r[8])),new ei("lightingAmbientSH_G2",(s,n)=>qi(Zf,n.lighting.sh.g[5],n.lighting.sh.g[6],n.lighting.sh.g[7],n.lighting.sh.g[8])),new ei("lightingAmbientSH_B2",(s,n)=>qi(Zf,n.lighting.sh.b[5],n.lighting.sh.b[6],n.lighting.sh.b[7],n.lighting.sh.b[8]))]),i.code.add(x`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),t.pbrMode!==Rt.Normal&&t.pbrMode!==Rt.Schematic||i.code.add(x`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}const gie=O(),Zf=Gt();class We extends jr{constructor(t,i){super(t,"float",$i.Pass,(r,s,n)=>r.setUniform1f(t,i(s,n)))}}function VX(e,t){const i=e.fragment;t.isGround?i.uniforms.add(new We("lightingFixedFactor",(r,s)=>(1-s.lighting.groundLightingFactor)*(1-s.lighting.globalFactor))):i.constants.add("lightingFixedFactor","float",0),i.uniforms.add([new xt("lightingMainDirection",(r,s)=>s.lighting.lightingMainDirection),new xt("lightingMainIntensity",(r,s)=>s.lighting.mainLight.intensity)]),i.code.add(x`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, lightingMainDirection), 0.0, 1.0);
dotVal = mix(dotVal, 1.0, lightingFixedFactor);
return lightingMainIntensity * ((1.0 - shadowing) * dotVal);
}`)}function d5(e){e.vertex.code.add(x`const float PI = 3.141592653589793;`),e.fragment.code.add(x`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}class Gb extends jr{constructor(t,i){super(t,"bool",$i.Pass,(r,s,n)=>r.setUniform1b(t,i(s,n)))}}class z7e extends jr{constructor(t,i){super(t,"samplerCube",$i.Pass,(r,s,n)=>r.bindTexture(t,i(s,n)))}}function lve(e){const t=e.fragment;t.uniforms.add([new vr("rotationMatrixClouds",(i,r)=>r.clouds.parallax.transform),new vr("rotationMatrixCloudsCrossFade",(i,r)=>r.clouds.parallaxNew.transform),new xt("anchorPosition",(i,r)=>r.clouds.parallax.anchorPointClouds),new xt("anchorPositionCrossFade",(i,r)=>r.clouds.parallaxNew.anchorPointClouds),new di("cloudVariables",(i,r)=>_(r.clouds.data)?hi(V7e,r.clouds.data.coverage,r.clouds.data.absorption):Sh),new We("cloudsHeight",(i,r)=>r.clouds.parallax.cloudsHeight),new We("radiusCurvatureCorrectionFactor",(i,r)=>r.clouds.parallax.radiusCurvatureCorrectionFactor),new We("totalFadeInOut",(i,r)=>r.clouds.fadeInOut.stage===Gn.FINISHED?r.clouds.fadeInOutHeight.factor+Math.max($e(r.clouds.fadeIn.factor,0,1)):r.clouds.fadeInOutHeight.factor+Math.max($e(r.clouds.fadeInOut.factor,0,1))),new We("crossFadeAnchorFactor",(i,r)=>$e(r.clouds.crossFade.factor,0,1)),new z7e("cubeMap",(i,r)=>_(r.clouds.data)?r.clouds.data.cubeMap.colorTexture:null),new Gb("crossFade",(i,r)=>r.clouds.crossFade.enabled)]),t.constants.add("planetRadius","float",Ei.radius),t.code.add(x`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),t.code.add(x`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),t.code.add(x`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),t.uniforms.add([new xt("lightingMainDirection",(i,r)=>r.lighting.lightingMainDirection),new xt("lightingMainIntensity",(i,r)=>r.lighting.mainLight.intensity)]),t.code.add(x`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(lightingMainDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(lightingMainDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((lightingMainIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * pow(dirDotLight, RIM_SCATTERING_FACTOR) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),t.code.add(x`vec4 getCloudData(vec3 rayDir)
{
vec4 cloudData = textureCube(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
return mix(vec4(vec3(clamp(1.0 - cloudVariables.y, 0.6, 1.0)), 0.0), cloudData, smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(mu)));
}`),t.code.add(x`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),t.code.add(x`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),t.code.add(x`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}const V7e=tt();function Vf(e){e.code.add(x`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function B7e(){const e=new Bi;e.attributes.add(A.POSITION,"vec2"),e.varyings.add("worldRay","vec3");const{vertex:t,fragment:i}=e;return t.uniforms.add([new vr("inverseProjectionMatrix",(r,s)=>s.camera.inverseProjectionMatrix),new vr("inverseViewMatrix",(r,s)=>cs(G7e,s.camera.viewMatrix))]),t.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),i.include(Vf),i.include(uc),e.include(zX,{pbrMode:Rt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(d5),e.include(u5),e.include(VX,{isGround:!1}),e.include(lve,{instancedDoublePrecision:!1,isGround:!1}),i.uniforms.add([new xt("cameraPosition",(r,s)=>s.camera.eye)]),i.code.add(x`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
gl_FragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),e}const G7e=Ae(),j7e=Object.freeze(Object.defineProperty({__proto__:null,build:B7e},Symbol.toStringTag,{value:"Module"}));class p5 extends lr{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=p5.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:zf(Re.ONE,Re.SRC_ALPHA),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}p5.shader=new Qi(j7e,()=>import("./CloudsComposition.glsl.1bda464c.js"));function H7e(e){return _(e)&&_(e.cubeMap)&&e.coverage>0}function yie(e){return _(e)&&!e.running}let u1=class extends Ee{constructor(e){super(e),this._technique=new p5(e),this._vao=Ma(e.rctx)}destroy(){this._technique=Wi(this._technique),this._vao=Ye(this._vao)}render(e,t){const i=e.bindParameters.clouds;if(R(this._vao)||R(i.data))return;if(!this._technique.compiled)return void this.requestRender();this._setParallaxParameters(i,e.bindParameters.camera.eye,t);const r=e.rctx.bindTechnique(this._technique,Q7e,e.bindParameters);e.rctx.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(Pt.TRIANGLE_STRIP,0,4),Z7e(i)&&this.requestRender()}_setFadeInStage(e,t){const i=performance.now(),r=e.parallax.anchorPointClouds;e.fadeIn.stage===Ku.FINISHED&&(e.fadeIn.factor=1,se(r,np),e.fadeIn.stage=Ku.CHANGE_ANCHOR,e.crossFade.enabled=!1,e.fadeInOut.stage=Gn.FINISHED);const s=bie(e,t);e.fadeIn.stage===Ku.CHANGE_ANCHOR&&s&&yie(e.data)&&(se(r,np),e.fadeIn.stage=Ku.FADE_IN,e.startTime=i),e.fadeIn.factor>0&&e.fadeIn.stage===Ku.FADE_IN&&(e.fadeIn.factor=1-(i-e.startTime)/_ie),e.fadeIn.factor<=0&&e.fadeIn.stage===Ku.FADE_IN&&(e.fadeIn.stage=Ku.FINISHED,e.fadeIn.factor=0)}_setCrossFadingStage(e){const t=performance.now(),{crossFade:i}=e,r=e.parallax.anchorPointClouds;e.crossFade.enabled||(se(e.parallaxNew.anchorPointClouds,np),e.startTime=t,i.factor=0,e.crossFade.enabled=!0),i.factor<1&&e.crossFade.enabled&&(i.factor=(t-e.startTime)/X7e),i.factor>=1&&e.crossFade.enabled&&(e.crossFade.enabled=!1,i.factor=1,se(r,e.parallaxNew.anchorPointClouds))}_setFadeInOutStage(e,t){const i=performance.now(),{fadeInOut:r,crossFade:s}=e;r.stage===Gn.FINISHED&&(e.startTime=i,r.factor=0,r.stage=Gn.FADE_OUT),r.factor<1&&r.stage===Gn.FADE_OUT&&(r.factor=(i-e.startTime)/W7e),r.factor>=1&&r.stage===Gn.FADE_OUT&&(r.factor=1,se(e.parallax.anchorPointClouds,np)),r.factor>=1&&r.stage===Gn.FADE_OUT&&bie(e,t)&&(r.factor=1,r.stage=Gn.SWITCH,e.crossFade.enabled=!1,s.factor=1),yie(e.data)&&r.stage===Gn.SWITCH&&(e.startTime=i,r.factor=1,r.stage=Gn.FADE_IN,se(e.parallax.anchorPointClouds,np),e.crossFade.enabled=!1,s.factor=1),r.factor>0&&r.stage===Gn.FADE_IN&&(r.factor=1-(i-e.startTime)/_ie),r.factor<=0&&r.stage===Gn.FADE_IN&&(r.stage=Gn.FINISHED,r.factor=0)}_setFadeInOutHeight(e,t){const i=performance.now(),r=e.fadeInOutHeight,s=(i-(r.stage===nv.FINISHED?i:e.startTimeHeightFade))/Y7e;r.factor+=t?-s:s,e.startTimeHeightFade=i,r.factor=$e(r.factor,0,1),r.stage=nv.HEIGHT_FADE}_setParallaxParameters(e,t,i){const{parallax:r}=e;e.fadeInOutHeight.factor<0&&(e.fadeInOutHeight.factor=Me(t)-this.planetRadius>rh?1:0),we(np,t),oe(np,np,this.planetRadius),r.anchorPointClouds[0]===0&&r.anchorPointClouds[1]===0&&r.anchorPointClouds[2]===0&&se(r.anchorPointClouds,np);const s=Me(pe(q7e,r.anchorPointClouds,np));let n=!0;s>e.fadeIn.distanceThresholdFactor*r.cloudsHeight||e.fadeIn.stage!==Ku.FINISHED?this._setFadeInStage(e,t):s>e.fadeInOut.distanceThresholdFactor*r.cloudsHeight||e.fadeInOut.stage!==Gn.FINISHED?this._setFadeInOutStage(e,t):s>e.crossFade.distanceThresholdFactor*r.cloudsHeight&&!i||e.crossFade.enabled?this._setCrossFadingStage(e):n=!1;const o=Me(t),a=o-this.planetRadius;if((a>1.7*rh||a<-rh)&&e.fadeInOutHeight.factor<1?e.fadeInOutHeight.factor=1:(a>rh||a<-.35*rh)&&e.fadeInOutHeight.factor<1?this._setFadeInOutHeight(e,!1):a<rh&&a>-.35*rh&&e.fadeInOutHeight.factor>0?this._setFadeInOutHeight(e,!0):e.fadeInOutHeight.stage=nv.FINISHED,r.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(o*o-this.planetRadius*this.planetRadius,0))/o,wM(vie,r.anchorPointClouds,Dw),r.transform=Ae(),Wl(r.transform,r.transform,Dw[3],Dw),n){const{parallaxNew:l}=e;wM(vie,l.anchorPointClouds,Dw),l.transform=Ae(),Wl(l.transform,l.transform,Dw[3],Dw)}se(e.cameraPositionLastFrame,t)}};u([d({constructOnly:!0})],u1.prototype,"rctx",void 0),u([d({constructOnly:!0})],u1.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],u1.prototype,"planetRadius",void 0),u([d({constructOnly:!0})],u1.prototype,"requestRender",void 0),u1=u([P("esri.views.3d.environment.CloudsComposition")],u1);const vie=Fe(0,0,1),Dw=sE(),np=O(),q7e=O(),_ie=500,W7e=250,X7e=500,Y7e=500;function Z7e(e){return e.crossFade.enabled||e.fadeInOut.stage!==Gn.FINISHED||e.fadeIn.stage!==Ku.FINISHED||e.fadeInOutHeight.stage!==nv.FINISHED}function bie(e,t){return Tb(e.cameraPositionLastFrame,t)}const Q7e=new Us;function Ch(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[4],e[4]=t[5],e[5]=t[6],e[6]=t[8],e[7]=t[9],e[8]=t[10],e}function J7e(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function BX(e,t,i,r,s,n,o,a,l,c){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e[4]=n,e[5]=o,e[6]=a,e[7]=l,e[8]=c,e}function GX(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function Ah(e,t){if(e===t){const i=t[1],r=t[2],s=t[5];e[1]=t[3],e[2]=t[6],e[3]=i,e[5]=t[7],e[6]=r,e[7]=s}else e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8];return e}function ww(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l;let y=i*p+r*f+s*m;return y?(y=1/y,e[0]=p*y,e[1]=(-h*r+s*c)*y,e[2]=(a*r-s*o)*y,e[3]=f*y,e[4]=(h*i-s*l)*y,e[5]=(-a*i+s*n)*y,e[6]=m*y,e[7]=(-c*i+r*l)*y,e[8]=(o*i-r*n)*y,e):null}function K7e(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return e[0]=o*h-a*c,e[1]=s*c-r*h,e[2]=r*a-s*o,e[3]=a*l-n*h,e[4]=i*h-s*l,e[5]=s*n-i*a,e[6]=n*c-o*l,e[7]=r*l-i*c,e[8]=i*o-r*n,e}function eje(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8];return t*(c*n-o*l)+i*(-c*s+o*a)+r*(l*s-n*a)}function f5(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],m=i[1],y=i[2],v=i[3],w=i[4],b=i[5],S=i[6],T=i[7],E=i[8];return e[0]=f*r+m*o+y*c,e[1]=f*s+m*a+y*h,e[2]=f*n+m*l+y*p,e[3]=v*r+w*o+b*c,e[4]=v*s+w*a+b*h,e[5]=v*n+w*l+b*p,e[6]=S*r+T*o+E*c,e[7]=S*s+T*a+E*h,e[8]=S*n+T*l+E*p,e}function YN(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=i[0],m=i[1];return e[0]=r,e[1]=s,e[2]=n,e[3]=o,e[4]=a,e[5]=l,e[6]=f*r+m*o+c,e[7]=f*s+m*a+h,e[8]=f*n+m*l+p,e}function jX(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=t[4],l=t[5],c=t[6],h=t[7],p=t[8],f=Math.sin(i),m=Math.cos(i);return e[0]=m*r+f*o,e[1]=m*s+f*a,e[2]=m*n+f*l,e[3]=m*o-f*r,e[4]=m*a-f*s,e[5]=m*l-f*n,e[6]=c,e[7]=h,e[8]=p,e}function HX(e,t,i){const r=i[0],s=i[1],n=i[2];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e[6]=n*t[6],e[7]=n*t[7],e[8]=n*t[8],e}function tje(e,t,i){const r=i[0],s=i[1];return e[0]=r*t[0],e[1]=r*t[1],e[2]=r*t[2],e[3]=s*t[3],e[4]=s*t[4],e[5]=s*t[5],e}function ije(e,t){return e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=1,e[5]=0,e[6]=t[0],e[7]=t[1],e[8]=1,e}function rje(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=0,e[3]=-i,e[4]=r,e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function sje(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=0,e[4]=t[1],e[5]=0,e[6]=0,e[7]=0,e[8]=1,e}function nje(e,t){return e[0]=t[0],e[1]=t[1],e[2]=0,e[3]=t[2],e[4]=t[3],e[5]=0,e[6]=t[4],e[7]=t[5],e[8]=1,e}function m5(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=i+i,a=r+r,l=s+s,c=i*o,h=r*o,p=r*a,f=s*o,m=s*a,y=s*l,v=n*o,w=n*a,b=n*l;return e[0]=1-p-y,e[3]=h-b,e[6]=f+w,e[1]=h+b,e[4]=1-c-y,e[7]=m-v,e[2]=f-w,e[5]=m+v,e[8]=1-c-p,e}function cve(e,t){const i=t[0],r=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l,y=i*p+r*f+s*m;if(!y)return null;const v=1/y;return e[0]=p*v,e[1]=(-h*r+s*c)*v,e[2]=(a*r-s*o)*v,e[3]=f*v,e[4]=(h*i-s*l)*v,e[5]=(-a*i+s*n)*v,e[6]=m*v,e[7]=(-c*i+r*l)*v,e[8]=(o*i-r*n)*v,e}function u2(e,t){const i=t[0],r=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],y=t[12],v=t[13],w=t[14],b=t[15],S=i*a-r*o,T=i*l-s*o,E=i*c-n*o,C=r*l-s*a,M=r*c-n*a,I=s*c-n*l,N=h*v-p*y,D=h*w-f*y,z=h*b-m*y,V=p*w-f*v,k=p*b-m*v,Y=f*b-m*w;let Z=S*Y-T*k+E*V+C*z-M*D+I*N;return Z?(Z=1/Z,e[0]=(a*Y-l*k+c*V)*Z,e[1]=(l*z-o*Y-c*D)*Z,e[2]=(o*k-a*z+c*N)*Z,e[3]=(s*k-r*Y-n*V)*Z,e[4]=(i*Y-s*z+n*D)*Z,e[5]=(r*z-i*k-n*N)*Z,e[6]=(v*I-w*M+b*C)*Z,e[7]=(w*E-y*I-b*T)*Z,e[8]=(y*M-v*E+b*S)*Z,e):null}function oje(e,t,i){return e[0]=2/t,e[1]=0,e[2]=0,e[3]=0,e[4]=-2/i,e[5]=0,e[6]=-1,e[7]=1,e[8]=1,e}function aje(e){return"mat3("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+", "+e[4]+", "+e[5]+", "+e[6]+", "+e[7]+", "+e[8]+")"}function lje(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2+e[4]**2+e[5]**2+e[6]**2+e[7]**2+e[8]**2)}function cje(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e[4]=t[4]+i[4],e[5]=t[5]+i[5],e[6]=t[6]+i[6],e[7]=t[7]+i[7],e[8]=t[8]+i[8],e}function uve(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e[4]=t[4]-i[4],e[5]=t[5]-i[5],e[6]=t[6]-i[6],e[7]=t[7]-i[7],e[8]=t[8]-i[8],e}function uje(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*i,e}function hje(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e[4]=t[4]+i[4]*r,e[5]=t[5]+i[5]*r,e[6]=t[6]+i[6]*r,e[7]=t[7]+i[7]*r,e[8]=t[8]+i[8]*r,e}function dje(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]&&e[4]===t[4]&&e[5]===t[5]&&e[6]===t[6]&&e[7]===t[7]&&e[8]===t[8]}function pje(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=t[0],f=t[1],m=t[2],y=t[3],v=t[4],w=t[5],b=t[6],S=t[7],T=t[8];return Math.abs(i-p)<=Et*Math.max(1,Math.abs(i),Math.abs(p))&&Math.abs(r-f)<=Et*Math.max(1,Math.abs(r),Math.abs(f))&&Math.abs(s-m)<=Et*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(n-y)<=Et*Math.max(1,Math.abs(n),Math.abs(y))&&Math.abs(o-v)<=Et*Math.max(1,Math.abs(o),Math.abs(v))&&Math.abs(a-w)<=Et*Math.max(1,Math.abs(a),Math.abs(w))&&Math.abs(l-b)<=Et*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(c-S)<=Et*Math.max(1,Math.abs(c),Math.abs(S))&&Math.abs(h-T)<=Et*Math.max(1,Math.abs(h),Math.abs(T))}function qX(e){const t=Et,i=e[0],r=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return Math.abs(1-(i*i+n*n+l*l))<=t&&Math.abs(1-(r*r+o*o+c*c))<=t&&Math.abs(1-(s*s+a*a+h*h))<=t}const fje=f5,mje=uve;Object.freeze(Object.defineProperty({__proto__:null,fromMat4:Ch,copy:J7e,set:BX,identity:GX,transpose:Ah,invert:ww,adjoint:K7e,determinant:eje,multiply:f5,translate:YN,rotate:jX,scale:HX,scaleByVec2:tje,fromTranslation:ije,fromRotation:rje,fromScaling:sje,fromMat2d:nje,fromQuat:m5,normalFromMat4Legacy:cve,normalFromMat4:u2,projection:oje,str:aje,frob:lje,add:cje,subtract:uve,multiplyScalar:uje,multiplyScalarAndAdd:hje,exactEquals:dje,equals:pje,isOrthoNormal:qX,mul:fje,sub:mje},Symbol.toStringTag,{value:"Module"}));function WX(){return new Float32Array(2)}function gje(e){const t=new Float32Array(2);return t[0]=e[0],t[1]=e[1],t}function _a(e,t){const i=new Float32Array(2);return i[0]=e,i[1]=t,i}function yje(e,t){return new Float32Array(e,t,2)}function hve(){return WX()}function dve(){return _a(1,1)}function pve(){return _a(1,0)}function fve(){return _a(0,1)}const vje=hve(),_je=dve(),bje=pve(),wje=fve();Object.freeze(Object.defineProperty({__proto__:null,create:WX,clone:gje,fromValues:_a,createView:yje,zeros:hve,ones:dve,unitX:pve,unitY:fve,ZEROS:vje,ONES:_je,UNIT_X:bje,UNIT_Y:wje},Symbol.toStringTag,{value:"Module"}));var Ad;(function(e){e[e.SIXTEEN=0]="SIXTEEN",e[e.HUNDRED=1]="HUNDRED",e[e.TWOHUNDRED=2]="TWOHUNDRED",e[e.COUNT=3]="COUNT"})(Ad||(Ad={}));class mve extends Ra{constructor(){super(...arguments),this.steps=Ad.SIXTEEN}}u([G({count:Ad.COUNT})],mve.prototype,"steps",void 0);const sh=he("esri-mobile")?64:128,xje=sh/128,fd=Math.ceil(Math.sqrt(sh)),Td=(sh+2)*fd,Tje=1e5,M6=128,Sje=Td/1560;function zv(e,t=!0){e.attributes.add(A.POSITION,"vec2"),t&&e.varyings.add("uv","vec2"),e.vertex.code.add(x`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${t?x`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}class xM extends jr{constructor(t,i){super(t,"mat3",$i.Draw,(r,s,n)=>r.setUniformMatrix3fv(t,i(s,n)))}}class gve extends Us{constructor(){super(...arguments),this.viewMatrix=Sr()}}function Eje(e){const t=new Bi;return t.include(zv,!1),t.fragment.uniforms.add(new Pi("cloudRadius")),t.fragment.uniforms.add(new Pi("halfCubeMapSize")),t.fragment.uniforms.add(new Pi("power")),t.fragment.uniforms.add(new Pi("sigmaE")),t.fragment.uniforms.add(new Pi("density")),t.fragment.uniforms.add(new Pi("cloudSize")),t.fragment.uniforms.add(new Pi("detailSize")),t.fragment.uniforms.add(new Pi("smoothness")),t.fragment.uniforms.add(new Pi("cloudHeight")),t.fragment.uniforms.add(new Pi("coverage")),t.fragment.uniforms.add(new xM("view",i=>i.viewMatrix)),t.fragment.uniforms.add(new $r("cloudShapeTexture")),t.fragment.code.add(x`
    const int STEPS = ${e.steps===Ad.SIXTEEN?x`16`:e.steps===Ad.HUNDRED?x`100`:x`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),t.fragment.code.add(x`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${x.float(Td)};
      const float dataWidth = ${x.float(Td)};
      const float tileRows = ${x.float(fd)};
      const vec3 atlasDimensions = vec3(${x.float(sh)}, ${x.float(sh)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${x.float(xje)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture2D(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Non-power-of-two textures can't be tiled using WebGL1
      // Get fractional part of uv to tile
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = fract((${x.float(Sje)} * p) / ${x.float(Td)} + 0.5);

      return texture2D(cloudShapeTexture, uv).a;
    }
    `),t.fragment.code.add(x`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),t.fragment.code.add(x`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),t.fragment.code.add(`
    vec3 multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      vec3 luminance = vec3(0);

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),t.fragment.code.add(x`vec3 lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
vec3 beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),t.fragment.code.add(x`vec3 mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return vec3(0);
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
vec3 color = vec3(0.0);
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
vec3 luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
color += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return color;
}`),t.fragment.code.add(x`void main() {
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
if (hitsPlanet) {
gl_FragColor = vec4(vec3(0), 1);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
float totalTransmittance = 1.0;
vec3 sunDirection = normalize(vec3(0, 0, 1));
vec3 col = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance).rgb;
gl_FragColor = vec4(col, totalTransmittance);
}`),t}const Cje=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:gve,build:Eje},Symbol.toStringTag,{value:"Module"}));class FE{constructor(t,i,r,s,n,o,a,l,c=.5){this.coverage=t,this.density=i,this.absorption=r,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingStepType=l,this.median=c}}const yve={sunny:new FE([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],Ad.SIXTEEN),cloudy:new FE([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],Ad.TWOHUNDRED,.6),rainy:new FE([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],Ad.TWOHUNDRED,.4),snowy:new FE([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],Ad.HUNDRED,.65),foggy:new FE([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],Ad.SIXTEEN)};class g5 extends lr{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=g5.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:so(Re.ONE,Re.ONE,Re.ZERO,Re.ZERO),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}g5.shader=new Qi(Cje,()=>import("./Clouds.glsl.09e4e257.js"));var Xc;(function(e){e[e.Full=0]="Full",e[e.WeatherMap=1]="WeatherMap",e[e.COUNT=2]="COUNT"})(Xc||(Xc={}));class O7 extends Ra{constructor(){super(...arguments),this.mode=Xc.Full}}u([G({count:Xc.COUNT})],O7.prototype,"mode",void 0);function Aje(e){const t=new Bi;return t.include(zv,!1),t.fragment.code.add(x`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),t.fragment.uniforms.add(new ag("weatherTile")),e.mode===Xc.Full&&t.fragment.code.add(x`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${x.float(fd)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${x.float(8)});

      float worley0 = worley(p, ${x.float(2)} * 2.0);
      float worley1 = worley(p, ${x.float(2)} * 8.0);
      float worley2 = worley(p, ${x.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${x.float(2)});
      float worley1 = worley(p, ${x.float(2)} * 2.0);
      float worley2 = worley(p, ${x.float(2)} * 4.0);
      float worley3 = worley(p, ${x.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),t.fragment.code.add(x`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${x.float(M6)});

      // Get global coordinates of p
      p += weatherTile * ${x.float(M6)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${x.float(Tje)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),t.fragment.code.add(x`void main() {`),e.mode===Xc.Full&&t.fragment.code.add(x`
        float padWidth = 1.0;
        float paddedSize = ${x.float(sh)} + 2.0 * padWidth;
        float tileCount = ${x.float(fd)} * ${x.float(fd)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${x.float(sh)};
          }

          if (startPadY) {
            pixel.y += ${x.float(sh)};
          }

          if (endPadX) {
            pixel.x -= ${x.float(sh)};
          }

          if (endPadY) {
            pixel.y -= ${x.float(sh)};
          }

          uv = vec2(pixel.xy / ${x.float(sh)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${x.float(sh)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${x.float(fd)} * ${x.float(fd)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${x.float(fd)} * ${x.float(fd)});
        p = p_;
        p.z /= (${x.float(fd)} * ${x.float(fd)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        gl_FragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),t.fragment.code.add(x`
      vec2 mapUV = ${x.float(M6)} * (gl_FragCoord.xy / ${x.float(Td)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${e.mode===Xc.Full?x`gl_FragColor.ba = vec2(0.0, map);`:x`gl_FragColor = vec4(map);`};
    }
  `),t}const Rje=Object.freeze(Object.defineProperty({__proto__:null,build:Aje},Symbol.toStringTag,{value:"Module"}));class TM extends lr{initializeProgram(t){const i=TM.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:this.configuration.mode===Xc.Full?zf(Re.ONE,Re.ZERO):so(Re.ZERO,Re.ONE,Re.ONE,Re.ZERO),depthTest:{func:hr.ALWAYS},colorWrite:Jt})}}TM.shader=new Qi(Rje,()=>import("./NoiseTextureAtlas.glsl.348a6ff8.js"));class oT{constructor(t,i){this._context=t,this._desc=i,this.type="renderbuffer",this._context.instanceCounter.increment(dn.Renderbuffer,this);const r=this._context.gl;this.glName=r.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=i;if(a){if(this._context.type!==ai.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");r.renderbufferStorageMultisample(r.RENDERBUFFER,this.samples,o,s,n)}else r.renderbufferStorage(r.RENDERBUFFER,o,s,n)}get descriptor(){return this._desc}get samples(){const t=this._desc.samples,i=this._context.parameters.maxSamples;return t?Math.min(t,i):i}resize(t,i){const r=this._desc;if(r.width===t&&r.height===i)return;r.width=t,r.height=i;const s=this._context.gl;this._context.bindRenderbuffer(this),r.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,r.internalFormat,r.width,r.height):s.renderbufferStorage(s.RENDERBUFFER,r.internalFormat,r.width,r.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(dn.Renderbuffer,this),this._context=null)}}const Mje=me.getLogger("esri.views.webgl.FrameBufferObject");class xr{constructor(t,i,r=null,s=null){var n;if(this._context=t,this._glName=null,this._depthAttachment=null,this._stencilAttachment=null,this._colorAttachments=new Map,this._initialized=!1,this._desc=F({},i),t.instanceCounter.increment(dn.FramebufferObject,this),_(r)){Array.isArray(r)||(r=[r]);for(let o=0;o<r.length;++o){const a=r[o],l=Lc.COLOR_ATTACHMENT0+o;let c;xie(a)?(Cm(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new st(this._context,c))),OP(c,this._desc)):(wie(a)?(c=a.descriptor,this._colorAttachments.set(l,a)):(c=a,this._colorAttachments.set(l,new oT(this._context,c))),O6(c,this._desc)),this._validateColorAttachmentPoint(l)}}if(_(s)){let o,a;if(xie(s))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),Cm(s)?(a=s.descriptor,this._depthStencilTexture=s):(a=s,this._depthStencilTexture=new st(this._context,a)),OP(a,this._desc);else{wie(s)?(a=s.descriptor,o=s):(a=s,o=new oT(this._context,a));const l=(n=this._desc.depthStencilTarget)!=null?n:xi.DEPTH_STENCIL_RENDER_BUFFER;l===xi.STENCIL_RENDER_BUFFER?this._stencilAttachment=o:l===xi.DEPTH_RENDER_BUFFER||l===xi.DEPTH_STENCIL_RENDER_BUFFER?this._depthAttachment=o:console.error('If a Renderbuffer is provided, "depthStencilTarget" must be one of STENCIL_RENDER_BUFFER, DEPTH_RENDER_BUFFER or DEPTH_STENCIL_RENDER_BUFFER'),O6(a,this._desc)}}}dispose(){if(!this._desc)return;const t=this._context.getBoundFramebufferObject();this._disposeColorAttachments(),this._disposeDepthStencilAttachments(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(t),this._context.instanceCounter.decrement(dn.FramebufferObject,this),this._desc=null}get glName(){return this._glName}get descriptor(){return this._desc}get colorTexture(){const t=this._colorAttachments.get(Lc.COLOR_ATTACHMENT0);return t&&Cm(t)?t:null}get colorAttachment(){return this._colorAttachments.get(Lc.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthAttachment||this._stencilAttachment}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._desc.width}get height(){return this._desc.height}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((t,[i,r])=>t+Bb(r),0)+Bb(this.depthStencilAttachment)}getColorTexture(t){const i=this._colorAttachments.get(t);return i&&Cm(i)?i:null}attachColorTexture(t,i=Lc.COLOR_ATTACHMENT0){!t||(this._validateColorAttachmentPoint(i),OP(t.descriptor,this._desc),this._disposeColorAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,i)),this._colorAttachments.set(i,t))}detachColorTexture(t=Lc.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(t);if(Cm(i)){const r=i;return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)),this._colorAttachments.delete(t),r}}setColorTextureTarget(t,i=Lc.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(i);Cm(r)&&this._framebufferTexture2D(r.glName,i,t)}attachDepthStencilTexture(t){if(R(t))return;const i=t.descriptor;i.pixelFormat!==ze.DEPTH_STENCIL&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),i.dataType!==St.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),OP(i,this._desc),this._desc.depthStencilTarget&&this._desc.depthStencilTarget!==xi.DEPTH_STENCIL_TEXTURE&&(this._desc.depthStencilTarget=xi.DEPTH_STENCIL_TEXTURE),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(t.glName,sie)),this._depthStencilTexture=t}detachDepthStencilTexture(){const t=this._depthStencilTexture;return t&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,sie)),this._depthStencilTexture=null,t}attachDepthStencilBuffer(t){if(R(t))return;const i=t.descriptor;if(i.internalFormat!==va.DEPTH_STENCIL&&i.internalFormat!==va.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),O6(i,this._desc),this._disposeDepthStencilAttachments(),this._desc.depthStencilTarget=i.internalFormat===va.DEPTH_STENCIL?xi.DEPTH_STENCIL_RENDER_BUFFER:xi.DEPTH_RENDER_BUFFER,this._initialized){this._context.bindFramebuffer(this);const r=this._context.gl,s=this._desc.depthStencilTarget===xi.DEPTH_RENDER_BUFFER?r.DEPTH_ATTACHMENT:r.DEPTH_STENCIL_ATTACHMENT;r.framebufferRenderbuffer(Tn.FRAMEBUFFER,s,r.RENDERBUFFER,t.glName)}this._depthAttachment=t}detachDepthStencilBuffer(){const t=this._context.gl,i=this._depthAttachment;if(i&&this._initialized){this._context.bindFramebuffer(this);const r=this._desc.depthStencilTarget===xi.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(Tn.FRAMEBUFFER,r,t.RENDERBUFFER,null)}return this._depthAttachment=null,i}detachAll(){this._colorAttachments.forEach((t,i)=>this._detachColorAttachment(i)),this.detachDepthStencilBuffer(),this.detachDepthStencilTexture()}copyToTexture(t,i,r,s,n,o,a){(t<0||i<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=this._desc,c=a.descriptor;a.descriptor.target!==pt.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(t+r>l.width||i+s>l.height||n+r>c.width||o+s>c.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const h=this._context,p=h.bindTexture(a,st.TEXTURE_UNIT_FOR_UPDATES);h.setActiveTexture(st.TEXTURE_UNIT_FOR_UPDATES),h.bindFramebuffer(this),h.gl.copyTexSubImage2D(pt.TEXTURE_2D,0,n,o,t,i,r,s),h.bindTexture(p,st.TEXTURE_UNIT_FOR_UPDATES)}readPixels(t,i,r,s,n,o,a){(r<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(t,i,r,s,n,o,a)}async readPixelsAsync(t,i,r,s,n,o,a){if(this._context.type!==ai.WEBGL2)return Ju()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(t,i,r,s,n,o,a);const l=this._context.gl,c=ti.createPixelPack(this._context,yi.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(t,i,r,s,n,o,0),this._context.unbindBuffer(bt.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(t,i){const r=this._desc;if(r.width!==t||r.height!==i){if(!this._initialized)return r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),void(this._depthStencilTexture&&this._depthStencilTexture.resize(t,i));r.width=t,r.height=i,this._colorAttachments.forEach(s=>{s&&s.resize(t,i)}),this._depthStencilTexture!=null?this._depthStencilTexture.resize(t,i):(this._depthAttachment||this._stencilAttachment)&&(this._depthAttachment&&this._depthAttachment.resize(t,i),this._stencilAttachment&&this._stencilAttachment.resize(t,i)),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1}}initializeAndBind(t=Tn.FRAMEBUFFER){var h,p,f,m;const i=this._context.gl;if(this._initialized)return void i.bindFramebuffer(t,this.glName);this._glName&&i.deleteFramebuffer(this._glName);const r=this._context,s=i.createFramebuffer(),n=this._desc,o=(h=n.colorTarget)!=null?h:Zr.RENDER_BUFFER,a=(p=n.width)!=null?p:1,l=(f=n.height)!=null?f:1;if(i.bindFramebuffer(t,s),this._colorAttachments.size===0)if(o===Zr.TEXTURE||o===Zr.CUBEMAP)this._colorAttachments.set(Lc.COLOR_ATTACHMENT0,Oje(r,n,this.descriptor.colorTarget===Zr.CUBEMAP?pt.TEXTURE_CUBE_MAP:pt.TEXTURE_2D));else{const y=new oT(r,{internalFormat:ft.RGBA4,width:a,height:l});this._colorAttachments.set(Lc.COLOR_ATTACHMENT0,y)}this._colorAttachments.forEach((y,v)=>{y&&(Cm(y)?this._framebufferTexture2D(y.glName,v,Tie(y),t):i.framebufferRenderbuffer(t,v,i.RENDERBUFFER,y.glName))});const c=(m=n.depthStencilTarget)!=null?m:xi.NONE;switch(c){case xi.DEPTH_RENDER_BUFFER:case xi.DEPTH_STENCIL_RENDER_BUFFER:{this._depthAttachment||(this._depthAttachment=new oT(r,{internalFormat:n.depthStencilTarget===xi.DEPTH_RENDER_BUFFER?va.DEPTH_COMPONENT16:va.DEPTH_STENCIL,width:a,height:l}));const y=c===xi.DEPTH_RENDER_BUFFER?i.DEPTH_ATTACHMENT:i.DEPTH_STENCIL_ATTACHMENT;i.framebufferRenderbuffer(t,y,i.RENDERBUFFER,this._depthAttachment.glName);break}case xi.STENCIL_RENDER_BUFFER:this._stencilAttachment||(this._stencilAttachment=new oT(r,{internalFormat:va.STENCIL_INDEX8,width:a,height:l})),i.framebufferRenderbuffer(t,i.STENCIL_ATTACHMENT,i.RENDERBUFFER,this._stencilAttachment.glName);break;case xi.DEPTH_STENCIL_TEXTURE:if(!this._depthStencilTexture){r.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture as an attachment!");const y={target:pt.TEXTURE_2D,pixelFormat:ze.DEPTH_STENCIL,dataType:St.UNSIGNED_INT_24_8,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,width:a,height:l};this._depthStencilTexture=new st(r,y)}this._framebufferTexture2D(this._depthStencilTexture.glName,i.DEPTH_STENCIL_ATTACHMENT,Tie(this._depthStencilTexture),t)}vM()&&i.checkFramebufferStatus(t)!==i.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=s,this._initialized=!0}_framebufferTexture2D(t,i=Lc.COLOR_ATTACHMENT0,r=pt.TEXTURE_2D,s=Tn.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,i,r,t,n)}_detachColorAttachment(t){Ju()&&console.warn("Detaching an FBO attachment can be a slow due to invalidating framebuffer completeness!");const i=this._context.gl,r=this._colorAttachments.get(t);return Cm(r)?this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t)):this._initialized&&(this._context.bindFramebuffer(this),i.framebufferRenderbuffer(Tn.FRAMEBUFFER,t,i.RENDERBUFFER,null)),this._colorAttachments.delete(t),r}_disposeColorAttachments(){this._colorAttachments.forEach((t,i)=>{this._detachColorAttachment(i),t.dispose()}),this._colorAttachments.clear()}_disposeDepthStencilAttachments(){const t=this._context.gl;if(this._depthAttachment){if(this._initialized){this._context.bindFramebuffer(this);const i=this._desc.depthStencilTarget===xi.DEPTH_RENDER_BUFFER?t.DEPTH_ATTACHMENT:t.DEPTH_STENCIL_ATTACHMENT;t.framebufferRenderbuffer(Tn.FRAMEBUFFER,i,t.RENDERBUFFER,null)}this._depthAttachment.dispose(),this._depthAttachment=null}this._stencilAttachment&&(this._initialized&&(this._context.bindFramebuffer(this),t.framebufferRenderbuffer(Tn.FRAMEBUFFER,t.STENCIL_ATTACHMENT,t.RENDERBUFFER,null)),this._stencilAttachment.dispose(),this._stencilAttachment=null),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,t.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture.dispose(),this._depthStencilTexture=null)}_validateColorAttachmentPoint(t){if(xr._MAX_COLOR_ATTACHMENTS===-1){const r=this._context.capabilities.drawBuffers;if(r){const s=this._context.gl;xr._MAX_COLOR_ATTACHMENTS=s.getParameter(r.MAX_COLOR_ATTACHMENTS)}else xr._MAX_COLOR_ATTACHMENTS=1}const i=t-Lc.COLOR_ATTACHMENT0;i+1>xr._MAX_COLOR_ATTACHMENTS&&Mje.error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${i+1}. Implementation supports up to ${xr._MAX_COLOR_ATTACHMENTS} color attachments`)}}function Cm(e){return"type"in e&&e.type==="texture"}function wie(e){return"type"in e&&e.type==="renderbuffer"}function xie(e){return Cm(e)||"pixelFormat"in e}function Oje(e,t,i){return new st(e,{target:i,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,width:t.width,height:t.height})}function OP(e,t){e.target!==pt.TEXTURE_2D&&e.target!==pt.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Color attachment texture must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function O6(e,t){t.width!==void 0&&t.width>=0&&t.height!==void 0&&t.height>=0?t.width===e.width&&t.height===e.height||console.error("Renderbuffer dimensions must match the framebuffer's!"):(t.width=e.width,t.height=e.height)}function Tie(e){return e.descriptor.target===pt.TEXTURE_CUBE_MAP?pt.TEXTURE_CUBE_MAP_POSITIVE_X:pt.TEXTURE_2D}xr._MAX_COLOR_ATTACHMENTS=-1;class vve extends Ee{constructor(t){let i;super(t),this._weatherTile=_a(0,0),this._needsRender=!0,this._frameBuffer=new xr(t.context.renderContext.rctx,{colorTarget:Zr.TEXTURE,width:Td,height:Td},{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,hasMipmap:!1,width:Td,height:Td}),this._vao=Ma(t.context.renderContext.rctx),this._shaderTechniqueRepository=t.context.shaderTechniqueRepository,this._ensureRendered=()=>(_(i)?_(this.weatherMapTechnique)&&this.weatherMapTechnique.compiled&&this._needsRender&&(i=this._render(t.context.renderContext.rctx,Xc.WeatherMap)):_(this.fullTechnique)&&this.fullTechnique.compiled&&(i=this._render(t.context.renderContext.rctx,Xc.Full)),i)}get textureAtlas(){return this._ensureRendered()}_setDirty(){this._needsRender=!0}updateWeatherMap(t){this._weatherTile[0]===t[0]&&this._weatherTile[1]===t[1]||(this._weatherTile=t,this._setDirty())}destroy(){this._fullTechnique=Wi(this._fullTechnique),this._weatherMapTechnique=Wi(this._weatherMapTechnique),this._frameBuffer=Ye(this._frameBuffer),this._vao=Ye(this._vao)}get fullTechnique(){if(R(this._fullTechnique)){const t=new O7;t.mode=Xc.Full,this._fullTechnique=this._shaderTechniqueRepository.acquire(TM,t)}return this._fullTechnique}get weatherMapTechnique(){if(R(this._weatherMapTechnique)){const t=new O7;t.mode=Xc.WeatherMap,this._weatherMapTechnique=this._shaderTechniqueRepository.acquire(TM,t)}return this._weatherMapTechnique}_render(t,i){if(R(this._vao)||R(this._frameBuffer))return null;const r=i===Xc.Full?this.fullTechnique:this.weatherMapTechnique;if(R(r))return null;const s=t.getViewport();t.setViewport(0,0,Td,Td),t.bindFramebuffer(this._frameBuffer);const n=t.bindTechnique(r);return n.setUniform2f("weatherTile",this._weatherTile[0],this._weatherTile[1]),t.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),t.gl.drawArrays(t.gl.TRIANGLE_STRIP,0,4),t.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._frameBuffer.colorTexture}}u([d({constructOnly:!0})],vve.prototype,"context",void 0);function _ve(e){e.include(gu),e.uniforms.add([new zt("geometryDepthTexture",(t,i)=>i.multipassGeometry.linearDepthTexture),new di("nearFar",(t,i)=>i.camera.nearFar)]),e.code.add(x`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}class Pje{constructor(){this.enabled=!1}}function yu(e,t){t.hasMultipassTerrain&&(e.fragment.include(gu),e.fragment.uniforms.add(new zt("terrainDepthTexture",(i,r)=>r.multipassTerrain.linearDepthTexture)),e.fragment.uniforms.add(new di("nearFar",(i,r)=>r.camera.nearFar)),e.fragment.uniforms.add(new di("inverseViewport",(i,r)=>r.inverseViewport)),e.fragment.code.add(x`
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){
      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${t.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `))}class Ije{constructor(){this.enabled=!1,this.cullAboveGround=!1}}function $je(e,t){const i=e.fragment.uniforms;i.add(new di("nearFar",(r,s)=>s.camera.nearFar)),i.add(new zt("depthMap",(r,s)=>s.linearDepthTexture)),i.add(new vr("view",(r,s)=>s.ssr.camera.viewMatrix)),i.add(new vr("proj",(r,s)=>s.ssr.camera.projectionMatrix)),i.add(new We("invResolutionHeight",(r,s)=>1/s.ssr.camera.height)),i.add(new zt("lastFrameColorMap",(r,s)=>s.ssr.lastFrameColorTexture)),i.add(new vr("reprojectionMatrix",(r,s)=>s.ssr.reprojectionMatrix)),e.fragment.include(gu),e.fragment.code.add(x`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${t.highStepCount?"150;":"75;"}

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}class Dje{constructor(){this.reprojectionMatrix=Ae()}}var Se;(function(e){e[e.INTEGRATED_MESH=0]="INTEGRATED_MESH",e[e.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",e[e.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",e[e.TRANSPARENT_MATERIAL=3]="TRANSPARENT_MATERIAL",e[e.TRANSPARENT_TERRAIN=4]="TRANSPARENT_TERRAIN",e[e.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=5]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",e[e.OCCLUDED_TERRAIN=6]="OCCLUDED_TERRAIN",e[e.OCCLUDER_MATERIAL=7]="OCCLUDER_MATERIAL",e[e.TRANSPARENT_OCCLUDER_MATERIAL=8]="TRANSPARENT_OCCLUDER_MATERIAL",e[e.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",e[e.POSTPROCESSING_ENVIRONMENT_OPAQUE=10]="POSTPROCESSING_ENVIRONMENT_OPAQUE",e[e.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=11]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",e[e.LASERLINES=12]="LASERLINES",e[e.LASERLINES_CONTRAST_CONTROL=13]="LASERLINES_CONTRAST_CONTROL",e[e.HUD_MATERIAL=14]="HUD_MATERIAL",e[e.LABEL_MATERIAL=15]="LABEL_MATERIAL",e[e.LINE_CALLOUTS=16]="LINE_CALLOUTS",e[e.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",e[e.DRAPED_MATERIAL=18]="DRAPED_MATERIAL",e[e.DRAPED_WATER=19]="DRAPED_WATER",e[e.VOXEL=20]="VOXEL",e[e.MAX_SLOTS=21]="MAX_SLOTS"})(Se||(Se={}));class XX{constructor(t=O()){this.intensity=t}}class bve{constructor(t=O(),i=Fe(.57735,.57735,.57735)){this.intensity=t,this.direction=i}}class P7{constructor(t=O(),i=Fe(.57735,.57735,.57735),r=!0,s=1,n=1){this.intensity=t,this.direction=i,this.castShadows=r,this.specularStrength=s,this.environmentStrength=n}}class wve{constructor(){this.r=[0],this.g=[0],this.b=[0]}}function Lje(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t[r];return i}function P6(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]*t;return i}function aS(e,t,i){(i=i||e).length=e.length;for(let r=0;r<e.length;r++)i[r]=e[r]+t[r];return i}function xve(e){return(e+1)*(e+1)}function Nje(e){return $e(Math.floor(Math.sqrt(e)-1),0,2)}function Tve(e,t,i){const r=e[0],s=e[1],n=e[2],o=i||[];return o.length=xve(t),t>=0&&(o[0]=.28209479177),t>=1&&(o[1]=.4886025119*r,o[2]=.4886025119*n,o[3]=.4886025119*s),t>=2&&(o[4]=1.09254843059*r*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*r*n,o[8]=.54627421529*(r*r-s*s)),o}function Fje(e,t){const i=xve(e),r=t||{r:[],g:[],b:[]};r.r.length=r.g.length=r.b.length=i;for(let s=0;s<i;s++)r.r[s]=r.g[s]=r.b[s]=0;return r}function Uje(e,t){const i=Nje(t.r.length);for(const r of e)qo(I7,r.direction),Tve(I7,i,Xm),Lje(Xm,jD),P6(Xm,r.intensity[0],Lw),aS(t.r,Lw),P6(Xm,r.intensity[1],Lw),aS(t.g,Lw),P6(Xm,r.intensity[2],Lw),aS(t.b,Lw);return t}function kje(e,t){Tve(I7,0,Xm);for(const i of e)t.r[0]+=Xm[0]*jD[0]*i.intensity[0]*4*Math.PI,t.g[0]+=Xm[0]*jD[0]*i.intensity[1]*4*Math.PI,t.b[0]+=Xm[0]*jD[0]*i.intensity[2]*4*Math.PI;return t}function zje(e,t,i,r){Fje(t,r),ie(i.intensity,0,0,0);let s=!1;const n=Vje,o=Bje,a=Gje;n.length=0,o.length=0,a.length=0;for(const l of e)l instanceof P7&&!s?(se(i.direction,l.direction),se(i.intensity,l.intensity),i.specularStrength=l.specularStrength,i.environmentStrength=l.environmentStrength,i.castShadows=l.castShadows,s=!0):l instanceof P7||l instanceof bve?n.push(l):l instanceof XX?o.push(l):l instanceof wve&&a.push(l);Uje(n,r),kje(o,r);for(const l of a)aS(r.r,l.r),aS(r.g,l.g),aS(r.b,l.b)}const Vje=[],Bje=[],Gje=[],Xm=[0],Lw=[0],I7=O(),jD=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398],nE=.4;class jje{constructor(){this._shOrder=2,this._oldSunlight={direction:O(),ambient:{color:O(),intensity:1},diffuse:{color:O(),intensity:1}},this.globalFactor=.5,this.groundLightingFactor=.5,this._sphericalHarmonics=new wve,this._mainLight={intensity:O(),direction:Fe(1,0,0),castShadows:!1,specularStrength:1,environmentStrength:1}}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}get lightingMainDirection(){return this._mainLight.direction}set(t){zje(t,this._shOrder,this._mainLight,this._sphericalHarmonics),se(this._oldSunlight.direction,this._mainLight.direction);const i=1/Math.PI;this._oldSunlight.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*i,this._oldSunlight.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*i,this._oldSunlight.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*i,oe(this._oldSunlight.diffuse.color,this._mainLight.intensity,i),se(PP,this._oldSunlight.diffuse.color),oe(PP,PP,nE*this.globalFactor),de(this._oldSunlight.ambient.color,this._oldSunlight.ambient.color,PP)}get old(){return this._oldSunlight}}const PP=O();class y5{constructor(t,i,r){this.shadowMap=t,this.ssaoHelper=i,this.slicePlane=r,this.slot=Se.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this._inverseViewport=tt(),this.lighting=new jje,this.ssr=new Dje,this.multipassTerrain=new Ije,this.multipassGeometry=new Pje,this.clouds=new I7e,this.overlays=[]}get camera(){return this._camera}set camera(t){this._camera=this.ssr.camera=t,this._inverseViewport[0]=1/t.fullViewport[2],this._inverseViewport[1]=1/t.fullViewport[3]}get inverseViewport(){return this._inverseViewport}}let aa=class extends Ee{constructor(e){super(e),this._frameTask=null,this._handles=new qt,this._cubeMapSize=he("esri-mobile")?1024:2048,this._techniques=[],this._techniqueConfiguration=new mve,this._bindParameters=new y5(null,null,null),this._drawParameters=new gve,this._weatherTile=_a(0,0),this._weatherTileCount=128,this.coverage=jt(Pa.coverage[0],Pa.coverage[1],.5),this.density=jt(Pa.density[0],Pa.density[1],.5),this.absorption=jt(Pa.absorption[0],Pa.absorption[1],.5),this.cloudSize=jt(Pa.cloudSize[0],Pa.cloudSize[1],.5),this.detailSize=jt(Pa.detailSize[0],Pa.detailSize[1],.5),this.smoothness=jt(Pa.smoothness[0],Pa.smoothness[1],.5),this.cloudHeight=jt(Pa.cloudHeight[0],Pa.cloudHeight[1],.5),this.raymarchingStepType=Pa.raymarchingStepType,this._cloudRadius=0,this._viewMatrix=Ae(),this._cameraPositionLastFrame=O(),this.running=!1}_getTechnique(e){return this._techniques[e]||(this._techniqueConfiguration.steps=e,this._techniques[e]=new g5({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[e])}_getWeatherTile(){const e=this.view.camera.position.latitude,t=this.view.camera.position.longitude;let i=_a((e+90)/180,(t+180)/360);const r=Math.floor(this._weatherTileCount*Math.abs(2*i[0]-1));i=_a(Math.floor(2*this._weatherTileCount*i[0]),Math.floor(4*(this._weatherTileCount-r)*i[1]));let s=0,n=0;if(_(this.view.environment)&&this.view.environment.lighting.type==="sun"&&_(this.view.environment.lighting.date)){const o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+this.view.environment.lighting.displayUTCOffset),s=31*o.getUTCMonth()+o.getUTCDate(),n=o.getUTCFullYear()}return i[0]=(i[0]+s)%(2*this._weatherTileCount),i[1]=(i[1]+n%100)%(4*this._weatherTileCount),i}initialize(){this._vao=Ma(this.context.renderContext.rctx);const e=vi(this.view.spatialReference);this._cloudRadius=.5*e.radius,this.setDirty(),this._weatherTile=this._getWeatherTile(),this._frameTask=this.view.resourceController.scheduler.registerTask(mt.CLOUDS_GENERATOR,this),this._handles.add(this._frameTask),this._handles.add(ae(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingStepType],()=>this.setDirty(),Ft))}destroy(){this._handles.destroy(),this._techniques.forEach(e=>Wi(e)),this._techniques=null,this._frameBufferCube=Ye(this._frameBufferCube),this._vao=Ye(this._vao),this._noiseTexture=ot(this._noiseTexture)}_ensureNoiseTexture(){if(R(this._noiseTexture)){const e=this.context;this._noiseTexture=new vve({context:e}),this._noiseTexture.updateWeatherMap(this._weatherTile)}return this._noiseTexture.textureAtlas}ensureWeatherTile(){const e=this._getWeatherTile();_(this._noiseTexture)&&_(this.context)&&this._noiseTexture.updateWeatherMap(e),e[0]===this._weatherTile[0]&&e[1]===this._weatherTile[1]||(this._weatherTile=e,this.setDirty())}get frameBufferCube(){if(R(this._frameBufferCube)){const e={target:pt.TEXTURE_CUBE_MAP,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,hasMipmap:!1,width:this._cubeMapSize,height:this._cubeMapSize};this._frameBufferCube=new xr(this.context.renderContext.rctx,{colorTarget:Zr.CUBEMAP,width:this._cubeMapSize,height:this._cubeMapSize},e)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}isFading(e){return e.crossFade.enabled||e.fadeInOut.stage===Gn.FADE_OUT||e.fadeInOutHeight.stage!==nv.FINISHED}applyPreset(e,t){const i=e.median,r=s=>{const n=jt(s[0],s[1],i);return t<.5?jt(s[0],n,2*t):jt(n,s[1],2*(t-.5))};this.coverage=r(e.coverage),this.density=r(e.density),this.absorption=r(e.absorption),this.cloudSize=r(e.cloudSize),this.detailSize=r(e.detailSize),this.smoothness=r(e.smoothness),this.cloudHeight=r(e.cloudHeight),this.raymarchingStepType=e.raymarchingStepType}setDirty(){this.running=!0}runTask(e){if(this.coverage===0||R(this._vao))return void(this.running=!1);const t=this._getTechnique(this.raymarchingStepType);if(!t.compiled)return;if(!Tb(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye)||this.isFading(this.context.renderContext.bindParameters.clouds))return void se(this._cameraPositionLastFrame,this.context.renderContext.bindParameters.camera.eye);this.ensureWeatherTile();const i=this._ensureNoiseTexture();if(R(i))return;const r=this.context.renderContext.rctx,s=r.bindTechnique(t),n=1+this.absorption,o=jt(35,120,this.absorption);s.bindTexture("cloudShapeTexture",i),s.setUniform1f("cloudRadius",this._cloudRadius),s.setUniform1f("halfCubeMapSize",.5*this._cubeMapSize),s.setUniform1f("power",o),s.setUniform1f("sigmaE",n),s.setUniform1f("density",jt(0,.3,this.density)),s.setUniform1f("cloudSize",jt(0,.02,Math.max(.01,1-this.cloudSize))),s.setUniform1f("detailSize",jt(0,.2,Math.max(.01,1-this.detailSize))),s.setUniform1f("smoothness",jt(0,.5,1-this.smoothness)),s.setUniform1f("cloudHeight",jt(0,1500,this.cloudHeight)),s.setUniform1f("coverage",this.coverage),r.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const a=r.getViewport();r.setViewport(0,0,this._cubeMapSize,this._cubeMapSize),r.bindFramebuffer(this.frameBufferCube);for(let l=0;l<5;l++){const c=Hje[l],h=qje[l];wde(this._viewMatrix,Wje,c,h),Ch(this._drawParameters.viewMatrix,this._viewMatrix);const p=pt.TEXTURE_CUBE_MAP_POSITIVE_X+l;this.frameBufferCube.setColorTextureTarget(p),s.bindDraw(this._drawParameters,this._bindParameters),r.gl.drawArrays(r.gl.TRIANGLE_STRIP,0,4),r.gl.flush()}this.running=!1,r.setViewport(a.x,a.y,a.width,a.height),this.requestRender(),e.madeProgress()}};u([d({constructOnly:!0})],aa.prototype,"context",void 0),u([d({constructOnly:!0})],aa.prototype,"view",void 0),u([d({constructOnly:!0})],aa.prototype,"requestRender",void 0),u([d()],aa.prototype,"_frameTask",void 0),u([d()],aa.prototype,"coverage",void 0),u([d()],aa.prototype,"density",void 0),u([d()],aa.prototype,"absorption",void 0),u([d()],aa.prototype,"cloudSize",void 0),u([d()],aa.prototype,"detailSize",void 0),u([d()],aa.prototype,"smoothness",void 0),u([d()],aa.prototype,"cloudHeight",void 0),u([d()],aa.prototype,"raymarchingStepType",void 0),u([d()],aa.prototype,"running",void 0),aa=u([P("esri.views.3d.environment.CloudsGenerator")],aa);const Hje=[Ai(1,0,0),Ai(-1,0,0),Ai(0,1,0),Ai(0,-1,0),Ai(0,0,1)],qje=[Ai(0,1,0),Ai(0,1,0),Ai(0,0,-1),Ai(0,0,1),Ai(0,1,0)],Wje=DX(),Pa=yve.sunny;function Xje(e){const t=new Bi;t.attributes.add(A.POSITION,"vec2"),t.include(og,{textureCoordinateType:Zs.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:i,fragment:r}=t;return i.uniforms.add([new vr("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new vr("inverseViewMatrix",(s,n)=>cs(Yje,n.camera.viewMatrix))]),i.code.add(x`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Pi("atmosphereC")),r.uniforms.add(new rl("cameraPosition")),r.uniforms.add(new di("nearFar",(s,n)=>n.camera.nearFar)),r.uniforms.add(new $r("depthTex")),r.uniforms.add(new Pi("fogStrength")),r.uniforms.add(new Pi("fogAmount")),r.uniforms.add(new rl("fogColor")),t.include(u5),r.include(gu),r.code.add(x`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(x`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),r.code.add(x`
    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;

      float depthSample = texture2D(depthTex, vuv0).r;
      float zNorm = 2.0 * depthSample - 1.0;
      float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
      if(depthSample < 1.0 && depthSample > 0.0){
        vec3 cameraSpaceRay = normalize(eyeDir);
        cameraSpaceRay /= cameraSpaceRay.z;
        cameraSpaceRay *= linDepth;
        terrainDepth = max(0.0, length(cameraSpaceRay));
      }

      ${e.haze?x`
          if(terrainDepth == -1.0){
            gl_FragColor = vec4(0);
            return;
          }`:""}

      vec4 fog = applyFog(terrainDepth, rayDir);

      gl_FragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
    }
  `),t}const Yje=Ae(),Zje=Object.freeze(Object.defineProperty({__proto__:null,build:Xje},Symbol.toStringTag,{value:"Module"}));class SM extends lr{initializeProgram(t){const i=SM.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return this.configuration.haze?Ut({blending:so(Re.ONE,Re.ZERO,Re.ONE_MINUS_SRC_COLOR,Re.ONE),colorWrite:Jt}):Ut({blending:so(Re.SRC_ALPHA,Re.ZERO,Re.ONE_MINUS_SRC_ALPHA,Re.ONE),colorWrite:Jt})}}SM.shader=new Qi(Zje,()=>import("./Fog.glsl.c9753833.js"));class $7 extends Ra{constructor(){super(...arguments),this.haze=!1}}u([G()],$7.prototype,"haze",void 0);let MA=class extends Ee{constructor(e){super(e),this._fogColor=wi(),this._fogColorAtNight=wi(),this._cameraDirection=wi(),this._foggyFadeStart=.95,this._foggyFadeEnd=1,this._hazeFadeStart=.7,this._hazeFadeEnd=1,this._strength=4e-6;const t=e.context.renderContext.rctx;this._vao=Ma(t,VO);const i=vi(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+zD}destroy(){this._hazeFogTechnique=Wi(this._hazeFogTechnique),this._thickFogTechnique=Wi(this._thickFogTechnique),this._vao=Ye(this._vao)}get _shaderTechniqueRepository(){return this.context.shaderTechniqueRepository}set strength(e){this._strength=e}get strength(){return this._strength}get thickFogTechnique(){if(R(this._thickFogTechnique)){const e=new $7;e.haze=!1,this._thickFogTechnique=this._shaderTechniqueRepository.acquire(SM,e)}return this._thickFogTechnique}get hazeFogTechnique(){if(R(this._hazeFogTechnique)){const e=new $7;e.haze=!0,this._hazeFogTechnique=this._shaderTechniqueRepository.acquire(SM,e)}return this._hazeFogTechnique}when(){return Promise.resolve()}render(e,t,i){if(this.view.basemapTerrain.baseOpacity===0&&!t||(this._update(e,t,i),this._fogAmount<=0))return;const r=t?this.thickFogTechnique:this.hazeFogTechnique;if(!r.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper,n=e.rctx.bindTechnique(r,Qje,e.bindParameters);s.renderDepthDetached(()=>{n.bindTexture("depthTex",s.depthTexture),this._renderFog(r.program,e)})}_renderFog(e,t){if(R(this._vao))return!1;const i=t.rctx,r=t.bindParameters.camera;return e.setUniform3fv("cameraPosition",r.eye),e.setUniform1f("atmosphereC",this._atmosphereC),e.setUniform1f("fogStrength",this._strength),e.setUniform1f("fogAmount",this._fogAmount),e.setUniform3fv("fogColor",this._fogColor),i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Pt.TRIANGLE_STRIP,0,4),!0}_update(e,t,i){const r=e.bindParameters.camera,s=t?.1:0;i?ie(this._fogColor,.5,.5,.5):t?ie(this._fogColor,1.5,1.5,1.5):ie(this._fogColor,.24,.44,.8),oe(this._fogColorAtNight,this._fogColor,s),we(this._cameraDirection,r.eye);const n=Math.max(0,xe(this._cameraDirection,e.bindParameters.lighting.lightingMainDirection));en(this._fogColor,this._fogColorAtNight,this._fogColor,n);const o=Me(r.eye),a=o*o;this._atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._fogAmount=t?1-TS(this._foggyFadeStart*rh,this._foggyFadeEnd*rh,Math.abs(o-this._planetRadius)):1-TS(this._hazeFadeStart*rh,this._hazeFadeEnd*rh,Math.abs(o-this._planetRadius))}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],MA.prototype,"context",void 0),u([d({constructOnly:!0})],MA.prototype,"view",void 0),MA=u([P("esri.views.3d.environment.Fog")],MA);const Qje=new Us;async function Qd(e,t){const{data:i}=await ur(e,F({responseType:"image"},t));return i}var Rf;(function(e){e[e.Cone=0]="Cone",e[e.Cylinder=1]="Cylinder",e[e.Underground=2]="Underground",e[e.COUNT=3]="COUNT"})(Rf||(Rf={}));class ZN extends Ra{constructor(){super(...arguments),this.geometry=Rf.Cone}}u([G({count:Rf.COUNT})],ZN.prototype,"geometry",void 0);function To(e,t={hasModelTransformation:!1,linearDepth:!1}){if(t.hasModelTransformation)return t.linearDepth?void e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, mat4 model, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * (model * vec4(pos, 1.0));
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):void e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, mat4 model, vec3 pos) {
return proj * (view * (model * vec4(pos, 1.0)));
}`);t.linearDepth?e.vertex.code.add(x`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = (-eye.z - nearFar[0]) / (nearFar[1] - nearFar[0]) ;
return proj * eye;
}`):e.vertex.code.add(x`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}class vv extends jr{constructor(t){super(t,"mat4")}}class YX extends Us{}function Jje(e){const t=new Bi,{vertex:i,fragment:r}=t;if(e.geometry===Rf.Underground)t.attributes.add(A.POSITION,"vec2"),t.varyings.add("color","vec4"),i.uniforms.add([new xt("lightingMainDirection",(s,n)=>n.lighting.lightingMainDirection),new rl("cameraPosition"),new Pi("undergroundFadeAlpha")]),i.code.add(x`void main(void) {
float ndotl = dot(normalize(cameraPosition), lightingMainDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),r.code.add(x`void main() {
gl_FragColor = color;
}`);else{t.include(To),t.attributes.add(A.POSITION,"vec3"),t.varyings.add("vtc","vec2"),t.varyings.add("falloff","float");const s=e.geometry===Rf.Cylinder;i.uniforms.add([new vr("proj",(a,l)=>l.camera.projectionMatrix),new vv("view"),new xt("lightingMainDirection",(a,l)=>l.lighting.lightingMainDirection)]),s||(t.varyings.add("innerFactor","float"),i.uniforms.add(new rl("silCircleCenter")),i.uniforms.add(new rl("silCircleV1")),i.uniforms.add(new rl("silCircleV2")),i.uniforms.add(new ag("texV")),i.uniforms.add(new Pi("innerScale")));const n=6.2831853,o=1/128;i.code.add(x`
		void main(void) {
      ${s?x`
      vec3 pos = position;
      float ndotl = lightingMainDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:x`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${x.float(n*o)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), lightingMainDirection);
      vtc.x = position.x  * ${x.float(o)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),r.uniforms.add(new zt("tex",a=>a.texture)),s||r.uniforms.add(new Pi("altitudeFade")),r.code.add(x`
		void main() {
			vec4 atmosphereColor = texture2D(tex, vtc) * falloff;
      ${s?x`gl_FragColor = atmosphereColor;`:x`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			gl_FragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return t}const Kje=Object.freeze(Object.defineProperty({__proto__:null,SimpleAtmospherePassParameters:YX,build:Jje},Symbol.toStringTag,{value:"Module"}));class h2 extends lr{initializeProgram(t){const i=h2.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return this.configuration.geometry===Rf.Cylinder?Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),culling:RX,depthTest:{func:hr.LEQUAL},colorWrite:Jt}):Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}h2.shader=new Qi(Kje,()=>import("./SimpleAtmosphere.glsl.fe1e9f0b.js"));const Sve="data:image/png;base64, iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAABD1gYFAAAACXBIWXMAAC4jAAAuIwF4pT92AAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAXVJREFUeNq0k9GWhDAIQ3PjzP9/cuehFqhW19mz++IhkCZAq1prsqT+kSQS9g8Vnqp6VGVWkYVktR6tj3Gr968nLnfwlHzHYyHapkKS73bPd/39eI38AYWj24OGvqdwWjZ3l8IDgacXyl1Dj9tdLOzZiicj+P1YcGk0H2O2vN/VQpTveEHmPHQxZxYlqsQdhUeuCWREuDEvAjqlCqDIMYwIo2ijR1HdYUS58dQrKpgQ0EGeMocsTNXrxzyOhS9kfzlWjn82YuWLqwAnvfNEWJFjYXkJCT0s7AmS0NG4x7Lt6Cpy2MiVPBZmS668QT5AR1cevp7b6CpzQ/ZSNH0vmhy5CsNtdax0MBpXDBiFsrDiMSLKMc8b6hH93bNbEpRsIyHDUhNcfTyeKF16PC7c/2QdczvUnvOB1ylZHVFSMtd5s8C2IW/7w6hwM5GLavLCd1zkiFjB+BwH1DSgctQ7mPOimBLJrw35beSXkd8BM/cCqbXWPgMA+GQQ5sIgkfAAAAAASUVORK5CYII=";function hc(e,t=0){const i=e.stride;return e.fieldNames.filter(r=>{const s=e.fields.get(r).optional;return!(s&&s.glPadding)}).map(r=>{const s=e.fields.get(r),n=s.constructor.ElementCount,o=eHe(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new to(r,n,o,a,i,l,t)})}function eHe(e){const t=tHe[e];if(t)return t;throw new Error("BufferType not supported in WebGL")}const tHe={u8:ht.UNSIGNED_BYTE,u16:ht.UNSIGNED_SHORT,u32:ht.UNSIGNED_INT,i8:ht.BYTE,i16:ht.SHORT,i32:ht.INT,f32:ht.FLOAT};class ZX{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}ZX.ElementCount=9;class QX{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)i[s]=this.typedBuffer[r++];return i}setMat(t,i){let r=t*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[r++]=i[s]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}}QX.ElementCount=16;class Ug{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}get(t){return this.typedBuffer[t*this.typedBufferStride]}set(t,i){this.typedBuffer[t*this.typedBufferStride]=i}get buffer(){return this.typedBuffer.buffer}}Ug.ElementCount=1;class kg{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,hi(i,this.typedBuffer[t],this.typedBuffer[t+1])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t]=i[1]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t]=r}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}kg.ElementCount=2;class zg{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,ie(i,this.typedBuffer[t],this.typedBuffer[t+1],this.typedBuffer[t+2])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t]=i[2]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t]=s}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}zg.ElementCount=3;class Vg{constructor(t,i,r=0,s,n){this.TypedArrayConstructor=t,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=i.byteLength===0?0:r;this.typedBuffer=n==null?new o(i,a):new o(i,a,(n-r)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(t,i,r=this.count-i){const s=this.typedBuffer.byteOffset+i*this.stride;return new t(this.buffer,s,this.stride,s+r*this.stride)}getVec(t,i){return t*=this.typedBufferStride,qi(i,this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t++],this.typedBuffer[t])}setVec(t,i){t*=this.typedBufferStride,this.typedBuffer[t++]=i[0],this.typedBuffer[t++]=i[1],this.typedBuffer[t++]=i[2],this.typedBuffer[t]=i[3]}get(t,i){return this.typedBuffer[t*this.typedBufferStride+i]}set(t,i,r){this.typedBuffer[t*this.typedBufferStride+i]=r}setValues(t,i,r,s,n){t*=this.typedBufferStride,this.typedBuffer[t++]=i,this.typedBuffer[t++]=r,this.typedBuffer[t++]=s,this.typedBuffer[t]=n}copyFrom(t,i,r){const s=this.typedBuffer,n=i.typedBuffer;let o=t*this.typedBufferStride,a=r*i.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}}Vg.ElementCount=4;class GO extends Ug{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}static fromTypedArray(t,i){return new GO(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}GO.ElementType="f32";class Rh extends kg{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Rh,t,i)}static fromTypedArray(t,i){return new Rh(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Rh.ElementType="f32";class Vi extends zg{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Vi,t,i)}static fromTypedArray(t,i){return new Vi(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Vi.ElementType="f32";class On extends Vg{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(On,t,i)}static fromTypedArray(t,i){return new On(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}On.ElementType="f32";class Jd extends ZX{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(Jd,t,i)}static fromTypedArray(t,i){return new Jd(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Jd.ElementType="f32";class _v extends ZX{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(_v,t,i)}static fromTypedArray(t,i){return new _v(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}_v.ElementType="f64";class d2 extends QX{constructor(t,i=0,r,s){super(Float32Array,t,i,r,s),this.elementType="f32"}slice(t,i){return this.sliceBuffer(d2,t,i)}static fromTypedArray(t,i){return new d2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}d2.ElementType="f32";class bv extends QX{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(bv,t,i)}static fromTypedArray(t,i){return new bv(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}bv.ElementType="f64";class p2 extends Ug{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(p2,t,i)}static fromTypedArray(t,i){return new p2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}p2.ElementType="f64";class f2 extends kg{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(f2,t,i)}static fromTypedArray(t,i){return new f2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}f2.ElementType="f64";class vs extends zg{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(vs,t,i)}static fromTypedArray(t,i){return new vs(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}vs.ElementType="f64";class jb extends Vg{constructor(t,i=0,r,s){super(Float64Array,t,i,r,s),this.elementType="f64"}slice(t,i){return this.sliceBuffer(jb,t,i)}static fromTypedArray(t,i){return new jb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}jb.ElementType="f64";class Ag extends Ug{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(Ag,t,i)}static fromTypedArray(t,i){return new Ag(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Ag.ElementType="u8";class Hb extends kg{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(Hb,t,i)}static fromTypedArray(t,i){return new Hb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Hb.ElementType="u8";class wv extends zg{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(wv,t,i)}static fromTypedArray(t,i){return new wv(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}wv.ElementType="u8";class fl extends Vg{constructor(t,i=0,r,s){super(Uint8Array,t,i,r,s),this.elementType="u8"}slice(t,i){return this.sliceBuffer(fl,t,i)}static fromTypedArray(t,i){return new fl(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}fl.ElementType="u8";class qb extends Ug{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(qb,t,i)}static fromTypedArray(t,i){return new qb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}qb.ElementType="u16";class m2 extends kg{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(m2,t,i)}static fromTypedArray(t,i){return new m2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}m2.ElementType="u16";class Wb extends zg{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(Wb,t,i)}static fromTypedArray(t,i){return new Wb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Wb.ElementType="u16";class xv extends Vg{constructor(t,i=0,r,s){super(Uint16Array,t,i,r,s),this.elementType="u16"}slice(t,i){return this.sliceBuffer(xv,t,i)}static fromTypedArray(t,i){return new xv(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}xv.ElementType="u16";class Xb extends Ug{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(Xb,t,i)}static fromTypedArray(t,i){return new Xb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Xb.ElementType="u32";class g2 extends kg{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(g2,t,i)}static fromTypedArray(t,i){return new g2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}g2.ElementType="u32";class EM extends zg{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(EM,t,i)}static fromTypedArray(t,i){return new EM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}EM.ElementType="u32";class CM extends Vg{constructor(t,i=0,r,s){super(Uint32Array,t,i,r,s),this.elementType="u32"}slice(t,i){return this.sliceBuffer(CM,t,i)}static fromTypedArray(t,i){return new CM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}CM.ElementType="u32";class y2 extends Ug{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(y2,t,i)}static fromTypedArray(t,i){return new y2(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}y2.ElementType="i8";class Yb extends kg{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(Yb,t,i)}static fromTypedArray(t,i){return new Yb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Yb.ElementType="i8";class AM extends zg{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(AM,t,i)}static fromTypedArray(t,i){return new AM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}AM.ElementType="i8";class RM extends Vg{constructor(t,i=0,r,s){super(Int8Array,t,i,r,s),this.elementType="i8"}slice(t,i){return this.sliceBuffer(RM,t,i)}static fromTypedArray(t,i){return new RM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}RM.ElementType="i8";class MM extends Ug{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(MM,t,i)}static fromTypedArray(t,i){return new MM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}MM.ElementType="i16";class Zb extends kg{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(Zb,t,i)}static fromTypedArray(t,i){return new Zb(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}Zb.ElementType="i16";class OM extends zg{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(OM,t,i)}static fromTypedArray(t,i){return new OM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}OM.ElementType="i16";class PM extends Vg{constructor(t,i=0,r,s){super(Int16Array,t,i,r,s),this.elementType="i16"}slice(t,i){return this.sliceBuffer(PM,t,i)}static fromTypedArray(t,i){return new PM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}PM.ElementType="i16";class IM extends Ug{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(IM,t,i)}static fromTypedArray(t,i){return new IM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}IM.ElementType="i32";class $M extends kg{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer($M,t,i)}static fromTypedArray(t,i){return new $M(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}$M.ElementType="i32";class DM extends zg{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(DM,t,i)}static fromTypedArray(t,i){return new DM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}DM.ElementType="i32";class LM extends Vg{constructor(t,i=0,r,s){super(Int32Array,t,i,r,s),this.elementType="i32"}slice(t,i){return this.sliceBuffer(LM,t,i)}static fromTypedArray(t,i){return new LM(t.buffer,t.byteOffset,i,t.byteOffset+t.byteLength)}}LM.ElementType="i32";function Eve(e){switch(e){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8;default:return}}function iHe(e){switch(e){case"u8":case"u16":case"u32":return!1;case"i8":case"i16":case"i32":case"f32":case"f64":return!0;default:return}}function rHe(e){switch(e){case"u8":case"u16":case"u32":case"i8":case"i16":case"i32":return!0;case"f32":case"f64":return!1;default:return}}function sHe(e){switch(e){case"u8":return 255;case"u16":return 65535;case"u32":return 4294967295;case"i8":return 127;case"i16":return 32767;case"i32":return 2147483647;case"f32":return 3402823e32;case"f64":return 179769e303;default:return}}class QN{constructor(t,i){this.layout=t,this.buffer=typeof i=="number"?new ArrayBuffer(i*t.stride):i;for(const r of t.fieldNames){const s=t.fields.get(r);this[r]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(t,i){const r=this[t];return r&&r.elementCount===i.ElementCount&&r.elementType===i.ElementType?r:null}slice(t,i){return new QN(this.layout,this.buffer.slice(t*this.stride,i*this.stride))}copyFrom(t,i,r,s){const n=this.stride;if(n%4==0){const o=new Uint32Array(t.buffer,i*n,s*n/4);new Uint32Array(this.buffer,r*n,s*n/4).set(o)}else{const o=new Uint8Array(t.buffer,i*n,s*n);new Uint8Array(this.buffer,r*n,s*n).set(o)}}}class JX{constructor(){this.stride=0,this.fields=new Map,this.fieldNames=[]}vec2f(t,i){return this._appendField(t,Rh,i),this}vec2f64(t,i){return this._appendField(t,f2,i),this}vec3f(t,i){return this._appendField(t,Vi,i),this}vec3f64(t,i){return this._appendField(t,vs,i),this}vec4f(t,i){return this._appendField(t,On,i),this}vec4f64(t,i){return this._appendField(t,jb,i),this}mat3f(t,i){return this._appendField(t,Jd,i),this}mat3f64(t,i){return this._appendField(t,_v,i),this}mat4f(t,i){return this._appendField(t,d2,i),this}mat4f64(t,i){return this._appendField(t,bv,i),this}vec4u8(t,i){return this._appendField(t,fl,i),this}f32(t,i){return this._appendField(t,GO,i),this}f64(t,i){return this._appendField(t,p2,i),this}u8(t,i){return this._appendField(t,Ag,i),this}u16(t,i){return this._appendField(t,qb,i),this}i8(t,i){return this._appendField(t,y2,i),this}vec2i8(t,i){return this._appendField(t,Yb,i),this}vec2i16(t,i){return this._appendField(t,Zb,i),this}vec2u8(t,i){return this._appendField(t,Hb,i),this}vec4u16(t,i){return this._appendField(t,xv,i),this}u32(t,i){return this._appendField(t,Xb,i),this}_appendField(t,i,r){const s=i.ElementCount*Eve(i.ElementType),n=this.stride;this.fields.set(t,{size:s,constructor:i,offset:n,optional:r}),this.stride+=s,this.fieldNames.push(t)}alignTo(t){return this.stride=Math.floor((this.stride+t-1)/t)*t,this}hasField(t){return this.fieldNames.includes(t)}createBuffer(t){return new QN(this,t)}createView(t){return new QN(this,t)}clone(){const t=new JX;return t.stride=this.stride,t.fields=new Map,this.fields.forEach((i,r)=>t.fields.set(r,i)),t.fieldNames=this.fieldNames.slice(),t.BufferType=this.BufferType,t}}function Kr(){return new JX}var D7;(function(e){function t(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function i(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function r(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}e.length=t,e.normalize=i,e.scale=r,e.add=s,e.subtract=n})(D7||(D7={}));const Ko=Gt();class nHe{constructor(t){this.message=t}toString(){return`AssertException: ${this.message}`}}function dt(e,t){if(!e)throw t=t||"assert",console.log(new Error(t).stack),new nHe(t)}function Nw(e,t){e||(t=t||"",console.warn("Verify failed: "+t+`
`+new Error("verify").stack))}function Sie(e,t,i,r){let s,n=(i[0]-e[0])/t[0],o=(r[0]-e[0])/t[0];n>o&&(s=n,n=o,o=s);let a=(i[1]-e[1])/t[1],l=(r[1]-e[1])/t[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(i[2]-e[2])/t[2],h=(r[2]-e[2])/t[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function IP(e,t,i,r,s,n=tt()){const o=(r[s]-i[s])*(t[0]-e[0])-(r[0]-i[0])*(t[s]-e[s]),a=(r[0]-i[0])*(e[s]-i[s])-(r[s]-i[s])*(e[0]-i[0]);if(o===0)return!1;const l=a/o;return n[0]=e[0]+l*(t[0]-e[0]),n[1]=e[s]+l*(t[s]-e[s]),!0}function Eie(e,t,i,r,s){s||(s=e),Ko[0]=e[0],Ko[1]=e[1],Ko[2]=e[2],Ko[3]=1,Qc(Ko,Ko,t),s.length>2&&(s[2]=-Ko[2]),Qc(Ko,Ko,i),dt(Ko[3]!==0),s[0]=Ko[0]/Ko[3],s[1]=Ko[1]/Ko[3],s[2]=Ko[2]/Ko[3],s[0]=(.5*s[0]+.5)*r[2]+r[0],s[1]=(.5*s[1]+.5)*r[3]+r[1]}function oHe(e,t){return Math.log(e)/Math.log(t)}function Cve(e,t,i,r){e[12]=t,e[13]=i,e[14]=r}function Ave(e){return e[0]===1&&e[1]===0&&e[2]===0&&e[3]===0&&e[4]===0&&e[5]===1&&e[6]===0&&e[7]===0&&e[8]===0&&e[9]===0&&e[10]===1&&e[11]===0&&e[15]===1}function aHe(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/t)}function lHe(e,t,i){return 2*Math.atan(Math.sqrt(t*t+i*i)*Math.tan(.5*e)/i)}function cHe(e,t,i){return 2*Math.atan(t*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}function uHe(e,t,i){return 2*Math.atan(i*Math.tan(.5*e)/Math.sqrt(t*t+i*i))}class v5{constructor(t,i,r,s){this.primitiveIndices=t,this._numIndexPerPrimitive=i,this.indices=r,this.position=s,this.center=O(),dt(t.length>=1),dt(r.length%this._numIndexPerPrimitive==0),dt(r.length>=t.length*this._numIndexPerPrimitive),dt(s.size===3||s.size===4);const{data:n,size:o}=s,a=t.length;let l=o*r[this._numIndexPerPrimitive*t[0]];i_.clear(),i_.push(l),this.bbMin=Fe(n[l],n[l+1],n[l+2]),this.bbMax=Is(this.bbMin);for(let h=0;h<a;++h){const p=this._numIndexPerPrimitive*t[h];for(let f=0;f<this._numIndexPerPrimitive;++f){l=o*r[p+f],i_.push(l);let m=n[l];this.bbMin[0]=Math.min(m,this.bbMin[0]),this.bbMax[0]=Math.max(m,this.bbMax[0]),m=n[l+1],this.bbMin[1]=Math.min(m,this.bbMin[1]),this.bbMax[1]=Math.max(m,this.bbMax[1]),m=n[l+2],this.bbMin[2]=Math.min(m,this.bbMin[2]),this.bbMax[2]=Math.max(m,this.bbMax[2])}}en(this.center,this.bbMin,this.bbMax,.5),this.radius=.5*Math.max(Math.max(this.bbMax[0]-this.bbMin[0],this.bbMax[1]-this.bbMin[1]),this.bbMax[2]-this.bbMin[2]);let c=this.radius*this.radius;for(let h=0;h<i_.length;++h){l=i_.getItemAt(h);const p=n[l]-this.center[0],f=n[l+1]-this.center[1],m=n[l+2]-this.center[2],y=p*p+f*f+m*m;if(y<=c)continue;const v=Math.sqrt(y),w=.5*(v-this.radius);this.radius=this.radius+w,c=this.radius*this.radius;const b=w/v;this.center[0]+=p*b,this.center[1]+=f*b,this.center[2]+=m*b}i_.clear()}getCenter(){return this.center}getBSRadius(){return this.radius}getBBMin(){return this.bbMin}getBBMax(){return this.bbMax}getChildren(){if(this._children)return this._children;if($s(this.bbMin,this.bbMax)>1){const t=en(O(),this.bbMin,this.bbMax,.5),i=this.primitiveIndices.length,r=new Uint8Array(i),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<i;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],m=n[f],y=n[f+1],v=n[f+2];for(let w=1;w<this._numIndexPerPrimitive;++w){f=o*this.indices[p+w];const b=n[f],S=n[f+1],T=n[f+2];b<m&&(m=b),S<y&&(y=S),T<v&&(v=T)}m<t[0]&&(h|=1),y<t[1]&&(h|=2),v<t[2]&&(h|=4),r[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<i;++c){const h=r[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array(8);for(let c=0;c<8;++c)l[c]!==void 0&&(this._children[c]=new v5(l[c],this._numIndexPerPrimitive,this.indices,this.position))}return this._children}static prune(){i_.prune()}}const i_=new Bt({deallocator:null});class jO{constructor(){this.id=sl()}unload(){}}var Kd;(function(e){e[e.Layer=0]="Layer",e[e.Object=1]="Object",e[e.Geometry=2]="Geometry",e[e.Material=3]="Material",e[e.Texture=4]="Texture",e[e.COUNT=5]="COUNT"})(Kd||(Kd={}));function Cie(e,t,i){const r=t[0]-e[0],s=t[1]-e[1],n=i[0]-e[0],o=i[1]-e[1];return .5*Math.abs(r*o-s*n)}function hHe(e,t,i){return pe(I6,t,e),pe(Aie,i,e),Me(lt(I6,I6,Aie))/2}new $g(Ff);new $g(()=>({p0:null,p1:null,p2:null}));const I6=O(),Aie=O();let g0=(()=>{const e=new Uint32Array(131072);for(let t=0;t<e.length;++t)e[t]=t;return e})();const Rve=new Uint16Array([0]),JN=(()=>{const e=new Uint16Array(65536);for(let t=0;t<e.length;++t)e[t]=t;return e})();function v2(e){if(e===1)return Rve;if(e<JN.length)return new Uint16Array(JN.buffer,0,e);if(e>g0.length){const t=Math.max(2*g0.length,e);g0=new Uint32Array(t);for(let i=0;i<g0.length;i++)g0[i]=i}return new Uint32Array(g0.buffer,0,e)}function B_t(e){if(e===1)return new Uint16Array(Rve);if(e<JN.length)return new Uint16Array(JN.slice(0,e));if(e>g0.length){const t=new Uint32Array(e);for(let i=0;i<t.length;i++)t[i]=i;return t}return new Uint32Array(g0.slice(0,e))}function Mve(e,t,i){if(!e)return!1;const{size:r,data:s}=e;ie(i,0,0,0),ie(eh,0,0,0);let n=0,o=0;for(let a=0;a<t.length-2;a+=3){const l=t[a+0]*r,c=t[a+1]*r,h=t[a+2]*r;ie(Sn,s[l+0],s[l+1],s[l+2]),ie(Ym,s[c+0],s[c+1],s[c+2]),ie($P,s[h+0],s[h+1],s[h+2]);const p=hHe(Sn,Ym,$P);p?(de(Sn,Sn,Ym),de(Sn,Sn,$P),oe(Sn,Sn,1/3*p),de(i,i,Sn),n+=p):(de(eh,eh,Sn),de(eh,eh,Ym),de(eh,eh,$P),o+=3)}return(o!==0||n!==0)&&(n!==0?(oe(i,i,1/n),!0):o!==0&&(oe(i,eh,1/o),!0))}function Ove(e,t,i){if(!e||!t)return!1;const{size:r,data:s}=e;ie(i,0,0,0);let n=-1,o=0;for(let a=0;a<t.length;a++){const l=t[a]*r;n!==l&&(i[0]+=s[l+0],i[1]+=s[l+1],i[2]+=s[l+2],o++),n=l}return o>1&&oe(i,i,1/o),o>0}function KX(e,t,i,r){if(!e)return!1;const{size:s,data:n}=e;ie(r,0,0,0),ie(eh,0,0,0);let o=0,a=0;const l=t?t.length-1:n.length/s-1,c=l+(i?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,m=(t?t[p]:p)*s,y=(t?t[f]:f)*s;Sn[0]=n[m+0],Sn[1]=n[m+1],Sn[2]=n[m+2],Ym[0]=n[y+0],Ym[1]=n[y+1],Ym[2]=n[y+2],oe(Sn,de(Sn,Sn,Ym),.5);const v=dH(Sn,Ym);v>0?(de(r,r,oe(Sn,Sn,v)),o+=v):(de(eh,eh,Sn),a++)}return o!==0?(oe(r,r,1/o),!0):a!==0&&(oe(r,eh,1/a),!0)}const Sn=O(),Ym=O(),$P=O(),eh=O();class Or extends jO{constructor(t,i=[],r=ll.Triangle,s=-1){super(),this._primitiveType=r,this.edgeIndicesLength=s,this.type=Kd.Geometry,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[n,o]of t)o&&this._vertexAttributes.set(n,F({},o));if(i==null||i.length===0){const n=dHe(this._vertexAttributes),o=v2(n);this.edgeIndicesLength=this.edgeIndicesLength<0?n:this.edgeIndicesLength;for(const a of this._vertexAttributes.keys())this._indices.set(a,o)}else for(const[n,o]of i)o&&(this._indices.set(n,pHe(o)),n===A.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(n).length:this.edgeIndicesLength))}cloneShallow(){const t=new Or([],void 0,this._primitiveType,void 0),{_vertexAttributes:i,_indices:r}=t;return this._vertexAttributes.forEach((s,n)=>{i.set(n,s)}),this._indices.forEach((s,n)=>{r.set(n,s)}),t.screenToWorldRatio=this.screenToWorldRatio,t._boundingInfo=this._boundingInfo,t}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(t){const i=this._vertexAttributes.get(t);return i&&!i.exclusive&&(i.data=Array.from(i.data),i.exclusive=!0),i}get indices(){return this._indices}get indexCount(){const t=this._indices.values().next().value;return t?t.length:0}get primitiveType(){return this._primitiveType}get faceCount(){return this.indexCount/3}get boundingInfo(){return R(this._boundingInfo)&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(t){return this.primitiveType===ll.Triangle?this._computeAttachmentOriginTriangles(t):this._computeAttachmentOriginPoints(t)}_computeAttachmentOriginTriangles(t){const i=this.indices.get(A.POSITION),r=this.vertexAttributes.get(A.POSITION);return Mve(r,i,t)}_computeAttachmentOriginPoints(t){const i=this.indices.get(A.POSITION),r=this.vertexAttributes.get(A.POSITION);return Ove(r,i,t)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const t=this.indices.get(A.POSITION);if(t.length===0)return null;const i=this.primitiveType===ll.Triangle?3:1;dt(t.length%i==0,"Indexing error: "+t.length+" not divisible by "+i);const r=v2(t.length/i),s=this.vertexAttributes.get(A.POSITION);return new v5(r,i,t,s)}}function dHe(e){const t=e.values().next().value;return t==null?0:t.data.length/t.size}function pHe(e){if(e.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT)return e;for(const t of e)if(t>=65536)return e;return new Uint16Array(e)}const Fw=D7;var $6,D6,L6,L7;(function(e){const i=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],r=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],s=[0,0,1,0,1,1,0,1],n=new Uint16Array([0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5]),o=new Uint16Array(36);for(let c=0;c<6;c++)for(let h=0;h<6;h++)o[6*c+h]=c;const a=new Uint16Array(36);for(let c=0;c<6;c++)a[6*c+0]=0,a[6*c+1]=1,a[6*c+2]=2,a[6*c+3]=2,a[6*c+4]=3,a[6*c+5]=0;function l(c){Array.isArray(c)||(c=[c,c,c]);const h=new Array(24);for(let p=0;p<8;p++)h[3*p]=i[p][0]*c[0],h[3*p+1]=i[p][1]*c[1],h[3*p+2]=i[p][2]*c[2];return new Or([[A.POSITION,{size:3,data:h,exclusive:!0}],[A.NORMAL,{size:3,data:r}],[A.UV0,{size:2,data:s}]],[[A.POSITION,n],[A.NORMAL,o],[A.UV0,a]])}e.createGeometry=l})($6||($6={})),function(e){const i=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],r=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],s=new Uint16Array([5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0]),n=new Uint16Array([0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7]);function o(a){Array.isArray(a)||(a=[a,a,a]);const l=new Array(18);for(let c=0;c<6;c++)l[3*c]=i[c][0]*a[0],l[3*c+1]=i[c][1]*a[1],l[3*c+2]=i[c][2]*a[2];return new Or([[A.POSITION,{size:3,data:l,exclusive:!0}],[A.NORMAL,{size:3,data:r}]],[[A.POSITION,s],[A.NORMAL,n]])}e.createGeometry=o}(D6||(D6={})),function(e){const r=Ai(-.5,0,-.5),s=Ai(.5,0,-.5),n=Ai(0,0,.5),o=Ai(0,0+.5,0),a=wi(),l=wi(),c=wi(),h=wi(),p=wi();pe(a,r,o),pe(l,r,s),lt(c,a,l),we(c,c),pe(a,s,o),pe(l,s,n),lt(h,a,l),we(h,h),pe(a,n,o),pe(l,n,r),lt(p,a,l),we(p,p);const f=[r,s,n,o],m=[0,-1,0,c[0],c[1],c[2],h[0],h[1],h[2],p[0],p[1],p[2]],y=[0,1,2,3,1,0,3,2,1,3,0,2],v=[0,0,0,1,1,1,2,2,2,3,3,3];function w(b){Array.isArray(b)||(b=[b,b,b]);const S=new Array(12);for(let T=0;T<4;T++)S[3*T]=f[T][0]*b[0],S[3*T+1]=f[T][1]*b[1],S[3*T+2]=f[T][2]*b[2];return new Or([[A.POSITION,{size:3,data:S,exclusive:!0}],[A.NORMAL,{size:3,data:m}]],[[A.POSITION,new Uint16Array(y)],[A.NORMAL,new Uint16Array(v)]])}e.createGeometry=w}(L6||(L6={})),function(e){function t(T,E,C,M={uv:!0}){const I=-Math.PI,N=2*Math.PI,D=-Math.PI/2,z=Math.PI,V=Math.max(3,Math.floor(E)),k=Math.max(2,Math.floor(C)),Y=(V+1)*(k+1),Z=new Float32Array(3*Y),le=new Float32Array(3*Y),ne=new Float32Array(2*Y),$=[];let U=0;for(let K=0;K<=k;K++){const j=[],ee=K/k,ye=D+ee*z,Te=Math.cos(ye);for(let Ne=0;Ne<=V;Ne++){const _e=Ne/V,ge=I+_e*N,Ce=Math.cos(ge)*Te,Le=Math.sin(ye),Ri=-Math.sin(ge)*Te;Z[3*U]=Ce*T,Z[3*U+1]=Le*T,Z[3*U+2]=Ri*T,le[3*U]=Ce,le[3*U+1]=Le,le[3*U+2]=Ri,ne[2*U]=_e,ne[2*U+1]=ee,j.push(U),++U}$.push(j)}const B=new Uint32Array(2*V*(k-1)*3);U=0;for(let K=0;K<k;K++)for(let j=0;j<V;j++){const ee=$[K][j],ye=$[K][j+1],Te=$[K+1][j+1],Ne=$[K+1][j];K===0?(B[U++]=ee,B[U++]=Te,B[U++]=Ne):K===k-1?(B[U++]=ee,B[U++]=ye,B[U++]=Te):(B[U++]=ee,B[U++]=ye,B[U++]=Te,B[U++]=Te,B[U++]=Ne,B[U++]=ee)}const H=[[A.POSITION,B],[A.NORMAL,B]],W=[[A.POSITION,{size:3,data:Z,exclusive:!0}],[A.NORMAL,{size:3,data:le,exclusive:!0}]];return M.uv&&(W.push([A.UV0,{size:2,data:ne,exclusive:!0}]),H.push([A.UV0,B])),M.offset&&(H[0][0]=A.OFFSET,W[0][0]=A.OFFSET,H.push([A.POSITION,new Uint32Array(B.length)]),W.push([A.POSITION,{size:3,data:Float64Array.from(M.offset),exclusive:!0}])),new Or(W,H)}function i(T,E,C){const M=T;let I,N;if(C)I=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],N=new Uint32Array([0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1]);else{const Z=M*(1+Math.sqrt(5))/2;I=[-M,Z,0,M,Z,0,-M,-Z,0,M,-Z,0,0,-M,Z,0,M,Z,0,-M,-Z,0,M,-Z,Z,0,-M,Z,0,M,-Z,0,-M,-Z,0,M],N=new Uint32Array([0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1])}for(let Z=0;Z<I.length;Z+=3)Fw.scale(I,Z,T/Fw.length(I,Z));let D={};function z(Z,le){Z>le&&([Z,le]=[le,Z]);const ne=Z.toString()+"."+le.toString();if(D[ne])return D[ne];let $=I.length;return I.length+=3,Fw.add(I,3*Z,I,3*le,I,$),Fw.scale(I,$,T/Fw.length(I,$)),$/=3,D[ne]=$,$}for(let Z=0;Z<E;Z++){const le=N.length,ne=new Uint32Array(4*le);for(let $=0;$<le;$+=3){const U=N[$],B=N[$+1],H=N[$+2],W=z(U,B),K=z(B,H),j=z(H,U),ee=4*$;ne[ee]=U,ne[ee+1]=W,ne[ee+2]=j,ne[ee+3]=B,ne[ee+4]=K,ne[ee+5]=W,ne[ee+6]=H,ne[ee+7]=j,ne[ee+8]=K,ne[ee+9]=W,ne[ee+10]=K,ne[ee+11]=j}N=ne,D={}}const V=new Float32Array(I);for(let Z=0;Z<V.length;Z+=3)Fw.normalize(V,Z);const k=[[A.POSITION,N],[A.NORMAL,N]],Y=[[A.POSITION,{size:3,data:new Float32Array(I),exclusive:!0}],[A.NORMAL,{size:3,data:V,exclusive:!0}]];return new Or(Y,k)}function r(T,E,C,M,I,N,D){const z=E?[E[0],E[1],E[2]]:[0,0,0],V=T?[T[0],T[1],T[2]]:[0,0,1];N=N||[0,0];const k=C?[255*C[0],255*C[1],255*C[2],C.length>3?255*C[3]:255]:[255,255,255,255],Y=M!=null&&M.length===2?M:[1,1],Z=[[A.POSITION,{size:3,data:z,exclusive:!0}],[A.NORMAL,{size:3,data:V,exclusive:!0}],[A.UV0,{size:N.length,data:N}],[A.COLOR,{size:4,data:k,exclusive:!0}],[A.SIZE,{size:2,data:Y}]];if(I!=null){const le=new Float32Array([I[0],I[1],I[2],I[3]]);Z.push([A.AUXPOS1,{size:4,data:le}])}if(D!=null){const le=new Float32Array([D[0],D[1],D[2],D[3]]);Z.push([A.AUXPOS2,{size:4,data:le}])}return new Or(Z,null,ll.Point)}function s(T,E,C,M,I,N,D,z){if(T!=null){const{data:V}=z.getMutableAttribute(A.NORMAL);V[0]=T[0],V[1]=T[1],V[2]=T[2]}if(E!=null){const{data:V}=z.getMutableAttribute(A.POSITION);V[0]=E[0],V[1]=E[1],V[2]=E[2]}if(C!=null){const{data:V}=z.getMutableAttribute(A.COLOR);V[0]=C[0],V[1]=C[1],V[2]=C[2],V[3]=C[3]}if(M!=null){const{data:V}=z.getMutableAttribute(A.SIZE);V[0]=M[0],V[1]=M[1]}if(I!=null){const{data:V}=z.getMutableAttribute(A.AUXPOS1);V[0]=I[0],V[1]=I[1],V[2]=I[2],V[3]=I[3]}if(N!=null){const{data:V}=z.getMutableAttribute(A.UV0);V[0]=N[0],V[1]=N[1]}if(D!=null){const{data:V}=z.getMutableAttribute(A.AUXPOS2);V[0]=D[0],V[1]=D[1],V[2]=D[2],V[3]=D[3]}}function n(T,E){const C=new Float32Array(3*T.length),M=new Float32Array(E?3*T.length:3),I=new Uint32Array(T.length),N=new Uint32Array(T.length);for(let k=0;k<T.length;k++)C[3*k]=T[k][0],C[3*k+1]=T[k][1],C[3*k+2]=T[k][2],E&&(M[3*k]=E[k][0],M[3*k+1]=E[k][1],M[3*k+2]=E[k][2]),I[k]=k,N[k]=0;E||(M[0]=0,M[1]=1,M[2]=0);const D=[0,0],z=[[A.POSITION,I],[A.NORMAL,E?I:N],[A.UV0,N]],V=[[A.POSITION,{size:3,data:C,exclusive:!0}],[A.NORMAL,{size:3,data:M,exclusive:!0}],[A.UV0,{size:2,data:D,exclusive:!0}]];return new Or(V,z,ll.Point)}function o(){const T=[0,0,0,0,0,100,100,0,0],E=new Uint16Array([0,1,2]),C=[0,1,0],M=new Uint16Array([0,0,0]),I=[0,0],N=new Uint16Array([0,0,0]),D=[[A.POSITION,E],[A.NORMAL,M],[A.UV0,N]],z=[[A.POSITION,{size:3,data:T,exclusive:!0}],[A.NORMAL,{size:3,data:C,exclusive:!0}],[A.UV0,{size:2,data:I,exclusive:!0}]];return new Or(z,D)}e.createBoxGeometry=$6.createGeometry,e.createDiamondGeometry=D6.createGeometry,e.createTetrahedronGeometry=L6.createGeometry,e.createSphereGeometry=t,e.createPolySphereGeometry=i,e.createPointGeometry=r,e.updatePointGeometry=s,e.createPointArrayGeometry=n,e.createTriangleGeometry=o;const a=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function l(T=a){const E=new Array(12);for(let k=0;k<4;k++)for(let Y=0;Y<3;Y++)E[3*k+Y]=T[k][Y];const C=new Uint32Array([0,1,2,2,3,0]),M=[0,0,1],I=new Uint32Array([0,0,0,0,0,0]),N=[0,0,1,0,1,1,0,1],D=[255,255,255,255],z=[[A.POSITION,C],[A.NORMAL,I],[A.UV0,C],[A.COLOR,I]],V=[[A.POSITION,{size:3,data:E,exclusive:!0}],[A.NORMAL,{size:3,data:M,exclusive:!0}],[A.UV0,{size:2,data:N,exclusive:!0}],[A.COLOR,{size:4,data:D,exclusive:!0}]];return new Or(V,z)}function c(T,E,C,M,I=!0,N=!0){let D=0;const z=E,V=T;let k=Ai(0,D,0),Y=Ai(0,D+V,0),Z=Ai(0,-1,0),le=Ai(0,1,0);M&&(D=V,Y=Ai(0,0,0),k=Ai(0,D,0),Z=Ai(0,1,0),le=Ai(0,-1,0));const ne=[Y,k],$=[Z,le],U=C+2,B=Math.sqrt(V*V+z*z);if(M)for(let _e=C-1;_e>=0;_e--){const ge=_e*(2*Math.PI/C),Ce=Ai(Math.cos(ge)*z,D,Math.sin(ge)*z);ne.push(Ce);const Le=Ai(V*Math.cos(ge)/B,-z/B,V*Math.sin(ge)/B);$.push(Le)}else for(let _e=0;_e<C;_e++){const ge=_e*(2*Math.PI/C),Ce=Ai(Math.cos(ge)*z,D,Math.sin(ge)*z);ne.push(Ce);const Le=Ai(V*Math.cos(ge)/B,z/B,V*Math.sin(ge)/B);$.push(Le)}const H=new Uint32Array(2*(C+2)*3),W=new Uint32Array(2*(C+2)*3);let K=0,j=0;if(I){for(let _e=3;_e<ne.length;_e++)H[K++]=1,H[K++]=_e-1,H[K++]=_e,W[j++]=0,W[j++]=0,W[j++]=0;H[K++]=ne.length-1,H[K++]=2,H[K++]=1,W[j++]=0,W[j++]=0,W[j++]=0}if(N){for(let _e=3;_e<ne.length;_e++)H[K++]=_e,H[K++]=_e-1,H[K++]=0,W[j++]=_e,W[j++]=_e-1,W[j++]=1;H[K++]=0,H[K++]=2,H[K++]=ne.length-1,W[j++]=1,W[j++]=2,W[j++]=$.length-1}const ee=new Float32Array(3*U);for(let _e=0;_e<U;_e++)ee[3*_e]=ne[_e][0],ee[3*_e+1]=ne[_e][1],ee[3*_e+2]=ne[_e][2];const ye=new Float32Array(3*U);for(let _e=0;_e<U;_e++)ye[3*_e]=$[_e][0],ye[3*_e+1]=$[_e][1],ye[3*_e+2]=$[_e][2];const Te=[[A.POSITION,H],[A.NORMAL,W]],Ne=[[A.POSITION,{size:3,data:ee,exclusive:!0}],[A.NORMAL,{size:3,data:ye,exclusive:!0}]];return new Or(Ne,Te)}function h(T,E,C,M,I,N){const D=M?XN(M):Ai(1,0,0),z=I?XN(I):Ai(0,0,0);N=N==null||N;const V=wi();we(V,D);const k=wi();oe(k,V,Math.abs(T));const Y=wi();oe(Y,k,-.5),de(Y,Y,z);const Z=Ai(0,1,0);Math.abs(1-xe(V,Z))<.2&&ie(Z,0,0,1);const le=wi();lt(le,V,Z),we(le,le),lt(Z,le,V);const ne=2*C+(N?2:0),$=C+(N?2:0),U=new Float32Array(3*ne),B=new Float32Array(3*$),H=new Float32Array(2*ne),W=new Uint32Array(3*C*(N?4:2)),K=new Uint32Array(3*C*(N?4:2));N&&(U[3*(ne-2)+0]=Y[0],U[3*(ne-2)+1]=Y[1],U[3*(ne-2)+2]=Y[2],H[2*(ne-2)]=0,H[2*(ne-2)+1]=0,U[3*(ne-1)+0]=U[3*(ne-2)+0]+k[0],U[3*(ne-1)+1]=U[3*(ne-2)+1]+k[1],U[3*(ne-1)+2]=U[3*(ne-2)+2]+k[2],H[2*(ne-1)]=1,H[2*(ne-1)+1]=1,B[3*($-2)+0]=-V[0],B[3*($-2)+1]=-V[1],B[3*($-2)+2]=-V[2],B[3*($-1)+0]=V[0],B[3*($-1)+1]=V[1],B[3*($-1)+2]=V[2]);const j=(ge,Ce,Le)=>{W[ge]=Ce,K[ge]=Le};let ee=0;const ye=wi(),Te=wi();for(let ge=0;ge<C;ge++){const Ce=ge*(2*Math.PI/C);oe(ye,Z,Math.sin(Ce)),oe(Te,le,Math.cos(Ce)),de(ye,ye,Te),B[3*ge+0]=ye[0],B[3*ge+1]=ye[1],B[3*ge+2]=ye[2],oe(ye,ye,E),de(ye,ye,Y),U[3*ge+0]=ye[0],U[3*ge+1]=ye[1],U[3*ge+2]=ye[2],H[2*ge+0]=ge/C,H[2*ge+1]=0,U[3*(ge+C)+0]=U[3*ge+0]+k[0],U[3*(ge+C)+1]=U[3*ge+1]+k[1],U[3*(ge+C)+2]=U[3*ge+2]+k[2],H[2*(ge+C)+0]=ge/C,H[2*ge+1]=1;const Le=(ge+1)%C;j(ee++,ge,ge),j(ee++,ge+C,ge),j(ee++,Le,Le),j(ee++,Le,Le),j(ee++,ge+C,ge),j(ee++,Le+C,Le)}if(N){for(let ge=0;ge<C;ge++){const Ce=(ge+1)%C;j(ee++,ne-2,$-2),j(ee++,ge,$-2),j(ee++,Ce,$-2)}for(let ge=0;ge<C;ge++){const Ce=(ge+1)%C;j(ee++,ge+C,$-1),j(ee++,ne-1,$-1),j(ee++,Ce+C,$-1)}}const Ne=[[A.POSITION,W],[A.NORMAL,K],[A.UV0,W]],_e=[[A.POSITION,{size:3,data:U,exclusive:!0}],[A.NORMAL,{size:3,data:B,exclusive:!0}],[A.UV0,{size:2,data:H,exclusive:!0}]];return new Or(_e,Ne)}function p(T,E,C,M,I){C=C||10,M=M==null||M,dt(T.length>1);const N=[[0,0,0]],D=[],z=[];for(let V=0;V<C;V++){D.push([0,-V-1,-(V+1)%C-1]);const k=V/C*2*Math.PI;z.push([Math.cos(k)*E,Math.sin(k)*E])}return e.createPathExtrusionGeometry(z,T,N,D,M,I)}function f(T,E,C,M,I,N=Ai(0,0,0)){const D=T.length,z=new Float32Array(E.length*D*3+(6*C.length||0)),V=new Float32Array(E.length*D*3+(C?6:0)),k=(E.length-1)*D*6+3*M.length*2,Y=new Uint32Array(k),Z=new Uint32Array(k);let le=0,ne=0,$=0,U=0;const B=wi(),H=wi(),W=wi(),K=wi(),j=wi(),ee=wi(),ye=wi(),Te=O(),Ne=wi(),_e=wi(),ge=wi(),Ce=wi(),Le=wi(),Ri=gi();ie(Ne,0,1,0),pe(H,E[1],E[0]),we(H,H),I?(de(Te,E[0],N),we(W,Te)):ie(W,0,0,1),S(H,W,Ne,Ne,j,W,Rie),se(K,W),se(Ce,j);for(let rt=0;rt<C.length;rt++)oe(ee,j,C[rt][0]),oe(Te,W,C[rt][2]),de(ee,ee,Te),de(ee,ee,E[0]),z[le++]=ee[0],z[le++]=ee[1],z[le++]=ee[2];V[ne++]=-H[0],V[ne++]=-H[1],V[ne++]=-H[2];for(let rt=0;rt<M.length;rt++)Y[$++]=M[rt][0]>0?M[rt][0]:-M[rt][0]-1+C.length,Y[$++]=M[rt][1]>0?M[rt][1]:-M[rt][1]-1+C.length,Y[$++]=M[rt][2]>0?M[rt][2]:-M[rt][2]-1+C.length,Z[U++]=0,Z[U++]=0,Z[U++]=0;let Li=C.length;const ii=C.length-1;for(let rt=0;rt<E.length;rt++){let Er=!1;rt>0&&(se(B,H),rt<E.length-1?(pe(H,E[rt+1],E[rt]),we(H,H)):Er=!0,de(_e,B,H),we(_e,_e),de(ge,E[rt-1],K),qS(E[rt],_e,Ri),gw(Ri,mu(ge,B),Te)?(pe(Te,Te,E[rt]),we(W,Te),lt(j,_e,W),we(j,j)):S(_e,K,Ce,Ne,j,W,Rie),se(K,W),se(Ce,j)),I&&(de(Te,E[rt],N),we(Le,Te));for(let Pn=0;Pn<D;Pn++)if(oe(ee,j,T[Pn][0]),oe(Te,W,T[Pn][1]),de(ee,ee,Te),we(ye,ee),V[ne++]=ye[0],V[ne++]=ye[1],V[ne++]=ye[2],de(ee,ee,E[rt]),z[le++]=ee[0],z[le++]=ee[1],z[le++]=ee[2],!Er){const Oa=(Pn+1)%D;Y[$++]=Li+Pn,Y[$++]=Li+D+Pn,Y[$++]=Li+Oa,Y[$++]=Li+Oa,Y[$++]=Li+D+Pn,Y[$++]=Li+D+Oa;for(let Qo=0;Qo<6;Qo++)Z[U++]=Y[$-6+Qo]-ii}Li+=D}const Ni=E[E.length-1];for(let rt=0;rt<C.length;rt++)oe(ee,j,C[rt][0]),oe(Te,W,C[rt][1]),de(ee,ee,Te),de(ee,ee,Ni),z[le++]=ee[0],z[le++]=ee[1],z[le++]=ee[2];const ni=ne/3;V[ne++]=H[0],V[ne++]=H[1],V[ne++]=H[2];const Fi=Li-D;for(let rt=0;rt<M.length;rt++)Y[$++]=M[rt][0]>=0?Li+M[rt][0]:-M[rt][0]-1+Fi,Y[$++]=M[rt][2]>=0?Li+M[rt][2]:-M[rt][2]-1+Fi,Y[$++]=M[rt][1]>=0?Li+M[rt][1]:-M[rt][1]-1+Fi,Z[U++]=ni,Z[U++]=ni,Z[U++]=ni;const Fr=[[A.POSITION,Y],[A.NORMAL,Z]],es=[[A.POSITION,{size:3,data:z,exclusive:!0}],[A.NORMAL,{size:3,data:V,exclusive:!0}]];return new Or(es,Fr)}function m(T,E,C){dt(T.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),dt(T[0].length===3,"createPolylineGeometry(): malformed vertex"),dt(E==null||E.length===T.length,"createPolylineGeometry: need same number of points and normals"),dt(E==null||E[0].length===3,"createPolylineGeometry(): malformed normal");const M=new Float64Array(3*T.length),I=new Uint32Array(2*(T.length-1));let N=0,D=0;for(let k=0;k<T.length;k++){for(let Y=0;Y<3;Y++)M[N++]=T[k][Y];k>0&&(I[D++]=k-1,I[D++]=k)}const z=[],V=[];if(z.push([A.POSITION,I]),V.push([A.POSITION,{size:3,data:M,exclusive:!0}]),E){const k=new Float32Array(3*E.length);let Y=0;for(let Z=0;Z<T.length;Z++)for(let le=0;le<3;le++)k[Y++]=E[Z][le];z.push([A.NORMAL,I]),V.push([A.NORMAL,{size:3,data:k,exclusive:!0}])}return C&&(V.push([A.COLOR,{size:4,data:C}]),z.push([A.COLOR,v2(C.length/4)])),new Or(V,z,ll.Line)}function y(T,E,C,M,I=0){const N=new Array(18),D=[[-E,I,M/2],[C,I,M/2],[0,T+I,M/2],[-E,I,-M/2],[C,I,-M/2],[0,T+I,-M/2]],z=new Uint16Array([0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5]);for(let V=0;V<6;V++)N[3*V]=D[V][0],N[3*V+1]=D[V][1],N[3*V+2]=D[V][2];return new Or([[A.POSITION,{size:3,data:N,exclusive:!0}]],[[A.POSITION,z]])}function v(T,E){const C=T.getMutableAttribute(A.POSITION).data;for(let M=0;M<C.length;M+=3){const I=C[M],N=C[M+1],D=C[M+2];ie(Uw,I,N,D),Ue(Uw,Uw,E),C[M]=Uw[0],C[M+1]=Uw[1],C[M+2]=Uw[2]}}function w(T,E=T){const C=T.vertexAttributes,M=C.get(A.POSITION).data,I=C.get(A.NORMAL).data;if(I){const N=E.getMutableAttribute(A.NORMAL).data;for(let D=0;D<I.length;D+=3){const z=I[D+1];N[D+1]=-I[D+2],N[D+2]=z}}if(M){const N=E.getMutableAttribute(A.POSITION).data;for(let D=0;D<M.length;D+=3){const z=M[D+1];N[D+1]=-M[D+2],N[D+2]=z}}return E}function b(T,E,C,M,I){return!(Math.abs(xe(E,T))>I)&&(lt(C,T,E),we(C,C),lt(M,C,T),we(M,M),!0)}function S(T,E,C,M,I,N,D){return b(T,E,I,N,D)||b(T,C,I,N,D)||b(T,M,I,N,D)}e.createSquareGeometry=l,e.createConeGeometry=c,e.createCylinderGeometry=h,e.createTubeGeometry=p,e.createPathExtrusionGeometry=f,e.createPolylineGeometry=m,e.createExtrudedTriangle=y,e.transformInPlace=v,e.cgToGIS=w,e.makeOrthoBasisDirUp=b,e.makeOrthoBasisDirUpFallback=S}(L7||(L7={}));const Rie=.99619469809,Uw=wi(),Nl=L7,fHe=me.getLogger("esri.views.3d.environment.PanoramicAtmosphere");class mHe{constructor(){this.type="panoramic",this._techniqueConfig=new ZN,this._passParameters=new YX,this._readyResolver=Wd(),this._readyController=new AbortController}destroy(){this._readyResolver.reject(),this._passParameters.texture=Ye(this._passParameters.texture),this._vao=Ye(this._vao),this._readyController=xh(this._readyController)}when(){return this._readyResolver.promise}initializeRenderContext(t){this._techniqueConfig.geometry=Rf.Cylinder,this._technique=t.shaderTechniqueRepository.acquire(h2,this._techniqueConfig);const i=t.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=xo(this._vao,"geometry"),Qd(Sve,{signal:this._readyController.signal}).then(r=>{this._passParameters.texture=new st(i,{pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!0},r),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}).catch(r=>{Gr(r)||fHe.error("Unable to initialize atmosphere: image request failed",r),this._readyResolver.reject()})}get canRender(){return this._passParameters.texture!=null}render(t){const i=t.rctx,r=i.bindTechnique(this._technique,this._passParameters,t.bindParameters);gHe(Mie,t.bindParameters.camera.viewMatrix),r.setUniformMatrix4fv("view",Mie),i.bindVAO(this._vao),r.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Pt.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(t){const i=Nl.createPolySphereGeometry(1,2,!1),r=i.indices.get(A.POSITION);for(let a=0;a<r.length;a+=3){const l=r[a];r[a]=r[a+2],r[a+2]=l}const s=i.vertexAttributes.get(A.POSITION).data,n=Oie.createBuffer(r.length),o=n.position;for(let a=0;a<r.length;++a){const l=3*r[a];o.set(a,0,s[l]),o.set(a,1,s[l+1]),o.set(a,2,s[l+2])}return new Ns(t,Di,{geometry:hc(Oie)},{geometry:ti.createVertex(t,yi.STATIC_DRAW,n.buffer)})}}function gHe(e,t){ms(e,t),e[12]=0,e[13]=0,e[14]=0,e[15]=1}const Mie=Ae(),Oie=Kr().vec3f(A.POSITION);var Tv;(function(e){e[e.Rain=0]="Rain",e[e.Snow=1]="Snow",e[e.COUNT=2]="COUNT"})(Tv||(Tv={}));class N7 extends Ra{constructor(){super(...arguments),this.type=Tv.Rain}}u([G({count:Tv.COUNT})],N7.prototype,"type",void 0);function yHe(e){const t=new Bi;return t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"float"),t.vertex.uniforms.add(new rl("cameraPosition")),t.vertex.uniforms.add(new rl("offset")),t.vertex.uniforms.add(new Pi("width")),t.vertex.uniforms.add(new vr("proj",(i,r)=>r.camera.projectionMatrix)),t.vertex.uniforms.add(new vv("view")),t.vertex.uniforms.add(new Pi("time")),t.varyings.add("vUv","vec2"),t.vertex.code.add(x`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${e.type===Tv.Rain?x`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:x`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),t.fragment.uniforms.add(new Pi("opacity")),t.fragment.uniforms.add(new rl("particleColor")),t.fragment.code.add(x`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${e.type===Tv.Rain?x`d = 0.35 * smoothstep(0.5, 0.0, d);`:x`d = smoothstep(0.5, 0.1, d);`}
      gl_FragColor = opacity * vec4(particleColor * d, d);
    }
  `),t}const vHe=Object.freeze(Object.defineProperty({__proto__:null,build:yHe},Symbol.toStringTag,{value:"Module"}));class _He extends Us{constructor(){super(...arguments),this.time=0,this.radius=1}}class Jm extends lr{initializeProgram(t){const i=Jm.shader.get().build(this.configuration);return new Ji(t.rctx,i,Jm.attributeLocation)}initializePipeline(){return Ut({blending:so(Re.ONE,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}Jm.shader=new Qi(vHe,()=>import("./Precipitation.glsl.dad67a33.js")),Jm.attributeLocation=new Map([[A.POSITION,0],[A.INSTANCEFEATUREATTRIBUTE,1]]);class Pve{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance(t){return _(t.forcedTime)?this._time!==t.forcedTime&&(this._time=t.forcedTime,!0):!(!this.enabled||t.dt===0)&&(this._time+=t.dt,!0)}}let h1=class extends Ee{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._opacity=1,this._width=500,this._offset=O(),this._tile=O(),this._particleColor=wi(),this._particleColorAtNight=wi(),this._nightMultiplier=.7,this._cameraDirection=wi(),this._renderParameters=new _He,this._animation=new Pve,this._updatingTracking=new uf,this._renderParameters.time=0,this._renderParameters.radius=vi(e.view.spatialReference).radius,this._shaderTechniqueRepository=e.context.shaderTechniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechnique=Wi(this._snowTechnique),this._rainTechnique=Wi(this._rainTechnique),this._vao=Ye(this._vao),this._instanceIdBuffer=Ye(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get rainTechnique(){if(R(this._rainTechnique)){const e=new N7;e.type=Tv.Rain,this._rainTechnique=this._shaderTechniqueRepository.acquire(Jm,e)}return this._rainTechnique}get snowTechnique(){if(R(this._snowTechnique)){const e=new N7;e.type=Tv.Snow,this._snowTechnique=this._shaderTechniqueRepository.acquire(Jm,e)}return this._snowTechnique}update(e){return this._animation.advance(e)}render(e,t,i){const r=i==="rainy",s=r?this.rainTechnique:this.snowTechnique;if(!s.compiled)return void this.context.requestRender();const n=e.rctx;if(this._ensureResources(n),R(s)||R(this._vao)||R(this._instanceIdBuffer)||(_(e.bindParameters.clouds.data)&&(this._opacity=1-e.bindParameters.clouds.fadeInOutHeight.factor),this._opacity<=0))return;const o=.35;t=t<.5?jt(0,o,2*t):jt(o,1,2*(t-.5));const a=n.bindTechnique(s);this._renderParameters.camera=e.bindParameters.camera,this._renderParameters.time=(r?this._rainSpeed:this._snowSpeed)*CH(this._animation.time),this._renderParameters.time=this._renderParameters.time%1e5,this._update(a,i,e),n.bindVAO(this._vao);const l=Jm.attributeLocation;a.assertCompatibleVertexAttributeLocations(this._vao),OX(n,l,this._instanceIdBuffer,Pie,0),n.capabilities.instancing.drawArraysInstanced(Pt.TRIANGLES,0,3,this._numParticles*t),PX(n,l,this._instanceIdBuffer,Pie)}_update(e,t,i){const r=i.bindParameters.camera,s=r.eye;this._tile[0]=Math.floor((s[0]+.5*this._width)/this._width),this._tile[1]=Math.floor((s[1]+.5*this._width)/this._width),this._tile[2]=Math.floor((s[2]+.5*this._width)/this._width),this._offset[0]=s[0]-this._tile[0]*this._width,this._offset[1]=s[1]-this._tile[1]*this._width,this._offset[2]=s[2]-this._tile[2]*this._width,e.setUniform1f("width",this._width),e.setUniform3fv("offset",this._offset),e.setUniformMatrix4fv("view",r.viewMatrix),e.setUniform3fv("cameraPosition",s),e.bindPass(null,i.bindParameters),e.setUniform1f("time",this._renderParameters.time),t==="rainy"?ie(this._particleColor,.85,.85,.85):ie(this._particleColor,1,1,1),oe(this._particleColorAtNight,this._particleColor,this._nightMultiplier),we(this._cameraDirection,s);const n=Math.max(0,xe(this._cameraDirection,i.bindParameters.lighting.lightingMainDirection));en(this._particleColor,this._particleColorAtNight,this._particleColor,n),e.setUniform3fv("particleColor",this._particleColor),e.setUniform1f("opacity",this._opacity)}_ensureResources(e){R(this._vao)&&(this._vao=this._createVertexArrayObject(e)),R(this._instanceIdBuffer)&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const t=[];for(let i=0;i<this._numParticles;i++)t.push(i);return ti.createVertex(e,yi.STATIC_DRAW,new Float32Array(t))}_createVertexArrayObject(e){const t=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new Ns(e,Jm.attributeLocation,{geometry:hc(bHe)},{geometry:ti.createVertex(e,yi.STATIC_DRAW,t)})}};u([d({constructOnly:!0})],h1.prototype,"context",void 0),u([d({constructOnly:!0})],h1.prototype,"view",void 0),u([d({readOnly:!0})],h1.prototype,"updating",null),u([d()],h1.prototype,"_updatingTracking",void 0),h1=u([P("esri.views.3d.environment.Precipitation")],h1);const bHe=Kr().vec3f(A.POSITION),Pie=hc(Kr().f32(A.INSTANCEFEATUREATTRIBUTE),1),wHe="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAIACAYAAAE00TaTAAAACXBIWXMAAA7AAAAOwAFq1okJAAAKT2lDQ1BQaG90b3Nob3AgSUNDIHByb2ZpbGUAAHjanVNnVFPpFj333vRCS4iAlEtvUhUIIFJCi4AUkSYqIQkQSoghodkVUcERRUUEG8igiAOOjoCMFVEsDIoK2AfkIaKOg6OIisr74Xuja9a89+bN/rXXPues852zzwfACAyWSDNRNYAMqUIeEeCDx8TG4eQuQIEKJHAAEAizZCFz/SMBAPh+PDwrIsAHvgABeNMLCADATZvAMByH/w/qQplcAYCEAcB0kThLCIAUAEB6jkKmAEBGAYCdmCZTAKAEAGDLY2LjAFAtAGAnf+bTAICd+Jl7AQBblCEVAaCRACATZYhEAGg7AKzPVopFAFgwABRmS8Q5ANgtADBJV2ZIALC3AMDOEAuyAAgMADBRiIUpAAR7AGDIIyN4AISZABRG8lc88SuuEOcqAAB4mbI8uSQ5RYFbCC1xB1dXLh4ozkkXKxQ2YQJhmkAuwnmZGTKBNA/g88wAAKCRFRHgg/P9eM4Ors7ONo62Dl8t6r8G/yJiYuP+5c+rcEAAAOF0ftH+LC+zGoA7BoBt/qIl7gRoXgugdfeLZrIPQLUAoOnaV/Nw+H48PEWhkLnZ2eXk5NhKxEJbYcpXff5nwl/AV/1s+X48/Pf14L7iJIEyXYFHBPjgwsz0TKUcz5IJhGLc5o9H/LcL//wd0yLESWK5WCoU41EScY5EmozzMqUiiUKSKcUl0v9k4t8s+wM+3zUAsGo+AXuRLahdYwP2SycQWHTA4vcAAPK7b8HUKAgDgGiD4c93/+8//UegJQCAZkmScQAAXkQkLlTKsz/HCAAARKCBKrBBG/TBGCzABhzBBdzBC/xgNoRCJMTCQhBCCmSAHHJgKayCQiiGzbAdKmAv1EAdNMBRaIaTcA4uwlW4Dj1wD/phCJ7BKLyBCQRByAgTYSHaiAFiilgjjggXmYX4IcFIBBKLJCDJiBRRIkuRNUgxUopUIFVIHfI9cgI5h1xGupE7yAAygvyGvEcxlIGyUT3UDLVDuag3GoRGogvQZHQxmo8WoJvQcrQaPYw2oefQq2gP2o8+Q8cwwOgYBzPEbDAuxsNCsTgsCZNjy7EirAyrxhqwVqwDu4n1Y8+xdwQSgUXACTYEd0IgYR5BSFhMWE7YSKggHCQ0EdoJNwkDhFHCJyKTqEu0JroR+cQYYjIxh1hILCPWEo8TLxB7iEPENyQSiUMyJ7mQAkmxpFTSEtJG0m5SI+ksqZs0SBojk8naZGuyBzmULCAryIXkneTD5DPkG+Qh8lsKnWJAcaT4U+IoUspqShnlEOU05QZlmDJBVaOaUt2ooVQRNY9aQq2htlKvUYeoEzR1mjnNgxZJS6WtopXTGmgXaPdpr+h0uhHdlR5Ol9BX0svpR+iX6AP0dwwNhhWDx4hnKBmbGAcYZxl3GK+YTKYZ04sZx1QwNzHrmOeZD5lvVVgqtip8FZHKCpVKlSaVGyovVKmqpqreqgtV81XLVI+pXlN9rkZVM1PjqQnUlqtVqp1Q61MbU2epO6iHqmeob1Q/pH5Z/YkGWcNMw09DpFGgsV/jvMYgC2MZs3gsIWsNq4Z1gTXEJrHN2Xx2KruY/R27iz2qqaE5QzNKM1ezUvOUZj8H45hx+Jx0TgnnKKeX836K3hTvKeIpG6Y0TLkxZVxrqpaXllirSKtRq0frvTau7aedpr1Fu1n7gQ5Bx0onXCdHZ4/OBZ3nU9lT3acKpxZNPTr1ri6qa6UbobtEd79up+6Ynr5egJ5Mb6feeb3n+hx9L/1U/W36p/VHDFgGswwkBtsMzhg8xTVxbzwdL8fb8VFDXcNAQ6VhlWGX4YSRudE8o9VGjUYPjGnGXOMk423GbcajJgYmISZLTepN7ppSTbmmKaY7TDtMx83MzaLN1pk1mz0x1zLnm+eb15vft2BaeFostqi2uGVJsuRaplnutrxuhVo5WaVYVVpds0atna0l1rutu6cRp7lOk06rntZnw7Dxtsm2qbcZsOXYBtuutm22fWFnYhdnt8Wuw+6TvZN9un2N/T0HDYfZDqsdWh1+c7RyFDpWOt6azpzuP33F9JbpL2dYzxDP2DPjthPLKcRpnVOb00dnF2e5c4PziIuJS4LLLpc+Lpsbxt3IveRKdPVxXeF60vWdm7Obwu2o26/uNu5p7ofcn8w0nymeWTNz0MPIQ+BR5dE/C5+VMGvfrH5PQ0+BZ7XnIy9jL5FXrdewt6V3qvdh7xc+9j5yn+M+4zw33jLeWV/MN8C3yLfLT8Nvnl+F30N/I/9k/3r/0QCngCUBZwOJgUGBWwL7+Hp8Ib+OPzrbZfay2e1BjKC5QRVBj4KtguXBrSFoyOyQrSH355jOkc5pDoVQfujW0Adh5mGLw34MJ4WHhVeGP45wiFga0TGXNXfR3ENz30T6RJZE3ptnMU85ry1KNSo+qi5qPNo3ujS6P8YuZlnM1VidWElsSxw5LiquNm5svt/87fOH4p3iC+N7F5gvyF1weaHOwvSFpxapLhIsOpZATIhOOJTwQRAqqBaMJfITdyWOCnnCHcJnIi/RNtGI2ENcKh5O8kgqTXqS7JG8NXkkxTOlLOW5hCepkLxMDUzdmzqeFpp2IG0yPTq9MYOSkZBxQqohTZO2Z+pn5mZ2y6xlhbL+xW6Lty8elQfJa7OQrAVZLQq2QqboVFoo1yoHsmdlV2a/zYnKOZarnivN7cyzytuQN5zvn//tEsIS4ZK2pYZLVy0dWOa9rGo5sjxxedsK4xUFK4ZWBqw8uIq2Km3VT6vtV5eufr0mek1rgV7ByoLBtQFr6wtVCuWFfevc1+1dT1gvWd+1YfqGnRs+FYmKrhTbF5cVf9go3HjlG4dvyr+Z3JS0qavEuWTPZtJm6ebeLZ5bDpaql+aXDm4N2dq0Dd9WtO319kXbL5fNKNu7g7ZDuaO/PLi8ZafJzs07P1SkVPRU+lQ27tLdtWHX+G7R7ht7vPY07NXbW7z3/T7JvttVAVVN1WbVZftJ+7P3P66Jqun4lvttXa1ObXHtxwPSA/0HIw6217nU1R3SPVRSj9Yr60cOxx++/p3vdy0NNg1VjZzG4iNwRHnk6fcJ3/ceDTradox7rOEH0x92HWcdL2pCmvKaRptTmvtbYlu6T8w+0dbq3nr8R9sfD5w0PFl5SvNUyWna6YLTk2fyz4ydlZ19fi753GDborZ752PO32oPb++6EHTh0kX/i+c7vDvOXPK4dPKy2+UTV7hXmq86X23qdOo8/pPTT8e7nLuarrlca7nuer21e2b36RueN87d9L158Rb/1tWeOT3dvfN6b/fF9/XfFt1+cif9zsu72Xcn7q28T7xf9EDtQdlD3YfVP1v+3Njv3H9qwHeg89HcR/cGhYPP/pH1jw9DBY+Zj8uGDYbrnjg+OTniP3L96fynQ89kzyaeF/6i/suuFxYvfvjV69fO0ZjRoZfyl5O/bXyl/erA6xmv28bCxh6+yXgzMV70VvvtwXfcdx3vo98PT+R8IH8o/2j5sfVT0Kf7kxmTk/8EA5jz/GMzLdsAAAAgY0hSTQAAeiUAAICDAAD5/wAAgOkAAHUwAADqYAAAOpgAABdvkl/FRgAAAp1JREFUSMd9lcmSEzEQRCtflnqxYZgIThBDAP//kXDQ0pJtuDhqycxWZ5fKERFCERARIAVEyCjCtSFFEjWVa9q7OdJE0oiidIhKhRBROlhloiGVhaYERQHJWFEwMpYKrjUlibI2cqSJIJEpKNmM2c3GkRTOJDnThTMpnMWu0VFszs3Jfbe5bza3w+a229yOIs6zmP3czfn1K2w/for8+EVU15pNmmyqkeJyclinXNJRu1xrUaJmjmdzJiejVNt7zZVBRAIq1RwrsrrWnez+SR7WmQQP/1itKz2q/pmzuJtYnNy2bth9x9z2NLfDcB7FHOcGx6ebOb9/iPzxG/ztg4iorglFiKjzF9HSNphCoRb1OY3RZQJrYgRdT68bmgXGDdBzrTG8qNS7QP/m19ef7tGlcoH7vESYkK70uoPuOLEetz0IqeGoWQW6MlB/j36EnipYGKPWwDRg/RkNhXCNJIzAhMk6PrDePJNII6JHqM5VWqYApCtNFPe0GFFGtOWopWCrEVBSoiQi06KkRRaD08IlxXa/ifz8Jvz2LvjyLnh7F/r8Rei8a8xfjNkIrpmMOQ1C02COrkTEHxGhh+6DQJfXc/eZprXxcIyVIf1LJVgWvKaHvwI/1aQxtv851SQ/nqGXL6MHFVY3nmhLyqKsWO/+qzWif+yS1TpNKq8NezjGPCV69ciZoQj1PwfN6QRpWyCGVMe1D/AAHt3/gefu1Ign3AVpjOiNXkN90JlpL6TUnzFEUU+Jvks0tkp/dY3Fy1TzI24BWwsYJPyg11Q0FqDwK72xIz2kLojbeuxS1FpgtfNWyMX1gFw0j3W7RNeSHTVEe3VaV7SdCzVywFaEt02w7QH7Eeg4AvZDNdJ+Cu1HENsutO+Byi6ilEBZ9BeCNBJceJIjHgAAAABJRU5ErkJggg==",xHe=me.getLogger("esri.views.3d.environment.SimpleAtmosphere"),DP=128,Iie=-R7,$ie=0,N6=50,THe=()=>1-511/512,SHe=iD([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);class EHe{constructor(t){this.view=t,this.type="simple",this._renderData={texV:tt(),silCircleCenter:O(),silCircleV1:O(),silCircleV2:O(),altitudeFade:0,innerScale:0,undergroundFadeAlpha:0},this._passParameters=new YX,this._fadeVaoCount=0,this._readyResolver=Wd(),this._readyController=new AbortController,this.texV1=1,this.canRender=!0,this.isOnMars=If(t.spatialReference);const i=vi(t.spatialReference);this.planetRadius=i.radius,this.outerRimWidth=i.outerAtmosphereRimWidth,this.innerRimFactor=(this.planetRadius+Iie)/this.planetRadius,this.middleRimFactor=(this.planetRadius+$ie)/this.planetRadius,this.outerRimFactor=(this.planetRadius+this.outerRimWidth)/this.planetRadius,this.texV0=$ie/this.outerRimWidth,this.texVScale=this.texV1-this.texV0}destroy(){this._readyResolver.reject(),this._cameraChangeHandle=Ds(this._cameraChangeHandle),this._passParameters.texture=Ye(this._passParameters.texture),this._fadeVao=Ye(this._fadeVao),this._vao=Ye(this._vao),this._readyController=xh(this._readyController)}when(){return this._readyResolver.promise}async initializeRenderContext(t){this._shaderTechniqueRepository=t.shaderTechniqueRepository;const i=t.renderContext.rctx;this._cameraChangeHandle=ae(()=>{var n;return(n=this.view.state)==null?void 0:n.camera},()=>t.requestRender(),Ms),this._vao=this._createRibbon(i),this._vaoCount=xo(this._vao,"geometry"),this._fadeVao=Ma(i),this._fadeVaoCount=xo(this._fadeVao,"geometry");const r=this.isOnMars?wHe:Sve,s=this._readyController.signal;try{const n=await Qd(r,{signal:s});li(s),this._passParameters.texture=new st(i,{pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!0},n),t.requestRender(),this._readyController=null,this._readyResolver.resolve()}catch(n){Gr(n)||xHe.error("Unable to initialize simple atmosphere: image request failed",n),this._readyResolver.reject(n)}}get coneTechnique(){if(R(this._coneTechnique)){const t=new ZN;t.geometry=Rf.Cone,this._coneTechnique=this._shaderTechniqueRepository.acquire(h2,t)}return this._coneTechnique}get undergroundTechnique(){if(R(this._undergroundTechnique)){const t=new ZN;t.geometry=Rf.Underground,this._undergroundTechnique=this._shaderTechniqueRepository.acquire(h2,t)}return this._undergroundTechnique}render(t){const i=t.bindParameters.camera;this._update(i);const r=t.rctx;if(this._renderData.undergroundFadeAlpha<1){const s=r.bindTechnique(this.coneTechnique,this._passParameters,t.bindParameters);s.setUniformMatrix4fv("proj",i.projectionMatrix),s.setUniformMatrix4fv("view",i.viewMatrix),s.setUniform3fv("silCircleCenter",this._renderData.silCircleCenter),s.setUniform3fv("silCircleV1",this._renderData.silCircleV1),s.setUniform3fv("silCircleV2",this._renderData.silCircleV2),s.setUniform2fv("texV",this._renderData.texV),s.setUniform1f("altitudeFade",this._renderData.altitudeFade),s.setUniform1f("innerScale",this._renderData.innerScale),r.bindVAO(this._vao),r.drawArrays(Pt.TRIANGLES,0,this._vaoCount)}if(this._renderData.undergroundFadeAlpha>0){const s=r.bindTechnique(this.undergroundTechnique,this._passParameters,t.bindParameters);s.setUniform1f("undergroundFadeAlpha",this._renderData.undergroundFadeAlpha),s.setUniform3fv("cameraPosition",i.eye),r.bindVAO(this._fadeVao),r.drawArrays(Pt.TRIANGLE_STRIP,0,this._fadeVaoCount)}}renderHaze(){return!1}_update(t){const i=O(),r=this.planetRadius,s=Me(t.eye),n=s-r;if(n<0){const m=Math.min(-n/5e3,1);this._renderData.undergroundFadeAlpha=m}else this._renderData.undergroundFadeAlpha=0;const o=Math.max(N6,n),a=r+Iie;this._renderData.innerScale=CHe(r+o,r,a)-1,this._renderData.altitudeFade=I0e(n),oe(i,t.eye,(r+N6)/s),Die(i,t.center,t.up,r,this._renderData);const l=this._computeScreenRimWidth(t,i,t.up,this._renderData),c=THe(),h=SHe(n);let p=this.texV0+c*this.texVScale,f=this.texV0+l*h*this.texVScale;if(n>N6){Die(t.eye,t.center,t.up,r,this._renderData);const m=this._computeScreenRimWidth(t,t.eye,t.up,this._renderData),y=$e((m-1.5)/(l-1.5),0,1);p=this.texV0+y*c*this.texVScale,f=this.texV0+jt(this.texV1,l*h,y)*this.texVScale}hi(this._renderData.texV,p,f)}_createRibbon(t){const i=new Float32Array(3+3*DP*3),r=new Uint32Array(3*DP*5);i[0]=0,i[1]=0,i[2]=-1;for(let o=0;o<DP;o++){const a=9*o+3;i[a+0]=o,i[a+1]=this.innerRimFactor,i[a+2]=-1,i[a+3]=o,i[a+4]=this.middleRimFactor,i[a+5]=0,i[a+6]=o,i[a+7]=this.outerRimFactor,i[a+8]=1;const l=3*o+1,c=o===DP-1?1:l+3,h=15*o;r[h+0]=l,r[h+1]=l+1,r[h+2]=c+1,r[h+3]=c+1,r[h+4]=c,r[h+5]=l,r[h+6]=l+1,r[h+7]=l+2,r[h+8]=c+2,r[h+9]=c+2,r[h+10]=c+1,r[h+11]=l+1,r[h+12]=l,r[h+13]=c,r[h+14]=0}const s=Lie.createBuffer(r.length),n=s.position;for(let o=0;o<r.length;++o){const a=3*r[o];n.set(o,0,i[a]),n.set(o,1,i[a+1]),n.set(o,2,i[a+2])}return new Ns(t,Di,{geometry:hc(Lie)},{geometry:ti.createVertex(t,yi.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(t,i,r,s){return de(UE,s.silCircleCenter,s.silCircleV2),oe(U6,UE,this.outerRimFactor),C4(F6,i,UE,r),Eie(UE,F6,t.projectionMatrix,t.viewport),Eie(U6,F6,t.projectionMatrix,t.viewport),nr(UE,U6)/t.height}}function Die(e,t,i,r,s){const n=Me(e),o=r*Math.sqrt(n*n-r*r)/n,a=Math.sqrt(r*r-o*o),l=s.silCircleV1,c=s.silCircleV2;return oe(s.silCircleCenter,e,a/n),lt(l,e,t),ba(l)<1&&lt(l,e,i),oe(l,l,o/Me(l)),lt(c,l,e),oe(c,c,o/Me(c)),o}const F6=Ae(),UE=O(),U6=O();function CHe(e,t,i){return e*e/(Math.sqrt(e*e-t*t)*Math.sqrt(e*e-i*i)+t*i)}const Lie=Kr().vec3f(A.POSITION);function eY(e){const t=x`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`,i=x`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`;e.vertex.code.add(t),e.vertex.code.add(i),e.fragment.code.add(t),e.fragment.code.add(i)}function AHe(){const e=new Bi;return e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.COLOR,"vec4"),e.attributes.add(A.SIZE,"float"),e.varyings.add("vcolor","vec4"),e.varyings.add("vsize","float"),e.vertex.uniforms.add([new vr("transform",(t,i)=>RHe(t,i)),new ei("viewport",(t,i)=>i.camera.fullViewport),new We("pixelRatio",(t,i)=>i.camera.pixelRatio)]),e.include(eY),e.vertex.code.add(x`void main(void) {
vec4 posProj = transform * vec4(position, 0);
gl_Position = alignToPixelCenter(posProj, viewport.zw);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),e.fragment.code.add(x`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
gl_FragColor = vec4(vcolor.xyz, intensity);
}`),e}function RHe(e,t){return ms(ty,t.camera.projectionMatrix),ty[10]=24e-8-1,ty[11]=-1,ty[14]=(24e-8-2)*t.camera.near,Nr(ty,ty,t.camera.viewMatrix),Nr(ty,ty,e.modelMatrix)}const ty=Ae(),MHe=Object.freeze(Object.defineProperty({__proto__:null,build:AHe},Symbol.toStringTag,{value:"Module"}));class OHe extends Us{constructor(){super(...arguments),this.modelMatrix=Ae()}}class _5 extends lr{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=_5.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),depthTest:{func:hr.LEQUAL},colorWrite:Jt})}}_5.shader=new Qi(MHe,()=>import("./Stars.glsl.82056bab.js"));const PHe=me.getLogger("esri.views.3d.environment.Stars");let s0=class extends Ee{constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new OHe,this._updatingTracking=new uf}get updating(){return this._updatingTracking.updating||this.loading}get loading(){return _(this._loadDataTask)&&!this._loadDataTask.finished}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=xh(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=Wi(this._technique),this._vao=Ye(this._vao)}render(e){const{rctx:t}=e;if(this._ensureResources(t),R(this._technique)||R(this._vao))return;if(!this._technique.compiled)return void this.requestRender();const i=t.bindTechnique(this._technique,this._renderParameter,e.bindParameters);t.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),t.drawArrays(Pt.POINTS,0,this._numPoints)}_ensureResources(e){if(_(this._technique)||R(kw))return;this._technique=new _5({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=kw.byteLength/Nie;const t=new Float32Array(kw,0,2*this._numPoints),i=new Uint8Array(kw,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,t,i,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type==="sun"?this.view.environment.lighting.date:null,r=>this._update(r),Ft)}_computeDayDuration(e){const t=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+t-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const t=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),r=ms(this._renderParameter.modelMatrix,DHe);BS(r,r,-i*Math.PI),Nr(r,$He,r),BS(r,r,-t*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,t,i,r){const s=Fie.createBuffer(r),n=s.position,o=s.color,a=s.size;for(let l=0;l<r;l++){const c=t[2*l+0],h=t[2*l+1];n.set(l,0,-Math.cos(c)*Math.sin(h)),n.set(l,1,-Math.sin(c)*Math.sin(h)),n.set(l,2,-Math.cos(h));const p=this._unpackUint8Attributes(i[l]),f=this._hexToRGB(IHe[p[1]]);o.set(l,0,255*f[0]),o.set(l,1,255*f[1]),o.set(l,2,255*f[2]),o.set(l,3,255),a.set(l,p[0])}return new Ns(e,Di,{geometry:hc(Fie)},{geometry:ti.createVertex(e,yi.STATIC_DRAW,s.buffer)})}_createLoadDataTask(){if(_(kw))return null;const e=mO(async t=>{const{data:i}=await oOe("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:t});this._verifyStarData(i),kw=i});return e.promise.catch(t=>{Gr(t)||PHe.error(t)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new q("stars:no-data-received","Failed to create stars because star catalogue is missing");const t=e.byteLength/Nie;if(t%1!=0||t>5e4||t<5e3)throw new q("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],s0.prototype,"view",void 0),u([d({constructOnly:!0})],s0.prototype,"requestRender",void 0),u([d({readOnly:!0})],s0.prototype,"updating",null),u([d()],s0.prototype,"_loadDataTask",void 0),u([d()],s0.prototype,"_updatingTracking",void 0),s0=u([P("esri.views.3d.environment.Stars")],s0);const IHe=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],$He=Gq(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),DHe=Gq(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),Nie=9,Fie=Kr().vec3f(A.POSITION).vec4u8(A.COLOR).f32(A.SIZE);let kw=null;var je;(function(e){e[e.MATERIAL=0]="MATERIAL",e[e.MATERIAL_ALPHA=1]="MATERIAL_ALPHA",e[e.MATERIAL_DEPTH=2]="MATERIAL_DEPTH",e[e.MATERIAL_NORMAL=3]="MATERIAL_NORMAL",e[e.MATERIAL_DEPTH_SHADOWMAP_ALL=4]="MATERIAL_DEPTH_SHADOWMAP_ALL",e[e.MATERIAL_HIGHLIGHT=5]="MATERIAL_HIGHLIGHT",e[e.MATERIAL_DEPTH_SHADOWMAP_DEFAULT=6]="MATERIAL_DEPTH_SHADOWMAP_DEFAULT",e[e.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT=7]="MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT"})(je||(je={}));var OA;const LHe=[Se.POSTPROCESSING_ENVIRONMENT_OPAQUE,Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let Uie,la=OA=class extends Ee{constructor(e){super(e),this._handles=new qt,this._context=null,this._pendingAtmosphere=null,this._atmosphere=null}initialize(){this.view._stage.addRenderPlugin(LHe,this)}destroy(){var e;this._pendingAtmosphere=ot(this._pendingAtmosphere),((e=this.view)==null?void 0:e._stage)!=null&&this.view._stage.removeRenderPlugin(this),this._handles=ot(this._handles),this._set("view",null)}get atmosphereType(){return _(this._pendingAtmosphere)?this._pendingAtmosphere.type:_(this._atmosphere)?this._atmosphere.type:"none"}get canRender(){var e;return!!((e=this.view.basemapTerrain)==null?void 0:e.renderer.canRender)||this.view.viewingMode!=="global"}get needsLinearDepth(){return this._selectAtmosphereType()==="realistic"}updateAnimation(e){return!!_(this._precipitation)&&this._precipitation.update(e)}get updating(){return _(this._pendingAtmosphere)||_(this._stars)&&this._stars.updating||_(this._clouds)&&this._clouds.running}get weatherVisible(){return Me(this.view.state.camera.eye)-vi(this.view.spatialReference).radius<=rh}get _stars(){var r,s;const e=this.view,t=(s=(r=e.environment)==null?void 0:r.starsEnabled)!=null?s:!1,i=this._get("_stars");return!t||R(this._context)?(ot(i),null):_(i)?i:new s0({view:e,requestRender:()=>this._setNeedsRender()})}get _precipitation(){const e=this._get("_precipitation");if(!this._precipitationEnabled||R(this._context))return ot(e),null;const t=this.view,i=this._context;return _(e)&&e.context===i?e:(ot(e),new h1({context:i,view:t}))}get _clouds(){const e=this._get("_clouds");if(!this.weatherEnabled||R(this._context))return ot(e),null;if(_(e))return e;const t=this.view,i=this._context;return ot(e),new aa({context:i,view:t,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const e=this._get("_cloudsComposition");if(!this.weatherEnabled||R(this._context))return ot(e),null;const t=this.view.state.viewingMode,i=this._context.renderContext.rctx,r=vi(this.view.spatialReference).radius;return _(e)&&e.viewingMode===t&&e.planetRadius===r?e:(ot(e),new u1({rctx:i,viewingMode:t,planetRadius:r,requestRender:()=>this._setNeedsRender()}))}get _fog(){const e=this._get("_fog");if(!this.weatherEnabled||R(this._context))return ot(e),null;if(_(e))return e;const t=this.view,i=this._context;return ot(e),new MA({context:i,view:t})}get weatherEnabled(){var e,t;return!!((t=(e=this.view)==null?void 0:e.environmentManager)==null?void 0:t.weatherEnabled)}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(e=null){this._context=e,this._handles.add([cl(()=>{var t;return(t=this.view)==null?void 0:t.basemapTerrain},()=>this._updateBasemapTerrain(),Ms),ae(()=>({viewingMode:this.view.viewingMode,atmosphereEnabled:this.view.environment.atmosphereEnabled,atmosphereQuality:this.view.environment.atmosphere.quality}),()=>this._updateAtmosphere(),Ms),ae(()=>this._stars,()=>this._setNeedsRender()),ae(()=>this._clouds,()=>this._updateWeather(this._weatherUpdateParameters),Ft),ae(()=>this._precipitation,()=>this._setNeedsRender()),ae(()=>this._fog,()=>this._updateFog(this._weatherUpdateParameters),Ft),ae(()=>this._weatherUpdateParameters,t=>{this._updateWeather(t),this._updateFog(t)},Ms)])}uninitializeRenderContext(){this._context=null,this._atmosphere=ot(this._atmosphere),this._set("_stars",ot(this._stars)),this._set("_precipitation",ot(this._precipitation)),this._set("_clouds",ot(this._clouds)),this._set("_cloudsComposition",ot(this._cloudsComposition)),this._set("_fog",ot(this._fog))}prepareRender(e){e.bindParameters.clouds.data=H7e(this._clouds)?this._clouds:null}render(e){if(e.pass===je.MATERIAL)switch(e.bindParameters.slot){case Se.POSTPROCESSING_ENVIRONMENT_OPAQUE:_(this._stars)&&this._stars.render(e),_(this._atmosphere)&&this._atmosphere.canRender&&(this._atmosphere.render(e),_(this._cloudsComposition)&&_(e.bindParameters.clouds.data)&&(this.weatherVisible&&_(this._clouds)&&this._clouds.ensureWeatherTile(),this._cloudsComposition.render(e,_(this.view.animation))));break;case Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(_(this._atmosphere)&&this._atmosphere.canRender){const t=this.weatherEnabled?this.view.environment.weather.type:"disabled";if(this._atmosphere.renderHaze(e,t==="rainy"),_(this._fog)){const i=t==="foggy"||t==="rainy"||t==="snowy";(i||this._selectAtmosphereType()!=="realistic")&&this._fog.render(e,i,t==="rainy")}if(_(this._precipitation)){const i=this.view.environment.weather;i.type!=="rainy"&&i.type!=="snowy"||this._precipitation.render(e,i.precipitation,i.type)}}}}get _weatherUpdateParameters(){const e=this.weatherEnabled?this.view.environment.weather:null;return R(e)?null:e.type==="rainy"||e.type==="snowy"?{type:e.type,weatherAdjustment:e.cloudCover,effect:e.precipitation}:{type:e.type,weatherAdjustment:e.type==="foggy"?e.fogStrength:e.cloudCover}}_updateWeather(e){R(e)||R(this._clouds)||(this._clouds.applyPreset(yve[e.type],e.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){_(this._context)&&this._context.requestRender()}_updateFog(e){if(!R(this._fog)&&!R(e))switch(e.type){case"foggy":this._fog.strength=jt(3e-5,.005,e.weatherAdjustment**3),this._setNeedsRender();break;case"rainy":case"snowy":this._fog.strength=jt(4e-6,2e-4,e.effect**3),this._setNeedsRender();break;default:this._fog.strength=4e-6,this._setNeedsRender()}}_updateAtmosphere(){const e=this._selectAtmosphereType();if(this.atmosphereType===e)return;_(this._pendingAtmosphere)&&(this._pendingAtmosphere!==this._atmosphere&&this._pendingAtmosphere.destroy(),this._pendingAtmosphere=null);const t=this._getAtmosphereClass();if(!t)return _(this._atmosphere)&&(this._atmosphere.destroy(),this._atmosphere=null,this._setNeedsRender()),void this._updateBasemapTerrain();const i=new t(this.view);_(this._context)&&i.initializeRenderContext(this._context),R(this._atmosphere)&&(this._atmosphere=i,this._setNeedsRender()),this._pendingAtmosphere=i,i.when().then(()=>{_(this._atmosphere)&&this._pendingAtmosphere&&this._pendingAtmosphere!==this._atmosphere&&(this._atmosphere.destroy(),this._atmosphere=this._pendingAtmosphere),this._pendingAtmosphere=null,this._setNeedsRender(),this._updateBasemapTerrain()}).catch(()=>{this._pendingAtmosphere===i&&(this._pendingAtmosphere=null)})}_getAtmosphereClass(){switch(this._selectAtmosphereType()){case"none":return null;case"realistic":return pie;case"panoramic":return mHe;case"simple":return EHe;default:return}}_selectAtmosphereType(){const e=this.view.get("environment.atmosphereEnabled"),t=this.view.get("environment.atmosphere.quality"),i=this.view.viewingMode;return!e||t==null||$f(this.view.spatialReference)?"none":i==="local"?"panoramic":t==="high"&&_(this._context)&&pie.isSupported(this._context)&&RS(this.view.spatialReference)?"realistic":"simple"}_updateBasemapTerrain(){this.view.basemapTerrain&&(this.view.basemapTerrain.velvetOverground=_(this._atmosphere)&&this.atmosphereType==="simple")}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType(),stubGetAtmosphereClass:e=>{Uie=OA.prototype._getAtmosphereClass,OA.prototype._getAtmosphereClass=e},restoreGetAtmosphereClass:()=>{OA.prototype._getAtmosphereClass=Uie}}}};u([d({constructOnly:!0})],la.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],la.prototype,"updating",null),u([d({readOnly:!0})],la.prototype,"weatherVisible",null),u([d()],la.prototype,"_context",void 0),u([d()],la.prototype,"_pendingAtmosphere",void 0),u([d({readOnly:!0})],la.prototype,"_stars",null),u([d({readOnly:!0})],la.prototype,"_precipitation",null),u([d({readOnly:!0})],la.prototype,"_clouds",null),u([d({readOnly:!0})],la.prototype,"_cloudsComposition",null),u([d({readOnly:!0})],la.prototype,"_fog",null),u([d({readOnly:!0})],la.prototype,"weatherEnabled",null),u([d({readOnly:!0})],la.prototype,"_precipitationEnabled",null),u([d({readOnly:!0})],la.prototype,"_weatherUpdateParameters",null),la=OA=u([P("esri.views.3d.environment.EnvironmentRenderer")],la);function kie(e,t,i){return NHe(e,t.longitude,t.latitude,i.longitude,i.latitude)}function NHe(e,t,i,r,s){const n=$t(i),o=$t(s),a=n-o,l=$t(t)-$t(r),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Hd(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*e;return Math.round(1e4*p)/1e4}function FHe(e,t,i){const r=t.spatialReference,s=vi(r),n=new nt(t.x,e.y,r),o=new nt(i.x,e.y,r),a=new nt(e.x,t.y,r),l=new nt(e.x,i.y,r);return{lon:kie(s.radius,n,o),lat:kie(s.radius,a,l)}}function UHe(e,t,i){const r=t/i,s=$t(e),n=Math.sin(r/2),o=Math.cos(s),a=2*Hd(Math.sqrt(n*n/(o*o)));return ec(a)}function kHe(e,t){let i=e/15;return t||(i=Math.round(i)),i}function zie(e,t){t||(t={hours:0,minutes:0,seconds:0}),t.hours=kHe(e[0],!0);const i=t.hours%1;t.hours-=i,t.minutes=60*i;const r=t.minutes%1;return t.minutes-=r,t.seconds=Math.round(60*r),t}var Vie,Bie,Gie,Ive={exports:{}};Vie=Ive,Bie=function(){var e=Math.PI,t=Math.sin,i=Math.cos,r=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=e/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f($){return $.valueOf()/l-.5+c}function m($){return new Date(($+.5-c)*l)}function y($){return f($)-h}var v=23.4397*a;function w($,U){return n(t($)*i(v)-r(U)*t(v),i($))}function b($,U){return s(t(U)*i(v)+i(U)*t(v)*t($))}function S($,U,B){return n(t($),i($)*t(U)-r(B)*i(U))}function T($,U,B){return s(t(U)*t(B)+i(U)*i(B)*i($))}function E($,U){return a*(280.16+360.9856235*$)-U}function C($){return a*(357.5291+.98560028*$)}function M($){return a*(1.9148*t($)+.02*t(2*$)+3e-4*t(3*$))}function I($,U){return $+U+102.9372*a+e}function N($,U){var B=C($),H=I(B,M(B));return U||(U={dec:0,ra:0}),U.dec=b(H,0),U.ra=w(H,0),U}var D={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function($,U,B,H){var W=a*-B,K=a*U,j=y($),ee=N(j,p),ye=E(j,W)-ee.ra;return H||(H={azimuth:0,altitude:0}),H.azimuth=S(ye,K,ee.dec),H.altitude=T(ye,K,ee.dec),H}},z=[[-.83,"sunrise","sunset"]];D.addTime=function($,U,B){z.push([$,U,B])};var V=9e-4;function k($,U){return Math.round($-V-U/(2*e))}function Y($,U,B){return V+($+U)/(2*e)+B}function Z($,U,B){return h+$+.0053*t(U)-.0069*t(2*B)}function le($,U,B){return o((t($)-t(U)*t(B))/(i(U)*i(B)))}function ne($){var U=a*(134.963+13.064993*$),B=a*(93.272+13.22935*$),H=a*(218.316+13.176396*$)+6.289*a*t(U),W=5.128*a*t(B),K=385001-20905*i(U);return{ra:w(H,W),dec:b(H,W),dist:K}}return D.getTimes=function($,U,B){var H=a*-B,W=a*U,K=k(y($),H),j=Y(0,H,K),ee=C(j),ye=M(ee),Te=I(ee,ye),Ne=b(Te,0),_e=Z(j,ee,Te);function ge(Fi){return Z(Y(le(Fi,W,Ne),H,K),ee,Te)}function Ce(Fi){var Fr=(t(Fi)-t(W)*t(Ne))/(i(W)*i(Ne));return Fr<-1?D.PolarException.MIDNIGHT_SUN:Fr>1?D.PolarException.POLAR_NIGHT:D.PolarException.NORMAL}var Le,Ri,Li,ii,Ni,ni={solarNoon:m(_e),nadir:m(_e-.5),polarException:D.PolarException.NORMAL};for(Le=0,Ri=z.length;Le<Ri;Le+=1)Ni=_e-((ii=ge((Li=z[Le])[0]*a))-_e),ni[Li[1]]=m(Ni),ni[Li[2]]=m(ii);return ni.polarException=Ce(z[0][0]*a),ni},D.getMoonPosition=function($,U,B){var H=a*-B,W=a*U,K=y($),j=ne(K),ee=E(K,H)-j.ra,ye=T(ee,W,j.dec);return ye+=.017*a/r(ye+10.26*a/(ye+5.1*a)),{azimuth:S(ee,W,j.dec),altitude:ye,distance:j.dist}},D.getMoonFraction=function($){var U=y($),B=N(U),H=ne(U),W=149598e3,K=o(t(B.dec)*t(H.dec)+i(B.dec)*i(H.dec)*i(B.ra-H.ra)),j=n(W*t(K),H.dist-W*i(K));return(1+i(j))/2},D},(Gie=Bie())!==void 0&&(Vie.exports=Gie);const Qb=Ive.exports,Zp={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};function zHe(e,t,i,r,s,n,o){ie(o.ambient.color,1,1,1),o.ambient.intensity=Zp.global.ambient,ie(o.direct.color,1,1,1),o.direct.intensity=Zp.global.direct;const a=t[2],l=$e((Math.abs(a)-Zp.local.altitude)/(Zp.global.altitude-Zp.local.altitude),0,1);let c;if(o.globalFactor=l,n==="sun"&&(c=Qb.getTimes(e,t[1],t[0])),l<1){let h;if(n==="sun")h=XHe(e,c,r);else{const p=Dve(r);h={direct:{intensity:Zp.local.directAtNoon*p.direct,color:Fe(1,1,1)},ambient:{intensity:Zp.local.ambientAtNoon*p.ambient,color:Fe(1,1,1)},timeOfDay:"early afternoon"}}en(o.ambient.color,h.ambient.color,o.ambient.color,l),o.ambient.intensity=jt(h.ambient.intensity,o.ambient.intensity,l),en(o.direct.color,h.direct.color,o.direct.color,l),o.direct.intensity=jt(h.direct.intensity,o.direct.intensity,l),o.specularStrength=r==="rainy"||r==="snowy"||r==="foggy"?0:1,o.environmentStrength=r==="rainy"?.7:r==="snowy"||r==="foggy"?.75:1}o.noonFactor=n==="sun"?WHe(e,c):1,n==="sun"?BHe(e,t,i,o.direct.directionToLightSource):VHe(s,i,o.direct.directionToLightSource)}function VHe(e,t,i){t===Ve.Global?we(k6,e.eye):ie(k6,0,0,1),oe(z6,e.viewForward,-1);const r=tD(z6,k6),s=Math.max(r-2*V6,0),n=.85*s/(s+1),o=Math.max(V6,r-V6-n);pu(Hie,-o,e.viewRight),Ue(i,z6,Hie),de(i,i,oe(YHe,e.viewRight,ZHe)),we(i,i)}function BHe(e,t,i,r){const s=qHe,n=Cf(HHe);if(i===Ve.Global)Qb.getPosition(e,0,0,s),ie(r,0,0,-1),VS(n,n,-s.azimuth),S4(n,n,-s.altitude),Ue(r,r,n);else{const o=Zp.planarDirection,a=o.globalAngles,l=t[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=$e(c,0,1),c<1?(Qb.getPosition(e,t[1],t[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),ie(r,0,-1,0),BS(n,n,-s.azimuth),VS(n,n,-s.altitude),Ue(r,r,n)}}function GHe(e,t){if(t===Ve.Global)return!0;const i=Zp.planarDirection;return Math.abs(e)<i.localAltitude}const jHe=Fe(.5773502691896258,-.5773502691896258,.5773502691896258);class $ve{constructor(){this.ambient={color:Fe(1,1,1),intensity:.55},this.direct={color:Fe(1,1,1),intensity:.55,directionToLightSource:Is(jHe)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}}const HHe=Ae(),qHe={azimuth:0,altitude:0};function WHe(e,t){const i=e.valueOf();let r,s;t.polarException===Qb.PolarException.MIDNIGHT_SUN?(r=i-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,s=r+432e6):t.polarException===Qb.PolarException.POLAR_NIGHT?(r=i-2,s=i-1):(r=t.sunrise.valueOf(),s=t.sunset.valueOf());const n=r+(s-r)/2;return 1-$e(Math.abs(i-n)/432e5,0,1)}function Dve(e){switch(e){case"disabled":case"sunny":case"cloudy":return{direct:1,ambient:1};case"rainy":return{direct:.4,ambient:1.2};case"snowy":return{direct:.5,ambient:1.3};case"foggy":return{direct:.2,ambient:1.6}}}function jie(e,t){const i=(e[0]+e[1]+e[2])/3;for(let r=0;r<3;r++)e[r]=e[r]+(i-e[r])*t;return e}function XHe(e,t,i){const r=e.valueOf();let s,n;t.polarException===Qb.PolarException.MIDNIGHT_SUN?(s=r-60*(e.getHours()+48)*60*1e3-60*e.getMinutes()*1e3,n=s+432e6):t.polarException===Qb.PolarException.POLAR_NIGHT?(s=r-2,n=r-1):(s=t.sunrise.valueOf(),n=t.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,m=s+p/2,y=n-p/2,v=n+p/2,w=Zp.local,b=[.01,w.ambientAtNight],S=[.8,.8,1],T=[.01,.01,.01],E=[w.directAtTwilight,w.ambientAtTwilight],C=[1,.6,.5],M=[.8,.8,1],I=[.9*w.directAtNoon,w.ambientAtNoon],N=[1,.98,.98],D=[.98,.98,1],z=[w.directAtNoon,w.ambientAtNoon],V=[1,1,1],k=[1,1,1],Y=I,Z=N,le=D,ne=E,$=C,U=M;let B,H,W=[0,0],K=[0,0,0],j=[0,0,0];r<f||r>v?(W=b,K=T,j=S,H="night"):r<m?(B=m-f,W=lo(r-f,B,b,E),K=lo(r-f,B,T,C),j=lo(r-f,B,S,M),H="sun rising"):r<c?(B=c-m,W=lo(r-m,B,E,I),K=lo(r-m,B,C,N),j=lo(r-m,B,M,D),H="early morning"):r<a?(B=a-c,W=lo(r-c,B,I,z),K=lo(r-c,B,N,V),j=lo(r-c,B,D,k),H="late morning"):r<h?(B=h-a,W=lo(r-a,B,z,Y),K=lo(r-a,B,V,Z),j=lo(r-a,B,k,le),H="early afternoon"):r<y?(B=y-h,W=lo(r-h,B,Y,ne),K=lo(r-h,B,Z,$),j=lo(r-h,B,le,U),H="late afternoon"):r<v&&(B=v-y,W=lo(r-y,B,ne,b),K=lo(r-y,B,$,T),j=lo(r-y,B,U,S),H="sun setting");let ee=0;switch(i){case"rainy":case"foggy":ee=.9;case"snowy":ee=.5}ee>0&&(K=jie(K,ee),j=jie(j,ee));const ye=Fe(K[0],K[1],K[2]),Te=Fe(j[0],j[1],j[2]),Ne=Dve(i);return{direct:{intensity:W[0]*Ne.direct,color:ye},ambient:{intensity:W[1]*Ne.ambient,color:Te},timeOfDay:H}}function lo(e,t,i,r){const s=[];for(let n=0;n<i.length;n++)s[n]=(r[n]-i[n])*e/t+i[n];return s}const Hie=Ae(),k6=O(),z6=O(),YHe=O(),V6=.25,ZHe=.2;let cd=class extends us.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new qt,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new P7,this._ambientLight=new XX,this._moonLight=new bve,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){var e;return(e=this._renderer)==null?void 0:e.view}get updating(){var e;return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!((e=this._renderer)==null?void 0:e.updating))}get weatherEnabled(){var e,t,i;return((e=this._view)==null?void 0:e.environment.atmosphereEnabled)&&!this._disableWeather&&((i=(t=this._view)==null?void 0:t.state)==null?void 0:i.viewingMode)===Ve.Global&&RS(this._view.spatialReference)}get weatherVisible(){var e;return this.weatherEnabled&&((e=this._renderer)==null?void 0:e.weatherVisible)}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new la({view:e});const t=()=>this._updateRenderParameters(),i=()=>this._cameraHandler(),r=()=>this._updateLighting();this._viewHandles.add([ae(()=>e.environment.lighting,s=>this._updateLightingHandler(s),rr),ae(()=>e.environment.lighting.type==="sun"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),rr),ae(()=>e.stationary,()=>this._interactingStationaryHandler()),ae(()=>e.environment.lighting.directShadowsEnabled,t,rr),ae(()=>e.environment.lighting.ambientOcclusionEnabled,t,rr),ae(()=>e.environment.lighting.waterReflectionEnabled,t,rr),ae(()=>{var s;return(s=e.environment.background)==null?void 0:s.color},t,rr),ae(()=>e.spatialReference,()=>this._resetReferencePosition(!0),rr),ae(()=>e.environment.weather.type,r,rr),ae(()=>this.weatherEnabled,r,rr),ae(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ms),ae(()=>e.environment.lighting.type==="sun"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),Ms),ae(()=>e.state.camera,i,Ms),ae(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=ot(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type==="sun"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type==="sun"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const t=this._view.environment.lighting;(t==null?void 0:t.type)==="sun"&&(t.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const t=this._view.environment.lighting;if((t==null?void 0:t.type)!=="virtual"){if(e){if(!t.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!Db(i)){const r=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(r))return void this._requestReferencePositionUpdate(r)}if(this._preupdateTracking(e),_(this._referencePosWGS84Comparable)){const r=zie(this._referencePosWGS84Comparable,qie);_(r)&&(t.autoUpdate(null,r),this._trackingEnabled&&(t.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type==="sun"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const t=this._view;if(!t.ready)return;const i=t.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,t){const i=RS(this._view.spatialReference);if(i&&!Db(this._view.spatialReference))return!1;const r=e.position;return R(this._referencePosWGS84Comparable)&&(this._referencePosWGS84Comparable=O()),i?$3e(r,this._referencePosWGS84Comparable):ie(this._referencePosWGS84Comparable,r.longitude,r.latitude,r.z),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,t)||this._updateLighting(t),!0}_cameraHandlerServerSide(e){const t=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(t))&&this._requestReferencePositionUpdate(t,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=t.z*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e){const t=this._view,i=e||(t.environment.lighting.type==="sun"?t.environment.lighting.date:null),r=this._referencePosWGS84Comparable,s=_(r)?QHe:JHe;if(_(r)){const h=this.weatherVisible?t.environment.weather.type:"disabled";zHe(i,r,t.state.viewingMode,h,t.state.camera,t.environment.lighting.type,s)}const n=this._mainLight,o=s.direct;oe(n.intensity,o.color,o.intensity*Math.PI),se(n.direction,o.directionToLightSource),n.specularStrength=s.specularStrength,n.environmentStrength=s.environmentStrength;const a=this._ambientLight;oe(a.intensity,s.ambient.color,s.ambient.intensity);const l=this._moonLight;en(l.intensity,eqe,tqe,s.globalFactor);const c=(1-.5*s.globalFactor)*(1-.4*s.noonFactor*(1-s.globalFactor));oe(l.intensity,l.intensity,c),se(l.direction,o.directionToLightSource),t._stage.renderView.updateLightSources([n,a,l],1-s.noonFactor,s.globalFactor),this._updateRenderParameters()}_autoUpdateTimezone(e,t=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||R(e))return!1;const i=KHe;i.setTime((t||this._view.environment.lighting.date).getTime());const r=zie(e,qie);if(R(r))return!1;let s=this._view.environment.lighting.positionTimezoneInfo;if(s.autoUpdated){if(s.hours===r.hours&&s.minutes===r.minutes&&s.seconds===r.seconds)return!1}else s=r;const n=i.getUTCHours()-(r.hours-s.hours),o=i.getUTCMinutes()-(r.minutes-s.minutes),a=i.getUTCSeconds()-(r.seconds-s.seconds);return i.setUTCHours(n),i.setUTCMinutes(o),i.setUTCSeconds(a),!t&&this._view.environment.lighting.autoUpdate(i,r)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const t=Gc(this._referencePosWGS84Comparable,!0,s=>GHe(s[2],this._view.state.viewingMode)),i=this._view.environment.background,r=i instanceof C0e?{type:"color",color:jq(qe.toUnitRGBA(i.color))}:{type:"color",color:fi(0,0,0,1)};e.renderView.setRenderParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&t,background:r,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,t=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!t,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=CS(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const s=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(s)}}).catch(s=>{s.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),r=this._referencePosUpdateTimer=CS(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===r&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const t=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(t[0])&&!isNaN(t[1])){const i=this._referencePosMapCoords.z*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=t[0],this._referencePosWGS84Comparable[1]=t[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[t[0],t[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let t=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(t*=this._view.mapCoordsHelper.unitInMeters),t>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(t){e._referencePointUpdateInterval=t},set referencePointUpdateDistThreshold(t){e._referencePointUpdateDistThreshold=t},set referencePosUpdateTimer(t){e._referencePosUpdateTimer=t},set referencePointUpdateDelay(t){e._referencePointUpdateDelay=t},set disableWeather(t){e._disableWeather=t}}}};u([d({type:Boolean,readOnly:!0})],cd.prototype,"updating",null),u([d()],cd.prototype,"disableQueries",void 0),u([d()],cd.prototype,"_disableWeather",void 0),u([d()],cd.prototype,"weatherEnabled",null),u([d()],cd.prototype,"weatherVisible",null),u([d()],cd.prototype,"referencePositionWGS84Comparable",null),u([d()],cd.prototype,"_renderer",void 0),u([d()],cd.prototype,"_referencePosWGS84Comparable",void 0),cd=u([P("esri.views.3d.environment.SceneViewEnvironmentManager")],cd);const QHe=new $ve,JHe=new $ve,KHe=new Date,qie={hours:0,minutes:0,seconds:0},eqe=Fe(.22,.22,.33),tqe=Fe(.22,.22,.22);function NM(e,t){return(e&t)!=0}function KN(e,t,i,r,s,n){e!==0&&(i?(n.min=Math.min(n.min,t),n.max=Math.max(n.max,t)):r!=null?(n.min-=Math.max(0,(t-n.min)*(1-r)),n.max+=Math.max(0,(t-n.max)*(1-r))):s&&(n.min-=Math.max(0,t-n.min-s),n.max+=Math.max(0,t-n.max-s)))}var kt,mr,Rn;(function(e){e[e.NONE=0]="NONE",e[e.ZOOM=1]="ZOOM",e[e.TUMBLE=2]="TUMBLE",e[e.LOOK_AROUND=3]="LOOK_AROUND",e[e.PAN=4]="PAN",e[e.ASCEND=5]="ASCEND"})(kt||(kt={})),function(e){e[e.NONE=0]="NONE",e[e.TILT=1]="TILT",e[e.ALTITUDE=2]="ALTITUDE",e[e.DISTANCE=4]="DISTANCE",e[e.COLLISION=8]="COLLISION",e[e.ALL=15]="ALL",e[e.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"}(mr||(mr={})),function(e){e[e.TUMBLE=0]="TUMBLE",e[e.LOOK_AROUND=1]="LOOK_AROUND"}(Rn||(Rn={}));const Sv={selection:mr.NONE,interactionType:kt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Rn.TUMBLE};function Lve(e,t,i,r){return t=t||e.viewForward,se(r,t),oe(r,r,Math.sign(xe(t,i))),r}function iqe(e,t,i,r){return aqe(e,t,i,nqe(r,t,i,!0))}function rqe(e,t,i,r){const s=xe(i,pe(e,r,t));return de(e,t,oe(e,i,s))}const sqe={dir:O(),len:0,clip:tt()};function nqe(e,t,i,r){const s=sqe;return e?(i&&r&&(s.len=nr(t,i)),se(s.dir,e)):r?(s.len=nr(t,i),pe(s.dir,i,t),oe(s.dir,s.dir,1/s.len)):(pe(s.dir,i,t),we(s.dir,s.dir)),s}function oqe(e,t,i){const r=xe(e,i.dir),s=-ir(e,t);if(s<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return s>0;if((s<0||r<0)&&!(s<0&&r<0))return!0;const n=s/r;return r>0?n<i.clip[1]&&(i.clip[1]=n):n>i.clip[0]&&(i.clip[0]=n),i.clip[0]<=i.clip[1]}function aqe(e,t,i,r){r.clip[0]=0,r.clip[1]=i?r.len:Number.MAX_VALUE;for(let s=0;s<e.length;s++)if(!oqe(e[s],t,r))return!1;return!0}function lqe(e,t,i=Sv){const r=tY(e,t,i);if(r===0)return!1;const s=e.renderCoordsHelper,n=s.getAltitude(t.eye)+r,o=Lve(t,i.interactionDirection,hqe(e,t,Math.sign(r),mqe),fqe),a=se(gqe,t.viewForward),l=s.intersectInfiniteManifold(mu(t.eye,o),n,B6);return t.eye=_(l)?l:s.setAltitude(B6,n,t.eye),t.center=rqe(B6,t.eye,a,t.center),!0}function tY(e,t,i=Sv){if(!cqe(e,i))return 0;const r=dqe(e.state.constraints.altitude,pqe);uqe(e,i,r);const s=e.renderCoordsHelper.getAltitude(t.eye),n=$e(s,r.min,r.max)-s;return Math.abs(n)<=1e-6?0:n}function cqe(e,t){const i=e.state.constraints.altitude;return!(!e.state.isGlobal||!i)&&(t.interactionType!==kt.TUMBLE||!NM(t.selection,mr.TILT))}function uqe(e,t,i){const r=t.interactionType;if(r===kt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===kt.TUMBLE||r===kt.ZOOM,c=tY(e,o),h=c===0?0:e.renderCoordsHelper.getAltitude(o.eye);i.min=s,i.max=n,KN(c,h,l,a,.05*h,i)}function hqe(e,t,i,r){return e.renderCoordsHelper.worldUpAtPosition(t.eye,r),oe(r,r,i),r}function dqe(e,t){return t.min=e.min,t.max=e.max,t}const pqe={min:0,max:0},fqe=O(),mqe=O(),gqe=O(),B6=O();function iY(e,t,i=Sv){if(!e.state.isLocal)return 0;const r=e.state.constraints.distance;if(!e.pointsOfInterest.surfaceOrigin.renderLocation||r===1/0)return 0;LP.min=0,LP.max=r,vqe(e,i,LP);const s=rY(e,t),n=LP.max-s;return n>=-1e-6?0:n}function yqe(e,t,i=Sv){const r=iY(e,t,i);if(r===0)return!1;const s=e.pointsOfInterest.surfaceOrigin,n=rY(e,t)+r,o=se(bqe,t.eye),a=Lve(t,i.interactionDirection,_qe(e,t,Tqe),xqe);if(!Fv(dpe(s.renderLocation,n),mu(t.eye,a),NP))return!1;t.eye=NP;const l=pe(wqe,t.eye,o);t.center=de(NP,t.center,l);const c=e.renderCoordsHelper.getAltitude(t.center),h=e.renderCoordsHelper.intersectInfiniteManifold(t.ray,c,NP);return _(h)&&(t.center=h),!0}function vqe(e,t,i){const r=t.interactionType;if(r===kt.NONE)return;const{min:s,max:n}=i,{interactionStartCamera:o,interactionFactor:a}=t,l=r===kt.ZOOM||r===kt.PAN,c=iY(e,o),h=c===0?0:rY(e,o);i.min=s,i.max=n,KN(c,h,l,a,.05*h,i)}function rY(e,t){const i=e.pointsOfInterest.surfaceOrigin;return nr(t.eye,i.renderLocation)}function _qe(e,t,i){const r=e.pointsOfInterest.surfaceOrigin;return Og(i,t.eye,r.renderLocation)}const LP={min:0,max:0},bqe=O(),wqe=O(),xqe=O(),Tqe=O(),NP=O();var Dr,io;(function(e){e[e.OBJECT=0]="OBJECT",e[e.HUD=1]="HUD",e[e.TERRAIN=2]="TERRAIN",e[e.OVERLAY=3]="OVERLAY",e[e.I3S=4]="I3S",e[e.PCL=5]="PCL",e[e.LOD=6]="LOD",e[e.VOXEL=7]="VOXEL"})(Dr||(Dr={}));class Sqe{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.store=io.ALL}}(function(e){e[e.MIN=0]="MIN",e[e.MINMAX=1]="MINMAX",e[e.ALL=2]="ALL"})(io||(io={}));function Bf(e){return _(e)&&_(e.dist)}function Wie(e){return(t,i,r)=>(en(Xie,t,i,r),!Kq(e,Xie))}function b5(e){return Bf(e)&&e.intersector===Dr.OBJECT&&!!e.target}function w5(e){return Bf(e)&&e.intersector===Dr.HUD&&!!e.target&&_(e.target.center)}const Xie=O();class Eqe{constructor(){this._transform=Ae(),this._transformInverse=new FP({value:this._transform},cs,Ae),this._transformInverseTranspose=new FP(this._transformInverse,dl,Ae),this._transformTranspose=new FP({value:this._transform},dl,Ae),this._transformInverseRotation=new FP({value:this._transform},cve,Sr)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(t){ms(this._transform,t)}multiplyTransform(t){Nr(this._transform,this._transform,t)}set(t){ms(this._transform,t),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(t,i){this.setTransformMatrix(t),this.multiplyTransform(i),this._invalidateLazyTransforms()}}class FP{constructor(t,i,r){this.original=t,this.update=i,this.dirty=!0,this.transform=r()}invalidate(){this.dirty=!0}get value(){return this.dirty&&(this.update(this.transform,this.original.value),this.dirty=!1),this.transform}}class Cqe{constructor(t=0){this.offset=t,this.tmpVertex=O()}applyToVertex(t,i,r){const s=t+this.localOrigin[0],n=i+this.localOrigin[1],o=r+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=t+s*a,this.tmpVertex[1]=i+n*a,this.tmpVertex[2]=r+o*a,this.tmpVertex}applyToAabb(t){for(let n=0;n<3;++n)iy[n]=t[0+n]+this.localOrigin[n],UP[n]=t[3+n]+this.localOrigin[n],zw[n]=iy[n];const i=this.applyToVertex(iy[0],iy[1],iy[2]);for(let n=0;n<3;++n)t[n]=i[n],t[n+3]=i[n];const r=n=>{const o=this.applyToVertex(n[0],n[1],n[2]);for(let a=0;a<3;++a)t[a+0]=Math.min(t[a+0],o[a]),t[a+3]=Math.max(t[a+3],o[a])};for(let n=1;n<8;++n){for(let o=0;o<3;++o)zw[o]=(n&1<<o)==0?iy[o]:UP[o];r(zw)}let s=0;for(let n=0;n<3;++n)iy[n]*UP[n]<0&&(s|=1<<n);if(s!==0&&s!==7){for(let n=0;n<8;++n)if((s&n)==0){for(let o=0;o<3;++o)s[o]?zw[o]=0:zw[o]=(n&1<<o)!=0?iy[o]:UP[o];r(zw)}}for(let n=0;n<3;++n)t[n+0]-=this.localOrigin[n],t[n+3]-=this.localOrigin[n];return t}}const iy=O(),UP=O(),zw=O();class Aqe{constructor(t=0){this.componentLocalOriginLength=0,this._tmpVertex=O(),this._mbs=fn(),this._obb={center:O(),halfSize:wi(),quaternion:null},this._totalOffset=0,this._offset=0,this._resetOffset(t)}_resetOffset(t){this._offset=t,this._totalOffset=t}set offset(t){this._resetOffset(t)}get offset(){return this._offset}set componentOffset(t){this._totalOffset=this._offset+t}set localOrigin(t){this.componentLocalOriginLength=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])}applyToVertex(t,i,r){const s=t,n=i,o=r+this.componentLocalOriginLength,a=this._totalOffset/Math.sqrt(s*s+n*n+o*o);return this._tmpVertex[0]=t+s*a,this._tmpVertex[1]=i+n*a,this._tmpVertex[2]=r+o*a,this._tmpVertex}applyToAabb(t){const i=t[0],r=t[1],s=t[2]+this.componentLocalOriginLength,n=t[3],o=t[4],a=t[5]+this.componentLocalOriginLength,l=i*n<0?0:Math.min(Math.abs(i),Math.abs(n)),c=r*o<0?0:Math.min(Math.abs(r),Math.abs(o)),h=s*a<0?0:Math.min(Math.abs(s),Math.abs(a)),p=Math.sqrt(l*l+c*c+h*h);if(p<this._totalOffset)return t[0]-=i<0?this._totalOffset:0,t[1]-=r<0?this._totalOffset:0,t[2]-=s<0?this._totalOffset:0,t[3]+=n>0?this._totalOffset:0,t[4]+=o>0?this._totalOffset:0,t[5]+=a>0?this._totalOffset:0,t;const f=Math.max(Math.abs(i),Math.abs(n)),m=Math.max(Math.abs(r),Math.abs(o)),y=Math.max(Math.abs(s),Math.abs(a)),v=Math.sqrt(f*f+m*m+y*y),w=this._totalOffset/v,b=this._totalOffset/p;return t[0]+=i*(i>0?w:b),t[1]+=r*(r>0?w:b),t[2]+=s*(s>0?w:b),t[3]+=n*(n<0?w:b),t[4]+=o*(o<0?w:b),t[5]+=a*(a<0?w:b),t}applyToMbs(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this._totalOffset/i;return this._mbs[0]=t[0]+t[0]*r,this._mbs[1]=t[1]+t[1]*r,this._mbs[2]=t[2]+t[2]*r,this._mbs[3]=t[3]+t[3]*this._totalOffset/i,this._mbs}applyToObb(t){const i=t.center,r=this._totalOffset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);this._obb.center[0]=i[0]+i[0]*r,this._obb.center[1]=i[1]+i[1]*r,this._obb.center[2]=i[2]+i[2]*r,eu(this._obb.halfSize,t.halfSize,t.quaternion),de(this._obb.halfSize,this._obb.halfSize,t.center);const s=this._totalOffset/Math.sqrt(this._obb.halfSize[0]*this._obb.halfSize[0]+this._obb.halfSize[1]*this._obb.halfSize[1]+this._obb.halfSize[2]*this._obb.halfSize[2]);return this._obb.halfSize[0]+=this._obb.halfSize[0]*s,this._obb.halfSize[1]+=this._obb.halfSize[1]*s,this._obb.halfSize[2]+=this._obb.halfSize[2]*s,pe(this._obb.halfSize,this._obb.halfSize,t.center),Cg(Jie,t.quaternion),eu(this._obb.halfSize,this._obb.halfSize,Jie),this._obb.halfSize[0]*=this._obb.halfSize[0]<0?-1:1,this._obb.halfSize[1]*=this._obb.halfSize[1]<0?-1:1,this._obb.halfSize[2]*=this._obb.halfSize[2]<0?-1:1,this._obb.quaternion=t.quaternion,this._obb}}class Rqe{constructor(t=0){this.offset=t,this.sphere=fn(),this.tmpVertex=O()}applyToVertex(t,i,r){const s=this.objectTransform.transform;let n=s[0]*t+s[4]*i+s[8]*r+s[12],o=s[1]*t+s[5]*i+s[9]*r+s[13],a=s[2]*t+s[6]*i+s[10]*r+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(t,i){const r=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*r,t[1]+=t[1]*r,t[2]+=t[2]*r;const s=this.offset/Math.sqrt(i[0]*i[0]+i[1]*i[1]+i[2]*i[2]);i[0]+=i[0]*s,i[1]+=i[1]*s,i[2]+=i[2]*s}applyToAabb(t){const i=this.offset/Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]);t[0]+=t[0]*i,t[1]+=t[1]*i,t[2]+=t[2]*i;const r=this.offset/Math.sqrt(t[3]*t[3]+t[4]*t[4]+t[5]*t[5]);return t[3]+=t[3]*r,t[4]+=t[4]*r,t[5]+=t[5]*r,t}applyToBoundingSphere(t){const i=Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2]),r=this.offset/i;return this.sphere[0]=t[0]+t[0]*r,this.sphere[1]=t[1]+t[1]*r,this.sphere[2]=t[2]+t[2]*r,this.sphere[3]=t[3]+t[3]*this.offset/i,this.sphere}}const Yie=new Rqe;function F7(e){return _(e)?(Yie.offset=e,Yie):null}const Zie=new Aqe;function Mqe(e){return _(e)?(Zie.offset=e,Zie):null}const Qie=new Cqe;function Oqe(e){return _(e)?(Qie.offset=e,Qie):null}const Rd="terrain",Jie=Dg();function U7(e,t,i){for(let r=0;r<i;++r)t[2*r]=e[r],t[2*r+1]=e[r]-t[2*r]}function Pqe(e,t){const i=e.length;for(let r=0;r<i;++r)LT[0]=e[r],t[r]=LT[0];return t}function Iqe(e,t){const i=e.length;for(let r=0;r<i;++r)LT[0]=e[r],LT[1]=e[r]-LT[0],t[r]=LT[1];return t}const LT=new Float32Array(2);function k7(e,t){return R(e)&&(e=[]),e.push(t),e}function z7(e,t){if(R(e))return null;const i=e.filter(r=>r!==t);return i.length===0?null:i}function HO(e){return!!_(e)&&!e.visible}function $qe(e,t,i){const r=e.origin.vec3;Cve(G6,-r[0],-r[1],-r[2]),_(e.transformation)?Nr(t,G6,e.transformation):ms(t,G6),i&&(cs(i,t),dl(i,i))}function Dqe(e,t,i,r,s){kP[0]=e.get(t,0),kP[1]=e.get(t,1),kP[2]=e.get(t,2),U7(kP,r_,3),i.set(s,0,r_[0]),r.set(s,0,r_[1]),i.set(s,1,r_[2]),r.set(s,1,r_[3]),i.set(s,2,r_[4]),r.set(s,2,r_[5])}const kP=new Float64Array(3),r_=new Float32Array(6),G6=Ae(),_2=1e-5;class Lqe{constructor(t){this.options=new Sqe,this._results=new Nqe,this.transform=new Eqe,this.tolerance=_2,this.verticalOffset=null,this._ray=Yn(),this._rayEnd=O(),this._rayBeginTransformed=O(),this._rayEndTransformed=O(),this.viewingMode=t==null?Ve.Global:t}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(t,i,r){this.resetWithRay(aPe(t,i,this._ray),r)}resetWithRay(t,i){this.camera=i,t!==this._ray&&vN(t,this._ray),this.options.verticalOffset!==0?this.viewingMode===Ve.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,de(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(t=null,i,r,s,n){this.point=i,this.filterPredicate=s,this.tolerance=r==null?_2:r;const o=F7(this.verticalOffset);if(_(t)&&t.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of t){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();_(c)?(_(o)?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(t){const i=t.geometryRecords;if(!i)return;const r=t.transformation,s=F7(this.verticalOffset);for(const n of i){const{geometry:o,material:a,instanceParameters:l}=n;if(HO(l))continue;const c=o.id;this.transform.setAndInvalidateLazyTransforms(r,n.getShaderTransformation()),Ue(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Ue(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const h=this.transform.transform;_(s)&&(s.objectTransform=this.transform),a.intersect(o,l,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(p,f,m,y,v,w)=>{if(p>=0){if(_(this.filterPredicate)&&!this.filterPredicate(this._ray.origin,this._rayEnd,p))return;const b=y?this._results.hud:this._results,S=y?T=>{const E={object:t,geometryId:c,triangleNr:m,center:_(w)?[w[0],w[1],w[2]]:null};T.set(Dr.HUD,E,p,f,Ks,v)}:T=>T.set(Dr.OBJECT,{object:t,geometryId:c,triangleNr:m},p,f,h,v);if((b.min.drapedLayerOrder==null||v>=b.min.drapedLayerOrder)&&(b.min.dist==null||p<b.min.dist)&&S(b.min),this.options.store!==io.MIN&&(b.max.drapedLayerOrder==null||v<b.max.drapedLayerOrder)&&(b.max.dist==null||p>b.max.dist)&&S(b.max),this.options.store===io.ALL)if(y){const T=new V7(this._ray);S(T),this._results.hud.all.push(T)}else{const T=new lS(this._ray);S(T),this._results.all.push(T)}}},n.shaderTransformation)}}sortResults(t=this._results.all){t.sort((i,r)=>i.dist!==r.dist?yt(i.dist,0)-yt(r.dist,0):i.drapedLayerOrder!==r.drapedLayerOrder?yt(i.drapedLayerOrder,Number.MAX_VALUE)-yt(r.drapedLayerOrder,Number.MAX_VALUE):yt(r.drapedLayerGraphicOrder,Number.MIN_VALUE)-yt(i.drapedLayerGraphicOrder,Number.MIN_VALUE))}}function Mh(e){return new Lqe(e)}class Nqe{constructor(){this.min=new lS(Yn()),this.max=new lS(Yn()),this.hud={min:new V7(Yn()),max:new V7(Yn()),all:new Array},this.ground=new lS(Yn()),this.all=[]}init(t){this.min.init(t),this.max.init(t),this.ground.init(t),this.all.length=0,this.hud.min.init(t),this.hud.max.init(t),this.hud.all.length=0}}class lS{constructor(t){this.intersector=Dr.OBJECT,this.normal=O(),this.transformation=Ae(),this._ray=Yn(),this.init(t)}get ray(){return this._ray}get distanceInRenderSpace(){return _(this.dist)?(oe(zP,this.ray.direction,this.dist),Me(zP)):null}getIntersectionPoint(t){return!!Bf(this)&&(oe(zP,this.ray.direction,this.dist),de(t,this.ray.origin,zP),!0)}getTransformedNormal(t){return se(kE,this.normal),kE[3]=0,Qc(kE,kE,this.transformation),se(t,kE),we(t,t)}init(t){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=Dr.OBJECT,vN(t,this._ray)}set(t,i,r,s,n,o,a){this.intersector=t,this.dist=r,se(this.normal,yt(s,Cle)),ms(this.transformation,yt(n,Ks)),this.target=i,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(t){vN(t.ray,this._ray),this.intersector=t.intersector,this.dist=t.dist,this.target=t.target,this.drapedLayerOrder=t.drapedLayerOrder,this.drapedLayerGraphicOrder=t.drapedLayerGraphicOrder,se(this.normal,t.normal),ms(this.transformation,t.transformation)}}class V7 extends lS{constructor(){super(...arguments),this.intersector=Dr.HUD}}function sY(e){return new lS(e)}const zP=O(),kE=Gt();function Nve(e,t,i,r){return _(e.renderCoordsHelper.fromRenderCoords(t.eye,eF,r))&&rhe(i,eF)}function x5(e,t){return e.elevationProvider?yt(e.elevationProvider.getElevation(t[0],t[1],t[2],e.renderCoordsHelper.spatialReference,"ground"),0):0}function xw(e,t,i,r){const s=e.state.camera.clone();t&&(s.eye=t,s.center=i,s.up=r),Fqe(e,s.ray,ry)||se(ry,s.center);const n=e.state.constraints,o=n.minimumPoiDistance;if($s(s.eye,ry)<o){const a=n.collision.enabled;se(s_,s.viewForward),oe(s_,s_,o),a?s.eye=pe(eF,ry,s_):de(ry,s.eye,s_);const l=e.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(pe(s_,ry,s.eye),s.eye=l.setAltitude(eF,h,s.eye),de(ry,s.eye,s_))}return s.center=ry,s}function Kie(e,t,i){if(!e.state.isGlobal)return!1;const r=x5(e,t),s=e.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(t,i,e.renderDataExtent,r,kqe),o=n*n;return $s(t,i)>o}function Fqe(e,t,i){let r=ere[e.viewingMode];r||(r=Mh(e.state.viewingMode),r.options.backfacesTerrain=!e.state.isGlobal,r.options.invisibleTerrain=!0,ere[e.viewingMode]=r);const{isGlobal:s}=e.state;return!(!e.sceneIntersectionHelper.intersectRay(t,r,i)||Kie(e,t.origin,i))||!(!e.renderCoordsHelper.intersectManifold(t,0,i)||Kie(e,t.origin,i))||!!s&&Uqe(t,i,vi(e.spatialReference).radius)}function Uqe(e,t,i){const r=xe(e.origin,e.origin)-i*i,s=r>0?Math.sqrt(r)/3:1;return oe(t,e.direction,s/Me(e.direction)),de(t,t,e.origin),!0}const ere={},eF=O(),ry=O(),s_=O(),kqe={near:0,far:0};function oE(e,t,i=vh.EYE){const r=e.state.constraints;if(!r.collision.enabled)return!1;const s=x5(e,t.eye),n=e.renderCoordsHelper.getAltitude(t.eye),o=s+r.collision.elevationMargin;if(n>=o)return!1;const a=Me(t.eye);if(pe(VP,t.center,t.eye),t.eye=e.renderCoordsHelper.setAltitude(zqe,o,t.eye),i===vh.EYE_AND_CENTER)t.center=de(VP,t.eye,VP);else if(i===vh.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;t.center=oe(VP,t.center,l)}return!0}var vh;(function(e){e[e.EYE=0]="EYE",e[e.EYE_AND_CENTER=1]="EYE_AND_CENTER",e[e.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})(vh||(vh={}));const VP=O(),zqe=O();function Ev(e,t,i){e.worldUpAtPosition(t,tre),pe(j6,i,t);const r=Me(j6);return r===0?0:tn(xe(j6,tre)/r)}const tre=O(),j6=O();function Fve(e,t,i=Sv,r=!0){zE.eyeCenterDistance=0,zE.requiresTwoSteps=!1;const s=nY(e,t,i,void 0,zE);if(s===0)return!1;switch(pu(BP,-s,t.viewRight),i.tiltMode){case Rn.LOOK_AROUND:Ue(sy,t.viewForward,BP),oe(sy,sy,zE.eyeCenterDistance),t.center=de(S0,t.eye,sy);break;case Rn.TUMBLE:pe(sy,t.center,t.eye),Ue(sy,sy,BP),t.eye=pe(S0,t.center,sy);break;default:i.tiltMode}return t.up=Ue(S0,t.up,BP),!zE.requiresTwoSteps||!r||Fve(e,t,i,!1)}function nY(e,t,i=Sv,r=Sv,s){if(!e.state.constraints.tilt)return 0;const n=t.distance,o=e.state.constraints.tilt(n,Zqe);return Yqe(e,i,o),r.interactionType===kt.TUMBLE&&NM(r.selection,mr.ALTITUDE)&&Uve(e,r.interactionStartCamera,o),i.tiltMode===Rn.LOOK_AROUND||r.tiltMode===Rn.LOOK_AROUND?Bqe(e,t,o,s):Vqe(e,t,o)}function Vqe(e,t,i){const r=Ev(e.renderCoordsHelper,t.center,t.eye),s=r-$e(r,i.min,i.max);return FM(s)?s:0}function Bqe(e,t,i,r){switch(r&&(r.requiresTwoSteps=!1),e.viewingMode){case"global":return jqe(e,t,i,r);case"local":return Gqe(e,t,i,r);default:return void(e.viewingMode,void 0)}}function Gqe(e,t,i,r){const s=Ev(e.renderCoordsHelper,t.center,t.eye),n=$e(s,i.min,i.max),o=s-n;if(!FM(o))return 0;if(r){const a=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=e.renderCoordsHelper.getAltitude(t.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?r.eyeCenterDistance=l/c:r.eyeCenterDistance=t.distance}return o}function jqe(e,t,i,r){const s=Hqe(e,t,Qqe),n=$e(s.tiltAtCenter,i.min,i.max);if(!FM(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=qqe(s),a=Wqe(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),r&&o<Math.PI/2&&(r.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=Xqe(s,o)),r&&(r.eyeCenterDistance=B7(s,o)),a}function Hqe(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=r+vi(e.spatialReference).radius,n=e.renderCoordsHelper.intersectManifold(t.ray,r,S0);return i.eyeCenterDistance=t.distance,i.centerIsOnSurface=!1,_(n)?(i.eyeCenterDistance=nr(t.eye,n),i.tiltAtCenter=Ev(e.renderCoordsHelper,n,t.eye),i.centerIsOnSurface=!0):e.state.isLocal?i.tiltAtCenter=Ev(e.renderCoordsHelper,t.center,t.eye):(q2(O4(P4,s),t.ray,S0),i.eyeCenterDistance=nr(t.eye,S0),i.tiltAtCenter=tn(-xe(t.viewForward,we(S0,S0)))),i.radius=s,i.eyeRadius=Me(t.eye),i.constraints=e.state.constraints,i}function FM(e){return Math.abs(e)>1e-9}function qqe(e){const{constraints:t,eyeCenterDistance:i,tiltAtCenter:r}=e;let s=r,n=t.clampTilt(i,r);const o=B7(e,n);if(t.clampTilt(o,r)===n)return n;let a=0;for(;a<10&&FM(n-s);){const l=(s+n)/2,c=B7(e,l);FM(t.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function B7(e,t){if(!e.centerIsOnSurface)return e.eyeCenterDistance;const i=Math.PI-$e(t,0,Math.PI),r=Hd(e.radius/e.eyeRadius*Math.sin(i)),s=Math.PI-i-r,n=Math.sin(s)/Math.sin(i);if(e.eyeRadius<e.radius&&n>1){const o=Math.PI-r,a=Math.PI-i-o;return Math.sin(a)/Math.sin(i)*e.eyeRadius}return n*e.eyeRadius}function Wqe(e,t){const i=Hd(e.radius/e.eyeRadius*Math.sin(e.tiltAtCenter)),r=Hd(e.radius/e.eyeRadius*Math.sin(t));return e.eyeRadius>e.radius?i-r:r-i}function Xqe(e,t){return e.tiltAtCenter-Math.PI/2-(t-Math.PI/2)}function Yqe(e,t,i){if(t.interactionType===kt.NONE)return;const{interactionStartCamera:r,interactionFactor:s}=t,{min:n,max:o}=i,a=nY(e,r,Sv,t),l=a===0?0:Ev(e.renderCoordsHelper,r.center,r.eye);i.min=n,i.max=o,t.interactionType===kt.TUMBLE?(NM(t.selection,mr.ALTITUDE)&&Uve(e,r,i),KN(a,l,!0,s,ire,i)):KN(a,l,!1,s,ire,i)}function Uve(e,t,i){if(e.state.isLocal)return;const r=e.state.constraints;if(!r.altitude)return;const s=ba(t.center),n=Math.sqrt(s),o=t.distance,a=vi(e.spatialReference).radius,l=r.altitude.min+a,c=r.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);i.min=Math.max(i.min,Math.min(Math.PI-tn(p),i.max)),i.max=Math.min(i.max,Math.PI-tn(h))}const sy=O(),BP=Ae(),S0=O(),ire=$t(5),Zqe={min:0,max:0},Qqe={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},zE={eyeCenterDistance:0,requiresTwoSteps:!1};function Jqe(e){return e}const T5=e=>e*e,oY=e=>1-T5(1-e),Kqe=e=>e<.5?T5(2*e)/2:(oY(2*(e-.5))+1)/2,aY=e=>e*e*e,kve=e=>1-aY(1-e),zve=e=>e<.5?aY(2*e)/2:(kve(2*(e-.5))+1)/2,lY=e=>e*e*e*e,Vve=e=>1-lY(1-e),eWe=e=>e<.5?lY(2*e)/2:(Vve(2*(e-.5))+1)/2,cY=e=>e*e*e*e*e,Bve=e=>1-cY(1-e),tWe=e=>e<.5?cY(2*e)/2:(Bve(2*(e-.5))+1)/2,uY=e=>1-Math.cos(e*Math.PI/2),Gve=e=>1-uY(1-e),iWe=e=>e<.5?uY(2*e)/2:(Gve(2*(e-.5))+1)/2,hY=e=>2**(10*(e-1)),qO=e=>1-hY(1-e),rWe=e=>e<.5?hY(2*e)/2:(qO(2*(e-.5))+1)/2,dY=e=>-(Math.sqrt(1-e*e)-1),jve=e=>1-dY(1-e),sWe=e=>e<.5?dY(2*e)/2:(jve(2*(e-.5))+1)/2;function $h(e){const t=2*(e-Math.sqrt((e-1)*e)),i=t/2/e;return r=>r<i?e*r*r:t*r-t+1}function Dh(e,t){return(i,r)=>i<t?t*e(i/t,r):1-e((1-i)/(1-t),r)*(1-t)}const nWe=Dh($h(1),1),oWe=Dh($h(1),0),Hve=Dh($h(1),.5),aWe=Dh($h(2),1),lWe=Dh($h(2),0),cWe=Dh($h(2),.5),uWe=Dh($h(3),1),hWe=Dh($h(3),0),dWe=Dh($h(3),.5),pWe=Dh($h(4),1),fWe=Dh($h(4),0),mWe=Dh($h(4),.5),gWe={linear:Jqe,"in-quad":T5,"out-quad":oY,"in-out-quad":Kqe,"in-coast-quad":nWe,"out-coast-quad":oWe,"in-out-coast-quad":Hve,"in-cubic":aY,"out-cubic":kve,"in-out-cubic":zve,"in-coast-cubic":aWe,"out-coast-cubic":lWe,"in-out-coast-cubic":cWe,"in-quart":lY,"out-quart":Vve,"in-out-quart":eWe,"in-coast-quart":uWe,"out-coast-quart":hWe,"in-out-coast-quart":dWe,"in-quint":cY,"out-quint":Bve,"in-out-quint":tWe,"in-coast-quint":pWe,"out-coast-quint":fWe,"in-out-coast-quint":mWe,"in-sine":uY,"out-sine":Gve,"in-out-sine":iWe,"in-expo":hY,"out-expo":qO,"in-out-expo":rWe,"in-circ":dY,"out-circ":jve,"in-out-circ":sWe};function as(e,t,i=bWe,r=t){let s=!1;r!==t&&r.copyFrom(t),r.computeUp(e.state.viewingMode);for(let a=0;a<wWe;a++){let l=0;for(const c of _We)if(NM(i.selection,c.type)){const h=Math.abs(c.error(e,r,i));c.apply(e,r,i)&&(s=!0,l+=h)}if(l===0)break}const n=NM(i.selection,mr.COLLISION),o=yWe(i.interactionType,e);return n&&oE(e,r,o)&&(s=!0),s&&r.computeUp(e.state.viewingMode),s}function yWe(e,t){switch(e){case kt.PAN:return vh.EYE_AND_CENTER;case kt.ASCEND:return t.state.isGlobal?vh.EYE_AND_CENTER_SCALE:vh.EYE_AND_CENTER;default:return vh.EYE}}function Sd(e,t){const i=typeof e=="number"?e:EX(e,t),r=Math.min(1,i/150);return zve(r)}function vWe(e,t,i){return nY(e,t,i)*t.distance}const _We=[{type:mr.TILT,error:vWe,apply:Fve},{type:mr.ALTITUDE,error:tY,apply:lqe},{type:mr.DISTANCE,error:iY,apply:yqe}],bWe={selection:mr.ALL,interactionType:kt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Rn.TUMBLE},wWe=5,fc=O(),yl=O(),ny=O(),Po=O(),n_=O(),xWe=O(),mc={upward:Fe(0,0,1),forward:Fe(0,1,0),sideway:Fe(1,0,0)},rre=Sr();class sre{constructor(t=Ve.Global){this.viewingMode=t,this.center=O(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=Is(mc.forward)}pixelsPerPanAtZoom(t){return this.size/2/(this._zoomToPanScale*t)}zoomAtPixelsPerPan(t){return this.size/2/(this._zoomToPanScale*t)}pixelsPerRotateAtZoom(){const t=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/t}compareTo(t,i){if(i||(i={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Ve.Global){const n=(Me(this.center)+Me(t.center))/2;i.pan=tD(this.center,t.center)*n}else i.pan=nr(this.center,t.center);let r=Math.abs(t.yaw-this.yaw);r>=Math.PI&&(r=2*Math.PI-r);const s=Math.abs(t.pitch-this.pitch);return i.rotate=Math.max(r,s),i.sourceZoom=this.distance,i.targetZoom=t.distance,i}interpolate(t,i,r){this.viewingMode===Ve.Global?CPe(t.center,i.center,r.pan,this.center):en(this.center,t.center,i.center,r.pan),this.distance=jt(t.distance,i.distance,r.zoom),this.pitch=jt(t.pitch,i.pitch,r.rotate);let s=t.yaw;const n=i.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=jt(s,n,r.rotate)}copyFrom(t){se(this.center,t.center),this.pitch=t.pitch,this.yaw=t.yaw,this.distance=t.distance,se(this.lookAtDirection,t.lookAtDirection),this.size=t.size,this.copyFromCommon(t),this.viewingMode=t.viewingMode}copyFromRenderCamera(t){const i=this._lookAtOrientation(t.center,rre);se(this.center,t.center),pe(Po,t.center,t.eye),ql(Po,Po,i),ql(n_,t.up,i),this.distance=Me(Po),Po[0]/=this.distance,Po[1]/=this.distance,Po[2]/=this.distance,this.pitch=this._eyeUpToPitch(Po),this.yaw=this._eyeUpToYaw(Po,n_),this.size=Math.sqrt(t.width*t.width+t.height*t.height),this.copyFromCommon(t)}copyFromCommon(t){this.fov=t.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(t){const i=this._lookAtOrientation(this.center,rre);Ah(i,i),this._axisAngleVec3(mc.sideway,this.pitch-Math.PI/2,mc.forward,Po),this._axisAngleVec3(mc.upward,this.yaw,Po),this._axisAngleVec3(mc.sideway,this.pitch-Math.PI/2,mc.upward,n_),this._axisAngleVec3(mc.upward,this.yaw,n_),oe(Po,Po,this.distance),ql(Po,Po,i),ql(n_,n_,i),t.center=this.center,t.eye=pe(Po,this.center,Po),t.up=n_}_axisAngleVec3(t,i,r,s=r){const n=Math.cos(i),o=Math.sin(i);return oe(fc,r,n),lt(yl,t,r),oe(yl,yl,o),oe(ny,t,(1-n)*xe(t,r)),de(s,de(s,fc,yl),ny)}_lookAtOrientation(t,i=Sr()){return this._upAtLookAt(t,ny),lt(fc,this.lookAtDirection,ny),we(fc,fc),fc[0]===0&&fc[1]===0&&fc[2]===0&&se(fc,mc.sideway),lt(yl,ny,fc),we(yl,yl),i[0]=fc[0],i[1]=yl[0],i[2]=ny[0],i[3]=fc[1],i[4]=yl[1],i[5]=ny[1],i[6]=fc[2],i[7]=yl[2],i[8]=ny[2],i}_upAtLookAt(t,i){return this.viewingMode===Ve.Local?se(i,mc.upward):we(i,t)}_eyeUpToPitch(t){return Math.PI-tD(mc.upward,t)}_eyeUpToYaw(t,i){const r=xWe;return Math.abs(i[2])<.5?(se(r,i),t[2]>0&&oe(r,r,-1)):se(r,t),lt(yl,r,mc.upward),we(yl,yl),tD(mc.sideway,yl,mc.upward)}}function pY(e){return e?{ray:Yn(e.ray),c0:e.c0,c1:e.c1}:{ray:Yn(),c0:0,c1:Number.MAX_VALUE}}function TWe(e,t=pY()){return vN(e,t.ray),t.c0=0,t.c1=Number.MAX_VALUE,t}function SWe(e,t,i=pY()){const r=Me(e.vector);return hpe(e.origin,t,i.ray),i.c0=0,i.c1=r,i}function G_t(e,t){return qve(e,e.c0,t)}function j_t(e,t){return qve(e,e.c1,t)}function qve(e,t,i){return de(i,e.ray.origin,oe(i,e.ray.direction,t))}new $g(()=>({c0:0,c1:0,ray:null}));function UM(e){return e?[gi(e[0]),gi(e[1]),gi(e[2]),gi(e[3]),gi(e[4]),gi(e[5])]:[gi(),gi(),gi(),gi(),gi(),gi()]}function Wve(){return[O(),O(),O(),O(),O(),O(),O(),O()]}function tF(e,t){for(let i=0;i<Rg.NUM;i++)I4(e[i],t[i])}function Xve(e,t,i,r=OWe){const s=Nr(qq.get(),t,e);cs(s,s);for(let n=0;n<G7.NUM;++n){const o=Qc(Hq.get(),MWe[n],s);ie(r[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}Yve(i,r)}function Yve(e,t){Bo(t[Je.FAR_BOTTOM_LEFT],t[Je.NEAR_BOTTOM_LEFT],t[Je.NEAR_TOP_LEFT],e[tr.LEFT]),Bo(t[Je.NEAR_BOTTOM_RIGHT],t[Je.FAR_BOTTOM_RIGHT],t[Je.FAR_TOP_RIGHT],e[tr.RIGHT]),Bo(t[Je.FAR_BOTTOM_LEFT],t[Je.FAR_BOTTOM_RIGHT],t[Je.NEAR_BOTTOM_RIGHT],e[tr.BOTTOM]),Bo(t[Je.NEAR_TOP_LEFT],t[Je.NEAR_TOP_RIGHT],t[Je.FAR_TOP_RIGHT],e[tr.TOP]),Bo(t[Je.NEAR_BOTTOM_LEFT],t[Je.NEAR_BOTTOM_RIGHT],t[Je.NEAR_TOP_RIGHT],e[tr.NEAR]),Bo(t[Je.FAR_BOTTOM_RIGHT],t[Je.FAR_BOTTOM_LEFT],t[Je.FAR_TOP_LEFT],e[tr.FAR])}function H0(e,t){for(let i=0;i<Rg.NUM;i++){const r=e[i];if(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]+r[3]>=t[3])return!1}return!0}function EWe(e,t){return Qve(e,TWe(t,Jve.get()))}function H_t(e,t){for(let i=0;i<Rg.NUM;i++){const r=e[i];if(!DPe(r,t))return!1}return!0}function CWe(e,t,i){return Qve(e,SWe(t,i,Jve.get()))}function Zve(e,t){for(let i=0;i<Rg.NUM;i++)if(ir(e[i],t)>0)return!1;return!0}function AWe(e,t){for(let i=0;i<Rg.NUM;i++)if(IPe(e[i],t))return!1;return!0}function Qve(e,t){for(let i=0;i<Rg.NUM;i++)if(!$Pe(e[i],t))return!1;return!0}var tr,Je;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.TOP=3]="TOP",e[e.NEAR=4]="NEAR",e[e.FAR=5]="FAR"})(tr||(tr={})),function(e){e[e.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",e[e.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",e[e.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",e[e.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",e[e.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",e[e.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",e[e.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",e[e.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(Je||(Je={}));const RWe={bottom:[Je.FAR_BOTTOM_RIGHT,Je.NEAR_BOTTOM_RIGHT,Je.NEAR_BOTTOM_LEFT,Je.FAR_BOTTOM_LEFT],near:[Je.NEAR_BOTTOM_LEFT,Je.NEAR_BOTTOM_RIGHT,Je.NEAR_TOP_RIGHT,Je.NEAR_TOP_LEFT],far:[Je.FAR_BOTTOM_RIGHT,Je.FAR_BOTTOM_LEFT,Je.FAR_TOP_LEFT,Je.FAR_TOP_RIGHT],right:[Je.NEAR_BOTTOM_RIGHT,Je.FAR_BOTTOM_RIGHT,Je.FAR_TOP_RIGHT,Je.NEAR_TOP_RIGHT],left:[Je.FAR_BOTTOM_LEFT,Je.NEAR_BOTTOM_LEFT,Je.NEAR_TOP_LEFT,Je.FAR_TOP_LEFT],top:[Je.FAR_TOP_LEFT,Je.NEAR_TOP_LEFT,Je.NEAR_TOP_RIGHT,Je.FAR_TOP_RIGHT]};var Rg,G7;(function(e){e[e.NUM=6]="NUM"})(Rg||(Rg={})),function(e){e[e.NUM=8]="NUM"}(G7||(G7={}));const MWe=[fi(-1,-1,-1,1),fi(1,-1,-1,1),fi(1,1,-1,1),fi(-1,1,-1,1),fi(-1,-1,1,1),fi(1,-1,1,1),fi(1,1,1,1),fi(-1,1,1,1)],Jve=new $g(pY),OWe=Wve(),PWe=me.getLogger("esri.views.3d.webgl-engine.lib.Camera");class Yi{constructor(t=null,i=null,r=null){this._viewUp=O(),this._viewForward=O(),this._viewRight=O(),this._ray=Yn(),this._viewport=fi(0,0,1,1),this._padding=fi(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=Oi(1,1e3),this._viewDirty=!0,this._viewMatrix=Ae(),this._projectionDirty=!0,this._projectionMatrix=Ae(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=Ae(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=Ae(),this._inverseProjectionDirty=!0,this._inverseProjectionMatrix=null,this._frustumDirty=!0,this._frustum=UM(),this._fullViewport=Gt(),this._pixelRatio=1,this.relativeElevation=0,_(t)&&se(this._ray.origin,t),this._center=_(i)?Is(i):O(),this._up=_(r)?Is(r):Fe(0,0,1)}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center)}get ray(){return pe(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up)}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){ms(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get x(){return this._viewport[0]}set x(t){t+=this._padding[Ct.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get y(){return this._viewport[1]}set y(t){t+=this._padding[Ct.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get fullWidth(){return this._viewport[2]+this._padding[Ct.RIGHT]+this._padding[Ct.LEFT]}set fullWidth(t){this.width=t-(this._padding[Ct.RIGHT]+this._padding[Ct.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[Ct.TOP]+this._padding[Ct.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[Ct.TOP]+this._padding[Ct.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[Ct.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[Ct.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){this._padding[Ct.TOP]===t[Ct.TOP]&&this._padding[Ct.RIGHT]===t[Ct.RIGHT]&&this._padding[Ct.BOTTOM]===t[Ct.BOTTOM]&&this._padding[Ct.LEFT]===t[Ct.LEFT]||(this._viewport[0]+=t[Ct.LEFT]-this._padding[Ct.LEFT],this._viewport[1]+=t[Ct.BOTTOM]-this._padding[Ct.BOTTOM],this._viewport[2]-=t[Ct.RIGHT]+t[Ct.LEFT]-(this._padding[Ct.RIGHT]+this._padding[Ct.LEFT]),this._viewport[3]-=t[Ct.TOP]+t[Ct.BOTTOM]-(this._padding[Ct.TOP]+this._padding[Ct.BOTTOM]),Pd(this._padding,t),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0)}get viewProjectionMatrix(){return this._viewProjectionDirty&&(Nr(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){if(this._projectionDirty){const t=this.width,i=this.height,r=this.near*Math.tan(this.fovY/2),s=r*this.aspect;bde(this._projectionMatrix,-s*(1+2*this._padding[Ct.LEFT]/t),s*(1+2*this._padding[Ct.RIGHT]/t),-r*(1+2*this._padding[Ct.BOTTOM]/i),r*(1+2*this._padding[Ct.TOP]/i),this.near,this.far),this._projectionDirty=!1}return this._projectionMatrix}get inverseProjectionMatrix(){return R(this._inverseProjectionMatrix)&&(this._inverseProjectionMatrix=Ae()),this._inverseProjectionDirty&&cs(this._inverseProjectionMatrix,this.projectionMatrix),this._inverseProjectionMatrix}set projectionMatrix(t){ms(this._projectionMatrix,t),this._projectionDirty=!1,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fov(){return this._fov}set fov(t){this._fov=t,this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return cHe(this._fov,this.width,this.height)}set fovX(t){this._fov=aHe(t,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return uHe(this._fov,this.width,this.height)}set fovY(t){this._fov=lHe(t,this.width,this.height),this._projectionDirty=!0,this._inverseProjectionDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return nr(this._center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(cs(this._viewInverseTransposeMatrix,this.viewMatrix),dl(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const i=2*t-1;return 2*this.near*this.far/(this.far+this.near-i*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this._pixelRatio}get aboveGround(){return this.relativeElevation&&this.relativeElevation>=0}copyFrom(t){se(this._ray.origin,t.eye),se(this._center,t.center),se(this._up,t.up),Pd(this._viewport,t.viewport),Pd(this._padding,t.padding),ro(this._nearFar,t.nearFar),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const i=t;return this._viewDirty=i._viewDirty,this._viewDirty||(ms(this._viewMatrix,t.viewMatrix),se(this._viewRight,t.viewRight),se(this._viewUp,t.viewUp),se(this._viewForward,t.viewForward)),i._projectionDirty?this._projectionDirty=!0:(ms(this._projectionMatrix,t.projectionMatrix),this._projectionDirty=!1),this._viewProjectionDirty=!0,this._inverseProjectionDirty=!0,this._frustumDirty=i._frustumDirty,this._frustumDirty||(tF(this._frustum,t.frustum),this._frustumDirty=!1),i._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(ms(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Pd(this._fullViewport,t.fullViewport),this._pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new Yi().copyFrom(this)}equals(t){return tl(this.eye,t.eye)&&tl(this._center,t.center)&&tl(this._up,t.up)&&kR(this._viewport,t.viewport)&&kR(this._padding,t.padding)&&O0e(this._nearFar,t.nearFar)&&this._fov===t.fov&&this._pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(this._pixelRatio!==t.pixelRatio||Math.abs(t.fov-this._fov)>=.001)return!1;const i=5e-4,r=1-1e-10;Kl(Io,t.eye,t.center),Kl(H6,this.eye,this._center);const s=xe(Io,H6),n=YV(Io),o=YV(H6);return s*s>=r*n*o&&pH(t.eye,this.eye)<Math.max(n,o)*i*i&&NL(t.padding,this._padding)<.5&&NL(t.viewport,this._viewport)<.5}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perRenderPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(rR(this.viewForward,pe(Io,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,i){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(i||1)))}getScreenCenter(t=Vr()){return t[0]=(this.padding[Ct.LEFT]+this.width/2)/this._pixelRatio,t[1]=(this.padding[Ct.TOP]+this.height/2)/this._pixelRatio,t}getRenderCenter(t,i=.5,r=.5){return t[0]=this.padding[Ct.LEFT]+this.width*i,t[1]=this.padding[Ct.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const i=this.viewport,r=this.padding;t.setViewport(i[0]-r[3],i[1]-r[2],i[2]+r[1]+r[3],i[3]+r[0]+r[2])}applyProjection(t,i){t!==Vt&&se(Vt,t),Vt[3]=1,Qc(Vt,Vt,this.projectionMatrix);const r=Math.abs(Vt[3]);oe(Vt,Vt,1/r);const s=this.fullViewport;i[0]=jt(0,s[0]+s[2],.5+.5*Vt[0]),i[1]=jt(0,s[1]+s[3],.5+.5*Vt[1]),i[2]=.5*(Vt[2]+1),i[3]=r}unapplyProjection(t,i){const r=this.fullViewport;Vt[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],Vt[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],Vt[2]=(2*t[2]-1)*t[3],Vt[3]=t[3],Qc(Vt,Vt,this.inverseProjectionMatrix),i[0]=Vt[0],i[1]=Vt[1],i[2]=Vt[2]}projectToScreen(t,i){this.projectToRenderScreen(t,q6),this.renderToScreen(q6,i)}projectToRenderScreen(t,i){if(Vt[0]=t[0],Vt[1]=t[1],Vt[2]=t[2],Vt[3]=1,Qc(Vt,Vt,this.viewProjectionMatrix),Vt[3]===0)return null;oe(Vt,Vt,1/Math.abs(Vt[3]));const r=this.fullViewport;return"x"in i?(i.x=jt(0,r[0]+r[2],.5+.5*Vt[0]),i.y=jt(0,r[1]+r[3],.5+.5*Vt[1])):(i[0]=jt(0,r[0]+r[2],.5+.5*Vt[0]),i[1]=jt(0,r[1]+r[3],.5+.5*Vt[1]),i.length>2&&(i[2]=.5*(Vt[2]+1))),i}unprojectFromScreen(t,i){return this.unprojectFromRenderScreen(this.screenToRender(t,q6),i)}unprojectFromRenderScreen(t,i){if(Nr(GP,this.projectionMatrix,this.viewMatrix),!cs(GP,GP))return null;const r=this.fullViewport;return Vt[0]=2*(t[0]-r[0])/r[2]-1,Vt[1]=2*(t[1]-r[1])/r[3]-1,Vt[2]=2*t[2]-1,Vt[3]=1,Qc(Vt,Vt,GP),Vt[3]===0?null:(i[0]=Vt[0]/Vt[3],i[1]=Vt[1]/Vt[3],i[2]=Vt[2]/Vt[3],i)}constrainWindowSize(t,i,r,s=r){const n=t*this._pixelRatio,o=i*this._pixelRatio,a=Math.max(n-r/2,0),l=Math.max(this.fullHeight-o-s/2,0),c=-Math.min(n-r/2,0),h=-Math.min(this.fullHeight-o-s/2,0);return[a,l,r-c- -Math.min(this.fullWidth-n-r/2,0),s-h- -Math.min(o-s/2,0)]}computeUp(t){t===Ve.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,i){const r=t[0]*this._pixelRatio,s=this.fullHeight-t[1]*this._pixelRatio;return i[0]=r,i[1]=s,i}renderToScreen(t,i){const r=t[0]/this._pixelRatio,s=(this.fullHeight-t[1])/this._pixelRatio;i[0]=r,i[1]=s}_computeUpGlobal(){pe(Io,this.center,this.eye);const t=Me(this.center);t<1?(ie(this._up,0,0,1),this._markViewDirty()):Math.abs(xe(Io,this.center))>.9999*Me(Io)*t||(lt(this._up,Io,this.center),lt(this._up,this._up,Io),we(this._up,this._up),this._markViewDirty())}_computeUpLocal(){Og(Io,this.eye,this.center),Math.abs(Io[2])<=.9999&&(oe(Io,Io,Io[2]),ie(this._up,-Io[0],-Io[1],1-Io[2]),we(this._up,this._up),this._markViewDirty())}_compareAndSetView(t,i){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?tl(t,i)||(se(i,t),this._markViewDirty()):PWe.warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(Xve(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(C4(this._viewMatrix,this.eye,this._center,this._up),ie(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ie(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ie(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}}const Vt=Gt(),GP=Ae(),Io=O(),H6=O(),q6=wo();var Ct;(function(e){e[e.TOP=0]="TOP",e[e.RIGHT=1]="RIGHT",e[e.BOTTOM=2]="BOTTOM",e[e.LEFT=3]="LEFT"})(Ct||(Ct={}));const iF={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};class fY{constructor(t){this.createCamera=t,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:iF.desiredScreenFlow},this.source=t(),this.target=t()}clone(){const t=new fY(this.createCamera);return t.copyFrom(this),t}copyFrom(t){this.update(t.source,t.target,t.settings)}update(t,i,r){this.source!==t&&this.source.copyFrom(t),this.target!==i&&this.target.copyFrom(i),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=r.desiredScreenFlow!=null?r.desiredScreenFlow:iF.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(t){const i=this.target.pixelsPerPanAtZoom(t);return this.halfWindowSize/i}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}}class IWe{constructor(){this.segments=[]}get time(){return this.segments.reduce((t,i)=>t+i.time,0)}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1),t*=this.time;let r=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(t<=a.time||o===this.segments.length-1){i=this.segmentInterpolateComponentsAt(a,t/a.time,i),n.hasPan?i.pan=(r+l.compared.pan*i.pan)/n.compared.pan:i.pan=1,n.hasRotate?i.rotate=(s+l.compared.rotate*i.rotate)/n.compared.rotate:i.rotate=1;const c=i.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;return n.hasZoom?i.zoom=(c-h)/(p-h):i.zoom=1,i}t-=a.time,r+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(t,i,r){return t.interpolateComponentsAt(i,r)}}class W6{constructor(t){t&&this.update(t)}get time(){return this._time}update(t){t&&(this.definition?this.definition.copyFrom(t):this.definition=t.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const t=this.definition,i=t.compared,r=i.sourceZoom,s=i.targetZoom;this._zoomSign=r>s?1:-1,this._panPixelsAtSource=i.pan*t.source.pixelsPerPanAtZoom(r);const n=(t.source.pixelsPerRotateAtZoom(r)+t.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=i.rotate*n}_updatePixelFlow(){const t=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom,{hasZoom:r,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;r&&(s&&(o=(i/t-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(t/i)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(r&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(r&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(r&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:r?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:r?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const t=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,i=t*this._panPixelsAtSource;return Math.log(i*(this._zoomPixelFlow/this._panPixelFlow)+1)/(t*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(t){if(t===0||t===1)return t;if(this.definition.hasZoom){const i=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom;return(i*(i/r)**-t-i)/(r-i)}return t}_interpolateComponentsPan(t){if(t===0||t===1)return t;if(this.definition.hasPan&&this.definition.hasZoom){const i=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(i*t*this._time)-1))/(i*Math.LN2)}return t}_interpolateComponentsRotate(t){return t}interpolateComponentsAt(t,i){t=Math.min(Math.max(t,0),1);const r=this._interpolateComponentsZoom(t),s=this._interpolateComponentsPan(t),n=this._interpolateComponentsRotate(t);return i?(i.zoom=r,i.pan=s,i.rotate=n):i={zoom:r,pan:s,rotate:n},i}}function $We(e,t,i){const r=t-e.compared.sourceZoom,s=e.halfWindowPanAtZoom(r);return-e.halfWindowSize*(i.ascensionFactor*Math.LN2*e.compared.pan+s)*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2*s)}function DWe(e,t,i){const r=1/t,s=Math.log(e.compared.sourceZoom*r),n=1/e.desiredPixelFlow,o=1/Math.LN2,a=t-e.compared.sourceZoom,l=1/a,c=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(a))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*r*n*o*l*c-e.halfWindowSize*s*n*o*l+e.halfWindowSize*s*n*o*c/(a*a)}function LWe(e,t,i){const r=t-e.compared.sourceZoom,s=1/r,n=1/t,o=Math.log(e.compared.sourceZoom*n),a=(i.ascensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(r))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function NWe(e,t){return-e.halfWindowSize*Math.log(e.compared.sourceZoom/t)/(e.desiredPixelFlow*Math.LN2)}function FWe(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function UWe(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function kWe(e,t,i){return-e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t))}function zWe(e,t,i){return e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t))}function VWe(e,t,i){return-2*e.compared.pan*e.halfWindowSize*(i.ascensionFactor+i.descensionFactor-1)/(e.desiredPixelFlow*e.halfWindowPanAtZoom(t*t*t))}function BWe(e,t,i){return e.halfWindowSize*(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*e.halfWindowPanAtZoom(-t+e.compared.targetZoom))}function GWe(e,t,i){const r=Math.log(t/e.compared.targetZoom),s=1/e.desiredPixelFlow,n=1/Math.LN2,o=-t+e.compared.targetZoom,a=1/o,l=(-e.halfWindowPanAtZoom(t)-i.descensionFactor*Math.LN2*e.compared.pan+e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return-e.halfWindowSize*r*s*n*a+e.halfWindowSize*r*s*n*l/(o*o)+e.halfWindowSize*s*n*a*l/t}function jWe(e,t,i){const r=t-e.compared.targetZoom,s=1/r,n=1/t,o=Math.log(t/e.compared.targetZoom),a=(e.halfWindowPanAtZoom(t)+i.descensionFactor*Math.LN2*e.compared.pan-e.halfWindowPanAtZoom(e.compared.targetZoom))/e.halfWindowPanAtZoom(1);return e.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(r*r)-a/(t*t))/(e.desiredPixelFlow*Math.LN2)}function HWe(e,t){return e.halfWindowSize*Math.log(t/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2)}function qWe(e,t){return e.halfWindowSize/(t*e.desiredPixelFlow*Math.LN2)}function WWe(e,t){return-e.halfWindowSize/(t*t*e.desiredPixelFlow*Math.LN2)}function XWe(e){const t=Math.LN2*e.compared.pan,i=e.compared.sourceZoom-e.compared.targetZoom,r=e.halfWindowPanAtZoom(i),s=e.halfWindowSize*Math.log(e.compared.sourceZoom/e.compared.targetZoom)/(e.desiredPixelFlow*Math.LN2*r);return e.compared.sourceZoom<=e.compared.targetZoom?s*(t-r):s*(t+r)}function YWe(e,t){let i=ZWe(e,t);const r={ascensionFactor:t.ascensionFactor!=null?t.ascensionFactor:.5,descensionFactor:t.descensionFactor!=null?t.descensionFactor:.5},s=r.ascensionFactor===0,n=r.descensionFactor===0,o=s?NWe:$We,a=s?FWe:DWe,l=s?UWe:LWe,c=n?HWe:BWe,h=n?qWe:GWe,p=n?WWe:jWe,f=E=>o(e,E,r)+kWe(e,E,r)+c(e,E,r),m=E=>a(e,E,r)+zWe(e,E,r)+h(e,E,r),y=E=>l(e,E,r)+VWe(e,E,r)+p(e,E,r);let v=f(i);const w=XWe(e);let b;const S=t.maximumIterations||20,T=t.maximumDistance!=null?t.maximumDistance:1/0;for(b=0;b<S;b++){const C=(m(i)+1e-6)/y(i);if(isNaN(C)||i>=T&&C<0){if(!isFinite(T))return null;i=T,v=f(i);break}if(i-=C,i<e.compared.sourceZoom||i<e.compared.targetZoom)return null;const M=f(i);if(Math.abs(M-v)/v<=.005)break;v=M}return v>w*(1-.3)||i<e.compared.sourceZoom||i<e.compared.targetZoom?null:i}function ZWe(e,t){const i=Math.max(e.compared.sourceZoom,e.compared.targetZoom),r=e.source.zoomAtPixelsPerPan(e.desiredPixelFlow/e.compared.pan)/2;return r<i?t.maximumDistance!=null?i+(t.maximumDistance-i)/2:1.5*i:t.maximumDistance?Math.min(t.maximumDistance,r):r}class QWe extends IWe{constructor(t,i){super(),this._preallocSegments=[new W6,new W6,new W6],this.update(t,i)}update(t,i){if(!t)return;this.definition?this.definition.copyFrom(t):this.definition=t.clone();let r=null;i&&i.apex&&(r=YWe(t,i.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,r==null?this._updateWithoutApex():this._updateWithApex(r,i.apex)}segmentInterpolateComponentsAt(t,i,r){return r=t.interpolateComponentsAt(i,r),t===this._ascensionSegment?r.zoom=oY(r.zoom):t===this._descensionSegment&&(r.zoom=T5(r.zoom)),r}_updateWithApex(t,i){const[r,s,n]=this._preallocSegments,o=i.ascensionFactor!=null?i.ascensionFactor:.5,a=Math.min(1-o,i.ascensionFactor!=null?i.descensionFactor:.5),l=1-o-a;r.definition?r.definition.copyFrom(this.definition):r.definition=this.definition.clone(),r.definition.compared.targetZoom=t,r.definition.compared.pan=this.definition.compared.pan*o,r.definition.compared.rotate=this.definition.compared.rotate*o,r.update(),this._ascensionSegment=r,this.segments.push(r),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=t,s.definition.compared.targetZoom=t,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=t,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[t]=this._preallocSegments;t.update(this.definition),this.segments.push(t)}}const JWe={zoom:0,pan:0,rotate:0};class KWe{constructor(t){this.createCamera=t,this._time=0,this.definition=new fY(t),this.path=new QWe}get time(){return this._time}update(t,i,r){this.definition.update(t,i,r),this.path.update(this.definition,r),this._time=this._applyTimeSettings(uce(this.path.time),r),this._easing=r.easing?r.easing:this._time>=1e3?Hve:qO}cameraAt(t,i){i=i||this.createCamera(),t=Math.min(Math.max(0,t),1),t=this._normalizedEasing(t);const r=this.path.interpolateComponentsAt(t,JWe);return i.interpolate(this.definition.source,this.definition.target,r),i}_normalizedEasing(t){const i=this._easing(0,this._time),r=this._easing(1,this._time);return(this._easing(t,this._time)-i)/(r-i)}_applyTimeSettings(t,i){const r=i.speedFactor!=null?i.speedFactor:1;i.duration!=null?t=i.duration:i.speedFactor!=null&&(t=t/r);const s=i.minDuration!=null?i.minDuration:iF.minDuration/r,n=i.maxDuration!=null?i.maxDuration:iF.maxDuration/r;return Math.min(Math.max(s,t),n)}}const eXe=O();class tXe{constructor(t){this.currentTime=0,this._animation=new KWe(()=>new sre(t)),this._current=new sre(t)}get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}update(t,i,r){const s=this._animation.definition.source,n=this._animation.definition.target,o=pe(eXe,i.center,t.center),a=Me(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),se(s.lookAtDirection,o),se(n.lookAtDirection,o),s.copyFromRenderCamera(t),n.copyFromRenderCamera(i),this._current.copyFrom(s),this._animation.update(s,n,r),this.currentTime=0,t.almostEquals(i)&&(this.currentTime=this._animation.time)}cameraAt(t,i){return this._animation.cameraAt(t,this._current),i=i||new Yi,this._current.copyToRenderCamera(i),i}step(t,i){return this.finished||(this.currentTime=this.currentTime+uce(t),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,i)}}var Ir;(function(e){e.Ready="ready",e.Rejected="rejected",e.Running="running",e.Stopped="stopped",e.Finished="finished"})(Ir||(Ir={}));let eb=class extends Ee{constructor(){super(...arguments),this.state=Ir.Ready}get active(){return this.state===Ir.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=Ir.Stopped,!0)}finishController(){this.state=Ir.Finished}get steppingFinished(){return!1}};u([d({readOnly:!0})],eb.prototype,"active",null),u([d()],eb.prototype,"state",void 0),eb=u([P("esri.views.3d.state.controllers.CameraController")],eb);let kM=class extends eb{get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(ui()),this._asyncResult=null),this.state===Ir.Finished||this.state===Ir.Stopped?this.state===Ir.Finished?e.resolve():e.reject(ui()):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=Ir.Running,_(this.viewAnimation)&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){!_(this.viewAnimation)||this.state!==Ir.Ready&&this.state!==Ir.Running||(this.viewAnimation.state===s2.State.FINISHED?this.finish():this.viewAnimation.state===s2.State.STOPPED&&(this.state=Ir.Stopped))}onControllerEnd(){_(this.viewAnimation)&&!this.viewAnimation.done&&(this.state===Ir.Finished?this.viewAnimation.finish():this.state===Ir.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===Ir.Finished?this._asyncResult.resolve():this._asyncResult.reject(ui()))}finish(){this.finishController()}};kM=u([P("esri.views.3d.state.controllers.AnimationController")],kM);let Km=class extends kM{constructor(e){super(e),this.view=null,this.mode="interaction",this.hasTarget=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.animation=new tXe(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new s2}get isInteractive(){return this.mode==="interaction"}begin(e,t){this.hasTarget=!0;const i=this.animationSettings(t);jP.copyFrom(this.view.state.camera);const r=Mh(this.view.state.viewingMode);this.intersectionHelper.intersectRay(jP.ray,r,nre)&&(jP.center=nre),this.animation.update(jP,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this.hasTarget&&this.animation.finished}stepController(e,t){this.hasTarget&&this.animation.step(e,t)}onControllerEnd(e){this.hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return ve(F({apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0}},e),{easing:typeof e.easing=="string"?gWe[e.easing]:e.easing})}};u([d({constructOnly:!0})],Km.prototype,"view",void 0),u([d({constructOnly:!0})],Km.prototype,"mode",void 0),Km=u([P("esri.views.3d.state.controllers.PointToPointAnimationController")],Km);const jP=new Yi,nre=O();function Kve(e,t,i){return iXe(e,e.screenToRender(t,He.get()),i)}function iXe(e,t,i){const r=ro(He.get(),t);if(r[2]=0,!e.unprojectFromRenderScreen(r,i.origin))return null;const s=ro(He.get(),t);s[2]=1;const n=e.unprojectFromRenderScreen(s,He.get());return R(n)?null:(pe(i.direction,n,i.origin),i)}function aE(e,t,i){return mY(e,e.screenToRender(t,He.get()),i)}function mY(e,t,i){se(i.origin,e.eye);const r=ie(He.get(),t[0],t[1],1),s=e.unprojectFromRenderScreen(r,He.get());return R(s)?null:(pe(i.direction,s,i.origin),i)}function gY(e,t,i,r){const s=aE(t,i,rXe);return Fv(e,s,r)}const rXe=Yn();var b2;(function(e){e[e.Ellipsoid=0]="Ellipsoid",e[e.Silhouette=1]="Silhouette"})(b2||(b2={}));const e_e=30,rF=[1,3e8],t_e=70;function _b(e,t,i){return i[0]=t[0]/(e.fullWidth/e.pixelRatio),i[1]=t[1]/(e.fullHeight/e.pixelRatio),i}function j7(e){for(;e>Math.PI;)e-=2*Math.PI;for(;e<-Math.PI;)e+=2*Math.PI;return e}function Cv(e,t,i){const r=pu(qq.get(),i[3],i);R(r)||(pe(ki,e.eye,t),Ue(ki,ki,r),e.eye=de(ki,ki,t),pe(ki,e.center,t),Ue(ki,ki,r),e.center=de(ki,ki,t),e.up=Ue(ki,e.up,r))}function sXe(e,t,i,r){return gw(e,Kve(t,i,_Y),r)}function H7(e,t,i,r){return gw(e,aE(t,i,_Y),r)}function yY(e,t,i,r){const s=He.get();let n=1-i;pe(s,t,e.eye);const o=Me(s);let a=o*(1-n);n>=0&&a<r&&(a=r,n=-(a-o)/o),Math.abs(o-a)<1e-6||(oe(s,s,n),e.eye=de(ki,e.eye,s),e.center=en(ki,e.center,t,n))}function i_e(e,t,i){t.getScreenCenter(ore),gY(e,t,ore,ki)&&(t.center=ki);const r=t.distance,s=r*i;if(Math.abs(r-s)<1e-6)return;const n=oe(He.get(),t.viewForward,s);t.eye=pe(ki,t.center,n)}const ore=Vr();function X6(e,t){ie(t,0,0,0);for(const i of e)de(t,t,i);oe(t,t,1/e.length)}function HD(e,t,i,r){return Math.sin(e/Me(t))*(i+r.radius)}function are(e,t,i,r){return HD(Math.PI/2,t,i,r)+(e-Math.PI/2)}var Zn;(function(e){e[e.Vertical=0]="Vertical",e[e.Horizontal=1]="Horizontal"})(Zn||(Zn={}));const lre={Elevation:3e4,Angle:$t(6)},vR={Pole:.95,Angle:$t(18),Tilt:45},r_e=$t(80);function s_e(e,t,i,r,s,n){const o=O(),a=fn();let l=!0,c=!0;return e.intersectScreen(i,o,n)?a[3]=Me(o):(c=!1,t.aboveGround&&s!==b2.Ellipsoid?a[3]=Math.max(Me(t.center),.9*r.radius):a[3]=Me(t.eye)-t.relativeElevation,s===b2.Silhouette?zM(a,t,i,o):l=gY(a,t,i,o)),{sphere:a,scenePickPoint:l?o:null,hasGeometryIntersection:c}}function S5(e,t,i,r){return Me(e.eye)-r.radius>lre.Elevation?Zn.Horizontal:i?(aE(e,t,gre),-Math.sign(e.relativeElevation)*(.5*Math.PI+Xq(e.eye,gre.direction))<lre.Angle?Zn.Vertical:Zn.Horizontal):Zn.Vertical}function n_e(e,t,i){pe(Y6,i,t),e.eye=pe(ki,e.eye,Y6),e.center=pe(ki,e.center,Y6)}const Y6=O();function zM(e,t,i,r){const s=aE(t,i,_Y);return!R(s)&&(q2(e,s,HP),Fv(e,s,r)?!($s(HP,s.origin)<$s(r,s.origin))||(se(r,HP),!1):(pe(Vw,t.eye,t.center),we(Vw,Vw),bpe(Vw,-xe(we(Vw,Vw),HP),cre),gw(cre,s,r),!1))}const HP=O(),Vw=O(),cre=gi();function o_e(e,t,i,r,s,n){let o;if(lt(oF,e,t),pe(YP,e,t),Me(e)<=s||!r.aboveGround){lt(i,YP,r.eye);const a=xe(e,t)/(Me(e)*Me(t)),l=Math.cos($e(pv.normalize($t(n)),0,r_e));o=-tn(a)-Math.max(0,Me(t)-s)/(l*s)}else pe(ure,r.eye,r.center),lt(i,YP,ure),o=-Me(YP)/s;return we(i,i),oe(i,i,Me(oF)),o}const ure=O();function hre(e,t,i,r){let s,n;const o=Math.cos($e(pv.normalize($t(r)),0,r_e));return s=t>i?-(t-i)/(o*i):t<-i?Math.PI-(t+i)/(o*i):tn(t/i),n=e>i?-(e-i)/(o*i):e<-i?Math.PI-(e+i)/(o*i):tn(e/i),(n-s)*i}function nXe(e,t,i,r,s,n,o,a,l,c){const h=hre(e[2],t[2],o[3],l),p=c?hre(e[0],t[0],o[3],180):t[0]-e[0],f=Math.sin(a)*p-Math.cos(a)*h,m=Math.cos(a)*p+Math.sin(a)*h;we(ki,s);const y=c?f/Math.sqrt(Math.abs(o[3]**2-xe(i,ki)**2)):f/o[3],v=m/Math.sqrt(Math.abs(o[3]**2-xe(i,r)**2));hi(n,y,v)}function a_e(e,t,i,r,s,n,o,a,l,c){lt(oF,e,t),l9(n.up,n.eye,qP,WP,XP),l9([0,0,1],n.eye,lg,ov,h_e),se(i,ov),se(r,lg),we(i,i),oe(i,i,Me(oF)),AJ(e,we(WP,WP),we(XP,XP),we(qP,qP),dre),AJ(t,WP,XP,qP,pre),nXe(dre,pre,e,lg,ov,s,o,a,l,c)}function oXe(e,t,i,r,s,n,o){pu(sF,s,r),pu(nF,o,n),Nr(NT,sF,nF),pe(t,e,i),Ue(t,t,NT),de(t,t,i)}function l_e(e,t,i,r,s,n){pu(sF,r,i),pu(nF,n,s),Nr(NT,sF,nF),pe(ki,e.eye,t),Ue(ki,ki,NT),e.eye=de(ki,ki,t),pe(ki,e.center,t),Ue(ki,ki,NT),e.center=de(ki,ki,t),pe(ki,e.up,t),Ue(ki,ki,NT),e.up=de(ki,ki,t)}function vY(e,t,i,r,s,n,o=vR.Pole,a=vR.Angle){const l=Math.abs(r)>Math.PI-a||Math.abs(r)<a,c=Math.abs(e[2])<i*o||Math.abs(t)>i;return!!(l&&c&&n.aboveGround&&s<vR.Tilt)}function c_e(e,t,i,r,s,n){if(n)wM(i,r,fre),Cv(t,e,fre);else{const o=o_e(i,r,mre,t,e[3],s);Cv(t,e,bM(mre,o))}}function u_e(e,t,i,r,s,n,o){const a=o?20:1,l=1e-12;let c,h;se(o_,r),ZP.copyFrom(t);for(let p=0;p<a&&$s(i,o_)>l&&(c=$s(i,o_),a_e(i,o_,ov,lg,VE,ZP,e,s,n,o),l_e(ZP,e,lg,VE[1],ov,VE[0]),oXe(o_,o_,e,lg,VE[1],ov,VE[0]),h=$s(i,o_),h<c||p===0);p++)t.copyFrom(ZP)}function aXe(e,t,i,r,s,n,o){vY(i,xe(t.up,i),e[3],-pv.normalize($t(s)),n,t,vR.Pole,vR.Angle)?u_e(e,t,i,r,-pv.normalize($t(s)),n,o):c_e(e,t,i,r,n,o)}function lXe(e,t,i,r,s,n){const{eye:o}=e;l9([0,0,1],o,lg,ov,h_e);const a=t.translation[0]*i.pan,l=s.mode==="zoom"?0:t.translation[1]*i.pan,c=Math.max(Math.sqrt(Math.abs(1-xe(e.center,lg)**2/Me(e.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(Wl(r.pan.matrix,r.pan.matrix,h,lg),r.pan.enabled=!0,s.mode){case"pan":Wl(r.pan.matrix,r.pan.matrix,p,ov),r.pan.enabled=!0;break;case"zoom":r.zoom=-t.translation[1]*i.zoom}}function cXe(e,t,i,r,s){const{eye:n,viewRight:o}=e,a=lt(He.get(),o,n),l=t.translation[0]*i.pan;switch(l!==0&&(Wl(r.pan.matrix,r.pan.matrix,-l,a),r.pan.enabled=!0),s.mode){case"pan":{const c=t.translation[1]*i.pan;c!==0&&(Wl(r.pan.matrix,r.pan.matrix,c,o),r.pan.enabled=!0);break}case"zoom":r.zoom=-t.translation[1]*i.zoom}}function uXe(e,t,i,r,s,n,o,a,l){vY(e.center,xe(e.up,e.center),Me(e.center),-pv.normalize($t(n)),o,t)?lXe(t,i,r,a,l,-pv.normalize($t(s))):cXe(t,i,r,a,l)}const lg=O(),ov=O(),h_e=O(),qP=O(),WP=O(),XP=O(),dre=O(),pre=O(),VE=tt(),fre=sE(),sF=Ae(),nF=Ae(),NT=Ae(),o_=O(),ki=O(),YP=O(),ZP=new Yi,oF=O(),mre=O(),_Y={origin:O(),direction:O()},gre={origin:O(),direction:O()},yre=.6,Z6=4,hXe=12,dXe=60,pXe=200;let aF=class extends Km{constructor(){super(...arguments),this.zoomLocation=O(),this.tmpCamera=new Yi,this.tmpViewDir=O(),this.tmpRayDir={origin:O(),direction:O()},this.targetOnSphere=O(),this.tmpCenter=O(),this.constraintOptions={selection:mr.ALL_EXCEPT_COLLISION,interactionType:kt.ZOOM,interactionFactor:null,interactionStartCamera:new Yi,interactionDirection:null,tiltMode:Rn.TUMBLE},this.sphere=fn()}initialize(){this.intersector=Mh(this.view.state.viewingMode)}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r);let s=!1,n=!1;this.intersectionHelper.intersectScreen(t,this.zoomLocation,this.view.map.ground.opacity===0?fXe:{})&&(s=e>0,n=!0),this.tmpCamera.copyFrom(i.camera),s?this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter):this.intersectionHelper.intersectRay(this.tmpCamera.ray,this.intersector,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:se(this.zoomLocation,this.tmpCamera.center),this._updateCamera(this.tmpCamera,e,this.zoomLocation,t,n),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:qO}}_updateCamera(e,t,i,r,s){const n=vi(this.view.spatialReference),o=S5(e,r,s,n);let a;this.view.camera.position.hasZ&&(a=Math.abs(this.view.camera.position.z)),we(JP,e.eye),oe(JP,JP,-1),aE(e,r,this.tmpRayDir),we(this.tmpRayDir.direction,this.tmpRayDir.direction);const l=Math.max(Math.min(hXe,1/Math.abs(xe(JP,this.tmpRayDir.direction)))*a,pXe);if(o===Zn.Horizontal){let c=yre**t;this.sphere[3]=Me(i),pe(this.tmpViewDir,e.center,e.eye);const h=Math.min(Me(this.tmpViewDir),l);let p=h*c;if(c<=1&&p<Z6&&(p=Z6,c=p/h),Math.abs(h-p)<1e-6)return;const f=Me(e.center);if(this.sphere[3]!==f){const m=this.sphere[3]+c*(f-this.sphere[3]);e.center=oe(QP,e.center,m/f)}oe(this.tmpViewDir,this.tmpViewDir,-c),e.eye=de(QP,e.center,this.tmpViewDir),as(this.view,e,this.constraintOptions),$s(i,e.center)>1e-12&&gY(this.sphere,e,r,this.targetOnSphere)&&aXe(this.sphere,e,i,this.targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let c=yre**Math.abs(t);const h=t>0?1:-1;pe(this.tmpViewDir,i,e.eye);const p=Me(this.tmpViewDir),f=this.view._stage.renderView.getMinimalDepthForArea(null,r[0],r[1],this.view.state.camera,dXe);let m=f?Math.min(l,f):l;m=s?Math.min(m,p):m,oe(this.tmpRayDir.direction,this.tmpRayDir.direction,m),de(i,this.tmpRayDir.origin,this.tmpRayDir.direction);let y=m*c;const v=Math.max(Z6,1.01*e.nearFar[0]);if(t>0&&y<v&&(y=v,c=y/m),Math.abs(m-y)<1e-6)return;oe(this.tmpRayDir.direction,this.tmpRayDir.direction,h*(1-c)),e.eye=de(QP,e.eye,this.tmpRayDir.direction),e.center=de(QP,e.center,this.tmpRayDir.direction)}oE(this.view,e)}};aF=u([P("esri.views.3d.state.controllers.global.ZoomStepController")],aF);const QP=O(),JP=O(),fXe={exclude:new Set([Rd])},mXe=.6,gXe=4,yXe=60,vXe=14,_Xe=200;let lF=class extends Km{constructor(){super(...arguments),this.zoomLocation=O(),this.tmpCamera=new Yi,this.tmpRayDir=O(),this.tmpCenter=O(),this.constraintOptions={selection:mr.ALL,interactionType:kt.ZOOM,interactionFactor:null,interactionStartCamera:new Yi,interactionDirection:null,tiltMode:Rn.TUMBLE}}zoomStep(e,t){if(!this.active)return;const i=this.view.state,{interactionStartCamera:r}=this.constraintOptions;this.animation.finished?r.copyFrom(i.camera):this.animation.cameraAt(1,r),this.tmpCamera.copyFrom(i.camera);const s=Mh(this.view.state.viewingMode);e>0?(this.view.map.ground.opacity===0?this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation,wXe):this.intersectionHelper.intersectScreenFreePointFallback(t,this.zoomLocation),this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.tmpCenter)&&(this.tmpCamera.center=this.tmpCenter)):this.intersectionHelper.intersectRay(this.tmpCamera.ray,s,this.zoomLocation)?this.tmpCamera.center=this.zoomLocation:se(this.zoomLocation,this.tmpCamera.center);const n=mXe**e;let o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,t[0],t[1],this.view.state.camera,yXe);pe(KP,this.tmpCamera.eye,this.zoomLocation),we(KP,KP);const a=Math.max(Math.min(vXe,1/Math.abs(xe(bXe,KP)))*Math.abs(this.view.camera.position.z),_Xe);if(o=o?Math.min(o,a):a,o){const l=O();pe(l,this.zoomLocation,this.tmpCamera.eye),o<Me(l)&&(we(l,l),de(this.zoomLocation,this.tmpCamera.eye,oe(l,l,o)))}this._updateCamera(this.tmpCamera,n,this.zoomLocation),this.begin(this.tmpCamera)}animationSettings(){return{apex:null,duration:600,easing:qO}}_updateCamera(e,t,i){pe(this.tmpRayDir,i,e.eye);const r=Me(this.tmpRayDir);let s=r*t;const n=t<=1,o=Math.max(gXe,1.01*e.nearFar[0]);n&&s<o&&(s=o,t=s/r),Math.abs(r-s)<1e-6||(oe(this.tmpRayDir,this.tmpRayDir,t),e.eye=pe(vre,i,this.tmpRayDir),e.center=en(vre,e.center,i,1-t),as(this.view,e,this.constraintOptions))}};lF=u([P("esri.views.3d.state.controllers.local.ZoomStepController")],lF);const vre=O(),bXe=Fe(0,0,1),KP=O(),wXe={exclude:new Set([Rd])};function xXe(e,t){switch(t){case"primary":return e.pointerType==="touch"||e.button===0;case"secondary":return e.pointerType!=="touch"&&e.button===2;case"tertiary":return e.pointerType!=="touch"&&e.button===1}}function bY(e,t){if(e.pointerType==="touch")return!1;switch(t){case"primary":return e.button===0;case"secondary":return e.button===2;case"tertiary":return e.button===1}}class TXe extends Ao{constructor(t,i){super(!0),this.view=t,this.registerIncoming("double-click",i,r=>this._handleDoubleClick(r))}_handleDoubleClick(t){const i=t.data;if(xXe(i,"primary")){const r=this.view.state.isGlobal?new aF({view:this.view,mode:"animation"}):new lF({view:this.view,mode:"animation"});this.view.state.switchCameraController(r),r.zoomStep(Math.log(.5)/Math.log(.6),Vr(i.x,i.y)),t.stopPropagation()}}}let Av=class extends eb{constructor(){super(...arguments),this.startCamera=new Yi,this.currentCamera=new Yi}get isInteractive(){return!0}stepController(e,t){t.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(t)}onControllerStart(e){this.state=Ir.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}};Av=u([P("esri.views.3d.state.controllers.InteractiveController")],Av);var Fl;(function(e){e[e.CENTER=0]="CENTER",e[e.EYE=1]="EYE"})(Fl||(Fl={}));const SXe=7,Q6=90;let FT=class extends Av{constructor(e){super(e),this.view=null,this.pivot=Fl.CENTER,this.lastPoint=tt(),this.tmpWorldUp=O(),this.tmpViewDir=O(),this.tmpRotCurPoint=tt(),this.tmpTransf=Ae(),this.tmpAxis=O(),this.tmpPivotPoint=O(),this.pivotPos=O(),this.constraintOptions={selection:mr.ALL,interactionType:kt.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Rn.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}initialize(){this.rotScale=this.pivot===Fl.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case Fl.EYE:se(this.pivotPos,this.startCamera.eye),this.constraintOptions.interactionType=kt.LOOK_AROUND,this.constraintOptions.tiltMode=Rn.LOOK_AROUND,this.constraintOptions.selection=mr.NONE;break;case Fl.CENTER:{const t=this.intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this.pivotPos);t||se(this.pivotPos,this.startCamera.center),this._constrainPivotPoint(e,t),this.startCamera.center=this.pivotPos,this.constraintOptions.interactionType=kt.TUMBLE,this.constraintOptions.tiltMode=Rn.TUMBLE,this.constraintOptions.selection=mr.ALL&~mr.DISTANCE;break}}this.constraintOptions.interactionStartCamera=this.startCamera,_b(this.startCamera,e,this.lastPoint)}}_constrainPivotPoint(e,t){const i=this.startCamera,r=O();pe(r,this.pivotPos,i.eye);const s=Me(r);let n=Math.min(s,SXe*Math.abs(this.view.camera.position.z));const o=vi(this.view.spatialReference),a=Vr(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),l=S5(this.startCamera,a,!0,o);let c=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*Q6,Q6),h=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,Q6);c===void 0&&h===void 0||(c=c===void 0?h:c,h=h===void 0||l===Zn.Horizontal?c:h,n=c>h?h:c,n=t?Math.min(n,s):n),we(r,r),se(this.pivotPos,de(this.tmpPivotPoint,i.eye,oe(this.tmpPivotPoint,r,n)))}update(e){if(this.active){switch(this.pivot){case Fl.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this.pivotPos);break;case Fl.CENTER:this.currentCamera.center=this.pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this.pivotPos)}as(this.view,this.currentCamera,this.constraintOptions)}}end(){this.active&&this.finishController()}_applyRotation(e,t,i,r){this.view.renderCoordsHelper.worldUpAtPosition(r,this.tmpWorldUp),_b(e,t,this.tmpRotCurPoint);let s=(this.lastPoint[1]-this.tmpRotCurPoint[1])*this.rotScale,n=(this.tmpRotCurPoint[0]-this.lastPoint[0])*this.rotScale;pe(this.tmpViewDir,i,r);const o=Me(this.tmpViewDir),a=tn(xe(this.tmpViewDir,this.tmpWorldUp)/o);if(this.pivot===Fl.EYE){s*=-.5;const l=.5*Math.PI-a,c=.5*Math.PI*.99;s=l-Math.max(-c,Math.min(c,l+s))}return s=$e(s+a,_o.min,_o.max)-a,lt(this.tmpAxis,e.up,this.tmpViewDir),this.pivot===Fl.CENTER&&(n=-n),pu(this.tmpTransf,n,this.tmpWorldUp),Wl(this.tmpTransf,this.tmpTransf,s,this.tmpAxis),Ue(this.tmpViewDir,this.tmpViewDir,this.tmpTransf),e.up=Ue(J6,e.up,this.tmpTransf),de(J6,r,this.tmpViewDir),ro(this.lastPoint,this.tmpRotCurPoint),J6}};u([d({constructOnly:!0})],FT.prototype,"view",void 0),u([d()],FT.prototype,"pivot",void 0),FT=u([P("esri.views.3d.state.controllers.RotateController")],FT);const J6=O();class K6 extends Ao{constructor(t,i,r,s){super(!0),this.view=t,this.pointerAction=i,this.pivot=r,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!bY(t.data,this.pointerAction))return;const r=Vr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.cameraController=new FT({view:this.view,pivot:this.pivot}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}let qD=class extends Av{constructor(e){super(e),this.view=null,this.pickPoint=O(),this.tmpP0=tt(),this.panAxisAngle=sE(),this.tmpRayDir=O(),this.tmpRayDirPick=O(),this.targetOnSphere=O(),this.tmpRay={origin:O(),direction:O()},this.dragBeginPoint=Vr(),this.normalizedAnchorPoint=tt(),this.constraintOptions={selection:mr.ALL_EXCEPT_COLLISION,interactionType:kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:Rn.TUMBLE},this.sphere=fn(),this.hasPickPoint=!1}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;ro(this.dragBeginPoint,e),_b(this.startCamera,e,this.normalizedAnchorPoint);const t=vi(this.view.spatialReference),i=s_e(this.intersectionHelper,this.startCamera,e,t,b2.Ellipsoid,this.view.map.ground.opacity===0?EXe:{});if(this.navMode=S5(this.startCamera,e,i.hasGeometryIntersection,t),this.navMode===Zn.Horizontal)this.hasPickPoint=!!i.scenePickPoint,this.pickPoint=i.scenePickPoint,this.sphere=i.sphere;else{let r,s;aE(this.startCamera,e,this.tmpRay),we(this.tmpRay.direction,this.tmpRay.direction),i.scenePickPoint&&(pe(this.tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),s=Me(this.tmpRayDirPick)),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let n=$e(e_e*r,rF[0],rF[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,t_e);n=o?Math.min(n,o):n,n=i.scenePickPoint?Math.min(n,s):n,this.hasPickPoint=!0,oe(this.tmpRay.direction,this.tmpRay.direction,n),de(this.pickPoint,this.tmpRay.origin,this.tmpRay.direction)}this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this.navMode===Zn.Horizontal){pe(this.tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const t=Me(this.tmpRayDir);_b(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;if(this.hasPickPoint&&r<t){const n=1-(1-r/t)*(1-this.sphere[3]/Me(this.currentCamera.center));this.currentCamera.center=oe(eI,this.currentCamera.center,n)}oe(this.tmpRayDir,this.tmpRayDir,-r/t),this.currentCamera.eye=de(eI,this.currentCamera.center,this.tmpRayDir),this.constraintOptions.interactionFactor=Sd(this.dragBeginPoint,e),as(this.view,this.currentCamera,this.constraintOptions),this.hasPickPoint&&(zM(this.sphere,this.currentCamera,this.dragBeginPoint,this.targetOnSphere),wM(this.pickPoint,this.targetOnSphere,this.panAxisAngle),Cv(this.currentCamera,this.sphere,this.panAxisAngle))}else{const t=Me(this.tmpRay.direction);_b(this.currentCamera,e,this.tmpP0);const i=12*(this.normalizedAnchorPoint[1]-this.tmpP0[1]);let r=t*2**i;const s=this.view.state.constraints.minimumPoiDistance;if(i<0&&r<s&&(r=s),Math.abs(t-r)<1e-6)return;oe(this.tmpRayDir,this.tmpRay.direction,1-r/t),this.currentCamera.eye=de(eI,this.currentCamera.eye,this.tmpRayDir),this.currentCamera.center=de(eI,this.currentCamera.center,this.tmpRayDir)}oE(this.view,this.currentCamera)}}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],qD.prototype,"view",void 0),qD=u([P("esri.views.3d.state.controllers.global.ZoomController")],qD);const eI=O(),EXe={exclude:new Set([Rd])};let WD=class extends Av{constructor(e){super(e),this.view=null,this.tmpP=O(),this.tmpDir=O(),this.tmpN=O(),this.tmpP0=tt(),this.tmpPoi=O(),this.tmpRayDir=O(),this.dragBeginPoint=Vr(),this.normalizedAnchorPoint=tt(),this.constraintOptions={selection:mr.ALL,interactionType:kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:O(),tiltMode:Rn.TUMBLE},this.plane=gi()}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;ro(this.dragBeginPoint,e),_b(this.startCamera,e,this.normalizedAnchorPoint);const t=this.intersectionHelper.intersectScreenFreePointFallback(e,this.tmpP,this.view.map.ground.opacity===0?CXe:{});pe(this.tmpDir,this.tmpP,this.startCamera.eye);const i=Me(this.tmpDir);let r;we(this.tmpDir,this.tmpDir),this.view.camera.position.hasZ&&(r=Math.abs(this.view.camera.position.z));let s=$e(e_e*r,rF[0],rF[1]);const n=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,t_e);s=n?Math.min(s,n):s,s=t?Math.min(s,i):s,oe(this.tmpDir,this.tmpDir,s),de(this.tmpP,this.startCamera.eye,this.tmpDir),pe(this.tmpN,this.startCamera.eye,this.startCamera.center),we(this.tmpN,this.tmpN),this.tmpN[1]<0&&qo(this.tmpN,this.tmpN),qS(this.tmpP,this.tmpN,this.plane),this.constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;sXe(this.plane,this.currentCamera,this.dragBeginPoint,this.tmpPoi)||se(this.tmpPoi,this.currentCamera.center),_b(this.currentCamera,e,this.tmpP0);let t=4*(this.tmpP0[1]-this.normalizedAnchorPoint[1]);ro(this.normalizedAnchorPoint,this.tmpP0),pe(this.tmpRayDir,this.tmpPoi,this.currentCamera.eye);const i=Me(this.tmpRayDir);let r=i*(1-t);se(this.constraintOptions.interactionDirection,this.tmpRayDir),oe(this.constraintOptions.interactionDirection,this.constraintOptions.interactionDirection,Math.sign(t)/i);const s=this.view.state.constraints.minimumPoiDistance;t>=0&&r<s&&(r=s,t=-(r-i)/i),Math.abs(i-r)<1e-6||(oe(this.tmpRayDir,this.tmpRayDir,t),this.currentCamera.eye=de(a_,this.currentCamera.eye,this.tmpRayDir),en(a_,this.currentCamera.center,this.tmpPoi,t),this.tmpPoi[2]>this.startCamera.center[2]?a_[2]=Math.max(this.startCamera.center[2],a_[2]):a_[2]=Math.min(this.startCamera.center[2],a_[2]),this.currentCamera.center=a_,this.constraintOptions.interactionFactor=Sd(this.dragBeginPoint,e),as(this.view,this.currentCamera,this.constraintOptions))}end(){this.active&&this.finishController()}};u([d({constructOnly:!0})],WD.prototype,"view",void 0),WD=u([P("esri.views.3d.state.controllers.local.ZoomController")],WD);const a_=O(),CXe={exclude:new Set([Rd])};class AXe extends Ao{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){const i=t.data;if(i.pointers.size>1||!bY(t.data,this.pointerAction))return;const r=Vr(i.center.x,i.center.y);switch(i.action){case"start":this.cameraController&&(this.cameraController.end(),this.cameraController=null),this.view.state.isGlobal?this.cameraController=new qD({view:this.view}):this.cameraController=new WD({view:this.view}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":this.cameraController&&this.cameraController.update(r);break;case"end":this.cameraController&&(this.cameraController.end(),this.cameraController=null)}t.stopPropagation()}}const RXe=O(),tI=O();function wY(){return{direction:O(),up:O()}}function d_e(e,t,i,r,s){let n=we(RXe,e),o=xe(n,r);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(xe(t,r)),o<.99?(se(n,t),a&&oe(n,n,-1)):n=null);let l=0;if(n){oe(tI,r,xe(r,n)),pe(n,n,tI);const h=xe(n,s)/(Me(n)*Me(s));lt(tI,n,s),l=(xe(tI,r)>0?1:-1)*ec(tn(h))}const c=ec(tn(-xe(r,e)/Me(e)));return i?(i.heading=l,i.tilt=c,i):{heading:l,tilt:c}}const p_e=Fe(0,1,0),f_e=Fe(0,0,1),BE=Ae(),Qf=O(),Jf=O();function m_e(e,t,i,r=wY()){const{direction:s,up:n}=r;return yde(BE,-$t(t)),VS(BE,BE,$t(i)),Ue(s,f_e,BE),oe(s,s,-1),Ue(n,p_e,BE),r}function MXe(e,t,i,r){return d_e(t,i,r,f_e,p_e)}function OXe(e,t,i,r){const s=m_e(e,i,r),n=O();return oe(n,s.direction,-t),de(n,n,e),{up:s.up,eye:n,heading:i,tilt:r}}function PXe(e){return ec(e)}function IXe(e){return $t(e)}function g_e(e,t,i,r,s){const n=e.renderSpatialReference,o=e.map&&e.spatialReference||t.spatialReference;return Mn(t,Qf,n),Mn(t,Jf,n),Qf[0]-=i/2,Jf[0]+=i/2,Qf[1]-=r/2,Jf[1]+=r/2,Js(Qf,n,Qf,o),Js(Jf,n,Jf,o),s?(s.xmin=Qf[0],s.ymin=Qf[1],s.xmax=Jf[0],s.ymax=Jf[1],s.spatialReference=o):s=new ci(Qf[0],Qf[1],Jf[0],Jf[1],o),s}const $Xe=Object.freeze(Object.defineProperty({__proto__:null,headingTiltToDirectionUp:m_e,directionToHeadingTilt:MXe,eyeForCenterWithHeadingTilt:OXe,lookAtTiltToEyeTilt:PXe,eyeTiltToLookAtTilt:IXe,toExtent:g_e},Symbol.toStringTag,{value:"Module"})),y_e=Fe(0,0,1),v_e=we(O(),Fe(1,1,1)),DXe=new dv(-180,180),GE=Ae(),y0=O(),Bw=O();function __e(e,t,i,r=wY()){lt(y0,e,y_e),xe(y0,y0)===0&&lt(y0,e,v_e),pu(GE,-$t(t),e),Wl(GE,GE,-$t(i),y0);const{up:s,direction:n}=r;return lt(s,y0,e),we(s,s),Ue(s,s,GE),we(n,e),qo(n,n),Ue(n,n,GE),r}function LXe(e,t,i,r){const s=y0,n=Bw;return we(s,e),lt(Bw,s,y_e),xe(Bw,Bw)===0&&lt(Bw,s,v_e),lt(n,Bw,s),d_e(t,i,r,s,n)}function NXe(e,t,i,r){const s={eye:O(),up:null,tilt:r,heading:i},n=y0;n[0]=e[0],n[1]=e[2],n[2]=-e[1];const o=t,a=$t(i),l=$t(r),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),m=Me(n);let y;if(Math.abs(l)<1e-8)y=o+m;else{const ne=m/p,$=Hd(o/ne),U=Math.PI-l-$;y=ne*Math.sin(U)}const v=f*o,w=o*o*(p*p),b=h*h*w,S=y-v,T=S*S,E=b*(b+T-n[1]*n[1]);if(E<0)return oe(s.eye,n,y/m),s.tilt=0,s;const C=Math.sqrt(E),M=n[1]*S,I=b+T;let N;if(N=h>0?-C+M:C+M,Math.abs(I)<1e-8)return m<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):oe(s.eye,n,y/m),s.tilt=0,ez(s.eye),tz(s,e);s.eye[1]=N/I;const D=c*c*w,z=p*o,V=h*z*s.eye[1],k=s.eye[1]*s.eye[1],Y=1-k,Z=Math.sqrt(Y),le=b*k+D-2*V*Z*S+Y*T;return Math.abs(le)<1e-8?(oe(s.eye,n,y/m),s.tilt=0,ez(s.eye),tz(s,e)):(s.eye[0]=(Y*(y*n[0]-v*n[0])-z*Z*(n[0]*s.eye[1]*h+n[2]*c))/le,s.eye[2]=(Y*(y*n[2]-v*n[2])-z*Z*(n[2]*s.eye[1]*h-n[0]*c))/le,oe(s.eye,s.eye,y),ez(s.eye),tz(s,e))}function ez(e){const t=e[1];e[1]=-e[2],e[2]=t}function tz(e,t){const i=__e(t,e.heading,e.tilt);return e.up=i.up,e}function FXe(e,t,i){const r=Me(t),s=Math.sqrt(i*i+r*r-2*i*r*Math.cos(Math.PI-e)),n=Hd(i/(s/Math.sin(e)));return ec(e-n)}function UXe(e,t,i){const r=$t(e),s=Me(t);return Hd(i/(s/Math.sin(r)))+r}function b_e(e,t,i,r,s){let n,o,a,l;const c=t.latitude,h=vi(e.spatialReference).radius,p=t.longitude,f=UHe(c,i,h)/2;n=p-f,o=p+f;const m=$t(c),y=(1+Math.sin(m))/(1-Math.sin(m)),v=(y+1)*Math.tan(r/h/2),w=v*v;function b(T){const E=Math.PI/2;return(T=XEe.normalize(T,-E))>E&&(T=Math.PI-T),T}if(a=1.5*Math.PI-2*Math.atan(.5*(v+Math.sqrt(4*y+w))),l=a+r/h,a=b(a),l=b(l),l<a){const T=l;l=a,a=T}if(a=Math.max(ec(a),-90),l=Math.min(ec(l),90),o=DXe.monotonic(n,o),o-n>180){const T=(o-n-180)/2;n+=T,o-=T}const S=e.spatialReference&&e.spatialReference.isGeographic?e.spatialReference:Xe.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=S):s=new ci(n,a,o,l,S),e.spatialReference&&e.spatialReference.isWebMercator&&rg(s,!1,s),s}const kXe=Object.freeze(Object.defineProperty({__proto__:null,headingTiltToDirectionUp:__e,directionToHeadingTilt:LXe,eyeForCenterWithHeadingTilt:NXe,lookAtTiltToEyeTilt:FXe,eyeTiltToLookAtTilt:UXe,toExtent:b_e},Symbol.toStringTag,{value:"Module"}));function cF(e){return e.type==="point"}class w_e{constructor(t,i=null,r=0){this.array=t,this.spatialReference=i,this.offset=r}}function x_e(e){return"array"in e}function lf(e,t,i="ground"){if(cF(t))return e.getElevation(t.x,t.y,t.z||0,t.spatialReference,i);if(x_e(t)){let r=t.offset;return e.getElevation(t.array[r++],t.array[r++],t.array[r]||0,yt(t.spatialReference,e.spatialReference),i)}return e.getElevation(t[0],t[1],t[2]||0,e.spatialReference,i)}function w2(e,t){return e!=null&&(t==null||(t===Ve.Local?!e.isGeographic||e.isWGS84||e.wkid===dh.CGCS2000:e.isWebMercator||e.isWGS84||e.wkid===dh.CGCS2000||e.wkid===dh.GCSMARS2000||e.wkid===dh.GCSMARS2000_SPHERE||e.wkid===dh.GCSMOON2000))}const T_e=me.getLogger("esri.views.3d.support.cameraUtils"),S_e=39.37,E_e=96,q7=1,zXe=8,VXe=5,C_e=1,_re=O(),iI=O(),BXe={heading:0,tilt:0},Hm=new nt,GXe=new dv(-20037508342788905e-9,20037508342788905e-9),jXe=new dv(-180,180);var So;function WO(e){return e.spatialReference||Xe.WGS84}function lE(e){return e.viewingMode==="global"?kXe:$Xe}function HXe(e,t,i,r,s){return lE(e).headingTiltToDirectionUp(t,i,r,s)}function km(e,t){if(R(t))return null;const i=e.renderSpatialReference,r=lE(e).headingTiltToDirectionUp,s=O();if(!Mn(t.position,s,i))return null;const n=r(s,t.heading,t.tilt);oe(n.direction,n.direction,e.state.camera.distance),de(n.direction,n.direction,s);const o=xw(e,s,n.direction,n.up);return o.fov=$t(t.fov),o}(function(e){e[e.LOCKED=0]="LOCKED",e[e.ADJUST=1]="ADJUST"})(So||(So={}));const Gw=O();function x2(e,t,i){const r=e.renderSpatialReference,s=E5(e,t.eye,t.viewForward,t.up,BXe);let n=WO(e);return Js(t.eye,r,Gw,n)||(n=Xe.WGS84,Js(t.eye,r,Gw,n)),R(i)?new rc(new nt(Gw,n),s.heading,s.tilt,ec(t.fov)):(i.position.x=Gw[0],i.position.y=Gw[1],i.position.z=Gw[2],i.position.spatialReference=n,i.heading=s.heading,i.tilt=s.tilt,i.fov=ec(t.fov),i)}function xY(e,t,i){const r=e.state.camera,s=r.width/2/r.pixelRatio;return e.renderCoordsHelper.viewingMode===Ve.Global&&i!=null&&(t*=Math.cos($t(i))),t/=e.renderCoordsHelper.unitInMeters,s/(E_e*S_e/t)/Math.tan(r.fovX/2)}function Jb(e,t,i){const r=e.state.camera,s=t*Math.tan(r.fovX/2),n=r.width/2/r.pixelRatio;let o=E_e*S_e/(n/s);return e.renderCoordsHelper.viewingMode===Ve.Global&&(o/=Math.cos($t(i))),o*=e.renderCoordsHelper.unitInMeters,o}function A_e(e,t,i,r,s,n){return R_e(e,t,xY(e,i,t.latitude),r,s,n)}function R_e(e,t,i,r,s,n){if(bb(n)){const a=new cE(n.signal);return VM(e,r.heading,r.tilt,t,i,s,a),void a.resolver.promise.then(l=>{const c=hF(e,l,r.fov);if(!R(c))return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=VM(e,r.heading,r.tilt,t,i,s);return hF(e,o,r.fov,n)}function E5(e,t,i,r,s){return lE(e).directionToHeadingTilt(t,i,r,s)}function qXe(e,t){return!!(e.basemapTerrain&&e.renderCoordsHelper.fromRenderCoords(t,Hm,e.spatialReference)&&yt(lf(e.elevationProvider,Hm),0)>Hm.z-C_e)}async function WXe(e,t,i){if(!e.renderCoordsHelper.fromRenderCoords(t,Hm,e.spatialReference))return!1;const r=await e.elevationProvider.queryElevation(Hm.x,Hm.y,Hm.z,Hm.spatialReference,"ground",i);return yt(r,0)>Hm.z-C_e}async function XXe(e,t,i){const r=O();if(t)if(t instanceof nt){if(Mn(t,r,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const s=await e.elevationProvider.queryElevation(t.x,t.y,t.z,t.spatialReference,"ground",i);return _(s)&&e.renderCoordsHelper.setAltitude(r,s),r}}else se(r,t);else se(r,e.state.camera.center);return r}function YXe(e,t){const i=O();if(t&&t instanceof nt){if(Mn(t,i,e.renderSpatialReference),t.z==null&&e.basemapTerrain!=null){const r=lf(e.elevationProvider,t);_(r)&&e.renderCoordsHelper.setAltitude(i,r)}}else se(i,t||e.state.camera.center);return i}function VM(e,t,i,r,s,n,o){const a=r&&r instanceof nt?r:null;if(bb(o))return XXe(e,r,o.signal).then(c=>{W7(e,t,i,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=YXe(e,r);return W7(e,t,i,a,l,s,n,o)}function W7(e,t,i,r,s,n,o,a){if(R(r)){const p=e.renderSpatialReference;if(r=mv(s,p,WO(e)),R(r))return null}n=Math.max(n,e.state.constraints.minimumPoiDistance);const l=JXe(e,t,i,s,n,o),c=(0,lE(e).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===So.ADJUST&&e.viewingMode==="global"&&i>0){const p=()=>{const m=M_e(e,s,n,eYe(e,n,i,s));return o=i-m<1?So.LOCKED:So.ADJUST,W7(e,t,m,r,s,n,o,a)},f=e.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(qXe(e,c.eye))return p();if(bb(a))return WXe(e,c.eye,a.signal).then(m=>m?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:Is(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||bb(a)?{center:O(),eye:O(),up:O(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=Is(s),h.heading=c.heading,h.tilt=c.tilt,bb(a)&&a.resolver.resolve(h),h}function _R(e,t,i,r,s,n=null){const o=t.zmax!=null&&t.zmin!=null;let a,l,c;if(e.state.isGlobal){if(!w2(t.spatialReference,Ve.Global))return bb(n)&&n.resolver.reject(),null;const b=new nt(t.xmin,t.ymin,t.spatialReference),S=new nt(t.xmax,t.ymax,t.spatialReference),T=t.spatialReference.isGeographic?jXe:GXe;a=new nt({x:T.center(b.x,S.x),y:(S.y+b.y)/2,z:o?(t.zmax+t.zmin)/2:null,spatialReference:t.spatialReference});const E=vi(t.spatialReference),C=FHe(a,b,S);l=C.lon,c=C.lat,T.diff(b.x,S.x)>T.range/2&&(l+=E.halfCircumference),l=Math.min(l,E.halfCircumference),c=Math.min(c,E.halfCircumference)}else{const b=yt(e.renderSpatialReference,t.spatialReference);b.equals(t.spatialReference)||(t=AO(t,b)),l=t.xmax-t.xmin,c=t.ymax-t.ymin;const S=o?(t.zmax+t.zmin)/2:null;a=new nt({x:t.xmin+.5*l,y:t.ymin+.5*c,z:S,spatialReference:b})}const h=o?t.zmax-t.zmin:0,p=e.state.camera,f=1/Math.tan(p.fovX/2),m=1/Math.tan(p.fovY/2),y=1/Math.tan(p.fov/2),v=Math.max(.5*l*f,.5*c*m,.5*h*y)/q7;if(bb(n)){const b=new cE(n.signal);return VM(e,i,r,a,v,s,b),void b.resolver.promise.then(S=>{const T=hF(e,S,e.camera.fov);if(!R(T))return n.resolver.resolve(T);n.resolver.reject()},S=>n.resolver.reject(S))}const w=VM(e,i,r,a,v,s);return hF(e,w,e.camera.fov,n)}function ZXe(e,t,i){const r=e.renderSpatialReference,s=mv(i,r,WO(e));if(R(s))return null;const n=Math.tan(t.fovX/2),o=Math.tan(t.fovY/2),a=dH(t.eye,i),l=2*a*n*q7,c=2*a*o*q7;return e.viewingMode==="global"?b_e(e,s,l,c):g_e(e,s,l,c)}function QXe(e,t,i){const r=e.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(i/r)/Math.LN2>zXe)return!0;const s=e.renderSpatialReference,n=WO(e),o=mv(t,s,n),a=mv(e.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(R(o)||R(a))return!1;const l=Math.tan(.5*e.state.camera.fov)*r;return a.distance(o)/l>VXe}function JXe(e,t,i,r,s,n){let o=0;return n===So.ADJUST&&QXe(e,r,s)?(t=0,o=KXe(e,s,i,r)):o=TY(e,r,s,i),o=e.state.constraints.clampTilt(s,o),{heading:t,tilt:i=M_e(e,r,s,o)}}const uF=.7;function KXe(e,t,i,r){const s=e.state.constraints.tilt(t);s.max=Math.min(s.max,.5*Math.PI);const n=s.min*(1-uF)+s.max*uF,o=TY(e,r,t,i);return Math.min(o,n)}function eYe(e,t,i,r){const s=e.state.constraints.tilt(t);let n=TY(e,r,t,i);return n=Math.min(n,.5*Math.PI),s.min*(1-uF)+n*uF}function M_e(e,t,i,r){return lE(e).lookAtTiltToEyeTilt(r,t,i)}function TY(e,t,i,r){return lE(e).eyeTiltToLookAtTilt(r,t,i)}function hF(e,t,i,r){if(R(t))return null;const s=e.renderSpatialReference,n=mv(t.eye,s,WO(e));return R(n)?null:_(r)?(r.position=n,r.heading=t.heading,r.tilt=t.tilt,r.fov=i,r):new rc(n,t.heading,t.tilt,i)}function O_e(e,t){var r;const i=(r=e.basemapTerrain)==null?void 0:r.tilingScheme;if(i)return i.levelAtScale(t);T_e.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function P_e(e,t){var r;const i=(r=e.basemapTerrain)==null?void 0:r.tilingScheme;if(i)return i.scaleAtLevel(t);T_e.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function tYe(e,t){return e.spatialReference?kpe(t,e.spatialReference):void 0}function I_e(e,t,i){const r=e.renderSpatialReference;let s,n;t||(t=e.state.camera);const o=Xe.WGS84;return t instanceof rc?(s=t.position.latitude,Mn(t.position,_re,r),Mn(i,iI,r),n=nr(_re,iI)):(Js(t.center,r,iI,o),s=iI[1],n=t.distance),Jb(e,n,s)}class cE{constructor(t){this.signal=t,this.resolver=Wd()}}function bb(e){return e&&"resolver"in e}function Gh(e){let t=e*e;return e<0&&(t*=-1),t}function bre(e,t,i){const r=i,s=e.state,n=e.device,o=t.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(r.translation[0]=Gh(s.axes[0]),r.translation[1]=Gh(s.axes[1]),r.translation[2]=Gh(s.buttons[7])-Gh(s.buttons[6]),r.heading=Gh(s.axes[2]),r.tilt=Gh(s.axes[3])):n.deviceType==="spacemouse"&&(r.translation[0]=1.2*Gh(s.axes[0]),r.translation[1]=1.2*Gh(s.axes[1]),r.translation[2]=2*-Gh(s.axes[2]),r.heading=1.2*Gh(s.axes[5]),r.tilt=1.2*Gh(s.axes[3])),r.tilt*=o,oe(r.translation,r.translation,a),r}function wre(e,t){const i=t;return i.translation[0]=e[1]-e[0],i.translation[1]=e[3]-e[2],i.translation[2]=e[4]-e[5],i.heading=e[7]-e[6],i.tilt=e[8]-e[9],i.zoom=e[10]-e[11],i}function iz(e){return e.translation[0]===0&&e.translation[1]===0&&e.translation[2]===0&&e.heading===0&&e.tilt===0&&e.zoom===0}let E0=class extends Av{constructor(e){super(e),this.transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this.keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this.tmpCamera=new Yi,this.constraintOptions={selection:mr.ALL,interactionType:kt.NONE,interactionStartCamera:new Yi,interactionFactor:0,interactionDirection:null,tiltMode:Rn.LOOK_AROUND}}handleEventGamepad(e){const t=bre(e,this.view.navigation.gamepad,this.transformation);(e.action==="end"||iz(t))&&this.finishController()}activateDirection(e){this.keysButtonState[e]=1,wre(this.keysButtonState,this.transformation)}deactivateDirection(e){this.keysButtonState[e]=0;const t=wre(this.keysButtonState,this.transformation);iz(t)&&this.finishController()}onControllerStart(e){this.filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this.headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const t=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this.filteredSurfaceElevation+=i*(t-this.filteredSurfaceElevation)*e}stepController(e,t){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(t),this._updateCameraCenter(),this.constraintOptions.interactionStartCamera.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,l_),this._applyDisabledMovementTypes(l_),this._applyPan(l_.pan),this._applyRotate(l_.rotate),this._applyZoom(l_.zoom),this._applyAscend(l_.ascend),this.constraintOptions.interactionType=kt.NONE,this.constraintOptions.selection=mr.COLLISION,as(this.view,this.currentCamera,this.constraintOptions),super.stepController(e,t)}_updateStartHeading(){this.transformation.heading!==0&&(this.headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const t=this.currentCamera;pe(Ia,t.center,t.eye),Ue(Ia,Ia,e.matrix),t.center=de(Ia,Ia,t.eye),t.up=Ue(Ia,t.up,e.matrix),this.constraintOptions.interactionType=kt.LOOK_AROUND,this.constraintOptions.selection=mr.ALL_EXCEPT_COLLISION,as(this.view,t,this.constraintOptions)}_applyPan(e,t=this.currentCamera){!e.enabled||(t.eye=Ue(Ia,t.eye,e.matrix),t.center=Ue(Ia,t.center,e.matrix),this.view.state.isGlobal&&(t.up=Ue(Ia,t.up,e.matrix)),this.constraintOptions.interactionType=kt.PAN,this.constraintOptions.selection=mr.ALL,as(this.view,t,this.constraintOptions))}_applyZoom(e){if(!e)return;const t=this.currentCamera.viewForward;this.currentCamera.eye=de(Ia,this.currentCamera.eye,oe(He.get(),t,e)),se(jE,t),qo(jE,jE),this.constraintOptions.interactionDirection=jE,this.constraintOptions.interactionType=kt.ZOOM,this.constraintOptions.selection=mr.ALL_EXCEPT_COLLISION,as(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const t=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,He.get());if(this.constraintOptions.interactionDirection=se(jE,t),this.view.state.isGlobal){const i=Me(this.currentCamera.eye),r=(i+e)/i;this.currentCamera.eye=oe(Ia,this.currentCamera.eye,r),this.currentCamera.center=oe(Ia,this.currentCamera.center,r)}else{const i=oe(He.get(),t,e);this.currentCamera.eye=de(Ia,this.currentCamera.eye,i),this.currentCamera.center=de(Ia,this.currentCamera.center,i)}this._updateCameraCenter(),this.constraintOptions.interactionType=kt.ASCEND,this.constraintOptions.selection=mr.COLLISION,as(this.view,this.currentCamera,this.constraintOptions)&&this._updateCameraCenter(),this.constraintOptions.selection=mr.ALL_EXCEPT_COLLISION,as(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null}_calculateControlTransformation(e,t,i){lYe(i);const r=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(r,t,i):this._calculateControlTransformationGlobal(r,t,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,t=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=t.intersectManifoldClosestSilhouette(i,e,Ia)}_calculateControlTransformationLocal(e,t,i){const{viewRight:r,viewForward:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=ie(He.get(),s[0],s[1],0);we(a,a);const l=n.translation[0]*e.pan;if(l!==0){const y=oe(He.get(),r,l);Aa(i.pan.matrix,i.pan.matrix,y),i.pan.enabled=!0}switch(o.mode){case"pan":{const y=-n.translation[1]*e.pan;if(y!==0){const v=oe(He.get(),a,y);Aa(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=n.zoom*e.zoom;break}case"zoom":i.zoom=(-n.translation[1]+n.zoom)*e.zoom;break;default:o.mode}const c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(Wl(i.rotate.matrix,i.rotate.matrix,h,this.view.renderCoordsHelper.worldUpAtPosition(t.eye,He.get())),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=Ev(this.view.renderCoordsHelper,t.center,t.eye),m=$e(f+p,_o.min,_o.max)-f;m&&(Wl(i.rotate.matrix,i.rotate.matrix,m,r),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,t,i){const{eye:r,viewRight:s}=t,n=this.transformation,o=this.view.navigation.gamepad,a=lt(He.get(),s,r);we(a,a),qo(a,a),uXe(this.startCamera,t,n,e,this.view.camera.heading,this.headingStart,this.view.camera.tilt,i,o),this.tmpCamera.copyFrom(this.currentCamera),this._applyPan(l_.pan,this.tmpCamera);const l=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,c=n.translation[2]*e.ascend;i.ascend=c;const h=-n.heading*e.rotate;h!==0&&(Wl(i.rotate.matrix,i.rotate.matrix,h,this.tmpCamera.eye),i.rotate.enabled=!0);const p=n.tilt*e.rotate,f=this._clampTiltDeltaGlobalToValidRange(p,t.ray,l);f!==0&&(Wl(i.rotate.matrix,i.rotate.matrix,f,this.tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=n.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,t,i){const r=vi(this.view.spatialReference),s=HD(_o.min,t.origin,i,r);let n=0,o=0;const a=He.get();if(this.view.renderCoordsHelper.intersectManifold(t,i,a)){const l=Ev(this.view.renderCoordsHelper,a,t.origin);n=HD(l,t.origin,i,r),o=HD(_o.max,t.origin,i,r)}else{q2(O4(P4,i+r.radius),t,a);const l=tn(-xe(t.direction,we(a,a)));n=are(l,t.origin,i,r),o=are(_o.max,t.origin,i,r)}return $e(n+e,s,o)-n}_getPointAbsoluteSurfaceElevation(e,t,i){const{renderCoordsHelper:r}=this.view,s=r.getAltitude(e),n=t+Math.abs(s-t);return r.setAltitude(i,n,e),n}_clampedDistanceToSurface(e,t){const{renderCoordsHelper:i}=this.view,{camera:r}=this.view.state,{direction:s}=HXe(this.view,t,0,$_e,aYe),n=i.intersectManifoldClosestSilhouette(mu(t,s),e,He.get()),o=nr(t,n),a=i.intersectManifoldClosestSilhouette(mu(t,Og(He.get(),t,r.center)),e,He.get()),l=nr(t,a);return Math.min(o,l)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:t,state:i}=this.view,{camera:r,isGlobal:s}=i,n=t.intersectManifoldClosestSilhouette(r.ray,this.filteredSurfaceElevation,He.get());if(s){const o=pe(He.get(),e,n),a=Me(o);oe(o,o,1/a);const l=we(He.get(),e),c=tn(xe(l,o));return a*Math.sin(Math.min(rYe,c))}{const o=se(He.get(),e);return t.setAltitude(o,this.filteredSurfaceElevation),nr(n,o)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:sYe}_computeVelocities(e){const t=this.filteredSurfaceElevation,i=t+vi(this.view.spatialReference).radius,{camera:r,isGlobal:s}=this.view.state,n=He.get(),o=this._getPointAbsoluteSurfaceElevation(r.eye,t,n),a=this._clampedDistanceToSurface(t,n),l=r.width/2,c=xre*r.width,h=xre*r.width,p=a*Math.tan(.5*r.fovX)/l,f=p/i,m=p/this._computeHeadingRotateRadius(n),y=o-t;return{pan:(s?f:p)*c*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(c*e/l)*y-y),zoom:2**(c*e/l)*a-a,rotate:$e(m*h,nYe,oYe)*e}}_applyDisabledMovementTypes(e){!_(this.disableMovements)||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&Cf(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&Cf(e.rotate.matrix))}static activatesFor(e,t){const i=bre(t,e.navigation.gamepad,iYe);return!(t.action==="end"||iz(i))}};u([d({constructOnly:!0})],E0.prototype,"view",void 0),u([d({constructOnly:!0})],E0.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],E0.prototype,"disableMovements",void 0),E0=u([P("esri.views.3d.state.controllers.GamepadKeyboardController")],E0);const iYe={translation:[0,0,0],heading:0,tilt:0,zoom:0},$_e=80,rYe=$t($_e),xre=.75,sYe=5,nYe=$t(30),oYe=$t(80),l_={zoom:0,ascend:0,pan:{enabled:!1,matrix:Ae()},rotate:{enabled:!1,matrix:Ae()}},Ia=O(),jE=O(),aYe=wY();function lYe(e){e.zoom=0,e.ascend=0,e.pan.enabled=!1,Cf(e.pan.matrix),e.rotate.enabled=!1,Cf(e.rotate.matrix)}class cYe extends Ao{constructor(t){super(!0),this.view=t,this.watchHandles=new qt,this.handle=this.registerIncoming("gamepad",i=>this._handleEventGamepad(i)),this.handle.pause()}onInstall(t){super.onInstall(t),this.watchHandles.add([ae(()=>this.view.navigation.gamepad.enabled,i=>{i?this.handle.resume():(this.handle.pause(),this.cameraControllerGamepad&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null))},Ft),ae(()=>this.view.navigation.gamepad.device,i=>{this.cameraControllerGamepad&&i&&this.cameraControllerGamepad.gamepadDevice!==i&&(this.cameraControllerGamepad.finishController(),this.cameraControllerGamepad=null)})])}onUninstall(){this.watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(t){const i=this.view.navigation.gamepad.device;if(i&&t.data.device!==i)return;const r=this.cameraControllerGamepad&&this.cameraControllerGamepad.active;if(r||E0.activatesFor(this.view,t.data)){if(!r){const s=new E0({view:this.view,gamepadDevice:t.data.device});this.view.state.switchCameraController(s)&&(this.cameraControllerGamepad=s)}this.cameraControllerGamepad&&this.cameraControllerGamepad.active&&this.cameraControllerGamepad.gamepadDevice===t.data.device&&this.cameraControllerGamepad.handleEventGamepad(t.data)}}}var Pl;(function(e){e[e.LEFT=0]="LEFT",e[e.RIGHT=1]="RIGHT",e[e.FORWARD=2]="FORWARD",e[e.BACKWARD=3]="BACKWARD",e[e.UP=4]="UP",e[e.DOWN=5]="DOWN",e[e.HEADINGLEFT=6]="HEADINGLEFT",e[e.HEADINGRIGHT=7]="HEADINGRIGHT",e[e.TILTUP=8]="TILTUP",e[e.TILTDOWN=9]="TILTDOWN",e[e.ZOOMIN=10]="ZOOMIN",e[e.ZOOMOUT=11]="ZOOMOUT"})(Pl||(Pl={}));class uYe extends Ao{constructor(t,i){super(!0),this.view=t,this.disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ve.Local},this.keyToNumber={[i.left]:Pl.LEFT,[i.right]:Pl.RIGHT,[i.forward]:Pl.FORWARD,[i.backward]:Pl.BACKWARD,[i.up]:Pl.UP,[i.down]:Pl.DOWN,[i.headingLeft]:Pl.HEADINGLEFT,[i.headingRight]:Pl.HEADINGRIGHT,[i.tiltUp]:Pl.TILTUP,[i.tiltDown]:Pl.TILTDOWN,[i.zoomIn]:Pl.ZOOMIN,[i.zoomOut]:Pl.ZOOMOUT},this.registerIncoming("key-down",null,r=>this._handleKeyDown(r)),this.registerIncoming("key-up",null,r=>this._handleKeyUp(r)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&(this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active||(this.cameraControllerKeyboard=new E0({view:this.view,disableMovements:this.disableMovements}),this.view.state.switchCameraController(this.cameraControllerKeyboard)),this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.activateDirection(i),t.stopPropagation()))}_handleBlur(){this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.finishController(),this.cameraControllerKeyboard=null)}_handleKeyUp(t){if(t.data.native.ctrlKey||t.data.native.metaKey)return;const i=this.keyToNumber[t.data.key];i!=null&&this.cameraControllerKeyboard&&this.cameraControllerKeyboard.active&&(this.cameraControllerKeyboard.deactivateDirection(i),t.stopPropagation())}}class hYe extends Ao{constructor(t,i){super(!0),this.view=t,this.registerIncoming("mouse-wheel",i,r=>this._handleMouseWheel(r))}_handleMouseWheel(t){if(!this.view.navigation.mouseWheelZoomEnabled)return;const i=t.data;this.cameraController&&this.cameraController.active||(this.cameraController=this.view.state.isGlobal?new aF({view:this.view,mode:"interaction"}):new lF({view:this.view,mode:"interaction"}),this.view.state.switchCameraController(this.cameraController)),this.cameraController.zoomStep(-1/60*i.deltaY,Vr(i.x,i.y)),t.preventDefault(),t.stopPropagation()}}class dF{constructor(t){this._gain=t}reset(t){this._value=t}set gain(t){this._gain=t}get value(){return this._value===void 0?0:this._value}update(t){this._value===void 0?this._value=t:this._value=this._gain*t+(1-this._gain)*this._value}}let av=class extends kM{constructor(e){super(e),this.view=null,this.beginCamera=new Yi,this.elapsedTimeSec=0,this.constraintOptions={selection:mr.ALL,interactionType:kt.PAN,interactionFactor:0,interactionStartCamera:new Yi,interactionDirection:null,tiltMode:Rn.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new s2}get steppingFinished(){return this.momentum.isFinished(this.elapsedTimeSec)}onControllerStart(e){this.beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this.beginCamera,super.onControllerStart(e)}stepController(e,t){t.copyViewFrom(this.beginCamera),this.elapsedTimeSec+=e,this.momentumStep(this.elapsedTimeSec,t),as(this.view,t,this.constraintOptions)}};u([d({constructOnly:!0})],av.prototype,"view",void 0),av=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],av);let bR=class extends av{constructor(e){super(e),this.interactionType=kt.PAN,this.tmpPan=O()}momentumStep(e,t){const i=this.momentum.value(e);oe(this.tmpPan,this.momentum.direction,i),t.eye=pe(Tre,t.eye,this.tmpPan),t.center=pe(Tre,t.center,this.tmpPan),this.constraintOptions.interactionDirection=this.tmpPan}};u([d({constructOnly:!0})],bR.prototype,"momentum",void 0),bR=u([P("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],bR);const Tre=O(),dYe=O(),rI=O();let XD=class extends av{constructor(e){super(e),this.interactionType=kt.PAN}momentumStep(e,t){const i=this.momentum.value1(e),r=this.momentum.value2(e);se(rI,t.eye),we(rI,rI),lt(this.momentum.axis2,rI,this.momentum.axis1),l_e(t,dYe,this.momentum.axis1,i,this.momentum.axis2,r)}};u([d({constructOnly:!0})],XD.prototype,"momentum",void 0),XD=u([P("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],XD);let z1=class extends av{constructor(e){super(e),this.interactionType=kt.TUMBLE}set center(e){this._set("center",Is(e))}set axis(e){this._set("axis",Is(e))}momentumStep(e,t){const i=this.momentum.value(e);Cv(t,this.center,bM(this.axis,i))}};u([d({constructOnly:!0})],z1.prototype,"momentum",void 0),u([d({constructOnly:!0})],z1.prototype,"center",null),u([d({constructOnly:!0})],z1.prototype,"axis",null),z1=u([P("esri.views.3d.state.controllers.momentum.MomentumController")],z1);let UT=class extends av{constructor(e){super(e),this.interactionType=kt.ZOOM,this.constraintOptions.interactionDirection=O()}set zoomCenter(e){this._set("zoomCenter",Is(e))}momentumStep(e,t){se(this.constraintOptions.interactionDirection,t.eye);const i=this.momentum.valueDelta(0,e);yY(t,this.zoomCenter,i,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionDirection=Og(this.constraintOptions.interactionDirection,t.eye,this.constraintOptions.interactionDirection)}};u([d({constructOnly:!0})],UT.prototype,"momentum",void 0),u([d({constructOnly:!0})],UT.prototype,"zoomCenter",null),UT=u([P("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],UT);let d1=class extends av{constructor(e){super(e),this.interactionType=kt.ZOOM,this.radius=0,this.tmpSceneCenter=O(),this.tmpZoomAxisAngle=sE(),this.sphere=fn()}set screenCenter(e){this._set("screenCenter",Vr(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",Is(e))}initialize(){this.sphere[3]=this.radius}momentumStep(e,t){const i=this.momentum.valueDelta(0,e);i_e(this.sphere,t,i),this.constraintOptions.interactionType=kt.ZOOM,as(this.view,t,this.constraintOptions),zM(this.sphere,t,this.screenCenter,this.tmpSceneCenter),wM(this.sceneCenter,this.tmpSceneCenter,this.tmpZoomAxisAngle),Cv(t,this.sphere,this.tmpZoomAxisAngle),this.constraintOptions.interactionType=kt.PAN}};u([d({constructOnly:!0})],d1.prototype,"momentum",void 0),u([d({constructOnly:!0})],d1.prototype,"screenCenter",null),u([d({constructOnly:!0})],d1.prototype,"sceneCenter",null),u([d({constructOnly:!0})],d1.prototype,"radius",void 0),d1=u([P("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],d1);class Ed{constructor(t){this.gain=t}update(t){if(this.hasLastValue){const i=this.computeDelta(t);this._updateDelta(i)}this.lastValue=t}reset(){this.lastValue=void 0,this.filteredDelta=void 0}get hasLastValue(){return this.lastValue!==void 0}get hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(t){return t-this.lastValue}_updateDelta(t){this.hasFilteredDelta?this.filteredDelta=(1-this.gain)*this.filteredDelta+this.gain*t:this.filteredDelta=t}}class C5{constructor(t,i,r){this._initialVelocity=t,this._stopVelocity=i,this._friction=r,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(t){return t>this.duration}get friction(){return this._friction}value(t){return this.valueFromInitialVelocity(this._initialVelocity,t)}valueDelta(t,i){const r=this.value(t);return this.value(t+i)-r}valueFromInitialVelocity(t,i){i=Math.min(i,this.duration);const r=1-this.friction;return t*(r**i-1)/Math.log(r)}}class pYe extends C5{constructor(t,i,r,s,n){super(t,i,r),this.sceneVelocity=s,this.direction=n}value(t){return super.valueFromInitialVelocity(this.sceneVelocity,t)}}class D_e{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.time=new Ed(.6),this.screen=[new Ed(.4),new Ed(.4)],this.scene=[new Ed(.6),new Ed(.6),new Ed(.6)],this.tmpDirection=O()}add(t,i,r){if(this.enabled){if(this.time.hasLastValue&&this.time.computeDelta(r)<.015)return;this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.scene[0].update(i[0]),this.scene[1].update(i[1]),this.scene[2].update(i[2]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.scene[0].reset(),this.scene[1].reset(),this.scene[2].reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){ie(this.tmpDirection,this.scene[0].filteredDelta,this.scene[1].filteredDelta,this.scene[2].filteredDelta);const s=Me(this.tmpDirection);s>0&&oe(this.tmpDirection,this.tmpDirection,1/s);const n=s/this.time.filteredDelta;return new pYe(t,i,r,n,this.tmpDirection)}}class Sre{constructor(t){this.gain=t}update(t){this.hasFilteredValue?this.filteredValue=(1-this.gain)*this.filteredValue+this.gain*t:this.filteredValue=t}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}}const Ere=1e-5;class fYe extends C5{constructor(t,i,r,s,n,o=0,a){super(t,i,r),this.angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(t){return super.valueFromInitialVelocity(this.angularVelocity1,t)}value2(t){return super.valueFromInitialVelocity(this.angularVelocity2,t)}}class mYe{constructor(t=300,i=12,r=.84){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.enabled=!0,this.tmpAxis1=O(),this.tmpAxis2=O(),this.tmpAngles=tt(),this.time=new Ed(.3),this.screen=[new Ed(.4),new Ed(.4)],this.angle1=new Sre(.6),this.angle2=new Sre(.6),this.axis1=O(),this.axis2=O(),this.lastScene=O()}addMomentumDirectRotation(t,i,r,s,n,o){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;let a=o_e(this.lastScene,i,this.tmpAxis2,s,n,o);this.angle2.update(0),ba(this.tmpAxis2)<Ere?a=0:we(this.axis1,this.tmpAxis2),this.angle1.update(a),se(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}addMomentumPreserveHeading(t,i,r,s,n,o,a){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(r)<.01)return;a_e(this.lastScene,i,this.tmpAxis2,this.tmpAxis1,this.tmpAngles,s,n,o,a,!1),ba(this.tmpAxis2)<Ere?(this.angle1.update(0),this.angle2.update(0)):(this.angle1.update(this.tmpAngles[1]),this.angle2.update(this.tmpAngles[0]),we(this.axis1,this.tmpAxis1),we(this.axis2,this.tmpAxis2)),se(this.lastScene,i)}this.screen[0].update(t[0]),this.screen[1].update(t[1]),this.time.update(r)}}reset(){this.screen[0].reset(),this.screen[1].reset(),this.angle1.reset(),this.angle2.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.screen[0].hasFilteredDelta)return null;const t=this.screen[0].filteredDelta,i=this.screen[1].filteredDelta,r=Math.sqrt(t*t+i*i)/this.time.filteredDelta;return Math.abs(r)<this.minimumInitialVelocity?null:this.createMomentum(r,this.stopVelocity,this.friction)}createMomentum(t,i,r){const s=this.angle1.filteredValue/this.time.filteredDelta,n=this.angle2.filteredValue/this.time.filteredDelta;return new fYe(t,i,r,s,this.axis1,n,this.axis2)}}class L_e{constructor(t=2.5,i=.01,r=.95,s=12){this.minimumInitialVelocity=t,this.stopVelocity=i,this.friction=r,this.maxVelocity=s,this.enabled=!0,this.value=new Ed(.8),this.time=new Ed(.3)}add(t,i){if(this.enabled){if(this.time.hasLastValue){if(this.time.computeDelta(i)<.01)return;if(this.value.hasFilteredDelta){const r=this.value.computeDelta(t);this.value.filteredDelta*r<0&&this.value.reset()}}this.time.update(i),this.value.update(t)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta)return null;let t=this.value.filteredDelta/this.time.filteredDelta;return t=$e(t,-this.maxVelocity,this.maxVelocity),Math.abs(t)<this.minimumInitialVelocity?null:this.createMomentum(t,this.stopVelocity,this.friction)}createMomentum(t,i,r){return new C5(t,i,r)}}class N_e extends L_e{constructor(t=3,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){if(this.value.hasLastValue){const r=this.value.lastValue;let s=t-r;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;t=r+s}super.add(t,i)}}class gYe extends C5{constructor(t,i,r){super(t,i,r)}value(t){const i=super.value(t);return Math.exp(i)}valueDelta(t,i){const r=super.value(t),s=super.value(t+i)-r;return Math.exp(s)}}class F_e extends L_e{constructor(t=2.5,i=.01,r=.95,s=12){super(t,i,r,s)}add(t,i){super.add(Math.log(t),i)}createMomentum(t,i,r){return new gYe(t,i,r)}}let YD=class extends Av{constructor(e){super(e),this.view=null,this.smoothRotation=new dF(.05),this.rotationAxis=O(),this.panningPlane=gi(),this.smoothScaling=new dF(.05),this.zoomCenterScreen=Vr(),this.zoomMomentumEstimator=new F_e,this.rotationMomentumEstimator=new N_e,this.panSphericalMomentumEstimator=new mYe,this.panPlanarMomentumEstimator=new D_e,this.adjustedSphere=fn(),this.tmp3d=O(),this.tmpScreenPointArray=Vr(),this.beginScreenPoint=Vr(),this.beginScenePoint=O(),this.screenPickPoint=Vr(),this.navMode=Zn.Horizontal,this.tmpInteractionDirection=O(),this.constraintOptions={selection:mr.ALL,interactionType:kt.NONE,interactionFactor:0,interactionStartCamera:new Yi,interactionDirection:null,tiltMode:Rn.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panPlanarMomentumEstimator.enabled=t,this.panSphericalMomentumEstimator.enabled=t,this.beginHeading=-pv.normalize($t(this.view.camera.heading)),this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.smoothRotation.reset(),qm(e.center,this.screenPickPoint),ro(this.beginScreenPoint,this.screenPickPoint);const i=vi(this.view.spatialReference),r=s_e(this.intersectionHelper,this.startCamera,this.screenPickPoint,i,b2.Silhouette);this.scenePickPoint=r.scenePickPoint,this.sphere=r.sphere,se(this.beginScenePoint,this.scenePickPoint),this.navMode=S5(this.startCamera,this.screenPickPoint,r.hasGeometryIntersection,i),this.navMode===Zn.Vertical&&this._preparePlanarPanMode(e),this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}_preparePlanarPanMode(e){const t=qo(this.tmp3d,this.startCamera.viewForward);qS(this.scenePickPoint,t,this.panningPlane);const i=Vr(this.screenPickPoint[0],0),r=O(),s=Me(this.startCamera.eye);this.adjustedSphere[3]=s<this.sphere[3]?s-100:this.sphere[3],zM(this.adjustedSphere,this.startCamera,i,r);const n=wo();this.startCamera.projectToRenderScreen(r,n);const o=.9*n[1];this.screenPickPoint[1]=Math.min(this.screenPickPoint[1],o);const a=this.intersectionHelper.intersectScreen(this.screenPickPoint,this.scenePickPoint);a&&qS(this.scenePickPoint,this.panningPlane,this.panningPlane);const l=O(),c=O(),h=O(),p=80,f=5,m=50;pe(l,this.scenePickPoint,this.currentCamera.eye);const y=Me(l);we(l,l);const v=f*Math.max(Math.abs(this.view.camera.position.z),m),w=this.view._stage.renderView.getMinimalDepthForArea(null,this.screenPickPoint[0],this.screenPickPoint[1],this.view.state.camera,p);let b=w?Math.min(w,v):v;b=a?Math.min(b,y):b,se(h,de(c,this.currentCamera.eye,oe(c,l,b))),this.panningPlane[3]=-xe(this.panningPlane,h),this.startCamera.center=de(c,this.startCamera.eye,oe(c,this.startCamera.viewForward,b));const S=qm(e.center,this.tmpScreenPointArray);H7(this.panningPlane,this.startCamera,S,this.beginScenePoint)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1;this.navMode===Zn.Horizontal?(t&&this._zoomSpherical(e),this._panningSpherical(e),t&&this._rotateSpherical(e)):(t&&this._zoomPlanar(e),this._panningPlanar(e),t&&this._rotatePlanar(e))}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return this.navMode===Zn.Horizontal?new d1({view:this.view,momentum:t,screenCenter:this.zoomCenterScreen,sceneCenter:this.beginScenePoint,radius:this.sphere[3]}):new UT({view:this.view,momentum:t,zoomCenter:this.beginScenePoint});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new z1({view:this.view,momentum:i,center:this.sphere,axis:this.rotationAxis});if(this.navMode===Zn.Horizontal){const r=this.panSphericalMomentumEstimator.evaluateMomentum();if(r)return new XD({view:this.view,momentum:r})}else{const r=this.panPlanarMomentumEstimator.evaluateMomentum();if(r)return new bR({view:this.view,momentum:r})}return null}_zoomSpherical(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),i_e(this.sphere,this.currentCamera,this.smoothScaling.value),qm(e.center,this.zoomCenterScreen),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),this.constraintOptions.interactionType=kt.ZOOM,this.constraintOptions.interactionFactor=Sd(e.radius-this.beginRadius),as(this.view,this.currentCamera,this.constraintOptions)}_panningSpherical(e){const t=qm(e.center,this.tmpScreenPointArray);zM(this.sphere,this.currentCamera,t,this.tmp3d),vY(this.beginScenePoint,xe(this.currentCamera.up,this.beginScenePoint),this.sphere[3],this.beginHeading,this.view.camera.tilt,this.startCamera)?(u_e(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.beginHeading,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumPreserveHeading(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere,this.beginHeading,this.view.camera.tilt)):(c_e(this.sphere,this.currentCamera,this.beginScenePoint,this.tmp3d,this.view.camera.tilt,!1),this.panSphericalMomentumEstimator.addMomentumDirectRotation(t,this.tmp3d,.001*e.timestamp,this.startCamera,this.sphere[3],this.view.camera.tilt)),this.constraintOptions.interactionType=kt.PAN,this.constraintOptions.interactionFactor=Sd(this.screenPickPoint,t),as(this.view,this.currentCamera,this.constraintOptions)}_rotateSpherical(e){we(this.rotationAxis,this.scenePickPoint),this.currentCamera.aboveGround||qo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value,i=t+j7(e.angle-t),r=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=r,this.smoothRotation.update(i);const s=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(s,.001*e.timestamp),Cv(this.currentCamera,this.sphere,bM(this.rotationAxis,s)),this.constraintOptions.interactionType=kt.TUMBLE,this.constraintOptions.interactionFactor=Sd(e.radius*i),as(this.view,this.currentCamera,this.constraintOptions)}_panningPlanar(e){const t=qm(e.center,this.tmpScreenPointArray);H7(this.panningPlane,this.currentCamera,t,this.tmp3d)&&(n_e(this.currentCamera,this.beginScenePoint,this.tmp3d),this.panPlanarMomentumEstimator.add(t,this.tmp3d,.001*e.timestamp),this.constraintOptions.interactionType=kt.PAN,this.constraintOptions.interactionFactor=Sd(this.beginScreenPoint,t),this.constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this.tmpInteractionDirection),as(this.view,this.currentCamera,this.constraintOptions),this.constraintOptions.interactionDirection=null)}_zoomPlanar(e){const t=this.beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this.smoothScaling.gain=i,this.smoothScaling.update(t),this.zoomMomentumEstimator.add(this.smoothScaling.value,.001*e.timestamp),yY(this.currentCamera,this.beginScenePoint,this.smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this.constraintOptions.interactionType=kt.ZOOM,this.constraintOptions.interactionFactor=Sd(e.radius-this.beginRadius),as(this.view,this.currentCamera,this.constraintOptions)}_rotatePlanar(e){se(this.rotationAxis,this.beginScenePoint),this.currentCamera.aboveGround||qo(this.rotationAxis,this.rotationAxis);const t=this.smoothRotation.value;let i=e.angle-t;i=j7(i);const r=t+i,s=.00125*Math.min(Math.max(e.radius,40),120);this.smoothRotation.gain=s,this.smoothRotation.update(r);const n=this.smoothRotation.value-this.beginAngle;this.rotationMomentumEstimator.add(n,.001*e.timestamp),Cv(this.currentCamera,this.sphere,bM(this.rotationAxis,n)),this.constraintOptions.interactionType=kt.TUMBLE,this.constraintOptions.interactionFactor=Sd(e.radius*n),as(this.view,this.currentCamera,this.constraintOptions)}};u([d({constructOnly:!0})],YD.prototype,"view",void 0),YD=u([P("esri.views.3d.state.controllers.global.PinchAndPanController")],YD);const Cre=Fe(0,0,1),yYe={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI},vYe=80;let ZD=class extends Av{constructor(e){super(e),this.view=null,this.rotationValueSmooth=new dF(.05),this.scalingValueSmooth=new dF(.05),this.planeHorizontal=gi(),this.planeVertical=gi(),this.rotationMomentumEstimator=new N_e,this.panMomentumEstimator=new D_e(300,12,.9),this.zoomMomentumEstimator=new F_e,this.beginCenter=O(),this.tmpPoints=[],this.beginCenterScreen=Vr(),this.tmpCentroid3d=O(),this.tmpCentroid2d=Vr(),this.tmp2d=Vr(),this.constraintOptions={selection:mr.ALL,interactionType:kt.NONE,interactionFactor:0,interactionStartCamera:new Yi,interactionDirection:null,tiltMode:Rn.TUMBLE}}get intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const t=this.view.navigation.momentumEnabled;this.zoomMomentumEstimator.enabled=t,this.rotationMomentumEstimator.enabled=t,this.panMomentumEstimator.enabled=t,this.beginRadius=e.radius,this.pointerCount=e.pointers.size,this.beginAngle=e.angle,this.rotationValueSmooth.reset(),this.scalingValueSmooth.reset(),qm(e.center,this.beginCenterScreen),bpe(Cre,0,this.planeHorizontal);const i=O(),r=this.intersectionHelper.intersectScreenFreePointFallback(this.beginCenterScreen,i),s=O();qo(s,this.startCamera.viewForward);const n=O();se(n,Cre);const o=xe(s,n),a=Hd(o<0?-o:o);if(this.panMode=a>=yYe.ANGLE_THRESHOLD?Zn.Horizontal:Zn.Vertical,n9(this.planeHorizontal,this.planeHorizontal,i),this.startCamera.aboveGround||o9(this.planeHorizontal,this.planeHorizontal),this.panMode===Zn.Vertical){oe(n,n,o),pe(this.planeVertical,s,n),we(this.planeVertical,this.planeVertical),n9(this.planeVertical,this.planeVertical,i);const l=O(),c=O(),h=O();pe(l,i,this.currentCamera.eye);const p=Me(l);we(l,l);const f=5*Math.max(Math.abs(this.view.camera.position.z),50),m=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this.beginCenterScreen[0],this.beginCenterScreen[1],this.view.state.camera,vYe);let y=m?Math.min(m,f):f;y=r?Math.min(y,p):y,se(h,de(c,this.currentCamera.eye,oe(c,l,y))),this.planeVertical[3]=-xe(this.planeVertical,h),this.computePlanePoints(e.pointers,this.planeVertical,this.startCamera,this.tmpPoints),X6(this.tmpPoints,this.beginCenter)}else this.computePlanePoints(e.pointers,this.planeHorizontal,this.startCamera,this.tmpPoints),X6(this.tmpPoints,this.beginCenter);this.constraintOptions.interactionStartCamera.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const t=e.pointers.size>1,i=this.panMode===Zn.Horizontal?this.planeHorizontal:this.planeVertical,r=this.beginCenter;if(t){const s=this.beginRadius/e.radius,n=.001875*Math.min(Math.max(e.radius,40),120);this.scalingValueSmooth.gain=n,this.scalingValueSmooth.update(s),yY(this.currentCamera,r,this.scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this.zoomMomentumEstimator.add(this.scalingValueSmooth.value,.001*e.timestamp),this.constraintOptions.interactionType=kt.ZOOM,this.constraintOptions.interactionFactor=Sd(Math.abs(e.radius-this.beginRadius)),as(this.view,this.currentCamera,this.constraintOptions)}if(this.computePlanePoints(e.pointers,i,this.currentCamera,this.tmpPoints),X6(this.tmpPoints,this.tmpCentroid3d),qm(e.center,this.tmpCentroid2d),n_e(this.currentCamera,r,this.tmpCentroid3d),this.panMomentumEstimator.add(this.tmpCentroid2d,this.tmpCentroid3d,.001*e.timestamp),this.constraintOptions.interactionType=kt.PAN,this.constraintOptions.interactionFactor=Sd(this.beginCenterScreen,this.tmpCentroid2d),as(this.view,this.currentCamera,this.constraintOptions),t){const s=this.planeHorizontal,n=r,o=this.rotationValueSmooth.value,a=o+j7(e.angle-o),l=.00125*Math.min(Math.max(e.radius,40),120);this.rotationValueSmooth.gain=l,this.rotationValueSmooth.update(a);const c=this.rotationValueSmooth.value-this.beginAngle;this.rotationMomentumEstimator.add(c,.001*e.timestamp),Cv(this.currentCamera,n,bM(s,c)),this.constraintOptions.interactionType=kt.TUMBLE,this.constraintOptions.interactionFactor=Sd(Math.abs(e.radius*c)),as(this.view,this.currentCamera,this.constraintOptions)}}end(e){e.pointers.size===this.pointerCount&&this.update(e),this.finishController();const t=this.zoomMomentumEstimator.evaluateMomentum();if(t)return new UT({view:this.view,momentum:t,zoomCenter:this.beginCenter});const i=this.rotationMomentumEstimator.evaluateMomentum();if(i)return new z1({view:this.view,momentum:i,center:this.beginCenter,axis:this.planeHorizontal});const r=this.panMomentumEstimator.evaluateMomentum();return r?new bR({view:this.view,momentum:r}):null}computePlanePoints(e,t,i,r){r.length=e.size;const s=this.tmp2d;let n=0;return e.forEach(o=>{s[0]=o.x,s[1]=o.y,r[n]===void 0&&(r[n]=O()),H7(t,i,s,r[n]),n+=1}),r}};u([d({constructOnly:!0})],ZD.prototype,"view",void 0),ZD=u([P("esri.views.3d.state.controllers.local.PinchAndPanController")],ZD);class Are extends Ao{constructor(t,i,r){super(!0),this.view=t,this.pointerAction=i,this.lastEndTimestamp=0,this.lastTimestamp=0,this.registerIncoming("drag",r,s=>this._handleDrag(s))}_handleDrag(t){if(t.data.pointerType==="mouse"&&!bY(t.data,this.pointerAction))return;const i=t.timestamp-this.lastEndTimestamp,r=40,s=this.momentum&&this.momentum.active&&i<r;switch(t.data.action){case"start":case"update":if(s)break;this.controller&&this.controller.active?t.data.timestamp-this.lastTimestamp>2&&(this.controller.update(t.data),this.lastTimestamp=t.timestamp):this._startController(t);break;case"end":case"removed":this._endController(t,!0);break;case"added":this._endController(t,!1),this._startController(t)}t.stopPropagation()}_endController(t,i){if(this.controller&&this.controller.active){this.lastEndTimestamp=t.timestamp;const r=this.controller.end(t.data);i&&r&&(this.momentum=r,this.view.state.switchCameraController(this.momentum))}this.controller=null}_startController(t){this.controller=this._createController(),this.view.state.switchCameraController(this.controller),this.controller.begin(t.data),this.lastTimestamp=t.timestamp}_createController(){return this.view.state.isGlobal?new YD({view:this.view}):new ZD({view:this.view})}}class _Ye extends Ao{constructor(t,i){super(!0),this.view=t,this.registerIncoming("pointer-down",i,()=>this.view.state.stopActiveCameraController())}}class U_e extends Ao{constructor(t,i){super(!0),this.key=t,this.registerIncoming("key-down",i,r=>this._handleKeyDown(r))}_handleKeyDown(t){t.data.key===this.key&&(this.activate(),t.stopPropagation())}}class bYe extends U_e{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({heading:0}).catch(()=>{})}}class wYe extends U_e{constructor(t,i,r){super(i,r),this.view=t}activate(){this.view.goTo({tilt:0}).catch(()=>{})}}class xYe extends Ao{constructor(t,i=!1){super(!0),this.view=t,this.invert=i,this.registerIncoming("vertical-two-finger-drag",r=>this._handleTwoFinger(r))}_handleTwoFinger(t){var s,n,o;const i=this.invert?-1:1,r=Vr(0,t.data.delta*i);switch(t.data.action){case"begin":(s=this.cameraController)==null||s.end(),this.cameraController=new FT({view:this.view,pivot:Fl.CENTER}),this.view.state.switchCameraController(this.cameraController),this.cameraController.begin(r);break;case"update":(n=this.cameraController)==null||n.update(r);break;case"end":(o=this.cameraController)==null||o.end(),this.cameraController=null}}}function Rre(e){const t=e.native;return t?{buttons:t.buttons.map(i=>i.pressed?i.value?i.value:1:0),axes:t.axes.map(i=>EYe(i,e.axisThreshold))}:{buttons:[],axes:[]}}function TYe(e,t){if(e.axes.length!==t.axes.length||e.buttons.length!==t.buttons.length)return!1;for(let i=0;i<e.axes.length;i++)if(e.axes[i]!==t.axes[i])return!1;for(let i=0;i<e.buttons.length;i++)if(e.buttons[i]!==t.buttons[i])return!1;return!0}function SYe(e){for(let t=0;t<e.axes.length;t++)if(e.axes[t]!==0)return!1;for(let t=0;t<e.buttons.length;t++)if(e.buttons[t]!==0)return!1;return!0}function EYe(e,t){const i=Math.abs(e);return i<t?0:Math.sign(e)*(i-t)/(1-t)}class CYe{constructor(t,i){this.element=t,this.input=i,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this.inputDevices[a];l&&(this._emitGamepadEvent(o,Rre(l),!1),this.inputDevices.splice(a,1),this.latestUpdate.splice(a,1),this.input.gamepad.devices.remove(l),this.ensurePollingState())},this.frameTask=null,this.latestUpdate=new Array,this.inputDevices=new Array,this.callback=null;const r="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=r&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(t){this._hasEventListeners!==t&&(this._hasEventListeners=t,this.ensurePollingState())}get eventsEnabled(){return this.supported&&this.inputDevices.length>0&&this._hasEventListeners}set onEvent(t){this.callback=t}_connectGamepad(t){const i=new TX(t);i.deviceType!=="unknown"&&(this.inputDevices[t.index]=i,this.input.gamepad.devices.add(i)),this.ensurePollingState()}ensurePollingState(){this.eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this.frameTask==null&&(this.frameTask=Eb({update:()=>this._readGamepadState()}))}_stopPolling(){this.frameTask!=null&&(this.frameTask.remove(),this.frameTask=null,this.latestUpdate=new Array)}_readGamepadState(){const t=document.hasFocus(),i=this.element.contains(document.activeElement),r=this.input.gamepad.enabledFocusMode==="document"&&!t||this.input.gamepad.enabledFocusMode==="view"&&!i;this._forEachGamepad(s=>{const n=this.inputDevices[s.index];if(!n)return;const o=this.latestUpdate[s.index],a=Rre(n),l=r||SYe(a);o&&(o.timestamp===s.timestamp||!o.active&&l||TYe(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(t){const i=window.navigator.getGamepads();for(let r=0;r<i.length;r++){const s=i[r];this._validate(s)&&t(s)}}_emitGamepadEvent(t,i,r){const s=this.latestUpdate[t.index],n=s&&s.active;if(!n&&!r)return;const o=!n&&r?"start":n&&r?"update":"end";this.latestUpdate[t.index]={timestamp:t.timestamp,state:i,active:r},this.callback&&this.callback({device:this.inputDevices[t.index],state:i,action:o})}_validate(t){if(!t||!t.connected)return!1;for(let i=0;i<t.axes.length;i++)if(isNaN(t.axes[i]))return!1;return!0}}const Mre=he("trident"),Ore=he("edge"),AYe=he("chrome"),RYe=he("ff"),MYe=he("safari"),jw={touchNone:"esri-view-surface--touch-none",touchPan:"esri-view-surface--touch-pan"};class A5{constructor(t,i){this.input=i,this._active={},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=t,t.getAttribute("tabindex")||t.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new CYe(t,this.input),this._gamepadSource.onEvent=r=>this._callback("gamepad",r)}destroy(){this._callback=null,this.activeEvents=null,this._activePointerCaptures.forEach(t=>{this._releasePointerCaptureSafe(t)}),this._gamepadSource&&(this._gamepadSource.destroy(),this._gamepadSource=null),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(t){this._browserTouchPanningEnabled=t,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(t){this._callback=t}set activeEvents(t){for(const i in this._active)if(!t||!t.has(i)){const r=this._active[i];this._element.removeEventListener(rz[i],r),delete this._active[i]}t&&t.forEach(i=>{if(!this._active[i]&&rz[i]){const r=(this._eventHandlers[i]||this._handleDefault).bind(this,i);this._element.addEventListener(rz[i],r),this._active[i]=r}}),this._gamepadSource.hasEventListeners=t&&t.has("gamepad")}setPointerCapture(t,i){i?(this._element.setPointerCapture(t.pointerId),this._activePointerCaptures.add(t.pointerId)):(this._releasePointerCaptureSafe(t.pointerId),this._activePointerCaptures.delete(t.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?jw.touchNone:jw.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?jw.touchPan:jw.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(jw.touchNone),this._element.classList.remove(jw.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_releasePointerCaptureSafe(t){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(t))return;this._element.releasePointerCapture(t)}catch{}}_updateNormalizedPointerLikeEvent(t,i){const r=m0e(this._element,t);return A5.test.disableSubpixelCoordinates&&(r.x=Math.round(r.x),r.y=Math.round(r.y)),i.x=r.x,i.y=r.y,i}_handleKey(t,i){const r=q8e(i);r&&t==="key-up"&&this._keyDownState.delete(r);const s={native:i,key:r,repeat:r&&this._keyDownState.has(r)};r&&t==="key-down"&&this._keyDownState.add(s.key),this._callback(t,s)}_handlePointer(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});this._callback(t,r)}_handlePointerPreventDefault(t,i){const r=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,pointerType:i.pointerType,button:i.button,buttons:i.buttons,eventId:this._eventId++});i.preventDefault(),this._callback(t,r)}_handleMouseWheel(t,i){let r=i.deltaY;switch(i.deltaMode){case 0:(Mre||Ore)&&(r=r/document.documentElement.clientHeight*600);break;case 1:r*=30;break;case 2:r*=900}Mre||Ore?r*=.7:AYe||MYe?r*=.6:RYe&&(r*=1.375);const s=100,n=Math.abs(r);n>s&&(r=r/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(i,{native:i,x:0,y:0,deltaY:r});this._callback(t,o)}_handlePointerCaptureLost(t,i){this._activePointerCaptures.delete(i.pointerId),this._handleDefault(t,i)}_handleDefault(t,i){const r={native:i};i.preventDefault(),this._callback(t,r)}_preventAltKeyDefault(t){t.key==="Alt"&&t.preventDefault()}_preventMultiTouchPanning(t){t.touches.length>1&&t.preventDefault()}}A5.test={disableSubpixelCoordinates:!1};const rz={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};class OYe extends Ao{constructor(){super(!0),this.registerIncoming("context-menu",t=>{t.data.native.preventDefault()})}}function k_e(e,t){return Math.abs(t.x-e.x)+Math.abs(t.y-e.y)}function PYe(e,t){const i=t.x-e.x,r=t.y-e.y;return Math.sqrt(i*i+r*r)}function IYe(e,t){if(t?(t.radius=0,t.center.x=0,t.center.y=0):t={radius:0,center:Xd()},e.length===0)return t;if(e.length===1)return t.center.x=e[0].x,t.center.y=e[0].y,t;if(e.length===2){const[T,E]=e,[C,M]=[E.x-T.x,E.y-T.y];return t.radius=Math.sqrt(C*C+M*M)/2,t.center.x=(T.x+E.x)/2,t.center.y=(T.y+E.y)/2,t}let i=0,r=0;for(let T=0;T<e.length;T++)i+=e[T].x,r+=e[T].y;i/=e.length,r/=e.length;const s=e.map(T=>T.x-i),n=e.map(T=>T.y-r);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let T=0;T<s.length;T++){const E=s[T],C=n[T],M=E*E,I=C*C;o+=M,a+=I,l+=E*C,c+=M*E,h+=I*C,p+=E*I,f+=C*M}const m=.5*(c+p),y=.5*(h+f),v=o*a-l*l,w=(m*a-y*l)/v,b=(o*y-l*m)/v,S=Xd(w+i,b+r);return{radius:Math.sqrt(w*w+b*b+(o+a)/e.length),center:S}}class $Ye extends Ao{constructor(t){super(!1),this.navigationTouch=t,this.startStateModifiers=new Set,this.activePointerMap=new Map,this.isDragging=!1,this.isCurrentDragSuppressed=!1,this.drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(t,i,r,s){return{action:t,pointerType:this.pointerType,button:this.mouseButton,buttons:i.buttons,timestamp:s,pointers:DYe(this.activePointerMap),pointer:i,angle:r.angle,radius:r.radius,center:r.center}}_addPointer(t){const i=t.native.pointerId,r=sI(this.activePointerMap).angle,s={event:t,initialAngle:0,lastAngle:0};this.activePointerMap.set(i,s);const n=QD(s,z_e(this.activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(r)}_updatePointer(t){if(t&&t.x==null&&t.y==null)return;const i=t.native.pointerId,r=this.activePointerMap.get(i);r?r.event=t:this._addPointer(t)}_removePointer(t){const i=sI(this.activePointerMap).angle;this.activePointerMap.delete(t),this._updatePointerAngles(i)}_updatePointerAngles(t){const i=sI(this.activePointerMap);this.activePointerMap.forEach(r=>{r.initialAngle=QD(r,i)-t,r.lastAngle=QD(r,i)-t})}_emitEvent(t,i,r){const s=sI(this.activePointerMap);this.drag.emit(this._createPayload(t,i,s,r),void 0,this.startStateModifiers)}_handlePointerUpAndPointerLost(t){const i=t.data.native.pointerId,r=t.timestamp;this.activePointerMap.get(i)&&(this.activePointerMap.size===1?(this._updatePointer(t.data),!this.isCurrentDragSuppressed&&this._emitEvent("end",t.data,r),this.isDragging=!1,this.isCurrentDragSuppressed=!1,this._removePointer(i)):(this._removePointer(i),this._emitEvent("removed",t.data,t.timestamp)))}_handlePointerDrag(t){const i=t.data,r=i.currentEvent,s=t.timestamp;switch(i.action){case"start":case"update":this.isDragging?this.activePointerMap.has(r.native.pointerId)?(this._updatePointer(r),!this.isCurrentDragSuppressed&&this._emitEvent("update",r,s)):(this._addPointer(r),this._emitEvent("added",r,s),this.isCurrentDragSuppressed=this.isSuppressed):(this._updatePointer(r),this.pointerType=t.data.startEvent.pointerType,this.mouseButton=t.data.startEvent.button,this.startStateModifiers=t.modifiers,this.isDragging=!0,this.isCurrentDragSuppressed=this.isSuppressed,!this.isCurrentDragSuppressed&&this._emitEvent("start",r,s))}}get isSuppressed(){return this.navigationTouch&&!this.navigationTouch.browserTouchPanEnabled&&this.pointerType==="touch"&&this.activePointerMap.size===1}}function z_e(e){const t=[];return e.forEach(i=>{t.push(Xd(i.event.x,i.event.y))}),IYe(t)}function sI(e){const t=z_e(e);let i=0;return e.forEach(r=>{let s=QD(r,t),n=s-r.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=r.lastAngle+n,r.lastAngle=s,i+=s-r.initialAngle}),i/=e.size||1,{angle:i,radius:t.radius,center:t.center}}function DYe(e){const t=new Map;return e.forEach((i,r)=>t.set(r,i.event)),t}function QD(e,t){const i=e.event,r=i.x-t.center.x,s=i.y-t.center.y;return Math.atan2(s,r)}var Pre;(function(e){e[e.Left=0]="Left",e[e.Middle=1]="Middle",e[e.Right=2]="Right",e[e.Back=3]="Back",e[e.Forward=4]="Forward",e[e.Undefined=-1]="Undefined"})(Pre||(Pre={}));const q0={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};class LYe extends Ao{constructor(t=q0.maximumDoubleClickDelay,i=q0.maximumDoubleClickDistance,r=q0.maximumDoubleTouchDelay,s=q0.maximumDoubleTouchDistance,n=e4){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("drag",this._handleDrag.bind(this))}onUninstall(){this._pointerState.forEach(t=>t.doubleClickTimeout=Ds(t.doubleClickTimeout))}get hasPendingInputs(){return Ws(this._pointerState,t=>t.doubleClickTimeout!=null)}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_handleImmediateClick(t){const i=t.data,r=this._pointerId(i),s=this._pointerState.get(r);if(s){const n=i.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;k_e(s.event.data,i)>n?(this._clearDoubleClickTimeout(r,!0),this._startClick(t)):(this._clearDoubleClickTimeout(r,!1),this._doubleClick.emit(s.event.data,void 0,s.event.modifiers))}else this._startClick(t)}_startClick(t){const i=this._pointerId(t.data),r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;this._pointerState.set(i,{event:t,doubleClickTimeout:this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(i),r)}),this.refreshHasPendingInputs()}_handlePointerDrag(t){const i=this._pointerId(t.data.currentEvent);this._clearDoubleClickTimeout(i,!0)}_handleDrag(t){const i=this._pointerId(t.data.pointer);this._clearDoubleClickTimeout(i,!0)}_clearDoubleClickTimeout(t,i){const r=this._pointerState.get(t);r&&(r.doubleClickTimeout.remove(),r.doubleClickTimeout=null,i&&this._doubleClickTimeoutExceeded(t),this._pointerState.delete(t),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(t){const i=this._pointerState.get(t);this._click.emit(i.event.data,void 0,i.event.modifiers),i.doubleClickTimeout=null,this._pointerState.delete(t),this.refreshHasPendingInputs()}}class NYe extends Ao{constructor(t=q0.maximumDoubleClickDelay,i=q0.maximumDoubleClickDistance,r=q0.maximumDoubleTouchDelay,s=q0.maximumDoubleTouchDistance,n=e4){super(!1),this.maximumDoubleClickDelay=t,this.maximumDoubleClickDistance=i,this.maximumDoubleTouchDelay=r,this.maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",o=>{this._handlePointerLoss(o,"pointer-up")}),this.registerIncoming("pointer-capture-lost",o=>{this._handlePointerLoss(o,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",o=>{this._handlePointerLoss(o,"pointer-cancel")})}onUninstall(){this._pointerState.forEach(t=>{t.immediateDoubleClick&&t.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=this._pointerId(i);if(!this._pointerState.has(r)){const s={downButton:i.native.button,immediateDoubleClick:null};this._pointerState.set(r,s),this.startCapturingPointer(i.native)}}_handlePointerLoss(t,i){const r=t.data,s=this._pointerId(r),n=this._pointerState.get(s);if(n&&i==="pointer-up"&&n.downButton===r.native.button){const o=n.immediateDoubleClick;if(o){o.timeoutHandle.remove();const a=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDistance:this.maximumDoubleClickDistance;k_e(o,t.data)>a?this._startImmediateDoubleClick(t,n):(this._immediateDoubleClick.emit(t.data,void 0,o.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(t,n)}}_startImmediateDoubleClick(t,i){const r=t.data.native.pointerType==="touch"?this.maximumDoubleTouchDelay:this.maximumDoubleClickDelay;i.immediateDoubleClick={x:t.data.x,y:t.data.y,modifiers:t.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(t.data),r)}}_pointerId(t){const i=t.native;return i.pointerType==="mouse"?`${i.pointerId}:${i.button}`:`${i.pointerType}`}_removeState(t){const i=this._pointerId(t);this._pointerState.delete(i),this.stopCapturingPointer(t.native),this.refreshHasPendingInputs()}}const HE={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};class FYe extends Ao{constructor(t=HE.maximumClickDelay,i=HE.movementUntilMouseDrag,r=HE.movementUntilPenDrag,s=HE.movementUntilTouchDrag,n=HE.holdDelay,o=e4){super(!1),this.maximumClickDelay=t,this.movementUntilMouseDrag=i,this.movementUntilPenDrag=r,this.movementUntilTouchDrag=s,this.holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(t=>{t.holdTimeout!=null&&(t.holdTimeout.remove(),t.holdTimeout=null)}),super.onUninstall()}_handlePointerDown(t){const i=t.data,r=i.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(r);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,t.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this.holdDelay));const n={startEvent:i,previousEvent:i,startTimestamp:t.timestamp,isDragging:!1,downButton:i.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(r,n),this.startCapturingPointer(i.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(t)}_createPointerDragData(t,i,r){return{action:t,startEvent:i.startEvent,previousEvent:i.previousEvent,currentEvent:r}}_handlePointerMove(t){const i=t.data,r=i.native.pointerId,s=this._pointerState.get(r);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,i),void 0,s.modifiers):PYe(i,s.startEvent)>this._getDragThreshold(i.native.pointerType)&&this._startDragging(t),s.previousEvent=i)}_getDragThreshold(t){switch(t){case"touch":return this.movementUntilTouchDrag;case"pen":return this.movementUntilPenDrag;default:return this.movementUntilMouseDrag}}_startDragging(t){const i=t.data,r=i.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=t.modifiers,s.isDragging=!0,r===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,i)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),t.timestamp))})}_handlePointerLoss(t,i){const r=t.data,s=r.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,i==="pointer-up"?r:n.previousEvent),void 0,n.modifiers):i==="pointer-up"&&n.downButton===r.native.button&&t.timestamp-n.startTimestamp<=this.maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(r),this._pointerState.delete(s),this.stopCapturingPointer(r.native),this._pointerState.size===0&&this._moveHandle.pause())}}class UYe{constructor(t){this.callbacks=t,this.currentCount=0,this.callbacks.condition||(this.callbacks.condition=()=>!0)}handle(t){const i=t.data,r=i.pointers.size;switch(i.action){case"start":this.currentCount=r,this._emitStart(t);break;case"added":this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"update":this._emitUpdate(t);break;case"removed":this.startEvent&&this._emitEnd(this.previousEvent),this.currentCount=r,this._emitStart(t);break;case"end":this._emitEnd(t),this.currentCount=0}this.previousEvent=t}_emitStart(t){this.startEvent=t,this.callbacks.condition(this.currentCount,t)&&this.callbacks.start(this.currentCount,t,this.startEvent)}_emitUpdate(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.update(this.currentCount,t,this.startEvent)}_emitEnd(t){this.callbacks.condition(this.currentCount,t)&&this.callbacks.end(this.currentCount,t,this.startEvent),this.startEvent=null}}class kYe extends Ao{constructor(t=20,i=40){super(!1),this._threshold=t,this._maxDelta=i,this.state="ready",this.emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this.dragEventSeparator=new UYe({start:(r,s)=>this._observeStart(r,s),update:(r,s,n)=>this._observeUpdate(r,s,n),end:(r,s)=>this._observeEnd(s)}),this.registerIncoming("drag",r=>this.dragEventSeparator.handle(r))}get failed(){return this.state==="failed"}_observeStart(t,i){t===1&&this.emittedArtificalEnd2&&(this.emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),i.stopPropagation()),this.state=t===2?"ready":"failed"}_observeUpdate(t,i,r){if(this.state!=="failed"&&t===2)return this.state==="active"?(this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void i.stopPropagation()):void(this._checkMovementWithinLimits(i.data,r.data)?this._checkVerticalThresholdReached(i.data,r.data)&&(this.state="active",this.emittedArtificalEnd2=!0,this._thresholdReachedCenter=i.data.center,this._artificalDrag.emit({action:"end",button:i.data.button,buttons:i.data.buttons,pointerType:i.data.pointerType,timestamp:i.data.timestamp,pointers:i.data.pointers,pointer:i.data.pointer,angle:i.data.angle,radius:i.data.radius,center:i.data.center}),this._vertical.emit({delta:i.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),i.stopPropagation()):this.state="failed")}_observeEnd(t){this.state==="active"&&(this._vertical.emit({delta:t.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this.state="ready",t.stopPropagation())}_checkMovementWithinLimits(t,i){let r=-1/0,s=1/0,n=-1/0,o=1/0;i.pointers.forEach(v=>{r=Math.max(r,v.x),s=Math.min(s,v.x),n=Math.max(n,v.y),o=Math.min(o,v.y)});let a=-1/0,l=1/0,c=-1/0,h=1/0;t.pointers.forEach(v=>{a=Math.max(a,v.x),l=Math.min(l,v.x),c=Math.max(c,v.y),h=Math.min(h,v.y)});const p=r-s,f=n-o,m=a-l,y=c-h;return Math.abs(t.center.x-i.center.x)<this._threshold&&Math.abs(m-p)<=this._maxDelta&&Math.abs(y-f)<=this._maxDelta}_checkVerticalThresholdReached(t,i){let r=Math.abs(t.center.y-i.center.y);return t.pointers.forEach((s,n)=>{const o=i.pointers.get(n);r=Math.min(r,Math.abs(s.y-o.y))}),r>=this._threshold}}let Np=class extends Ee{constructor(){super(...arguments),this._handles=new qt}destroy(){this._handles&&(this._handles.removeAll(),this._handles=null),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get hasPendingInputs(){var e;return(e=this._inputManager)==null?void 0:e.hasPendingInputs}get latestPointerType(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerType}get latestPointerLocation(){var e;return(e=this._inputManager)==null?void 0:e.latestPointerLocation}disconnect(){this.view.viewEvents.disconnect(),this._inputManager&&(this._inputManager.destroy(),this._inputManager=null),this._source&&(this._source.destroy(),this._source=null)}connect(){const e=this.view;this._source=new A5(this.view.surface,e.input);const t=[new NYe,new FYe,new LYe,new $Ye(this.view.navigation),new kYe],i=new Yy({eventSource:this._source,recognizers:t});this._inputManager=i,i.installHandlers("prevent-context-menu",[new OYe],rv.INTERNAL),this._modeDragPan=new Are(e,"primary"),this._modeDragRotate=new K6(e,"secondary",Fl.CENTER),this._modeDragZoom=new AXe(e,"tertiary");const r={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new _Ye(e),new TXe(e),new cYe(e),new uYe(e,r.pan),new hYe(e),new wYe(e,r.resetTilt),new bYe(e,r.resetHeading),new K6(e,"primary",Fl.EYE,[r.lookAround]),new K6(e,"secondary",Fl.CENTER,[r.lookAround]),new Are(e,"tertiary",[r.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new xYe(e)],rv.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(ae(()=>{var s;return(s=this.view.navigation)==null?void 0:s.browserTouchPanEnabled},s=>{this._source.browserTouchPanningEnabled=!s},Ft))}_updateMode(){const e=this.mode,t=this.primaryDragAction,i=X7.get(e).get(t);this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom)}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Np.prototype,"view",void 0),u([d({value:"pan"})],Np.prototype,"primaryDragAction",null),u([d({value:"default"})],Np.prototype,"mode",null),u([d({readOnly:!0})],Np.prototype,"hasPendingInputs",null),u([d()],Np.prototype,"latestPointerType",null),u([d()],Np.prototype,"latestPointerLocation",null),u([d()],Np.prototype,"_inputManager",void 0),Np=u([P("esri.views.3d.input.SceneInputManager")],Np);const X7=new Map,sz=new Map,nz=new Map;sz.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),sz.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),nz.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),nz.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),X7.set("default",sz),X7.set("pro",nz);const zYe=Np;let is=class extends Ee{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};u([d()],is.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],is.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],is.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],is.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],is.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],is.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],is.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],is.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],is.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],is.prototype,"SHOW_POI",void 0),u([d()],is.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],is.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],is.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],is.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],is.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],is.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],is.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],is.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],is.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],is.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],is.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],is.prototype,"LINE_WIREFRAMES",void 0),is=u([P("esri.views.3d.support.DebugFlags")],is);const zi=new is;let Fc,cS,Y7=!1,Z7=!1,Q7=!1,J7=!1,wR=null;function VYe(e,t){if(!Z7||!cS)return;V_e();const i=cS;let r=0;for(let s=0;s<e.accBinsNumX;s++)for(let n=0;n<e.accBinsNumY;n++){const o=e.accBins[s][e.accBinsNumY-1-n];r+=o.length;const a=s*e.accBinsSizeX,l=(s+1)*e.accBinsSizeX,c=n*e.accBinsSizeY,h=(n+1)*e.accBinsSizeY;i.fillText(o.length.toFixed(),a+5,c+15),B_e(a,l,c,h,"blue")}i.fillText("total totalShownLabels: "+r,70,40),i.fillText("total visible labels: "+t.size,70,50),i.fillText("total numTests: "+e.accNumTests,70,30)}function BYe(e){Q7=zi.DECONFLICTOR_SHOW_VISIBLE,J7=zi.DECONFLICTOR_SHOW_INVISIBLE,Y7=Q7||J7,Z7=zi.DECONFLICTOR_SHOW_GRID,wR=null,Y7||Z7?wR=()=>GYe(e):Fc&&(Fc.parentElement.removeChild(Fc),Fc=null)}function V_e(){wR&&(wR(),wR=null)}function GYe(e){Fc==null&&(Fc=document.createElement("canvas"),Fc.setAttribute("id","canvas2d"),e.surface.parentElement.style.position="relative",e.surface.parentElement.appendChild(Fc));const{state:t}=e,{camera:i,pixelRatio:r}=t,{width:s,height:n}=i,o=s*r,a=n*r;Fc.setAttribute("width",`${o}px`),Fc.setAttribute("height",`${a}px`),Fc.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),cS=Fc.getContext("2d"),cS.clearRect(0,0,s,n),cS.font="12px Arial"}function B_e(e,t,i,r,s){V_e();const n=Fc.height,o=cS;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(e,n-i),o.lineTo(t,n-i),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.closePath()}function jYe(e,t){Y7&&(t&&Q7||!t&&J7)&&B_e(e.aabr[0],e.aabr[2],e.aabr[1],e.aabr[3],t?"green":"red")}var Wn,Yc;(function(e){e[e.GRAPHIC=0]="GRAPHIC",e[e.LABEL=1]="LABEL",e[e._COUNT=2]="_COUNT"})(Wn||(Wn={})),function(e){e[e.USER_SETTING=0]="USER_SETTING",e[e.SCALE_RANGE=1]="SCALE_RANGE",e[e.FILTER=2]="FILTER",e[e.DECONFLICTION=3]="DECONFLICTION",e[e._COUNT=4]="_COUNT"}(Yc||(Yc={}));function G_e(e,t){return new R5(e,W_e,t)}function HYe(e,t){const{curvatureDependent:i,scaleStart:r,scaleFallOffRange:s}=W_e;return new R5(e,{curvatureDependent:{min:{curvature:i.min.curvature,tiltAngle:i.min.tiltAngle,scaleFallOffFactor:oz.curvatureDependent.min.scaleFallOffFactor},max:{curvature:i.max.curvature,tiltAngle:i.max.tiltAngle,scaleFallOffFactor:oz.curvatureDependent.max.scaleFallOffFactor}},scaleStart:r,scaleFallOffRange:s,minPixelSize:oz.minPixelSize},t)}function qYe(e){return Math.abs(e*e*e)}function j_e(e,t,i){const r=i.parameters,s=i.paddingPixelsOverride;return qE.scale=Math.min(r.divisor/(t-r.offset),1),qE.factor=qYe(e),qE.minPixelSize=r.minPixelSize,qE.paddingPixels=s,qE}function H_e(e,t){return e===0?t.minPixelSize:t.minPixelSize*(1+2*t.paddingPixels/e)}function SY(e,t){return Math.max(jt(e*t.scale,e,t.factor),H_e(e,t))}function WYe(e,t,i){const r=j_e(e,t,i);return r.minPixelSize=0,r.paddingPixels=0,SY(1,r)}function Ire(e,t,i,r){r.scale=WYe(e,t,i),r.factor=0,r.minPixelSize=i.parameters.minPixelSize,r.paddingPixels=i.paddingPixelsOverride}function q_e(e,t,i=[0,0]){const r=Math.min(Math.max(t.scale,H_e(e[1],t)/Math.max(1e-5,e[1])),1);return i[0]=e[0]*r,i[1]=e[1]*r,i}function XYe(e,t,i,r){return SY(e,j_e(t,i,r))}class R5{constructor(t,i,r,s=YYe(),n){this.viewingMode=t,this.description=i,this.ellipsoidRadius=r,this.parameters=s,this._paddingPixelsOverride=n,this.viewingMode===Ve.Local?(this.coverageCompensation=this._surfaceCoverageCompensationLocal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this.coverageCompensation=this._surfaceCoverageCompensationGlobal,this.calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}update(t){return(!this.parameters||this.parameters.camera.fovY!==t.fovY||this.parameters.camera.distance!==t.distance)&&(this._calculateParameters(t,this.ellipsoidRadius,this.parameters),!0)}overridePadding(t){return t!==this.paddingPixelsOverride?new R5(this.viewingMode,this.description,this.ellipsoidRadius,this.parameters,t):this}_calculateParameters(t,i,r){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this.description,{fovY:a,distance:l}=t,c=this.calculateCurvatureDependentParameters(t,i),h=this.coverageCompensation(t,i,c),{tiltAngle:p,scaleFallOffFactor:f}=c,m=Math.sin(p)*l,y=.5*Math.PI-p-a*(.5-s*h),v=m/Math.cos(y),w=y+a*n*h,b=(v-f*(m/Math.cos(w)))/(1-f);return r.camera.fovY=t.fovY,r.camera.distance=t.distance,r.offset=b,r.divisor=v-b,r.minPixelSize=o,r}_calculateCurvatureDependentParametersLocal(t,i,r=$re){return r.tiltAngle=this.description.curvatureDependent.min.tiltAngle,r.scaleFallOffFactor=this.description.curvatureDependent.min.scaleFallOffFactor,r}_calculateCurvatureDependentParametersGlobal(t,i,r=$re){const s=this.description.curvatureDependent,n=1+t.distance/i,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=$e((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return r.tiltAngle=jt(h.tiltAngle,p.tiltAngle,c),r.scaleFallOffFactor=jt(h.scaleFallOffFactor,p.scaleFallOffFactor,c),r}_surfaceCoverageCompensationLocal(t,i,r){return(t.fovY-r.tiltAngle)/t.fovY}_surfaceCoverageCompensationGlobal(t,i,r){const s=i*i,n=r.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=t,l=a*a+s-2*Math.cos(n)*a*i,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(i/(c/Math.sin(n)))+.5*o)/o}}const W_e={curvatureDependent:{min:{curvature:$t(10),tiltAngle:$t(12),scaleFallOffFactor:.5},max:{curvature:$t(70),tiltAngle:$t(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},oz={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function YYe(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const qE={scale:0,factor:0,minPixelSize:0,paddingPixels:0},$re={tiltAngle:0,scaleFallOffFactor:0};function ZYe(e){return e instanceof Float32Array&&e.length>=16}function QYe(e){return Array.isArray(e)&&e.length>=16}function JYe(e){return ZYe(e)||QYe(e)}var J;(function(e){e[e.Color=0]="Color",e[e.Depth=1]="Depth",e[e.Normal=2]="Normal",e[e.Shadow=3]="Shadow",e[e.Highlight=4]="Highlight",e[e.Draped=5]="Draped",e[e.Occlusion=6]="Occlusion",e[e.Alpha=7]="Alpha",e[e.COUNT=8]="COUNT"})(J||(J={}));function EY(e){e.vertex.code.add(x`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),e.vertex.code.add(x`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),e.vertex.code.add(x`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),e.vertex.code.add(x`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),e.vertex.code.add(x`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),e.vertex.code.add(x`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),e.vertex.code.add(x`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function KYe(e){e.uniforms.add(new ei("screenSizePerspective",t=>X_e(t.screenSizePerspective)))}function M5(e){e.uniforms.add(new ei("screenSizePerspectiveAlignment",t=>X_e(t.screenSizePerspectiveAlignment||t.screenSizePerspective)))}function X_e(e){return qi(eZe,e.parameters.divisor,e.parameters.offset,e.parameters.minPixelSize,e.paddingPixelsOverride)}const eZe=Gt();class K7 extends jr{constructor(t,i){super(t,"mat4",$i.Draw,(r,s,n)=>r.setUniformMatrix4fv(t,i(s,n)))}}function Mf(e,t){t.instancedDoublePrecision?e.constants.add("cameraPosition","vec3",Ta):e.uniforms.add(new Sa("cameraPosition",(i,r)=>ie(Y_e,r.camera.viewInverseTransposeMatrix[3]-i.origin[0],r.camera.viewInverseTransposeMatrix[7]-i.origin[1],r.camera.viewInverseTransposeMatrix[11]-i.origin[2])))}function ou(e,t){if(e.vertex.uniforms.add(new vr("proj",(r,s)=>s.camera.projectionMatrix)),t.instancedDoublePrecision){const r=(n,o)=>ie(Y_e,o.camera.viewInverseTransposeMatrix[3],o.camera.viewInverseTransposeMatrix[7],o.camera.viewInverseTransposeMatrix[11]);e.vertex.uniforms.add(new vr("view",(n,o)=>Aa(Dre,o.camera.viewMatrix,r(n,o))));const s=new xt("localOrigin",r);return e.vertex.uniforms.add(s),s}e.vertex.uniforms.add(new K7("view",(r,s)=>Aa(Dre,s.camera.viewMatrix,r.origin)));const i=new Sa("localOrigin",r=>r.origin);return e.vertex.uniforms.add(i),i}const Dre=OO(),Y_e=O();function Z_e(e,t){const i=e.vertex;t.hasVerticalOffset?(Q_e(i),t.hasScreenSizePerspective&&(e.include(EY),M5(i),Mf(e.vertex,t)),i.code.add(x`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${t.spherical?x`vec3 worldNormal = normalize(worldPos + localOrigin);`:x`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${t.hasScreenSizePerspective?x`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:x`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):i.code.add(x`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const tZe=Gt();function Q_e(e){e.uniforms.add(new ei("verticalOffset",(t,i)=>{const{minWorldLength:r,maxWorldLength:s,screenLength:n}=t.verticalOffset,o=Math.tan(.5*i.camera.fovY)/(.5*i.camera.fullViewport[3]),a=i.camera.pixelRatio||1;return qi(tZe,n*a,o,r,s)}))}var th;(function(e){e[e.Occluded=0]="Occluded",e[e.NotOccluded=1]="NotOccluded",e[e.Both=2]="Both",e[e.COUNT=3]="COUNT"})(th||(th={}));var el;function J_e(e,t){e.include(EY),e.attributes.add(A.POSITION,"vec3"),e.attributes.add(A.NORMAL,"vec3"),e.attributes.add(A.AUXPOS1,"vec4");const i=e.vertex;ou(e,t),Mf(i,t),i.uniforms.add([new ei("viewport",(r,s)=>s.camera.fullViewport),new We("polygonOffset",r=>r.shaderPolygonOffset),new We("cameraGroundRelative",(r,s)=>s.camera.aboveGround?1:-1),new We("renderTransparentlyOccludedHUD",(r,s)=>s.renderTransparentlyOccludedHUD===th.Occluded?1:s.renderTransparentlyOccludedHUD===th.NotOccluded?0:.75),new zt("hudVisibilityTexture",(r,s)=>s.hudVisibilityTexture)]),t.hasVerticalOffset&&Q_e(i),i.constants.add("smallOffsetAngle","float",.984807753012208),i.code.add(x`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),i.code.add(x`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),t.isDraped&&!t.hasVerticalOffset||i.uniforms.add(new vr("viewNormal",(r,s)=>s.camera.viewInverseTransposeMatrix)),t.isDraped||(i.uniforms.add(new We("perDistancePixelRatio",(r,s)=>Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[2]/2))),i.code.add(x`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`)),t.screenCenterOffsetUnitsEnabled===el.Screen&&i.uniforms.add(new We("pixelRatio",(r,s)=>s.camera.pixelRatio)),t.hasScreenSizePerspective&&M5(i),i.code.add(x`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${t.isDraped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${t.hasScreenSizePerspective&&(t.hasVerticalOffset||t.screenCenterOffsetUnitsEnabled===el.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${t.hasVerticalOffset?t.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${t.hasVerticalOffset?x`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${t.screenCenterOffsetUnitsEnabled!==el.Screen?x`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${t.screenCenterOffsetUnitsEnabled===el.Screen?t.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${t.screenCenterOffsetUnitsEnabled===el.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),i.code.add(x`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture2D(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}(function(e){e[e.World=0]="World",e[e.Screen=1]="Screen",e[e.COUNT=2]="COUNT"})(el||(el={}));const nI=Ls();function O5(e,t,i,r,s,n,o){if(!HO(t))if(e.boundingInfo){dt(e.primitiveType===ll.Triangle);const a=i.tolerance;K_e(e.boundingInfo,r,s,a,n,o)}else{const a=e.indices.get(A.POSITION),l=e.vertexAttributes.get(A.POSITION);XO(r,s,0,a.length/3,a,l,void 0,n,o)}}const iZe=O();function K_e(e,t,i,r,s,n){if(R(e))return;const o=t1e(t,i,iZe);if(ohe(nI,e.getBBMin()),ahe(nI,e.getBBMax()),_(s)&&s.applyToAabb(nI),AY(nI,t,o,r)){const{primitiveIndices:a,indices:l,position:c}=e,h=a?a.length:l.length/3;if(h>aZe){const p=e.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&K_e(p[f],t,i,r,s,n);return}}XO(t,i,0,h,l,c,a,s,n)}}const e1e=O();function XO(e,t,i,r,s,n,o,a,l){if(o)return rZe(e,t,i,r,s,n,o,a,l);const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],m=e[2],y=t[0]-p,v=t[1]-f,w=t[2]-m;for(let b=i,S=3*i;b<r;++b){let T=h*s[S++],E=c[T++],C=c[T++],M=c[T];T=h*s[S++];let I=c[T++],N=c[T++],D=c[T];T=h*s[S++];let z=c[T++],V=c[T++],k=c[T];_(a)&&([E,C,M]=a.applyToVertex(E,C,M,b),[I,N,D]=a.applyToVertex(I,N,D,b),[z,V,k]=a.applyToVertex(z,V,k,b));const Y=I-E,Z=N-C,le=D-M,ne=z-E,$=V-C,U=k-M,B=v*U-$*w,H=w*ne-U*y,W=y*$-ne*v,K=Y*B+Z*H+le*W;if(Math.abs(K)<=Number.EPSILON)continue;const j=p-E,ee=f-C,ye=m-M,Te=j*B+ee*H+ye*W;if(K>0){if(Te<0||Te>K)continue}else if(Te>0||Te<K)continue;const Ne=ee*le-Z*ye,_e=ye*Y-le*j,ge=j*Z-Y*ee,Ce=y*Ne+v*_e+w*ge;if(K>0){if(Ce<0||Te+Ce>K)continue}else if(Ce>0||Te+Ce<K)continue;const Le=(ne*Ne+$*_e+U*ge)/K;Le>=0&&l(Le,CY(Y,Z,le,ne,$,U,e1e),b,!1)}}function rZe(e,t,i,r,s,n,o,a,l){const c=n.data,h=n.stride||n.size,p=e[0],f=e[1],m=e[2],y=t[0]-p,v=t[1]-f,w=t[2]-m;for(let b=i;b<r;++b){const S=o[b];let T=3*S,E=h*s[T++],C=c[E++],M=c[E++],I=c[E];E=h*s[T++];let N=c[E++],D=c[E++],z=c[E];E=h*s[T];let V=c[E++],k=c[E++],Y=c[E];_(a)&&([C,M,I]=a.applyToVertex(C,M,I,b),[N,D,z]=a.applyToVertex(N,D,z,b),[V,k,Y]=a.applyToVertex(V,k,Y,b));const Z=N-C,le=D-M,ne=z-I,$=V-C,U=k-M,B=Y-I,H=v*B-U*w,W=w*$-B*y,K=y*U-$*v,j=Z*H+le*W+ne*K;if(Math.abs(j)<=Number.EPSILON)continue;const ee=p-C,ye=f-M,Te=m-I,Ne=ee*H+ye*W+Te*K;if(j>0){if(Ne<0||Ne>j)continue}else if(Ne>0||Ne<j)continue;const _e=ye*ne-le*Te,ge=Te*Z-ne*ee,Ce=ee*le-Z*ye,Le=y*_e+v*ge+w*Ce;if(j>0){if(Le<0||Ne+Le>j)continue}else if(Le>0||Ne+Le<j)continue;const Ri=($*_e+U*ge+B*Ce)/j;Ri>=0&&l(Ri,CY(Z,le,ne,$,U,B,e1e),S,!1)}}const Lre=O(),Nre=O();function CY(e,t,i,r,s,n,o){return ie(Lre,e,t,i),ie(Nre,r,s,n),lt(o,Lre,Nre),we(o,o),o}function t1e(e,t,i){return ie(i,1/(t[0]-e[0]),1/(t[1]-e[1]),1/(t[2]-e[2]))}function AY(e,t,i,r){return RY(e,t,i,r,1/0)}function RY(e,t,i,r,s){const n=(e[0]-r-t[0])*i[0],o=(e[3]+r-t[0])*i[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(e[1]-r-t[1])*i[1],h=(e[4]+r-t[1])*i[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(e[2]-r-t[2])*i[2],f=(e[5]+r-t[2])*i[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function i1e(e,t,i,r,s){let n=(i.screenLength||0)*e.pixelRatio;_(s)&&(n=XYe(n,r,t,s));const o=n*Math.tan(.5*e.fovY)/(.5*e.fullHeight);return $e(o*t,i.minWorldLength||0,i.maxWorldLength!=null?i.maxWorldLength:1/0)}function r1e(e,t){const i=t?r1e(t):{};for(const r in e){let s=e[r];s&&s.forEach&&(s=oZe(s)),s==null&&r in i||(i[r]=s)}return i}function sZe(e,t){let i=!1;for(const r in t){const s=t[r];s!==void 0&&(Array.isArray(s)?e[r]===null?(e[r]=s.slice(),i=!0):vH(e[r],s)&&(i=!0):e[r]!==s&&(i=!0,e[r]=s))}return i}function nZe(e,t,i,r,s,n){if(!t.options.selectionMode)return;const o=e.vertexAttributes.get(A.POSITION).data,a=e.vertexAttributes.get(A.SIZE),l=a&&a.data[0],c=r[0],h=r[1],p=((l+s)/2+4)*e.screenToWorldRatio;let f=Number.MAX_VALUE,m=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],w=o[y+1],b=c-v,S=h-w,T=o[y+3]-v,E=o[y+4]-w,C=$e((T*b+E*S)/(T*T+E*E),0,1),M=T*C-b,I=E*C-S,N=M*M+I*I;N<f&&(f=N,m=y/3)}f<p*p&&n(i.dist,i.normal,m,!1)}function oZe(e){const t=[];return e.forEach(i=>t.push(i)),t}const s1e={multiply:1,ignore:2,replace:3,tint:4},aZe=1e3;class Gf extends jO{constructor(t,i){super(),this.type=Kd.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=Di,this._parameters=r1e(t,i),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(t){return!1}setParameters(t,i=!0){sZe(this._parameters,t)&&(this.validateParameters(this._parameters),i&&this.parametersChanged())}validateParameters(t){}get visible(){return this._visible}set visible(t){t!==this._visible&&(this._visible=t,this.parametersChanged())}shouldRender(t){return this.isVisible()&&this.isVisibleInPass(t.pass)&&(this.renderOccluded&t.renderOccludedMask)!=0}isVisibleInPass(t){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(t){t!==this._renderPriority&&(this._renderPriority=t,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(t){t!==this._insertOrder&&(this._insertOrder=t,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){_(this.repository)&&this.repository.materialChanged(this)}}var Mr;(function(e){e[e.Occlude=1]="Occlude",e[e.Transparent=2]="Transparent",e[e.OccludeAndTransparent=4]="OccludeAndTransparent",e[e.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",e[e.Opaque=16]="Opaque"})(Mr||(Mr={}));class uE extends Us{constructor(){super(...arguments),this.renderOccluded=Mr.Occlude}}function q_t(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l)n[r]=t[e[l]],r+=o;else for(let l=0;l<a;++l){const c=t[e[l]];for(let h=0;h<s;h++)n[r]=c,r+=o}}function lZe(e,t,i,r){const s=i.typedBuffer,n=i.typedBufferStride,o=e.length;r*=n;for(let a=0;a<o;++a){const l=2*e[a];s[r]=t[l],s[r+1]=t[l+1],r+=n}}function n1e(e,t,i,r,s){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}else for(let l=0;l<a;++l){const c=3*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],r+=o}}function T2(e,t,i,r,s=1){const n=i.typedBuffer,o=i.typedBufferStride,a=e.length;if(r*=o,s===1)for(let l=0;l<a;++l){const c=4*e[l];n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}else for(let l=0;l<a;++l){const c=4*e[l];for(let h=0;h<s;++h)n[r]=t[c],n[r+1]=t[c+1],n[r+2]=t[c+2],n[r+3]=t[c+3],r+=o}}function P5(e,t,i,r,s,n=1){if(!i)return void n1e(e,t,r,s,n);const o=r.typedBuffer,a=r.typedBufferStride,l=e.length,c=i[0],h=i[1],p=i[2],f=i[4],m=i[5],y=i[6],v=i[8],w=i[9],b=i[10],S=i[12],T=i[13],E=i[14];if(s*=a,n===1)for(let C=0;C<l;++C){const M=3*e[C],I=t[M],N=t[M+1],D=t[M+2];o[s]=c*I+f*N+v*D+S,o[s+1]=h*I+m*N+w*D+T,o[s+2]=p*I+y*N+b*D+E,s+=a}else for(let C=0;C<l;++C){const M=3*e[C],I=t[M],N=t[M+1],D=t[M+2],z=c*I+f*N+v*D+S,V=h*I+m*N+w*D+T,k=p*I+y*N+b*D+E;for(let Y=0;Y<n;++Y)o[s]=z,o[s+1]=V,o[s+2]=k,s+=a}}function MY(e,t,i,r,s,n=1){if(!i)return void n1e(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],v=o[6],w=o[8],b=o[9],S=o[10],T=!Dq(o),E=1e-6,C=1-E;if(s*=l,n===1)for(let M=0;M<c;++M){const I=3*e[M],N=t[I],D=t[I+1],z=t[I+2];let V=h*N+m*D+w*z,k=p*N+y*D+b*z,Y=f*N+v*D+S*z;if(T){const Z=V*V+k*k+Y*Y;if(Z<C&&Z>E){const le=1/Math.sqrt(Z);V*=le,k*=le,Y*=le}}a[s+0]=V,a[s+1]=k,a[s+2]=Y,s+=l}else for(let M=0;M<c;++M){const I=3*e[M],N=t[I],D=t[I+1],z=t[I+2];let V=h*N+m*D+w*z,k=p*N+y*D+b*z,Y=f*N+v*D+S*z;if(T){const Z=V*V+k*k+Y*Y;if(Z<C&&Z>E){const le=1/Math.sqrt(Z);V*=le,k*=le,Y*=le}}for(let Z=0;Z<n;++Z)a[s+0]=V,a[s+1]=k,a[s+2]=Y,s+=l}}function cZe(e,t,i,r,s,n=1){if(!i)return void T2(e,t,r,s,n);const o=i,a=r.typedBuffer,l=r.typedBufferStride,c=e.length,h=o[0],p=o[1],f=o[2],m=o[4],y=o[5],v=o[6],w=o[8],b=o[9],S=o[10],T=!Dq(o),E=1e-6,C=1-E;if(s*=l,n===1)for(let M=0;M<c;++M){const I=4*e[M],N=t[I],D=t[I+1],z=t[I+2],V=t[I+3];let k=h*N+m*D+w*z,Y=p*N+y*D+b*z,Z=f*N+v*D+S*z;if(T){const le=k*k+Y*Y+Z*Z;if(le<C&&le>E){const ne=1/Math.sqrt(le);k*=ne,Y*=ne,Z*=ne}}a[s+0]=k,a[s+1]=Y,a[s+2]=Z,a[s+3]=V,s+=l}else for(let M=0;M<c;++M){const I=4*e[M],N=t[I],D=t[I+1],z=t[I+2],V=t[I+3];let k=h*N+m*D+w*z,Y=p*N+y*D+b*z,Z=f*N+v*D+S*z;if(T){const le=k*k+Y*Y+Z*Z;if(le<C&&le>E){const ne=1/Math.sqrt(le);k*=ne,Y*=ne,Z*=ne}}for(let le=0;le<n;++le)a[s+0]=k,a[s+1]=Y,a[s+2]=Z,a[s+3]=V,s+=l}}function pF(e,t,i,r,s,n=1){const o=r.typedBuffer,a=r.typedBufferStride,l=e.length;if(s*=a,n===1){if(i===4)for(let c=0;c<l;++c){const h=4*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}else if(i===4)for(let c=0;c<l;++c){const h=4*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=t[h+3],s+=a}else if(i===3)for(let c=0;c<l;++c){const h=3*e[c];for(let p=0;p<n;++p)o[s]=t[h],o[s+1]=t[h+1],o[s+2]=t[h+2],o[s+3]=255,s+=a}}function I5(e,t,i,r,s,n){for(const o of t.fieldNames){const a=e.vertexAttributes.get(o),l=e.indices.get(o);if(a&&l)switch(o){case A.POSITION:{dt(a.size===3);const c=s.getField(o,Vi);c&&P5(l,a.data,i,c,n);break}case A.NORMAL:{dt(a.size===3);const c=s.getField(o,Vi);c&&MY(l,a.data,r,c,n);break}case A.UV0:{dt(a.size===2);const c=s.getField(o,Rh);c&&lZe(l,a.data,c,n);break}case A.COLOR:{dt(a.size===3||a.size===4);const c=s.getField(o,fl);c&&pF(l,a.data,a.size,c,n);break}case A.SYMBOLCOLOR:{dt(a.size===3||a.size===4);const c=s.getField(o,fl);c&&pF(l,a.data,a.size,c,n);break}case A.TANGENT:{dt(a.size===4);const c=s.getField(o,On);c&&cZe(l,a.data,r,c,n);break}}}}function BM(e,t,i=0){const r=$e(e,0,dZe);for(let s=0;s<4;s++)t[i+s]=Math.floor(256*pZe(r*uZe[s]))}function OY(e,t=0){let i=0;for(let r=0;r<4;r++)i+=e[t+r]*hZe[r];return i}const uZe=[1,256,65536,16777216],hZe=[1/256,1/65536,1/16777216,1/4294967296],dZe=OY(new Uint8ClampedArray([255,255,255,255]));function pZe(e){return e-Math.floor(e)}function fZe(){if(R(az)){const e=t=>Mi(`esri/libs/basisu/${t}`);az=import("./basis_transcoder.1e8fae4c.js").then(t=>t.b).then(({default:t})=>t({locateFile:e}).then(i=>(i.initializeBasis(),delete i.then,i)))}return az}let az;var V1;(function(e){e[e.ETC1_RGB=0]="ETC1_RGB",e[e.ETC2_RGBA=1]="ETC2_RGBA",e[e.BC1_RGB=2]="BC1_RGB",e[e.BC3_RGBA=3]="BC3_RGBA",e[e.BC4_R=4]="BC4_R",e[e.BC5_RG=5]="BC5_RG",e[e.BC7_M6_RGB=6]="BC7_M6_RGB",e[e.BC7_M5_RGBA=7]="BC7_M5_RGBA",e[e.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",e[e.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",e[e.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",e[e.ATC_RGB=11]="ATC_RGB",e[e.ATC_RGBA=12]="ATC_RGBA",e[e.FXT1_RGB=17]="FXT1_RGB",e[e.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",e[e.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",e[e.ETC2_EAC_R11=20]="ETC2_EAC_R11",e[e.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",e[e.RGBA32=13]="RGBA32",e[e.RGB565=14]="RGB565",e[e.BGR565=15]="BGR565",e[e.RGBA4444=16]="RGBA4444"})(V1||(V1={}));let Bd=null,oI=null;async function o1e(){return R(oI)&&(oI=fZe(),Bd=await oI),oI}function mZe(e,t){if(R(Bd))return e.byteLength;const i=new Bd.BasisFile(new Uint8Array(e)),r=l1e(i)?a1e(i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),t):0;return i.close(),i.delete(),r}function gZe(e,t){if(R(Bd))return e.byteLength;const i=new Bd.KTX2File(new Uint8Array(e)),r=c1e(i)?a1e(i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),t):0;return i.close(),i.delete(),r}function a1e(e,t,i,r,s){const n=q0e(t?Xr.COMPRESSED_RGBA8_ETC2_EAC:Xr.COMPRESSED_RGB8_ETC2),o=s&&e>1?(4**e-1)/(3*4**(e-1)):1;return Math.ceil(i*r*n*o)}function l1e(e){return e.getNumImages()>=1&&!e.isUASTC()}function c1e(e){return e.getFaces()>=1&&e.isETC1S()}async function yZe(e,t,i){R(Bd)&&(Bd=await o1e());const r=new Bd.BasisFile(new Uint8Array(i));if(!l1e(r))return null;r.startTranscoding();const s=u1e(e,t,r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),(n,o)=>r.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>r.transcodeImage(a,0,n,o,0,0));return r.close(),r.delete(),s}async function vZe(e,t,i){R(Bd)&&(Bd=await o1e());const r=new Bd.KTX2File(new Uint8Array(i));if(!c1e(r))return null;r.startTranscoding();const s=u1e(e,t,r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),(n,o)=>r.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>r.transcodeImage(a,n,0,0,o,0,-1,-1));return r.close(),r.delete(),s}function u1e(e,t,i,r,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=e.capabilities,[h,p]=l?r?[V1.ETC2_RGBA,Xr.COMPRESSED_RGBA8_ETC2_EAC]:[V1.ETC1_RGB,Xr.COMPRESSED_RGB8_ETC2]:c?r?[V1.BC3_RGBA,Xr.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[V1.BC1_RGB,Xr.COMPRESSED_RGB_S3TC_DXT1_EXT]:[V1.RGBA32,ze.RGBA],f=t.hasMipmap?i:Math.min(1,i),m=[];for(let b=0;b<f;b++)m.push(new Uint8Array(o(b,h))),a(b,h,m[b]);const y=m.length>1,v=y?Ke.LINEAR_MIPMAP_LINEAR:Ke.LINEAR,w=ve(F({},t),{samplingMode:v,hasMipmap:y,internalFormat:p,width:s,height:n});return new st(e,w,{type:"compressed",levels:m})}const WE=me.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),_Ze=542327876,bZe=131072,wZe=4;function PY(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}function xZe(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}const TZe=PY("DXT1"),SZe=PY("DXT3"),EZe=PY("DXT5"),CZe=31,AZe=0,RZe=1,MZe=2,OZe=3,PZe=4,IZe=7,$Ze=20,DZe=21;function LZe(e,t,i){const{textureData:r,internalFormat:s,width:n,height:o}=NZe(i,t.hasMipmap);return t.samplingMode=r.levels.length>1?Ke.LINEAR_MIPMAP_LINEAR:Ke.LINEAR,t.hasMipmap=r.levels.length>1,t.internalFormat=s,t.width=n,t.height=o,new st(e,t,r)}function NZe(e,t){const i=new Int32Array(e,0,CZe);if(i[AZe]!==_Ze)return WE.error("Invalid magic number in DDS header"),null;if(!(i[$Ze]&wZe))return WE.error("Unsupported format, must contain a FourCC code"),null;const r=i[DZe];let s,n;switch(r){case TZe:s=8,n=Xr.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case SZe:s=16,n=Xr.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case EZe:s=16,n=Xr.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return WE.error("Unsupported FourCC code:",xZe(r)),null}let o=1,a=i[PZe],l=i[OZe];(3&a)==0&&(3&l)==0||(WE.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;i[MZe]&bZe&&t!==!1&&(o=Math.max(1,i[IZe])),o===1||xS(a)&&xS(l)||(WE.warn("Ignoring mipmaps of non power of two sized compressed texture."),o=1);let m=i[RZe]+4;const y=[];for(let v=0;v<o;++v)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(e,m,f),y.push(p),m+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:y},internalFormat:n,width:c,height:h}}class Cs extends jO{constructor(t,i){super(),this.data=t,this.type=Kd.Texture,this._glTexture=null,this._powerOfTwoStretchInfo=null,this._loadingPromise=null,this._loadingController=null,this.events=new us,this.params=i||{},this.params.mipmap=this.params.mipmap!==!1,this.params.noUnpackFlip=this.params.noUnpackFlip||!1,this.params.preMultiplyAlpha=this.params.preMultiplyAlpha||!1,this.params.wrap=this.params.wrap||{s:_t.REPEAT,t:_t.REPEAT},this.params.powerOfTwoResizeMode=this.params.powerOfTwoResizeMode||sv.STRETCH,this.estimatedTexMemRequired=Cs._estimateTexMemRequired(this.data,this.params),this._startPreload()}_startPreload(){const t=this.data;R(t)||(t instanceof HTMLVideoElement?this._startPreloadVideoElement(t):t instanceof HTMLImageElement&&this._startPreloadImageElement(t))}_startPreloadVideoElement(t){if(!(FS(t.src)||t.preload==="auto"&&t.crossOrigin)){t.preload="auto",t.crossOrigin="anonymous";const i=!t.paused;if(t.src=t.src,i&&t.autoplay){const r=()=>{t.removeEventListener("canplay",r),t.play()};t.addEventListener("canplay",r)}}}_startPreloadImageElement(t){Lf(t.src)||FS(t.src)||t.crossOrigin||(t.crossOrigin="anonymous",t.src=t.src)}static _getDataDimensions(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}static _estimateTexMemRequired(t,i){if(R(t))return 0;if(pE(t)||C1(t))return i.encoding===Cs.KTX2_ENCODING?gZe(t,i.mipmap):i.encoding===Cs.BASIS_ENCODING?mZe(t,i.mipmap):t.byteLength;const{width:r,height:s}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?Cs._getDataDimensions(t):i;return(i.mipmap?4/3:1)*r*s*(i.components||4)||0}dispose(){this.data=void 0}get width(){return this.params.width}get height(){return this.params.height}_createDescriptor(t){var i;return{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:this.params.wrap,flipped:!this.params.noUnpackFlip,samplingMode:this.params.mipmap?Ke.LINEAR_MIPMAP_LINEAR:Ke.LINEAR,hasMipmap:this.params.mipmap,preMultiplyAlpha:this.params.preMultiplyAlpha,maxAnisotropy:(i=this.params.maxAnisotropy)!=null?i:this.params.mipmap?t.parameters.maxMaxAnisotropy:1}}get glTexture(){return this._glTexture}load(t,i){if(_(this._glTexture))return this._glTexture;if(_(this._loadingPromise))return this._loadingPromise;const r=this.data;return R(r)?(this._glTexture=new st(t,this._createDescriptor(t),null),this._glTexture):typeof r=="string"?this._loadFromURL(t,i,r):r instanceof Image?this._loadFromImageElement(t,i,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(t,i,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(t,r,i):(pE(r)||C1(r))&&this.params.encoding===Cs.DDS_ENCODING?(this.data=void 0,this._loadFromDDSData(t,r)):(pE(r)||C1(r))&&this.params.encoding===Cs.KTX2_ENCODING?(this.data=void 0,this._loadFromKTX2(t,r)):(pE(r)||C1(r))&&this.params.encoding===Cs.BASIS_ENCODING?(this.data=void 0,this._loadFromBasis(t,r)):C1(r)?this._loadFromPixelData(t,r):pE(r)?this._loadFromPixelData(t,new Uint8Array(r)):null}get requiresFrameUpdates(){return this.data instanceof HTMLVideoElement}frameUpdate(t,i,r){if(!(this.data instanceof HTMLVideoElement)||R(this._glTexture)||this.data.readyState<xR.HAVE_CURRENT_DATA||r===this.data.currentTime)return r;if(_(this._powerOfTwoStretchInfo)){const{framebuffer:s,vao:n,sourceTexture:o}=this._powerOfTwoStretchInfo;o.setData(this.data),this._drawStretchedTexture(t,i,s,n,o,this._glTexture)}else{const{videoWidth:s,videoHeight:n}=this.data,{width:o,height:a}=this._glTexture.descriptor;s!==o||n!==a?this._glTexture.updateData(0,0,0,Math.min(s,o),Math.min(n,a),this.data):this._glTexture.setData(this.data)}return this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.params.updateCallback&&this.params.updateCallback(),this.data.currentTime}_loadFromDDSData(t,i){return this._glTexture=LZe(t,this._createDescriptor(t),i),this._glTexture}_loadFromKTX2(t,i){return this._loadAsync(()=>vZe(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromBasis(t,i){return this._loadAsync(()=>yZe(t,this._createDescriptor(t),i).then(r=>(this._glTexture=r,r)))}_loadFromPixelData(t,i){dt(this.params.width>0&&this.params.height>0);const r=this._createDescriptor(t);return r.pixelFormat=this.params.components===1?ze.LUMINANCE:this.params.components===3?ze.RGB:ze.RGBA,r.width=this.params.width,r.height=this.params.height,this._glTexture=new st(t,r,i),this._glTexture}_loadFromURL(t,i,r){return this._loadAsync(async s=>{const n=await Qd(r,{signal:s});return li(s),this._loadFromImage(t,n,i)})}_loadFromImageElement(t,i,r){return r.complete?this._loadFromImage(t,r,i):this._loadAsync(async s=>{const n=await Ahe(r,r.src,!1,s);return li(s),this._loadFromImage(t,n,i)})}_loadFromVideoElement(t,i,r){return r.readyState>=xR.HAVE_CURRENT_DATA?this._loadFromImage(t,r,i):this._loadFromVideoElementAsync(t,i,r)}_loadFromVideoElementAsync(t,i,r){return this._loadAsync(s=>new Promise((n,o)=>{const a=()=>{r.removeEventListener("loadeddata",l),r.removeEventListener("error",c),Ds(h)},l=()=>{r.readyState>=xR.HAVE_CURRENT_DATA&&(a(),n(this._loadFromImage(t,r,i)))},c=p=>{a(),o(p||new q("Failed to load video"))};r.addEventListener("loadeddata",l),r.addEventListener("error",c);const h=Wo(s,()=>c(ui()))}))}_loadFromImage(t,i,r){const s=Cs._getDataDimensions(i);this.params.width=s.width,this.params.height=s.height;const n=this._createDescriptor(t);return n.pixelFormat=this.params.components===3?ze.RGB:ze.RGBA,!this._requiresPowerOfTwo(t,n)||xS(s.width)&&xS(s.height)?(n.width=s.width,n.height=s.height,this._glTexture=new st(t,n,i),this._glTexture):(this._glTexture=this._makePowerOfTwoTexture(t,i,s,n,r),this._glTexture)}_loadAsync(t){const i=new AbortController;this._loadingController=i;const r=t(i.signal);this._loadingPromise=r;const s=()=>{this._loadingController===i&&(this._loadingController=null),this._loadingPromise===r&&(this._loadingPromise=null)};return r.then(s,s),r}_requiresPowerOfTwo(t,i){const r=_t.CLAMP_TO_EDGE,s=typeof i.wrapMode=="number"?i.wrapMode===r:i.wrapMode.s===r&&i.wrapMode.t===r;return!Cn(t.gl)&&(i.hasMipmap||!s)}_makePowerOfTwoTexture(t,i,r,s,n){const{width:o,height:a}=r,l=wS(o),c=wS(a);let h;switch(s.width=l,s.height=c,this.params.powerOfTwoResizeMode){case sv.PAD:s.textureCoordinateScaleFactor=[o/l,a/c],h=new st(t,s),h.updateData(0,0,0,o,a,i);break;case sv.STRETCH:case null:case void 0:h=this._stretchToPowerOfTwo(t,i,s,n());break;default:this.params.powerOfTwoResizeMode}return s.hasMipmap&&h.generateMipmap(),h}_stretchToPowerOfTwo(t,i,r,s){const n=new st(t,r),o=new xr(t,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},n),a=new st(t,{target:pt.TEXTURE_2D,pixelFormat:r.pixelFormat,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!!r.flipped,maxAnisotropy:8,preMultiplyAlpha:r.preMultiplyAlpha},i),l=Ma(t),c=t.getBoundFramebufferObject();return this._drawStretchedTexture(t,s,o,l,a,n),this.requiresFrameUpdates?this._powerOfTwoStretchInfo={vao:l,sourceTexture:a,framebuffer:o}:(l.dispose(!0),a.dispose(),o.detachColorTexture(),o.dispose()),t.bindFramebuffer(c),n}_drawStretchedTexture(t,i,r,s,n,o){t.bindFramebuffer(r);const a=t.getViewport();t.setViewport(0,0,o.descriptor.width,o.descriptor.height);const l=t.bindTechnique(i);l.setUniform4f("uColor",1,1,1,1),l.bindTexture("tex",n),t.bindVAO(s),t.drawArrays(Pt.TRIANGLE_STRIP,0,xo(s,"geometry")),t.bindFramebuffer(null),t.setViewport(a.x,a.y,a.width,a.height)}unload(){if(_(this._powerOfTwoStretchInfo)){const{framebuffer:t,vao:i,sourceTexture:r}=this._powerOfTwoStretchInfo;i.dispose(!0),r.dispose(),t.dispose(),this._glTexture=null,this._powerOfTwoStretchInfo=null}if(_(this._glTexture)&&(this._glTexture.dispose(),this._glTexture=null),_(this._loadingController)){const t=this._loadingController;this._loadingController=null,this._loadingPromise=null,t.abort()}this.events.emit("unloaded")}}var xR;Cs.DDS_ENCODING="image/vnd-ms.dds",Cs.KTX2_ENCODING="image/ktx2",Cs.BASIS_ENCODING="image/x.basis",function(e){e[e.HAVE_NOTHING=0]="HAVE_NOTHING",e[e.HAVE_METADATA=1]="HAVE_METADATA",e[e.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",e[e.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",e[e.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"}(xR||(xR={}));const GM=128,IY=.5;function h1e(e,t=GM,i=t*IY,r=0){const s=FZe(e,t,i,r);return new Cs(s,{mipmap:!1,wrap:{s:_t.CLAMP_TO_EDGE,t:_t.CLAMP_TO_EDGE},width:t,height:t,components:4,noUnpackFlip:!0})}function FZe(e,t=GM,i=t*IY,r=0){switch(e){case"circle":default:return UZe(t,i);case"square":return kZe(t,i);case"cross":return VZe(t,i,r);case"x":return BZe(t,i,r);case"kite":return zZe(t,i);case"triangle":return GZe(t,i);case"arrow":return jZe(t,i)}}function UZe(e,t){const i=e/2-.5;return YO(e,f1e(i,i,t/2))}function kZe(e,t){return d1e(e,t,!1)}function zZe(e,t){return d1e(e,t,!0)}function VZe(e,t,i=0){return p1e(e,t,!1,i)}function BZe(e,t,i=0){return p1e(e,t,!0,i)}function GZe(e,t){return YO(e,m1e(e/2,t,t/2))}function jZe(e,t){const i=t,r=t/2,s=e/2,n=.8*i,o=f1e(s,(e-t)/2-n,Math.sqrt(n*n+r*r)),a=m1e(s,i,r);return YO(e,(l,c)=>Math.max(a(l,c),-o(l,c)))}function d1e(e,t,i){return i&&(t/=Math.SQRT2),YO(e,(r,s)=>{let n=r-.5*e+.25,o=.5*e-s-.75;if(i){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*t})}function p1e(e,t,i,r=0){t-=r,i&&(t*=Math.SQRT2);const s=.5*t;return YO(e,(n,o)=>{let a,l=n-.5*e,c=.5*e-o-1;if(i){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=r/2,a})}function f1e(e,t,i){return(r,s)=>{const n=r-e,o=s-t;return Math.sqrt(n*n+o*o)-i}}function m1e(e,t,i){const r=Math.sqrt(t*t+i*i);return(s,n)=>{const o=Math.abs(s-e)-i,a=n-e+t/2+.75,l=(t*o+i*a)/r,c=-a;return Math.max(l,c)}}function YO(e,t){const i=new Uint8Array(4*e*e);for(let r=0;r<e;r++)for(let s=0;s<e;s++){const n=s+e*r;let o=t(s,r);o=o/e+.5,BM(o,i,4*n)}return i}class W_t extends Us{constructor(t){super(),this.slicePlaneLocalOrigin=t}}function HZe(e,t){g1e(e,t,[new xt("slicePlaneOrigin",(i,r)=>b1e(t,i,r)),new xt("slicePlaneBasis1",(i,r)=>{var s;return fF(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new xt("slicePlaneBasis2",(i,r)=>{var s;return fF(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)})])}function ls(e,t){g1e(e,t,[new Sa("slicePlaneOrigin",(i,r)=>b1e(t,i,r)),new Sa("slicePlaneBasis1",(i,r)=>{var s;return fF(t,i,r,(s=r.slicePlane)==null?void 0:s.basis1)}),new Sa("slicePlaneBasis2",(i,r)=>{var s;return fF(t,i,r,(s=r.slicePlane)==null?void 0:s.basis2)})])}function g1e(e,t,i){if(!t.hasSlicePlane){const o=x`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return t.hasSliceInVertexProgram&&e.vertex.code.add(o),void e.fragment.code.add(o)}e.extensions.add("GL_OES_standard_derivatives"),t.hasSliceInVertexProgram&&e.vertex.uniforms.add(i),e.fragment.uniforms.add(i);const r=x`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,s=x`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,n=t.hasSliceHighlight?x`
        ${s}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:x`#define highlightSlice(_color_, _pos_) (_color_)`;t.hasSliceInVertexProgram&&e.vertex.code.add(r),e.fragment.code.add(r),e.fragment.code.add(n)}function y1e(e,t,i){return e.instancedDoublePrecision?ie(qZe,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]):t.slicePlaneLocalOrigin}function v1e(e,t){return _(e)?pe(mF,t.origin,e):t.origin}function _1e(e,t,i){return e.hasSliceTranslatedView?_(t)?Aa(WZe,i.camera.viewMatrix,t):i.camera.viewMatrix:null}function b1e(e,t,i){if(R(i.slicePlane))return Ta;const r=y1e(e,t,i),s=v1e(r,i.slicePlane),n=_1e(e,r,i);return _(n)?Ue(mF,s,n):s}function fF(e,t,i,r){if(R(r)||R(i.slicePlane))return Ta;const s=y1e(e,t,i),n=v1e(s,i.slicePlane),o=_1e(e,s,i);return _(o)?(de(XE,r,n),Ue(mF,n,o),Ue(XE,XE,o),pe(XE,XE,mF)):r}const qZe=O(),mF=O(),XE=O(),WZe=Ae();function XZe(e,t){const{vertex:i,fragment:r}=e;t.hasMultipassGeometry&&i.include(_ve),t.hasMultipassTerrain&&e.varyings.add("depth","float"),i.code.add(x`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${t.hasMultipassGeometry?x`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${t.hasMultipassTerrain?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),t.hasMultipassTerrain&&r.include(gu),t.hasMultipassTerrain&&r.uniforms.add([new zt("terrainDepthTexture",(s,n)=>n.multipassTerrain.linearDepthTexture),new di("nearFar",(s,n)=>n.camera.nearFar),new di("inverseViewport",(s,n)=>n.inverseViewport)]),r.include(uc),r.code.add(x`
  void main() {
    gl_FragColor = vec4(1, 1, 1, 1);
    ${t.hasMultipassTerrain?x`
          vec2 uv = gl_FragCoord.xy * inverseViewport;

          //Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texture2D(terrainDepthTexture, uv);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          //If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          //Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            gl_FragColor.g = 0.5;
          }`:""}
  }
  `)}const YZe=fi(1,1,0,1),w1e=fi(1,0,1,1);function Bg(e){e.fragment.uniforms.add(new zt("depthTex",(t,i)=>i.highlightDepthTexture)),e.fragment.uniforms.add(new di("highlightViewportPixelSz",(t,i)=>i.inverseViewport)),e.fragment.constants.add("occludedHighlightFlag","vec4",YZe).add("unoccludedHighlightFlag","vec4",w1e),e.fragment.code.add(x`void outputHighlight() {
vec4 fragCoord = gl_FragCoord;
float sceneDepth = texture2D(depthTex, fragCoord.xy * highlightViewportPixelSz.xy).r;
if (fragCoord.z > sceneDepth + 5e-7) {
gl_FragColor = occludedHighlightFlag;
}
else {
gl_FragColor = unoccludedHighlightFlag;
}
}`)}class $5 extends jr{constructor(t,i,r){super(t,"vec4",$i.Pass,(s,n,o)=>s.setUniform4fv(t,i(n,o)),r)}}class jo extends jr{constructor(t,i,r){super(t,"float",$i.Pass,(s,n,o)=>s.setUniform1fv(t,i(n,o)),r)}}class ZO extends jr{constructor(t,i){super(t,"mat3",$i.Pass,(r,s,n)=>r.setUniformMatrix3fv(t,i(s,n)))}}class $Y extends uE{constructor(){super(...arguments),this.vvSizeEnabled=!1,this.vvSizeMinSize=Fe(1,1,1),this.vvSizeMaxSize=Fe(100,100,100),this.vvSizeOffset=Fe(0,0,0),this.vvSizeFactor=Fe(1,1,1),this.vvSizeValue=Fe(1,1,1),this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvOpacityEnabled=!1,this.vvOpacityValues=[0,0,0,0,0,0,0,0],this.vvOpacityOpacities=[1,1,1,1,1,1,1,1],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=Sr()}}const Gd=8;function uS(e,t){t.hasVvInstancing&&(t.vvSize||t.vvColor)&&e.attributes.add(A.INSTANCEFEATUREATTRIBUTE,"vec4");const i=e.vertex;t.vvSize?(i.uniforms.add(new xt("vvSizeMinSize",r=>r.vvSizeMinSize)),i.uniforms.add(new xt("vvSizeMaxSize",r=>r.vvSizeMaxSize)),i.uniforms.add(new xt("vvSizeOffset",r=>r.vvSizeOffset)),i.uniforms.add(new xt("vvSizeFactor",r=>r.vvSizeFactor)),i.uniforms.add(new ZO("vvSymbolRotationMatrix",r=>r.vvSymbolRotationMatrix)),i.uniforms.add(new xt("vvSymbolAnchor",r=>r.vvSymbolAnchor)),i.code.add(x`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),i.code.add(x`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${t.hasVvInstancing?x`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):i.code.add(x`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),t.vvColor?(i.constants.add("vvColorNumber","int",Gd),t.hasVvInstancing&&i.uniforms.add([new jo("vvColorValues",r=>r.vvColorValues,Gd),new $5("vvColorColors",r=>r.vvColorColors,Gd)]),i.code.add(x`
      vec4 vvGetColor(vec4 featureAttribute, float values[vvColorNumber], vec4 colors[vvColorNumber]) {
        float value = featureAttribute.y;
        if (value <= values[0]) {
          return colors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (values[i] >= value) {
            float f = (value - values[i-1]) / (values[i] - values[i-1]);
            return mix(colors[i-1], colors[i], f);
          }
        }
        return colors[vvColorNumber - 1];
      }

      ${t.hasVvInstancing?x`
      vec4 vvColor() {
        return vvGetColor(instanceFeatureAttribute, vvColorValues, vvColorColors);
      }`:""}
    `)):i.code.add(x`vec4 vvColor() { return vec4(1.0); }`)}const gF=.1,Eo=.001;function ZZe(e){const t=new Bi,i=e.signedDistanceFieldEnabled;if(t.include(eY),t.include(J_e,e),t.include(ls,e),e.output===J.Occlusion)return t.include(XZe,e),t;const{vertex:r,fragment:s}=t;t.include(EY),s.include(uc),s.include(Vf),t.include(uS,e),t.varyings.add("vcolor","vec4"),t.varyings.add("vtc","vec2"),t.varyings.add("vsize","vec2"),e.binaryHighlightOcclusionEnabled&&t.varyings.add("voccluded","float"),r.uniforms.add([new ei("viewport",(c,h)=>h.camera.fullViewport),new di("screenOffset",(c,h)=>hi(x1e,2*c.screenOffset[0]*h.camera.pixelRatio,2*c.screenOffset[1]*h.camera.pixelRatio)),new di("anchorPosition",c=>yF(c)),new ei("materialColor",c=>c.color),new We("pixelRatio",(c,h)=>h.camera.pixelRatio)]),i&&(r.uniforms.add(new ei("outlineColor",c=>c.outlineColor)),s.uniforms.add([new ei("outlineColor",c=>Fre(c)?c.outlineColor:hf),new We("outlineSize",c=>Fre(c)?c.outlineSize:0)])),e.hasScreenSizePerspective&&(KYe(r),M5(r)),(e.debugDrawLabelBorder||e.binaryHighlightOcclusionEnabled)&&t.varyings.add("debugBorderCoords","vec4"),t.attributes.add(A.UV0,"vec2"),t.attributes.add(A.COLOR,"vec4"),t.attributes.add(A.SIZE,"vec2"),t.attributes.add(A.AUXPOS2,"vec4"),r.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${e.hasScreenSizePerspective?x`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:x`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${e.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${e.occlusionTestEnabled||e.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${e.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const n=x`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`,o=e.pixelSnappingEnabled?i?x`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:x`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:x`posProj += quadOffset;`;e.vvColor&&r.uniforms.add([new $5("vvColorColors",c=>c.vvColorColors,Gd),new jo("vvColorValues",c=>c.vvColorValues,Gd)]),r.uniforms.add(new di("textureCoordinateScaleFactor",c=>_(c.texture)&&_(c.texture.descriptor.textureCoordinateScaleFactor)?c.texture.descriptor.textureCoordinateScaleFactor:tpe)),r.code.add(x`
    ${e.occlusionTestEnabled?"if (visible) {":""}
    ${n}
    ${e.vvColor?"vcolor = vvGetColor(auxpos2, vvColorValues, vvColorColors) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    bool alphaDiscard = vcolor.a < ${x.float(Eo)};
    ${i?`alphaDiscard = alphaDiscard && outlineColor.a < ${x.float(Eo)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${o}
      gl_Position = posProj;
    }

    vtc = uv * textureCoordinateScaleFactor;

    ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${e.occlusionTestEnabled?x`} else { vtc = vec2(0.0);
      ${e.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),s.uniforms.add(new zt("tex",c=>c.texture));const a=e.debugDrawLabelBorder?x`(isBorder > 0.0 ? 0.0 : ${x.float(gF)})`:x.float(gF),l=x`
    ${e.debugDrawLabelBorder?x`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${i?x`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${x.float(GM)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture2D(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${x.float(Eo)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        gl_FragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        gl_FragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // gl_FragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:x`
          vec4 texColor = texture2D(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          gl_FragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${e.debugDrawLabelBorder?x`gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return e.output===J.Alpha&&s.code.add(x`
      void main() {
        ${l}
        gl_FragColor = vec4(gl_FragColor.a);
      }
      `),e.output===J.Color&&s.code.add(x`
    void main() {
      ${l}
      ${e.transparencyPassType===gt.FrontFace?"gl_FragColor.rgb /= gl_FragColor.a;":""}
    }
    `),e.output===J.Highlight&&(t.include(Bg),s.code.add(x`
    void main() {
      ${l}
      ${e.binaryHighlightOcclusionEnabled?x`
          if (voccluded == 1.0) {
            gl_FragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            gl_FragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),t}function Fre(e){return e.outlineColor[3]>0&&e.outlineSize>0}function yF(e,t=x1e){return e.textureIsSignedDistanceField?QZe(e.anchorPosition,e.distanceFieldBoundingBox,t):ro(t,e.anchorPosition),t}function QZe(e,t,i){_(t)?hi(i,e[0]*(t[2]-t[0])+t[0],e[1]*(t[3]-t[1])+t[1]):hi(i,0,0)}const x1e=tt(),JZe=Object.freeze(Object.defineProperty({__proto__:null,build:ZZe,calculateAnchorPosForRendering:yF},Symbol.toStringTag,{value:"Module"})),au=so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),KZe=zf(Re.ONE,Re.ONE),T1e=zf(Re.ZERO,Re.ONE_MINUS_SRC_ALPHA);function Gg(e){return e===gt.FrontFace?null:e===gt.Alpha?T1e:KZe}function D5(e){return e===gt.FrontFace?pl:null}const L5=5e5,N5={factor:-1,units:-2};function F5(e){return e?N5:null}function Vv(e,t=hr.LESS){return e===gt.NONE||e===gt.FrontFace?t:hr.LEQUAL}class QO extends lr{initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global}initializeProgram(t){const i=QO.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}_setPipelineState(t){const i=this.configuration,r=t===gt.NONE,s=t===gt.FrontFace,n=this.configuration.hasPolygonOffset&&eQe,o=(r||s)&&i.output!==J.Highlight?(i.depthEnabled||i.output===J.Occlusion)&&pl:null;return Ut({blending:i.output===J.Color||i.output===J.Alpha||i.output===J.Highlight?r?tQe:Gg(t):null,depthTest:{func:hr.LEQUAL},depthWrite:o,colorWrite:Jt,polygonOffset:n})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.output===J.Occlusion?Pt.POINTS:Pt.TRIANGLES}}QO.shader=new Qi(JZe,()=>import("./HUDMaterial.glsl.c10941c9.js"));const eQe={factor:0,units:-4},tQe=zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA);class Ho extends Ra{}u([G({constValue:!0})],Ho.prototype,"hasSliceHighlight",void 0),u([G({constValue:!1})],Ho.prototype,"hasSliceInVertexProgram",void 0),u([G({constValue:!1})],Ho.prototype,"instancedDoublePrecision",void 0),u([G({constValue:!1})],Ho.prototype,"isGround",void 0),u([G({constValue:$i.Pass})],Ho.prototype,"pbrTextureBindType",void 0);class xs extends Ho{constructor(){super(...arguments),this.output=J.Color,this.screenCenterOffsetUnitsEnabled=el.World,this.transparencyPassType=gt.NONE,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusionEnabled=!0,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.isDraped=!1,this.hasMultipassGeometry=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}u([G({count:J.COUNT})],xs.prototype,"output",void 0),u([G({count:el.COUNT})],xs.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([G({count:gt.COUNT})],xs.prototype,"transparencyPassType",void 0),u([G()],xs.prototype,"spherical",void 0),u([G()],xs.prototype,"occlusionTestEnabled",void 0),u([G()],xs.prototype,"signedDistanceFieldEnabled",void 0),u([G()],xs.prototype,"vvSize",void 0),u([G()],xs.prototype,"vvColor",void 0),u([G()],xs.prototype,"hasVerticalOffset",void 0),u([G()],xs.prototype,"hasScreenSizePerspective",void 0),u([G()],xs.prototype,"debugDrawLabelBorder",void 0),u([G()],xs.prototype,"binaryHighlightOcclusionEnabled",void 0),u([G()],xs.prototype,"hasSlicePlane",void 0),u([G()],xs.prototype,"hasPolygonOffset",void 0),u([G()],xs.prototype,"depthEnabled",void 0),u([G()],xs.prototype,"pixelSnappingEnabled",void 0),u([G()],xs.prototype,"isDraped",void 0),u([G()],xs.prototype,"hasMultipassGeometry",void 0),u([G()],xs.prototype,"hasMultipassTerrain",void 0),u([G()],xs.prototype,"cullAboveGround",void 0),u([G({constValue:!0})],xs.prototype,"hasSliceInVertexProgram",void 0),u([G({constValue:!1})],xs.prototype,"hasVvInstancing",void 0);class S2 extends Gf{constructor(t){super(t,new hQe),this.techniqueConfig=new xs}getConfiguration(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasVerticalOffset=!!this.parameters.verticalOffset,this.techniqueConfig.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?el.Screen:el.World,this.techniqueConfig.hasPolygonOffset=this.parameters.polygonOffset,this.techniqueConfig.isDraped=this.parameters.isDraped,this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this.techniqueConfig.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this.techniqueConfig.vvSize=!!this.parameters.vvSizeEnabled,this.techniqueConfig.vvColor=!!this.parameters.vvColorEnabled,t===J.Color&&(this.techniqueConfig.debugDrawLabelBorder=!!this.parameters.debugDrawLabelBorder),t===J.Highlight&&(this.techniqueConfig.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this.techniqueConfig.depthEnabled=this.parameters.depthEnabled,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.hasMultipassGeometry=i.multipassGeometry.enabled,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedHudGeometry(t,o,a,l,c):this._intersectHudGeometry(t,i,r,s,a,l)}_intersectDrapedHudGeometry(t,i,r,s,n){const o=t.vertexAttributes.get(A.POSITION),a=t.vertexAttributes.get(A.SIZE),l=this.parameters,c=yF(l);let h=1,p=1;if(_(s)){const m=s(zre);h=m[0],p=m[5]}h*=t.screenToWorldRatio,p*=t.screenToWorldRatio;const f=cQe*t.screenToWorldRatio;for(let m=0;m<o.data.length/o.size;m++){const y=m*o.size,v=o.data[y],w=o.data[y+1],b=m*a.size;let S;oy[0]=a.data[b]*h,oy[1]=a.data[b+1]*p,l.textureIsSignedDistanceField&&(S=l.outlineSize*t.screenToWorldRatio/2),Ure(i,v,w,oy,f,S,l,c)&&r(n.dist,n.normal,-1,!1)}}_intersectHudGeometry(t,i,r,s,n,o){if(!s.options.selectionMode||!s.options.hud||HO(i))return;const a=this.parameters;let l=1,c=1;if(Ch(cz,r),_(o)){const S=o(zre);l=S[0],c=S[5],sQe(cz)}const h=t.vertexAttributes.get(A.POSITION),p=t.vertexAttributes.get(A.SIZE),f=t.vertexAttributes.get(A.NORMAL),m=t.vertexAttributes.get(A.AUXPOS1);dt(h.size>=3);const y=s.point,v=s.camera,w=yF(a);l*=v.pixelRatio,c*=v.pixelRatio;const b=this.parameters.centerOffsetUnits==="screen";for(let S=0;S<h.data.length/h.size;S++){const T=S*h.size;ie($o,h.data[T],h.data[T+1],h.data[T+2]),Ue($o,$o,r);const E=S*p.size;oy[0]=p.data[E]*l,oy[1]=p.data[E+1]*c,Ue($o,$o,v.viewMatrix);const C=S*m.size;if(ie(gc,m.data[C+0],m.data[C+1],m.data[C+2]),!b&&($o[0]+=gc[0],$o[1]+=gc[1],gc[2]!==0)){const I=gc[2];we(gc,$o),pe($o,$o,oe(gc,gc,I))}const M=S*f.size;if(ie(YE,f.data[M],f.data[M+1],f.data[M+2]),this._normalAndViewAngle(YE,cz,v,uz),this._applyVerticalOffsetTransformationView($o,uz,v,lz),v.applyProjection($o,ea),ea[0]>-1){ea[0]=Math.floor(ea[0]),ea[1]=Math.floor(ea[1]),b&&(gc[0]||gc[1])&&(ea[0]+=gc[0],gc[1]!==0&&(ea[1]+=SY(gc[1],lz.factorAlignment)),v.unapplyProjection(ea,$o)),ea[0]+=this.parameters.screenOffset[0],ea[1]+=this.parameters.screenOffset[1],q_e(oy,lz.factor,oy);const I=lQe*v.pixelRatio;let N;if(a.textureIsSignedDistanceField&&(N=a.outlineSize*v.pixelRatio/2),Ure(y,ea[0],ea[1],oy,I,N,a,w)){const D=s.ray;if(Ue(kre,$o,cs(aQe,v.viewMatrix)),ea[0]=y[0],ea[1]=y[1],v.unprojectFromRenderScreen(ea,$o)){const z=O();se(z,D.direction);const V=1/Me(z);oe(z,z,V),n(nr(D.origin,$o)*V,z,-1,!0,1,kre)}}}}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(A.POSITION),n=t.indices.get(A.POSITION);return Ove(s,n,i)}createBufferWriter(){return new pQe(this)}_normalAndViewAngle(t,i,r,s){return JYe(i)&&(i=Ch(oQe,i)),ql(s.normal,t,i),Ue(s.normal,s.normal,r.viewInverseTransposeMatrix),s.cosAngle=xe(E1e,uQe),s}_updateScaleInfo(t,i,r){const s=this.parameters;_(s.screenSizePerspective)?Ire(r,i,s.screenSizePerspective,t.factor):(t.factor.scale=1,t.factor.factor=0,t.factor.minPixelSize=0,t.factor.paddingPixels=0),_(s.screenSizePerspectiveAlignment)?Ire(r,i,s.screenSizePerspectiveAlignment,t.factorAlignment):(t.factorAlignment.factor=t.factor.factor,t.factorAlignment.scale=t.factor.scale,t.factorAlignment.minPixelSize=t.factor.minPixelSize,t.factorAlignment.paddingPixels=t.factor.paddingPixels)}applyShaderOffsetsView(t,i,r,s,n,o,a){const l=this._normalAndViewAngle(i,r,n,uz);return this._applyVerticalGroundOffsetView(t,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(t,i,r,s,n){return this._applyCenterOffsetNDC(t,i,r,s),_(n)&&se(n,s),this._applyPolygonOffsetNDC(s,i,r,s),s}_applyPolygonOffsetView(t,i,r,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(r);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return se(n,t);const c=$e(Math.abs(i.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return oe(n,t,l>0?h:1/h),n}_applyVerticalGroundOffsetView(t,i,r,s){const n=Me(t),o=r.aboveGround?1:-1,a=.5*r.computeRenderPixelSizeAtDist(n),l=oe($o,i.normal,o*a);return de(s,t,l),s}_applyVerticalOffsetTransformationView(t,i,r,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Me(t);this._updateScaleInfo(s,c,i.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return t}const o=Me(t),a=yt(n.screenSizePerspectiveAlignment,n.screenSizePerspective),l=i1e(r,o,n.verticalOffset,i.cosAngle,a);return this._updateScaleInfo(s,o,i.cosAngle),oe(i.normal,i.normal,l),de(t,t,i.normal)}_applyCenterOffsetView(t,i,r){const s=this.parameters.centerOffsetUnits!=="screen";return r!==t&&se(r,t),s&&(r[0]+=i[0],r[1]+=i[1],i[2]&&(we(YE,r),de(r,r,oe(YE,YE,i[2])))),r}_applyCenterOffsetNDC(t,i,r,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==t&&se(s,t),n||(s[0]+=i[0]/r.fullWidth*2,s[1]+=i[1]/r.fullHeight*2),s}_applyPolygonOffsetNDC(t,i,r,s){const n=this.parameters.shaderPolygonOffset;if(t!==s&&se(s,t),n){const o=r.aboveGround?1:-1,a=o*Math.sign(i[3]);s[2]-=(a||o)*n}return s}requiresSlot(t){if(t===Se.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:r}=this.parameters;return t===(i?Se.LABEL_MATERIAL:Se.HUD_MATERIAL)||r&&t===Se.OCCLUSION_PIXELS}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha?new iQe(t):t.output===J.Highlight?new S1e(t):null}calculateRelativeScreenBounds(t,i,r=Dt()){return rQe(this.parameters,t,i,r),r[2]=r[0]+t[0],r[3]=r[1]+t[1],r}}class S1e extends UX{constructor(t){super(F(F({},t),t.material.parameters))}selectProgram(t){return this.ensureTechnique(QO,t)}beginSlot(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(t)}}class iQe extends S1e{_isOcclusionSlot(t){return t.slot===Se.OCCLUSION_PIXELS&&this._material.parameters.occlusionTest&&(this._output===J.Color||this._output===J.Alpha)}selectProgram(t){return this.ensureTechnique(QO,t,this._isOcclusionSlot(t)?J.Occlusion:this._output)}}function rQe(e,t,i,r=nQe){return ro(r,e.anchorPosition),r[0]*=-t[0],r[1]*=-t[1],r[0]+=e.screenOffset[0]*i,r[1]+=e.screenOffset[1]*i,r}function sQe(e){const t=e[0],i=e[1],r=e[2],s=e[3],n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=1/Math.sqrt(t*t+i*i+r*r),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return e[0]=t*h,e[1]=i*h,e[2]=r*h,e[3]=s*p,e[4]=n*p,e[5]=o*p,e[6]=a*f,e[7]=l*f,e[8]=c*f,e}function Ure(e,t,i,r,s,n,o,a){let l=t-s-(a[0]>0?r[0]*a[0]:0),c=l+r[0]+2*s,h=i-s-(a[1]>0?r[1]*a[1]:0),p=h+r[1]+2*s;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&_(f)&&(l+=r[0]*f[0],h+=r[1]*f[1],c-=r[0]*(1-f[2]),p-=r[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n),e[0]>l&&e[0]<c&&e[1]>h&&e[1]<p}const lz={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}},nQe=tt(),$o=O(),YE=O(),ea=Gt(),E1e=O(),kre=O(),cz=Sr(),oQe=Sr(),aQe=Ae(),gc=O(),uz={normal:E1e,cosAngle:0},zre=Ae(),lQe=1,cQe=2,oy=[0,0],uQe=Fe(0,0,1);class hQe extends ave{constructor(){super(...arguments),this.renderOccluded=Mr.Occlude,this.color=[1,1,1,1],this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=Oi(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.outlineColor=[1,1,1,1],this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.binaryHighlightOcclusion=!0,this.debugDrawLabelBorder=!1,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}}const dQe=Kr().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4u8(A.COLOR).vec2f(A.SIZE).vec4f(A.AUXPOS1).vec4f(A.AUXPOS2);class pQe{constructor(t){this.material=t,this.vertexBufferLayout=dQe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(A.POSITION).length}write(t,i,r,s){P5(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,t.transformation,r.position,s,6),MY(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,t.invTranspTransformation,r.normal,s,6);{const n=i.vertexAttributes.get(A.UV0).data;let o,a,l,c;if(n==null||n.length<4){const m=this.material.parameters;o=0,a=0,l=m.texCoordScale[0],c=m.texCoordScale[1]}else o=n[0],a=n[1],l=n[2],c=n[3];l=Math.min(1.99999,l+1),c=Math.min(1.99999,c+1);const h=i.indices.get(A.POSITION).length,p=r.uv0;let f=s;for(let m=0;m<h;++m)p.set(f,0,o),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,a),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,l),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,c),f+=1,p.set(f,0,o),p.set(f,1,a),f+=1}pF(i.indices.get(A.COLOR),i.vertexAttributes.get(A.COLOR).data,4,r.color,s,6);{const n=i.indices.get(A.SIZE),o=i.vertexAttributes.get(A.SIZE).data,a=n.length,l=r.size;let c=s;for(let h=0;h<a;++h){const p=o[2*n[h]],f=o[2*n[h]+1];for(let m=0;m<6;++m)l.set(c,0,p),l.set(c,1,f),c+=1}}i.indices.get(A.AUXPOS1)&&i.vertexAttributes.get(A.AUXPOS1)&&T2(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,r.auxpos1,s,6),i.indices.get(A.AUXPOS2)&&i.vertexAttributes.get(A.AUXPOS2)&&T2(i.indices.get(A.AUXPOS2),i.vertexAttributes.get(A.AUXPOS2).data,r.auxpos2,s,6)}}const op=O(),Hw=Gt(),ZE=Gt(),hz=O(),fQe=Ae(),mQe=fn(),dz=Yn(),gQe=O(),yQe=Dt();class vQe{constructor(){this.aabr=Dt(),this.distance=0,this.culled=!1,this.visible=!1}}class _Qe{constructor(t,i,r={}){this.graphics3DGraphic=t,this.slicePlaneEnabled=i,this.info=r}}class bQe{constructor(){this.active=new Map,this.visible=new Map}clear(){this.active.clear(),this.visible.clear()}}class wQe{}class xQe{constructor(){this.sortArray=new Bt({allocator:t=>t||new wQe})}}var $l;(function(e){e[e.Idle=0]="Idle",e[e.Process=1]="Process",e[e.Sort=2]="Sort",e[e.Deconflict=3]="Deconflict",e[e.NumStates=4]="NumStates"})($l||($l={}));class C1e{constructor(){this.camera=new Yi,this.slicePlane=Uv(),this.slicePlaneEnabled=!1}copyFrom(t){this.camera.copyFrom(t.camera),yw(t.slicePlane,this.slicePlane),this.slicePlaneEnabled=t.slicePlaneEnabled}}let kT=class extends Ee{constructor(){super(...arguments),this._dirty=!1,this._runningViewState=new C1e,this._state=$l.Idle,this.graphics=new bQe,this.iterators=new xQe,this.accBinsNumX=15,this.accBinsNumY=20,this.accBinsSizeX=0,this.accBinsSizeY=0,this.accBins=null,this.accNumTests=0}get dirty(){return this._dirty}get state(){return this._state}destroy(){this.graphics.clear(),this.iterators=null}setDirty(){!this._dirty&&this.graphics.active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==$l.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const e=this._state/$l.NumStates;return this._dirty?.5*e:e}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(e){switch(this._state){case $l.Idle:this._startUpdate(),e.madeProgress();case $l.Process:if(this._state=$l.Process,!this._processActiveGraphics(e))return;case $l.Sort:if(this._state=$l.Sort,!this._sortVisibleGraphics(e))return;case $l.Deconflict:if(this._state=$l.Deconflict,!this._deconflictVisibleGraphics(e))return;default:VYe(this,this.graphics.visible),this._state=$l.Idle,this.notifyChange("updating")}}modifyGraphics(e,t){t?e.forEach(i=>this.addToActiveGraphics(i)):e.forEach(i=>this.removeFromActiveGraphics(i)),this.setDirty()}layerSupportsDeconfliction(e){if(R(e)||e.type!=="object3d")return!1;const t=e.stageObject;return(t?t.geometryRecords.length:0)!==1?!1:t.geometryRecords[0].material instanceof S2}_startUpdate(){BYe(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:e,fullHeight:t}=this._runningViewState.camera;this._initBins(e,t),this._resetIterators()}addToActiveGraphics(e){e.info[this.visibilityGroup]=new vQe,this.graphics.active.set(e.graphics3DGraphic.graphic.uid,e),this.setDirty()}removeFromActiveGraphics(e){this._removeFromVisibleGraphics(e),TQe(e,this.visibilityGroup),delete e.info[this.visibilityGroup],this.graphics.active.delete(e.graphics3DGraphic.graphic.uid),this.setDirty()}_addToVisibleGraphics(e){this.graphics.visible.set(e.graphics3DGraphic.graphic.uid,e)}_removeFromVisibleGraphics(e){this.graphics.visible.delete(e.graphics3DGraphic.graphic.uid)}_processActiveGraphics(e){const t=this._ensureActiveGraphicsIterator(),i=cs(fQe,this._runningViewState.camera.projectionMatrix),r=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?mQe:null;let s=0;for(_(r)&&(Ue(r,Ta,this._runningViewState.camera.viewMatrix),r[3]=vi(this.view.spatialReference).radius,s=gpe(r,Ta));!e.done;){e.madeProgress();const n=t.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,i,r,s),a.culled?this._removeFromVisibleGraphics(o):this._addToVisibleGraphics(o))}return!1}_sortVisibleGraphics(e){const t=this._ensureSortGraphicsIterator();for(;!e.done;){const i=t.next();if(e.madeProgress(),i.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(e){const t=this._ensureVisibleGraphicsIterator(),i=this.visibilityGroup===Wn.LABEL;for(;!e.done;){e.madeProgress();const r=t.next();if(r.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=r.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=(!i||o.isVisible())&&!this._isConflicted(s);a&&this._addToBins(s),n.visible=a,this._setGraphicVisibility(s,a),jYe(n,a)}return!1}_resetIterators(){this.iterators.active=null,this.iterators.visible=null,this.iterators.sort=null}_ensureActiveGraphicsIterator(){return this.iterators.active||(this.iterators.active=Vre(this.graphics.active)),this.iterators.active}_resetActiveGraphicsIterator(){this.iterators.active=null}_ensureVisibleGraphicsIterator(){return this.iterators.visible||(this.iterators.visible=Vre(this.graphics.visible)),this.iterators.visible}_resetVisibleGraphicsIterator(){this.iterators.visible=null}_ensureSortGraphicsIterator(){return this.iterators.sort||(this.iterators.sort=SQe(this.graphics.visible,this.iterators.sortArray,this.visibilityGroup)),this.iterators.sort}_resetSortGraphicsIterator(){this.iterators.sort=null}_collectGraphics3DGraphics(e,t,i,r){const s=e.graphics3DGraphic;if(s.destroyed)return;const n=e.info[this.visibilityGroup];if(!s.isVisible(Wn.GRAPHIC,Yc.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);hu(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometryRecords[0].material;if(R(a)){if(a=this._getProjectionInfo(l,t,AQe),a.isOutsideScreen||this._isCulledBySlice(e,op)||_(i)&&this._isCulledByHorizon(a,i,r))return void(n.culled=!0);!zi.TESTS_DISABLE_OPTIMIZATIONS&&n.visible&&(a.distance*=.7)}this._expandBoundingRect(n,l,c,a)}R(a)?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(e,t,i){const r=this._runningViewState.camera,s=e.stageObject,n=s.geometryRecords[0],o=n.material,a=s.boundingVolumeWorldSpace.bounds;Ue(op,a,r.viewMatrix);const l=n.geometry.vertexAttributes,c=l.get(A.NORMAL).data,h=l.get(A.AUXPOS1).data;return o.applyShaderOffsetsView(op,c,s.transformation,h,r,i.scaleInfo,op),qi(Hw,op[0],op[1],op[2],1),Qc(ZE,Hw,r.projectionMatrix),oe(i.positionNDC,ZE,1/ZE[3]),o.applyShaderOffsetsNDC(i.positionNDC,h,r,i.positionNDC,hz),i.distanceWithoutPolygonOffset=r.depthNDCToWorld(hz[2]),i.distance=hz[2]===i.positionNDC[2]?i.distanceWithoutPolygonOffset:r.depthNDCToWorld(i.positionNDC[2]),qi(ZE,i.positionNDC[0],i.positionNDC[1],i.positionNDC[2],1),Qc(Hw,ZE,t),hO(Hw,Hw,1/Hw[3]),ie(i.positionView,op[0],op[1],op[2]),i}_isCulledByHorizon(e,t,i){return se(dz.direction,e.positionView),ie(dz.origin,0,0,0),!!Fv(t,dz,gQe)&&e.distanceWithoutPolygonOffset>i}_isCulledBySlice(e,t){return e.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Kq(this._runningViewState.slicePlane,t)}_expandBoundingRect(e,t,i,{positionNDC:r,scaleInfo:s}){const n=this._runningViewState.camera,o=t.getScreenSize(EQe);q_e(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=rN(i.calculateRelativeScreenBounds(o,s.factorAlignment.scale,yQe),jt(0,n.fullWidth,.5+.5*r[0]),jt(0,n.fullHeight,.5+.5*r[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(Wc(a),Yd(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}cb(e.aabr,a,e.aabr)}_isConflicted(e){const t=e.graphics3DGraphic.graphic.uid,i=e.info[this.visibilityGroup];for(let r=Math.floor(i.aabr[0]/this.accBinsSizeX);r<=Math.floor(i.aabr[2]/this.accBinsSizeX);r++)if(!(r<0||r>=this.accBinsNumX))for(let s=Math.floor(i.aabr[1]/this.accBinsSizeY);s<=Math.floor(i.aabr[3]/this.accBinsSizeY);s++){if(s<0||s>=this.accBinsNumY)continue;const n=this.accBins[r][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==t&&(this.accNumTests++,TO(l.aabr,i.aabr)))return!0}}return!1}_initBins(e,t){if(this.accBins==null){this.accBins=[];for(let i=0;i<this.accBinsNumX;i++){this.accBins.push([]);const r=this.accBins[this.accBins.length-1];for(let s=0;s<this.accBinsNumY;s++)r.push(new Bt)}}else for(let i=0;i<this.accBinsNumX;i++)for(let r=0;r<this.accBinsNumY;r++)this.accBins[i][r].clear();this.accBinsSizeX=e/this.accBinsNumX,this.accBinsSizeY=t/this.accBinsNumY,this.accNumTests=0}_addToBins(e){const t=e.info[this.visibilityGroup],i=Math.floor(t.aabr[0]/this.accBinsSizeX),r=Math.floor(t.aabr[2]/this.accBinsSizeX),s=Math.floor(t.aabr[1]/this.accBinsSizeY),n=Math.floor(t.aabr[3]/this.accBinsSizeY);for(let o=i;o<=r;o++)if(!(o<0||o>=this.accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this.accBinsNumY||this.accBins[o][a].push(e)}_setGraphicVisibility(e,t){const i=e.graphics3DGraphic;i.destroyed||(i.setVisibilityFlag(Yc.DECONFLICTION,t,this.visibilityGroup),this.visibilityGroup===Wn.LABEL&&this.view.labeler.setLabelGraphicVisibility(i,t))}};function TQe(e,t){const i=e.graphics3DGraphic;i.destroyed||i.clearVisibilityFlag(Yc.DECONFLICTION,t)}function*Vre(e){if(Map.prototype.entries){const t=e.entries();for(let i=t.next();!i.done;i=t.next())yield i.value[1]}else yield*e.values()}function*SQe(e,t,i){t.clear(),e.forEach((s,n)=>{const o=t.pushNew();o.id=n,o.prio=s.info?-s.info[i].distance:Number.MAX_VALUE}),yield;const r=t.iterableSort((s,n)=>n.prio-s.prio);for(let s=r.next();!s.done;s=r.next())yield;t.forAll(s=>{const n=e.get(s.id);n&&(e.delete(s.id),e.set(s.id,n))}),t.clear()}u([d({constructOnly:!0})],kT.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],kT.prototype,"updating",null),kT=u([P("esri.views.3d.layers.graphics.Deconflictor")],kT);const EQe=tt();class CQe{constructor(){this.positionView=O(),this.positionNDC=O(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo={factor:{scale:0,factor:0,minPixelSize:0,paddingPixels:0},factorAlignment:{scale:0,factor:0,minPixelSize:0,paddingPixels:0}}}get isOutsideScreen(){const t=this.positionNDC;return t[0]<-1||t[1]<-1||t[2]<-1||t[0]>=1||t[1]>=1}}const AQe=new CQe,RQe=2e3;let JD=class extends kT{constructor(){super(...arguments),this.visibilityGroup=Wn.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return;const t=performance.now();(e.state===xn.IDLE||t-this._lastDeconfliction>RQe)&&(super.runTask(e),this.state===$l.Idle&&(this._lastDeconfliction=t))}enabledChanged(e,t){this.modifyGraphics(t,e.labelsEnabled)}getGraphicsLayers(e){return e.labelGraphics}};u([d({constructOnly:!0})],JD.prototype,"parent",void 0),JD=u([P("esri.views.3d.layers.graphics.LabelDeconflictor")],JD);let ej=class extends kT{constructor(){super(...arguments),this._handles=new qt,this._contexts=new Map,this._viewState=new C1e,this.visibilityGroup=Wn.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([ae(()=>{var e,t;return(t=(e=this.view)==null?void 0:e.state)==null?void 0:t.camera},()=>{this._updateViewState(),this.setDirty()}),ae(()=>{var e,t,i;return(i=(t=(e=this.view)==null?void 0:e.map)==null?void 0:t.ground)==null?void 0:i.opacity},(e,t)=>{e!==1&&t!==1||this.setDirty()}),ae(()=>{var e;return(e=this.view)==null?void 0:e.slicePlane},()=>{this._updateSlicePlane(),this._slicePlaneChanged()},Ft)]),this._frameTask=this.view.resourceController.scheduler.registerTask(mt.GRAPHICS_DECONFLICTOR,this),this._labels=new JD({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,t){const i=!(this._graphicSupportsDeconfliction(t)&&pz(e));t.setVisibilityFlag(Yc.DECONFLICTION,i,Wn.GRAPHIC)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;_(e)&&Ppe(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=_(e)}_slicePlaneChanged(){Ws(this._contexts,(e,t)=>t.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){let t=this._contexts.get(e);return t==null&&(t=new Map,this._contexts.set(e,t),this.setDirty()),{addGraphic:i=>this._addGraphic(e,t,i),removeGraphic:i=>this._removeGraphic(t,i),labelingInfoChange:()=>this._labels.enabledChanged(e,t),featureReductionChange:()=>this.enabledChanged(e,t),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,t),clear:()=>t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic))}}removeGraphicsOwner(e){const t=this._contexts.get(e);t&&(t.forEach(i=>this._removeGraphic(t,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,t,i){const r=i.graphic.uid,s=new _Qe(i,e.symbolCreationContext.slicePlaneEnabled);t.set(r,s),pz(e)&&this.addToActiveGraphics(s),e.labelsEnabled&&this._labels.addToActiveGraphics(s)}_removeGraphic(e,t){const i=t.graphic.uid,r=e.get(i);r&&(this.removeFromActiveGraphics(r),this._labels.removeFromActiveGraphics(r),e.delete(i),this.setDirty())}enabledChanged(e,t){const i=pz(e);i||MQe(e),this.modifyGraphics(t,i)}_slicePlaneEnabledChanged(e,t){const i=e.symbolCreationContext.slicePlaneEnabled;t.forEach(r=>r.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.graphics}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const t=e.graphics;if(!t||!t.length)return!1;for(const i of t)if(this.layerSupportsDeconfliction(i))return!0;return!1}};function pz(e){const t=e.layer;return!(!t||!t.featureReduction||t.featureReduction.type!=="selection")}function MQe(e){const t=e.graphics3DGraphics;t&&t.forEach(i=>i.clearVisibilityFlag(Yc.DECONFLICTION))}ej=u([P("esri.views.3d.layers.graphics.GraphicsDeconflictor")],ej);const DY=(e,t,i)=>[t,i],E2=(e,t,i)=>[t,i,e[2]],LY=(e,t,i)=>[t,i,e[2],e[3]];function X_t(e){return e?{originPosition:e.originPosition==="upper-left"?"upperLeft":e.originPosition==="lower-left"?"lowerLeft":e.originPosition,scale:e.tolerance?[e.tolerance,e.tolerance]:[1,1],translate:_(e.extent)?[e.extent.xmin,e.extent.ymax]:[0,0]}:null}function OQe({scale:e,translate:t},i){return Math.round((i-t[0])/e[0])}function PQe({scale:e,translate:t},i){return Math.round((t[1]-i)/e[1])}function A1e({scale:e,translate:t},i){return i*e[0]+t[0]}function R1e({scale:e,translate:t},i){return t[1]-i*e[1]}function M1e(e,t,i){const r=new Array(i.length);if(!i.length)return r;const[s,n]=e.scale;let o=A1e(e,i[0][0]),a=R1e(e,i[0][1]);r[0]=t(i[0],o,a);for(let l=1;l<i.length;l++){const c=i[l];o+=c[0]*s,a-=c[1]*n,r[l]=t(c,o,a)}return r}function O1e(e,t,i){const r=new Array(i.length);for(let s=0;s<i.length;s++)r[s]=M1e(e,t,i[s]);return r}function IQe(e,t,i,r){return M1e(e,i?r?LY:E2:r?E2:DY,t)}function $Qe(e,t,i,r){return O1e(e,i?r?LY:E2:r?E2:DY,t)}function DQe(e,t,i,r){return O1e(e,i?r?LY:E2:r?E2:DY,t)}function Y_t(e,t,i,r,s){return t.x=OQe(e,i.x),t.y=PQe(e,i.y),t!==i&&(r&&(t.z=i.z),s&&(t.m=i.m)),t}function P1e(e,t,i,r,s){return _(i)&&(t.points=IQe(e,i.points,r,s)),t}function I1e(e,t,i,r,s){return R(i)||(t.x=A1e(e,i.x),t.y=R1e(e,i.y),t!==i&&(r&&(t.z=i.z),s&&(t.m=i.m))),t}function $1e(e,t,i,r,s){return _(i)&&(t.rings=DQe(e,i.rings,r,s)),t}function D1e(e,t,i,r,s){return _(i)&&(t.paths=$Qe(e,i.paths,r,s)),t}function L1e(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++){const r=e[i],s=t[i];if(r.length!==s.length)return!1;for(let n=0;n<r.length;n++)if(r[n]!==s[n])return!1}return!0}function N1e(e,t){if(e===t)return!0;if(e==null||t==null||e.length!==t.length)return!1;for(let i=0;i<e.length;i++)if(!L1e(e[i],t[i]))return!1;return!0}function LQe(e,t){return!!JO(e.spatialReference,t.spatialReference)&&e.x===t.x&&e.y===t.y&&e.z===t.z&&e.m===t.m}function NQe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!JO(e.spatialReference,t.spatialReference)&&N1e(e.paths,t.paths)}function FQe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!JO(e.spatialReference,t.spatialReference)&&N1e(e.rings,t.rings)}function UQe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!JO(e.spatialReference,t.spatialReference)&&L1e(e.points,t.points)}function kQe(e,t){return e.hasZ===t.hasZ&&e.hasM===t.hasM&&!!JO(e.spatialReference,t.spatialReference)&&e.xmin===t.xmin&&e.ymin===t.ymin&&e.zmin===t.zmin&&e.xmax===t.xmax&&e.ymax===t.ymax&&e.zmax===t.zmax}function JO(e,t){return e===t||e&&t&&e.equals(t)}function zQe(e,t){if(e===t)return!0;if(R(e)||R(t)||e.type!==t.type)return!1;switch(e.type){case"point":return LQe(e,t);case"extent":return kQe(e,t);case"polyline":return NQe(e,t);case"polygon":return FQe(e,t);case"multipoint":return UQe(e,t);case"mesh":return!1;default:return}}function VQe(e,t){if(e===t)return!0;if(!e||!t)return!1;const i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(const s of i)if(e[s]!==t[s])return!1;return!0}function Z_t(e,t){return e===t||e!=null&&t!=null&&e.objectId===t.objectId&&!!zQe(e.geometry,t.geometry)&&!!VQe(e.attributes,t.attributes)}class Q_t{constructor(t,i,r){this.uid=t,this.geometry=i,this.attributes=r,this.visible=!0,this.objectId=null,this.centroid=null}}function J_t(e){return _(e.geometry)}class K_t{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}}function e1t(e){const t=yue.fromJSON(e.geometryType),i=Xe.fromJSON(e.spatialReference),r=e.transform,s=e.features.map(n=>{const o=BQe(n,t,i,e.objectIdFieldName),a=o.geometry;if(_(a)&&r)switch(a.type){case"point":o.geometry=I1e(r,a,a,a.hasZ,a.hasM);break;case"multipoint":o.geometry=P1e(r,a,a,a.hasZ,a.hasM);break;case"polygon":o.geometry=$1e(r,a,a,a.hasZ,a.hasM);break;case"polyline":o.geometry=D1e(r,a,a,a.hasZ,a.hasM);break;case"extent":case"mesh":o.geometry=a}return o});return{geometryType:t,features:s,spatialReference:i,fields:e.fields?e.fields.map(n=>IO.fromJSON(n)):null,objectIdFieldName:e.objectIdFieldName,globalIdFieldName:e.globalIdFieldName,geohashFieldName:e.geohashFieldName,geometryProperties:e.geometryProperties,hasZ:e.hasZ,hasM:e.hasM,exceededTransferLimit:e.exceededTransferLimit,transform:null}}function BQe(e,t,i,r){return{uid:sl(),objectId:r&&e.attributes?e.attributes[r]:null,attributes:e.attributes,geometry:GQe(e.geometry,t,i),visible:!0}}function GQe(e,t,i){if(R(e))return null;switch(t){case"point":{const r=e;return{x:r.x,y:r.y,z:r.z,m:r.m,hasZ:r.z!=null,hasM:r.m!=null,type:"point",spatialReference:i}}case"polyline":{const r=e;return{paths:r.paths,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polyline",spatialReference:i}}case"polygon":{const r=e;return{rings:r.rings,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"polygon",spatialReference:i}}case"multipoint":{const r=e;return{points:r.points,hasZ:!!r.hasZ,hasM:!!r.hasM,type:"multipoint",spatialReference:i}}}}function jg(e,t,i,r){return{x:e,y:t,z:i,hasZ:i!=null,hasM:!1,spatialReference:r,type:"point"}}function jQe(e){if(R(e))return 0;let t=32;switch(e.type){case"point":t+=42;break;case"polyline":case"polygon":{let i=0;const r=2+(e.hasZ?1:0)+(e.hasM?1:0),s=e.type==="polyline"?e.paths:e.rings;for(const n of s)i+=n.length;t+=8*i*r+64,t+=128*i,t+=34,t+=32*(s.length+1);break}case"multipoint":{const i=2+(e.hasZ?1:0)+(e.hasM?1:0),r=e.points.length;t+=8*r*i+64,t+=128*r,t+=34,t+=32;break}case"extent":t+=98,e.hasM&&(t+=32),e.hasZ&&(t+=32);break;case"mesh":t+=M3(e.vertexAttributes.position),t+=M3(e.vertexAttributes.normal),t+=M3(e.vertexAttributes.uv),t+=M3(e.vertexAttributes.tangent)}return t}function t1t(e){let t=32;return t+=qde(e.attributes),t+=3,t+=8+jQe(e.geometry),t}function HQe(e){if(R(e))return 0;switch(e.type){case"point":return 1;case"polyline":{let t=0;for(const i of e.paths)t+=i.length;return t}case"polygon":{let t=0;for(const i of e.rings)t+=i.length;return t}case"multipoint":return e.points.length;case"extent":return 2;case"mesh":{const t=e.vertexAttributes&&e.vertexAttributes.position;return t?t.length/3:0}default:return}}function i1t(e){if(R(e))return!1;switch(e.type){case"extent":case"point":return!0;case"polyline":for(const t of e.paths)if(t.length>0)return!0;return!1;case"polygon":for(const t of e.rings)if(t.length>0)return!0;return!1;case"multipoint":return e.points.length>0;case"mesh":return!e.loaded||e.vertexAttributes.position.length>0}}function r1t(e,t){switch(cr(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[3]=e.x,t[1]=t[4]=e.y,e.hasZ&&(t[2]=t[5]=e.z);break;case"polyline":for(let i=0;i<e.paths.length;i++)ck(t,e.paths[i],e.hasZ);break;case"polygon":for(let i=0;i<e.rings.length;i++)ck(t,e.rings[i],e.hasZ);break;case"multipoint":ck(t,e.points,e.hasZ);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[3]=e.xmax,t[4]=e.ymax,e.zmin!=null&&(t[2]=e.zmin),e.zmax!=null&&(t[5]=e.zmax)}}function qQe(e,t){switch(hu(t),e.type==="mesh"&&(e=e.extent),e.type){case"point":t[0]=t[2]=e.x,t[1]=t[3]=e.y;break;case"polyline":for(let i=0;i<e.paths.length;i++)lk(t,e.paths[i]);break;case"polygon":for(let i=0;i<e.rings.length;i++)lk(t,e.rings[i]);break;case"multipoint":lk(t,e.points);break;case"extent":t[0]=e.xmin,t[1]=e.ymin,t[2]=e.xmax,t[3]=e.ymax}}function s1t(e,t){return e.objectId!=null?e.objectId:e.attributes&&t?e.attributes[t]:null}Ls();Dt();function F1e(e){return"declaredClass"in e}function Bre(e){return"declaredClass"in e}function WQe(e){return"declaredClass"in e}function XQe(e,t){if(!e)return null;if(WQe(e))return e;const i=new Ca({layer:t,sourceLayer:t});return i.visible=e.visible,i.symbol=te(e.symbol),i.attributes=te(e.attributes),i.geometry=U1e(e.geometry),i}function U1e(e){return R(e)?null:F1e(e)?e:yf(YQe(e))}function YQe(e){const t=e.spatialReference.toJSON();switch(e.type){case"point":{const{x:i,y:r,z:s,m:n}=e;return{x:i,y:r,z:s,m:n,spatialReference:t}}case"polygon":{const{rings:i,hasZ:r,hasM:s}=e;return{rings:Gre(i),hasZ:r,hasM:s,spatialReference:t}}case"polyline":{const{paths:i,hasZ:r,hasM:s}=e;return{paths:Gre(i),hasZ:r,hasM:s,spatialReference:t}}case"extent":{const{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p}=e;return{xmin:i,xmax:r,ymin:s,ymax:n,zmin:o,zmax:a,mmin:l,mmax:c,hasZ:h,hasM:p,spatialReference:t}}case"multipoint":{const{points:i,hasZ:r,hasM:s}=e;return{points:z1e(i)?k1e(i):i,hasZ:r,hasM:s,spatialReference:t}}default:return}}function Gre(e){return ZQe(e)?e.map(t=>k1e(t)):e}function k1e(e){return e.map(t=>m2e(t))}function ZQe(e){for(const t of e)if(t.length!==0)return z1e(t);return!1}function z1e(e){return e.length&&(Hle(e[0])||qle(e[0]))}function QQe(e,t){if(!e)return null;let i;if(Bre(e)){if(t==null)return e.clone();if(Bre(t))return t.copy(e)}return t!=null?(i=t,i.x=e.x,i.y=e.y,i.spatialReference=e.spatialReference,e.hasZ?(i.z=e.z,i.hasZ=e.hasZ):(i.z=null,i.hasZ=!1),e.hasM?(i.m=e.m,i.hasM=!0):(i.m=null,i.hasM=!1)):(i=jg(e.x,e.y,e.z,e.spatialReference),e.hasM&&(i.m=e.m,i.hasM=!0)),i}const fz=me.getLogger("esri.layers.support.labelFormatUtils"),jre={type:"simple",evaluate:()=>null},JQe={getAttribute:(e,t)=>e.field(t)};async function V1e(e,t,i){if(!e||!e.symbol)return jre;const r=e.where,s=o5(e),n=r?await import("./WhereClause.6eb5053b.js"):null;let o;if(s.type==="arcade"){const a=await KCe(s.expression,i,t);o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l});if(c!=null)return c.toString()}catch{fz.error(new q("arcade-expression-error","Encountered an error when evaluating label expression for feature",{feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>uX(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replace(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=t.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":B1e(p,h)})};if(r){let a;try{a=n.WhereClause.create(r,t)}catch(c){return fz.error(new q("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:r,error:c})),jre}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:JQe;try{if(a.testFeature(c,h))return l(c)}catch(p){fz.error(new q("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:r,feature:c,error:p}))}return null}}return o}function B1e(e,t){if(e==null)return"";const i=t.domain;if(i){if(i.type==="codedValue"||i.type==="coded-value"){const s=e;for(const n of i.codedValues)if(n.code===s)return n.name}else if(i.type==="range"){const s=+e,n="range"in i?i.range[0]:i.minValue,o="range"in i?i.range[1]:i.maxValue;if(n<=s&&s<=o)return i.name}}let r=e;return t.type==="date"||t.type==="esriFieldTypeDate"?r=_f(r,a4("short-date")):o4(t)&&(r=bf(+r)),r||""}var n1t=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",createLabelFunction:V1e,formatField:B1e});function NY(e,t){if(e.type==="point")return ay(e,t,!1);if(F1e(e))switch(e.type){case"extent":return ay(e.center,t,!1);case"polygon":return ay(e.centroid,t,!1);case"polyline":return ay(Hre(e),t,!0);case"mesh":return ay(e.origin,t,!1)}else switch(e.type){case"extent":return ay(KQe(e),t,!0);case"polygon":return ay(eJe(e),t,!0);case"polyline":return ay(Hre(e),t,!0)}}function Hre(e){const t=e.paths[0];if(!t||t.length===0)return null;const i=iue(t,tue(t)/2);return jg(i[0],i[1],i[2],e.spatialReference)}function KQe(e){const t=isFinite(e.zmin);return jg(.5*(e.xmax+e.xmin),.5*(e.ymax+e.ymin),t?.5*(e.zmax+e.zmin):void 0,e.spatialReference)}function eJe(e){const t=e.rings[0];if(!t||t.length===0)return null;const i=rue(e.rings,e.hasZ);return jg(i[0],i[1],i[2],e.spatialReference)}function ay(e,t,i){const r=i?e:QQe(e);return t&&e?M3e(e,r,t)?r:null:r}function o1t(e,t,i,r=0){if(e){t||(t=Dt());const s=e;let n=.5*s.width*(i-1),o=.5*s.height*(i-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),qi(t,s.xmin-n-r,s.ymin-o-r,s.xmax+n+r,s.ymax+o+r),t}return null}function G1e(e,t){for(let i=0;i<e.geometries.length;++i){const r=e.geometries[i].getMutableAttribute(A.AUXPOS1);r&&r.data[3]!==t&&(r.data[3]=t,e.geometryVertexAttrsUpdated(e.geometryRecords[i]))}}function TR(e,t){const i=M4(ph);return _(e)&&(i[0]=e[0],i[1]=e[1],i[2]=e[2]),_(t)?i[3]=t:_(e)&&e.length>3&&(i[3]=e[3]),i}function a1t(e,t,i,r,s,n=[0,0,0,0]){for(let o=0;o<3;++o)_(e)&&e[o]!=null?n[o]=e[o]:_(i)&&i[o]!=null?n[o]=i[o]:n[o]=s[o];return _(t)?n[3]=t:_(r)?n[3]=r:n[3]=s[3],n}function qre(e=of,t,i,r=1){const s=new Array(3);if(R(t)||R(i))s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=e[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=i[a];l==="symbol-value"||p?c=f!==0?t[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=r;return Ya(s)}function tJe(e){return e.isPrimitive!=null}function U5(e){return tJe(e)&&(e=[e.width,e.depth,e.height]),vF(e)?null:"Symbol sizes may not be negative values"}function vF(e){if(Array.isArray(e)){for(const t of e)if(!vF(t))return!1;return!0}return e==null||e>=0}function iJe(e,t,i,r=Ae()){const s=e||0,n=t||0,o=i||0;return s!==0&&BS(r,r,-s/180*Math.PI),n!==0&&VS(r,r,n/180*Math.PI),o!==0&&S4(r,r,o/180*Math.PI),r}function FY(e,t){return t.minDemResolution!=null?t.minDemResolution:p4(e)?t.minDemResolutionForPoints:.01*cRe(e)}function j1e(e,t,i,r,s,n,o,a,l,c,h){const p=uJe[h.mode];let f,m,y=0;if(ar(e,t,i,r,l.spatialReference,s,a))return p.requiresAlignment(h)?(y=p.applyElevationAlignmentBuffer(r,s,n,o,a,l,c,h),f=n,m=o):(f=r,m=s),ar(f,l.spatialReference,m,n,c.spatialReference,o,a)?y:void 0}function Mg(e,t,i,r,s){const n=(cF(e)?e.z:x_e(e)?e.array[e.offset+2]:e[2])||0;switch(i.mode){case"on-the-ground":{const o=yt(lf(t,e,"ground"),0);return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=yt(lf(t,e,"ground"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=yt(lf(t,e,"scene"),0),a=i.geometryZWithOffset(n,r);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=i.geometryZWithOffset(n,r),a=yt(lf(t,e,"ground"),0);return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return i.mode,void(s.z=0)}}function rJe(e,t,i,r){return Mg(e,t,i,r,zT),zT.z}function KO(e,t,i){return t==null||i==null?e.definedChanged:t==="on-the-ground"&&i==="on-the-ground"?e.staysOnTheGround:t===i||t!=="on-the-ground"&&i!=="on-the-ground"?Br.UPDATE:e.onTheGroundChanged}function Oh(e){return e==="relative-to-ground"||e==="relative-to-scene"}function Rv(e){return e!=="absolute-height"}function sJe(e,t,i,r,s){Mg(t,i,s,r,zT),G1e(e,zT.verticalDistanceToGround);const n=zT.sampledElevation,o=ms(hJe,e.transformation);return aI[0]=t.x,aI[1]=t.y,aI[2]=zT.z,fu(t.spatialReference,aI,o,r.spatialReference)?e.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function nJe(e,t,i,r,s,n){let o=0;const a=n.spatialReference;t*=3,r*=3;for(let l=0;l<s;++l){const c=e[t+0],h=e[t+1],p=e[t+2],f=yt(n.getElevation(c,h,p,a,"ground"),0);o+=f,i[r+0]=c,i[r+1]=h,i[r+2]=f,t+=3,r+=3}return o/s}function oJe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const m=e[t+0],y=e[t+1],v=e[t+2],w=yt(n.getElevation(m,y,v,p,"ground"),0);l+=w,i[r+0]=m,i[r+1]=y,i[r+2]=h==null?v+w+c:w+c,t+=3,r+=3}return l/s}function aJe(e,t,i,r,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;t*=3,r*=3;for(let f=0;f<s;++f){const m=e[t+0],y=e[t+1],v=e[t+2],w=yt(n.getElevation(m,y,v,p,"scene"),0);l+=w,i[r+0]=m,i[r+1]=y,i[r+2]=h==null?v+w+c:w+c,t+=3,r+=3}return l/s}function lJe(e){const t=e.meterUnitOffset,i=e.featureExpressionInfoContext;return t!==0||i!=null}function cJe(e,t,i,r,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;t*=3,r*=3;for(let h=0;h<s;++h){const p=e[t+0],f=e[t+1],m=e[t+2];i[r+0]=p,i[r+1]=f,i[r+2]=c==null?m+l:l,t+=3,r+=3}return 0}class e3{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}}var Br;(function(e){e[e.NONE=0]="NONE",e[e.UPDATE=1]="UPDATE",e[e.RECREATE=2]="RECREATE"})(Br||(Br={}));const uJe={"absolute-height":{applyElevationAlignmentBuffer:cJe,requiresAlignment:lJe},"on-the-ground":{applyElevationAlignmentBuffer:nJe,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:oJe,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:aJe,requiresAlignment:()=>!0}},hJe=Ae(),zT=new e3,aI=O();function H1e(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;for(const a of n){const{update:l,averageGeometrySampledElevation:c}=W1e(a,t,i,r);o+=c,l&&s.geometryVertexAttrsUpdated(a)}return o/n.length}function jM(e,t,i,r){const s=e.stageObject,n=t.centerPointInElevationSR;let o=0;s.metadata.usesVerticalDistanceToGround?(Mg(n,i,t,r,Ka),G1e(s,Ka.verticalDistanceToGround),o=Ka.sampledElevation):(Mg(n,i,t,r,Ka),t.mode!=="absolute-height"&&(o=Ka.sampledElevation));const a=ms(dJe,s.transformation),l=ie(q1e,a[12],a[13],a[14]);zi.TESTS_DISABLE_OPTIMIZATIONS?(Ja[0]=n.x,Ja[1]=n.y,Ja[2]=Ka.z,fu(n.spatialReference,Ja,a,r.spatialReference)&&(s.transformation=a)):r.setAltitudeOfTransformation(Ka.z,a);const c=UY/r.unitInMeters;return(Math.abs(a[12]-l[0])>=c||Math.abs(a[13]-l[1])>=c||Math.abs(a[14]-l[2])>=c)&&(s.transformation=a),o}const dJe=Ae();function pJe(e,t,i,r){const s=e.graphics3DSymbolLayer.lodRenderer;if(R(s))return 0;const n=t.centerPointInElevationSR;Mg(n,i,t,r,Ka);const o=t.mode!=="absolute-height"?Ka.sampledElevation:0,a=s.instanceData,l=e.instanceIndex,c=mJe;a.getGlobalTransform(l,c);const h=ie(q1e,c[12],c[13],c[14]);zi.TESTS_DISABLE_OPTIMIZATIONS?(Ja[0]=n.x,Ja[1]=n.y,Ja[2]=Ka.z,fu(n.spatialReference,Ja,c,r.spatialReference)&&a.setGlobalTransform(l,c)):r.setAltitudeOfTransformation(Ka.z,c);const p=UY/r.unitInMeters;return(zi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&a.setGlobalTransform(l,c),o}function fJe(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;if(n.length===0)return 0;let o=0,a=null,l=0,c=!1;for(const h of n){const p=h.geometry.vertexAttributes.get(A.POSITION);if(p!==a){const{update:f,averageGeometrySampledElevation:m}=W1e(h,t,i,r);l=m,a=p,c=f}c&&s.geometryVertexAttrsUpdated(h),o+=l}return o/n.length}const UY=.01,Ja=O(),Eu=O(),qw=O(),mJe=Ae(),q1e=O(),Ka=new e3;function W1e(e,t,i,r){let s=!1;const n=i.spatialReference,o=e.geometry,a=e.getShaderTransformation(),l=t.requiresSampledElevationInfo;Eu[0]=a[12],Eu[1]=a[13],Eu[2]=a[14],o.invalidateBoundingInfo();const c=o.getMutableAttribute(A.POSITION),h=c.data,p=o.vertexAttributes.get(A.MAPPOS).data,f=c.size,m=h.length/f,y=new w_e(p,n);let v=0,w=0;for(let b=0;b<m;b++){if(qw[0]=h[v],qw[1]=h[v+1],qw[2]=h[v+2],Mg(y,i,t,r,Ka),l&&(w+=Ka.sampledElevation),zi.TESTS_DISABLE_OPTIMIZATIONS)h[v]=y.array[y.offset],h[v+1]=y.array[y.offset+1],h[v+2]=Ka.z,ar(h,n,v,h,r.spatialReference,v,1),h[v]-=Eu[0],h[v+1]-=Eu[1],h[v+2]-=Eu[2],s=!0;else{Ja[0]=h[v]+Eu[0],Ja[1]=h[v+1]+Eu[1],Ja[2]=h[v+2]+Eu[2],r.setAltitude(Ja,Ka.z),h[v]=Ja[0]-Eu[0],h[v+1]=Ja[1]-Eu[1],h[v+2]=Ja[2]-Eu[2];const S=UY/r.unitInMeters;(Math.abs(qw[0]-h[v])>=S||Math.abs(qw[1]-h[v+1])>=S||Math.abs(qw[2]-h[v+2])>=S)&&(s=!0)}v+=f,y.offset+=3}return w/=m,{update:s,averageGeometrySampledElevation:w}}const gJe=me.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function yJe(e){return{cachedResult:e.cachedResult,arcade:e.arcade?{func:e.arcade.func,context:e.arcade.modules.arcadeUtils.createExecContext(null,{sr:e.arcade.context.spatialReference}),modules:e.arcade.modules}:null}}function l1t(e){const t=e&&e.expression;if(typeof t=="string"){const i=Z1e(t);if(i!=null)return{cachedResult:i}}return null}async function c1t(e,t,i){const r=e&&e.expression;if(typeof r!="string")return null;const s=Z1e(r);if(s!=null)return{cachedResult:s};const n=await vf(),o=n.arcadeUtils,a=o.createSyntaxTree(r);return o.dependsOnView(a)?(i!=null&&i.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:o.createFunction(a),context:o.createExecContext(null,{sr:t}),modules:n}}}function X1e(e,t,i){return e.arcadeUtils.createFeature(t.attributes,t.geometry,i)}function kY(e,t){if(e!=null&&!Y1e(e)){if(!t||!e.arcade)return void gJe.errorOncePerTick("Arcade support required but not provided");const i=t;i._geometry&&(i._geometry=U1e(i._geometry)),e.arcade.modules.arcadeUtils.updateExecContext(e.arcade.context,t)}}function vJe(e){if(e!=null){if(Y1e(e))return e.cachedResult;const t=e.arcade;let i=e.arcade.modules.arcadeUtils.executeFunction(t.func,t.context);return typeof i!="number"&&(e.cachedResult=0,i=0),i}return 0}function u1t(e,t=!1){let i=e&&e.featureExpressionInfo;const r=i&&i.expression;return t||r==="0"||(i=null),i}const _Je={cachedResult:0};function Y1e(e){return e.cachedResult!=null}function Z1e(e){return e==="0"?0:null}class _u{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(t){this._unit=t,this._metersPerElevationInfoUnit=xze(t)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(t){this._meterUnitOffset=t,this._renderUnitOffset=0}set offsetElevationInfoUnits(t){this._meterUnitOffset=t*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(t){this._renderUnitOffset+=t}geometryZWithOffset(t,i){const r=this.calculateOffsetRenderUnits(i);return this.featureExpressionInfoContext!=null?r:t+r}calculateOffsetRenderUnits(t){let i=this._meterUnitOffset;const r=this.featureExpressionInfoContext;return r!=null&&(i+=vJe(r)*this._metersPerElevationInfoUnit),i/t.unitInMeters+this._renderUnitOffset}setFromElevationInfo(t){this.mode=t.mode,this.unit=wze(t.unit)?t.unit:"meters",this.offsetElevationInfoUnits=yt(t.offset,0)}updateFeatureExpressionInfoContext(t,i,r){if(R(t))return void(this._featureExpressionInfoContext=null);const s=t&&t.arcade;s&&_(i)&&_(r)?(this._featureExpressionInfoContext=yJe(t),kY(this._featureExpressionInfoContext,X1e(s.modules,i,r))):this._featureExpressionInfoContext=t}static fromElevationInfo(t){const i=new _u;return _(t)&&i.setFromElevationInfo(t),i}}var It;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.TRANSPARENT=1]="TRANSPARENT",e[e.OPAQUE=2]="OPAQUE"})(It||(It={}));class jf{constructor(t,i,r,s,n,o,a,l=null){this.graphics3DSymbolLayer=t,this.stageObject=i,this._uniqueGeometries=r,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._stage=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1,this.graphics3DSymbolLayer=t,this.stageObject=i}get isElevationSource(){return!(!this.stageObject.metadata||!this.stageObject.metadata.isElevationSource)}initialize(t,i){this._stageLayer=i,this._stage=t,t.addMany(this._uniqueMaterials),t.addMany(this._uniqueGeometries),t.add(this.stageObject)}destroy(){const t=this._stage;this._stageLayer&&(t.removeMany(this._uniqueMaterials),t.removeMany(this._uniqueGeometries)),t.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)&&i.removeObject(this.stageObject),this.stageObject.dispose(),_(this._sharedResource)&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null,this._stage=null}layerOpacityChanged(t,i){if(R(this._edgeState))return;const r=Wre(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==r&&(n.objectTransparency=r,s=!0);s&&this._resetEdgeObject(i),this._stage.renderView.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[t])}slicePlaneEnabledChanged(t,i){R(this._edgeState)||(this._stage.renderView.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:t},!i),this._edgeState.properties.hasSlicePlane=t)}setVisibility(t){if(this._stage!=null&&this._visible!==t&&(this._visible=t,this._visible?this._addedToStage?this.stageObject.setVisible(!0):(this._stageLayer.add(this.stageObject),this._addedToStage=!0):this.stageObject.setVisible(!1),_(this._edgeState))){const i=this._stage.renderView.ensureEdgeView();i.hasObject(this.stageObject)?i.updateObjectVisibility(this.stageObject,t):t&&this._addOrUpdateEdgeObject(i,!1)}}get visible(){return this._visible}alignWithElevation(t,i,r,s){this.elevationAligner!=null&&(_(r)&&kY(this.elevationContext.featureExpressionInfoContext,r),this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,t,i),this._resetEdgeObject(s))}getCenterObjectSpace(t=O()){return se(t,this.stageObject.boundingVolumeObjectSpace.bounds)}getBoundingBoxObjectSpace(t=Ls()){const i=this.stageObject.boundingVolumeObjectSpace;return ohe(t,i.min),ahe(t,i.max),t}computeAttachmentOrigin(t){if(this.useObjectOriginAsAttachmentOrigin){const i=this.stageObject.transformation;t.render.origin[0]+=i[12],t.render.origin[1]+=i[13],t.render.origin[2]+=i[14],t.render.num++}else for(const i of this.stageObject.geometryRecords)i.computeAttachmentOrigin(Kf)&&(Ue(Kf,Kf,this.stageObject.transformation),de(t.render.origin,t.render.origin,Kf),t.render.num++)}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=bJe,l=p4(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];ly[0]=o[p[0]],ly[1]=o[p[1]],ly[2]=o[p[2]],Ue(ly,ly,this.stageObject.transformation),c_[3*h+0]=ly[0],c_[3*h+1]=ly[1],c_[3*h+2]=ly[2]}if(!t(c_,0,l))return null;cr(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],c_[h+p]),o[p+3]=Math.max(o[p+3],c_[h+p]);c&&r.push({location:c_.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&i.service&&this.elevationContext.mode!=="absolute-height"){Id(o,Kf);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(i.useViewElevation)p=yt(i.service.getElevation(Kf[0],Kf[1],h),0);else try{const f=FY(o,i);p=yt(await i.service.queryElevation(Kf[0],Kf[1],s,f,h),0)}catch{}nhe(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(t,i){t===Eg.Highlight&&i.addObject(this.stageObject,this.stageObject.highlight()),t===Eg.MaskOccludee&&i.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(t){t.removeObject(this.stageObject)}_resetEdgeObject(t){if(R(this._edgeState))return;const i=this._stage.renderView.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(i,t):i.removeObject(this.stageObject)}_addOrUpdateEdgeObject(t,i){const r=this._edgeState;if(R(r))return;const s=Wre(r.baseMaterial);for(const n of r.edgeMaterials)n.objectTransparency=s;t.addOrUpdateObject3D(this.stageObject,r.edgeMaterials,r.properties,!i).then(()=>{var n;return(n=this._stageLayer)==null?void 0:n.sync()})}}function Wre(e){return e.isVisible?e.parameters.transparent?It.TRANSPARENT:It.OPAQUE:It.INVISIBLE}const c_=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],ly=O(),Kf=O(),bJe=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];var Qs;(function(e){e[e.Recreate_Symbol=0]="Recreate_Symbol",e[e.Recreate_Graphics=1]="Recreate_Graphics",e[e.Fast_Update=2]="Fast_Update"})(Qs||(Qs={}));class zY{constructor(t){this.schedule=t,this._loadStatus=Bc.LOADING,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(t,i){return this._loadStatus===Bc.LOADED?(t&&t(),this._loader):this._loadStatus===Bc.FAILED?(i&&i(this._loadError),this._loader):(R(this._loader)&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=Bc.LOADED},r=>{throw this._loadError=r,this._abortController=null,this._loadStatus=Bc.FAILED,!Gr(r)&&this.logger&&r.message&&this.logger.warn(r.message),r})),this._loader.then(t,i).catch(()=>{}),this._loader)}abortLoad(){_(this._abortController)?this._abortController=xh(this._abortController):this._loadStatus===Bc.LOADING&&(this._loadStatus=Bc.FAILED),this._loader=null}}var Bc;(function(e){e[e.LOADING=0]="LOADING",e[e.LOADED=1]="LOADED",e[e.FAILED=2]="FAILED"})(Bc||(Bc={}));function wJe(e){switch(e){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function Q1e(e,t){const i=(r,s,n=!1)=>({levels:r.map(o=>{const a=s(o.tesselation);return n&&Nl.cgToGIS(a),{components:[{geometry:a,material:t}],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(e){case"sphere":return i([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],r=>Nl.createPolySphereGeometry(.5,r,!0));case"cube":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Nl.createBoxGeometry(1));case"cone":return i(mz,r=>Nl.createConeGeometry(1,.5,r,!1),!0);case"inverted-cone":return i(mz,r=>Nl.createConeGeometry(1,.5,r,!0),!0);case"cylinder":return i(mz,r=>Nl.createCylinderGeometry(1,.5,r,[0,0,1],[0,0,.5]));case"tetrahedron":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Nl.createTetrahedronGeometry(1),!0);case"diamond":return i([{tesselation:0,minScreenSpaceRadius:0}],()=>Nl.createDiamondGeometry(1),!0);default:return}}const mz=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}];function xJe(e){return e.type==="fill"}function TJe(e){return e.type==="extrude"}function SJe(e){return e&&e.enabled&&(TJe(e)||xJe(e))&&_(e.edges)}function EJe(e){return e&&e.enabled&&e.edges||null}function J1e(e,t){return K1e(EJe(e),t)}function K1e(e,t){if(R(e))return null;const i=_(e.color)?jq(qe.toUnitRGBA(e.color)):fi(0,0,0,0),r=Jn(e.size),s=Jn(e.extensionLength);switch(e.type){case"solid":return ebe(F({color:i,size:r,extensionLength:s},t));case"sketch":return CJe(F({color:i,size:r,extensionLength:s},t));default:return}}function ebe(e){return ve(F(F({},AJe),e),{type:"solid"})}function CJe(e){return ve(F(F({},RJe),e),{type:"sketch"})}const AJe={color:fi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:It.OPAQUE,hasSlicePlane:!1},RJe={color:fi(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:It.OPAQUE,hasSlicePlane:!1};function lI(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.material)})}),dO(t)}function MJe(e){const t=new Array;return e.levels.forEach(i=>{i.components.forEach(r=>{r.textures&&t.push(...r.textures)})}),dO(t)}function VY(e){const t=[];return e.components.forEach(i=>{t.push(i.geometry)}),dO(t)}function OJe(e){const t=[];return e.levels.forEach(i=>{i.components.forEach(r=>{t.push(r.geometry)})}),dO(t)}function PJe(e){return VY(e).reduce((t,i)=>t+i.indexCount/3,0)}const BY={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function h1t(e){return e.type==="web-style"?BY:GY(e.symbolLayers.toArray().map(t=>tbe(e,t)))}function GY(e){let t=0,i=0,r=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of e)R(a)||(t+=a.primitivesPerFeature,i+=a.primitivesPerCoordinate,r+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:t,primitivesPerCoordinate:i,drawCallsPerFeature:r,estimated:s,memory:o,numComplexities:n}}function d1t(e){const t=GY(e);return t.numComplexities>0&&(t.primitivesPerFeature/=t.numComplexities,t.primitivesPerCoordinate/=t.numComplexities,t.drawCallsPerFeature/=t.numComplexities,t.memory.bytesPerFeature/=t.numComplexities,t.memory.bytesPerFeatureLabel/=t.numComplexities,t.memory.bytesPerCoordinate/=t.numComplexities,t.memory.draped.bytesPerFeature/=t.numComplexities,t.memory.draped.bytesPerFeatureLabel/=t.numComplexities,t.memory.draped.bytesPerCoordinate/=t.numComplexities),t}const Xre={};function tbe(e,t){const i=ibe(e,t),r=SJe(t)?2:0;switch(t.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:r,estimated:!1,memory:i};case"fill":return e.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:r,estimated:!1,memory:i}:_(t.outline)&&t.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:i}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:i};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:i};case"object":return t.resource&&t.resource.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:i}:ve(F({},IJe(t.resource&&t.resource.primitive||Phe)),{memory:i});case"path":{let a=0,l=0;switch(t.profile){case"circle":a=10;break;case"quad":a=4;break;default:return void(t.profile,void 0)}switch(t.join){case"round":l=3;break;case"miter":case"bevel":l=1;break;default:return void(t.join,void 0)}const c=2*a,h=a*l*2;let p=-2*h-c;switch(t.cap){case"none":break;case"butt":case"square":p+=2*(a-1);break;case"round":p+=2*(a*(3-1)*2+a);break;default:return}return{primitivesPerFeature:p,primitivesPerCoordinate:h+c,drawCallsPerFeature:0,estimated:!1,memory:i}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:i};default:return}}function ibe(e,t){const i=e.type==="point-3d";switch(t.type){case"extrude":return t.edges&&t.edges.size>0?$a.EXTRUDE_EDGES:$a.EXTRUDE;case"fill":return _(t.outline)&&t.outline.size>0?$a.FILL_OUTLINE:$a.FILL;case"water":return $a.FILL;case"line":return t.join==="round"?$a.LINE_ROUND:$a.LINE_MITER;case"path":switch(t.join){case"round":switch(t.profile){case"circle":return $a.PATH_ROUND_CIRCLE;case"quad":return $a.PATH_ROUND_QUAD;default:return void(t.profile,void 0)}case"miter":case"bevel":switch(t.profile){case"circle":return $a.PATH_MITER_CIRCLE;case"quad":return $a.PATH_MITER_QUAD;default:return void(t.profile,void 0)}default:return void(t.join,void 0)}case"object":return i?$a.OBJECT_POINT:$a.OBJECT_POLYGON;case"icon":case"text":return i?$a.ICON_POINT:$a.ICON_POLYGON;default:return}}function IJe(e){let t=Xre[e];if(t)return t;const i=Q1e(e,null);return t={primitivesPerFeature:VY(i.levels[0]).reduce((r,s)=>r+s.indices.get(A.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},Xre[e]=t,t}const $a={ICON_POINT:{bytesPerFeature:7127.413186968842,bytesPerFeatureLabel:4826.302896296296,bytesPerCoordinate:0,draped:{bytesPerFeature:3929.4396628895197,bytesPerFeatureLabel:3550.1332222222227,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:9329.452613976147,bytesPerFeatureLabel:3675.3372604938268,bytesPerCoordinate:60.177252982212096,draped:{bytesPerFeature:6190.247450139383,bytesPerFeatureLabel:3744.074358024691,bytesPerCoordinate:59.488211068026104}},OBJECT_POINT:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0,draped:{bytesPerFeature:2350.5884192634558,bytesPerFeatureLabel:4446.651003703703,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506,draped:{bytesPerFeature:4583.807620302299,bytesPerFeatureLabel:3665.342685185186,bytesPerCoordinate:60.11621818101506}},LINE_MITER:{bytesPerFeature:7321.028181375921,bytesPerFeatureLabel:4048.0226716049388,bytesPerCoordinate:186.55621386363578,draped:{bytesPerFeature:4246.856619435009,bytesPerFeatureLabel:3852.3737679012347,bytesPerCoordinate:163.47884002621583}},LINE_ROUND:{bytesPerFeature:7482.205842738954,bytesPerFeatureLabel:4045.886987654321,bytesPerCoordinate:191.5452524171851,draped:{bytesPerFeature:4473.481387957992,bytesPerFeatureLabel:3842.1112395061728,bytesPerCoordinate:167.27703460226945}},PATH_MITER_CIRCLE:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275,draped:{bytesPerFeature:9010.489006415351,bytesPerFeatureLabel:4230.9109,bytesPerCoordinate:4618.2594178027275}},PATH_ROUND_CIRCLE:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957,draped:{bytesPerFeature:4104.727250200398,bytesPerFeatureLabel:4251.8525,bytesPerCoordinate:8019.043777064957}},PATH_MITER_QUAD:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203,draped:{bytesPerFeature:9416.372942261387,bytesPerFeatureLabel:4241.2757,bytesPerCoordinate:3176.7222742582203}},PATH_ROUND_QUAD:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826,draped:{bytesPerFeature:6614.431545308682,bytesPerFeatureLabel:4206.7461,bytesPerCoordinate:5141.817789093826}},FILL:{bytesPerFeature:9478.244183633637,bytesPerFeatureLabel:3713.816824691358,bytesPerCoordinate:95.9343604185578,draped:{bytesPerFeature:6287.911108168086,bytesPerFeatureLabel:3790.785032098766,bytesPerCoordinate:83.08783220478168}},FILL_OUTLINE:{bytesPerFeature:13085.871870349445,bytesPerFeatureLabel:3392.613241975309,bytesPerCoordinate:118.63968023169875,draped:{bytesPerFeature:8437.199992480122,bytesPerFeatureLabel:3973.5431172839503,bytesPerCoordinate:106.33556817014312}},EXTRUDE:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477,draped:{bytesPerFeature:19459.53727140414,bytesPerFeatureLabel:3743.7045209876546,bytesPerCoordinate:372.6819978900477}},EXTRUDE_EDGES:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312,draped:{bytesPerFeature:22266.888534913724,bytesPerFeatureLabel:3064.3193358024696,bytesPerCoordinate:374.3725221561312}}},cI=me.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");class Hf extends zY{constructor(t,i,r,s){super(r.schedule),this._context=r,this._elevationInfoOverride=null,this._ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=cI,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.symbol=t,this.symbolLayer=i,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new _u,this.complexity=this.computeComplexity(),this._ignoreDrivers=s.ignoreDrivers,this._ignoreDrivers||(this._drivenProperties=Yre(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(t){if(this._ignoreDrivers)return!1;const i=this._drivenProperties,r=Yre(t);return r.color!==i.color||r.opacity!==i.opacity||r.opacityAlwaysOpaque!==i.opacityAlwaysOpaque||r.size!==i.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(t,i,r,s){const n=t.projectionSuccess,o="polygons"in t?t.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!i.length||i.length===1&&!i[0].length?l=`${a} (no ${r} were defined)`:Array.isArray(i)&&Array.isArray(i[0])?o&&o.length===0&&r==="rings"&&i.length>0&&i[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (${r} should be defined as a 2D array)`:l=`${a} (failed to project geometry to view spatial reference)`,l&&cI.warnOncePerTick(l)}_validateGeometry(t,i=null,r=null){if(_(i)&&!i.includes(t.type))return this.logger.warn("unsupported geometry type for "+r+` symbol: ${t.type}`),!1;if(t.type==="point"){const s=t;if(!isFinite(s.x)||!isFinite(s.y))return cI.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return $Je}_defaultElevationInfoZ(){return DJe}_updateElevationContext(){_(this._elevationInfoOverride)?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(t){return t.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(t,i=this.getDefaultElevationInfo(t)){return this._elevationContext.mode||i.mode}setElevationInfoOverride(t){this._elevationInfoOverride=t,this._updateElevationContext()}setGraphicElevationContext(t,i){const r=t.geometry,s=this.getDefaultElevationInfo(r);i.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,i.mode=this.getGeometryElevationMode(r,s),i.offsetMeters=yt(this._elevationContext.meterUnitOffset,yt(s.offset,0));const n=!this._elevationOptions.supportsOnTheGround&&i.mode==="on-the-ground";n&&(i.mode="relative-to-ground",i.offsetMeters=0);const o=n?_Je:this._elevationContext.featureExpressionInfoContext;return i.updateFeatureExpressionInfoContext(o,t,this._context.layer),i}prepareSymbolLayerPatch(t){}updateGeometry(t,i){return!1}onRemoveGraphic(t){}_getLayerOpacity(){if(this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner)return this._context.graphicsCoreOwner.fullOpacity;const t=this._context.layer.opacity;return t==null?1:t}_getCombinedOpacity(t,i=Zre){let r=1;return this.draped||(r*=this._getLayerOpacity()),this._drivenProperties.opacity||(_(t)?r*=t.a:i.hasIntrinsicColor||(r=0)),r}_getCombinedOpacityAndColor(t,i=Zre){const r=this._getCombinedOpacity(t,i);if(this._drivenProperties.color)return TR(null,r);const s=_(t)?qe.toUnitRGB(t):of;return TR(s,r)}_getVertexOpacityAndColor(t,i=null){const r=this._drivenProperties.color?t.color:null,s=this._drivenProperties.opacity?t.opacity:null,n=TR(r,s);return _(i)&&(n[0]*=i,n[1]*=i,n[2]*=i,n[3]*=i),n}isFastUpdatesEnabled(){return this._fastUpdates&&this._fastUpdates.enabled}computeComplexity(){return tbe(this.symbol,this.symbolLayer)}globalPropertyChanged(t,i,r){switch(t){case"opacity":return this.layerOpacityChanged(i,r);case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(i,r,s)!==Br.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(i,r);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged();default:return!1}}updateGraphics3DGraphicElevationInfo(t,i,r){let s=Br.UPDATE;return t.forEach(n=>{const o=i(n);if(_(o)){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=r(o.elevationContext.mode)}else s=Br.RECREATE}),s}applyRendererDiff(t,i){return Qs.Recreate_Symbol}getFastUpdateAttrValues(t){if(!this._fastUpdates.enabled)return null;const i=this._fastUpdates.visualVariables,r=i.size?cg(i.size.field,t):0,s=i.color?cg(i.color.field,t):0,n=i.opacity?cg(i.opacity.field,t):0;return fi(r,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(t){return this._draped==null?(this._draped=t,!0):(t!==this.draped&&cI.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const t=()=>{var i,r,s,n,o,a,l,c,h,p,f,m,y,v,w,b;return{size:(n=(s=(r=(i=this._fastUpdates)==null?void 0:i.visualVariables)==null?void 0:r.size)==null?void 0:s.field)!=null?n:null,color:(c=(l=(a=(o=this._fastUpdates)==null?void 0:o.visualVariables)==null?void 0:a.color)==null?void 0:l.field)!=null?c:null,opacity:(m=(f=(p=(h=this._fastUpdates)==null?void 0:h.visualVariables)==null?void 0:p.opacity)==null?void 0:f.field)!=null?m:null,rotation:(b=(w=(v=(y=this._fastUpdates)==null?void 0:y.visualVariables)==null?void 0:v.rotation)==null?void 0:w.field)!=null?b:null}};return{drivenProperties:this._drivenProperties,getVisVarFields:t}}}function cg(e,t){const i=e!=null?t.attributes[e]:0;return i!=null&&isFinite(i)?i:0}function Yre(e){const t={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return e&&"visualVariables"in e&&e.visualVariables&&e.visualVariables.forEach(i=>{switch(i.type){case"color":if(t.color=!0,i.stops)for(let r=0;r<i.stops.length;r++){const s=i.stops[r].color;s&&(t.opacity=!0,s.a<1&&(t.opacityAlwaysOpaque=!1))}break;case"opacity":t.opacity=!0,t.opacityAlwaysOpaque=!1;break;case"size":t.size=!0}}),t}const $Je={mode:"on-the-ground",offset:0,unit:"meters"},DJe={mode:"absolute-height",offset:0,unit:"meters"},Zre={hasIntrinsicColor:!1};class Kb{constructor(){this._disposed=!1}get disposed(){return this._disposed}get shaderTransformation(){return this._shaderTransformation}acquire(t,i,r,s,n,o){this.id=sl(),this.geometry=t,this.material=i,this.transformation=r,this.instanceParameters=s,this.origin=n,this._shaderTransformation=o,this._disposed=!1}release(){this._disposed=!1}dispose(){this._disposed=!0}getStaticTransformation(){return this.transformation}getShaderTransformation(){return _(this._shaderTransformation)?this._shaderTransformation(this.transformation):this.transformation}computeAttachmentOrigin(t){return!!(this.material.computeAttachmentOrigin?this.material.computeAttachmentOrigin(this.geometry,t):this.geometry.computeAttachmentOrigin(t))&&(Ue(t,t,this.getStaticTransformation()),!0)}}Kb.pool=new ys(Kb);class _F{constructor(t){this.channel=t,this.id=sl()}}class Hg extends jO{constructor(t={}){super(),this.type=Kd.Object,this._geometryRecords=new Array,this._geometries=new Array,this._objectTransformation=Ae(),this._bvObjectSpace=new Qre,this._bvWorldSpace=new Qre,this._bvDirty=!0,this._hasVolatileTransformation=!1,this._visible=!0,this.castShadow=t.castShadow==null||t.castShadow,this.metadata=t.metadata,this.metadata&&this.metadata.isElevationSource&&(this.metadata.lastValidElevationBB=new rbe),this.transformation=Ae();const{geometries:i,materials:r,transformations:s,origins:n}=t;if(Array.isArray(i)){dt(r.length===i.length,"Object3D: materials don't match geometries"),dt(s.length===i.length,"Object3D: transformations don't match geometries"),this._geometryRecords.length=i.length,this._geometries.length=i.length;for(let o=0;o<i.length;o++)this._geometries[o]=i[o],this._geometryRecords[o]=Kb.pool.acquire(i[o],r[o],fb(s[o]),{highlights:null,occludees:null,visible:this._visible},n&&n[o])}}get geometryRecords(){return this._geometryRecords}get geometries(){return this._geometries}get transformation(){return this._objectTransformation}set transformation(t){ms(this._objectTransformation,t),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}dispose(){this._geometryRecords.length=0,this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(t){dt(this._parentLayer==null||t==null,"Object3D can only be added to a single Layer"),this._parentLayer=t}addGeometry(t,i,r,s,n){r=r||Ks,this._geometries.push(t);const o=Kb.pool.acquire(t,i,r,{highlights:null,occludees:null,visible:this._visible},s,n);return this._geometryRecords.push(o),this._hasVolatileTransformation=this._hasVolatileTransformation||_(o.shaderTransformation),this._emit("objectGeometryAdded",{object:this,record:o}),this._invalidateBoundingVolume(),o}removeGeometry(t){const i=this._geometryRecords.splice(t,1)[0];return this._hasVolatileTransformation=_(i.shaderTransformation)?this._geometryRecords.some(r=>_(r.shaderTransformation)):this._hasVolatileTransformation,i.dispose(),this._geometries.splice(t,1),this._emit("objectGeometryRemoved",{object:this,record:i}),this._invalidateBoundingVolume(),i}removeAllGeometries(){for(;this.geometryRecords.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(t){this._emit("vertexAttrsUpdated",{object:this,record:t}),this._invalidateBoundingVolume()}get isVisible(){return this._visible}setVisible(t){if(this._visible!==t){this._visible=t;for(const i of this._geometryRecords)i.instanceParameters.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const t=new _F(Eg.MaskOccludee);for(const i of this._geometryRecords)i.instanceParameters.occludees=k7(i.instanceParameters.occludees,t);return this._emit("occlusionChanged",this),t}removeOcclude(t){for(const i of this._geometryRecords)i.instanceParameters.occludees=z7(i.instanceParameters.occludees,t);this._emit("occlusionChanged",this)}highlight(){const t=new _F(Eg.Highlight);for(const i of this._geometryRecords)i.instanceParameters.highlights=k7(i.instanceParameters.highlights,t);return this._emit("highlightChanged",this),t}removeHighlight(t){for(const i of this._geometryRecords)i.instanceParameters.highlights=z7(i.instanceParameters.highlights,t);this._emit("highlightChanged",this)}getCombinedStaticTransformation(t,i){return Nr(yt(i,Ae()),this.transformation,t.getStaticTransformation())}_getCombinedShaderTransformation(t,i){return i=i||Ae(),Nr(i,this.transformation,t.getShaderTransformation()),i}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._validateBoundingVolume(),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._validateBoundingVolume(),this._bvObjectSpace}_validateBoundingVolume(){if(!this._bvDirty&&!this._hasVolatileTransformation)return;this._bvObjectSpace.init(),this._bvWorldSpace.init();for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s],o=this._geometryRecords[s],a=n.boundingInfo;_(a)&&(this._calculateTransformedBoundingVolume(a,this._bvObjectSpace,o.getShaderTransformation()),this._calculateTransformedBoundingVolume(a,this._bvWorldSpace,this._getCombinedShaderTransformation(o)))}en(this._bvObjectSpace.bounds,this._bvObjectSpace.min,this._bvObjectSpace.max,.5),en(this._bvWorldSpace.bounds,this._bvWorldSpace.min,this._bvWorldSpace.max,.5);const t=O(),i=O(),r=Lb(this.transformation);for(let s=0;s<this._geometryRecords.length;++s){const n=this._geometries[s].boundingInfo;if(R(n))continue;const o=this._geometryRecords[s].getShaderTransformation(),a=Lb(o);Ue(t,n.getCenter(),o);const l=nr(t,this._bvObjectSpace.bounds),c=n.getBSRadius()*a;this._bvObjectSpace.bounds[3]=Math.max(this._bvObjectSpace.bounds[3],l+c),Ue(i,t,this.transformation);const h=nr(i,this._bvWorldSpace.bounds),p=c*r;this._bvWorldSpace.bounds[3]=Math.max(this._bvWorldSpace.bounds[3],h+p)}this._bvDirty=!1}_calculateTransformedBoundingVolume(t,i,r){const s=t.getBBMin(),n=t.getBBMax(),o=Is(s),a=Is(n);Ue(o,o,r),Ue(a,a,r);for(let l=0;l<3;++l)i.min[l]=Math.min(i.min[l],o[l],a[l]),i.max[l]=Math.max(i.max[l],o[l],a[l]);for(let l=0;l<3;++l){se(o,s),se(a,n),o[l]=n[l],a[l]=s[l],Ue(o,o,r),Ue(a,a,r);for(let c=0;c<3;++c)i.min[c]=Math.min(i.min[c],o[c],a[c]),i.max[c]=Math.max(i.max[c],o[c],a[c])}}_invalidateBoundingVolume(){this._bvDirty=!0,_(this._parentLayer)&&this._parentLayer.notifyObjectBBChanged(this,this._bvWorldSpace.bounds)}_emit(t,i){_(this._parentLayer)&&this._parentLayer.events.emit(t,i)}get test(){const t=this;return{hasGeometry:i=>t._geometries.includes(i),getGeometryIndex:i=>t._geometries.indexOf(i)}}}class rbe{constructor(){this.min=Fe(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Fe(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}}class Qre extends rbe{constructor(){super(...arguments),this.bounds=fn()}init(){ie(this.min,Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),ie(this.max,-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),ppe(this.bounds)}}const W0=O();function jY(e,t,i,r,s,n,o,a){const l=i?i.length:0,c=e.clippingExtent;if(Mn(t,W0,e.elevationProvider.spatialReference),_(c)&&!aq(c,W0))return null;Mn(t,W0,e.renderCoordsHelper.spatialReference);const h=e.localOriginFactory.getOrigin(W0),p=new Hg({castShadow:!1,metadata:{layerUid:n,graphicUid:o,usesVerticalDistanceToGround:!0}});for(let f=0;f<l;f++){const m=Ks;p.addGeometry(i[f],r[f],m,h,a)}return{object:p,sampledElevation:sJe(p,t,e.elevationProvider,e.renderCoordsHelper,s)}}function HM(e,t,i){const r=e.elevationContext,s=i.spatialReference;Mn(t,W0,s),r.centerPointInElevationSR=jg(W0[0],W0[1],t.hasZ?W0[2]:0,s)}function qM(e){switch(e.type){case"point":return e;case"polygon":case"extent":return NY(e);case"polyline":{const t=e.paths[0];if(!t||t.length===0)return null;const i=iue(t,tue(t)/2);return jg(i[0],i[1],i[2],e.spatialReference)}case"mesh":return e.origin}return null}function LJe(e){const t=new Bi;t.include(eY),t.include(J_e,e),t.include(ls,e),t.attributes.add(A.UV0,"vec2");const{vertex:i,fragment:r}=t;return i.uniforms.add([new ei("viewport",(s,n)=>n.camera.fullViewport),new We("lineSize",(s,n)=>Math.ceil(s.size)*n.camera.pixelRatio),new di("pixelToNDC",(s,n)=>hi(Kre,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new We("borderSize",(s,n)=>_(s.borderColor)?n.camera.pixelRatio:0),new di("screenOffset",(s,n)=>hi(Kre,s.screenOffset[0]*n.camera.pixelRatio,s.screenOffset[1]*n.camera.pixelRatio))]),t.varyings.add("coverageSampling","vec4"),t.varyings.add("lineSizes","vec2"),e.hasMultipassGeometry&&t.varyings.add("depth","float"),e.hasScreenSizePerspective&&M5(i),i.code.add(x`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${e.occlusionTestEnabled?x`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${e.hasScreenSizePerspective?x`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:x`
      vec2 screenOffsetScaled = screenOffset;
        `}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly
      // used to get the correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${e.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${e.depthHudEnabled?e.depthHudAlignStartEnabled?x`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:x`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${e.hasScreenSizePerspective?x`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:x`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;
      // Calculate a pixel offset from the edge of the pixel, s.t. we keep the line aligned
      // to pixels if it has a full pixel size. Since pixel aligned biases to the bottom-left,
      // we bias the size to the right (for odd sizes) to balance out the bias. Grow sub-pixel
      // sizes towards the left or right s.t. there is a smooth transition (e.g. from 2 to 3 px).
      float halfWholePixelSize = floor(lineSizeScaled) * 0.5;
      float halfPixelSizeInt = floor(halfWholePixelSize);

      // Sub-pixel offset if we need to grow sub-pixels to the left
      float subpixelOffset = -fract(lineSizeScaled) * float(halfWholePixelSize > 0.0);

      // Pixel offset aligning to whole pixels and adding subpixel offset if needed
      float pixelOffset = -halfPixelSizeInt + subpixelOffset;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (pixelOffset - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),r.uniforms.add([new ei("uColor",s=>Jre(s.color)),new ei("borderColor",s=>Jre(s.borderColor))]),e.hasMultipassGeometry&&(r.include(_ve,e),r.uniforms.add(new di("inverseViewport",(s,n)=>n.inverseViewport))),r.code.add(x`
    void main() {
      ${e.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line
      // blends on top of the border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage
      // and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${e.depthHudEnabled?x`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:x`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      gl_FragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),t}function Jre(e){return _(e)?e:hf}const Kre=tt(),NJe=Object.freeze(Object.defineProperty({__proto__:null,build:LJe},Symbol.toStringTag,{value:"Module"}));class k5 extends lr{initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global}initializeProgram(t){const i=k5.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}setPipelineState(t){const i=t?hr.ALWAYS:hr.LESS;return this.configuration.depthHudEnabled?Ut({depthTest:{func:i},depthWrite:pl}):Ut({blending:so(Re.ONE,Re.SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),depthTest:{func:i},colorWrite:Jt})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}}k5.shader=new Qi(NJe,()=>import("./LineCallout.glsl.908c89d7.js"));class Hu extends Ho{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=el.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}}u([G({count:el.COUNT})],Hu.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([G()],Hu.prototype,"spherical",void 0),u([G()],Hu.prototype,"occlusionTestEnabled",void 0),u([G()],Hu.prototype,"hasVerticalOffset",void 0),u([G()],Hu.prototype,"hasScreenSizePerspective",void 0),u([G()],Hu.prototype,"depthHudEnabled",void 0),u([G()],Hu.prototype,"depthHudAlignStartEnabled",void 0),u([G()],Hu.prototype,"hasSlicePlane",void 0),u([G()],Hu.prototype,"hasMultipassGeometry",void 0),u([G({constValue:!0})],Hu.prototype,"hasSliceInVertexProgram",void 0),u([G({constValue:!1})],Hu.prototype,"isDraped",void 0);class tb extends Gf{constructor(t){super(t,new UJe),this.techniqueConfig=new Hu,this._uniqueMaterialIdentifier=tb.uniqueMaterialIdentifier(this.parameters)}get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}getPassParameters(){return this.parameters}getConfiguration(t,i){const r=(i==null?void 0:i.slot)!==Se.LINE_CALLOUTS;return this.techniqueConfig.occlusionTestEnabled=this.parameters.occlusionTest,this.techniqueConfig.hasVerticalOffset=_(this.parameters.verticalOffset),this.techniqueConfig.hasScreenSizePerspective=_(this.parameters.screenSizePerspective),this.techniqueConfig.depthHudEnabled=r,this.techniqueConfig.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this.techniqueConfig.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?el.Screen:el.World,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasMultipassGeometry=!!i&&i.multipassGeometry.enabled,this.techniqueConfig}intersect(){}requiresSlot(t){switch(t){case Se.LINE_CALLOUTS:case Se.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(t){return t.output===J.Color?new FJe(t):null}createBufferWriter(){return new zJe}validateParameters(t){const i=tb.uniqueMaterialIdentifier(t);i!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=i)}static uniqueMaterialIdentifier(t){return JSON.stringify({screenOffset:t.screenOffset||[0,0],centerOffsetUnits:t.centerOffsetUnits||"world"})}}class FJe extends kv{beginSlot(t){return this.ensureTechnique(k5,t)}}class UJe extends uE{constructor(){super(...arguments),this.screenOffset=Sh,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}}const kJe=Kr().vec3f(A.POSITION).vec3f(A.NORMAL).vec2f(A.UV0).vec4f(A.AUXPOS1),ese=[_a(0,0),_a(1,0),_a(0,1),_a(1,0),_a(1,1),_a(0,1)];class zJe{constructor(){this.vertexBufferLayout=kJe}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return 6*t.indices.get(A.POSITION).length}write(t,i,r,s){P5(i.indices.get(A.POSITION),i.vertexAttributes.get(A.POSITION).data,t.transformation,r.position,s,6),MY(i.indices.get(A.NORMAL),i.vertexAttributes.get(A.NORMAL).data,t.invTranspTransformation,r.normal,s,6),T2(i.indices.get(A.AUXPOS1),i.vertexAttributes.get(A.AUXPOS1).data,r.auxpos1,s,6);for(let n=0;n<ese.length;++n)r.uv0.setVec(s+n,ese[n])}}class z5 extends Hf{constructor(t,i){super(t,null,i,GJe),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new tb(this.materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(t){const i=this.materialParameters;return i.screenOffset=t.screenOffset||Sh,i.centerOffsetUnits=t.centerOffsetUnits||"world",i}get materialParameters(){const t=this.symbol,i=t.callout,r=_(i.color)?qe.toUnitRGBA(i.color):[0,0,0,0];r[3]*=this._getLayerOpacity();const s=Jn(i.size||0);let n=null;if(t.verticalOffset){const{screenLength:p,minWorldLength:f,maxWorldLength:m}=t.verticalOffset;n={screenLength:Jn(p),minWorldLength:f||0,maxWorldLength:m!=null?m:1/0}}const o=_(i.border)&&_(i.border.color)?qe.toUnitRGBA(i.border.color):null,a=t.symbolLayers.getItemAt(0).type==="object",l=!a,c=a?0:void 0,h=t.type==="label-3d";return{color:r,size:s,verticalOffset:n,screenSizePerspective:this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,screenOffset:[0,0],centerOffsetUnits:"world",borderColor:o,occlusionTest:l,shaderPolygonOffset:c,depthHUDAlignStart:h,hasSlicePlane:this._context.slicePlaneEnabled,renderOccluded:Mr.Occlude,__tagStrict:"NoParameters"}}_defaultElevationInfoNoZ(){return BJe}createGraphics3DGraphic(t){const i=t.renderingInfo,r=t.graphic,s=this.setGraphicElevationContext(r,new _u,i.elevationOffset||0),n=i.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!Fhe(l)))return null;const a=NY(r.geometry);return R(a)?null:this._createAs3DShape(a,s,i,r.uid)}layerOpacityChanged(){return R(this._material)||this._material.setParameters(this.materialParameters),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=KO(z5.elevationModeChangeTypes,r,s);return n!==Br.UPDATE||t.forEach(o=>{const a=i(o);_(a)&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return R(this._material)||this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=Oh(i.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:BY.memory}}_createVertexData(t){const{translation:i,centerOffset:r}=t,s=i?{size:3,data:[i[0],i[1],i[2]],exclusive:!0}:{size:3,data:[0,0,0],exclusive:!0},n=r?{size:4,data:[r[0],r[1],r[2],r[3]],exclusive:!0}:{size:4,data:[0,0,0,1],exclusive:!0};return[[A.POSITION,s],[A.NORMAL,{size:3,data:[0,0,1],exclusive:!0}],[A.AUXPOS1,n]]}_getOrCreateMaterial(t){const i=this._perInstanceMaterialParameters(t),r=tb.uniqueMaterialIdentifier(i);if(_(this._material)&&r===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(t.materialCollection){let s=t.materialCollection.get(r);return R(s)&&(s=new tb(i),t.materialCollection.add(r,s)),{material:s,isUnique:!1}}return{material:new tb(i),isUnique:!0}}_createAs3DShape(t,i,r,s){const n=[new Or(this._createVertexData(r),VJe,ll.Point)],o=this._getOrCreateMaterial(r),a=jY(this._context,t,n,[o.material],i,this._context.layer.uid,s);if(a===null)return null;const l=new jf(this,a.object,n,o.isUnique?[o.material]:null,null,jM,i);return l.metadata={elevationOffset:r.elevationOffset||0},l.alignedSampledElevation=a.sampledElevation,l.needsElevationUpdates=Oh(i.mode),HM(l,t,this._context.elevationProvider),l}}z5.elevationModeChangeTypes={definedChanged:Br.UPDATE,staysOnTheGround:Br.UPDATE,onTheGroundChanged:Br.RECREATE};const gz=new Uint16Array([0]),VJe=[[A.POSITION,gz],[A.NORMAL,gz],[A.AUXPOS1,gz]],BJe={mode:"relative-to-ground",offset:0},GJe={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1},tse=me.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function jJe(e,t){if(!Aq(e))return tse.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${e.type}' does not support callouts`),null;if(!e.callout)return null;const i=HJe[e.callout.type];return i?new i(e,t):(tse.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${e.callout.type}`),null)}const HJe={line:z5};class qJe{constructor(t,i,r){this.graphic=t,this.renderingInfo=i,this.layer=r}}const ise=new ys(Array,e=>d4(e,lhe),null,10,5),WJe=Dt();class XJe{constructor(t,i,r,s,n){this.graphic=t,this.graphics3DSymbol=i,this.graphics=r,this._labelGraphics=new Array,this._auxiliaryGraphics=new Array,this._visibilityFlags=YJe(Wn._COUNT,Yc._COUNT),this._featureExpressionFeature=null,this._optimizedGeometry={geometry:null,hasZ:!1,hasM:!1},this._extent=null,this.isElevationSource=!1,++i.referenced,this._featureExpressionFeature=n?X1e(n,t,s):null;for(const o of r)_(o)&&(this.isElevationSource=this.isElevationSource||o.isElevationSource)}get labelGraphics(){return this._labelGraphics}get extent(){return this._extent}initialize(t,i){this._layer=i,this._stage=t,this._forEachSymbolLayerGraphic(r=>{r.initialize(t,i),r.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(t=>t.destroy()),this.graphics=null,this._auxiliaryGraphics=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.graphics==null}clearLabelGraphics(){this._forEachLabelGraphic(t=>t.destroy()),this._labelGraphics.length=0}addLabelGraphic(t,i,r){this._labelGraphics.push(t),t.initialize(i,r),t.setVisibility(this.isVisible(Wn.LABEL))}addAuxiliaryGraphic(t){this._auxiliaryGraphics.push(t),this._layer&&(t.initialize(this._stage,this._layer),t.setVisibility(this.isVisible()))}get isDraped(){let t=!1;return this._forEachSymbolLayerGraphic(i=>{i.type==="draped"&&(t=!0)}),t}isVisible(t=Wn.GRAPHIC,i){for(let r=0;r<=t;r++){const s=this._visibilityFlags[r];for(let n=0;n<s.length;++n)if(s[n]===!1&&n!==i)return!1}return!0}hasVisibilityFlag(t,i){return this._visibilityFlags[i][t]!=null}setVisibilityFlag(t,i,r){const s=this.isVisible(r);this._visibilityFlags[r][t]=i;const n=this.isVisible(r);if(s===n)return!1;if(r===Wn.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(Wn.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}clearVisibilityFlag(t,i=Wn.GRAPHIC){return this.setVisibilityFlag(t,void 0,i)}computeExtent(t){if(!this._extent){const i=this.graphic.geometry;if(R(i))return!1;this._extent=Dt(),qQe(i,this._extent);const r=i.spatialReference;if(!r.equals(t)&&!A4(this._extent,r,this._extent,t))return this._extent=null,!1}return!0}getAsOptimizedGeometry(t,i){return _(this._optimizedGeometry.geometry)&&this._optimizedGeometry.hasZ===t&&this._optimizedGeometry.hasM===i||(this._optimizedGeometry.geometry=this._convertGraphicToOptimizedGeometry(this.graphic,t,i),this._optimizedGeometry.hasZ=t,this._optimizedGeometry.hasM=i),this._optimizedGeometry.geometry}_convertGraphicToOptimizedGeometry(t,i,r){let s=t.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=cu.fromExtent(s.type==="mesh"?s.extent:s)),y4e(s,i,r)}get usedMemory(){let t=qde(this.graphic.attributes);return this._forEachSymbolLayerGraphic(i=>{const r=i.graphics3DSymbolLayer.complexity;if(R(r))return;const s=i.type==="draped"?r.memory.draped:r.memory;t+=s.bytesPerFeature,s.bytesPerCoordinate&&(t+=HQe(this.graphic.geometry)*s.bytesPerCoordinate)}),t}computeAttachmentOrigin(){const t={render:{origin:O(),num:0},draped:{origin:tt(),num:0}};for(const i of this.graphics)R(i)||i.computeAttachmentOrigin(t);return t.render.num&&oe(t.render.origin,t.render.origin,1/t.render.num),t.draped.num&&jl(t.draped.origin,t.draped.origin,1/t.draped.num),t}async getProjectedBoundingBox(t,i,r,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?cr(n.boundingBox):n.boundingBox=cr(),n.requiresDrapedElevation=!1,await B4(this.graphics,async o=>{if(R(o))return;const a=o.type==="draped"?i:t,l=ise.acquire(),c=await o.getProjectedBoundingBox(a,r,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&NS(n.boundingBox,l),ise.release(l)}),lRe(n.boundingBox)||iB(lq(n.boundingBox,WJe))?n:null}needsElevationUpdates(){for(const t of this.graphics)if(_(t)&&(t.type==="object3d"||t.type==="lod-instance")&&t.needsElevationUpdates)return!0;for(const t of this._labelGraphics)if(t&&t.needsElevationUpdates)return!0;return!1}alignWithElevation(t,i,r){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(t,i,this._featureExpressionFeature,r)})}addObjectStateSet(t,i){this._forEachSymbolLayerGraphic(r=>r.addObjectState(t,i))}removeObjectState(t){this._forEachSymbolLayerGraphic(i=>i.removeObjectState(t))}_forEachGraphicList(t,i){t.forEach(r=>r&&i(r))}_forEachSymbolLayerGraphic(t){this._forEachGraphicList(this.graphics,t),this._forEachGraphicList(this._auxiliaryGraphics,t)}_forEachLabelGraphic(t){this._forEachGraphicList(this._labelGraphics,t)}_forEachRenderedGraphic(t){this._forEachSymbolLayerGraphic(t),this._forEachLabelGraphic(t)}}function YJe(e,t){const i=new Array(e);for(let r=0;r<i.length;r++)i[r]=new Array(t);return i}var rse,sse,nse,sbe={exports:{}};rse=sbe,sse=function(){function e($,U,B){B=B||2;var H,W,K,j,ee,ye,Te,Ne=U&&U.length,_e=Ne?U[0]*B:$.length,ge=t($,0,_e,B,!0),Ce=[];if(!ge||ge.next===ge.prev)return Ce;if(Ne&&(ge=l($,U,ge,B)),$.length>80*B){H=K=$[0],W=j=$[1];for(var Le=B;Le<_e;Le+=B)(ee=$[Le])<H&&(H=ee),(ye=$[Le+1])<W&&(W=ye),ee>K&&(K=ee),ye>j&&(j=ye);Te=(Te=Math.max(K-H,j-W))!==0?1/Te:0}return r(ge,Ce,B,H,W,Te),Ce}function t($,U,B,H,W){var K,j;if(W===ne($,U,B,H)>0)for(K=U;K<B;K+=H)j=Y(K,$[K],$[K+1],j);else for(K=B-H;K>=U;K-=H)j=Y(K,$[K],$[K+1],j);if(j&&C(j,j.next)){var ee=j.next;Z(j),j=ee}return j}function i($,U){if(!$)return $;U||(U=$);var B,H=$;do if(B=!1,H.steiner||!C(H,H.next)&&E(H.prev,H,H.next)!==0)H=H.next;else{var W=H.prev;if(Z(H),(H=U=W)===H.next)break;B=!0}while(B||H!==U);return U}function r($,U,B,H,W,K,j){if($){!j&&K&&y($,H,W,K);for(var ee,ye,Te=$;$.prev!==$.next;)if(ee=$.prev,ye=$.next,K?n($,H,W,K):s($))U.push(ee.i/B),U.push($.i/B),U.push(ye.i/B),Z($),$=ye.next,Te=ye.next;else if(($=ye)===Te){j?j===1?r($=o(i($),U,B),U,B,H,W,K,2):j===2&&a($,U,B,H,W,K):r(i($),U,B,H,W,K,1);break}}}function s($){var U=$.prev,B=$,H=$.next;if(E(U,B,H)>=0)return!1;for(var W=$.next.next;W!==$.prev;){if(S(U.x,U.y,B.x,B.y,H.x,H.y,W.x,W.y)&&E(W.prev,W,W.next)>=0)return!1;W=W.next}return!0}function n($,U,B,H){var W=$.prev,K=$,j=$.next;if(E(W,K,j)>=0)return!1;for(var ee=W.x<K.x?W.x<j.x?W.x:j.x:K.x<j.x?K.x:j.x,ye=W.y<K.y?W.y<j.y?W.y:j.y:K.y<j.y?K.y:j.y,Te=W.x>K.x?W.x>j.x?W.x:j.x:K.x>j.x?K.x:j.x,Ne=W.y>K.y?W.y>j.y?W.y:j.y:K.y>j.y?K.y:j.y,_e=w(ee,ye,U,B,H),ge=w(Te,Ne,U,B,H),Ce=$.prevZ,Le=$.nextZ;Ce&&Ce.z>=_e&&Le&&Le.z<=ge;){if(Ce!==$.prev&&Ce!==$.next&&S(W.x,W.y,K.x,K.y,j.x,j.y,Ce.x,Ce.y)&&E(Ce.prev,Ce,Ce.next)>=0||(Ce=Ce.prevZ,Le!==$.prev&&Le!==$.next&&S(W.x,W.y,K.x,K.y,j.x,j.y,Le.x,Le.y)&&E(Le.prev,Le,Le.next)>=0))return!1;Le=Le.nextZ}for(;Ce&&Ce.z>=_e;){if(Ce!==$.prev&&Ce!==$.next&&S(W.x,W.y,K.x,K.y,j.x,j.y,Ce.x,Ce.y)&&E(Ce.prev,Ce,Ce.next)>=0)return!1;Ce=Ce.prevZ}for(;Le&&Le.z<=ge;){if(Le!==$.prev&&Le!==$.next&&S(W.x,W.y,K.x,K.y,j.x,j.y,Le.x,Le.y)&&E(Le.prev,Le,Le.next)>=0)return!1;Le=Le.nextZ}return!0}function o($,U,B){var H=$;do{var W=H.prev,K=H.next.next;!C(W,K)&&M(W,H,H.next,K)&&z(W,K)&&z(K,W)&&(U.push(W.i/B),U.push(H.i/B),U.push(K.i/B),Z(H),Z(H.next),H=$=K),H=H.next}while(H!==$);return i(H)}function a($,U,B,H,W,K){var j=$;do{for(var ee=j.next.next;ee!==j.prev;){if(j.i!==ee.i&&T(j,ee)){var ye=k(j,ee);return j=i(j,j.next),ye=i(ye,ye.next),r(j,U,B,H,W,K),void r(ye,U,B,H,W,K)}ee=ee.next}j=j.next}while(j!==$)}function l($,U,B,H){var W,K,j,ee=[];for(W=0,K=U.length;W<K;W++)(j=t($,U[W]*H,W<K-1?U[W+1]*H:$.length,H,!1))===j.next&&(j.steiner=!0),ee.push(b(j));for(ee.sort(c),W=0;W<ee.length;W++)B=i(B=p(ee[W],B),B.next);return B}function c($,U){return $.x-U.x}function h($){if($.next.prev===$)return $;let U=$;for(;;){const B=U.next;if(B.prev===U||B===U||B===$)break;U=B}return U}function p($,U){var B=f($,U);if(!B)return U;var H=k(B,$),W=i(B,B.next);let K=h(H);return i(K,K.next),W=h(W),h(U===B?W:U)}function f($,U){var B,H=U,W=$.x,K=$.y,j=-1/0;do{if(K<=H.y&&K>=H.next.y&&H.next.y!==H.y){var ee=H.x+(K-H.y)*(H.next.x-H.x)/(H.next.y-H.y);if(ee<=W&&ee>j){if(j=ee,ee===W){if(K===H.y)return H;if(K===H.next.y)return H.next}B=H.x<H.next.x?H:H.next}}H=H.next}while(H!==U);if(!B)return null;if(W===j)return B;var ye,Te=B,Ne=B.x,_e=B.y,ge=1/0;H=B;do W>=H.x&&H.x>=Ne&&W!==H.x&&S(K<_e?W:j,K,Ne,_e,K<_e?j:W,K,H.x,H.y)&&(ye=Math.abs(K-H.y)/(W-H.x),z(H,$)&&(ye<ge||ye===ge&&(H.x>B.x||H.x===B.x&&m(B,H)))&&(B=H,ge=ye)),H=H.next;while(H!==Te);return B}function m($,U){return E($.prev,$,U.prev)<0&&E(U.next,$,$.next)<0}function y($,U,B,H){var W=$;do W.z===null&&(W.z=w(W.x,W.y,U,B,H)),W.prevZ=W.prev,W.nextZ=W.next,W=W.next;while(W!==$);W.prevZ.nextZ=null,W.prevZ=null,v(W)}function v($){var U,B,H,W,K,j,ee,ye,Te=1;do{for(B=$,$=null,K=null,j=0;B;){for(j++,H=B,ee=0,U=0;U<Te&&(ee++,H=H.nextZ);U++);for(ye=Te;ee>0||ye>0&&H;)ee!==0&&(ye===0||!H||B.z<=H.z)?(W=B,B=B.nextZ,ee--):(W=H,H=H.nextZ,ye--),K?K.nextZ=W:$=W,W.prevZ=K,K=W;B=H}K.nextZ=null,Te*=2}while(j>1);return $}function w($,U,B,H,W){return($=1431655765&(($=858993459&(($=252645135&(($=16711935&(($=32767*($-B)*W)|$<<8))|$<<4))|$<<2))|$<<1))|(U=1431655765&((U=858993459&((U=252645135&((U=16711935&((U=32767*(U-H)*W)|U<<8))|U<<4))|U<<2))|U<<1))<<1}function b($){var U=$,B=$;do(U.x<B.x||U.x===B.x&&U.y<B.y)&&(B=U),U=U.next;while(U!==$);return B}function S($,U,B,H,W,K,j,ee){return(W-j)*(U-ee)-($-j)*(K-ee)>=0&&($-j)*(H-ee)-(B-j)*(U-ee)>=0&&(B-j)*(K-ee)-(W-j)*(H-ee)>=0}function T($,U){return $.next.i!==U.i&&$.prev.i!==U.i&&!D($,U)&&(z($,U)&&z(U,$)&&V($,U)&&(E($.prev,$,U.prev)||E($,U.prev,U))||C($,U)&&E($.prev,$,$.next)>0&&E(U.prev,U,U.next)>0)}function E($,U,B){return(U.y-$.y)*(B.x-U.x)-(U.x-$.x)*(B.y-U.y)}function C($,U){return $.x===U.x&&$.y===U.y}function M($,U,B,H){var W=N(E($,U,B)),K=N(E($,U,H)),j=N(E(B,H,$)),ee=N(E(B,H,U));return W!==K&&j!==ee||!(W!==0||!I($,B,U))||!(K!==0||!I($,H,U))||!(j!==0||!I(B,$,H))||!(ee!==0||!I(B,U,H))}function I($,U,B){return U.x<=Math.max($.x,B.x)&&U.x>=Math.min($.x,B.x)&&U.y<=Math.max($.y,B.y)&&U.y>=Math.min($.y,B.y)}function N($){return $>0?1:$<0?-1:0}function D($,U){var B=$;do{if(B.i!==$.i&&B.next.i!==$.i&&B.i!==U.i&&B.next.i!==U.i&&M(B,B.next,$,U))return!0;B=B.next}while(B!==$);return!1}function z($,U){return E($.prev,$,$.next)<0?E($,U,$.next)>=0&&E($,$.prev,U)>=0:E($,U,$.prev)<0||E($,$.next,U)<0}function V($,U){var B=$,H=!1,W=($.x+U.x)/2,K=($.y+U.y)/2;do B.y>K!=B.next.y>K&&B.next.y!==B.y&&W<(B.next.x-B.x)*(K-B.y)/(B.next.y-B.y)+B.x&&(H=!H),B=B.next;while(B!==$);return H}function k($,U){var B=new le($.i,$.x,$.y),H=new le(U.i,U.x,U.y),W=$.next,K=U.prev;return $.next=U,U.prev=$,B.next=W,W.prev=B,H.next=B,B.prev=H,K.next=H,H.prev=K,H}function Y($,U,B,H){var W=new le($,U,B);return H?(W.next=H.next,W.prev=H,H.next.prev=W,H.next=W):(W.prev=W,W.next=W),W}function Z($){$.next.prev=$.prev,$.prev.next=$.next,$.prevZ&&($.prevZ.nextZ=$.nextZ),$.nextZ&&($.nextZ.prevZ=$.prevZ)}function le($,U,B){this.i=$,this.x=U,this.y=B,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ne($,U,B,H){for(var W=0,K=U,j=B-H;K<B;K+=H)W+=($[j]-$[K])*($[K+1]+$[j+1]),j=K;return W}return e.deviation=function($,U,B,H){var W=U&&U.length,K=W?U[0]*B:$.length,j=Math.abs(ne($,0,K,B));if(W)for(var ee=0,ye=U.length;ee<ye;ee++){var Te=U[ee]*B,Ne=ee<ye-1?U[ee+1]*B:$.length;j-=Math.abs(ne($,Te,Ne,B))}var _e=0;for(ee=0;ee<H.length;ee+=3){var ge=H[ee]*B,Ce=H[ee+1]*B,Le=H[ee+2]*B;_e+=Math.abs(($[ge]-$[Le])*($[Ce+1]-$[ge+1])-($[ge]-$[Ce])*($[Le+1]-$[ge+1]))}return j===0&&_e===0?0:Math.abs((_e-j)/j)},e.flatten=function($){for(var U=$[0][0].length,B={vertices:[],holes:[],dimensions:U},H=0,W=0;W<$.length;W++){for(var K=0;K<$[W].length;K++)for(var j=0;j<U;j++)B.vertices.push($[W][K][j]);W>0&&(H+=$[W-1].length,B.holes.push(H))}return B},e},(nse=sse())!==void 0&&(rse.exports=nse);const C2=sbe.exports,V5=me.getLogger("esri.views.3d.support.buffer.math");function t3(e,t,i){if(e.count!==t.count)return void V5.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[4],l=i[5],c=i[6],h=i[8],p=i[9],f=i[10],m=i[12],y=i[13],v=i[14],w=e.typedBuffer,b=e.typedBufferStride,S=t.typedBuffer,T=t.typedBufferStride;for(let E=0;E<r;E++){const C=E*b,M=E*T,I=S[M],N=S[M+1],D=S[M+2];w[C]=s*I+a*N+h*D+m,w[C+1]=n*I+l*N+p*D+y,w[C+2]=o*I+c*N+f*D+v}}function Mv(e,t,i){if(e.count!==t.count)return void V5.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],m=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,w=t.typedBufferStride;for(let b=0;b<r;b++){const S=b*y,T=b*w,E=v[T],C=v[T+1],M=v[T+2];m[S]=s*E+a*C+h*M,m[S+1]=n*E+l*C+p*M,m[S+2]=o*E+c*C+f*M}}function tj(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2]}}function HY(e,t){const i=Math.min(e.count,t.count),r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride;for(let a=0;a<i;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);r[l]=y*h,r[l+1]=y*p,r[l+2]=y*f}}}function ZJe(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i}}Object.freeze(Object.defineProperty({__proto__:null,transformMat4:t3,transformMat3:Mv,scale:tj,normalize:HY,shiftRight:ZJe},Symbol.toStringTag,{value:"Module"}));function B5(e,t){if(!e||e.symbol)return null;const i=t&&t.renderer;return e&&_(i)&&i.getObservationRenderer?i.getObservationRenderer(e):i}function QJe(e,t){if(_(e.symbol))return e.symbol;const i=B5(e,t);return _(i)&&i.type!=="dot-density"?i.getSymbol(e,t):null}function p1t(e,t){const i=B5(e,t),r=QJe(e,t);if(R(r))return null;const s={renderer:i,symbol:r};if(R(i)||!("visualVariables"in i)||!i.visualVariables)return s;const n=YW(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function JJe(e,t){if(_(e.symbol))return e.symbol;const i=B5(e,t);return _(i)&&i.getSymbolAsync(e,t)}async function f1t(e,t){const i=B5(e,t),r=await JJe(e,t);if(!r)return null;const s={renderer:i,symbol:r};if(!i||!("visualVariables"in i)||!i.visualVariables)return s;const n=YW(i,e,t),o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=qe.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function KJe(e,t=0){const i=e[t];return typeof i=="number"&&isFinite(i)?i:null}function eKe(e){for(let t=0;t<3;t++){const i=e[t];if(typeof i=="number")return isFinite(i)?i:0}return 0}function nbe(e,t,i){var C;const r=e.byteLength/(4*t),s=new Uint32Array(e,0,r*t);let n=new Uint32Array(r);const o=(C=i==null?void 0:i.minReduction)!=null?C:0,a=(i==null?void 0:i.originalIndices)||null,l=a?a.length:0,c=(i==null?void 0:i.componentOffsets)||null;let h=0;if(c)for(let M=0;M<c.length-1;M++){const I=c[M+1]-c[M];I>h&&(h=I)}else h=r;const p=Math.floor(1.1*h)+1;(ap==null||ap.length<2*p)&&(ap=new Uint32Array(wS(2*p)));for(let M=0;M<2*p;M++)ap[M]=0;let f=0;const m=!!c&&!!a,y=m?l:r,v=m?new Uint32Array(l):null,w=1.96;let b=o!==0?Math.ceil(4*w*w/(o*o)*o*(1-o)):y,S=1,T=c?c[1]:y;for(let M=0;M<y;M++){if(M===b){const k=1-f/M;if(k+w*Math.sqrt(k*(1-k)/M)<o)return null;b*=2}if(M===T){for(let k=0;k<2*p;k++)ap[k]=0;if(a)for(let k=c[S-1];k<c[S];k++)v[k]=n[a[k]];T=c[++S]}const I=m?a[M]:M,N=I*t,D=rKe(s,N,t);let z=D%p,V=f;for(;ap[2*z+1]!==0;){if(ap[2*z]===D){const k=ap[2*z+1]-1;if(tKe(s,N,k*t,t)){V=n[k];break}}z++,z>=p&&(z-=p)}V===f&&(ap[2*z]=D,ap[2*z+1]=I+1,f++),n[I]=V}if(o!==0&&1-f/r<o)return null;if(m){for(let M=c[S-1];M<v.length;M++)v[M]=n[a[M]];n=v}const E=new Uint32Array(t*f);f=0;for(let M=0;M<y;M++)n[M]===f&&(iKe(s,(m?a[M]:M)*t,E,f*t,t),f++);if(a&&!m){const M=new Uint32Array(l);for(let I=0;I<M.length;I++)M[I]=n[a[I]];n=M}return{buffer:E.buffer,indices:n,uniqueCount:f}}function tKe(e,t,i,r){for(let s=0;s<r;s++)if(e[t+s]!==e[i+s])return!1;return!0}function iKe(e,t,i,r,s){for(let n=0;n<s;n++)i[r+n]=e[t+n]}function rKe(e,t,i){let r=0;for(let s=0;s<i;s++)r=e[t+s]+r|0,r=r+(r<<11)+(r>>>2)|0;return r>>>0}let ap=null;function m1t(e){const t=i3(e.rings,e.hasZ,Of.CCW_IS_HOLE),i=[];let r=0,s=0;for(const a of t.polygons){const l=a.count,c=a.index,h=new Float64Array(t.position.buffer,3*c*t.position.BYTES_PER_ELEMENT,3*l),p=a.holeIndices.map(m=>m-c),f=new Uint32Array(C2(h,p,3));i.push({position:h,faces:f}),r+=h.length,s+=f.length}const n=sKe(i,r,s),o=nbe(n.position.buffer,6,{originalIndices:n.faces});return n.position=new Float64Array(o.buffer),n.faces=o.indices,n}function sKe(e,t,i){if(e.length===1)return e[0];const r=new Float64Array(t),s=new Uint32Array(i);let n=0,o=0,a=0;for(const l of e){for(let c=0;c<l.position.length;c++)r[n++]=l.position[c];for(let c=0;c<l.faces.length;c++)s[o++]=l.faces[c]+a;a=n/3}return{position:r,faces:s}}function i3(e,t,i){const r=e.length,s=new Array(r),n=new Array(r),o=new Array(r);let a=0,l=0,c=0,h=0;for(let m=0;m<r;++m)h+=e[m].length;const p=new Float64Array(3*h);let f=0;for(let m=r-1;m>=0;m--){const y=e[m],v=i===Of.CCW_IS_HOLE&&nKe(y);if(v&&r!==1)s[a++]=y;else{let w=y.length;for(let S=0;S<a;++S)w+=s[S].length;const b={index:f,pathLengths:new Array(a+1),count:w,holeIndices:new Array(a)};b.pathLengths[0]=y.length,y.length>0&&(o[c++]={index:f,count:y.length}),f=v?uI(y,y.length-1,-1,p,f,y.length,t):uI(y,0,1,p,f,y.length,t);for(let S=0;S<a;++S){const T=s[S];b.holeIndices[S]=f,b.pathLengths[S+1]=T.length,T.length>0&&(o[c++]={index:f,count:T.length}),f=uI(T,0,1,p,f,T.length,t)}a=0,b.count>0&&(n[l++]=b)}}for(let m=0;m<a;++m){const y=s[m];y.length>0&&(o[c++]={index:f,count:y.length}),f=uI(y,0,1,p,f,y.length,t)}return l<r&&(n.length=l),c<r&&(o.length=c),{position:p,polygons:n,outlines:o}}function uI(e,t,i,r,s,n,o){s*=3;for(let a=0;a<n;++a){const l=e[t];r[s++]=l[0],r[s++]=l[1],r[s++]=o?l[2]:0,t+=i}return s/3}function nKe(e){return!BH(e,!1,!1)}var Of;(function(e){e[e.NONE=0]="NONE",e[e.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(Of||(Of={}));var SR,ij;(function(e){e[e.RasterImage=0]="RasterImage",e[e.Features=1]="Features"})(SR||(SR={})),function(e){e[e.WithRasterImage=0]="WithRasterImage",e[e.WithoutRasterImage=1]="WithoutRasterImage"}(ij||(ij={}));var Pr,lh,Nt,A2,fs,An;(function(e){e[e.INNER=0]="INNER",e[e.OUTER=1]="OUTER"})(Pr||(Pr={})),function(e){e[e.REGULAR=0]="REGULAR",e[e.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",e[e.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",e[e.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(lh||(lh={})),function(e){e[e.NORTH=0]="NORTH",e[e.NORTH_EAST=1]="NORTH_EAST",e[e.EAST=2]="EAST",e[e.SOUTH_EAST=3]="SOUTH_EAST",e[e.SOUTH=4]="SOUTH",e[e.SOUTH_WEST=5]="SOUTH_WEST",e[e.WEST=6]="WEST",e[e.NORTH_WEST=7]="NORTH_WEST"}(Nt||(Nt={})),function(e){e[e.OFF=0]="OFF",e[e.ON=1]="ON"}(A2||(A2={})),function(e){e[e.Color=0]="Color",e[e.ColorNoRasterImage=1]="ColorNoRasterImage",e[e.Highlight=2]="Highlight",e[e.Water=3]="Water",e[e.Occluded=4]="Occluded"}(fs||(fs={})),function(e){e[e.FADING=0]="FADING",e[e.IMMEDIATE=1]="IMMEDIATE",e[e.UNFADED=2]="UNFADED"}(An||(An={}));class oKe{constructor(t,i){this.vec3=t,this.id=i}}function ER(e,t,i,r){return new oKe(Fe(e,t,i),r)}var ga;(function(e){e[e.None=0]="None",e[e.ColorAndWater=1]="ColorAndWater",e[e.Highlight=2]="Highlight",e[e.Occluded=3]="Occluded"})(ga||(ga={}));class ose{constructor(t,i){this.index=t,this.renderTargets=i,this._extent=Dt(),this.resolution=0,this.renderLocalOrigin=ER(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new lKe,this.validTargets=null,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=t,this.validTargets=new Array(i.renderTargets.length).fill(!1)}get extent(){return this._extent}getValidTexture(t){return this.validTargets[t]?this.renderTargets.getTarget(t).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(t){const i=t===ga.ColorAndWater?this.renderTargets.getTarget(fs.Color):t===ga.Highlight?this.renderTargets.getTarget(fs.Highlight):this.renderTargets.getTarget(fs.Occluded);return i?i.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(fs.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(fs.Color):null}getNormalTexture(t){const i=t===ga.ColorAndWater?this.renderTargets.getTarget(fs.Water):null;return i?i.getTexture():null}draw(t,i){const r=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==fs.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=t.drawTarget(this,s,i):this.validTargets[s.type]=!1;return r^this.computeRenderTargetValidityBitfield()?c2.CHANGED:c2.UNCHANGED}computeRenderTargetValidityBitfield(){const t=this.validTargets;return+t[fs.Color]|+t[fs.ColorNoRasterImage]<<1|+t[fs.Highlight]<<2|+t[fs.Water]<<3|+t[fs.Occluded]<<4}setupGeometryViewsCyclical(t){this.setupGeometryViewsDirect();const i=.001*t.range;if(this._extent[0]-i<=t.min){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];rN(this._extent,t.range,0,r)}if(this._extent[2]+i>=t.max){const r=this.canvasGeometries.extents[this.canvasGeometries.numViews++];rN(this._extent,-t.range,0,r)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,vg(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let t=0;t<this.canvasGeometries.numViews;t++){const i=this.canvasGeometries.extents[t];if(i[0]!==i[2]&&i[1]!==i[3])return!0}return!1}applyViewport(t){t.setViewport(this.index===Pr.INNER?0:this.resolution,0,this.resolution,this.resolution)}}function aKe(e,t,i){return Math.min(wS(Math.max(e,t)+256),i)}class lKe{constructor(){this.extents=[Dt(),Dt(),Dt()],this.numViews=0}}class obe{constructor(t,i){this.size=WX(),this._fbo=null,this._fbo=new xr(t,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR_MIPMAP_LINEAR,hasMipmap:i,maxAnisotropy:8,width:0,height:0})}dispose(){this._fbo=Ye(this._fbo)}getTexture(){return this._fbo?this._fbo.colorTexture:null}isValid(){return this._fbo!==null}resize(t,i){this.size[0]=t,this.size[1]=i,this._fbo.resize(this.size[0],this.size[1])}bind(t){t.bindFramebuffer(this._fbo)}generateMipMap(){this._fbo.colorTexture.descriptor.hasMipmap&&this._fbo.colorTexture.generateMipmap()}disposeRenderTargetMemory(){var t;(t=this._fbo)==null||t.resize(0,0)}get gpuMemoryUsage(){var t,i;return(i=(t=this._fbo)==null?void 0:t.gpuMemoryUsage)!=null?i:0}}class cKe{constructor(t){const i=(r,s,n=!0)=>({type:s,fbo:new obe(t,n),renderPass:r,valid:!1,lastUsed:1/0});this.renderTargets=[i(je.MATERIAL,fs.Color),i(je.MATERIAL,fs.ColorNoRasterImage),i(je.MATERIAL_HIGHLIGHT,fs.Highlight,!1),i(je.MATERIAL_NORMAL,fs.Water),i(je.MATERIAL,fs.Occluded)]}getTarget(t){return this.renderTargets[t].fbo}dispose(){for(const t of this.renderTargets)t.fbo.dispose()}disposeRenderTargetMemory(){for(const t of this.renderTargets)t.fbo.disposeRenderTargetMemory()}validateUsageForTarget(t,i,r){if(t)i.lastUsed=r;else if(r-i.lastUsed>uKe)i.fbo.disposeRenderTargetMemory(),i.lastUsed=1/0;else if(i.lastUsed<1/0)return!0;return!1}get gpuMemoryUsage(){return this.renderTargets.reduce((t,i)=>t+i.fbo.gpuMemoryUsage,0)}}const uKe=1e3;class qY{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(t,i){var r;return(r=this._outer.get(t))==null?void 0:r.get(i)}set(t,i,r){const s=this._outer.get(t);s?s.set(i,r):this._outer.set(t,new Map([[i,r]]))}delete(t,i){const r=this._outer.get(t);r&&(r.delete(i),r.size===0&&this._outer.delete(t))}forEach(t){this._outer.forEach((i,r)=>t(i,r))}}class abe{constructor(t){this._context=t,this._perConstructorInstances=new qY,this._frameCounter=0,this._keepAliveFrameCount=ase}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}dispose(){this._perConstructorInstances.forEach(t=>t.forEach(i=>i.technique.destroy())),this._perConstructorInstances.clear()}acquire(t,i){const r=i.key;let s=this._perConstructorInstances.get(t,r);if(R(s)){const n=new t(this._context,i,()=>this.release(n));s=new hKe(n),this._perConstructorInstances.set(t,r,s)}return++s.refCount,s.technique}releaseAndAcquire(t,i,r){if(_(r)){if(i.key===r.key)return r;this.release(r)}return this.acquire(t,i)}release(t){if(R(t)||this._perConstructorInstances.empty)return;const i=this._perConstructorInstances.get(t.constructor,t.key);R(i)||(--i.refCount,i.refCount===0&&(i.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==ase&&this._perConstructorInstances.forEach((t,i)=>{t.forEach((r,s)=>{r.refCount===0&&r.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(r.technique.destroy(),this._perConstructorInstances.delete(i,s))})})}async reloadAll(){const t=new Array;this._perConstructorInstances.forEach((i,r)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>{l.technique.reload(this._context)}))};t.push(s(i,r))}),await Promise.all(t)}}class hKe{constructor(t){this.technique=t,this.refCount=0,this.refZeroFrame=0}}const ase=-1,G5=e=>{class t extends e{constructor(){super(...arguments),this._isDisposed=!1}dispose(){var r;for(const s of(r=this._managedDisposables)!=null?r:[]){const n=this[s];this[s]=null,n&&typeof n.dispose=="function"&&n.dispose()}this._isDisposed=!0}get isDisposed(){return this._isDisposed}}return t};class j5 extends G5(class{}){}function go(){return(e,t)=>{var i,r;e.hasOwnProperty("_managedDisposables")||(e._managedDisposables=(r=(i=e._managedDisposables)==null?void 0:i.slice())!=null?r:[]),e._managedDisposables.unshift(t)}}const dKe=me.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository");class lbe{constructor(t,i,r,s){this._textureRepository=t,this._techniqueRepository=i,this.materialChanged=r,this.requestRender=s,this._id2glMaterialRef=new qY}dispose(){this._textureRepository.dispose()}acquire(t,i){this._ownMaterial(t);let r=this._id2glMaterialRef.get(i,t.id);if(R(r)){const s=t.createGLMaterial({material:t,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});r=new pKe(s),this._id2glMaterialRef.set(i,t.id,r)}return r.ref(),r.glMaterial}release(t,i){const r=this._id2glMaterialRef.get(i,t.id);_(r)&&(r.unref(),r.referenced||(Ye(r.glMaterial),this._id2glMaterialRef.delete(i,t.id)))}_ownMaterial(t){_(t.repository)&&t.repository!==this&&dKe.error("Material is already owned by a different material repository"),t.repository=this}}class pKe{constructor(t){this.glMaterial=t,this.refCnt=0}ref(){++this.refCnt}unref(){--this.refCnt,dt(this.refCnt>=0)}get referenced(){return this.refCnt>0}}const fKe={orderedRepackingEnabled:!1},mKe={rootOrigin:null},gKe=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","vertexAttrsUpdated"];class R2{constructor(t,i){this._objectToBoundingSphere=t,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new Wr,this._objectCount=0,i&&(i.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=i.maximumObjectsPerNode),i.maximumDepth!==void 0&&(this._maximumDepth=i.maximumDepth))}get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}destroy(){this._degenerateObjects.clear(),Wr.clearPool(),rj[0]=null,u_.prune(),p1.prune()}add(t,i=t.length){this._objectCount+=i,this._grow(t,i);const r=Wr.acquire();for(let s=0;s<i;s++){const n=t[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(r.init(this._root),this._add(n,r))}Wr.release(r)}remove(t,i=null){this._objectCount-=t.length;const r=Wr.acquire();for(const s of t){const n=_(i)?i:HS(this._objectToBoundingSphere(s),wKe);PA(n[3])?(r.init(this._root),this._remove(s,n,r)):this._degenerateObjects.delete(s)}Wr.release(r),this._shrink()}update(t,i){if(!PA(i[3])&&this._isDegenerate(t))return;const r=bKe(t);this.remove(r,i),this.add(r)}forEachAlongRay(t,i,r){const s=mu(t,i);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&r(a)}),!0})}forEachAlongRayWithVerticalOffset(t,i,r,s){const n=mu(t,i);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&r(l)}),!0})}forEach(t){this._forEachNode(this._root,i=>{const r=i.node;return r.terminals.forAll(t),r.residents!==null&&r.residents.forAll(t),!0}),this._degenerateObjects.forEach(t)}forEachDegenerateObject(t){this._degenerateObjects.forEach(t)}findClosest(t,i,r,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=yz(t,i),h=p=>{if(--n,!s(p))return;const f=this._objectToBoundingSphere(p);if(!H0(r,f))return;const m=v0(t,i,f),y=m-f[3],v=m+f[3];y<o&&(o=y,a=v,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!H0(r,p.bounds)||(oe(Cu,c,p.halfSize),de(Cu,Cu,p.bounds),v0(t,i,Cu)>a))return!1;const f=p.node;return f.terminals.forAll(m=>h(m)),f.residents!==null&&f.residents.forAll(m=>h(m)),!0},t,i),l}forEachInDepthRange(t,i,r,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:v=>{r===R2.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,v.near),c=Math.min(c,v.far)):(l=Math.max(l,-v.far),c=Math.min(c,-v.near))}};h.setRange(s);const p=v0(i,r,t),f=yz(i,r),m=yz(i,-r),y=v=>{if(!a(v))return;const w=this._objectToBoundingSphere(v),b=w,S=v0(i,r,b)-p,T=S-w[3],E=S+w[3];T>c||E<l||!H0(o,w)||n(v,h)};this._forEachNodeDepthOrdered(this._root,v=>{if(!H0(o,v.bounds)||(oe(Cu,f,v.halfSize),de(Cu,Cu,v.bounds),v0(i,r,Cu)-p>c)||(oe(Cu,m,v.halfSize),de(Cu,Cu,v.bounds),v0(i,r,Cu)-p<l))return!1;const w=v.node;return w.terminals.forAll(b=>y(b)),w.residents!==null&&w.residents.forAll(b=>y(b)),!0},i,r)}forEachNode(t){this._forEachNode(this._root,i=>t(i.node,i.bounds,i.halfSize))}forEachNeighbor(t,i){const r=sg(i),s=i,n=o=>{const a=this._objectToBoundingSphere(o),l=sg(a),c=r+l;$s(a,s)-c*c<=0&&t(o)};this._forEachNode(this._root,o=>{const a=sg(o.bounds),l=r+a;if($s(o.bounds,s)-l*l>0)return!1;const c=o.node;return c.terminals.forAll(h=>n(h)),c.residents!==null&&c.residents.forAll(h=>n(h)),!0}),this.forEachDegenerateObject(n)}_intersectsNode(t,i){return hI(i.bounds,2*-i.halfSize,Uc),hI(i.bounds,2*i.halfSize,kc),Sie(t.origin,t.direction,Uc,kc)}_intersectsNodeWithOffset(t,i,r){return hI(i.bounds,2*-i.halfSize,Uc),hI(i.bounds,2*i.halfSize,kc),r.applyToMinMax(Uc,kc),Sie(t.origin,t.direction,Uc,kc)}_intersectsObject(t,i){const r=this._objectToBoundingSphere(i);return!(r[3]>0)||r9(r,t)}_intersectsObjectWithOffset(t,i,r){const s=this._objectToBoundingSphere(i);return!(s[3]>0)||r9(r.applyToBoundingSphere(s),t)}_forEachNode(t,i){let r=Wr.acquire().init(t);const s=[r];for(;s.length!==0;){if(r=s.pop(),i(r)&&!r.isLeaf())for(let n=0;n<r.node.children.length;n++)r.node.children[n]&&s.push(Wr.acquire().init(r).advance(n));Wr.release(r)}}_forEachNodeDepthOrdered(t,i,r,s=R2.DepthOrder.FRONT_TO_BACK){let n=Wr.acquire().init(t);const o=[n];for(_Ke(r,s,use);o.length!==0;){if(n=o.pop(),i(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=use[a];n.node.children[l]&&o.push(Wr.acquire().init(n).advance(l))}Wr.release(n)}}_remove(t,i,r){u_.clear();const s=r.advanceTo(i,(n,o)=>{u_.push(n.node),u_.push(o)})?r.node.terminals:r.node.residents;if(s.removeUnordered(t),s.length===0)for(let n=u_.length-2;n>=0;n-=2){const o=u_.data[n],a=u_.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(t){if(t.terminals.length!==0)return!1;if(t.residents!==null)return t.residents.length===0;for(let i=0;i<t.children.length;i++)if(t.children[i])return!1;return!0}_purge(t,i){return i>=0&&(t.children[i]=null),!!this._nodeIsEmpty(t)&&(t.residents===null&&(t.residents=new Bt({shrink:!0})),!0)}_add(t,i){i.advanceTo(this._objectToBoundingSphere(t))?i.node.terminals.push(t):(i.node.residents.push(t),i.node.residents.length>this._maximumObjectsPerNode&&i.depth<this._maximumDepth&&this._split(i))}_split(t){const i=t.node.residents;t.node.residents=null;for(let r=0;r<i.length;r++){const s=Wr.acquire().init(t);this._add(i.getItemAt(r),s),Wr.release(s)}}_grow(t,i){if(i!==0&&(lse(t,i,r=>this._objectToBoundingSphere(r),lp),PA(lp[3])&&!this._fitsInsideTree(lp)))if(this._nodeIsEmpty(this._root.node))HS(lp,this._root.bounds),this._root.halfSize=1.25*lp[3];else{const r=this._rootBoundsForRootAsSubNode(lp);this._placingRootViolatesMaxDepth(r)?this._rebuildTree(lp,r):this._growRootAsSubNode(r),Wr.release(r)}}_rebuildTree(t,i){se(_z,i.bounds),_z[3]=i.halfSize,lse([t,_z],2,s=>s,bz);const r=Wr.acquire().init(this._root);this._root.initFrom(null,bz,1.25*bz[3]),this._forEachNode(r,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),Wr.release(r)}_placingRootViolatesMaxDepth(t){const i=Math.log(t.halfSize/this._root.halfSize)*Math.LOG2E;let r=0;return this._forEachNode(this._root,s=>(r=Math.max(r,s.depth),r+i<=this._maximumDepth)),r+i>this._maximumDepth}_rootBoundsForRootAsSubNode(t){const i=t[3],r=t;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let a=0;a<3;a++){const l=n[a]-o-(r[a]-i),c=r[a]+i-(n[a]+o),h=Math.max(0,Math.ceil(l/(2*o))),p=Math.max(0,Math.ceil(c/(2*o)))+1,f=2**Math.ceil(Math.log(h+p)*Math.LOG2E);s=Math.max(s,f),dI[a].min=h,dI[a].max=p}for(let a=0;a<3;a++){let l=dI[a].min,c=dI[a].max;const h=(s-(l+c))/2;l+=Math.ceil(h),c+=Math.floor(h);const p=n[a]-o-l*o*2;vz[a]=p+(c+l)*o}return vz[3]=s*o*ube,Wr.acquire().initFrom(null,vz,s*o,0)}_growRootAsSubNode(t){const i=this._root.node;se(lp,this._root.bounds),lp[3]=this._root.halfSize,this._root.init(t),t.advanceTo(lp,null,!0),t.node.children=i.children,t.node.residents=i.residents,t.node.terminals=i.terminals}_shrink(){for(;;){const t=this._findShrinkIndex();if(t===-1)break;this._root.advance(t),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let t=null;const i=this._root.node.children;let r=0,s=0;for(;s<i.length&&t==null;)r=s++,t=i[r];for(;s<i.length;)if(i[s++])return-1;return r}_isDegenerate(t){return!PA(this._objectToBoundingSphere(t)[3])}_fitsInsideTree(t){const i=this._root.bounds,r=this._root.halfSize;return t[3]<=r&&t[0]>=i[0]-r&&t[0]<=i[0]+r&&t[1]>=i[1]-r&&t[1]<=i[1]+r&&t[2]>=i[2]-r&&t[2]<=i[2]+r}}class Wr{constructor(){this.bounds=fn(),this.halfSize=0,this.initFrom(null,null,0,0)}init(t){return this.initFrom(t.node,t.bounds,t.halfSize,t.depth)}initFrom(t,i,r,s=this.depth){return this.node=_(t)?t:Wr.createEmptyNode(),_(i)&&HS(i,this.bounds),this.halfSize=r,this.depth=s,this}advance(t){let i=this.node.children[t];i||(i=Wr.createEmptyNode(),this.node.children[t]=i),this.node=i,this.halfSize/=2,this.depth++;const r=cbe[t];return this.bounds[0]+=r[0]*this.halfSize,this.bounds[1]+=r[1]*this.halfSize,this.bounds[2]+=r[2]*this.halfSize,this.bounds[3]=this.halfSize*ube,this}advanceTo(t,i,r=!1){for(;;){if(this.isTerminalFor(t))return i&&i(this,-1),!0;if(this.isLeaf()){if(!r)return i&&i(this,-1),!1;this.node.residents=null}const s=this._childIndex(t);i&&i(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(t){return t[3]>this.halfSize/2}_childIndex(t){const i=this.bounds;return(i[0]<t[0]?1:0)+(i[1]<t[1]?2:0)+(i[2]<t[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new Bt({shrink:!0}),residents:new Bt({shrink:!0})}}static acquire(){return Wr._pool.acquire()}static release(t){Wr._pool.release(t)}static clearPool(){Wr._pool.prune()}}function yKe(e,t){e[0]=Math.min(e[0],t[0]-t[3]),e[1]=Math.min(e[1],t[1]-t[3]),e[2]=Math.min(e[2],t[2]-t[3])}function vKe(e,t){e[0]=Math.max(e[0],t[0]+t[3]),e[1]=Math.max(e[1],t[1]+t[3]),e[2]=Math.max(e[2],t[2]+t[3])}function hI(e,t,i){i[0]=e[0]+t,i[1]=e[1]+t,i[2]=e[2]+t}function lse(e,t,i,r){if(t===1){const s=i(e[0]);HS(s,r)}else{Uc[0]=1/0,Uc[1]=1/0,Uc[2]=1/0,kc[0]=-1/0,kc[1]=-1/0,kc[2]=-1/0;for(let s=0;s<t;s++){const n=i(e[s]);PA(n[3])&&(yKe(Uc,n),vKe(kc,n))}en(r,Uc,kc,.5),r[3]=Math.max(kc[0]-Uc[0],kc[1]-Uc[1],kc[2]-Uc[2])/2}}function _Ke(e,t,i){if(!p1.length)for(let r=0;r<8;++r)p1.push({index:0,distance:0});for(let r=0;r<8;++r){const s=cbe[r];p1.data[r].index=r,p1.data[r].distance=v0(e,t,s)}p1.sort((r,s)=>r.distance-s.distance);for(let r=0;r<8;++r)i[r]=p1.data[r].index}function yz(e,t){let i=1/0,r=null;for(let s=0;s<8;++s){const n=v0(e,t,cse[s]);n<i&&(i=n,r=cse[s])}return r}function v0(e,t,i){return t*(e[0]*i[0]+e[1]*i[1]+e[2]*i[2])}function PA(e){return!isNaN(e)&&e!==-1/0&&e!==1/0&&e>0}Wr._pool=new ys(Wr),function(e){var t;(t=e.DepthOrder||(e.DepthOrder={}))[t.FRONT_TO_BACK=1]="FRONT_TO_BACK",t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(R2||(R2={}));const cbe=[Fe(-1,-1,-1),Fe(1,-1,-1),Fe(-1,1,-1),Fe(1,1,-1),Fe(-1,-1,1),Fe(1,-1,1),Fe(-1,1,1),Fe(1,1,1)],cse=[Fe(-1,-1,-1),Fe(-1,-1,1),Fe(-1,1,-1),Fe(-1,1,1),Fe(1,-1,-1),Fe(1,-1,1),Fe(1,1,-1),Fe(1,1,1)],ube=Math.sqrt(3),rj=[null];function bKe(e){return rj[0]=e,rj}const vz=fn(),Cu=O(),Uc=O(),kc=O(),u_=new Bt,wKe=fn(),lp=fn(),_z=fn(),bz=fn(),dI=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],p1=new Bt,use=[0,0,0,0,0,0,0,0],Ud=R2;class hbe extends jO{constructor(t,i=""){var r,s,n;super(),this.apiLayerUid=i,this.type=Kd.Layer,this.events=new us,this.isSliceable=!1,this._objects=new Bt,this._stageHandles=new qt,this.apiLayerUid=i,this.isVisible=(r=t==null?void 0:t.isVisible)!=null?r:!0,this.isPickable=(s=t==null?void 0:t.isPickable)!=null?s:!0,this.updatePolicy=(n=t==null?void 0:t.updatePolicy)!=null?n:l2.ASYNC}get objects(){return this._objects}destroy(){this.detachStage(),this._stage=null}attachStage(t){this.detachStage(),this._stage=t;for(const i of gKe)this._stageHandles.add(this.events.on(i,r=>t.handleEvent(i,r)))}detachStage(){this._stageHandles.removeAll(),this.invalidateSpatialQueryAccelerator()}add(t){this._objects.push(t),t.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:t}),_(this._octree)&&this._octree.add([t])}remove(t){this._objects.removeUnordered(t)&&(t.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:t}),_(this._octree)&&this._octree.remove([t]))}addMany(t){this._objects.pushArray(t);for(const i of t)i.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:t}),_(this._octree)&&this._octree.add(t)}removeMany(t){const i=new Array;if(this._objects.removeUnorderedMany(t,t.length,i),i.length!==0){for(const r of i)r.parentLayer=null;this.events.emit("layerObjectsRemoved",{layer:this,objects:i}),_(this._octree)&&this._octree.remove(i)}}sync(){_(this._stage)&&this.updatePolicy!==l2.SYNC&&this._stage.syncLayer(this.id)}notifyObjectBBChanged(t,i){_(this._octree)&&this._octree.update(t,i)}getSpatialQueryAccelerator(){return R(this._octree)&&this._objects.length>50&&this._createOctree(),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=ot(this._octree)}_createOctree(){this._octree=new Ud(t=>t.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)}}function bF(e){return _(e)&&e.type===Kd.Layer}class dbe{constructor(t,i){this._material=t,this._repository=i,this._map=new Map}destroy(){this._map.forEach((t,i)=>{_(t)&&this._repository.release(this._material,ew(i))})}load(t,i){this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,ew(i)));const r=this._map.get(i);if(_(r)){if(r.ensureResources(t)===kl.LOADED)return r;this._repository.requestRender()}return null}}function ew(e){switch(e){case je.MATERIAL:return J.Color;case je.MATERIAL_ALPHA:return J.Alpha;case je.MATERIAL_DEPTH:return J.Depth;case je.MATERIAL_NORMAL:return J.Normal;case je.MATERIAL_DEPTH_SHADOWMAP_ALL:return J.Shadow;case je.MATERIAL_HIGHLIGHT:return J.Highlight;case je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:case je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return J.Shadow}}const hse=8;function pbe(e,t){const i=e.vertex;i.uniforms.add(new We("intrinsicWidth",r=>r.width)),t.vvSize?(e.attributes.add(A.SIZEFEATUREATTRIBUTE,"float"),i.uniforms.add(new xt("vvSizeMinSize",r=>r.vvSizeMinSize)),i.uniforms.add(new xt("vvSizeMaxSize",r=>r.vvSizeMaxSize)),i.uniforms.add(new xt("vvSizeOffset",r=>r.vvSizeOffset)),i.uniforms.add(new xt("vvSizeFactor",r=>r.vvSizeFactor)),i.code.add(x`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(e.attributes.add(A.SIZE,"float"),i.code.add(x`float getSize(){
return intrinsicWidth * size;
}`)),t.vvOpacity?(e.attributes.add(A.OPACITYFEATUREATTRIBUTE,"float"),i.constants.add("vvOpacityNumber","int",8),i.uniforms.add([new jo("vvOpacityValues",r=>r.vvOpacityValues,hse),new jo("vvOpacityOpacities",r=>r.vvOpacityOpacities,hse)]),i.code.add(x`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):i.code.add(x`vec4 applyOpacity( vec4 color ){
return color;
}`),t.vvColor?(e.attributes.add(A.COLORFEATUREATTRIBUTE,"float"),i.constants.add("vvColorNumber","int",Gd),i.uniforms.add(new jo("vvColorValues",r=>r.vvColorValues,Gd)),i.uniforms.add(new $5("vvColorColors",r=>r.vvColorColors,Gd)),i.code.add(x`vec4 interpolateColor( float value ) {
if (value <= vvColorValues[0]) {
return vvColorColors[0];
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return mix(vvColorColors[i-1], vvColorColors[i], f);
}
}
return vvColorColors[vvColorNumber - 1];
}
vec4 getColor(){
return applyOpacity(interpolateColor(colorFeatureAttribute));
}`)):(e.attributes.add(A.COLOR,"vec4"),i.code.add(x`vec4 getColor(){
return applyOpacity(color);
}`))}function Bv(e,t){e.fragment.include(uc),t.output===J.Shadow?(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 2.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`)):t.output===J.Depth&&e.fragment.code.add(x`void outputDepth(float _linearDepth) {
gl_FragColor = float2rgba(_linearDepth);
}`)}function xKe(e){return R(e)?hf:e.length===4?e:qi(TKe,e[0],e[1],e[2],1)}const TKe=Gt();function fbe(e,t){e.constants.add("stippleAlphaColorDiscard","float",.001),e.constants.add("stippleAlphaHighlightDiscard","float",.5),t.stippleEnabled?SKe(e,t):EKe(e)}function SKe(e,t){const i=!(t.draped&&t.stipplePreferContinuous),{vertex:r,fragment:s}=e;s.include(uc),r.uniforms.add(new Pi("stipplePatternPixelSize")),t.draped||(Mf(r,t),r.uniforms.add(new We("worldToScreenPerDistanceRatio",(n,o)=>1/o.camera.perScreenPixelRatio)),r.code.add(x`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),e.varyings.add("vStippleDistance","float"),t.stippleRequiresClamp&&e.varyings.add("vStippleDistanceLimits","vec2"),t.stippleRequiresStretchMeasure&&e.varyings.add("vStipplePatternStretch","float"),r.code.add(x`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${CKe};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),r.code.add(x`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),r.code.add(x`
    if (segmentLengthPseudoScreen >= ${i?"patternLength":"1e4"}) {
  `),r.uniforms.add(new We("pixelRatio",(n,o)=>o.camera.pixelRatio)),r.code.add(x`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${t.stippleRequiresStretchMeasure?x`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.uniforms.add(new $r("stipplePatternTexture")),s.uniforms.add(new Pi("stipplePatternSDFNormalizer")),s.uniforms.add(new Pi("stipplePatternTextureSize")),s.uniforms.add(new Pi("stipplePatternPixelSizeInv")),s.code.add(x`float padTexture(float u) {
return (u * stipplePatternTextureSize + 1.0)/(stipplePatternTextureSize + 2.0);
}`),s.code.add(x`
    float getStippleSDF(out bool isClamped) {
      ${t.stippleRequiresClamp?x`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:x`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${t.stippleScaleWithLineWidth?x`u *= vLineSizeInv;`:""}
      u = padTexture(fract(u));

      float encodedSDF = rgba2float(texture2D(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${t.stippleRequiresStretchMeasure?x`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:x`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${t.stippleScaleWithLineWidth?x`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:x`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),t.stippleOffColorEnabled?(s.uniforms.add(new ei("stippleOffColor",n=>xKe(n.stippleOffColor))),s.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(x`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function EKe(e){e.fragment.code.add(x`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}const CKe=x.float(.4);var wh;(function(e){e[e.BUTT=0]="BUTT",e[e.SQUARE=1]="SQUARE",e[e.ROUND=2]="ROUND",e[e.COUNT=3]="COUNT"})(wh||(wh={}));class Ur extends Ho{constructor(){super(...arguments),this.output=J.Color,this.capType=wh.BUTT,this.transparencyPassType=gt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.wireframe=!1}}u([G({count:J.COUNT})],Ur.prototype,"output",void 0),u([G({count:wh.COUNT})],Ur.prototype,"capType",void 0),u([G({count:gt.COUNT})],Ur.prototype,"transparencyPassType",void 0),u([G()],Ur.prototype,"occluder",void 0),u([G()],Ur.prototype,"hasSlicePlane",void 0),u([G()],Ur.prototype,"hasPolygonOffset",void 0),u([G()],Ur.prototype,"writeDepth",void 0),u([G()],Ur.prototype,"draped",void 0),u([G()],Ur.prototype,"stippleEnabled",void 0),u([G()],Ur.prototype,"stippleOffColorEnabled",void 0),u([G()],Ur.prototype,"stippleScaleWithLineWidth",void 0),u([G()],Ur.prototype,"stipplePreferContinuous",void 0),u([G()],Ur.prototype,"roundJoins",void 0),u([G()],Ur.prototype,"vvSize",void 0),u([G()],Ur.prototype,"vvColor",void 0),u([G()],Ur.prototype,"vvOpacity",void 0),u([G()],Ur.prototype,"falloffEnabled",void 0),u([G()],Ur.prototype,"innerColorEnabled",void 0),u([G()],Ur.prototype,"hasOccludees",void 0),u([G()],Ur.prototype,"hasMultipassTerrain",void 0),u([G()],Ur.prototype,"cullAboveGround",void 0),u([G()],Ur.prototype,"wireframe",void 0),u([G({constValue:!0})],Ur.prototype,"stippleRequiresClamp",void 0),u([G({constValue:!0})],Ur.prototype,"stippleRequiresStretchMeasure",void 0),u([G({constValue:!0})],Ur.prototype,"hasVvInstancing",void 0),u([G({constValue:!0})],Ur.prototype,"hasSliceTranslatedView",void 0);const wF=1;function AKe(e){const t=new Bi,i=e.hasMultipassTerrain&&(e.output===J.Color||e.output===J.Alpha);t.include(d5),t.include(pbe,e),t.include(fbe,e),e.output===J.Depth&&t.include(Bv,e),ou(t,e);const{vertex:r,fragment:s}=t;r.uniforms.add([new vr("inverseProjectionMatrix",(f,m)=>m.camera.inverseProjectionMatrix),new di("nearFar",(f,m)=>m.camera.nearFar),new We("miterLimit",f=>f.join!=="miter"?0:f.miterLimit),new ei("viewport",(f,m)=>m.camera.fullViewport)]),r.constants.add("LARGE_HALF_FLOAT","float",65500),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.SUBDIVISIONFACTOR,"float"),t.attributes.add(A.UV0,"vec2"),t.attributes.add(A.AUXPOS1,"vec3"),t.attributes.add(A.AUXPOS2,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("linearDepth","float"),i&&t.varyings.add("depth","float");const n=e.capType===wh.ROUND,o=e.stippleEnabled&&e.stippleScaleWithLineWidth||n;o&&t.varyings.add("vLineWidth","float");const a=e.stippleEnabled&&e.stippleScaleWithLineWidth;a&&t.varyings.add("vLineSizeInv","float");const l=e.innerColorEnabled||n;l&&t.varyings.add("vLineDistance","float");const c=e.stippleEnabled&&n,h=e.falloffEnabled||c;h&&t.varyings.add("vLineDistanceNorm","float"),n&&(t.varyings.add("vSegmentSDF","float"),t.varyings.add("vReverseSegmentSDF","float")),r.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),r.code.add(x`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${i?"depth = pos.z;":""}
      linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),r.uniforms.add(new We("pixelRatio",(f,m)=>m.camera.pixelRatio)),r.code.add(x`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${o?x`vLineWidth = lineWidth;`:""}
      ${a?x`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);

      clipAndTransform(pos, prev, next, isStartVertex);

      vec2 left = (pos.xy - prev.xy);
      vec2 right = (next.xy - pos.xy);

      float leftLen = length(left);
      float rightLen = length(right);
  `),(e.stippleEnabled||n)&&r.code.add(x`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${n?x`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(x`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),e.roundJoins?r.code.add(x`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${e.stippleEnabled?x`min(1.0, subdivisionFactor * ${x.float((wF+2)/(wF+1))})`:x`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(x`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const p=e.capType!==wh.BUTT;return r.code.add(x`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${p?x`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(x`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${h||l?x`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${l?x`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${h?x`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),n&&r.code.add(x`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),e.stippleEnabled&&(e.draped?r.uniforms.add(new We("worldToScreenRatio",(f,m)=>1/m.screenToPCSRatio)):r.code.add(x`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(x`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),e.draped?r.code.add(x`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(x`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.code.add(x`
      float patternLength = ${e.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),r.code.add(x`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${e.wireframe&&!e.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
    }
  }
  `),i&&t.include(yu,e),t.include(ls,e),s.include(Vf),s.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${i?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),e.wireframe?s.code.add(x`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(n&&s.code.add(x`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${x.float(Eo)}) {
        discard;
      }
    `),c?s.code.add(x`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${x.float(Eo)}, stippleCoverage);
      `):s.code.add(x`float stippleAlpha = getStippleAlpha();`),s.uniforms.add(new ei("intrinsicColor",f=>f.color)),s.code.add(x`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);
vec4 color = intrinsicColor * vColor;`),e.innerColorEnabled&&(s.uniforms.add(new ei("innerColor",f=>yt(f.innerColor,f.color))),s.uniforms.add(new We("innerWidth",(f,m)=>f.innerWidth*m.camera.pixelRatio)),s.code.add(x`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),s.code.add(x`vec4 finalColor = blendStipple(color, stippleAlpha);`),e.falloffEnabled&&(s.uniforms.add(new We("falloff",f=>f.falloff)),s.code.add(x`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),s.code.add(x`
    if (finalColor.a < ${x.float(Eo)}) {
      discard;
    }

    ${e.output===J.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===J.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===J.Color&&e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===J.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===J.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}const RKe=Object.freeze(Object.defineProperty({__proto__:null,NUM_ROUND_JOIN_SUBDIVISIONS:wF,build:AKe},Symbol.toStringTag,{value:"Module"})),WY={func:hr.LESS},xF={func:hr.ALWAYS},Pf={mask:255},mbe={mask:0},MKe=e=>({function:{func:hr.NOTEQUAL,ref:e,mask:e},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.KEEP}}),OKe=e=>({function:{func:hr.ALWAYS,ref:e,mask:e},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.REPLACE}}),Gv={function:{func:hr.ALWAYS,ref:al.OutlineVisualElementMask,mask:al.OutlineVisualElementMask},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.ZERO}},Ov={function:{func:hr.ALWAYS,ref:al.OutlineVisualElementMask,mask:al.OutlineVisualElementMask},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.REPLACE}},gbe={function:{func:hr.EQUAL,ref:al.OutlineVisualElementMask,mask:al.OutlineVisualElementMask},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.KEEP}},ybe={function:{func:hr.NOTEQUAL,ref:al.OutlineVisualElementMask,mask:al.OutlineVisualElementMask},operation:{fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.KEEP}},vbe=new Map([[A.POSITION,0],[A.SUBDIVISIONFACTOR,1],[A.UV0,2],[A.AUXPOS1,3],[A.AUXPOS2,4],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.OPACITYFEATUREATTRIBUTE,7]]);class H5 extends lr{constructor(t,i,r){super(t,i,r),this.stippleTextureRepository=t.stippleTextureRepository}initializeProgram(t){const i=H5.shader.get().build(this.configuration);return new Ji(t.rctx,i,vbe)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(this.program.bindPass(t,i),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.configuration.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r)}}_makePipelineState(t,i){const r=this.configuration,s=t===gt.NONE,n=t===gt.FrontFace;return Ut({blending:r.output===J.Color||r.output===J.Alpha?s?au:Gg(t):null,depthTest:{func:Vv(t)},depthWrite:s?r.writeDepth&&pl:D5(t),colorWrite:Jt,stencilWrite:r.hasOccludees?Pf:null,stencilTest:r.hasOccludees?i?Ov:Gv:null,polygonOffset:s||n?r.hasPolygonOffset&&dse:N5})}initializePipeline(){const t=this.configuration;if(t.occluder){const i=t.hasPolygonOffset&&dse;this._occluderPipelineTransparent=Ut({blending:au,polygonOffset:i,depthTest:xF,depthWrite:null,colorWrite:Jt,stencilWrite:null,stencilTest:ybe}),this._occluderPipelineOpaque=Ut({blending:au,polygonOffset:i,depthTest:xF,depthWrite:null,colorWrite:Jt,stencilWrite:mbe,stencilTest:gbe}),this._occluderPipelineMaskWrite=Ut({blending:null,polygonOffset:i,depthTest:WY,depthWrite:null,colorWrite:null,stencilWrite:Pf,stencilTest:Ov})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Pt.LINES:Pt.TRIANGLE_STRIP}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}H5.shader=new Qi(RKe,()=>import("./RibbonLine.glsl.27ce5baa.js"));const dse={factor:0,units:-4},PKe=me.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial");var Il;(function(e){e[e.LEFT_JOIN_START=-2]="LEFT_JOIN_START",e[e.LEFT_JOIN_END=-1]="LEFT_JOIN_END",e[e.LEFT_CAP_START=-4]="LEFT_CAP_START",e[e.LEFT_CAP_END=-5]="LEFT_CAP_END",e[e.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",e[e.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",e[e.RIGHT_CAP_START=4]="RIGHT_CAP_START",e[e.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(Il||(Il={}));class VT extends Gf{constructor(t){super(t,new $Ke),this._vertexAttributeLocations=vbe,this.techniqueConfig=new Ur,this.layout=this.createLayout()}isClosed(t,i){return _be(this.parameters,t,i)}getConfiguration(t,i){this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===Se.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern)&&t!==J.Highlight;return this.techniqueConfig.stippleEnabled=r,this.techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this.techniqueConfig.stippleScaleWithLineWidth=r&&this.parameters.stippleScaleWithLineWidth,this.techniqueConfig.stipplePreferContinuous=r&&this.parameters.stipplePreferContinuous,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.roundJoins=this.parameters.join==="round",this.techniqueConfig.capType=this.parameters.cap,this.techniqueConfig.hasPolygonOffset=this.parameters.hasPolygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.innerColorEnabled=this.parameters.innerWidth>0&&_(this.parameters.innerColor),this.techniqueConfig.falloffEnabled=this.parameters.falloff>0,this.techniqueConfig.occluder=this.parameters.renderOccluded===Mr.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig.wireframe=this.parameters.wireframe,this.techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?this._intersectDrapedLineGeometry(t,s,c,o,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectDrapedLineGeometry(t,i,r,s,n){if(!i.options.selectionMode)return;const o=t.vertexAttributes.get(A.POSITION).data,a=t.vertexAttributes.get(A.SIZE);let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const y=t.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0];l*=$e(this.parameters.vvSizeOffset[0]+y*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else a&&(l*=a.data[0]);const c=s[0],h=s[1],p=(l/2+4)*t.screenToWorldRatio;let f=Number.MAX_VALUE,m=0;for(let y=0;y<o.length-5;y+=3){const v=o[y],w=o[y+1],b=c-v,S=h-w,T=o[y+3]-v,E=o[y+4]-w,C=$e((T*b+E*S)/(T*T+E*E),0,1),M=T*C-b,I=E*C-S,N=M*M+I*I;N<f&&(f=N,m=y/3)}f<p*p&&n(r.dist,r.normal,m,!1)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||HO(i))return;if(!Ave(r))return void PKe.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes,a=o.get(A.POSITION).data;let l=this.parameters.width;if(this.parameters.vvSizeEnabled){const b=o.get(A.SIZEFEATUREATTRIBUTE).data[0];l*=$e(this.parameters.vvSizeOffset[0]+b*this.parameters.vvSizeFactor[0],this.parameters.vvSizeMinSize[0],this.parameters.vvSizeMaxSize[0])}else o.has(A.SIZE)&&(l*=o.get(A.SIZE).data[0]);const c=s.camera,h=LKe;ro(h,s.point);const p=l*c.pixelRatio/2+4*c.pixelRatio;ie(QE[0],h[0]-p,h[1]+p,0),ie(QE[1],h[0]+p,h[1]+p,0),ie(QE[2],h[0]+p,h[1]-p,0),ie(QE[3],h[0]-p,h[1]-p,0);for(let b=0;b<4;b++)if(!c.unprojectFromRenderScreen(QE[b],em[b]))return;Bo(c.eye,em[0],em[1],xz),Bo(c.eye,em[1],em[2],Tz),Bo(c.eye,em[2],em[3],Sz),Bo(c.eye,em[3],em[0],Ez);let f=Number.MAX_VALUE,m=0;const y=sj(this.parameters,o,t.indices)?a.length-2:a.length-5;for(let b=0;b<y;b+=3){Da[0]=a[b]+r[12],Da[1]=a[b+1]+r[13],Da[2]=a[b+2]+r[14];const S=(b+3)%a.length;if(La[0]=a[S]+r[12],La[1]=a[S+1]+r[13],La[2]=a[S+2]+r[14],ir(xz,Da)<0&&ir(xz,La)<0||ir(Tz,Da)<0&&ir(Tz,La)<0||ir(Sz,Da)<0&&ir(Sz,La)<0||ir(Ez,Da)<0&&ir(Ez,La)<0)continue;if(c.projectToRenderScreen(Da,d_),c.projectToRenderScreen(La,p_),d_[2]<0&&p_[2]>0){pe(cp,Da,La);const E=c.frustum,C=-ir(E[tr.NEAR],Da)/xe(cp,E[tr.NEAR]);oe(cp,cp,C),de(Da,Da,cp),c.projectToRenderScreen(Da,d_)}else if(d_[2]>0&&p_[2]<0){pe(cp,La,Da);const E=c.frustum,C=-ir(E[tr.NEAR],La)/xe(cp,E[tr.NEAR]);oe(cp,cp,C),de(La,La,cp),c.projectToRenderScreen(La,p_)}else if(d_[2]<0&&p_[2]<0)continue;d_[2]=0,p_[2]=0;const T=Wq(mb(d_,p_,mse),h);T<f&&(f=T,se(pse,Da),se(fse,La),m=b/3)}const v=s.rayBegin,w=s.rayEnd;if(f<p*p){let b=Number.MAX_VALUE;if(cpe(mb(pse,fse,mse),mb(v,w,NKe),h_)){pe(h_,h_,v);const S=Me(h_);oe(h_,h_,1/S),b=S/nr(v,w)}n(b,h_,m,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=t.indices,n=r.get(A.POSITION);return KX(n,s?s.get(A.POSITION):null,s&&sj(this.parameters,r,s),i)}createLayout(){const t=Kr().vec3f(A.POSITION).f32(A.SUBDIVISIONFACTOR).vec2f(A.UV0).vec3f(A.AUXPOS1).vec3f(A.AUXPOS2);return this.parameters.vvSizeEnabled?t.f32(A.SIZEFEATUREATTRIBUTE):t.f32(A.SIZE),this.parameters.vvColorEnabled?t.f32(A.COLORFEATUREATTRIBUTE):t.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&t.f32(A.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new DKe(this.layout,this.parameters)}requiresSlot(t,i){if(t===Se.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Mr.OccludeAndTransparentStencil)return t===Se.OPAQUE_MATERIAL||t===Se.OCCLUDER_MATERIAL||t===Se.TRANSPARENT_OCCLUDER_MATERIAL;const r=ew(i);return r===J.Color||r===J.Alpha?t===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===Se.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Highlight||t.output===J.Depth?new IKe(t):null}validateParameters(t){t.join!=="miter"&&(t.miterLimit=0)}}class IKe extends kv{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||this._updateOccludeeState(t),this.ensureTechnique(H5,t)}}class $Ke extends $Y{constructor(){super(...arguments),this.width=0,this.color=ph,this.join="miter",this.cap=wh.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}}class DKe{constructor(t,i){this.parameters=i,this.numJoinSubdivisions=0,this.vertexBufferLayout=t;const r=i.stipplePattern?1:0;switch(this.parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=r;break;case"round":this.numJoinSubdivisions=wF+r}}_isClosed(t){return sj(this.parameters,t.vertexAttributes,t.indices)}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){const r=t.indices.get(A.POSITION).length/2+1,s=this._isClosed(t);let n=s?2:2*2;return n+=((s?r:r-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this.parameters.wireframe&&(n=2+4*(n-2)),n}write(t,i,r,s){var k;const n=FKe,o=UKe,a=kKe,l=i.vertexAttributes.get(A.POSITION).data,c=i.indices&&i.indices.get(A.POSITION),h=(k=i.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:k.data;c&&c.length!==2*(l.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let p=1,f=0;this.parameters.vvSizeEnabled?f=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(p=i.vertexAttributes.get(A.SIZE).data[0]);let m=[1,1,1,1],y=0;this.parameters.vvColorEnabled?y=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(m=i.vertexAttributes.get(A.COLOR).data);let v=0;this.parameters.vvOpacityEnabled&&(v=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const w=l.length/3,b=t.transformation,S=new Float32Array(r.buffer),T=this.vertexBufferLayout.stride/4;let E=s*T;const C=E;let M=0;const I=h?(Y,Z,le)=>M=h[le]:(Y,Z,le)=>M+=nr(Y,Z),N=(Y,Z,le,ne,$,U,B)=>{if(S[E++]=Z[0],S[E++]=Z[1],S[E++]=Z[2],S[E++]=ne,S[E++]=B,S[E++]=$,S[E++]=Y[0],S[E++]=Y[1],S[E++]=Y[2],S[E++]=le[0],S[E++]=le[1],S[E++]=le[2],this.parameters.vvSizeEnabled?S[E++]=f:S[E++]=p,this.parameters.vvColorEnabled)S[E++]=y;else{const H=Math.min(4*U,m.length-4);S[E++]=m[H+0],S[E++]=m[H+1],S[E++]=m[H+2],S[E++]=m[H+3]}this.parameters.vvOpacityEnabled&&(S[E++]=v)};E+=T,ie(o,l[0],l[1],l[2]),b&&Ue(o,o,b);const D=this._isClosed(i);if(D){const Y=l.length-3;ie(n,l[Y],l[Y+1],l[Y+2]),b&&Ue(n,n,b)}else ie(a,l[3],l[4],l[5]),b&&Ue(a,a,b),N(o,o,a,1,Il.LEFT_CAP_START,0,0),N(o,o,a,1,Il.RIGHT_CAP_START,0,0),se(n,o),se(o,a);const z=D?0:1,V=D?w:w-1;for(let Y=z;Y<V;Y++){const Z=(Y+1)%w*3;ie(a,l[Z+0],l[Z+1],l[Z+2]),b&&Ue(a,a,b),I(n,o,Y),N(n,o,a,0,Il.LEFT_JOIN_END,Y,M),N(n,o,a,0,Il.RIGHT_JOIN_END,Y,M);const le=this.numJoinSubdivisions;for(let ne=0;ne<le;++ne){const $=(ne+1)/(le+1);N(n,o,a,$,Il.LEFT_JOIN_END,Y,M),N(n,o,a,$,Il.RIGHT_JOIN_END,Y,M)}N(n,o,a,1,Il.LEFT_JOIN_START,Y,M),N(n,o,a,1,Il.RIGHT_JOIN_START,Y,M),se(n,o),se(o,a)}D?(ie(a,l[3],l[4],l[5]),b&&Ue(a,a,b),M=I(n,o,V),N(n,o,a,0,Il.LEFT_JOIN_END,z,M),N(n,o,a,0,Il.RIGHT_JOIN_END,z,M)):(M=I(n,o,V),N(n,o,o,0,Il.LEFT_CAP_END,V,M),N(n,o,o,0,Il.RIGHT_CAP_END,V,M)),wz(S,C+T,S,C,T),E=wz(S,E-T,S,E,T),this.parameters.wireframe&&this._addWireframeVertices(r,C,E,T)}_addWireframeVertices(t,i,r,s){const n=new Float32Array(t.buffer,r*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(t.buffer,i*Float32Array.BYTES_PER_ELEMENT,r-i);let a=0;const l=c=>a=wz(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}}function wz(e,t,i,r,s){for(let n=0;n<s;n++)i[r++]=e[t++];return r}function sj(e,t,i){return _be(e,t.get(A.POSITION).data,i?i.get(A.POSITION):null)}function _be(e,t,i){return!!e.isClosed&&(i?i.length>2:t.length>6)}const Da=O(),La=O(),cp=O(),h_=O(),LKe=O(),d_=wo(),p_=wo(),pse=O(),fse=O(),mse=Ff(),NKe=Ff(),FKe=O(),UKe=O(),kKe=O(),QE=[wo(),wo(),wo(),wo()],em=[O(),O(),O(),O()],xz=gi(),Tz=gi(),Sz=gi(),Ez=gi();class XY{constructor(t,i=125e4){this._originSR=t,this._gridSize=i,this._origins=new Map,this._objects=new Map,this._rootOriginId="root/"+sl()}getOrigin(t){const i=this._origins.get(this._rootOriginId);if(i==null){const h=mKe.rootOrigin;if(_(h))return this._origins.set(this._rootOriginId,ER(h[0],h[1],h[2],this._rootOriginId)),this.getOrigin(t);const p=ER(t[0]+Math.random()-.5,t[1]+Math.random()-.5,t[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,p),p}const r=this._gridSize,s=Math.round(t[0]/r),n=Math.round(t[1]/r),o=Math.round(t[2]/r),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*r;if(pe(In,t,i.vec3),In[0]=Math.abs(In[0]),In[1]=Math.abs(In[1]),In[2]=Math.abs(In[2]),In[0]<c&&In[1]<c&&In[2]<c){if(l){const h=Math.max(...In);if(pe(In,t,l.vec3),In[0]=Math.abs(In[0]),In[1]=Math.abs(In[1]),In[2]=Math.abs(In[2]),Math.max(...In)<h)return l}return i}return l||(l=ER(s*r,n*r,o*r,a),this._origins.set(a,l)),l}_drawOriginBox(t,i=fi(1,1,0,1)){const r=window.view,s=r._stage,n=i.toString();if(!this._objects.has(n)){this._material=new VT({width:2,color:i}),s.add(this._material);const m=new hbe({isPickable:!1}),y=new Hg({castShadow:!1});s.add(y),m.add(y),s.add(m),this._objects.set(n,y)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Uint16Array(2*(l-1)),p=.5*this._gridSize;for(let m=0;m<l;m++)c[3*m+0]=t[0]+(1&a[m]?p:-p),c[3*m+1]=t[1]+(2&a[m]?p:-p),c[3*m+2]=t[2]+(4&a[m]?p:-p),m>0&&(h[2*m+0]=m-1,h[2*m+1]=m);ar(c,this._originSR,0,c,r.renderSpatialReference,0,l);const f=new Or([[A.POSITION,{size:3,data:c,exclusive:!0}]],[[A.POSITION,h]],ll.Line);s.add(f),o.addGeometry(f,this._material,Ks)}}const In=O();class bbe{constructor(t,i,r,s=null){this.rctx=t,this.sliceHelper=s,this.lastFrameCamera=new Yi,this.pass=je.MATERIAL,this.renderOccludedMask=gse,this.bindParameters=new y5(i,r,_(s)?s.plane:null)}resetRenderOccludedMask(){this.renderOccludedMask=gse}get isHighlightPass(){return this.pass===je.MATERIAL_HIGHLIGHT}}class zKe extends bbe{constructor(t,i,r,s,n){super(t,r,s,n),this.offscreenRenderingHelper=i,this.sliceHelper=n}}const gse=Mr.Occlude|Mr.OccludeAndTransparent|Mr.OccludeAndTransparentStencil;var M2;(function(e){e[e.Highlight=0]="Highlight",e[e.Default=1]="Default"})(M2||(M2={}));class pI{constructor(){this.camera=new Yi,this.lightMat=Ae()}}class YY{constructor(t,i,r=0){this.rctx=t,this.viewingMode=i,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this.maxTextureSize=0,this.numCascades=1,this.maxNumCascades=4,this.splitSchemeLambda=0,this.warp=!0,this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Gt(),this._cascades=[new pI,new pI,new pI,new pI],this.maxTextureSize=this.rctx.parameters.maxTextureSize,this.snapshotCount=r}get depthTexture(){return this._depthTexture}get textureSize(){return this._textureSize}get cascadeDistances(){return qi(this._usedCascadeDistances,this._cascadeDistances[0],this.numCascades>1?this._cascadeDistances[1]:1/0,this.numCascades>2?this._cascadeDistances[2]:1/0,this.numCascades>3?this._cascadeDistances[3]:1/0)}dispose(){this._discardDepthTexture(),this._discardAllSnapshots()}set maxCascades(t){this.maxNumCascades=$e(Math.floor(t),1,4)}get maxCascades(){return this.maxNumCascades}set enabled(t){this._enabled=t,t||(this._discardDepthTexture(),this._discardAllSnapshots())}get enabled(){return this._enabled}get ready(){return this._enabled&&_(this._depthTexture)}get snapshotCount(){return this._snapshots.length}set snapshotCount(t){const i=this._snapshots.length;if(t>i){const r=t-i;this._snapshots.length=t;for(let s=0;s<r;++s)this._snapshots[i+s]=null}else if(t<this.snapshotCount){const r=i-t;for(let s=0;s<r;++s)this._discardSnapshot(t+s);this._snapshots.length=t}}getSnapshot(t){return this.enabled?this._snapshots[t]:null}getCascades(){for(let t=0;t<this.numCascades;++t)Az[t]=this._cascades[t];return Az.length=this.numCascades,Az}start(t,i,r){dt(this.enabled),this._textureSize=this._computeTextureSize(t.fullWidth,t.fullHeight),this._ensureDepthTexture();const{near:s,far:n}=this._clampNearFar(r);this._computeCascadeDistances(n,s),this._setupMatrices(t,i);const o=t.viewMatrix,a=t.projectionMatrix;for(let l=0;l<this.numCascades;++l)this._constructCascade(l,a,o,i);this.lastOrigin=null,this.clear()}finish(t){dt(this.enabled),this.rctx.bindFramebuffer(t)}getShadowMapMatrices(t){if(!this.lastOrigin||!tl(t,this.lastOrigin)){this.lastOrigin=this.lastOrigin||O(),se(this.lastOrigin,t);for(let i=0;i<this.numCascades;++i){Aa(Cse,this._cascades[i].lightMat,t);for(let r=0;r<16;++r)Ase[16*i+r]=Cse[r]}}return Ase}takeCascadeSnapshotTo(t,i){dt(this.enabled);const r=this._ensureSnapshot(i);this._bindFbo();const s=this.rctx,n=s.bindTexture(r,st.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(pt.TEXTURE_2D,0,t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[0],t.camera.viewport[1],t.camera.viewport[2],t.camera.viewport[3]),s.bindTexture(n,st.TEXTURE_UNIT_FOR_UPDATES)}clear(){const t=this.rctx;this._bindFbo(),t.setClearColor(1,1,1,1),t.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT)}_computeTextureSize(t,i){const r=.5*Math.log(t*t+i*i)*Math.LOG2E,s=.35,n=2**Math.round(r+s);return Math.min(this.maxTextureSize,2*n)}_ensureDepthTexture(){if(_(this._depthTexture)&&this._depthTexture.descriptor.width===this._textureSize)return;this._discardDepthTexture();const t={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};this._depthTexture=new st(this.rctx,t),this._fbo=new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.DEPTH_RENDER_BUFFER,width:this._textureSize,height:this._textureSize},this._depthTexture)}_ensureSnapshot(t){let i=this._snapshots[t];if(_(i)&&i.descriptor.width===this._textureSize)return i;this._discardSnapshot(t);const r={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.NEAREST,flipped:!0,width:this._textureSize,height:this._textureSize};return i=new st(this.rctx,r),this._snapshots[t]=i,i}_discardDepthTexture(){this._fbo=Ye(this._fbo),this._depthTexture=Ye(this._depthTexture)}_discardSnapshot(t){this._snapshots[t]=Ye(this._snapshots[t])}_discardAllSnapshots(){for(let t=0;t<this.snapshotCount;++t)this._discardSnapshot(t)}_bindFbo(){const t=this.rctx;t.unbindTexture(this._depthTexture),t.bindFramebuffer(this._fbo)}_constructCascade(t,i,r,s){const n=this._cascades[t],o=-this._cascadeDistances[t],a=-this._cascadeDistances[t+1],l=(i[10]*o+i[14])/Math.abs(i[11]*o+i[15]),c=(i[10]*a+i[14])/Math.abs(i[11]*a+i[15]);dt(l<c);for(let p=0;p<8;++p){qi(bse,p%4==0||p%4==3?-1:1,p%4==0||p%4==1?-1:1,p<4?l:c,1),Qc(Ml[p],bse,_se);for(let f=0;f<3;++f)Ml[p][f]/=Ml[p][3]}qo(Cz,Ml[0]),Aa(yse,Ese,Cz),n.camera.viewMatrix=yse;for(let p=0;p<8;++p)Ue(Ml[p],Ml[p],n.camera.viewMatrix);se(up,Ml[0]),se(hp,Ml[0]);for(let p=1;p<8;++p)for(let f=0;f<3;++f)up[f]=Math.min(up[f],Ml[p][f]),hp[f]=Math.max(hp[f],Ml[p][f]);up[2]-=200,hp[2]+=200,n.camera.near=-hp[2],n.camera.far=-up[2],this.warp?this._constructTrapezoidalProjection(r,s,n):this._constructOrthogonalProjection(n),Nr(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const h=this._textureSize/2;n.camera.viewport[0]=t%2==0?0:h,n.camera.viewport[1]=Math.floor(t/2)===0?0:h,n.camera.viewport[2]=h,n.camera.viewport[3]=h}_constructOrthogonalProjection(t){$q(t.camera.projectionMatrix,up[0],hp[0],up[1],hp[1],t.camera.near,t.camera.far)}_constructTrapezoidalProjection(t,i,r){const s=1/Ml[0][3],n=1/Ml[4][3];dt(s<n);let o=s+Math.sqrt(s*n);const a=Math.sin(tn(t[2]*i[0]+t[6]*i[1]+t[10]*i[2]));o/=a,BKe(Ml,o,a,wse,xse,VKe,Tse,Sse),GKe(wse,xse,Tse,Sse,r.camera.projectionMatrix),r.camera.projectionMatrix[10]=2/(up[2]-hp[2]),r.camera.projectionMatrix[14]=-(up[2]+hp[2])/(up[2]-hp[2])}_setupMatrices(t,i){Nr(vse,t.projectionMatrix,t.viewMatrix),cs(_se,vse);const r=this.viewingMode===Ve.Global?t.eye:ie(Cz,0,0,1);C4(Ese,[0,0,0],[-i[0],-i[1],-i[2]],r)}_clampNearFar(t){let{near:i,far:r}=t;return i<2&&(i=2),r<2&&(r=2),i>=r&&(i=2,r=4),{near:i,far:r}}_computeCascadeDistances(t,i){this.numCascades=Math.min(1+Math.floor(oHe(t/i,4)),this.maxNumCascades);const r=(t-i)/this.numCascades,s=(t/i)**(1/this.numCascades);let n=i,o=i;for(let a=0;a<this.numCascades+1;++a)this._cascadeDistances[a]=jt(n,o,this.splitSchemeLambda),n*=s,o+=r}get gpuMemoryUsage(){var t,i;return this._snapshots.reduce((r,s)=>r+Bb(s),(i=(t=this._fbo)==null?void 0:t.gpuMemoryUsage)!=null?i:0)}get test(){const t=this;return{maxNumCascades:this.maxNumCascades,cascades:this._cascades,textureSize:this._textureSize,set splitSchemeLambda(i){t.splitSchemeLambda=i},get splitSchemeLambda(){return t.splitSchemeLambda},set warp(i){t.warp=i},get warp(){return t.warp}}}}const yse=Ae(),vse=Ae(),_se=Ae(),bse=Gt(),Ml=[];for(let e=0;e<8;++e)Ml.push(Gt());const up=O(),hp=O(),wse=tt(),xse=tt(),VKe=tt(),Tse=tt(),Sse=tt(),Ese=Ae(),Cz=O(),Az=[],Cse=Ae(),Ase=new Float32Array(64),yc=tt(),Ww=tt(),f_=[tt(),tt(),tt(),tt()],rn=tt(),Rz=tt(),cy=tt(),JE=tt(),Xw=tt(),Yw=tt(),fI=tt();function BKe(e,t,i,r,s,n,o,a){hi(yc,0,0);for(let C=0;C<4;++C)wd(yc,yc,e[C]);jl(yc,yc,.25),hi(Ww,0,0);for(let C=4;C<8;++C)wd(Ww,Ww,e[C]);jl(Ww,Ww,.25),nT(f_[0],e[4],e[5],.5),nT(f_[1],e[5],e[6],.5),nT(f_[2],e[6],e[7],.5),nT(f_[3],e[7],e[4],.5);let l=0,c=HN(f_[0],yc);for(let C=1;C<4;++C){const M=HN(f_[C],yc);M<c&&(c=M,l=C)}rf(rn,f_[l],e[l+4]);const h=rn[0];let p,f;rn[0]=-rn[1],rn[1]=h,rf(Rz,Ww,yc),Bs(Rz,rn)<0&&AX(rn,rn),nT(rn,rn,Rz,i),yM(rn,rn),p=f=Bs(rf(cy,e[0],yc),rn);for(let C=1;C<8;++C){const M=Bs(rf(cy,e[C],yc),rn);M<p?p=M:M>f&&(f=M)}ro(r,yc),jl(cy,rn,p-t),wd(r,r,cy);let m=-1,y=1,v=0,w=0;for(let C=0;C<8;++C){rf(JE,e[C],r),yM(JE,JE);const M=rn[0]*JE[1]-rn[1]*JE[0];M>0?M>m&&(m=M,v=C):M<y&&(y=M,w=C)}Nw(m>0,"leftArea"),Nw(y<0,"rightArea"),jl(Xw,rn,p),wd(Xw,Xw,yc),jl(Yw,rn,f),wd(Yw,Yw,yc),fI[0]=-rn[1],fI[1]=rn[0];const b=IP(r,e[w],Yw,wd(cy,Yw,fI),1,s),S=IP(r,e[v],Yw,cy,1,n),T=IP(r,e[v],Xw,wd(cy,Xw,fI),1,o),E=IP(r,e[w],Xw,cy,1,a);Nw(b,"rayRay"),Nw(S,"rayRay"),Nw(T,"rayRay"),Nw(E,"rayRay")}function oi(e,t){return 3*t+e}const Rse=tt();function vl(e,t){return hi(Rse,e[t],e[t+3]),Rse}const Na=tt(),Qe=Sr();function GKe(e,t,i,r,s){rf(Na,i,r),jl(Na,Na,.5),Qe[0]=Na[0],Qe[1]=Na[1],Qe[2]=0,Qe[3]=Na[1],Qe[4]=-Na[0],Qe[5]=0,Qe[6]=Na[0]*Na[0]+Na[1]*Na[1],Qe[7]=Na[0]*Na[1]-Na[1]*Na[0],Qe[8]=1,Qe[oi(0,2)]=-Bs(vl(Qe,0),e),Qe[oi(1,2)]=-Bs(vl(Qe,1),e);let n=Bs(vl(Qe,0),i)+Qe[oi(0,2)],o=Bs(vl(Qe,1),i)+Qe[oi(1,2)],a=Bs(vl(Qe,0),r)+Qe[oi(0,2)],l=Bs(vl(Qe,1),r)+Qe[oi(1,2)];n=-(n+a)/(o+l),Qe[oi(0,0)]+=Qe[oi(1,0)]*n,Qe[oi(0,1)]+=Qe[oi(1,1)]*n,Qe[oi(0,2)]+=Qe[oi(1,2)]*n,n=1/(Bs(vl(Qe,0),i)+Qe[oi(0,2)]),o=1/(Bs(vl(Qe,1),i)+Qe[oi(1,2)]),Qe[oi(0,0)]*=n,Qe[oi(0,1)]*=n,Qe[oi(0,2)]*=n,Qe[oi(1,0)]*=o,Qe[oi(1,1)]*=o,Qe[oi(1,2)]*=o,Qe[oi(2,0)]=Qe[oi(1,0)],Qe[oi(2,1)]=Qe[oi(1,1)],Qe[oi(2,2)]=Qe[oi(1,2)],Qe[oi(1,2)]+=1,n=Bs(vl(Qe,1),t)+Qe[oi(1,2)],o=Bs(vl(Qe,2),t)+Qe[oi(2,2)],a=Bs(vl(Qe,1),i)+Qe[oi(1,2)],l=Bs(vl(Qe,2),i)+Qe[oi(2,2)],n=-.5*(n/o+a/l),Qe[oi(1,0)]+=Qe[oi(2,0)]*n,Qe[oi(1,1)]+=Qe[oi(2,1)]*n,Qe[oi(1,2)]+=Qe[oi(2,2)]*n,n=Bs(vl(Qe,1),t)+Qe[oi(1,2)],o=Bs(vl(Qe,2),t)+Qe[oi(2,2)],a=-o/n,Qe[oi(1,0)]*=a,Qe[oi(1,1)]*=a,Qe[oi(1,2)]*=a,s[0]=Qe[0],s[1]=Qe[1],s[2]=0,s[3]=Qe[2],s[4]=Qe[3],s[5]=Qe[4],s[6]=0,s[7]=Qe[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=Qe[6],s[13]=Qe[7],s[14]=0,s[15]=Qe[8]}class wbe{constructor(){this.adds=new Bt,this.removes=new Bt,this.updates=new Bt({allocator:t=>t||new jKe,deallocator:t=>(t.renderGeometry=null,t)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}}class jKe{}class HKe{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}}var Zt;(function(e){var t,i;(t=e.Geometry||(e.Geometry={}))[t.ADD=1]="ADD",t[t.UPDATE=2]="UPDATE",t[t.REMOVE=4]="REMOVE",(i=e.State||(e.State={}))[i.VISIBILITIES=1]="VISIBILITIES",i[i.VERTEXATTRS=2]="VERTEXATTRS",i[i.TRANSFORMATION=4]="TRANSFORMATION",i[i.HIGHLIGHTS=8]="HIGHLIGHTS",i[i.OCCLUDEES=16]="OCCLUDEES"})(Zt||(Zt={}));function xbe(e){const t=new Map,i=r=>{let s=t.get(r);return s||(s=new HKe,t.set(r,s)),s};return e.removes.forAll(r=>{Mz(r)&&i(r.material).removes.push(r)}),e.adds.forAll(r=>{Mz(r)&&i(r.material).adds.push(r)}),e.updates.forAll(r=>{Mz(r.renderGeometry)&&i(r.renderGeometry.material).updates.push(r)}),t}function Mz(e){return e.data.indexCount>=1}function qKe(e){const t=x`vec3 decodeNormal(vec2 f) {
float z = 1.0 - abs(f.x) - abs(f.y);
return vec3(f + sign(f) * min(z, 0.0), z);
}`;e.fragment.code.add(t),e.vertex.code.add(t)}function q5(e,t){t.normalType===Tr.Attribute&&(e.attributes.add(A.NORMAL,"vec3"),e.vertex.code.add(x`vec3 normalModel() {
return normal;
}`)),t.normalType===Tr.CompressedAttribute&&(e.include(qKe),e.attributes.add(A.NORMALCOMPRESSED,"vec2"),e.vertex.code.add(x`vec3 normalModel() {
return decodeNormal(normalCompressed);
}`)),t.normalType===Tr.ScreenDerivative&&(e.extensions.add("GL_OES_standard_derivatives"),e.fragment.code.add(x`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`))}var Tr;(function(e){e[e.Attribute=0]="Attribute",e[e.CompressedAttribute=1]="CompressedAttribute",e[e.Ground=2]="Ground",e[e.ScreenDerivative=3]="ScreenDerivative",e[e.COUNT=4]="COUNT"})(Tr||(Tr={}));function W5(e){e.attributes.add(A.POSITION,"vec3"),e.vertex.code.add(x`vec3 positionModel() { return position; }`)}function TF({code:e},t){t.doublePrecisionRequiresObfuscation?e.add(x`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):e.add(x`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}function r3(e){return!!he("force-double-precision-obfuscation")||e.driverTest.doublePrecisionRequiresObfuscation}function hS(e,t){e.include(W5);const i=e.vertex;i.include(TF,t),e.varyings.add("vPositionWorldCameraRelative","vec3"),e.varyings.add("vPosition_view","vec3"),i.uniforms.add([new xt("transformWorldFromViewTH",r=>r.transformWorldFromViewTH),new xt("transformWorldFromViewTL",r=>r.transformWorldFromViewTL),new ZO("transformViewFromCameraRelativeRS",r=>r.transformViewFromCameraRelativeRS),new vr("transformProjFromView",r=>r.transformProjFromView),new xM("transformWorldFromModelRS",r=>r.transformWorldFromModelRS),new Sa("transformWorldFromModelTH",r=>r.transformWorldFromModelTH),new Sa("transformWorldFromModelTL",r=>r.transformWorldFromModelTL)]),i.code.add(x`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),i.code.add(x`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${t.spherical?x`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:x`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),e.fragment.uniforms.add(new xt("transformWorldFromViewTL",r=>r.transformWorldFromViewTL)),i.code.add(x`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),e.fragment.code.add(x`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}class Tbe extends Us{constructor(){super(...arguments),this.transformWorldFromViewTH=O(),this.transformWorldFromViewTL=O(),this.transformViewFromCameraRelativeRS=Sr(),this.transformProjFromView=Ae()}}class Sbe extends Us{constructor(){super(...arguments),this.transformWorldFromModelRS=Sr(),this.transformWorldFromModelTH=wi(),this.transformWorldFromModelTL=wi()}}function X5(e,t){t.normalType===Tr.Attribute||t.normalType===Tr.CompressedAttribute?(e.include(q5,t),e.varyings.add("vNormalWorld","vec3"),e.varyings.add("vNormalView","vec3"),e.vertex.uniforms.add([new xM("transformNormalGlobalFromModel",i=>i.transformNormalGlobalFromModel),new ZO("transformNormalViewFromGlobal",i=>i.transformNormalViewFromGlobal)]),e.vertex.code.add(x`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`)):t.normalType===Tr.Ground?(e.include(hS,t),e.varyings.add("vNormalWorld","vec3"),e.vertex.code.add(x`
    void forwardNormal() {
      vNormalWorld = ${t.spherical?x`normalize(vPositionWorldCameraRelative);`:x`vec3(0.0, 0.0, 1.0);`}
    }
    `)):e.vertex.code.add(x`void forwardNormal() {}`)}class Ebe extends Tbe{constructor(){super(...arguments),this.transformNormalViewFromGlobal=Sr()}}class Cbe extends Sbe{constructor(){super(...arguments),this.transformNormalGlobalFromModel=Sr(),this.toMapSpace=Gt()}}class nj extends Cbe{constructor(t=O()){super(),this.origin=t,this.slicePlaneLocalOrigin=this.origin}}function s3(e,t){t.output===J.Color&&t.receiveShadows?(e.varyings.add("linearDepth","float"),e.vertex.code.add(x`void forwardLinearDepth() { linearDepth = gl_Position.w; }`)):t.output===J.Depth||t.output===J.Shadow?(e.include(hS,t),e.varyings.add("linearDepth","float"),e.vertex.uniforms.add(new di("nearFar",(i,r)=>r.camera.nearFar)),e.vertex.code.add(x`void forwardLinearDepth() {
linearDepth = (-vPosition_view.z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)):e.vertex.code.add(x`void forwardLinearDepth() {}`)}function X0(e,t){t.spherical?e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):e.vertex.code.add(x`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),t.spherical?e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):e.vertex.code.add(x`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}class n3 extends jr{constructor(t,i){super(t,"int",$i.Pass,(r,s,n)=>r.setUniform1i(t,i(s,n)))}}class Abe extends jr{constructor(t,i,r,s){switch(i){case $i.Pass:return void super(t,"mat4",i,(n,o,a)=>n.setUniformMatrix4fv(t,r(o,a)),s);case $i.Draw:return void super(t,"mat4",i,(n,o,a)=>n.setUniformMatrix4fv(t,r(o,a)),s)}}}class Rbe extends Us{constructor(){super(...arguments),this.origin=O()}}function Y5(e,t){t.receiveShadows&&(e.fragment.uniforms.add(new Abe("shadowMapMatrix",$i.Pass,(i,r)=>r.shadowMap.getShadowMapMatrices(i.origin),4)),Mbe(e))}function tw(e,t){t.receiveShadows&&(e.fragment.uniforms.add(new Abe("shadowMapMatrix",$i.Draw,(i,r)=>r.shadowMap.getShadowMapMatrices(i.origin),4)),Mbe(e))}function Mbe(e){const t=e.fragment;t.include(uc),t.uniforms.add([new zt("shadowMapTex",(i,r)=>r.shadowMap.depthTexture),new n3("numCascades",(i,r)=>r.shadowMap.numCascades),new ei("cascadeDistances",(i,r)=>r.shadowMap.cascadeDistances),new We("depthHalfPixelSz",(i,r)=>.5/r.shadowMap.textureSize)]),t.code.add(x`int chooseCascade(float depth, out mat4 mat) {
vec4 distance = cascadeDistances;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + 0.5 * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture2D(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float halfPixelSize, sampler2D _depthTex) {
float texSize = 0.5 / halfPixelSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= numCascades) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, depthHalfPixelSz, shadowMapTex);
}`)}function WKe(e){e.fragment.code.add(x`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function XKe(e){e.fragment.code.add(x`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}function YKe(e){const t=e.fragment.code;t.add(x`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),t.add(x`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),t.add(x`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function Z5(e,t){const i=e.fragment.code;e.include(d5),t.pbrMode===Rt.Water||t.pbrMode===Rt.WaterOnIntegratedMesh?(i.add(x`
    struct PBRShadingWater
    {
        float NdotL;   // cos angle between normal and light direction
        float NdotV;   // cos angle between normal and view direction
        float NdotH;   // cos angle between normal and half vector
        float VdotH;   // cos angle between view direction and half vector
        float LdotH;   // cos angle between light direction and half vector
        float VdotN;   // cos angle between view direction and normal vector
    };

    float dtrExponent = ${t.useCustomDTRExponentForWater?"2.2":"2.0"};
    `),i.add(x`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),i.add(x`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),i.add(x`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),i.add(x`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)):t.pbrMode!==Rt.Normal&&t.pbrMode!==Rt.Schematic||(e.include(YKe),i.add(x`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),i.add(x`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),i.add(x`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`),i.add(x`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),i.add(x`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),i.add(x`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function Obe(e,t){e.include(Z5,t),e.include(u5),e.include(XKe),t.hasCloudsReflections&&e.include(lve,t),t.hasScreenSpaceReflections&&e.include($je,t);const i=e.fragment;i.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),i.code.add(x`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),i.uniforms.add([new We("lightingSpecularStrength",(r,s)=>s.lighting.mainLight.specularStrength),new We("lightingEnvironmentStrength",(r,s)=>s.lighting.mainLight.environmentStrength)]),i.code.add(x`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),t.hasCloudsReflections&&i.code.add(x`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y*cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),t.hasScreenSpaceReflections?i.code.add(x`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view *vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3*dCoords.y), 0.0, 1.0) * heightMod;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture2D(lastFrameColorMap, reprojectedCoordinate).xyz)* reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod*0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor + reflSea * seaColorMod + specular  + foam);`):i.code.add(x`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),t.hasCloudsReflections?t.hasScreenSpaceReflections?i.code.add(x`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):i.code.add(x`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):i.code.add(x`return waterRenderedColor;
}`)}function Mse(e){e.fragment.uniforms.add(new $r("texWaveNormal")),e.fragment.uniforms.add(new $r("texWavePerturbation")),e.fragment.uniforms.add([new ei("waveParams",t=>qi(ZKe,t.waveStrength,t.waveTextureRepeat,t.flowStrength,t.flowOffset)),new di("waveDirection",t=>hi(QKe,t.waveDirection[0]*t.waveVelocity,t.waveDirection[1]*t.waveVelocity))]),e.include(WKe),e.fragment.code.add(x`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture2D(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture2D(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const ZKe=Gt(),QKe=tt();function JKe(e){const t=new Bi,{vertex:i,fragment:r}=t,s=ou(t,e);return t.include(To),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.UV0,"vec2"),i.uniforms.add(new ei("waterColor",n=>n.color)),e.output!==J.Color&&e.output!==J.Alpha||(t.include(X0,e),t.include(s3,e),t.varyings.add("vuv","vec2"),t.varyings.add("vpos","vec3"),t.varyings.add("vnormal","vec3"),t.varyings.add("vtbnMatrix","mat3"),r.uniforms.add(s),e.hasMultipassTerrain&&t.varyings.add("depth","float"),i.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(Eo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${e.output===J.Color?"forwardLinearDepth();":""}
      }
    `)),t.include(yu,e),e.output===J.Alpha&&(t.include(ls,e),r.uniforms.add(new xa("waterColor")),r.code.add(x`
        void main() {
          discardBySlice(vpos);
          ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          gl_FragColor = vec4(waterColor.a);
        }
      `)),e.output===J.Color&&(t.include(VX,{isGround:!1}),t.include(zX,{pbrMode:Rt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(Mse),t.include(ls,e),t.include(tw,e),t.include(Obe,e),r.uniforms.add([new xa("waterColor"),new xt("lightingMainDirection",(n,o)=>o.lighting.lightingMainDirection),new xt("lightingMainIntensity",(n,o)=>o.lighting.mainLight.intensity),new We("timeElapsed",n=>n.timeElapsed),new vv("view")]),Mf(r,e),r.include(Vf),r.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${e.receiveShadows?x`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view*vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, lightingMainDirection, waterColor.rgb, lightingMainIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        gl_FragColor = delinearizeGamma(final);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output===J.Normal&&(t.include(X0,e),t.include(Mse,e),t.include(ls,e),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),i.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(Eo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),r.uniforms.add(new We("timeElapsed",n=>n.timeElapsed)),r.code.add(x`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
gl_FragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`)),e.output===J.Draped&&(t.varyings.add("vpos","vec3"),i.code.add(x`
        void main(void) {
          if (waterColor.a < ${x.float(Eo)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),r.uniforms.add(new xa("waterColor")),r.code.add(x`void main() {
gl_FragColor = waterColor;
}`)),e.output===J.Highlight&&(t.include(Bg),t.varyings.add("vpos","vec3"),i.code.add(x`
      void main(void) {
        if (waterColor.a < ${x.float(Eo)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),t.include(ls,e),r.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const KKe=Object.freeze(Object.defineProperty({__proto__:null,build:JKe},Symbol.toStringTag,{value:"Module"}));class Q5 extends lr{constructor(t,i,r){super(t,i,r),this._textureRepository=t.waterTextureRepository}initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global,i.doublePrecisionRequiresObfuscation=r3(t.rctx)}initializeProgram(t){const i=Q5.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}bindPass(t,i){this.program.bindPass(t,i),this.configuration.output!==J.Color&&this.configuration.output!==J.Normal||this._textureRepository.bind(this.program)}_setPipelineState(t){const i=this.configuration,r=t===gt.NONE,s=t===gt.FrontFace;return Ut({blending:i.output!==J.Normal&&i.output!==J.Highlight&&i.transparent?r?au:Gg(t):null,depthTest:{func:Vv(t)},depthWrite:r?i.writeDepth&&pl:D5(t),colorWrite:Jt,polygonOffset:r||s?null:F5(i.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}Q5.shader=new Qi(KKe,()=>import("./WaterSurface.glsl.95e029c8.js"));class zn extends Ho{constructor(){super(...arguments),this.output=J.Color,this.transparencyPassType=gt.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}u([G({count:J.COUNT})],zn.prototype,"output",void 0),u([G({count:gt.COUNT})],zn.prototype,"transparencyPassType",void 0),u([G()],zn.prototype,"spherical",void 0),u([G()],zn.prototype,"receiveShadows",void 0),u([G()],zn.prototype,"hasSlicePlane",void 0),u([G()],zn.prototype,"transparent",void 0),u([G()],zn.prototype,"enableOffset",void 0),u([G()],zn.prototype,"writeDepth",void 0),u([G()],zn.prototype,"hasScreenSpaceReflections",void 0),u([G()],zn.prototype,"doublePrecisionRequiresObfuscation",void 0),u([G()],zn.prototype,"hasCloudsReflections",void 0),u([G()],zn.prototype,"isDraped",void 0),u([G()],zn.prototype,"hasMultipassTerrain",void 0),u([G()],zn.prototype,"cullAboveGround",void 0),u([G({constValue:Rt.Water})],zn.prototype,"pbrMode",void 0),u([G({constValue:!0})],zn.prototype,"useCustomDTRExponentForWater",void 0),u([G({constValue:!0})],zn.prototype,"highStepCount",void 0),u([G({constValue:!1})],zn.prototype,"useFillLights",void 0);class Ose extends kv{_updateShadowState(t){t.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:t.shadowMap.enabled})}_updateSSRState(t){t.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:t.ssr.enabled})}_updateCloudsReflectionState(t){const i=_(t.clouds.data);i!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:i})}ensureResources(t){const i=this._techniqueRepository.constructionContext.waterTextureRepository;return i.resourceState===kl.NOT_LOADED&&i.loadTextures(t),i.resourceState}beginSlot(t){return this._output===J.Color&&(this._updateShadowState(t),this._updateSSRState(t),this._updateCloudsReflectionState(t)),this.ensureTechnique(Q5,t)}}const eet=Kr().vec3f(A.POSITION),tet=Kr().vec3f(A.POSITION).vec2f(A.UV0),Pbe=Kr().vec3f(A.POSITION).vec4u8(A.COLOR);class J5{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(A.POSITION).length}write(t,i,r,s){I5(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}class Ibe extends Gf{constructor(t){super(t,new $be),this._techniqueConfig=new zn,this.animation=new Pve}getConfiguration(t,i){return this._techniqueConfig.output=t,this._techniqueConfig.writeDepth=this.parameters.writeDepth,this._techniqueConfig.receiveShadows=this.parameters.receiveShadows,this._techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this._techniqueConfig.transparent=this.parameters.transparent,this._techniqueConfig.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._techniqueConfig.hasCloudsReflections=this.parameters.hasCloudsReflections,this._techniqueConfig.isDraped=this.parameters.isDraped,this._techniqueConfig.transparencyPassType=i.transparencyPassType,this._techniqueConfig.enableOffset=i.camera.relativeElevation<L5,this._techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this._techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this._techniqueConfig}update(t){const i=Math.min(t.camera.relativeElevation,t.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*i<iet;const r=this.animation.advance(t);return this.setParameters({timeElapsed:CH(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&r}intersect(t,i,r,s,n,o,a){O5(t,i,s,n,o,void 0,a)}requiresSlot(t,i){switch(ew(i)){case J.Normal:return t===Se.DRAPED_WATER;case J.Color:if(this.parameters.isDraped)return t===Se.DRAPED_MATERIAL;break;case J.Highlight:return t===Se.OPAQUE_MATERIAL||t===Se.DRAPED_MATERIAL}let r=Se.OPAQUE_MATERIAL;return this.parameters.transparent&&(r=this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),t===r}createGLMaterial(t){if(t.output===J.Color&&this.parameters.isDraped)return t.output=J.Draped,new Ose(t);switch(t.output){case J.Color:case J.Normal:case J.Highlight:case J.Alpha:return new Ose(t)}return null}createBufferWriter(){return new J5(tet)}}class $be extends uE{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=Oi(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=fi(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1}}const iet=35e3;class Pse{constructor(t){this.first=t.from,this.count=t.to-t.from}}class aT{constructor(t=0,i=0){this.from=t,this.to=i}}class ret extends aT{constructor(t,i,r,s,n,o){super(i,r),this.id=t,this.isVisible=s,this.hasHighlights=n,this.hasOccludees=o}}function Ise(e){return Array.from(e.values()).sort(set)}function set(e,t){return e.from===t.from?e.to-t.to:e.from-t.from}function mI(e,t){if(e.length===0)return void e.push(new Pse(t));const i=e[e.length-1];if(net(i,t)){const r=t.from-i.first+t.to-t.from;i.count=r}else e.push(new Pse(t))}function net(e,t){return e.first+e.count>=t.from}class oet{constructor(t,i){this._pool=t,this._size=0,this._buffer=t.newBuffer(oj(i))}dispose(){this._buffer=this._pool.deleteBuffer(this._buffer),this._size=0}release(){this.erase(0,this._size),this.dispose()}get vao(){return this._buffer.vao}get array(){return this._buffer.array}get size(){return this._size}grow(t){this._resize(this._size+t,!0).dispose()}alloc(t){return this._resize(t,!1)}_resize(t,i){let r;const s=aet(this._buffer.length,this._size,t);if(this._buffer.length!==s){const o=this._pool.newBuffer(s);i&&(o.array.set(this._buffer.array.subarray(0,Math.min(this._size,s))),o.vao.vertexBuffers.geometry.setSubData(o.array,0,0,o.array.byteLength)),r=this._buffer,this._buffer=o}const n=this._size;return this._size=t,r?{dispose:()=>{r.array.fill(0,0,n),this._pool.deleteBuffer(r)},copy:(o,a,l)=>this._buffer.array.set(r.array.subarray(a,l),o),hasNewBuffer:!0}:{dispose:()=>{},copy:(o,a,l)=>{o!==a&&this._buffer.array.copyWithin(o,a,l)},hasNewBuffer:!1}}erase(t,i){this._buffer.array.fill(0,t,i)}}const $se=65536;function oj(e){return Math.ceil(e/$se)*$se}function aet(e,t,i){return t<=i?e>=i?e:oj(Math.max(2*e,i)):e<=2*i?e:oj(i)}class cet{constructor(t,i,r,s){this.vao=new Ns(t,i,{geometry:r},{geometry:ti.createVertex(t,yi.STATIC_DRAW)}),this.array=new Float32Array(s),this.vao.vertexBuffers.geometry.setSize(this.array.byteLength)}dispose(){this.vao.dispose(!0)}get length(){return this.array.length}}const uet=oD+1;class het{constructor(t,i,r){this._rctx=t,this._locations=i,this._layout=r,this._cache=t.newCache(`MergedRenderer pool ${sl()}`,det)}dispose(){this._cache.destroy()}newBuffer(t){const i=t.toString(),r=this._cache.pop(i);if(_(r)){const s=r.pop();return r.length>0&&this._cache.put(i,r,s.array.byteLength*r.length,uet),s}return new cet(this._rctx,this._locations,this._layout,t)}deleteBuffer(t){const i=t.array.byteLength,r=t.array.length.toString(),s=this._cache.pop(r);return _(s)?(s.push(t),this._cache.put(r,s,i*s.length,-1)):this._cache.put(r,[t],i,-1),null}}function det(e,t){if(t===jm.ALL)return void e.forEach(s=>s.dispose());const i=e.pop(),r=e.length*i.array.byteLength;return i.dispose(),r}class Dbe{constructor(t,i,r){this._rctx=t,this._materialRepository=i,this._material=r,this.type="MergedRenderer",this._dataByOrigin=new Map,this._renderCommandData=new Bt,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new dbe(this._material,this._materialRepository),this._bufferWriter=r.createBufferWriter(),this._bufferPool=new het(t,r.vertexAttributeLocations,hc(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach(t=>t.buffer.dispose()),this._dataByOrigin.clear(),this._bufferPool.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this._material instanceof Ibe}get rendersOccluded(){return!this.isEmpty&&this._material.renderOccluded!==Mr.Occlude}modify(t){this._updateGeometries(t.updates),this._addAndRemoveGeometries(t.adds,t.removes),this._updateRenderCommands()}_addAndRemoveGeometries(t,i){const r=this._bufferWriter,s=r.vertexBufferLayout.stride/4,n=this._dataByOrigin,o=fet(t,i);o.forEach((a,l)=>{o.delete(l);const c=a.toAdd.reduce((b,S)=>b+r.elementCount(S.data),0);let h=n.get(l);if(h==null)dt(a.toRemove.length===0),h=new get(a.origin,new oet(this._bufferPool,c*s)),n.set(l,h);else if(a.toAdd.length===0&&h.instances.size===a.toRemove.length)return h.buffer.dispose(),void n.delete(l);let p=0;h.instances.forEach(b=>p+=b.to-b.from);const f=a.toRemove.reduce((b,S)=>b+r.elementCount(S.data),0),m=h.buffer.size,y=(p+c-f)*s,v=vet;if(y<m/2?this._removeAndRebuild(h,a.toRemove,s,y,v):a.toRemove.length>0&&this._remove(h,a.toRemove,s,v),a.toAdd.length>0){const b=_et;Cve(b,-a.origin[0],-a.origin[1],-a.origin[2]),this._add(h,a.toAdd,s,b,v)}const w=h.buffer.vao.vertexBuffers.geometry;Nse(v),v.forAll(({from:b,to:S})=>{if(b<S){const T=h.buffer.array,E=4,C=b*E,M=S*E;w.setSubData(T,C,C,M)}}),v.clear(),h.drawCommandsDirty=!0})}_updateGeometries(t){const i=this._bufferWriter,r=i.vertexBufferLayout.stride/4;for(const s of t){const n=s.renderGeometry,o=this._dataByOrigin.get(n.origin.id),a=o&&o.instances.get(n.id);if(!a)return;const l=s.updateType;if(l&Zt.State.VISIBILITIES&&(a.isVisible=n.instanceParameters.visible),l&(Zt.State.HIGHLIGHTS|Zt.State.VISIBILITIES)){const c=n.instanceParameters.visible;a.hasHighlights=!!n.instanceParameters.highlights&&c}if(l&Zt.State.OCCLUDEES&&(a.hasOccludees=!!n.instanceParameters.occludees),l&(Zt.State.VERTEXATTRS|Zt.State.TRANSFORMATION)){const{array:c,vao:h}=o.buffer;$qe(n,Oz,KE),i.write({transformation:Oz,invTranspTransformation:KE},n.data,i.vertexBufferLayout.createView(c.buffer),a.from),dt(a.from+i.elementCount(n.data)===a.to,"material VBO layout has changed"),h.vertexBuffers.geometry.setSubData(c,a.from*r*4,a.from*r*4,a.to*r*4)}o.drawCommandsDirty=!0}}_updateRenderCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(i=>{i.hasHiddenInstances=!1,i.hasHighlights=!1,i.hasOccludees=!1,Ws(i.instances,r=>(r.isVisible?(r.hasHighlights&&(this._hasHighlights=!0,i.hasHighlights=!0),r.hasOccludees&&(this._hasOccludees=!0,i.hasOccludees=!0)):i.hasHiddenInstances=!0,i.hasHiddenInstances&&i.hasHighlights&&i.hasOccludees))});const t=i=>{if(i.drawCommandsDefault=null,i.drawCommandsHighlight=null,i.drawCommandsOccludees=null,i.drawCommandsShadowHighlightRest=null,i.instances.size===0)return;if(!Lse(i)){const s=this._bufferWriter.vertexBufferLayout.stride,n=4*i.buffer.size/s;return void(i.drawCommandsDefault=[{first:0,count:n}])}const r=Ise(i.instances);i.drawCommandsDefault=[],i.drawCommandsHighlight=[],i.drawCommandsOccludees=[],i.drawCommandsShadowHighlightRest=[];for(const s of r)s.isVisible&&(s.hasOccludees?mI(i.drawCommandsOccludees,s):mI(i.drawCommandsDefault,s),s.hasHighlights?mI(i.drawCommandsHighlight,s):mI(i.drawCommandsShadowHighlightRest,s))};this._dataByOrigin.forEach(i=>{i.drawCommandsDirty&&(t(i),i.drawCommandsDirty=!1)})}updateAnimation(t){return this._material.update(t)}requiresSlot(t,i){return t==null||this._material.requiresSlot(t,i)}render(t,i){if(!this.requiresSlot(i.slot,t))return!1;const r=t===je.MATERIAL_HIGHLIGHT||t===je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT;if(r&&!this._hasHighlights)return!1;const s=t===je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,n=!(r||s);if(this._dataByOrigin.forEach(c=>{if(r&&!c.hasHighlights)return;const h=(r?c.drawCommandsHighlight:s&&Lse(c)?c.drawCommandsShadowHighlightRest:c.drawCommandsDefault)||null,p=n&&c.drawCommandsOccludees||null;(_(h)||_(p))&&this._renderCommandData.push(new yet(c.origin,c.buffer,h,p))}),this._renderCommandData.length===0)return!1;const o=this._rctx,a=this._glMaterials.load(o,t);if(R(a))return this._renderCommandData.clear(),!1;const l=a.beginSlot(i);return o.bindTechnique(l,this._material.parameters,i,!1),this._renderCommandData.forAll(c=>{l.bindDraw(c,i);const{buffer:h,renderCommands:p,occludeeCommands:f}=c;l.ensureAttributeLocations(h.vao),o.bindVAO(h.vao);const m=l.primitiveType;_(p)&&this._renderCommands(o,m,p),_(f)&&(l.bindPipelineState(o,i.slot,!0),this._renderCommands(o,m,f),l.bindPipelineState(o,i.slot,!1))}),this._renderCommandData.clear(),!0}_renderCommands(t,i,r){for(let s=0;s<r.length;s++)t.drawArrays(i,r[s].first,r[s].count)}_removeAndRebuild(t,i,r,s,n){for(const h of i)t.instances.delete(h.id);const o=Ise(t.instances);t.instances.clear();const a=t.buffer.size,l=t.buffer.alloc(s);let c=0;for(const h of o){const p=h.from*r,f=h.to*r;l.copy(c,p,f),h.from=c/r,c+=f-p,h.to=c/r,t.instances.set(h.id,h)}n.push(new aT(0,l.hasNewBuffer?t.buffer.array.length:a)),l.dispose(),t.buffer.erase(c,n.back().to),t.holes.clear()}_remove(t,i,r,s){for(const n of i){const o=n.id,a=t.instances.get(o),l=a.from*r,c=a.to*r;t.buffer.erase(l,c),t.holes.push(new aT(a.from,a.to)),t.instances.delete(o),s.push(new aT(l,c))}Nse(t.holes)}_add(t,i,r,s,n){if(i.length===0)return;const o=this._bufferWriter;let a=o.vertexBufferLayout.createView(t.buffer.array.buffer);const l=t.holes.length>0;let c=Number.MAX_SAFE_INTEGER,h=Number.MIN_SAFE_INTEGER;for(const p of i){const f=_(p.transformation)?Nr(Oz,s,p.transformation):s;cs(KE,f);const m=dl(KE,KE),y=o.elementCount(p.data),v=y*r;let w=met(t.holes,y);R(w)&&(w=t.buffer.size/r,t.buffer.grow(v),a=o.vertexBufferLayout.createView(t.buffer.array.buffer)),o.write({transformation:f,invTranspTransformation:m},p.data,a,w);const b=p.instanceParameters.visible,S=!!p.instanceParameters.highlights&&b,T=!!p.instanceParameters.occludees,E=new ret(p.id,w,w+y,b,S,T);dt(t.instances.get(p.id)==null),t.instances.set(p.id,E),l?n.push(new aT(E.from*r,E.to*r)):(c=Math.min(E.from,c),h=Math.max(E.to,h))}l||n.push(new aT(c*r,h*r))}get test(){return{material:this._material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}}class pet{constructor(t){this.origin=t,this.toAdd=new Array,this.toRemove=new Array}}function fet(e,t){const i=new Map;for(const r of e)Dse(i,r,!0);for(const r of t)Dse(i,r,!1);return i}function Dse(e,t,i){const r=t.origin;if(R(r))return;let s=e.get(r.id);s==null&&(s=new pet(r.vec3),e.set(r.id,s)),i?s.toAdd.push(t):s.toRemove.push(t)}function Lse(e){return e.hasOccludees||e.hasHighlights||e.hasHiddenInstances}function met(e,t){let i;if(!e.some(s=>!(s.to-s.from<t)&&(i=s,!0)))return null;const r=i.from;return i.from+=t,i.from>=i.to&&e.removeUnordered(i),r}function Nse(e){const t=new Map;e.forAll(r=>t.set(r.from,r));let i=!0;for(;i;)i=!1,e.forEach(r=>{const s=t.get(r.to);s&&(r.to=s.to,t.delete(s.from),e.removeUnordered(s),i=!0)})}class get{constructor(t,i){this.origin=t,this.buffer=i,this.instances=new Map,this.holes=new Bt({deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!1}}class yet extends nj{constructor(t,i,r,s){super(t),this.buffer=i,this.renderCommands=r,this.occludeeCommands=s}}const vet=new Bt({deallocator:null}),_et=Ae(),Oz=Ae(),KE=Ae();let qp=class extends Ee{constructor(e){super(e),this._pending=new bet,this._changes=new wbe,this._materialRenderers=new Map,this._sortedMaterialRenderers=new Bt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return Ws(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=xbe(this._changes);let t=!1,i=!1,r=!1;return e.forEach((s,n)=>{let o=this._materialRenderers.get(n);if(!o&&s.adds.length>0&&(o=new Dbe(this.rctx,this._materialRepository,n),this._materialRenderers.set(n,o),t=!0,i=!0,r=!0),!o)return;const a=i||o.hasHighlights,l=r||o.hasWater;o.modify(s),i=i||a!==o.hasHighlights,r=r||l!==o.hasWater,o.isEmpty&&(this._materialRenderers.delete(n),o.dispose(),t=!0)}),this._changes.clear(),t&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=Ws(this._materialRenderers,s=>s.hasHighlights)),r&&(this._hasWater=Ws(this._materialRenderers,s=>s.hasWater)),this.notifyChange("updating"),!0}addGeometries(e,t){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const s of i)this._geometries.set(s.id,s);const r=this._pending.empty;for(const s of i)this._pending.adds.add(s);r&&this.notifyChange("updating"),t===Zt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,t){const i=this._pending.empty,r=this._pending.adds;for(const s of e)r.has(s)?(this._pending.removed.add(s),r.delete(s)):this._pending.removed.has(s)||this._pending.removes.add(s),this._geometries.delete(s.id);i&&!this._pending.empty&&this.notifyChange("updating"),t===Zt.Geometry.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,t){const i=this._changes.updates.length===0;for(const r of e){const s=this._changes.updates.pushNew();s.renderGeometry=this._validateRenderGeometry(r),s.updateType=t}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),t){case Zt.State.TRANSFORMATION:case Zt.State.VERTEXATTRS:return this._notifyGraphicGeometryChanged(e);case Zt.State.VISIBILITIES:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let t=!1;return this._sortedMaterialRenderers.forAll(({materialRenderer:i})=>t=i.updateAnimation(e)||t),t}render(e,t){for(let i=0;i<this._sortedMaterialRenderers.length;i++){const r=this._sortedMaterialRenderers.data[i];r.material.shouldRender(e)&&r.materialRenderer.render(e.pass,t)}}intersect(e,t,i,r,s){return this._geometries.forEach(n=>{if(r&&!r(n))return;this._intersectRenderGeometry(n,i,t,0,e,s);const o=this.rendererContext.longitudeCyclical;o&&(n.boundingSphere[0]-n.boundingSphere[3]<o.min&&this._intersectRenderGeometry(n,i,t,o.range,e,s),n.boundingSphere[0]+n.boundingSphere[3]>o.max&&this._intersectRenderGeometry(n,i,t,-o.range,e,s)),s++}),s}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((t,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push({material:i,materialRenderer:t})}),this._sortedMaterialRenderers.sort((t,i)=>{const r=i.material.renderPriority-t.material.renderPriority;return r!==0?r:t.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const t=this._changes.updates.data[e];this._pending.has(t.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,t,i,r,s,n){if(!e.instanceParameters.visible)return;let o=0;_(e.transformation)&&(r+=e.transformation[12],o=e.transformation[13]),gI[0]=i[0]-r,gI[1]=i[1]-o,gI[2]=1,yI[0]=i[0]-r,yI[1]=i[1]-o,yI[2]=0,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersect(e,null,e.getShaderTransformation(),s,gI,yI,(a,l,c)=>{wet(t,c,e.material.renderPriority,n,s,e.layerUid,e.graphicUid)},e.calculateShaderTransformation,t)}_notifyGraphicGeometryChanged(e){if(R(this.drapeSource.notifyGraphicGeometryChanged))return;let t;for(const i of e){const r=i.graphicUid;_(r)&&r!==t&&(this.drapeSource.notifyGraphicGeometryChanged(r),t=r)}}_notifyGraphicVisibilityChanged(e){if(R(this.drapeSource.notifyGraphicVisibilityChanged))return;let t;for(const i of e){const r=i.graphicUid;_(r)&&r!==t&&(this.drapeSource.notifyGraphicVisibilityChanged(r),t=r)}}_validateRenderGeometries(e){for(const t of e)this._validateRenderGeometry(t);return e}_validateRenderGeometry(e){return R(e.origin)&&(e.origin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],qp.prototype,"drapeSource",void 0),u([d()],qp.prototype,"updating",null),u([d()],qp.prototype,"rctx",null),u([d()],qp.prototype,"rendererContext",void 0),u([d()],qp.prototype,"_materialRepository",null),u([d()],qp.prototype,"_localOriginFactory",null),qp=u([P("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],qp);class bet{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(t){return this.adds.has(t)||this.removes.has(t)||this.removed.has(t)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}}function wet(e,t,i,r,s,n,o){const a={layerUid:n,graphicUid:o,triangleNr:t},l=c=>{c.set(Dr.OVERLAY,a,e.dist,e.normal,e.transformation,i,r)};if((s.results.min.drapedLayerOrder==null||i>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==io.MIN&&(s.results.max.drapedLayerOrder==null||i<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===io.ALL){const c=sY(s.ray);l(c),s.results.all.push(c)}}const gI=O(),yI=O();function K5(e){e.fragment.uniforms.add(new ei("projInfo",(t,i)=>xet(i))),e.fragment.uniforms.add(new di("zScale",(t,i)=>Lbe(i))),e.fragment.code.add(x`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function xet(e){const t=e.camera.projectionMatrix;return t[11]===0?qi(Fse,2/(e.camera.fullWidth*t[0]),2/(e.camera.fullHeight*t[5]),(1+t[12])/t[0],(1+t[13])/t[5]):qi(Fse,-2/(e.camera.fullWidth*t[0]),-2/(e.camera.fullHeight*t[5]),(1-t[8])/t[0],(1-t[9])/t[5])}const Fse=Gt();function Lbe(e){return e.camera.projectionMatrix[11]===0?hi(Use,0,1):hi(Use,1,0)}const Use=tt();var Pv;(function(e){e[e.SSAO=0]="SSAO",e[e.Blur=1]="Blur",e[e.COUNT=2]="COUNT"})(Pv||(Pv={}));class Nbe extends Ra{constructor(){super(...arguments),this.output=Pv.SSAO}}u([G({count:Pv.COUNT})],Nbe.prototype,"output",void 0);const eC={samples:16,filterRadius:4};function Tet(e){const t=new Bi,i=t.fragment;if(t.include(zv),e.output===Pv.Blur){const r=(eC.filterRadius+1)/2,s=1/(2*r*r);i.include(gu),i.uniforms.add([new $r("normalMap"),new $r("depthMap"),new $r("tex"),new ag("blurSize"),new Pi("projScale"),new di("nearFar",(n,o)=>o.camera.nearFar)]),i.code.add(x`
      void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
        float c = texture2D(tex, uv).r;
        float d = linearDepthFromTexture(depthMap, uv, nearFar);

        float ddiff = d - center_d;

        float w = exp(-r * r * ${x.float(s)} - ddiff * ddiff * sharpness);
        wTotal += w;
        bTotal += w * c;
      }
    `),i.code.add(x`
      void main(void) {
        float b = 0.0;
        float w_total = 0.0;

        float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

        float sharpness = -0.05 * projScale/center_d;
        for (int r = -${x.int(eC.filterRadius)}; r <= ${x.int(eC.filterRadius)}; ++r) {
          float rf = float(r);
          vec2 uvOffset = uv + rf * blurSize;
          blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
        }

        gl_FragColor = vec4(b / w_total);
      }
    `)}return e.output===Pv.SSAO&&(i.include(gu),t.include(K5),i.uniforms.add(new $r("normalMap")),i.uniforms.add(new $r("depthMap")),i.uniforms.add(new $r("rnm")),i.uniforms.add(new Pi("intensity")),i.uniforms.add(new Pi("projScale")),i.uniforms.add(new Pi("radius")),i.uniforms.add(new di("nearFar",(r,s)=>s.camera.nearFar)),i.uniforms.add(new ag("screenSize")),i.uniforms.add(new ag("rnmScale")),i.code.add(x`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn-bias, 0.0);
}`),i.code.add(x`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),t.fragment.uniforms.add(new di("zScale",(r,s)=>Lbe(s))),i.code.add(x`
      void main(void) {
        fillSphere();
        vec3 fres = normalize((texture2D(rnm, uv * rnmScale).xyz * 2.0) - vec3(1.0));
        float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

        if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
          gl_FragColor = vec4(0.0);
          return;
        }

        vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

        // get the normal of current fragment
        vec4 norm4 = texture2D(normalMap, uv);
        vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
        bool isTerrain = norm4.w<0.5;

        float sum = .0;
        vec3 tapPixelPos;

        // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
        // bug or deviation from CE somewhere else?
        float ps = projScale/(2.0 * currentPixelPos.z * zScale.x + zScale.y);

        for(int i = 0; i < ${x.int(eC.samples)}; ++i) {
          vec2 unitOffset = reflect(sphere[i], fres).xy;
          vec2 offset = vec2(-unitOffset * radius * ps);

          //don't use current or very nearby samples
          if ( abs(offset.x)<2.0 || abs(offset.y)<2.0) continue;

          vec2 tc = vec2(gl_FragCoord.xy + offset);
          if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
          vec2 tcTap = tc / screenSize;
          float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

          if (isTerrain) {
            bool isTerrainTap = texture2D(normalMap, tcTap).w<0.5;
            if (isTerrainTap) {
              continue;
            }
          }

          tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

          sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
        }

        // output the result
        float A = max(1.0-sum*intensity/float(${x.int(eC.samples)}),0.0);

        // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4)/2.2
        A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
        gl_FragColor = vec4(A);
      }
    `)),t}const Eet=Object.freeze(Object.defineProperty({__proto__:null,build:Tet},Symbol.toStringTag,{value:"Module"}));class WM extends lr{initializeProgram(t){const i=WM.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({colorWrite:Jt})}}WM.shader=new Qi(Eet,()=>import("./SSAO.glsl.3539b705.js"));class Fbe{constructor(t,i,r){this._techniqueRep=t,this._rctx=i,this._requestRender=r,this._enabled=!1,this._ssaoTechniqueConfig=new Nbe,this.quadVAO=null,this._blurSizePx=2,this._attenuation=.5}dispose(){this.quadVAO=Ye(this.quadVAO)}disposeOffscreenBuffers(){qs(this._ssaoFBO,t=>t.resize(0,0)),qs(this._blur0FBO,t=>t.resize(0,0)),qs(this._blur1FBO,t=>t.resize(0,0))}set enabled(t){t?this._enable():this._disable()}get enabled(){return this._enabled}get ready(){return this.enabled&&_(this._noiseTexture)&&_(this._ssaoFBO)&&_(this._blur0FBO)&&_(this._blur1FBO)}get colorTexture(){return _(this._blur1FBO)?this._blur1FBO.colorTexture:null}get width(){return _(this._ssaoFBO)?this._ssaoFBO.width:-1}get height(){return _(this._ssaoFBO)?this._ssaoFBO.height:-1}computeSSAO(t,i,r){if(!this.enabled||R(i)||R(r)||R(this._noiseTexture)||R(this._ssaoFBO)||R(this._blur0FBO)||R(this._blur1FBO))return;const s=this._rctx,n=t.camera,o=n.fullViewport,a=o[2],l=o[3],c=a/this._blurSizePx,h=l/this._blurSizePx;this._ssaoFBO.resize(a,l),this._blur0FBO.resize(c,h),this._blur1FBO.resize(c,h);const p=1,f=1,m=a*p,y=l*f;s.bindFramebuffer(this._ssaoFBO),s.setViewport(0,0,a,l);const v=s.bindTechnique(this._ssaoTechnique,kse,t);v.setUniform2f("rnmScale",a/this._noiseTexture.descriptor.width,l/this._noiseTexture.descriptor.height);let w=1/n.computeRenderPixelSizeAtDist(1);v.setUniform1f("projScale",w*p),v.setUniform2f("screenSize",m,y);const b=nr(n.eye,n.center);let S=20*n.computeRenderPixelSizeAtDist(b);S=Math.max(.1,S),v.setUniform1f("radius",S),v.setUniform1f("intensity",4*this._attenuation/S**6),v.bindTexture("rnm",this._noiseTexture),v.bindTexture("normalMap",r),v.bindTexture("depthMap",i),R(this.quadVAO)&&(this.quadVAO=Ma(this._rctx)),s.bindVAO(this.quadVAO),s.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this.quadVAO,"geometry"));const T=s.bindTechnique(this._blurTechnique,kse,t);T.bindTexture("tex",this._ssaoFBO.colorTexture),T.bindTexture("normalMap",r),T.bindTexture("depthMap",i),s.setViewport(0,0,m/this._blurSizePx,y/this._blurSizePx),s.bindFramebuffer(this._blur0FBO),T.setUniform2f("screenSize",m,y),T.setUniform2f("blurSize",0,this._blurSizePx*p/y),b>5e4&&(w=Math.max(0,w-(b-5e4))),T.setUniform1f("projScale",w),s.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this.quadVAO,"geometry")),T.setUniform2f("blurSize",this._blurSizePx*f/m,0),s.bindFramebuffer(this._blur1FBO),T.bindTexture("tex",this._blur0FBO.colorTexture),s.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this.quadVAO,"geometry")),s.setViewport(o[0],o[1],o[2],o[3])}_selectPrograms(){this._ssaoTechniqueConfig.output=Pv.SSAO,this._ssaoTechnique=this._techniqueRep.releaseAndAcquire(WM,this._ssaoTechniqueConfig,this._ssaoTechnique),this._ssaoTechniqueConfig.output=Pv.Blur,this._blurTechnique=this._techniqueRep.releaseAndAcquire(WM,this._ssaoTechniqueConfig,this._blurTechnique)}_enable(){this.enabled||(this._enabled=!0,this._loadResources(()=>{this._enabled&&this._initialize()}))}_loadResources(t){this._data?t():import("./SSAOHelperData.08f44d75.js").then(i=>{this._data=i,t()})}_initialize(){const t={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:0,height:0},i={colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE};Qd(this._data.noiseTexture).then(r=>{this._enabled&&(this._ssaoFBO=new xr(this._rctx,i,t),this._blur0FBO=new xr(this._rctx,i,t),this._blur1FBO=new xr(this._rctx,i,t),this._noiseTexture=new st(this._rctx,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,hasMipmap:!0,width:r.width,height:r.height},r),this._requestRender())}),this._selectPrograms()}_disable(){this._enabled=!1,this._noiseTexture=Ye(this._noiseTexture),this._blur1FBO=Ye(this._blur1FBO),this._blur0FBO=Ye(this._blur0FBO),this._ssaoFBO=Ye(this._ssaoFBO)}get gpuMemoryUsage(){return(_(this._blur0FBO)?this._blur0FBO.gpuMemoryUsage:0)+(_(this._blur1FBO)?this._blur1FBO.gpuMemoryUsage:0)+(_(this._ssaoFBO)?this._ssaoFBO.gpuMemoryUsage:0)}get test(){return{ssao:this._ssaoFBO,blur:this._blur1FBO}}}const kse=new Us;function Cet(){const e=new Bi;return e.include(zv),e.fragment.uniforms.add([new $r("tex"),new xa("uColor")]),e.fragment.code.add(x`void main() {
vec4 texColor = texture2D(tex, uv);
gl_FragColor = texColor * uColor;
}`),e}const Aet=Object.freeze(Object.defineProperty({__proto__:null,build:Cet},Symbol.toStringTag,{value:"Module"}));class o3 extends lr{initializeProgram(t){const i=o3.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return this.configuration.hasAlpha?Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt}):Ut({colorWrite:Jt})}}o3.shader=new Qi(Aet,()=>import("./TextureOnly.glsl.0db9ec2e.js"));class ZY extends Ra{constructor(){super(...arguments),this.hasAlpha=!1}}u([G()],ZY.prototype,"hasAlpha",void 0);class Ube{constructor(t){this._rctx=t,this.cache=new Map}dispose(){this.cache.forEach(t=>t.texture=Ye(t.texture)),this.cache.clear()}_acquire(t){if(R(t))return null;const i=this._patternId(t),r=this.cache.get(i);if(r)return r.refCount++,r.bind;const s=t.pixelRatio,{encodedData:n,sdfNormalizer:o,pixels:a,paddedPixels:l}=Ret(t.pattern,s),c=a/s,h={refCount:1,texture:null,bind:p=>(R(h.texture)&&(h.texture=new st(this._rctx,{width:l,height:1,internalFormat:ze.RGBA,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE},n)),p.bindTexture("stipplePatternTexture",h.texture),{pixelSize:c,sdfNormalizer:o,pixels:a})};return this.cache.set(i,h),h.bind}release(t){if(R(t))return;const i=this._patternId(t),r=this.cache.get(i);r&&(r.refCount--,r.refCount===0&&(_(r.texture)&&r.texture.dispose(),this.cache.delete(i)))}swap(t,i){const r=this._acquire(i);return this.release(t),r}_patternId(t){return`${t.pattern.join(",")}-r${t.pixelRatio}`}}function Ret(e,t){const i=e.map(y=>Math.round(y*t)),r=1/t,s=Math.floor(i.reduce((y,v)=>y+v)),n=i.reduce((y,v)=>Math.max(y,v)),o=(Math.floor(.5*(n-1))+.5)*r,a=[];let l=1;for(const y of i){for(let v=0;v<y;v++){const w=l*(Math.min(v,y-1-v)+.5)*r/o*.5+.5;a.push(w)}l=-l}const c=Math.round(i[0]/2),h=[...a.slice(c),...a.slice(0,c)],p=s+2,f=new Uint8Array(4*p);let m=4;for(const y of h)BM(y,f,m),m+=4;return f.copyWithin(0,m-4,m),f.copyWithin(m,4,8),{encodedData:f,sdfNormalizer:o,paddedPixels:p,pixels:s}}var Hl,bo;(function(e){e[e.Standard=0]="Standard",e[e.TransparentToHUDVisibility=1]="TransparentToHUDVisibility",e[e.Transparency=2]="Transparency",e[e.OverlayWithTransparency=3]="OverlayWithTransparency",e[e.COUNT=4]="COUNT"})(Hl||(Hl={})),function(e){e[e.None=0]="None",e[e.Alpha=1]="Alpha",e[e.PremultipliedAlpha=2]="PremultipliedAlpha",e[e.COUNT=3]="COUNT"}(bo||(bo={}));class KD extends Ra{constructor(){super(...arguments),this.function=Hl.Standard,this.alphaMode=bo.None,this.hasOpacityFactor=!1}}u([G({count:Hl.COUNT})],KD.prototype,"function",void 0),u([G({count:bo.COUNT})],KD.prototype,"alphaMode",void 0),u([G()],KD.prototype,"hasOpacityFactor",void 0);let ud=class extends G5(Ee){constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new qt,this._frameTask=r2,this._drapeSourceRenderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedDrapeSourceRenderers=new Bt,this._rctx=null,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this.worldToPCSRatio=1,this.events=new us,this.longitudeCyclical=null}get _bindParameters(){return this._renderContext.bindParameters}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}initialize(){const e=this.view._stage.renderView;this._rctx=e.renderingContext;const t=e.waterTextureRepository;this._stippleTextureRepository=new Ube(e.renderingContext),this._shaderTechniqueRepository=new abe({rctx:this._rctx,viewingMode:Ve.Local,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:t}),this._renderContext=new bbe(this._rctx,new YY(this._rctx,this.view.state.viewingMode),new Fbe(this._shaderTechniqueRepository,this._rctx,()=>{})),this._handles.add([ae(()=>t.updating,()=>this.events.emit("content-changed"),Ms),ae(()=>this.spatialReference,i=>this._localOriginFactory=new XY(i),Ms),eo(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new lbe(e.textureRepository,this._shaderTechniqueRepository,i=>{(i.renderOccluded&SF)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating")},()=>this.events.emit("content-changed")),this._bindParameters.slot=Se.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=Y0e(this._rctx),this._bindParameters.camera=ib,this._bindParameters.transparencyPassType=gt.NONE,this._bindParameters.lighting.groundLightingFactor=1,this._bindParameters.lighting.globalFactor=0,this._bindParameters.lighting.set([new XX(Fe(1,1,1))]),this._frameTask=this.view.resourceController.scheduler.registerTask(mt.STAGE,this),this._handles.add(this._frameTask)}dispose(){this._handles.destroy(),this._drapeSourceRenderers.forEach(e=>e.destroy()),this._drapeSourceRenderers.clear(),this._debugTextureTechnique=Wi(this._debugTextureTechnique),this._debugPatternTexture=Ye(this._debugPatternTexture),this._bindParameters.highlightDepthTexture=Ye(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Ye(this._shaderTechniqueRepository),this._temporaryFBO=Ye(this._temporaryFBO),this._quadVAO=Ye(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||this._frameTask.updating||Ws(this._drapeSourceRenderers,e=>e.updating)}get hasOverlays(){return _(this._overlays)&&_(this._overlayRenderTarget)}get gpuMemoryUsage(){return _(this._overlayRenderTarget)?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,qp)}createDrapeSourceRenderer(e,t,i){const r=this._drapeSourceRenderers.get(e);_(r)&&r.destroy();const s=new t(ve(F({},i),{rendererContext:this,drapeSource:e}));return this._drapeSourceRenderers.set(e,s),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(ae(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),s}removeDrapeSourceRenderer(e){if(R(e))return;const t=this._drapeSourceRenderers.get(e);R(t)||(this._sortedDrapeSourceRenderersDirty=!0,this._drapeSourceRenderers.delete(e),this._handles.remove(e),t.destroy())}collectUnusedRenderTargetMemory(e){let t=!1;if(_(this._overlayRenderTarget))for(const i of this._overlayRenderTarget.renderTargets){const r=this.overlays[0].validTargets[i.type]||!this.overlays[1].validTargets[i.type];t=this._overlayRenderTarget.validateUsageForTarget(r,i,e)||t}return t}get overlays(){return yt(this._overlays,[])}ensureDrapeTargets(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasTargetWithoutRasterImage=C$(e,i=>i.drapeTargetType===ij.WithoutRasterImage)})}ensureDrapeSources(e){_(this._overlays)&&this._overlays.forEach(t=>{t.hasDrapedFeatureSource=C$(e,i=>i.drapeSourceType===SR.Features),t.hasDrapedRasterSource=C$(e,i=>i.drapeSourceType===SR.RasterImage)})}ensureOverlays(e,t){R(this._overlays)&&(this._overlayRenderTarget=new cKe(this._rctx),this._overlays=[new ose(Pr.INNER,this._overlayRenderTarget),new ose(Pr.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(t)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=Ye(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e,t=()=>!0){this._frameTask.processQueue(e),e.done||this._processDrapeSources(e,t)}_processDrapeSources(e,t){let i=!1;for(const[r,s]of this._drapeSourceRenderers){if(e.done)break;(r.destroyed||t(r))&&s.commitChanges()&&(i=!0,e.madeProgress())}this._updateSortedDrapeSourceRenderers(),i&&(_(this._overlays)&&this._drapeSourceRenderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(rE,e=>e.updatePolicy===l2.SYNC)}isEmpty(){if(zi.OVERLAY_DRAW_DEBUG_TEXTURE)return!1;for(const e of this._drapeSourceRenderers.values())if(!e.isEmpty)return!1;return!0}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let t=!1;return this._drapeSourceRenderers.forEach(i=>t=i.updateAnimation(e)||t),t}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,t,i){const r=e.canvasGeometries;if(r.numViews===0)return!1;this._screenToWorldRatio=i*e.mapUnitsPerPixel;const s=t.renderPass;if(this.isEmpty()||s===je.MATERIAL_HIGHLIGHT&&!this.hasHighlights||s===je.MATERIAL_NORMAL&&!this.hasWater||!e.hasSomeSizedView())return!1;const n=t.fbo;if(!n.isValid())return!1;const o=2*e.resolution,a=e.resolution;n.resize(o,a);const l=this._rctx;ib.pixelRatio=e.pixelRatio*i,this._renderContext.pass=s,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=s===je.MATERIAL_NORMAL?Se.DRAPED_WATER:Se.DRAPED_MATERIAL,e.applyViewport(this._rctx),n.bind(l),e.index===Pr.INNER&&(l.setClearColor(0,0,0,0),l.clearSafe(Xi.COLOR_BUFFER_BIT));const c=t.type===fs.ColorNoRasterImage?_0.ExcludeRasterImage:t.type===fs.Occluded?_0.OccludedOnly:_0.Normal;if(c===_0.OccludedOnly&&(this._renderContext.renderOccludedMask=SF),zi.OVERLAY_DRAW_DEBUG_TEXTURE&&c!==_0.OccludedOnly)for(let h=0;h<r.numViews;h++)this._setViewParameters(r.extents[h],e,ib),this._drawDebugTexture(e.resolution,Oet[e.index]);return this._drapeSourceRenderers.size>0&&this._sortedDrapeSourceRenderers.forAll(({drapeSource:h,renderer:p})=>{if(c===_0.ExcludeRasterImage&&h.drapeSourceType===SR.RasterImage)return;const{fullOpacity:f}=h,m=_(f)&&f<1&&s===je.MATERIAL;m&&(this.bindTemporaryFramebuffer(this._rctx,o,a),l.clearSafe(Xi.COLOR_BUFFER_BIT));for(let y=0;y<r.numViews;y++)this._setViewParameters(r.extents[y],e,ib),p.render(this._renderContext,this._bindParameters);m&&_(this._temporaryFBO)&&(n.bind(l),this.view._stage.renderView.compositingHelper.composite(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),bo.PremultipliedAlpha,f,Hl.OverlayWithTransparency,e.index))}),l.bindFramebuffer(null),n.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,t,i){R(this._temporaryFBO)&&(this._temporaryFBO=new obe(e,!1)),this._temporaryFBO.resize(t,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,t,i,r){var n,o;let s=0;for(const a of this._drapeSourceRenderers.values())s=(o=(n=a.intersect)==null?void 0:n.call(a,e,t,i,r,s))!=null?o:s}_updateSortedDrapeSourceRenderers(){if(!this._sortedDrapeSourceRenderersDirty||(this._sortedDrapeSourceRenderersDirty=!1,this._sortedDrapeSourceRenderers.clear(),this._drapeSourceRenderers.size===0))return;const e=this.view.map.allLayers;this._drapeSourceRenderers.forEach((t,i)=>{const r=e.indexOf(i.layer);this._sortedDrapeSourceRenderers.push(new Met(i,t,r<0?1/0:r))}),this._sortedDrapeSourceRenderers.sort((t,i)=>t.index-i.index)}_setViewParameters(e,t,i){i.viewport[0]=i.viewport[1]=0,i.viewport[2]=i.viewport[3]=t.resolution,$q(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),E4(i.viewMatrix,[-e[0],-e[1],0]),this._bindParameters.camera=i}_updateHasWater(){const e=Ws(this._drapeSourceRenderers,t=>t.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=Ws(this._drapeSourceRenderers,t=>t.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=Ws(this._drapeSourceRenderers,t=>t.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,t){this._ensureDebugPatternResources(e,e);const i=this._rctx,r=i.bindTechnique(this._debugTextureTechnique);r.setUniform4f("uColor",t[0],t[1],t[2],1),r.bindTexture("tex",this._debugPatternTexture),i.bindVAO(this._quadVAO),i.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,t){if(this._debugPatternTexture)return;const i=new Uint8Array(e*t*4);let r=0;for(let n=0;n<t;n++)for(let o=0;o<e;o++){const a=Math.floor(o/10),l=Math.floor(n/10);a<2||l<2||10*a>e-20||10*l>t-20?(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=255):(i[r++]=255,i[r++]=255,i[r++]=255,i[r++]=1&a&&1&l?1&o^1&n?0:255:1&a^1&l?0:128)}this._debugPatternTexture=new st(this._rctx,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:e,height:t},i);const s=new ZY;s.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(o3,s),this._quadVAO=Ma(this._rctx)}get test(){return{drapeSourceRenderers:this._drapeSourceRenderers,getDrapeSourceRenderer:e=>this._drapeSourceRenderers.get(e)}}};var _0;u([d()],ud.prototype,"_frameTask",void 0),u([d()],ud.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([go()],ud.prototype,"_shaderTechniqueRepository",void 0),u([go()],ud.prototype,"_stippleTextureRepository",void 0),u([d({constructOnly:!0})],ud.prototype,"view",void 0),u([d()],ud.prototype,"worldToPCSRatio",void 0),u([d()],ud.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],ud.prototype,"updating",null),ud=u([P("esri.views.3d.terrain.OverlayRenderer")],ud),function(e){e[e.Normal=0]="Normal",e[e.OccludedOnly=1]="OccludedOnly",e[e.ExcludeRasterImage=2]="ExcludeRasterImage"}(_0||(_0={}));class Met{constructor(t,i,r){this.drapeSource=t,this.renderer=i,this.index=r}}const Oet=[[1,.5,.5],[.5,.5,1]],ib=new Yi;ib.near=1,ib.far=1e4,ib.relativeElevation=null;const QY=-2,SF=Mr.OccludeAndTransparent;function zse(e){const t=[[A.POSITION,e.indices]],i=[[A.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}]];return _(e.attributeData.color)&&(i.push([A.COLOR,{size:4,data:e.attributeData.color,exclusive:!0}]),t.push([A.COLOR,new Uint32Array(e.indices.length)])),_(e.attributeData.uvMapSpace)&&(i.push([A.UVMAPSPACE,{size:4,data:e.attributeData.uvMapSpace,exclusive:!0}]),t.push([A.UVMAPSPACE,e.indices])),_(e.attributeData.boundingRect)&&(i.push([A.BOUNDINGRECT,{size:9,data:e.attributeData.boundingRect,exclusive:!0}]),t.push([A.BOUNDINGRECT,e.indices])),_(e.attributeData.mapPosition)&&(i.push([A.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([A.MAPPOS,e.indices])),new Or(i,t)}function Vse(e){const t=[[A.POSITION,e.indices],[A.UV0,e.indices]],i=[[A.POSITION,{size:3,data:e.attributeData.position,exclusive:!0}],[A.UV0,{size:2,data:e.attributeData.uv0,exclusive:!0}]];return _(e.attributeData.mapPosition)&&(i.push([A.MAPPOS,{size:3,data:e.attributeData.mapPosition,exclusive:!0}]),t.push([A.MAPPOS,e.indices])),new Or(i,t)}function XM(e){switch(e.type){case"extent":if(e instanceof ci)return cu.fromExtent(e);break;case"polygon":return e}return null}function JY(e,t,i,r){const s=i3(e.rings,e.hasZ,Of.CCW_IS_HOLE),n=new Float64Array(s.position.length),o=j1e(s.position,e.spatialReference,0,n,0,s.position,0,s.position.length/3,t,i,r),a=o!=null;return{position:s.position,mapPosition:n,polygons:Vbe(s.polygons,s.position,n),outlines:zbe(s.outlines,s.position,n),projectionSuccess:a,sampledElevation:o}}function kbe(e,t){const i=i3(e.rings,!1,Of.CCW_IS_HOLE),r=ar(i.position,e.spatialReference,0,i.position,t,0,i.position.length/3);for(let s=2;s<i.position.length;s+=3)i.position[s]=QY;return{position:i.position,polygons:Vbe(i.polygons,i.position),outlines:zbe(i.outlines,i.position),projectionSuccess:r}}function zbe(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({index:s,count:n,position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function Vbe(e,t,i){const r=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of e){if(n<=1)continue;const l=3*s,c=l+3*n,h=o.map(p=>p-s);r.push({index:s,count:n,holeIndices:h,pathLengths:a,position:t.subarray(l,c),mapPosition:i?i.subarray(l,c):void 0})}return r}function Bbe(e,t){const i=e.fragment;switch(i.code.add(x`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),t.doubleSidedMode){case Lr.None:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case Lr.View:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case Lr.WindingOrder:i.code.add(x`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:t.doubleSidedMode;case Lr.COUNT:}}var Lr;(function(e){e[e.None=0]="None",e[e.View=1]="View",e[e.WindingOrder=2]="WindingOrder",e[e.COUNT=3]="COUNT"})(Lr||(Lr={}));function Gbe(e){e.vertex.code.add(x`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}function jbe(e,t){t.instanced&&t.instancedDoublePrecision&&(e.attributes.add(A.MODELORIGINHI,"vec3"),e.attributes.add(A.MODELORIGINLO,"vec3"),e.attributes.add(A.MODEL,"mat3"),e.attributes.add(A.MODELNORMAL,"mat3"));const i=e.vertex;t.instancedDoublePrecision&&(i.include(TF,t),i.uniforms.add(new Sa("viewOriginHi",(r,s)=>Pqe(ie(vI,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),vI))),i.uniforms.add(new Sa("viewOriginLo",(r,s)=>Iqe(ie(vI,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),vI)))),i.code.add(x`
    vec3 calculateVPos() {
      ${t.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `),i.code.add(x`
    vec3 subtractOrigin(vec3 _pos) {
      ${t.instancedDoublePrecision?x`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),i.code.add(x`
    vec3 dpNormal(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `),t.output===J.Normal&&(i.uniforms.add(new vr("viewNormal",(r,s)=>s.camera.viewInverseTransposeMatrix)),i.code.add(x`
    vec3 dpNormalView(vec4 _normal) {
      ${t.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `)),t.hasVertexTangents&&i.code.add(x`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${t.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `)}const vI=O();var gs;function Hbe(e){switch(e){case"multiply":default:return gs.Multiply;case"ignore":return gs.Ignore;case"replace":return gs.Replace;case"tint":return gs.Tint}}function qbe(e,t,i){if(R(e)||t===gs.Ignore)return i[0]=255,i[1]=255,i[2]=255,void(i[3]=255);const r=$e(Math.round(e[3]*EF),0,EF),s=r===0||t===gs.Tint?0:t===gs.Replace?Pet:Iet;i[0]=$e(Math.round(e[0]*Zw),0,Zw),i[1]=$e(Math.round(e[1]*Zw),0,Zw),i[2]=$e(Math.round(e[2]*Zw),0,Zw),i[3]=r+s}(function(e){e[e.Multiply=1]="Multiply",e[e.Ignore=2]="Ignore",e[e.Replace=3]="Replace",e[e.Tint=4]="Tint"})(gs||(gs={}));const Zw=255,EF=85,Pet=EF,Iet=2*EF;function Wbe(e){e.vertex.code.add(x`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${x.int(gs.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${x.int(gs.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${x.int(gs.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${x.int(gs.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function Xbe(e,t){t.hasSymbolColors?(e.include(Wbe),e.attributes.add(A.SYMBOLCOLOR,"vec4"),e.varyings.add("colorMixMode","mediump float"),e.vertex.code.add(x`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`)):(e.fragment.uniforms.add(new n3("colorMixMode",i=>s1e[i.colorMixMode])),e.vertex.code.add(x`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`))}function Tw(e,t){t.hasVertexColors?(e.attributes.add(A.COLOR,"vec4"),e.varyings.add("vColor","vec4"),e.vertex.code.add(x`void forwardVertexColor() { vColor = color; }`),e.vertex.code.add(x`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):e.vertex.code.add(x`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function $et(e){e.fragment.code.add(x`
    #define discardOrAdjustAlpha(color) { if (color.a < ${x.float(Eo)}) { discard; } }
  `)}class Ybe extends jr{constructor(t,i){super(t,"float",$i.Draw,(r,s,n)=>r.setUniform1f(t,i(s,n)))}}function wb(e,t){Zbe(e,t,new We("textureAlphaCutoff",i=>i.textureAlphaCutoff))}function Det(e,t){Zbe(e,t,new Ybe("textureAlphaCutoff",i=>i.textureAlphaCutoff))}function Zbe(e,t,i){const r=e.fragment;switch(t.alphaDiscardMode!==sr.Mask&&t.alphaDiscardMode!==sr.MaskBlend||r.uniforms.add(i),t.alphaDiscardMode){case sr.Blend:return e.include($et);case sr.Opaque:r.code.add(x`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case sr.Mask:r.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case sr.MaskBlend:e.fragment.code.add(x`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function Qbe(e,t){const i=e.vertex.code,r=e.fragment.code,s=t.hasModelTransformation;t.output!==J.Depth&&t.output!==J.Shadow||(ou(e,t),e.include(To,{linearDepth:!0,hasModelTransformation:s}),e.include(og,t),e.include(uS,t),e.include(Bv,t),e.include(ls,t),e.vertex.uniforms.add(new di("nearFar",(n,o)=>o.camera.nearFar)),e.varyings.add("depth","float"),t.hasColorTexture&&e.fragment.uniforms.add(new zt("tex",n=>n.texture)),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPositionWithDepth(proj, view, ${s?"model,":""} vpos, nearFar, depth);
        forwardTextureCoordinates();
      }
    `),e.include(wb,t),r.add(x`
      void main(void) {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputDepth(depth);
      }
    `)),t.output===J.Normal&&(ou(e,t),e.include(To,{linearDepth:!1,hasModelTransformation:s}),e.include(q5,t),e.include(X5,t),e.include(og,t),e.include(uS,t),t.hasColorTexture&&e.fragment.uniforms.add(new zt("tex",n=>n.texture)),e.varyings.add("vPositionView","vec3"),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        ${t.normalType===Tr.Attribute?x`
        vNormalWorld = dpNormalView(vvLocalNormal(normalModel()));`:""}
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(ls,t),e.include(wb,t),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}

        ${t.normalType===Tr.ScreenDerivative?x`
            vec3 normal = screenDerivativeNormal(vPositionView);`:x`
            vec3 normal = normalize(vNormalWorld);
            if (gl_FrontFacing == false) normal = -normal;`}
        gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
      }
    `)),t.output===J.Highlight&&(ou(e,t),e.include(To,{linearDepth:!1,hasModelTransformation:s}),e.include(og,t),e.include(uS,t),t.hasColorTexture&&e.fragment.uniforms.add(new zt("tex",n=>n.texture)),i.add(x`
      void main(void) {
        vpos = calculateVPos();
        vpos = subtractOrigin(vpos);
        vpos = addVerticalOffset(vpos, localOrigin);
        gl_Position = transformPosition(proj, view, ${s?"model,":""} vpos);
        forwardTextureCoordinates();
      }
    `),e.include(ls,t),e.include(wb,t),e.include(Bg),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${t.hasColorTexture?x`
        vec4 texColor = texture2D(tex, vuv0);
        discardOrAdjustAlpha(texColor);`:""}
        outputHighlight();
      }
    `))}function Jbe(e,t){const i=e.fragment;if(t.hasVertexTangents?(e.attributes.add(A.TANGENT,"vec4"),e.varyings.add("vTangent","vec4"),t.doubleSidedMode===Lr.WindingOrder?i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):i.code.add(x`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):(e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`)),t.textureCoordinateType!==Zs.None){e.include(LX,t);const r=t.supportsTextureAtlas;i.uniforms.add(t.pbrTextureBindType===$i.Pass?GD("normalTexture",s=>s.textureNormal,r):yR("normalTexture",s=>s.textureNormal,r)),i.code.add(x`
    vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
      vtc.uv = uv;
      ${t.supportsTextureAtlas?"vtc.size = normalTextureSize;":""}
      vec3 rawNormal = textureLookup(normalTexture, vtc).rgb * 2.0 - 1.0;
      return tangentSpace * rawNormal;
    }
  `)}}function a3(e,t){const i=e.fragment;t.receiveAmbientOcclusion?(i.uniforms.add([new zt("ssaoTex",(r,s)=>s.ssaoHelper.colorTexture),new ei("viewportPixelSz",(r,s)=>qi(Let,s.camera.fullViewport[0],s.camera.fullViewport[1],1/s.ssaoHelper.width,1/s.ssaoHelper.height))]),i.code.add(x`float evaluateAmbientOcclusion() {
return 1.0 - texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}
float evaluateAmbientOcclusionInverse() {
return texture2D(ssaoTex, (gl_FragCoord.xy - viewportPixelSz.xy) * viewportPixelSz.zw).a;
}`)):i.code.add(x`float evaluateAmbientOcclusion() { return 0.0; }
float evaluateAmbientOcclusionInverse() { return 1.0; }`)}const Let=Gt();function iw(e,t){const i=e.fragment;e.include(a3,t),t.pbrMode!==Rt.Disabled&&e.include(Z5,t),e.include(zX,t),i.constants.add("ambientBoostFactor","float",nE),e.include(d5),i.code.add(x`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${t.pbrMode===Rt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),i.uniforms.add(new xt("lightingMainDirection",(r,s)=>s.lighting.lightingMainDirection)),i.code.add(x`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${t.spherical?x`normalize(vPosWorld)`:x`vec3(0.0, 0.0, 1.0)`}, lightingMainDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),i.uniforms.add([new We("lightingGlobalFactor",(r,s)=>s.lighting.globalFactor),new xt("lightingMainIntensity",(r,s)=>s.lighting.mainLight.intensity)]),i.code.add(x`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * lightingMainIntensity;
}`),t.pbrMode===Rt.Disabled||t.pbrMode===Rt.WaterOnIntegratedMesh?(e.include(VX,t),i.code.add(x`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`)):t.pbrMode!==Rt.Normal&&t.pbrMode!==Rt.Schematic||(i.code.add(x`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 mainLightDirection = lightingMainDirection;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),i.code.add(x`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),t.useFillLights?i.uniforms.add(new Gb("hasFillLights",(r,s)=>s.enableFillLights)):i.constants.add("hasFillLights","bool",!1),i.code.add(x`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * lightingMainIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),i.uniforms.add([new We("lightingSpecularStrength",(r,s)=>s.lighting.mainLight.specularStrength),new We("lightingEnvironmentStrength",(r,s)=>s.lighting.mainLight.environmentStrength)]),i.code.add(x`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * lightingMainIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * lightingMainIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),i.code.add(x`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${t.pbrMode===Rt.Schematic?x`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:x`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `))}function Kbe(e,t){const i=x`
  /*
  *  ${t.name}
  *  ${t.output===J.Color?"RenderOutput: Color":t.output===J.Depth?"RenderOutput: Depth":t.output===J.Shadow?"RenderOutput: Shadow":t.output===J.Normal?"RenderOutput: Normal":t.output===J.Highlight?"RenderOutput: Highlight":""}
  */
  `;vM()&&(e.fragment.code.add(i),e.vertex.code.add(i))}function YM(e){e.include(Vf),e.code.add(x`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${x.int(gs.Multiply)}) {
        return allMixed;
      }
      if (mode == ${x.int(gs.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${x.int(gs.Replace)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${x.int(gs.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${x.int(gs.Replace)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)}function Net(e){const t=new Bi,i=t.vertex.code,r=t.fragment.code;t.include(Kbe,{name:"Default Material Shader",output:e.output});const s=ou(t,e);return t.include(W5),t.varyings.add("vpos","vec3"),t.include(uS,e),t.include(jbe,e),t.include(Z_e,e),e.output!==J.Color&&e.output!==J.Alpha||(Mf(t.vertex,e),t.include(q5,e),t.include(To,{linearDepth:!1,hasModelTransformation:e.hasModelTransformation}),e.normalType===Tr.Attribute&&e.offsetBackfaces&&t.include(Gbe),t.include(Jbe,e),t.include(X5,e),e.instancedColor&&t.attributes.add(A.INSTANCECOLOR,"vec4"),t.varyings.add("localvpos","vec3"),t.include(og,e),t.include(s3,e),t.include(Xbe,e),t.include(Tw,e),t.vertex.uniforms.add(new ei("externalColor",n=>n.externalColor)),t.varyings.add("vcolorExt","vec4"),e.hasMultipassTerrain&&t.varyings.add("depth","float"),e.hasModelTransformation&&t.vertex.uniforms.add(new vr("model",n=>_(n.modelTransformation)?n.modelTransformation:Ks)),i.add(x`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${e.instancedColor?"vcolorExt *= instanceColor;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${x.float(Eo)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        } else {
          vpos = calculateVPos();
          localvpos = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${e.normalType===Tr.Attribute?x`vNormalWorld = dpNormal(vvLocalNormal(normalModel()));`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${e.hasVertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, ${e.hasModelTransformation?"model,":""} vpos);
          ${e.normalType===Tr.Attribute&&e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
      }
    `)),e.output===J.Alpha&&(t.include(ls,e),t.include(wb,e),t.include(yu,e),t.fragment.uniforms.add([new We("opacity",n=>n.opacity),new We("layerOpacity",n=>n.layerOpacity)]),e.hasColorTexture&&t.fragment.uniforms.add(new zt("tex",n=>n.texture)),t.fragment.include(YM),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
                vec4 texColor = texture2D(tex, vuv0);
                ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.hasVertexColors?x`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===J.Color&&(t.include(ls,e),t.include(iw,e),t.include(a3,e),t.include(wb,e),t.include(e.instancedDoublePrecision?Y5:tw,e),t.include(yu,e),Mf(t.fragment,e),t.fragment.uniforms.add([s,new xt("ambient",n=>n.ambient),new xt("diffuse",n=>n.diffuse),new We("opacity",n=>n.opacity),new We("layerOpacity",n=>n.layerOpacity),new We("lightingGlobalFactor",(n,o)=>o.lighting.globalFactor),new xt("lightingMainIntensity",(n,o)=>o.lighting.mainLight.intensity)]),t.fragment.constants.add("ambientBoostFactor","float",nE),e.hasColorTexture&&t.fragment.uniforms.add(new zt("tex",n=>n.texture)),t.include(kX,e),t.include(Z5,e),t.fragment.include(YM),t.include(Bbe,e),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${e.hasColorTexture?x`
                vec4 texColor = texture2D(tex, vuv0);
                ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${e.normalType===Tr.ScreenDerivative?x`
                vec3 normal = screenDerivativeNormal(localvpos);`:x`
                shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
        ${e.pbrMode===Rt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.hasVertexColors?x`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${e.hasNormalTexture?x`
                mat3 tangentSpace = ${e.hasVertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
                vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`:x`vec3 shadingNormal = normal;`}
        vec3 normalGround = ${e.spherical?x`normalize(vpos + localOrigin);`:x`vec3(0.0, 0.0, 1.0);`}

        ${e.snowCover?x`
                float snow = smoothstep(0.5, 0.55, dot(normal, normalGround));
                albedo = mix(albedo, vec3(1), snow);
                shadingNormal = mix(shadingNormal, normal, snow);
                ssao = mix(ssao, 1.0, snow);`:""}

        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        ${e.pbrMode===Rt.Normal||e.pbrMode===Rt.Schematic?x`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
                ${e.snowCover?x`
                        mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                        emission = mix(emission, vec3(0.0), snow);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:x`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.transparencyPassType===gt.Color?x`gl_FragColor = premultiplyAlpha(gl_FragColor);`:""}
      }
    `)),t.include(Qbe,e),t}const Fet=Object.freeze(Object.defineProperty({__proto__:null,build:Net},Symbol.toStringTag,{value:"Module"}));class Uet extends Ebe{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=Fe(0,1,.5),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=or.Back,this.emissiveFactor=Fe(0,0,0),this.instancedDoublePrecision=!1,this.normals="default",this.receiveSSAO=!0,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=Fe(.2,.2,.2),this.diffuse=Fe(.8,.8,.8),this.externalColor=fi(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=O(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSizeEnabled=!1,this.vvSizeMinSize=[1,1,1],this.vvSizeMaxSize=[100,100,100],this.vvSizeOffset=[0,0,0],this.vvSizeFactor=[1,1,1],this.vvSizeValue=[1,1,1],this.vvColorEnabled=!1,this.vvColorValues=[0,0,0,0,0,0,0,0],this.vvColorColors=[1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0],this.vvSymbolAnchor=[0,0,0],this.vvSymbolRotationMatrix=Sr(),this.vvOpacityEnabled=!1,this.vvOpacityValues=[],this.vvOpacityOpacities=[],this.transparent=!1,this.writeDepth=!0,this.customDepthTest=zb.Less,this.textureAlphaMode=sr.Blend,this.textureAlphaCutoff=gF,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Mr.Occlude}}class ket extends Cbe{constructor(){super(...arguments),this.origin=O(),this.slicePlaneLocalOrigin=this.origin}}class l3 extends lr{initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global,i.doublePrecisionRequiresObfuscation=r3(t.rctx),i.textureCoordinateType=i.hasColorTexture||i.hasMetalnessAndRoughnessTexture||i.hasEmissionTexture||i.hasOcclusionTexture||i.hasNormalTexture?Zs.Default:Zs.None}initializeProgram(t){return this._initializeProgram(t,l3.shader)}_initializeProgram(t,i){const r=i.get().build(this.configuration);return new Ji(t.rctx,r,Di)}_convertDepthTestFunction(t){return t===zb.Lequal?hr.LEQUAL:hr.LESS}_setPipeline(t,i){const r=this.configuration,s=t===gt.NONE,n=t===gt.FrontFace;return Ut({blending:r.output!==J.Color&&r.output!==J.Alpha||!r.transparent?null:s?au:Gg(t),culling:zet(r)&&h5(r.cullFace),depthTest:{func:Vv(t,this._convertDepthTestFunction(r.customDepthTest))},depthWrite:s||n?r.writeDepth&&pl:null,colorWrite:Jt,stencilWrite:r.hasOccludees?Pf:null,stencilTest:r.hasOccludees?i?Ov:Gv:null,polygonOffset:s||n?null:F5(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipeline(this.configuration.transparencyPassType,!0),this._setPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}function zet(e){return e.cullFace!==or.None||!e.hasSlicePlane&&!e.transparent&&!e.doubleSidedMode}l3.shader=new Qi(Fet,()=>import("./DefaultMaterial.glsl.7a9439a7.js"));class Xt extends Ho{constructor(){super(...arguments),this.output=J.Color,this.alphaDiscardMode=sr.Opaque,this.doubleSidedMode=Lr.None,this.pbrMode=Rt.Disabled,this.cullFace=or.None,this.transparencyPassType=gt.NONE,this.normalType=Tr.Attribute,this.textureCoordinateType=Zs.None,this.customDepthTest=zb.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1}}u([G({count:J.COUNT})],Xt.prototype,"output",void 0),u([G({count:sr.COUNT})],Xt.prototype,"alphaDiscardMode",void 0),u([G({count:Lr.COUNT})],Xt.prototype,"doubleSidedMode",void 0),u([G({count:Rt.COUNT})],Xt.prototype,"pbrMode",void 0),u([G({count:or.COUNT})],Xt.prototype,"cullFace",void 0),u([G({count:gt.COUNT})],Xt.prototype,"transparencyPassType",void 0),u([G({count:Tr.COUNT})],Xt.prototype,"normalType",void 0),u([G({count:Zs.COUNT})],Xt.prototype,"textureCoordinateType",void 0),u([G({count:zb.COUNT})],Xt.prototype,"customDepthTest",void 0),u([G()],Xt.prototype,"spherical",void 0),u([G()],Xt.prototype,"hasVertexColors",void 0),u([G()],Xt.prototype,"hasSymbolColors",void 0),u([G()],Xt.prototype,"hasVerticalOffset",void 0),u([G()],Xt.prototype,"hasSlicePlane",void 0),u([G()],Xt.prototype,"hasSliceHighlight",void 0),u([G()],Xt.prototype,"hasColorTexture",void 0),u([G()],Xt.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([G()],Xt.prototype,"hasEmissionTexture",void 0),u([G()],Xt.prototype,"hasOcclusionTexture",void 0),u([G()],Xt.prototype,"hasNormalTexture",void 0),u([G()],Xt.prototype,"hasScreenSizePerspective",void 0),u([G()],Xt.prototype,"hasVertexTangents",void 0),u([G()],Xt.prototype,"hasOccludees",void 0),u([G()],Xt.prototype,"hasMultipassTerrain",void 0),u([G()],Xt.prototype,"hasModelTransformation",void 0),u([G()],Xt.prototype,"offsetBackfaces",void 0),u([G()],Xt.prototype,"vvSize",void 0),u([G()],Xt.prototype,"vvColor",void 0),u([G()],Xt.prototype,"receiveShadows",void 0),u([G()],Xt.prototype,"receiveAmbientOcclusion",void 0),u([G()],Xt.prototype,"textureAlphaPremultiplied",void 0),u([G()],Xt.prototype,"instanced",void 0),u([G()],Xt.prototype,"instancedColor",void 0),u([G()],Xt.prototype,"instancedDoublePrecision",void 0),u([G()],Xt.prototype,"doublePrecisionRequiresObfuscation",void 0),u([G()],Xt.prototype,"writeDepth",void 0),u([G()],Xt.prototype,"transparent",void 0),u([G()],Xt.prototype,"enableOffset",void 0),u([G()],Xt.prototype,"cullAboveGround",void 0),u([G()],Xt.prototype,"snowCover",void 0),u([G({constValue:!0})],Xt.prototype,"hasVvInstancing",void 0),u([G({constValue:!1})],Xt.prototype,"useCustomDTRExponentForWater",void 0),u([G({constValue:!1})],Xt.prototype,"supportsTextureAtlas",void 0),u([G({constValue:!0})],Xt.prototype,"useFillLights",void 0);function Vet(e){const t=new Bi,i=t.vertex.code,r=t.fragment.code,s=ou(t,e);return t.include(W5),t.varyings.add("vpos","vec3"),t.include(uS,e),t.include(jbe,e),t.include(Z_e,e),e.output!==J.Color&&e.output!==J.Alpha||(Mf(t.vertex,e),t.include(q5,e),t.include(To),e.offsetBackfaces&&t.include(Gbe),e.instancedColor&&t.attributes.add(A.INSTANCECOLOR,"vec4"),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("localvpos","vec3"),e.hasMultipassTerrain&&t.varyings.add("depth","float"),t.include(og,e),t.include(s3,e),t.include(Xbe,e),t.include(Tw,e),t.vertex.uniforms.add(new ei("externalColor",n=>n.externalColor)),t.varyings.add("vcolorExt","vec4"),i.add(x`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${e.instancedColor?"vcolorExt *= instanceColor;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${x.float(Eo)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          } else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${e.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${e.hasMultipassTerrain?x`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),e.output===J.Alpha&&(t.include(ls,e),t.include(wb,e),t.include(yu,e),t.fragment.uniforms.add([new We("opacity",n=>n.opacity),new We("layerOpacity",n=>n.layerOpacity),new vv("view")]),e.hasColorTexture&&t.fragment.uniforms.add(new zt("tex",n=>n.texture)),t.fragment.include(YM),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
                vec4 texColor = texture2D(tex, vuv0);
                ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        ${e.hasVertexColors?x`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}

        gl_FragColor = vec4(opacity_);
      }
    `)),e.output===J.Color&&(t.include(ls,e),t.include(iw,e),t.include(a3,e),t.include(wb,e),t.include(e.instancedDoublePrecision?Y5:tw,e),t.include(yu,e),Mf(t.fragment,e),t.fragment.uniforms.add([s,new xt("ambient",n=>n.ambient),new xt("diffuse",n=>n.diffuse),new We("opacity",n=>n.opacity),new We("layerOpacity",n=>n.layerOpacity),new vv("view"),new We("lightingGlobalFactor",(n,o)=>o.lighting.globalFactor),new xt("lightingMainIntensity",(n,o)=>o.lighting.mainLight.intensity)]),t.fragment.constants.add("ambientBoostFactor","float",nE),e.hasColorTexture&&t.fragment.uniforms.add(new zt("tex",n=>n.texture)),t.include(kX,e),t.include(Z5,e),t.fragment.include(YM),t.extensions.add("GL_OES_standard_derivatives"),r.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?x`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${e.hasColorTexture?x`
                vec4 texColor = texture2D(tex, vuv0);
                ${e.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:x`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${e.pbrMode===Rt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${e.hasVertexColors?x`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:x`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${e.snowCover?x`albedo = mix(albedo, vec3(1), 0.9);`:x``}
        ${x`
            vec3 shadingNormal = normalize(vNormalWorld);
            albedo *= 1.2;
            vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
            float alignmentLightView = clamp(dot(viewForward, -lightingMainDirection), 0.0, 1.0);
            float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
            float treeRadialFalloff = vColor.r;
            float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
            additionalLight += backLightFactor * lightingMainIntensity;`}
        ${e.pbrMode===Rt.Normal||e.pbrMode===Rt.Schematic?e.spherical?x`vec3 normalGround = normalize(vpos + localOrigin);`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:x``}
        ${e.pbrMode===Rt.Normal||e.pbrMode===Rt.Schematic?x`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * lightingMainIntensity[2];
                ${e.snowCover?x`
                        mrr = vec3(0.0, 1.0, 0.04);
                        emission = vec3(0.0);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:x`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        gl_FragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${e.transparencyPassType===gt.Color?x`gl_FragColor = premultiplyAlpha(gl_FragColor);`:x``}
      }
    `)),t.include(Qbe,e),t}const Bet=Object.freeze(Object.defineProperty({__proto__:null,build:Vet},Symbol.toStringTag,{value:"Module"}));class eU extends l3{initializeConfiguration(t,i){super.initializeConfiguration(t,i),i.hasMetalnessAndRoughnessTexture=!1,i.hasEmissionTexture=!1,i.hasOcclusionTexture=!1,i.hasNormalTexture=!1,i.hasModelTransformation=!1,i.normalType=Tr.Attribute,i.doubleSidedMode=Lr.WindingOrder,i.hasVertexTangents=!1}initializeProgram(t){return this._initializeProgram(t,eU.shader)}}eU.shader=new Qi(Bet,()=>import("./RealisticTree.glsl.955c9d0c.js"));class rw extends Gf{constructor(t){super(t,Het),this.supportsEdges=!0,this.techniqueConfig=new Xt,this.vertexBufferLayout=Wet(this.parameters),this.instanceBufferLayout=t.instanced?ewe(this.parameters):null}isVisibleInPass(t){return t!==je.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;if(!super.isVisible()||t.layerOpacity===0)return!1;const{instanced:i,hasVertexColors:r,hasSymbolColors:s,vvColorEnabled:n}=t,o=_(i)&&i.includes("color"),a=t.colorMixMode==="replace",l=t.opacity>0,c=t.externalColor&&t.externalColor[3]>0;return r&&(o||n||s)?!!a||l:r?a?c:l:o||n||s?!!a||l:a?c:l}getConfiguration(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.hasNormalTexture=!!this.parameters.normalTextureId,this.techniqueConfig.hasColorTexture=!!this.parameters.textureId,this.techniqueConfig.hasVertexTangents=this.parameters.hasVertexTangents,this.techniqueConfig.instanced=!!this.parameters.instanced,this.techniqueConfig.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.hasVerticalOffset=_(this.parameters.verticalOffset),this.techniqueConfig.hasScreenSizePerspective=_(this.parameters.screenSizePerspective),this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasSliceHighlight=this.parameters.hasSliceHighlight,this.techniqueConfig.alphaDiscardMode=this.parameters.textureAlphaMode,this.techniqueConfig.normalType=this.parameters.normals==="screenDerivative"?Tr.ScreenDerivative:Tr.Attribute,this.techniqueConfig.transparent=this.parameters.transparent,this.techniqueConfig.writeDepth=this.parameters.writeDepth,_(this.parameters.customDepthTest)&&(this.techniqueConfig.customDepthTest=this.parameters.customDepthTest),this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.cullFace=this.parameters.hasSlicePlane?or.None:this.parameters.cullFace,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig.hasModelTransformation=_(this.parameters.modelTransformation),t!==J.Color&&t!==J.Alpha||(this.techniqueConfig.hasVertexColors=this.parameters.hasVertexColors,this.techniqueConfig.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this.techniqueConfig.doubleSidedMode=Lr.WindingOrder:this.techniqueConfig.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?Lr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?Lr.WindingOrder:Lr.None,this.techniqueConfig.instancedColor=_(this.parameters.instanced)&&this.parameters.instanced.includes("color"),this.techniqueConfig.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this.techniqueConfig.receiveAmbientOcclusion=!!i.ssaoHelper.ready&&this.parameters.receiveSSAO,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this.techniqueConfig.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?Rt.Schematic:Rt.Normal:Rt.Disabled,this.techniqueConfig.hasMetalnessAndRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this.techniqueConfig.hasEmissionTexture=!!this.parameters.emissiveTextureId,this.techniqueConfig.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this.techniqueConfig.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<L5,this.techniqueConfig.snowCover=this.hasSnowCover(i)),this.techniqueConfig}hasSnowCover(t){return _(t.weather)&&t.weatherVisible&&t.weather.type==="snowy"&&t.weather.snowCover==="enabled"}intersect(t,i,r,s,n,o,a){if(_(this.parameters.verticalOffset)){const l=s.camera;ie(Iz,r[12],r[13],r[14]);let c=null;switch(s.viewingMode){case Ve.Global:c=we(Bse,Iz);break;case Ve.Local:c=se(Bse,Zet)}let h=0;const p=pe(Qet,Iz,l.eye),f=Me(p),m=oe(p,p,1/f);let y=null;this.parameters.screenSizePerspective&&(y=xe(c,m)),h+=i1e(l,f,this.parameters.verticalOffset,y,this.parameters.screenSizePerspective),oe(c,c,h),ql(Pz,c,s.transform.inverseRotation),n=pe(Xet,n,Pz),o=pe(Yet,o,Pz)}O5(t,i,s,n,o,F7(s.verticalOffset),a)}requiresSlot(t){return t===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL)||t===Se.DRAPED_MATERIAL}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Depth||t.output===J.Normal||t.output===J.Shadow||t.output===J.Highlight?new Get(t):null}createBufferWriter(){return new qet(this.vertexBufferLayout,this.instanceBufferLayout)}}class Get extends UX{constructor(t){super(F(F({},t),t.material.parameters))}_updateParameters(t){const i=this._material.parameters;this.updateTexture(i.textureId);const r=t.camera.viewInverseTransposeMatrix;return ie(i.origin,r[3],r[7],r[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(i.treeRendering?eU:l3,t)}_updateShadowState(t){t.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:t.shadowMap.enabled})}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this._updateParameters(t)}}class jet extends Uet{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}}const Het=new jet;class qet{constructor(t,i){this.vertexBufferLayout=t,this.instanceBufferLayout=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(A.POSITION).length}write(t,i,r,s){I5(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}function Wet(e){const t=e.textureId||e.normalTextureId||e.metallicRoughnessTextureId||e.emissiveTextureId||e.occlusionTextureId,i=Kr().vec3f(A.POSITION).vec3f(A.NORMAL);return e.hasVertexTangents&&i.vec4f(A.TANGENT),t&&i.vec2f(A.UV0),e.hasVertexColors&&i.vec4u8(A.COLOR),e.hasSymbolColors&&i.vec4u8(A.SYMBOLCOLOR),i}function ewe(e){let t=Kr();return t=e.instancedDoublePrecision?t.vec3f(A.MODELORIGINHI).vec3f(A.MODELORIGINLO).mat3f(A.MODEL).mat3f(A.MODELNORMAL):t.mat4f(A.MODEL).mat4f(A.MODELNORMAL),_(e.instanced)&&e.instanced.includes("color")&&(t=t.vec4f(A.INSTANCECOLOR)),_(e.instanced)&&e.instanced.includes("featureAttribute")&&(t=t.vec4f(A.INSTANCEFEATUREATTRIBUTE)),t}const Xet=O(),Yet=O(),Zet=Fe(0,0,1),Bse=O(),Pz=O(),Iz=O(),Qet=O(),Jet=["polygon","extent"];class Ket extends Hf{constructor(t,i,r,s){super(t,i,r,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=U5(this._getSymbolSize());if(a)throw new q("graphics3dextrudesymbollayer:invalid-size",a)}const t=Yr(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t),r=Ya(i),s=i[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:r,ambient:r,opacity:s,transparent:n,cullFace:n?or.None:or.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0};this._material=new rw(o),this._bottomMaterial=new rw(ve(F({},o),{cullFace:or.Back})),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,Jet,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new _u);return this._createAs3DShape(i,t.renderingInfo,r,s,i.uid)}layerOpacityChanged(t,i){const r=Yr(this.symbolLayer,"material","color"),s=this._getCombinedOpacity(r),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();return t.forEach(a=>{const l=i(a);_(l)&&l.layerOpacityChanged(o,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,Rv)}slicePlaneEnabledChanged(t,i){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}_getExtrusionSize(t){var r;let i;return i=t.size&&this._drivenProperties.size?(r=KJe(t.size,2))!=null?r:0:this._getSymbolSize(),i/=this._context.renderCoordsHelper.unitInMeters,i}applyRendererDiff(t,i){return this._drivenPropertiesChanged(i)?Qs.Recreate_Symbol:Qs.Recreate_Graphics}_getSymbolSize(){var t;return(t=this.symbolLayer.size)!=null?t:1}_createAs3DShape(t,i,r,s,n){const o=XM(t.geometry);if(R(o))return null;const a=JY(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);if(this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer"),o.rings.length===0||!o.rings.some(le=>le.length>0))return null;const l=NY(o);if(R(l))return null;const c=new Array,h=new Array,p=new Array,f=Ls(),m=Ae(),y=O(),v=this._context.renderCoordsHelper.viewingMode===Ve.Global;v||this._context.renderCoordsHelper.worldUpAtPosition(null,y),fu(o.spatialReference,[l.x,l.y,0],m,this._context.renderCoordsHelper.spatialReference);const w=Ae();cs(w,m);const b=Sr();u2(b,w);const{polygons:S,mapPosition:T,position:E}=a,C=E.length/3,M=new Float64Array(3*C*6),I=new Float64Array(3*C*6),N=new Float64Array(3*C*6),D=new Float64Array(1*C*6);let z=0;for(let le=0;le<S.length;++le){const ne=S[le],$=ne.count;if(this._context.clippingExtent&&(cr(f),Kc(f,ne.mapPosition),!$d(f,this._context.clippingExtent)))continue;const U=C2(ne.mapPosition,ne.holeIndices,3);if(U.length===0)continue;const B=3*$*2+U.length,H=new Uint32Array(B),W=new Uint32Array(U.length),K=6*$,j=3*M.BYTES_PER_ELEMENT,ee=new vs(M.buffer,z*j,j,(z+K)*j),ye=3*I.BYTES_PER_ELEMENT,Te=new vs(I.buffer,z*ye,ye,(z+K)*ye),Ne=new Float64Array(N.buffer,3*z*N.BYTES_PER_ELEMENT,3*K),_e=new Float64Array(D.buffer,1*z*D.BYTES_PER_ELEMENT,1*K),ge=this._getExtrusionSize(i);ett(E,T,U,ne,ee.typedBuffer,Ne,Te.typedBuffer,_e,0,H,W,ge,y,v),t3(ee,ee,w),Mv(Te,Te,b),z+=6*$;const Ce=Gse(H,H.length-W.length,{positions:ee.typedBuffer,elevation:Ne,normals:Te.typedBuffer,heights:_e},r);c.push(Ce),h.push(this._material),p.push(Ks);const Le=Gse(W,0,{positions:ee.typedBuffer,elevation:Ne,normals:Te.typedBuffer,heights:_e},r);c.push(Le),h.push(this._bottomMaterial),p.push(Ks)}if(c.length===0)return null;const V=new Hg({geometries:c,materials:h,transformations:p,metadata:{layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0}});V.transformation=m;const k=J1e(this.symbolLayer,{opacity:this._getLayerOpacity()}),Y=_(k)?{baseMaterial:this._material,edgeMaterials:[k],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,Z=new jf(this,V,c,null,null,rtt,s,Y);return Z.alignedSampledElevation=a.sampledElevation,Z.needsElevationUpdates=Rv(s.mode),Z}}function Gse(e,t,i,r){const s=new Uint32Array(e.length),n=[[A.POSITION,{size:3,data:i.positions,exclusive:!0}],[A.NORMAL,{size:3,data:i.normals,exclusive:!0}],[A.COLOR,{size:4,data:r,exclusive:!0}],[A.SIZE,{size:1,data:i.heights,exclusive:!0}]],o=[[A.POSITION,e],[A.NORMAL,e],[A.COLOR,s]];return i.elevation&&(n.push([A.MAPPOS,{size:3,data:i.elevation}]),o.push([A.MAPPOS,e])),new Or(n,o,ll.Triangle,t)}function ett(e,t,i,r,s,n,o,a,l,c,h,p,f,m){const y=i.length/3;let v=0,w=2*r.count;ttt(e,t,r.index,r.count,i,0,y,s,n,o,a,l,c,h,w,p,f,m),l+=2*r.count,w=0,jse(s,n,a,o,v,r.pathLengths[0],r.count,l,c,w,p),l+=4*r.pathLengths[0],w+=2*r.pathLengths[0],v+=r.pathLengths[0];for(let b=1;b<r.pathLengths.length;++b)jse(s,n,a,o,v,r.pathLengths[b],r.count,l,c,w,p),l+=4*r.pathLengths[b],w+=2*r.pathLengths[b],v+=r.pathLengths[b]}function ttt(e,t,i,r,s,n,o,a,l,c,h,p,f,m,y,v,w,b){se(Fa,w);const S=v>0?1:-1;let T=3*i,E=p,C=3*E,M=p+r,I=3*M;for(let z=0;z<r;++z)b&&(Fa[0]=e[T+0],Fa[1]=e[T+1],Fa[2]=e[T+2],we(Fa,Fa)),a[C+0]=e[T+0],a[C+1]=e[T+1],a[C+2]=e[T+2],l[C+0]=t[T+0],l[C+1]=t[T+1],l[C+2]=t[T+2],c[C+0]=-S*Fa[0],c[C+1]=-S*Fa[1],c[C+2]=-S*Fa[2],h[E]=0,a[I+0]=e[T+0]+v*Fa[0],a[I+1]=e[T+1]+v*Fa[1],a[I+2]=e[T+2]+v*Fa[2],l[I+0]=t[T+0],l[I+1]=t[T+1],l[I+2]=t[T+2],c[I+0]=S*Fa[0],c[I+1]=S*Fa[1],c[I+2]=S*Fa[2],h[M]=v,C+=3,I+=3,T+=3,E+=1,M+=1;T=3*n,C=0,I=3*y;const N=v<0?Zse:Yse,D=v<0?Yse:Zse;for(let z=0;z<o;++z)m[C+0]=s[T+N[0]],m[C+1]=s[T+N[1]],m[C+2]=s[T+N[2]],f[I+0]=s[T+D[0]]+r,f[I+1]=s[T+D[1]]+r,f[I+2]=s[T+D[2]]+r,C+=3,I+=3,T+=3}function _I(e,t,i,r,s,n,o){r[n]=r[o],o*=3,e[(n*=3)+0]=e[o+0],e[n+1]=e[o+1],e[n+2]=e[o+2],t[n+0]=t[o+0],t[n+1]=t[o+1],t[n+2]=t[o+2],i[n+0]=s[0],i[n+1]=s[1],i[n+2]=s[2]}const tC=O();function jse(e,t,i,r,s,n,o,a,l,c,h){let p=s,f=s+1,m=s+o,y=s+o+1,v=a,w=a+1,b=a+2*n,S=a+2*n+1;h<0&&(p=s+o+1,y=s),c*=3;for(let T=0;T<n;++T)T===n-1&&(h>0?(f=s,y=s+o):(f=s,p=s+o)),itt(e,p,f,m,tC),_I(e,t,r,i,tC,v,p),_I(e,t,r,i,tC,w,f),_I(e,t,r,i,tC,b,m),_I(e,t,r,i,tC,S,y),l[c++]=v,l[c++]=b,l[c++]=S,l[c++]=v,l[c++]=S,l[c++]=w,p++,f++,m++,y++,v+=2,w+=2,b+=2,S+=2}const $z=O(),Hse=O(),qse=O(),Wse=O(),Xse=O();function itt(e,t,i,r,s){t*=3,i*=3,r*=3,ie($z,e[t++],e[t++],e[t++]),ie(Hse,e[i++],e[i++],e[i++]),ie(qse,e[r++],e[r++],e[r++]),pe(Wse,Hse,$z),pe(Xse,qse,$z),lt(s,Xse,Wse),we(s,s)}const Qw=O();function rtt(e,t,i,r){const s=e.stageObject,n=s.geometryRecords,o=n.length,a=t.mode!=="absolute-height";let l=0;const c=s.transformation,h=cs(Ae(),c);for(let p=0;p<o;p+=2){const f=n[p].geometry,m=f.getMutableAttribute(A.POSITION).data,y=f.vertexAttributes.get(A.SIZE).data,v=f.vertexAttributes.get(A.MAPPOS).data,w=new w_e(v),b=m.length/3;let S=0,T=!1,E=0;const C=i.spatialReference;for(let M=0;M<b;M++){Qw[0]=m[S],Qw[1]=m[S+1],Qw[2]=m[S+2],Mg(w,i,t,r,bI),a&&(E+=bI.sampledElevation),zi.TESTS_DISABLE_OPTIMIZATIONS?(ie(_l,w.array[w.offset+0],w.array[w.offset+1],bI.z+y[S/3]),r.toRenderCoords(_l,C,_l),Ue(_l,_l,h)):(ie(_l,m[S+0],m[S+1],m[S+2]),Ue(_l,_l,c),r.setAltitude(_l,bI.z+y[S/3]),Ue(_l,_l,h)),m[S]=_l[0],m[S+1]=_l[1],m[S+2]=_l[2];const I=stt/r.unitInMeters;(Math.abs(Qw[0]-m[S])>=I||Math.abs(Qw[1]-m[S+1])>=I||Math.abs(Qw[2]-m[S+2])>=I)&&(T=!0),w.offset+=3,S+=3}T&&(f.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p]),n[p+1].geometry.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(n[p+1])),l+=E/b}return l/o}const _l=O(),Fa=O(),bI=new e3,Yse=[0,2,1],Zse=[0,1,2],stt=.01;function ntt(e,t,i,r,s){const n=e.referencesGeometry()&&s?ott(t,r,s):t,o=e.repurposeFeature(n);try{return e.evaluate(ve(F({},i),{$feature:o}))}catch(a){return me.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const Dz=new Map;function ott(e,t,i){const{transform:r,hasZ:s,hasM:n}=i;Dz.has(t)||Dz.set(t,att(t));const o=Dz.get(t)(e.geometry,r,s,n);return ve(F({},e),{geometry:o})}function att(e){const t={};switch(e){case"esriGeometryPoint":return(i,r,s,n)=>I1e(r,t,i,s,n);case"esriGeometryPolygon":return(i,r,s,n)=>$1e(r,t,i,s,n);case"esriGeometryPolyline":return(i,r,s,n)=>D1e(r,t,i,s,n);case"esriGeometryMultipoint":return(i,r,s,n)=>P1e(r,t,i,s,n);default:return me.getLogger("esri.views.2d.support.arcadeOnDemand").error(new q("mapview-arcade",`Unable to handle geometryType: ${e}`)),i=>i}}const g1t=1.2,ltt=hf,ctt=ph;class tU{constructor(t,i,r,s){this.graphics3DSymbolLayer=t,this.renderGeometries=i,this.boundingBox=r,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(t){this.stage=t}setVisibility(t){if(this.stage!=null&&this._visible!==t){if(this._visible=t,t&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,Zt.Geometry.ADD);if(t||this._addedToStage){for(const i of this.renderGeometries)i.instanceParameters.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Zt.State.VISIBILITIES)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,Zt.Geometry.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(t=O()){return ie(t,0,0,0)}getBoundingBoxObjectSpace(t=Ls()){return cr(t)}addObjectState(t,i){t===Eg.Highlight&&(this.renderGeometries.forEach(r=>{const s=r.addHighlight();i.addRenderGeometry(r,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Zt.State.HIGHLIGHTS))}removeObjectState(t){this.renderGeometries.forEach(i=>{t.removeRenderGeometry(i)})}removeRenderGeometryObjectState(t,i){t.removeHighlight(i),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,Zt.State.HIGHLIGHTS)}computeAttachmentOrigin(t){for(const i of this.renderGeometries)i.computeAttachmentOrigin(Jw)&&(t.draped.origin[0]+=Jw[0],t.draped.origin[1]+=Jw[1],t.draped.num++)}async getProjectedBoundingBox(t,i,r,s,n){cr(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,t,Qse,r),aRe(n,Qse)}if(i){let o;Id(n,Jw);const a=FY(n,i);try{o=await i.service.queryElevation(Jw[0],Jw[1],s,a,"ground")}catch{}_(o)&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(t,i,r,s){if(this.boundingBox)d4(dp,this.boundingBox);else{const n=t.boundingSphere,o=n[3];dp[0]=n[0]-o,dp[1]=n[1]-o,dp[2]=n[2]-o,dp[3]=n[0]+o,dp[4]=n[1]+o,dp[5]=n[2]+o}return i(dp,0,2),this.calculateRelativeScreenBounds&&s.push({location:Id(dp),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),lq(dp,r)}}const Qse=Dt(),dp=Ls(),Jw=O();class twe{constructor(t,i,r,s=2048){this.text=t,this._alignment=i,this._parameters=r,this.maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._displayWidth=null,this._heightMetrics=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${t}`,this._lines=t.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._ensureTextWidth()+2*this.backgroundHorizontalPadding)}get displayHeight(){const t=this.lineSpacing*(this._lines.length-1),i=this.lineHeight;return Math.ceil(t+i+2*this.haloSize+this.backgroundTopPadding+this.backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this.firstLineYOffset+this.baselinePosition)}get firstLineYOffset(){return this.backgroundTopPadding+this.haloSize}get heightMetrics(){return this._ensureHeightMetrics()}get lineSpacing(){return(this.lineHeight+this.linePadding)*this._parameters.definition.lineSpacingFactor}get lineHeight(){return this.heightMetrics.lineHeight}get linePadding(){return this.lineHeight*utt}get baselinePosition(){return this.heightMetrics.baselinePosition}get renderedFontSize(){return this._toRenderUnit(this.fontSize)}get fontSize(){return this._parameters.definition.size}get renderedHaloSize(){return this._toRenderUnit(this.haloSize)}get haloSize(){return this._parameters.haloSize}get backgroundHorizontalPadding(){return this.hasBackground?this._parameters.definition.background.padding[0]:0}get backgroundVerticalPadding(){return this.hasBackground?this._parameters.definition.background.padding[1]:0}get backgroundTopPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingTop)}get backgroundBottomPadding(){return Math.max(0,this.backgroundVerticalPadding-this.heightMetrics.paddingBottom)}get hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(R(this._renderPixelRatio)){const t=this._parameters.definition.pixelRatio;this.maxSize>0?this._renderPixelRatio=Math.min(t,Math.min(this.maxSize/this.displayWidth,this.maxSize/this.displayHeight)):this._renderPixelRatio=t}return this._renderPixelRatio}_getLineXOffset(t){switch(this._alignment){case lv.Left:return this.backgroundHorizontalPadding;case lv.Center:return(this.displayWidth-this._lineWidths[t])/2;case lv.Right:return this.displayWidth-this.backgroundHorizontalPadding-this._lineWidths[t]}}render(t,i=0,r=0){t.save();const s=i/=this.renderPixelRatio,n=r/=this.renderPixelRatio,o=this.haloSize,a=this.firstLineYOffset;i+=o,r+=a+this.baselinePosition;const l=this.haloSize>0;l&&this._renderHalo(t,s,n,o,a),this._setFontProperties(t,this.renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(t.globalCompositeOperation="destination-out",t.fillStyle="rgb(0, 0, 0)",this._fillText(t,h,i+p,r),this._renderLineDecoration(t,i+p,r,this._textWidths[c])),t.globalCompositeOperation="source-over",t.fillStyle=this._parameters.textStyle,this._fillText(t,h,i+this._getLineXOffset(c),r),this._renderLineDecoration(t,i+p,r,this._textWidths[c]),r+=this.lineSpacing}if(zi.TEXT_SHOW_BASELINE){t.strokeStyle=Jse,t.setLineDash([2,2]),t.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this.baselinePosition;this._drawLine(t,[s,p],[s+this.displayWidth,p]),c+=this.lineSpacing}}if(zi.TEXT_SHOW_BORDER&&(t.strokeStyle=Jse,t.setLineDash([]),t.lineWidth=1,this._drawBox(t,[s,n],[this.displayWidth,this.displayHeight])),this.hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(t,s,n,c),t.globalCompositeOperation="destination-over",t.fillStyle=this._parameters.backgroundStyle,t.fill()}t.restore()}_renderLineDecoration(t,i,r,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":r+=2*a;break;case"line-through":r-=.33*this.baselinePosition}const l=n?this.haloSize:0;t.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,t.lineWidth=this._toRenderUnit(a+2*l),t.beginPath(),t.moveTo(this._toRenderUnit(i-l),this._toRenderUnit(r)),t.lineTo(this._toRenderUnit(i+s+l),this._toRenderUnit(r)),t.stroke()}_roundedRect(t,i,r,s){i=this._toRenderUnit(i),r=this._toRenderUnit(r);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=$e(s,0,Math.floor(o/2)),t.beginPath(),t.moveTo(i,r+s),t.arcTo(i,r,i+s,r,s),t.lineTo(i+n-s,r),t.arcTo(i+n,r,i+n,r+s,s),t.lineTo(i+n,r+o-s),t.arcTo(i+n,r+o,i+n-s,r+o,s),t.lineTo(i+s,r+o),t.arcTo(i,r+o,i,r+o-s,s),t.closePath()):t.rect(i,r,n,o)}_renderHalo(t,i,r,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=eL(Lz,Math.max(o,Kw),Math.max(a,Kw)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this.renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this.renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this.baselinePosition;for(let f=0;f<this._lines.length;++f){const m=this._getLineXOffset(f);this._renderLineDecoration(c,s+m,p,this._textWidths[f],!0),p+=this.lineSpacing}t.globalAlpha=this._parameters.definition.halo.color[3],t.drawImage(l,0,0,o,a,this._toRenderUnit(i),this._toRenderUnit(r),o,a),t.globalAlpha=1}_renderHaloEmulated(t,i,r){r+=this.baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of iwe)this._fillText(t,n,i+o+this.haloSize*a,r+this.haloSize*l);r+=this.lineSpacing}}_renderHaloNative(t,i,r){const s=2*this.haloSize;r+=this.baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;t.lineWidth=this._toRenderUnit(p*s),this._strokeText(t,o,i+a,r)}r+=this.lineSpacing}}_setFontProperties(t,i){t.font=this._parameters.fontString(i),t.textAlign="left",t.textBaseline="alphabetic"}_ensureTextWidth(){if(_(this._displayWidth))return this._displayWidth;const t=eL(Lz,Kw,Kw).getContext("2d");this._setFontProperties(t,this.fontSize);let i=2*this.haloSize;const r=this._parameters.definition.font;r.style!=="italic"&&r.style!=="oblique"&&r.weight!=="bold"&&r.weight!=="bolder"||(i+=.3*t.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s=0;for(const n of this._lines){const o=t.measureText(n).width,a=o+i;this._textWidths.push(o),this._lineWidths.push(a),s=Math.max(s,a)}return this._displayWidth=s,this._displayWidth}_ensureHeightMetrics(){if(R(this._heightMetrics)){const t=eL(Lz,Kw,Kw).getContext("2d");this._setFontProperties(t,this.fontSize);const i=t.measureText(this.text+htt),r=this.hasBackground?t.measureText(this._lines[0]):i,s=this._lines.length===1?r:this.hasBackground?t.measureText(this._lines[this._lines.length-1]):i,n=i.actualBoundingBoxAscent+i.actualBoundingBoxDescent;this._heightMetrics={paddingTop:i.actualBoundingBoxAscent-r.actualBoundingBoxAscent,paddingBottom:i.actualBoundingBoxDescent-s.actualBoundingBoxDescent,lineHeight:n,baselinePosition:i.actualBoundingBoxAscent}}return this._heightMetrics}_toRenderUnit(t){return t*this.renderPixelRatio}_toRoundedRenderUnit(t){return Math.round(t*this.renderPixelRatio)}_fillText(t,i,r,s){t.fillText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_strokeText(t,i,r,s){t.strokeText(i,this._toRenderUnit(r),this._toRenderUnit(s))}_drawLine(t,i,r){t.beginPath(),t.moveTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),t.lineTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),t.stroke()}_drawBox(t,i,r){const s=this._toRenderUnit(i[0]),n=this._toRenderUnit(i[1]),o=this._toRenderUnit(r[0]),a=this._toRenderUnit(r[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;t.beginPath(),t.moveTo(l,h),t.lineTo(c,h),t.lineTo(c,p),t.lineTo(l,p),t.lineTo(l,h),t.stroke()}}const iwe=[];for(let t=0;t<360;t+=360/16)iwe.push([Math.cos(Math.PI*t/180),Math.sin(Math.PI*t/180)]);var lv;function eL(e,t,i){return e.canvas||(e.canvas=document.createElement("canvas")),e.canvas.width=t,e.canvas.height=i,e.canvas}(function(e){e[e.Left=0]="Left",e[e.Center=1]="Center",e[e.Right=2]="Right"})(lv||(lv={}));const Lz={canvas:null},utt=.2,Kw=512,Jse="rgb(255, 0, 255, 0.5)",htt=(()=>{let e="";for(let t=32;t<127;t++)e+=String.fromCharCode(t);return e})(),dtt={left:0,center:.5,right:1},tL={"bottom-left":Oi(0,0),bottom:Oi(.5,0),"bottom-right":Oi(1,0),left:Oi(0,.5),center:Oi(.5,.5),right:Oi(1,.5),"top-left":Oi(0,1),top:Oi(.5,1),"top-right":Oi(1,1)};function rwe(e){switch(e){case"left":return lv.Left;case"right":return lv.Right;default:return lv.Center}}function Kse(e){switch(e){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function ptt(e){switch(e){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function ftt(e,t){switch(t){case"bottom":return e==="left"?"bottom-left":e==="right"?"bottom-right":"bottom";case"center":return e;case"top":return e==="left"?"top-left":e==="right"?"top-right":"top"}}function mtt(e){return e==="middle"?"center":e}var Go,ene,CF;function iC(e){return e!=null}function ex(e){return typeof e=="number"}function iU(e){return typeof e=="string"}function gtt(e){return e==null||iU(e)}function Ys(e,t){e&&e.push(t)}function ytt(e,t,i,r=Ae()){const s=e||0,n=t||0,o=i||0;return s!==0&&BS(r,r,-s/180*Math.PI),n!==0&&VS(r,r,n/180*Math.PI),o!==0&&S4(r,r,o/180*Math.PI),r}function uy(e,t,i,r,s){const n=e.minSize,o=e.maxSize;if(e.expression)return Ys(s,"Could not convert size info: expression not supported"),!1;if(e.useSymbolValue){const a=r.symbolSize[i];return t.minSize[i]=a,t.maxSize[i]=a,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Go.DefinedSize,!0}if(iC(e.field))return iC(e.stops)?e.stops.length===2&&ex(e.stops[0].size)&&ex(e.stops[1].size)?(tne(e.stops[0].size,e.stops[1].size,e.stops[0].value,e.stops[1].value,t,i),t.type[i]=Go.DefinedSize,!0):(Ys(s,"Could not convert size info: stops only supported with 2 elements"),!1):ex(n)&&ex(o)&&iC(e.minDataValue)&&iC(e.maxDataValue)?(tne(n,o,e.minDataValue,e.maxDataValue,t,i),t.type[i]=Go.DefinedSize,!0):QS[e.valueUnit]!=null?(t.minSize[i]=-1/0,t.maxSize[i]=1/0,t.offset[i]=0,t.factor[i]=1/QS[e.valueUnit],t.type[i]=Go.DefinedSize,!0):e.valueUnit==="unknown"?(Ys(s,"Could not convert size info: proportional size not supported"),!1):(Ys(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!iC(e.field)){if(e.stops&&e.stops[0]&&ex(e.stops[0].size))return t.minSize[i]=e.stops[0].size,t.maxSize[i]=e.stops[0].size,t.offset[i]=t.minSize[i],t.factor[i]=0,t.type[i]=Go.DefinedSize,!0;if(ex(n))return t.minSize[i]=n,t.maxSize[i]=n,t.offset[i]=n,t.factor[i]=0,t.type[i]=Go.DefinedSize,!0}return Ys(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function tne(e,t,i,r,s,n){const o=Math.abs(r-i)>0?(t-e)/(r-i):0;s.minSize[n]=o>0?e:t,s.maxSize[n]=o>0?t:e,s.offset[n]=e-i*o,s.factor[n]=o}function vtt(e,t,i,r){if(e.normalizationField||e.valueRepresentation)return Ys(r,"Could not convert size info: unsupported property"),null;if(!gtt(e.field))return Ys(r,"Could not convert size info: field is not a string"),null;if(t.size){if(e.field)if(t.size.field){if(e.field!==t.size.field)return Ys(r,"Could not convert size info: multiple fields in use"),null}else t.size.field=e.field}else t.size={field:e.field,minSize:[0,0,0],maxSize:[0,0,0],offset:[0,0,0],factor:[0,0,0],type:[Go.Undefined,Go.Undefined,Go.Undefined]};let s;switch(e.axis){case"width":return s=uy(e,t.size,0,i,r),s?t:null;case"height":return s=uy(e,t.size,2,i,r),s?t:null;case"depth":return s=uy(e,t.size,1,i,r),s?t:null;case"width-and-depth":return s=uy(e,t.size,0,i,r),s&&uy(e,t.size,1,i,r),s?t:null;case null:case void 0:case"all":return s=uy(e,t.size,0,i,r),s=s&&uy(e,t.size,1,i,r),s=s&&uy(e,t.size,2,i,r),s?t:null;default:return Ys(r,`Could not convert size info: unknown axis "${e.axis}""`),null}}function _tt(e,t,i){for(let s=0;s<3;++s){let n=t.unitInMeters;e.type[s]===Go.DefinedSize&&(n*=t.modelSize[s],e.type[s]=Go.DefinedScale),e.minSize[s]=e.minSize[s]/n,e.maxSize[s]=e.maxSize[s]/n,e.offset[s]=e.offset[s]/n,e.factor[s]=e.factor[s]/n}let r;if(e.type[0]!==Go.Undefined)r=0;else if(e.type[1]!==Go.Undefined)r=1;else{if(e.type[2]===Go.Undefined)return Ys(i,"No size axis contains a valid size or scale"),!1;r=2}for(let s=0;s<3;++s)e.type[s]===Go.Undefined&&(e.minSize[s]=e.minSize[r],e.maxSize[s]=e.maxSize[r],e.offset[s]=e.offset[r],e.factor[s]=e.factor[r],e.type[s]=e.type[r]);return!0}function ine(e,t,i){e[4*t+0]=i.r/255,e[4*t+1]=i.g/255,e[4*t+2]=i.b/255,e[4*t+3]=i.a}function btt(e,t,i){if(e.normalizationField)return Ys(i,"Could not convert color info: unsupported property"),null;if(iU(e.field)){if(!e.stops)return Ys(i,"Could not convert color info: missing stops or colors"),null;{if(e.stops.length>8)return Ys(i,"Could not convert color info: too many color stops"),null;t.color={field:e.field,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.color.values[s]=n.value,ine(t.color.colors,s,n.color)}}}else{if(!(e.stops&&e.stops.length>=0))return Ys(i,"Could not convert color info: no field and no colors/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].color;t.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.color.values[s]=1/0,ine(t.color.colors,s,r)}}return t}function wtt(e,t,i){if(e.normalizationField)return Ys(i,"Could not convert opacity info: unsupported property"),null;if(iU(e.field)){if(!e.stops)return Ys(i,"Could not convert opacity info: missing stops or opacities"),null;{if(e.stops.length>8)return Ys(i,"Could not convert opacity info: too many opacity stops"),null;t.opacity={field:e.field,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};const r=e.stops;for(let s=0;s<8;++s){const n=r[Math.min(s,r.length-1)];t.opacity.values[s]=n.value,t.opacity.opacityValues[s]=n.opacity}}}else{if(!(e.stops&&e.stops.length>=0))return Ys(i,"Could not convert opacity info: no field and no opacities/stops"),null;{const r=e.stops&&e.stops.length>=0&&e.stops[0].opacity;t.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)t.opacity.values[s]=1/0,t.opacity.opacityValues[s]=r}}return t}function Nz(e,t,i){const r=i===2&&e.rotationType==="arithmetic";t.offset[i]=r?90:0,t.factor[i]=r?-1:1,t.type[i]=1}function xtt(e,t,i){if(!iU(e.field))return Ys(i,"Could not convert rotation info: field is not a string"),null;if(t.rotation){if(e.field)if(t.rotation.field){if(e.field!==t.rotation.field)return Ys(i,"Could not convert rotation info: multiple fields in use"),null}else t.rotation.field=e.field}else t.rotation={field:e.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(e.axis){case"tilt":return Nz(e,t.rotation,0),t;case"roll":return Nz(e,t.rotation,1),t;case null:case void 0:case"heading":return Nz(e,t.rotation,2),t;default:return Ys(i,`Could not convert rotation info: unknown axis "${e.axis}""`),null}}function swe(e,t,i){if(!e)return null;const r=!t.supportedTypes||!!t.supportedTypes.size,s=!t.supportedTypes||!!t.supportedTypes.color,n=!t.supportedTypes||!!t.supportedTypes.rotation,o=!!t.supportedTypes&&!!t.supportedTypes.opacity,a=e.reduce((l,c)=>{if(!l)return l;if(c.valueExpression)return Ys(i,"Could not convert visual variables: arcade expressions not supported"),null;switch(c.type){case"size":return r?vtt(c,l,t,i):l;case"color":return s?btt(c,l,i):l;case"opacity":return o?wtt(c,l,i):null;case"rotation":return n?xtt(c,l,i):l;default:return null}},{size:null,color:null,opacity:null,rotation:null});return!(e.length>0&&a)||a.size||a.color||a.opacity||a.rotation?a&&a.size&&!_tt(a.size,t,i)?null:a:null}function KY(e){return e&&e.size!=null}function ZM(e,t){if(!e)return{enabled:!1};if(zi.TESTS_DISABLE_FAST_UPDATES)return{enabled:!1};const i=swe(e.visualVariables,t);return i?{enabled:!0,visualVariables:i,materialParameters:nwe(i,t),requiresShaderTransformation:KY(i)}:{enabled:!1}}function QM(e,t,i){if(!t||!e.enabled)return!1;const r=e.visualVariables,s=swe(t.visualVariables,i);return!!s&&!!(wI(r.size,s.size,"size")&&wI(r.color,s.color,"color")&&wI(r.rotation,s.rotation,"rotation")&&wI(r.opacity,s.opacity,"opacity"))&&(e.visualVariables=s,e.materialParameters=nwe(s,i),e.requiresShaderTransformation=KY(s),!0)}function wI(e,t,i){if(!!e!=!!t||e&&e.field!==t.field)return!1;if(e&&i==="rotation"){const r=e,s=t;for(let n=0;n<3;n++)if(r.type[n]!==s.type[n]||r.offset[n]!==s.offset[n]||r.factor[n]!==s.factor[n])return!1}return!0}function nwe(e,t){const i={vvSizeEnabled:!1,vvSizeMinSize:null,vvSizeMaxSize:null,vvSizeOffset:null,vvSizeFactor:null,vvSizeValue:null,vvColorEnabled:!1,vvColorValues:null,vvColorColors:null,vvOpacityEnabled:!1,vvOpacityValues:null,vvOpacityOpacities:null,vvSymbolAnchor:null,vvSymbolRotationMatrix:null},r=KY(e);return e&&e.size?(i.vvSizeEnabled=!0,i.vvSizeMinSize=e.size.minSize,i.vvSizeMaxSize=e.size.maxSize,i.vvSizeOffset=e.size.offset,i.vvSizeFactor=e.size.factor):e&&r&&(i.vvSizeValue=t.transformation.scale),e&&r&&(i.vvSymbolAnchor=t.transformation.anchor,i.vvSymbolRotationMatrix=Sr(),Cf(CR),ytt(t.transformation.rotation[2],t.transformation.rotation[0],t.transformation.rotation[1],CR),Ch(i.vvSymbolRotationMatrix,CR)),e&&e.color&&(i.vvColorEnabled=!0,i.vvColorValues=e.color.values,i.vvColorColors=e.color.colors),e&&e.opacity&&(i.vvOpacityEnabled=!0,i.vvOpacityValues=e.opacity.values,i.vvOpacityOpacities=e.opacity.opacityValues),i}(function(e){e[e.Undefined=0]="Undefined",e[e.DefinedSize=1]="DefinedSize",e[e.DefinedScale=2]="DefinedScale"})(Go||(Go={})),function(e){e[e.Undefined=0]="Undefined",e[e.DefinedAngle=1]="DefinedAngle"}(ene||(ene={})),function(e){const t=Ae(),i=O();function r(n,o,a){if(!n.vvSizeEnabled)return a;ms(t,a);const l=n.vvSymbolRotationMatrix;Nf(CR,l[0],l[1],l[2],0,l[3],l[4],l[5],0,l[6],l[7],l[8],0,0,0,0,1),Nr(t,t,CR);for(let c=0;c<3;++c){const h=n.vvSizeOffset[c]+o[0]*n.vvSizeFactor[c];i[c]=$e(h,n.vvSizeMinSize[c],n.vvSizeMaxSize[c])}return T4(t,t,i),Aa(t,t,n.vvSymbolAnchor),t}function s(n,o,a){if(!o.vvSizeEnabled)return ie(n,1,1,1);for(let l=0;l<3;++l){const c=o.vvSizeOffset[l]+a[0]*o.vvSizeFactor[l];n[l]=$e(c,o.vvSizeMinSize[l],o.vvSizeMaxSize[l])}return n}e.evaluateModelTransform=r,e.evaluateModelTransformScale=s}(CF||(CF={}));const CR=Ae(),aj=CF.evaluateModelTransform,Ttt=CF.evaluateModelTransformScale;class Stt{constructor(){this.visible=!0}}class O2{constructor(t,i,r={}){this.data=t,this.material=i,this.boundingSphere=Gt(),this.instanceParameters=new Stt,this._transformation=Ae(),this._shaderTransformationDirty=!0,this.layerUid=yt(r.layerUid,null),this.graphicUid=yt(r.graphicUid,null),this.id=r.id?r.id:sl(),this.boundingInfo=yt(r.boundingInfo,null),this.calculateShaderTransformation=yt(r.calculateShaderTransformation,null),this.castShadow=!!r.castShadow&&r.castShadow}get transformation(){return this._transformation}updateTransformation(t){t(this._transformation),this._shaderTransformationDirty=!0,this.computeBoundingSphere(this._transformation,this.boundingSphere)}shaderTransformationChanged(){this._shaderTransformationDirty=!0}computeBoundingSphere(t,i,r=Lb(t)){R(this.boundingInfo)||(Ue(i,this.boundingInfo.getCenter(),t),i[3]=this.boundingInfo.getBSRadius()*r)}get hasShaderTransformation(){return _(this.calculateShaderTransformation)}get primitiveType(){return this.data.primitiveType}getShaderTransformation(){return R(this.calculateShaderTransformation)?yt(this.transformation,Ks):(this._shaderTransformationDirty&&(this._shaderTransformation||(this._shaderTransformation=Ae()),ms(this._shaderTransformation,this.calculateShaderTransformation(yt(this.transformation,Ks))),this._shaderTransformationDirty=!1),this._shaderTransformation)}computeAttachmentOrigin(t){if(this.material.computeAttachmentOrigin)return!!this.material.computeAttachmentOrigin(this,t)&&(_(this._transformation)&&Ue(t,t,this._transformation),!0);const i=this.indices.get(A.POSITION),r=this.vertexAttributes.get(A.POSITION);return!!Mve(r,i,t)&&(_(this._transformation)&&Ue(t,t,this._transformation),!0)}get indices(){return this.data.indices}get vertexAttributes(){return this.data.vertexAttributes}addHighlight(){const t=new _F(Eg.Highlight),i=this.instanceParameters;return i.highlights=k7(i.highlights,t),t}removeHighlight(t){const i=this.instanceParameters;i.highlights=z7(i.highlights,t)}}const Ett=Ae(),rne=Fe(0,0,1),Ctt=16,Att=1.5,rb=IY,Rtt=[rb/2,rb/2,1-rb/2,1-rb/2],Mtt=[GM*rb,GM*rb];class JM extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}getCachedSize(){return{size:this._getIconSize()}}async doLoad(t){this._validateOrThrow();const i=this._prepareMaterialParameters(),r=this._getPrimitive();if(_(r))this._prepareResourcesPrimitive(i,r);else{const s=VNe(this.symbol,this.symbolLayer),n=y4(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(i,JSON.parse(n.data),t):await this._prepareResourcesHref(i,s,t)}}_validateOrThrow(){if(this._drivenProperties.size)return;const t=U5(this._getIconSize());if(t)throw new q("graphics3diconsymbollayer:invalid-size",t)}_getIconSize(){const t=this.symbolLayer,i=Math.round(t.size!=null?Jn(t.size):Ctt);return this._drivenProperties.size?Math.max(i,64):i}_generateTextureCIM(t){const i=this._getGraphicHash(t);let r=i===""?null:this._cimSymbolTextures.get(i);if(!r){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol(this._cimLayers,t,"esriGeometryPoint",s,null,null);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height,powerOfTwoResizeMode:sv.PAD};r=new Cs(n.imageData,o),this._cimSymbolTextures.set(i,r),this._context.stage.add(r)}return r}_computeSize(t,i){const r=t.width/t.height;return r>1?[i,Math.round(i/r)]:[Math.round(i*r),i]}_prepareMaterialParameters(){const t={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},i=this.symbol;if(Ott(i)){const{screenLength:r,minWorldLength:s,maxWorldLength:n}=i.verticalOffset;t.verticalOffset={screenLength:Jn(r),minWorldLength:s||0,maxWorldLength:n!=null?n:1/0}}return this._context.screenSizePerspectiveEnabled&&(t.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),t.occlusionTest=!0,t.hasSlicePlane=this._context.slicePlaneEnabled,t}_prepareResourcesPrimitive(t,i){const r=this._getOutlineSize();if(Fz(i)&&r===0)throw new Error("Nothing to render");this._outlineSize=r,t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize;const s=this._context.sharedResources.textures.fromData(i,()=>h1e(i));this._texture=s.texture,this._releaseTexture=s,t.textureIsSignedDistanceField=!0,t.distanceFieldBoundingBox=Rtt,t.textureId=this._texture.id;const n=this._getIconSize();this._size=[n,n],this._symbolTextureRatio=1/rb,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesHref(t,i,r){if(!he("esri-canvas-svg-support")&&yq(i))throw new q("graphics3diconsymbollayer:unsupported-image-format","IconSymbol3DLayer failed to load (SVG symbols are not supported in IE11)");this._outlineSize=this._getOutlineSize(),t.color=this._getFillColor(),t.outlineColor=this._getOutlineColor(),t.outlineSize=this._outlineSize,t.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.state.pixelRatio,o=await nc(this._context.sharedResources.textures.fromUrl(i,n,{signal:r}));if(o.ok===!1)throw Pg(o.error),new q("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${i})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.params;this._size=this._computeSize(l,s),t.textureId=a.id,this._createMaterialAndAddToStage(t,this._context.stage)}async _prepareResourcesCIM(t,i,r){const s=new V2({data:i});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await import("./CIMSymbolRasterizer.e4814c2e.js")).CIMSymbolRasterizer;li(r),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:r}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await eAe(p,this._context.layer.spatialReference,n);a=(m,y,v)=>{const w=ntt(f,m,{$view:v},"esriGeometryPoint",y);return w!==null?w:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];li(r);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=t,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||iMe}_getOutlineSize(){let t=0;const i=this.symbolLayer;return _(i.outline)&&i.outline.size!=null?Math.max(Jn(i.outline.size),0):(t=Fz(this._getPrimitive())?Att:0,Math.max(t,0))}_getOutlineColor(){const t=this._getLayerOpacity(),i=this.symbolLayer,r=Yr(i,"outline","color");if(_(r)){const s=qe.toUnitRGB(r),n=r.a*t;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(Fz(this._getPrimitive()))return ltt;const t=R(this._getPrimitive()),i=Yr(this.symbolLayer,"material","color");return this._getCombinedOpacityAndColor(i,{hasIntrinsicColor:t})}_getAnchorPos(t,i){return t==="relative"?Oi((i.x||0)+.5,.5-(i.y||0)):t in tL?tL[t]:tL.center}_createMaterialAndAddToStage(t,i){if(this._cimLayers?this._fastUpdates={enabled:!1}:this._fastUpdates=ZM(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates.enabled&&Object.assign(t,this._fastUpdates.materialParameters),this._cimLayers){let r=_(t.textureId)?this._cimSymbolMaterials.get(t.textureId):null;return r||(r=new S2(t),this._cimSymbolMaterials.set(yt(t.textureId,0),r),i.add(r)),r}return this._material=new S2(t),i.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(t=>{t.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(t=>this._context.stage.remove(t)),this._cimSymbolTextures.clear(),this._releaseTexture=Wi(this._releaseTexture)}_getScaleFactor(t,i){if(this._drivenProperties.size&&t.size){for(let r=0;r<3;r++){const s=t.size[r];s&&s!=="symbol-value"&&s!=="proportional"&&(t.size[r]=Jn(s))}if(t.size[0]==="symbol-value")return 1;if(isFinite(+t.size[0]))return+t.size[0]/i;if(isFinite(+t.size[2]))return+t.size[2]/i}return 1}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;let r,s;if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(i),f=F({textureId:p.id},this._cimMaterialParametersInfo);s=this._createMaterialAndAddToStage(f,this._context.stage),r=[p.params.width,p.params.height]}else r=this._size,s=this._material;const n=qM(i.geometry);if(R(n))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const o=t.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates.enabled||!this._fastUpdates.visualVariables.size){const p=r[0]>r[1]?r[0]:r[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=[r[0]*l,r[1]*l],h=this.setGraphicElevationContext(i,new _u);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(i,n,s,a,c,t.layer.uid):this._createAs3DShape(i,n,s,a,c,h,i.uid)}layerOpacityChanged(){const t=this._getFillColor(),i=this._getOutlineColor();return this._forEachMaterial(r=>{r.setParameters({color:t}),r.setParameters({outlineColor:i})}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=KO(JM.elevationModeChangeTypes,r,s);if(n!==Br.UPDATE)return n;const o=Oh(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(t=>{t.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!!this._getPrimitive()}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!QM(this._fastUpdates,i,this._fastVisualVariableConvertOptions()))return Qs.Recreate_Symbol;_(this._material)&&this._material.setParameters(this._fastUpdates.materialParameters)}return Qs.Fast_Update}_defaultElevationInfoNoZ(){return Ptt}_createAs3DShape(t,i,r,s,n,o,a){const l=this.getFastUpdateAttrValues(t),c=l?m=>aj(this._fastUpdates.materialParameters,l,m):null,h=[Nl.createPointGeometry(rne,null,s,n,Itt,null,l)],p=jY(this._context,i,h,[r],o,this._context.layer.uid,a,c);if(p===null)return null;const f=new jf(this,p.object,h,null,null,jM,o);return f.alignedSampledElevation=p.sampledElevation,f.needsElevationUpdates=Oh(o.mode)||o.mode==="absolute-height",f.getScreenSize=this._createScreenSizeGetter(n,c),f.calculateRelativeScreenBounds=m=>r.calculateRelativeScreenBounds(f.getScreenSize(),1,m),HM(f,i,this._context.elevationProvider),f}_createAsOverlay(t,i,r,s,n,o){r.renderPriority=this._renderPriority;const a=Gt();Mn(i,a,this._context.overlaySR),a[2]=QY;const l=this._context.clippingExtent;if(_(l)&&!aq(l,a))return null;const c=this.getFastUpdateAttrValues(t),h=c?y=>aj(this._fastUpdates.materialParameters,c,y):null,p=Nl.createPointGeometry(rne,a,s,n,null,null,c),f=new O2(p,r,{layerUid:o,graphicUid:t.uid,calculateShaderTransformation:h});a[3]=0,Pd(f.boundingSphere,a);const m=new tU(this,[f],null,this._context.drapeSourceRenderer);return m.getScreenSize=this._createScreenSizeGetter(n,h),m.calculateRelativeScreenBounds=y=>r.calculateRelativeScreenBounds(m.getScreenSize(),1,y),m}_createScreenSizeGetter(t,i){const r=this._outlineSize+2;if(this._fastUpdates.enabled){const s=t[0]/this._symbolTextureRatio,n=t[1]/this._symbolTextureRatio;return(o=tt())=>{const a=i(Ett);return o[0]=a[0]*s+r,o[1]=a[5]*n+r,o}}{const s=t[0]/this._symbolTextureRatio+r,n=t[1]/this._symbolTextureRatio+r;return(o=tt())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const t=this._size[0]>this._size[1]?this._size[0]:this._size[1],i=Fe(t,t,t),r=uu(1),s=t*r;return{modelSize:i,symbolSize:Fe(s,s,s),unitInMeters:r,transformation:{anchor:Ta,scale:of,rotation:Ta}}}_getGraphicHash(t){let i="";for(const r of this._cimRequiredFields)i+=r+t.attributes[r];return i}_forEachMaterial(t){_(this._material)&&t(this._material),this._cimSymbolMaterials.forEach(t)}test(){return ve(F({},super.test()),{material:this._material})}}function Ott(e){return e&&e.type==="point-3d"&&e.hasVisibleVerticalOffset()}function Fz(e){return!R(e)&&(e==="cross"||e==="x")}JM.PRIMITIVE_SIZE=Mtt,JM.elevationModeChangeTypes={definedChanged:Br.UPDATE,staysOnTheGround:Br.NONE,onTheGroundChanged:Br.RECREATE};const Ptt={mode:"relative-to-ground",offset:0},Itt=fi(0,0,0,1);function lj(e){const t=[],i=[];Ltt(e,i,t);const r=i[0][1].data,s=t[0][1].length,n=new Uint16Array(s);return Ntt(e,i,t),Ftt(e,i,t,n),ktt(e,i,t,n),Utt(e,i,t,n),ztt(e,i,t,n),Vtt(e,i,t,n),Btt(e,i,t,r),new Or(i,t,ll.Line)}function $tt(e,t,i,r){const s=e.type==="polygon"?Of.CCW_IS_HOLE:Of.NONE,n=e.type==="polygon"?e.rings:e.paths,{position:o,outlines:a}=i3(n,e.hasZ,s),l=new Float64Array(o.length),c=j1e(o,e.spatialReference,0,l,0,o,0,o.length/3,t,i,r),h=c!=null;return{lines:h?owe(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function owe(e,t,i){const r=new Array;for(const{index:s,count:n}of e){if(n<=1)continue;const o=3*s,a=o+3*n;r.push({position:t.subarray(o,a),mapPosition:i?i.subarray(o,a):void 0})}return r}function Dtt(e,t){const i=e.type==="polygon"?Of.CCW_IS_HOLE:Of.NONE,r=e.type==="polygon"?e.rings:e.paths,{position:s,outlines:n}=i3(r,!1,i),o=ar(s,e.spatialReference,0,s,t,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=QY;return{lines:o?owe(n,s):[],projectionSuccess:o}}function Ltt(e,t,i){const{attributeData:{position:r},removeDuplicateStartEnd:s}=e,n=Gtt(r)&&s===sw.REMOVE,o=r.length/3-(n?1:0),a=new Uint32Array(2*(o-1)),l=n?bH(r,0,r.length-3):r;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;t.push([A.POSITION,{size:3,data:l,exclusive:n}]),i.push([A.POSITION,a])}function Ntt(e,t,i){const r=e.attributeData.mapPosition;R(r)||(i.push([A.MAPPOS,i[0][1]]),t.push([A.MAPPOS,{size:3,data:r}]))}function Ftt(e,t,i,r){if(_(e.attributeData.colorFeature))return;const s=e.attributeData.color;t.push([A.COLOR,{size:4,data:yt(s,ctt)}]),i.push([A.COLOR,r])}function Utt(e,t,i,r){const s=e.attributeData.colorFeature;R(s)||(t.push([A.COLORFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([A.COLOR,r]))}function ktt(e,t,i,r){if(_(e.attributeData.sizeFeature))return;const s=e.attributeData.size;t.push([A.SIZE,{size:1,data:[yt(s,1)]}]),i.push([A.SIZE,r])}function ztt(e,t,i,r){const s=e.attributeData.sizeFeature;R(s)||(t.push([A.SIZEFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([A.SIZEFEATUREATTRIBUTE,r]))}function Vtt(e,t,i,r){const s=e.attributeData.opacityFeature;R(s)||(t.push([A.OPACITYFEATUREATTRIBUTE,{size:1,data:new Float32Array([s])}]),i.push([A.OPACITYFEATUREATTRIBUTE,r]))}function Btt(e,t,i,r){if(R(e.overlayInfo)||e.overlayInfo.renderCoordsHelper.viewingMode!==Ve.Global||!e.overlayInfo.spatialReference.isGeographic)return;const s=new Float64Array(r.length),n=vi(e.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)Fq(r,f,s,f,n);const o=r.length/3,a=new Float32Array(o+1);let l=jtt,c=Htt,h=0,p=0;ie(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),ie(c,s[p++],s[p++],s[p++]),h+=P0e(l,c),a[f]=h,[l,c]=[c,l];t.push([A.DISTANCETOSTART,{size:1,data:a}]),i.push([A.DISTANCETOSTART,i[0][1]])}function Gtt(e){const t=e.length;return e[0]===e[t-3]&&e[1]===e[t-2]&&e[2]===e[t-1]}var sw;(function(e){e[e.KEEP=0]="KEEP",e[e.REMOVE=1]="REMOVE"})(sw||(sw={}));const jtt=O(),Htt=O();function cj(e){switch(e){case"butt":return wh.BUTT;case"square":return wh.SQUARE;case"round":return wh.ROUND;default:return null}}const AF=64,awe=AF/2,lwe=awe/5;function qtt(e,t){return _(t)?Wtt(e,Xtt(t.style)):null}function Wtt(e,t){return e.fromData(t,()=>h1e(t,AF,awe,lwe))}function Xtt(e){return e==="diamond"?"kite":e}function Ytt(e){const t=new Bi,i=e.hasMultipassTerrain&&(e.output===J.Color||e.output===J.Alpha);t.include(pbe,e),e.output===J.Depth&&t.include(Bv,e);const{vertex:r,fragment:s}=t;return s.include(uc),ou(t,e),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.UV0,"vec2"),t.attributes.add(A.AUXPOS1,"vec3"),t.varyings.add("vColor","vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vUV","vec2"),t.varyings.add("vSize","float"),t.varyings.add("linearDepth","float"),i&&t.varyings.add("depth","float"),r.code.add(x`#define PERPENDICULAR(v) vec2(v.y, -v.x)
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}`),r.uniforms.add([new di("nearFar",(n,o)=>o.camera.nearFar),new ei("viewport",(n,o)=>o.camera.fullViewport)]),r.code.add(x`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),r.code.add(x`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
prev = mix(pos, prev, interp(vnp, pos, prev));
}
}`),e.draped||(r.uniforms.add(new vr("inverseProjectionMatrix",(n,o)=>o.camera.inverseProjectionMatrix)),r.code.add(x`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),r.code.add(x`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),r.uniforms.add(new We("perScreenPixelRatio",(n,o)=>o.camera.perScreenPixelRatio)),r.code.add(x`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${e.hasCap?`
                if(prev.z > posLeft.z) {
                  vec2 diff = posLeft.xy - posRight.xy;
                  planeOrigin.xy += PERPENDICULAR(diff) / 2.0;
                }
              `:""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),r.uniforms.add(new We("pixelRatio",(n,o)=>o.camera.pixelRatio)),r.code.add(x`
    void main(void) {
      float coverage = 1.0;

      // Check for special value of uv0.y which is used by the Renderer when graphics
      // are removed before the VBO is recompacted. If this is the case, then we just
      // project outside of clip space.
      if (uv0.y == 0.0) {
        // Project out of clip space
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
      }
      else {
        float lineSize = getSize();
        float lineWidth = max(lineSize, 1.0) * pixelRatio;

        vec4 pos  = view * vec4(position.xyz, 1.0);
        vec4 prev = view * vec4(auxpos1.xyz, 1.0);
        clip(pos, prev);

        vec4 posScreen = projectAndScale(pos);
        vec4 prevScreen = projectAndScale(prev);

        vec2 segment = posScreen.xy - prevScreen.xy;

        // normalize vector along line segment
        float segmentLen = length(segment);
        segment = (segmentLen > 0.001) ? segment / segmentLen : vec2(0.0, 0.0);

        // displace according to position in the texture
        vec2 displacementDirU = PERPENDICULAR(segment);
        vec2 displacementDirV = segment;

        float displacementLen = ${x.float(AF/lwe)} * lineWidth;

        vec4 displacedPosScreen = posScreen;
        displacedPosScreen.xy += uv0.x * displacementDirU * displacementLen + uv0.y * displacementDirV * displacementLen;
  `),e.draped||r.code.add(x`vec3 posRight = inverseProject(posScreen + vec4(displacementDirU.xy, 0.0, 0.0) * lineWidth);
vec3 posLeft = pos.xyz + (pos.xyz - posRight);
pos = toFront(displacedPosScreen, posLeft, posRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`),r.code.add(x`
        ${i?"depth = pos.z;":""}
        linearDepth = (-pos.z - nearFar[0]) / (nearFar[1] - nearFar[0]);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1] and cancel out perspective correct interpolation
        vUV = (uv0 + 1.0) / 2.0;
        vUV *= displacedPosScreen.w;

        vSize = displacementLen;

        vColor = getColor();
        vColor.a *= coverage;

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),i&&t.include(yu,e),t.include(ls,e),s.uniforms.add([new ei("intrinsicColor",n=>n.color),new zt("tex",n=>n.texture)]),s.include(Vf),s.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${i?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    // Offset texture coordinate s.t. we sample texel centers
    float texelSize = ${x.float(1/AF)};
    vec2 samplePos = vUV * gl_FragCoord.w + vec2(0.5, -0.5) * texelSize;

    // Evaluate sdf
    float sdf = rgba2float(texture2D(tex, samplePos)) - 0.5;
    float distance = sdf * vSize;

    // Grow by a halfpixel to make sure the line is fully covered by the cross marker
    // (otherwise there will be a halo if they are different colours)
    distance -= 0.5;

    finalColor.a *= clamp(0.5 - distance, 0.0, 1.0);

    if (finalColor.a < ${x.float(Eo)}) {
      discard;
    }

    ${e.output===J.Alpha?x`gl_FragColor = vec4(finalColor.a);`:""}
    ${e.output===J.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===J.Color&&e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
    ${e.output===J.Highlight?x`gl_FragColor = vec4(1.0);`:""}
    ${e.output===J.Depth?x`outputDepth(linearDepth);`:""}
  }
  `),t}const Ztt=Object.freeze(Object.defineProperty({__proto__:null,build:Ytt},Symbol.toStringTag,{value:"Module"})),cwe=new Map([[A.POSITION,0],[A.UV0,2],[A.AUXPOS1,3],[A.SIZE,6],[A.SIZEFEATUREATTRIBUTE,6],[A.COLOR,5],[A.COLORFEATUREATTRIBUTE,5],[A.OPACITYFEATUREATTRIBUTE,7]]);class rU extends lr{initializeProgram(t){const i=rU.shader.get().build(this.configuration);return new Ji(t.rctx,i,cwe)}_makePipelineState(t,i){const r=this.configuration,s=t===gt.NONE;return Ut({blending:r.output===J.Color||r.output===J.Alpha?s?au:Gg(t):null,depthTest:{func:Vv(t)},depthWrite:s?r.writeDepth&&pl:D5(t),colorWrite:Jt,stencilWrite:r.hasOccludees?Pf:null,stencilTest:r.hasOccludees?i?Ov:Gv:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=Ut({blending:au,depthTest:xF,depthWrite:null,colorWrite:Jt,stencilWrite:null,stencilTest:ybe}),this._occluderPipelineOpaque=Ut({blending:au,depthTest:xF,depthWrite:null,colorWrite:Jt,stencilWrite:mbe,stencilTest:gbe}),this._occluderPipelineMaskWrite=Ut({blending:null,depthTest:WY,depthWrite:null,colorWrite:null,stencilWrite:Pf,stencilTest:Ov})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:this.configuration.occluder?t===Se.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:t===Se.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(t,i)}}rU.shader=new Qi(Ztt,()=>import("./LineMarker.glsl.1d4c9d2e.js"));class ca extends Ho{constructor(){super(...arguments),this.output=J.Color,this.transparencyPassType=gt.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.draped=!1,this.hasCap=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}u([G({count:J.COUNT})],ca.prototype,"output",void 0),u([G({count:gt.COUNT})],ca.prototype,"transparencyPassType",void 0),u([G()],ca.prototype,"occluder",void 0),u([G()],ca.prototype,"hasSlicePlane",void 0),u([G()],ca.prototype,"writeDepth",void 0),u([G()],ca.prototype,"draped",void 0),u([G()],ca.prototype,"hasCap",void 0),u([G()],ca.prototype,"vvSize",void 0),u([G()],ca.prototype,"vvColor",void 0),u([G()],ca.prototype,"vvOpacity",void 0),u([G()],ca.prototype,"hasOccludees",void 0),u([G()],ca.prototype,"hasMultipassTerrain",void 0),u([G()],ca.prototype,"cullAboveGround",void 0),u([G({constValue:!0})],ca.prototype,"hasVvInstancing",void 0),u([G({constValue:!0})],ca.prototype,"hasSliceTranslatedView",void 0);class Qtt extends Gf{constructor(t){super(t,new Ktt),this._vertexAttributeLocations=cwe,this.techniqueConfig=new ca,this.layout=this.createLayout()}dispose(){}getConfiguration(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.draped=i.slot===Se.DRAPED_MATERIAL,this.techniqueConfig.hasCap=this.parameters.cap!==wh.BUTT,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.hasOccludees=this.parameters.hasOccludees,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.vvColor=this.parameters.vvColorEnabled,this.techniqueConfig.vvOpacity=this.parameters.vvOpacityEnabled,this.techniqueConfig.vvSize=this.parameters.vvSizeEnabled,this.techniqueConfig.occluder=this.parameters.renderOccluded===Mr.OccludeAndTransparentStencil,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(){}createLayout(){const t=Kr().vec3f(A.POSITION).vec2f(A.UV0).vec3f(A.AUXPOS1);return this.parameters.vvSizeEnabled?t.f32(A.SIZEFEATUREATTRIBUTE):t.f32(A.SIZE),this.parameters.vvColorEnabled?t.f32(A.COLORFEATUREATTRIBUTE):t.vec4f(A.COLOR),this.parameters.vvOpacityEnabled&&t.f32(A.OPACITYFEATUREATTRIBUTE),t}createBufferWriter(){return new eit(this.layout,this.parameters)}requiresSlot(t,i){if(t===Se.DRAPED_MATERIAL)return!0;if(this.parameters.renderOccluded===Mr.OccludeAndTransparentStencil)return t===Se.OPAQUE_MATERIAL||t===Se.OCCLUDER_MATERIAL||t===Se.TRANSPARENT_OCCLUDER_MATERIAL;const r=ew(i);return r===J.Color||r===J.Alpha?t===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):t===Se.OPAQUE_MATERIAL}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Highlight||t.output===J.Depth?new Jtt(t):null}}class Jtt extends UX{_updateParameters(t){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(rU,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||this._updateOccludeeState(t),this._updateParameters(t)}}class Ktt extends $Y{constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.placement="end",this.cap=wh.BUTT,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1}}class eit{constructor(t,i){this.vertexBufferLayout=t,this.parameters=i}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(){return this.parameters.placement==="begin-end"?12:6}write(t,i,r,s){const n=i.vertexAttributes.get(A.POSITION).data,o=n.length/3;let a=1,l=0;this.parameters.vvSizeEnabled?l=i.vertexAttributes.get(A.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.SIZE)&&(a=i.vertexAttributes.get(A.SIZE).data[0]);let c=[1,1,1,1],h=0;this.parameters.vvColorEnabled?h=i.vertexAttributes.get(A.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(A.COLOR)&&(c=i.vertexAttributes.get(A.COLOR).data);let p=0;this.parameters.vvOpacityEnabled&&(p=i.vertexAttributes.get(A.OPACITYFEATUREATTRIBUTE).data[0]);const f=t.transformation,m=new Float32Array(r.buffer);let y=s*(this.vertexBufferLayout.stride/4);const v=(T,E,C,M)=>{if(m[y++]=T[0],m[y++]=T[1],m[y++]=T[2],m[y++]=C[0],m[y++]=C[1],m[y++]=E[0],m[y++]=E[1],m[y++]=E[2],this.parameters.vvSizeEnabled?m[y++]=l:m[y++]=a,this.parameters.vvColorEnabled)m[y++]=h;else{const I=Math.min(4*M,c.length-4);m[y++]=c[I+0],m[y++]=c[I+1],m[y++]=c[I+2],m[y++]=c[I+3]}this.parameters.vvOpacityEnabled&&(m[y++]=p)};let w;(function(T){T[T.ASCENDING=1]="ASCENDING",T[T.DESCENDING=-1]="DESCENDING"})(w||(w={}));const b=(T,E)=>{const C=ie(tit,n[3*T],n[3*T+1],n[3*T+2]),M=iit;let I=T+E;do ie(M,n[3*I],n[3*I+1],n[3*I+2]),I+=E;while(Tb(C,M)&&I>=0&&I<o);f&&(Ue(C,C,f),Ue(M,M,f)),v(C,M,[-1,-1],T),v(C,M,[1,-1],T),v(C,M,[1,1],T),v(C,M,[-1,-1],T),v(C,M,[1,1],T),v(C,M,[-1,1],T)},S=this.parameters.placement;S!=="begin"&&S!=="begin-end"||b(0,w.ASCENDING),S!=="end"&&S!=="begin-end"||b(o-1,w.DESCENDING)}}const tit=O(),iit=O(),Do={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},rit={dash:Do.dash,"dash-dot":[...Do.dash,...Do.dot],dot:Do.dot,"long-dash":Do["long-dash"],"long-dash-dot":[...Do["long-dash"],...Do.dot],"long-dash-dot-dot":[...Do["long-dash"],...Do.dot,...Do.dot],none:null,"short-dash":Do["short-dash"],"short-dash-dot":[...Do["short-dash"],...Do["short-dot"]],"short-dash-dot-dot":[...Do["short-dash"],...Do["short-dot"],...Do["short-dot"]],"short-dot":Do["short-dot"],solid:null},sit=8;function nit(e,t=2){return R(e)?e:{pattern:e.slice(),pixelRatio:t}}function y1t(e,t=2){return{pattern:[e,e],pixelRatio:t}}function uwe(e){return _(e)&&e.type==="style"?oit(e.style):null}function oit(e){return _(e)?nit(rit[e],sit):null}const ait=["polyline","polygon","extent"];class sU extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._uniformSize=1}async doLoad(){if(this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[1,1,1],unitInMeters:1,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=ZM(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1},!this._drivenProperties.size){const t=this.symbolLayer.size!=null?this.symbolLayer.size:uu(1);if(t<0)throw new q("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values");this._uniformSize=t}this._markerTexture=qtt(this._context.sharedResources.textures,this.symbolLayer.marker)}_getMaterialParameters(t,i=!1){var n;const r=this._getCombinedOpacityAndColor(i&&this._markerColor||this._materialColor);this._patternHidesLine&&!i&&(r[3]=0);const s={width:this._computeMaterialWidth((n=this.symbolLayer)==null?void 0:n.size),color:r,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:cj(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:t,stipplePattern:uwe(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates&&this._fastUpdates.visualVariables?F(F({},s),this._fastUpdates.materialParameters):s}get _materialColor(){return qs(this.symbolLayer.material,t=>t.color)}get _markerColor(){return qs(this.symbolLayer.marker,t=>t.color)}get lineMaterial(){return R(this._lineMaterial)&&(this._lineMaterial=new VT(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterial)),this._lineMaterial}get ringMaterial(){return R(this._ringMaterial)&&(this._ringMaterial=new VT(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterial)),this._ringMaterial}get wireframeLineMaterial(){return R(this._wireframeLineMaterial)&&(this._wireframeLineMaterial=new VT(ve(F({},this._getMaterialParameters(!1)),{wireframe:!0})),this._context.stage.add(this._wireframeLineMaterial)),this._wireframeLineMaterial}get wireframeRingMaterial(){return R(this._wireframeRingMaterial)&&(this._wireframeRingMaterial=new VT(ve(F({},this._getMaterialParameters(!0)),{wireframe:!0})),this._context.stage.add(this._wireframeRingMaterial)),this._wireframeRingMaterial}get markerMaterial(){return R(this._markerMaterial)&&_(this.symbolLayer.marker)&&_(this._markerTexture)&&(this._markerMaterial=new Qtt(ve(F({},this._getMaterialParameters(!1,!0)),{placement:this.symbolLayer.marker.placement,textureId:this._markerTexture.texture.id})),this._context.stage.add(this._markerMaterial)),this._markerMaterial}destroy(){super.destroy(),this._forEachMaterial(t=>this._context.stage.remove(t)),this._lineMaterial=null,this._ringMaterial=null,this._wireframeLineMaterial=null,this._wireframeRingMaterial=null,this._markerMaterial=null,this._markerTexture=Wi(this._markerTexture)}_getDrivenSize(t){return this._drivenProperties.size&&t.size?Jn(eKe(t.size)):1}_getSizeFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?cg(this._fastUpdates.visualVariables.size.field,t):null}_getDrivenColor(t){const i=fi(1,1,1,1);return this._drivenProperties.color&&t.color&&(i[0]=t.color[0],i[1]=t.color[1],i[2]=t.color[2],t.color.length>0&&(i[3]=t.color[3])),this._drivenProperties.opacity&&t.opacity&&(i[3]=t.opacity),i}_getColorFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color?cg(this._fastUpdates.visualVariables.color.field,t):null}_getOpacityFeatureAttributeData(t){return this._fastUpdates.enabled&&this._fastUpdates.visualVariables.opacity?cg(this._fastUpdates.visualVariables.opacity.field,t):null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,ait,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new _u);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.draped?this._createAsOverlay(t,this._context.layer.uid):this._createAs3DShape(t,r,i.uid)}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!QM(this._fastUpdates,i,this._vvConvertOptions))return Qs.Recreate_Symbol;this._forEachMaterial(s=>s.setParameters(this._fastUpdates.materialParameters))}return Qs.Fast_Update}prepareSymbolLayerPatch(t){var n,o;if(t.diff.type!=="partial")return;const i=t.diff.diff,r={};((n=i.size)==null?void 0:n.type)==="complete"&&(r.width=this._computeMaterialWidth(i.size.newValue),delete i.size),((o=i.cap)==null?void 0:o.type)==="complete"&&(r.cap=cj(yt(i.cap.newValue,"butt")),delete i.cap);const s=this._prepareMarkerPatch(t,i);this._prepareMaterialPatch(t,i,s),t.symbolLayerStatePatches.push(()=>this._forEachMaterial(a=>a.setParameters(r)))}layerOpacityChanged(){return this._forEachMaterial((t,i)=>this._updateMaterialLayerOpacity(t,i)),!0}_forEachMaterial(t){_(this._lineMaterial)&&t(this._lineMaterial),_(this._ringMaterial)&&t(this._ringMaterial),_(this._wireframeLineMaterial)&&t(this._wireframeLineMaterial),_(this._wireframeRingMaterial)&&t(this._wireframeRingMaterial),_(this._markerMaterial)&&t(this._markerMaterial,!0)}_updateMaterialLayerOpacity(t,i=!1){const r=t.parameters.color,s=Yr(this.symbolLayer,"material","color"),n=this._patternHidesLine&&!i?0:this._getCombinedOpacity(s),o=fi(r[0],r[1],r[2],n);t.setParameters({color:o})}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=KO(sU.elevationModeChangeTypes,r,s);if(n!==Br.UPDATE)return n;const o=Oh(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){const t={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(i=>i.setParameters(t)),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_getGeometryAsPolygonOrPolyline(t){switch(t.type){case"extent":if(t instanceof ci)return cu.fromExtent(t);break;case"polygon":case"polyline":return t}return null}_createAs3DShape(t,i,r){const s=t.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=new Array,c=new Array,h=Ls(),p=$tt(n,this._context.elevationProvider,this._context.renderCoordsHelper,i),f=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(p,o,f,"LineSymbol3DLayer");for(let v=0;v<p.lines.length;v++){const{position:w,mapPosition:b}=p.lines[v];if(_(this._context.clippingExtent)&&(cr(h),Kc(h,b),!$d(h,this._context.clippingExtent)))continue;const S=this._createGeometry(t,w,b,n.type,AR.ELEVATED);a.push(S),l.push(n.type==="polygon"?this.ringMaterial:this.lineMaterial),c.push(Ks),zi.LINE_WIREFRAMES&&(a.push(S.cloneShallow()),l.push(n.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial),c.push(Ks));const T=this.markerMaterial;_(T)&&(a.push(S.cloneShallow()),l.push(T),c.push(Ks))}if(a.length===0)return null;const m=new Hg({geometries:a,materials:l,transformations:c,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),y=new jf(this,m,a,null,null,fJe,i);return y.alignedSampledElevation=p.sampledElevation,y.needsElevationUpdates=Oh(i.mode),y}_createGeometry(t,i,r,s,n){const o=s==="polygon"?sw.REMOVE:sw.KEEP,a=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.color,l=this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size;return lj({overlayInfo:n===AR.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,removeDuplicateStartEnd:o,uniformSize:this._uniformSize,attributeData:{position:i,mapPosition:r,size:l?null:this._getDrivenSize(t.renderingInfo),color:a?null:this._getDrivenColor(t.renderingInfo),sizeFeature:this._getSizeFeatureAttributeData(t.graphic),colorFeature:this._getColorFeatureAttributeData(t.graphic),opacityFeature:this._getOpacityFeatureAttributeData(t.graphic)}})}_createAsOverlay(t,i){const r=t.graphic,s=this._getGeometryAsPolygonOrPolyline(r.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this.ringMaterial:this.lineMaterial;o.renderPriority=this._renderPriority;const a=zi.LINE_WIREFRAMES?s.type==="polygon"?this.wireframeRingMaterial:this.wireframeLineMaterial:null,l=this.markerMaterial;_(a)&&(a.renderPriority=this._renderPriority-.001),_(l)&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=Ls(),p=cr(),f=Dtt(s,this._context.overlaySR),m=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,m,"LineSymbol3DLayer");for(const y of f.lines){if(cr(h),Kc(h,y.position),!$d(h,this._context.clippingExtent))continue;NS(p,h);const v=this._createGeometry(t,y.position,null,s.type,AR.DRAPED),w=S=>{const T=new O2(v,S,{layerUid:i,graphicUid:r.uid});return c.push(T),T};if(_(l)){const S=w(l),T=this.symbolLayer.marker.placement;T!=="begin"&&T!=="begin-end"||Kc(h,y.position,0,1),T!=="end"&&T!=="begin-end"||Kc(h,y.position,y.position.length-3,1),this._updateBoundingSphere(S,h)}const b=w(o);if(this._updateBoundingSphere(b,h),zi.LINE_WIREFRAMES){const S=w(a);this._updateBoundingSphere(S,h)}}return new tU(this,c,p,this._context.drapeSourceRenderer)}_updateBoundingSphere(t,i){qi(t.boundingSphere,.5*(i[0]+i[3]),.5*(i[1]+i[4]),0,.5*Math.sqrt((i[3]-i[0])*(i[3]-i[0])+(i[4]-i[1])*(i[4]-i[1])))}get _patternHidesLine(){const t=this.symbolLayer.pattern;return _(t)&&t.type==="style"&&t.style==="none"}_computeMaterialWidth(t){return t=yt(t,uu(1)),this._drivenProperties.size?this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size?Jn(1):1:Jn(t)}_prepareMaterialPatch(t,i,r){const s=i.material;if(R(s))return void(r.changed&&r.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterial,t));if(s.type==="collection")return;const n=s.type==="complete"?qs(s.newValue,a=>a.color):s.diff.color.type==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);r.useMaterialColor&&this._patchMaterialColor(M4(o),this._markerMaterial,t),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterial,t),delete i.material}_prepareMarkerPatch(t,i){const r=i.marker;if(R(r)||r.type!=="partial"||_(r.diff.style)||_(r.diff.placement)||_(r.diff.color)&&r.diff.color.type!=="complete")return{changed:!1,useMaterialColor:R(this._markerColor)};const s=r.diff.color;if(R(s))return delete i.marker,{changed:!1,useMaterialColor:R(this._markerColor)};const n=s.newValue;return R(n)?(delete i.marker,{changed:!0,useMaterialColor:!0}):(this._patchMaterialColor(this._getCombinedOpacityAndColor(n),this._markerMaterial,t),delete i.marker,{changed:!0,useMaterialColor:!1})}_patchMaterialColor(t,i,r){R(i)||r.symbolLayerStatePatches.push(()=>i.setParameters({color:t}))}}var AR;sU.elevationModeChangeTypes={definedChanged:Br.RECREATE,staysOnTheGround:Br.NONE,onTheGroundChanged:Br.RECREATE},function(e){e[e.DRAPED=0]="DRAPED",e[e.ELEVATED=1]="ELEVATED"}(AR||(AR={}));const sne=2048,lit=1.5,cit=8;function uit(e,t){const{format:i,quality:r,rotation:s,disableDecorations:n}=e||{},o=eZ(e,t.padding),a=wit(e,{width:t.width-o.left-o.right,height:t.height-o.top-o.bottom}),{width:l,height:c}=bit(e,a),h=Sit(i),p=Mit[h];return{format:h,quality:$e(r!=null?r:p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!e||!e.ignoreBackground),ignorePadding:!(!e||!e.ignorePadding)}}function hit(e,t){const i=uit(e,t),r=i.area,s=i.width/r.width,n=eZ(i,t.padding),o=n.left+n.right,a=n.top+n.bottom,l=t.width-o,c=t.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=e&&e.layers?e.layers:[],m=i.ignoreBackground,y=i.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(r.x*s)+n.left,y:Math.floor(r.y*s)+n.top,width:i.width,height:i.height},format:i.format,quality:i.quality,rotation:i.rotation,pixelRatio:s,layers:f,disableDecorations:i.disableDecorations,ignoreBackground:m,ignorePadding:y}}function dit(e,t,i){const{ctx:r,canvas:s}=hwe(e,i),n=r.getImageData(0,0,e.width,e.height),o=mit(s,t);return dwe(s),{dataUrl:o,data:n}}function pit(e,t){const{ctx:i,canvas:r}=hwe(e,t),s=i.getImageData(0,0,e.width,e.height);return dwe(r),s}function hwe(e,t){const i=fit();t.premultipliedAlpha&&Cit(e),i.width=e.width,i.height=e.height;const r=i.getContext("2d");return r.putImageData(e,0,0),t.flipY&&Eit(r),{ctx:r,canvas:i}}function dwe(e){e.width=0,e.height=0}function fit(){return R(Uz)&&(Uz=document.createElement("canvas")),Uz}let Uz=null;function mit(e,t){const i=Ait[t.format],r=t.quality/100;return e.toDataURL(i,r)}function kz(e,t,i){if(!e||!t)throw new Error("Cannot construct image data without dimensions");if(RF)try{return new ImageData(e,t)}catch{RF=!1}return pwe(e,t,i)}function git(e,t,i,r){if(!t||!i)throw new Error("Cannot construct image data without dimensions");if(RF)try{return new ImageData(e,t,i)}catch{RF=!1}const s=pwe(t,i,r);return s.data.set(e,0),s}function yit(e,t,i,r=0,s=0,n=e.width-r,o=e.height-s,a=!1){const{data:l}=e,{width:c,height:h,data:p}=t,f=n/c,m=o/h,y=Math.ceil(f/2),v=Math.ceil(m/2),w=e.width;for(let b=0;b<h;b++)for(let S=0;S<c;S++){const T=4*(S+(a?h-b-1:b)*c);let E=0,C=0,M=0,I=0,N=0,D=0;const z=(b+.5)*m;for(let V=Math.floor(b*m);V<(b+1)*m;V++){const k=Math.abs(z-(V+.5))/v,Y=(S+.5)*f,Z=k*k;for(let le=Math.floor(S*f);le<(S+1)*f;le++){const ne=Math.abs(Y-(le+.5))/y,$=Math.sqrt(Z+ne*ne);if($>=1)continue;let U=2*$*$*$-3*$*$+1;const B=4*(r+le+(s+V)*w);D+=U*l[B+3],C+=U,!i&&l[B+3]<255&&(U=U*l[B+3]/255),M+=U*l[B],I+=U*l[B+1],N+=U*l[B+2],E+=U}}p[T]=M/E,p[T+1]=I/E,p[T+2]=N/E,p[T+3]=D/C}return t}function vit(e,t,i){if(!t)return e;const{framebufferWidth:r,framebufferHeight:s,pixelRatio:n,region:o}=e,a=eZ(e,i),l=a.left+a.right,c=a.top+a.bottom,h=r-l,p=s-c,f=Math.min(cit,Math.min((sne-l)/h,(sne-c)/p));return f<lit?e:ve(F({},e),{framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:r,height:s}})}function pwe(e,t,i){return i||(i=_it()),i.getContext("2d").createImageData(e,t)}let rC=null,RF=!0;function _it(){return rC||(rC=document.createElement("canvas"),rC.width=1,rC.height=1),rC}function bit(e,t){if(!e)return t;const i=e.width,r=e.height;if(i!=null&&r!=null)return{width:Math.floor(i),height:Math.floor(r)};if(i==null&&r==null)return t;const s=t.width/t.height;return r==null?{width:Math.floor(i),height:Math.floor(i/s)}:{width:Math.floor(r*s),height:Math.floor(r)}}function wit(e,t){const i={x:0,y:0,width:t.width,height:t.height};if(e&&e.area){e.area.x!=null&&(i.x=Math.floor(e.area.x)),e.area.y!=null&&(i.y=Math.floor(e.area.y));const r=e.area.width!=null?Math.floor(e.area.width):null,s=e.area.height!=null?Math.floor(e.area.height):null;if(i.width=t.width-i.x,i.height=t.height-i.y,r!=null&&s!=null)i.width=Math.min(i.width,r),i.height=Math.min(i.height,s);else if(r==null&&s!=null){const n=Math.min(i.width,r);i.height=n/i.width*i.height,i.width=n}else if(r!=null&&s==null){const n=Math.min(i.height,s);i.width=n/i.height*i.width,i.height=n}}return xit(Tit(i,e),t)}function xit(e,t){const i=Math.floor(Math.max(e.x,0)),r=Math.floor(Math.max(e.y,0)),s={x:i,y:r,width:Math.floor(Math.min(e.width,t.width-i)),height:Math.floor(Math.min(e.height,t.height-r))},n=s.width/s.height,o=e.width/e.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function Tit(e,t){if(!t||t.width==null||t.height==null)return e;const i=t.width/t.height,r=e.width/e.height;if(r===i)return e;if(r<i){const n=Math.floor(e.height*i);return e.x-=(n-e.width)/2,e.width=n,e}const s=Math.floor(e.width/i);return e.y-=(s-e.height)/2,e.height=s,e}function eZ(e,t){return!t||e&&e.ignorePadding?Oit:t}function Sit(e){switch(e){case"png":case"jpg":case"jpeg":return e;default:return Rit}}function Eit(e){e.save(),e.globalCompositeOperation="copy",e.scale(1,-1),e.translate(0,-e.canvas.height),e.drawImage(e.canvas,0,0),e.restore()}function Cit(e){const t=e.data,i=t.length;for(let r=0;r<i;r+=4){const s=t[r+3];if(s!==255&&s>0){const n=255/s;t[r+0]=t[r+0]*n,t[r+1]=t[r+1]*n,t[r+2]=t[r+2]*n}}}const Ait={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},nne=98,Rit="png",Mit={png:100,jpg:nne,jpeg:nne},Oit={top:0,right:0,bottom:0,left:0};var lT;const zz=new WeakMap;let Pit=0,Fp=lT=class extends fe{constructor(e){super(e),this.wrap="repeat"}get url(){return this._get("url")||null}set url(e){this._set("url",e),e&&this._set("data",null)}get data(){return this._get("data")||null}set data(e){this._set("data",e),e&&this._set("url",null)}writeData(e,t,i,r){if(e instanceof HTMLImageElement){const s={type:"image-element",src:Ib(e.src,r),crossOrigin:e.crossOrigin};t[i]=s}else if(e instanceof HTMLCanvasElement){const s=e.getContext("2d").getImageData(0,0,e.width,e.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};t[i]=n}else if(e instanceof HTMLVideoElement){const s={type:"video-element",src:Ib(e.src,r),autoplay:e.autoplay,loop:e.loop,muted:e.muted,crossOrigin:e.crossOrigin,preload:e.preload};t[i]=s}else{const s={type:"image-data",imageData:this._encodeImageData(e)};t[i]=s}}readData(e){switch(e.type){case"image-element":{const t=new Image;return t.src=e.src,t.crossOrigin=e.crossOrigin,t}case"canvas-element":{const t=this._decodeImageData(e.imageData),i=document.createElement("canvas");return i.width=t.width,i.height=t.height,i.getContext("2d").putImageData(t,0,0),i}case"image-data":return this._decodeImageData(e.imageData);case"video-element":{const t=document.createElement("video");return t.src=e.src,t.crossOrigin=e.crossOrigin,t.autoplay=e.autoplay,t.loop=e.loop,t.muted=e.muted,t.preload=e.preload,t}default:return}}get transparent(){const e=this.data,t=this.url;if(e instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(e.getContext("2d").getImageData(0,0,e.width,e.height));if(e instanceof ImageData)return this._imageDataContainsTransparent(e);if(t){const i=t.substr(t.length-4,4).toLowerCase(),r=t.substr(0,15).toLocaleLowerCase();if(i===".png"||r==="data:image/png;")return!0}return!1}set transparent(e){e!=null?this._override("transparent",e):this._clearOverride("transparent")}get contentHash(){const e=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",t=(i="")=>`d:${i},t:${this.transparent},w:${e}`;return this.url!=null?t(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?t(this.data.src):(zz.has(this.data)||zz.set(this.data,++Pit),t(zz.get(this.data))):t()}clone(){const e={url:this.url,data:this.data,wrap:this._cloneWrap()};return new lT(e)}cloneWithDeduplication(e){const t=e.get(this);if(t)return t;const i=this.clone();return e.set(this,i),i}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(e){let t="";for(let i=0;i<e.data.length;i++)t+=String.fromCharCode(e.data[i]);return{data:btoa(t),width:e.width,height:e.height}}_decodeImageData(e){const t=atob(e.data),i=new Uint8ClampedArray(t.length);for(let r=0;r<t.length;r++)i[r]=t.charCodeAt(r);return git(i,e.width,e.height)}_imageDataContainsTransparent(e){for(let t=3;t<e.data.length;t+=4)if(e.data[t]!==255)return!0;return!1}static from(e){return typeof e=="string"?new lT({url:e}):e instanceof HTMLImageElement||e instanceof HTMLCanvasElement||e instanceof ImageData||e instanceof HTMLVideoElement?new lT({data:e}):SS(lT,e)}};u([d({type:String,json:{write:fv}})],Fp.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],Fp.prototype,"data",null),u([Be("data")],Fp.prototype,"writeData",null),u([ke("data")],Fp.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],Fp.prototype,"transparent",null),u([d({json:{write:!0}})],Fp.prototype,"wrap",void 0),u([d({readOnly:!0})],Fp.prototype,"contentHash",null),Fp=lT=u([P("esri.geometry.support.MeshTexture")],Fp);const RR=Fp;var uj;let Am=uj=class extends fe{constructor(e){super(e),this.color=null,this.colorTexture=null,this.normalTexture=null,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new uj(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return{color:_(this.color)?this.color.clone():null,colorTexture:_(this.colorTexture)?this.colorTexture.cloneWithDeduplication(e):null,normalTexture:_(this.normalTexture)?this.normalTexture.cloneWithDeduplication(e):null,alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided}}};u([d({type:qe,json:{write:!0}})],Am.prototype,"color",void 0),u([d({type:RR,json:{write:!0}})],Am.prototype,"colorTexture",void 0),u([d({type:RR,json:{write:!0}})],Am.prototype,"normalTexture",void 0),u([d({nonNullable:!0,json:{write:!0}})],Am.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],Am.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],Am.prototype,"doubleSided",void 0),Am=uj=u([P("esri.geometry.support.MeshMaterial")],Am);const tZ=Am;var hj;let Rm=hj=class extends tZ{constructor(e){super(e),this.emissiveColor=null,this.emissiveTexture=null,this.occlusionTexture=null,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(e,t){const i=_(e)?e.get(this):null;if(i)return i;const r=new hj(this.clonePropertiesWithDeduplication(t));return _(e)&&e.set(this,r),r}clonePropertiesWithDeduplication(e){return ve(F({},super.clonePropertiesWithDeduplication(e)),{emissiveColor:_(this.emissiveColor)?this.emissiveColor.clone():null,emissiveTexture:_(this.emissiveTexture)?this.emissiveTexture.cloneWithDeduplication(e):null,occlusionTexture:_(this.occlusionTexture)?this.occlusionTexture.cloneWithDeduplication(e):null,metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:_(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.cloneWithDeduplication(e):null})}};u([d({type:qe,json:{write:!0}})],Rm.prototype,"emissiveColor",void 0),u([d({type:RR,json:{write:!0}})],Rm.prototype,"emissiveTexture",void 0),u([d({type:RR,json:{write:!0}})],Rm.prototype,"occlusionTexture",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Rm.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],Rm.prototype,"roughness",void 0),u([d({type:RR,json:{write:!0}})],Rm.prototype,"metallicRoughnessTexture",void 0),Rm=hj=u([P("esri.geometry.support.MeshMaterialMetallicRoughness")],Rm);const fwe=Rm;var iL;const tx=me.getLogger("esri.geometry.support.MeshVertexAttributes");let Au=iL=class extends fe{constructor(e){super(e),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(e){return cT(e,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},tx)}castPosition(e){return e&&e instanceof Float32Array&&tx.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),cT(e,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},tx)}castUv(e){return cT(e,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},tx)}castNormal(e){return cT(e,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},tx)}castTangent(e){return cT(e,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},tx)}clone(){const e={position:te(this.position),uv:te(this.uv),normal:te(this.normal),tangent:te(this.tangent),color:te(this.color)};return new iL(e)}clonePositional(){const e={position:te(this.position),normal:te(this.normal),tangent:te(this.tangent),uv:this.uv,color:this.color};return new iL(e)}};function Vz(e,t,i,r){const{loggerTag:s,stride:n}=t;return e.length%n!=0?(r.error(s,`Invalid array length, expected a multiple of ${n}`),new i([])):e}function cT(e,t,i,r,s){if(!e)return e;if(e instanceof t)return Vz(e,r,t,s);for(const n of i)if(e instanceof n)return Vz(new t(e),r,t,s);if(Array.isArray(e))return Vz(new t(e),r,t,s);{const n=i.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${e.constructor.name}`),new t([])}}function sC(e,t,i){t[i]=Iit(e)}function Iit(e){const t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e[i];return t}u([d({json:{write:sC}})],Au.prototype,"color",void 0),u([Ot("color")],Au.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:sC}})],Au.prototype,"position",void 0),u([Ot("position")],Au.prototype,"castPosition",null),u([d({json:{write:sC}})],Au.prototype,"uv",void 0),u([Ot("uv")],Au.prototype,"castUv",null),u([d({json:{write:sC}})],Au.prototype,"normal",void 0),u([Ot("normal")],Au.prototype,"castNormal",null),u([d({json:{write:sC}})],Au.prototype,"tangent",void 0),u([Ot("tangent")],Au.prototype,"castTangent",null),Au=iL=u([P("esri.geometry.support.MeshVertexAttributes")],Au);var IA;const $it=me.getLogger("esri.geometry.support.MeshComponent");let Mm=IA=class extends fe{constructor(e){super(e),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}static from(e){return SS(IA,e)}castFaces(e){return cT(e,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},$it)}castMaterial(e){return SS(e&&typeof e=="object"&&("metallic"in e||"roughness"in e||"metallicRoughnessTexture"in e)?fwe:tZ,e)}clone(){return new IA({faces:te(this.faces),shading:this.shading,material:te(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(e,t){const i={faces:te(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(e,t):null,trustSourceNormals:this.trustSourceNormals};return new IA(i)}};u([d({json:{write:!0}})],Mm.prototype,"faces",void 0),u([Ot("faces")],Mm.prototype,"castFaces",null),u([d({type:tZ,json:{write:!0}})],Mm.prototype,"material",void 0),u([Ot("material")],Mm.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],Mm.prototype,"shading",void 0),u([d({type:Boolean})],Mm.prototype,"trustSourceNormals",void 0),Mm=IA=u([P("esri.geometry.support.MeshComponent")],Mm);const Dit=Mm,nU=me.getLogger("esri.geometry.support.meshUtils.normalProjection");function Lit(e,t,i,r,s){return aU(r)?(oU(ug.TO_PCPF,Vi.fromTypedArray(e),vs.fromTypedArray(t),vs.fromTypedArray(i),r,Vi.fromTypedArray(s)),s):(nU.error("Cannot convert spatial reference to PCPF"),s)}function v1t(e,t,i,r,s){return aU(r)?(oU(ug.FROM_PCPF,Vi.fromTypedArray(e),vs.fromTypedArray(t),vs.fromTypedArray(i),r,Vi.fromTypedArray(s)),s):(nU.error("Cannot convert to spatial reference from PCPF"),s)}function _1t(e,t,i){return ar(e,t,0,i,Ef(t),0,e.length/3),i}function b1t(e,t,i){return ar(e,Ef(i),0,t,i,0,e.length/3),t}function Nit(e,t,i){if(R(e))return t;const r=vs.fromTypedArray(e),s=vs.fromTypedArray(t);return t3(s,r,i),t}function Fit(e,t,i){if(R(e))return t;u2(wn,i);const r=Vi.fromTypedArray(e),s=Vi.fromTypedArray(t);return Mv(s,r,wn),qX(wn)||HY(s,s),t}function Uit(e,t,i){if(R(e))return t;u2(wn,i);const r=Vi.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),s=Vi.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT);if(Mv(s,r,wn),qX(wn)||HY(s,s),e!==t)for(let n=3;n<e.length;n+=4)t[n]=e[n];return t}function kit(e,t,i,r,s){if(!aU(r))return nU.error("Cannot convert spatial reference to PCPF"),s;oU(ug.TO_PCPF,Vi.fromTypedArray(e,4*Float32Array.BYTES_PER_ELEMENT),vs.fromTypedArray(t),vs.fromTypedArray(i),r,Vi.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function w1t(e,t,i,r,s){if(!aU(r))return nU.error("Cannot convert to spatial reference from PCPF"),s;oU(ug.FROM_PCPF,Vi.fromTypedArray(e,16),vs.fromTypedArray(t),vs.fromTypedArray(i),r,Vi.fromTypedArray(s,16));for(let n=3;n<e.length;n+=4)s[n]=e[n];return s}function oU(e,t,i,r,s,n){if(!t)return;const o=i.count,a=Ef(s);if(mwe(s))for(let l=0;l<o;l++)r.getVec(l,xI),t.getVec(l,pp),fu(a,xI,TI,a),Ch(wn,TI),e===ug.FROM_PCPF&&Ah(wn,wn),ql(pp,pp,wn),n.setVec(l,pp);else for(let l=0;l<o;l++){r.getVec(l,xI),t.getVec(l,pp),fu(a,xI,TI,a),Ch(wn,TI);const c=KL(i.get(l,1));let h=Math.cos(c);e===ug.TO_PCPF&&(h=1/h),wn[0]*=h,wn[1]*=h,wn[2]*=h,wn[3]*=h,wn[4]*=h,wn[5]*=h,e===ug.FROM_PCPF&&Ah(wn,wn),ql(pp,pp,wn),we(pp,pp),n.setVec(l,pp)}return n}function aU(e){return mwe(e)||zit(e)}function mwe(e){return e.isWGS84||Zce(e)||If(e)||$f(e)}function zit(e){return e.isWebMercator}var ug;(function(e){e[e.TO_PCPF=0]="TO_PCPF",e[e.FROM_PCPF=1]="FROM_PCPF"})(ug||(ug={}));const xI=O(),pp=O(),TI=Ae(),wn=Sr();function Vit(e){const t=new Bi;t.include(To),t.include(Tw,e),t.include(fbe,e),ou(t,e);const{vertex:i,fragment:r}=t;return e.stippleEnabled&&(t.attributes.add(A.UV0,"vec2"),t.attributes.add(A.AUXPOS1,"vec3"),i.uniforms.add(new ei("viewport",(s,n)=>n.camera.fullViewport))),t.attributes.add(A.POSITION,"vec3"),t.varyings.add("vpos","vec3"),i.code.add(x`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),e.stippleEnabled&&(i.code.add(x`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),e.draped?i.uniforms.add(new We("worldToScreenRatio",(s,n)=>1/n.screenToPCSRatio)):i.code.add(x`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),i.code.add(x`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),e.draped?i.code.add(x`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):i.code.add(x`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),i.code.add(x`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),i.code.add(x`}`),e.output===J.Highlight&&t.include(Bg),t.include(ls,e),r.uniforms.add(new We("alphaCoverage",(s,n)=>Math.min(1,s.width*n.camera.pixelRatio))),e.hasVertexColors||r.uniforms.add(new ei("constantColor",s=>s.color)),r.code.add(x`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${e.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    if (finalColor.a < ${x.float(Eo)}) {
      discard;
    }

    ${e.output===J.Color?x`gl_FragColor = highlightSlice(finalColor, vpos);`:""}
    ${e.output===J.Highlight?x`outputHighlight();`:""}
  }
  `),t}const Bit=Object.freeze(Object.defineProperty({__proto__:null,build:Vit},Symbol.toStringTag,{value:"Module"}));class lU extends lr{constructor(t,i,r){super(t,i,r),this.stipplePattern=null,this.stippleTextureBind=null,this.stippleTextureRepository=t.stippleTextureRepository}get stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==J.Highlight}initializeProgram(t){const i=lU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}destroy(){super.destroy(),this.stippleTextureRepository.release(this.stipplePattern),this.stipplePattern=null,this.stippleTextureBind=null}bindPass(t,i){if(this.program.bindPass(t,i),this.stipplePattern!==t.stipplePattern){const r=t.stipplePattern;this.stippleTextureBind=this.stippleTextureRepository.swap(this.stipplePattern,r),this.stipplePattern=r}if(this.stippleEnabled){const{pixelSize:r,sdfNormalizer:s,pixels:n}=_(this.stippleTextureBind)?this.stippleTextureBind(this.program):{pixelSize:1,sdfNormalizer:1,pixels:1};this.program.setUniform1f("stipplePatternSDFNormalizer",s),this.program.setUniform1f("stipplePatternTextureSize",n),this.program.setUniform1f("stipplePatternPixelSize",r),this.program.setUniform1f("stipplePatternPixelSizeInv",1/r)}}initializePipeline(){const t=this.configuration,i=so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),r=(s,n=null,o=null)=>Ut({blending:n,depthTest:WY,depthWrite:o,colorWrite:Jt,stencilWrite:t.hasOccludees?Pf:null,stencilTest:t.hasOccludees?s?Ov:Gv:null});return t.output===J.Color?(this._occludeePipelineState=r(!0,t.transparent||this.stippleEnabled?i:null,pl),r(!1,t.transparent||this.stippleEnabled?i:null,pl)):r(!1)}get primitiveType(){return Pt.LINES}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}lU.shader=new Qi(Bit,()=>import("./NativeLine.glsl.a821c06c.js"));class Rc extends Ho{constructor(){super(...arguments),this.output=J.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}}u([G({count:J.COUNT})],Rc.prototype,"output",void 0),u([G()],Rc.prototype,"hasSlicePlane",void 0),u([G()],Rc.prototype,"hasVertexColors",void 0),u([G()],Rc.prototype,"transparent",void 0),u([G()],Rc.prototype,"draped",void 0),u([G()],Rc.prototype,"stippleEnabled",void 0),u([G()],Rc.prototype,"stippleOffColorEnabled",void 0),u([G()],Rc.prototype,"stipplePreferContinuous",void 0),u([G()],Rc.prototype,"hasOccludees",void 0),u([G({constValue:!1})],Rc.prototype,"stippleRequiresClamp",void 0),u([G({constValue:!1})],Rc.prototype,"stippleScaleWithLineWidth",void 0),u([G({constValue:!1})],Rc.prototype,"stippleRequiresStretchMeasure",void 0);const Git=me.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial");var MF;(function(e){e[e.START=0]="START",e[e.END=1]="END"})(MF||(MF={}));class one extends Gf{constructor(t){super(t,new qit),this._techniqueConfig=new Rc}getConfiguration(t,i){this._techniqueConfig.output=t,this._techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this._techniqueConfig.hasVertexColors=this.parameters.hasVertexColors,this._techniqueConfig.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._techniqueConfig.draped=i.slot===Se.DRAPED_MATERIAL;const r=_(this.parameters.stipplePattern);return this._techniqueConfig.stippleEnabled=r,this._techniqueConfig.stippleOffColorEnabled=r&&_(this.parameters.stippleOffColor),this._techniqueConfig.hasOccludees=this.parameters.hasOccludees,this._techniqueConfig.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._techniqueConfig}intersect(t,i,r,s,n,o,a,l,c){_(c)?nZe(t,s,c,o,1,a):this._intersectLineGeometry(t,i,r,s,a)}_intersectLineGeometry(t,i,r,s,n){if(!s.options.selectionMode||HO(i))return;if(!Ave(r))return void Git.error("intersection assumes a translation-only matrix");const o=t.vertexAttributes.get(A.POSITION).data,a=s.camera,l=Xit;ro(l,s.point);const c=2;ie(nC[0],l[0]-c,l[1]+c,0),ie(nC[1],l[0]+c,l[1]+c,0),ie(nC[2],l[0]+c,l[1]-c,0),ie(nC[3],l[0]-c,l[1]-c,0);for(let y=0;y<4;y++)if(!a.unprojectFromRenderScreen(nC[y],tm[y]))return;Bo(a.eye,tm[0],tm[1],Bz),Bo(a.eye,tm[1],tm[2],Gz),Bo(a.eye,tm[2],tm[3],jz),Bo(a.eye,tm[3],tm[0],Hz);let h=Number.MAX_VALUE,p=0;for(let y=0;y<o.length-5;y+=3){if(ua[0]=o[y]+r[12],ua[1]=o[y+1]+r[13],ua[2]=o[y+2]+r[14],ha[0]=o[y+3]+r[12],ha[1]=o[y+4]+r[13],ha[2]=o[y+5]+r[14],ir(Bz,ua)<0&&ir(Bz,ha)<0||ir(Gz,ua)<0&&ir(Gz,ha)<0||ir(jz,ua)<0&&ir(jz,ha)<0||ir(Hz,ua)<0&&ir(Hz,ha)<0)continue;if(a.projectToRenderScreen(ua,g_),a.projectToRenderScreen(ha,y_),g_[2]<0&&y_[2]>0){pe(fp,ua,ha);const w=a.frustum,b=-ir(w[tr.NEAR],ua)/xe(fp,w[tr.NEAR]);oe(fp,fp,b),de(ua,ua,fp),a.projectToRenderScreen(ua,g_)}else if(g_[2]>0&&y_[2]<0){pe(fp,ha,ua);const w=a.frustum,b=-ir(w[tr.NEAR],ha)/xe(fp,w[tr.NEAR]);oe(fp,fp,b),de(ha,ha,fp),a.projectToRenderScreen(ha,y_)}else if(g_[2]<0&&y_[2]<0)continue;g_[2]=0,y_[2]=0;const v=Wq(mb(g_,y_,cne),l);v<h&&(h=v,se(ane,ua),se(lne,ha),p=y/3)}const f=s.rayBegin,m=s.rayEnd;if(h<c*c){let y=Number.MAX_VALUE;if(cpe(mb(ane,lne,cne),mb(f,m,Wit),m_)){pe(m_,m_,f);const v=Me(m_);oe(m_,m_,1/v),y=v/nr(f,m)}n(y,m_,p,!1)}}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return!1;const s=r.get(A.POSITION);return KX(s,null,!1,i)}requiresSlot(t){return t===Se.OPAQUE_MATERIAL||t===Se.DRAPED_MATERIAL}createGLMaterial(t){return t.output===J.Color||t.output===J.Highlight?new jit(t):null}createBufferWriter(){const t=this.parameters.hasVertexColors?Pbe:eet;return R(this.parameters.stipplePattern)?new J5(t):new Hit(t.clone().vec3f(A.AUXPOS1).vec2f(A.UV0))}}class jit extends kv{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output===J.Color&&this._updateOccludeeState(t),this.ensureTechnique(lU,t)}}class Hit{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(A.POSITION).length}write(t,i,r,s){I5(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s),this._writeAuxpos1(t,i,r,s),this._writeUV0(t,i,r,s)}_writeAuxpos1(t,i,r,s){const n=r.getField(A.AUXPOS1,Vi),o=i.indices.get(A.POSITION),a=i.vertexAttributes.get(A.POSITION).data,l=t.transformation,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const m=3*o[p+f],y=a[m],v=a[m+1],w=a[m+2],b=l[0]*y+l[4]*v+l[8]*w+l[12],S=l[1]*y+l[5]*v+l[9]*w+l[13],T=l[2]*y+l[6]*v+l[10]*w+l[14];h[s]=b,h[s+1]=S,h[s+2]=T,s+=c}}_writeUV0(t,i,r,s){var E;const n=r.getField(A.UV0,Rh),o=i.indices.get(A.POSITION),a=i.vertexAttributes.get(A.POSITION).data,l=(E=i.vertexAttributes.get(A.DISTANCETOSTART))==null?void 0:E.data,c=t.transformation,h=n.typedBufferStride,p=n.typedBuffer;let f=0;p[s*=h]=MF.START,p[s+1]=f,s+=h;const m=3*o[0],y=ie(ua,a[m],a[m+1],a[m+2]);c&&Ue(y,y,c);const v=ha,w=o.length-1;let b=1;const S=l?(C,M,I)=>f=l[I]:(C,M,I)=>f+=nr(C,M);for(let C=1;C<w;C+=2){const M=3*o[C];ie(v,a[M],a[M+1],a[M+2]),c&&Ue(v,v,c),S(y,v,b++);for(let I=0;I<2;++I)p[s]=1-I,p[s+1]=f,s+=h;se(y,v)}const T=3*o[w];ie(v,a[T],a[T+1],a[T+2]),c&&Ue(v,v,c),S(y,v,b),p[s]=MF.END,p[s+1]=f}}class qit extends uE{constructor(){super(...arguments),this.color=ph,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}}const ua=O(),ha=O(),fp=O(),m_=O(),g_=wo(),y_=wo(),ane=O(),lne=O(),cne=Ff(),Wit=Ff(),Xit=O(),nC=[wo(),wo(),wo(),wo()],tm=[O(),O(),O(),O()],Bz=gi(),Gz=gi(),jz=gi(),Hz=gi(),Yit=["mesh"];class Zit extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._materials=new Map,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){zi.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new one({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new one({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(Array.from(this._materials.values(),t=>t.material)),this._context.stage.removeMany(Array.from(this._textures.values())),this._materials.clear(),this._textures.clear()}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,Yit,"fill on mesh-3d"))return null;const r=this.setGraphicElevationContext(i,new _u),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(t,i){const r=this._getLayerOpacity();return this._materials.forEach(s=>{s.material.setParameters({layerOpacity:r});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),t.forEach(s=>{const n=i(s);_(n)&&n.layerOpacityChanged(r,this._context.isAsync)}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,Rv)}slicePlaneEnabledChanged(t,i){return this._materials.forEach(r=>{r.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),t.forEach(r=>{const s=i(r);_(s)&&s.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const t=this._usePBR();return this._materials.forEach(i=>i.material.setParameters({usePBR:t})),!0}pixelRatioChanged(){return!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(t){return R(t)?"-":t instanceof qe?t.toHex():t.contentHash}_materialPropertiesDefault(t,i){const r=this._requiresSymbolVertexColors(),s=!!t.vertexAttributes.color,n=!!t.vertexAttributes.tangent;return{hasSymbolVertexColors:r,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${i},svc:${r}`}}_materialProperties(t,i,r){const s=this._materialPropertiesDefault(t,r);if(!i.material)return s;const{color:n,colorTexture:o,normalTexture:a,doubleSided:l,alphaCutoff:c,alphaMode:h}=i.material,p=this._colorOrTextureUid(n),f=this._colorOrTextureUid(o),m=this._colorOrTextureUid(a);if(s.color=n,s.colorTexture=o,s.normalTexture=a,s.uid=`${s.uid},cmuid:${p},ctmuid:${f},ntmuid:${m},ds:${l},ac:${c},am:${h}`,i.material instanceof fwe){const{metallic:y,roughness:v,metallicRoughnessTexture:w,emissiveColor:b,emissiveTexture:S,occlusionTexture:T}=i.material,E=this._colorOrTextureUid(w),C=this._colorOrTextureUid(b),M=this._colorOrTextureUid(S),I=this._colorOrTextureUid(T);s.metallic=y,s.roughness=v,s.metallicRoughnessTexture=w,s.emissiveColor=b,s.emissiveTexture=S,s.occlusionTexture=T,s.uid=`${s.uid},mrm:${y},mrr:${v},mrt:${E},emuid:${C},etmuid:${M},otmuid:${I}`}return s}_setInternalColorValueParameters(t,i){i.diffuse=qe.toUnitRGB(t),i.opacity=t.a}_getLoadableTextureResource(t){return t.data?t.data:t.url}_getInternalTextureId(t){const i=this._getInternalTexture(t,sr.Opaque);return _(i)?i.id:null}_getInternalTexture(t,i){const r=this._getLoadableTextureResource(t);if(!r)return null;const s=`${t.contentHash}/${i}`;let n=this._textures.get(s);return n||(n=new Cs(r,{mipmap:!0,wrap:this._castTextureWrap(t.wrap),noUnpackFlip:!0,preMultiplyAlpha:i!==sr.Opaque}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(t="repeat"){if(typeof t=="string"){const i=this._castTextureWrapIndividual(t);return{s:i,t:i}}return{s:this._castTextureWrapIndividual(t.horizontal),t:this._castTextureWrapIndividual(t.vertical)}}_castTextureWrapIndividual(t){switch(t){case"clamp":return _t.CLAMP_TO_EDGE;case"mirror":return _t.MIRRORED_REPEAT;default:return _t.REPEAT}}_setInternalMaterialParameters(t,i){if(_(t.color)&&this._setInternalColorValueParameters(t.color,i),_(t.colorTexture)){const r=this._getInternalTexture(t.colorTexture,i.textureAlphaMode);_(r)?(i.textureId=r.id,i.textureAlphaPremultiplied=!!r.params.preMultiplyAlpha):i.textureId=void 0}_(t.normalTexture)&&(i.normalTextureId=this._getInternalTextureId(t.normalTexture)),_(t.emissiveColor)&&(i.emissiveFactor=qe.toUnitRGB(t.emissiveColor)),_(t.emissiveTexture)&&(i.emissiveTextureId=this._getInternalTextureId(t.emissiveTexture)),_(t.occlusionTexture)&&(i.occlusionTextureId=this._getInternalTextureId(t.occlusionTexture)),_(t.metallicRoughnessTexture)&&(i.metallicRoughnessTextureId=this._getInternalTextureId(t.metallicRoughnessTexture))}_setExternalMaterialParameters(t){const i=this._drivenProperties.color;let r=_(this.symbolLayer.material)?this.symbolLayer.material.colorMixMode:null;if(i)t.externalColor=ph;else{const s=_(this.symbolLayer.material)?this.symbolLayer.material.color:null;_(s)?t.externalColor=qe.toUnitRGBA(s):(r=null,t.externalColor=ph)}r&&(t.colorMixMode=r),t.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(t){const i=t.vertexAttributes.color;if(R(i))return!1;for(let r=3;r<i.length;r+=4)if(i[r]!==255)return!0;return!1}_getOrCreateMaterial(t,i){var y,v,w;const r=(y=i.material)==null?void 0:y.color,s=(v=i.material)==null?void 0:v.colorTexture,n=(w=i.material)==null?void 0:w.alphaMode,o=n==="blend",a=n!=="opaque"&&(this._hasTransparentVertexColors(t)||_(r)&&r.a<1||_(s)&&s.transparent||o),l=this._materialProperties(t,i,a),c=this._materials.get(l.uid);if(c)return c.material;const h={material:null,isComponentTransparent:a,alphaMode:i.material?i.material.alphaMode:"opaque"},p=l.metallicRoughnessTexture==null&&l.metallic==null&&l.roughness==null,f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:Ta,diffuse:of,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:or.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};p||(f.mrrFactors=[l.metallic!=null?l.metallic:1,l.roughness!=null?l.roughness:1,.5]),i.material&&(f.doubleSided=i.material.doubleSided,f.cullFace=i.material.doubleSided?or.None:or.Back,f.textureAlphaCutoff=i.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,h),this._setInternalMaterialParameters(l,f);const m=new rw(f);return h.material=m,this._materials.set(l.uid,h),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(t,i){t.transparent=this.needsDrivenTransparentPass||i.isComponentTransparent||t.layerOpacity<1||t.opacity<1||t.externalColor&&t.externalColor[3]<1,i.alphaMode==="auto"?t.textureAlphaMode=t.transparent?sr.MaskBlend:sr.Opaque:t.textureAlphaMode=i.alphaMode==="opaque"?sr.Opaque:i.alphaMode==="mask"?sr.Mask:sr.Blend}_addDebugNormals(t,i,r,s){const n=i.length,o=t.spatialReference.isGeographic?20015077/180:1,a=.1*Math.max(t.extent.width*o,t.extent.height*o,t.extent.zmax-t.extent.zmin),l=[],c=[],h=[],p=[];for(let y=0;y<n;y++){const v=i[y],w=v.vertexAttributes.get(A.POSITION),b=v.vertexAttributes.get(A.NORMAL),S=v.indices.get(A.POSITION),T=v.indices.get(A.NORMAL),E=w.data,C=b.data;for(let M=0;M<S.length;M++){const I=3*S[M],N=3*T[M];for(let D=0;D<3;D++)l.push(E[I+D]);for(let D=0;D<3;D++)l.push(E[I+D]+C[N+D]*a);if(c.push(c.length),c.push(c.length),M%3==0){this._calculateFaceNormal(E,S,M,sx),this._getFaceVertices(E,S,M,co,ix,rx),de(co,co,ix),de(co,co,rx),oe(co,co,1/3);for(let D=0;D<3;D++)h.push(co[D]);for(let D=0;D<3;D++)h.push(co[D]+sx[D]*a);p.push(p.length),p.push(p.length)}}}const f=new Or([[A.POSITION,{data:l,size:3,exclusive:!0}]],[[A.POSITION,new Uint32Array(c)]],ll.Line);i.push(f),r.push(this._debugVertexNormalMaterial),s.push(fb(s[0]));const m=new Or([[A.POSITION,{data:h,size:3,exclusive:!0}]],[[A.POSITION,new Uint32Array(p)]],ll.Line);i.push(m),r.push(this._debugFaceNormalMaterial),s.push(fb(s[0]))}_createAs3DShape(t,i,r,s){const n=t.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,i);if(!o)return null;const{geometries:a,materials:l,transformations:c,objectTransformation:h}=o;zi.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a,l,c);const p=new Hg({geometries:a,materials:l,transformations:c,metadata:{layerUid:this._context.layer.uid,graphicUid:s}});p.transformation=h;const f=this._createEdgeMaterial(),m=_(f)?{baseMaterial:l[0],edgeMaterials:[f],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,y=new jf(this,p,a,null,null,jM,r,m);return y.needsElevationUpdates=Rv(r.mode),y.useObjectOriginAsAttachmentOrigin=!0,y.elevationContext.centerPointInElevationSR=this._getCenterPointInElevationSR(p),y.alignedSampledElevation=jM(y,y.elevationContext,this._context.elevationProvider,this._context.renderCoordsHelper),y}_getCenterPointInElevationSR(t){const i=jg(0,0,0,this._context.elevationProvider.spatialReference);return $de([t.transformation[12],t.transformation[13],t.transformation[14]],this._context.renderCoordsHelper.spatialReference,i),i}_createComponentNormals(t,i,r,s){switch(r.shading||"flat"){case"source":return this._createComponentNormalsSource(t,i,r,s);case"flat":return this._createComponentNormalsFlat(t,s);case"smooth":return this._createComponentNormalsSmooth(t,s);default:return}}_createComponentNormalsSource(t,i,r,s){if(R(i))return this._createComponentNormalsFlat(t,s);let n=!1;if(!r.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(t,s,o,sx);for(let a=0;a<3;a++){const l=3*s[o+a];co[0]=i[l+0],co[1]=i[l+1],co[2]=i[l+2],xe(sx,co)<0&&(i[l+0]=-i[l+0],i[l+1]=-i[l+1],i[l+2]=-i[l+2],n=!0)}}return{normals:i,indices:s,didFlipNormals:n}}_createComponentNormalsFlat(t,i){const r=new Float32Array(i.length),s=new Uint32Array(3*i.length);for(let n=0;n<i.length;n+=3){const o=this._calculateFaceNormal(t,i,n,sx);for(let a=0;a<3;a++)r[n+a]=o[a],s[n+a]=n/3}return{normals:r,indices:s,didFlipNormals:!1}}_createComponentNormalsSmooth(t,i){const r={};for(let o=0;o<i.length;o+=3){const a=this._calculateFaceNormal(t,i,o,sx);for(let l=0;l<3;l++){const c=i[o+l];let h=r[c];h||(h={normal:O(),count:0},r[c]=h),de(h.normal,h.normal,a),h.count++}}const s=new Float32Array(3*i.length),n=new Uint32Array(3*i.length);for(let o=0;o<i.length;o++){const a=r[i[o]];a.count!==1&&(we(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return{normals:s,indices:n,didFlipNormals:!1}}_getFaceVertices(t,i,r,s,n,o){const a=3*i[r+0],l=3*i[r+1],c=3*i[r+2];s[0]=t[a+0],s[1]=t[a+1],s[2]=t[a+2],n[0]=t[l+0],n[1]=t[l+1],n[2]=t[l+2],o[0]=t[c+0],o[1]=t[c+1],o[2]=t[c+2]}_calculateFaceNormal(t,i,r,s){return this._getFaceVertices(t,i,r,co,ix,rx),pe(ix,ix,co),pe(rx,rx,co),lt(co,ix,rx),we(s,co),s}_getOrCreateComponents(t){return yt(t.components,Qit)}_createPositionBuffer(t,i){let r=t.vertexAttributes.position;const s=i.reprojection===Ic.ECEF?i.transformBeforeProject:null;if(_(s)&&(r=Nit(r,new Float64Array(r.length),s)),i.reprojection===Ic.NONE)return i.needsBufferCopy?new Float64Array(r):r;const n=_(s)?r:new Float64Array(r.length);return ar(r,t.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,r.length/3),n}_createNormalBuffer(t,i,r){let s=t.vertexAttributes.normal;if(R(s))return null;const n=r.reprojection===Ic.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=Fit(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Ic.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return Lit(s,o,i,t.spatialReference,a)}_createTangentBuffer(t,i,r){let s=t.vertexAttributes.tangent;if(R(s))return null;const n=r.reprojection===Ic.ECEF?r.transformBeforeProject:null;if(_(n)&&(s=Uit(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||r.reprojection===Ic.NONE)return r.needsBufferCopy&&t.vertexAttributes.normal===s?new Float32Array(s):s;const o=t.vertexAttributes.position,a=_(n)?s:new Float32Array(s.length);return kit(s,o,i,t.spatialReference,a)}_createColorBuffer(t){return t.vertexAttributes.color}_createSymbolColorBuffer(t){if(this._requiresSymbolVertexColors()){const i=this._getVertexOpacityAndColor(t),r=Hbe(Yr(this.symbolLayer,"material","colorMixMode")),s=new Uint8Array(4);return qbe(i,r,s),s}return null}_createBuffers(t,i){const r=t.vertexAttributes&&t.vertexAttributes.position;if(!r)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=t.vertexAttributes.normal,n=t.vertexAttributes.uv,o=t.vertexAttributes.tangent;if(_(s)&&s.length!==r.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(_(o)&&o.length/4!=r.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(_(n)&&n.length/2!=r.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(t),l=this._createPositionBuffer(t,a),c=this._createColorBuffer(t),h=this._createSymbolColorBuffer(i),p=this._createNormalBuffer(t,l,a),f=this._createTangentBuffer(t,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===Ic.NONE&&_(a.objectTransformation)?a.objectTransformation:this._transformOriginLocal(t,l,p,f),geometryTransformation:a.reprojection===Ic.NONE&&_(a.geometryTransformation)?a.geometryTransformation:Ae()}}_computeReprojectionInfo(t){const i=_(t.transform),r=i&&t.transform.geographic||this._context.renderCoordsHelper.viewingMode===Ve.Local?Ic.NONE:Ic.ECEF;if(i){if(r===Ic.NONE){const n=Ae();return fu(t.spatialReference,t.transform.origin,n,this._context.renderCoordsHelper.spatialReference),{reprojection:r,objectTransformation:n,geometryTransformation:fb(t.transform.localMatrix),needsBufferCopy:!1}}const s=E4(Ae(),t.transform.origin);return Nr(s,s,t.transform.localMatrix),{reprojection:r,transformBeforeProject:s,needsBufferCopy:!0}}return{reprojection:r,needsBufferCopy:!0}}_transformOriginLocal(t,i,r,s){const n=this._context.renderCoordsHelper.spatialReference,o=t.anchor;SI[0]=o.x,SI[1]=o.y,SI[2]=o.z;const a=Ae();fu(t.spatialReference,SI,a,n);const l=vs.fromTypedArray(i);if(cs(une,a),t3(l,l,une),_(r)||_(s)){if(Ch(oC,a),Ah(oC,oC),_(r)){const c=Vi.fromTypedArray(r);Mv(c,c,oC)}if(_(s)){const c=Vi.fromTypedArray(s,4*s.BYTES_PER_ELEMENT);Mv(c,c,oC)}}return a}_validateFaces(t,i){const r=t.vertexAttributes.position.length/3,s=i.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(r<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(r%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(t,i){return i.faces?i.faces:v2(t.vertexAttributes.position.length/3)}_isOutsideClippingArea(t){if(!this._context.clippingExtent)return!1;const i=t.vertexAttributes&&t.vertexAttributes.position;if(!i)return!1;const r=this._context.elevationProvider.spatialReference;let s;const n=i.length/3;return t.spatialReference.equals(r)?s=i:(s=new Float64Array(i.length),ar(t.vertexAttributes.position,t.spatialReference,0,s,r,0,n)),cr(qz),Kc(qz,s,0,n),!$d(qz,this._context.clippingExtent)}_createGeometryInfo(t,i){if(!bg(t.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(t))return null;const r=this._createBuffers(t,i);if(R(r))return null;const{positionBuffer:s,uvBuffer:n,colorBuffer:o,symbolColorBuffer:a,normalBuffer:l,tangentBuffer:c,objectTransformation:h,geometryTransformation:p}=r,f=this._getOrCreateComponents(t),m=[],y=[],v=[];let w=!1;for(const b of f){if(!this._validateFaces(t,b))return null;const S=this._getOrCreateFaces(t,b);if(S.length===0)continue;const T=this._createComponentNormals(s,l,b,S);T.didFlipNormals&&(w=!0);const E=[[A.POSITION,{size:3,data:s,exclusive:!0}],[A.NORMAL,{size:3,data:T.normals,exclusive:!0}]],C=[[A.POSITION,S],[A.NORMAL,T.indices]];_(o)&&(E.push([A.COLOR,{size:4,data:o,exclusive:!0}]),C.push([A.COLOR,S])),_(a)&&(E.push([A.SYMBOLCOLOR,{size:4,data:a,exclusive:!0}]),C.push([A.SYMBOLCOLOR,new Uint16Array(S.length)])),_(n)&&(E.push([A.UV0,{size:2,data:n,exclusive:!0}]),C.push([A.UV0,S])),_(c)&&(E.push([A.TANGENT,{size:4,data:c,exclusive:!0}]),C.push([A.TANGENT,S]));const M=new Or(E,C);m.push(M),y.push(p),v.push(this._getOrCreateMaterial(t,b))}return w&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:m,transformations:y,materials:v,objectTransformation:h}}_createEdgeMaterial(){const t={opacity:this._getLayerOpacity()};return J1e(this.symbolLayer,t)}}const SI=O(),co=O(),ix=O(),rx=O(),sx=O(),une=Ae(),oC=Sr(),qz=Ls(),Qit=[new Dit];var Ic;(function(e){e[e.NONE=0]="NONE",e[e.ECEF=1]="ECEF"})(Ic||(Ic={}));class Jit{constructor(t,i,r,s){this.graphics3DSymbolLayer=t,this.instanceIndex=i,this.elevationAligner=r,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(t){const i=this.lodRenderer.instanceData;t!==i.getVisible(this.instanceIndex)&&i.setVisible(this.instanceIndex,t)}destroy(){this.instanceIndex!=null&&(this.lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(t,i,r){if(this.elevationAligner){kY(this.elevationContext.featureExpressionInfoContext,r);const s=this.elevationAligner(this,this.elevationContext,t,i);_(s)&&(this.alignedSampledElevation=s)}}getCenterObjectSpace(t=O()){return this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,mp),Ue(t,this.lodRenderer.baseBoundingSphere.center,mp)}getBoundingBoxObjectSpace(t=Ls()){this.lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,mp);const i=this.lodRenderer.baseBoundingBox;cr(t);for(let r=0;r<8;++r)ie(Ru,(1&r)==0?i[0]:i[3],(2&r)==0?i[1]:i[4],(4&r)==0?i[2]:i[5]),Ue(Ru,Ru,mp),xf(t,Ru);return t}computeAttachmentOrigin(t){this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,mp),t.render.origin[0]+=mp[12],t.render.origin[1]+=mp[13],t.render.origin[2]+=mp[14],t.render.num++}async getProjectedBoundingBox(t,i,r,s,n){const o=this.getBoundingBoxObjectSpace(n),a=Kit,l=p4(o)?1:a.length;this.lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,mp);for(let h=0;h<l;h++){const p=a[h];Ru[0]=o[p[0]],Ru[1]=o[p[1]],Ru[2]=o[p[2]],Ue(Ru,Ru,mp),v_[3*h+0]=Ru[0],v_[3*h+1]=Ru[1],v_[3*h+2]=Ru[2]}if(!t(v_,0,l))return null;cr(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],v_[h+p]),o[p+3]=Math.max(o[p+3],v_[h+p]);c&&r.push({location:v_.slice(h,h+3),screenSpaceBoundingRect:c})}if(i&&(Id(o,Wz),this.elevationContext.mode!=="absolute-height")){let h;const p=FY(o,i);try{h=await i.service.queryElevation(Wz[0],Wz[1],s,p,"ground")}catch{}_(h)&&nhe(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(t,i){if(t===Eg.Highlight){const r=new _F(t);this._addHighlightId(r),i.addExternal(s=>{this._removeHighlightId(s)},r)}}removeObjectState(t){this._highlights.forEach(i=>t.remove(i))}_addHighlightId(t){this._highlights.add(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(t){this._highlights.delete(t),this.lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}}const v_=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Ru=O(),Wz=O(),Kit=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],mp=Ae();function ert(e){const t=[];return e.stageResources.geometries.forEach((i,r)=>{const s=e.stageResources.materials[r],n=e.stageResources.textures;t.push({material:s,geometry:i,textures:n})}),{components:t,minScreenSpaceRadius:e.lodThreshold,pivotOffset:e.pivotOffset}}function trt(e){return{levels:e.map(t=>ert(t))}}function irt(e,t=srt){const i=PJe(e);return Math.sqrt(i/(t*Math.PI))}function rrt(e){e.levels.forEach(t=>{t.minScreenSpaceRadius||(t.minScreenSpaceRadius=irt(t))})}const srt=.05;function x1t(e){return e=e||globalThis.location.hostname,ort.some(t=>(e==null?void 0:e.match(t))!=null)}function nrt(e,t){return e&&(t=t||globalThis.location.hostname)?t.match(gwe)!=null||t.match(vwe)!=null?e.replace("static.arcgis.com","staticdev.arcgis.com"):t.match(ywe)!=null||t.match(_we)!=null?e.replace("static.arcgis.com","staticqa.arcgis.com"):e:e}const gwe=/^devext.arcgis.com$/,ywe=/^qaext.arcgis.com$/,vwe=/^[\w-]*\.mapsdevext.arcgis.com$/,_we=/^[\w-]*\.mapsqa.arcgis.com$/,ort=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,gwe,ywe,/^jsapps.esri.com$/,vwe,_we];function art(e,t,i){if(e.count!==t.count)return void V5.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],m=i[9],y=i[10],v=i[11],w=i[12],b=i[13],S=i[14],T=i[15],E=e.typedBuffer,C=e.typedBufferStride,M=t.typedBuffer,I=t.typedBufferStride;for(let N=0;N<r;N++){const D=N*C,z=N*I,V=M[z],k=M[z+1],Y=M[z+2],Z=M[z+3];E[D]=s*V+l*k+f*Y+w*Z,E[D+1]=n*V+c*k+m*Y+b*Z,E[D+2]=o*V+h*k+y*Y+S*Z,E[D+3]=a*V+p*k+v*Y+T*Z}}function bwe(e,t,i){if(e.count!==t.count)return void V5.error("source and destination buffers need to have the same number of elements");const r=e.count,s=i[0],n=i[1],o=i[2],a=i[3],l=i[4],c=i[5],h=i[6],p=i[7],f=i[8],m=e.typedBuffer,y=e.typedBufferStride,v=t.typedBuffer,w=t.typedBufferStride;for(let b=0;b<r;b++){const S=b*y,T=b*w,E=v[T],C=v[T+1],M=v[T+2],I=v[T+3];m[S]=s*E+a*C+h*M,m[S+1]=n*E+l*C+p*M,m[S+2]=o*E+c*C+f*M,m[S+3]=I}}function lrt(e,t){const i=Math.min(e.count,t.count),r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride;for(let a=0;a<i;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const y=1/Math.sqrt(m);r[l]=y*h,r[l+1]=y*p,r[l+2]=y*f}}}function dj(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=i*o[h],s[c+1]=i*o[h+1],s[c+2]=i*o[h+2],s[c+3]=i*o[h+3]}}function crt(e,t,i){const r=Math.min(e.count,t.count),s=e.typedBuffer,n=e.typedBufferStride,o=t.typedBuffer,a=t.typedBufferStride;for(let l=0;l<r;l++){const c=l*n,h=l*a;s[c]=o[h]>>i,s[c+1]=o[h+1]>>i,s[c+2]=o[h+2]>>i,s[c+3]=o[h+3]>>i}}Object.freeze(Object.defineProperty({__proto__:null,transformMat4:art,transformMat3:bwe,normalize:lrt,scale:dj,shiftRight:crt},Symbol.toStringTag,{value:"Module"}));function urt(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<9;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:urt},Symbol.toStringTag,{value:"Module"}));function hrt(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h){for(let p=0;p<16;++p)r[l+p]=n[c+p];l+=s,c+=o}}Object.freeze(Object.defineProperty({__proto__:null,copy:hrt},Symbol.toStringTag,{value:"Module"}));function drt(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],l+=s,c+=o}function rL(e,t){const i=e.count;t||(t=new e.TypedArrayConstructor(i));for(let r=0;r<i;r++)t[r]=e.get(r);return t}Object.freeze(Object.defineProperty({__proto__:null,copy:drt,makeDense:rL},Symbol.toStringTag,{value:"Module"}));function wwe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],l+=s,c+=o}function xwe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;if(rHe(t.elementType)){const h=sHe(t.elementType);if(iHe(t.elementType))for(let p=0;p<a;++p)r[l]=Math.max(n[c]/h,-1),r[l+1]=Math.max(n[c+1]/h,-1),l+=s,c+=o;else for(let p=0;p<a;++p)r[l]=n[c]/h,r[l+1]=n[c+1]/h,l+=s,c+=o}else wwe(e,t,i);return e}function prt(e,t,i,r){var l,c;const s=e.typedBuffer,n=e.typedBufferStride,o=(l=r==null?void 0:r.count)!=null?l:e.count;let a=((c=r==null?void 0:r.dstIndex)!=null?c:0)*n;for(let h=0;h<o;++h)s[a]=t,s[a+1]=i,a+=n}Object.freeze(Object.defineProperty({__proto__:null,copy:wwe,normalizeIntegerBuffer:xwe,fill:prt},Symbol.toStringTag,{value:"Module"}));function cU(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],l+=s,c+=o}function frt(e,t,i,r,s){var c,h;const n=e.typedBuffer,o=e.typedBufferStride,a=(c=s==null?void 0:s.count)!=null?c:e.count;let l=((h=s==null?void 0:s.dstIndex)!=null?h:0)*o;for(let p=0;p<a;++p)n[l]=t,n[l+1]=i,n[l+2]=r,l+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:cU,fill:frt},Symbol.toStringTag,{value:"Module"}));function Twe(e,t,i){const r=e.typedBuffer,s=e.typedBufferStride,n=t.typedBuffer,o=t.typedBufferStride,a=i?i.count:t.count;let l=(i&&i.dstIndex?i.dstIndex:0)*s,c=(i&&i.srcIndex?i.srcIndex:0)*o;for(let h=0;h<a;++h)r[l]=n[c],r[l+1]=n[c+1],r[l+2]=n[c+2],r[l+3]=n[c+3],l+=s,c+=o}function Swe(e,t,i,r,s,n){var h,p;const o=e.typedBuffer,a=e.typedBufferStride,l=(h=n==null?void 0:n.count)!=null?h:e.count;let c=((p=n==null?void 0:n.dstIndex)!=null?p:0)*a;for(let f=0;f<l;++f)o[c]=t,o[c+1]=i,o[c+2]=r,o[c+3]=s,c+=a}Object.freeze(Object.defineProperty({__proto__:null,copy:Twe,fill:Swe},Symbol.toStringTag,{value:"Module"}));function B1(e,t){return new e(new ArrayBuffer(t*e.ElementCount*Eve(e.ElementType)))}class Ewe{constructor(t){this.streamDataRequester=t}async loadJSON(t,i){return this._load("json",t,i)}async loadBinary(t,i){return Lf(t)?(li(i),_he(t)):this._load("binary",t,i)}async loadImage(t,i){return this._load("image",t,i)}async _load(t,i,r){if(R(this.streamDataRequester))return(await ur(i,{responseType:mrt[t]})).data;const s=await nc(this.streamDataRequester.request(i,t,r));if(s.ok===!0)return s.value;throw Pg(s.error),new q("",`Request for resource failed: ${s.error}`)}}const mrt={image:"image",binary:"array-buffer",json:"json"},grt=me.getLogger("esri.views.3d.glTF");class yrt{error(t){throw new q("gltf-loader-error",t)}errorUnsupported(t){throw new q("gltf-loader-unsupported-feature",t)}errorUnsupportedIf(t,i){t&&this.errorUnsupported(i)}assert(t,i){t||this.error(i)}warn(t){grt.warn(t)}warnUnsupported(t){this.warn("[Unsupported Feature] "+t)}warnUnsupportedIf(t,i){t&&this.warnUnsupported(i)}}function vrt(e={}){return F({color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply"},e)}function _rt(e,t={}){return{data:e,parameters:F({wrap:F({s:_t.REPEAT,t:_t.REPEAT},t.wrap),noUnpackFlip:!0,mipmap:!1},t)}}class Iv{constructor(t,i,r=""){this.major=t,this.minor=i,this._context=r}lessThan(t,i){return this.major<t||t===this.major&&this.minor<i}since(t,i){return!this.lessThan(t,i)}validate(t){if(this.major!==t.major){const i=this._context&&this._context+":",r=this._context&&this._context+" ";throw new q(i+"unsupported-version",`Required major ${r}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:t})}}clone(){return new Iv(this.major,this.minor,this._context)}static parse(t,i=""){const[r,s]=t.split("."),n=/^\s*\d+\s*$/;if(!r||!r.match||!r.match(n))throw new q((i&&i+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:t});if(!s||!s.match||!s.match(n))throw new q((i&&i+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:t});const o=parseInt(r,10),a=parseInt(s,10);return new Iv(o,a,i)}}class hne{constructor(t){this.data=t,this.offset4=0,this.dataUint32=new Uint32Array(this.data,0,Math.floor(this.data.byteLength/4))}readUint32(){const t=this.offset4;return this.offset4+=1,this.dataUint32[t]}readUint8Array(t){const i=4*this.offset4;return this.offset4+=t/4,new Uint8Array(this.data,i,t)}remainingBytes(){return this.data.byteLength-4*this.offset4}}var MR,dne;(function(e){e.SCALAR="SCALAR",e.VEC2="VEC2",e.VEC3="VEC3",e.VEC4="VEC4",e.MAT2="MAT2",e.MAT3="MAT3",e.MAT4="MAT4"})(MR||(MR={})),function(e){e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(dne||(dne={}));const Cwe={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},brt={pbrMetallicRoughness:Cwe,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},wrt={ESRI_externalColorMixMode:"tint"},pne=(e={})=>{const t=F(F({},Cwe),e.pbrMetallicRoughness),i=xrt(F(F({},wrt),e.extras));return ve(F(F({},brt),e),{pbrMetallicRoughness:t,extras:i})};function xrt(e){switch(e.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:e.ESRI_externalColorMixMode,e.ESRI_externalColorMixMode="tint"}return e}const Trt={magFilter:Ke.LINEAR,minFilter:Ke.LINEAR_MIPMAP_LINEAR,wrapS:_t.REPEAT,wrapT:_t.REPEAT},Srt=e=>F(F({},Trt),e);function Ert(e){let t,i;return e.replace(/^(.*\/)?([^/]*)$/,(r,s,n)=>(t=s||"",i=n||"","")),{dirPart:t,filePart:i}}const EI={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};class zm{constructor(t,i,r,s,n){this.context=t,this.errorContext=i,this.uri=r,this.json=s,this.glbBuffer=n,this.bufferLoaders=new Map,this.textureLoaders=new Map,this.textureCache=new Map,this.materialCache=new Map,this.nodeParentMap=new Map,this.nodeTransformCache=new Map,this.baseUri=Ert(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.errorUnsupportedIf(s.scenes==null,"Scenes must be defined."),i.errorUnsupportedIf(s.meshes==null,"Meshes must be defined"),i.errorUnsupportedIf(s.nodes==null,"Nodes must be defined."),this._computeNodeParents()}static async load(t,i,r,s){if(Lf(r)){const a=y4(r);if(a.mediaType!=="model/gltf-binary")try{const c=JSON.parse(a.isBase64?atob(a.data):a.data);return new zm(t,i,r,c)}catch{}const l=_he(r);if(zm._isGLBData(l))return this._fromGLBData(t,i,r,l)}if(r.endsWith(".gltf")){const a=await t.loadJSON(r,s);return new zm(t,i,r,a)}const n=await t.loadBinary(r,s);if(zm._isGLBData(n))return this._fromGLBData(t,i,r,n);const o=await t.loadJSON(r,s);return new zm(t,i,r,o)}static _isGLBData(t){const i=new hne(t);return i.remainingBytes()>=4&&i.readUint32()===EI.MAGIC}static async _fromGLBData(t,i,r,s){const n=await zm._parseGLBData(i,s);return new zm(t,i,r,n.json,n.binaryData)}static async _parseGLBData(t,i){const r=new hne(i);t.assert(r.remainingBytes()>=12,"GLB binary data is insufficiently large.");const s=r.readUint32(),n=r.readUint32(),o=r.readUint32();t.assert(s===EI.MAGIC,"Magic first 4 bytes do not fit to expected GLB value."),t.assert(i.byteLength>=o,"GLB binary data is smaller than header specifies."),t.errorUnsupportedIf(n!==2,"An unsupported GLB container version was detected. Only version 2 is supported.");let a,l,c=0;for(;r.remainingBytes()>=8;){const h=r.readUint32(),p=r.readUint32();c===0?(t.assert(p===EI.CHUNK_TYPE_JSON,"First GLB chunk must be JSON."),t.assert(h>=0,"No JSON data found."),a=await Prt(r.readUint8Array(h))):c===1?(t.errorUnsupportedIf(p!==EI.CHUNK_TYPE_BIN,"Second GLB chunk expected to be BIN."),l=r.readUint8Array(h)):t.warnUnsupported("More than 2 GLB chunks detected. Skipping."),c+=1}return a||t.error("No GLB JSON chunk detected."),{json:a,binaryData:l}}async getBuffer(t,i){const r=this.json.buffers[t],s=this.errorContext;if(r.uri==null)return s.assert(this.glbBuffer!=null,"GLB buffer not present"),this.glbBuffer;const n=await this._getBufferLoader(t,i);return s.assert(n.byteLength===r.byteLength,"Buffer byte lengths should match."),n}async _getBufferLoader(t,i){const r=this.bufferLoaders.get(t);if(r)return r;const s=this.json.buffers[t],n=this.context.loadBinary(this._resolveUri(s.uri),i).then(o=>new Uint8Array(o));return this.bufferLoaders.set(t,n),n}async getAccessor(t,i){const r=this.errorContext;r.errorUnsupportedIf(!this.json.accessors,"Accessors missing.");const s=this.json.accessors[t];r.errorUnsupportedIf((s==null?void 0:s.bufferView)==null,"Some accessor does not specify a bufferView."),r.errorUnsupportedIf(s.type in[MR.MAT2,MR.MAT3,MR.MAT4],`AttributeType ${s.type} is not supported`);const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,i),a=Rrt[s.type],l=Mrt[s.componentType],c=a*l,h=n.byteStride||c;return{raw:o.buffer,byteStride:h,byteOffset:o.byteOffset+(n.byteOffset||0)+(s.byteOffset||0),entryCount:s.count,isDenselyPacked:h===c,componentCount:a,componentByteSize:l,componentType:s.componentType,min:s.min,max:s.max,normalized:!!s.normalized}}async getIndexData(t,i){if(t.indices==null)return null;const r=await this.getAccessor(t.indices,i);if(r.isDenselyPacked)switch(r.componentType){case ht.UNSIGNED_BYTE:return new Uint8Array(r.raw,r.byteOffset,r.entryCount);case ht.UNSIGNED_SHORT:return new Uint16Array(r.raw,r.byteOffset,r.entryCount);case ht.UNSIGNED_INT:return new Uint32Array(r.raw,r.byteOffset,r.entryCount)}else switch(r.componentType){case ht.UNSIGNED_BYTE:return rL(this._wrapAccessor(Ag,r));case ht.UNSIGNED_SHORT:return rL(this._wrapAccessor(qb,r));case ht.UNSIGNED_INT:return rL(this._wrapAccessor(Xb,r))}}async getPositionData(t,i){const r=this.errorContext;r.errorUnsupportedIf(t.attributes.POSITION==null,"No POSITION vertex data found.");const s=await this.getAccessor(t.attributes.POSITION,i);return r.errorUnsupportedIf(s.componentType!==ht.FLOAT,"Expected type FLOAT for POSITION vertex attribute, but found "+AI[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"POSITION vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Vi,s)}async getNormalData(t,i){const r=this.errorContext;r.assert(t.attributes.NORMAL!=null,"No NORMAL vertex data found.");const s=await this.getAccessor(t.attributes.NORMAL,i);return r.errorUnsupportedIf(s.componentType!==ht.FLOAT,"Expected type FLOAT for NORMAL vertex attribute, but found "+AI[s.componentType]),r.errorUnsupportedIf(s.componentCount!==3,"NORMAL vertex attribute must have 3 components, but found "+s.componentCount.toFixed()),this._wrapAccessor(Vi,s)}async getTangentData(t,i){const r=this.errorContext;r.assert(t.attributes.TANGENT!=null,"No TANGENT vertex data found.");const s=await this.getAccessor(t.attributes.TANGENT,i);return r.errorUnsupportedIf(s.componentType!==ht.FLOAT,"Expected type FLOAT for TANGENT vertex attribute, but found "+AI[s.componentType]),r.errorUnsupportedIf(s.componentCount!==4,"TANGENT vertex attribute must have 4 components, but found "+s.componentCount.toFixed()),new On(s.raw,s.byteOffset,s.byteStride,s.byteOffset+s.byteStride*s.entryCount)}async getTextureCoordinates(t,i){const r=this.errorContext;r.assert(t.attributes.TEXCOORD_0!=null,"No TEXCOORD_0 vertex data found.");const s=await this.getAccessor(t.attributes.TEXCOORD_0,i);return r.errorUnsupportedIf(s.componentCount!==2,"TEXCOORD_0 vertex attribute must have 2 components, but found "+s.componentCount.toFixed()),s.componentType===ht.FLOAT?this._wrapAccessor(Rh,s):(r.errorUnsupportedIf(!s.normalized,"Integer component types are only supported for a normalized accessor for TEXCOORD_0."),Ort(s))}async getVertexColors(t,i){const r=this.errorContext;r.assert(t.attributes.COLOR_0!=null,"No COLOR_0 vertex data found.");const s=await this.getAccessor(t.attributes.COLOR_0,i);if(r.errorUnsupportedIf(s.componentCount!==4&&s.componentCount!==3,"COLOR_0 attribute must have 3 or 4 components, but found "+s.componentCount.toFixed()),s.componentCount===4){if(s.componentType===ht.FLOAT)return this._wrapAccessor(On,s);if(s.componentType===ht.UNSIGNED_BYTE)return this._wrapAccessor(fl,s);if(s.componentType===ht.UNSIGNED_SHORT)return this._wrapAccessor(xv,s)}else if(s.componentCount===3){if(s.componentType===ht.FLOAT)return this._wrapAccessor(Vi,s);if(s.componentType===ht.UNSIGNED_BYTE)return this._wrapAccessor(wv,s);if(s.componentType===ht.UNSIGNED_SHORT)return this._wrapAccessor(Wb,s)}r.errorUnsupported("Unsupported component type for COLOR_0 attribute: "+AI[s.componentType])}hasPositions(t){return t.attributes.POSITION!==void 0}hasNormals(t){return t.attributes.NORMAL!==void 0}hasVertexColors(t){return t.attributes.COLOR_0!==void 0}hasTextureCoordinates(t){return t.attributes.TEXCOORD_0!==void 0}hasTangents(t){return t.attributes.TANGENT!==void 0}async getMaterial(t,i,r){let s=this.materialCache.get(t.material);if(!s){const n=t.material!=null?pne(this.json.materials[t.material]):pne(),o=n.pbrMetallicRoughness,a=this.hasVertexColors(t),l=this.getTexture(o.baseColorTexture,i),c=this.getTexture(n.normalTexture,i),h=r?this.getTexture(n.occlusionTexture,i):null,p=r?this.getTexture(n.emissiveTexture,i):null,f=r?this.getTexture(o.metallicRoughnessTexture,i):null,m=t.material!=null?t.material:-1;s={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:o.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await l,normalTexture:await c,name:n.name,id:m,occlusionTexture:await h,emissiveTexture:await p,emissiveFactor:n.emissiveFactor,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,metallicRoughnessTexture:await f,hasVertexColors:a,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode}}return s}async getTexture(t,i){if(!t)return null;this.errorContext.errorUnsupportedIf((t.texCoord||0)!==0,"Only TEXCOORD with index 0 is supported.");const r=t.index,s=this.errorContext,n=this.json.textures[r],o=Srt(n.sampler!=null?this.json.samplers[n.sampler]:{});s.errorUnsupportedIf(n.source==null,"Source is expected to be defined for a texture.");const a=this.json.images[n.source],l=await this._loadTextureImageData(r,n,i);return TH(this.textureCache,r,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>(s.error(`Unexpected TextureSampler WrapMode: ${p}. Using default REPEAT(10497).`),10497);return{data:l,wrapS:c(o.wrapS)?o.wrapS:h(o.wrapS),wrapT:c(o.wrapT)?o.wrapT:h(o.wrapT),minFilter:o.minFilter,name:a.name,id:r}})}getNodeTransform(t){if(t===void 0)return Art;let i=this.nodeTransformCache.get(t);if(!i){const r=this.getNodeTransform(this._getNodeParent(t)),s=this.json.nodes[t];s.matrix?i=Nr(Ae(),r,s.matrix):s.translation||s.rotation||s.scale?(i=fb(r),s.translation&&Aa(i,i,s.translation),s.rotation&&(CI[3]=Q0e(CI,s.rotation),Wl(i,i,CI[3],CI)),s.scale&&T4(i,i,s.scale)):i=r,this.nodeTransformCache.set(t,i)}return i}_wrapAccessor(t,i){return new t(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*(i.entryCount-1)+i.componentByteSize*i.componentCount)}_resolveUri(t){return gh(t,this.baseUri)}_getNodeParent(t){return this.nodeParentMap.get(t)}_checkVersionSupported(){const t=Iv.parse(this.json.asset.version,"glTF");Crt.validate(t)}_checkRequiredExtensionsSupported(){const t=this.json,i=this.errorContext;t.extensionsRequired&&t.extensionsRequired.length!==0&&i.errorUnsupported("gltf loader was not able to load unsupported feature. Required extensions: "+t.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((t,i)=>{t.children&&t.children.forEach(r=>{this.nodeParentMap.set(r,i)})})}async _loadTextureImageData(t,i,r){const s=this.textureLoaders.get(t);if(s)return s;const n=this._createTextureLoader(i,r);return this.textureLoaders.set(t,n),n}async _createTextureLoader(t,i){const r=this.json.images[t.source];if(r.uri)return this.context.loadImage(this._resolveUri(r.uri),i);const s=this.errorContext;s.errorUnsupportedIf(r.bufferView==null,"Image bufferView must be defined."),s.errorUnsupportedIf(r.mimeType==null,"Image mimeType must be defined.");const n=this.json.bufferViews[r.bufferView],o=await this.getBuffer(n.buffer,i);return s.errorUnsupportedIf(n.byteStride!=null,"byteStride not supported for image buffer"),Irt(new Uint8Array(o.buffer,o.byteOffset+(n.byteOffset||0),n.byteLength),r.mimeType)}}const Crt=new Iv(2,0,"glTF"),Art=gde(Ae(),Math.PI/2),CI=Dg(),Rrt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4},Mrt={[ht.BYTE]:1,[ht.UNSIGNED_BYTE]:1,[ht.SHORT]:2,[ht.UNSIGNED_SHORT]:2,[ht.FLOAT]:4,[ht.UNSIGNED_INT]:4};function Ort(e){switch(e.componentType){case ht.BYTE:return new Yb(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ht.UNSIGNED_BYTE:return new Hb(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ht.SHORT:return new Zb(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ht.UNSIGNED_SHORT:return new m2(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ht.UNSIGNED_INT:return new g2(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);case ht.FLOAT:return new Rh(e.raw,e.byteOffset,e.byteStride,e.byteOffset+e.byteStride*e.entryCount);default:return void(e.componentType,void 0)}}async function Prt(e){return new Promise((t,i)=>{const r=new Blob([e]),s=new FileReader;s.onload=()=>{const n=s.result;t(JSON.parse(n))},s.onerror=n=>{i(n)},s.readAsText(r)})}async function Irt(e,t){return new Promise((i,r)=>{const s=new Blob([e],{type:t}),n=URL.createObjectURL(s),o=new Image;o.addEventListener("load",()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>i(o),()=>i(o)):i(o)}),o.addEventListener("error",a=>{URL.revokeObjectURL(n),r(a)}),o.src=n})}const AI={5120:"BYTE",5121:"UNSIGNED_BYTE",5122:"SHORT",5123:"UNSIGNED_SHORT",5125:"UNSIGNED_INT",5126:"FLOAT"};let $rt=0;async function Awe(e,t,i={},r=!0){const s=await zm.load(e,sL,t,i),n="gltf_"+$rt++,o={lods:[],materials:new Map,textures:new Map,meta:Drt(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await Lrt(s,async(c,h,p,f)=>{var D;const m=(D=l.get(p))!=null?D:0;l.set(p,m+1);const y=c.mode!==void 0?c.mode:Pt.TRIANGLES,v=y===Pt.TRIANGLES||y===Pt.TRIANGLE_STRIP||y===Pt.TRIANGLE_FAN?y:null;if(R(v))return void sL.warnUnsupported("Unsupported primitive mode ("+krt[y]+"). Skipping primitive.");if(!s.hasPositions(c))return void sL.warn("Skipping primitive without POSITION vertex attribute.");const w=s.getPositionData(c,i),b=s.getMaterial(c,i,r),S=s.hasNormals(c)?s.getNormalData(c,i):null,T=s.hasTangents(c)?s.getTangentData(c,i):null,E=s.hasTextureCoordinates(c)?s.getTextureCoordinates(c,i):null,C=s.hasVertexColors(c)?s.getVertexColors(c,i):null,M=s.getIndexData(c,i),I={transform:fb(h),attributes:{position:await w,normal:S?await S:null,texCoord0:E?await E:null,color:C?await C:null,tangent:T?await T:null},indices:await M,primitiveType:v,material:Frt(o,await b,n)};let N=null;_(o.meta)&&_(o.meta.ESRI_lod)&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(N=o.meta.ESRI_lod.thresholds[p]),o.lods[p]=o.lods[p]||{parts:[],name:f,lodThreshold:N},o.lods[p].parts[m]=I});for(const c of o.lods)c.parts=c.parts.filter(h=>!!h);return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{}}}function Drt(e){const t=e.json;let i=null;return t.nodes.forEach(r=>{const s=r.extras;_(s)&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(i=s)}),i}async function Lrt(e,t){const i=e.json,r=i.scenes[i.scene||0].nodes,s=r.length>1,n=[];for(const a of r){const l=i.nodes[a];n.push(o(a,0)),Nrt(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=i.nodes[a],h=e.getNodeTransform(a);if(sL.warnUnsupportedIf(c.weights!=null,"Morph targets are not supported."),c.mesh!=null){const p=i.meshes[c.mesh];for(const f of p.primitives)n.push(t(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function Nrt(e){return e.extensions&&e.extensions.MSFT_lod&&Array.isArray(e.extensions.MSFT_lod.ids)}function Frt(e,t,i){const r=n=>{const o=`${i}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!e.textures.has(o)){const a=_rt(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:Urt.includes(n.minFilter),noUnpackFlip:!0});e.textures.set(o,a)}return o},s=`${i}_mat_${t.id}_${t.name}`;if(!e.materials.has(s)){const n=vrt({color:[t.color[0],t.color[1],t.color[2]],opacity:t.color[3],alphaMode:t.alphaMode,alphaCutoff:t.alphaCutoff,doubleSided:t.doubleSided,colorMixMode:t.ESRI_externalColorMixMode,textureColor:t.colorTexture?r(t.colorTexture):void 0,textureNormal:t.normalTexture?r(t.normalTexture):void 0,textureOcclusion:t.occlusionTexture?r(t.occlusionTexture):void 0,textureEmissive:t.emissiveTexture?r(t.emissiveTexture):void 0,textureMetallicRoughness:t.metallicRoughnessTexture?r(t.metallicRoughnessTexture):void 0,emissiveFactor:[t.emissiveFactor[0],t.emissiveFactor[1],t.emissiveFactor[2]],metallicFactor:t.metallicFactor,roughnessFactor:t.roughnessFactor});e.materials.set(s,n)}return s}const sL=new yrt,Urt=[Ke.LINEAR_MIPMAP_LINEAR,Ke.LINEAR_MIPMAP_NEAREST],krt=["POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLES","TRIANGLE_STRIP","TRIANGLE_FAN"];function zrt(e,t=v2){return typeof e=="number"?t(e):FL(e)||C1(e)?new Uint32Array(e):e}function Vrt(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;n+=1)n%2==0?(r[s++]=n,r[s++]=n+1,r[s++]=n+2):(r[s++]=n+1,r[s++]=n,r[s++]=n+2)}else{let s=0;for(let n=0;n<i;n+=1)if(n%2==0){const o=e[n],a=e[n+1],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}else{const o=e[n+1],a=e[n],l=e[n+2];r[s++]=o,r[s++]=a,r[s++]=l}}return r}function Brt(e){const t=typeof e=="number"?e:e.length;if(t<3)return new Uint16Array(0);const i=t-2,r=i<=65536?new Uint16Array(3*i):new Uint32Array(3*i);if(typeof e=="number"){let s=0;for(let n=0;n<i;++n)r[s++]=0,r[s++]=n+1,r[s++]=n+2;return r}{const s=e[0];let n=e[1],o=0;for(let a=0;a<i;++a){const l=e[a+2];r[o++]=s,r[o++]=n,r[o++]=l,n=l}return r}}const Om=me.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function Rwe(e,t){const i=await Grt(e,t);return{resource:i,textures:await Xrt(i.textureDefinitions,t)}}async function Grt(e,t){const i=_(t)&&t.streamDataRequester;if(i)return jrt(e,i,t);const r=await nc(ur(e,t));if(r.ok===!0)return r.value.data;Pg(r.error),Mwe(r.error)}async function jrt(e,t,i){const r=await nc(t.request(e,"json",i));if(r.ok===!0)return r.value;Pg(r.error),Mwe(r.error.details.url)}function Mwe(e){throw new q("",`Request for object resource failed: ${e}`)}function Hrt(e){const t=e.params,i=t.topology;let r=!0;switch(t.vertexAttributes||(Om.warn("Geometry must specify vertex attributes"),r=!1),t.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=t.faces;if(n){if(t.vertexAttributes)for(const o in t.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&(Om.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),r=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&(Om.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),r=!1)):(Om.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),r=!1)}}else Om.warn("Indexed geometries must specify faces"),r=!1;break}default:Om.warn(`Unsupported topology '${i}'`),r=!1}e.params.material||(Om.warn("Geometry requires material"),r=!1);const s=e.params.vertexAttributes;for(const n in s)s[n].values||(Om.warn("Geometries with externally defined attributes are not yet supported"),r=!1);return r}function qrt(e,t){const i=[],r=[],s=[],n=[],o=e.resource,a=Iv.parse(o.version||"1.0","wosr");Zrt.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions,p=e.textures;let f=0;const m=new Map;for(let y=0;y<c.length;y++){const v=c[y];if(!Hrt(v))continue;const w=Yrt(v),b=v.params.vertexAttributes,S=[];for(const D in b){const z=b[D],V=z.values;S.push([D,{data:V,size:z.valuesPerElement,exclusive:!0}])}const T=[];if(v.params.topology!=="PerAttributeArray"){const D=v.params.faces;for(const z in D)T.push([z,new Uint32Array(D[z].values)])}const E=p&&p[w.texture];if(E&&!m.has(w.texture)){const{image:D,params:z}=E,V=new Cs(D,z);n.push(V),m.set(w.texture,V)}const C=m.get(w.texture),M=C?C.id:void 0;let I=s[w.material]?s[w.material][w.texture]:null;if(!I){const D=h[w.material.substring(w.material.lastIndexOf("/")+1)].params;D.transparency===1&&(D.transparency=0);const z=E&&E.alphaChannelUsage,V=D.transparency>0||z==="transparency"||z==="maskAndTransparency",k=E?Owe(E.alphaChannelUsage):void 0,Y={ambient:Ya(D.diffuse),diffuse:Ya(D.diffuse),opacity:1-(D.transparency||0),transparent:V,textureAlphaMode:k,textureAlphaCutoff:.33,textureId:M,initTextureTransparent:!0,doubleSided:!0,cullFace:or.None,colorMixMode:D.externalColorMixMode||"tint",textureAlphaPremultiplied:!!E&&!!E.params.preMultiplyAlpha};_(t)&&t.materialParamsMixin&&Object.assign(Y,t.materialParamsMixin),I=new rw(Y),s[w.material]||(s[w.material]={}),s[w.material][w.texture]=I}r.push(I);const N=new Or(S,T);f+=T.position?T.position.length:0,i.push(N)}return{name:l,stageResources:{textures:n,materials:r,geometries:i},pivotOffset:o.model.pivotOffset,boundingBox:Wrt(i),numberOfVertices:f,lodThreshold:null}}function Wrt(e){const t=cr();return e.forEach(i=>{const r=i.boundingInfo;_(r)&&(xf(t,r.getBBMin()),xf(t,r.getBBMax()))}),t}async function Xrt(e,t){const i=[];for(const n in e){const o=e[n],a=o.images[0].data;if(!a){Om.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:_t.REPEAT,t:_t.REPEAT},preMultiplyAlpha:Owe(h)!==sr.Opaque},f=_(t)&&t.disableTextures?Promise.resolve(null):Qd(l,t);i.push(f.then(m=>({refId:c,image:m,params:p,alphaChannelUsage:h})))}const r=await Promise.all(i),s={};for(const n of r)s[n.refId]=n;return s}function Owe(e){switch(e){case"mask":return sr.Mask;case"maskAndTransparency":return sr.MaskBlend;case"none":return sr.Opaque;default:return sr.Blend}}function Yrt(e){const t=e.params;return{id:1,material:t.material,texture:t.texture,region:t.texture}}const Zrt=new Iv(1,2,"wosr"),nx=2.1;async function Pwe(e,t){const i=Iwe(nrt(e));if(i.fileType==="wosr"){const l=await(t.cache?t.cache.loadWOSR(i.url,t):Rwe(i.url,t)),c=qrt(l,t);return{lods:[c],referenceBoundingBox:c.boundingBox,isEsriSymbolResource:!1,isWosr:!0,remove:l.remove}}const r=await(t.cache?t.cache.loadGLTF(i.url,t,t.usePBR):Awe(new Ewe(t.streamDataRequester),i.url,t,t.usePBR)),s=Yr(r.model.meta,"ESRI_proxyEllipsoid");r.meta.isEsriSymbolResource&&_(s)&&r.meta.uri.includes("/RealisticTrees/")&&Krt(r,s);const n=r.meta.isEsriSymbolResource?{usePBR:t.usePBR,isSchematic:!1,treeRendering:!!r.customMeta.esriTreeRendering,mrrFactors:[0,1,.2]}:{usePBR:t.usePBR,isSchematic:!1,treeRendering:!1,mrrFactors:[0,1,.5]},o=ve(F({},t.materialParamsMixin),{treeRendering:!!r.customMeta.esriTreeRendering});if(i.specifiedLodIndex!=null){const l=nL(r,n,o,i.specifiedLodIndex);let c=l[0].boundingBox;return i.specifiedLodIndex!==0&&(c=nL(r,n,o,0)[0].boundingBox),{lods:l,referenceBoundingBox:c,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}const a=nL(r,n,o);return{lods:a,referenceBoundingBox:a[0].boundingBox,isEsriSymbolResource:r.meta.isEsriSymbolResource,isWosr:!1,remove:r.remove}}function Iwe(e){const t=e.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return t?{fileType:"gltf",url:t[1],specifiedLodIndex:t[4]!=null?Number(t[4]):null}:e.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:e,specifiedLodIndex:null}:{fileType:"unknown",url:e,specifiedLodIndex:null}}function nL(e,t,i,r){const s=e.model,n=Sr(),o=new Array,a=new Map,l=new Map;return s.lods.forEach((c,h)=>{if(r!==void 0&&h!==r)return;const p={name:c.name,stageResources:{textures:new Array,materials:new Array,geometries:new Array},lodThreshold:_(c.lodThreshold)?c.lodThreshold:null,pivotOffset:[0,0,0],numberOfVertices:0,boundingBox:cr()};o.push(p),c.parts.forEach(f=>{const m=f.material+(f.attributes.normal?"_normal":"")+(f.attributes.color?"_color":"")+(f.attributes.texCoord0?"_texCoord0":"")+(f.attributes.tangent?"_tangent":""),y=s.materials.get(f.material),v=_(f.attributes.texCoord0),w=_(f.attributes.normal),b=Qrt(y.alphaMode);if(!a.has(m)){if(v){if(_(y.textureColor)&&!l.has(y.textureColor)){const ne=s.textures.get(y.textureColor),$=ve(F({},ne.parameters),{preMultiplyAlpha:b!==sr.Opaque});l.set(y.textureColor,new Cs(ne.data,$))}if(_(y.textureNormal)&&!l.has(y.textureNormal)){const ne=s.textures.get(y.textureNormal);l.set(y.textureNormal,new Cs(ne.data,ne.parameters))}if(_(y.textureOcclusion)&&!l.has(y.textureOcclusion)){const ne=s.textures.get(y.textureOcclusion);l.set(y.textureOcclusion,new Cs(ne.data,ne.parameters))}if(_(y.textureEmissive)&&!l.has(y.textureEmissive)){const ne=s.textures.get(y.textureEmissive);l.set(y.textureEmissive,new Cs(ne.data,ne.parameters))}if(_(y.textureMetallicRoughness)&&!l.has(y.textureMetallicRoughness)){const ne=s.textures.get(y.textureMetallicRoughness);l.set(y.textureMetallicRoughness,new Cs(ne.data,ne.parameters))}}const D=y.color[0]**(1/nx),z=y.color[1]**(1/nx),V=y.color[2]**(1/nx),k=y.emissiveFactor[0]**(1/nx),Y=y.emissiveFactor[1]**(1/nx),Z=y.emissiveFactor[2]**(1/nx),le=_(y.textureColor)&&v?l.get(y.textureColor):null;a.set(m,new rw(F(ve(F({},t),{transparent:b===sr.Blend,customDepthTest:zb.Lequal,textureAlphaMode:b,textureAlphaCutoff:y.alphaCutoff,diffuse:[D,z,V],ambient:[D,z,V],opacity:y.opacity,doubleSided:y.doubleSided,doubleSidedType:"winding-order",cullFace:y.doubleSided?or.None:or.Back,hasVertexColors:!!f.attributes.color,hasVertexTangents:!!f.attributes.tangent,normals:w?"default":"screenDerivative",castShadows:!0,receiveSSAO:!0,textureId:_(le)?le.id:void 0,colorMixMode:y.colorMixMode,normalTextureId:_(y.textureNormal)&&v?l.get(y.textureNormal).id:void 0,textureAlphaPremultiplied:_(le)&&!!le.params.preMultiplyAlpha,occlusionTextureId:_(y.textureOcclusion)&&v?l.get(y.textureOcclusion).id:void 0,emissiveTextureId:_(y.textureEmissive)&&v?l.get(y.textureEmissive).id:void 0,metallicRoughnessTextureId:_(y.textureMetallicRoughness)&&v?l.get(y.textureMetallicRoughness).id:void 0,emissiveFactor:[k,Y,Z],mrrFactors:[y.metallicFactor,y.roughnessFactor,t.mrrFactors[2]],isSchematic:!1}),i)))}const S=Jrt(f.indices||f.attributes.position.count,f.primitiveType),T=f.attributes.position.count,E=B1(Vi,T);t3(E,f.attributes.position,f.transform);const C=[[A.POSITION,{data:E.typedBuffer,size:E.elementCount,exclusive:!0}]],M=[[A.POSITION,S]];if(_(f.attributes.normal)){const D=B1(Vi,T);u2(n,f.transform),Mv(D,f.attributes.normal,n),C.push([A.NORMAL,{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),M.push([A.NORMAL,S])}if(_(f.attributes.tangent)){const D=B1(On,T);u2(n,f.transform),bwe(D,f.attributes.tangent,n),C.push([A.TANGENT,{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),M.push([A.TANGENT,S])}if(_(f.attributes.texCoord0)){const D=B1(Rh,T);xwe(D,f.attributes.texCoord0),C.push([A.UV0,{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),M.push([A.UV0,S])}if(_(f.attributes.color)){const D=B1(fl,T);if(f.attributes.color.elementCount===4)f.attributes.color instanceof On?dj(D,f.attributes.color,255):f.attributes.color instanceof fl?Twe(D,f.attributes.color):f.attributes.color instanceof xv&&dj(D,f.attributes.color,1/256);else{Swe(D,255,255,255,255);const z=new wv(D.buffer,0,4);f.attributes.color instanceof Vi?tj(z,f.attributes.color,255):f.attributes.color instanceof wv?cU(z,f.attributes.color):f.attributes.color instanceof Wb&&tj(z,f.attributes.color,1/256)}C.push([A.COLOR,{data:D.typedBuffer,size:D.elementCount,exclusive:!0}]),M.push([A.COLOR,S])}const I=new Or(C,M);p.stageResources.geometries.push(I),p.stageResources.materials.push(a.get(m)),v&&(_(y.textureColor)&&p.stageResources.textures.push(l.get(y.textureColor)),_(y.textureNormal)&&p.stageResources.textures.push(l.get(y.textureNormal)),_(y.textureOcclusion)&&p.stageResources.textures.push(l.get(y.textureOcclusion)),_(y.textureEmissive)&&p.stageResources.textures.push(l.get(y.textureEmissive)),_(y.textureMetallicRoughness)&&p.stageResources.textures.push(l.get(y.textureMetallicRoughness))),p.numberOfVertices+=T;const N=I.boundingInfo;_(N)&&(xf(p.boundingBox,N.getBBMin()),xf(p.boundingBox,N.getBBMax()))})}),o}function Qrt(e){switch(e){case"BLEND":return sr.Blend;case"MASK":return sr.Mask;case"OPAQUE":case null:case void 0:return sr.Opaque}}function Jrt(e,t){switch(t){case Pt.TRIANGLES:return zrt(e);case Pt.TRIANGLE_STRIP:return Vrt(e);case Pt.TRIANGLE_FAN:return Brt(e)}}function Krt(e,t){for(let i=0;i<e.model.lods.length;++i){const r=e.model.lods[i];e.customMeta.esriTreeRendering=!0;for(const s of r.parts){const n=s.attributes.normal;if(R(n))return;const o=s.attributes.position,a=o.count,l=O(),c=O(),h=O(),p=B1(fl,a),f=B1(Vi,a),m=cs(Ae(),s.transform);for(let y=0;y<a;y++){o.getVec(y,c),n.getVec(y,l),Ue(c,c,s.transform),pe(h,c,t.center),LL(h,h,t.radius);const v=h[2],w=Me(h),b=Math.min(.45+.55*w*w,1);LL(h,h,t.radius),Ue(h,h,m),we(h,h),i+1!==e.model.lods.length&&e.model.lods.length>1&&en(h,h,l,v>-1?.2:Math.min(-4*v-3.8,1)),f.setVec(y,h),p.set(y,0,255*b),p.set(y,1,255*b),p.set(y,2,255*b),p.set(y,3,255)}s.attributes.normal=f,s.attributes.color=p}}}var T1t=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",fetch:Pwe,gltfToEngineResources:nL,parseUrl:Iwe}),wr;function est(e){let t=Kr().mat4f64(A.LOCALTRANSFORM).mat4f64(A.GLOBALTRANSFORM).vec4f64(A.BOUNDINGSPHERE).vec3f64(A.MODELORIGIN).mat3f(A.MODEL).mat3f(A.MODELNORMAL).vec2f(A.MODELSCALEFACTORS);return e.includes("color")&&(t=t.vec4f(A.COLOR)),e.includes("featureAttribute")&&(t=t.vec4f(A.FEATUREATTRIBUTE)),t=t.u8(A.STATE).u8(A.LODLEVEL).alignTo(8),t}(function(e){e[e.ALLOCATED=1]="ALLOCATED",e[e.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",e[e.VISIBLE=4]="VISIBLE",e[e.HIGHLIGHT=8]="HIGHLIGHT",e[e.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",e[e.REMOVE=32]="REMOVE",e[e.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",e[e.ACTIVE=18]="ACTIVE"})(wr||(wr={}));class tst{constructor(t){this.localTransform=t.getField(A.LOCALTRANSFORM,bv),this.globalTransform=t.getField(A.GLOBALTRANSFORM,bv),this.modelOrigin=t.getField(A.MODELORIGIN,vs),this.model=t.getField(A.MODEL,Jd),this.modelNormal=t.getField(A.MODELNORMAL,Jd),this.modelScaleFactors=t.getField(A.MODELSCALEFACTORS,Rh),this.boundingSphere=t.getField(A.BOUNDINGSPHERE,jb),this.color=t.getField(A.COLOR,On),this.featureAttribute=t.getField(A.FEATUREATTRIBUTE,On),this.state=t.getField(A.STATE,Ag),this.lodLevel=t.getField(A.LODLEVEL,Ag)}}class ist extends us{constructor(t,i){super(),this._capacity=0,this._size=0,this._next=0,this._layout=est(t),this._shaderTransformation=i}get capacity(){return this._capacity}get size(){return this._size}get buffer(){return this._buffer.buffer}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const t=this._findSlot();return this._view.state.set(t,wr.ALLOCATED),this._size++,this.emit("instance-added",{index:t}),t}removeInstance(t){const i=this._view.state;dt(t>=0&&t<this._capacity&&i.get(t)&wr.ALLOCATED,"invalid instance handle"),this._getStateFlag(t,wr.ACTIVE)?this._setStateFlags(t,wr.REMOVE):this.freeInstance(t),this.emit("instance-removed",{index:t})}freeInstance(t){const i=this._view.state;dt(t>=0&&t<this._capacity&&i.get(t)&wr.ALLOCATED,"invalid instance handle"),i.set(t,0),this._size--}setLocalTransform(t,i,r=!0){this._view.localTransform.setMat(t,i),r&&this.updateModelTransform(t)}getLocalTransform(t,i){this._view.localTransform.getMat(t,i)}setGlobalTransform(t,i,r=!0){this._view.globalTransform.setMat(t,i),r&&this.updateModelTransform(t)}getGlobalTransform(t,i){this._view.globalTransform.getMat(t,i)}updateModelTransform(t){const i=this._view,r=hy,s=jh;i.localTransform.getMat(t,fne),i.globalTransform.getMat(t,Xz);const n=Nr(Xz,Xz,fne);ie(r,n[12],n[13],n[14]),i.modelOrigin.setVec(t,r),Ch(s,n),i.model.setMat(t,s);const o=SPe(hy,n);o.sort(),i.modelScaleFactors.set(t,0,o[1]),i.modelScaleFactors.set(t,1,o[2]),ww(s,s),Ah(s,s),i.modelNormal.setMat(t,s),this._setStateFlags(t,wr.TRANSFORM_CHANGED),this.emit("instance-transform-changed",{index:t})}getModelTransform(t,i){const r=this._view;r.model.getMat(t,jh),r.modelOrigin.getVec(t,hy),i[0]=jh[0],i[1]=jh[1],i[2]=jh[2],i[3]=0,i[4]=jh[3],i[5]=jh[4],i[6]=jh[5],i[7]=0,i[8]=jh[6],i[9]=jh[7],i[10]=jh[8],i[11]=0,i[12]=hy[0],i[13]=hy[1],i[14]=hy[2],i[15]=1}applyShaderTransformation(t,i){this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i)}getCombinedModelTransform(t,i){return this.getModelTransform(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedLocalTransform(t,i){return this._view.localTransform.getMat(t,i),this._shaderTransformation&&this._shaderTransformation.applyTransform(this,t,i),i}getCombinedMaxScaleFactor(t){let i=this._view.modelScaleFactors.get(t,1);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(hy,this,t);i*=Math.max(r[0],r[1],r[2])}return i}getCombinedMedianScaleFactor(t){let i=this._view.modelScaleFactors.get(t,0);if(this._shaderTransformation){const r=this._shaderTransformation.scaleFactor(hy,this,t);r.sort(),i*=r[1]}return i}getModel(t,i){this._view.model.getMat(t,i)}setFeatureAttribute(t,i){this._view.featureAttribute.setVec(t,i)}getFeatureAttribute(t,i){this._view.featureAttribute.getVec(t,i)}setColor(t,i){this._view.color.setVec(t,i)}getColor(t,i){this._view.color.getVec(t,i)}setVisible(t,i){i!==this.getVisible(t)&&(this._setStateFlag(t,wr.VISIBLE,i),this.emit("instance-visibility-changed",{index:t}))}getVisible(t){return this._getStateFlag(t,wr.VISIBLE)}setHighlight(t,i){i!==this.getHighlight(t)&&(this._setStateFlag(t,wr.HIGHLIGHT,i),this.emit("instance-highlight-changed",{index:t}))}getHighlight(t){return this._getStateFlag(t,wr.HIGHLIGHT)}getState(t){return this._view.state.get(t)}getLodLevel(t){return this._view.lodLevel.get(t)}countFlags(t){let i=0;for(let r=0;r<this._capacity;++r)this.getState(r)&t&&++i;return i}_setStateFlags(t,i){const r=this._view.state;i=r.get(t)|i,r.set(t,i)}_clearStateFlags(t,i){const r=this._view.state;i=r.get(t)&~i,r.set(t,i)}_setStateFlag(t,i,r){r?this._setStateFlags(t,i):this._clearStateFlags(t,i)}_getStateFlag(t,i){return!!(this._view.state.get(t)&i)}_grow(){const t=Math.max(rst,Math.floor(this._capacity*sst)),i=this._layout.createBuffer(t);if(this._buffer){const r=new Uint8Array(this._buffer.buffer);new Uint8Array(i.buffer).set(r)}this._capacity=t,this._buffer=i,this._view=new tst(this._buffer)}_findSlot(){const t=this._view.state;let i=this._next;for(;t.get(i)&wr.ALLOCATED;)i=(i+1)%this._capacity;return this._next=(i+1)%this._capacity,i}}const rst=1024,sst=2,hy=O(),jh=Sr(),fne=Ae(),Xz=Ae();class nst extends Ud{constructor(t,i){super(r=>this._instanceData.view.boundingSphere.getVec(r,this._tmpSphere),{maximumDepth:25}),this._tmpSphere=fn(),this._tmpMat4=Ae(),this._instanceData=t,this._boundingSphere=i}addInstance(t){const i=this._instanceData.view.boundingSphere,r=this._instanceData.getCombinedModelTransform(t,this._tmpMat4);Ue(this._tmpSphere,this._boundingSphere.center,r),this._tmpSphere[3]=this._boundingSphere.radius*Lb(r),i.setVec(t,this._tmpSphere),this.add([t])}removeInstance(t){this.remove([t])}}class ost{constructor(t,i){this.thresholdScale=1,this._camera=new Yi,this._worldSpaceRadius=t,this._thresholds=i.map(r=>r)}updateCamera(t){this._camera.copyFrom(t)}selectLevel(t,i){const r=this._camera.computeScreenPixelSizeAt(t),s=this._worldSpaceRadius*i/r,n=this._thresholds;let o=-1;for(let a=0;a<n.length;++a)s>=n[a]*this.thresholdScale&&(o=a);return o}}class ast{constructor(t,i){const r=t.renderContext.rctx,{geometry:s,material:n}=i;this._materialRepository=t.materialRep,n.setParameters({instancedDoublePrecision:!0});const o=n.createBufferWriter(),a=o.vertexBufferLayout,l=o.elementCount(s),c=o.allocate(l);o.write({},s,c,0),this.geometry=s,this.material=n,this.glMaterials=new dbe(n,this._materialRepository),this.vertexBufferLayout=a,this.vbo=ti.createVertex(r,yi.STATIC_DRAW,c.buffer),this.vao=new Ns(r,Di,{geometry:hc(a)},{geometry:this.vbo}),this.vertexCount=l}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(t,i,r,s,n,o,a,l){const c=this.geometry.id;this.material.intersect(this.geometry,null,t.transform.transform,t,r,s,(h,p,f,m,y)=>{if(h>=0){if(i!=null&&!i(t.rayBegin,t.rayEnd,h))return;const v={layerUid:o.layerUid,graphicUid:o.graphicUid(n),geometryId:c,triangleNr:f,baseBoundingSphere:a,numLodLevels:l};if((t.results.min.drapedLayerOrder==null||y>=t.results.min.drapedLayerOrder)&&(t.results.min.dist==null||h<t.results.min.dist)&&t.results.min.set(Dr.LOD,v,h,p,t.transform.transform,y),t.options.store!==io.MIN&&(t.results.max.drapedLayerOrder==null||y>=t.results.max.drapedLayerOrder)&&(t.results.max.dist==null||h>t.results.max.dist)&&t.results.max.set(Dr.LOD,v,h,p,t.transform.transform,y),t.options.store===io.ALL){const w=sY(t.results.min.ray);w.set(Dr.LOD,v,h,p,t.transform.transform,y),t.results.all.push(w)}}})}}class iZ{constructor(t,i){this.minScreenSpaceRadius=t,this.components=i}static async create(t,i,r){const s=await Promise.allSettled(i.components.map(o=>t.schedule(()=>new ast(t,o),r))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Xs(r)||n.length!==s.length){n.forEach(o=>o.destroy()),li(r);for(const o of s)if(o.status==="rejected")throw o.reason}return new iZ(i.minScreenSpaceRadius,n)}destroy(){this.components.forEach(t=>t.destroy())}intersect(t,i,r,s,n,o,a){this.components.forEach(l=>l.intersect(t,i,r,s,n,o,this.boundingSphere,a))}get boundingBox(){if(R(this._boundingBox)){const t=cr();this.components.forEach(i=>{_(i.boundingInfo)&&(xf(t,i.boundingInfo.bbMin),xf(t,i.boundingInfo.bbMax))}),this._boundingBox=t}return this._boundingBox}get boundingSphere(){if(R(this._boundingSphere)){const t=this.boundingBox,i=O();Id(t,i),this._boundingSphere={center:i,radius:.5*she(t)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((t,i)=>t+i.triangleCount,0)}}class lst{constructor(t,i,r){this._elementSize=i,this._buffer=ti.createVertex(t,yi.STATIC_DRAW),this.resize(r)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(t,i,r,s=0){const n=new Uint8Array(this.array,t*this.elementSize,(i-t)*this.elementSize);new Uint8Array(r.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(t,i){const r=t*this._elementSize,s=i*this._elementSize;this._buffer.setSubData(this._array,r,r,s)}resize(t){const i=t*this._elementSize,r=new ArrayBuffer(i);this._array&&(t>=this._capacity?new Uint8Array(r).set(new Uint8Array(this._array)):new Uint8Array(r).set(new Uint8Array(this._array).subarray(0,t*this._elementSize))),this._array=r,this._buffer.setSize(i),this._capacity=t}}class cst{constructor(t){this.modelOriginHi=t.getField(A.MODELORIGINHI,Vi),this.modelOriginLo=t.getField(A.MODELORIGINLO,Vi),this.model=t.getField(A.MODEL,Jd),this.modelNormal=t.getField(A.MODELNORMAL,Jd),this.color=t.getField(A.INSTANCECOLOR,On),this.featureAttribute=t.getField(A.INSTANCEFEATUREATTRIBUTE,On)}}class mne{constructor(t,i){this._headIndex=0,this._tailIndex=0,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=t,this._instanceBufferLayout=i,this._elementSize=i.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const t=this._headIndex,i=this._tailIndex;return t>=i?t-i:t+this._capacity-i}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCylce(){this._captureFirstIndex=!0}beginUpdate(){dt(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){dt(this._updating,"not updating"),this.size<hst*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){dt(this._updating,"not updating"),this.isFull&&this._grow();const t=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=t,this._captureFirstIndex=!1),this._incrementHead(),dt(this._headIndex!==this._tailIndex,"invalid pointers"),t}freeTail(){dt(this._updating,"not updating"),dt(this.size>0,"invalid size");const t=this._tailIndex===this._firstIndex;this._incrementTail(),t&&(this._firstIndex=this._tailIndex)}_grow(){const t=Math.max(gne,Math.floor(this._capacity*ust));this._resize(t)}_shrink(){const t=Math.max(gne,Math.floor(this._capacity*dst));this._resize(t)}_resize(t){if(dt(this._updating,"not updating"),t===this._capacity)return;const i=new lst(this._rctx,this._elementSize,t);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const r=this.size,s=this._compactInstances(i);dt(s===r,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=t,this._buffer=i,this._view=new cst(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(t){const i=this._headIndex,r=this._tailIndex;return r<i?(this._buffer.copyRange(r,i,t),i-r):r>i?(this._buffer.copyRange(r,this._capacity,t),i>0&&this._buffer.copyRange(0,i,t,this._capacity-r),i+(this._capacity-r)):0}_incrementHead(t=1){this._headIndex=(this._headIndex+t)%this._capacity}_incrementTail(t=1){this._tailIndex=(this._tailIndex+t)%this._capacity}_transferRange(t,i){t<i?this._buffer.transferRange(t,i):t>i&&(i>0&&this._buffer.transferRange(0,i),this._buffer.transferRange(t,this._capacity))}}const gne=1024,ust=2,hst=.3,dst=.5;let pst=e=>{const t=e.baseBoundingSphere.radius,i=e.levels.map(r=>r.minScreenSpaceRadius);return new ost(t,i)};class fst{constructor(t,i,r,s){this.type=Dr.LOD,this.isGround=!1,this._levels=[],this._defaultRenderInstanceData=[],this._highlightRenderInstanceData=[],this._instanceIndex=0,this._slicePlane=!1,this._enableLevelSelection=!0,this._lastCamera=new Yi,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL],this.canRender=!0,this._symbol=t,this._optionalFields=i,this._metadata=r,this._instanceBufferLayout=ewe({instancedDoublePrecision:!0,instanced:i}),this._glInstanceBufferLayout=hc(this._instanceBufferLayout,1),this._instanceData=new ist(this._optionalFields,s),this._instanceData.on("instance-added",()=>this._requestUpdateCycle()),this._instanceData.on("instance-removed",()=>this._requestUpdateCycle()),this._instanceData.on("instance-transform-changed",n=>{this._requestUpdateCycle(),this._metadata.notifyGraphicGeometryChanged(n.index)}),this._instanceData.on("instance-visibility-changed",n=>{this._requestUpdateCycle(!0),this._metadata.notifyGraphicVisibilityChanged(n.index)}),this._instanceData.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0)),this._enableLevelSelection=this._symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(t){this._slicePlane=t}get layerUid(){return this._metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const t={cpu:0,gpu:0};return this._defaultRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),this._highlightRenderInstanceData.forEach(i=>{const r=i.memoryUsage;t.cpu+=r.cpu,t.gpu+=r.gpu}),t}get renderStats(){const t=this._instanceData.size,i=[];return this._levels.forEach((r,s)=>{const n=this._defaultRenderInstanceData[s],o=this._highlightRenderInstanceData[s],a=n.size+o.size,l=r.triangleCount;i.push({renderedInstances:a,renderedTriangles:a*l,trianglesPerInstance:l})}),{totalInstances:t,renderedInstances:i.reduce((r,s)=>r+s.renderedInstances,0),renderedTriangles:i.reduce((r,s)=>r+s.renderedTriangles,0),levels:i}}async initializeRenderContext(t,i){this._context=t;const r=t.renderContext.rctx,s=await Promise.allSettled(this._symbol.levels.map(o=>(this._defaultRenderInstanceData.push(new mne(r,this._instanceBufferLayout)),this._highlightRenderInstanceData.push(new mne(r,this._instanceBufferLayout)),iZ.create(t,o,i)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(o=>o);if(Xs(i)||n.length!==s.length){n.forEach(o=>o.destroy()),li(i);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=pst(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(t=>t.destroy()),this._defaultRenderInstanceData.forEach(t=>t.destroy()),this._highlightRenderInstanceData.forEach(t=>t.destroy())}get needsTransparentPass(){return this._levels.some(t=>t.components.some(i=>i.material.requiresSlot(Se.TRANSPARENT_MATERIAL)))}get needsHighlight(){return this._highlightRenderInstanceData.some(t=>t.size>0)}prepareRender(t){if(zi.LOD_INSTANCE_RENDERER_DISABLE_UPDATES)return;if(this._enableLevelSelection){const r=t.bindParameters.contentCamera.equals(this._lastCamera);this._lastCamera.copyFrom(t.bindParameters.contentCamera),r||this._requestUpdateCycle()}const i=this._needFullCycle?this._instanceData.size:2e3;this._needFullCycle=!1,this._updateInstances(t.bindParameters.contentCamera,i),this.needsUpdates&&this._context.requestRender()}render(t){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleInPass(t.pass))return;t.rctx.bindVAO();const i=t.pass!==je.MATERIAL_HIGHLIGHT&&t.pass!==je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,r=t.pass!==je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT;i&&this._renderComponents(t,this._defaultRenderInstanceData),r&&this._renderComponents(t,this._highlightRenderInstanceData)}intersect(t,i,r,s){if(!this.baseMaterial.isVisible())return;const n=O();pe(n,s,r);const o=a=>{this._instanceData.getCombinedModelTransform(a,_ne),t.transform.set(_ne),Ue(bne,r,t.transform.inverse),Ue(wne,s,t.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a),h=this._levels.length;dt(l&wr.ACTIVE,"invalid instance state"),dt(c>=0&&c<h,"invaid lod level"),this._levels[c].intersect(t,i,bne,wne,a,this._metadata,h)};this.baseMaterial.parameters.verticalOffset?this.octree.forEach(o):this.octree.forEachAlongRay(r,n,o)}queryDepthRange(t){return this._queryDepthRangeOctree(t)}notifyShaderTransformationChanged(){this._invalidateOctree()}_requestUpdateCycle(t=!1){this._updateCyclesWithStaticCamera=-1,t&&(this._needFullCycle=!0),this.needsUpdates&&this._context.requestRender()}get needsUpdates(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}get octree(){return this._octree||(this._octree=this._buildOctree()),this._octree}_invalidateOctree(){this._octree&&(this._octree.destroy(),this._octree=null)}_buildOctree(){const t=new nst(this._instanceData,this.baseBoundingSphere),i=this._instanceData,r=i.view?i.view.state:null;for(let s=0;s<this._instanceData.capacity;++s)r.get(s)&wr.ACTIVE&&t.addInstance(s);return t}_queryDepthRangeOctree(t){const i=t.eye,r=t.viewForward,s=this.octree.findClosest(r,Ud.DepthOrder.FRONT_TO_BACK,t.frustum),n=this.octree.findClosest(r,Ud.DepthOrder.BACK_TO_FRONT,t.frustum);if(s!=null&&n!=null){this._instanceData.view.boundingSphere.getVec(s,gp),pe(gp,gp,i);const o=xe(gp,r)-gp[3];this._instanceData.view.boundingSphere.getVec(n,gp),pe(gp,gp,i);const a=xe(gp,r)+gp[3];return{near:Math.max(t.near,o),far:Math.min(t.far,a)}}return{near:1/0,far:-1/0}}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._defaultRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this._highlightRenderInstanceData.forEach(t=>{t.startUpdateCylce()}),this.needsUpdates&&this._context.requestRender()}_updateInstances(t,i){const r=this._enableLevelSelection,s=this._levelSelector;s.updateCamera(t),this._defaultRenderInstanceData.forEach(h=>{h.beginUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.beginUpdate()});const n=this._instanceData,o=this._instanceData.view,a=n.size,l=n.capacity;let c=this._instanceIndex;i=Math.min(a,i);for(let h=0;h<i;++h){c===0&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&wr.ALLOCATED)){c=(c+1)%l,i++;continue}const m=o.lodLevel.get(c);if(p&wr.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[m].freeTail(),p&wr.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[m].freeTail(),p&wr.REMOVE)n.freeInstance(c);else if(p&wr.VISIBLE){let y=0;r&&(o.modelOrigin.getVec(c,vne),y=s.selectLevel(vne,n.getCombinedMedianScaleFactor(c))),f=p&~(wr.ACTIVE|wr.TRANSFORM_CHANGED),y>=0&&(p&wr.HIGHLIGHT?(yne(this._highlightRenderInstanceData[y],o,c),f|=wr.HIGHLIGHT_ACTIVE):(yne(this._defaultRenderInstanceData[y],o,c),f|=wr.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,y)}else f=p&~(wr.ACTIVE|wr.TRANSFORM_CHANGED),o.state.set(c,f);if(this._octree){const y=!!(p&wr.ACTIVE),v=!!(f&wr.ACTIVE);!y&&v?this._octree.addInstance(c):y&&!v?this._octree.removeInstance(c):y&&v&&p&wr.TRANSFORM_CHANGED&&(this._octree.removeInstance(c),this._octree.addInstance(c))}c=(c+1)%l}this._instanceIndex=c,this._defaultRenderInstanceData.forEach(h=>{h.endUpdate()}),this._highlightRenderInstanceData.forEach(h=>{h.endUpdate()})}_renderComponents(t,i){this.levels.forEach((r,s)=>{r.components.forEach(n=>{this._renderComponent(t,i[s],n,s)})})}_renderComponent(t,i,r,s){const n=t.bindParameters;if(i.size===0||!r.material.requiresSlot(n.slot))return;const{rctx:o,pass:a}=t,l=r.glMaterials.load(o,a);if(R(l))return;const c=l.beginSlot(n),h=o.bindTechnique(c,r.material.parameters,n);o.bindVAO(r.vao),c.ensureAttributeLocations(r.vao),c.bindDraw(gst,n),zi.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&t.pass===je.MATERIAL&&(h.setUniform4fv("externalColor",xne[Math.min(s,xne.length-1)]),h.setUniform1i("colorMixMode",s1e.replace));const p=o.capabilities.instancing,f=i.capacity,m=i.headIndex,y=i.tailIndex,v=i.firstIndex,w=this._glInstanceBufferLayout,b=(S,T)=>{OX(o,Di,i.buffer,w,S),p.drawArraysInstanced(c.primitiveType,0,r.vertexCount,T-S),PX(o,Di,i.buffer,w)};r.material.parameters.transparent&&v!=null?m>y?(dt(v>=y&&v<=m,"invalid firstIndex"),b(v,m),b(y,v)):m<y&&(v<=m?(dt(v>=0&&v<=m,"invalid firstIndex"),b(v,m),b(y,f),b(0,v)):(dt(v>=y&&v<=f,"invalid firstIndex"),b(v,f),b(0,m),b(y,v))):m>y?b(y,m):m<y&&(b(0,m),b(y,f)),o.bindVAO(null)}}function yne(e,t,i){const r=e.allocateHead();mst(t,i,e.view,r)}function mst(e,t,i,r){Dqe(e.modelOrigin,t,i.modelOriginHi,i.modelOriginLo,r),i.model.copyFrom(r,e.model,t),i.modelNormal.copyFrom(r,e.modelNormal,t),e.color&&i.color&&i.color.copyFrom(r,e.color,t),e.featureAttribute&&i.featureAttribute&&i.featureAttribute.copyFrom(r,e.featureAttribute,t)}const vne=O(),gp=Gt(),_ne=Ae(),bne=O(),wne=O(),xne=[[1,0,1,1],[0,0,1,1],[0,1,0,1],[1,1,0,1],[1,0,0,1]],gst=new ket;class yst extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this.hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.ensureDrapedStatus(!1),this.hasLoadedPBRTextures=r.physicalBasedRenderingEnabled}getCachedSize(){const[t,i,r]=_(this._resources)?this._resources.symbolSize:[1,1,1];return{width:t,depth:i,height:r}}async doLoad(t){if(!this._drivenProperties.size&&U5(this.symbolLayer))throw new Error;const i=this.symbolLayer;if(this.isPrimitive){const r=i.resource?i.resource.primitive:Phe;this._resources=await this._createResourcesForPrimitive(r,t)}else this._resources=await this._createResourcesForUrl(i.resource.href,t);this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return _(this._resources)?this._resources.extentPadding:0}get isPrimitive(){return!(this.symbolLayer.resource&&this.symbolLayer.resource.href)}get lodRenderer(){return Yr(this._resources,"lodRenderer")}_setMaterialTransparencyParams(t,i=Yr(this.symbolLayer,"material","color")){const r=this._getCombinedOpacity(i),s=r<1||this.needsDrivenTransparentPass;return t.transparent=s,t.opacity=r,t.cullFace=s?or.None:or.Back,t}async _createResourcesForPrimitive(t,i){if(!wJe(t))throw new Error(`Unknown object symbol primitive: ${t}`);const r=this.symbolLayer,s=Ls(gRe(t)),n=Ya(U3(s)),o=Ya(uk(n,r)),a=Me(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,ambient:of,diffuse:of,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:b,minWorldLength:S,maxWorldLength:T}=f.verticalOffset;h.verticalOffset={screenLength:Jn(b),minWorldLength:S||0,maxWorldLength:T!=null?T:1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=ph;else{const b=_(r.material)&&r.material.color,S=_(b)?qe.toUnitRGBA(b):ph;h.externalColor=S}this._fastUpdates=ZM(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,P_)),h.instanced=["transformation"],this._fastUpdates.enabled?(Object.assign(h,this._fastUpdates.materialParameters),h.instanced.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(h.instanced.push("color"),this._optionalFields.push("color"));const m=new rw(h),y=Q1e(t,m);if(!y)throw new Error(`Unknown object symbol primitive: ${t}`);const v=lI(y).map(b=>({opacity:1,transparent:b.parameters.transparent})),w=await this._createStageResources(y,p);return{lodResources:y,lodRenderer:await this._createLodRenderer(y,i),stageResources:w,symbolSize:o,extentPadding:a,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:v,physicalBasedRenderingEnabled:p,resourceBoundingBox:s,resourceSize:n,pivotOffset:P_}}async _createResourcesForUrl(t,i){const r=["transformation"],s={materialParamsMixin:{instanced:r,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=ZM(this._context.renderer,this._fastVisualVariableConvertOptions(P_,P_,P_,P_)),this._fastUpdates.enabled?(Object.assign(s.materialParamsMixin,this._fastUpdates.materialParameters),r.push("featureAttribute"),this._optionalFields.push("featureAttribute")):this._hasPerInstanceColor()&&(r.push("color"),this._optionalFields.push("color"));const n=this.symbol;if(n.type==="point-3d"&&n.verticalOffset){const{screenLength:D,minWorldLength:z,maxWorldLength:V}=n.verticalOffset;s.materialParamsMixin.verticalOffset={screenLength:Jn(D),minWorldLength:z||0,maxWorldLength:V!=null?V:1/0},s.materialParamsMixin.castShadows=!1}s.signal=i,s.usePBR=this._context.physicalBasedRenderingEnabled;const o=s.usePBR,a=await Pwe(t,s),l=a.isEsriSymbolResource,c=a.isWosr;this._addDisposeResource(()=>a.remove());const h=trt(a.lods);rrt(h),h.levels.sort((D,z)=>D.minScreenSpaceRadius-z.minScreenSpaceRadius),h.levels[0].minScreenSpaceRadius=Math.min(2,h.levels[0].minScreenSpaceRadius);const p=this._context,f=this.symbolLayer.material,m=this._getExternalColorParameters(f),y=Yr(this.symbolLayer,"material","color"),v=this._getCombinedOpacity(y,{hasIntrinsicColor:!0}),w=this.needsDrivenTransparentPass,b=lI(h),S=lI(h).map(D=>({opacity:D.parameters.opacity||1,transparent:D.parameters.transparent}));b.forEach(D=>{const z=D.parameters;D.setParameters(m);const V=z.opacity*v,k=V<1||w||z.transparent;D.setParameters({opacity:V,transparent:k}),p.screenSizePerspectiveEnabled&&D.setParameters({screenSizePerspective:p.sharedResources.screenSizePerspectiveSettings})});const T=a.referenceBoundingBox,E=Ya(U3(T)),C=Ya(h.levels[0].pivotOffset),M=Ya(uk(E,this.symbolLayer)),I=Me(M);QM(this._fastUpdates,this._context.renderer,this._fastVisualVariableConvertOptions(T,M,E,C))&&b.forEach(D=>D.setParameters(this._fastUpdates.materialParameters));const N=await this._createStageResources(h,o);return{lodResources:h,lodRenderer:await this._createLodRenderer(h,i),stageResources:N,symbolSize:M,extentPadding:I,isEsriSymbolResource:l,isWosr:c,originalMaterialParameters:S,physicalBasedRenderingEnabled:o,resourceBoundingBox:T,resourceSize:E,pivotOffset:C}}_addDisposeResource(t){this._disposeResourceHandles.push(t)}async _createStageResources(t,i){const r=this._context.stage,s=lI(t);i!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),r.addMany(s),this._addDisposeResource(()=>r.removeMany(s));const n=MJe(t);r.addMany(n),this._addDisposeResource(()=>r.removeMany(n)),await r.load(n);const o=OJe(t);return r.addMany(o),this._addDisposeResource(()=>r.removeMany(o)),{materials:s,textures:n,geometries:o}}async _createLodRenderer(t,i){const r=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:a=>this._instanceIndexToGraphicUid.get(a),notifyGraphicGeometryChanged:a=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(a)),notifyGraphicVisibilityChanged:a=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(a))},n=this._fastUpdates.enabled?{applyTransform:(a,l,c)=>{a.getFeatureAttribute(l,RI),ms(c,aj(this._fastUpdates.materialParameters,RI,c))},scaleFactor:(a,l,c)=>(l.getFeatureAttribute(c,RI),Ttt(a,this._fastUpdates.materialParameters,RI))}:null,o=new fst(t,this._optionalFields,s,n);return o.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{r.removeRenderPlugin(o)}),await r.addRenderPlugin(o.slots,o,i),o}_getExternalColorParameters(t){const i={};return this._drivenProperties.color?i.externalColor=ph:_(t)&&_(t.color)?i.externalColor=qe.toUnitRGBA(t.color):(i.externalColor=ph,i.colorMixMode="ignore"),i}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(t=>t()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry))return null;const r=qM(i.geometry);if(R(r))return this.logger.warn(`unsupported geometry type for icon symbol: ${i.geometry.type}`),null;const s=this.setGraphicElevationContext(i,new _u),n=t.renderingInfo;return this._createAs3DShape(i,r,n,s,i.uid)}notifyDestroyGraphicLayer(t){this._instanceIndexToGraphicUid.delete(t.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(R(this._resources))return!0;const t=this._drivenProperties.opacity,i=!this.isPrimitive,r=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<r.length;n++){const o=r[n],a=Yr(this.symbolLayer,"material","color"),l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:i})*l.opacity,h=c<1||t||l.transparent;o.setParameters({opacity:c,transparent:h}),this.isPrimitive&&o.setParameters({cullFace:h?or.None:or.Back})}return!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,Rv)}slicePlaneEnabledChanged(){if(R(this._resources))return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const t of this._resources.stageResources.materials)t.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(R(this._resources))return!0;const{stageResources:t,isWosr:i}=this._resources;for(const r of t.materials)this.isPrimitive?r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):i||r.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this.hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this.hasLoadedPBRTextures=!0,!1)}pixelRatioChanged(){return!0}applyRendererDiff(t,i){if(R(this._resources))return Qs.Recreate_Symbol;const{stageResources:{materials:r},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in t.diff){if(c!=="visualVariables"||!QM(this._fastUpdates,i,this._fastVisualVariableConvertOptions(n,o,a,l)))return Qs.Recreate_Symbol;for(const h of r)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return Qs.Fast_Update}computeComplexity(){return R(this._resources)?super.computeComplexity():{primitivesPerFeature:VY(this._resources.lodResources.levels[0]).reduce((t,i)=>t+i.indices.get(A.POSITION).length,0)/3,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:ibe(this.symbol,this.symbolLayer)}}_hasLodRenderer(){return _(this._resources)}_createAs3DShape(t,i,r,s,n){if(!this._hasLodRenderer()||R(this._resources))return null;const o=this.getFastUpdateAttrValues(t),a=!this._fastUpdates.enabled&&this._hasPerInstanceColor()?TR(r.color,r.opacity):null,l=this._context.clippingExtent;if(Mn(i,ox,this._context.elevationProvider.spatialReference),_(l)&&!aq(l,ox))return null;const c=this._requiresTerrainElevation(s),h=this._computeGlobalTransform(i,s,Yz,MI),p=this._computeLocalTransform(this._resources,this.symbolLayer,r,Tne),f=this._resources.lodRenderer.instanceData,m=f.addInstance();this._instanceIndexToGraphicUid.set(m,n),f.setLocalTransform(m,p,!1),f.setGlobalTransform(m,h),o&&f.setFeatureAttribute(m,o),a&&f.setColor(m,a);const y=new Jit(this,m,pJe,s);return c&&(y.alignedSampledElevation=MI.sampledElevation),y.needsElevationUpdates=Rv(s.mode),HM(y,i,this._context.elevationProvider),y}_computeGlobalTransform(t,i,r,s){return Mg(t,this._context.elevationProvider,i,this._context.renderCoordsHelper,s),ox[0]=t.x,ox[1]=t.y,ox[2]=s.z,fu(t.spatialReference,ox,r,this._context.renderCoordsHelper.spatialReference),r}_computeLocalTransform(t,i,r,s){return Cf(s),this._applyObjectRotation(r,!1,s),this._applyObjectRotation(i,!0,s),this._applyObjectScale(t,r,s),this._applyAnchor(t,i,s),s}_applyObjectScale(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._drivenProperties.size&&i.size?i.size:t.symbolSize,n=qre(s,t.symbolSize,t.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||T4(r,r,n)}prepareSymbolLayerPatch(t){if(t.diff.type!=="partial")return;const i=t.diff.diff;this._preparePatchTransform(t,i),this._preparePatchColor(t,i)}updateGeometry(t,i){if(R(this._resources))return!0;const r=i&&qM(i);if(R(r))return!1;const s=this.getGeometryElevationMode(i);return t.elevationContext.mode===s&&(this._computeGlobalTransform(r,t.elevationContext,Yz,MI),this._requiresTerrainElevation(t.elevationContext)&&(t.alignedSampledElevation=MI.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(t.instanceIndex,Yz,!0),HM(t,r,this._context.elevationProvider),!0)}_preparePatchTransform(t,i){if(!(i.heading||i.tilt||i.roll||i.width||i.height||i.depth||i.anchor||i.anchorPosition)||R(this._resources))return;const r=(y,v,w)=>yt(y!=null&&y.type==="complete"?y.newValue:v,w),s=r(i.heading,this.symbolLayer.heading,0),n=r(i.tilt,this.symbolLayer.tilt,0),o=r(i.roll,this.symbolLayer.roll,0),a=r(i.width,this.symbolLayer.width,void 0),l=r(i.height,this.symbolLayer.height,void 0),c=r(i.depth,this.symbolLayer.depth,void 0),h=r(i.anchor,this.symbolLayer.anchor,void 0),p=r(i.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete i.heading,delete i.tilt,delete i.roll,delete i.width,delete i.height,delete i.depth,delete i.anchor,delete i.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},m=this._resources;this.loadStatus===Bc.LOADED&&t.symbolLayerStatePatches.push(()=>{m.symbolSize=Ya(uk(m.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),t.graphics3DGraphicPatches.push((y,v)=>{const w=this._computeLocalTransform(m,f,v,Tne),b=y.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(b,w,!0)})}_preparePatchColor(t,i){if(!i.material||i.material.type!=="partial")return;const r=i.material.diff;if(!r.color||r.color.type!=="complete"||r.color.newValue==null||r.color.oldValue==null)return;const s=r.color.newValue,n=_(s)?qe.toUnitRGBA(s):ph;delete r.color;const o=this._resources;R(o)||t.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(t){return t.mode!=="absolute-height"}_applyObjectRotation(t,i,r){if(!(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation&&i))return iJe(t.heading,t.tilt,t.roll,r)}_computeAnchor(t,i,r){const s=O();switch(r.anchor){case"center":se(s,Id(t)),qo(s,s);break;case"top":{const n=Id(t);ie(s,-n[0],-n[1],-t[5]);break}case"bottom":{const n=Id(t);ie(s,-n[0],-n[1],-t[2]);break}case"relative":{const n=Id(t),o=U3(t),a=r.anchorPosition,l=a?Fe(a.x,a.y,a.z):Ta;YF(s,o,l),de(s,s,n),qo(s,s);break}default:_(i)?qo(s,i):se(s,Ta)}return s}_applyAnchor(t,i,r){if(this._fastUpdates.enabled&&this._fastUpdates.requiresShaderTransformation)return;const s=this._computeAnchor(t.resourceBoundingBox,t.pivotOffset,i);s&&Aa(r,r,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(t,i,r,s){const n=_(t)?Ya(U3(t)):of,o=_(t)?this._computeAnchor(t,s,this.symbolLayer):Ta,a=this._context.renderCoordsHelper.unitInMeters,l=qre(_(i)?i:void 0,i,r,a),c=Fe(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return{modelSize:n,symbolSize:_(i)?i:of,unitInMeters:a,transformation:{anchor:o,scale:l,rotation:c}}}}const ox=O(),Tne=Ae(),Yz=Ae(),RI=Gt(),MI=new e3;function vst(e,t){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function _st(e){return e[0]=1,e[1]=0,e[2]=0,e[3]=1,e}function rZ(e,t,i,r,s){return e[0]=t,e[1]=i,e[2]=r,e[3]=s,e}function bst(e,t){if(e===t){const i=t[1];e[1]=t[2],e[2]=i}else e[0]=t[0],e[1]=t[2],e[2]=t[1],e[3]=t[3];return e}function wst(e,t){const i=t[0],r=t[1],s=t[2],n=t[3];let o=i*n-s*r;return o?(o=1/o,e[0]=n*o,e[1]=-r*o,e[2]=-s*o,e[3]=i*o,e):null}function xst(e,t){const i=t[0];return e[0]=t[3],e[1]=-t[1],e[2]=-t[2],e[3]=i,e}function Tst(e){return e[0]*e[3]-e[2]*e[1]}function $we(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1],c=i[2],h=i[3];return e[0]=r*a+n*l,e[1]=s*a+o*l,e[2]=r*c+n*h,e[3]=s*c+o*h,e}function Sst(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=Math.sin(i),l=Math.cos(i);return e[0]=r*l+n*a,e[1]=s*l+o*a,e[2]=r*-a+n*l,e[3]=s*-a+o*l,e}function Est(e,t,i){const r=t[0],s=t[1],n=t[2],o=t[3],a=i[0],l=i[1];return e[0]=r*a,e[1]=s*a,e[2]=n*l,e[3]=o*l,e}function Cst(e,t){const i=Math.sin(t),r=Math.cos(t);return e[0]=r,e[1]=i,e[2]=-i,e[3]=r,e}function Ast(e,t){return e[0]=t[0],e[1]=0,e[2]=0,e[3]=t[1],e}function Rst(e){return"mat2("+e[0]+", "+e[1]+", "+e[2]+", "+e[3]+")"}function Mst(e){return Math.sqrt(e[0]**2+e[1]**2+e[2]**2+e[3]**2)}function Ost(e,t,i,r){return e[2]=r[2]/r[0],i[0]=r[0],i[1]=r[1],i[3]=r[3]-e[2]*i[1],[e,t,i]}function Pst(e,t,i){return e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2],e[3]=t[3]+i[3],e}function Dwe(e,t,i){return e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2],e[3]=t[3]-i[3],e}function Ist(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]&&e[3]===t[3]}function $st(e,t){const i=e[0],r=e[1],s=e[2],n=e[3],o=t[0],a=t[1],l=t[2],c=t[3];return Math.abs(i-o)<=Et*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(r-a)<=Et*Math.max(1,Math.abs(r),Math.abs(a))&&Math.abs(s-l)<=Et*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=Et*Math.max(1,Math.abs(n),Math.abs(c))}function Dst(e,t,i){return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e}function Lst(e,t,i,r){return e[0]=t[0]+i[0]*r,e[1]=t[1]+i[1]*r,e[2]=t[2]+i[2]*r,e[3]=t[3]+i[3]*r,e}const Nst=$we,Fst=Dwe;Object.freeze(Object.defineProperty({__proto__:null,copy:vst,identity:_st,set:rZ,transpose:bst,invert:wst,adjoint:xst,determinant:Tst,multiply:$we,rotate:Sst,scale:Est,fromRotation:Cst,fromScaling:Ast,str:Rst,frob:Mst,LDU:Ost,add:Pst,subtract:Dwe,exactEquals:Ist,equals:$st,multiplyScalar:Dst,multiplyScalarAndAdd:Lst,mul:Nst,sub:Fst},Symbol.toStringTag,{value:"Module"}));class Ust extends Or{constructor(t,i,r,s,n,o){super(t,i),this.path=r,this.geometrySR=s,this.upVectorAlignment=n,this.stencilWidth=o}}function Lwe(e){return"upVectorAlignment"in e}function Nwe(){return[1,0,0,1]}function kst(e){return[e[0],e[1],e[2],e[3]]}function zst(e,t,i,r){return[e,t,i,r]}function Vst(e,t){return new Float64Array(e,t,4)}Object.freeze(Object.defineProperty({__proto__:null,create:Nwe,clone:kst,fromValues:zst,createView:Vst},Symbol.toStringTag,{value:"Module"}));function pj(){return{up:O(),right:O()}}function Bst(e,t,i){Ue(e.up,t.up,i),Ue(e.right,t.right,i)}function Gst(e,t,i){hi(e,xe(i,t.right),xe(i,t.up))}class jst{constructor(){this.pos=O(),this.posES=O(),this.posGS=O(),this.vRight=O(),this.vLeft=O(),this.frame=pj(),this.rotationFrame=pj(),this.rotationRight=tt(),this.rotationAngle=0,this.miterStretch=Nwe()}setFrameFromUpVector(t){se(this.frame.up,t),de(qu,this.vLeft,this.vRight),we(qu,qu),oe(hd,this.frame.up,xe(qu,this.frame.up)),pe(PI,qu,hd),we(PI,PI),lt(this.frame.right,PI,this.frame.up)}computeRotationAxisAndAngleFromUpVector(){se(this.rotationFrame.up,this.frame.up),se(this.rotationFrame.right,this.frame.right),hi(this.rotationRight,1,0),oe(hd,this.frame.up,xe(this.frame.up,this.vLeft)),pe(hd,this.vLeft,hd),qo(hd,hd),we(hd,hd),oe(qu,this.frame.up,xe(this.frame.up,this.vRight)),pe(qu,this.vRight,qu),we(qu,qu),lt(fj,this.rotationFrame.up,this.vLeft);const t=Math.sign(xe(fj,this.vRight));if(this.rotationAngle=t*(Math.PI-tn(xe(hd,qu))),Math.abs(this.rotationAngle)>0){const r=ZV(Math.cos(.5*this.rotationAngle));rZ(this.miterStretch,r-1+1,0,0,1)}const i=Math.PI-this.rotationAngle;this.maxStretchDistance=Math.abs(Math.min(this.vLeftLength,this.vRightLength)/Math.cos(.5*i))}}class KM{constructor(){this.vertices=[],this.vertexIndices=[],this.vertexNormals=[],this.poles=[],this.poleIndices=[],this.uvs=null,this.uvIndices=null}addVertex(t,i){return this.vertices.push(eA(t)),this.vertexNormals.push(eA(i)),this.vertices.length-1}addUV(t){return this.uvs||(this.uvs=[],this.uvIndices=[]),this.uvs.push(t),this.uvs.length-1}addPole(t,i=null){return this.poles.push({position:eA(t),normal:i?eA(i):null}),this.poles.length-1}addSegment(t,i=null,r=null){this.vertexIndices.push(t.v0),this.vertexIndices.push(t.v1),i&&(this.uvIndices.push(i.v0),this.uvIndices.push(i.v1)),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.vertexIndices.length/2}hasUV(){return this.uvs!=null}translate(t,i){for(const r of this.vertices)r[0]+=t,r[1]+=i;for(const r of this.poles)r.position[0]+=t,r.position[1]+=i}static circle(t=20){const r=new KM,s={v0:0,v1:0};r.addPole(Oi(0,0));for(let a=0;a<t;++a){const l=2*a*Math.PI/t,c=Math.cos(l),h=Math.sin(l),p=Oi(c*.5,h*.5),f=Oi(c,h);r.addVertex(p,f),r.addUV(a/t)}r.addUV(1);for(let a=0;a<t-1;++a){const l={v0:a,v1:a+1},c=l;r.addSegment(l,c,s)}const n={v0:t-1,v1:0},o={v0:t-1,v1:t};return r.addSegment(n,o,s),r}static rect(){const r=new KM,s=Oi(.5*-1,.5*-1),n=Oi(.5*1,.5*-1),o=Oi(.5*1,.5*1),a=Oi(.5*-1,.5*1),l=Oi(0,-1),c=Oi(1,0),h=Oi(0,1),p=Oi(-1,0);r.addUV(0),r.addUV(1),r.addPole(Oi(0,.5*1),h),r.addPole(Oi(0,.5*1)),r.addPole(Oi(0,.5*-1)),r.addPole(Oi(0,.5*-1),l);const f={v0:0,v1:1};return r.addVertex(s,l),r.addVertex(n,l),r.addSegment({v0:0,v1:1},f,{v0:3,v1:3}),r.addVertex(n,c),r.addVertex(o,c),r.addSegment({v0:2,v1:3},f,{v0:2,v1:1}),r.addVertex(o,h),r.addVertex(a,h),r.addSegment({v0:4,v1:5},f,{v0:0,v1:0}),r.addVertex(a,p),r.addVertex(s,p),r.addSegment({v0:6,v1:7},f,{v0:1,v1:2}),r}}class Hst{constructor(t){this.vertices=[],this.offset=O(),this.xform=Ae(),this.vertices=t;const i=Math.floor((t.length-1)/2);se(this.offset,this.vertices[i].pos);for(const r of this.vertices)pe(r.pos,r.pos,this.offset);Aa(this.xform,this.xform,this.offset),this.updatePathVertexInformation()}updatePathVertexInformation(){const t=this.vertices.length;let i=this.vertices[0];i.index=0,ie(i.vLeft,0,0,0),i.vLeftLength=0,pe(i.vRight,this.vertices[1].pos,i.pos),i.vRightLength=Me(i.vRight),we(i.vRight,i.vRight);let r=i;for(let s=1;s<t;++s)i=this.vertices[s],i.index=s,se(i.vLeft,r.vRight),i.vLeftLength=r.vRightLength,s<t-1?(pe(i.vRight,this.vertices[s+1].pos,i.pos),i.vRightLength=Me(i.vRight),we(i.vRight,i.vRight)):(se(i.vRight,i.vLeft),i.vRightLength=i.vLeftLength),r=i}}function qst(e,t){let i=null;const r=e.vertices.length,s=.99619469809,n=O(),o=O(),a=O(),l=O(),c=O(),h=O(),p=gi();let f=e.vertices[0];se(o,t),ie(n,0,1,0),Nl.makeOrthoBasisDirUpFallback(f.vRight,o,n,n,a,o,s),se(f.frame.up,o),se(f.frame.right,a),i=f;for(let m=1;m<r;++m){f=e.vertices[m],de(c,f.vLeft,f.vRight);let y=Me(c);y>0?(y=1/Math.sqrt(y),c[0]=c[0]*y,c[1]=c[1]*y,c[2]=c[2]*y):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),de(h,i.pos,i.frame.up),qS(f.pos,c,p),gw(p,mu(h,f.vLeft),l)?(pe(l,l,f.pos),we(o,l),lt(a,c,o),we(a,a)):Nl.makeOrthoBasisDirUpFallback(c,i.frame.up,i.frame.right,n,a,o,s),se(f.frame.up,o),se(f.frame.right,a),i=f}}class Wst{numProfilesPerJoin(){return 1}extrude(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],!1)}}class Zz{constructor(t=.8*Math.PI,i=1){this.cutoffAngle=t,this.numBendSubdivisions=i}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(t,i,r){const s=ent;if(Math.abs(t.rotationAngle)>=this.cutoffAngle)for(let n=0;n<this.numBendSubdivisions+1;++n){pu(Cne,.5*-t.rotationAngle+n*t.rotationAngle/this.numBendSubdivisions,t.rotationFrame.up),Bst(s,t.frame,Cne);for(let o=0;o<i.vertices.length;++o)Bs(i.vertices[o],t.rotationRight)*t.rotationAngle>=0?r(t.index,s,i.vertices[o],i.vertexNormals[o],!1):(A7(sb,i.vertices[o],t.miterStretch),r(t.index,t.frame,sb,i.vertexNormals[o],!0))}else for(let n=0;n<this.numBendSubdivisions+1;++n)for(let o=0;o<i.vertices.length;++o){const a=Bs(i.vertices[o],t.rotationRight)*t.rotationAngle>=0;A7(sb,i.vertices[o],t.miterStretch),r(t.index,t.frame,sb,i.vertexNormals[o],!a)}}}const Xst={generateUV:!1};class sZ{rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],0,0)}}class Sne extends sZ{constructor(){super()}getNumVertices(){return 0}getNumIndices(){return 0}rebuildCapGeometry(){}buildTopology(){}}class OI extends sZ{constructor(t,i=0,r=!1){super(),this.profile=t,this.profilePlaneOffset=i,this.flip=r}getNumVertices(){return this.profile.vertices.length}getNumIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(t,i,r){for(let s=0;s<i.vertices.length;++s)r(t.index,t.frame,i.vertices[s],i.vertexNormals[s],this.profilePlaneOffset,0)}rebuildCapGeometry(t,i){const r=nZ;hi(r,0,0);const s=this.flip?1:-1;for(let n=0;n<this.profile.vertices.length;++n)i(t.index,t.frame,this.profile.vertices[n],r,this.profilePlaneOffset,s)}buildTopology(t,i){const r=this.vertexBufferStart+this.profile.vertexIndices[0];for(let s=1;s<this.profile.numSegments;++s){const n=this.profile.vertexIndices[2*s+0],o=this.profile.vertexIndices[2*s+1],a=this.vertexBufferStart+n,l=this.vertexBufferStart+o;this.flip?i(l,a,r):i(r,a,l)}}}class Ene extends sZ{constructor(t){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=t.profile,this.flip=t.flip,this.sign=this.flip?1:-1,this.breakNormals=t.breakNormals,this.numSegments=t.subdivisions}getNumVertices(){let t=0;return t=this.profile.vertices.length*(this.numSegments-1),this.breakNormals&&(t+=this.profile.vertices.length),t+=this.profile.poles.length,t}getNumIndices(){let t=0;t+=2*this.profile.numSegments*(this.numSegments-1);for(let i=0;i<this.profile.numSegments;++i){const r=this.profile.vertexIndices[2*i+0],s=this.profile.vertexIndices[2*i+1];this.profile.poleIndices[r]===this.profile.poleIndices[s]?t+=1:t+=2}return 3*t}rebuildCapGeometry(t,i){const r=t.frame,s=.5*this.sign,n=sb,o=nZ;hi(o,0,0);for(let a=0;a<this.profile.poles.length;++a){const l=this.profile.poles[a];l.normal?i(t.index,r,l.position,l.normal,s,0):i(t.index,r,l.position,o,s,this.sign)}if(this.breakNormals)for(let a=0;a<this.profile.vertices.length;++a)i(t.index,r,this.profile.vertices[a],this.profile.vertexNormals[a],0,0);for(let a=0;a<this.numSegments-1;++a){const l=(1-(a+1)/this.numSegments)*Math.PI*.5,c=Math.sin(l),h=Math.cos(l);for(let p=0;p<this.profile.vertices.length;++p){const f=this.profile.poles[this.profile.poleIndices[p]];rf(n,this.profile.vertices[p],f.position),jl(n,n,c),f.normal?(wd(n,n,f.position),i(t.index,r,n,f.normal,s*h,0)):(yM(o,n),jl(o,o,c),wd(n,n,f.position),i(t.index,r,n,o,s*h,this.sign*h))}}}buildTopology(t,i){const r=this.breakNormals?this.vertexBufferStart+this.profile.poles.length:this.firstProfileVertexIndex,s=this.breakNormals?this.vertexBufferStart+this.profile.poles.length+this.profile.vertices.length:this.vertexBufferStart+this.profile.poles.length;for(let n=0;n<this.profile.numSegments;++n){const o=this.profile.vertexIndices[2*n+0],a=this.profile.vertexIndices[2*n+1],l=this.vertexBufferStart+this.profile.poleIndices[o],c=this.vertexBufferStart+this.profile.poleIndices[a];let h=r+o,p=r+a;for(let f=0;f<this.numSegments-1;++f){const m=s+f*this.profile.vertices.length+o,y=s+f*this.profile.vertices.length+a;this.flip?(i(m,p,h),i(p,m,y)):(i(h,p,m),i(y,m,p)),h=m,p=y}this.flip?(i(l,p,h),l!==c&&i(l,c,p)):(i(h,p,l),l!==c&&i(p,c,l))}}}class Yst{constructor(t,i,r,s,n,o=Xst){this.options=o,this._extrusionVertexCount=0,this._triangleCount=0,this.numExtrusionProfiles=0,this.numVerticesTotal=0,this.numNormalsTotal=0,this.numUVTotal=0,this.profile=i,this.path=t,this.extruder=r,this.startCap=s,this.endCap=n;const a=this.path.vertices.length-2;this.numExtrusionProfiles=r.numProfilesPerJoin()*a+2,this.numVerticesTotal=i.vertices.length*this.numExtrusionProfiles,this.numNormalsTotal=this.numVerticesTotal,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.getNumVertices();this.numVerticesTotal+=l,this.numNormalsTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.getNumVertices();this.numVerticesTotal+=c,this.numNormalsTotal+=c,this.pathVertexData=new Float32Array(1*this.numVerticesTotal),this.profileRightAxisData=new Float32Array(4*this.numVerticesTotal),this.profileUpAxisData=new Float32Array(4*this.numVerticesTotal),this.profileVertexAndNormalData=new Float32Array(4*this.numVerticesTotal),this.profile.hasUV()&&this.options.generateUV&&(this.numUVTotal=this.profile.uvs.length,this.uvData=new Float32Array(2*this.numUVTotal)),this.originData=new Float32Array(3*this.path.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(t,i,r,s,n){if(this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,n){const o=this.path.vertices[t];this.profileRightAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[0]*o.maxStretchDistance,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o.rotationRight[1]*o.maxStretchDistance}else this.profileRightAxisData[4*this._extrusionVertexCount+3]=0,this.profileUpAxisData[4*this._extrusionVertexCount+3]=0;++this._extrusionVertexCount}emitCapVertex(t,i,r,s,n,o){this.profileRightAxisData[4*this._extrusionVertexCount+0]=i.right[0],this.profileRightAxisData[4*this._extrusionVertexCount+1]=i.right[1],this.profileRightAxisData[4*this._extrusionVertexCount+2]=i.right[2],this.profileUpAxisData[4*this._extrusionVertexCount+0]=i.up[0],this.profileUpAxisData[4*this._extrusionVertexCount+1]=i.up[1],this.profileUpAxisData[4*this._extrusionVertexCount+2]=i.up[2],this.profileVertexAndNormalData[4*this._extrusionVertexCount+0]=r[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+1]=r[1],this.profileVertexAndNormalData[4*this._extrusionVertexCount+2]=s[0],this.profileVertexAndNormalData[4*this._extrusionVertexCount+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=t,this.profileRightAxisData[4*this._extrusionVertexCount+3]=n,this.profileUpAxisData[4*this._extrusionVertexCount+3]=o,++this._extrusionVertexCount}emitTriangle(t,i,r){this.vertexIndices[3*this._triangleCount+0]=t,this.vertexIndices[3*this._triangleCount+1]=i,this.vertexIndices[3*this._triangleCount+2]=r,this.pathVertexIndices[3*this._triangleCount+0]=this.pathVertexData[t],this.pathVertexIndices[3*this._triangleCount+1]=this.pathVertexData[i],this.pathVertexIndices[3*this._triangleCount+2]=this.pathVertexData[r],this.normalIndices[3*this._triangleCount+0]=t,this.normalIndices[3*this._triangleCount+1]=i,this.normalIndices[3*this._triangleCount+2]=r,++this._triangleCount}_rebuildGeometry(){const t=(r,s,n,o,a)=>this.emitVertex(r,s,n,o,a),i=(r,s,n,o,a,l)=>this.emitCapVertex(r,s,n,o,a,l);this._extrusionVertexCount=0;for(const r of this.path.vertices)this.originData[3*r.index+0]=r.pos[0],this.originData[3*r.index+1]=r.pos[1],this.originData[3*r.index+2]=r.pos[2];this.startCap.rebuildConnectingProfileGeometry(this.path.vertices[0],this.profile,i);for(let r=1;r<this.path.vertices.length-1;++r)this.extruder.extrude(this.path.vertices[r],this.profile,t);if(this.endCap.rebuildConnectingProfileGeometry(this.path.vertices[this.path.vertices.length-1],this.profile,i),this.startCap.rebuildCapGeometry(this.path.vertices[0],i),this.endCap.rebuildCapGeometry(this.path.vertices[this.path.vertices.length-1],i),this.profile.hasUV()&&this.options.generateUV)for(let r=0;r<this.profile.uvs.length;++r)this.uvData[2*r+0]=this.profile.uvs[r],this.uvData[2*r+1]=0}buildTopology(){const t=(o,a,l)=>this.emitTriangle(o,a,l);this._triangleCount=0;const i=this.profile.vertices.length,r=this.profile.numSegments,s=this.numExtrusionProfiles-1;let n=3*(2*(r*s));this.startCap.indexBufferStart=n,this.startCap.firstProfileVertexIndex=0,n+=this.startCap.getNumIndices(),this.endCap.indexBufferStart=n,this.endCap.firstProfileVertexIndex=i*(this.numExtrusionProfiles-1),n+=this.endCap.getNumIndices(),this.vertexIndices=new Uint32Array(n),this.normalIndices=new Uint32Array(n),this.pathVertexIndices=new Uint32Array(n),this.profile.hasUV()&&this.options.generateUV&&(this.uvIndices=new Uint32Array(n));for(let o=0;o<r;++o){const a=this.profile.vertexIndices[2*o],l=this.profile.vertexIndices[2*o+1];for(let c=0;c<s;++c){const h=c*i+a,p=(c+1)*i+l,f=c*i+l;t(h,(c+1)*i+a,p),t(h,p,f)}}this.startCap.buildTopology(this.path.vertices[0],t),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],t)}onPathChanged(){this._rebuildGeometry()}}class Fwe{constructor(t){this.builder=t}get xform(){return this.builder.path.xform}onPathChanged(){this.builder.onPathChanged()}}class Uwe extends Fwe{constructor(t){super(t),this.vertexAttributePosition=null,this.vertexAttributeNormal=null,this.vertexAttributeColor=null,this.vertexAttributePosition=new Float32Array(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Float32Array(3*this.builder.numNormalsTotal),this.vertexAttributeColor=new Uint8Array(4),this.vertexAttributeColor[0]=255,this.vertexAttributeColor[1]=255,this.vertexAttributeColor[2]=255,this.vertexAttributeColor[3]=255}bakeVertexColors(t){this.vertexAttributeColor[0]=255*t[0],this.vertexAttributeColor[1]=255*t[1],this.vertexAttributeColor[2]=255*t[2],this.vertexAttributeColor[3]=255*(t.length>3?t[3]:1)}bake(t){this.size=t;for(let i=0;i<this.builder.numVerticesTotal;++i){let r=this.builder.pathVertexData[i];const s=r===0||r===this.builder.path.vertices.length-1;r*=3;const n=Qst;ie(n,this.builder.originData[r++],this.builder.originData[r++],this.builder.originData[r]);const o=4*i,a=hd,l=sb,c=qu,h=fj,p=Kst;let f=0,m=0;if(ie(h,this.builder.profileRightAxisData[o],this.builder.profileRightAxisData[o+1],this.builder.profileRightAxisData[o+2]),ie(p,this.builder.profileUpAxisData[o],this.builder.profileUpAxisData[o+1],this.builder.profileUpAxisData[o+2]),hi(l,this.builder.profileVertexAndNormalData[o]*t[0],this.builder.profileVertexAndNormalData[o+1]*t[1]),s)lt(c,p,h),f=this.builder.profileRightAxisData[o+3]*t[0],m=this.builder.profileUpAxisData[o+3];else{const v=nZ,w=Jst;hi(v,this.builder.profileRightAxisData[o+3],this.builder.profileUpAxisData[o+3]);const b=CX(v);yM(v,v);const S=Bs(l,v);if(Math.abs(S)>b){hi(w,-v[1],v[0]);const T=Bs(l,w);jl(v,v,b*Math.sign(S)),jl(w,w,T),wd(l,v,w)}ie(c,0,0,0)}ie(a,h[0]*l[0]+p[0]*l[1],h[1]*l[0]+p[1]*l[1],h[2]*l[0]+p[2]*l[1]),this.vertexAttributePosition[3*i+0]=n[0]+a[0]+c[0]*f,this.vertexAttributePosition[3*i+1]=n[1]+a[1]+c[1]*f,this.vertexAttributePosition[3*i+2]=n[2]+a[2]+c[2]*f;const y=sb;hi(y,this.builder.profileVertexAndNormalData[o+2],this.builder.profileVertexAndNormalData[o+3]),this.vertexAttributeNormal[3*i+0]=h[0]*y[0]+p[0]*y[1]+c[0]*m,this.vertexAttributeNormal[3*i+1]=h[1]*y[0]+p[1]*y[1]+c[1]*m,this.vertexAttributeNormal[3*i+2]=h[2]*y[0]+p[2]*y[1]+c[2]*m}}createGeometryData(){const t=[[A.POSITION,this.builder.vertexIndices],[A.NORMAL,this.builder.normalIndices]],i=[[A.POSITION,{size:3,data:this.vertexAttributePosition,exclusive:!0}],[A.NORMAL,{size:3,data:this.vertexAttributeNormal,exclusive:!0}]];if(this.vertexAttributeColor){const r=this.builder.vertexIndices.length;t.push([A.COLOR,new Uint32Array(r)]),i.push([A.COLOR,{size:4,data:this.vertexAttributeColor}])}return{vertexAttributes:i,indices:t}}onPathChanged(){super.onPathChanged(),this.bake(this.size)}intersect(t,i,r){const s=this.builder.vertexIndices,n={size:3,data:this.vertexAttributePosition},o=s.length/3;XO(t,i,0,o,s,n,void 0,void 0,r)}}class Zst extends Fwe{constructor(t,i,r,s){super(t),this.sizeAttributeValue=i,this.colorAttributeValue=r,this.opacityAttributeValue=s,this.vvData=null,this.baked=new Uwe(t),this.vvData=new Float32Array(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n+0]=i,this.vvData[4*n+1]=r,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return{vertexAttributes:[[A.POSITION,{size:3,data:this.builder.originData,exclusive:!0}],[A.PROFILERIGHT,{size:4,data:this.builder.profileRightAxisData,exclusive:!0}],[A.PROFILEUP,{size:4,data:this.builder.profileUpAxisData,exclusive:!0}],[A.PROFILEVERTEXANDNORMAL,{size:4,data:this.builder.profileVertexAndNormalData,exclusive:!0}],[A.FEATUREVALUE,{size:4,data:this.vvData,exclusive:!0}]],indices:[[A.POSITION,this.builder.pathVertexIndices],[A.PROFILERIGHT,this.builder.vertexIndices],[A.PROFILEUP,this.builder.vertexIndices],[A.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[A.FEATUREVALUE,this.builder.pathVertexIndices]]}}}const Qst=O(),sb=tt(),nZ=tt(),Jst=tt(),hd=O(),qu=O(),fj=O(),Kst=O(),PI=O(),ent=pj(),Cne=Ae(),Qz=8;function tnt(e,t){e.attributes.add(A.FEATUREVALUE,"vec4");const i=e.vertex;i.code.add(x`bool isCapVertex() {
return featureValue.w == 1.0;
}`),i.uniforms.add(new di("size",r=>r.size)),t.vvSize?(i.uniforms.add(new xt("vvSizeMinSize",r=>r.vvSizeMinSize)),i.uniforms.add(new xt("vvSizeMaxSize",r=>r.vvSizeMaxSize)),i.uniforms.add(new xt("vvSizeOffset",r=>r.vvSizeOffset)),i.uniforms.add(new xt("vvSizeFactor",r=>r.vvSizeFactor)),i.code.add(x`vec2 getSize() {
return size * clamp(vvSizeOffset + featureValue.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
}`)):i.code.add(x`vec2 getSize(){
return size;
}`),t.vvOpacity?(i.constants.add("vvOpacityNumber","int",Qz),i.uniforms.add([new jo("vvOpacityValues",r=>r.vvOpacityValues,Qz),new jo("vvOpacityOpacities",r=>r.vvOpacityOpacities,Qz)]),i.code.add(x`vec4 applyOpacity(vec4 color) {
float value = featureValue.z;
if (value <= vvOpacityValues[0]) {
return vec4( color.xyz, vvOpacityOpacities[0]);
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
}
}
return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
}`)):i.code.add(x`vec4 applyOpacity(vec4 color){
return color;
}`),t.vvColor?(i.constants.add("vvColorNumber","int",Gd),i.uniforms.add([new jo("vvColorValues",r=>r.vvColorValues,Gd),new $5("vvColorColors",r=>r.vvColorColors,Gd)]),i.code.add(x`vec4 getColor() {
float value = featureValue.y;
if (value <= vvColorValues[0]) {
return applyOpacity(vvColorColors[0]);
}
for (int i = 1; i < vvColorNumber; ++i) {
if (vvColorValues[i] >= value) {
float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
}
}
return applyOpacity(vvColorColors[vvColorNumber - 1]);
}`)):i.code.add(x`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),e.include(W5),e.attributes.add(A.PROFILERIGHT,"vec4"),e.attributes.add(A.PROFILEUP,"vec4"),e.attributes.add(A.PROFILEVERTEXANDNORMAL,"vec4"),i.code.add(x`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),i.code.add(x`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),i.code.add(x`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),i.code.add(x`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}class int extends $Y{constructor(){super(...arguments),this.size=Oi(1,1)}}function rnt(e){const t=new Bi,i=ou(t,e),{vertex:r,fragment:s}=t;return t.varyings.add("vpos","vec3"),t.include(tnt,e),e.output!==J.Color&&e.output!==J.Alpha||(t.include(To),t.include(tw,e),t.include(s3,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vcolor","vec4"),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.code.add(x`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${e.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${e.output===J.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),t.include(yu,e),e.output===J.Alpha&&(t.include(ls,e),s.uniforms.add(new We("opacity",n=>n.opacity)),s.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        gl_FragColor = vec4(combinedOpacity);
      }
    `)),e.output===J.Color&&(t.include(ls,e),t.include(iw,e),t.include(a3,e),t.include(tw,e),t.include(Bbe,e),Mf(s,e),s.uniforms.add([i,new xt("ambient",n=>n.ambient),new xt("diffuse",n=>n.diffuse),new xt("specular",n=>n.specular),new We("opacity",n=>n.opacity),new We("lightingGlobalFactor",(n,o)=>o.lighting.globalFactor),new xt("lightingMainIntensity",(n,o)=>o.lighting.mainLight.intensity)]),s.constants.add("ambientBoostFactor","float",nE),s.include(Vf),s.code.add(x`
      void main() {
        discardBySlice(vpos);
        ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        shadingParams.normalView = vnormal;
        vec3 normal = shadingNormal(shadingParams);
        float ssao = evaluateAmbientOcclusionInverse();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${e.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":e.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
        float combinedOpacity = vcolor.a * opacity;
        albedo += 0.25 * specular; // don't completely ignore specular for now

        vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
        gl_FragColor = vec4(shadedColor, combinedOpacity);
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
        ${e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==J.Depth&&e.output!==J.Shadow||(t.include(To,{hasModelTransformation:!1,linearDepth:!0}),r.uniforms.add(new di("nearFar",(n,o)=>o.camera.nearFar)),t.varyings.add("depth","float"),r.code.add(x`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),t.include(ls,e),t.include(Bv,e),s.code.add(x`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`)),e.output===J.Normal&&(t.include(To),t.include(X0,e),r.uniforms.add(new vr("viewNormal",(n,o)=>o.camera.viewInverseTransposeMatrix)),t.varyings.add("vnormal","vec3"),r.code.add(x`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(ls,e),s.uniforms.add(new xa("waterColor")),s.code.add(x`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`)),e.output===J.Highlight&&(t.include(To),t.include(X0,e),t.varyings.add("vnormal","vec3"),r.code.add(x`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),t.include(ls,e),t.include(Bg),s.code.add(x`void main() {
discardBySlice(vpos);
outputHighlight();
}`)),t}const snt=Object.freeze(Object.defineProperty({__proto__:null,build:rnt},Symbol.toStringTag,{value:"Module"})),kwe=new Map([[A.POSITION,0],[A.PROFILERIGHT,1],[A.PROFILEUP,2],[A.PROFILEVERTEXANDNORMAL,3],[A.FEATUREVALUE,4]]);class nnt extends int{constructor(){super(...arguments),this.ambient=Fe(.2,.2,.2),this.diffuse=Fe(.8,.8,.8),this.specular=Fe(0,0,0),this.opacity=1}}class uU extends lr{initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global,i.doublePrecisionRequiresObfuscation=r3(t.rctx)}initializeProgram(t){const i=uU.shader.get().build(this.configuration);return new Ji(t.rctx,i,kwe)}_setPipelineState(t){const i=this.configuration,r=t===gt.NONE,s=t===gt.FrontFace,n=o=>!o.hasSlicePlane&&!(o.transparent||o.doubleSidedMode===Lr.None);return Ut({blending:i.output!==J.Color&&i.output!==J.Alpha||!i.transparent?null:r?au:Gg(t),culling:n(i)&&L0e,depthTest:{func:Vv(t)},depthWrite:r||s?pl:null,colorWrite:Jt,stencilWrite:i.hasOccludees?Pf:null,stencilTest:i.hasOccludees?Gv:null,polygonOffset:r||s?null:N5})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}uU.shader=new Qi(snt,()=>import("./Path.glsl.243f0fa9.js"));class _n extends Ho{constructor(){super(...arguments),this.output=J.Color,this.doubleSidedMode=Lr.None,this.transparencyPassType=gt.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}}u([G({count:J.COUNT})],_n.prototype,"output",void 0),u([G({count:Lr.COUNT})],_n.prototype,"doubleSidedMode",void 0),u([G({count:gt.COUNT})],_n.prototype,"transparencyPassType",void 0),u([G()],_n.prototype,"spherical",void 0),u([G()],_n.prototype,"receiveShadows",void 0),u([G()],_n.prototype,"receiveAmbientOcclusion",void 0),u([G()],_n.prototype,"vvSize",void 0),u([G()],_n.prototype,"vvColor",void 0),u([G()],_n.prototype,"vvOpacity",void 0),u([G()],_n.prototype,"hasSlicePlane",void 0),u([G()],_n.prototype,"transparent",void 0),u([G()],_n.prototype,"hasOccludees",void 0),u([G()],_n.prototype,"hasMultipassTerrain",void 0),u([G()],_n.prototype,"cullAboveGround",void 0),u([G()],_n.prototype,"doublePrecisionRequiresObfuscation",void 0),u([G({constValue:Rt.Disabled})],_n.prototype,"pbrMode",void 0),u([G({constValue:!0})],_n.prototype,"hasVvInstancing",void 0),u([G({constValue:!1})],_n.prototype,"useCustomDTRExponentForWater",void 0),u([G({constValue:!1})],_n.prototype,"useFillLights",void 0);class oZ extends Gf{constructor(t){super(t,new ant),this.supportsEdges=!0,this._vertexAttributeLocations=kwe,this._configuration=new _n,this.vertexBufferLayout=oZ.getVertexBufferLayout(this.parameters)}getConfiguration(t,i){return this._configuration.output=t,this._configuration.vvSize=this.parameters.vvSizeEnabled,this._configuration.vvColor=this.parameters.vvColorEnabled,this._configuration.vvOpacity=this.parameters.vvOpacityEnabled,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,t!==J.Color&&t!==J.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?Lr.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?Lr.WindingOrder:Lr.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!i.ssaoHelper.ready&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=i.transparencyPassType,this._configuration.hasMultipassTerrain=i.multipassTerrain.enabled,this._configuration.cullAboveGround=i.multipassTerrain.cullAboveGround,this._configuration}isVisibleInPass(t){return t!==je.MATERIAL_DEPTH_SHADOWMAP_ALL&&t!==je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT&&t!==je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||this.parameters.castShadows}isVisible(){const t=this.parameters;return!!super.isVisible()&&t.opacity>0}intersect(t,i,r,s,n,o,a){const l=t;if(!Lwe(l))return;const c=l.path,h=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSizeEnabled){const b=this.parameters.vvSizeOffset,S=this.parameters.vvSizeFactor,T=this.parameters.vvSizeMinSize,E=this.parameters.vvSizeMaxSize,C=c.sizeAttributeValue;h[0]*=$e(b[0]+C*S[0],T[0],E[0]),h[1]*=$e(b[2]+C*S[2],T[2],E[2])}const p=Math.max(h[0],h[1]),f=t.boundingInfo;if(R(f))return void this._intersectTriangles(c,h,n,o,a);const m=Pb(f.bbMin[0]-p,f.bbMin[1]-p,f.bbMin[2]-p,f.bbMax[0]+p,f.bbMax[1]+p,f.bbMax[2]+p),y=[o[0]-n[0],o[1]-n[1],o[2]-n[2]],v=Math.sqrt(y[0]*y[0]+y[1]*y[1]+y[2]*y[2]),w=[v/y[0],v/y[1],v/y[2]];AY(m,n,w,s.tolerance)&&this._intersectTriangles(c,h,n,o,a)}_intersectTriangles(t,i,r,s,n){t.baked.size&&t.baked.size[0]===i[0]&&t.baked.size[1]===i[1]||t.baked.bake(i),t.baked.intersect(r,s,n)}computeAttachmentOrigin(t,i){const r=t.vertexAttributes;if(!r)return null;const s=r.get(A.POSITION);return KX(s,null,!1,i)}createBufferWriter(){return new lnt(this.vertexBufferLayout)}requiresSlot(t){return t===(this.parameters.transparent?Se.TRANSPARENT_MATERIAL:Se.OPAQUE_MATERIAL)||t===Se.DRAPED_MATERIAL}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Depth||t.output===J.Normal||t.output===J.Highlight||t.output===J.Shadow&&this.parameters.castShadows?new ont(t):null}static getVertexBufferLayout(t){let i=Kr().vec3f(A.POSITION).vec4f(A.PROFILERIGHT).vec4f(A.PROFILEUP).vec4f(A.PROFILEVERTEXANDNORMAL);return(t.vvColorEnabled||t.vvSizeEnabled||t.vvOpacityEnabled)&&(i=i.vec4f(A.FEATUREVALUE)),i}}class ont extends kv{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}_updateShadowState(t){(R(this.technique)||t.shadowMap.enabled!==this.technique.configuration.receiveShadows)&&this._material.setParameters({receiveShadows:t.shadowMap.enabled})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||(this._updateShadowState(t),this._updateOccludeeState(t)),this.ensureTechnique(uU,t)}}class ant extends nnt{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}}class lnt{constructor(t){this.vertexBufferLayout=t}allocate(t){return this.vertexBufferLayout.createBuffer(t)}elementCount(t){return t.indices.get(A.POSITION).length}write(t,i,r,s){const n=o=>{if(i.vertexAttributes.has(o)){const a=i.vertexAttributes.get(o),l=i.indices.get(o);dt(a.size===4);const c=r.getField(o,On);if(!c)throw new Error("unable to acquire view for "+o);T2(l,a.data,c,s)}};n(A.PROFILERIGHT),n(A.PROFILEUP),n(A.PROFILEVERTEXANDNORMAL),this.vertexBufferLayout.hasField(A.FEATUREVALUE)&&n(A.FEATUREVALUE),I5(i,this.vertexBufferLayout,t.transformation,t.invTranspTransformation,r,s)}}const cnt=["polyline"];class unt extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._intrinsicSize=Oi(1,1),this.upVectorAlignment="path",this.stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const t=_(this.symbolLayer.width)?this.symbolLayer.width:this.symbolLayer.height,i=_(this.symbolLayer.height)?this.symbolLayer.height:t;this._vvConvertOptions={modelSize:[1,1,1],symbolSize:[t,1,i],unitInMeters:this._context.renderCoordsHelper.unitInMeters,transformation:{anchor:[0,0,0],scale:[1,1,1],rotation:[0,0,0]},supportedTypes:{size:!0,color:!0,opacity:!0,rotation:!1}},this._context.renderer&&this._context.renderer.visualVariables&&this._context.renderer.visualVariables.length>0?this._fastUpdates=ZM(this._context.renderer,this._vvConvertOptions):this._fastUpdates={enabled:!1};const r=this.symbolLayer.anchor||"center";this.upVectorAlignment="path",this.symbolLayer.profileRotation==="heading"&&(this.upVectorAlignment="world");const s=this.symbolLayer.profile||"circle";switch(s){case"circle":default:this._profile=KM.circle(mnt);break;case"quad":this._profile=KM.rect()}let n=[0,0];switch(r!=="center"&&(n={left:[.5,0],right:[-.5,0],top:[0,-.5],bottom:[0,.5]}[r],this._profile.translate(n[0],n[1])),this.symbolLayer.join||"simple"){case"round":this._extruder=new Zz(0,fnt);break;case"bevel":this._extruder=new Zz(0,1);break;case"miter":this._extruder=new Zz(.8*Math.PI,1);break;default:this._extruder=new Wst}const o=this.symbolLayer.cap||"butt";switch(o){case"none":this._startCap=new Sne,this._endCap=new Sne;break;case"butt":default:this._startCap=new OI(this._profile,0),this._endCap=new OI(this._profile,0,!0);break;case"square":this._startCap=new OI(this._profile,-.5),this._endCap=new OI(this._profile,.5,!0);break;case"round":{const m=s==="quad";this._startCap=new Ene({profile:this._profile,flip:!1,breakNormals:m,subdivisions:Mne}),this._endCap=new Ene({profile:this._profile,flip:!0,breakNormals:m,subdivisions:Mne});break}}const a=Yr(this.symbolLayer,"material","color"),l=this._getCombinedOpacityAndColor(a),c=Ya(l),h=l[3],p=h<1||this.needsDrivenTransparentPass,f={diffuse:c,ambient:c,opacity:h,transparent:p,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:p||o==="none"?or.None:or.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(hi(this._intrinsicSize,t,i),!vF(this._intrinsicSize[0])||!vF(this._intrinsicSize[1])))throw new q("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates.enabled&&this._fastUpdates.visualVariables.size||jl(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates.enabled){const m=ve(F(F({},f),this._fastUpdates.materialParameters),{size:Yde(this._intrinsicSize)});this._material=new oZ(m)}else f.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,this._material=new rw(f);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,cnt,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new _u),s=t.renderingInfo;return this._createAs3DShape(i,s,r,i.uid)}layerOpacityChanged(){const t=Yr(this.symbolLayer,"material","color"),i=this._getCombinedOpacity(t),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({opacity:i,transparent:r}),!0}layerElevationInfoChanged(t,i){return this.updateGraphics3DGraphicElevationInfo(t,i,Rv)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}pixelRatioChanged(){return!0}applyRendererDiff(t,i){for(const r in t.diff){if(r!=="visualVariables"||!QM(this._fastUpdates,i,this._vvConvertOptions))return Qs.Recreate_Symbol;this._material.setParameters(this._fastUpdates.materialParameters)}return Qs.Fast_Update}getVertexData(t){let i=0;const r=t.paths,s=[],n=t.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const m of r)i+=m.length;const l=new Float64Array(3*i),c=new Float64Array(3*i),h=new Float64Array(3*i);let p=0;for(const m of r){s.push({index:p,numVertices:m.length});for(const y of m)l[p++]=y[0],l[p++]=y[1],l[p++]=t.hasZ?y[2]:0}let f=!0;return n.equals(o)?this._copyVertices(l,0,c,0,i):f=ar(l,n,0,c,o,0,i),o.equals(a)?this._copyVertices(c,0,h,0,i):ar(c,o,0,h,a,0,i),{pathVertexDataInfos:s,vertexDataGS:l,vertexDataES:c,vertexDataRS:h,projectionSuccess:f,terrainElevation:0}}_copyVertices(t,i,r,s,n){i*=3,s*=3;for(let o=0;o<n;++o)r[s++]=t[i++],r[s++]=t[i++],r[s++]=t[i++]}_createAs3DShape(t,i,r,s){const n=t.geometry,o=new Array,a=new Array,l=new Array,c=n.spatialReference,h=Ls(),p=this._context.renderCoordsHelper;Vwe.spatialReference=c;const f=this.getVertexData(n);if(!f.projectionSuccess)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(f.pathVertexDataInfos.length>0){for(let m=0;m<f.pathVertexDataInfos.length;++m){const y=f.pathVertexDataInfos[m],v=y.index,w=y.numVertices;if(w<2||_(this._context.clippingExtent)&&(cr(h),Kc(h,f.vertexDataES,3*v,w),!$d(h,this._context.clippingExtent)))continue;const b=[];for(let N=v;N<v+3*w;){const D=N++,z=N++,V=N++,k=new jst;ie(k.posGS,f.vertexDataGS[D],f.vertexDataGS[z],f.vertexDataGS[V]),ie(k.posES,f.vertexDataES[D],f.vertexDataES[z],f.vertexDataES[V]);const Y=rJe(k.posES,this._context.elevationProvider,r,p);ie(fh,f.vertexDataRS[D],f.vertexDataRS[z],f.vertexDataRS[V]),p.setAltitude(fh,Y),ie(k.pos,fh[0],fh[1],fh[2]),b.push(k)}const S=new Hst(b);zwe(S,this.upVectorAlignment,this._context.renderCoordsHelper);const T=new Yst(S,this._profile,this._extruder,this._startCap,this._endCap);let E=null;if(this._fastUpdates.enabled){const N=this._fastUpdates.visualVariables,D=N.size?cg(N.size.field,t):0,z=N.color?cg(N.color.field,t):0,V=N.opacity?cg(N.opacity.field,t):0;E=new Zst(T,D,z,V)}else{const N=[this._intrinsicSize[0],this._intrinsicSize[1]];this._drivenProperties.size&&(N[0]*=Ane(i.size[0],i.size[2]==="symbol-value"?this.symbolLayer.height||0:i.size[2],this.symbolLayer.width||0),N[1]*=Ane(i.size[2],i.size[0]==="symbol-value"?this.symbolLayer.width||0:i.size[0],this.symbolLayer.height||0));let D=null;this._drivenProperties.color&&(D=i.color),this._drivenProperties.opacity&&i.opacity!=null&&(D=D?[D[0],D[1],D[2],i.opacity]:[1,1,1,i.opacity]);const z=new Uwe(T);z.bake(N),D&&z.bakeVertexColors(D),E=z}const{vertexAttributes:C,indices:M}=E.createGeometryData(),I=new Ust(C,M,E,c,this.upVectorAlignment,this.stencilWidth);o.push(I),a.push(this._material),l.push(E.xform)}if(o.length>0){const m={layerUid:this._context.layer.uid,graphicUid:s},y=new Hg({geometries:o,materials:a,transformations:l,metadata:m}),v=new jf(this,y,o,null,null,dnt,r);return v.alignedSampledElevation=f.terrainElevation,v.needsElevationUpdates=Rv(r.mode),v}}else n.paths.length!==0&&n.paths.some(m=>m.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)");return null}}function zwe(e,t,i){switch(t){case"world":for(const r of e.vertices)de(yp,r.pos,e.offset),i.worldUpAtPosition(yp,fh),r.setFrameFromUpVector(fh),r.computeRotationAxisAndAngleFromUpVector();break;case"path":de(yp,e.vertices[0].pos,e.offset),i.worldUpAtPosition(yp,fh),qst(e,fh);for(const r of e.vertices){const s=Math.sign(xe(r.frame.right,r.vRight));lt(r.rotationFrame.up,r.vRight,r.vLeft),oe(r.rotationFrame.up,r.rotationFrame.up,s),we(r.rotationFrame.up,r.rotationFrame.up);const n=xe(r.rotationFrame.up,r.frame.up),o=xe(r.rotationFrame.up,r.frame.right);if(oe(yp,r.frame.up,-o),oe(Rne,r.frame.right,n),de(yp,yp,Rne),we(r.rotationFrame.right,yp),Gst(r.rotationRight,r.frame,r.rotationFrame.right),qo(yp,r.vLeft),r.rotationAngle=-s*(Math.PI-tn(xe(yp,r.vRight))),Math.abs(r.rotationAngle)>0){const l=ZV(Math.cos(.5*r.rotationAngle));rZ(r.miterStretch,1+(l-1)*r.rotationRight[0]*r.rotationRight[0],(l-1)*r.rotationRight[0]*r.rotationRight[1],(l-1)*r.rotationRight[0]*r.rotationRight[1],1+(l-1)*r.rotationRight[1]*r.rotationRight[1])}const a=Math.PI-r.rotationAngle;r.maxStretchDistance=Math.abs(Math.min(r.vLeftLength,r.vRightLength)*ZV(Math.cos(.5*a)))}}}function Ane(e,t,i){switch(e){case"symbol-value":return i;case"proportional":return t;default:return e}}function hnt(e,t,i,r){let s=0;for(const n of e.vertices)Mg(n.posES,i,t,r,Jz),s+=Jz.sampledElevation,de(fh,n.pos,e.offset),r.setAltitude(fh,Jz.z),pe(n.pos,fh,e.offset);return e.updatePathVertexInformation(),s/e.vertices.length}function dnt(e,t,i,r){const s=e.stageObject,n=s.geometryRecords;let o=0;pnt.spatialReference=r.spatialReference;for(const a of n){const l=a.geometry;if(!Lwe(l))continue;const c=l.path,h=c.builder.path,p=l.geometrySR;Vwe.spatialReference=p,o+=hnt(h,t,i,r),l.upVectorAlignment!=="world"&&zwe(h,l.upVectorAlignment,r),c.onPathChanged(),l.invalidateBoundingInfo(),s.geometryVertexAttrsUpdated(a)}return o/n.length}const pnt=jg(0,0,0,null),Vwe=jg(0,0,0,null),fh=O(),yp=wi(),Rne=wi(),Jz=new e3,fnt=3,Mne=3,mnt=10;function gnt(e,t,i,r,s=1){if(i.isGeographic&&r===Ve.Global){const a=new Float64Array(t.typedBuffer.length),l=3*t.count,c=vi(i);for(let h=0;h<l;h+=3)Fq(t.typedBuffer,h,a,h,c);t=vs.fromTypedArray(a)}hi(js,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let a=0;a<t.count;a++)t.getVec(a,Bl),js[0]=Math.min(js[0],Bl[0]),js[1]=Math.min(js[1],Bl[1]);const n=js[0]%s,o=js[1]%s;ch[0]=js[0]-n,ch[1]=js[1]-o;for(let a=0;a<t.count;a++)t.getVec(a,Bl),e.setValues(a,(Bl[0]-ch[0])/s,(Bl[1]-ch[1])/s,ch[0]/s,ch[1]/s)}function Bwe(e,t,i,r,s=1){ie(__,1,0,0),ie(b_,0,1,0),ie(ax,0,0,1),_nt(Kz,t),ynt(t,One)&&vnt(One,__,b_,ax,i,Kz),hi(js,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),hi(w_,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let l=0;l<t.count;l++){t.getVec(l,Bl);const c=xe(__,Bl),h=xe(b_,Bl);js[0]=Math.min(js[0],c),js[1]=Math.min(js[1],h),w_[0]=Math.max(w_[0],c),w_[1]=Math.max(w_[1],h)}const n=xe(ax,Kz);tV(dy,js[0],js[1],n,__,b_,ax),tV(x_,w_[0],js[1],n,__,b_,ax),tV(T_,js[0],w_[1],n,__,b_,ax),pe(x_,x_,dy),oe(x_,x_,.5),pe(T_,T_,dy),oe(T_,T_,.5),de(dy,dy,x_),de(dy,dy,T_);const o=js[0]%s,a=js[1]%s;ch[0]=js[0]-o,ch[1]=js[1]-a;for(let l=0;l<t.count;l++){t.getVec(l,Bl),e.setValues(l,(xe(__,Bl)-ch[0])/s,(xe(b_,Bl)-ch[1])/s,ch[0]/s,ch[1]/s);for(let c=0;c<3;c++)r.set(l,c,dy[c]),r.set(l,c+3,x_[c]),r.set(l,c+6,T_[c])}}const Kz=O(),Bl=O(),One=gi(),__=O(),b_=O(),ax=O(),js=tt(),w_=tt(),ch=tt(),dy=O(),x_=O(),T_=O();function ynt(e,t){const i=e.count-1;return wpe(e,t,0,Math.floor(i/3),Math.floor(i*(2/3)))}function vnt(e,t,i,r,s,n){_(s)?(s.basisMatrixAtPosition(n,vp),ie(II,vp[0],vp[1],vp[2]),ie($I,vp[4],vp[5],vp[6]),ie(eV,vp[8],vp[9],vp[10])):(ie(II,1,0,0),ie($I,0,1,0),ie(eV,0,0,1));const o=e;xe(o,eV)<0&&oe(o,o,-1),se(r,o);const a=xe(o,$I),l=xe(o,II);Math.abs(a)<Math.abs(l)?(j1(t,II,o,-l),we(t,t),lt(i,t,o),we(i,i),oe(i,i,-1)):(j1(i,$I,o,-a),we(i,i),lt(t,i,o),we(t,t))}const vp=Ae(),II=O(),$I=O(),eV=O();function _nt(e,t){ie(DI,0,0,0);for(let i=0;i<t.count-1;i++)t.getVec(i,Bl),de(DI,DI,Bl);oe(e,DI,1/(t.count-1))}const DI=O();function tV(e,t,i,r,s,n,o){ie(e,t*s[0]+i*n[0]+r*o[0],t*s[1]+i*n[1]+r*o[1],t*s[2]+i*n[2]+r*o[2])}function bnt(e){const t=new Bi,i=e.output===J.Depth,r=e.hasMultipassTerrain&&(e.output===J.Color||e.output===J.Alpha);ou(t,e),t.include(To,{hasModelTransformation:!1,linearDepth:i}),t.include(Tw,e),t.attributes.add(A.POSITION,"vec3"),t.varyings.add("vpos","vec3"),r&&t.varyings.add("depth","float");const{vertex:s,fragment:n}=t;return i&&(t.include(Bv,e),s.uniforms.add(new di("nearFar",(o,a)=>a.camera.nearFar)),t.varyings.add("linearDepth","float")),s.code.add(x`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      ${r?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${i?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(ls,e),r&&t.include(yu,e),n.include(Vf),n.uniforms.add(new ei("eColor",o=>o.color)),e.output===J.Highlight&&t.include(Bg),n.code.add(x`
  void main() {
    discardBySlice(vpos);
    ${r?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = ${e.hasVertexColors?"vColor * eColor;":"eColor;"}

    if (fColor.a < ${x.float(Eo)}) {
      discard;
    }

    ${e.output===J.Alpha?x`gl_FragColor = vec4(fColor.a);`:""}

    ${e.output===J.Color?x`gl_FragColor = highlightSlice(fColor, vpos); ${e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
    ${e.output===J.Highlight?x`outputHighlight();`:""};
    ${e.output===J.Depth?x`outputDepth(linearDepth);`:""};
  }
  `),t}const wnt=Object.freeze(Object.defineProperty({__proto__:null,build:bnt},Symbol.toStringTag,{value:"Module"}));class hU extends lr{initializeProgram(t){const i=hU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}_createPipeline(t,i){const r=this.configuration,s=t===gt.NONE,n=t===gt.FrontFace;return Ut({blending:r.output!==J.Color&&r.output!==J.Alpha||!r.transparent?null:s?au:Gg(t),culling:h5(r.cullFace),depthTest:{func:Vv(t)},depthWrite:s||n?r.writeDepth&&pl:null,colorWrite:Jt,stencilWrite:r.hasOccludees?Pf:null,stencilTest:r.hasOccludees?i?Ov:Gv:null,polygonOffset:s||n?r.polygonOffset&&xnt:F5(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}hU.shader=new Qi(wnt,()=>import("./ColorMaterial.glsl.a4987a44.js"));const xnt={factor:1,units:1};class Mc extends Ho{constructor(){super(...arguments),this.output=J.Color,this.cullFace=or.None,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.transparencyPassType=gt.NONE,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}u([G({count:J.COUNT})],Mc.prototype,"output",void 0),u([G({count:or.COUNT})],Mc.prototype,"cullFace",void 0),u([G()],Mc.prototype,"hasSlicePlane",void 0),u([G()],Mc.prototype,"hasVertexColors",void 0),u([G()],Mc.prototype,"transparent",void 0),u([G()],Mc.prototype,"polygonOffset",void 0),u([G()],Mc.prototype,"enableOffset",void 0),u([G()],Mc.prototype,"writeDepth",void 0),u([G()],Mc.prototype,"hasOccludees",void 0),u([G({count:gt.COUNT})],Mc.prototype,"transparencyPassType",void 0),u([G()],Mc.prototype,"hasMultipassTerrain",void 0),u([G()],Mc.prototype,"cullAboveGround",void 0);class Pne extends Gf{constructor(t){super(t,new Snt),this.supportsEdges=!0,this._configuration=new Mc}getConfiguration(t,i){return this._configuration.output=t,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=i.transparencyPassType,this._configuration.enableOffset=i.camera.relativeElevation<L5,this._configuration.hasMultipassTerrain=i.multipassTerrain.enabled,this._configuration.cullAboveGround=i.multipassTerrain.cullAboveGround,this._configuration}intersect(t,i,r,s,n,o,a){O5(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===Se.DRAPED_MATERIAL?!0:ew(i)===J.Highlight?t===Se.OPAQUE_MATERIAL:t===(this.parameters.transparent?this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:Se.OPAQUE_MATERIAL)}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Highlight||t.output===J.Depth&&this.parameters.writeLinearDepth?new Tnt(t):null}createBufferWriter(){return new J5(Pbe)}}class Tnt extends kv{_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||this._updateOccludeeState(t),this.ensureTechnique(hU,t)}}class Snt extends uE{constructor(){super(...arguments),this.color=hf,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=or.None,this.hasOccludees=!1}}var Xn;(function(e){e[e.Horizontal=0]="Horizontal",e[e.Vertical=1]="Vertical",e[e.Cross=2]="Cross",e[e.ForwardDiagonal=3]="ForwardDiagonal",e[e.BackwardDiagonal=4]="BackwardDiagonal",e[e.DiagonalCross=5]="DiagonalCross",e[e.COUNT=6]="COUNT"})(Xn||(Xn={}));const mj=.70710678118,Ine=mj,Ent=.08715574274;function Cnt(e){const t=new Bi,i=e.hasMultipassTerrain&&(e.output===J.Color||e.output===J.Alpha);e.draped||t.extensions.add("GL_OES_standard_derivatives");const r=e.output===J.Depth,{vertex:s,fragment:n}=t;ou(t,e),t.include(To,{hasModelTransformation:!1,linearDepth:r}),t.include(Tw,e),r&&(t.include(Bv,e),s.uniforms.add(new di("nearFar",(a,l)=>l.camera.nearFar)),t.varyings.add("linearDepth","float")),e.draped?s.uniforms.add(new We("worldToScreenRatio",(a,l)=>1/l.screenToPCSRatio)):t.attributes.add(A.BOUNDINGRECT,"mat3"),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.UVMAPSPACE,"vec4"),t.varyings.add("vpos","vec3"),t.varyings.add("vuv","vec2"),i&&t.varyings.add("depth","float");const o=e.style===Xn.ForwardDiagonal||e.style===Xn.BackwardDiagonal||e.style===Xn.DiagonalCross;return o&&s.code.add(x`
      const mat2 rotate45 = mat2(${x.float(mj)}, ${x.float(-Ine)},
                                 ${x.float(Ine)}, ${x.float(mj)});
    `),e.draped||(Mf(s,e),s.uniforms.add(new We("worldToScreenPerDistanceRatio",(a,l)=>1/l.camera.perScreenPixelRatio)),s.code.add(x`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),s.code.add(x`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),s.code.add(x`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${x.float(Ent)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),s.code.add(x`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${o?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${o?" * rotate45":""};

      ${e.draped?"":x`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${x.float(e.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `),s.code.add(x`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${i?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      gl_Position = ${r?x`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:x`transformPosition(proj, view, vpos);`}
    }
  `),t.include(ls,e),n.include(Vf),e.draped&&n.uniforms.add(new We("texelSize",(a,l)=>1/l.camera.pixelRatio)),e.output===J.Highlight&&t.include(Bg),i&&t.include(yu,e),e.output!==J.Highlight&&(n.code.add(x`
      const float lineWidth = ${x.float(e.lineWidth)};
      const float spacing = ${x.float(e.patternSpacing)};
      const float spacingINV = ${x.float(1/e.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),e.draped||n.code.add(x`const int maxSamples = 5;
float sample(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),n.uniforms.add(new ei("uColor",a=>a.color)),n.code.add(x`
    void main() {
      discardBySlice(vpos);
      ${i?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = ${e.hasVertexColors?"vColor * uColor;":"uColor;"}
      color = highlightSlice(color, vpos);

      ${e.output!==J.Highlight?x`color.a *= ${Ant(e)};`:""}

      if (color.a < ${x.float(Eo)}) {
        discard;
      }

      ${e.output===J.Alpha?x`gl_FragColor = vec4(color.a);`:""}

      ${e.output===J.Color?x`gl_FragColor = color; ${e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}`:""}
      ${e.output===J.Highlight?x`outputHighlight();`:""}
      ${e.output===J.Depth?x`outputDepth(linearDepth);`:""};
    }
  `),t}function Ant(e){function t(i){return e.draped?x`coverage(vuv.${i}, texelSize)`:x`sample(vuv.${i})`}switch(e.style){case Xn.ForwardDiagonal:case Xn.Horizontal:return t("y");case Xn.BackwardDiagonal:case Xn.Vertical:return t("x");case Xn.DiagonalCross:case Xn.Cross:return x`
        1.0 - (1.0 - ${t("x")}) * (1.0 - ${t("y")})
      `;default:return"0.0"}}const Rnt=Object.freeze(Object.defineProperty({__proto__:null,build:Cnt},Symbol.toStringTag,{value:"Module"}));class dU extends lr{initializeProgram(t){const i=dU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Gwe)}_setPipelineState(t,i){const r=this.configuration,s=t===gt.NONE,n=t===gt.FrontFace;return Ut({blending:r.output===J.Color||r.output===J.Alpha?s?au:Gg(t):null,culling:h5(r.cullFace),depthTest:{func:Vv(t)},depthWrite:s?r.writeDepth&&pl:D5(t),colorWrite:Jt,stencilWrite:r.hasOccludees?Pf:null,stencilTest:r.hasOccludees?i?Ov:Gv:null,polygonOffset:s||n?r.polygonOffset&&Mnt:F5(r.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(t,i){return i?this._occludeePipelineState:super.getPipelineState(t,i)}}dU.shader=new Qi(Rnt,()=>import("./Pattern.glsl.95e8423a.js"));const Mnt={factor:1,units:1};class da extends Ho{constructor(){super(...arguments),this.output=J.Color,this.cullFace=or.None,this.transparencyPassType=gt.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}}u([G({count:J.COUNT})],da.prototype,"output",void 0),u([G({count:or.COUNT})],da.prototype,"cullFace",void 0),u([G({count:Xn.COUNT})],da.prototype,"style",void 0),u([G({count:gt.COUNT})],da.prototype,"transparencyPassType",void 0),u([G()],da.prototype,"hasSlicePlane",void 0),u([G()],da.prototype,"hasVertexColors",void 0),u([G()],da.prototype,"polygonOffset",void 0),u([G()],da.prototype,"writeDepth",void 0),u([G()],da.prototype,"hasOccludees",void 0),u([G()],da.prototype,"patternSpacing",void 0),u([G()],da.prototype,"lineWidth",void 0),u([G()],da.prototype,"enableOffset",void 0),u([G()],da.prototype,"draped",void 0),u([G()],da.prototype,"hasMultipassTerrain",void 0),u([G()],da.prototype,"cullAboveGround",void 0);const Gwe=new Map([[A.POSITION,0],[A.COLOR,3],[A.UVMAPSPACE,4],[A.BOUNDINGRECT,5]]);class aZ extends Gf{constructor(t){super(t,new Int),this.supportsEdges=!0,this._vertexAttributeLocations=Gwe,this.techniqueConfig=new da}getConfiguration(t,i){return this.techniqueConfig.output=t,this.techniqueConfig.cullFace=this.parameters.cullFace,this.techniqueConfig.hasVertexColors=this.parameters.hasVertexColors,this.techniqueConfig.hasSlicePlane=this.parameters.hasSlicePlane,this.techniqueConfig.polygonOffset=this.parameters.polygonOffset,this.techniqueConfig.writeDepth=this.parameters.writeDepth,this.techniqueConfig.style=this.parameters.style,this.techniqueConfig.patternSpacing=this.parameters.patternSpacing,this.techniqueConfig.lineWidth=this.parameters.lineWidth,this.techniqueConfig.draped=this.parameters.draped,this.techniqueConfig.transparencyPassType=i.transparencyPassType,this.techniqueConfig.enableOffset=i.camera.relativeElevation<L5,this.techniqueConfig.hasMultipassTerrain=i.multipassTerrain.enabled,this.techniqueConfig.cullAboveGround=i.multipassTerrain.cullAboveGround,this.techniqueConfig}intersect(t,i,r,s,n,o,a){O5(t,i,s,n,o,void 0,a)}requiresSlot(t,i){return t===Se.DRAPED_MATERIAL?!0:ew(i)===J.Highlight?t===Se.OPAQUE_MATERIAL:t===(this.parameters.writeDepth?Se.TRANSPARENT_MATERIAL:Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL)}createGLMaterial(t){return t.output===J.Color||t.output===J.Alpha||t.output===J.Highlight||t.output===J.Depth&&this.parameters.writeLinearDepth?new Ont(t):null}createBufferWriter(){const t=Kr().vec3f(A.POSITION).vec4u8(A.COLOR).vec4f(A.UVMAPSPACE);return this.parameters.draped||t.mat3f(A.BOUNDINGRECT),new Pnt(t)}}class Ont extends kv{_updateParameters(t){return this.ensureTechnique(dU,t)}_updateOccludeeState(t){t.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:t.hasOccludees})}beginSlot(t){return this._output!==J.Color&&this._output!==J.Alpha||this._updateOccludeeState(t),this._updateParameters(t)}}class Pnt extends J5{write(t,i,r,s){for(const n of this.vertexBufferLayout.fieldNames){const o=i.vertexAttributes.get(n),a=i.indices.get(n);if(o&&a)switch(n){case A.POSITION:{dt(o.size===3);const l=r.getField(n,Vi);l&&P5(a,o.data,t.transformation,l,s);break}case A.COLOR:{dt(o.size===3||o.size===4);const l=r.getField(n,fl);l&&pF(a,o.data,o.size,l,s);break}case A.UVMAPSPACE:{dt(o.size===4);const l=r.getField(n,On);l&&T2(a,o.data,l,s);break}case A.BOUNDINGRECT:{dt(o.size===9);const l=r.getField(n,Jd);l&&this.writeBoundingRect(a,o.data,t.transformation,l,s);break}}}}writeBoundingRect(t,i,r,s,n){const o=r,a=s.typedBuffer,l=s.typedBufferStride,c=t.length;n*=l;for(let h=0;h<c;++h){const p=9*t[h],f=i[p],m=i[p+1],y=i[p+2];a[n]=o[0]*f+o[4]*m+o[8]*y+o[12],a[n+1]=o[1]*f+o[5]*m+o[9]*y+o[13],a[n+2]=o[2]*f+o[6]*m+o[10]*y+o[14];for(let v=3;v<9;++v)a[n+v]=i[p+v];n+=l}}}class Int extends uE{constructor(){super(...arguments),this.color=fi(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=or.None,this.hasOccludees=!1,this.style=Xn.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}}function $nt(e,t,i){return Lnt(Dnt(e),t,i)}function Dnt(e){return e&&e.pattern||null}function Lnt(e,t,i){return _(e)?e.style==="none"||e.style==="solid"?(e.style==="none"&&(t.color=fi(0,0,0,0),t.transparent=!0),new Pne(t)):(t.style=Nnt(e.style),t.draped=i.isDraped,new aZ(t)):new Pne(t)}function Nnt(e){switch(e){case"horizontal":return Xn.Horizontal;case"vertical":return Xn.Vertical;case"cross":return Xn.Cross;case"forward-diagonal":return Xn.ForwardDiagonal;case"backward-diagonal":return Xn.BackwardDiagonal;case"diagonal-cross":return Xn.DiagonalCross;default:return}}function Fnt(e){return e.material instanceof aZ&&!e.material.parameters.draped}function Unt(e,t){if(Fnt(e)){const i=e.geometry.vertexAttributes,r=i.get(A.POSITION).data,s=i.get(A.UVMAPSPACE).data,n=i.get(A.BOUNDINGRECT).data;Bwe(On.fromTypedArray(s),vs.fromTypedArray(r),t,_v.fromTypedArray(n))}}function knt(e,t,i,r){const s=H1e(e,t,i,r),n=e.stageObject.geometryRecords;for(let o=0;o<n.length;o++)Unt(n[o],r);return s}const znt=["polyline","polygon","extent"];class pU extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(_(this._material))return;const t=Yr(this.symbolLayer,"material","color"),i=this._getCombinedOpacityAndColor(t);this._material=$nt(this.symbolLayer,{color:i,transparent:i[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,hasSlicePlane:this._context.slicePlaneEnabled},{isDraped:this.draped}),this._needsUV=this._material instanceof aZ,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const t=this.symbolLayer.outline;if(_(this._outlineMaterial)||!this._isValidOutline(t))return;this._hasOutline=!0;const i=r=>{const s=uwe(t.pattern);return new VT({width:r,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:cj(t.patternCap||"butt")})};this._outlineMaterial=i(Jn(t.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(t){return _(t)&&t.size&&t.size>0&&_(t.color)&&(R(t.pattern)||t.pattern.type!=="style"||t.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,znt,this.symbolLayer.type))return null;const r=this._getVertexOpacityAndColor(t.renderingInfo,255),s=this.setGraphicElevationContext(i,new _u);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(i,r):this._createAs3DShape(i,r,s)}layerOpacityChanged(){if(_(this._material)){const t=this._material.parameters.color,i=Yr(this.symbolLayer,"material","color"),r=this._getCombinedOpacity(i);this._material.setParameters({color:[t[0],t[1],t[2],r],transparent:r<1||this.needsDrivenTransparentPass})}if(_(this._outlineMaterial)){const t=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[t[0],t[1],t[2],this._getOutlineOpacity()]})}return!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=KO(pU.elevationModeChangeTypes,r,s);if(n!==Br.UPDATE)return n;const o=Oh(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){if(_(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),_(this._outlineMaterial)){const t={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(t)}return!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=XM(t.geometry);if(R(s))return null;sn.renderData=JY(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),sn.color=i;const n=sn.renderData.position.length/3;if(this._needsUV&&(sn.uvMapSpace=new Float32Array(4*n),sn.boundingRect=new Float64Array(9*n)),sn.outNum=0,sn.outGeometries=[],sn.outTransforms=[],sn.outMaterials=[],this._createAs3DShapeFill(sn),this._hasOutline&&this._createAs3DShapeOutline(sn),this._logGeometryCreationWarnings(sn.renderData,s.rings,"rings","FillSymbol3DLayer"),sn.outNum===0)return null;this._needsUV&&Bwe(On.fromTypedArray(sn.uvMapSpace),vs.fromTypedArray(sn.renderData.position),this._context.renderCoordsHelper,_v.fromTypedArray(sn.boundingRect));const o=new Hg({geometries:sn.outGeometries,materials:sn.outMaterials,transformations:sn.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:t.uid}}),a=new jf(this,o,sn.outGeometries,null,null,knt,r);return a.alignedSampledElevation=sn.renderData.sampledElevation,a.needsElevationUpdates=Oh(r.mode),a}_createAs3DShapeFill(t){const i=t.renderData.polygons;for(const{position:r,mapPosition:s,holeIndices:n,index:o,count:a}of i){if(_(this._context.clippingExtent)&&(cr(ta),Kc(ta,s),!$d(ta,this._context.clippingExtent)))continue;const l=C2(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=zse({indices:c,attributeData:{position:r,color:t.color,mapPosition:s,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*o*t.uvMapSpace.BYTES_PER_ELEMENT,4*a):null,boundingRect:this._needsUV?new Float64Array(t.boundingRect.buffer,9*o*t.boundingRect.BYTES_PER_ELEMENT,9*a):null}});t.outGeometries.push(h),t.outMaterials.push(this._material),t.outTransforms.push(Ks),t.outNum++}}_createAs3DShapeOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{mapPosition:s,position:n}=i[r];if(_(this._context.clippingExtent)&&(cr(ta),Kc(ta,s),!$d(ta,this._context.clippingExtent)))continue;const o=lj({overlayInfo:null,removeDuplicateStartEnd:sw.REMOVE,attributeData:{position:n,mapPosition:s}}),a=o.vertexAttributes.get(A.POSITION);a.data===n&&(a.data=new Float64Array(n)),t.outGeometries.push(o),t.outMaterials.push(this._outlineMaterial),t.outTransforms.push(Ks),t.outNum++}}_createAsOverlay(t,i){const r=XM(t.geometry);if(R(r))return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,_(this._outlineMaterial)&&(this._outlineMaterial.renderPriority=this._renderPriority),uo.renderData=kbe(r,this._context.overlaySR),uo.color=i;const s=uo.renderData.position.length/3;return this._needsUV&&(uo.uvMapSpace=new Float32Array(4*s)),uo.outNum=0,uo.outGeometries=[],uo.outBoundingBox=cr(),uo.layerUid=this._context.layer.uid,uo.graphicsUid=t.uid,this._createAsOverlayFill(uo),this._hasOutline&&this._createAsOverlayOutline(uo),this._logGeometryCreationWarnings(uo.renderData,r.rings,"rings","FillSymbol3DLayer"),uo.outNum===0?null:(this._needsUV&&gnt(On.fromTypedArray(uo.uvMapSpace),vs.fromTypedArray(uo.renderData.position),this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode),uo.outNum>0?new tU(this,uo.outGeometries,uo.outBoundingBox,this._context.drapeSourceRenderer):null)}_createAsOverlayFill(t){const i=t.renderData.polygons;for(const{position:r,holeIndices:s,index:n,count:o}of i){if(cr(ta),Kc(ta,r),!$d(ta,this._context.clippingExtent))continue;const a=C2(r,s,3);if(a.length===0)continue;NS(t.outBoundingBox,ta);const l=new Uint32Array(a),c=zse({indices:l,attributeData:{position:r,color:t.color,uvMapSpace:this._needsUV?new Float32Array(t.uvMapSpace.buffer,4*n*t.uvMapSpace.BYTES_PER_ELEMENT,4*o):null}}),h=new O2(c,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),p=ta;qi(h.boundingSphere,.5*(p[0]+p[3]),.5*(p[1]+p[4]),0,.5*Math.sqrt((p[3]-p[0])*(p[3]-p[0])+(p[4]-p[1])*(p[4]-p[1]))),t.outGeometries.push(h),t.outNum++}}_createAsOverlayOutline(t){if(!this._hasOutline)return;const i=t.renderData.outlines;for(let r=0;r<i.length;++r){const{position:s}=i[r];if(cr(ta),Kc(ta,s),!$d(ta,this._context.clippingExtent))continue;NS(t.outBoundingBox,ta);const n=lj({overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:sw.REMOVE,attributeData:{position:s}}),o=new O2(n,this._outlineMaterial,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),a=ta;qi(o.boundingSphere,.5*(a[0]+a[3]),.5*(a[1]+a[4]),0,.5*Math.sqrt((a[3]-a[0])*(a[3]-a[0])+(a[4]-a[1])*(a[4]-a[1]))),t.outGeometries.push(o),t.outNum++}}_getOutlineOpacity(){const t=Yr(this.symbolLayer,"outline","color");return(this.draped?1:this._getLayerOpacity())*(_(t)?t.a:0)}_getOutlineColor(){const t=Yr(this.symbolLayer,"outline","color"),i=this._getOutlineOpacity();return TR(_(t)?qe.toUnitRGB(t):null,i)}test(){return ve(F({},super.test()),{createAsOverlay:(t,i)=>this._createAsOverlay(t,i),createAs3DShape:(t,i,r)=>this._createAs3DShape(t,i,r)})}}pU.elevationModeChangeTypes={definedChanged:Br.RECREATE,staysOnTheGround:Br.NONE,onTheGroundChanged:Br.RECREATE};const ta=Ls(),sn={renderData:null,color:null,uvMapSpace:null,boundingRect:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},uo={renderData:null,color:null,uvMapSpace:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Vnt=me.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters");class fU{constructor(t){this.definition=t,this.key=JSON.stringify(t),this.haloSize=Math.round(t.halo.size),this.textStyle=this._colorToRGBA(t.color),this.haloStyle=this._colorToRGB(t.halo.color),this.backgroundStyle=t.background.color[3]!==0?this._colorToRGBA(t.background.color):null}fontString(t){const i=this.definition.font;return`${i.style} ${i.weight} ${t}px ${i.family}, sans-serif`}_colorToRGB(t){return`rgb(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()})`}_colorToRGBA(t){return`rgba(${t.slice(0,3).map(i=>Math.floor(255*i)).toString()},${t[3]})`}static async fromSymbol(t,i=1){const r=Yr(t,"material","color"),s=Gc(r,hf,qe.toUnitRGBA),n=Gc(t.size,12,Jn),o=t.lineHeight,a=_(t.background)?qe.toUnitRGBA(t.background.color):hf,l={family:Gc(t.font,"sans-serif",m=>m.family),decoration:Gc(t.font,"none",m=>m.decoration),weight:Gc(t.font,"normal",m=>m.weight),style:Gc(t.font,"normal",m=>m.style)},c=t.halo,h=_(c)&&_(c.color)&&c.size>0?{size:Jn(c.size),color:qe.toUnitRGBA(c.color)}:{size:0,color:hf},p=new fU({color:s,size:n,background:{color:a,padding:_(t.background)?[.65*n,.5*n]:[0,0],borderRadius:_(t.background)?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:i}),f=p.fontString(n);try{await document.fonts.load(f)}catch{Vnt.warnOnce(`Failed to preload font '${f}'. Some text symbology may be rendered using the default browser font.`)}return p}}class Bnt{constructor(t,i,r){this._renderer=new twe(t,i,r)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const t=eL(Gnt,this._renderer.renderedWidth,this._renderer.renderedHeight),i=t.getContext("2d");return i.save(),this._renderer.render(i,0,0),i.restore(),new Cs(t,{wrap:{s:_t.CLAMP_TO_EDGE,t:_t.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0,powerOfTwoResizeMode:sv.PAD})}}const Gnt={canvas:null},jnt=[0,0,1];class Hnt extends Hf{constructor(t,i,r,s){super(t,i,r,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const t=U5(this.symbolLayer.size);if(t)throw new q("graphics3dtextsymbollayer:invalid-size",t)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const t=this._context.graphicsCoreOwner.view.state.pixelRatio;this._textRenderParameters=await fU.fromSymbol(this.symbolLayer,t)}destroy(){super.destroy()}createGraphics3DGraphic(t){const i=t.graphic,r=qM(i.geometry);if(R(r))return this.logger.warn(`unsupported geometry type for text symbol: ${i.geometry.type}`),null;const s=this.symbolLayer.text;if(R(s)||s==="")return null;const n=Aq(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(_(n)&&!Fhe(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=ve(F({},Xnt),{verticalOffset:n,horizontalPlacement:this.symbolLayer.horizontalAlignment,verticalPlacement:mtt(this.symbolLayer.verticalAlignment)});return this._createAs3DShape(i,r,s,o)}createLabel(t,i,r,s){const n=t.graphic,o=qM(n.geometry);if(R(o))return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=i.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,i,r,s)}setGraphicElevationContext(t,i,r=0){const s=super.setGraphicElevationContext(t,i);return s.addOffsetRenderUnits(r),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(t,i){return $ne(t,i,(r,s)=>{this.updateGraphicElevationContext(s,r)}),Br.UPDATE}slicePlaneEnabledChanged(t,i){return $ne(t,i,r=>{for(const s of r.stageObject.geometryRecords)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!1}updateGraphicElevationContext(t,i){this.setGraphicElevationContext(t,i.elevationContext,i.metadata.elevationOffset),i.needsElevationUpdates=Oh(i.elevationContext.mode)||i.elevationContext.mode==="absolute-height"}_defaultElevationInfoNoZ(){return Wnt}_createAs3DShape(t,i,r,s,n,o){const a=this.setGraphicElevationContext(t,new _u,s.elevationOffset),l=Yr(t.geometry,"type")==="polyline",c=t.uid;let h=null,p=null;if(R(o)){const k=rwe(s.horizontalPlacement);h=new Bnt(r,k,this._textRenderParameters);let Y=null;p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{_(Y)&&Y.release()});const Z=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if(R(Z)||vu(Z))return p.release(),null;Y=Z}const f=qnt(h,s),m={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,debugDrawLabelBorder:s.debugDrawLabelBorder,drawInSecondSlot:!0};if(_(p)&&(m.textureId=p.texture.id),_(o)&&(m.textureId=o.id),_(s.verticalOffset)){const{screenLength:k,minWorldLength:Y,maxWorldLength:Z}=s.verticalOffset;m.verticalOffset={screenLength:Jn(k),minWorldLength:Y||0,maxWorldLength:Z!=null?Z:1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:k,screenSizePerspectiveSettingsLabels:Y}=this._context.sharedResources;m.screenSizePerspective=Y.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=k}let y;if(l&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,_(n)){const k=JSON.stringify(m);y=n.get(k),R(y)&&(y=new S2(m),n.add(k,y))}else y=new S2(m);const v=[y],w=s.translation,b=_(h)?[h.displayWidth,h.displayHeight]:[0,0],S=s.centerOffset,T=jnt,E=[0,0],C=[Nl.createPointGeometry(T,w,null,b,S,E,null)],M=this._context.layer.uid,I=jY(this._context,i,C,v,a,M,c);if(I===null)return null;const N=new jf(this,I.object,C,R(n)?v:null,p,jM,a);N.alignedSampledElevation=I.sampledElevation,N.needsElevationUpdates=Oh(a.mode)||a.mode==="absolute-height";const{displayWidth:D,displayHeight:z}=_(h)?h:s;N.getScreenSize=(k=tt())=>(k[0]=D,k[1]=z,k);const V={labelText:r,elevationOffset:s.elevationOffset};return N.metadata=V,HM(N,i,this._context.elevationProvider),N}}function $ne(e,t,i){e&&e.forEach(r=>{const s=t(r);_(s)&&i(s,r.graphic)})}function qnt(e,t){if(t.verticalPlacement==="baseline"){const r=dtt[t.horizontalPlacement],s=_(e)?e.baselineAnchorY:0;return Oi(r,s)}const i=ftt(t.horizontalPlacement,t.verticalPlacement);return tL[i]}const Wnt={mode:"relative-to-ground",offset:0},Xnt={text:null,translation:[0,0,0],elevationOffset:0,centerOffset:[0,0,0,1],screenOffset:[0,0],horizontalPlacement:"center",verticalPlacement:"center",verticalOffset:null,centerOffsetUnits:null,debugDrawLabelBorder:!1,displayWidth:0,displayHeight:0},Ynt={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},Znt=["polyline","polygon","extent"];class Jp extends Hf{constructor(t,i,r,s){super(t,i,r,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(t){const i=t.graphic;if(!this._validateGeometry(i.geometry,Znt,this.symbolLayer.type))return null;const r=this.setGraphicElevationContext(i,new _u);return this.ensureDrapedStatus(r.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(i):this._createAs3DShape(i,r,i.uid)}ensureMaterial(){if(_(this._material))return;const t=new $be,i=this.symbolLayer.color;_(i)&&(t.color=qe.toUnitRGBA(i));const r=this._getCombinedOpacity(i,{hasIntrinsicColor:!0});t.color=[t.color[0],t.color[1],t.color[2],r],t.transparent=r<1||this.needsDrivenTransparentPass,t.waveDirection=_(this.symbolLayer.waveDirection)?Jp.headingVectorFromAngle(this.symbolLayer.waveDirection):Oi(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=Ynt[s];t.waveStrength=n.waveStrength,t.waveTextureRepeat=n.textureRepeat,t.waveVelocity=n.waveVelocity,t.flowStrength=n.perturbationStrength,t.hasSlicePlane=this._context.slicePlaneEnabled,t.isDraped=this.draped,this._material=new Ibe(t),this._context.stage.add(this._material)}layerOpacityChanged(){if(R(this._material))return!0;const t=this._material.parameters.color,i=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),r=i<1||this.needsDrivenTransparentPass;return this._material.setParameters({color:[t[0],t[1],t[2],i],transparent:r}),!0}layerElevationInfoChanged(t,i,r){const s=this._elevationContext.mode,n=KO(Jp.elevationModeChangeTypes,r,s);if(n!==Br.UPDATE)return n;const o=Oh(s);return this.updateGraphics3DGraphicElevationInfo(t,i,()=>o)}slicePlaneEnabledChanged(){return _(this._material)&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}pixelRatioChanged(){return!0}_createAs3DShape(t,i,r){const s=XM(t.geometry);if(R(s))return null;Lo.renderData=JY(s,this._context.elevationProvider,this._context.renderCoordsHelper,i);const n=Lo.renderData.position.length/3;if(Lo.uvCoords=new Float64Array(2*n),Lo.outNum=0,Lo.outGeometries=[],Lo.outTransforms=[],Lo.outMaterials=[],this._create3DShapeGeometries(Lo),this._logGeometryCreationWarnings(Lo.renderData,s.rings,"rings","WaterSymbol3DLayer"),Lo.outNum===0)return null;this._createUVCoordsFromVertices(Lo.uvCoords,Lo.renderData.mapPosition,n,this._context.elevationProvider.spatialReference);const o=new Hg({geometries:Lo.outGeometries,materials:Lo.outMaterials,transformations:Lo.outTransforms,castShadow:!1,metadata:{layerUid:this._context.layer.uid,graphicUid:r}}),a=new jf(this,o,Lo.outGeometries,null,null,H1e,i);return a.alignedSampledElevation=Lo.renderData.sampledElevation,a.needsElevationUpdates=Oh(i.mode),a}_createUVCoordsFromVertices(t,i,r,s){const n=cc(s);hu(py);for(let l=0;l<r;l++)hi(Dne,i[3*l+0],i[3*l+1]),JT(py,Dne);hO(py,py,n);const o=py[0]%Jp.unitSizeOfTexture,a=py[1]%Jp.unitSizeOfTexture;LI[0]=py[0]-o,LI[1]=py[1]-a;for(let l=0;l<r;l++)t[2*l+0]=(i[3*l+0]*n-LI[0])/Jp.unitSizeOfTexture,t[2*l+1]=(i[3*l+1]*n-LI[1])/Jp.unitSizeOfTexture}_create3DShapeGeometries(t){const i=t.renderData.polygons,r=t.uvCoords;for(const{count:s,index:n,position:o,mapPosition:a,holeIndices:l}of i){if(_(this._context.clippingExtent)&&(cr(fy),Kc(fy,a),!$d(fy,this._context.clippingExtent)))continue;const c=C2(a,l,3);if(c.length===0)continue;const h=new Uint32Array(c),p=new Float64Array(r.buffer,2*n*r.BYTES_PER_ELEMENT,2*s),f=Vse({indices:h,attributeData:{position:o,uv0:p,mapPosition:a}});t.outGeometries.push(f),t.outMaterials.push(this._material),t.outTransforms.push(Ks),t.outNum++}}_createAsOverlay(t){const i=XM(t.geometry);if(R(i))return null;this._material.renderPriority=this._renderPriority,ia.renderData=kbe(i,this._context.overlaySR);const r=ia.renderData.position.length/3;return ia.uvCoords=new Float64Array(2*r),ia.outNum=0,ia.outGeometries=[],ia.outBoundingBox=cr(),ia.layerUid=this._context.layer.uid,ia.graphicsUid=t.uid,this._createAsOverlayWater(ia),this._logGeometryCreationWarnings(ia.renderData,i.rings,"rings","WaterSymbol3DLayer"),ia.outNum===0?null:(this._createUVCoordsFromVertices(ia.uvCoords,ia.renderData.position,r,this._context.overlaySR),ia.outNum>0?new tU(this,ia.outGeometries,ia.outBoundingBox,this._context.drapeSourceRenderer):null)}_createAsOverlayWater(t){const i=t.uvCoords,r=t.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of r){if(cr(fy),Kc(fy,s),!$d(fy,this._context.clippingExtent))continue;NS(t.outBoundingBox,fy);const l=C2(s,n,3);if(l.length===0)continue;const c=new Uint32Array(l),h=new Float64Array(i.buffer,2*o*i.BYTES_PER_ELEMENT,2*a),p=Vse({indices:c,attributeData:{position:s,uv0:h}}),f=new O2(p,this._material,{layerUid:t.layerUid,graphicUid:t.graphicsUid}),m=fy;qi(f.boundingSphere,.5*(m[0]+m[3]),.5*(m[1]+m[4]),0,.5*Math.sqrt((m[3]-m[0])*(m[3]-m[0])+(m[4]-m[1])*(m[4]-m[1]))),t.outGeometries.push(f),t.outNum++}}static headingVectorFromAngle(t){const i=tt(),r=XF(t);return i[0]=Math.sin(r),i[1]=Math.cos(r),i}test(){return ve(F({},super.test()),{create3DShape:t=>this._createAs3DShape(t.graphic,t.elevationContext,t.graphicUid),ensureMaterial:()=>this.ensureMaterial()})}}Jp.unitSizeOfTexture=100,Jp.elevationModeChangeTypes={definedChanged:Br.RECREATE,staysOnTheGround:Br.NONE,onTheGroundChanged:Br.RECREATE};const LI=tt(),py=Dt(),Dne=tt(),fy=Ls(),Lo={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},ia={renderData:null,uvCoords:null,outNum:0,outBoundingBox:null,outGeometries:null,outMaterials:null,outTransforms:null},Qnt=me.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory");function Jnt(e,t,i,r){const s=Lne[e.type]&&Lne[e.type][t.type]||Knt[t.type];return s?new s(e,t,i,r):(Qnt.error("GraphicsLayerFactory#make",`unknown symbol type ${t.type}`),null)}const Knt={icon:JM,object:yst,line:sU,path:unt,fill:pU,extrude:Ket,text:Hnt,water:Jp},Lne={"mesh-3d":{fill:Zit}};class eot extends zY{constructor(t,i,r){super(i.schedule),this._symbol=t,this._context=i,this._backgroundLayers=r,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}set symbol(t){this._symbol=t;for(let i=0;i<t.symbolLayers.length;i++){const r=this.symbolLayers[i];R(r)||(r.symbol=t,r.symbolLayer=t.symbolLayers.items[i])}}get symbol(){return this._symbol}async doLoad(t){let i=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(i=this._backgroundLayers.concat(i));const r=i.length;for(;this.symbolLayers.length<i.length;)this.symbolLayers.push(null);this.symbolLayers.length=i.length;const s=[];for(let n=0;n<r;n++){const o=i.getItemAt(n);if(o.enabled===!1)continue;NI.renderPriority=1-(1+n)/r,NI.renderPriorityStep=1/r,NI.ignoreDrivers=o._ignoreDrivers;const a=Jnt(this.symbol,o,this._context,NI);s.push(r4(t,()=>{this.symbolLayers[n]=null,a.destroy()})),this.symbolLayers[n]=a}await B4(this.symbolLayers,async(n,o)=>{if(_(n))try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}});for(const n of s)n==null||n.remove();if(s.length=0,li(t),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(t){const i=this.symbolLayers[t];return _(i)?i.getCachedSize():null}get extentPadding(){return this._extentPadding}createGraphics3DGraphic(t,i){const r=t.graphic,s=new Array(this.symbolLayers.length);for(let o=0;o<this.symbolLayers.length;o++){const a=this.symbolLayers[o];s[o]=_(a)?a.createGraphics3DGraphic(t):null}const n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new XJe(r,i||this,s,t.layer,n)}get complexity(){return GY(this.symbolLayers.map(t=>Yr(t,"complexity")))}globalPropertyChanged(t,i){const r=this.symbolLayers.length;for(let s=0;s<r;s++){const n=this.symbolLayers[s],o=a=>{const l=a.graphics[s];return l instanceof jf?l:null};if(_(n)&&!n.globalPropertyChanged(t,i,o))return!1}return!0}applyRendererDiff(t,i){return this.loadStatus!==Bc.LOADED?Qs.Recreate_Symbol:this.symbolLayers.reduce((r,s)=>r!==Qs.Recreate_Symbol&&_(s)?Math.min(r,s.applyRendererDiff(t,i)):r,Qs.Fast_Update)}prepareSymbolPatch(t){if(this.loadStatus===Bc.FAILED||t.diff.type!=="partial")return;const i=t.diff.diff;if(!i.symbolLayers||i.symbolLayers.type!=="partial")return;const r=i.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(R(s))return;const o=r[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),t.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&t.graphics3DGraphicPatches.push((l,c)=>{const h=l.graphics[n];_(h)&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(t,i){for(let r=0;r<this.symbolLayers.length;r++){const s=this.symbolLayers[r];if(R(s))continue;const n=t.graphics[r];if(R(n)||!s.updateGeometry(n,i))return!1}return!0}onRemoveGraphic(t){for(let i=0;i<this.symbolLayers.length;i++){const r=this.symbolLayers[i];if(R(r))continue;const s=t.graphics[i];_(s)&&r.onRemoveGraphic(s)}}getFastUpdateStatus(){let t=0,i=0,r=0;return this.symbolLayers.forEach(s=>{R(s)||(s.loadStatus===Bc.LOADING?t++:s.isFastUpdatesEnabled()?r++:i++)}),{loading:t,slow:i,fast:r}}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const t of this.symbolLayers)_(t)&&t.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}}const NI={renderPriority:0,renderPriorityStep:1,ignoreDrivers:!1};class tot extends zY{constructor(t,i,r){super(i),this.symbol=t,this.convert=r,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getSymbolLayerSize(t):null}get symbolLayers(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.extentPadding:0}async doLoad(t){const i=await this.symbol.fetchSymbol({signal:t});i.id=this.symbol.id,this.graphics3DSymbol=this.convert(i),_(this.graphics3DSymbol)&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(t){return _(this.graphics3DSymbol)?this.graphics3DSymbol.createGraphics3DGraphic(t,this):null}get complexity(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.complexity:BY}globalPropertyChanged(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.globalPropertyChanged(t,i)}applyRendererDiff(t,i){return _(this.graphics3DSymbol)?this.graphics3DSymbol.applyRendererDiff(t,i):Qs.Recreate_Symbol}prepareSymbolPatch(t){_(this.graphics3DSymbol)&&this.graphics3DSymbol.prepareSymbolPatch(t)}updateGeometry(t,i){return!!_(this.graphics3DSymbol)&&this.graphics3DSymbol.updateGeometry(t,i)}onRemoveGraphic(){}getFastUpdateStatus(){return _(this.graphics3DSymbol)?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){_(this.graphics3DSymbol)&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}}function lZ(e){return e instanceof tot?e.graphics3DSymbol:e instanceof eot?e:null}const eO=me.getLogger("esri.views.3d.layers.graphics.labelPlacement");function iot(e){const t=hot(e);if(R(t))return null;const i=rot(e,t);if(R(i))return null;const r=i.anchor,s=!!t.hasLabelVerticalOffset;return not({anchor:r,verticalOffset:t.verticalOffset,screenOffset:tt(),centerOffset:fi(0,0,0,-1),centerOffsetUnits:"world",translation:O(),elevationOffset:0,hasLabelVerticalOffset:s},i,e)}function rot(e,t){if(t.anchor)return t;const i=e.labelClass.labelPlacement,r=kd[i],s=r||OF(e);return i&&!r&&eO.warnOncePerTick(`the requested label placement '${i}' is currently unsupported in SceneView.`),sot(s,e)}function cZ(e){const t=e.graphics3DGraphic.graphics3DSymbol,i=lZ(t);return _(i)?i.symbol.symbolLayers.getItemAt(0):null}function sot(e,t){const i=t.graphics3DGraphic.graphic.geometry;if(R(i))return null;if(_(t.disablePlacement))return t.labelClass.labelPlacement?(eO.warnOncePerTick(Nne(e.placement,t.disablePlacement.logEntityDescription)),OF(t)):e;const r=i.type;switch(r){case"polyline":case"polygon":case"extent":case"multipoint":if(t.labelClass.labelPlacement)return eO.warnOncePerTick(Nne(e.placement,`'${r}' geometries`)),OF(t);break;case"point":case"mesh":return e}return e}function Nne(e,t){return`the requested label placement '${e}' is currently unsupported for ${t} in SceneView.`}function OF(e){const t=e.graphics3DGraphic.graphic.geometry;if(R(t))return null;switch(t.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const i=cZ(e);return _(i)&&i.type==="extrude"?kd["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return kd["above-center"];default:return}}function not(e,t,i){const r=i.graphics3DGraphic.graphic.geometry;if(R(r))return null;switch(r.type){case"point":aot(e,t,i);break;case"polygon":oot(e,t,i);break;case"mesh":uZ(e,t,i.graphics3DGraphic.graphics[0])}return e}function oot(e,t,i){const r=cZ(i);if(!R(r))switch(r.type){case"extrude":{const s=i.graphics3DGraphic.graphics[0];_(s)?(s.getBoundingBoxObjectSpace(OR),Id(OR,e.translation),e.translation[2]=$v(OR)/2):ie(e.translation,0,0,0),uZ(e,t,s);break}}}function aot(e,t,i){const r=cZ(i);if(R(r))return;const s=i.graphics3DGraphic.graphics[0];switch(_(s)?s.getCenterObjectSpace(e.translation):ie(e.translation,0,0,0),r.type){case"icon":case"text":lot(e,t,i,s);break;case"object":uZ(e,t,s)}}function lot(e,t,i,r){const{graphics3DGraphic:s}=i,n=_(r)?r.getScreenSize():null;if(!s.isDraped&&_(n)){const o=cot(i);aC[0]=n[0]/2*(t.normalizedOffset[0]-o[0]),aC[1]=n[1]/2*(t.normalizedOffset[1]-o[1]),e.screenOffset[0]=aC[0],e.hasLabelVerticalOffset?(e.centerOffset[1]=aC[1],e.centerOffsetUnits="screen"):e.screenOffset[1]=aC[1]}else e.hasLabelVerticalOffset||e.anchor==="center"||(kd[i.labelClass.labelPlacement]&&eO.warnOncePerTick(`the requested placement '${t.placement}' is currently unsupported for draped graphics`),e.anchor="center")}function cot(e,t=dot){const{graphics3DGraphic:i}=e,r=i.graphics[0],s=_(r)?r.stageObject.geometryRecords[0].material:null;if(s&&s instanceof S2){const n=s.parameters.anchorPosition;t[0]=2*(n[0]-.5),t[1]=2*(n[1]-.5)}else t[0]=0,t[1]=0;return t}function uZ(e,t,i){const r=_(i)?i.getBoundingBoxObjectSpace(OR):OR,s=Fe(r[3]-r[0],r[4]-r[1],r[5]-r[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);e.centerOffset[0]=n/2*t.normalizedOffset[0];const o=e.translation[2],a=s[2]/2*t.normalizedOffset[1];e.translation[2]=0,e.elevationOffset=o+a;const l=Me(s);e.centerOffset[2]=l/2*t.normalizedOffset[2]}function uot(e){return e==="above-center"}function hot(e){const t=e.labelClass.labelPlacement,{labelSymbol:i,graphics3DGraphic:r}=e,s=lZ(r.graphics3DSymbol),n=qs(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=kd[t]||OF(e);return _(n)&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!r.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:Fne(n.verticalOffset),anchor:null,normalizedOffset:null}:i&&i.hasVisibleVerticalOffset()&&(R(n)||!n.supportsCallout()||!n.verticalOffset||r.isDraped)?uot(o.placement)?{placement:"above-center",verticalOffset:Fne(i.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(eO.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+t+" placement)"),null):{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}}function Fne(e){const{screenLength:t,minWorldLength:i,maxWorldLength:r}=e;return{screenLength:t,minWorldLength:i,maxWorldLength:r}}const kd={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},Une={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const e in Une){const t=Une[e],i=kd[e];t.forEach(r=>{kd[r]=i})}Object.freeze&&(Object.freeze(kd),Object.keys(kd).forEach(e=>{Object.freeze(kd[e]),Object.freeze(kd[e].normalizedOffset)}));const aC=[0,0],dot=[0,0],OR=Ls();class kne{constructor(t){this._stage=t,this._materials=new Map}get(t){return this._materials.get(t)}add(t,i){this._materials.set(t,i),this._stage.add(i)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}}const iV=512,rV=4096,pot=.85,fot=.95;let $A=class extends Ee{constructor(e){super(e),this.type=Kd.Texture,this.id=sl(),this.events=new us,this._glTexture=null,this.needsClear=!1,this.elementsToAddOrUpdate=new Map,this.elementsToRemove=new Map,this.elementsToRender=new Map,this.elements=new Map,this.stageObjects=new Map,this.updating=!1}initialize(){this.stage=this.view._stage,this.canvas=this._create2DCanvas(),this.ctx=this.canvas.getContext("2d"),this.stage.add(this);const e=this._computeAtlasResolution(this.view.width,this.view.height);this._createAtlasRegion(e),this._update2DCanvasSize(),this._resetAtlasCursor()}unload(){this._glTexture=Ye(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get width(){return this.atlas.size.width}get height(){return this.atlas.size.height}get requiresFrameUpdates(){return!1}_createDescriptor(e){return{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,flipped:!0,samplingMode:Ke.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,preMultiplyAlpha:!0,maxAnisotropy:e.parameters.maxMaxAnisotropy}}get glTexture(){return this._glTexture}load(e){return _(this._glTexture)||(this._glTexture=new st(e,this._createDescriptor(e),this.canvas),this.frameWorker=this.view.resourceController.scheduler.registerTask(mt.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this.elements=null,this.elementsToAddOrUpdate=null,this.elementsToRemove=null,this.elementsToRender=null,this.frameWorker=Ds(this.frameWorker),this._glTexture&&(this.stage.remove(this),this._glTexture=Ye(this._glTexture)),this.canvas.width=0,this.canvas.height=0,this.canvas=null,this.ctx=null}_create2DCanvas(){const e=document.createElement("canvas");return e.setAttribute("id","canvas2d"),e.setAttribute("style","display:none"),e.setAttribute("width",iV.toString()),e.setAttribute("height",iV.toString()),e}_update2DCanvasSize(){this.canvas.setAttribute("width",this.atlas.size.width.toString()),this.canvas.setAttribute("height",this.atlas.size.height.toString())}_createAtlasRegion(e=iV){this.atlas={size:{width:e,height:e},cursor:{x:0,y:0},lineHeight:0}}_computeAtlasResolution(e,t){let i=Math.max(e,t);return i+=256,i=wS(i),i=Math.min(i,rV),i}_resizeAtlas(e,t){t=t||e;const i=this.atlas;i.size.width=e,i.size.height=t,_(this._glTexture)&&this._glTexture.resize(e,t),this._update2DCanvasSize()}_resetAtlasCursor(){const e=this.atlas;e.cursor.x=lC,e.cursor.y=lC+zne,e.lineHeight=0,this.needsClear=!0}_getAtlasUsage(){const e=this.atlas;return(e.cursor.x+e.cursor.y*e.size.width)/(e.size.width*e.size.height)}_getExpectedAtlasUsage(){const e=this.elementsToRemove.size,t=this.elementsToAddOrUpdate.size,i=this.elements.size;return this._getAtlasUsage()/i*(i+t-e)}_addAtlasElement(e,t,i,r){const s=this.atlas,{renderedWidth:n,renderedHeight:o,displayWidth:a,displayHeight:l}=e.textRenderer;e.placement.offset.x=s.cursor.x,e.placement.offset.y=s.cursor.y,e.placement.size.width=n,e.placement.size.height=o,e.placement.size.displayWidth=a,e.placement.size.displayHeight=l,e.placement.uvMinMax=[e.placement.offset.x/s.size.width,1-(e.placement.offset.y+o)/s.size.height,(e.placement.offset.x+n)/s.size.width,1-e.placement.offset.y/s.size.height],s.cursor.x+=i,s.lineHeight=Math.max(s.lineHeight,r),this.elements.set(t,e)}_removeAtlasElement(e){if(e&&this.elements.has(e.textId)){const t=e.placement.offset,i=e.placement.size;this.ctx.clearRect(t.x,t.y,i.width,i.height),this.elements.delete(e.textId)}}_ensureStageObjects(e){const t=this.stageObjects.get(e);if(t)return t;const i=new Set;return this.stageObjects.set(e,i),i}_addStageObject(e,t){this._ensureStageObjects(e).add(t)}_removeStageObject(e,t){const i=this.stageObjects.get(e);i&&i.delete(t)&&(t.geometries[0].vertexAttributes.get(A.SIZE).data=[0,0],t.geometryVertexAttrsUpdated(t.geometryRecords[0]))}_processAddition(e,t){const i=this.atlas,r=e.textId,s=e.textRenderer.renderedWidth,n=e.textRenderer.renderedHeight,o=s+lC,a=n+lC+zne;if(i.cursor.x+o<i.size.width&&i.cursor.y+a<i.size.height)this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r);else{if(!(i.cursor.y+a+i.lineHeight<i.size.height)){const l=this._getExpectedAtlasUsage(),c=l>pot&&i.size.width<rV;return c&&this._resizeAtlas(2*i.size.width,2*i.size.height),!t||!c&&l>fot&&i.size.width===rV?(this._processRemovals(),BT.OK):(this._repack(),BT.REPACK)}i.cursor.x=lC,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,r,o,a),this.elementsToRender.set(r,e),this.elementsToAddOrUpdate.delete(r)}return BT.OK}_processRemovals(){this.elementsToRemove.forEach((e,t)=>{const i=this.stageObjects.get(t);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this.stageObjects.delete(t)}),this.elementsToRemove.clear()}_repack(){this._processRemovals(),this.elements.forEach((e,t)=>{e.rendered=!1,this.elementsToAddOrUpdate.set(t,e)}),this.elements.clear(),this._resetAtlasCursor(),this.elementsToRender.clear()}_processRenderingRequest(e){this.ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.placement.size.width,e.placement.size.height),e.textRenderer.render(this.ctx,e.placement.offset.x,e.placement.offset.y);const t=this.stageObjects.get(e.textId);t&&t.forEach(i=>{i.geometries[0].vertexAttributes.get(A.UV0).data=new Float32Array(e.placement.uvMinMax),i.geometries[0].vertexAttributes.get(A.SIZE).data=[e.placement.size.displayWidth,e.placement.size.displayHeight],i.geometryVertexAttrsUpdated(i.geometryRecords[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,t=!0){if(!this._glTexture)return;let i=!1;if(Ws(this.elementsToAddOrUpdate,(s,n)=>{const o=this.elements.get(n);if(o&&o.rendered){const a=this.stageObjects.get(n);return a&&a.forEach(l=>{const c=l.geometries[0].vertexAttributes,h=this.elements.get(n);c.get(A.UV0).data=new Float32Array(h.placement.uvMinMax),c.get(A.SIZE).data=new Float32Array([h.placement.size.displayWidth,h.placement.size.displayHeight]),l.geometryVertexAttrsUpdated(l.geometryRecords[0])}),this.elementsToAddOrUpdate.delete(n),!1}return this._processAddition(this.elementsToAddOrUpdate.get(n),t)===BT.REPACK&&(i=!0,!0)}),i)return void this.runTask(rE,!1);let r=!1;this.elementsToRender.size>0&&this.needsClear&&(this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.needsClear=!1),Ws(this.elementsToRender,(s,n)=>(this._processRenderingRequest(s),this.elementsToRender.delete(n),r=!0,e.madeProgress(),e.done)),r&&_(this._glTexture)&&this._glTexture.setData(this.canvas),this.updating=this.elementsToRender.size>0,!this.updating&&fKe.orderedRepackingEnabled&&this.repackOrdered()}addTextTexture(e,t){const i=e.key;this.elementsToAddOrUpdate.has(i)||this.elementsToAddOrUpdate.set(i,{textId:i,placement:{offset:{x:0,y:0},size:{width:0,height:0,displayWidth:0,displayHeight:0},uvMinMax:[]},textRenderer:e,rendered:!1}),this._addStageObject(i,t),this.elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,t){const i=e.key;this.elementsToRemove.set(i,this.elements.get(i)),this._removeStageObject(i,t)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this.elements.size===0)return;const e=[];this.elements.forEach((i,r)=>e.push({element:i,key:r}));let t=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){t=!1;break}if(!t||this.elementsToRemove.size){e.sort((i,r)=>i.key.localeCompare(r.key)),this.elements.clear();for(const{element:i,key:r}of e)this.elements.set(r,i);this._repack(),this.setDirty()}}get test(){const{elements:e,stageObjects:t,elementsToRemove:i,atlas:r}=this,s=this;return{elements:e,stageObjects:t,elementsToRemove:i,atlas:r,_resizeAtlas:(n,o)=>s._resizeAtlas(n,o),run:(n,o)=>s.runTask(n,o)}}};u([d({constructOnly:!0})],$A.prototype,"view",void 0),u([d({type:Boolean})],$A.prototype,"updating",void 0),$A=u([P("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],$A);const lC=2,zne=2;var BT;(function(e){e[e.OK=0]="OK",e[e.REPACK=1]="REPACK"})(BT||(BT={}));const Vne=me.getLogger("esri.views.3d.layers.graphics.Labeler");let f1=class extends Ee{constructor(){super(...arguments),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new qt,this._handles.add([ae(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this.setDirty()),ae(()=>{var e;return(e=this.view.state)==null?void 0:e.pixelRatio},()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(mt.LABELER,this)]),this._textTextureAtlas=new $A({view:this.view}),this._hudMaterialCollection=new kne(this.view._stage),this._calloutMaterialCollection=new kne(this.view._stage)}dispose(){this._handles=ot(this._handles),this._textTextureAtlas=Ye(this._textTextureAtlas),this._hudMaterialCollection=Ye(this._hudMaterialCollection),this._calloutMaterialCollection=Ye(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}_activateLabelingContext(e){e.labels.forEach((t,i)=>{this._labels.set(i,t),t.graphics3DGraphic.setVisibilityFlag(Yc.USER_SETTING,!0,Wn.LABEL)}),e.active=!0}_deactivateLabelingContext(e){e.labels.forEach((t,i)=>{t.graphics3DGraphic.setVisibilityFlag(Yc.USER_SETTING,!1,Wn.LABEL),this.setLabelGraphicVisibility(t.graphics3DGraphic,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.addTextTexture(i,t.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const t of e.graphics3DGraphic.labelGraphics){if(!t._labelClass)continue;const i=e.textTextureResources.textRenderers[t._labelIndex];_(i)&&this._textTextureAtlas.removeTextTexture(i,t.stageObject)}e.rendered=!1}get running(){var e;return this.view.ready&&(this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.running)}runTask(e){this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e)}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const t of this._labelingContexts)if(mot(t)){if(!Bne(t)){if(got(t)){this._deactivateLabelingContext(t);continue}if(this._createLabelClassContext(t),sV(t)){this._dirty=!0;continue}if(!Bne(t))continue}Ws(t.labelsToInitialize,(i,r)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(r,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textTextureResources.initialized||!i.visible&&i.hasGraphics3DResources)&&(t.labelsToInitialize.delete(r),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(t=>this._removeLabelTextureFromAtlas(t)),this._labelsToAdd.forEach(t=>this._addLabelTextureToAtlas(t)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const t=e.labelClassAbortController.signal;await e.layer.when(),li(t),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,r=i.layer,s=r.labelingInfo&&r.labelingInfo.filter(a=>!!a.symbol);if(!s||s.length===0)return;const n=new Array(s.length);let o=!1;await B4(s,async(a,l)=>{const c=a.symbol,h=lZ(i.getOrCreateGraphics3DSymbol(c));if(R(h))return void Vne.error("Failed to create Graphics3DSymbol for label");await h.load(),li(t);let p=null;Aq(c)&&c.hasVisibleCallout()&&(p=jJe(c,i.symbolCreationContext),await p.load(),li(t));const f=await nc(V1e(a,e.layer.fieldsIndex,this.view.spatialReference));if(li(t),f.ok===!0){const m=await this._createTextRenderParameters(h.symbol);li(t),n[l]={labelClass:a,labelFunction:f.value,graphics3DSymbol:h,graphics3DCalloutSymbolLayer:p,calloutSymbolLayerIndex:0,textRenderParameters:m}}else Vne.error(`Label expression failed to evaluate: ${f.error}`),o=!0}),li(t),o||(e.labelClassContexts=n)}async _createLabelClassContext(e){return e.labelClassPromise||(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(t=>{if(Gr(t))throw t;e.labelClassContexts=null}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const t=e.symbolLayers.getItemAt(0);return t&&t.type==="text"?fU.fromSymbol(t,this.view.state.pixelRatio):null}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced,i.graphics3DSymbol=null;const t=e.labelClassAbortController;e.labelClassAbortController=new AbortController,t&&t.abort(),e.labelClassContexts=[],e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,t,i,r,s){const n={text:e.text,centerOffset:i.centerOffset,translation:i.translation,elevationOffset:i.elevationOffset,screenOffset:i.screenOffset,centerOffsetUnits:i.centerOffsetUnits,horizontalPlacement:Kse(i.anchor),verticalPlacement:ptt(i.anchor),verticalOffset:i.verticalOffset,debugDrawLabelBorder:zi.LABELS_SHOW_BORDER,displayWidth:e.displayWidth,displayHeight:e.displayHeight};return my.graphic=t,my.renderingInfo=null,my.layer=r,s.createLabel(my,n,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,t,i,r,s){const n={symbol:t,translation:r.translation,elevationOffset:r.elevationOffset,screenOffset:r.screenOffset,centerOffset:r.centerOffset,centerOffsetUnits:r.centerOffsetUnits,materialCollection:this._calloutMaterialCollection};return my.graphic=e,my.renderingInfo=n,my.layer=s,i.createGraphics3DGraphic(my)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const t=e.graphics3DGraphic;if(t.destroyed)return!1;this._ensureTextTextureResources(e);const{textTextureResources:i}=e,r=e.labelingContext,s=r.labelClassContexts;if(!s||s.length===0||!r.emptySymbolLabelSupported&&t.graphics.length===0)return!1;let n=!1;const o=t.graphic,a=r.layer,l=c9(r.layer),c=this.view._stage;for(let h=0;h<s.length;h++){const p=i.textRenderers[h],f=i.labelPlacements[h];if(R(p)||R(f))continue;const m=s[h],y=m.graphics3DSymbol,v=y.symbol&&y.symbol.type==="label-3d"?y.symbol:null,w=y.symbolLayers[0];if(!w)continue;w.setElevationInfoOverride(r.elevationInfoOverride);const b=this._createTextSymbolGraphic(p,o,f,a,w);if(!b)return!1;b._labelClass=m.labelClass,b._labelIndex=h,t.addLabelGraphic(b,c,r.stageLayer),t.setVisibilityFlag(Yc.USER_SETTING,l,Wn.LABEL),t.clearVisibilityFlag(Yc.SCALE_RANGE,Wn.LABEL),t.setVisibilityFlag(Yc.DECONFLICTION,!1,Wn.LABEL),n=!0;const S=m.graphics3DCalloutSymbolLayer;if(S&&f.hasLabelVerticalOffset){S.setElevationInfoOverride(r.elevationInfoOverride);const T=this._createLineCalloutGraphic(o,v,S,f,a);_(T)&&(m.calloutSymbolLayerIndex=t.labelGraphics.length,t.addLabelGraphic(T,c,r.stageLayer))}break}return r.scaleVisibility&&n&&r.scaleVisibility.updateGraphicLabelScaleVisibility(t),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const t=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelGraphics){if(i._labelClass==null)continue;const r=t[i._labelIndex].graphics3DSymbol.symbolLayers[0];r!=null&&r.onRemoveGraphic(i)}e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){const{textTextureResources:t}=e;if(t.initialized)return;const i=e.labelingContext,r=i.labelClassContexts;if(!r||r.length===0)return;const s=e.graphics3DGraphic.graphic;for(let n=0;n<r.length;n++){const o=r[n];if(t.textRenderers[n]=null,t.labelPlacements[n]=null,!o.textRenderParameters)continue;const a=o.labelFunction;let l;if(a.type==="arcade")try{const b=a.needsHydrationToEvaluate()?XQe(s,i.layer):s;l=a.evaluate(b)}catch{l=null}else l=a.evaluate(s);if(R(l)||l===""||/^\s+$/.test(l))continue;const c=o.graphics3DSymbol,h=c.symbol&&c.symbol.type==="label-3d"?c.symbol:null;if(!c.symbolLayers[0])continue;const p=e.graphics3DGraphic,f=o.labelClass,m=i.disablePlacement,y=iot({graphics3DGraphic:p,labelSymbol:h,labelClass:f,disablePlacement:m});if(R(y))continue;const v=Kse(y.anchor),w=rwe(v);t.textRenderers[n]=new twe(l,w,o.textRenderParameters),t.labelPlacements[n]=y}t.initialized=!0}_destroyTextTextureResources(e){const{textTextureResources:t}=e;t.initialized=!1,t.textRenderers=[],t.labelPlacements=[]}_addGraphic(e,t){const i={hasGraphics3DResources:!1,visible:!1,rendered:!1,labelingContext:e,graphics3DGraphic:t,textTextureResources:{initialized:!1,textRenderers:[],labelPlacements:[]}},r=t.graphic.uid;e.labels.set(r,i),e.labelsToInitialize.set(r,i),this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,t){const i=t.graphic.uid,r=e.labels.get(i);r&&(this._destroyGraphic(r,i),e.labels.delete(i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,t){this._labels.has(t)&&(this._labels.delete(t),this._labelsToAdd.delete(t),this._labelsToRemove.delete(t)),e.textTextureResources.initialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,t){if(!t)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of t){const r=e.labels.get(i);r&&(this._removeGraphic(e,r.graphics3DGraphic),this._addGraphic(e,r.graphics3DGraphic))}}_globalPropertyChanged(e,t){for(const i of t.labelClassContexts){const r=new Map;t.labels.forEach(n=>{const o=n.graphics3DGraphic;r.set(o.graphic.uid,o)});const s=n=>n.labelGraphics[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,r,s),i.graphics3DCalloutSymbolLayer){const n=o=>o.labelGraphics[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,r,n)}}}_visibilityInfoChange(e){const t=e.layer.labelsVisible;t&&!e.active&&this._activateLabelingContext(e),!t&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.labels.forEach((t,i)=>{this._destroyGraphic(t,i),t.visible=!1,t.rendered=!1,e.labelsToInitialize.set(i,t)}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const t of this._labelingContexts)if(t.graphics3DCore===e)return t;return null}addGraphicsOwner(e,t,i){const r=i&&i.emptySymbolLabelSupported||!1,s=i&&i.elevationInfoOverride||null,n=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const o=e.layer,a={graphics3DCore:e,layer:o,scaleVisibility:t,emptySymbolLabelSupported:r,elevationInfoOverride:s,disablePlacement:n,active:o.labelsVisible,labelClassPromise:null,labelClassAbortController:new AbortController,labelClassContexts:[],labels:new Map,labelsToInitialize:new Map,stageLayer:new hbe({isPickable:!0},o.uid)};return this.view._stage.add(a.stageLayer),this._labelingContexts.push(a),this.setDirty(),{addGraphic:l=>this._addGraphic(a,l),removeGraphic:l=>this._removeGraphic(a,l),featureReductionChange:()=>{},layerLabelsEnabled:()=>c9(a.layer),labelingInfoChange:l=>this._labelingInfoChange(a,l),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",a),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",a),visibilityInfoChange:()=>this._visibilityInfoChange(a),reset:()=>this._resetLabels(a),clear:()=>{}}}removeGraphicsOwner(e){const t=this._findLabelingContext(e);if(!t)return;const i=this._labelingContexts.indexOf(t);this._labelingContexts.splice(i,1),t.labels.forEach(r=>this._removeGraphic(t,r.graphics3DGraphic)),this.view._stage.remove(t.stageLayer),t.stageLayer=null,this.setDirty()}setLabelGraphicVisibility(e,t){const i=e.graphic.uid,r=this._labels.get(i);r&&r.visible!==t&&(t&&!r.rendered?(this._labelsToAdd.set(i,r),this._labelsToRemove.delete(i),r.textTextureResources.initialized||r.labelingContext.labelsToInitialize.set(i,r)):!t&&r.rendered&&(this._labelsToRemove.set(i,r),this._labelsToAdd.delete(i)),r.visible=t,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){var e;return this._dirty||((e=this._textTextureAtlas)==null?void 0:e.updating)||this.deconflictor.updating||this._labelingContexts.some(t=>sV(t))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((t,i)=>t+(sV(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function mot(e){return e.active&&c9(e.layer)}function sV(e){return e.labelClassPromise&&!!e.labelClassAbortController}function Bne(e){return e.labelClassContexts&&e.labelClassContexts.length}function got(e){return e.labelClassContexts===null}u([d({constructOnly:!0})],f1.prototype,"view",void 0),u([d({constructOnly:!0})],f1.prototype,"deconflictor",void 0),u([d()],f1.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],f1.prototype,"updating",null),f1=u([P("esri.views.3d.layers.graphics.Labeler")],f1);const my=new qJe(null,null,null);class yot{constructor(){this.gltfCache=new Map,this.wosrCache=new Map,this.evictHandles=new qt}loadGLTF(t,i,r){const s=r?`gltfPBR:${t}`:`gltf:${t}`;return this._fromCache(this.gltfCache,s,n=>Awe(new Ewe(n.streamDataRequester),t,n,r),i)}loadWOSR(t,i){const r=`wosr:${t}:${i.disableTextures}`;return this._fromCache(this.wosrCache,r,s=>Rwe(t,s),i)}destroy(){this.evictHandles.destroy(),this.gltfCache.clear(),this.wosrCache.clear()}get size(){return this.wosrCache.size+this.gltfCache.size}_fromCache(t,i,r,s){return new Promise((n,o)=>{if(Xs(s))return void o(ui());const a=Wo(s,()=>{this._remove(t,i),o(ui())}),l=t.get(i);if(l)return this.evictHandles.remove(i),l.refCount++,void l.item.then(n,o);const c=new AbortController,h=ve(F({},s),{signal:c.signal}),p={refCount:1,abortController:c,item:r(h).then(f=>(p.abortController=null,f.remove=()=>this._remove(t,i),f))};t.set(i,p),p.item.then(f=>{_(a)&&a.remove(),n(f)},f=>{_(a)&&a.remove(),o(f)})})}_remove(t,i){const r=t.get(i);r&&(r.refCount--,r.refCount===0&&this.evictHandles.add(P2e(()=>{t.delete(i),_(r.abortController)&&r.abortController.abort()},_ot),i))}}const vot=1e4;let _ot=vot;class Md{constructor(t,i,r,s=null){this.lij=[0,0,0],this.extent=Dt(),this.resolution=0,this.loadPriority=0,this.measures={visibility:zo.VISIBLE_ON_SURFACE,screenRect:Dt(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(t,i,r,s)}acquire(t,i,r,s){this.tilingScheme=s,this.id=Md.id(t,i,r),this.lij[0]=t,this.lij[1]=i,this.lij[2]=r,s.getExtent(t,i,r,this.extent),this.resolution=s.resolutionAtLevel(t)}release(){this.tilingScheme=null}getChildren(t){const i=this.lij[0]+1,r=2*this.lij[1],s=2*this.lij[2];return t?(t[0].acquire(i,r,s,this.tilingScheme),t[1].acquire(i,r+1,s,this.tilingScheme),t[2].acquire(i,r,s+1,this.tilingScheme),t[3].acquire(i,r+1,s+1,this.tilingScheme),t):[new Md(i,r,s,this.tilingScheme),new Md(i,r+1,s,this.tilingScheme),new Md(i,r,s+1,this.tilingScheme),new Md(i,r+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(t){this.measures.visibility=t.measures.visibility,this.measures.shouldSplit=t.measures.shouldSplit,this.measures.distance=t.measures.distance,vg(t.measures.screenRect,this.measures.screenRect)}static id(t,i,r){return`${t}/${i}/${r}`}}var zo;(function(e){e[e.INVISIBLE=0]="INVISIBLE",e[e.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",e[e.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(zo||(zo={}));class C0{constructor(t){this.renderCoordsHelper=t,this.frustum=UM(),this._points=Wve(),this.lines=new Array(12),this._origin=O(),this._direction=O(),this._altitude=null;for(let i=0;i<12;i++)this.lines[i]={origin:null,direction:O(),endpoint:null}}get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}update(t){Xve(t.viewMatrix,t.projectionMatrix,this.frustum,this._points),se(this._origin,t.eye),se(this._direction,t.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(t){for(let i=0;i<this._points.length;i++)se(this._points[i],t[i]);Yve(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(t){return H0(this.frustum,t)}intersectsRay(t){return EWe(this.frustum,t)}intersectsLineSegment(t,i){return CWe(this.frustum,t,i)}intersectsPoint(t){return Zve(this.frustum,t)}_updateLines(){const t=this._points;for(let i=0;i<4;i++){const r=i+4;nV(this.lines[i],t[i],t[r]),nV(this.lines[i+4],t[i],i===3?t[0]:t[i+1]),nV(this.lines[i+8],t[r],i===3?t[4]:t[r+1])}}}function nV(e,t,i){e.origin=t,e.endpoint=i,Og(e.direction,t,i)}C0.planePointIndices=RWe,C0.nearFarLineIndices=[[Je.NEAR_BOTTOM_LEFT,Je.FAR_BOTTOM_LEFT],[Je.NEAR_BOTTOM_RIGHT,Je.FAR_BOTTOM_RIGHT],[Je.NEAR_TOP_RIGHT,Je.FAR_TOP_RIGHT],[Je.NEAR_TOP_LEFT,Je.FAR_TOP_LEFT]];const jwe=.5*Math.PI,bot=jwe/Math.PI*180;class wot{constructor(t){this.renderCoordsHelper=t.renderCoordsHelper,this.extent=new Array(4),this.planes=new Array(6),this.maxSpan=0,this.center={origin:O(),direction:O()};for(let i=0;i<4;i++)this.extent[i]={origin:O(),direction:O(),cap:{next:null,direction:O()}},this.planes[i]=gi();this.planes[tr.NEAR]=gi(),this.planes[tr.FAR]=gi(),this.planesWithoutFar=this.planes.slice(0,5)}update(t,i,r,s=!0){const n=this.extent;this._toRenderBoundingExtent(t,i,r),de(this.center.origin,n[0].origin,n[2].origin),oe(this.center.origin,this.center.origin,.5),this.renderCoordsHelper.worldUpAtPosition(this.center.origin,this.center.direction),s||oe(this.center.direction,this.center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this.renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,Og(a.cap.direction,a.origin,l.origin),iM(a.direction,a.cap.direction,a.origin,this.planes[o]),s||oe(a.direction,a.direction,-1)}iM(n[0].cap.direction,n[1].cap.direction,n[0].origin,this.planes[tr.NEAR]),s?o9(this.planes[tr.NEAR],this.planes[tr.FAR]):(I4(this.planes[tr.FAR],this.planes[tr.NEAR]),o9(this.planes[tr.NEAR],this.planes[tr.NEAR])),this.maxSpan=Math.max(Math.abs(t[0]-t[2]),Math.abs(t[1]-t[3])),this.maxSpanSpatialReference=i,this.minGlobalAltitude=.9*vi(this.maxSpanSpatialReference).radius}isVisibleInFrustum(t,i,r=!1){if(t==null)return!1;if(this.renderCoordsHelper.viewingMode===Ve.Global){const n=this.maxSpanSpatialReference.isGeographic?bot:jwe*i;if(this.maxSpan>n)return!0;if(t.altitude>=this.minGlobalAltitude)return this._isVisibleInFrustumGlobal(t)}if(this.maxSpan===0){const n=this.extent[0];return!(r||!t.intersectsRay(mu(n.origin,n.direction)))}for(let n=0;n<this.extent.length;n++){const o=this.extent[n];if(!r&&t.intersectsRay(mu(o.origin,o.direction))||t.intersectsLineSegment(mb(o.origin,o.cap.next,Tot),o.cap.direction))return!0}const s=r?this.planes:this.planesWithoutFar;for(let n=0;n<t.lines.length;n++){const o=t.lines[n];if(iqe(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(t,i,r){nq(t,Hh),Hh[2]=r,fu(i,Hh,oV,this.renderCoordsHelper.spatialReference),cs(Gne,oV),cr(bl);for(const{x0:n,x1:o,y0:a,y1:l}of xot)for(let c=0;c<5;c++){const h=c/4;Hh[0]=jt(t[n],t[o],h),Hh[1]=jt(t[a],t[l],h),Hh[2]=r,Js(Hh,i,Hh,this.renderCoordsHelper.spatialReference),Ue(Hh,Hh,Gne),xf(bl,Hh)}ie(this.extent[0].origin,bl[0],bl[1],bl[2]),ie(this.extent[1].origin,bl[3],bl[1],bl[2]),ie(this.extent[2].origin,bl[3],bl[4],bl[2]),ie(this.extent[3].origin,bl[0],bl[4],bl[2]);for(let n=0;n<4;++n)Ue(this.extent[n].origin,this.extent[n].origin,oV)}_toRenderBoundingExtentLocal(t,i,r){A4(t,i,im,this.renderCoordsHelper.spatialReference),ie(this.extent[0].origin,im[0],im[1],r),ie(this.extent[1].origin,im[2],im[1],r),ie(this.extent[2].origin,im[2],im[3],r),ie(this.extent[3].origin,im[0],im[3],r)}_toRenderBoundingExtent(t,i,r){switch(this.renderCoordsHelper.viewingMode){case Ve.Global:this._toRenderBoundingExtentGlobal(t,i,r);break;case Ve.Local:this._toRenderBoundingExtentLocal(t,i,r);break;default:this.renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(t){if(ir(t.planes[tr.NEAR],this.center.origin)<0&&xe(this.center.direction,t.direction)<0)return!0;for(let i=0;i<4;i++){const r=this.extent[i];if(ir(t.planes[tr.NEAR],r.origin)<0&&xe(r.direction,t.direction)<0)return!0}return!1}}const xot=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],Hh=O(),oV=Ae(),Gne=Ae(),bl=Ls(),im=Dt(),Tot=Ff();class Sot{constructor(t){this.renderCoordsHelper=t,this.surfaceElevation=0,this.cache=new Map,this.frustum=new C0(t),this.extendedFrustum=new C0(t),this.intersector=new wot({renderCoordsHelper:t}),this.renderCoordsHelper=t}begin(t,i){this.surfaceElevation=i,this.aboveGround=this.renderCoordsHelper.getAltitude(t.eye)>i,this.frustum.update(t),this._shortenFrustumFarPlane(this.frustum),this._updateExtendedFrustum(t)}end(){this.cache.clear()}calculate(t){if(this.allTilesInvisible)return zo.INVISIBLE;const i=this.renderCoordsHelper.viewingMode===Ve.Global&&t.lij[0]>=Eot&&t.lij[0]<Cot,r=this._getOrCalculateSingleTileVisibility(t,!i);return r!==zo.INVISIBLE&&i?this._calculateAggregatedChildrenVisibility(t):r}_shortenFrustumFarPlane(t){const i=C0.nearFarLineIndices,r=t.mutablePoints;for(const s of i){const[n,o]=s,a=r[n],l=r[o];pe(vc,l,a),oe(vc,vc,Rot),de(r[o],a,vc)}t.updatePoints(r)}_calculateAggregatedChildrenVisibility(t){let i=zo.INVISIBLE;const r=this.cache.get(t.id);if(r!=null)return r;const s=Wne.acquire();t.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==zo.INVISIBLE&&(i=o,o===zo.VISIBLE_ON_SURFACE))break}return Wne.release(s),this.cache.set(t.id,i),i}_getOrCalculateSingleTileVisibility(t,i){const r=this.cache.get(t.id);if(r!=null)return r;const s=this._calculateSingleTileVisibility(t);return i&&this.cache.set(t.id,s),s}_calculateSingleTileVisibility(t){return!this.aboveGround&&this.renderCoordsHelper.viewingMode===Ve.Global&&t.lij[0]<Aot?this._calculateSingleTileVisibilitySided(t,!1)===zo.INVISIBLE?this._calculateSingleTileVisibilitySided(t,!0):void 0:this._calculateSingleTileVisibilitySided(t,this.aboveGround)}_calculateSingleTileVisibilitySided(t,i){this.intersector.update(t.extent,t.tilingScheme.spatialReference,this.surfaceElevation,i);const r=vi(t.tilingScheme.spatialReference).radius;return this.intersector.isVisibleInFrustum(this.extendedFrustum,r)?this.intersector.isVisibleInFrustum(this.frustum,r,!0)?zo.VISIBLE_ON_SURFACE:zo.VISIBLE_WHEN_EXTENDED:zo.INVISIBLE}_updateExtendedFrustum(t){this.extendedFrustum.update(t),this._shortenFrustumFarPlane(this.extendedFrustum);const i=this.renderCoordsHelper.worldUpAtPosition(t.eye,vc);this.aboveGround||qo(i,i);const r=tn(-xe(i,t.viewForward));if(this.allTilesInvisible=r>(Math.PI+t.fovY)/2,this.allTilesInvisible||(this.hasExtendedFrustum=r>t.fovY/2,!this.hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this.extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this.renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this.renderCoordsHelper.worldUpAtPosition(l,vc),a){case Je.FAR_BOTTOM_LEFT:case Je.FAR_TOP_LEFT:case Je.NEAR_BOTTOM_LEFT:case Je.NEAR_TOP_LEFT:a9(this.extendedFrustum.planes[tr.LEFT],vc,vc);break;case Je.FAR_BOTTOM_RIGHT:case Je.FAR_TOP_RIGHT:case Je.NEAR_BOTTOM_RIGHT:case Je.NEAR_TOP_RIGHT:a9(this.extendedFrustum.planes[tr.RIGHT],vc,vc)}oe(vc,vc,s.direction),this.renderCoordsHelper.intersectInfiniteManifold(mu(l,vc),s.zWithMargin,l)}}if(this.extendedFrustum.updatePoints(n),Bo(n[Je.NEAR_BOTTOM_LEFT],n[Je.NEAR_BOTTOM_RIGHT],n[Je.NEAR_TOP_RIGHT],Hne),Bo(n[Je.NEAR_BOTTOM_RIGHT],n[Je.NEAR_TOP_RIGHT],n[Je.NEAR_TOP_LEFT],qne),xe(Hne,qne)<0){const o=this.extendedFrustum.mutablePoints;this.aboveGround?[o[Je.NEAR_BOTTOM_LEFT],o[Je.NEAR_BOTTOM_RIGHT]]=[o[Je.NEAR_BOTTOM_RIGHT],o[Je.NEAR_BOTTOM_LEFT]]:[o[Je.NEAR_TOP_LEFT],o[Je.NEAR_TOP_RIGHT]]=[o[Je.NEAR_TOP_RIGHT],o[Je.NEAR_TOP_LEFT]],this.extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this.aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const t=this.surfaceElevation-jne;return{zWithMargin:t,pointIndices:C0.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:i=>i>t}}_extendedFrustumParametersBelowSurface(){const t=this.surfaceElevation+jne;return{zWithMargin:t,pointIndices:C0.planePointIndices.top,direction:1,needsAltitudeAdjustment:i=>i<t}}}const Eot=2,Cot=6,Aot=12,Rot=.95,jne=1,vc=O(),Hne=gi(),qne=gi(),Wne=new ys(Array,e=>{e.length!==4&&(e[0]=new Md,e[1]=new Md,e[2]=new Md,e[3]=new Md)},e=>{e[0].release(),e[1].release(),e[2].release(),e[3].release()});class Mot{constructor(t){this.camera=new Yi,this.focusOnMap=[0,0],this.screenRect=Dt(),this.tileSize=t.tileSize,this.renderCoordsHelper=t.renderCoordsHelper,this.tilingScheme=t.tilingScheme,this.visibility=new Sot(t.renderCoordsHelper)}begin(t,i,r){this.camera.copyFrom(t),this.surfaceElevation=r,this.focusOnMap[0]=i.x,this.focusOnMap[1]=i.y,sq(0,0,t.fullWidth,t.fullHeight,this.screenRect),this.visibility.begin(this.camera,r)}end(){this.visibility.end()}updateTile(t){t.measures.visibility=this.visibility.calculate(t),t.measures.distance=sRe(t.extent,this.focusOnMap),t.measures.visibility!==zo.INVISIBLE&&this._updateScreenMeasure(t)}_updateScreenMeasure(t){const i=Oot,r=1<<i,s=t.measures.screenRect;hu(s);let n=0;const o=t.lij[0]+i,a=t.lij[1]<<i,l=t.lij[2]<<i,c=this._tileSizeWithBias(t),h=c*c;for(let p=0;p<r;p++)for(let f=0;f<r;f++)if(n+=this._computeScreenArea(t,o,a+p,l+f,s),n>h)return void(t.measures.shouldSplit=!0);t.measures.shouldSplit=!1}_tileSizeWithBias(t){return t.measures.visibility===zo.VISIBLE_WHEN_EXTENDED?this.tileSize*Pot:this.tileSize}_computeScreenArea(t,i,r,s,n){const o=t.measures.visibility===zo.VISIBLE_WHEN_EXTENDED;this._projectToScreen(i,r,s,o,gy),hu(aV);for(let a=0;a<4;a++)JT(aV,gy[a]);return cb(n,aV,n),Cie(gy[0],gy[1],gy[2])+Cie(gy[0],gy[2],gy[3])}_projectToScreen(t,i,r,s,n){this.tilingScheme.ensureMaxLod(t),this.tilingScheme.getExtent(t,i,r,cC),this._toRenderCoords(cC,0,3,yy[0]),this._toRenderCoords(cC,2,3,yy[1]),this._toRenderCoords(cC,2,1,yy[2]),this._toRenderCoords(cC,0,1,yy[3]),s&&(this._projectToPlane(yy,this.camera.frustum[tr.NEAR]),this._projectToPlane(yy,this.camera.frustum[tr.TOP]),this._projectToPlane(yy,this.camera.frustum[tr.BOTTOM]));for(let o=0;o<4;o++)this.camera.projectToRenderScreen(yy[o],Xne),this.camera.renderToScreen(Xne,n[o])}_projectToPlane(t,i){for(let s=0;s<4;s++)hC[s]=ir(i,t[s]);const r=Math.max(hC[0],hC[1],hC[2],hC[3]);if(r>0){const s=oe(uC,i,-r);for(let n=0;n<4;n++)de(t[n],t[n],s)}}_toRenderCoords(t,i,r,s){return uC[0]=t[i],uC[1]=t[r],uC[2]=this.surfaceElevation,this.renderCoordsHelper.toRenderCoords(uC,this.tilingScheme.spatialReference,s),s}}const aV=Dt(),Oot=2,Pot=5,gy=[Vr(),Vr(),Vr(),Vr()],cC=Dt(),uC=O(),yy=[O(),O(),O(),O()],hC=[0,0,0,0],Xne=wo();function S1t(e,t,i){if(R(e)||R(i))return!1;let r=!0;return Gs[0]=e.xmin!=null?e.xmin:0,Gs[1]=e.ymin!=null?e.ymin:0,Gs[2]=e.zmin!=null?e.zmin:0,r=r&&ar(Gs,e.spatialReference,0,t,i,0,1),Gs[0]=e.xmax!=null?e.xmax:0,Gs[1]=e.ymax!=null?e.ymax:0,Gs[2]=e.zmax!=null?e.zmax:0,r=r&&ar(Gs,e.spatialReference,0,t,i,3,1),e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.zmin==null&&(t[2]=-1/0),e.xmax==null&&(t[3]=1/0),e.ymax==null&&(t[4]=1/0),e.zmax==null&&(t[5]=1/0),r}function Hwe(e,t,i){if(R(e)||R(i))return!1;let r=!0;return Gs[0]=e.xmin!=null?e.xmin:0,Gs[1]=e.ymin!=null?e.ymin:0,Gs[2]=e.zmin!=null?e.zmin:0,r=r&&ar(Gs,e.spatialReference,0,Gs,i,0,1),t[0]=Gs[0],t[1]=Gs[1],Gs[0]=e.xmax!=null?e.xmax:0,Gs[1]=e.ymax!=null?e.ymax:0,Gs[2]=e.zmax!=null?e.zmax:0,r=r&&ar(Gs,e.spatialReference,0,Gs,i,0,1),t[2]=Gs[0],t[3]=Gs[1],e.xmin==null&&(t[0]=-1/0),e.ymin==null&&(t[1]=-1/0),e.xmax==null&&(t[2]=1/0),e.ymax==null&&(t[3]=1/0),r}const Gs=O(),Iot=me.getLogger("esri.views.3d.layers.support.FeatureTileTree3D");let Bn=class extends Ee{constructor(e){super(e),this.tiles=new at,this.tileSize=512,this._idToTile=new Map,this._handles=new qt,this._clients=new Set,this._dirty=!1,this._newTiles=new Bt}get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(_(e)&&!e.spatialReference.equals(this.viewState.spatialReference))return void Iot.error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const t=this._get("filterExtent");if(t===e||_(t)&&e&&t.equals(e))return;const i=_(e)?e.clone():null;this._set("filterExtent",i),this._setDirty()}get filterExtentRect(){if(R(this.filterExtent)||!this.tilingScheme)return null;const e=Dt();return Hwe(this.filterExtent,e,this.tilingScheme.spatialReference),e}get rootTileIds(){return this.filterExtentRect?this.tilingScheme.rootTilesInExtent(this.filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}initialize(){this._handles.add([ae(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),rr),ae(()=>{var e,t,i;return[this.tileSize,(e=this.cameraOnSurface)==null?void 0:e.location,this.tilingScheme,(t=this.viewState)==null?void 0:t.contentCamera,(i=this.focus)==null?void 0:i.location]},()=>this._setDirty(),Ms)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(mt.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Ds(this._frameWorker),this._handles=ot(this._handles)}addClient(){const e=Dot();return this._clients.add(e),this._clients.size===1&&this._setDirty(),{remove:()=>this._removeClient(e)}}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(rE))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),_(this._frameWorker)&&(this._frameWorker.priority=mt.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),!this._pendingTiles&&_(this._frameWorker)&&(this._frameWorker.priority=mt.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new Mot({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){return this.rootTileIds.map(e=>new Md(e[0],e[1],e[2],this.tilingScheme))}_purgeHorizonTiles(e){e.sort((t,i)=>{const r=t.measures.screenRect,s=i.measures.screenRect;return r[1]+r[3]-(s[1]+s[3])}),hu(FI);for(let t=0;t<e.length;t++)if(cb(FI,e.data[t].measures.screenRect,FI),Yd(FI)>Lot)return e.data.slice(t,e.length);return[]}_subdivideTilesForView(e){if(this._pendingTiles){for(;this._pendingTiles.length>0&&!e.done;){const t=this._pendingTiles.pop();e.madeProgress(),this.filterExtentRect&&!TO(this.filterExtentRect,t.extent)||(this._tileMeasurements.updateTile(t),t.measures.visibility!==zo.INVISIBLE&&(t.measures.shouldSplit?(this.tilingScheme.ensureMaxLod(t.lij[0]+1),this._pendingTiles.push(...t.getChildren())):this._newTiles.push(t)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}}_updateTiles(e){for(const r of this.tiles.items)r.used=!1;const t=e.filter(r=>{const s=this._idToTile.get(r.id);return s?(s.copyMeasurementsFrom(r),s.used=!0):this._idToTile.set(r.id,r),!s}),i=this.tiles.items.filter(r=>!r.used&&(this._idToTile.delete(r.id),!0));this.tiles.removeMany(i),this.tiles.addMany(t),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,t)=>e.measures.visibility!==t.measures.visibility?e.measures.visibility===zo.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-t.measures.distance),this.tiles.forEach((e,t)=>e.loadPriority=t)}};u([d({constructOnly:!0})],Bn.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Bn.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Bn.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],Bn.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],Bn.prototype,"focus",void 0),u([d({constructOnly:!0})],Bn.prototype,"viewState",void 0),u([d({constructOnly:!0})],Bn.prototype,"terrain",void 0),u([d()],Bn.prototype,"tiles",void 0),u([d()],Bn.prototype,"tileSize",void 0),u([d({readOnly:!0})],Bn.prototype,"tilingScheme",null),u([d()],Bn.prototype,"filterExtent",null),u([d({readOnly:!0})],Bn.prototype,"filterExtentRect",null),u([d({readOnly:!0})],Bn.prototype,"rootTileIds",null),u([d({value:!1})],Bn.prototype,"suspended",null),u([d({readOnly:!0})],Bn.prototype,"updating",null),Bn=u([P("esri.views.3d.layers.support.FeatureTileTree3D")],Bn);let $ot=0;function Dot(){return $ot++}const FI=Dt(),Lot=10;let Vn=class extends Ee{constructor(){super(...arguments),this._propertiesPool=new Tg({camera:Yi},this),this._lastSeenCameraProjectionValues=new Yi,this.events=new us,this.viewingMode=Ve.Global,this._cameraChanged=!1,this.updateQueue=new Array,this.processingUpdates=!1}init(e,t){this._set("viewingMode",e),this._set("spatialReference",t),this._set("constraints",new Em({mode:this.viewingMode}))}exit(){this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new Tg({camera:Yi},this)}createInitialCamera(){if(this.viewingMode===Ve.Global){const e=vi(this.spatialReference).radius;this.camera=new Yi(Fe(4*e,0,0),Fe(e,0,0),Fe(0,0,1))}else this.camera=new Yi(Fe(0,0,100),Fe(0,0,0),Fe(0,1,0))}get animation(){return this.cameraController instanceof kM&&_(this.cameraController.viewAnimation)?this.cameraController.viewAnimation:null}get camera(){return this._get("camera")}set camera(e){e!==Mu&&Mu.copyFrom(e),Mu.computeUp(this.viewingMode),Yne.camera=Mu,this.events.emit("before-camera-change",Yne);const t=this._get("camera");if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,Mu)&&(this._lastSeenCameraProjectionValues.copyFrom(Mu),Zne.camera=this._lastSeenCameraProjectionValues,this.events.emit("camera-projection-changed",Zne)),(!t||!t.equals(Mu))&&(this._set("camera",this._propertiesPool.get("camera").copyFrom(Mu)),this._cameraChanged=!t||!t.almostEquals(Mu),this._cameraChanged)){const i=Ace(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get contentCamera(){return _(this._contentCamera)?this._contentCamera:this.camera}set contentCamera(e){this._contentCamera=_(e)?e.clone():null}get fixedContentCamera(){return _(this._contentCamera)}get isGlobal(){return this.viewingMode===Ve.Global}get isLocal(){return this.viewingMode===Ve.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(e&&(this.own(ae(()=>e.state,t=>{t!==Ir.Finished&&t!==Ir.Stopped||(this._set("cameraController",null),this.updateCamera(i=>e.onControllerEnd(i)))},rr)),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=Ir.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==Ir.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this.updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this.updateQueue.length===0||this.processingUpdates)return;this.processingUpdates=!0;const e=this.updateQueue.shift();Mu.copyFrom(this._get("camera")),e(Mu),this.camera=Mu,this.processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,t){return e.fov!==t.fov||e.fullViewport[0]!==t.fullViewport[0]||e.fullViewport[1]!==t.fullViewport[1]||e.fullViewport[2]!==t.fullViewport[2]||e.fullViewport[3]!==t.fullViewport[3]||e.padding[Ct.TOP]!==t.padding[Ct.TOP]||e.padding[Ct.RIGHT]!==t.padding[Ct.RIGHT]||e.padding[Ct.BOTTOM]!==t.padding[Ct.BOTTOM]||e.padding[Ct.LEFT]!==t.padding[Ct.LEFT]}};u([d({readOnly:!0,type:s2})],Vn.prototype,"animation",null),u([d({type:Yi})],Vn.prototype,"camera",null),u([d()],Vn.prototype,"pixelRatio",null),u([d({})],Vn.prototype,"_contentCamera",void 0),u([d({type:Yi})],Vn.prototype,"contentCamera",null),u([d({readOnly:!0})],Vn.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],Vn.prototype,"constraints",void 0),u([d({readOnly:!0})],Vn.prototype,"events",void 0),u([d({readOnly:!0})],Vn.prototype,"isGlobal",null),u([d({readOnly:!0})],Vn.prototype,"isLocal",null),u([d({readOnly:!0})],Vn.prototype,"viewingMode",void 0),u([d({readOnly:!0})],Vn.prototype,"spatialReference",void 0),u([d({readOnly:!0})],Vn.prototype,"navigating",null),u([d({readOnly:!0})],Vn.prototype,"stationary",null),u([d()],Vn.prototype,"_cameraChanged",void 0),u([d()],Vn.prototype,"cameraController",null),Vn=u([P("esri.views.3d.state.ViewState")],Vn);const Not=Vn,Mu=new Yi,Yne={camera:null},Zne={camera:null};function Fot(e,t,i){return e===Ve.Global?new kot(i):new Uot(t,i)}class Uot{constructor(t,i){this.elevationProvider=t,this._referenceEllipsoid=vi(i),this.unitInMeters=cc(i,this._referenceEllipsoid.metersPerDegree)}compute(t,i,r,s,n){n||(n={near:0,far:0});let o=t[2]*this.unitInMeters;const a=o,l=o-s,c=this.elevationProvider?this.elevationProvider.elevationBounds:null;c&&(o=l>=0?a-this.unitInMeters*c.min:this.unitInMeters*c.max-a);const h={x:(r=_(r)?r:new ci({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-r.xmin,y:r.ymax-r.ymin,z:4*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},p=Math.max(h.x,h.y,h.z);pe(S_,i,t),lx[0]=S_[0]>0?r.xmax:r.xmin,lx[1]=S_[1]>0?r.ymax:r.ymin,lx[2]=S_[2]>0?p/2:-p/2,pe(lx,lx,t),we(S_,S_);const f=1.1*xe(lx,S_)*this.unitInMeters,m=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),y=Math.max(r.xmax-r.xmin,r.ymax-r.ymin),v=y*Bot*this.unitInMeters,w=y*Got*this.unitInMeters;let b=$e((o-w)/(v-w),0,1);b*=b*b;let S=jt(m,f,b);return S*=Math.max(Math.log(Math.abs(l)),1),S=Math.min(S,Math.max(34064e4,p)),S/=this.unitInMeters,qwe(S,zot,this.unitInMeters,n)}}class kot{constructor(t){this._referenceEllipsoid=vi(t)}compute(t,i,r,s,n){n||(n={near:0,far:0});const o=Me(t)-this._referenceEllipsoid.radius,a=this._referenceEllipsoid.radius+Math.min(0,s),l=Math.abs(o-s),c=Math.max(l,Math.abs(o));return qwe(1.2*Math.sqrt(c*(c+2*a)),$e(2e4-(Math.log(c)-7.983)/9.011*19e3,1e3,2e4),1,n)}}function qwe(e,t,i,r){const s=Vot/i;return e/t>s?(r.far=e,r.near=r.far/t):(r.near=s,r.far=r.near*t),r}const zot=2e4,Vot=2,Bot=.001,Got=1e-4,lx=O(),S_=O();let oL=class extends Ee{constructor(e){super(e),this.handles=new qt}initialize(){this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const t=this.view.state.camera;Nve(this.view,t,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>{oE(this.view,e,vh.EYE_AND_CENTER)})}};u([d({constructOnly:!0})],oL.prototype,"view",void 0),oL=u([P("esri.views.3d.state.ElevationCollisionConstraint")],oL);let DA=class extends Ee{constructor(e){super(e),this._handles=new qt,this.nearFarHeuristic=Fot(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this._handles.add([ae(()=>{var e,t,i,r;return[(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.near,(r=(i=this.view.constraints)==null?void 0:i.clipDistance)==null?void 0:r.far]},()=>this._clipDistanceNearFarChanged()),ae(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.clipDistance)==null?void 0:t.mode},()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e.camera)),ae(()=>this.view.renderDataExtent,()=>this._updateNearFar(),rr),ae(()=>{var e,t,i,r;return[(t=(e=this.view.constraints)==null?void 0:e.altitude)==null?void 0:t.min,(r=(i=this.view.constraints)==null?void 0:i.altitude)==null?void 0:r.max]},()=>this._updateAltitude(),rr),ae(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.max},()=>this._updateTiltMax(),rr),ae(()=>{var e,t;return(t=(e=this.view.constraints)==null?void 0:e.tilt)==null?void 0:t.mode},()=>this._updateTilt(),rr),ae(()=>{var e;return(e=this.view.state)==null?void 0:e.camera},()=>this._updateTiltAutoMax(),rr),ae(()=>{var e,t,i,r,s,n;return[(i=(t=(e=this.view.map)==null?void 0:e.ground)==null?void 0:t.navigationConstraint)==null?void 0:i.type,(n=(s=(r=this.view.state)==null?void 0:r.constraints)==null?void 0:s.collision)==null?void 0:n.enabled]},()=>this._updateCollision(),rr)]),this.view.state.isLocal&&this._handles.add(ae(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),Ft)),this._updateNearFar(),this.view.state.viewingMode!==Ve.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new oL({view:this.view}))}destroy(){this._handles=ot(this._handles),this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){var t;const e=(t=this.view.constraints)==null?void 0:t.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(i=>(this._updateCameraNearFarManual(i,e),!0))}_updateNearFar(){this.view.state.updateCamera(e=>(this._updateCameraNearFar(e),!0))}_updateCameraNearFar(e){const t=this.view.constraints&&this.view.constraints.clipDistance;(t?t.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,t):this._updateCameraNearFarAuto(e,t)}_updateCameraNearFarAuto(e,t){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,x5(this.view,e.eye),e),t&&t.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,t){t&&(e.near=t.near,e.far=t.far)}_updateCollision(){var r,s,n;const e=(n=(s=(r=this.view.map)==null?void 0:r.ground)==null?void 0:s.navigationConstraint)==null?void 0:n.type,t=!e||e==="stay-above",i=this.view.state.constraints.collision;if(t!==i.enabled){i.enabled=t,t&&this._reapplyConstraints(mr.COLLISION);const o=this.view.constraints&&this.view.constraints.tilt;o&&o.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ve.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const t=this.view.state.constraints;t.tilt=t.createConstantMaxTilt($t(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const t=this.view.state.constraints;if(t.tilt){const i=t.tilt(this.view.state.camera.distance).max;e.autoUpdate(ec(i))}}_updateLocalSurfaceDistance(e){if(R(e))return;let t=Math.max(e.width,e.height);if(t<=0)return;e.hasZ&&(t=Math.max(t,e.zmax-e.zmin));const i=this.view.state,r=3*t/Math.atan(i.camera.fov/2);r!==i.constraints.distance&&(i.constraints.distance=r)}_reapplyConstraints(e=mr.ALL){this.view.state.updateCamera(t=>as(this.view,t,{selection:e,interactionType:kt.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:Rn.TUMBLE}))}};u([d({constructOnly:!0})],DA.prototype,"view",void 0),u([d({readOnly:!0})],DA.prototype,"surfaceCollisionConstraint",void 0),DA=u([P("esri.views.3d.state.ConstraintsManager")],DA);let GT=class extends eb{constructor(e){super(e),this.handles=new qt}set desiredCamera(e){this._set("desiredCamera",e.clone())}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=Ir.Running,this.handles.add(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.handles.removeAll()}stepController(){}_handleElevationChangeEvent(e){Nve(this.view,this.desiredCamera,e.extent,e.spatialReference)&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),oE(this.view,e,vh.EYE_AND_CENTER)||this.constraintEnabled||(this.state=Ir.Stopped)})}};u([d({constructOnly:!0})],GT.prototype,"view",void 0),u([d({constructOnly:!0})],GT.prototype,"desiredCamera",null),GT=u([P("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],GT);const jot=.66;function Wwe(e){return 360-LH.normalize(e)}function mU(e){return LH.normalize(360-e)}function UI(e){return _(e)&&e.resolver&&e.resolver.reject(),null}function Hot(e,t){return _(e)&&e.resolver&&e.resolver.resolve(t),t}function hZ(e,t,i,r=null){if(!t)return UI(r);const s=e.spatialReference||Xe.WGS84;if(_(t.camera)){const c=aw(t.camera.position,s);if(R(c))return UI(r);const h=t.camera.clone();return h.position=c,Hot(r,h)}if(R(t.targetGeometry))return UI(r);const n=t.get("targetGeometry.spatialReference");if(n&&!K0(n,s))return UI(r);const o=x2(e,e.state.camera);let a=So.ADJUST;if(t.rotation!=null&&(o.heading=Wwe(t.rotation),a=So.LOCKED),i!=null&&(o.tilt=i),t.targetGeometry.type==="point"){const c=t.targetGeometry;let h;const p=t.targetGeometry.clone();return h=t.scale!=null?xY(e,t.scale,c.latitude):e.state.camera.distance,R_e(e,p,h,o,a,r)}const l=t.targetGeometry.extent;return _R(e,l,o.heading,o.tilt,a,r)}function qot(e,t,i=null){return R(i)&&(i=new sc),fZ(e,null,t.clone(),i)}async function Wot(e,t,i){const r=rat(e,t);if(!r)throw new q("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new rc({fov:e.camera.fov}),n=new sc({camera:s});if(r.target instanceof sc)return E_(await Zot(e,r.target,r,i,n));if(r.target instanceof rc)return E_(Ywe(e,r.target,n));const o=r.scale!=null||r.zoom!=null;if(r.target instanceof ci){const c=r.target.xmin===r.target.xmax||r.target.ymin===r.target.ymax;return E_(o||c?await gj(e,r,r.target.center,s,i,n):await eat(e,r,r.target,s,i,n))}const a={boundingBox:cr(),hasZ:!1,screenSpaceObjects:[]},l=o?Xot(e,r):void 0;if(await Xwe(e,r.target,l,a),isFinite(a.boundingBox[0])){let c;if(Id(a.boundingBox,os),zc.x=os[0],zc.y=os[1],zc.z=os[2],zc.spatialReference=e.spatialReference,isFinite(zc.z)&&a.hasZ?c=p4(a.boundingBox):(zc.z=void 0,c=nRe(lq(a.boundingBox,nat))),o||c)return E_(await gj(e,r,zc,s,i,n));const h=sat(e,a.screenSpaceObjects);return E_(await iat(e,r,zc,a.boundingBox,h,s,i,n))}return r.position?E_(Jot(e,r,s,n)):E_(await Kot(e,r,s,i,n))}function dZ(e,t){return t.scale==null&&t.zoom!=null?P_e(e,t.zoom):t.scale}function Xot(e,t){return tYe(e,dZ(e,t))}function pZ(e,t){let i=!1;return t.heading!=null?(e.heading=t.heading,i=!0):t.rotation!=null&&(e.heading=Wwe(t.rotation),i=!0),t.tilt!=null&&(e.tilt=t.tilt,i=!0),t.fov!=null&&(e.fov=t.fov),i}function fZ(e,t,i,r){const s=e.spatialReference||Xe.WGS84;return t=_(t)?t:km(e,i),R(t)||(r.targetGeometry=mv(t.center,e.renderSpatialReference,s),r.scale=I_e(e,t),r.rotation=mU(i.heading),r.camera=i),r}function PF(e,t,i){if(!t)return;if(!K0(t.spatialReference,e.spatialReference))throw new q("viewpointutils:incompatible-spatialreference",`Spatial reference (${t.spatialReference?t.spatialReference.wkid:"unknown"}) is incompatible with the view (${e.spatialReference.wkid})`,{geometry:t});const r=[];if(!t.hasZ&&e.basemapTerrain){let o;switch(t.type){case"point":o=t;break;case"multipoint":case"polyline":o=t.extent.center;break;case"mesh":o=t.origin;break;case"extent":o=t.center;break;case"polygon":o=t.centroid}o&&K0(o,e.basemapTerrain.spatialReference)?os[2]=yt(lf(e.elevationProvider,o),0):os[2]=0}(0,oat[t.type])(t,o=>{r.push(o[0],o[1],o[2])},os);const s=r.length/3;if(s===0)return;const n=new Array(r.length);if(ar(r,t.spatialReference,0,n,e.spatialReference,0,s)){t.hasZ&&(i.hasZ=!0);for(let o=0;o<n.length;o+=3)t.hasZ?(os[0]=n[o+0],os[1]=n[o+1],os[2]=n[o+2]):(os[0]=n[o+0],os[1]=n[o+1]),xf(i.boundingBox,os)}}async function Yot(e,t,i,r){const s=await nc(e.whenViewForGraphic(t));if(s.ok===!1||R(s.value)||!("whenGraphicBounds"in s.value))return void PF(e,t.geometry,r);const n=s.value,o=await nc(n.whenGraphicBounds(t,{minDemResolution:i}));if(o.ok===!1)return void PF(e,t.geometry,r);const{screenSpaceObjects:a,boundingBox:l}=o.value;NS(r.boundingBox,l),a&&a.forEach(c=>{r.screenSpaceObjects.push(c)}),isFinite(l[2])&&(r.hasZ=!0)}async function Xwe(e,t,i,r){if(Array.isArray(t)&&t.length===2){const s=t[0],n=t[1];if(typeof s=="number"&&typeof n=="number")return zc.x=s,zc.y=n,zc.z=void 0,zc.spatialReference=e.spatialReference.isGeographic?e.spatialReference:Xe.WGS84,void PF(e,zc,r)}t&&typeof t.map=="function"?await pn(t.map(s=>Xwe(e,s,i,r))):t instanceof ic?PF(e,t,r):t instanceof Ca&&await Yot(e,t,i,r)}async function Zot(e,t,i,r,s){if(_(t.camera))return Ywe(e,t.camera,s);s.scale=t.scale,s.rotation=t.rotation,s.targetGeometry=_(t.targetGeometry)?t.targetGeometry.clone():null,s.camera=null,i.heading!=null?s.rotation=mU(i.heading):i.rotation!=null&&(s.rotation=i.rotation);const n=dZ(e,i);n!=null&&(s.scale=n);const o=new cE(r);return hZ(e,s,i.tilt,o),s.camera=await o.resolver.promise,s}function Ywe(e,t,i){const r=e.spatialReference,s=aw(t.position,r);return R(s)?null:((t=t.clone()).fov=e.camera.fov,t.position=s,fZ(e,null,t,i))}function Qot(e,t,i,r,s,n){const o=e.renderSpatialReference;return Mn(i.position,zI,o),Mn(t,lV,o),n.targetGeometry=new nt(t),s.position=new nt(i.position),pe(IF,lV,zI),E5(e,zI,IF,r.up,s),n.scale=Jb(e,nr(zI,lV),n.targetGeometry.latitude),n.rotation=mU(s.heading),n.camera=s,n}async function gj(e,t,i,r,s,n){if(R(i))throw new q("createfromcenter","invalid point");n.targetGeometry=i.clone();const o=xw(e);if(t.position)return Qot(e,n.targetGeometry,t,o,r,n);if(t.zoomFactor){const l=o.distance/t.zoomFactor,c=oe(os,o.viewForward,-l);o.eye=de(os,o.center,c),n.scale=Jb(e,l,i.latitude)}x2(e,o,r);const a=pZ(r,t)?So.LOCKED:So.ADJUST;if(!t.zoomFactor){n.scale=dZ(e,t),n.scale==null&&(Mn(i,os,e.renderSpatialReference),Zve(o.frustum,os)?n.scale=Jb(e,nr(o.eye,os),i.latitude):n.scale=I_e(e,o));const l=new cE(s);A_e(e,n.targetGeometry,n.scale,r,a,l),n.camera=await l.resolver.promise}return n}function Jot(e,t,i,r){const s=xw(e);return se(IF,s.viewForward),E5(e,s.eye,IF,s.up,cV),i.position=new nt(t.position),i.heading=t.heading!=null?t.heading:cV.heading,i.tilt=t.tilt!=null?t.tilt:cV.tilt,fZ(e,null,i,r)}async function Kot(e,t,i,r,s){const n=xw(e);return gj(e,t,mv(n.center,e.renderSpatialReference,e.spatialReference),i,r,s)}async function eat(e,t,i,r,s,n){n.targetGeometry=i.clone();const o=xw(e);x2(e,o,r);const a=pZ(r,t)?So.LOCKED:So.ADJUST,l=new cE(s);return _R(e,i,r.heading,r.tilt,a,l),n.camera=await l.resolver.promise,n}function tat(e,t,i,r,s){let n=0;i.hasZ?n=i.z:e.basemapTerrain&&(n=lf(e.elevationProvider,i)),ie(os,i.x,i.y,n),fu(e.spatialReference,os,Qne,e.renderSpatialReference),Ch(kI,Qne),Ah(kI,kI),cr(dC);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let y=0;y<o.length;y++){const v=o[y];let w=r[v[2]];isFinite(w)||(w=n),ie(os,r[v[0]],r[v[1]],w),Js(os,e.spatialReference,os,e.renderSpatialReference),xf(dC,ql(os,os,kI))}const a=hw(dC),l=$v(dC),c=dw(dC),h=1/Math.tan(t.fovX/2),p=1/Math.tan(t.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,m=.5*l*p+.5*Math.max(a,c);return Math.max(f,m)/s}async function iat(e,t,i,r,s,n,o,a){a.targetGeometry=i.clone();const l=xw(e),c=tat(e,l,i,r,s);x2(e,l,n);const h=pZ(n,t)?So.LOCKED:So.ADJUST;a.scale=Jb(e,c,a.targetGeometry.latitude);const p=new cE(o);return A_e(e,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function rat(e,t){if(!t||!e.spatialReference)return null;const i={target:null};if("declaredClass"in t||Array.isArray(t))i.target=t;else{for(const r in t)i[r]=t[r];t.center&&!i.target&&(i.target=t.center)}return i}function E_(e){return e&&_(e.camera)&&(e.rotation=mU(e.camera.heading)),e}function sat(e,t){const i=jot;if(!t.length)return i;let r=Number.NEGATIVE_INFINITY;for(let s=0;s<t.length;s++){const n=t[s].screenSpaceBoundingRect;r=Math.max(r,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return i-r/Math.min(e.width,e.height)*2}const os=O(),Qne=Ae(),kI=Sr(),dC=Ls(),nat=Dt(),IF=O(),zI=O(),lV=O(),cV={heading:0,tilt:0},zc=new nt,oat={point(e,t,i){i[0]=e.x,i[1]=e.y,e.hasZ&&(i[2]=e.z),t(i)},polygon(e,t,i){const r=e.hasZ;for(let s=0;s<e.rings.length;s++){const n=e.rings[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},polyline(e,t,i){const r=e.hasZ;for(let s=0;s<e.paths.length;s++){const n=e.paths[s];for(let o=0;o<n.length;o++)i[0]=n[o][0],i[1]=n[o][1],r&&(i[2]=n[o][2]),t(i)}},multipoint(e,t,i){const r=e.points,s=e.hasZ;for(let n=0;n<r.length;n++)i[0]=r[n][0],i[1]=r[n][1],s&&(i[2]=r[n][2]),t(i)},extent(e,t,i){e.hasZ?(t(ie(i,e.xmin,e.ymin,e.zmin)),t(ie(i,e.xmax,e.ymin,e.zmin)),t(ie(i,e.xmin,e.ymax,e.zmin)),t(ie(i,e.xmax,e.ymax,e.zmin)),t(ie(i,e.xmin,e.ymin,e.zmax)),t(ie(i,e.xmax,e.ymin,e.zmax)),t(ie(i,e.xmin,e.ymax,e.zmax)),t(ie(i,e.xmax,e.ymax,e.zmax))):(t(ie(i,e.xmin,e.ymin,i[2])),t(ie(i,e.xmax,e.ymin,i[2])),t(ie(i,e.xmin,e.ymax,i[2])),t(ie(i,e.xmax,e.ymax,i[2])))},mesh(e,t,i){const r=e.vertexAttributes&&e.vertexAttributes.position;if(r)for(let s=0;s<r.length;s+=3)t(ie(i,r[s+0],r[s+1],r[s+2]))}};class aat{constructor(t,i,r){this.target=t,this.options=i,this.view=r,this.state="pending",this.abortController=null,this.animationController=null,this.promise=new Promise((s,n)=>{this.resolveCallback=s,this.rejectCallback=n;const o=new AbortController;_(this.options.signal)&&Wo(this.options.signal,()=>{this.abort()}),this.abortController=o,this.waitForReady()})}then(t,i){return this.promise.then(t,i)}catch(t){return this.promise.catch(t)}resolve(t){return this.state="finished",this.resolveCallback(t)}reject(t){return this.state="finished",this.rejectCallback(t)}abort(t=!1){switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":this.reject(ui());break;case"wait-for-animation-finish":!t&&_(this.animationController)&&this.view.state.cameraController===this.animationController&&this.animationController.active&&this.animationController.stopController(),this.reject(ui())}}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await BR(()=>this.view.ready,this.abortController.signal)}catch(t){return this.reject(t)}this.createViewPoint()}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this.animationController=this.options.animate?this._getAnimationController():null,Wot(this.view,this.target,this.abortController.signal).then(t=>{if(this.state==="finished")return;const i=this._getCameraFromViewpoint(t);if(!R(i))if(this.options.animate){if(R(this.animationController))return;this.startAnimation(i,this.animationController)}else this.view.stateManager.setStateCamera(i.camera,{applyConstraints:!i.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},t=>{this.reject(t)}))}_getCameraFromViewpoint(t){const i=!!(this.target instanceof sc&&this.target.camera||this.target instanceof rc),r=t.camera;if(R(r))return null;if(!this.view.stateManager.isCompatible(r)){const n=r.position,o=n&&n.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference.wkid;return this.reject(new q("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:r})),null}const s=km(this.view,r);return R(s)?(this.reject(new q("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:t,camera:s,isFullySpecified:i}}startAnimation(t,i){this.state="wait-for-animation-finish";const r=i.viewAnimation;if(R(r))return void this.reject(new q("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(r.update(t.viewpoint,"running"),!i.active||R(i.viewAnimation)||i.viewAnimation.target!==t.viewpoint||this.view.state.cameraController!==i)return this.abort();let s;t.isFullySpecified?(s=new GT({view:this.view,desiredCamera:t.camera}),oE(this.view,t.camera,vh.EYE_AND_CENTER)):as(this.view,t.camera),i.begin(t.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof Km&&_(a.viewAnimation)&&a.viewAnimation.target===t.viewpoint&&(this.view.state.cameraController=s):_(i.viewAnimation)&&i.viewAnimation.target===t.viewpoint&&i.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(!R(this.view.state))switch(i.state){case Ir.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case Ir.Ready:case Ir.Rejected:case Ir.Running:case Ir.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};r.when(n,a=>o(a)),i.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let t,i=null;const r=this.view.state.cameraController;return r instanceof Km&&(r.updateStateFromViewAnimation(),r.active&&(t=r,i=t.viewAnimation)),t!=null||(t=new Km({view:this.view,mode:"animation"}),i=t.viewAnimation,this.view.state.switchCameraController(t))?t:(_(i)&&i.stop(),this.reject(new q("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}}const Ou=me.getLogger("esri.views.3d.state.ViewStateManager");let on=class extends Ee{constructor(e){super(e),this.propertiesPool=new Tg({frustum:C0},this),this.handles=new qt,this.cameraSetByUser=!1,this.gotoOperation=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._maximumPixelRatioOverride=null,this.test={contentCameraResetState:new Map,setDevicePixelRatio:t=>this._devicePixelRatioOverride=t,setMaximumPixelRatio:t=>this._maximumPixelRatioOverride=t}}get camera(){const e=this._get("camera");if(!this.ready)return e;const t=x2(this.view,this.view.state.camera);return t&&e&&t.equals(e)?e:t}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider.enableElevationCache(!0),this.setStateCamera(km(this.view,e),{applyConstraints:!1})||Ou.error("#camera=","Invalid camera",e),this.view.elevationProvider.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const t=x2(this.view,this.view.state.contentCamera);return t&&e&&t.equals(e)?e:t}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const t=km(this.view,e);R(t)?this.view.state.contentCamera=null:(this._updateElevation(t),this.view.state.contentCamera=t)}installContentCameraReset(e){if(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const t=this.zoom,i=this.view.state.camera.distance**2,r=Ya(this.view.state.camera.center),s=e.sticky?this.contentCamera.clone():null;return this.handles.add([ae(()=>this.contentCamera,()=>{e.sticky||(this.handles.remove("contentCameraReset"),this.test.contentCameraResetState.clear())}),ae(()=>this.zoom,n=>{this.test.contentCameraResetState.set("view.zoom",Math.abs(n-t)/2),Math.abs(n-t)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)}),ae(()=>this.view.state.camera,n=>{const o=$s(r,n.center);this.test.contentCameraResetState.set("camera.center",o/i),o>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=s)})],"contentCameraReset"),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():Ou.error("#center=","Invalid center",e):Ou.error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Ou.error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,t=ZXe(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return _(t)?t:this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||Ou.error("#extent=","Invalid extent",e):Ou.error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e):Ou.error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this.propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return Jb(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||Ou.error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,t=e.padding,i=e.pixelRatio,r=this._get("padding"),s=Math.round(t[Ct.TOP]/i),n=Math.round(t[Ct.RIGHT]/i),o=Math.round(t[Ct.BOTTOM]/i),a=Math.round(t[Ct.LEFT]/i);return r!=null&&r.top===s&&r.right===n&&r.bottom===o&&r.left===a?r:{top:s,right:n,bottom:o,left:a}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,VI),this.view.state.updateCamera(t=>t.padding=VI))}_paddingToArray(e,t,i){e?qi(i,e.top||0,e.right||0,e.bottom||0,e.left||0):qi(i,0,0,0,0);for(let r=0;r<4;r++)i[r]=Math.round(i[r]*t)}get screenCenter(){const e=this.padding;return Xd((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?qot(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||Ou.error("#viewpoint=","Invalid viewpoint",e);else{const t=_(e.camera)?e.camera.position:e.targetGeometry,i=_(t)&&t.spatialReference;Ou.error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference.wkid+")",e)}else Ou.error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?O_e(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||Ou.error("#zoom=","Invalid zoom",e)}get maximumPixelRatio(){if(_(this._maximumPixelRatioOverride))return this._maximumPixelRatioOverride;let e=1/0;const{maximumPixelRatio:t,maximumRenderResolution:i}=this.view.qualitySettings;if(t!=null&&(e=Math.min(e,t)),i!=null){const r=i/Math.max(this.view.width,this.view.height);e=Math.min(e,r)}return e}get _devicePixelRatio(){return R(this._devicePixelRatioOverride)?Math.min(this._windowDevicePixelRatio,this.maximumPixelRatio):this._devicePixelRatioOverride}initialize(){this.handles.add([eo(()=>this.view.state.events,"before-camera-change",e=>this._updateElevation(e.camera))]),ae(()=>this.view.state.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.handles.add(Eb({prepare:()=>this._prepareFrame()})),this.handles.add(ae(()=>this.view.state.cameraController,()=>{this.cameraSetByUser=!0,this.handles.remove(BI)})),this.handles.add(eo(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale")))}destroy(){this.deinit(),this.handles&&(this.handles.destroy(),this.handles=null),this.propertiesPool&&(this.propertiesPool.destroy(),this.propertiesPool=null)}init(){this.constraintsManager=new DA({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this.cameraSetByUser=!1,this._set("ready",!0);for(const t of e)this.set(t.name,t.value);if(!this.cameraSetByUser){const t=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;t&&this.isCompatible(t)?this._setInitialView(t):this.view.state.viewingMode===Ve.Local&&this.handles.add(cl(()=>this.view.basemapTerrain.ready,()=>{this.handles.remove(BI),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),BI)}}deinit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this.cameraSetByUser=!1,this.handles.remove(BI),this.constraintsManager&&(this.constraintsManager.destroy(),this.constraintsManager=null))}async goTo(e,t){const i=F({animate:!0},t);return _(this.gotoOperation)&&this.gotoOperation.abort(i.animate),this.gotoOperation=new aat(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this.gotoOperation}debugSetCameraOnContent(){this.setStateCamera(xw(this.view),{applyConstraints:!1})}step(e){const t=this.view.state,i=t&&this.view.state.cameraController;i&&(t.updateCamera(r=>{i.stepController(e,r)}),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){_(this.gotoOperation)&&(this.gotoOperation.abort(),this.gotoOperation=null)}_getInitialProperties(){const e=new Set,t=[];for(const{propertyName:i,overrides:r}of uat){const s=e.has(i),n=this._isOverridden(i);!s&&n&&t.push({name:i,value:this._get(i)}),this._clearOverride(i),(s||n)&&r.forEach(o=>e.add(o))}return t}_setInitialView(e){if(R(e)||this.cameraSetByUser)return;if(e instanceof rc)return void this.setStateCamera(km(this.view,e),{applyConstraints:!1});if(e instanceof sc){if(e.targetGeometry instanceof ci){const s=_R(this.view,e.targetGeometry,0,.5,So.LOCKED);return void(_(s)&&this.setStateCamera(km(this.view,s),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},r=this._viewpointToCamera(e);return void this.setStateCamera(r,i)}const t=_R(this.view,e,0,.5,So.LOCKED);_(t)&&this.setStateCamera(km(this.view,t),{applyConstraints:!0})}_updatePropertyBeforeReady(e,t){return!this.ready&&(this._override(e,t),t&&cat.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return!R(e)&&(e instanceof sc?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof rc?this.isCompatible(e.position):e.spatialReference&&K0(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=hat){return this.cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,t,i=vy){const{heading:r,tilt:s}=this._getPreservingHeadingTilt(),n=VM(this.view,r,s,e,t,So.ADJUST);return R(n)?null:(i.copyFrom(this.view.state.camera),i.eye=n.eye,i.center=n.center,i.up=n.up,i)}_centerToCamera(e){const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:t,tilt:i}=this._getPreservingHeadingTilt(),r=_R(this.view,e,t,i,So.ADJUST,dat);return _(r)?km(this.view,r):null}_scaleToCamera(e){if(e==null)return null;const t=this.view.pointsOfInterest.centerOnContent;t.runTask();const i=t.renderLocation,r=t.location.latitude,s=xY(this.view,e,r);return this._centerPointAtDistanceToCamera(i,s)}_zoomToCamera(e){return this._scaleToCamera(P_e(this.view,e))}_viewpointToCamera(e){return km(this.view,hZ(this.view,e))}setStateCamera(e,t){return!(R(e)||!this.view.state.stopActiveCameraController())&&(this.cameraSetByUser=!0,t.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{t.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),t.applyConstraints&&as(this.view,i)}),t.applyConstraints||(this.view.state.cameraController=new GT({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:t}=this.view;if(!e||!t)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._devicePixelRatio,r=Math.round(e.clientWidth*i),s=Math.round(e.clientHeight*i);if(r!==0&&s!==0&&(t.width===r&&t.height===s||(t.width=r,t.height=s),this.view.state)){const n=this.view.state.camera;n.fullWidth===r&&n.fullHeight===s&&n.pixelRatio===i||(vy.copyFrom(n),vy.pixelRatio!==i&&(this._paddingToArray(this.padding,i,VI),vy.padding=VI),vy.fullWidth=r,vy.fullHeight=s,vy.pixelRatio=i,this.view.state.camera=vy)}}_updateElevation(e){const t=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper.getAltitude(e.eye),r=t?x5(this.view,e.eye):0;e.relativeElevation=i-r}};u([d({type:rc,dependsOn:["view.state.camera","ready"]})],on.prototype,"camera",null),u([d({type:rc,dependsOn:["view.state.contentCamera","ready"]})],on.prototype,"contentCamera",null),u([d({type:nt})],on.prototype,"center",null),u([d({type:ci})],on.prototype,"extent",null),u([d({readOnly:!0})],on.prototype,"frustum",null),u([d({readOnly:!0})],on.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],on.prototype,"ready",void 0),u([d({type:Number})],on.prototype,"scale",null),u([d()],on.prototype,"padding",null),u([d({readOnly:!0})],on.prototype,"screenCenter",null),u([d({constructOnly:!0})],on.prototype,"view",void 0),u([d({type:sc})],on.prototype,"viewpoint",null),u([d({type:Number})],on.prototype,"zoom",null),u([d()],on.prototype,"maximumPixelRatio",null),u([d()],on.prototype,"_devicePixelRatio",null),u([d()],on.prototype,"_windowDevicePixelRatio",void 0),u([d()],on.prototype,"_devicePixelRatioOverride",void 0),u([d()],on.prototype,"_maximumPixelRatioOverride",void 0),on=u([P("esri.views.3d.state.ViewStateManager")],on);const lat=on,cat=["camera","viewpoint","extent","scale","center","zoom"],uat=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],hat={heading:0,tilt:0},dat=new rc,vy=new Yi,VI=Gt(),BI="pending-initial-view";class pat{constructor(t,i,r){this.viewingMode=t,this._forEachLayer=i,this.view=r,this.externalIntersectionHandlers=new Bt,this.tolerance=_2,this.tmpRay=Yn(),this.tmpRegion=Dt(),this.validateHUDIntersector=Mh(this.viewingMode),this.validateHUDIntersector.options.hud=!1}intersectScreen(t,i,r){return this.intersectRay(this._getPickRay(t,this.tmpRay),Jne(this.viewingMode),i,r)}intersectScreenFreePointFallback(t,i,r){return this.intersectRayFreePointFallback(this._getPickRay(t,this.tmpRay),i,r)}intersectRayFreePointFallback(t,i,r){return this.intersectRay(t,Jne(this.viewingMode),i,r)||this._intersectRayFreePointLocal(t,i)}intersectRay(t,i,r,s){return i.options.selectionMode=!1,i.options.store=io.MIN,this.computeIntersection(t,i,s),!!i.results.min&&i.results.min.getIntersectionPoint(r)}getCenterRayWithSubpixelOffset(t,i,r=.5,s=.5){return t.getRenderCenter(HI,r,s),HI[0]+=.0466,HI[1]-=.0123,mY(t,HI,i)}intersectIntersectorScreen(t,i,r){this.computeIntersection(this._getPickRay(t,this.tmpRay),i,r)}intersectToolIntersectorScreen(t,i,r){const s=this._getPickRay(t,this.tmpRay);this.intersectToolIntersectorRay(s,i,r)}intersectToolIntersectorRay(t,i,r){i.options.selectionMode=!0,this.computeIntersection(t,i,r);const s=i.results.min;!!this.view.basemapTerrain&&this.view.basemapTerrain.opaque||Bf(s)&&s.intersector!==Dr.TERRAIN||(i.options.selectionMode=!1,this.computeIntersection(t,i,r))}setTolerance(t=_2){this.tolerance=t}addIntersectionHandler(t){this.externalIntersectionHandlers.push(t),this.externalIntersectionHandlers.sort((i,r)=>i.type===Dr.TERRAIN?1:r.type===Dr.TERRAIN?-1:0)}removeIntersectionHandler(t){this.externalIntersectionHandlers.removeUnordered(t)!=null&&this.externalIntersectionHandlers.sort((i,r)=>i.type===Dr.TERRAIN?1:r.type===Dr.TERRAIN?-1:0)}_getPickRay(t,i){const r=this.view.state.camera;return Kve(r,t,i)}_intersectRayFreePointLocal(t,i){if(this.viewingMode!==Ve.Local||R(t))return!1;const r=this.view.renderDataExtent;if(R(r))return de(i,t.origin,we(He.get(),t.direction)),!0;const s={x:r.xmax-r.xmin,y:r.ymax-r.ymin,z:8*Math.max(r.xmax-r.xmin,r.ymax-r.ymin)},n=Math.max(s.x,s.y,s.z);if(n===0)return de(i,t.origin,we(He.get(),t.direction)),!0;const o=this.view.state.camera,a=Math.max(0,r.xmin-o.eye[0],o.eye[0]-r.xmax),l=Math.max(0,r.ymin-o.eye[1],o.eye[1]-r.ymax),c=Math.sqrt(a*a+l*l),h=Math.abs(o.relativeElevation)+Number.MIN_VALUE,p=Math.max(0,Math.log(n/h))**2;let f=n/Math.max(1,p);f=Math.max(f,Math.min(c,n));const m=oe(He.get(),t.direction,f/Me(t.direction));return de(i,t.origin,m),!0}intersectElevationFromScreen(t,i,r=0,s=null){return this._intersectElevation(this._getPickRay(t,this.tmpRay),i,r,s)}_intersectElevation(t,i,r=0,s=null){if(R(t))return null;const n=_(i)?i.mode:"absolute-height",o=_(i)?yt(i.offset,0):0,a=n!=="on-the-ground"?o+r:0,l=a/this.view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this.view.renderCoordsHelper.intersectInfiniteManifold(t,a,jI)){const S=this.view.computeMapPointFromVec3d(jI);return S.z-=o,S}return null}const c=this.view.state.camera,h=He.get();c.projectToRenderScreen(t.origin,h);const p=new Kne(null,this._forEachLayer),f=this.view.slicePlane,m=_(f)?Wie(f):null,y=Mh(this.viewingMode);y.options.store=io.MIN,y.options.verticalOffset=l;const v=t.origin,w=de(He.get(),v,t.direction);y.reset(v,w,c),y.point=h;const b=_(s)?"type"in s&&s.type==="graphics"?S=>S.metadata.layerUid!==s.uid:S=>S.metadata.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":{const S=T=>(R(b)||b(T))&&T.metadata&&T.metadata.isElevationSource;y.intersect(p.layers,h,this.tolerance,null,S),this.externalIntersectionHandlers.forAll(T=>{if(T.type===Dr.I3S||T.type===Dr.TERRAIN){const E=T.slicePlaneEnabled?m:null;T.intersect(y,E,y.rayBegin,y.rayEnd,h)}})}break;case"on-the-ground":case"relative-to-ground":this.externalIntersectionHandlers.forAll(S=>{if(S.isGround){const T=S.slicePlaneEnabled?m:null;S.intersect(y,T,y.rayBegin,y.rayEnd,h)}})}if(y.results.min.getIntersectionPoint(jI)){const S=this.view.computeMapPointFromVec3d(jI);return S.z=r,S}return null}computeIntersection(t,i,r){if(R(t))return;const s=this.view.state.camera,n=He.get();s.projectToRenderScreen(t.origin,n);const o=new Kne(r,this._forEachLayer);i.options.selectOpaqueTerrainOnly=!r||!("include"in r||"exclude"in r);const a=t.origin,l=de(He.get(),t.origin,t.direction);i.reset(a,l,s),i.intersect(o.layers,n,this.tolerance);const c=this.view.slicePlane,h=_(c)?Wie(c):null;i.intersect(o.sliceableLayers,n,this.tolerance,h);const p=r&&(r.requiresGroundFeedback||r.enableDraped);this.externalIntersectionHandlers.forAll(m=>{if(i.options.isFiltered=!o.filterLayerUid(m.layerUid),m.isGround&&p||!i.options.isFiltered){const y=m.slicePlaneEnabled?h:null;m.intersect(i,y,a,l,n)}});const f=He.get();if(r&&r.enableDraped&&i.results.ground.getIntersectionPoint(f)){const m=this.view.basemapTerrain,y=m.overlayManager.renderer,v=this.view.renderCoordsHelper.spatialReference,w=He.get();this.view.renderCoordsHelper.fromRenderCoords(f,w,m.spatialReference),w[2]=yt(this.view.elevationProvider.getElevation(f[0],f[1],f[2],v,"ground"),0),y.intersect(i,w,i.results.ground,b=>o.filterRenderGeometry(b))}i.sortResults(),this._processHUDResults(i)}_processHUDResults(t){const i=t.results.hud;vg(this.tmpRegion,sB);const r=this.view.state.camera,s=[],n=this.tmpRegion,o=b=>{const S=new mat(b);r.projectToRenderScreen(b.target.center,S.screenPoint),S.screenPoint[0]=Math.floor(S.screenPoint[0]),S.screenPoint[1]=Math.floor(S.screenPoint[1]),s.push(S),JT(n,S.screenPoint)};t.sortResults(i.all),_(i.min.dist)&&o(i.min);for(const b of i.all)i.min.target.object!==b.target.object&&i.max.target.object!==b.target.object&&o(b);if(_(i.max.dist)&&i.max.target.object!==i.min.target.object&&o(i.max),!s.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const a=r.fullWidth,l=r.fullHeight,c=Math.max(0,n[0]-LA),h=Math.max(0,n[1]-LA),p=Math.min(Wc(n)+2*LA,a-c),f=Math.min(Yd(n)+2*LA,l-h),m=new Uint8Array(p*f*4);this.view._stage.renderView.readHUDVisibility(c,h,p,f,m);let y=!0;const v=R(t.results.max.dist);let w=0;for(const b of s)for(const S of fat)if(m[4*(Math.min(b.screenPoint[0]+S[0],a)-n[0]+(Math.min(b.screenPoint[1]+S[1],l)-n[1])*p)]){y&&(t.results.min.copy(b.result),y=!1),v&&t.results.max.copy(b.result),t.options.store===io.ALL&&t.results.all.splice(w++,0,b.result);break}}}const LA=1,fat=(()=>{const e=[],t=LA;for(let i=-t;i<=t;i++)for(let r=-t;r<=t;r++)e.push([r+t,i+t]);return e})();class mat{constructor(t){this.result=t,this.screenPoint=wo()}}let GI;function Jne(e){return GI&&GI.viewingMode===e||(GI=Mh(e)),GI}class Kne{constructor(t,i){this.layers=new Array,this.sliceableLayers=new Array,this.include=t==null?void 0:t.include,this.exclude=t==null?void 0:t.exclude,i(r=>{r.isPickable&&this.filterLayerUid(r.apiLayerUid)&&(r.isSliceable?this.sliceableLayers:this.layers).push(r)})}filterLayerUid(t){const{include:i,exclude:r}=this;return R(t)?i==null&&r==null:(i==null||i.has(t))&&(r==null||!r.has(t))}filterRenderGeometry(t){return this.filterLayerUid(t.layerUid)}}function eoe(e){return typeof e=="object"&&"intersect"in e}const jI=O(),HI=wo();class E1t{constructor(t,i){this.spatialReference=t,this.view=i}getElevation(t,i,r){return this.view.elevationProvider.getElevation(t,i,0,this.spatialReference,r)}async queryElevation(t,i,r,s,n){return this.view.elevationProvider.queryElevation(t,i,0,this.spatialReference,n,r,s)}}class gat{constructor(t,i,r,s){this.spatialReference=i,this._getElevationQueryProvider=r,this._queries=new Array,this._queryOptions=ve(F({},s),{ignoreInvisibleLayers:!0}),this._frameTask=t.registerTask(mt.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(t,i,r,s=0){return new Promise((n,o)=>{const a={x:t,y:i,minDemResolution:s,result:{resolve:n,reject:o},signal:r};this._queries.push(a),Wo(r,()=>{_H(this._queries,a),o(ui())})})}get running(){return this._queries.length>0}runTask(){const t=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return void t.forEach(c=>c.result.reject());const r=t.map(c=>[c.x,c.y]),s=t.reduce((c,h)=>Math.min(c,h.minDemResolution),1/0),n=new lw({points:r,spatialReference:this.spatialReference}),o=t.length>1&&t.some(c=>!!c.signal)?new AbortController:null,a=_(o)?o.signal:t[0].signal;if(_(o)){let c=0;t.forEach(h=>Wo(h.signal,()=>{c++,h.result.reject(ui()),c===t.length&&o.abort()}))}const l=ve(F({},this._queryOptions),{minDemResolution:s,signal:a});i.queryElevation(n,l).then(c=>{t.forEach((h,p)=>{_(h.signal)&&h.signal.aborted?h.result.reject(ui()):h.result.resolve(c.geometry.points[p][2])})}).catch(c=>{t.forEach(h=>h.result.reject(c))})}get test(){const t=this;return{update:()=>t._queries.length>0&&t.runTask()}}}let NA=class extends us.EventedMixin(Ee){constructor(e){super(e),this.im=new Array,this.ground=new Array,this.scene=new Array,this.handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQuery=ot(this._elevationQuery)}get elevationQuery(){return R(this._elevationQuery)&&(this._elevationQuery=new gat(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQuery}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,t,i,r,s){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const o=this.lastElevationQuery;if(e===o.x&&t===o.y&&i===o.z&&r.equals(o.spatialReference)&&s===o.queryContext)return o.result}let n=null;return n=qI(n,this.im,e,t,i,r,s),R(n)&&(n=qI(n,this.ground,e,t,i,r,s)),s==="scene"&&(n=qI(n,this.scene,e,t,i,r,s)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:t,z:i,spatialReference:r,queryContext:s,result:n}),n}queryElevation(e,t,i,r,s,n=null,o=0){const a=Wd();return this.elevationQuery.queryElevation(e,t,n,o).then(l=>{s==="scene"&&(l=qI(l,this.scene,e,t,i,r,s)),a.resolve(l)}).catch(l=>{Gr(l)?a.reject(l):a.resolve(this.getElevation(e,t,i,r,s))}),a.promise}register(e,t){this.handles.set(t,t.on("elevation-change",i=>this.emit("elevation-change",i))),this[e].push(t)}unregister(e){this.handles.has(e)&&(this.handles.get(e).remove(),this.handles.delete(e));for(const t of[this.im,this.ground,this.scene]){const i=t.indexOf(e);i>-1&&t.splice(i,1)}}};function qI(e,t,i,r,s,n,o){for(const a of t){const l=a.getElevation(i,r,s,n,o);_(l)&&(e=_(e)?Math.max(l,e):l)}return e}u([d({constructOnly:!0})],NA.prototype,"view",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain.spatialReference"})],NA.prototype,"spatialReference",void 0),NA=u([P("esri.views.3d.support.CombinedElevationProvider")],NA);class Y0{static isValidProfile(t){return t in Y0.profiles}static getDefaultProfile(){return he("trident")||he("esri-iPhone")?"low":"medium"}static apply(t,i){const r=Y0.profiles[t];i.graphics3D.maxTotalNumberOfFeatures=r.graphics3D.maxTotalNumberOfFeatures,i.graphics3D.maxTotalNumberOfPrimitives=r.graphics3D.maxTotalNumberOfPrimitives,i.graphics3D.polygonLodFactor=r.graphics3D.polygonLodFactor,i.graphics3D.polylineLodFactor=r.graphics3D.polylineLodFactor,i.graphics3D.snapshotAvailable=r.graphics3D.snapshotAvailable;{const s=i.sceneService["3dObject"],n=r.sceneService["3dObject"];s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration}i.sceneService.point.lodFactor=r.sceneService.point.lodFactor,i.sceneService.integratedMesh.lodFactor=r.sceneService.integratedMesh.lodFactor,i.sceneService.pointCloud.lodFactor=r.sceneService.pointCloud.lodFactor,i.sceneService.uncompressedTextureDownsamplingEnabled=r.sceneService.uncompressedTextureDownsamplingEnabled,i.tiledSurface.lodBias=r.tiledSurface.lodBias,i.tiledSurface.angledSplitBias=r.tiledSurface.angledSplitBias,i.tiledSurface.reduceTileLevelDifferences=r.tiledSurface.reduceTileLevelDifferences,i.tiledSurface.textureFadeDuration=r.tiledSurface.textureFadeDuration,i.heatmap.pixelRatio=r.heatmap.pixelRatio,i.heatmap.maxTotalNumberOfFeatures=r.heatmap.maxTotalNumberOfFeatures,i.antialiasingEnabled=r.antialiasingEnabled,i.physicallyBasedRenderingEnabled=r.physicalBasedRenderingEnabled,i.highQualityTransparency=r.highQualityTransparency,i.memoryLimit=r.memoryLimit,i.additionalCacheMemory=r.additionalCacheMemory,i.frameRate=r.frameRate,i.maximumRenderResolution=r.maximumRenderResolution,i.maximumPixelRatio=r.maximumPixelRatio}}function toe(){const e=!!he("esri-mobile"),t=!!he("ios");return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{"3dObject":{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?.8:1,polylineLodFactor:e?1.2:1.5,snapshotAvailable:!t},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:e},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!he("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?600:750,additionalCacheMemory:e?0:150,frameRate:0,maximumRenderResolution:null,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:e?1.2:2,polylineLodFactor:e?1.2:2,snapshotAvailable:!t},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{"3dObject":{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:400},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!he("disable-feature:reduce-map-tile-levels"),textureFadeDuration:400},antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,memoryLimit:e?900:1500,additionalCacheMemory:0,frameRate:0,maximumRenderResolution:e?null:4096,maximumPixelRatio:e?1:null}}}Y0.debug={reset(){const e=toe();for(const t in e)Y0.profiles[t]=e[t]}},function(e){e.profiles=toe()}(Y0||(Y0={}));const aL=Y0;function mZ(){return new Float32Array(4)}function yat(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function Ph(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function vat(e,t){return new Float32Array(e,t,4)}function Zwe(){return mZ()}function Qwe(){return Ph(1,1,1,1)}function Jwe(){return Ph(1,0,0,0)}function Kwe(){return Ph(0,1,0,0)}function exe(){return Ph(0,0,1,0)}function txe(){return Ph(0,0,0,1)}const _at=Zwe(),bat=Qwe(),wat=Jwe(),xat=Kwe(),Tat=exe(),Sat=txe();Object.freeze(Object.defineProperty({__proto__:null,create:mZ,clone:yat,fromValues:Ph,createView:vat,zeros:Zwe,ones:Qwe,unitX:Jwe,unitY:Kwe,unitZ:exe,unitW:txe,ZEROS:_at,ONES:bat,UNIT_X:wat,UNIT_Y:xat,UNIT_Z:Tat,UNIT_W:Sat},Symbol.toStringTag,{value:"Module"}));let Up=class extends Ee{constructor(){super(...arguments),this.color=new qe([0,255,255]),this.haloColor=null,this.haloOpacity=1,this.fillOpacity=.25,this.shadowOpacity=.4,this.shadowColor=new qe([0,0,0]),this.shadowDifference=.2}static toEngineOptions(e){const t=qe.toUnitRGBA(e.color),i=_(e.haloColor)?qe.toUnitRGBA(e.haloColor):t,r=qe.toUnitRGBA(e.shadowColor);return{color:Ph(t[0],t[1],t[2],t[3]),haloColor:Ph(i[0],i[1],i[2],i[3]),haloOpacity:e.haloOpacity,haloOpacityOccluded:.25*e.haloOpacity,fillOpacity:e.fillOpacity,fillOpacityOccluded:.25*e.fillOpacity,shadowOpacity:e.shadowOpacity,shadowColor:fi(r[0],r[1],r[2],r[3]),occludedShadowOpacity:e.shadowOpacity*(1-e.shadowDifference)}}};u([d({type:qe})],Up.prototype,"color",void 0),u([d({type:qe})],Up.prototype,"haloColor",void 0),u([d()],Up.prototype,"haloOpacity",void 0),u([d()],Up.prototype,"fillOpacity",void 0),u([d()],Up.prototype,"shadowOpacity",void 0),u([d({type:qe})],Up.prototype,"shadowColor",void 0),u([d()],Up.prototype,"shadowDifference",void 0),Up=u([P("esri.views.3d.support.HighlightOptions")],Up);const yj=Up;function Eat(e,t,i){const r=_ue(t);return e.map(s=>{const n=r.fromJSON(s);return n.spatialReference=i,n})}let m1=class extends fe{constructor(e){super(e),this.geometries=null,this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(r=>r.toJSON()),t=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=t.spatialReference.wkid||JSON.stringify(t.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:k2(t),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],m1.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],m1.prototype,"outSpatialReference",void 0),u([d()],m1.prototype,"transformation",void 0),u([d()],m1.prototype,"transformForward",void 0),m1=u([P("esri.rest.support.ProjectParameters")],m1);const gZ=m1,Cat=Qr(gZ);async function ixe(e,t,i){t=Cat(t);const r=cme(e),s=F(ve(F({},r.query),{f:"json"}),t.toJSON()),n=t.outSpatialReference,o=k2(t.geometries[0]),a=mFe(s,i);return ur(r.path+"/project",a).then(({data:{geometries:l}})=>Eat(l,o,n))}async function yZ(e=null,t){var s,n;if(Ii.geometryServiceUrl)return Ii.geometryServiceUrl;if(!e)throw new q("internal:geometry-service-url-not-configured");let i;i="portal"in e?e.portal||Kn.getDefault():e,await i.load({signal:t});const r=(n=(s=i.helperServices)==null?void 0:s.geometry)==null?void 0:n.url;if(!r)throw new q("internal:geometry-service-url-not-configured");return r}async function Aat(e,t,i=null,r){const s=await yZ(i,r),n=new gZ;n.geometries=[e],n.outSpatialReference=t;const o=await ixe(s,n,{signal:r});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new q("internal:geometry-service-projection-failed")}var Rat=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",getGeometryServiceURL:yZ,projectGeometry:Aat});class Mat{constructor(t,i){this.spatialReference=i,this.unitInMeters=cc(this.spatialReference,vi(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=yZ(t&&t.get("portalItem")).catch(()=>{throw new q("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(t){const i=await this._geometryServiceURLPromise;let r,s=!0;Array.isArray(t[0])&&typeof t[0]!="number"?r=t:(r=[t],s=!1);const n=r.map(l=>l instanceof nt?l:new nt(l,this.spatialReference)),o=new gZ({geometries:n,outSpatialReference:Xe.WGS84}),a=(await ixe(i,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0);return s?a:a[0]}}let Wp=class extends Ee{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1}};u([d()],Wp.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Wp.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Wp.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Wp.prototype,"snapshotAvailable",void 0),u([d()],Wp.prototype,"polygonLodFactor",void 0),u([d()],Wp.prototype,"polylineLodFactor",void 0),Wp=u([P("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Wp);let pf=class extends Ee{constructor(){super(...arguments),this.lodFactor=1}};u([d()],pf.prototype,"lodFactor",void 0),pf=u([P("esri.views.3d.support.QualitySettings.LoDFactorSettings")],pf);let $F=class extends pf{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};$F=u([P("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],$F);let Vm=class extends Ee{constructor(){super(...arguments),this["3dObject"]=new $F,this.point=new pf,this.integratedMesh=new pf,this.pointCloud=new pf,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:$F})],Vm.prototype,"3dObject",void 0),u([d({type:pf})],Vm.prototype,"point",void 0),u([d({type:pf})],Vm.prototype,"integratedMesh",void 0),u([d({type:pf})],Vm.prototype,"pointCloud",void 0),u([d()],Vm.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Vm=u([P("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Vm);let b0=class extends Ee{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=500}};u([d()],b0.prototype,"lodBias",void 0),u([d()],b0.prototype,"angledSplitBias",void 0),u([d()],b0.prototype,"reduceTileLevelDifferences",void 0),u([d()],b0.prototype,"textureFadeDuration",void 0),b0=u([P("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],b0);let jT=class extends Ee{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],jT.prototype,"pixelRatio",void 0),u([d()],jT.prototype,"maxTotalNumberOfFeatures",void 0),jT=u([P("esri.views.3d.support.QualitySettings.HeatmapSettings")],jT);let Ba=class extends Ee{constructor(){super(...arguments),this.graphics3D=new Wp,this.sceneService=new Vm,this.tiledSurface=new b0,this.heatmap=new jT,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0}};u([d({type:Wp})],Ba.prototype,"graphics3D",void 0),u([d({type:Vm})],Ba.prototype,"sceneService",void 0),u([d({type:b0})],Ba.prototype,"tiledSurface",void 0),u([d({type:jT})],Ba.prototype,"heatmap",void 0),u([d()],Ba.prototype,"antialiasingEnabled",void 0),u([d()],Ba.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],Ba.prototype,"highQualityTransparency",void 0),u([d()],Ba.prototype,"memoryLimit",void 0),u([d()],Ba.prototype,"additionalCacheMemory",void 0),u([d()],Ba.prototype,"frameRate",void 0),u([d()],Ba.prototype,"maximumRenderResolution",void 0),u([d()],Ba.prototype,"maximumPixelRatio",void 0),Ba=u([P("esri.views.3d.support.QualitySettings.QualitySettings")],Ba);const ioe=Ba;class DF{constructor(t,i,r,s){this.viewingMode=t,this.spatialReference=i,this.unitInMeters=r,this.coordinateSystem=s,this._coordinateSystem=JPe(s)}set extent(t){t&&KPe(this.coordinateSystem,t,this.coordinateSystem)}getAltitude(t){return aIe(this.coordinateSystem,t)}setAltitude(t,i,r=t){return Npe(this.coordinateSystem,r,i,t)}setAltitudeOfTransformation(t,i){lIe(this.coordinateSystem,i,t,i)}worldUpAtPosition(t,i){return rIe(this.coordinateSystem,t,i)}worldBasisAtPosition(t,i,r){return sIe(this.coordinateSystem,t,i,r)}basisMatrixAtPosition(t,i){const r=this.worldBasisAtPosition(t,su.X,He.get()),s=this.worldBasisAtPosition(t,su.Y,He.get()),n=this.worldBasisAtPosition(t,su.Z,He.get());return Nf(i,r[0],r[1],r[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),i}intersectManifoldClosestSilhouette(t,i,r){return Tk(this.coordinateSystem,i,this._coordinateSystem),oIe(this._coordinateSystem,t,r),r}intersectManifold(t,i,r){Tk(this.coordinateSystem,i,this._coordinateSystem);const s=He.get();return nIe(this._coordinateSystem,t,s)?se(r,s):null}intersectInfiniteManifold(t,i,r){if(this.viewingMode===Ve.Global)return this.intersectManifold(t,i,r);Tk(this.coordinateSystem,i,this._coordinateSystem);const s=this._coordinateSystem.value,n=He.get();return gw(s.plane,t,n)?se(r,n):null}toRenderCoords(t,i,r){return cF(t)?Mn(t,i,this.spatialReference):Js(t,i,r,this.spatialReference)}fromRenderCoords(t,i,r=null){return cF(i)?(_(r)&&(i.spatialReference=r),$de(t,this.spatialReference,i)):i instanceof Xe?mv(t,this.spatialReference,i):Js(t,this.spatialReference,i,r)?i:null}static create(t,i){switch(t){case Ve.Local:return new DF(Ve.Local,i,cc(i),iIe());case Ve.Global:return new DF(Ve.Global,i,1,tIe(i))}}static renderUnitScaleFactor(t,i){return roe(t)/roe(i)}}function roe(e){if(w2(e,Ve.Global))return 1;const t=Fpe(!1,e);return cc(t)}var sf;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.BASEMAP=1]="BASEMAP",e[e.I3S_INDEX=2]="I3S_INDEX",e[e.I3S_DATA=3]="I3S_DATA",e[e.SYMBOLOGY=4]="SYMBOLOGY"})(sf||(sf={}));const Oat=(()=>{const e=new Array;return e[sf.ELEVATION]=10,e[sf.BASEMAP]=10,e[sf.I3S_INDEX]=10,e[sf.I3S_DATA]=10,e[sf.SYMBOLOGY]=5,e})(),Pat=30;function rxe(e){return typeof e.getUsedMemory=="function"}const Iat=me.getLogger("esri.views.3d.support.MemoryController");function $at(e){return new Ga({view:e})}const WI=1,uV=1,Dat=.75,Lat=.6,soe=1.3;let Ga=class extends Ee{constructor(e){super(e),this._quality=1,this._memoryUsed=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new SW,this._numQualityChanges=0,this._maxMemory=500,this._additionalCacheMemory=100}destroy(){this._cacheStorage.destroy()}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(WI),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&e>=0&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._memoryUsed}newCache(e,t){return new INe(e,this._cacheStorage,t)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<Lat&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(WI);else if(e)(this._memoryPredicted>1.1*uV||this._memoryUsed>uV)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._memoryUsed&&(this._updateQuality(this._quality/soe),this._downscaleMemoryUsed=this._memoryUsed,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._memoryUsed>uV)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/soe),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._memoryUsed<Dat&&this._quality<WI){this._stableQuality=this._quality;const t=.05;e=this._updateQuality(this._quality+t)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),WI))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){let e=0,t=0;this.view.basemapTerrain&&this.view.basemapTerrain.getUsedMemory&&(e+=this.view.basemapTerrain.getUsedMemory());const i=this.view._stage&&this.view._stage.renderView&&this.view._stage.renderView.edgeView;_(i)&&(e+=i.usedMemory),this.view.allLayerViews&&this.view.allLayerViews.forEach(o=>{if(rxe(o)){const a=o.ignoresMemoryFactor()?this._quality:1;e+=o.getUsedMemory()*a,t+=o.getUnloadedMemory()*a}});const r=this._warnMemoryUsage==null||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),s=1048576*this.maxMemory;if(e>s&&r){this._warnMemoryUsage=e;const o=l=>(l/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",a=Math.round(100*this._quality);Iat.warn(`Memory Limit exceeded! Limit: ${o(s)} Current: ${o(e)} Projected: ${o(e+t)} Quality: ${a}%`)}this._memoryUsed=e/s,this._memoryPredicted=(e+t)/s;const n=s-e;this._cacheStorage.maxSize=Math.max(0,n+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const t=e._numQualityChanges;return e._numQualityChanges=0,t}}}};u([d({constructOnly:!0})],Ga.prototype,"view",void 0),u([d()],Ga.prototype,"maxMemory",null),u([d()],Ga.prototype,"additionalCacheMemory",null),u([d()],Ga.prototype,"memoryFactor",null),u([d()],Ga.prototype,"updating",null),u([d()],Ga.prototype,"usedMemory",null),u([d()],Ga.prototype,"_quality",void 0),u([d()],Ga.prototype,"_memoryUsed",void 0),u([d()],Ga.prototype,"_updating",void 0),u([d()],Ga.prototype,"_stableQuality",void 0),u([d()],Ga.prototype,"_maxMemory",void 0),u([d()],Ga.prototype,"_additionalCacheMemory",void 0),Ga=u([P("esri.views.3d.support.MemoryController")],Ga);class Nat{constructor(t){this.client=t,this._cancelled=!1,this.size=0,this.duration=0}}class Fat{constructor(t){this.typeWorkerQuota=t,this.tasks=new Array,this.numWorkers=0,this.statistics=new Uat}}class Uat{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}}class kat{constructor(t,i,r,s){this._workerFunc=t,this._callbackFunc=i,this._maxTotalNumWorkers=r,this._totalNumWorkers=0,this._clients=s.map(n=>new Fat(n))}hasQuota(t){const i=this._clients[t];return!!i&&(this._totalNumWorkers<this._maxTotalNumWorkers||i.numWorkers+i.tasks.length<i.typeWorkerQuota)}push(t){const i=this._clients[t.client];i&&(this._totalNumWorkers<this._maxTotalNumWorkers?(i.numWorkers++,this._totalNumWorkers++,this._workerFunc(t,(r,s)=>this._taskCallback(r,s))):i.tasks.push(t))}cancel(t){this._taskFinished(t),t._cancelled=!0}destroy(){this._clients.length=0}_taskFinished(t){const i=this._clients[t.client];this._totalNumWorkers--,i.numWorkers--,i.statistics.requests++,i.statistics.size+=t.size||0,i.statistics.duration+=t.duration||0,i.statistics.speed=i.statistics.duration>0?i.statistics.size/i.statistics.duration:0,dt(i.numWorkers>=0),this._next()}_next(){for(const t of this._clients)if(t&&t.numWorkers<t.typeWorkerQuota&&this._processQueue(t))return;for(const t of this._clients)if(t&&this._processQueue(t))return}_processQueue(t){for(;t.tasks.length>0;)if(this._workerFunc(t.tasks.shift(),(i,r)=>this._taskCallback(i,r)))return t.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(t,i){t._cancelled||(this._callbackFunc(t,i),this._taskFinished(t))}getStatsForType(t){const i=this._clients[t];return i?{quota:i.typeWorkerQuota,workers:i.numWorkers,queueSize:i.tasks.length,requestStats:i.statistics}:null}get test(){const t=this;return{set workerFunc(i){t._workerFunc=i}}}}let lL=class extends Ee{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,t,i){this._loadQueue=new kat((r,s)=>this._startLoading(r,s),(r,s)=>this._doneLoadingCB(r,s),e,t),i&&(this._frameTask=i.registerTask(mt.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Ds(this._frameTask),this._tasks.forEach(e=>xh(e.abortController)),this._loadQueue=ot(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,t,i,r={}){const s=Wd();s.__signal=_(r)?r.signal:null;const n=this._createOrUpdateTask(e,t,i,r,s);return Wo(r,()=>this._cancelRequest(n,s)),s.promise}_createTask(e,t,i,r,s,n){const o=new Bat(e,t,i,r,s);return this._updateTask(o,n),this._tasks.set(s,o),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(o),o}_cancelRequest(e,t){QF(e.resolvers,t),t.reject(ui()),e.resolvers.length===0&&(e.status===Yu.DOWNLOADING&&(e.status=Yu.CANCELLED,this._loadQueue.cancel(e),e.abortController.abort(),e.request=null,e.abortController=null),e.status=Yu.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,t){e.resolvers.push(t)}_createOrUpdateTask(e,t,i,r,s){const n=Gat(_(r)&&r.uid||e,t,i),o=this._tasks.get(n);return o?(this._updateTask(o,s),o):this._createTask(e,r,t,i,n,s)}_doneLoadingCB(e,t){this._loadQueue&&(dt(e.status===Yu.DOWNLOADING),e.status=Yu.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:t}):this._doneLoading(e,t))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const t=this._onLoadQueue.shift();li(t.task.abortController),t.task.abortController=null,t.callback(t.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const t=this._doneQueue.shift();t.task.status!==Yu.DOWNLOADED&&(t.err=t.err||ui()),this._doneLoading(t.task,t.err),e.madeProgress()}}_doneLoading(e,t){if(t&&!Gr(t)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const r of e.resolvers)if(t)Gr(t)?r.reject(t):r.reject(new q("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${t}`,{url:e.url,error:t}));else{--i;const s=i<=0?e.result:te(e.result);r.resolve(s)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,t){if(e.status===Yu.CANCELLED)return!1;let i,r;switch(e.startTime=performance.now(),e.status=Yu.DOWNLOADING,e.docType){case"binary":r="array-buffer",i=0;break;case"image":r="image";break;case"image+type":r="array-buffer";break;default:r="json"}e.abortController=new AbortController;const s=e.abortController.signal;e.request=ur(e.url,ve(F({},e.options),{responseType:r,timeout:i,signal:s}));let n=()=>{};const o=l=>{e.duration=performance.now()-e.startTime,e.size=l instanceof ArrayBuffer?l.byteLength:e.size||0,e.result=l,this._frameTask?this._onLoadQueue.push({callback:t,task:e}):(e.abortController=null,t(e))},a=l=>{e.status===Yu.DOWNLOADING&&t(e,l),n()};return e.docType!=="image+type"?(e.request.then(l=>o(l.data),a),!0):(e.request.then(l=>{const c=l.data,h=Vat(c);if(r="image",e.size=c.byteLength,h==="unknown")return e.request=ur(e.url,{responseType:r,timeout:i,signal:s}),void e.request.then(m=>o(m.data),a);const p=new Blob([c],{type:h}),f=window.URL.createObjectURL(p);n=()=>window.URL.revokeObjectURL(f),e.request=ur(f,{responseType:r,timeout:i,signal:s}),e.request.then(m=>o(new gU(m.data,h,n)),a)},a),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],lL.prototype,"updating",void 0),lL=u([P("esri.views.3d.support.StreamDataLoader")],lL);const zat={numRetries:0};function Vat(e){if(e.byteLength<2)return"unknown";const t=new Uint8Array(e,0,e.byteLength);return t[0]===137&&t[1]===80?"image/png":t[0]===71&&t[1]===73?"image/gif":t[0]===66&&t[1]===77?"image/bmp":t[0]===255&&t[1]===216?"image/jpeg":"unknown"}class gU{constructor(t,i,r){this.image=t,this.type=i,this.release=r}get isOpaque(){return this.type==="image/jpeg"}}class Bat extends Nat{constructor(t,i,r,s,n){super(s),this.url=t,this.options=i,this.docType=r,this.key=n,this.result=null,this.status=Yu.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=zat.numRetries}}function Gat(e,t,i){return`${e}:${t}:${i}`}var Yu;(function(e){e[e.QUEUED=1]="QUEUED",e[e.DOWNLOADING=2]="DOWNLOADING",e[e.DOWNLOADED=3]="DOWNLOADED",e[e.CANCELLED=4]="CANCELLED"})(Yu||(Yu={}));let XI=class extends Ee{constructor(){super(...arguments),this.updating=!1}};function jat(e){return new vj.ResourceController({view:e})}var vj;u([d({readOnly:!0})],XI.prototype,"updating",void 0),XI=u([P("esri.views.3d.support.ResourceController")],XI),function(e){let t=class extends XI{constructor(){super(...arguments),this._scheduler=null,this._memoryController=null,this._streamDataLoader=null,this._scheduleTask=r2,this._cameraChangeTime=0,this._handles=new qt,this._frameTask=null,this._state=xn.IDLE}initialize(){this._cameraChangeTime=performance.now(),this._scheduler=a9e(),this._memoryController=$at(this.view),this._streamDataLoader=new lL,this._streamDataLoader.setup(Pat,Oat,this._scheduler),this._handles.add([ae(()=>{var r;return(r=this.view.state)==null?void 0:r.camera},(r,s)=>this._cameraChangedHandler(r,s),rr),ae(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=Eb({update:r=>this._frame(r)}),this._scheduleTask=this._scheduler.registerTask(mt.RESOURCE_CONTROLLER)}destroy(){this._handles=ot(this._handles),this._scheduleTask.remove(),this._frameTask=Ds(this._frameTask),this._streamDataLoader=ot(this._streamDataLoader),this._memoryController=ot(this._memoryController),this._scheduler=ot(this._scheduler)}get updating(){var r,s,n;return!!(((r=this._memoryController)==null?void 0:r.updating)||((s=this._streamDataLoader)==null?void 0:s.updating)||((n=this._scheduleTask)==null?void 0:n.updating))}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}schedule(r,s,n){return this._scheduleTask.schedule(r,s,n)}createStreamDataRequester(r){const s=this._streamDataLoader;return{request:(n,o,a)=>s.request(n,o,r,a),get busy(){return!s.hasDownloadSlots(r)}}}_frame(r){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(CH(r.deltaTime)),!this._scheduler)||(this._updateState(),this._scheduler.state=this._state,this._scheduler.updateBudget(r)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_cameraChangedHandler(r,s){r&&s&&r.almostEquals(s)||(this._cameraChangeTime=performance.now(),this._updateState(),this._scheduler.state=this._state)}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}_updateState(){this.view.animation?this._state=xn.ANIMATING:this.view.interacting?this._state=xn.INTERACTING:(this._state===xn.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=i?this._state=xn.INTERACTING:this._state=xn.IDLE)}get test(){return{getQueueStats:r=>this._streamDataLoader.test.loadQueue.getStatsForType(r),state:this._state}}};u([d({constructOnly:!0})],t.prototype,"view",void 0),u([d()],t.prototype,"_scheduler",void 0),u([d()],t.prototype,"_memoryController",void 0),u([d()],t.prototype,"_streamDataLoader",void 0),u([d()],t.prototype,"_scheduleTask",void 0),u([d({readOnly:!0})],t.prototype,"updating",null),t=u([P("esri.views.3d.support.ResourceController")],t),e.ResourceController=t;const i=300}(vj||(vj={}));function Hat(e){return"performanceInfo"in e}const cx=O(),qat=O(),rm=O(),sm=O();function Wat(e,t,i=0){const r=e.extent;if(R(r))return!1;if(i===0)return rhe(r,t);const s=Math.min(r[2]-r[0],r[3]-r[1]);return rRe(r,t,i*s)}function YI(e,t,i,r){se(cx,i),cx[r]=t[r];const s=pe(cx,cx,t),n=pe(qat,e,t),o=xe(n,s),a=xe(s,s);let l;l=o<=0?t:a<=o?i:de(cx,t,oe(s,s,o/a));const c=pe(cx,e,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function Xat(e,t,i){const r=e.extent;if(R(r))return 0;rm[0]=r[0],rm[1]=r[1],rm[2]=i,sm[0]=r[2],sm[1]=r[3],sm[2]=i;let s=1/0,n=1/0;return t[0]<rm[0]?s=YI(t,rm,sm,0):t[0]>sm[0]&&(s=YI(t,sm,rm,0)),t[1]<rm[1]?n=YI(t,rm,sm,1):t[1]>sm[1]&&(n=YI(t,sm,rm,1)),Math.min(s,n)}function Yat(e,t,i){if(R(e))return bX();if(e.spatialReference.isGeographic&&!Db(e.spatialReference))return new q("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const r=Rr.checkUnsupported(e);if(_(r))return r;if(R(i))return new q("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const s=Zat(e,i);if(s)return s;const n=e.spatialReference;return _(t)&&!(n.equals(t)||t.isWGS84&&n.isWebMercator)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene"):null}function Zat(e,t){const i=e.lods,r=i[0].resolution*2**i[0].level,s=[r*e.size[0],r*e.size[1]],n=[e.origin.x,e.origin.y],o=the(t),a=Dt();Rr.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>PT){const c=i[0].scale*2**i[0].level;let h=Math.max((o[3]-o[1])/e.size[1],(o[2]-o[0])/e.size[0])*c/r;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new q("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:PT})}return null}const Qat=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:Wat,tiltToExtentEdge:Xat,checkIfTileInfoSupportedForViewSR:Yat},Symbol.toStringTag,{value:"Module"}));function Jat(){return!0}function Kat(){return 0}function elt(e,t){if(R(e))return bX();const i=e.lods.length-1,r=e.spatialReference,s=Db(r)||If(r)||$f(r);if(r.isWebMercator){if(!Rr.makeWebMercatorAuxiliarySphere(i).compatibleWith(e))return new q("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new q("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!Rr.makeGCSWithTileSize(e.spatialReference,e.size[0],i).compatibleWith(e))return e.spatialReference.isWGS84?new q("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new q("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return _(t)&&!e.spatialReference.equals(t)?new q("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene"):void 0}const tlt=Object.freeze(Object.defineProperty({__proto__:null,isInsideExtent:Jat,tiltToExtentEdge:Kat,checkIfTileInfoSupportedForViewSR:elt},Symbol.toStringTag,{value:"Module"})),ilt={[Ve.Global]:tlt,[Ve.Local]:Qat};function Qp(e,t){e||console.warn("Terrain: "+t)}function _j(e){return yU(e)?{fullExtent:e.fullExtent,minScale:e.layer.minScale,maxScale:e.layer.maxScale,tilemapCache:null}:e.layer}function LF(e){return(e==null?void 0:e.type)==="imagery-tile"||(e==null?void 0:e.type)==="wcs"}function yU(e){return(e==null?void 0:e.type)==="imagery-tile-3d"}function vZ(e){return(e==null?void 0:e.type)==="tile-3d"}function tO(e){return(e==null?void 0:e.type)==="vector-tile-3d"}function sxe(e){return(e==null?void 0:e.type)==="wmts-3d"}function bj(e){return(e==null?void 0:e.type)==="elevation-3d"}function nxe(e){return(e==null?void 0:e.type)==="group"}function NF(e){return e&&(vZ(e)||sxe(e)||yU(e)||tO(e))}function wj(e){return e&&(vZ(e)||yU(e)||tO(e)||sxe(e))}function iO(e){return wj(e)||bj(e)}function C1t(e){switch(e.type){case"building-scene":case"csv":case"feature":case"geo-rss":case"geojson":case"graphics":case"group":case"integrated-mesh":case"kml":case"line-of-sight":case"map-notes":case"ogc-feature":case"point-cloud":case"route":case"scene":case"stream":case"voxel":case"subtype-group":case"unknown":case"unsupported":case"wfs":case null:return!1;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"elevation":case"imagery":case"imagery-tile":case"map-image":case"media":case"open-street-map":case"tile":case"vector-tile":case"wcs":case"web-tile":case"wms":case"wmts":return!0;default:return e.type,!1}}function rlt(e){var i;const t=(i=e==null?void 0:e.sourceLayerInfo)==null?void 0:i.data;return _(t)&&"type"in t&&t.type==="raster-tile"}function slt(e){var i;const t=(i=e==null?void 0:e.sourceLayerInfo)==null?void 0:i.data;return _(t)&&"type"in t&&t.type==="vector-tile"}function nlt(e){var i;const t=(i=e==null?void 0:e.sourceLayerInfo)==null?void 0:i.data;return _(t)&&"type"in t&&t.type==="tile-texture"}function olt(e){var i;const t=(i=e==null?void 0:e.sourceLayerInfo)==null?void 0:i.data;return t instanceof HTMLImageElement||t instanceof gU||t instanceof HTMLCanvasElement||t instanceof ImageData}function dS(e){return _(e)&&"release"in e&&e.release(),null}function noe(e){return e.fetchTile&&e.hasOverriddenFetchTile!==!1}function _Z(e,t,i,r){return ilt[r].checkIfTileInfoSupportedForViewSR(e,i,t)}function vU(e,t,i){let r=null,s=null;if((e==null?void 0:e.type)==="wmts"){const n=alt(e,t,i);r=n.tileInfo,s=n.fullExtent}else{s=LF(e)?e.getCompatibleFullExtent(t):e.fullExtent;const n=i===Ve.Local;if(LF(e))r=e.getCompatibleTileInfo(t,s,n);else if((e==null?void 0:e.type)==="vector-tile"){const o=n&&!llt(t)||clt.force512VTL,a=e.tileInfo.spatialReference.isGeographic;r=o?e.tileInfo:e.tileInfo.getOrCreateCompatible(256,a?1:2)}else r=e.tileInfo}return _(r)&&_(s)&&_Z(r,s,t,i)==null?{tileInfo:r,fullExtent:s}:null}function alt(e,t,i){const r=cIe(e);if(_(r)){if(!at.isCollection(r))return{tileInfo:r.tileInfo,fullExtent:r.fullExtent};{const s=r.find(n=>_Z(n.tileInfo,n.fullExtent,t,i)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function llt(e){return e.isWGS84||e.isWebMercator||Zce(e)||!RS(e)}const clt={force512VTL:!1};function FF(e){return e===Nt.NORTH_EAST?Nt.SOUTH_WEST:e===Nt.NORTH_WEST?Nt.SOUTH_EAST:e===Nt.SOUTH_WEST?Nt.NORTH_EAST:Nt.NORTH_WEST}function cL(e){return e===Nt.NORTH?Nt.SOUTH:e===Nt.EAST?Nt.WEST:e===Nt.SOUTH?Nt.NORTH:Nt.EAST}function ult(e){return e===Nt.NORTH_WEST||e===Nt.SOUTH_WEST}function hlt(e){return e===Nt.NORTH_WEST||e===Nt.NORTH_EAST}function ooe(e){return e===Nt.NORTH_WEST||e===Nt.WEST||e===Nt.SOUTH_WEST}function aoe(e){return e===Nt.NORTH_EAST||e===Nt.EAST||e===Nt.SOUTH_EAST}function loe(e){return e===Nt.SOUTH_EAST||e===Nt.SOUTH||e===Nt.SOUTH_WEST}function coe(e){return e===Nt.NORTH_EAST||e===Nt.NORTH||e===Nt.NORTH_WEST}const A0=[Nt.NORTH,Nt.EAST,Nt.SOUTH,Nt.WEST],UF=[Nt.NORTH_EAST,Nt.SOUTH_EAST,Nt.SOUTH_WEST,Nt.NORTH_WEST];class dlt{constructor(t,i){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=t.layer,this.memory=iO(t)?i.basemapTerrain.getUsedMemoryForLayerView(t):t.getUsedMemory(),Hat(t)){const r=t.performanceInfo;this.displayedNumberOfFeatures=r.displayedNumberOfFeatures,this.maximumNumberOfFeatures=r.maximumNumberOfFeatures,this.totalNumberOfFeatures=r.totalNumberOfFeatures}}}class plt{constructor(t){this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array;const i=t.resourceController.memoryController;this.totalMemory=i.maxMemory*jS.MEGABYTES,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=i.memoryFactor,this.load=t.resourceController.scheduler.load,this.terrainMemory=t.basemapTerrain?t.basemapTerrain.getUsedMemory():0;const r=t._stage&&t._stage.renderView&&t._stage.renderView.edgeView;this.edgesMemory=_(r)?r.usedMemory:0,t.allLayerViews.items.forEach(s=>{(rxe(s)||iO(s))&&this.layerPerformanceInfos.push(new dlt(s,t))}),this.layerPerformanceInfos.sort((s,n)=>n.memory-s.memory)}}class flt extends IT{constructor(t,i,r,s){super(i,s),this._streamDataRequester=t,this._parameters=r}async fromUrl(t,i,r){li(r);const s=_(r)&&r.signal,n=this.makeUid(t,i);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(t,"image",{uid:n,signal:a.signal});o={referenceCount:0,texture:null,textureAsync:null,abortController:a},this._textureRequests.set(n,o),o.textureAsync=l.then(async c=>{const h=this._createTexture(t,c,i);return o.texture=h,o.abortController=null,this._stage.add(h),await this._stage.load(h),{uid:n,texture:h,release:()=>this._release(n)}},c=>{throw o.abortController=null,c})}return o.referenceCount++,new Promise((a,l)=>{Wo(s,()=>{l(ui())}),o.textureAsync.then(a,l)}).catch(a=>{throw this._release(n),a})}_createTexture(t,i,r){const s=ve(F({},this._parameters),{powerOfTwoResizeMode:sv.PAD});if(yq(t)){if(r||i.width===0&&i.height===0){const n=i.width?i.height/i.width:1;r=r||64,n>1?(i.width=Math.round(r/n),i.height=r):(i.width=r,i.height=Math.round(r*n))}this._stage.renderView&&this._stage.renderView.renderingContext.driverTest.svgAlwaysPremultipliesAlpha&&(s.preMultiplyAlpha=!1)}return s.width=i.width,s.height=i.height,new Cs(i,s)}}class mlt{constructor(t){this.textures=null,this.streamDataRequester=null,this.graphicsOwners=[],this.screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this.viewState=t.viewState,this.view=t.view,this.pointsOfInterest=t.pointsOfInterest,this.objectResourceCache=t.objectResourceCache,this.streamDataRequester=t.resourceController.createStreamDataRequester(sf.SYMBOLOGY),this.textures=new flt(this.streamDataRequester,t.view._stage,{preMultiplyAlpha:!0,wrap:{s:_t.CLAMP_TO_EDGE,t:_t.CLAMP_TO_EDGE}},t.resourceController.scheduler);const i=vi(this.view.spatialReference).radius;this.screenSizePerspectiveSettings=G_e(t.viewingMode,i),this.screenSizePerspectiveSettingsLabels=HYe(t.viewingMode,i)}destroy(){this.textures.destroy(),this.textures=null,this.streamDataRequester=null}addGraphicsOwner(t){if(!t)return Th();this.graphicsOwners.push(t);const i=ae(()=>{var r;return(r=t.layer)==null?void 0:r.screenSizePerspectiveEnabled},()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),Th(()=>{i.remove(),QF(this.graphicsOwners,t),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const t=this.graphicsOwners.some(i=>{var r;return((r=i.layer)==null?void 0:r.screenSizePerspectiveEnabled)===!0});if(t&&!this.screenSizePerspectiveHandles){this.screenSizePerspectiveHandles=new qt;const i=()=>this._updateScreenSizePerspectiveSettings();this.screenSizePerspectiveHandles.add([ae(()=>this.pointsOfInterest.centerOnSurfaceInfrequent.distance,i,rr),this.viewState.events.on("camera-projection-changed",i)]),this._updateScreenSizePerspectiveSettings()}else!t&&this.screenSizePerspectiveHandles&&(this.screenSizePerspectiveHandles.destroy(),this.screenSizePerspectiveHandles=null)}_updateScreenSizePerspectiveSettings(){const t=this.pointsOfInterest;ZI.distance=t.centerOnSurfaceInfrequent.distance,ZI.fovY=this.viewState.camera.fovY,this.screenSizePerspectiveSettings.update(ZI),this.screenSizePerspectiveSettingsLabels.update(ZI),this.view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this.screenSizePerspectiveHandles}}}const ZI={distance:0,fovY:0};class n0{constructor(t,i,r=""){this.graphics=t,this._symbol=new L0({symbolLayers:[new D0({material:{color:i},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new pw({text:r,halo:{color:"white",size:1/.75},material:{color:i},size:12})]})}show(t,i){if(R(i))return;this.hide();const r=new nt({x:t[0],y:t[1],z:t[2],spatialReference:i});this._graphic=new Ca({geometry:r,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){_(this._graphic)&&(this.graphics.remove(this._graphic),this._graphic=null)}}let R0=class extends Ee{constructor(e){super(e),this.handles=new qt}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],R0.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],R0.prototype,"surface",void 0),u([d({constructOnly:!0})],R0.prototype,"state",void 0),R0=u([P("esri.views.3d.support.PointOfInterest")],R0);const glt=Array;let $c=class extends R0{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new Tg({location:nt,renderLocation:glt},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.cameraName="camera",this.renderLocation=O(),this.tmpPoint=new nt}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(eo(()=>{var t,i;return(i=(t=this.map)==null?void 0:t.ground)==null?void 0:i.layers},"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool.destroy(),this._propertiesPool=null}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,t=nr(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return Jb(i,t,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return void this._updateSurfaceAltitude(0);this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this.tmpPoint,this.state.spatialReference);let e=new AbortController;this.map.ground.queryElevation(this.tmpPoint,{signal:e.signal,cache:this.cache}).then(t=>this._updateSurfaceAltitude(t.geometry.z)).catch(t=>{Gr(t)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===e&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),e=null}),this._pendingElevationQueryController=e}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(hV,this._estimatedSurfaceAltitude,this._camera.eye),tl(this._get("renderLocation"),hV)||this._set("renderLocation",se(this._propertiesPool.get("renderLocation"),hV))}};u([d({constructOnly:!0})],$c.prototype,"scheduler",void 0),u([d({constructOnly:!0})],$c.prototype,"cache",void 0),u([d({constructOnly:!0})],$c.prototype,"task",void 0),u([d({constructOnly:!0})],$c.prototype,"cameraName",void 0),u([d({readOnly:!0})],$c.prototype,"location",null),u([d({constructOnly:!0})],$c.prototype,"map",void 0),u([d({readOnly:!0})],$c.prototype,"renderLocation",void 0),u([d({readOnly:!0})],$c.prototype,"scale",null),u([d({readOnly:!0})],$c.prototype,"updating",null),$c=u([P("esri.views.3d.support.CameraOnSurface")],$c);const hV=O(),ylt=Array;let Dl=class extends R0{constructor(e){super(e),this._propertiesPool=new Tg({location:nt,renderLocation:ylt},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.cameraName="camera",this.distance=0,this.renderLocation=O(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Ds(this._frameWorker),this._propertiesPool=ot(this._propertiesPool)}get _camera(){return this.state[this.cameraName]}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1}_updateRenderLocation(){const e=_lt;let t=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!t&&i&&(t=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),t&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const r=blt;t&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,r)&&(se(e,r),this._currentSurfaceAltitude=this._latestSurfaceAltitude),t?this.distance=nr(this._camera.eye,e):(oe(e,this._camera.viewForward,this._get("distance")),de(e,e,this._camera.eye)),tl(this._get("renderLocation"),e)||this._set("renderLocation",se(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,t){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,t))return!1;if(this.state.isGlobal){const r=vi(this.renderCoordsHelper.spatialReference).radius,s=r+e,n=ba(i.eye),o=n<s*s,a=nr(i.eye,t);if(o&&a>r/4){const l=s-Math.sqrt(n);return oe(t,i.viewForward,l),de(t,t,i.eye),!0}}else{const r=this.surface.ready?this.surface.extent:null;_(r)&&A4(r,this.surface.spatialReference,pC,this.renderCoordsHelper.spatialReference)&&(t[0]=$e(t[0],pC[0],pC[2]),t[1]=$e(t[1],pC[1],pC[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,t){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,t)){if(zi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,r=nr(i,e),s=nr(i,t);if(Math.abs(s-r)/r>vlt)return!0}return!1}};u([d({constructOnly:!0})],Dl.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Dl.prototype,"task",void 0),u([d({constructOnly:!0})],Dl.prototype,"cameraName",void 0),u([d()],Dl.prototype,"distance",void 0),u([d({constructOnly:!0})],Dl.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],Dl.prototype,"location",null),u([d({readOnly:!0})],Dl.prototype,"renderLocation",void 0),u([d()],Dl.prototype,"updating",void 0),Dl=u([P("esri.views.3d.support.CenterOnSurface")],Dl);const vlt=.05,_lt=O(),blt=O(),pC=Dt();class wlt{constructor(t){this.handles=new qt,this.events=new us,this.contentLayerViews=t.contentLayerViews,this.handles.add(this.contentLayerViews.on("change",i=>this._layerViewsChanged(i))),this._layerViewsChanged({added:this.contentLayerViews.toArray(),removed:[],moved:[],target:this.contentLayerViews})}destroy(){this.handles&&(this.handles.destroy(),this.handles=null)}_layerViewsChanged(t){t.added.forEach(i=>{i.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this.handles.add(i.on("visible-geometry-changed",()=>this._contentChanged()),i.uid)}),t.removed.forEach(i=>this.handles.remove(i.uid))}_contentChanged(){this.events.emit("request-update",xlt)}}const xlt={},Tlt=Array;let kp=class extends R0{constructor(e){super(e),this._propertiesPool=new Tg({location:nt,renderLocation:Tlt},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([ae(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),ae(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(mt.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool.destroy(),this._propertiesPool=null}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),t=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,r=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(t,uoe);const s=Math.max(0,(Math.acos(xe(uoe,r.viewForward))-.5*Math.PI)*(r.aboveGround?1:-1));if(Number.isNaN(s)){if(!e||!Tb(e,t)){const l=this._propertiesPool.get("renderLocation");se(l,t),this._set("renderLocation",l)}return}const n=1-$e(s/(.5*Math.PI),0,1),o=n*n*n;this._calculateScreenHorizontalEdgeOnSurface(hoe);const a=this._propertiesPool.get("renderLocation");en(a,t,hoe,o),e&&Tb(e,a)||this._set("renderLocation",a)}_calculateScreenHorizontalEdgeOnSurface(e){const t=this.state.contentCamera,i=t.getRenderCenter(wo());if(i[1]=t.aboveGround?t.padding[Ct.BOTTOM]:t.fullHeight-t.padding[Ct.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const r=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(t.unprojectFromRenderScreen(i,fC)){pe(fC,fC,t.eye);const s=we(fC,fC);if(this.renderCoordsHelper.intersectManifold(mu(t.eye,s),r,e))return e}return this.renderCoordsHelper.setAltitude(e,r,t.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],kp.prototype,"_dirty",void 0),u([d({constructOnly:!0})],kp.prototype,"scheduler",void 0),u([d({constructOnly:!0})],kp.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],kp.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],kp.prototype,"updating",null),u([d({readOnly:!0})],kp.prototype,"location",null),u([d({readOnly:!0})],kp.prototype,"renderLocation",void 0),kp=u([P("esri.views.3d.support.CenterOnSurface")],kp);const uoe=O(),fC=O(),hoe=O();let Pm=class extends Ee{constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new qt}get renderLocation(){if(!this.location)return null;const e=O();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}initialize(){this.view.state.isLocal&&(this._handles.add([ae(()=>{var e,t;return[(e=this.surfaceView)==null?void 0:e.spatialReference,(t=this.surfaceView)==null?void 0:t.extent]},()=>this._update()),eo(()=>{var e;return(e=this.surface)==null?void 0:e.layers},"change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||R(this.surfaceView.extent)||!this.surfaceView.spatialReference)return void this._set("location",null);const e=nq(this.surfaceView.extent),t=new nt({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(t,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{Gr(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",t)}};u([d({constructOnly:!0})],Pm.prototype,"view",void 0),u([d({constructOnly:!0})],Pm.prototype,"cache",void 0),u([d({readOnly:!0,aliasOf:"view.map.ground"})],Pm.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"view.basemapTerrain"})],Pm.prototype,"surfaceView",void 0),u([d({readOnly:!0})],Pm.prototype,"location",void 0),u([d({readOnly:!0})],Pm.prototype,"renderLocation",null),Pm=u([P("esri.views.3d.terrain.StableSurfaceCenter")],Pm);let Im=class extends Ee{constructor(){super(...arguments),this.handles=new qt,this._tileGeometryUpdateExtent=hu(),this._tileGeometryUpdateSpatialReference=null,this.events=new us,this.updating=!1}initialize(){this.handles.add([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(mt.SURFACE_GEOMETRY_UPDATES,this)])}destroy(){this.handles=ot(this.handles)}get running(){return this.updating}runTask(){this.updating&&(this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",Slt),hu(this._tileGeometryUpdateExtent),this._set("updating",!1))}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,cb(this._tileGeometryUpdateExtent,e.tile.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let t=1;t<this.centerOnSurfaces.length;t++){const i=this.centerOnSurfaces[t];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,t){const i=this.state.camera.eye,r=Elt,s=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,C_,t),this.renderCoordsHelper.fromRenderCoords(s.renderLocation,A_,t),C_[0]<A_[0]?(r[0]=C_[0],r[2]=A_[0]):(r[0]=A_[0],r[2]=C_[0]),C_[1]<A_[1]?(r[1]=C_[1],r[3]=A_[1]):(r[1]=A_[1],r[3]=C_[1]),TO(r,e)}};u([d({constructOnly:!0})],Im.prototype,"state",void 0),u([d({constructOnly:!0})],Im.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],Im.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Im.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Im.prototype,"surface",void 0),u([d({readOnly:!0})],Im.prototype,"updating",void 0),Im=u([P("esri.views.3d.support.SurfaceGeometryUpdates")],Im);const Slt={},C_=O(),A_=O(),Elt=hu();let ko=class extends Ee{constructor(e){super(e),this._handles=new qt,this._tmpRay=Yn(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new Tg({renderPointOfView:Clt},this),this.renderPointOfView=O(),this._pois=new Array,this._debugCenters=new Map}initialize(){var c;const{state:e,basemapTerrain:t,renderCoordsHelper:i,map:r}=this.view;this._surfaceIntersector=Mh(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=io.MIN,this._contentIntersector=Mh(e.viewingMode);const s=()=>this._estimateSurfaceAltitudeAtCenter(),n=this.view.resourceController.scheduler,o=(c=this.view.basemapTerrain)==null?void 0:c.elevationQueryCache,a={state:e,scheduler:n,surface:t,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new Dl(ve(F({},a),{task:mt.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("centerOnSurfaceFrequent",new Dl(ve(F({},a),{task:mt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:s}))),this._set("contentCenterOnSurface",new Dl(ve(F({},a),{task:mt.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:s,cameraName:"contentCamera"}))),this._set("centerOnContent",new Dl(ve(F({},a),{task:mt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()}))),this._set("cameraOnSurface",new $c(ve(F({},a),{cache:o,task:mt.POINT_OF_INTEREST_INFREQUENT,map:r}))),this._set("contentCameraOnSurface",new $c(ve(F({},a),{cache:o,task:mt.POINT_OF_INTEREST_INFREQUENT,map:r,cameraName:"contentCamera"}))),this._set("surfaceGeometryUpdates",new Im(ve(F({},a),{centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]}))),this._set("contentGeometryUpdates",new wlt({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Pm({cache:o,view:this.view})),this._set("focus",new kp({state:e,scheduler:n,surface:t,renderCoordsHelper:i,centerOnSurface:this.contentCenterOnSurface,estimateSurfaceIntersectionAtRenderPoint:(h,p)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.contentCenterOnSurface,this.cameraOnSurface,this.contentCameraOnSurface,this.focus);const l=this.view.graphics;this._debugCenters.set(this.centerOnContent,new n0(l,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new n0(l,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new n0(l,"red","CenterOnSurface")),this._debugCenters.set(this.contentCenterOnSurface,new n0(l,"red","ContentCenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new n0(l,"blue","CameraOnSurface")),this._debugCenters.set(this.contentCameraOnSurface,new n0(l,"blue","ContentCameraOnSurface")),this._debugCenters.set(this.focus,new n0(l,"green","Focus")),this._handles.add([ae(()=>e.camera,h=>this._cameraChanged(h),rr),ae(()=>t.extent,()=>this._updateCenterPointsOfInterest()),cl(()=>!t.updating,()=>this._updateCenterPointsOfInterest(),rr),eo(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),eo(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),cl(()=>zi.SHOW_POI,h=>this._setDebug(h),Ft)]),this._cameraChanged(this.view.state.camera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){var e;return!(!((e=this.surfaceGeometryUpdates)==null?void 0:e.updating)&&!this._pois.some(t=>t.updating))}get centerRay(){return this._centerRayDirty&&(this._centerRay=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.camera,this._tmpRay),this._centerRayDirty=!1),this._centerRay}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this.centerRay;return R(e)||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,ux,Rlt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(ux):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this.centerRay;if(R(e))return this._surfaceAltitudeAtCenter;const t=e.origin,i=de(ux,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.camera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,t,i),this._surfaceIntersector.results.min.getIntersectionPoint(ux)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(ux)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,t,i){const r=mY(t,e,Alt);if(R(r))return null;const s=r.origin,n=de(ux,r.origin,r.direction);return this._surfaceIntersector.resetWithRay(r,t),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,s,n),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const t=e.eye;tl(this.renderPointOfView,t)||this._set("renderPointOfView",se(this._propertiesPool.get("renderPointOfView"),t))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(t=>t.hide()),void this._handles.remove("debug");for(const t of this._pois)this._handles.add(ae(()=>t.renderLocation,i=>this._debugCenters.get(t).show(i,t.renderCoordsHelper.spatialReference),Ft),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],ko.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],ko.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],ko.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],ko.prototype,"contentCenterOnSurface",void 0),u([d({readOnly:!0})],ko.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],ko.prototype,"contentCameraOnSurface",void 0),u([d({readOnly:!0})],ko.prototype,"focus",void 0),u([d({readOnly:!0})],ko.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],ko.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],ko.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],ko.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],ko.prototype,"view",void 0),u([d({readOnly:!0})],ko.prototype,"updating",null),ko=u([P("esri.views.3d.support.PointsOfInterest")],ko);const Clt=Array,ux=O(),Alt=Yn(),Rlt={exclude:new Set([Rd])};class Mlt{constructor(t){this.store=t}destroy(){this.store.destroy()}get(t){return this.store.get(t)}put(t,i){this.store.put(t,i,i.values.byteLength+256)}}const Olt=me.getLogger("esri.core.workers.WorkerHandle");class oxe{constructor(t,i,r,s,n={}){this._mainMethod=i,this._transferLists=r,this._listeners=[],this._promise=rde(t,ve(F({},n),{schedule:s})).then(o=>{if(this._thread===void 0){this._thread=o,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const a of this._listeners)this._connectListener(a)}else o.close()}),this._promise.catch(o=>Olt.error(`Failed to initialize ${t} worker: ${o}`))}on(t,i){const r={removed:!1,eventName:t,callback:i,threadHandle:null};return this._listeners.push(r),this._connectListener(r),Th(()=>{r.removed=!0,_H(this._listeners,r),this._thread&&_(r.threadHandle)&&r.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null}invoke(t,i){return this.invokeMethod(this._mainMethod,t,i)}invokeMethod(t,i,r){if(this._thread){const s=this._transferLists[t],n=s?s(i):[];return this._thread.invoke(t,i,{transferList:n,signal:r})}return this._promise?this._promise.then(()=>(li(r),this.invokeMethod(t,i,r))):Promise.reject(null)}broadcast(t,i){return this._thread?Promise.all(this._thread.broadcast(i,t)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(t,i)):Promise.reject()}get promise(){return this._promise}_connectListener(t){this._thread&&this._thread.on(t.eventName,t.callback).then(i=>{t.removed||(t.threadHandle=i)})}}class doe extends oxe{constructor(t=null){super("LercWorker","_decode",{_decode:i=>[i.buffer]},t,{strategy:"dedicated"}),this.schedule=t,this.ref=0}decode(t,i,r){return t&&t.byteLength!==0?this.invoke({buffer:t,options:i},r):Promise.resolve(null)}release(){--this.ref<=0&&(PR.forEach((t,i)=>{t===this&&PR.delete(i)}),this.destroy())}}const PR=new Map;function Plt(e=null){let t=PR.get(e);return t||(_(e)?(t=new doe(i=>e.schedule(i)),PR.set(e,t)):(t=new doe,PR.set(null,t))),++t.ref,t}function hg(){const e=new Float32Array(9);return e[0]=1,e[4]=1,e[8]=1,e}function axe(e){const t=new Float32Array(9);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function Ilt(e,t,i,r,s,n,o,a,l){const c=new Float32Array(9);return c[0]=e,c[1]=t,c[2]=i,c[3]=r,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function $lt(e,t){return new Float32Array(e,t,9)}Object.freeze(Object.defineProperty({__proto__:null,create:hg,clone:axe,fromValues:Ilt,createView:$lt},Symbol.toStringTag,{value:"Module"}));var poe,zl,foe,moe,goe;(function(e){e[e.UNKNOWN=0]="UNKNOWN",e[e.FILL_VERTEX=1]="FILL_VERTEX",e[e.FILL_DD_VERTEX=2]="FILL_DD_VERTEX",e[e.FILL_INDEX=3]="FILL_INDEX",e[e.OUTLINE_VERTEX=4]="OUTLINE_VERTEX",e[e.OUTLINE_DD_VERTEX=5]="OUTLINE_DD_VERTEX",e[e.OUTLINE_INDEX=6]="OUTLINE_INDEX",e[e.LINE_VERTEX=7]="LINE_VERTEX",e[e.LINE_DD_VERTEX=8]="LINE_DD_VERTEX",e[e.LINE_INDEX=9]="LINE_INDEX",e[e.ICON_VERTEX=10]="ICON_VERTEX",e[e.ICON_DD_VERTEX=11]="ICON_DD_VERTEX",e[e.ICON_INDEX=12]="ICON_INDEX",e[e.TEXT_VERTEX=13]="TEXT_VERTEX",e[e.TEXT_DD_VERTEX=14]="TEXT_DD_VERTEX",e[e.TEXT_INDEX=15]="TEXT_INDEX",e[e.CIRCLE_VERTEX=16]="CIRCLE_VERTEX",e[e.CIRCLE_INDEX=17]="CIRCLE_INDEX"})(poe||(poe={})),function(e){e[e.FILL=1]="FILL",e[e.LINE=2]="LINE",e[e.SYMBOL=3]="SYMBOL",e[e.CIRCLE=4]="CIRCLE"}(zl||(zl={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.OPAQUE=1]="OPAQUE",e[e.TRANSLUCENT=2]="TRANSLUCENT",e[e.SYMBOLS=3]="SYMBOLS",e[e.HITTEST=4]="HITTEST"}(foe||(foe={})),function(e){e[e.BACKGROUND=0]="BACKGROUND",e[e.FILL=1]="FILL",e[e.OUTLINE=2]="OUTLINE",e[e.LINE=3]="LINE",e[e.ICON=4]="ICON",e[e.CIRCLE=5]="CIRCLE",e[e.TEXT=6]="TEXT",e[e.TILEINFO=7]="TILEINFO"}(moe||(moe={})),function(e){e[e.PAINTER_CHANGED=0]="PAINTER_CHANGED",e[e.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",e[e.LAYER_CHANGED=2]="LAYER_CHANGED",e[e.LAYER_REMOVED=3]="LAYER_REMOVED",e[e.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(goe||(goe={}));class Dlt{constructor(t){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=t}}class A1t{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}}function R1t(e,t,i,r,s,n){const o=i-s;if(o>=0)return(t>>o)+(r-(n<<o))*(e>>o);const a=-o;return t-(n-(r<<a))*(e>>a)<<a}class M1t{constructor(t,i,r){this._rows=Math.ceil(i/r),this._columns=Math.ceil(t/r),this._cellSize=r,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(t,i){const r=Math.min(Math.max(Math.floor(i/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(t/this._cellSize),0),this._columns-1);return this.cells[r]&&this.cells[r][s]||null}getCellSpan(t,i,r,s){return[Math.min(Math.max(Math.floor(t/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}}function Llt(e,t,i,r,s,n){const o=t[r++];for(let a=0;a<o;a++){const l=new Dlt(n);l.xTile=t[r++],l.yTile=t[r++],l.hash=t[r++],l.priority=t[r++];const c=t[r++];for(let f=0;f<c;f++){const m=t[r++],y=t[r++],v=t[r++],w=t[r++],b=!!t[r++],S=t[r++],T=i[r++],E=i[r++],C=t[r++],M=t[r++];l.colliders.push({xTile:m,yTile:y,dxPixels:v,dyPixels:w,hard:b,partIndex:S,width:C,height:M,minLod:T,maxLod:E})}const h=e[r++];for(let f=0;f<h;f++)l.textVertexRanges.push([e[r++],e[r++]]);const p=e[r++];for(let f=0;f<p;f++)l.iconVertexRanges.push([e[r++],e[r++]]);s.push(l)}return r}function O1t(e,t,i){for(const[r,s]of e.symbols)Nlt(e,t,i,s,r)}function Nlt(e,t,i,r,s){const n=e.layerData.get(s);if(n.type===zl.SYMBOL){for(const o of r){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;e.allSymbolsFadingOut=e.allSymbolsFadingOut&&p===0;const f=i?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=t,n.opacityChanged=!0}}class _U{constructor(t,i){this.layerUIDs=[],this.isDestroyed=!1,this.data=t,this.memoryUsed=t.byteLength;let r=1;const s=new Uint32Array(t);this.layerUIDs=[];const n=s[r++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[r++];this.bufferDataOffset=r,i&&(this.layer=i.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return R(this.data)}get offset(){return this.bufferDataOffset}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(t){R(this.data)||(this.doPrepareForRendering(t,this.data,this.bufferDataOffset),this.data=null)}}class Flt extends _U{constructor(t,i){super(t,i),this.type=zl.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.lineIndexStart=r[s++],this.lineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){_(this.lineVertexArrayObject)&&this.lineVertexArrayObject.dispose(),_(this.lineVertexBuffer)&&this.lineVertexBuffer.dispose(),_(this.lineIndexBuffer)&&this.lineIndexBuffer.dispose(),this.lineVertexArrayObject=null,this.lineVertexBuffer=null,this.lineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.lineVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.lineIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.lineMaterial;this.lineVertexArrayObject=new Ns(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.lineVertexBuffer},this.lineIndexBuffer)}}class Ult extends _U{constructor(t,i){super(t,i),this.type=zl.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.fillIndexStart=r[s++],this.fillIndexCount=r[s++],this.outlineIndexStart=r[s++],this.outlineIndexCount=r[s++];const n=r[s++];if(n>0){const o=new Map;for(let a=0;a<n;a++){const l=r[s++],c=r[s++],h=r[s++];o.set(l,[c,h])}this.patternMap=o}this.bufferDataOffset=s}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){_(this.fillVertexArrayObject)&&this.fillVertexArrayObject.dispose(),_(this.fillVertexBuffer)&&this.fillVertexBuffer.dispose(),_(this.fillIndexBuffer)&&this.fillIndexBuffer.dispose(),this.fillVertexArrayObject=null,this.fillVertexBuffer=null,this.fillIndexBuffer=null,_(this.outlineVertexArrayObject)&&this.outlineVertexArrayObject.dispose(),_(this.outlineVertexBuffer)&&this.outlineVertexBuffer.dispose(),_(this.outlineIndexBuffer)&&this.outlineIndexBuffer.dispose(),this.outlineVertexArrayObject=null,this.outlineVertexBuffer=null,this.outlineIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.fillVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.fillIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.outlineVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.outlineIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c;const h=this.layer,p=h.fillMaterial,f=h.outlineMaterial;this.fillVertexArrayObject=new Ns(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.fillVertexBuffer},this.fillIndexBuffer),this.outlineVertexArrayObject=new Ns(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.outlineVertexBuffer},this.outlineIndexBuffer)}}class klt extends _U{constructor(t,i,r){super(t,i),this.type=zl.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(t),n=new Int32Array(t),o=new Float32Array(t);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const m=s[a++],y=s[a++],v=s[a++];this.iconPerPageElementsMap.set(m,[y,v])}const c=s[a++];for(let f=0;f<c;f++){const m=s[a++],y=s[a++],v=s[a++];this.glyphPerPageElementsMap.set(m,[y,v])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=Llt(s,n,o,a,this.symbols,r),this.bufferDataOffset=a}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let t=0;for(const[i,r]of this.iconPerPageElementsMap)t+=r[1];for(const[i,r]of this.glyphPerPageElementsMap)t+=r[1];return t/3}doDestroy(){_(this.iconVertexArrayObject)&&this.iconVertexArrayObject.dispose(),_(this.iconVertexBuffer)&&this.iconVertexBuffer.dispose(),_(this.iconOpacityBuffer)&&this.iconOpacityBuffer.dispose(),_(this.iconIndexBuffer)&&this.iconIndexBuffer.dispose(),this.iconVertexArrayObject=null,this.iconVertexBuffer=null,this.iconOpacityBuffer=null,this.iconIndexBuffer=null,_(this.textVertexArrayObject)&&this.textVertexArrayObject.dispose(),_(this.textVertexBuffer)&&this.textVertexBuffer.dispose(),_(this.textOpacityBuffer)&&this.textOpacityBuffer.dispose(),_(this.textIndexBuffer)&&this.textIndexBuffer.dispose(),this.textVertexArrayObject=null,this.textVertexBuffer=null,this.textOpacityBuffer=null,this.textIndexBuffer=null,this.memoryUsed=0}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const t=this.iconOpacity,i=this.iconOpacityBuffer;t.length>0&&t.byteLength===i.size&&i.setSubData(t);const r=this.textOpacity,s=this.textOpacityBuffer;r.length>0&&r.byteLength===s.size&&s.setSubData(r)}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.iconVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.iconIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=s[r++];this.textVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,l)),r+=l;const c=s[r++];this.textIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,c)),r+=c,this.iconOpacityBuffer=ti.createVertex(t,yi.STATIC_DRAW,this.iconOpacity.buffer),this.textOpacityBuffer=ti.createVertex(t,yi.STATIC_DRAW,this.textOpacity.buffer);const h=this.layer,p=h.iconMaterial,f=h.textMaterial;this.iconVertexArrayObject=new Ns(t,p.getAttributeLocations(),p.getLayoutInfo(),{geometry:this.iconVertexBuffer,opacity:this.iconOpacityBuffer},this.iconIndexBuffer),this.textVertexArrayObject=new Ns(t,f.getAttributeLocations(),f.getLayoutInfo(),{geometry:this.textVertexBuffer,opacity:this.textOpacityBuffer},this.textIndexBuffer)}}class zlt extends _U{constructor(t,i){super(t,i),this.type=zl.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const r=new Uint32Array(t);let s=this.bufferDataOffset;this.circleIndexStart=r[s++],this.circleIndexCount=r[s++],this.bufferDataOffset=s}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){_(this.circleVertexArrayObject)&&this.circleVertexArrayObject.dispose(),_(this.circleVertexBuffer)&&this.circleVertexBuffer.dispose(),_(this.circleIndexBuffer)&&this.circleIndexBuffer.dispose(),this.circleVertexArrayObject=null,this.circleVertexBuffer=null,this.circleIndexBuffer=null,this.memoryUsed=0}doPrepareForRendering(t,i,r){const s=new Uint32Array(i),n=new Int32Array(s.buffer),o=s[r++];this.circleVertexBuffer=ti.createVertex(t,yi.STATIC_DRAW,new Int32Array(n.buffer,4*r,o)),r+=o;const a=s[r++];this.circleIndexBuffer=ti.createIndex(t,yi.STATIC_DRAW,new Uint32Array(s.buffer,4*r,a)),r+=a;const l=this.layer.circleMaterial;this.circleVertexArrayObject=new Ns(t,l.getAttributeLocations(),l.getLayoutInfo(),{geometry:this.circleVertexBuffer},this.circleIndexBuffer)}}const P1t=!0,I1t=32,yoe=200,Vlt=1/he("mapview-transitions-duration");class Blt extends us{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(t){this._clips=t,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(t){this._opacity!==t&&(this._opacity=Math.min(1,Math.max(t,0)),this.requestRender())}get stage(){return this._stage}set stage(t){if(this._stage===t)return;const i=this._stage;this._stage=t,t?this._stage.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):i.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return R(this._transforms)&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(t){this._visible!==t&&(this._visible=t,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=Wd(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=Wd(),this.requestRender()),this._fadeOutResolver.promise}beforeRender(t){this.updateTransitionProperties(t.deltaTime,t.state.scale)}afterRender(t){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){var t;(t=this.parent)==null||t.removeChild(this)}setTransform(t){}processRender(t){this.stage&&this.computedVisible&&this.doRender(t)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(t,i){if(this.fadeTransitionEnabled){const r=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===r)this.computedVisible=this.visible;else{const n=t*Vlt;this.computedOpacity=s>r?Math.max(r,s-n):Math.min(r,s+n),this.computedVisible=this.computedOpacity>0;const o=r===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(t){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}}class Kp{constructor(t,i,r,s){this.set(t,i,r,s)}static getId(t,i,r,s){return typeof t=="object"?`${t.level}/${t.row}/${t.col}/${t.world}`:`${t}/${i}/${r}/${s}`}get key(){return this}get id(){return this.toString()}set id(t){this.set(t)}get hash(){const t=4095&this.row,i=4095&this.col,r=63&this.level;return(3&this.world)<<30|i<<22|t<<8|r}acquire(t,i,r,s){this.set(t,i,r,s)}contains(t){const i=t.level-this.level;return this.row===t.row>>i&&this.col===t.col>>i&&this.world===t.world}equals(t){return this.level===t.level&&this.row===t.row&&this.col===t.col&&this.world===t.world}clone(){return new Kp(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(t,i,r,s){if(t==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof t=="object")this.level=t.level||0,this.row=t.row||0,this.col=t.col||0,this.world=t.world||0;else if(typeof t=="string"){const[n,o,a,l]=t.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+t,this.row=+i,this.col=+r,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new Kp(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const t=this.level+1,i=this.row<<1,r=this.col<<1,s=this.world;return[new Kp(t,i,r,s),new Kp(t,i,r+1,s),new Kp(t,i+1,r,s),new Kp(t,i+1,r+1,s)]}compareRowMajor(t){return this.row<t.row?-1:this.row>t.row?1:this.col<t.col?-1:this.col>t.col?1:0}}Kp.pool=new ys(Kp,null,null,25,50);class Glt extends Blt{constructor(t,i,r,s,n,o=s,a=n){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new Kp(t),this.x=i,this.y=r,this.width=s,this.height=n,this.rangeX=o,this.rangeY=a}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(t,i){const r=i/(t.resolution*t.pixelRatio),s=this.transforms.tileMat3,[n,o]=t.toScreenNoRotation([0,0],[this.x,this.y]),a=this.width/this.rangeX*r,l=this.height/this.rangeY*r;BX(s,a,0,0,0,l,0,n,o,1),f5(this.transforms.dvs,t.displayViewMat3,s)}}class IR extends Glt{constructor(t,i,r,s,n,o,a=null){super(t,i,r,s,n,4096,4096),this._memCache=a,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.styleRepository=o,this.id=t.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<yoe}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<yoe)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(t){this.changeDataImpl(t),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(t){let i=!1;for(const r of t)if(this.layerData.has(r)){const s=this.layerData.get(r);this._memoryUsedByLayerData-=s.memoryUsed,s.type===zl.SYMBOL&&this.symbols.has(r)&&(this.symbols.delete(r),i=!0),s.destroy(),this.layerData.delete(r),this.layerCount--}_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData),i&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(lxe.delete(this),IR._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsage(){return(this._memoryUsedByLayerData+256)/(this._referenced||1)}changeDataImpl(t){let i=!1;if(t){const{bucketsWithData:r,emptyBuckets:s}=t,n=this._createRenderBuckets(r);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===zl.SYMBOL&&(this.symbols.set(o,a.symbols),i=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;_(this._memCache)&&this._memCache.updateSize(this.key.id,this,this._memoryUsedByLayerData)}this._hasSymbolBuckets=!1;for(const[r,s]of this.layerData)s.type===zl.SYMBOL&&(this._hasSymbolBuckets=!0);i&&this.emit("symbols-changed")}attachWithContext(t){this.stage={context:t,trashDisplayObject(i){i.processDetach()},untrashDisplayObject:()=>!1}}setTransform(t,i){super.setTransform(t,i);const r=i/(t.resolution*t.pixelRatio),s=this.width/this.rangeX*r,n=this.height/this.rangeY*r,o=[0,0];t.toScreen(o,[this.x,this.y]);const a=this.transforms.tileUnitsToPixels;GX(a),YN(a,a,o),jX(a,a,Math.PI*t.rotation/180),HX(a,a,[s,n,1])}_createTransforms(){return{dvs:hg(),tileMat3:hg(),tileUnitsToPixels:hg()}}static _destroyRenderBuckets(t){if(!t)return;const i=new Set;t.forEach(r=>{i.has(r)||(r.destroy(),i.add(r))}),t.clear()}_createRenderBuckets(t){const i=new Map,r=new Map;for(const s of t){const n=this._deserializeBucket(s,r);for(const o of n.layerUIDs)i.set(o,n)}return i}_deserializeBucket(t,i){let r=i.get(t);if(r)return r;switch(new Uint32Array(t)[0]){case zl.FILL:r=new Ult(t,this.styleRepository);break;case zl.LINE:r=new Flt(t,this.styleRepository);break;case zl.SYMBOL:r=new klt(t,this.styleRepository,this);break;case zl.CIRCLE:r=new zlt(t,this.styleRepository)}return i.set(t,r),r}_deleteLayerData(t){if(!this.layerData.has(t))return;const i=this.layerData.get(t);this._memoryUsedByLayerData-=i.memoryUsed,i.destroy(),this.layerData.delete(t),this.layerCount--}}const lxe=new Map;function jlt(){lxe.forEach((e,t)=>{console.log(`
${t.key}:`),e[0].forEach(i=>console.log(i)),console.log("========"),e[1].forEach(i=>console.log(i))})}const $1t={value:.5,readOnly:!0},Hlt={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};class bZ{constructor(t=0,i=0){this.min=t,this.max=i,this.level=0,this.hasNoDataValues=!1}copyFrom(t){this.min=t.min,this.max=t.max,this.level=t.level,this.hasNoDataValues=t.hasNoDataValues}}class qlt{constructor(t,i,r){this.type="elevation",this.samplerData=null,this.level=t[0],this.i=t[1],this.j=t[2],this.extent=i;const s=r.noDataValue,n=r.values;let o=1/0,a=-1/0,l=!0,c=!1;for(let h=0;h<n.length;h++){const p=n[h];p!==s?(o=p<o?p:o,a=p>a?p:a,l=!1):c=!0}l&&(o=0,a=0),a=a>-3e38?a:0,this.samplerData={pixelData:r.values,width:r.width,height:r.height,noDataValue:s,safeWidth:.99999999*(r.width-1),dx:(r.width-1)/(i[2]-i[0]),dy:(r.width-1)/(i[3]-i[1]),x0:i[0],y1:i[3]},this.bounds=[o,a],this.hasNoDataValues=c}release(){this.samplerData=null,this.bounds=null}computeMinMaxValue(t,i,r,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=t-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(i/o)===this.i&&Math.floor(r/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.width,h=this.samplerData.pixelData,p=.5*fM;let f=(c-1)/o,m=(r-this.j*o)*f,y=(i-this.i*o)*f;if(f<1){const v=Math.floor(m),w=Math.floor(y),b=v+w*c,S=h[b],T=h[b+1],E=h[b+c],C=h[b+c+1];if(S+T+E+C<p){const M=m-v,I=y-w,N=Y3(S,T,E,C,M,I),D=Y3(S,T,E,C,M+f,I),z=Y3(S,T,E,C,M,I+f),V=Y3(S,T,E,C,M+f,I+f);return s.min=Math.min(N,D,z,V),s.max=Math.max(N,D,z,V),s}m=v,y=w,f=1}else m=Math.floor(m),y=Math.floor(y),f=Math.ceil(f);for(let v=m;v<=m+f;v++)for(let w=y;w<=y+f;w++){const b=h[v+w*c];b<p?(a=Math.min(a,b),l=Math.max(l,b)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}}function cxe(e,t,i){if(R(i))return null;for(const r of i){if(!r)continue;const s=r.safeWidth;let n=$e(r.dy*(r.y1-t),0,s),o=$e(r.dx*(e-r.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=r.width,h=a*c+l,p=r.pixelData,f=p[h],m=p[h+1],y=h+c,v=p[y],w=p[y+1];if(f+v+m+w<.5*fM){n-=a,o-=l;const b=f+(m-f)*o;return b+(v+(w-v)*o-b)*n}}return null}function gr(e,t,i){const r=cxe(e,t,i);return _(r)?r:0}let Xu=class extends Ee{constructor(e){super(e),this._handles=new qt}initialize(){this._handles.add([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){this._handles.destroy(),this._handles=null}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(t=>{const i=t.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const r=uxe(i.fullExtent,this.viewSpatialReference);_(r)&&e.push(the(r))}}),e}};function Wlt(e,t){return e===Ve.Global?new xj(t):new Tj(t)}u([d({readOnly:!0})],Xu.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],Xu.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],Xu.prototype,"stencilEnabledExtents",null),u([d()],Xu.prototype,"viewSpatialReference",void 0),u([d()],Xu.prototype,"tilingScheme",void 0),u([d()],Xu.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],Xu.prototype,"layers",void 0),u([d({constructOnly:!0})],Xu.prototype,"layerViews",void 0),Xu=u([P("esri.views.3d.terrain.ExtentHelper")],Xu);let xj=class extends Xu{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?l0e:EBe}};xj=u([P("esri.views.3d.terrain.ExtentHelperGlobal")],xj);let Tj=class extends Xu{_computeLayerViewsExtent(){const e=hu(),t=this.viewSpatialReference;this.layerViews.forEach(s=>{const n=s.layer;if(s.isResolved()&&(n.type!=="graphics"||!n.internal)){const o=uxe("fullExtentInLocalViewSpatialReference"in s&&s.fullExtentInLocalViewSpatialReference||s.layer.fullExtent,t);cb(e,o,e)}});const i=iB(e)?e:null,r=this._get("layerViewsExtent");return ub(i,r)?r:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const t=this.viewSpatialReference,i=hu();this.layers.forEach(n=>{if(n.loaded&&sR(n)){const o=vU(n,t,Ve.Local);if(R(o))return;const{tileInfo:a,fullExtent:l}=o;_(a)&&_(l)&&(LF(n)||e.compatibleWith(a)&&l.spatialReference.equals(e.spatialReference))&&cb(i,l,i)}}),cb(i,this.defaultTiledLayersExtent,i);const r=iB(i)?i:null,s=this._get("tiledLayersExtent");return ub(r,s)?s:r}};function uxe(e,t){return _(e)&&!e.spatialReference.equals(t)?Ode(e,e.spatialReference,t):e}Tj=u([P("esri.views.3d.terrain.ExtentHelperLocal")],Tj);var Ht;(function(e){e[e.ELEVATION=0]="ELEVATION",e[e.MAP=1]="MAP"})(Ht||(Ht={}));const g1=[Ht.ELEVATION,Ht.MAP];function hxe(){var t;const e=(t=globalThis.require)==null?void 0:t.modules;if(e){const i=Object.keys(e);for(const r of i)r.search(".glsl")!==-1&&delete e[r]}}const Xlt=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let _y,ja=class extends Ee{constructor(e){super(e),this._handles=new qt,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=he("esri-mobile")?2048:4096,this._animationTimeLast=0}get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||zi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return _(this._spatialReference)&&this._spatialReference.isGeographic&&!this.view.state.isLocal?vi(this._spatialReference).metersPerDegree:1}get view(){return this.surface.view}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}initialize(){const e=this.view;this.renderer=new ud({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference}),this._groundIntersector=Mh(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{this.setDrawTexturesDirty(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",t=>{var i;return(i=e._stage)==null?void 0:i.renderView.setRenderParameters({hasOverlayWater:t})}),this.renderer.events.on("renders-occluded",()=>{this.setDrawTexturesDirty(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",()=>this.setDrawTexturesDirty()),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),ae(()=>{var t,i,r;return[(t=e.pointsOfInterest)==null?void 0:t.renderPointOfView,(r=(i=e.pointsOfInterest)==null?void 0:i.centerOnSurfaceFrequent)==null?void 0:r.location]},()=>this.setPlacementDirty()),ae(()=>{var t;return(t=e.state)==null?void 0:t.pixelRatio},()=>this.setPlacementDirty(),rr),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),Eb({preRender:t=>{this._contentUpdated=!1,this.renderer.processSyncDrapeSources(),this.renderer.hasOverlays&&(this._dispatchAnimationUpdate(t),this._drawOverlayTextures(this.renderer.overlays,Rs.UPDATE)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}}),e.resourceController.scheduler.registerTask(mt.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",t=>{this._updateOverlays(t,Rs.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,Rs.BACKGROUND,t)})])}destroy(){this.renderer.dispose(),this._handles&&(this._handles.destroy(),this._handles=null),_(_y)&&(_y.hide(),_y=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const t=this.view.renderSpatialReference;_(e)&&_(t)?(this._renderSR=t,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new dv(-20037508342787e-6,20037508342787e-6):new dv(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,t,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const r=this.renderer.createDrapeSourceRenderer(e,t,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),r}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,qp)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&_(e.setDrapingExtent)&&_(this._spatialReference)&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){var e;(e=this.view._stage)==null||e.renderView.setRenderParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(){this._updateOverlays(this.view.state.camera,Rs.UPDATE)}_updateOverlays(e,t){if(!this._spatialReference)return;const i=aKe(e.fullWidth,e.fullHeight,this._maxResolution);this._computeOverlayExtents(e,i,nm);const r=Wc(nm.inner)/Wc(nm.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this._updateOverlay(Pr.INNER,nm.inner,i,1*nm.pixelRatioAdjustment,nm.mapUnitsPerPixel),n=this._updateOverlay(Pr.OUTER,nm.outer,i,r*nm.pixelRatioAdjustment,nm.mapUnitsPerPixel);s!==Xp.EXTENT&&n!==Xp.EXTENT||(this._drapeSources.forEach(o=>this._updateDrapeSourceExtent(o)),this.surface.updateTileOverlayParams(t)),s===Xp.NONE&&n===Xp.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1}_updateOverlay(e,t,i,r,s){if(this.renderer.overlays.length===0)return Xp.NONE;const n=this.renderer.overlays[e],o=n.mapUnitsPerPixel;if(n.mapUnitsPerPixel=s,n.pixelRatio=r,Ylt(t,n.extent)&&i===n.resolution)return o===s?Xp.NONE:Xp.RERENDER_ONLY;vg(n.extent,t),n.resolution=i;const a=nq(n.extent);return n.renderLocalOrigin=ER(a[0],a[1],0,"OV_"+this._latestOriginId++),Xp.EXTENT}setTileParameters(e){const t=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Pr.INNER],r=this.renderer.overlays[Pr.OUTER],s=H$(e.extent,this.surface.extent,voe);this._rectInsideRect(i.extent,s)||this._rectanglesOverlap(s,i.extent)||this._rectanglesOverlap(s,r.extent)?(this._setTileOverlayData(s,Pr.INNER,t),this._setTileOverlayData(s,Pr.OUTER,t)):(this._clearTileOverlayData(Pr.INNER,t),this._clearTileOverlayData(Pr.OUTER,t))}else this._clearTileOverlayData(Pr.INNER,t),this._clearTileOverlayData(Pr.OUTER,t)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const t=this.renderer.overlays[Pr.INNER],i=this.renderer.overlays[Pr.OUTER],r=this._pointIsInExtent(e,t.extent)?t:i;return(r.extent[2]-r.extent[0])/r.resolution}_setTileOverlayData(e,t,i){if(this.renderer.overlays.length===0)return;const r=this.renderer.overlays[t].extent,s=Wc(r),n=Yd(r);let o=e[0];if(this._longitudeCyclical){o=this._longitudeCyclical.minimalMonotonic(r[0],o);const a=this._longitudeCyclical.minimalMonotonic(r[0],e[2]);o>a&&(o=a-(e[2]-e[0]))}i.setScale(t,Wc(e)/s,Yd(e)/n),i.setOffset(t,(o-r[0])/s,(e[1]-r[1])/n)}_clearTileOverlayData(e,t){t.setScale(e,-1,-1),t.setOffset(e,-1,-1)}async reloadShaders(){hxe(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask()}_dispatchAnimationUpdate(e){const t=e.time-this._animationTimeLast;(t>=this.surface.view._stage.renderView.animationTimestep||_(this.forcedAnimationTime)||this._drawTexturesDirty||this._drawTexturesAnimateDirty)&&(this.renderer.updateAnimation({dt:t,forcedTime:this.forcedAnimationTime,camera:this.view.state.camera})&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e.time)}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0):this.setPlacementDirty()}_intersectGroundFromView(e,t,i,r){const s=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,Qlt,t,i);if(R(s))return!1;const n=s.origin,o=de(QI,s.origin,s.direction);return this._groundIntersector.reset(n,o,e),this._groundIntersector.intersect([],null),this.view.basemapTerrain.intersect(this._groundIntersector,null,n,o),this._groundIntersector.results.min.getIntersectionPoint(r)}_findHorizonBasedPointOfInterest(e,t){let i=.5;const r=.55,s=this.view.renderCoordsHelper.getAltitude(e.eye),n=this.view.pointsOfInterest.centerOnSurfaceFrequent,o=1e-5,a=$e(n.estimatedSurfaceAltitude,e.aboveGround?-1/0:s+o,e.aboveGround?s-o:1/0),l=e.aboveGround;if(this.view.viewingMode==="global"){const c=QI;q2(O4(P4,vi(this.view.spatialReference).radius+a),mu(e.eye,e.viewForward),c),pe(c,c,e.eye);const h=pv.normalize(dPe(e.viewForward,c,e.viewRight))/e.fovY+.5,p=h<=0||h>=1?.5:r;i=l?p*h:h+p*(1-h)}else{const c=.5*Math.PI-Math.acos(-e.viewForward[2]),h=Math.tan(c),p=fi(0,h,1,0),f=Qc(p,p,e.projectionMatrix)[1],m=$e(.5+.5*f,0,1);i=m===1||m===0?.5:l?m*r:1-(1-m)*r}return!!this._intersectGroundFromView(e,.5,i,t)&&pH(t,e.eye)<n.distance*n.distance}_computeOverlayExtents(e,t,i){const r=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s=O();this._findHorizonBasedPointOfInterest(e,s)||se(s,r);const n=Math.max(.1,nr(e.eye,s)),o=Ev(this.view.renderCoordsHelper,r,e.eye),a=Math.PI/2-Math.abs(o-Math.PI/2);zi.OVERLAY_SHOW_CENTER?(R(_y)&&(_y=new n0(this.view.graphics,"red")),_y.show(s,this._renderSR)):_(_y)&&_y.hide(),this._overlaySREqualsRenderSR||Js(s,this._renderSR,s,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&_(this._spatialReference)&&this._spatialReference.isGeographic,h=c&&_(this._spatialReference)?1/vi(this._spatialReference).metersPerDegree:1,p=e.perRenderPixelRatio*n*h;i.mapUnitsPerPixel=p/this._worldToPCSRatio;let f=t*p/2,m=!1,y=c?90:1/0;this._isSpherical&&_(l)&&_(this._spatialReference)&&(this._spatialReference.isWebMercator?(f/=Math.cos(KL(s[1])),y=l[3]):(m=!0,f/=vi(this._spatialReference).metersPerDegree,y=90),f>=y&&(f=y,s[1]=0,this._spatialReference.isWebMercator&&(s[0]=0)));let v=1;m&&(v=1/Math.max(.2,Math.cos(Math.abs($t(s[1])))),f*v>180&&(v=180/f),i.mapUnitsPerPixel*=v);const w=Math.log(2)/12;f=Math.exp(Math.round(Math.log(f)/w)*w);const b=f*v,S=32,T=.5*t/(S*b),E=.5*t/(S*f);s[0]=Math.round(s[0]*T)/T,s[1]=Math.round(s[1]*E)/E;const C=i.inner;C[0]=s[0]-b,C[1]=s[1]-f,C[2]=s[0]+b,C[3]=s[1]+f,this._isSpherical&&this._shiftExtentToFitBounds(C,1/0,y);const M=i.outer;if(6*b>Wc(l))vg(M,l);else if(a<=.25*Math.PI)M[0]=C[0]-b,M[1]=C[1]-f,M[2]=C[2]+b,M[3]=C[3]+f;else{Js(e.eye,this._renderSR,QI,this._spatialReference),rf(R_,s,QI);let N=-Math.atan2(R_[1],R_[0])+.125*Math.PI;N<0&&(N+=2*Math.PI);const D=Math.floor(N/(.25*Math.PI));hO(R_,Xlt[D],2*f),R_[0]*=v,R_[2]*=v,mH(M,C,R_)}if(this._isSpherical)M[0]=this._longitudeCyclical.clamp(M[0]),M[2]=this._longitudeCyclical.clamp(M[2]),M[1]=Math.max(M[1],-y),M[3]=Math.min(M[3],y);else{const N=H$(C,l,voe),D=H$(M,l,Zlt);LQ(N,D)&&(M[2]=M[0],M[3]=M[1])}const I=Math.abs(C[2]-C[0])/t;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,I),i.pixelRatioAdjustment=i.mapUnitsPerPixel/I}_drawOverlayTextures(e,t,i=this.view.state.camera){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const r=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const s=this._drawOverlay(e[Pr.INNER],i),n=this._drawOverlay(e[Pr.OUTER],i);s!==c2.CHANGED&&n!==c2.CHANGED||this.surface.updateTileOverlayParams(Rs.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),r?(this.surface.requestRender(t),t===Rs.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Rs.BACKGROUND)}_drawOverlay(e,t){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,t.pixelRatio)}_collectUnusedRenderTargetMemory(){if(this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays){const e=performance.now();this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory(e)}}_rectanglesOverlap(e,t){return!R(e)&&(this._longitudeCyclical?(this._longitudeCyclical.contains(t[0],t[2],e[0])||this._longitudeCyclical.contains(t[0],t[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],t[0]))&&!(e[1]>t[3]||e[3]<t[1]):TO(e,t))}_rectInsideRect(e,t){return!R(t)&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],t[0])&&this._longitudeCyclical.contains(e[0],e[2],t[2])&&t[1]>e[1]&&t[3]<e[3]:LQ(e,t))}_pointIsInExtent(e,t){if(this._longitudeCyclical)return this._longitudeCyclical.contains(t[0],t[2],e.x)&&e.y>=t[1]&&e.y<=t[3];const i=e.x,r=e.y;return i>t[0]&&i<t[2]&&r>t[1]&&r<t[3]}_shiftExtentToFitBounds(e,t,i){let r=0,s=0;e[0]<-t?r=e[0]+t:e[2]>t&&(r=t-e[2]),e[1]<-i?s=e[1]+i:e[3]>i&&(s=i-e[3]),rN(e,r,s)}get test(){return{renderer:this.renderer,update:()=>this.runTask()}}};function Ylt(e,t){const r=zi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(e[2]-e[0],e[3]-e[1],t[2]-t[0],t[3]-t[1]);return Math.abs(t[0]-e[0])<=r&&Math.abs(t[1]-e[1])<=r&&Math.abs(t[2]-e[2])<=r&&Math.abs(t[3]-e[3])<=r}u([d()],ja.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],ja.prototype,"running",null),u([d()],ja.prototype,"_placementDirty",void 0),u([d()],ja.prototype,"_contentUpdated",void 0),u([d()],ja.prototype,"_isSpherical",null),u([d()],ja.prototype,"_worldToPCSRatio",null),u([d()],ja.prototype,"renderer",void 0),u([d({constructOnly:!0})],ja.prototype,"surface",void 0),u([d({readOnly:!0,aliasOf:"surface.suspended"})],ja.prototype,"suspended",void 0),u([d({readOnly:!0})],ja.prototype,"updating",null),u([d({type:Boolean})],ja.prototype,"hasHighlights",null),u([d({type:Boolean})],ja.prototype,"rendersOccluded",null),ja=u([P("esri.views.3d.terrain.OverlayManager")],ja);const R_=Gt(),QI=O(),nm={inner:Dt(),outer:Dt(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},voe=Dt(),Zlt=Dt(),Qlt=Yn();var Xp;(function(e){e[e.NONE=0]="NONE",e[e.EXTENT=1]="EXTENT",e[e.RERENDER_ONLY=2]="RERENDER_ONLY"})(Xp||(Xp={}));class rO{constructor(t,i){this._factoryCallback=t,this._lengthCallback=i,this._pool=new Map}acquire(t){if(!rO.test.disabled){const i=this._pool.get(t);if(i&&i.length!==0)return i.pop()}try{return this._factoryCallback(t)}catch(i){const r=window.performance&&window.performance.memory;let s="";throw r&&(s=`
  totalJSHeapSize: ${r.totalJSHeapSize}, usedJSHeapSize: ${r.usedJSHeapSize}, jsHeapSizeLimit: ${r.jsHeapSizeLimit}`),console.log("Array allocation of size "+t+" failed: "+i+s),i}}release(t){if(rO.test.disabled)return;const i=this._lengthCallback(t);let r=this._pool.get(i);r||(r=new Bt({shrink:!0}),this._pool.set(i,r)),r.push(t)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}}rO.test={disabled:!1};class Jlt{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=cr(),this.indexCount=0,this.numVerticesPerSide=0,this.uvOffsetAndScale=Gt(),this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}}class _oe{constructor(t,i,r,s,n){this._buf=t,this._localOrigin=i,this.offset0=r,this.stride=s,this.count=n}getVertexOffset(t){return 0<=t&&t<this.count,this.offset0+this.stride*t}getVertex(t,i){const r=this.getVertexOffset(i)*Qu;t[0]=this._buf[r+0]+this._localOrigin[0],t[1]=this._buf[r+1]+this._localOrigin[1],t[2]=this._buf[r+2]+this._localOrigin[2]}getVertexZ(t){const i=this.getVertexOffset(t)*Qu;return this._buf[i+2]+this._localOrigin[2]}setVertex(t,i,r,s){const n=this.getVertexOffset(t)*Qu;this._buf[n+0]=i[0]-this._localOrigin[0],this._buf[n+1]=i[1]-this._localOrigin[1],this._buf[n+2]=i[2]-this._localOrigin[2],this._buf[n+3]=r,this._buf[n+4]=s}getNormal(t,i){const r=this.getVertexOffset(i)*Qu;t[0]=this._buf[r+5],t[1]=this._buf[r+6],t[2]=this._buf[r+7]}setVertexRawXYZUV(t,i,r,s,n,o){const a=this.getVertexOffset(t)*Qu;this._buf[a+0]=i,this._buf[a+1]=r,this._buf[a+2]=s,this._buf[a+3]=n,this._buf[a+4]=o}setVertexRawXYZUVN(t,i,r,s,n,o,a,l,c){const h=this.getVertexOffset(t)*Qu;this._buf[h+0]=i,this._buf[h+1]=r,this._buf[h+2]=s,this._buf[h+3]=n,this._buf[h+4]=o,this._buf[h+5]=a,this._buf[h+6]=l,this._buf[h+7]=c}setVertexRawNormal(t,i,r,s){const n=this.getVertexOffset(t)*Qu;this._buf[n+5]=i,this._buf[n+6]=r,this._buf[n+7]=s}getVertexRawNormal(t,i){const r=this.getVertexOffset(i)*Qu;t[0]=this._buf[r+5],t[1]=this._buf[r+6],t[2]=this._buf[r+7]}}const Klt=Kr().vec3f(A.POSITION).vec2f(A.UV0).vec3f(A.NORMAL),wZ=new rO(e=>Klt.createBuffer(e),e=>e.count);function ect(){wZ.clear()}function dxe(e){return wZ.acquire(e)}function tct(e){wZ.release(e.vertexAttributes),e.vertexAttributes=null,e.indices=null}class ict{constructor(){this.sinLonLUT=new Array(l7+1),this.cosLonLUT=new Array(l7+1)}update(t,i){const r=i[0],s=i[2];for(let n=0;n<=t;n++){const o=n/t,a=r*(1-o)+s*o;this.sinLonLUT[n]=Math.sin(a),this.cosLonLUT[n]=Math.cos(a)}}}class JI{constructor(){this.elevation=0,this.normal=[0,0,1],this.cornerTiles=[null,null,null,null]}}class rct{constructor(){this.edgeNeighbours=[null,null,null,null],this.cornerNeighborData=[new JI,new JI,new JI,new JI],this.edgeResolutions=[1,1,1,1],this.modifiedEdgeResolutions=[!1,!1,!1,!1]}}class sct{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.samplerDataVersion=0,this.neighborData=new rct}}class pS{constructor(t){this._getFadeDuration=t,this._fadeStart=0,this._delayedTime=0}clear(){this._current=ot(this._current),this._next=ot(this._next),this._waiting=ot(this._waiting),this._delayed=ot(this._delayed)}get current(){if(R(this._current))return null;if(!this._isFadingEnabled){const i=this._delayed||this._waiting||this._next||this._current;i!==this._current&&(this._current=null,this.clear(),this._current=i)}let t=pS.test.fadeMoment;if(_(this._delayed)&&(t=t||performance.now(),t>=this._delayedTime&&(this._push(this._delayed,dg.Immediate),this._delayed=null)),_(this._next)){t=t||performance.now();const i=this._fadeDuration,r=_(this._current)&&this._next.texture===this._current.texture,s=this._next.type!==An.FADING,n=t-this._fadeStart>=i;(r||s||n)&&(ot(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(t))}return this._current}get next(){return this._next}get fadeFactor(){if(R(this._next))return 1;const t=pS.test.fadeMoment||performance.now(),i=Math.max(0,t-this._fadeStart),r=this._fadeDuration;return i>r?0:1-i/r}get isFading(){return _(this._next)||_(this._delayed)}push(t,i=dg.Immediate){this._delayed=ot(this._delayed),this._push(t,i)}_push(t,i){if(this._isFadingEnabled||this.clear(),R(this._current))return void(this._current=t);const r=pS.test.fadeMoment||performance.now();return i!==dg.Immediate?(this._delayed=t,void(this._delayedTime=r+i)):R(this._next)?(this._next=t,void(this._fadeStart=this._alignFadeStart(r))):void(R(t)||(ot(this._waiting),this._waiting=t))}get _fadeDuration(){return R(this._waiting)?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(t){const i=this._getFadeDuration();return t+i-t%i}get _isFadingEnabled(){return this._getFadeDuration()>0}}var dg;pS.test={fadeMoment:0},function(e){e[e.Immediate=0]="Immediate",e[e.Delayed=5e3]="Delayed"}(dg||(dg={}));class pxe{constructor(){this._queue=new Bt,this._last=null,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(t){this._queue.clear(),this._queue.push(t),this._last=null}reset(t=null){this._queue.clear(),_(t)&&this._queue.pushArray(t),this._last=null}skipSubtree(){this._last=null}next(){return this._last&&!this._last.isLeaf&&this._queue.pushArray(this._last.children),this._last=this._queue.pop(),this._last}}class nct{constructor(){this.q=new Bt}get done(){return this.q.length===0}reset(t){if(this.q.clear(),!R(t)){this.q.pushArray(t);for(let i=0;i<this.q.length;++i){const r=this.q.data[i];r.isLeaf||this.q.pushArray(r.children)}}}next(){return this.q.pop()}}function $R(e,t,i){if(R(t)||R(t.fullExtent))return!1;const r=t.fullExtent,s=e.extent;if(i){if(s[0]<r.xmin||s[1]<r.ymin||s[2]>r.xmax||s[3]>r.ymax)return!1}else if(r.xmin>s[2]||r.ymin>s[3]||r.xmax<s[0]||r.ymax<s[1])return!1;const n=e.surface.tilingScheme.levels[e.level].scale;return!(t.minScale>0&&n>1.00000001*t.minScale)&&!(t.maxScale>0&&n<.99999999*t.maxScale)}function fxe(e,t){return e.lij[0]-t.lij[0]||e.lij[1]-t.lij[1]||e.lij[2]-t.lij[2]}function mxe(e,t){t.sort((i,r)=>gxe(i,r,e))}function gxe(e,t,i){const r=e.screenDepth,s=t.screenDepth;return r<s?-i:r>s?i:fxe(e,t)}function oct(e,t){const i=new Map;e.forAll(r=>i.set(r.lij,r.distanceToSquared(t))),e.sort((r,s)=>i.get(r.lij)-i.get(s.lij)||fxe(r,s))}function act(e,t,i){let r=1,s=0,n=0;for(;e!==t;)if(r*=.5,s*=.5,n*=.5,1&e.lij[2]&&(s+=.5),(1&e.lij[1])==0&&(n+=.5),(e=e.parent)==null)throw new Error("tile was not a descendant of upsampleTile");i.init(t,s,n,r)}function lct(e){for(let t=0;t<e.length;t++){const i=e[t],r=i.parent;if(r)for(let s=0;s<4;s++){const n=r.children[s];if(n&&n!==i&&n.loadable)return!0}}return!1}function D1t(e,t){if(!e||!t||e[0]===t[0])return!1;const i=e[0]<t[0],r=i?e:t,s=i?t:e,n=1<<s[0]-r[0];return Math.floor(s[1]/n)===r[1]&&Math.floor(s[2]/n)===r[2]}class xZ{get updating(){return!!this._tileRequested}init(t,i,r,s){this.tile=t,this._layerIdx=i,this._layerClass=r,this._suspended=s,this._tileLayerInfo=t.getLayerInfo(i,r),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(t){t!==this._suspended&&(this._suspended=t,t?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const t=this._findAncestorWithData();return this._setUpsampleTile(t),this._requestNext()}dataArrived(t){this._setUpsampleTile(t),this._tileRequested=null,t===this.tile?this.tile.updateRenderData(this._layerClass,An.FADING):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const t=this._findNextDownload();if(this._tileRequested){if(t===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return _(t)?t.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=t):this._agentDone(),!!this._tileRequested}_findNextDownload(){const t=this._layerIdx,i=this._layerClass,r=this.tile.surface.layerViewByIndex(t,i),s=_j(r),{minLevel:n,maxLevel:o}=r.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?$R:()=>!0;let h=this.tile;const p=h.level;let f;const m=this._tileLayerInfo.upsampleInfo,y=_(m)?m.tile.level:-1,v=!!_(m)&&y-p>=a,w=Yr(s,"tilemapCache");for(;h&&c(h,s,!1)&&h.level>=n;){const b=h.level,S=p-b,T=h.layerInfo[i][t];if(T.data&&S>=a){(!v||b>y)&&this._setUpsampleTile(h),T.dataInvalidated&&(f=h);break}if((R(w)||w.getAvailability(h.lij[0],h.lij[1],h.lij[2])!=="unavailable")&&b<=o&&!T.data&&!T.dataMissing&&((R(f)||h.level===n||b%a0e==0||p-f.level<a)&&(f=h),S>=l))break;h=h.parent}return _(f)&&p-f.level<a&&this._tileLayerInfo.upsampleInfo&&(f=null),f}_findAncestorWithData(){const t=this.tile.vlevel,i=this._desiredMinLevelDelta;let r;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(t-s.level>=i)return s;r=s}return r}_setUpsampleTile(t){this._tileLayerInfo.setUpsampleInfo(this.tile,t),this.tile.updateRenderData(this._layerClass,An.FADING)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}}class cct extends xZ{get _desiredMinLevelDelta(){throw boe}get _progressiveLevelModulo(){throw boe}dispose(){}}const boe=new Error("Abstract method called on TileAgent"),wl=new cct;class yxe extends xZ{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return ID(this.tile.level)-(this.tile.vlevel-this.tile.level)}get _progressiveLevelModulo(){return 0}}class vxe extends xZ{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return a0e}}var xb,nw;(function(e){e[e.Stretch=0]="Stretch",e[e.Lut=1]="Lut",e[e.Hillshade=2]="Hillshade",e[e.COUNT=3]="COUNT"})(xb||(xb={})),function(e){e[e.Noop=0]="Noop",e[e.PerBand=1]="PerBand",e[e.COUNT=2]="COUNT"}(nw||(nw={}));var woe,De;(function(e){e[e.OneMinusSourceAlpha=0]="OneMinusSourceAlpha",e[e.SourceAlpha=1]="SourceAlpha",e[e.COUNT=2]="COUNT"})(woe||(woe={})),function(e){e[e.Normal=0]="Normal",e[e.Average=1]="Average",e[e.Lighten=2]="Lighten",e[e.Lighter=3]="Lighter",e[e.Plus=4]="Plus",e[e.Screen=5]="Screen",e[e.ColorDodge=6]="ColorDodge",e[e.Darken=7]="Darken",e[e.Multiply=8]="Multiply",e[e.ColorBurn=9]="ColorBurn",e[e.Overlay=10]="Overlay",e[e.SoftLight=11]="SoftLight",e[e.HardLight=12]="HardLight",e[e.VividLight=13]="VividLight",e[e.Hue=14]="Hue",e[e.Saturation=15]="Saturation",e[e.Luminosity=16]="Luminosity",e[e.Color=17]="Color",e[e.DestinationOver=18]="DestinationOver",e[e.DestinationAtop=19]="DestinationAtop",e[e.DestinationIn=20]="DestinationIn",e[e.DestinationOut=21]="DestinationOut",e[e.SourceAtop=22]="SourceAtop",e[e.SourceIn=23]="SourceIn",e[e.SourceOut=24]="SourceOut",e[e.Xor=25]="Xor",e[e.Difference=26]="Difference",e[e.Exclusion=27]="Exclusion",e[e.Minus=28]="Minus",e[e.Invert=29]="Invert",e[e.Reflect=30]="Reflect",e[e.COUNT=31]="COUNT"}(De||(De={}));const uL={normal:De.Normal,average:De.Average,lighten:De.Lighten,lighter:De.Lighter,screen:De.Screen,plus:De.Plus,"color-dodge":De.ColorDodge,darken:De.Darken,multiply:De.Multiply,"color-burn":De.ColorBurn,overlay:De.Overlay,"soft-light":De.SoftLight,"hard-light":De.HardLight,"vivid-light":De.VividLight,hue:De.Hue,saturation:De.Saturation,luminosity:De.Luminosity,color:De.Color,difference:De.Difference,exclusion:De.Exclusion,minus:De.Minus,invert:De.Invert,reflect:De.Reflect,"destination-over":De.DestinationOver,"destination-atop":De.DestinationAtop,"destination-in":De.DestinationIn,"destination-out":De.DestinationOut,"source-atop":De.SourceAtop,"source-in":De.SourceIn,"source-out":De.SourceOut,xor:De.Xor};function uct(e){return e===De.DestinationOver||e===De.DestinationAtop||e===De.DestinationIn||e===De.DestinationOut||e===De.SourceAtop||e===De.SourceIn||e===De.SourceOut||e===De.Xor}function hct(e){e.fragment.uniforms.add([new zt("u_colormap",t=>t.u_colormap),new We("u_colormapOffset",t=>t.colormap.u_colormapOffset),new We("u_colormapMaxIndex",t=>t.colormap.u_colormapMaxIndex),new We("u_opacity",t=>t.common.u_opacity)]),e.fragment.code.add(x`vec4 colormap(vec4 currentPixel, bool isFloat) {
float clrIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || clrIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 clrPosition = vec2((clrIndex + 0.5) / (u_colormapMaxIndex + 1.0), 0.0);
result = texture2D(u_colormap, clrPosition);
}
return result;
}`)}function dct(e){e.fragment.uniforms.add(new zt("u_transformGrid",t=>t.u_transformGrid)),e.fragment.uniforms.add(new di("u_transformSpacing",t=>t.common.u_transformSpacing)),e.fragment.uniforms.add(new di("u_transformGridSize",t=>t.common.u_transformGridSize)),e.fragment.uniforms.add(new di("u_targetImageSize",t=>t.common.u_targetImageSize)),e.fragment.code.add(x`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(0.25 / u_transformGridSize.s, 1.0 / u_transformGridSize.t);
vec2 index_transform = floor(index_image / u_transformSpacing) / u_transformGridSize;
vec2 pos = fract((index_image + vec2(0.5, 0.5)) / u_transformSpacing);
vec2 srcLocation;
vec2 transform_location = index_transform + oneTransformPixel * 0.5;
if (pos.s <= pos.t) {
vec4 ll_abc = texture2D(u_transformGrid, vec2(transform_location.s, transform_location.t));
vec4 ll_def = texture2D(u_transformGrid, vec2(transform_location.s + oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ll_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ll_def.rgb, vec3(pos, 1.0));
} else {
vec4 ur_abc = texture2D(u_transformGrid, vec2(transform_location.s + 2.0 * oneTransformPixel.s, transform_location.t));
vec4 ur_def = texture2D(u_transformGrid, vec2(transform_location.s + 3.0 * oneTransformPixel.s, transform_location.t));
srcLocation.s = dot(ur_abc.rgb, vec3(pos, 1.0));
srcLocation.t = dot(ur_def.rgb, vec3(pos, 1.0));
}
return srcLocation;;
}`)}class _xe extends Us{constructor(){super(...arguments),this.scale=1,this.offset=Sh}}function bxe(e){e.attributes.add(A.POSITION,"vec2"),e.attributes.add(A.UV0,"vec2"),e.vertex.uniforms.add(new We("scale",t=>t.scale)),e.vertex.uniforms.add(new di("offset",t=>t.offset)),e.varyings.add("uv","vec2"),e.varyings.add("vuv","vec2"),e.vertex.code.add(x`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}class pct extends _xe{constructor(t,i,r){super(),this.common=t,this.u_image=i,this.u_transformGrid=r}}function fct(e){e.include(dct),e.fragment.uniforms.add([new zt("u_image",t=>t.u_image),new Gb("u_flipY",t=>t.common.u_flipY),new Gb("u_applyTransform",t=>t.common.u_applyTransform)]),e.fragment.code.add(x`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}
vec4 getPixel(vec2 pixelLocation) {
return texture2D(u_image, pixelLocation);
}`)}function TZ(e){e.code.add(x`
    float lineFactorAtPosition(float value) {
      float pos = value * ${x.float(257)};
      if(pos < 0.5 || pos > ${x.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec4 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec4(vec3(1.0, 0.972, 0.918) * line, 1.0);
    }`)}var Co;(function(e){e[e.LayerOnly=0]="LayerOnly",e[e.ColorComposite=1]="ColorComposite",e[e.GridComposite=2]="GridComposite",e[e.COUNT=3]="COUNT"})(Co||(Co={}));function wxe(e,t){const i=t.blendMode;i!==De.Normal&&(i===De.Reflect&&e.code.add(x`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),i!==De.ColorDodge&&i!==De.VividLight||e.code.add(x`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),i!==De.ColorBurn&&i!==De.VividLight||e.code.add(x`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),i===De.Overlay&&e.code.add(x`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),i===De.HardLight&&e.code.add(x`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),i===De.SoftLight&&e.code.add(x`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),i===De.VividLight&&e.code.add(x`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),i!==De.Hue&&i!==De.Saturation&&i!==De.Color&&i!==De.Luminosity||(e.code.add(x`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),i!==De.Hue&&i!==De.Saturation||e.code.add(x`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),e.code.add(x`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${i===De.Multiply?x`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Average?x`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Lighten?x`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Darken?x`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Lighter?x`return vec4(cl * ol + cb * ob, ol + ob);`:i===De.Plus?x`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:i===De.Minus?x`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:i===De.Screen?x`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Difference?x`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Invert?x`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:i===De.DestinationOver?x`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:i===De.DestinationAtop?x`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:i===De.DestinationOut?x`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:i===De.SourceAtop?x`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:i===De.SourceOut?x`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:i===De.Xor?x`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:i===De.DestinationIn?x`return vec4(cb * ob * ol, ol * ob);`:i===De.SourceIn?x`return vec4(cl * ol * ob, ol * ob);`:i===De.Hue?x`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Saturation?x`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Color?x`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Luminosity?x`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Exclusion?x`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Reflect?x`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.ColorDodge?x`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.ColorBurn?x`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.Overlay?x`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.SoftLight?x`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.HardLight?x`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:i===De.VividLight?x`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:x``}
    }
  `))}var Qn,un;function mct(e){const t=new Bi,i=e.output===Qn.GridOnly,r=e.output===Qn.GridComposite,s=r||i,n=e.output===Qn.ColorOnly,o=e.output===Qn.ColorComposite,a=o||n,l=r||o;if(t.include(bxe),a&&t.fragment.uniforms.add(new xt("backgroundColor",m=>m.backgroundColor)),e.baseOpacityMode!==un.One&&t.fragment.uniforms.add(new We("baseOpacity",m=>m.baseOpacity)),s&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(TZ)),i||n)return t.fragment.code.add(x`
    void main() {
      gl_FragColor = ${n?x`vec4(backgroundColor, 1.0)`:x`gridColor(uv)`};
    }
  `),t;const c=e.blendMode!==De.Normal,h=e.baseOpacityMode===un.OnBaseLayer,p=e.baseOpacityMode===un.OnBackground||e.baseOpacityMode===un.OnBaseLayer,f=e.premultipliedSource;return t.fragment.uniforms.add(new zt("tex",m=>m.texture)),t.fragment.uniforms.add(new We("opacity",m=>m.opacity)),(c||h||f)&&(t.fragment.uniforms.add(new zt("fboColor",m=>m.fboTexture)),t.fragment.uniforms.add(new We("tileSize",m=>_(m.fboTexture)?m.fboTexture.descriptor.width:1))),t.fragment.include(wxe,e),t.fragment.code.add(x`
    void main() {
      ${l||h||f?x`
      vec4 bgColor = ${o?x`vec4(backgroundColor, 1.0)`:r?x`gridColor(uv)`:x`texture2D(fboColor, gl_FragCoord.xy / tileSize)`};
      ${p?x`bgColor *= baseOpacity;`:""}`:""}
      vec4 colorLayer = texture2D(tex, uv);
      ${c?x`
          vec4 fboTex = ${l?x`bgColor;`:x`texture2D(fboColor, gl_FragCoord.xy / tileSize) ${h?" * baseOpacity":""};`}
          vec3 Cb = fboTex.a == 0.0 ? fboTex.rgb : vec3(fboTex.rgb * fboTex.a);
          gl_FragColor = applyBlendMode(colorLayer.rgb, colorLayer.a * opacity, Cb, fboTex.a);`:x`
          vec4 pmColorLayer = vec4(colorLayer.xyz, 1.0);
          float composeAlpha = colorLayer.a * opacity;
          gl_FragColor = ${f?x`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`:l||h?x`mix(bgColor, pmColorLayer, composeAlpha);`:x`pmColorLayer * composeAlpha;`}`}
    }
  `),t}(function(e){e[e.Composite=0]="Composite",e[e.ColorOnly=1]="ColorOnly",e[e.GridOnly=2]="GridOnly",e[e.ColorComposite=3]="ColorComposite",e[e.GridComposite=4]="GridComposite",e[e.COUNT=5]="COUNT"})(Qn||(Qn={})),function(e){e[e.One=0]="One",e[e.OnBackground=1]="OnBackground",e[e.OnBaseLayer=2]="OnBaseLayer",e[e.COUNT=3]="COUNT"}(un||(un={}));const gct=Object.freeze(Object.defineProperty({__proto__:null,get BlendLayersOutput(){return Qn},get BaseOpacityMode(){return un},build:mct},Symbol.toStringTag,{value:"Module"}));class bU extends pct{constructor(t,i,r,s,n,o){super(t,s,n),this.colormap=i,this.symbolizer=r,this.u_colormap=o,this.backgroundColor=Ta,this.fboTexture=null,this.baseOpacity=1}}class yct extends bU{}class vct extends bU{}function _ct(e){const t=new Bi;t.include(bxe),t.include(fct),t.include(hct),e.tileBlendInput===Co.GridComposite&&(t.extensions.add("GL_OES_standard_derivatives"),t.fragment.include(TZ));const i=e.tileBlendInput===Co.ColorComposite;i&&t.fragment.uniforms.add(new xt("backgroundColor",a=>a.backgroundColor)),e.baseOpacityMode!==un.One&&t.fragment.uniforms.add(new We("baseOpacity",a=>a.baseOpacity));const r=e.baseOpacityMode===un.OnBaseLayer,s=e.baseOpacityMode===un.OnBackground||e.baseOpacityMode===un.OnBaseLayer,n=e.blendMode!==De.Normal;t.fragment.include(wxe,e);const o=e.tileBlendInput!==Co.LayerOnly;return(n&&!o||r)&&(t.fragment.uniforms.add(new zt("fboColor",a=>a.fboTexture)),t.fragment.uniforms.add(new We("tileSize",a=>_(a.fboTexture)?a.fboTexture.descriptor.width:1))),t.fragment.code.add(x`
    vec4 applyBackgroundBlend(vec4 layerColor) {
      ${o||r?x`
          vec4 bgColor = ${r?x`texture2D(fboColor, gl_FragCoord.xy / tileSize)`:i?x`vec4(backgroundColor, 1.0)`:x`gridColor(vuv)`};
          ${s?x`bgColor *= baseOpacity;`:""}`:""}
      ${n?x`
            vec3 pmColorLayer = layerColor.rgb * layerColor.a;
            vec4 fboTex = ${o?x`bgColor;`:x`texture2D(fboColor, gl_FragCoord.xy / tileSize) ${r?" * baseOpacity":""};`}
            vec3 Cb = fboTex.a == 0.0 ? fboTex.rgb : vec3(fboTex.rgb * fboTex.a);
            return applyBlendMode(pmColorLayer.rgb, layerColor.a * u_opacity, Cb, fboTex.a);`:o||r?x`
            float composeAlpha = layerColor.a * u_opacity;
            vec4 pmColorLayer = vec4(layerColor.rgb, 1.0);
            return mix(bgColor, pmColorLayer, composeAlpha);`:x`
            return layerColor * layerColor.a * u_opacity;`}
    }
  `),e.colorizerType===xb.Stretch?wct(t,e):e.colorizerType===xb.Lut?bct(t):e.colorizerType===xb.Hillshade&&xct(t,e),t}function bct(e){e.fragment.code.add(x`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
gl_FragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function wct(e,t){e.fragment.uniforms.add([new n3("u_bandCount",r=>r.symbolizer.u_bandCount),new jo("u_minCutOff",r=>r.symbolizer.u_minCutOff,3),new jo("u_maxCutOff",r=>r.symbolizer.u_maxCutOff,3),new jo("u_factor",r=>r.symbolizer.u_factor,3),new We("u_minOutput",r=>r.symbolizer.u_minOutput),new We("u_maxOutput",r=>r.symbolizer.u_maxOutput),new Gb("u_useGamma",r=>r.symbolizer.u_useGamma),new jo("u_gamma",r=>r.symbolizer.u_gamma,3),new jo("u_gammaCorrection",r=>r.symbolizer.u_gammaCorrection,3),new We("u_opacity",r=>r.common.u_opacity)]),e.fragment.code.add(x`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const i=t.applyColormap?x`gl_FragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:x`gl_FragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;e.fragment.code.add(x`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${t.stretchType===nw.Noop?x`
        gl_FragColor = applyBackgroundBlend(currentPixel);`:x`
        if (currentPixel.a == 0.0) {
          gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${i}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          gl_FragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function xct(e,t){const i=e.fragment;i.uniforms.add([new zt("u_image",s=>s.u_image),new n3("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new jo("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new jo("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new jo("u_cosZs",s=>s.symbolizer.u_cosZs,6),new jo("u_weights",s=>s.symbolizer.u_weights,6),new di("u_factor",s=>s.symbolizer.u_factor),new We("u_minValue",s=>s.symbolizer.u_minValue),new We("u_maxValue",s=>s.symbolizer.u_maxValue),new di("u_srcImageSize",s=>s.common.u_srcImageSize)]),i.include(Vf),i.code.add(x`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec3 hsv = rgb2hsv(colormap(vec4(val, val, val, 1.0), false).rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv) * alpha, alpha);
}`),i.code.add(x`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const r=t.applyColormap?x`gl_FragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:x`hillshade *= alpha;
gl_FragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;i.code.add(x`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        gl_FragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture2D(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture2D(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture2D(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture2D(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture2D(u_image, pixelLocation);
      vec4 vf = texture2D(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture2D(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture2D(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture2D(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${r}
    }
  `)}const Tct=Object.freeze(Object.defineProperty({__proto__:null,ColorizerUniforms:bU,ColorizerStretchUniforms:yct,ColorizerHillshadeUniforms:vct,build:_ct},Symbol.toStringTag,{value:"Module"}));function Sct(e,t,i="nearest",r=!1){var c;const s=!(r&&t.pixelType==="u8"),n=s?St.FLOAT:St.UNSIGNED_BYTE,o=t.pixels==null||t.pixels.length===0?null:s?t.getAsRGBAFloat():t.getAsRGBA(),a=(c=e.capabilities.textureFloat)==null?void 0:c.textureFloatLinear,l={width:t.width,height:t.height,target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:e.type===ai.WEBGL2&&s?ft.RGBA32F:ze.RGBA,samplingMode:!a||i!=="bilinear"&&i!=="cubic"?Ke.NEAREST:Ke.LINEAR,dataType:n,wrapMode:_t.CLAMP_TO_EDGE,flipped:!1};return new st(e,l,o)}function Ect(e,t){const{spacing:i,offsets:r,coefficients:s,size:[n,o]}=t,a=i[0]>1,l={width:a?4*n:n,height:o,target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:e.type===ai.WEBGL2?ft.RGBA32F:ze.RGBA,dataType:St.FLOAT,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,flipped:!1},c=new Float32Array(a?n*o*16:2*r.length);if(a)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),m=2*(p*o+h);c[f]=r[m],c[f+1]=r[m+1],c[f+3]=r[m]===-1?0:1}return new st(e,l,c)}function xoe(e,t){const i={width:t.length/4,height:1,target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,flipped:!1};return new st(e,i,t)}function Cct(e,t,i,r=1,s=!0){return{u_flipY:s,u_applyTransform:!!e,u_opacity:r,u_transformSpacing:e?e.spacing:Sh,u_transformGridSize:e?e.size:Sh,u_targetImageSize:t,u_srcImageSize:i}}function Act(e,t){return{u_colormapOffset:t||0,u_colormapMaxIndex:e?e.length/4-1:0}}function Rct(e){return{u_bandCount:e.bandCount,u_minOutput:e.outMin,u_maxOutput:e.outMax,u_minCutOff:e.minCutOff,u_maxCutOff:e.maxCutOff,u_factor:e.factor,u_useGamma:e.useGamma,u_gamma:e.gamma,u_gammaCorrection:e.gammaCorrection}}function Mct(e){return{u_hillshadeType:e.hillshadeType,u_sinZcosAs:e.sinZcosAs,u_sinZsinAs:e.sinZsinAs,u_cosZs:e.cosZs,u_weights:e.weights,u_factor:e.factor,u_minValue:e.minValue,u_maxValue:e.maxValue}}const Toe={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};class Oct{constructor(t,i,r=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=t,this.source=i,this.width=r||i.width,this.height=s||i.height}get source(){return this._source}set source(t){this._source=t,this._rasterTexture=Ye(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?ve(F({},Toe),{maxCutOff:[1,1,1],factor:[1,1,1]}):this._symbolizerParameters||Toe}set symbolizerParameters(t){this._symbolizerParameters=t}get bandIds(){return this._bandIds}set bandIds(t){_(t)&&t.length>0?this._bandIds&&t.every((i,r)=>!!this._bandIds[r]&&i===this._bandIds[r])||(this._bandIds=t,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(t){if(this._interpolation=t,_(this._rasterTexture)){const i=this._getRasterTextureInterpolation(t);this._rasterTexture.setSamplingMode(i==="bilinear"?Ke.LINEAR:Ke.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(t){this._transformGrid=t,this._transformGridTexture=Ye(this._transformGridTexture),this._memoryUsed=null}bind(t){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((R(this._rasterTexture)||this._dirty)&&this._updateRasterTexture(t,this.bandIds),_(this._rasterTexture)&&(this._updateColormapTexture(t),this.transformGrid&&R(this._transformGridTexture)&&(this._transformGridTexture=Ect(t,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:t,transformGrid:i,width:r,height:s,opacity:n}=this,o=Cct(i,[r,s],[this.source.width,this.source.height],n),a=Act(t.colormap,t.colormapOffset),l=this.symbolizerParameters.type==="stretch"?Rct(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?Mct(this.symbolizerParameters):null;return new bU(o,a,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get memoryUsage(){if(R(this._memoryUsed)){const t=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=t.map(i=>_(i)?i.descriptor.width*i.descriptor.height*4:0).reduce((i,r)=>i+r,0)}return this._memoryUsed}release(){return this._rasterTexture=Ye(this._rasterTexture),this._transformGridTexture=Ye(this._transformGridTexture),this._colormapTexture=Ye(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(t,i){const r=this.source?this.source.extractBands(i):null;if(!(r&&r.pixels&&r.pixels.length>0))return void(this._rasterTexture=Ye(this._rasterTexture));const s=R(i)&&R(this.bandIds)||_(i)&&_(this.bandIds)&&i.join("")===this.bandIds.join("");if(_(this._rasterTexture)&&s)return;this._rasterTexture=Ye(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=Sct(t,r,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(t){return this.symbolizerParameters.type==="lut"||t==="nearest"||t==="majority"?"nearest":"bilinear"}_updateColormapTexture(t){const i=this._colormap,r=this.symbolizerParameters.colormap;return r?i?r.length!==i.length||r.some((s,n)=>s!==i[n])?(this._colormapTexture=Ye(this._colormapTexture),this._colormapTexture=xoe(t,r),void(this._colormap=r)):void 0:(this._colormapTexture=xoe(t,r),void(this._colormap=r)):(this._colormapTexture=Ye(this._colormapTexture),void(this._colormap=null))}}class hL{constructor(){this.waitingAgents=new Bt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(t){const i=dV.acquire();return i._init(t),i}release(){this.dispose(),dL.delete(this),dV.release(this)}dispose(){this.loadingAgent=Ye(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=dS(this._data)}static prune(){dV.prune(0)}_init(t){this.waitingAgents.clear(),this._data=dS(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=t,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=xh(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){_(this._upsampleInfo)&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(t,i){if(t===i||R(i))this._unsetUpsampleInfo();else{if(R(this._upsampleInfo))this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===i)return;this._upsampleInfo.tile.unrefMapData()}i.refMapData(),act(t,i,this._upsampleInfo)}}get data(){return this._data}set data(t){dS(this._data),this._data=t}}const dV=new ys(hL,null,()=>{}),dL=new Map;function Pct(){dL.size>0&&(console.log(`${dL.size} live TilePerLayerInfo allocations:`),dL.forEach(e=>console.log(e,`
`)))}class uT{constructor(t){this._texture=t,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}}var vt;(function(e){e[e.NONE=0]="NONE",e[e.NONE_HIT_MAXLOD=1]="NONE_HIT_MAXLOD",e[e.SPLIT=2]="SPLIT",e[e.VSPLITMERGE=4]="VSPLITMERGE",e[e.MERGE=8]="MERGE",e[e.RENDERDATA=16]="RENDERDATA",e[e.GEOMETRY=32]="GEOMETRY",e[e.TEXTURE_NOFADING=64]="TEXTURE_NOFADING",e[e.TEXTURE_FADING=128]="TEXTURE_FADING"})(vt||(vt={}));const pV=O(),hx=O(),$n=O(),Ict=.1;class $ct{constructor(){this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}}class SZ{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this._dirty=!0,this._previouslyRendered=!1,this.extent=Dt(),this._elevationBounds=tt(),this.layerInfo=[[],[]],this.extentInRadians=Dt(),this.centerAtSeaLevel=O(),this._center=[O(),fn(),O()],this.up=hH(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemory=0,this._mapDataRefCount=0,this._screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0}static prune(){EZ.prune(0),CZ.prune(0),hL.prune()}get isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[fa.MIDDLE][3]}get screenDepth(){return this._screenDepth}get visible(){return this._dirty&&this.computeVisibility(),this._visible}computeVisibility(){this._dirty=!1;const t=this._intersectsClippingArea&&this._isVisible(this.surface.frustum);return t!==this._visible&&(this._visible=t,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setNeedsRender(),this.updateAgentSuspension()),this._visible}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const t=!!this.renderData;return t!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=t,this._surface.renderer.setNeedsRender()),t}get shouldLoad(){if(!this.loadable)return!1;if(this._surface.lodSnapping===A2.ON){const t=this.level-this._surface.snapLevel;if(t===0)return!0;if(t===1)return!1}return this.isLeaf}init(t,i,r){this.lij[0]=t[0],this.lij[1]=t[1],this.lij[2]=t[2],this.ellipsoid=vi(r.tilingScheme.spatialReference),r.tilingScheme.getExtent(t[0],t[1],t[2],this.extent),r.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,r.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[fa.MIDDLE][3]=0,this.vlevel=t?t[0]:0,i&&i.elevationBounds?ro(this._elevationBounds,i.elevationBounds):hi(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this._screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=i,this.unsetChildren(),this._surface=r,this.updateVisibility();for(const s of g1){const n=r.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=hL.acquire(this._surface.upsampleInfoPool),s===Ht.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(r.tilingScheme.pixelSize,l7)}release(){Qp(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const t of g1){for(const i of this.layerInfo[t])i.release();this.layerInfo[t].length=0}this._parent=null,this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this.isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this.isCached){this.setMemoryDirty();const t=this.cachedMemory;t>0&&this._surface.upsampleMapCache.put(this.key,this,t)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this.isCached?0:this._mapTileMemory)}get cachedMemory(){return this.isCached?this.mapTileMemory:0}get mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[Ht.MAP].reduce((t,i)=>t+(i instanceof IR?i.memoryUsage:0),this._mapTileMemory)}get cpuImageMemorySize(){const i=this._surface.tilingScheme.pixelSize;return i*i*4}_ensureUsedMemory(){if(_(this._usedMemory))return this._usedMemory;this._usedMemory=0,this._mapTileMemory=0;let t=0;for(const{data:r}of this.layerInfo[Ht.MAP])r instanceof IR?t+=this._getTerrainDataMemory(r):this._mapTileMemory+=this._getTerrainDataMemory(r);const i=this.cpuImageMemorySize;for(const r of this.layerInfo[Ht.ELEVATION])this._usedMemory+=r.data?i:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemory+=Bb(this.renderData.textureDescriptor)),this.isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemory+t),this._usedMemory}getUsedMemoryForLayer(t,i){const r=this.layerInfo[t][i];return(r==null?void 0:r.data)?t===Ht.MAP?this.isCached?0:this._getTerrainDataMemory(r.data):t===Ht.ELEVATION?this.cpuImageMemorySize:0:0}_getTerrainDataMemory(t){return t instanceof uT?Bb(t.texture):t instanceof HTMLImageElement||t instanceof gU?this.cpuImageMemorySize:t instanceof IR||t instanceof Oct?t.memoryUsage:0}updateScreenDepth(t){const i=this._center[fa.MIDDLE],r=t,s=i[0],n=i[1],o=i[2],a=r[2]*s+r[6]*n+r[10]*o+r[14];this._screenDepth=a<0?0:a/(r[3]*s+r[7]*n+r[11]*o+r[15])}shouldSplit(t,i,r){if(_(t.frustum)&&(!this._intersectsClippingArea||!this._isVisible(t.frustum)))return vt.NONE;const s=this.level;pe(pV,this._center[fa.MIDDLE],i);let n=ba(pV),o=fa.MIDDLE;pe(hx,this._center[fa.TOP],i);const a=ba(hx);a<n&&(n=a,o=fa.TOP),pe(hx,this._center[fa.BOTTOM],i);const l=ba(hx);if(l<n&&(n=l,o=fa.BOTTOM),this._edgeLen2>n&&s<t.maxLod)return vt.SPLIT;const c=Math.sqrt(n),h=t.fovX*c*2,p=this._edgeLen/h,f=()=>{const w=s+Math.ceil(-Math.log2(t.relativeWidthLimit/p));return w!==this.vlevel?(this.vlevel=w,vt.VSPLITMERGE):vt.NONE_HIT_MAXLOD};if(r===A2.ON&&this._surface.snapLevel-s===1)return s>=t.maxLod?f():vt.SPLIT;const m=xe(this.up,pV),y=this._elevationBounds[1]-this._elevationBounds[0],v=y/this.edgeLen;if(t.aboveGround&&m>0&&v<.001&&m/c-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-v>0)return vt.NONE;if(p<t.relativeWidthLimit)return this.vlevel!==this.level?(this.vlevel=this.level,vt.VSPLITMERGE):vt.NONE;if(s>=t.maxLod)return f();if(s>6){pe(hx,this._center[o],i),oe($n,this.up,m),pe($n,$n,hx);const w=ba($n);if(w>this.radius*this.radius){oe($n,$n,this.radius/Math.sqrt(w)),de($n,$n,this._center[o]),pe($n,i,$n);const b=Math.min(1,(Math.abs(xe($n,this.up))+.5*y+this._curvatureHeight)/Me($n)),S=Ict/t.angledSplitBias,T=t.fovY*c*2;if(b*(this._edgeLen/T)<S*t.relativeHeightLimit)return vt.NONE}}return vt.SPLIT}setChildren(t,i,r,s){Qp(!!(t&&i&&r&&s),"Null child passed"),this._children[0]=t,this._children[1]=i,this._children[2]=r,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){var t,i;return(i=(t=this.renderData)==null?void 0:t.hasGeometry)!=null?i:!1}prepareToLoad(t){this.refMapData();for(const i of g1)this._createOrUpdateAgents(0,i);t.updateTileGeometryState(this)}load(t){this.prepareToLoad(t),this.loadPrepared(t)}loadPrepared(t){t.loadTile(this)}unload(t){t.unloadTile(this);for(const i of g1){const r=this.layerInfo[i];for(const s of r)s.loadingAgent&&s.loadingAgent!==wl&&(KI(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(vt.GEOMETRY),this.resetPendingUpdate(vt.TEXTURE_NOFADING),this.resetPendingUpdate(vt.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const t=this.layerInfo[Ht.MAP];for(const i of t)i.loadingAgent&&i.loadingAgent!==wl&&(KI(i.loadingAgent),i.loadingAgent=null),i.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(t){if(ub(t,this._clippingArea))return!1;const i=this._intersectsClippingArea,r=this._isWithinClippingArea;_(t)?(this._intersectsClippingArea=this.intersectsExtent(t),this._isWithinClippingArea=this._isWithinExtent(t)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=t,this.updateVisibility();const s=r&&this._isWithinClippingArea,n=!(r||i||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(vt.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(t,i){return this.layerInfo[i][t]}hasLayerData(t,i){const r=this.layerInfo[i][t];return!(!r||!r.data||r.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const t of g1){const i=this.layerInfo[t];for(const r of i)if(r.loadingAgent&&r.loadingAgent!==wl&&r.loadingAgent.updating)return!0}return!1}_isSuspended(t){return!!this.hasPendingUpdate(vt.SPLIT)||t!==Ht.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(t){return(this._pendingUpdates&t)===t}setPendingUpdate(t){this._pendingUpdates|=t,t===vt.SPLIT||t===vt.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(t){return!!this.hasPendingUpdate(t)&&(this._pendingUpdates&=~t,!0)}requestLayerData(t,i,r){const s=this.layerInfo[i][t];if(s.waitingAgents.has(r))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),!0;if(s.waitingAgents.push(r),s.data&&!s.dataInvalidated)return console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),r.tile.lij.toString(),i,t),r.dataArrived(this),!0;if(s.requestPromise)return!0;xh(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,t,i,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(t){return this.lij[0]===t[0]&&this.lij[1]===t[1]&&this.lij[2]===t[2]}findByLij(t){return this.hasLij(t)?this:this.isLeaf?null:this._children[0].findByLij(t)||this._children[1].findByLij(t)||this._children[2].findByLij(t)||this._children[3].findByLij(t)||null}distanceToSquared(t){return ba(pe($n,this._center[fa.MIDDLE],t))}containsPoint(t){const i=this.extent;return t[0]>=i[0]&&t[1]>=i[1]&&t[0]<=i[2]&&t[1]<=i[3]}unrequestLayerData(t,i,r){const s=this.layerInfo[i][t],n=s.waitingAgents,o=n.removeUnordered(r)!=null;Qp(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(t,i,r){const s=this.layerInfo[i][t];s.data=r,s.dataInvalidated=!1,s.waitingAgents.forAll(n=>n.dataArrived(this)),s.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(t,i,r){r.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${i}/${t} error ${r}`);const s=this.layerInfo[i][t];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(t,i){switch(t){case Ht.MAP:return this._updateTexture(i);case Ht.ELEVATION:return this._updateGeometry()}}_updateTexture(t){this.renderData&&(this.resetPendingUpdate(t===An.FADING?vt.TEXTURE_NOFADING:vt.TEXTURE_FADING),this.setPendingUpdate(t===An.FADING?vt.TEXTURE_FADING:vt.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(vt.GEOMETRY);for(const t of this.layerInfo[Ht.ELEVATION])t.pendingUpdates|=vt.GEOMETRY}invalidateLayerData(t,i){this.layerInfo[i][t].invalidateSourceData(),this.restartAgents(i)}computeElevationBounds(){const t=this._elevationBounds;hi(t,Number.MAX_VALUE,-Number.MAX_VALUE);const i=this.layerInfo[Ht.ELEVATION];let r=!0;for(const s of i)_(s.elevationBounds)&&(t[0]=Math.min(t[0],s.elevationBounds.min),t[1]=Math.max(t[1],s.elevationBounds.max),s.elevationBounds.hasNoDataValues||(r=!1));r&&(t[0]=Math.min(t[0],0),t[1]=Math.max(t[1],0)),this.updateRadiusAndCenter(),this._surface.setTileTreeDirty()}_updateCenter(){const t=this._elevationBounds,i=.5*(t[0]+t[1]);oe($n,this.up,i),de(this._center[fa.MIDDLE],this.centerAtSeaLevel,$n),oe($n,this.up,t[0]),de(this._center[fa.TOP],this.centerAtSeaLevel,$n),oe($n,this.up,t[1]),de(this._center[fa.BOTTOM],this.centerAtSeaLevel,$n)}findElevationBoundsForLayer(t,i){const r=this.layerInfo[Ht.ELEVATION][t];if(_(r.elevationBounds)&&r.elevationBounds.level>=i)return;const s=this._surface.layerViewByIndex(t,Ht.ELEVATION),n=_j(s);if(!$R(this,n,!1))return;const o=Lct;let a=!1;if(r.data){const l=r.data;o.min=l.bounds[0],o.max=l.bounds[1],o.hasNoDataValues=l.hasNoDataValues,o.level=this.level,a=!0}else{let l,c,h=0;for(let p=this._parent;p&&(!c||h<ID(this.level))&&(h=this.vlevel-p.level,l=c||l,c=p.layerInfo[Ht.ELEVATION][t].data,!(!c&&l&&h>=ID(this.level)));p=p.parent);c=c||l,c&&(c.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],o),o.min!==1/0&&(o.level=c.level,a=!0))}a&&(R(r.elevationBounds)&&(r.elevationBounds=new bZ),r.elevationBounds.copyFrom(o))}modifyLayers(t,i,r){const s=this.layerInfo[r];for(const a of s)a.loadingAgent&&a.loadingAgent!==wl&&(KI(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)t[a]===void 0&&s[a].release();const n=new Array(...s),o=i.length;s.length=o;for(let a=0;a<o;a++){const l=i[a];s[a]=l>-1?n[l]:hL.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(t){this.renderData&&(this._createOrUpdateAgents(0,t),this.updateRenderData(t,An.FADING))}updateAgents(t){if(this.renderData){const i=this.layerInfo[t];for(const r of i)r.loadingAgent===wl&&(r.loadingAgent=null);this._createOrUpdateAgents(0,t)}}updateAgentSuspension(){for(const t of g1){const i=this._isSuspended(t);for(const r of this.layerInfo[t])r.loadingAgent&&r.loadingAgent!==wl&&(r.loadingAgent.setSuspension(i),r.loadingAgent===wl&&this.updateRenderData(t,An.FADING))}}removeLayerAgent(t,i){const r=this.layerInfo[i][t];r.loadingAgent&&r.loadingAgent!==wl&&r.loadingAgent.dispose(),r.loadingAgent=null}agentDone(t,i){const r=this.layerInfo[i][t];r.loadingAgent=wl,!r.data&&R(r.upsampleInfo)&&this._createOrUpdateAgents(t+1,i)}_createOrUpdateAgents(t,i){const r=this.layerInfo[i];if(r.length===0)return;const s=(()=>{for(let o=t;o<r.length;++o){const a=this._surface.layerViewByIndex(o,i);if(NF(a)&&a.layer.blendMode!=="normal")return!0}return!1})(),n=this._isSuspended(i);for(let o=t;o<r.length;++o){const a=r[o];let l=!1;const c=this._surface.layerViewByIndex(o,i),h=_j(c);if(a.loadingAgent?$R(this,h,!1)?(a.loadingAgent!==wl&&a.loadingAgent.setSuspension(n),a.loadingAgent!==wl&&(l=a.loadingAgent.update())):a.dispose():$R(this,h,!1)&&(a.loadingAgent=Dct(this,o,i,n),l=a.loadingAgent.startLoading(),l?a.loadingAgent===wl&&this.setPendingUpdate(vt.GEOMETRY):(KI(a.loadingAgent),a.loadingAgent=wl)),a.loadingAgent===wl&&this.updateRenderData(i,An.FADING),!s&&l&&c.isOpaque)return}}_isWithinExtent(t){const i=this.extent;return i[0]>=t[0]&&t[2]>=i[2]&&i[1]>=t[1]&&t[3]>=i[3]}intersectsExtent(t){const i=this.extent;return i[2]>=t[0]&&t[2]>=i[0]&&i[3]>=t[1]&&t[3]>=i[1]}getElevationBasedVerticesPerSide(t){const i=this.vlevel-this.level,r=Math.max(this.level-t,ID(this.level)-i);return $e(1+(this.maxTesselation>>r),2,this.maxTesselation+1)}get test(){return{cachedMemory:this.cachedMemory}}_findLIJ(t,i){if(!t)return null;const r=this.surface.rootTiles;if(_(r)){for(const s of r)if(Nct(s,t)){let n=s,o=t[0]-n.level-1;for(;o>=0&&!n.isLeaf&&!i(n);){const a=t[1]>>o&1,l=t[2]>>o&1;n=n.children[2*a+l],o--}return i(n)?n:null}}return null}findNeighborTile(t,i){const r=this.lij,s=this.getNeighborLIJ(r,t);return s?Fct(r,s)?i(this)?this:null:this._findLIJ(s,i):null}findCorner(t,i){const r=t===Nt.NORTH_EAST?1:t===Nt.NORTH_WEST?0:t===Nt.SOUTH_WEST?2:3;let s=this;for(;!(s.isLeaf||i&&i(s));)s=s.children[r];return s}findNeighborCornerTileExact(t,i){var r;return(r=this.findNeighborTile(t,s=>i(s)||s.level===this.level))==null?void 0:r.findCorner(FF(t),i)}forAllSubtreeOnSide(t,i){const r=t===Nt.NORTH?[0,1]:t===Nt.NORTH_EAST?[1]:t===Nt.EAST?[1,3]:t===Nt.SOUTH_EAST?[3]:t===Nt.SOUTH?[2,3]:t===Nt.SOUTH_WEST?[2]:t===Nt.WEST?[0,2]:[0],s=n=>{i(n)||n.isLeaf||r.forEach(o=>s(n.children[o]))};s(this)}forallNeighbors(t){UF.forEach(i=>this.findNeighborCornerTileExact(i,t)),A0.forEach(i=>{var r;return(r=this.findNeighborTile(i,s=>s.level===this.level||t(s)))==null?void 0:r.forAllSubtreeOnSide(cL(i),t)})}getNeighborEdgeStartVertexIndex(t,i){const r=i!=null?i:this.findNeighborTile(A0[t],h=>h.isLoaded);if(!r||!this.isLoaded||!r.isLoaded)return 0;const s=this.level-r.level;if(s===0)return 0;const n=2**s,o=(1&t)==1,a=o?0:1,l=r.lij[a+1]*n,c=this.lij[a+1]-l;return o?n-1-c:c}_updateNeighborsWithChangedEdgeResolution(){for(let t=0;t<4;++t)if(this.renderData.geometryState.neighborData.modifiedEdgeResolutions[t]){const i=A0[t],r=this.findNeighborTile(i,s=>s.isLoaded||s.level===this.level);if(!r)continue;if(!r.isLoaded){r.isLeaf;const s=(t+2)%4,n=cL(i);r.forAllSubtreeOnSide(n,o=>o.isLoaded?(o.updateEdgeAfterResolutionChange(s),!0):(o.isLeaf,!1))}this.renderData.geometryState.neighborData.modifiedEdgeResolutions[t]=!1}}updateNeighborDataAndGeometryIfNeeded(){this.isLoaded&&this.renderData.updateNeighborDataAndGeometryIfNeeded()}updateNeighborsAfterGeometryChange(t=this.level){this.forEachLoadedNeighbor(i=>this._updateNeighbor(i)),A0.forEach(i=>{var r;(r=this.findNeighborTile(i,s=>s.isLoaded&&s.level<t))==null||r.updateNeighborsWithChangedEdgeResolution()})}updateNeighborsWithChangedEdgeResolution(){this.isLoaded&&this._updateNeighborsWithChangedEdgeResolution()}updateEdgeAfterResolutionChange(t){this.renderData.updateEdgeAfterResolutionChange(t)}forEachLoadedNeighbor(t){const i=this.level,r=s=>s.level===i||s.isLoaded;A0.forEach((s,n)=>{var l,c;const o=this.findNeighborTile(s,r);o!=null&&o!==this&&o.forAllSubtreeOnSide(cL(s),h=>!!h.isLoaded&&(t(h),!0));const a=(c=(l=this.renderData)==null?void 0:l.geometryState)==null?void 0:c.neighborData;a&&(a.modifiedEdgeResolutions[n]=!1)}),UF.forEach(s=>{var o;const n=(o=this.findNeighborTile(s,r))==null?void 0:o.findCorner(FF(s),a=>a.isLoaded);!n||Uct(this,n,s),(n==null?void 0:n.isLoaded)&&t(n)})}_updateNeighbor(t){(t==null?void 0:t.isLoaded)&&t.updateNeighborDataAndGeometryIfNeeded()}getNeighborLIJ(t,i){const r=coe(i)?-1:loe(i)?1:0,s=ooe(i)?-1:aoe(i)?1:0,n=[t[0],t[1]+r,t[2]+s];return n[1]<0?null:this.surface.isGlobal?this.wrapLIJ(n):n[2]<0?null:n}wrapLIJ(t){return!t||t[1]<0||t[1]>=2**t[0]?null:this.surface.wrapEastWest(t)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this.lij[2]===0}get isNorthEnd(){return this.lij[1]===0}get isSouthEnd(){return this.extent[1]+Et>=this.surface.extent[1]}compareLIJs(t){const i=this.lij,r=i[0],s=t[0];if(r===s)return[i,t];const n=r-s;if(n<0){const o=2**-n;return[[s,i[1]*o,i[2]*o],t]}{const o=2**n;return[i,[r,t[1]*o,t[2]*o]]}}checkGeometryWaterproofness(){}shouldHaveNeighbor(t){const i=this.extent,r=this.surface.rootTilesExtent,s=.25*(i[2]-i[0]);if(coe(t)&&i[3]+s>=r[3]||loe(t)&&i[1]-s<=r[1])return!1;const n=this.surface.isGlobal;return!(!n&&ooe(t)&&i[0]-s<=r[0])&&!(!n&&aoe(t)&&i[2]+s>=r[2])}}function Dct(e,t,i,r){const s=i===Ht.ELEVATION?CZ.acquire():EZ.acquire();return s.init(e,t,i,r),s}function KI(e){e.dispose(),e instanceof yxe?CZ.release(e):e instanceof vxe&&EZ.release(e)}const EZ=new ys(vxe),CZ=new ys(yxe),Lct=new bZ;var fa;function Nct(e,t){const i=e.level,r=t[0];if(i>r)return!1;const s=r-i,n=Math.floor(t[1]/2**s),o=Math.floor(t[2]/2**s);return n===e.lij[1]&&o===e.lij[2]}function Fct(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function fV(e,t,i){return Math.abs(e-t)<=i}function Uct(e,t,i){return!R(e)&&!R(t)&&t!==e&&(e.level>=t.level?Soe(e,t,i):Soe(t,e,FF(i)))}function Soe(e,t,i){e.level>=t.level;const r=ult(i),s=hlt(i),n=e.extent,o=t.extent,a=[r?n[0]:n[2],s?n[3]:n[1]],l=[r?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),h=fV(a[0],l[0],c)||e.surface.isGlobal&&fV(a[0],-l[0],c),p=fV(a[1],l[1],c);return h&&p?!0:e.level===t.level||!h&&!p?!1:h?Eoe(o[1],o[3],n[1],n[3],c):Eoe(o[0],o[2],n[0],n[2],c)}function Eoe(e,t,i,r,s=Et){return e-s<=i&&i<=r&&r<=t+s}(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(fa||(fa={}));class kct{constructor(){this._scales=[-1,-1,-1,-1],this._offsets=[-1,-1,-1,-1]}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(t,i,r){this._scales[2*t]=i,this._scales[2*t+1]=r}setOffset(t,i,r){this._offsets[2*t]=i,this._offsets[2*t+1]=r}get scales(){return this._scales}get offsets(){return this._offsets}}class eg{constructor(){this.geometryInfo=new Jlt,this.intersectionData=null,this.geometryState=null,this._textureRef=new pS(()=>this.tile.surface.textureFadeDuration),this.overlay=new kct,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._edgeResolutionChanged=!1,this._edgeNeighborChanged=!1,this._cornerElevationChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1}get tile(){return this._tile}init(t){this._tile=t,this.clear();const i=this.geometryInfo;i.indices=null,i.vertexAttributes=null,cr(i.boundingBox),i.indexCount=0,i.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new sct,this.localOrigin=null,this.overlay.clear()}clear(){this._releaseGeometry(),this.releaseTexture(),this._textureRef.clear()}updateGeometryIfChanged(t,i){const r=this.updateGeometryStateAndPrepareForGeometryGeneration(i);return this._hasGeometry=!0,this.updateNeighborDataAndGeometryIfNeeded(r,t)}updateNeighborDataAndGeometryIfNeeded(t=!1,i=this.vao.context){const r=this._updateNeighborData(),s=t||this._geometryStateChangedSinceLastUpdate||r;return s&&(this._updateGeometry(i),this._geometryStateChangedSinceLastUpdate=!1),s}_calculateEdgeResolution(t,i){var c;const r=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!r.surface.isGlobal){const h=r.surface.extent;if(_(h)&&(t===0&&r.extent[3]>h[3]||t===1&&r.extent[2]>h[2]||t===2&&r.extent[1]<h[1]||t===3&&r.extent[0]<h[0]))return s}const n=r.level,o=A0[t],a=i||r.findNeighborTile(o,h=>h.isLoaded||h.level===n);if(!a||a.isLeaf&&!a.isLoaded)return R((c=r.surface)==null?void 0:c.rootTiles)||r.surface.updatingRootTiles||r.shouldHaveNeighbor(o),s;if(a.isLoaded){const h=a,p=h.renderData.geometryState,f=n-h.level;if(f===0){const v=p.numVerticesPerSide-1;return Math.max(v,s)}const m=2**f,y=p.neighborData.edgeResolutions[(t+2)%4]/m;return Math.max(1,y)}a.isLeaf;let l=s;return a.forAllSubtreeOnSide(cL(o),h=>h===r||(h.isLoaded?(l=Math.max(l,2**(h.level-n)),!0):(h.isLeaf,!1))),l}_updateNeighborData(){const t=this.tile,i=c=>c.isLoaded||c.level===t.level,r=c=>c.isLoaded,s=[null,null,null,null],n=[null,null,null,null];(()=>{for(let c=0;c<4;++c){const h=t.findNeighborTile(A0[c],i);s[c]=h,n[c]=(h==null?void 0:h.isLoaded)?h:null}})();const o=[null,null,null,null];(()=>{for(let c=0;c<4;++c)o[c]=t.findNeighborTile(UF[c],r)})();const a=this.geometryState.neighborData;let l=!1;return(()=>{for(let c=0;c<4;++c){const h=a.edgeResolutions[c],p=s[c],f=this._calculateEdgeResolution(c,p);a.edgeResolutions[c]=f,h!==f&&(l=!0,this._edgeResolutionChanged=!0,p&&p!==t&&!p.isLoaded&&p.level===t.level&&(a.modifiedEdgeResolutions[c]=!0))}})(),(()=>{const c=(f,m)=>{var b,S;const y=f.reduce((T,E)=>{var C;return Math.min(T,(C=E==null?void 0:E.level)!=null?C:1/0)},1/0);for(let T=0;T<4;++T){const E=f[(T+3)%4],C=f[T];if(E&&E.level<t.level&&E===C){const M=E,I=(1&T)==1,N=(t.getNeighborEdgeStartVertexIndex(T,M)+(m===0||m===1&&!I||m===3&&I?1:0))/2**(t.level-M.level),D=I?m===0||m===1?M.extent[0]:M.extent[2]:jt(M.extent[0],M.extent[2],N),z=I?jt(M.extent[1],M.extent[3],N):m===0||m===3?M.extent[1]:M.extent[3];return gr(D,z,M.renderData.geometryState.samplerData)}}let v=0,w=0;for(let T=0;T<4;++T){const E=f[T];if(E&&E.level===y){const C=T===0||T===1,M=T===0||T===3,I=E.extent;w+=gr(I[C?0:2],I[M?1:3],(S=(b=E.renderData)==null?void 0:b.geometryState)==null?void 0:S.samplerData),v++}}return v?w/v:0},h=a.cornerNeighborData,p=(f,m)=>{var b;const y=h[f],v=y.cornerTiles;for(let S=0;S<4;++S){const T=UF[S],E=(b=m[S])==null?void 0:b.findCorner(FF(T),C=>(C==null?void 0:C.isLoaded)||C===t);v[S]=E}const w=c(v,f);return y.elevation!==w&&(y.elevation=w,!0)};for(let f=0;f<4;++f){const m=o[f],y=n[f],v=[m,n[(f+1)%4],t,y],w=v.map((b,S)=>v[(S+4-f)%4]);p(f,w)&&(this._cornerElevationChanged=!0,l=!0)}})(),(()=>{var p;const c=(f,m)=>{if(!(f==null?void 0:f.isLoaded)||f.lij[0]>t.lij[0])return null;const y=f.renderData.geometryState;return{neighborSamplerData:y.samplerData,neighborEdgeOverlapResolution:y.neighborData.edgeResolutions[m+2],version:y.samplerDataVersion,neighborVerticesPerSide:y.numVerticesPerSide,neighborTile:f}},h=a.edgeNeighbours;for(let f=0;f<4;++f){const m=n[f];m&&(m==null||m.isLoaded,(m==null?void 0:m.lij[0])<=t.lij[0],void 0);const y=h[f],v=y==null?void 0:y.version,w=c(m,f),b=(p=w==null?void 0:w.version)!=null?p:null,S=y!=null!=(w!=null),T=y&&w&&v!==b,E=y&&w&&(y==null?void 0:y.neighborTile)!==(w==null?void 0:w.neighborTile),C=S||T||E;this._edgeNeighborChanged||(this._edgeNeighborChanged=C),l||(l=C),!C&&v||(h[f]=w)}})(),l}updateEdgeAfterResolutionChange(t){var n,o;const i=this._calculateEdgeResolution(t),r=this.geometryState.neighborData.edgeResolutions,s=r[t];((o=(n=this.geometryState.neighborData.edgeNeighbours[t])==null?void 0:n.neighborTile.level)!=null?o:0)<=this.tile.level,i!==s&&(r[t]=i,this._edgeResolutionChanged=!0,eg.deferTileNeighborUpdate?eg.neighborTilesToUpdate.add(this.tile):this._updateGeometry(this.vao.context))}_updateGeometry(t){this.intersectionData=null;const i=this.tile,r=i.lij,s=eg.updatedGeometryTiles.get(r)||0;eg.updatedGeometryTiles.set(r,s+1);const n=this._vao,o=this.geometryInfo.vertexAttributes,a=!n||!o||this._wireframeChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._edgeResolutionChanged,l=!a&&this._edgeNeighborChanged,c=!l&&this._cornerElevationChanged;this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._edgeResolutionChanged=!1,this._edgeNeighborChanged=!1,this._cornerElevationChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,a?(this._releaseGeometry(),this._createGeometry(t)):l?i.updateEdgeElevations():c?i.updateCornerElevations():console.warn("Update for no reason?")}releaseGeometry(){return this._releaseGeometry()}get hasGeometry(){return this._hasGeometry}ensureTexture(t,i){return _(this._texture)&&this._texture.descriptor.width!==t&&this.releaseTexture(),R(this._texture)&&(this._texture=i(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){_(this._texture)&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}updateGeometryStateAndPrepareForGeometryGeneration(t){const i=this._getElevationInfo(),r=i.samplerData?this.tile.getElevationBasedVerticesPerSide(i.maxTileLevel):this.tile.getDefaultVerticesPerRowOnLevel(),s=Math.max(r,5);let n=this.tile.clippingArea;this.tile.intersectsClippingArea&&!this.tile.isWithinClippingArea||(n=null);const o=this.geometryState;let a=!1;return o.numVerticesPerSide!==s&&(this._numVerticesPerSideChanged=!0,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),i.changed&&(this._samplerDataChanged=!0,o.samplerData=i.samplerData,o.samplerDataVersion++,a=!0),uv(o.clippingArea,n)||(this._clippingAreaChanged=!0,o.clippingArea=n,a=!0),o.wireframe!==t&&(this._wireframeChanged=!0,o.wireframe=t,a=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),this._hasGeometry=!0,a}_createGeometry(t){this.tile.createGeometry();const i=this.geometryInfo.vertexAttributes,r=this.geometryInfo.indices,s=t.gl;this._vao=new Ns(t,Di,{geometry:hc(i.layout)},{geometry:ti.createVertex(t,s.STATIC_DRAW,i.buffer)},ti.createIndex(t,s.STATIC_DRAW,r)),this._hasGeometry=!0}_releaseGeometry(){return this._hasGeometry=!1,!!this._vao&&(this._vao.dispose(),this._vao=null,tct(this.geometryInfo),!0)}get vao(){return this._vao}setTextureReference(t,i=dg.Immediate){_(t)&&t.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(t,i)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const t=this.geometryState.samplerData,i=this.tile.layerInfo[Ht.ELEVATION],r=i.length;let s=new Array(r),n=0,o=0,a=!1;for(let l=0;l<r;l++){const c=i[l];if(_(c.upsampleInfo)){const h=c.upsampleInfo.tile,p=h.layerInfo[Ht.ELEVATION][l].data,f=p&&p.samplerData;t&&t[n]===f||(a=!0),s[n++]=f,o=Math.max(o,h.lij[0])}else if(c.data){const h=this.tile.surface.layerViewByIndex(l,Ht.ELEVATION);if($R(this.tile,h.layer,!1)){const p=c.data;t&&t[n]===p.samplerData||(a=!0),s[n++]=p.samplerData,o=this.tile.level}}}return _(t)&&t.length!==n&&(a=!0),n>0?s.length=n:s=null,{changed:a,samplerData:s,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){const t=Gc(this.intersectionData,0,i=>i.estimatedMemoryUsage);return this.geometryInfo.indices.byteLength+this.geometryInfo.vertexAttributes.byteLength+t}get textureDescriptor(){return _(this._texture)?this._texture.descriptor:null}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){}}eg.updatedGeometryTiles=new Map,eg.deferTileNeighborUpdate=!1,eg.neighborTilesToUpdate=new Set;const zct=65536;function Vct(e,t){const i=e.tile,{extent:r,extentInRadians:s,surface:n}=i,o=e.localOrigin,a=e.geometryState,l=n.isWebMercator,c=n.shadingEnabled,h=a.numVerticesPerSide,p=h-1,f=(h-2)**2,m=l&&(t===lh.HAS_SOUTH_POLE||t===lh.HAS_BOTH_POLES),y=l&&(t===lh.HAS_NORTH_POLE||t===lh.HAS_BOTH_POLES),v=6,w=((m?1:0)+(y?1:0))*v*(p+1),b=a.neighborData,S=b.edgeResolutions.reduce((K,j)=>K+j+1,0),T=dxe(f+w+S),E=e.geometryInfo;E.numVerticesPerSide=a.numVerticesPerSide,E.vertexAttributes=T,qi(E.uvOffsetAndScale,0,0,1,1);const C=T.position.typedBuffer,M=T.uv0.typedBuffer,I=T.normal.typedBuffer,N=E.boundingBox;cr(N);const D=o[0],z=o[1],V=o[2];M_.update(p,s);let k=0;const Y=a.samplerData,Z=i.ellipsoid.radius,le=RZ(e),ne=h-2,$=r[0],U=r[2],B=r[1],H=r[3];(()=>{for(let K=1;K<=ne;K++){const j=K/p,ee=B*(1-j)+H*j,ye=le(j),Te=Math.cos(ye),Ne=Math.sin(ye);for(let _e=1;_e<=ne;_e++){const ge=_e/p,Ce=$*(1-ge)+U*ge,Le=M_.sinLonLUT[_e],Ri=M_.cosLonLUT[_e],Li=Z+gr(Ce,ee,Y),ii=Ri*Te*Li-D,Ni=Le*Te*Li-z,ni=Ne*Li-V;pg(ii,Ni,ni,N);const Fi=Qu*k;C[Fi+0]=ii,C[Fi+1]=Ni,C[Fi+2]=ni,M[Fi+0]=ge,M[Fi+1]=j,++k}}})(),c&&(()=>{const K=_e=>(pe(fg,_e,mV),lt(P2,fg,cv),lt(I2,P2,fg),I2),j=T.position,ee=T.normal;k=0;const ye=_e=>{j.getVec(_e,Yl),de(ns,ns,K(Yl))},Te=(_e,ge)=>{{const Ce=_e/p,Le=$*(1-Ce)+U*Ce,Ri=M_.sinLonLUT[_e],Li=M_.cosLonLUT[_e],ii=ge/p,Ni=B*(1-ii)+H*ii,ni=le(ii),Fi=Math.cos(ni),Fr=Math.sin(ni),es=Z+gr(Le,Ni,Y);ie(Yl,Li*Fi*es-D,Ri*Fi*es-z,Fr*es-V)}de(ns,ns,K(Yl))},Ne=(_e,ge,Ce)=>{_e>1&&ge>1&&_e<ne&&ge<ne?ye(k+Ce):Te(_e,ge)};for(let _e=1;_e<=ne;_e++)for(let ge=1;ge<=ne;ge++)j.getVec(k,mV),de(nf,mV,e.localOrigin),we(cv,nf),ie(ns,0,0,0),Ne(ge-1,_e,-1),Ne(ge+1,_e,1),Ne(ge,_e-1,-ne),Ne(ge,_e+1,+ne),we(ns,ns),ee.setVec(k,ns),++k})(),k=f,Txe(e,f),Mxe(e),k=f+S;const W=[];(()=>{const K=(j,ee)=>{const ye=ee*h;pg(-D,-z,j*Z-V,N),W.push({connectedRowOffset:ye,connectedOuterEdgeOffset:j===1?0:2,rowOffset:k,latitudeResolution:v});const Te=Pxe(j===-1?B:H,Z),Ne=j*Math.PI/2-Te,_e=.99*(j===1?1:-1),ge=Z+0;for(let Ce=1;Ce<=v;++Ce){const Le=Te+Ne*(Ce/v),Ri=Math.cos(Le),Li=Math.sin(Le);for(let ii=0;ii<=p;ii++){const Ni=ii/p,ni=M_.sinLonLUT[ii],Fi=M_.cosLonLUT[ii]*Ri*ge-D,Fr=ni*Ri*ge-z,es=Li*ge-V;pg(Fi,Fr,es,N);const rt=Qu*k;if(C[rt+0]=Fi,C[rt+1]=Fr,C[rt+2]=es,M[rt+0]=Ni,M[rt+1]=_e,c){const Er=1/Math.sqrt(Fi*Fi+Fr*Fr+es*es);I[rt+0]=Er*Fi,I[rt+1]=Er*Fr,I[rt+2]=Er*es}++k}}};m&&K(-1,0),y&&K(1,p)})(),xxe(E,a.numVerticesPerSide,W,[0,h-1],[0,h-1],a.wireframe),e.intersectionData=null;for(let K=0;K<4;++K)E.outerEdges[K].count,b.edgeResolutions[K]+1}function Bct(e,t){const i=e.tile,r=i.extent,s=e.localOrigin,n=e.geometryState,o=i.surface,a=o.isWebMercatorOnPlateeCarree,l=o.shadingEnabled,c=r[0],h=r[1],p=r[2]-c,f=r[3]-h,m=n.clippingArea,y=_(m)?Math.max(0,(m[0]-r[0])/p):0,v=_(m)?Math.max(0,(m[1]-r[1])/f):0,w=_(m)?Math.min(1,(m[2]-r[0])/p):1,b=_(m)?Math.min(1,(m[3]-r[1])/f):1,S=w-y,T=b-v,E=S>0?1/S:1,C=T>0?1/T:1,M=-y*E,I=-v*C,N=n.numVerticesPerSide,D=N-1,z=(N-2)**2+n.neighborData.edgeResolutions.reduce((Te,Ne)=>Te+Ne+1,0),V=dxe(z),k=V.position.typedBuffer,Y=V.uv0.typedBuffer,Z=V.normal.typedBuffer,le=e.geometryInfo,ne=le.boundingBox;cr(ne);let $=0;const U=i.ellipsoid.radius,B=n.samplerData,H=_(m)?m:Lxe,W=sq(Math.max(r[0],H[0]),Math.max(r[1],H[1]),Math.min(r[2],H[2]),Math.min(r[3],H[3])),K=s[0],j=s[1],ee=s[2],ye=c3(a,U,t);(()=>{for(let Te=1;Te<=D-1;Te++){const Ne=Te/D,_e=I+Ne*C,ge=$e(h+Ne*f,W[1],W[3]),Ce=$e(_e,0,1),Le=ye(ge)-j,Ri=p/D;for(let Li=1;Li<=D-1;Li++){const ii=Li/D,Ni=M+ii*E,ni=$e(c+ii*p,W[0],W[2]),Fi=$e(Ni,0,1),Fr=gr(ni,ge,B),es=ni*t-K,rt=Fr-ee;pg(es,Le,rt,ne);const Er=Qu*$;if(k[Er+0]=es,k[Er+1]=Le,k[Er+2]=rt,Y[Er+0]=Fi,Y[Er+1]=Ce,l){const Pn=gr(ni+Ri,ge,B),Oa=gr(ni-Ri,ge,B),Qo=gr(ni,ge+Ri,B),Lh=.25*(Oa-Pn),Nh=.25*(gr(ni,ge-Ri,B)-Qo),Jo=Ri,jv=Math.sqrt(Lh*Lh+Nh*Nh+Jo*Jo);Z[Er+0]=Lh/jv,Z[Er+1]=Nh/jv,Z[Er+2]=Jo/jv}++$}}})(),le.numVerticesPerSide=n.numVerticesPerSide,le.vertexAttributes=V,qi(e.geometryInfo.uvOffsetAndScale,y,v,w-y,b-v),Txe(e,$),Sxe(e,t),$=z,xxe(le,n.numVerticesPerSide,[],[0,N-1],[0,N-1],n.wireframe),e.intersectionData=null}function xxe(e,t,i,r,s,n){const o=t-1,a=e.vertexAttributes.count,l=2*(Math.min(t-2,r[1])-Math.max(1,r[0]))*(Math.min(t-2,s[1])-Math.max(1,s[0])),c=A0.map((b,S)=>S===0&&s[1]<t-2||S===1&&r[1]<t-2||S===2&&s[0]>1||S===3&&r[0]>1),h=3*(l+e.outerEdges.reduce((b,S,T)=>b+(c[T]?0:o-2+S.count-1),0)+i.reduce((b,S)=>b+o*(2*(S.latitudeResolution-1)+1),0))*(n?2:1),p=new(a>zct?Uint32Array:Uint16Array)(h);let f=0;const m=n?(b,S,T)=>{p[f++]=b,p[f++]=S,p[f++]=S,p[f++]=T,p[f++]=T,p[f++]=b}:(b,S,T)=>{p[f++]=b,p[f++]=S,p[f++]=T},y=t-2,v=o-2;(()=>{for(let b=Math.max(s[0],1)-1;b<Math.min(s[1],t-2)-1;++b)for(let S=Math.max(r[0],1)-1;S<Math.min(r[1],t-2)-1;++S){const T=b*y+S,E=T+1,C=E+y,M=C-1;m(T,E,C),m(C,M,T)}})(),(()=>{for(let b=0;b<4;++b){if(c[b])continue;const S=e.outerEdges[b],T=e.innerEdges[b];let E=0,C=0;const M=S.count,I=T.count;S.count;const N=b===1||b===2?(D,z,V)=>m(D,z,V):(D,z,V)=>m(D,V,z);for(;E<M-1||C<I-1;){const D=T.getVertexOffset(C),z=S.getVertexOffset(E),V=E<M-1,k=C<I-1,Y=V?0+o*(E+.5)/(M-1):0,Z=k?1+v*(C+.5)/(I-1):0;V&&(!k||Y<=Z)?(++E,N(D,z,S.getVertexOffset(E))):(++C,N(D,z,T.getVertexOffset(C)))}}})();const w=b=>{let S=e.outerEdges[b.connectedOuterEdgeOffset].offset0;for(let T=0;T<b.latitudeResolution;++T){const E=T===0?b.rowOffset:S+t;for(let C=0;C<o;C++)m(S,S+1,E+C),T<b.latitudeResolution-1&&m(S+1,E+C+1,E+C),++S;S=E}};i.forEach(w),e.indices=p,e.indexCount=h}function Txe(e,t){const i=e.localOrigin,r=e.geometryInfo,s=e.geometryState.neighborData.edgeResolutions,n=r.numVerticesPerSide-2,o=r.vertexAttributes.position.typedBuffer;let a=t;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?n-1:0)*n+(l===1?n-1:0),p=(c?0:1)*n+(c?1:0);r.innerEdges[l]=new _oe(o,i,h,p,n)}{const c=a,h=s[l]+1;r.outerEdges[l]=new _oe(o,i,c,1,h),a+=h}}}function Gct(e){var r,s;Cxe(e),Ixe(e);const t=e.vao,i=e.geometryInfo.vertexAttributes;(s=(r=t==null?void 0:t.vertexBuffers)==null?void 0:r.geometry)==null||s.setSubData(i.position.typedBuffer)}function jct(e){Mxe(e),AZ(e)}function Hct(e,t){Axe(e,t),$xe(e,t),AZ(e)}function qct(e,t){Sxe(e,t),AZ(e)}function Sxe(e,t){Axe(e,t),Kct(e,t),$xe(e,t)}function Exe(e,t,i,r,s){const n=Math.cos(i),o=Math.sin(i),a=Math.sin(t),l=Math.cos(t),c=s+r;e[0]=l*n*c,e[1]=a*n*c,e[2]=o*c}function Wct(e,t,i,r,s,n){const o=s[i===0?1:3];Exe(e,s[t===0?0:2],o,r,n)}function Xct(e,t){return(Math.PI/2-2*Math.atan(Math.exp(-e/t)))*t}function Yct(e,t){return e*t}function c3(e,t,i){return e?r=>Xct(r,t):r=>Yct(r,i)}function Zct(e,t,i,r,s,n,o){const a=t===0?s[0]:s[2],l=i===0?s[1]:s[3],c=r;e[0]=a*n,e[1]=o(l),e[2]=c}function Qct(e,t){const i=e.geometryState,r=e.tile,s=r.extent,n=yt(i.clippingArea,s),o=e.geometryInfo,a=o.boundingBox,l=o.outerEdges,c=i.neighborData.cornerNeighborData,h=o.uvOffsetAndScale[0],p=o.uvOffsetAndScale[1],f=o.uvOffsetAndScale[2],m=o.uvOffsetAndScale[3],y=f>0?1/f:1,v=m>0?1/m:1,w=-h*y,b=-p*v,S=r.surface.isWebMercatorOnPlateeCarree,T=c3(S,S?r.ellipsoid.radius:0,t),E=i.samplerData,C=i.neighborData.edgeNeighbours,M=e.localOrigin,I=(N,D,z,V,k)=>{const Y=s[0]*(1-V)+s[2]*V,Z=s[1]*(1-k)+s[3]*k,le=$e(Y,n[0],n[2]),ne=$e(Z,n[1],n[3]),$=[ne===s[3],le===s[2],ne===s[1],le===s[0]],U=!$[3]&&!$[1]||!$[0]&&!$[2],B=U?$[0]&&_(C[0])?C[0]:$[1]&&_(C[1])?C[1]:$[2]&&_(C[2])?C[2]:$[3]&&_(C[3])?C[3]:null:null,H=U?B?B.neighborTile.level===r.level?.5*(gr(le,ne,E)+gr(le,ne,B.neighborSamplerData)):gr(le,ne,B.neighborSamplerData):gr(le,ne,E):c[z].elevation,W=le*t-M[0],K=T(ne)-M[1],j=H-M[2];pg(W,K,j,a);const ee=$e(w+V*y,0,1),ye=$e(b+k*v,0,1);N.setVertexRawXYZUV(D,W,K,j,ee,ye)};for(let N=0;N<4;++N){const D=l[N];I(D,0,N===0?3:N===1?1:2,N===1?1:0,N===0?1:0);const z=N===2?1:N===3?3:0,V=N===3?0:1,k=N===2?0:1;I(D,D.count-1,z,V,k)}}function Cxe(e){Rxe(e,(t,i,r,s)=>Wct(t,i,r,s,e.tile.extentInRadians,e.tile.ellipsoid.radius))}function Axe(e,t){const i=e.tile;_(i.renderData.geometryState.clippingArea)?Qct(e,t):Rxe(e,(r,s,n,o)=>Zct(r,s,n,o,e.tile.extent,t,c3(i.surface.isWebMercatorOnPlateeCarree,i.ellipsoid.radius,t)))}function Rxe(e,t){const i=e.geometryInfo,r=i.outerEdges,s=e.geometryState.neighborData.cornerNeighborData,n=i.boundingBox,o=e.localOrigin,a=(l,c,h,p,f)=>{t(by,h,p,s[c].elevation);for(let m=0;m<3;++m)by[m]-=o[m];pg(by[0],by[1],by[2],n),l.setVertexRawXYZUV(f,by[0],by[1],by[2],h,p)};for(let l=0;l<4;++l){const c=r[l];a(c,l===0?3:l===1?1:2,l===1?1:0,l===0?1:0,0),a(c,l===2?1:l===3?3:0,l===3?0:1,l===2?0:1,c.count-1)}}function AZ(e){var r,s;const t=e.vao,i=e.geometryInfo.vertexAttributes;(s=(r=t==null?void 0:t.vertexBuffers)==null?void 0:r.geometry)==null||s.setSubData(i.position.typedBuffer)}function Mxe(e){Cxe(e);for(let t=0;t<4;++t)Jct(e,t);Ixe(e)}function Jct(e,t){var m3,g3,y3;const i=e.geometryState,r=i.neighborData,s=e.tile;s.level;const n=s.extent,o=n[2]-n[0],a=n[3]-n[1],l=s.extentInRadians,c=l[0];l[1];const h=l[2];l[3];const p=s.ellipsoid.radius,f=RZ(e),m=Ci=>{if(!Ci)return 0;const Ro=v,no=w?0:1,gl=Ci.lij[no+1]*D,Hv=s.lij[no+1]-gl;return(w?D-1-Hv:Hv)*Ro},y=r.edgeNeighbours[t],v=r.edgeResolutions[t],w=t===1||t===3,b=t===1?1:0,S=t===0?1:0,T=n[0]+b*o,E=n[1]+S*a,C=c*(1-b)+h*b,M=f(S),I=y==null?void 0:y.neighborTile,N=s.level-((m3=I==null?void 0:I.level)!=null?m3:s.level),D=2**N,z=v*D,V=m(I),k=I==null?void 0:I.extent,Y=(t+2)%4,Z=i.samplerData,le=(y3=(g3=I==null?void 0:I.renderData)==null?void 0:g3.geometryState)==null?void 0:y3.samplerData,ne=I&&N===0,$=(Ci,Ro,no,gl)=>.5*(gr(Ci,Ro,le)+gr(no,gl,Z)),U=(Ci,Ro)=>gr(Ci,Ro,le),B=ne?$:U;let H=k?Y===1?k[2]:k[0]:T,W=k?Y===0?k[3]:k[1]:E;const K=(Ci,Ro,no)=>{const gl=(V+Ci)/z;return W=k[1]*(1-gl)+k[3]*gl,B(H,W,Ro,no)},j=(Ci,Ro,no)=>{const gl=(V+Ci)/z;return H=k[0]*(1-gl)+k[2]*gl,B(H,W,Ro,no)},ee=I?w?K:j:(Ci,Ro,no)=>gr(Ro,no,Z),ye=(Ci,Ro,no)=>ee(Ci,Ro,no);let Te=b,Ne=T,_e=C,ge=S,Ce=E,Le=M,Ri=Math.sin(_e),Li=Math.cos(_e),ii=Math.cos(Le),Ni=Math.sin(Le);const ni=w?()=>f(ge):()=>M,Fi=w?Ci=>{ge=Ci,Ce=n[1]*(1-Ci)+n[3]*Ci,Le=ni(),ii=Math.cos(Le),Ni=Math.sin(Le)}:Ci=>{Te=Ci,Ne=n[0]*(1-Ci)+n[2]*Ci,_e=c*(1-Te)+h*Te,Ri=Math.sin(_e),Li=Math.cos(_e)},Fr=e.geometryInfo,es=Fr.boundingBox,rt=Fr.vertexAttributes,Er=rt.position.typedBuffer,Pn=rt.uv0.typedBuffer,Oa=rt.normal.typedBuffer,Qo=Fr.outerEdges[t];let Lh=Qo.getVertexOffset(1);const Nh=v+1,Jo=e.localOrigin,jv=Jo[0],kU=Jo[1],zU=Jo[2],h3=s.surface.shadingEnabled,d3=t===1?-1:t===3?1:0,p3=t===0?-1:t===2?1:0,f3=o/v,VU=d3*f3,BU=p3*f3,GU=d3*(1/v),jU=p3*(1/v),hE=Ci=>{Kl(fg,Ci,nf),lt(P2,fg,cv),lt(I2,P2,fg),de(ns,ns,I2)};for(let Ci=1;Ci<Nh-1;++Ci){Fi(Ci/v);const Ro=ye(Ci,Ne,Ce),no=p+Ro,gl=Li*ii*no,Hv=Ri*ii*no,v3=Ni*no,_3=gl-jv,b3=Hv-kU,w3=v3-zU;pg(_3,b3,w3,es);const ep=Qu*Lh;if(Er[ep+0]=_3,Er[ep+1]=b3,Er[ep+2]=w3,Pn[ep+0]=Te,Pn[ep+1]=ge,h3){ie(ns,0,0,0),ie(nf,gl,Hv,v3),we(cv,nf);const ce=(Cr,Sw)=>{const bu=gr(Ne+Cr*VU,Ce+Cr*BU,Sw),qv=p+bu,ut=Te+Cr*GU,Wv=c*(1-ut)+h*ut,mn=Math.sin(Wv),Xv=Math.cos(Wv),x3=f(ge+Cr*jU),Fh=Math.sin(x3),dE=Math.cos(x3),T3=Fe(Xv*dE*qv,mn*dE*qv,Fh*qv);hE(T3)};I&&ce(-1,le),I&&!ne||ce(1,Z),Oa[ep+0]=ns[0],Oa[ep+1]=ns[1],Oa[ep+2]=ns[2]}++Lh}if(h3)for(let Ci=1;Ci<Nh-1;++Ci)Qo.getVertexRawNormal(ns,Ci),Qo.getVertex(nf,Ci),we(cv,nf),Qo.getVertex(Yl,Ci-1),hE(Yl),Qo.getVertex(Yl,Ci+1),hE(Yl),we(ns,ns),Qo.setVertexRawNormal(Ci,ns[0],ns[1],ns[2])}function Kct(e,t){const i=e.geometryState.clippingArea,r=e.tile.extent,s=_(i)&&(r[0]<i[0]||r[2]>i[2]||r[1]<i[1]||r[3]>i[3])?tut:eut;for(let n=0;n<4;++n)s(e,n,t)}function Oxe(e,t,i,r,s,n,o){return o===s?!e||t?(a,l)=>gr(a,l,i):null:o===n&&e?(a,l)=>gr(a,l,r):null}function kF(e,t,i,r){if(t!==e)return()=>0;const s=t?3:2,n=t?1:0,o=r(s,n),a=r(n,s),l=(o!=null?1:0)+(a!=null?1:0),c=t?i:0,h=t?0:i;return(p,f,m)=>((o!=null?-(o(p+c,f+h)-m):0)+(a!=null?+(a(p-c,f-h)-m):0))/l}function eut(e,t,i){const r=e.geometryState.neighborData,s=r.edgeNeighbours,n=e.tile,o=n.level,a=n.surface,l=a.shadingEnabled,c=s[t],h=r.edgeResolutions[t],p=h,f=n.extent,m=e.geometryState,y=p+1,v=c,w=e.localOrigin,b=m.samplerData,S=(j,ee)=>gr(j,ee,b),T=(j,ee)=>.5*(gr(j,ee,v.neighborSamplerData)+gr(j,ee,b)),E=(j,ee)=>gr(j,ee,v.neighborSamplerData),C=(v==null?void 0:v.neighborTile.level)===o,M=C?T:E,I=_(v)?M:S,N=e.geometryInfo,D=N.outerEdges[t],z=c3(a.isWebMercatorOnPlateeCarree,n.ellipsoid.radius,i),V=N.boundingBox,k=t===1||t===3,Y=t===1?f[2]:f[0],Z=t===0?f[3]:f[1],le=t===1?1:0,ne=t===0?1:0,$=(f[2]-f[0])/h,U=v==null?void 0:v.neighborSamplerData,B=_(v),H=(j,ee)=>Oxe(B,C,b,U,j,ee,t),W=kF(k,!0,$,H),K=kF(k,!1,$,H);for(let j=1;j<y-1;++j){const ee=j/p,ye=k?Y:f[0]*(1-ee)+f[2]*ee,Te=k?f[1]*(1-ee)+f[3]*ee:Z,Ne=k?le:ee,_e=k?ee:ne,ge=I(ye,Te),Ce=ye*i-w[0],Le=z(Te)-w[1],Ri=ge-w[2];if(pg(Ce,Le,Ri,V),l){const Li=W(ye,Te,ge),ii=K(ye,Te,ge),Ni=$;D.setVertexRawXYZUVN(j,Ce,Le,Ri,Ne,_e,Li,ii,Ni)}else D.setVertexRawXYZUV(j,Ce,Le,Ri,Ne,_e)}if(l){const j=k?0:1,ee=k?1:0;for(let ye=1;ye<y-1;++ye){D.getNormal(fS,ye);const Te=D.getVertexZ(ye-1)-D.getVertexZ(ye+1),Ne=fS[0]+.5*j*Te,_e=fS[1]+.5*ee*Te,ge=2*$,Ce=1/Math.sqrt(Ne*Ne+_e*_e+ge*ge);D.setVertexRawNormal(ye,Ce*Ne,Ce*_e,Ce*ge)}}}function tut(e,t,i){const r=e.geometryState.neighborData,s=r.edgeNeighbours,n=e.tile,o=n.level,a=n.surface,l=a.shadingEnabled,c=s[t],h=r.edgeResolutions[t],p=h,f=n.extent,m=e.geometryState,y=yt(m.clippingArea,Lxe),v=e.geometryInfo,w=v.uvOffsetAndScale[0],b=v.uvOffsetAndScale[1],S=w+v.uvOffsetAndScale[2],T=b+v.uvOffsetAndScale[3],E=S>w?1/(S-w):1,C=T>b?1/(T-b):1,M=-w*E,I=-b*C,N=p+1,D=[f[3]>y[3],f[2]>y[2],f[1]<y[1],f[0]<y[0]],z=c,V=m.samplerData,k=(ii,Ni)=>gr(ii,Ni,V),Y=(z==null?void 0:z.neighborTile.level)===o,Z=(ii,Ni)=>{const ni=gr(ii,Ni,z.neighborSamplerData);return Y?.5*(ni+gr(ii,Ni,V)):ni},le=k,ne=_(z)?Z:k,$=D[t]?le:ne,U=v.outerEdges[t],B=v.boundingBox,H=t===1||t===3,W=$e(t===1?f[2]:f[0],y[0],y[2]),K=$e(t===0?f[3]:f[1],y[1],y[3]),j=t===1?1:0,ee=t===0?1:0,ye=e.localOrigin,Te=c3(a.isWebMercatorOnPlateeCarree,n.ellipsoid.radius,i),Ne=(f[2]-f[0])/h,_e=z==null?void 0:z.neighborSamplerData,ge=_(z),Ce=(z==null?void 0:z.neighborTile.level)===o,Le=(ii,Ni)=>Oxe(ge,Ce,V,_e,ii,Ni,t),Ri=kF(H,!0,Ne,Le),Li=kF(H,!1,Ne,Le);for(let ii=1;ii<N-1;++ii){const Ni=ii/p,ni=H?W:$e(f[0]*(1-Ni)+f[2]*Ni,y[0],y[2]),Fi=H?$e(f[1]*(1-Ni)+f[3]*Ni,y[1],y[3]):K,Fr=H?j:$e(M+Ni*E,0,1),es=H?$e(I+Ni*C,0,1):ee,rt=$(ni,Fi),Er=ni*i-ye[0],Pn=Te(Fi)-ye[1],Oa=rt-ye[2];if(pg(Er,Pn,Oa,B),l){const Qo=Ri(ni,Fi,rt),Lh=Li(ni,Fi,rt),Nh=Ne;U.setVertexRawXYZUVN(ii,Er,Pn,Oa,Fr,es,Qo,Lh,Nh)}else U.setVertexRawXYZUV(ii,Er,Pn,Oa,Fr,es)}if(l){const ii=H?0:1,Ni=H?1:0;for(let ni=1;ni<N-1;++ni){U.getNormal(fS,ni);const Fi=U.getVertexZ(ni-1)-U.getVertexZ(ni+1),Fr=fS[0]+.5*ii*Fi,es=fS[1]+.5*Ni*Fi,rt=2*Ne,Er=1/Math.sqrt(Fr*Fr+es*es+rt*rt);U.setVertexRawNormal(ni,Er*Fr,Er*es,Er*rt)}}}function Pxe(e,t){return Math.PI/2-2*Math.atan(Math.exp(-e/t))}function iut(e,t,i,r){return Pxe(e+r*(t-e),i)}function rut(e,t,i){return e*(1-i)+t*i}function RZ(e){const t=e.tile;if(t.surface.isWebMercator){const r=t.extent,s=t.ellipsoid.radius;return n=>iut(r[1],r[3],s,n)}const i=t.extentInRadians;return r=>rut(i[1],i[3],r)}function Ixe(e){e.tile.surface.shadingEnabled&&Dxe(e,(t,i,r,s,n,o,a)=>sut(i,t,r,s,n,o,a))}function $xe(e,t){e.tile.surface.shadingEnabled&&Dxe(e,(i,r,s,n,o,a,l)=>nut(aut(e,t),i,s,o,a,l))}function sut(e,t,i,r,s,n,o){out(e,Yl,s,n,o),Kl(fg,Yl,i),lt(P2,fg,r),lt(t,P2,fg)}function nut(e,t,i,r,s,n){e(Yl,r,s,n);const o=Yl[0]-i[0],a=Yl[1]-i[1],l=Yl[2]-i[2];t[0]=-o*l,t[1]=-a*l,t[2]=o*o+a*a}function out(e,t,i,r,s){const n=RZ(e),o=e.tile,a=o.extent;GC(a,i,r,1);const l=(i-a[0])/(a[2]-a[0]),c=(r-a[1])/(a[3]-a[1]),h=o.extentInRadians;Exe(t,h[0]*(1-l)+h[2]*l,n(c),s,o.ellipsoid.radius)}function aut(e,t){return e.tile.surface.isWebMercatorOnPlateeCarree?(i,r,s,n)=>cut(t,e.tile.ellipsoid.radius,i,r,s,n):(i,r,s,n)=>lut(t,i,r,s,n)}function lut(e,t,i,r,s){t[0]=i*e,t[1]=r*e,t[2]=s}function cut(e,t,i,r,s,n){i[0]=r*e,i[1]=(Math.PI/2-2*Math.atan(Math.exp(-s/t)))*t,i[2]=n}function Dxe(e,t){var o;if(!e.tile.surface.shadingEnabled)return;const i=e.geometryState.neighborData.cornerNeighborData,r=e.tile,s=r.extent,n=((o=e.tile.surface.view)==null?void 0:o.viewingMode)==="local";n&&ie(cv,0,0,1);{const a=(v,w,b,S)=>{t(I2,v.renderData,nf,cv,w,b,S),de(ns,ns,I2)},c=(v,w,b,S,T,E)=>{const C=E===1?T.extent[0]:E===3?T.extent[2]:v,M=E===0?T.extent[1]:E===2?T.extent[3]:w,I=C+dx[b][0]*S,N=M+dx[b][1]*S;GC(T.extent,I,N,1);const D=gr(I,N,T.renderData.geometryState.samplerData);a(T,I,N,D)},h=(v,w,b)=>v.extent[w===0||w===1?2:0]+b,p=(v,w,b)=>v.extent[w===0||w===3?3:1]+b,f=(v,w,b,S)=>{const T=h(b,S,dx[v][0]*w),E=p(b,S,dx[v][1]*w);GC(b.extent,T,E,1);const C=gr(T,E,b.renderData.geometryState.samplerData);a(b,T,E,C)},m=(v,w,b,S,T,E)=>{const C=dx[v][0]*w,M=dx[v][1]*w,I=h(b,S,C),N=p(b,S,M),D=h(T,E,C),z=p(T,E,M);GC(b.extent,I,N,1),GC(T.extent,D,z,1);const V=gr(I,N,b.renderData.geometryState.samplerData),k=gr(D,z,T.renderData.geometryState.samplerData);a(b,I,N,.5*(V+k))},y=v=>{const w=v===0||v===1?s[2]:s[0],b=v===0||v===3?s[3]:s[1],S=i[v].cornerTiles,T=S.reduce((E,C)=>{var M;return Math.min(E,(M=C==null?void 0:C.level)!=null?M:1/0)},1/0);for(let E=0;E<4;++E){const C=S[E];wy[E]=(C==null?void 0:C.level)===T?C:null}for(let E=0;E<4;++E){const C=wy[(E+3)%4],M=wy[E];if(C!=null&&C!==r&&C===M){const I=C,N=(E+2)%4,D=I.renderData.geometryState.neighborData.edgeResolutions[N],z=Math.max(D,2**(r.level-I.level)),V=(I.extent[2]-I.extent[0])/z,k=(E+0)%4,Y=(E+1)%4;return c(w,b,(E+3)%4,V,I,E),c(w,b,k,V,I,E),c(w,b,Y,V,I,E),ns}}{wy.some(C=>(C==null?void 0:C.isLoaded)||C===r);const E=wy.reduce((C,M)=>M?M.extent[2]-M.extent[0]:C,0)/wy.reduce((C,M)=>{var I;return Math.max(C,(I=M==null?void 0:M.renderData.geometryState.numVerticesPerSide)!=null?I:1)},1);for(let C=0;C<4;++C){const M=wy[(C+3)%4],I=wy[(C+0)%4];if(!M&&!I)continue;const N=C===0?1:C===1?2:C===2?3:0,D=C===0?2:C===1?3:C===2?0:1;M&&I?m(C,E,M,N,I,D):f(C,E,M!=null?M:I,M?N:D)}}return ns};for(let v=0;v<4;++v){const w=e.geometryInfo.outerEdges[v],b=v===1||v===2?0:w.count-1;w.getVertex(nf,b),n||we(cv,nf),ie(ns,0,0,0);const S=y(v);we(gV[v],S)}}{const a=(c,h,p,f,m)=>{c.setVertexRawNormal(m,h,p,f)},l=e.geometryInfo.outerEdges;for(let c=0;c<4;++c){const h=l[c];{const p=gV[c===0?3:c===1?1:2];a(h,p[0],p[1],p[2],0)}{const p=gV[c===2?1:c===3?3:0];a(h,p[0],p[1],p[2],h.count-1)}}}}function pg(e,t,i,r){e<r[0]?r[0]=e:e>r[3]&&(r[3]=e),t<r[1]?r[1]=t:t>r[4]&&(r[4]=t),i<r[2]?r[2]=i:i>r[5]&&(r[5]=i)}const dx=[[0,1],[1,0],[0,-1],[-1,0]],M_=new ict,Lxe=sq(-1/0,-1/0,1/0,1/0),by=O(),Yl=O(),fg=O(),P2=O(),I2=O(),nf=O(),mV=O(),cv=O(),ns=O(),fS=O(),gV=[O(),O(),O(),O()],wy=[null,null,null,null];class uut extends SZ{constructor(t,i,r){super(),this.horizontalScaleFactor=1,this.extentInRenderSR=Dt(),t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r);const s=r.view.renderSpatialReference,n=r.spatialReference,o=_(s)&&HR(s)&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this.horizontalScaleFactor=o;const a=this.surface.isWebMercatorOnPlateeCarree,l=this.extentInRenderSR,c=this.extent;if(a){const h=Fe(c[0],c[1],0);Js(h,Xe.WebMercator,h,Xe.PlateCarree);const p=Fe(c[2],c[3],0);Js(p,Xe.WebMercator,p,Xe.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const t=this.extentInRenderSR,i=.5*(t[2]-t[0]),r=.5*(t[3]-t[1]),s=Math.sqrt(i*i+r*r),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[fa.MIDDLE][3]=o}_isVisible(t){return AWe(t,this._aabb())}_aabb(){const t=this.extentInRenderSR;return hRe(t[0],t[1],this.elevationBounds[0],t[2],t[3],this.elevationBounds[1])}intersectsRay(t,i,r,s){return e$[0]=1/i[0],e$[1]=1/i[1],e$[2]=1/i[2],RY(this._aabb(),t,e$,r,s)}createGeometry(){Bct(this.renderData,this.horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerRowOnLevel(){return this.level<9?3:2}updateCornerElevations(){Hct(this.renderData,this.horizontalScaleFactor)}updateEdgeElevations(){qct(this.renderData,this.horizontalScaleFactor)}}const e$=O();var sO;(function(e){e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT",e[e.NONE=0]="NONE",e[e.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(sO||(sO={}));class hut extends SZ{constructor(t,i,r){super(),this.obb=new Array(8);for(let s=0;s<8;s++)this.obb[s]=O();t!==void 0&&this.init(t,i,r)}init(t,i,r){super.init(t,i,r);const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=t[0],h=jt(o,l,.5),p=jt(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),xE(this.centerAtSeaLevel,p,h,this.ellipsoid.radius);const m=Ya(this.centerAtSeaLevel);we(m,m),this.up=m,this._updateOBB(),this.updateRadiusAndCenter()}updateRadiusAndCenter(){if(this.lij[0]===0)ie(this._center[md.MIDDLE],0,0,0),ie(this._center[md.TOP],0,0,0),ie(this._center[md.BOTTOM],0,0,0),this.ellipsoid||(this.ellipsoid=vi(this.surface.spatialReference)),this._center[md.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const t=Math.max($s(this._center[md.MIDDLE],this.obb[0]),$s(this._center[md.MIDDLE],this.obb[1]));this._center[md.MIDDLE][3]=Math.sqrt(t)}}_isVisible(t){if(!H0(t,this._center[md.MIDDLE]))return!1;if(this.lij[0]<10)return!0;const i=this.obb;for(let r=0;r<Rg.NUM;r++){const s=r===tr.NEAR,n=t[r];s&&(mC[0]=n[0],mC[1]=n[1],mC[2]=n[2],mC[3]=n[3]-this.surface.view.state.camera.near);const o=s?mC:n;let a;for(a=0;a<8;a++){const l=i[a];if(o[0]*l[0]+o[1]*l[1]+o[2]*l[2]+o[3]<0)break}if(a===8)return!1}return!0}computeElevationBounds(){super.computeElevationBounds(),this._updateOBB()}createGeometry(){const t=this._getPatchType(this.lij[1],this.lij[0]);Vct(this.renderData,t),this.setMemoryDirty()}_updateOBB(){const t=this.extentInRadians,i=this.obb;for(let r=0;r<2;r++){const s=this.elevationBounds[r];let n=4*r;xE(i[n++],t[0],t[1],this.ellipsoid.radius+s),xE(i[n++],t[0],t[3],this.ellipsoid.radius+s),xE(i[n++],t[2],t[3],this.ellipsoid.radius+s),xE(i[n++],t[2],t[1],this.ellipsoid.radius+s)}if(this.surface.isWebMercator)switch(this._getPatchType(this.lij[1],this.lij[0])){case lh.HAS_NORTH_POLE:ie(i[1],0,0,this.ellipsoid.radius),ie(i[2],0,0,this.ellipsoid.radius),ie(i[5],0,0,this.ellipsoid.radius),ie(i[6],0,0,this.ellipsoid.radius);break;case lh.HAS_SOUTH_POLE:ie(i[0],0,0,-this.ellipsoid.radius),ie(i[3],0,0,-this.ellipsoid.radius),ie(i[4],0,0,-this.ellipsoid.radius),ie(i[7],0,0,-this.ellipsoid.radius)}}_getPatchType(t,i){return t===(1<<i)-1?t===0?lh.HAS_BOTH_POLES:lh.HAS_SOUTH_POLE:t===0?lh.HAS_NORTH_POLE:lh.REGULAR}intersectsRay(t,i,r,s){const n=this._center[md.MIDDLE],o=n[3]+r,a=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],l=n[0]-t[0],c=n[1]-t[1],h=n[2]-t[2],p=(l*i[0]+c*i[1]+h*i[2])/a,f=i[0]*p-l,m=i[1]*p-c,y=i[2]*p-h;return f*f+m*m+y*y<o*o}getDefaultVerticesPerRowOnLevel(){return this.level<Coe.length?Coe[this.level]+1:2}updateCornerElevations(){Gct(this.renderData)}updateEdgeElevations(){jct(this.renderData)}}const Coe=[128,64,32,16,16,8,8,4],mC=gi();var md;(function(e){e[e.TOP=0]="TOP",e[e.MIDDLE=1]="MIDDLE",e[e.BOTTOM=2]="BOTTOM"})(md||(md={}));class dut{constructor(){this.extent=Gt(),this.minLevel=0,this.maxLevel=0,this.callback=null}}class put{constructor(){this._queries=new Bt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new Bt({initialSize:30}),this._queryPool=new ys(dut)}queryVisibleLevelRange(t,i,r,s){const n=this._queryPool.acquire();Pd(n.extent,t),n.minLevel=i||-Number.MAX_VALUE,n.maxLevel=r!=null?r:Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n)}hasPendingQueries(){return this._queryQueue.length!==0}prepareQueries(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const t=this._queryQueue.pop();this._queries.push(t)}this._queriesInvPtr=this._queries.length}processQueries(){for(let t=0;t<this._queries.length;t++){const i=this._queries.data[t];this._queryPool.release(i),i.callback(t>=this._queriesInvPtr),i.callback=null}this._queries.clear()}scaleQueriesForTile(t){const i=t.level;let r=0;for(;r<this._queriesInvPtr;){const s=this._queries.data[r],n=s.extent;i>=s.minLevel&&i<=s.maxLevel&&n[0]<=t.extent[2]&&n[2]>=t.extent[0]&&n[1]<=t.extent[3]&&n[3]>=t.extent[1]?(this._queries.swapElements(r,this._queriesInvPtr-1),this._queriesInvPtr--):r++}}}class MZ extends Ra{constructor(){super(...arguments),this.blendMode=De.Normal}}u([G({count:De.COUNT})],MZ.prototype,"blendMode",void 0);class fut extends _xe{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.blendMode=De.Normal,this.backgroundColor=Ta}}class wU extends lr{initializeProgram(t){const i=wU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt})}}wU.shader=new Qi(gct,()=>import("./BlendLayers.glsl.fcf942d2.js"));class pL extends MZ{constructor(){super(...arguments),this.output=Qn.Composite,this.baseOpacityMode=un.One,this.premultipliedSource=!1}}u([G({count:Qn.COUNT})],pL.prototype,"output",void 0),u([G({count:un.COUNT})],pL.prototype,"baseOpacityMode",void 0),u([G()],pL.prototype,"premultipliedSource",void 0);class yV{constructor(t,i,r,s,n,o){this.texture=t,this.type=i,t.retain(),this.offsetAndScale=fi(r.offset[0],r.offset[1],r.scale,r.scale),this.opacities=Fe(s,o,n)}destroy(){this.texture.release()}}function fL(){return[1,0,0,1,0,0]}function mut(e){return[e[0],e[1],e[2],e[3],e[4],e[5]]}function gut(e,t,i,r,s,n){return[e,t,i,r,s,n]}function yut(e,t){return new Float64Array(e,t,6)}Object.freeze(Object.defineProperty({__proto__:null,create:fL,clone:mut,fromValues:gut,createView:yut},Symbol.toStringTag,{value:"Module"}));function vut(e){return e instanceof Float32Array&&e.length>=2}function _ut(e){return Array.isArray(e)&&e.length>=2}function vV(e){return vut(e)||_ut(e)}const but=96,wut=39.37;function OZ(e,t){return t.type?hi(e,t.x,t.y):ro(e,t)}function xut(e){return cc(e)}function Tut(e,t){const i=e.targetGeometry,r=t.targetGeometry;return i.x=r.x,i.y=r.y,i.spatialReference=r.spatialReference,e.scale=t.scale,e.rotation=t.rotation,e}const Sut=function(){const e=tt();return function(t,i,r){const s=i.targetGeometry;OZ(e,s);const n=.5*xU(i);return t.xmin=e[0]-n*r[0],t.ymin=e[1]-n*r[1],t.xmax=e[0]+n*r[0],t.ymax=e[1]+n*r[1],t.spatialReference=s.spatialReference,t}}();function xU(e){return e.scale*Eut(e.targetGeometry)}function Eut(e){return _(e)&&ul(e.spatialReference)?1/(xut(e.spatialReference)*wut*but):1}function Cut(e){return XF(e.rotation)||0}const PZ=function(){const e=tt(),t=tt(),i=tt();return function(r,s,n,o,a,l){return AX(e,s),jl(t,n,.5*l),hi(i,1/o*l,-1/o*l),vX(r,t),a&&gX(r,r,a),Yye(r,r,i),yX(r,r,e),r}}(),Aut=function(){const e=tt();return function(t,i,r,s){const n=xU(i),o=Cut(i);return OZ(e,i.targetGeometry),PZ(t,e,r,n,o,s)}}(),Rut=function(){const e=tt();return function(t,i,r,s){const n=xU(i);return OZ(e,i.targetGeometry),PZ(t,e,r,n,0,s)}}();function Mut(e){const t=J0(e);return t?t.valid[1]-t.valid[0]:0}function Out(e,t){return Math.round(Mut(e)/t)}var Sj;const om=[0,0];let o0=Sj=class extends fe{constructor(e){super(e),this._viewpoint2D={center:tt(),rotation:0,scale:0,spatialReference:null},this.center=[0,0],this.extent=new ci,this.id=0,this.inverseTransform=fL(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=fL(),this.transformNoRotation=fL(),this.displayMat3=hg(),this.displayViewMat3=hg(),this.viewMat3=hg(),this.viewMat2d=Hye(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(e){this._set("pixelRatio",e),this._update()}set size(e){this._set("size",e),this._update()}set viewpoint(e){if(e){const t=this._viewpoint2D,i=e.targetGeometry;t.center[0]=i.x,t.center[1]=i.y,t.rotation=e.rotation,t.scale=e.scale,t.spatialReference=i.spatialReference}this._update()}copy(e){const t=this.size,i=this.viewpoint;return i&&t?(this.viewpoint=Tut(i,e.viewpoint),this._set("size",ro(t,e.size))):(this.viewpoint=e.viewpoint.clone(),this._set("size",[e.size[0],e.size[1]])),this._set("pixelRatio",e.pixelRatio),this}clone(){return new Sj({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(e,t,i){return vV(t)?c1(e,t,this.inverseTransform):(om[0]=t,om[1]=i,c1(e,om,this.inverseTransform))}toScreen(e,t,i){return vV(t)?c1(e,t,this.transform):(om[0]=t,om[1]=i,c1(e,om,this.transform))}toScreenNoRotation(e,t,i){return vV(t)?c1(e,t,this.transformNoRotation):(om[0]=t,om[1]=i,c1(e,om,this.transformNoRotation))}getScreenTransform(e,t){const{center:i}=this._viewpoint2D,r=this._get("pixelRatio")||1,s=this._get("size");return PZ(e,i,s,t,0,r),e}_update(){const{center:e,spatialReference:t,scale:i,rotation:r}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new sc({targetGeometry:new nt(e[0],e[1],t),scale:i,rotation:r});if(this._set("viewpoint",o),!n||!t||!i)return;this.resolution=xU(o),this.rotation=r,this.scale=i,this.spatialReference=t,ro(this.center,e);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;BX(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=GX(this.viewMat3),h=_a(n[0]/2,n[1]/2),p=_a(-n[0]/2,-n[1]/2),f=XF(r);YN(c,c,h),jX(c,c,f),YN(c,c,p),f5(this.displayViewMat3,this.displayMat3,c);const m=vX(this.viewMat2d,h);return gX(m,m,f),yX(m,m,p),Sut(this.extent,o,n),Aut(this.transform,o,n,s),Wye(this.inverseTransform,this.transform),Rut(this.transformNoRotation,o,n,s),this.worldScreenWidth=Out(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],o0.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],o0.prototype,"pixelRatio",null),u([d({json:{write:!0}})],o0.prototype,"size",null),u([d()],o0.prototype,"spatialReference",void 0),u([d({type:sc,json:{write:!0}})],o0.prototype,"viewpoint",null),o0=Sj=u([P("esri.views.2d.ViewState")],o0);const Put=o0,Iut=.125;class $ut{constructor(){this._renderParams={context:null,drawPhase:1,state:new Put({viewpoint:new sc({targetGeometry:new nt(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1}}dispose(){this._renderParams=null}render(t,i,r,s,n,o,a,l,c,h){const p=o.adjustLevel(i[0]),f=this._renderParams;f.context=t,f.painter=s,f.glyphMosaic=s.glyphMosaic,f.spriteMosaic=s.spriteMosaic,f.pixelRatio=h,f.displayLevel=p,f.requiredLevel=p;const m=o.getScale(i[0]),[y,v]=o.getShift(i,a*m),w=Iut*a*m/c,b=r.transforms.dvs;b[0]=w,b[4]=-w,b[6]=-1-y-l[0]*a*2,b[7]=1+v+(1-l[1])*a*2-2,f.state.size[0]=c,f.state.size[1]=c,r.stage||r.attachWithContext(t),r.triangleCount=0,s.drawTile(f,r,n)}}class TU extends lr{initializeProgram(t){const i=TU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt})}}TU.shader=new Qi(Tct,()=>import("./RasterColorizer.glsl.4c21d8c1.js"));class hT extends MZ{constructor(){super(...arguments),this.colorizerType=xb.Stretch,this.stretchType=nw.Noop,this.tileBlendInput=Co.LayerOnly,this.baseOpacityMode=un.One,this.applyColormap=!0}}u([G({count:xb.COUNT})],hT.prototype,"colorizerType",void 0),u([G({count:nw.COUNT})],hT.prototype,"stretchType",void 0),u([G({count:Co.COUNT})],hT.prototype,"tileBlendInput",void 0),u([G({count:un.COUNT})],hT.prototype,"baseOpacityMode",void 0),u([G()],hT.prototype,"applyColormap",void 0);class Aoe{constructor(t){this._rctx=t,this._pools=new Map}acquire(t){return this._getPool(t).acquire()}clear(){this._pools.forEach(t=>t.destroy()),this._pools.clear()}_getPool(t){let i=this._pools.get(t);if(!i){const r=Roe.bind(Roe,this._rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.DEPTH_RENDER_BUFFER,width:t,height:t},s=>this._getPool(s.width).release(s));i=new ys(r,null,()=>{}),this._pools.set(t,i)}return i}}class Roe extends xr{constructor(t,i,r){super(t,i),this.release=()=>r(this)}}const Dut=me.getLogger("esri.views.3d.terrain");class Lut{constructor(t,i){this._rctx=t,this._techniqueRepository=i,this._fboPools=[],this._doubleBufferFbo=[],this._vectorTileHelper=new $ut,this._bindParameters=new y5(null,null,null),this._blendLayersTechniqueConfig=new pL,this._poolToWrite=0,this._vaoQuad=Ma(this._rctx,VO),this._fboPools.push(new Aoe(this._rctx)),this._fboPools.push(new Aoe(this._rctx))}dispose(){this._fboPools.forEach(t=>{t.clear(),t=null}),this._fboPools=null,this._doubleBufferFbo.forEach(t=>Ye(t)),this._vaoQuad=Ye(this._vaoQuad),this._vectorTileHelper=Ye(this._vectorTileHelper),this._backgroundTechnique=Wi(this._backgroundTechnique),this._applyOpacityTechnique=Wi(this._applyOpacityTechnique),this._blendLayersTechnique=Wi(this._blendLayersTechnique)}_getBlendLayersTechnique(t,i,r,s=!1){return this._blendLayersTechniqueConfig.output=i,this._blendLayersTechniqueConfig.blendMode=t,this._blendLayersTechniqueConfig.baseOpacityMode=r?i===Qn.Composite?un.OnBaseLayer:un.OnBackground:un.One,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(wU,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(t,i){const r=this._getBlendLayersTechnique(De.Normal,i,!1),s=this._rctx.bindTechnique(r,t,this._bindParameters);this._render(s)}_render(t){this._rctx.bindVAO(this._vaoQuad),t.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this._vaoQuad,"geometry"))}drawRasterData(t,i,r=!1){if(R(i.texture))return;const s=i.baseOpacity<1;i.blendMode!==De.Normal||s||r?(i.fboTexture=this._currentFBO.colorTexture,this._switchPool(this._currentFBO.width)):i.fboTexture=null;const n=this._getBlendLayersTechnique(i.blendMode,t,s,r),o=this._rctx.bindTechnique(n,i,this._bindParameters);this._render(o)}drawImageryTileData(t,i,r){const s=t.sourceLayerInfo.data;if(!s.source)return;t.tile.surface.layerViewByIndex(t.layerIndex,Ht.MAP).ensureSymbolizerParameters(s);const n=r.baseOpacity<1;r.blendMode!==De.Normal||n?(r.fboTexture=this._currentFBO.colorTexture,this._switchPool(this._currentFBO.width)):r.fboTexture=null;const o=this._getRasterColorizerTechnique(s,i,r.blendMode,n),a=this._rctx.bindTechnique(o);if(!s.bind(this._rctx))return;s.opacity=r.opacity;const l=s.getUniforms();l.scale=t.scale,l.offset=t.offset,l.backgroundColor=r.backgroundColor,l.fboTexture=r.fboTexture,l.baseOpacity=r.baseOpacity,o.bindPass(l,null),this._render(a)}_getRasterColorizerTechnique(t,i,r,s){const n=t.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(n.type);return R(this._rasterColorizerConfig)&&(this._rasterColorizerConfig=new hT,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.tileBlendInput=i===Qn.ColorComposite?Co.ColorComposite:i===Qn.GridComposite?Co.GridComposite:Co.LayerOnly,this._rasterColorizerConfig.blendMode=r,this._rasterColorizerConfig.baseOpacityMode=s?i===Qn.Composite?un.OnBaseLayer:un.OnBackground:un.One,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.stretchType=t.hasStretchTypeNone()?nw.Noop:nw.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(TU,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(t,i,r,s,n,o,a){const l=this._rctx,c=i.sourceLayerInfo.data,h=i.tile.surface.layerViewByIndex(i.layerIndex,Ht.MAP),p=t.baseOpacity<1||t.opacity<1||t.blendMode!==De.Normal||a!==Qn.Composite;let f;this._getBlendLayersTechnique(t.blendMode,a,t.baseOpacity<1,p).bindPipelineState(l),p?(f=this._acquire(n),l.bindFramebuffer(f),l.setClearColor(0,0,0,0),l.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT)):o&&l.clearSafe(Xi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(l,i.sourceLod,c,h.painter,h.layer.styleRepository,h.schemaHelper,Math.round(1/i.scale),i.offset,s,r)}catch(m){Dut.warnOnce("A render call containing vector tiles did not resolve correctly.",m)}return!_(f)||(l.bindFramebuffer(this._currentFBO),t.texture=f.colorTexture,t.offset=Sh,t.scale=1,this.drawRasterData(a,t,p),f.release(),o)}copyFBOToTexture(t){const i=this._rctx,r=i.bindTexture(t.texture,st.TEXTURE_UNIT_FOR_UPDATES),s=t.descriptor;i.gl.copyTexImage2D(pt.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),t.generateMipmap(),i.bindTexture(r,st.TEXTURE_UNIT_FOR_UPDATES)}_initFBO(t,i){this._rctx.bindFramebuffer(t),this._rctx.setViewport(0,0,i,i),this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT)}_acquire(t){return this._fboPools[this._poolToWrite].acquire(t)}bindPool(t,i){this._poolToWrite=t,this._doubleBufferFbo[t]==null&&(this._doubleBufferFbo[t]=this._acquire(i),this._initFBO(this._doubleBufferFbo[t],i))}_switchPool(t){this._releaseCurrentFBO(),this._doubleBufferFbo[this._poolToWrite]=null,this._poolToWrite=this._poolToWrite===0?1:0,this.bindPool(this._poolToWrite,t)}get _currentFBO(){return this._doubleBufferFbo[this._poolToWrite]}_releaseCurrentFBO(){this._doubleBufferFbo[this._poolToWrite].release(),this._doubleBufferFbo[this._poolToWrite]=null}releasePool(){this._rctx.bindFramebuffer(null),this._releaseCurrentFBO()}cleanupFBOPool(t,i){t===this._lastPixelRatio&&i===this._lastNumLayers||(this._fboPools.forEach(r=>r.clear()),this._lastPixelRatio=t,this._lastNumLayers=i)}}class Nut{constructor(t,i,r){this._rctx=t,this.tileSize=i,this._techniqueRepository=r,this._passParameters=new fut,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._numTexturedLayer=0,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new Lut(this._rctx,this._techniqueRepository),this._blackTex=new uT(r7e(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=Ye(this._composition),this._backgroundTexture=Wi(this._backgroundTexture),this._blackTex=Wi(this._blackTex)}get backgroundIsGrid(){return R(this._backgroundColor)}get backgroundColor(){return this._backgroundColor}updateTileTexture(t,i){if(!t.renderData)return;const r=t.surface,s=r.baseOpacity;this._numTexturedLayer=0;let n=0,o=this.tileSize,a=!1;const l=r.view.state.pixelRatio;let c=!1;const h=t.layerInfo[Ht.MAP];let p=h.length,f=0;for(;f<h.length;f++){const v=r.layerViewByIndex(f,Ht.MAP),w=v.fullOpacity;if(bV[f]=w,zpe(v.layer)&&p>=h.length&&(p=f),w===0){h[f].pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING);continue}++n;const b=_V(t,f);if(b){if(h[f].pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING),NF(v)){const S=nxe(v.layer.parent)?"normal":v.layer.blendMode;Moe[f]=S;const T=S!=="normal";T&&(c=T,a=!1)}tO(v)?o=Math.max(o,this.tileSize*l):s===1&&w===1&&(v.isOpaque||this._dataToTexture(b)&&b.sourceLayerInfo.data.descriptor.isOpaque)&&(a=!0),++this._numTexturedLayer}}this._composition.cleanupFBOPool(l,h.length),o=Fut(o);const m=o/this.tileSize,y=f-1;this._ensureBackgroundTexture(this.tileSize),this._numTexturedLayer!==0?this._numTexturedLayer===1&&!c&&this._useLayerTexture(t,y,p,bV[y])||this._composeMapLayers(t,i,y,p,bV,Moe,o,m,!a||c):this._useBackgroundTexture(t,n)}_ensureBackgroundTexture(t){R(this._backgroundTexture)&&(this._backgroundTexture=this._buildTexture(t),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bindPool(0,t),this._passParameters.offset=Sh,this._passParameters.scale=1,this._passParameters.opacity=1,this._passParameters.blendMode=De.Normal,_(this.backgroundColor)&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,_(this.backgroundColor)?Qn.ColorOnly:Qn.GridOnly),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.releasePool(),this._backgroundDirty=!1)}_useBackgroundTexture(t,i){let r=dg.Immediate;(t.surface.view.layerViewManager.updating||i>0)&&(r=dg.Delayed),this._backgroundTexture&&R(t.renderData.textureReference)&&(r=dg.Immediate),t.renderData.setTextureReference(_(this._backgroundTexture)?new yV(this._backgroundTexture,An.FADING,Ooe,t.surface.baseOpacity,1,0):null,r)}_useLayerTexture(t,i,r,s){const n=i<r,o=n?1:t.surface.baseOpacity,a=n?t.surface.baseOpacity:1,l=_V(t,i);return!!this._dataToTexture(l)&&(t.renderData.setTextureReference(new yV(l.sourceLayerInfo.data,An.FADING,l,o,s,a)),!0)}_composeMapLayers(t,i,r,s,n,o,a,l,c){this._composition.bindPool(0,a);const h=t.surface.baseOpacity;let p=!1,f=Ke.LINEAR_MIPMAP_LINEAR,m=!1,y=0;for(let w=r;w>=0;w--){const b=_V(t,w);if(!b||n[w]===0)continue;const S=w<s&&h<1&&!p;this._passParameters.baseOpacity=S?h:1,S&&(p=!0);const T=y===0,E=c&&T?this.backgroundIsGrid?Qn.GridComposite:Qn.ColorComposite:Qn.Composite;slt(b)?(this._passParameters.opacity=n[w],this._passParameters.blendMode=uL[o[w]],m=this._composition.drawVectorData(this._passParameters,b,l,this.tileSize,a,m,E)):rlt(b)?(this._passParameters.opacity=n[w],this._passParameters.blendMode=uL[o[w]],this._composition.drawImageryTileData(b,E,this._passParameters),this._hasNearestInterpolation(b)&&(f=Ke.NEAREST)):this._dataToTexture(b)&&(this._passParameters.texture=b.sourceLayerInfo.data.texture,this._passParameters.offset=b.offset,this._passParameters.scale=b.scale,this._passParameters.opacity=n[w],this._passParameters.blendMode=uL[o[w]],this._composition.drawRasterData(E,this._passParameters)),y++}const v=t.renderData.ensureTexture(a,()=>this._buildTexture(a,f));this._composition.copyFBOToTexture(v),this._composition.releasePool(),t.renderData.setTextureReference(new yV(v,i,Ooe,p?1:h,1,0))}_hasNearestInterpolation(t){const i=t.sourceLayerInfo.data;return!!i.source&&i.interpolation==="nearest"}_dataToTexture(t){return olt(t)&&this._rasterDataToTexture(t),nlt(t)}_rasterDataToTexture(t){const i=t.sourceLayerInfo;i.data=this._buildTexture(i.data),t.tile.setMemoryDirty()}setBackground(t){this._backgroundColor!==t&&(this._backgroundColor=t,this._backgroundDirty=!0)}_buildTexture(t,i=Ke.LINEAR_MIPMAP_LINEAR){if(R(t))return null;const r={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:i,maxAnisotropy:this._maxAnisotropy,flipped:!0,hasMipmap:!0},s=this._rctx;let n;if(typeof t=="number")r.width=r.height=t,n=new uT(new st(s,r));else if(t instanceof gU)r.isOpaque=t.isOpaque,n=new uT(new st(s,r,t.image)),t.release();else try{n=new uT(new st(s,r,t))}catch{n=new uT(X0e(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,st.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,st.TEXTURE_UNIT_FOR_UPDATES),n}get test(){return{backgroundTexture:this._backgroundTexture}}}function Fut(e){const t=wS(e),i=t*t,r=e*e;if(i===r)return e;const s=t/2;return i-r<r-s*s?t:s}function _V(e,t){_c.layerIndex=t;const i=e.layerInfo[Ht.MAP][t];if(_(i.data))return hi(_c.offset,0,0),_c.tile=e,_c.scale=1,_c.sourceLod=e.lij,_c.sourceLayerInfo=i,_c;const r=i.upsampleInfo;if(_(r)){const s=r.tile.layerInfo[Ht.MAP][t];return _c.tile=r.tile,ro(_c.offset,r.offset),_c.scale=r.scale,_c.sourceLod=r.tile.lij,_c.sourceLayerInfo=s,_c}return null}const bV=new Array,Moe=new Array,_c={tile:null,sourceLayerInfo:null,sourceLod:null,offset:[0,0],scale:1,layerIndex:0},Ooe={offset:[0,0],scale:1},Nxe=200,wV=40,Uut=.8,kut=10,FA=1e-6;function zut(e,t,i){const r=t,s=i;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=e[a];if(r[a]<l){if(s[a]<=FA)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-FA){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=e[a+3];if(r[a]>l){if(s[a]>=-FA)return!1;const c=(l-r[a])/s[a];n=Math.max(n,c)}else if(s[a]>=FA){const c=(l-r[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}class Poe{constructor(t,i,r,s,n){this.aabb=t,this.axis=i,this.d=r,this.midStartIndex=s,this.rightStartIndex=n}}class $2{constructor(t,i,r,s){this.globalTriangleVertexIndices=t,this.firstTriangleIndex=i,this.positionAttribute=s,this.rayDirection=O(),this.bspNodeTree=new Array,this.vertexPositionBuffer=s.data,this.vertexPositionStride=s.stride;const n=r-i,o=n<=Fxe?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=Hut(t,i,r,s.data,s.stride),l=$e(Math.log2(n/wV),2,kut),c=(h,p,f)=>{const m=Gut(o,a,h,p),y=p-h;if(y<=wV){const E=new Poe(m,void 0,0,h,p);return this.bspNodeTree.push(E),E}const{axis:v,midValue:w}=jut(m),b=But(o,a,h,p,v,w),S=(E,C)=>{if(f>l)return;const M=C-E;return M<wV||M>=Uut*y?void 0:c(E,C,f+1)},T=new Poe(m,v,w,b.next,b.mid);return this.bspNodeTree.push(T),T.leftNode=S(h,b.next),T.rightNode=S(b.mid,p),T};c(0,n,0),this.triangleVertexIndices=qut(o,t,i,r)}}intersectRayTriangleRange(t,i){{if(t>=i)return;const r=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this.rayOrigin,a=o[0],l=o[1],c=o[2],h=this.rayDirection,p=h[0],f=h[1],m=h[2];for(let y=t,v=3*t;y<i;++y){const w=r[v]*n,b=s[w],S=s[w+1],T=s[w+2],E=r[v+1]*n,C=s[E],M=s[E+1],I=s[E+2],N=r[v+2]*n,D=s[N],z=s[N+1],V=s[N+2];v+=3;const k=C-b,Y=M-S,Z=I-T,le=D-b,ne=z-S,$=V-T,U=f*$-ne*m,B=m*le-$*p,H=p*ne-le*f,W=k*U+Y*B+Z*H;if(Math.abs(W)<=Number.EPSILON)continue;const K=a-b,j=l-S,ee=c-T,ye=K*U+j*B+ee*H;if(W>0){if(ye<0||ye>W)continue}else if(ye>0||ye<W)continue;const Te=j*Z-Y*ee,Ne=ee*k-Z*K,_e=K*Y-k*j,ge=p*Te+f*Ne+m*_e;if(W>0){if(ge<0||ye+ge>W)continue}else if(ge>0||ye+ge<W)continue;const Ce=(le*Te+ne*Ne+$*_e)/W;if(Ce>=0){const Le=this.indices[y]+this.firstTriangleIndex,Ri=CY(k,Y,Z,le,ne,$,Vut);this.callback(Ce,Ri,Le,!1)}}}$2.numFacesTested+=i-t}intersectRay(t,i){$2.numFacesTested=0;const r=Fe(t.r0[0],t.r0[1],t.r0[2]),s=Fe(t.r1[0],t.r1[1],t.r1[2]),n=s[0]-r[0],o=s[1]-r[1],a=s[2]-r[2];if(n*n+o*o+a*a<FA)return;this.rayOrigin=r;const l=this.rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this.callback=i;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(t,i,r){const s=this.rayOrigin,n=this.rayDirection;if(!zut(t.aabb,s,n))return;const o=t.axis,a=t.d;if(s[o]<a||n[o]<0){const l=i,c=t.midStartIndex;if(l<c){const h=t.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(t.midStartIndex,t.rightStartIndex),s[o]>a||n[o]>0){const l=t.rightStartIndex,c=r;if(l<c){const h=t.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}}$2.numFacesTested=0;const Vut=O(),px=[1/0,1/0,1/0],fx=[-1/0,-1/0,-1/0];function But(e,t,i,r,s,n){let o=i,a=r;for(;o<a;){const c=e[o];t[6*c+s+3]<=n?++o:(--a,e[o]=e[a],e[a]=c)}let l=o;for(a=r;l<a;){const c=e[a-1];t[6*c+s]>=n?--a:(e[a-1]=e[l],e[l]=c,++l)}return{next:o,mid:l}}function Gut(e,t,i,r){if(r<=i)return Pb(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*e[i];for(let n=0;n<3;++n)px[n]=t[s+0+n],fx[n]=t[s+3+n]}for(let s=i+1;s<r;++s){const n=6*e[s];for(let o=0;o<3;++o)px[o]=Math.min(px[o],t[n+0+o]),fx[o]=Math.max(fx[o],t[n+3+o])}return Pb(px[0],px[1],px[2],fx[0],fx[1],fx[2])}function jut(e){const t=e[3]-e[0],i=e[4]-e[1],r=e[5]-e[2],s=t>i?t>r?0:i>r?1:2:i>r?1:r>t?2:0;return{axis:s,midValue:(e[s]+e[s+3])/2}}function Hut(e,t,i,r,s){const n=i-t,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+t),c=e[l+0]*s,h=e[l+1]*s,p=e[l+2]*s;for(let f=0;f<3;++f){const m=r[c+f],y=r[h+f],v=r[p+f];o[6*a+f]=Math.min(m,y,v),o[6*a+3+f]=Math.max(m,y,v)}}return o}function qut(e,t,i,r){const s=r-i;let n=0;for(let a=i;a<r;++a)for(let l=0;l<3;++l)n=Math.max(t[3*a+l],n);const o=n<=Fxe?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(e[a]+i);for(let c=0;c<3;++c){const h=t[l+c];o[3*a+c]=h}}return o}const Fxe=65535;class IZ extends Ebe{constructor(){super(...arguments),this.slicePlaneLocalOrigin=O(),this.origin=this.slicePlaneLocalOrigin}}var Zc,Hn;(function(e){e[e.Material=0]="Material",e[e.ShadowMap=1]="ShadowMap",e[e.Highlight=2]="Highlight"})(Zc||(Zc={})),function(e){e[e.Color=0]="Color",e[e.Alpha=1]="Alpha",e[e.Depth=2]="Depth",e[e.Normal=3]="Normal"}(Hn||(Hn={}));class Wut extends IZ{constructor(){super(...arguments),this.identifier=Zc.Material,this.transparent=!1,this.integratedMesh=!1}}class Xut extends IZ{constructor(){super(...arguments),this.identifier=Zc.ShadowMap}}class Yut extends IZ{constructor(){super(...arguments),this.identifier=Zc.Highlight}}class zF extends jr{constructor(t,i){super(t,"vec4",$i.Draw,(r,s,n)=>r.setUniform4fv(t,i(s,n)))}}var mg;(function(e){e[e.Disabled=0]="Disabled",e[e.Enabled=1]="Enabled",e[e.EnabledWithWater=2]="EnabledWithWater",e[e.COUNT=3]="COUNT"})(mg||(mg={}));class Zut extends Us{constructor(){super(...arguments),this.overlayOpacity=1}}function Ioe(e,t){e.vertex.uniforms.add([new xa("overlayTexOffset"),new xa("overlayTexScale")]),e.fragment.uniforms.add([new We("overlayOpacity",i=>i.overlayOpacity),new zt("ovColorTex",(i,r)=>r.overlays.length===0?null:r.overlays[Pr.INNER].getColorTexture(i.overlaySource))]),Uxe(e,t)}function Qut(e,t){const{vertex:i,fragment:r}=e;i.uniforms.add([new zF("overlayTexOffset",(s,n)=>Jut(s,n)),new zF("overlayTexScale",(s,n)=>Kut(s,n))]),r.constants.add("overlayOpacity","float",1),r.uniforms.add(new zt("ovColorTex",(s,n)=>Ej(s,n))),Uxe(e,t)}function Uxe(e,t){e.extensions.add("GL_OES_standard_derivatives"),t.pbrMode!==Rt.Water&&t.pbrMode!==Rt.WaterOnIntegratedMesh||e.include(Obe,t);const{vertex:i,fragment:r}=e;e.varyings.add("vtcOverlay","vec4"),i.code.add(x`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),r.code.add(x`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture2D(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture2D(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),r.code.add(x`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),t.pbrMode!==Rt.Water&&t.pbrMode!==Rt.WaterOnIntegratedMesh||(r.uniforms.add([new xt("lightingMainDirection",(s,n)=>n.lighting.lightingMainDirection),new xt("lightingMainIntensity",(s,n)=>n.lighting.mainLight.intensity)]),r.code.add(x`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, lightingMainDirection, colorInput.rgb, lightingMainIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function Ej(e,t){return t.overlays.length===0?null:e.identifier===Zc.Material&&e.subPass===Hn.Color?t.overlays[Pr.INNER].getColorTextureNoRasterImage():e.identifier===Zc.Highlight?t.overlays[Pr.INNER].getValidTexture(fs.Highlight):null}function Jut(e,t){for(const i of t.overlays){const{index:r,extent:s}=i;ihe(s)>0&&(mS[2*r]=e.toMapSpace[0]/Wc(s)-s[0]/Wc(s),mS[2*r+1]=e.toMapSpace[1]/Yd(s)-s[1]/Yd(s))}return mS}function Kut(e,t){for(const i of t.overlays){const{index:r,extent:s}=i;ihe(s)>0&&(mS[2*r]=e.toMapSpace[2]/Wc(s),mS[2*r+1]=e.toMapSpace[3]/Yd(s))}return mS}const mS=Gt();function eht(e,t){e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),t.spherical?e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):e.vertex.code.add(x`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),e.fragment.code.add(x`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}function tht(e,t){e.varyings.add("vtc","vec2"),e.vertex.uniforms.add(new xa("texOffsetAndScale")),e.fragment.uniforms.add(new $r("tex")),e.fragment.uniforms.add(new rl("textureOpacities"));const i=t.textureFadingEnabled&&!t.renderOccluded;i&&(e.vertex.uniforms.add(new xa("nextTexOffsetAndScale")),e.varyings.add("nvtc","vec2"),e.fragment.uniforms.add(new $r("texNext")),e.fragment.uniforms.add(new rl("nextTexOpacities")),e.fragment.uniforms.add(new Pi("fadeFactor")));const r=t.tileBlendInput===Co.ColorComposite,s=t.tileBlendInput===Co.GridComposite;s&&e.fragment.include(TZ),r&&e.fragment.uniforms.add(new rl("backgroundColor")),e.vertex.code.add(x`
  void forwardTextureCoordinates(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${i?x`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:x``}
  }`),e.fragment.code.add(x`
    vec4 applyBaseOpacity(vec4 _color, vec3 _opacities) {
      return _opacities.z <= 0.0 ? _color : _color * _opacities.x;
    }

    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${s||r?x`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = ${r?x`vec4(backgroundColor, 1.0)`:x`gridColor(uv)`} * opacities.y;
              float alpha = opacities.z * color.a;
              return mix(bg, color, alpha) * opacities.x;`:x`return color;`}
    }`),i?e.fragment.code.add(x`vec4 getTileColor() {
vec4 color = getColor(texture2D(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture2D(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):e.fragment.code.add(x`vec4 getTileColor() {
return getColor(texture2D(tex, vtc), vtc, textureOpacities);
}`)}class kxe extends Zut{}function iht(e){const t=new Bi;t.include(Kbe,{name:"Terrain Shader",output:e.output}),t.attributes.add(A.POSITION,"vec3"),t.attributes.add(A.UV0,"vec2"),t.attributes.add(A.NORMAL,"vec3");const{vertex:i,fragment:r}=t;if(i.uniforms.add([new vr("proj",(s,n)=>n.camera.projectionMatrix),new K7("view",(s,n)=>Aa($oe,n.camera.viewMatrix,s.origin)),new Sa("origin",s=>s.origin)]),r.uniforms.add(new Sa("origin",s=>s.origin)),e.output===J.Color){t.include(To),t.include(X0,e),t.include(tht,e),t.include(iw,e);const s=e.overlayMode!==mg.Disabled,n=e.overlayMode===mg.EnabledWithWater;s&&t.include(Ioe,ve(F({},e),{pbrMode:Rt.Water})),n&&t.include(eht,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),(e.atmosphere||e.screenSizePerspective)&&i.uniforms.add(new vr("viewNormal",(a,l)=>l.camera.viewInverseTransposeMatrix));const o=e.receiveShadows&&!e.renderOccluded;o&&t.varyings.add("linearDepth","float"),e.tileBorders&&t.varyings.add("vuv","vec2"),e.atmosphere&&(i.uniforms.add(new xt("lightingMainDirection",(a,l)=>l.lighting.lightingMainDirection)),t.varyings.add("wnormal","vec3"),t.varyings.add("wlight","vec3")),e.screenSizePerspective&&(t.varyings.add("screenSizeDistanceToCamera","float"),t.varyings.add("screenSizeCosAngle","float")),i.code.add(x`
      void main(void) {
        vpos = position;
        vnormal = ${e.shading?x`normal`:x`getLocalUp(vpos, origin)`};
        vec2 uv = uv0;
        ${e.atmosphere?x`
        wnormal = normalize((viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz);
        wlight = normalize((view  * vec4(lightingMainDirection, 1.0)).xyz);`:""}
        ${e.tileBorders?x`vuv = uv;`:""}
        ${e.screenSizePerspective?x`
        vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
        screenSizeDistanceToCamera = length(viewPos);
        vec3 viewSpaceNormal = (viewNormal * vec4(normalize(vpos + origin), 1.0)).xyz;
        screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}
        gl_Position = transformPosition(proj, view, vpos);
        ${o?x`linearDepth = gl_Position.w;`:""}
        forwardTextureCoordinates(uv);
        ${s?x`setOverlayVTC(uv);`:""}
        ${n?x`forwardVertexTangent(vnormal);`:x``}
      }
    `),t.extensions.add("GL_OES_standard_derivatives"),t.extensions.add("GL_EXT_shader_texture_lod"),t.include(ls,e),t.include(iw,e),t.include(a3,e),t.include(tw,e),r.uniforms.add([new Sa("cameraPosition",(a,l)=>pe(xV,l.camera.eye,a.origin)),new xt("viewDirection",(a,l)=>we(xV,ie(xV,l.camera.viewMatrix[12],l.camera.viewMatrix[13],l.camera.viewMatrix[14]))),new We("lightingGlobalFactor",(a,l)=>l.lighting.globalFactor),new xt("lightingMainDirection",(a,l)=>l.lighting.lightingMainDirection),new xt("lightingMainIntensity",(a,l)=>l.lighting.mainLight.intensity)]),r.constants.add("ambientBoostFactor","float",nE),n&&r.uniforms.add([new zt("ovWaterTex",(a,l)=>l.overlays.length===0?null:l.overlays[Pr.INNER].getNormalTexture(a.overlaySource)),new K7("view",(a,l)=>Aa($oe,l.camera.viewMatrix,a.origin))]),r.code.add(x`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),r.code.add(x`
      void main() {
        ${o?x`float shadow = readShadowMap(vpos, linearDepth);`:x`float shadow = 0.0;`}
        vec3 normal = normalize(vnormal);
        float vndl = dot(normal, lightingMainDirection);
        float ssao = evaluateAmbientOcclusionInverse();
        vec4 tileColor = getTileColor();
        ${s?x`
            vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
            vec4 overlayColor = overlayOpacity * overlayColorOpaque;
            vec4 groundColor = tileColor;
            tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}
        if (rejectBySlice(vpos)) {
          tileColor *= sliceOpacity;
        }
        ${e.atmosphere?x`
            float ndotl = clamp(vndl, 0.0, 1.0);
            vec3 atm = vec3(clamp(1.0 - dot(-viewDirection, wnormal), 0.0, 1.0));
            atm *= clamp(1.0 - lum(tileColor.rgb) * 1.5, 0.0, 1.0); //avoid atmosphere on bright base maps
            atm *= clamp(ndotl * 2.0, 0.0, 1.0); // avoid atmosphere on dark side of the globe
            atm *= tileColor.a; // premultiply with tile alpha`:""}

        vec3 albedo = ${e.atmosphere?x`atm + tileColor.rgb;`:x`tileColor.rgb;`}

        // heuristic shading function used in the old terrain, now used to add ambient lighting
        float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl${e.shading?"":x`*2.5`}, 0.0, 1.0));

        vec3 additionalLight = ssao * lightingMainIntensity * additionalAmbientScale * ambientBoostFactor ${e.shading?"":x`* lightingGlobalFactor`};

        gl_FragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);
        ${n?x`
            vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
            float waterNormalLength = length(overlayWaterMask);
            if (waterNormalLength > 0.95) {
              mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
              vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
              vec4 viewPosition = view*vec4(vpos, 1.0);
              vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + origin);
              vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
              // un-gamma the ground color to mix in linear space
              gl_FragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w);
            }`:""}
        ${e.screenSizePerspective?x`
          float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
          if (perspectiveScale <= 0.25) {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
          }
          else if (perspectiveScale <= 0.5) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
          }
          else if (perspectiveScale >= 0.99) {
            gl_FragColor = mix(gl_FragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
          }
          else {
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
          }`:""}
        ${e.tileBorders?x`
            vec2 dVuv = fwidth(vuv);
            vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv, 1.0 - vuv));
            float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
            gl_FragColor = mix(gl_FragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
        gl_FragColor = highlightSlice(gl_FragColor, vpos);
      }
    `)}return e.output!==J.Depth&&e.output!==J.Shadow||(t.include(To,{hasModelTransformation:!1,linearDepth:!0}),t.include(Bv,{output:e.output}),t.include(X0,e),t.varyings.add("linearDepth","float"),i.uniforms.add(new di("nearFar",(s,n)=>n.camera.nearFar)),i.code.add(x`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),r.code.add(x`void main() {
outputDepth(linearDepth);
}`)),e.output===J.Normal&&(t.include(To),t.include(X0,e),t.varyings.add("vnormal","vec3"),t.varyings.add("vpos","vec3"),i.uniforms.add(new vr("viewNormal",(s,n)=>n.camera.viewInverseTransposeMatrix)),i.code.add(x`
        void main(void) {
          vec3 normal = ${e.shading?x`normal`:x`getLocalUp(position, origin)`};
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
          vnormal = normalize((viewNormal * vec4(normal, 1.0)).xyz);
        }
    `),r.code.add(x`void main() {
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) {
normal = -normal;
}
gl_FragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
}`)),e.output===J.Highlight&&(t.include(To),t.include(X0,e),t.include(Ioe,e),i.code.add(x`void main() {
setOverlayVTC(uv0);
gl_Position = transformPosition(proj, view, position);
}`),t.include(Bg),r.code.add(x`void main() {
vec4 overlayColor = getCombinedOverlayColor();
if (overlayColor.a == 0.0) {
gl_FragColor = vec4(0.0);
return;
}
outputHighlight();
}`)),t}const $oe=Ae(),xV=O(),rht=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:kxe,build:iht},Symbol.toStringTag,{value:"Module"}));class SU extends lr{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global}initializeProgram(t){const i=SU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(t){const i=this.configuration,r=i.backfaceCullingEnabled&&!i.renderOccluded;return Ut({blending:i.renderOccluded?zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA):null,culling:r&&RX,depthTest:!i.renderOccluded&&{func:hr.LESS},depthWrite:!i.renderOccluded&&pl,colorWrite:Jt,stencilTest:t?MKe(al.IntegratedMeshMaskExcluded):null})}getPipelineState(t,i){return this.useStencil?this._stencilPipelineState:super.getPipelineState(t,i)}}SU.shader=new Qi(rht,()=>import("./Terrain.glsl.1527bd40.js"));class Ts extends Ho{constructor(){super(...arguments),this.output=J.Color,this.overlayMode=mg.Disabled,this.tileBlendInput=Co.LayerOnly,this.spherical=!1,this.atmosphere=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.stencilEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.tileBorders=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.shading=he("enable-feature:terrain-shading")}}u([G({count:J.COUNT})],Ts.prototype,"output",void 0),u([G({count:mg.COUNT})],Ts.prototype,"overlayMode",void 0),u([G({count:Co.COUNT})],Ts.prototype,"tileBlendInput",void 0),u([G()],Ts.prototype,"spherical",void 0),u([G()],Ts.prototype,"atmosphere",void 0),u([G()],Ts.prototype,"receiveShadows",void 0),u([G()],Ts.prototype,"hasSlicePlane",void 0),u([G()],Ts.prototype,"backfaceCullingEnabled",void 0),u([G()],Ts.prototype,"stencilEnabled",void 0),u([G()],Ts.prototype,"textureFadingEnabled",void 0),u([G()],Ts.prototype,"renderOccluded",void 0),u([G()],Ts.prototype,"hasScreenSpaceReflections",void 0),u([G()],Ts.prototype,"hasCloudsReflections",void 0),u([G()],Ts.prototype,"tileBorders",void 0),u([G()],Ts.prototype,"screenSizePerspective",void 0),u([G()],Ts.prototype,"receiveAmbientOcclusion",void 0),u([G()],Ts.prototype,"shading",void 0),u([G({constValue:!0})],Ts.prototype,"isGround",void 0),u([G({constValue:Rt.Disabled})],Ts.prototype,"pbrMode",void 0),u([G({constValue:!1})],Ts.prototype,"highStepCount",void 0),u([G({constValue:!1})],Ts.prototype,"useCustomDTRExponentForWater",void 0),u([G({constValue:!1})],Ts.prototype,"useFillLights",void 0);const TV=7,sht=10,SV=Ls(),t$=Gt();let Oc=class extends Ee{constructor(e){super(e),this.type=Dr.TERRAIN,this.isGround=!0,this.tileSize=256,this._techniqueConfiguration=new Ts,this._passParameters=new kxe,this.rctx=null,this._isTransparent=!1,this._scaleRangeQueries=new put,this.renderDataPool=new ys(eg),this._patchGroups=new Map,this.patchGroupsDirty=!0,this.tileIterator=new pxe,this.highestVisibleLODTile=null,this.visible=!0,this._opaque=!0,this._velvetOverground=!0,this._castShadows=!0,this.emptyTex=null,this.tileRenderer=null,this.stencilEnabledLayerExtents=[],this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=Mr.Occlude}get isGlobal(){return this.stage.viewingMode===Ve.Global}get shadingEnabled(){var e;return(e=this._techniqueConfiguration)==null?void 0:e.shading}initialize(){const e=[Se.OPAQUE_TERRAIN,Se.TRANSPARENT_TERRAIN,Se.OCCLUDED_TERRAIN];this.stage.addRenderPlugin(e,this)}destroy(){this.stage.removeRenderPlugin(this),ect()}get canRender(){return this.visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setNeedsRender()}set opaque(e){this._opaque!==e&&(this._opaque=e,this.setNeedsRender())}get opaque(){return this._opaque&&!this._techniqueConfiguration.hasSlicePlane}get needsLinearDepth(){return this.overlayRenderer.hasWater}set isTransparent(e){this._isTransparent!==e&&(this._isTransparent=e,this.setNeedsRender())}get isTransparent(){return this._isTransparent}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this.setNeedsRender()}set velvetOverground(e){this._velvetOverground!==e&&(this._velvetOverground=e,this.setNeedsRender())}get layerUid(){return Rd}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}toggleShading(){this._techniqueConfiguration.shading=!this._techniqueConfiguration.shading,this.setNeedsRender()}setRootTiles(e){this._rootTiles=e,this.setNeedsRender()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?SF:Mr.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this.stencilEnabledLayerExtents=e,this.setNeedsRender()}setTileSize(e){this.tileSize=e,_(this.tileRenderer)&&(this.tileRenderer.tileSize=e),this.setNeedsRender()}_prepareTileForLoading(e){e.renderData||(e.renderData=this.renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometry(e),this.updateTileTexture(e,vt.TEXTURE_FADING)}queryVisibleLevelRange(e,t,i,r){this._scaleRangeQueries.queryVisibleLevelRange(e,t,i,r),this.setNeedsRender()}updateTileTexture(e,t){_(this.tileRenderer)&&(this.tileRenderer.updateTileTexture(e,t===vt.TEXTURE_FADING?An.FADING:An.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(t))}updateTileGeometryState(e){this._prepareTileForLoading(e),e.renderData.updateGeometryStateAndPrepareForGeometryGeneration(this.wireframe)}updateTileGeometry(e){for(const t of e.layerInfo[Ht.ELEVATION])t.pendingUpdates&=~vt.GEOMETRY;e.resetPendingUpdate(vt.GEOMETRY),e.renderData.updateGeometryIfChanged(this.rctx,this.wireframe)&&this.setNeedsRender()}unloadTile(e){const t=e.renderData;t&&(t.releaseGeometry(),this.renderDataPool.release(t),t.clear(),e.renderData=null,e.setMemoryDirty(),this.setNeedsRender())}_getLocalOriginOfTile(e){const t=sht-TV,i=Math.max(0,Math.floor((e.level-t)/TV)*TV);if(this.isGlobal&&i===0)return Ta;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this.visible=e,this.setNeedsRender()}getStats(){return{numTilesRendered:this.numTilesRendered,numTilesCulled:this.numTilesCulled,numOriginsRendered:this.numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.allTiles.forAll(t=>{t.isLoaded&&(this.updateTileGeometry(t),t.updateNeighborsAfterGeometryChange())}),this.setNeedsRender())}setNeedsRender(e=Rs.UPDATE){this.patchGroupsDirty=!0,this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this.rctx=e.renderContext.rctx,this._techniqueRepository=e.shaderTechniqueRepository,this.tileRenderer=new Nut(this.rctx,this.tileSize,this._techniqueRepository),this.updateTileBackground(),this.emptyTex=X0e(this.rctx)}uninitializeRenderContext(){this.emptyTex=Ye(this.emptyTex),this.tileRenderer=Ye(this.tileRenderer)}intersect(e,t,i,r){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&!this._opaque)return;const s=oht,n=aht;pe(s,r,i),ie(n,1/s[0],1/s[1],1/s[2]);const o=e.results.min,a=e.results.max,l=e.results.ground,c=e.options.store===io.MIN,h=!!e.results.ground.target,p=Oqe(e.verticalOffset),f=e.tolerance;let m,y=c&&_(o.dist)?o.dist:1/0;const v=b=>{const S=b.renderData;if(!(S==null?void 0:S.vao))return;const T=S.geometryInfo;d4(SV,T.boundingBox);const E=S.localOrigin;_(p)&&(p.localOrigin=E,p.applyToAabb(SV));const C=SV;if(mx[0]=i[0]-E[0],mx[1]=i[1]-E[1],mx[2]=i[2]-E[2],!RY(C,mx,n,f,y))return;const M=(Y,Z,le)=>{Y.set(this.type,b,Z,le,Ks),y=c&&_(o.dist)?o.dist:1/0},I=(Y,Z)=>{if(_(Z)&&Y>=0&&(e.options.backfacesTerrain||xe(Z,s)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||t==null||t(i,r,Y))){if((l.dist==null||Y<l.dist)&&M(l,Y,Z),e.options.isFiltered)return;e.options.store===io.ALL&&(R(m)?(m=sY(e.ray),M(m,Y,Z),e.results.all.push(m)):Y<m.dist&&M(m,Y,Z)),(o.dist==null||Y<o.dist)&&M(o,Y,Z),e.options.store!==io.MIN&&(a.dist==null||Y>a.dist)&&M(a,Y,Z)}},N=lht;pe(N,r,E);const D=T.indices,z=T.vertexAttributes,V={data:z.getField(A.POSITION,Vi).typedBuffer,size:3,stride:z.stride/4},k=T.indexCount/3;if(R(p)&&k>Nxe){const Y=b.renderData;R(Y.intersectionData)&&(Y.intersectionData=new $2(D,0,k,V)),Y.intersectionData.intersectRay({r0:mx,r1:N},I)}else XO(mx,N,0,k,D,V,null,p,I)},w=this._rootTiles;_(w)&&(()=>{const b=this.tileIterator;b.reset(w);const S=e.options.invisibleTerrain;for(;!b.done;){const T=b.next();!(T.visible||S&&T.intersectsClippingArea)||!_(p)&&!T.intersectsRay(i,s,f,y)||h&&this._useStencilForTile(T)?b.skipSubtree():v(T)}})()}prepareTechnique(e){if(e.bindParameters.slot===Se.OCCLUDED_TERRAIN){if((e.renderOccludedMask&SF)==0)return null}else{const t=this.opaque?Se.OPAQUE_TERRAIN:Se.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==t)return null}switch(e.pass){case je.MATERIAL:{this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=_(e.bindParameters.clouds.data),this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.ready,this._techniqueConfiguration.overlayMode=this.overlayRenderer.isEmpty()?mg.Disabled:this.overlayRenderer.hasWater?mg.EnabledWithWater:mg.Enabled;const t=e.bindParameters.slot===Se.OCCLUDED_TERRAIN?ga.Occluded:ga.ColorAndWater;return this._updateTechnique(J.Color,t===ga.Occluded)}case je.MATERIAL_DEPTH_SHADOWMAP_ALL:case je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._castShadows&&e.bindParameters.lighting.globalFactor===1?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(J.Shadow,!1)):null;case je.MATERIAL_DEPTH:return this.isTransparent&&this.overlayRenderer.isEmpty()?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(J.Depth,!1));case je.MATERIAL_NORMAL:return this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(J.Normal,!1);case je.MATERIAL_HIGHLIGHT:return this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(J.Highlight,!1)):null}return null}render(e,t){const i=e.pass,r=e.bindParameters.lighting.globalFactor===1;switch(this._updatePatchGroups(),t.useStencil=!1,i){case je.MATERIAL:{const s=e.bindParameters.slot===Se.OCCLUDED_TERRAIN?ga.Occluded:ga.ColorAndWater;this._renderMaterialPass(e,t,s);break}case je.MATERIAL_DEPTH_SHADOWMAP_ALL:case je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:this._castShadows&&r&&this._renderAuxiliaryPass(e,t,ga.None);break;case je.MATERIAL_DEPTH:this.isTransparent&&this.overlayRenderer.isEmpty()||this._renderAuxiliaryPass(e,t,ga.None);break;case je.MATERIAL_NORMAL:this._renderAuxiliaryPass(e,t,ga.None);break;case je.MATERIAL_HIGHLIGHT:this.needsHighlight&&(this._renderAuxiliaryPass(e,t,ga.Highlight),e.rctx.clearSafe(Xi.DEPTH_BUFFER_BIT))}this._scaleRangeQueries.hasPendingQueries()&&this.setNeedsRender()}_renderMaterialPass(e,t,i){const{rctx:r}=e;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this.numTilesRendered=0,this.numTilesCulled=0,this.numOriginsRendered=0,this._scaleRangeQueries.prepareQueries(),this.opaque?this._renderPatchGroups(e,t,i):e.offscreenRenderingHelper.renderToTargets(()=>this._renderPatchGroups(e,t,i),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]),this._scaleRangeQueries.processQueries()}_renderAuxiliaryPass(e,t,i){const r=e.rctx;this._passParameters.overlaySource=i,r.bindTechnique(t,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,t,i)}updateTileBackground(e=null){if(R(this.tileRenderer))return;const t=this.tileRenderer;let i=null;if(_(e)){const r=qe.toUnitRGBA(e);i=Fe(r[0]||0,r[1]||0,r[2]||0)}t.setBackground(i),this.allTiles.forAll(r=>t.updateTileTexture(r,An.FADING)),this._techniqueConfiguration.tileBlendInput=t.backgroundIsGrid?Co.GridComposite:_(t.backgroundColor)?Co.ColorComposite:Co.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this.patchGroupsDirty){if(this.highestVisibleLODTile=null,this._rebuildPatchGroups(),this.renderOrder!==sO.NONE){const e=Array.from(this._patchGroups.values());e.forEach(t=>mxe(this.renderOrder,t)),e.sort((t,i)=>gxe(t[0],i[0],this.renderOrder)),this._patchGroups=new Map(e.map(t=>[t[0].renderData.localOrigin,t]))}this.patchGroupsDirty=!1}}_rebuildPatchGroups(){var t;const e=this._rootTiles;if(!R(e)){(t=e[0])==null||t.surface.checkAllTileWaterproofness(),this._patchGroups.clear();for(const i of e)this._rebuildPatchGroupsForRootTile(i)}}_rebuildPatchGroupsForRootTile(e){const t=this.tileIterator;for(t.resetOne(e);!t.done;){const i=t.next(),r=i.renderData;if(!r||i.visible)if(i.rendered){if(r){const s=this._patchGroups.get(r.localOrigin)||new Array;this._patchGroups.set(r.localOrigin,s),s.push(i),(!this.highestVisibleLODTile||i.vlevel>this.highestVisibleLODTile.vlevel)&&(this.highestVisibleLODTile=i),t.skipSubtree()}}else this.numTilesCulled++;else this.numTilesCulled++,t.skipSubtree()}}_useStencilForTile(e){for(const t of this.stencilEnabledLayerExtents)if(e.intersectsExtent(t))return!0;return!1}_renderPatchGroupsAuxiliary(e,t,i){const r=this.stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(s=>{const n=s[0].renderData.localOrigin;t.program.bindDraw(new nj(n),e.bindParameters);for(let o=0;o<s.length;o++)this._renderPatch(e,t,s[o],Pt.TRIANGLES,r,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,t,i){const r=e.rctx,s=e.bindParameters.camera,n=t.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const h=G_e(this.stage.viewingMode,this.ellipsoidRadius),p=this.pointsOfInterest.centerOnSurfaceFrequent.distance;h.update({distance:p,fovY:s.fovY})}const o=this.stencilEnabledLayerExtents.length>0,a=i===ga.Occluded;a&&(n.bindTexture("tex",this.emptyTex),n.setUniform1f("blend",1),n.setUniform4fv("texOffsetAndScale",hf));const l=_(this.tileRenderer)&&_(this.tileRenderer.backgroundColor)?this.tileRenderer.backgroundColor:Ta;this._techniqueConfiguration.tileBlendInput===Co.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?Pt.LINES:Pt.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&n.bindTexture("texNext",this.emptyTex),this._patchGroups.forEach(h=>{const p=h[0].renderData.localOrigin;t.program.bindDraw(new nj(p),e.bindParameters),this.numOriginsRendered++;for(let f=0;f<h.length;f++){const m=h[f],y=m.renderData.textureReference;if(!R(y)){if(!a){this._scaleRangeQueries.scaleQueriesForTile(m),Doe(m.renderData.geometryInfo.uvOffsetAndScale,y.offsetAndScale,t$),n.setUniform4fv("texOffsetAndScale",t$),n.bindTexture("tex",y.texture.texture);const v=m.renderData.textureFadeFactor,w=v<1?m.renderData.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&_(w)&&v<1?(Doe(m.renderData.geometryInfo.uvOffsetAndScale,w.offsetAndScale,t$),n.setUniform1f("fadeFactor",v),n.setUniform4fv("nextTexOffsetAndScale",t$),n.setUniform3fv("nextTexOpacities",w.opacities),n.bindTexture("texNext",w.texture.texture)):n.setUniform1f("fadeFactor",1),m.renderData.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",y.opacities)}this._renderPatch(e,t,m,c,o,i),m.renderOrder=this.numTilesRendered,this.numTilesRendered++}}}),r.bindVAO(null)}_renderPatch(e,t,i,r,s,n){const o=i.renderData,a=o.vao,l=a.indexBuffer;if(R(l))return;const c=t.program;n!==ga.None&&this._bindOverlayPatchData(c,o.overlay),s&&(t.useStencil=this._useStencilForTile(i),t.bindPipelineState(e.rctx,e.bindParameters.slot));const h=o.geometryInfo.indexCount;e.rctx.bindVAO(a),c.assertCompatibleVertexAttributeLocations(a),e.rctx.drawElements(r,h,l.indexType,0)}_bindOverlayPatchData(e,t){e.setUniform4fv("overlayTexOffset",t.offsets),e.setUniform4fv("overlayTexScale",t.scales)}_updateTechnique(e,t){return this._techniqueConfiguration.output=e,e===J.Color&&(this._techniqueConfiguration.atmosphere=this.isGlobal&&this._velvetOverground),this._techniqueConfiguration.renderOccluded=t,this._techniqueConfiguration.stencilEnabled=!1,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(SU,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this.tileRenderer}}};u([d({constructOnly:!0})],Oc.prototype,"overlayRenderer",void 0),u([d({constructOnly:!0})],Oc.prototype,"stage",void 0),u([d({readOnly:!0})],Oc.prototype,"isGlobal",null),u([d({constructOnly:!0})],Oc.prototype,"allTiles",void 0),u([d({constructOnly:!0})],Oc.prototype,"ellipsoidRadius",void 0),u([d({value:!1})],Oc.prototype,"renderingDisabled",null),u([d()],Oc.prototype,"renderPatchBorders",null),u([d()],Oc.prototype,"cullBackFaces",null),u([d({value:sO.FRONT_TO_BACK})],Oc.prototype,"renderOrder",null),u([d()],Oc.prototype,"wireframe",null),Oc=u([P("esri.views.3d.terrain.TerrainRenderer")],Oc);const nht=Oc;function Doe(e,t,i){i[0]=e[0]*t[2]+t[0],i[1]=e[1]*t[3]+t[1],i[2]=e[2]*t[2],i[3]=e[3]*t[3]}const oht=O(),aht=O(),mx=O(),lht=O();class cht{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}}let zp=class extends Ee{constructor(e){super(e),this._handles=new qt}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(ae(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=ot(this._handles),this._waitTask=null}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(t=>!(!sR(t)||t.isRejected())&&!(t.isFulfilled()&&!uht(t,this.viewSpatialReference,this.viewingMode))&&(e=t,!((t==null?void 0:t.type)==="vector-tile"||LF(t)))),e)if(e.isResolved()){const t=vU(e,this.viewSpatialReference,this.viewingMode);if(_(t)){const i=new Rr(t.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const t=e.when().catch(()=>{}).then(()=>{t!==this._waitTask||this.destroyed||this._update()});this._waitTask=t}_lockTilingScheme(e){if(this.viewingMode===Ve.Global){const t=e.levels.length-1;e.spatialReference.isWebMercator?e=Rr.makeWebMercatorAuxiliarySphere(t):Db(e.spatialReference)&&(e=Rr.makeGCSWithTileSize(e.spatialReference,e.pixelSize,t))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(ae(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ve.Global){const e=this.extentHelper.viewSpatialReference,t=Db(e)||If(e)||$f(e);e.isWebMercator?this.tilingScheme=Rr.WebMercatorAuxiliarySphere:t&&(this.tilingScheme=Rr.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;_(e)&&!ub(e,this.extent)&&(this.tilingScheme=Rr.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function uht(e,t,i){return _(vU(e,t,i))}u([d()],zp.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],zp.prototype,"extent",void 0),u([d({value:!1})],zp.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],zp.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],zp.prototype,"layers",void 0),u([d({constructOnly:!0})],zp.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],zp.prototype,"viewingMode",void 0),zp=u([P("esri.views.3d.terrain.TilingSchemeLogic")],zp);class hht{constructor(){this.offset=tt(),this.scale=0,this.tile=null}init(t,i,r,s){this.tile=t,this.offset[0]=i,this.offset[1]=r,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}}const qh=me.getLogger("esri.views.3d.terrain.TerrainSurface"),dht=.25;let Kt=class extends us.EventedMixin(Ee){constructor(e){var t,i;super(e),this._elevationBounds=new bZ,this._iteratorPool=new ys(pxe,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new nct,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visible=!1,this._usedMemory=null,this._performanceInfo=new cht,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=O(),this._eyePosSurfaceSR=O(),this._splitLimits=new $ct,this._snapLevel=1/0,this._frustum=UM(),this._viewProjectionMatrix=Ae(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new qt,this._watchUpdatingTracking=new uf,this._frameTask=r2,this._allTiles=new Bt,this._upsampleInfoPool=new ys(hht),this._rootTilesExtent=Dt(),this._maxNumUpdating=1,this.maxTextureScale=1.2,this.backgroundColor=null,this._updatingRootTiles=!1,this.deferTileNeighborUpdate=!1,this.neighborTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this._layerViewsDirty=!1,this._isGlobal=!((i=(t=e.view)==null?void 0:t.state)==null?void 0:i.isLocal)}initialize(){this._lercDecoder=Plt(this.view.resourceController),this._tilePool=this.view.state.isLocal?new ys(uut):new ys(hut);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("esri.views.3d.terrain.upsample",s=>s.unloadMapData()),this._elevationQueryCache=new Mlt(e.newCache("elevation-query")),this._set("overlayManager",new ja({surface:this})),this._handles.add([ae(()=>this.overlayManager.hasHighlights,s=>this._renderer.setNeedsHighlight(s)),ae(()=>this.overlayManager.rendersOccluded,s=>this._renderer.setRenderOccludedOverlay(s))],"overlayManager"),this._renderer=new nht({overlayRenderer:this.overlayManager.renderer,ellipsoidRadius:vi(this.view.spatialReference).radius,stage:this.view._stage,allTiles:this._allTiles}),this._handles.add([ae(()=>this.baseOpacity,s=>{this._handleLayerViewChanges(),this._updateBaseOpacity(s)},Ms),ae(()=>this.hasCompositeBlendMode,()=>{this._updateBaseOpacity(this.baseOpacity)},Ms),ae(()=>this.renderingDisabled,()=>this._updateTransparentTerrain(),rr),ae(()=>this.backgroundColor,s=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(s)},Ms),ae(()=>this.view.pointsOfInterest,s=>{this._renderer.pointsOfInterest=s,this._watchUpdatingTracking.removeAll(),s&&this._watchUpdatingTracking.add(()=>s.focus.renderLocation,()=>()=>this._allTilesSorted=!1)}),ae(()=>zi.TERRAIN_TILE_TREE_SHOW_TILES,s=>{s&&!this._treeDebugger?import("./TerrainTileTree3DDebugger.4facc2dd.js").then(({TerrainTileTree3DDebugger:n})=>{!this._treeDebugger&&zi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new n({view:this.view}))}):s||(this._treeDebugger=ot(this._treeDebugger))},Ft)]),this._extentHelper=Wlt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:this.view.spatialReference});const t=this.view.defaultsFromMap?new i2({getCollections:()=>{var s,n,o;return(o=(n=(s=this.view)==null?void 0:s.defaultsFromMap)==null?void 0:n.mapCollections)==null?void 0:o.map(({layers:a})=>a)},getChildrenFunction:s=>s&&"layers"in s?s.layers:null}):this.view.map.allLayers,i=new zp({layers:t,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:this.view.spatialReference});this._set("tilingSchemeLogic",i),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(sf.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(sf.BASEMAP);const r=this.view.resourceController.scheduler;this._frameTask=r.registerTask(mt.TERRAIN_SURFACE,this),this._handles.add([ae(()=>this._extentHelper.stencilEnabledExtents,s=>this._renderer.setStencilEnabledLayerExtents(s),Ft),ae(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),rr),ae(()=>this.extent,()=>this._updateRootTiles(),Ft),this.view.on("resize",()=>this._viewChangeUpdate()),ae(()=>{var o,a;const s=this.view,n=s.state;return[this.lodBias,this.lodSnapping,(a=(o=s.resourceController)==null?void 0:o.memoryController)==null?void 0:a.memoryFactor,n.camera,n.contentCamera,n.fixedContentCamera]},()=>this._viewChangeUpdate(),Ms),ae(()=>{var s,n;return(n=(s=this.view.qualitySettings)==null?void 0:s.tiledSurface)==null?void 0:n.textureFadeDuration},s=>this._renderer.textureFadingEnabled=s>0,Ft),ae(()=>this._userClippingExtent,()=>this._updateClippingExtent(),rr)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=Wi(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=ot(this._upsampleMapCache),this._elevationQueryCache=ot(this._elevationQueryCache),this._set("tilingSchemeLogic",ot(this.tilingSchemeLogic)),this._extentHelper=ot(this._extentHelper),this._basemapLayerViewHandles.forEach((e,t)=>this._unregisterTiledLayerView(t)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",ot(this.overlayManager)),this._tilePool=ot(this._tilePool),SZ.prune(),this._treeDebugger&&(this._treeDebugger.destroy(),this._treeDebugger=null),this._renderer=ot(this._renderer),this._iteratorPool=ot(this._iteratorPool),this._set("view",null),this._upsampleInfoPool=ot(this._upsampleInfoPool),jlt(),Pct()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){var t,i;const e=(i=(t=this.view.pointsOfInterest)==null?void 0:t.contentCameraOnSurface)==null?void 0:i.scale;if(e){const r=this.view.state.contentCamera;let s=E5(this.view,r.eye,r.viewForward,r.up).tilt;s>90&&(s=180-s);const n=2*(s/90)**2,o=O_e(this.view,e)-n;Math.abs(this._snapLevel-o)>dht&&(Math.round(o)!==Math.round(this._snapLevel)&&(this._viewChanged=!0),this._snapLevel=o)}return Math.round(this._snapLevel)}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?A2.ON:A2.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:t}=this.view;if(R(t)||R(e))return null;const i=Dt(),r=Hwe(t,i,e)?i:null,s=this._get("extent");return ub(r,s)?s:r}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=H$(this.groundExtent,this._userClippingExtent,Dt()),t=this._get("extent");return ub(e,t)?t:e}get groundExtent(){return _(this._tilingSchemeExtent)?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){var e;return(e=this.tilingSchemeLogic)==null?void 0:e.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this._watchUpdatingTracking.updating||this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||this._asyncWorkItems>0||!this._allTilesSorted||this._layerViewsDirty)&&this.ready&&!this.suspended||this.overlayManager.updating||this._frameTask.updating)}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get viewingMode(){return this.view.state.viewingMode}get ready(){return _(this.rootTiles)}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get spatialReference(){var e,t;return(t=(e=this.tilingScheme)==null?void 0:e.spatialReference)!=null?t:null}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._updateTransparentTerrain()}_updateTransparentTerrain(){var t,i;const e=!this.renderingDisabled&&!this.opaque;(i=(t=this.view)==null?void 0:t._stage)==null||i.renderView.setRenderParameters({transparentTerrain:e})}set velvetOverground(e){e!==this.velvetOverground&&(this._renderer.velvetOverground=e),this._set("velvetOverground",e)}set visible(e){e!==this._visible&&(this._visible=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}intersect(e,t,i,r){this._renderer.intersect(e,t,i,r)}getElevation(e,t,i,r){const s=this.getTileWithElevation(e,t,i,r,ho);return R(s)?null:cxe(ho[0],ho[1],s.renderData.geometryState.samplerData)}getTileWithElevation(e,t,i,r,s=ho){var o;const n=this.rootTiles;if(R(n)||!n.length||n[0].layerInfo[Ht.ELEVATION].length===0)return null;if(s[0]=e,s[1]=t,s[2]=i,!Js(s,r,s,(o=this.tilingScheme)==null?void 0:o.spatialReference))return qh.error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null;for(let a of n){if(!a.containsPoint(s))continue;for(;a&&!a.rendered&&!a.isLeaf;){let c=0;s[0]>.5*(a.extent[0]+a.extent[2])&&(c+=1),s[1]<.5*(a.extent[1]+a.extent[3])&&(c+=2),a=a.children[c]}const l=a.renderData;return(l?l.geometryState.samplerData:null)?a:null}return null}get elevationBounds(){return this._elevationBounds}getScale(e){if(this.tilingScheme){if(!Mn(e,ho,this.spatialReference))return qh.error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const t=this.rootTiles;if(_(t)){for(let i of t)if(i==null?void 0:i.containsPoint(ho)){for(;!i.isLeaf&&!i.rendered;){let r=0;ho[0]>i.children[0].extent[2]&&(r+=1),ho[1]<i.children[0].extent[1]&&(r+=2),i=i.children[r]}return this._getLodBiasCorrectedScale(i.level)}}}return 1e100}getSphereElevationBounds(e,t,i,r,s){var c;if(ho[0]=e,ho[1]=t,ho[2]=i,ho[3]=r,!Js(ho,s,ho,(c=this.tilingScheme)==null?void 0:c.spatialReference))return qh.error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let n=1/0,o=-1/0;const a=h=>{if(h&&DQ(h.extent,ho))if(h.isLeaf||h.rendered)n=Math.min(n,h.elevationBounds[0]),o=Math.max(o,h.elevationBounds[1]);else for(const p of h.children)a(p)},l=this.rootTiles;if(_(l))for(const h of l)a(h);return{min:n,max:o}}getSphereScale(e,t){if(!this.tilingScheme)return null;if(!Mn(e,ho,this.spatialReference))return qh.error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;ho[3]=t;let i=null;const r=n=>{if(n&&DQ(n.extent,ho))if(n.isLeaf||n.rendered){const o=this._getLodBiasCorrectedScale(n.level);i=i==null?o:Math.min(i,o)}else for(const o of n.children)r(o)},s=this.rootTiles;if(_(s))for(const n of s)r(n);return i}queryVisibleScaleRange(e,t,i,r){const s=t?this.tilingScheme.levelAtScale(t):0,n=i?this.tilingScheme.levelAtScale(i):1/0,o=this.lodBias;this._renderer.queryVisibleLevelRange(e,s+o,n+o,r)}_updateBaseOpacity(e){const t=this._renderer.opaque;this._renderer.opaque=e>=1&&!this.hasCompositeBlendMode,this._renderer.isTransparent=this._allSurfaceLayersTransparent();const i=t!==this._renderer.opaque;i&&this._updateTransparentTerrain(),this._updateTileTextures(i?An.UNFADED:An.IMMEDIATE)}_updateTilingScheme(){var t,i;const e=this.tilingSchemeLogic.tilingScheme;e!==this.tilingScheme&&(Qp(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!((i=(t=this.view)==null?void 0:t.state)==null?void 0:i.isLocal),this.tilingScheme&&this._removeAllTiles(),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles()))}_acquireTile(e,t,i,r){const s=this._tilePool.acquire();return i$[0]=e,i$[1]=t,i$[2]=i,s.init(i$,r,this),s}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:t}=this;if(!t)return;const i=mht;let r=t.rootTilesInExtent(e,i,5*PT);if(_(this.rootTiles)){if(r.length>PT)return void qh.warn(CBe);const s=this.rootTiles.map(o=>o.lij),n=n2e(s,r,Loe);if(this._updatingRootTiles=!0,n.removed.length>0||n.added.length>0){const o=this.rootTiles.filter(a=>!(n.removed.findIndex(l=>Loe(l,a.lij))>-1)||(this._purgeTile(a,!0),!1));n.added.forEach(a=>o.push(this._newRootTile(a))),this._setRootTiles(o)}}else this._updatingRootTiles=!0,r.length>PT&&(qh.warn(ABe),r=t.rootTilesInExtent(e,i,PT)),this._setRootTiles(r.map(s=>this._newRootTile(s)));ub(i,this._rootTilesExtent)||(this._rootTilesExtent=Dt(i)),this.visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._allTiles.forEach(s=>{s.isLoaded&&this._prepareToLoadTile(s)}),this._allTiles.forAll(s=>{s.isLoaded&&(this._updateTileGeometry(s),this._updateTileNeighborsAfterGeometryChange(s))}),this._updatingRootTiles=!1,this.checkAllTileWaterproofness()}_newRootTile(e){const t=this._acquireTile(0,e[1],e[2],null);return t.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&t.setPendingUpdate(vt.SPLIT),this._loadTile(t),this.deferTileNeighborUpdate||t.checkGeometryWaterproofness(),t}_setRootTiles(e){if(this._set("rootTiles",e),this._allTiles.clear(),_(e)){const t=this._iteratorPool.acquire();for(t.reset(e);!t.done;)this._allTiles.push(t.next());t.remove()}this._renderer.setRootTiles(this.rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visible&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this.rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(e)}_updateTilesVisibility(e){if(R(e))return;const t=lct(e);let i=t?this._elevationBounds.min:1/0,r=t?this._elevationBounds.max:-1/0;const s=this.view.state.fixedContentCamera,n=this.extent,o=this._viewProjectionMatrix;this.setTileTreeDirty();const a=this._iteratorPool.acquire();for(a.reset(e);!a.done;){const l=a.next();l.updateClippingStatus(n)&&l.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometry(l),l.setPendingUpdate(vt.RENDERDATA);const c=l.computeVisibility();s||c?(l.updateScreenDepth(o),l.renderData&&(i=Math.min(l.elevationBounds[0],i),r=Math.max(l.elevationBounds[1],r))):a.skipSubtree()}a.remove(),this._viewChanged=!0,this._allTilesDirty=!0,isFinite(i)&&isFinite(r)&&(this._elevationBounds.min===i&&this._elevationBounds.max===r||(this._elevationBounds.min=i,this._elevationBounds.max=r,this.emit("elevation-bounds-change",null)))}_updateViewDependentParameters(){const e=this.view.state.camera,t=this.view.state.contentCamera,i=Math.tan(.5*t.fovX),r=Math.tan(.5*t.fovY),s=this.tilingScheme.pixelSize,n=2**-this.lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=r,this._splitLimits.relativeWidthLimit=s/e.width*this.maxTextureScale*n,this._splitLimits.relativeHeightLimit=s/e.height*this.maxTextureScale*n,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(R(this._splitLimits.frustum)&&(this._splitLimits.frustum=UM()),tF(this._splitLimits.frustum,t.frustum)):this._splitLimits.frustum=null,tF(this._frustum,e.frustum),Nr(this._viewProjectionMatrix,t.projectionMatrix,t.viewMatrix),se(this._eyePosRenderSR,t.eye),Js(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(zxe(e)?(this._loadChildren(e),this.deferTileNeighborUpdate||(this._checkTileNeighborsWaterproofness(e),e.children.forEach(t=>t.checkGeometryWaterproofness()))):fht(e)&&this._loadParent(e))}_updateTileGeometry(e){e.updateVisibility(),this._renderer.updateTileGeometry(e),this._updateTileNeighborsAfterGeometryChange(e),this._elevationUpdate(e),this._usedMemory=null,this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(e)}_updateTileNeighborsAfterGeometryChange(e,t){if(this.deferTileNeighborUpdate){const i=this.neighborTilesToUpdate;e.forEachLoadedNeighbor(r=>{i.add(r)})}else e.updateNeighborsAfterGeometryChange(t)}_updateTileTexture(e,t){const i=e.resetPendingUpdate(vt.TEXTURE_FADING)?vt.TEXTURE_FADING:!!e.resetPendingUpdate(vt.TEXTURE_NOFADING)&&vt.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,t.madeProgress())}_elevationUpdate(e){r$.spatialReference=this.spatialReference,r$.tile=e,r$.extent=e.extent,this.emit("elevation-change",r$)}get running(){return this.updating&&this.ready&&!this.suspended}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateTileStatus(e),this._sortTiles(e);const t=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,t),e.run(()=>this._updateElevation(e)),e.run(()=>this._updateTextures(e)),t||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),e.done?this.requestUpdate():this._usedMemory=this._recalculateUsedMemory(),this.notifyChange("updatingProgressValue")}_updateTileStatus(e){if(!this._viewChanged||!this.rootTiles||e.done)return;this._viewChanged=!1;const t=this._iteratorPool.acquire();for(t.reset(this.rootTiles);!t.done;){const i=t.next();if(i.loadable){const r=i.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping);if(r===vt.SPLIT){i.resetPendingUpdate(vt.MERGE),i.isLeaf&&(i.setPendingUpdate(vt.SPLIT),t.skipSubtree());continue}i.resetPendingUpdate(vt.SPLIT)&&i.updateAgentSuspension(),r===vt.VSPLITMERGE&&i.updateAgents(Ht.ELEVATION)}if(t.skipSubtree(),!i.isLeaf){i.setPendingUpdate(vt.MERGE),i.resetPendingUpdate(vt.SPLIT);const r=this._iteratorPool.acquire();r.resetOne(i);for(let s=r.next();!r.done;s=r.next())this._updateClippingStatus(s),s.updateVisibility(),s.loadable&&s.updateScreenDepth(this._viewProjectionMatrix);r.remove()}}t.remove(),this.requestUpdate(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(oct(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_prepareBatchTileGeometryUpdate(){this.neighborTilesToUpdate.size,this.deferTileNeighborUpdate=!0}_batchUpdateUpdatedTileNeighbors(){this.deferTileNeighborUpdate=!1;const e=this.neighborTilesToUpdate;(()=>{const t=()=>{for(const i of e)i.updateNeighborsWithChangedEdgeResolution()};(()=>{for(const i of e)i.updateNeighborDataAndGeometryIfNeeded()})(),t(),e.clear()})()}_mergeAndSplit(e,t){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate(),this._prepareBatchTileGeometryUpdate();let i=!1;for(;!e.done;){i=!0;let r=!1;const s=!this._allTiles.some(n=>{if(n.resetPendingUpdate(vt.MERGE)){if(!t)return n.setPendingUpdate(vt.MERGE),e.done;this._mergeTile(n),r=!0,e.madeProgress()}else n.resetPendingUpdate(vt.SPLIT)&&(this._splitTile(n),r=!0,e.madeProgress());return!e.done&&n.resetPendingUpdate(vt.RENDERDATA)&&(this._updateRenderData(n),e.madeProgress()),e.done});if(r&&(this._allTilesSorted=!1,this._allTilesDirty=!0),s){if(!r)break;this._updateTilesVisibility(this.rootTiles)}else this._allTilesDirty=!0}i||(this._allTilesDirty=!0),this._batchUpdateUpdatedTileNeighbors(),this._sortTiles(e)}_updateElevation(e){return this._prepareBatchTileGeometryUpdate(),this._allTiles.some(t=>(t.resetPendingUpdate(vt.GEOMETRY)&&(this._updateTileGeometry(t),this._updateTileTexture(t,e),e.madeProgress()),e.done)),this._batchUpdateUpdatedTileNeighbors(),e.hasProgressed}_updateTextures(e){return this._allTiles.some(t=>(this._updateTileTexture(t,e),e.done)),e.hasProgressed}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Rs.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*TBe}_getLodBiasCorrectedScale(e){const t=this.tilingScheme.levels,i=$e(e-this.lodBias,0,t.length-1),r=i-Math.floor(i);return t[Math.floor(i)].scale*(1-r)+t[Math.ceil(i)].scale*r}_removeAllTiles(){_(this.rootTiles)&&(this.rootTiles.forEach(e=>this._purgeTile(e,!1)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this.visible=!1}_purgeDescendantTiles(e){if(e.isLeaf)return!1;let t=!1;for(let i=0;i<4;++i)t=this._purgeTile(e.children[i],!1)||t;return e.unsetChildren(),t}_purgeTile(e,t){const i=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),t&&this._updateTileNeighborsAfterGeometryChange(e),this._tilePool.release(e),i}_unloadTile(e){this.deferTileNeighborUpdate&&this.neighborTilesToUpdate.delete(e),e.unload(this._renderer)}_splitTile(e){Qp(e.isLeaf,"tile that is already split should not be split again!");const t=e.level+1,i=2*e.lij[1],r=2*e.lij[2];e.setChildren(this._createTile(t,i,r,e),this._createTile(t,i,r+1,e),this._createTile(t,i+1,r,e),this._createTile(t,i+1,r+1,e)),e.setPendingUpdate(vt.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,this._emitTileScaleChange(e,t),++this._performanceInfo.numSplit}_emitTileScaleChange(e,t=e.level){s$.spatialReference=this.spatialReference,s$.extent=e.extent,s$.scale=this._getLodBiasCorrectedScale(t),this.emit("scale-change",s$)}_createTile(e,t,i,r){Qp(!!r,"_createTile sanity check");const s=this._acquireTile(e,t,i,r);return s.updateClippingStatus(this.extent),s.loadable&&(s.updateScreenDepth(this._viewProjectionMatrix),s.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.lodSnapping)===vt.SPLIT&&s.setPendingUpdate(vt.SPLIT)),s}_mergeTile(e){Qp(!e.hasPendingUpdate(vt.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(Qp(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._updateTileNeighborsAfterGeometryChange(e),this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e)),this._allTilesDirty=!0,++this._performanceInfo.numMerged,this._emitTileScaleChange(e)}_checkTileAndNeighborsWaterproofness(e){e.checkGeometryWaterproofness(),this._checkTileNeighborsWaterproofness(e)}_checkTileNeighborsWaterproofness(e){}_loadChildren(e){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e),Qp(e.rendered,"parent should be rendered"),this._unloadTile(e);const t=e.children;t.forEach(i=>this._prepareToLoadTile(i)),t.forEach(i=>this._loadTilePrepared(i)),this._updateTileNeighborsAfterGeometryChange(e,e.level+1),this.deferTileNeighborUpdate||(t.forEach(i=>i.updateNeighborsWithChangedEdgeResolution()),t.forEach(i=>i.checkGeometryWaterproofness()),this._checkTileNeighborsWaterproofness(e))}_loadParent(e){this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(e);const t=e.parent;this._unloadChildren(t),this._loadTile(t),this._updateTileNeighborsAfterGeometryChange(t),this.deferTileNeighborUpdate||this._checkTileAndNeighborsWaterproofness(t)}_unloadChildren(e){if(!e.isLeaf)for(let t=0;t<4;++t){const i=e.children[t];this._unloadChildren(i),this._unloadTile(i)}}_postLoadTile(e){e.setPendingUpdate(vt.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e),this._elevationUpdate(e)}_loadTile(e){e.load(this._renderer),this._postLoadTile(e)}_loadTilePrepared(e){e.loadPrepared(this._renderer),this._postLoadTile(e)}_prepareToLoadTile(e){e.prepareToLoad(this._renderer)}_elevationDataArrived(e,t,i){const r=new qlt(e.lij,e.extent,i);e.dataArrived(t,Ht.ELEVATION,r);const s=[e],n=e.level,o=this._iteratorPool.acquire();for(o.reset(s);!o.done;){const a=o.next();a.findElevationBoundsForLayer(t,n),a.computeElevationBounds()}o.remove(),this._updateTilesVisibility(s)}_handleLayerViewChanges(e=rE){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let t=!1;const i=new Set;let r=-1;for(const s of this.view.allLayerViews.items)if(i.add(s.uid),iO(s))if(this._basemapLayerViewHandles.has(s.uid)){const n=this._layerClassFromLayerView(s),o=this._getLayerIdxByUID(n,s.uid);_(o)&&((o<r||R(r))&&(t=!0),r=o)}else this._registerTiledLayerView(s),s.layer.loaded&&(t=!0);this._basemapLayerViewHandles.forEach((s,n)=>{i.has(n)||(this._unregisterTiledLayerView(n),t=!0)}),t&&this._updateTiledLayers(),this._renderer.isTransparent=this._allSurfaceLayersTransparent(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),e.madeProgress()}_allSurfaceLayersTransparent(){var t,i;let e=((i=(t=this.view.map)==null?void 0:t.ground)==null?void 0:i.opacity)===0;for(const r of this.view.allLayerViews.items)if(wj(r)&&!zpe(r.layer)&&r.fullOpacity!==0)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if(NF(e)){const t=nxe(e.layer.parent)?"normal":e.layer.blendMode;if(uct(uL[t]))return!0}return!1}_layerClassFromLayerView(e){return bj(e)?Ht.ELEVATION:Ht.MAP}_registerTiledLayerView(e){const t=[],i=this._layerClassFromLayerView(e);t.push(ae(()=>e.suspended,()=>this._updateTiledLayers())),t.push(ae(()=>e.fullOpacity,()=>this._updateTileTextures(An.UNFADED))),t.push(ae(()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),NF(e)&&t.push(ae(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures(An.UNFADED)})),e.on("data-changed",()=>{const r=this._getLayerIdxByUID(i,e.uid);_(r)&&this._invalidateLayerData(r,i)}),this._basemapLayerViewHandles.set(e.uid,t)}_unregisterTiledLayerView(e){const t=this._basemapLayerViewHandles.get(e);if(t){for(let i=0;i<t.length;i++)t[i].remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,t=[[],[]];let i=null;e.forEach(r=>{if(!r.layer||r.suspended||!iO(r)||!r.fullExtent)return;const s=this._layerClassFromLayerView(r);if(s===Ht.MAP){const n=r.displayLevelRange.maxLevel;n!==1/0&&(i===null||n>i)&&(i=n)}t[s].push(r)});for(const r of g1){const s=this._layerViews[r],n=t[r];n.reverse();const o=n.length;let a=s.length!==o;const l=new Array(o),c=new Array(s.length);this._layerIndexByUid[r].clear();for(let h=0;h<o;h++){const p=n[h].uid;this._layerIndexByUid[r].set(p,h);const f=s.indexOf(n[h]);l[h]=f,h!==f&&(a=!0),f>-1&&(c[f]=h)}if(a){const h=this._postorderIterator;for(h.reset(this.rootTiles);!h.done;)h.next().modifyLayers(c,l,r);this._layerViews[r]=n,this._restartAllAgents(r),this._updateTilesVisibility(this.rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const t=this._postorderIterator;for(t.reset(this.rootTiles);!t.done;){const i=t.next();i.restartAgents(e),e===Ht.ELEVATION&&i.computeElevationBounds()}}layerViewByIndex(e,t){return this._layerViews[t][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(t=>{t.updateAgents(Ht.MAP),e===An.IMMEDIATE?this.renderer.updateTileTexture(t,vt.TEXTURE_NOFADING):t.updateRenderData(Ht.MAP,e)}),this._renderer.isTransparent=this._allSurfaceLayersTransparent()}_invalidateLayerData(e,t){this._allTiles.forAll(i=>i.removeLayerAgent(e,t)),this._allTiles.forAll(i=>i.invalidateLayerData(e,t))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Rs.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,t,i,r){const s=this.layerViewByIndex(t,i),n=s.layer;return!n.tilemapCache||tO(s)?this._requestTileData(e,i,s,r):(++this._asyncWorkItems,n.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],ve(F({},r),{timeout:6e3})).then(()=>--this._asyncWorkItems).catch(o=>{throw--this._asyncWorkItems,Gr(o)||this._dataMissing(e,i,s,{notInTilemap:!0}),o}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,s,r),r.signal)))}_requestTileData(e,t,i,r){return t===Ht.ELEVATION?bj(i)?this._requestElevationTileData(e,i,r):Promise.reject():wj(i)?this._requestMapTileData(e,i,r):Promise.reject()}_requestElevationTileData(e,t,i){++this._asyncWorkItems;const r=o=>{if(Xs(i))return;const a=this._layerIndexByUid[Ht.ELEVATION].get(t.uid);a!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,a,o)):qh.warn("TerrainSurface: received data from unknown layer %d %s",Ht.ELEVATION,e.lij.toString())},s=o=>{Gr(o)||(this._dataMissing(e,Ht.ELEVATION,t,o),this.requestUpdate())};if(noe(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:fM,signal:i.signal}).then(o=>{if(!Xs(i))return this._frameTask.schedule(()=>r(o),i.signal,s);qh.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},s).finally(()=>{--this._asyncWorkItems});const n=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(n,"binary",i).then(o=>this._lercDecoder.decode(o,{noDataValue:fM},i.signal)).then(o=>{o?r({values:o.pixelData,width:o.width,height:o.height,noDataValue:o.noDataValue,minValue:o.minValue,maxValue:o.maxValue}):s(new Error("LERC decoding failed"))},s).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(e,t,i){++this._asyncWorkItems;const r=(c,h)=>{--this._asyncWorkItems,dS(h),Xs(i)||(this._dataMissing(e,Ht.MAP,t,c),this.requestUpdate())},s=c=>h=>r(h,c),n=c=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),Xs(i)?dS(c):this._mapTileDataArrived(e,t,c)},i.signal,s(c)).catch(s(c)),o=(c,h=null)=>this._frameTask.schedule(()=>r(c,h));if(tO(t)){const c=t.schemaHelper.getLevelRowColumn(e.lij);return t.fetchTile(c[0],c[1],c[2],i).then(n,o)}if(yU(t))return t.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(n,o);if(vZ(t)&&noe(t.layer))return t.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(c=>{if(Xs(i))return qh.warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void o(ui());n(c)},o);let a=t.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);qze(t.layer)&&t.layer.refreshTimestamp&&(a+=`${a.includes("?")?"&":"?"}_ts=${t.layer.refreshTimestamp}`);const l=t.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(a,l,i).then(n,o)}_mapTileDataArrived(e,t,i){const r=this._getLayerIdxByUID(Ht.MAP,t.uid);_(r)?e.dataArrived(r,Ht.MAP,i):(dS(i),qh.warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,t){return this._layerIndexByUid[e].get(t)}_dataMissing(e,t,i,r){const s=this._getLayerIdxByUID(t,i.uid);_(s)?e.dataMissing(s,t,r):qh.warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this.rootTiles&&this.overlayManager&&(this._allTiles.forAll(t=>{t.renderData&&this.overlayManager.setTileParameters(t)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(t=>{t.isLeaf&&e.numLeaves++;const i=t.level;t.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),t.visible&&(e.numVisible++,t.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}getUsedMemory(){return this.tilingScheme?(R(this._usedMemory)&&(this._usedMemory=this._recalculateUsedMemory()),_(this._usedMemory)?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce((e,t)=>e+t.usedMemory,0):null}getUsedMemoryForLayerView(e){let t=0;const i=this._layerClassFromLayerView(e),r=this._getLayerIdxByUID(i,e.uid);return _(r)&&this._allTiles.forAll(s=>t+=s.getUsedMemoryForLayer(i,r)),t}getTile(e){if(R(e)||R(this.rootTiles))return null;const t=e.split("/").map(o=>+o);if(t[0]===0)return this.rootTiles.find(o=>o.lij[1]===t[1]&&o.lij[2]===t[2]);const i=2**t[0],r=Math.floor(t[1]/i),s=Math.floor(t[2]/i);let n;if(this.rootTiles.some(o=>o.lij[1]===r&&o.lij[2]===s&&(n=o,!0)),n){let o=1<<t[0]-1;for(;n.lij[0]<t[0];){let a=t[1]&o?2:0;if((t[2]&o)>0&&a++,!n.children[a])return null;n=n.children[a],o>>=1}return Qp(n.lij[0]===t[0]&&n.lij[1]===t[1]&&n.lij[2]===t[2],"not the right tile?"),n}return null}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{_(e.rootTiles)&&(e._mergeTile(e.rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){EV.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&EV.push(i)});const t=EV.toArray();return mxe(e.renderOrder,t),t},lockTilingScheme(t,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(t)}}}checkAllTileWaterproofness(){}get isGlobal(){return this._isGlobal}get shadingEnabled(){return this._renderer.shadingEnabled}get isWebMercator(){var e;return!!((e=this.tilingScheme)==null?void 0:e.spatialReference.isWebMercator)}get isWebMercatorOnPlateeCarree(){var e;return this.isWebMercator&&HR((e=this.view)==null?void 0:e.renderSpatialReference)}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&e[2]===0}lijEastEnd(e){return 2**(e+(this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const t=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<t)return e;if(!this.isGlobal)return null;const r=(i+(i<0?t:0))%t;return[e[0],e[1],r]}};u([d()],Kt.prototype,"_renderer",void 0),u([d()],Kt.prototype,"_hasPendingUpdates",void 0),u([d()],Kt.prototype,"_asyncWorkItems",void 0),u([d()],Kt.prototype,"_allTilesDirty",void 0),u([d()],Kt.prototype,"_allTilesSorted",void 0),u([d()],Kt.prototype,"_viewChanged",void 0),u([d({readOnly:!0})],Kt.prototype,"_watchUpdatingTracking",void 0),u([d()],Kt.prototype,"_frameTask",void 0),u([d({readOnly:!0})],Kt.prototype,"snapLevel",null),u([d({readOnly:!0})],Kt.prototype,"lodSnapping",null),u([d({constructOnly:!0})],Kt.prototype,"view",void 0),u([d()],Kt.prototype,"_userClippingExtent",null),u([d()],Kt.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],Kt.prototype,"extent",null),u([d({readOnly:!0})],Kt.prototype,"groundExtent",null),u([d({readOnly:!0})],Kt.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],Kt.prototype,"updating",null),u([d(Hlt)],Kt.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],Kt.prototype,"updatingProgressValue",null),u([d()],Kt.prototype,"_maxNumUpdating",void 0),u([d({aliasOf:"view.map.ground.opacity"})],Kt.prototype,"baseOpacity",void 0),u([d()],Kt.prototype,"hasCompositeBlendMode",void 0),u([d({readOnly:!0})],Kt.prototype,"overlayManager",void 0),u([d({readOnly:!0})],Kt.prototype,"viewingMode",null),u([d()],Kt.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],Kt.prototype,"ready",null),u([d({value:sO.FRONT_TO_BACK})],Kt.prototype,"renderOrder",null),u([d({readOnly:!0})],Kt.prototype,"rootTiles",void 0),u([d({readOnly:!0})],Kt.prototype,"spatialReference",null),u([d({type:qe,aliasOf:"view.map.ground.surfaceColor"})],Kt.prototype,"backgroundColor",void 0),u([d({value:!1})],Kt.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],Kt.prototype,"tilingScheme",void 0),u([d({readOnly:!0,aliasOf:"tilingSchemeLogic.tilingSchemeLocked"})],Kt.prototype,"tilingSchemeLocked",void 0),u([d({readOnly:!0})],Kt.prototype,"tilingSchemeLogic",void 0),u([d({value:!0})],Kt.prototype,"velvetOverground",null),u([wt("_renderer.wireframe")],Kt.prototype,"wireframe",void 0),u([d({value:!1})],Kt.prototype,"suspended",null),u([d({readOnly:!0,aliasOf:"view.qualitySettings.tiledSurface.textureFadeDuration"})],Kt.prototype,"textureFadeDuration",void 0),u([d()],Kt.prototype,"_layerViewsDirty",void 0),u([wt("_renderer.renderPatchBorders")],Kt.prototype,"renderPatchBorders",void 0),u([wt("_renderer.renderingDisabled")],Kt.prototype,"renderingDisabled",void 0),Kt=u([P("esri.views.3d.terrain.TerrainSurface")],Kt);const pht=Kt;function Loe(e,t){return e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]}function zxe(e){return!e.isLeaf&&(e.children.some(t=>t.shouldLoad)||e.children.some(t=>zxe(t)))}function fht(e){return e.isLeaf&&e.parent&&e.parent.shouldLoad}const ho=Gt(),mht=Dt(),i$=[0,0,0],EV=new Bt,r$={spatialReference:null,tile:null,extent:null,context:"ground"},s$={spatialReference:null,extent:null,scale:0};let UA=class extends Ee{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commit(e){this.dirty=!1,this._dirtyGeomRecords.forEach((t,i)=>this.commitLayer(i,e))}commitLayer(e,t){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((r,s)=>{const n=this._ensureGeomRecord(e,s);r.forEach((o,a)=>{const l=o[0],c=o[1],h=o[2];let p=!1;if(c&Zt.Geometry.UPDATE){const f=n.get(a);if(f){const m=f[1];if(h&Zt.State.TRANSFORMATION){const y=this.model.getObject(s);this.model.updateRenderGeometryTransformation(y,l,m)&&(p=!0)}p||t.updates.push({renderGeometry:m,updateType:h})}else dt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(c&Zt.Geometry.REMOVE||p){const f=n.get(a);f?(t.removes.push(f[1]),n.delete(a),f[0].disposed&&Kb.pool.release(f[0])):c===Zt.Geometry.REMOVE&&dt(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(c&Zt.Geometry.ADD||p){const f=this.model.getObject(s);if(_(f)){const m=this.model.getRenderGeometry(f,l),y=[l,m];t.adds.push(m),n.set(a,y)}}}),n.size===0&&this._residentGeomRecords.get(e).delete(s)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e))}getResidentRenderGeometries(e,t){const i=this._residentGeomRecords.get(e);i&&i.forEach(r=>r.forEach(s=>t.push(s[1])))}_objectStateChanged(e,t){for(const i of t.geometryRecords)this._updateOrCreateDirtyRecord(t,i,null,Zt.Geometry.UPDATE,0,0,Zt.Geometry.UPDATE,Zt.Geometry.ADD|Zt.Geometry.REMOVE,e)}visibilityChanged(e){this._objectStateChanged(Zt.State.VISIBILITIES,e)}highlightChanged(e){this._objectStateChanged(Zt.State.HIGHLIGHTS,e)}occlusionChanged(e){this._objectStateChanged(Zt.State.OCCLUDEES,e)}vertexAttrsUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.record,null,Zt.Geometry.UPDATE,0,0,Zt.Geometry.UPDATE,Zt.Geometry.ADD|Zt.Geometry.REMOVE,Zt.State.VERTEXATTRS)}layerAdded(e){e.objects.forAll(t=>this._layerObjectAdded(e,t))}layerRemoved(e){e.objects.forAll(t=>this._layerObjectRemoved(e,t))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryAdded(t,r,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const t of e.objects)this._layerObjectAdded(e.layer,t)}layerObjectsRemoved(e){for(const t of e.objects)this._layerObjectRemoved(e.layer,t)}_layerObjectRemoved(e,t){const i=e.id;for(const r of t.geometryRecords)this._objectGeometryRemoved(t,r,i)}shaderTransformationChanged(e){const t=this._residentGeomRecords.get(e.id);t&&t.forEach((i,r)=>{const s=this.model.getObject(r);s&&s.hasVolativeTransformation()&&i.forEach(n=>{n[1].shaderTransformationChanged()})})}objectTransformation(e){const t=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(t,i).forEach(r=>{this._updateOrCreateDirtyRecord(e,r[0],t,Zt.Geometry.UPDATE,0,0,Zt.Geometry.UPDATE,Zt.Geometry.ADD|Zt.Geometry.REMOVE,Zt.State.TRANSFORMATION)})}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.record)}_objectGeometryAdded(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Zt.Geometry.ADD,Zt.Geometry.REMOVE,0,0,0)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.record)}_objectGeometryRemoved(e,t,i=null){this._updateOrCreateDirtyRecord(e,t,i,Zt.Geometry.REMOVE,Zt.Geometry.ADD,Zt.Geometry.UPDATE,0,0)}_updateOrCreateDirtyRecord(e,t,i,r,s,n,o,a,l){i=yt(i,this._getParentLayerId(e));const c=e.id,h=t.id,p=this._ensureDirtyRecord(i,c),f=p.get(h);if(f){const m=f[1];m&s?(p.delete(h),f[0].disposed&&Kb.pool.release(f[0])):m&n?(f[1]=r,f[2]=l):m&o?f[2]|=l:m&a||dt(!1,"ModelDirtySet.objectGeometryAdded: inconsistent state")}else p.set(h,[t,r,l]);this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,t){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}get _hasDirtyGeometryRecords(){return Ws(this._dirtyGeomRecords,e=>Ws(e,t=>t&&t.size>0))}_ensureDirtyRecord(e,t){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let r=i.get(t);return r||(r=new Map,i.set(t,r)),r}_getParentLayerId(e){return _(e.parentLayer)?e.parentLayer.id:K2e}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let t="";return this._dirtyGeomRecords.forEach((i,r)=>{i.forEach((s,n)=>{t.length>0&&(t+=`
`),t+=r+"."+n;const o=[];s.forEach(a=>{const l=a[1];o[l]||(o[l]=[]),o[l].push(a[0].geometry.id)});for(let a=0;a<o.length;a++)if(o[a]){t+=" "+e[a-1]+": ";for(let l=0;l<o[a].length;l++)t+=o[a][l]+", "}})}),t}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((t,i)=>t+i.size,0)}}}};u([d({constructOnly:!0})],UA.prototype,"model",void 0),u([d()],UA.prototype,"dirty",void 0),UA=u([P("esri.views.3d.webgl-engine.lib.ModelDirtySet")],UA);const ght=UA;let mL=class extends Ee{constructor(){super(...arguments),this.dirtySet=new ght({model:this}),this._content=new Map,this._originFactory=new XY(null,75e4)}getObject(e){return this._content.get(e)}add(e){const t=e.id;dt(!this._content.has(t),"Model/Stage already contains object to be added"),this._content.set(t,e),bF(e)&&this.dirtySet.layerAdded(e)}remove(e){dt(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),bF(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const t of e)_(t)&&(dt(!this._content.has(t.id),"Model/Stage already contains object to be added"),this._content.set(t.id,t))}removeMany(e){for(const t of e)dt(this._content.has(t.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(t.id),t.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,t){this._content.forEach(i=>{i.type===e&&t(i)})}getRenderGeometry(e,t){const{geometry:i,material:r,id:s,shaderTransformation:n,origin:o,instanceParameters:a}=t,l=new O2(i,r,{id:s,boundingInfo:i.boundingInfo,calculateShaderTransformation:n,castShadow:e.castShadow});return l.updateTransformation(c=>e.getCombinedStaticTransformation(t,c)),l.origin=o||this._originFactory.getOrigin(l.boundingSphere),l.instanceParameters=a,l}updateRenderGeometryTransformation(e,t,i){if(R(e))return!1;i.updateTransformation(s=>e.getCombinedStaticTransformation(t,s));const r=this._originFactory.getOrigin(i.boundingSphere);return i.origin!==r}getStats(){const e={},t=Array.from(this._content.values());for(let i=0;i<Kd.COUNT;++i)e[i]=t.filter(r=>r.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],mL.prototype,"dirtySet",void 0),mL=u([P("esri.views.3d.webgl-engine.parts.Model")],mL);function Vxe(){const e=new Float32Array(4);return e[3]=1,e}function Bxe(e){const t=new Float32Array(4);return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function yht(e,t,i,r){const s=new Float32Array(4);return s[0]=e,s[1]=t,s[2]=i,s[3]=r,s}function Gxe(e,t){return new Float32Array(e,t,4)}Object.freeze(Object.defineProperty({__proto__:null,create:Vxe,clone:Bxe,fromValues:yht,createView:Gxe},Symbol.toStringTag,{value:"Module"}));const ss=!0,nb={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16};function $Z(e,t,i){return{identifier:String.fromCharCode.apply(null,new Uint8Array(e,i+nb.identifierOffset,nb.identifierLength)),version:t.getUint16(i+nb.versionOffset,ss),checksum:t.getUint32(i+nb.checksumOffset,ss)}}const Ol={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};function vht(e,t){return{sizeLo:e.getUint32(t+Ol.sizeLo,ss),sizeHi:e.getUint32(t+Ol.sizeHi,ss),minX:e.getFloat64(t+Ol.minX,ss),minY:e.getFloat64(t+Ol.minY,ss),minZ:e.getFloat64(t+Ol.minZ,ss),maxX:e.getFloat64(t+Ol.maxX,ss),maxY:e.getFloat64(t+Ol.maxY,ss),maxZ:e.getFloat64(t+Ol.maxZ,ss),errorX:e.getFloat64(t+Ol.errorX,ss),errorY:e.getFloat64(t+Ol.errorY,ss),errorZ:e.getFloat64(t+Ol.errorZ,ss),count:e.getUint32(t+Ol.count,ss),reserved:e.getUint32(t+Ol.reserved,ss)}}function L1t(e){const t=new DataView(e,0);let i=0;const{identifier:r,version:s}=$Z(e,t,i);if(i+=nb.byteCount,r!=="LEPCC     ")throw new q("lepcc-decode-error","Bad identifier");if(s>1)throw new q("lepcc-decode-error","Unknown version");const n=vht(t,i);if(i+=Ol.byteCount,n.sizeHi*2**32+n.sizeLo!==e.byteLength)throw new q("lepcc-decode-error","Bad size");const o=new Float64Array(3*n.count),a=[],l=[],c=[],h=[];if(i=n$(e,i,a),i=n$(e,i,l),i=n$(e,i,c),i=n$(e,i,h),i!==e.byteLength)throw new q("lepcc-decode-error","Bad length");let p=0,f=0;for(let m=0;m<a.length;m++){f+=a[m];let y=0;for(let v=0;v<l[m];v++){y+=c[p];const w=h[p];o[3*p]=Math.min(n.maxX,n.minX+2*n.errorX*y),o[3*p+1]=Math.min(n.maxY,n.minY+2*n.errorY*f),o[3*p+2]=Math.min(n.maxZ,n.minZ+2*n.errorZ*w),p++}}return{errorX:n.errorX,errorY:n.errorY,errorZ:n.errorZ,result:o}}function n$(e,t,i){const r=[];t=Cj(e,t,r);const s=[];for(let n=0;n<r.length;n++){s.length=0,t=Cj(e,t,s);for(let o=0;o<s.length;o++)i.push(s[o]+r[n])}return t}function Cj(e,t,i){const r=new DataView(e,t),s=r.getUint8(0),n=31&s,o=!!(32&s),a=(192&s)>>6;let l=0;if(a===0)l=r.getUint32(1,ss),t+=5;else if(a===1)l=r.getUint16(1,ss),t+=3;else{if(a!==2)throw new q("lepcc-decode-error","Bad count type");l=r.getUint8(1),t+=2}if(o)throw new q("lepcc-decode-error","LUT not implemented");const c=Math.ceil(l*n/8),h=new Uint8Array(e,t,c);let p=0,f=0,m=0;const y=-1>>>32-n;for(let v=0;v<l;v++){for(;f<n;)p|=h[m]<<f,f+=8,m+=1;i[v]=p&y,p>>>=n,f-=n,f+n>32&&(p|=h[m-1]>>8-f)}return t+m}const y1={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};function _ht(e,t){return{sizeLo:e.getUint32(t+y1.sizeLo,ss),sizeHi:e.getUint32(t+y1.sizeHi,ss),count:e.getUint32(t+y1.count,ss),colorMapCount:e.getUint16(t+y1.colorMapCount,ss),lookupMethod:e.getUint8(t+y1.lookupMethod),compressionMethod:e.getUint8(t+y1.compressionMethod)}}function bht(e){const t=new DataView(e,0);let i=0;const{identifier:r,version:s}=$Z(e,t,i);if(i+=nb.byteCount,r!=="ClusterRGB")throw new q("lepcc-decode-error","Bad identifier");if(s>1)throw new q("lepcc-decode-error","Unknown version");const n=_ht(t,i);if(i+=y1.byteCount,n.sizeHi*2**32+n.sizeLo!==e.byteLength)throw new q("lepcc-decode-error","Bad size");if((n.lookupMethod===2||n.lookupMethod===1)&&n.compressionMethod===0){if(3*n.colorMapCount+n.count+i!==e.byteLength||n.colorMapCount>256)throw new q("lepcc-decode-error","Bad count");const o=new Uint8Array(e,i,3*n.colorMapCount),a=new Uint8Array(e,i+3*n.colorMapCount,n.count),l=new Uint8Array(3*n.count);for(let c=0;c<n.count;c++){const h=a[c];l[3*c]=o[3*h],l[3*c+1]=o[3*h+1],l[3*c+2]=o[3*h+2]}return l}if(n.lookupMethod===0&&n.compressionMethod===0){if(3*n.count+i!==e.byteLength||n.colorMapCount!==0)throw new q("lepcc-decode-error","Bad count");return new Uint8Array(e,i).slice()}if(n.lookupMethod<=2&&n.compressionMethod===1){if(i+3!==e.byteLength||n.colorMapCount!==1)throw new q("lepcc-decode-error","Bad count");const o=t.getUint8(i),a=t.getUint8(i+1),l=t.getUint8(i+2),c=new Uint8Array(3*n.count);for(let h=0;h<n.count;h++)c[3*h]=o,c[3*h+1]=a,c[3*h+2]=l;return c}throw new q("lepcc-decode-error","Bad method "+n.lookupMethod+","+n.compressionMethod)}const v1={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};function wht(e,t){return{sizeLo:e.getUint32(t+v1.sizeLo,ss),sizeHi:e.getUint32(t+v1.sizeHi,ss),count:e.getUint32(t+v1.count,ss),scaleFactor:e.getUint16(t+v1.scaleFactor,ss),bitsPerPoint:e.getUint8(t+v1.bitsPerPoint),reserved:e.getUint8(t+v1.reserved)}}function xht(e){const t=new DataView(e,0);let i=0;const{identifier:r,version:s}=$Z(e,t,i);if(i+=nb.byteCount,r!=="Intensity ")throw new q("lepcc-decode-error","Bad identifier");if(s>1)throw new q("lepcc-decode-error","Unknown version");const n=wht(t,i);if(i+=v1.byteCount,n.sizeHi*2**32+n.sizeLo!==e.byteLength)throw new q("lepcc-decode-error","Bad size");const o=new Uint16Array(n.count);if(n.bitsPerPoint===8){if(n.count+i!==e.byteLength)throw new q("lepcc-decode-error","Bad size");const a=new Uint8Array(e,i,n.count);for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}else if(n.bitsPerPoint===16){if(2*n.count+i!==e.byteLength)throw new q("lepcc-decode-error","Bad size");const a=new Uint16Array(e,i,n.count);for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}else{const a=[];if(Cj(e,i,a)!==e.byteLength)throw new q("lepcc-decode-error","Bad size");for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}return o}const Aj=me.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function Tht(e,t,i){let r="",s=0;for(;s<i;){const n=e[t+s];if(n<128)r+=String.fromCharCode(n),s++;else if(n>=192&&n<224){if(s+1>=i)throw new q("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const o=(31&n)<<6|63&e[t+s+1];r+=String.fromCharCode(o),s+=2}else if(n>=224&&n<240){if(s+2>=i)throw new q("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(15&n)<<12|(63&e[t+s+1])<<6|63&e[t+s+2];r+=String.fromCharCode(o),s+=3}else{if(!(n>=240&&n<248))throw new q("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(s+3>=i)throw new q("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(7&n)<<18|(63&e[t+s+1])<<12|(63&e[t+s+2])<<6|63&e[t+s+3];if(o>=65536){const a=55296+(o-65536>>10),l=56320+(1023&o);r+=String.fromCharCode(a,l)}else r+=String.fromCharCode(o);s+=4}}}return r}function jxe(e,t){const i={byteOffset:0,byteCount:0,fields:Object.create(null)};let r=0;for(let s=0;s<t.length;s++){const n=t[s],o=n.valueType||n.type,a=Pht[o];i.fields[n.property]=a(e,r),r+=EU[o].BYTES_PER_ELEMENT}return i.byteCount=r,i}function Sht(e,t,i){const r=[];let s,n,o=0;for(n=0;n<e;n+=1){if(s=t[n],s>0){if(r.push(Tht(i,o,s-1)),i[o+s-1]!==0)throw new q("string-array-error","Invalid string array: missing null termination.")}else r.push(null);o+=s}return r}function Noe(e,t){return new EU[t.valueType](e,t.byteOffset,t.count*t.valuesPerElement)}function Eht(e,t){return new Uint8Array(e,t.byteOffset,t.byteCount)}function Cht(e,t,i){const r=t.header!=null?jxe(e,t.header):{byteOffset:0,byteCount:0,fields:{count:i}},s={header:r,byteOffset:r.byteCount,byteCount:0,entries:Object.create(null)};let n=r.byteCount;for(let o=0;o<t.ordering.length;o++){const a=t.ordering[o],l=te(t[a]);if(l.count=r.fields.count,l.valueType==="String"){if(l.byteOffset=n,l.byteCount=r.fields[a+"ByteCount"],l.encoding!=="UTF-8")throw new q("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding})}else{if(!qxe(l.valueType))throw new q("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});{const c=gL(l.valueType);n+=n%c!=0?c-n%c:0,l.byteOffset=n,l.byteCount=c*l.valuesPerElement*l.count}}n+=l.byteCount,s.entries[a]=l}return s.byteCount=n-s.byteOffset,s}function Hxe(e,t,i){if(t!==e&&Aj.error(`Invalid ${i} buffer size
 expected: ${e}, actual: ${t})`),t<e)throw new q("buffer-too-small","Binary buffer is too small",{expectedSize:e,actualSize:t})}function Aht(e){return{isDraco:!1,isLegacy:!1,color:e.color!=null,normal:e.normal!=null,uv0:e.uv0!=null,uvRegion:e.uvRegion!=null,featureIndex:e.faceRange!=null&&e.featureId!=null}}function N1t(e,t){const i=jxe(e,t&&t.header);let r=i.byteCount;const s={isDraco:!1,header:i,byteOffset:i.byteCount,byteCount:0,vertexAttributes:{}},n=i.fields,o=n.vertexCount!=null?n.vertexCount:n.count;for(const c of t.ordering){if(!t.vertexAttributes[c])continue;const h=ve(F({},t.vertexAttributes[c]),{byteOffset:r,count:o}),p=Foe[c]?Foe[c]:"_"+c;s.vertexAttributes[p]=h,r+=gL(h.valueType)*h.valuesPerElement*o}const a=n.faceCount;if(t.faces&&a){s.faces={};for(const c of t.ordering){if(!t.faces[c])continue;const h=ve(F({},t.faces[c]),{byteOffset:r,count:a});s.faces[c]=h,r+=gL(h.valueType)*h.valuesPerElement*a}}const l=n.featureCount;if(t.featureAttributes&&t.featureAttributeOrder&&l){s.featureAttributes={};for(const c of t.featureAttributeOrder){if(!t.featureAttributes[c])continue;const h=ve(F({},t.featureAttributes[c]),{byteOffset:r,count:l});s.featureAttributes[c]=h,r+=(h.valueType==="UInt64"?8:gL(h.valueType))*h.valuesPerElement*l}}return Hxe(r,e.byteLength,"geometry"),s.byteCount=r-s.byteOffset,s}function F1t(e,t){return!e||!e.compressedAttributes||e.compressedAttributes.encoding!=="draco"?e?Aht(e):Rht(t):Mht(e.compressedAttributes.attributes)}function Rht(e){const t={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const i of e.ordering)if(e.vertexAttributes[i])switch(i){case"position":break;case"normal":t.normal=!0;break;case"color":t.color=!0;break;case"uv0":t.uv0=!0;break;case"region":t.uvRegion=!0}return e.featureAttributes&&e.featureAttributeOrder&&(t.featureIndex=!0),t}function Mht(e){const t={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const i of e)switch(i){case"position":break;case"normal":t.normal=!0;break;case"uv0":t.uv0=!0;break;case"color":t.color=!0;break;case"uv-region":t.uvRegion=!0;break;case"feature-index":t.featureIndex=!0}return t}const Foe={position:A.POSITION,normal:A.NORMAL,color:A.COLOR,uv0:A.UV0,region:A.UVREGION};function Oht(e,t,i){if(e.encoding==="lepcc-rgb")return bht(t);if(e.encoding==="lepcc-intensity")return xht(t);if(e.encoding!=null&&e.encoding!=="")throw new q("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");e["attributeByteCounts "]&&!e.attributeByteCounts&&(Aj.warn("Warning: Trailing space in 'attributeByteCounts '."),e.attributeByteCounts=e["attributeByteCounts "]),e.ordering[0]==="ObjectIds"&&e.hasOwnProperty("objectIds")&&(Aj.warn("Warning: Case error in objectIds"),e.ordering[0]="objectIds");const r=Cht(t,e,i);Hxe(r.byteOffset+r.byteCount,t.byteLength,"attribute");const s=r.entries.attributeValues||r.entries.objectIds;if(s){if(s.valueType==="String"){const n=r.entries.attributeByteCounts,o=Noe(t,n),a=Eht(t,s);return Sht(n.count,o,a)}return Noe(t,s)}throw new q("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}const EU={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},Pht={Float32:(e,t)=>new DataView(e,0).getFloat32(t,!0),Float64:(e,t)=>new DataView(e,0).getFloat64(t,!0),UInt8:(e,t)=>new DataView(e,0).getUint8(t),Int8:(e,t)=>new DataView(e,0).getInt8(t),UInt16:(e,t)=>new DataView(e,0).getUint16(t,!0),Int16:(e,t)=>new DataView(e,0).getInt16(t,!0),UInt32:(e,t)=>new DataView(e,0).getUint32(t,!0),Int32:(e,t)=>new DataView(e,0).getInt32(t,!0)};function qxe(e){return EU.hasOwnProperty(e)}function gL(e){return qxe(e)?EU[e].BYTES_PER_ELEMENT:0}function Iht(e,t,i,r){const s=$ht(e,t,i),n=Ae();return fu(i,s,n,r),n}const Wxe=1,Uoe=5-Wxe;function $ht(e,t,i){const r=O(),s=e[3],n=2**(Math.ceil(Math.log(s)*Math.LOG2E/Uoe)*Uoe+Wxe);if(i.isGeographic){const l=n/vi(i).radius*180/Math.PI,c=Math.round(e[1]/l),h=Math.max(-90,Math.min(90,c*l)),p=l/Math.cos((Math.abs(h)-l/2)/180*Math.PI),f=Math.round(e[0]/p)*p;r[0]=f,r[1]=h}else{const l=Math.round(e[0]/n),c=Math.round(e[1]/n);r[0]=l*n,r[1]=c*n}const o=e[2]+t,a=Math.round(o/n);return r[2]=a*n,r}const D2=1e-6,gC=[0,0,0],o$=[0,0,0];function Dht(e,t){const{data:i,size:r}=e,s=i.length/r;if(s<=0)return;const n=new Ght(e);yL(gC,n.minProj,n.maxProj),G1(gC,gC,.5),uh(o$,n.maxProj,n.minProj);const o=Rj(o$),a=new jht;a.quality=o,s<14&&(e={data:new Float64Array(n.buffer,112,42),size:3});const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],m=[0,0,0],y=[0,0,0];switch(Lht(n,e,y,l,c,h,p,f,m,a)){case 1:return void Boe(gC,o$,t);case 2:return void Bht(e,p,t)}Nht(e,y,l,c,h,p,f,m,a),Xxe(e,a.b0,a.b1,a.b2,yS,vS);const v=[0,0,0];uh(v,vS,yS),a.quality=Rj(v),a.quality<o?Yxe(a.b0,a.b1,a.b2,yS,vS,v,t):Boe(gC,o$,t)}function Lht(e,t,i,r,s,n,o,a,l,c){return Fht(e,r,s),Mj(r,s)<D2?1:(uh(o,r,s),yo(o,o),Uht(t,r,o,n)<D2?2:(uh(a,s,n),yo(a,a),uh(l,n,r),yo(l,l),hh(i,a,o),yo(i,i),_1(t,i,o,a,l,c),0))}const yC=[0,0,0],vC=[0,0,0],Pu=[0,0,0],Iu=[0,0,0],$u=[0,0,0],xy=[0,0,0],Ty=[0,0,0],Sy=[0,0,0];function Nht(e,t,i,r,s,n,o,a,l){kht(e,t,i,yC,vC),yC[0]!==void 0&&(uh(Pu,yC,i),yo(Pu,Pu),uh(Iu,yC,r),yo(Iu,Iu),uh($u,yC,s),yo($u,$u),hh(xy,Iu,n),yo(xy,xy),hh(Ty,$u,o),yo(Ty,Ty),hh(Sy,Pu,a),yo(Sy,Sy),_1(e,xy,n,Iu,Pu,l),_1(e,Ty,o,$u,Iu,l),_1(e,Sy,a,Pu,$u,l)),vC[0]!==void 0&&(uh(Pu,vC,i),yo(Pu,Pu),uh(Iu,vC,r),yo(Iu,Iu),uh($u,vC,s),yo($u,$u),hh(xy,Iu,n),yo(xy,xy),hh(Ty,$u,o),yo(Ty,Ty),hh(Sy,Pu,a),yo(Sy,Sy),_1(e,xy,n,Iu,Pu,l),_1(e,Ty,o,$u,Iu,l),_1(e,Sy,a,Pu,$u,l))}function Fht(e,t,i){let r=Mj(e.maxVert[0],e.minVert[0]),s=0;for(let n=1;n<7;++n){const o=Mj(e.maxVert[n],e.minVert[n]);o>r&&(r=o,s=n)}Zl(t,e.minVert[s]),Zl(i,e.maxVert[s])}const Du=[0,0,0];function Uht(e,t,i,r){const{data:s,size:n}=e;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){Du[0]=s[l]-t[0],Du[1]=s[l+1]-t[1],Du[2]=s[l+2]-t[2];const c=i[0]*Du[0]+i[1]*Du[1]+i[2]*Du[2],h=i[0]*i[0]+i[1]*i[1]+i[2]*i[2],p=Du[0]*Du[0]+Du[1]*Du[1]+Du[2]*Du[2]-c*c/h;p>o&&(o=p,a=l)}return Zl(r,s,a),o}const ln=[0,0];function kht(e,t,i,r,s){Vht(e,t,ln,s,r);const n=Qxe(i,t);ln[1]-D2<=n&&(r[0]=void 0),ln[0]+D2>=n&&(s[0]=void 0)}const koe=[0,0,0],zoe=[0,0,0],Voe=[0,0,0],gx=[0,0,0],yx=[0,0,0],a$=[0,0,0];function _1(e,t,i,r,s,n){if(Zxe(t)<D2)return;hh(koe,i,t),hh(zoe,r,t),hh(Voe,s,t),gS(e,t,ln),yx[1]=ln[0],gx[1]=ln[1],a$[1]=gx[1]-yx[1];const o=[i,r,s],a=[koe,zoe,Voe];for(let l=0;l<3;++l){gS(e,o[l],ln),yx[0]=ln[0],gx[0]=ln[1],gS(e,a[l],ln),yx[2]=ln[0],gx[2]=ln[1],a$[0]=gx[0]-yx[0],a$[2]=gx[2]-yx[2];const c=Rj(a$);c<n.quality&&(Zl(n.b0,o[l]),Zl(n.b1,t),Zl(n.b2,a[l]),n.quality=c)}}const zht=[0,0,0];function gS(e,t,i){const{data:r,size:s}=e;i[0]=Number.POSITIVE_INFINITY,i[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<r.length;n+=s){const o=r[n]*t[0]+r[n+1]*t[1]+r[n+2]*t[2];i[0]=Math.min(i[0],o),i[1]=Math.max(i[1],o)}}function Vht(e,t,i,r,s){const{data:n,size:o}=e;Zl(r,n),Zl(s,r),i[0]=Qxe(zht,t),i[1]=i[0];for(let a=o;a<n.length;a+=o){const l=n[a]*t[0]+n[a+1]*t[1]+n[a+2]*t[2];l<i[0]&&(i[0]=l,Zl(r,n,a)),l>i[1]&&(i[1]=l,Zl(s,n,a))}}function Boe(e,t,i){Zl(i.center,e),G1(i.halfSize,t,.5),i.quaternion[0]=0,i.quaternion[1]=0,i.quaternion[2]=0,i.quaternion[3]=1}const am=[0,0,0],vx=[0,0,0],_C=[0,0,0],yS=[0,0,0],vS=[0,0,0],Goe=[0,0,0];function Bht(e,t,i){Zl(am,t),Math.abs(t[0])>Math.abs(t[1])&&Math.abs(t[0])>Math.abs(t[2])?am[0]=0:Math.abs(t[1])>Math.abs(t[2])?am[1]=0:am[2]=0,Zxe(am)<D2&&(am[0]=am[1]=am[2]=1),hh(vx,t,am),yo(vx,vx),hh(_C,t,vx),yo(_C,_C),Xxe(e,t,vx,_C,yS,vS),uh(Goe,vS,yS),Yxe(t,vx,_C,yS,vS,Goe,i)}function Xxe(e,t,i,r,s,n){gS(e,t,ln),s[0]=ln[0],n[0]=ln[1],gS(e,i,ln),s[1]=ln[0],n[1]=ln[1],gS(e,r,ln),s[2]=ln[0],n[2]=ln[1]}const l$=[0,0,0],_p=[1,0,0,0,1,0,0,0,1],_x=[0,0,0];function Yxe(e,t,i,r,s,n,o){_p[0]=e[0],_p[1]=e[1],_p[2]=e[2],_p[3]=t[0],_p[4]=t[1],_p[5]=t[2],_p[6]=i[0],_p[7]=i[1],_p[8]=i[2],Hht(o.quaternion,_p),yL(_x,r,s),G1(_x,_x,.5),G1(o.center,e,_x[0]),G1(l$,t,_x[1]),yL(o.center,o.center,l$),G1(l$,i,_x[2]),yL(o.center,o.center,l$),G1(o.halfSize,n,.5)}const bc=7;class Ght{constructor(t){this.minVert=new Array(bc),this.maxVert=new Array(bc);const i=64*bc;this.buffer=new ArrayBuffer(i);let r=0;this.minProj=new Float64Array(this.buffer,r,bc),r+=8*bc,this.maxProj=new Float64Array(this.buffer,r,bc),r+=8*bc;for(let l=0;l<bc;++l)this.minVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<bc;++l)this.maxVert[l]=new Float64Array(this.buffer,r,3),r+=24;for(let l=0;l<bc;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(bc),n=new Array(bc),{data:o,size:a}=t;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<bc;++l){let c=s[l];Zl(this.minVert[l],o,c),c=n[l],Zl(this.maxVert[l],o,c)}}}class jht{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}}function Rj(e){return e[0]*e[1]+e[0]*e[2]+e[1]*e[2]}function yL(e,t,i){e[0]=t[0]+i[0],e[1]=t[1]+i[1],e[2]=t[2]+i[2]}function uh(e,t,i){e[0]=t[0]-i[0],e[1]=t[1]-i[1],e[2]=t[2]-i[2]}function G1(e,t,i){e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i}function Zl(e,t,i=0){e[0]=t[i+0],e[1]=t[i+1],e[2]=t[i+2]}function hh(e,t,i){const r=t[0],s=t[1],n=t[2],o=i[0],a=i[1],l=i[2];e[0]=s*l-n*a,e[1]=n*o-r*l,e[2]=r*a-s*o}function yo(e,t){const i=t[0]*t[0]+t[1]*t[1]+t[2]*t[2];if(i>0){const r=1/Math.sqrt(i);e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r}}function Zxe(e){return e[0]*e[0]+e[1]*e[1]+e[2]*e[2]}function Mj(e,t){const i=t[0]-e[0],r=t[1]-e[1],s=t[2]-e[2];return i*i+r*r+s*s}function Qxe(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}function Hht(e,t){const i=t[0]+t[4]+t[8];if(i>0){let r=Math.sqrt(i+1);e[3]=.5*r,r=.5/r,e[0]=(t[5]-t[7])*r,e[1]=(t[6]-t[2])*r,e[2]=(t[1]-t[3])*r}else{let r=0;t[4]>t[0]&&(r=1),t[8]>t[3*r+r]&&(r=2);const s=(r+1)%3,n=(r+2)%3;let o=Math.sqrt(t[3*r+r]-t[3*s+s]-t[3*n+n]+1);e[r]=.5*o,o=.5/o,e[3]=(t[3*s+n]-t[3*n+s])*o,e[s]=(t[3*s+r]+t[3*r+s])*o,e[n]=(t[3*n+r]+t[3*r+n])*o}}const DR=Dg(),ob=O(),qht=O(),Wht=Sr();class U1t{constructor(t){const o=t*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(t);for(let a=0;a<t;a++)this.obbs[a]={center:uH(this.buffer,56*a+0),halfSize:tve(this.buffer,56*a+24),quaternion:Gxe(this.buffer,56*a+36)}}}function DZ(e=[0,0,0],t=[-1,-1,-1],i=[0,0,0,1]){return{center:Is(e),halfSize:XN(t),quaternion:Bxe(i)}}function joe(e){return DZ(e.center,e.halfSize,e.quaternion)}function k1t(e,t){se(t.center,e.center),se(t.halfSize,e.halfSize),BO(t.quaternion,e.quaternion)}function Jxe(e,t){return t=t||DZ(),Dht(e,t),t}function b1(e,t){const i=ir(t,e.center),r=CU(e,t);return i>r?1:i<-r?-1:0}function z1t(e,t){t||(t=Ls());const i=m5(Wht,e.quaternion),r=e.halfSize[0]*Math.abs(i[0])+e.halfSize[1]*Math.abs(i[3])+e.halfSize[2]*Math.abs(i[6]),s=e.halfSize[0]*Math.abs(i[1])+e.halfSize[1]*Math.abs(i[4])+e.halfSize[2]*Math.abs(i[7]),n=e.halfSize[0]*Math.abs(i[2])+e.halfSize[1]*Math.abs(i[5])+e.halfSize[2]*Math.abs(i[8]);return t[0]=e.center[0]-r,t[1]=e.center[1]-s,t[2]=e.center[2]-n,t[3]=e.center[0]+r,t[4]=e.center[1]+s,t[5]=e.center[2]+n,t}function V1t(e,t){return ir(t,e.center)-CU(e,t)}function B1t(e,t){return ir(t,e.center)+CU(e,t)}function G1t(e,t){return b1(e,t[0])<=0&&b1(e,t[1])<=0&&b1(e,t[2])<=0&&b1(e,t[3])<=0&&b1(e,t[4])<=0&&b1(e,t[5])<=0}function j1t(e,t,i,r=0){Cg(DR,e.quaternion),pe(ob,t,e.center);const s=eu(ob,ob,DR),n=eu(qht,i,DR);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(r+e.halfSize[l]-s[l])/n[l],h=(-r-e.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>e.halfSize[l]+r||s[l]<-e.halfSize[l]-r)return!1;return o<=a}(()=>{const e=new Int8Array(162);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=6};return i([6,2,3,1,5,4]),i([0,2,3,1,5,4]),i([0,2,3,7,5,4]),i([0,1,3,2,6,4]),i([0,1,3,2,0,0]),i([0,1,5,7,3,2]),i([0,1,3,7,6,4]),i([0,1,3,7,6,2]),i([0,1,5,7,6,2]),i([0,1,5,4,6,2]),i([0,1,5,4,0,0]),i([0,1,3,7,5,4]),i([0,2,6,4,0,0]),i([0,0,0,0,0,0]),i([1,3,7,5,0,0]),i([2,3,7,6,4,0]),i([2,3,7,6,0,0]),i([2,3,1,5,7,6]),i([0,1,5,7,6,2]),i([0,1,5,7,6,4]),i([0,1,3,7,6,4]),i([4,5,7,6,2,0]),i([4,5,7,6,0,0]),i([4,5,1,3,7,6]),i([0,2,3,7,5,4]),i([6,2,3,7,5,4]),i([6,2,3,1,5,4]),e})();function CU(e,t){Cg(DR,e.quaternion),eu(ob,t,DR);const i=e.halfSize;return Math.abs(ob[0]*i[0])+Math.abs(ob[1]*i[1])+Math.abs(ob[2]*i[2])}function Kxe(e,t){for(let i=0;i<8;++i){const r=t[i];r[0]=1&i?-e.halfSize[0]:e.halfSize[0],r[1]=2&i?-e.halfSize[1]:e.halfSize[1],r[2]=4&i?-e.halfSize[2]:e.halfSize[2],eu(r,r,e.quaternion),de(r,r,e.center)}}function Xht(e){return fH(e.halfSize)}function eTe(e){return e&&parseInt(e.substring(e.lastIndexOf("/")+1,e.length),10)}function H1t(e){var t;if(he("disable-feature:i3s-draco")||!e)return!1;for(const i of e)for(const r of i.geometryBuffers)if(((t=r.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function q1t(e,t,i,r,s,n){const o=t!==r;s.traverse(i,a=>{let l=a.mbs;return o&&(l=Yht,N3e(a.mbs,r,l,t)),Zht(e,l)!==ab.OUTSIDE&&(n(a),!0)})}function W1t(e,t,i){let r=0,s=0;for(let n=0;n<t.length&&r<e.length;n++)e[r]===t[n]&&(i(n)&&(e[s]=e[r],s++),r++);e.length=s}function X1t(e,t,i){let r=0,s=0;for(;r<i.length;)Ule(e,i[r])>=0===t&&(i[s]=i[r],s++),r++;i.length=s}const bC=Dt();function Y1t(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return bC[0]=(e[0]-t.position[0])/t.rotationScale[0],bC[1]=(e[1]-t.position[1])/t.rotationScale[4],bC[2]=(e[2]-t.position[0])/t.rotationScale[0],bC[3]=(e[3]-t.position[1])/t.rotationScale[4],bC}const Yht=Gt();var ab;function Zht(e,t){const i=t[0],r=t[1],s=t[3],n=e[0]-i,o=i-e[2],a=e[1]-r,l=r-e[3],c=Math.max(n,o,0),h=Math.max(a,l,0),p=c*c+h*h;return p>s*s?ab.OUTSIDE:p>0?ab.INTERSECTS_CENTER_OUTSIDE:-Math.max(n,o,a,l)>s?ab.INSIDE:ab.INTERSECTS_CENTER_INSIDE}function Qht(e,t,i){const r=[],s=i&&i.missingFields,n=i&&i.originalFields;for(const o of e){const a=o.toLowerCase();let l=!1;for(const c of t)if(a===c.name.toLowerCase()){r.push(c.name),l=!0,n&&n.push(o);break}!l&&s&&s.push(o)}return r}async function Z1t(e,t,i,r,s){if(t.length===0)return[];const n=e.attributeStorageInfo;if(_(e.associatedLayer))try{return await Kht(e.associatedLayer,t,i,r)}catch(o){if(e.associatedLayer.loaded)throw o}if(n){const o=Jht(t,i,s);if(R(o))throw new q("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const a=e.parsedUrl.path,l=await Promise.all(o.map(c=>edt(a,n,c.node,c.indices,r).then(h=>{for(let p=0;p<c.graphics.length;p++){const f=c.graphics[p],m=h[p];if(f.attributes)for(const y in f.attributes)y in m||(m[y]=f.attributes[y]);f.attributes=m}return c.graphics})));return kle(l)}throw new q("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function Jht(e,t,i){const r=new Map,s=[],n=i();for(const o of e){const a=o.attributes[t];for(let l=0;l<n.length;l++){const c=n[l],h=c.featureIds.indexOf(a);if(h>=0){let p=r.get(c.node);p||(p={node:c.node,indices:[],graphics:[]},s.push(p),r.set(c.node,p)),p.indices.push(h),p.graphics.push(o);for(let f=l;f>0;f--)n[f]=n[f-1];n[0]=c;break}}}return s}async function Kht(e,t,i,r){t.sort((l,c)=>l.attributes[i]-c.attributes[i]);const s=t.map(l=>l.attributes[i]),n=[],o=Qht(r,e.fields,{originalFields:n}),a=await tTe(e,s,o);for(let l=0;l<t.length;l++){const c=t[l],h=a[l],p={};if(c.attributes)for(const f in c.attributes)p[f]=c.attributes[f];for(let f=0;f<n.length;f++)p[n[f]]=h[o[f]];c.attributes=p}return t}function tTe(e,t,i){const r=e.capabilities.query.maxRecordCount;if(r!=null&&t.length>r){const n=a2e(t,r);return Promise.all(n.map(o=>tTe(e,o,i))).then(kle)}const s=new Cd({objectIds:t,outFields:i,orderByFields:[e.objectIdField]});return e.queryFeatures(s).then(n=>{if(n&&n.features&&n.features.length===t.length)return n.features.map(o=>o.attributes);throw new q("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function edt(e,t,i,r,s){const n=[];for(const o of t)if(o&&s.includes(o.name)){const a=`${e}/nodes/${i.resources.attributes}/attributes/${o.key}/0`;n.push({url:a,storageInfo:o})}return pn(n.map(o=>ur(o.url,{responseType:"array-buffer"}).then(a=>Oht(o.storageInfo,a.data)))).then(o=>{const a=[];for(const l of r){const c={};for(let h=0;h<o.length;h++)o[h].value!=null&&(c[n[h].storageInfo.name]=rdt(o[h].value,l));a.push(c)}return a})}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(ab||(ab={}));const tdt=-32768,idt=-(2**31);function rdt(e,t){if(!e)return null;const i=e[t];return Gle(e)?i===tdt?null:i:jle(e)?i===idt?null:i:i!=i?null:i}function sdt(e){const t=e.store.indexCRS||e.store.geographicCRS,i=t===void 0?e.store.indexWKT:void 0;if(i){if(!e.spatialReference)throw new q("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new q("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new Xe(eTe(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function ndt(e){const t=e.store.vertexCRS||e.store.projectedCRS,i=t===void 0?e.store.vertexWKT:void 0;if(i){if(!e.spatialReference)throw new q("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(i!==e.spatialReference.wkt)throw new q("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const r=t?new Xe(eTe(t)):e.spatialReference;return r.equals(e.spatialReference)?e.spatialReference:r}function Q1t(e,t){return R(t)?"@null":t===Ef(t)?"@ECEF":e.equals(t)?"":t.wkid!=null?"@"+t.wkid:null}function Oj(e,t,i){if(!bg(e,t))throw new q("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(i==="local"&&!odt(e,t))throw new q("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function odt(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function adt(e,t,i){const r=sdt(e),s=ndt(e);Oj(r,t,i),Oj(s,t,i)}function ldt(e){return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function J1t(e){if(e.store==null||e.store.defaultGeometrySchema==null||!ldt(e.store.defaultGeometrySchema))throw new q("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function K1t(e,t){adt(e,t.spatialReference,t.viewingMode)}function cdt(e){return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&e.vertexAttributes!=null&&e.vertexAttributes.position!=null}function ebt(e){if(e.store==null||e.store.defaultGeometrySchema==null||!cdt(e.store.defaultGeometrySchema))throw new q("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function tbt(e,t){Oj(e.spatialReference,t.spatialReference,t.viewingMode)}function udt(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function hdt(e){return e.type==="mesh-3d"}function ibt(e){if(e==null||!udt(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.getSymbols();if(t.length===0)return!0;for(const i of t){if(!hdt(i)||i.symbolLayers.length===0)return!0;for(const r of i.symbolLayers.items)if(r.type!=="fill"||R(r.material)||R(r.material.color)||r.material.colorMixMode!=="replace")return!0}return!1}const rbt=ebe({color:[0,0,0,0],opacity:0});class ddt{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function sbt(e){const t=new ddt;let i=!1,r=!1;for(const s of e.symbolLayers.items)if(s.type==="fill"&&s.enabled){const n=s.material,o=s.edges;if(_(n)&&!i){const a=n.color,l=Hbe(n.colorMixMode);_(a)?t.material={color:[a.r/255,a.g/255,a.b/255],alpha:a.a,colorMixMode:l}:t.material={color:[1,1,1],alpha:1,colorMixMode:gs.Multiply},t.castShadows=s.castShadows,i=!0}_(o)&&!r&&(t.edgeMaterial=K1e(o,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:gs.Multiply}),t}function nbt(e,t){return(0|e)+(0|t)|0}function pdt(e,t,i,r,s=0){r===Ef(r)?t.isGeographic?bdt(e,i,t,s):_dt(e,i,t,s):t.isWGS84&&(r.isWebMercator||HR(r))?mdt(t,e,r,i,s):t.isWebMercator&&HR(r)?vdt(t,e,r,i,s):e===i?(i.center[2]+=s,ar(i.center,t,0,i.center,r,0,1)):(ie(i.center,e.center[0],e.center[1],e.center[2]+s),ar(i.center,t,0,i.center,r,0,1),BO(i.quaternion,e.quaternion),se(i.halfSize,e.halfSize))}function fdt(e,t,i,r,s){if(BO(s.quaternion,e.quaternion),r===Ve.Global){Cg(c$,e.quaternion),eu(Ey,e.center,c$),XV(bx,Ey),Rle(wx,bx,e.halfSize),Kl(wx,bx,wx);const n=Me(wx);de(wx,bx,e.halfSize);const o=Me(wx);if(n<i)se(s.center,e.center),ie(Ey,i,i,i),de(s.halfSize,e.halfSize,Ey);else{const a=o>0?1+t/o:1,l=n>0?1+i/n:1,c=(l+a)/2,h=(l-a)/2;oe(s.halfSize,bx,h),j1(s.halfSize,s.halfSize,e.halfSize,c),oe(s.center,bx,c),j1(s.center,s.center,e.halfSize,h),Ale(Ey,Ey),YF(s.center,s.center,Ey),eu(s.center,s.center,s.quaternion)}}else{const n=ie(Ey,0,0,1);j1(s.center,e.center,n,(i+t)/2),Cg(c$,e.quaternion),eu(n,n,c$),XV(n,n),j1(s.halfSize,e.halfSize,n,(i-t)/2)}return s}const Ey=O(),bx=O(),wx=O(),c$=Dg();function mdt(e,t,i,r,s){se(M0,t.center),M0[2]+=s;const n=Ef(i);ar(M0,e,0,M0,n,0,1),iTe(n,t,M0,i,r)}const vL=new Float64Array(24),gdt={data:vL,size:3},Hoe=O(),M0=O(),ydt=Sr();function vdt(e,t,i,r,s){se(M0,t.center),M0[2]+=s,iTe(e,t,M0,i,r)}function iTe(e,t,i,r,s){const n=m5(ydt,t.quaternion);for(let o=0;o<8;++o){for(let a=0;a<3;++a)Hoe[a]=t.halfSize[a]*((o&1<<a)!=0?-1:1);for(let a=0;a<3;++a){let l=i[a];for(let c=0;c<3;++c)l+=Hoe[c]*n[3*c+a];vL[3*o+a]=l}}ar(vL,e,0,vL,r,0,8),Jxe(gdt,s)}function _dt(e,t,i,r){Kxe(e,Pj),ie(t.center,e.center[0],e.center[1],e.center[2]+r),fu(i,t.center,wc,Ef(i)),ie(t.center,wc[12],wc[13],wc[14]);const s=2*Math.sqrt(1+wc[0]+wc[5]+wc[10]);Bm[0]=(wc[6]-wc[9])/s,Bm[1]=(wc[8]-wc[2])/s,Bm[2]=(wc[1]-wc[4])/s,Bm[3]=.25*s,IX(t.quaternion,Bm,e.quaternion),Cg(Bm,t.quaternion);let n=0,o=0,a=0;for(const l of Pj)l[2]+=r,ar(l,i,0,l,Ef(i),0,1),Kl(mi,l,t.center),eu(mi,mi,Bm),n=Math.max(n,Math.abs(mi[0])),o=Math.max(o,Math.abs(mi[1])),a=Math.max(a,Math.abs(mi[2]));ie(t.halfSize,n,o,a)}function bdt(e,t,i,r){const s=vi(i),n=1+Math.max(0,r)/(s.radius+e.center[2]);ie(t.center,e.center[0],e.center[1],e.center[2]+r),ar(t.center,i,0,t.center,Ef(i),0,1),BO(t.quaternion,e.quaternion),Cg(Bm,e.quaternion),ie(mi,0,0,1),eu(mi,mi,Bm),ie(mi,e.halfSize[0]*Math.abs(mi[0]),e.halfSize[1]*Math.abs(mi[1]),e.halfSize[2]*Math.abs(mi[2])),oe(mi,mi,s.inverseFlattening),de(t.halfSize,e.halfSize,mi),oe(t.halfSize,t.halfSize,n)}function obt(e,t,i,r,s,n){if(!n||n.length===0||R(t))return null;const o=Iht(e.mbs,s,i,t);let a;cs(h$,o);const l=()=>{if(!a)if(a=Pj,hu(u$),_(e.serviceObb)){pdt(e.serviceObb,i,qoe,t,s),Kxe(qoe,a);for(const m of a)Ue(m,m,h$),JT(u$,m)}else{const m=e.mbs,y=m[3];Js(m,i,mi,t),Ue(mi,mi,h$),mi[2]+=s;for(let v=0;v<8;++v){const w=1&v?y:-y,b=2&v?y:-y,S=4&v?y:-y,T=a[v];se(T,[mi[0]+w,mi[1]+b,mi[2]+S]),JT(u$,T)}}};let c=1/0,h=-1/0;const p=m=>{if(m.type!=="replace")return;const y=m.geometry;if(!y.hasZ)return;hu(CV);const v=y.spatialReference||r,w=y.rings.reduce((b,S)=>S.reduce((T,E)=>(Js(E,v,mi,t),Ue(mi,mi,h$),JT(CV,mi),Math.min(mi[2],T)),b),1/0);l(),TO(u$,CV)&&(c=Math.min(c,w),h=Math.max(h,w))};if(n.forEach(m=>p(m)),c===1/0)return null;const f=(m,y,v)=>{Ue(mi,v,o),m[y+0]=mi[0],m[y+1]=mi[1],m[y+2]=mi[2],y+=24,v[2]=c,Ue(mi,v,o),m[y+0]=mi[0],m[y+1]=mi[1],m[y+2]=mi[2],y+=24,v[2]=h,Ue(mi,v,o),m[y+0]=mi[0],m[y+1]=mi[1],m[y+2]=mi[2]};for(let m=0;m<8;++m)f(Woe.data,3*m,a[m]);return Jxe(Woe)}function abt(e){return _(e)&&e.halfSize[0]>=0}function lbt(e){return e[3]>=0}function cbt(e){_(e)&&(e.halfSize[0]=-1)}function ubt(e){_(e)&&(e[3]=-1)}const wc=Ae(),Bm=Vxe(),Pj=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],CV=Dt(),u$=Dt(),qoe=DZ(),mi=[0,0,0],Woe={data:new Array(72),size:3},h$=Ae();class wdt{constructor(t){this._totalCount=t,this._indexRanges=[0,t]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return this._indexRanges.length===0}componentCount(){const t=this._indexRanges;let i=0;for(let r=0;r<t.length;r+=2)i+=t[r+1];return i}reset(t){t==="all"||t.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=xdt(t)}forEachComponent(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r],n=s+i[r+1];for(let o=s;o<n;o++)if(!t(o))return!1}return!0}forEachComponentRange(t){const i=this._indexRanges;for(let r=0;r<i.length;r+=2){const s=i[r];if(!t(s,s+i[r+1]))return!1}return!0}computeOffsetRanges(t){const i=new Array(this._indexRanges.length),r=this._indexRanges;for(let s=0;s<r.length;s+=2){const n=r[s],o=n+r[s+1],a=t[n],l=t[o];i[s]=a,i[s+1]=l-a}return i}}function xdt(e){const t=new Array;if(e.length===0)return t;let i=e[0],r=1;for(let s=1;s<e.length;s++){const n=e[s];i+r===n?r+=1:(t.push(i),t.push(r),i=n,r=1)}return t.push(i),t.push(r),t}class Tdt extends j5{constructor(t,i){super(),this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null,this.offsets=bH(i);const r=this.count;this.visibility=new wdt(r),this.materialDataBuffer=t.getBuffer(r),this.materialDataIndices=new Uint16Array(r);for(let s=0;s<r;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}dispose(){super.dispose();for(let t=0;t<this.count;t++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[t])}get count(){return this.offsets.length-1}get geometryRanges(){return R(this.cachedGeometryRanges)&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return R(this.highlightCounts)?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return R(this.highlightCounts)?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((R(this.cachedHighlightRanges)||R(this.cachedDefaultRanges))&&_(this.highlightCounts)){const{highlightRanges:t,defaultRanges:i}=Sdt(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=t,this.cachedDefaultRanges=i}}}function Sdt(e,t,i){const r=[],s=[];let n=i.length,o=i.length;return t.forEachComponent(a=>(e[a]>0?(n!==a-1&&(r.length&&r.push(i[n+1]-r[r.length-1]),r.push(i[a])),n=a):(o!==a-1&&(s.length&&s.push(i[o+1]-s[s.length-1]),s.push(i[a])),o=a),!0)),r.length&&r.push(i[n+1]-r[r.length-1]),s.length&&s.push(i[o+1]-s[s.length-1]),{highlightRanges:r,defaultRanges:s}}class Ij extends j5{constructor(){super(...arguments),this.visible=_S.Hidden}}var _S;u([go()],Ij.prototype,"renderable",void 0),u([go()],Ij.prototype,"components",void 0),function(e){e[e.Hidden=0]="Hidden",e[e.Visible=1]="Visible"}(_S||(_S={}));function Edt(e,t,i,r){if(i>=t)return e;e==null&&(e=Cdt());const s=e.isVisibleBit;let n=e.data;const o=sTe(n),a=i/o|0,l=i-o*a,c=(t-1)/o|0,h=n,p=r===s;if(!(i<h.length*o)&&p){const m=a+1,y=Math.ceil(h.length*1.5),v=c+1;let w=Math.max(m,y);w=Math.min(w,v),n=new Uint32Array(w),n.set(h)}return a<n.length&&(n[a]=Rdt(n[a],l,p)),e.data=n,e}function rTe(e,t){if(e==null)return!0;const{isVisibleBit:i,data:r}=e,s=sTe(r);return t<r.length*s?Adt(i,r,t,s):!e.isVisibleBit}function Cdt(e=!0){return{isVisibleBit:!e,data:new Uint32Array(0)}}function Adt(e,t,i,r){const s=i/r|0,n=i-s*r;return Mdt(t[s],n)===e}function sTe(e){return e.BYTES_PER_ELEMENT*8}function Rdt(e,t,i){return e&~(1<<t)|(i?1:0)<<t}function Mdt(e,t){return(e&1<<t)!=0}class Odt{constructor(t,i){this._indices=_(t.indices)?t.indices:v2(t.positions.length/3),this._positions=new Vi(t.positions),this._components=i,this._componentIntersectionData=new Array(i.count)}getComponentAabb(t,i){if(_(this._perComponentAabbs)){for(let r=0;r<6;r++)i[r]=this._perComponentAabbs[6*t+r];return i}return this._computePerComponentAabbs(),this.getComponentAabb(t,i)}getComponentPositions(t,i){i.indices=this._indices,i.data=this._positions.typedBuffer,i.stride=this._positions.typedBufferStride,i.startIndex=this._components.offsets[t],i.endIndex=this._components.offsets[t+1]}intersect(t,i,r,s,n,o,a){const l={data:this._positions.typedBuffer,stride:this._positions.typedBufferStride,size:3},c=this._indices,h=this._components.offsets,p=t1e(t,i,Pdt),f=t[2],m=i[2];this._components.visibility.forEachComponent(y=>{if(!rTe(this._components.pickability,y))return!0;const v=this.getComponentAabb(y,Idt);if(_(o)){const E=o[y];_(n)?n.componentOffset=E:(t[2]=f-E,i[2]=m-E)}if(_(n)&&n.applyToAabb(v),!AY(v,t,p,r))return!0;const w=h[y]/3,b=h[y+1]/3,S=(E,C,M)=>{a(y,E,ql(C,C,s),M)},T=b-w;return R(n)&&T>Nxe?(this._componentIntersectionData[y]==null&&(this._componentIntersectionData[y]=new $2(this._indices,w,b,l)),this._componentIntersectionData[y].intersectRay({r0:t,r1:i},S)):XO(t,i,w,b,c,l,void 0,n,S),!0})}_computePerComponentAabbs(){const t=this._components.count;this._perComponentAabbs=new Float32Array(6*t);const i=this._indices,r=this._positions.typedBuffer,s=this._positions.typedBufferStride,n=this._components.offsets;let o=0;for(let a=0;a<t;a++){const l=n[a],c=n[a+1];let h=1/0,p=1/0,f=1/0,m=-1/0,y=-1/0,v=-1/0;for(let w=l;w<c;w++){const b=i[w]*s,S=r[b],T=r[b+1],E=r[b+2];h=Math.min(h,S),p=Math.min(p,T),f=Math.min(f,E),m=Math.max(m,S),y=Math.max(y,T),v=Math.max(v,E)}this._perComponentAabbs[o++]=h,this._perComponentAabbs[o++]=p,this._perComponentAabbs[o++]=f,this._perComponentAabbs[o++]=m,this._perComponentAabbs[o++]=y,this._perComponentAabbs[o++]=v}}get positions(){return this._positions}get indices(){return this._indices}}const Pdt=O(),Idt=Ls();class $dt{constructor(t,i,r){this.material=t,this.geometry=i,this.meta=r}dispose(){this.material.dispose(),this.geometry.dispose()}}class nTe extends j5{constructor(t,i,r,s){super(),this.primitiveType=i,this.parameters=r,this.indexed=s,this.vao=t}}u([go()],nTe.prototype,"vao",void 0);function Ddt(e,t){return{near:e,far:t}}function u3(e){return e?nO(e,1/0,-1/0):Ddt(1/0,-1/0)}function nO(e,t,i){return e.near=t,e.far=i,e}function L2(e,t,i=e){return i.near=Math.min(e.near,t.near),i.far=Math.max(e.far,t.far),i}function d$(e,t){return e.near<=t&&t<=e.far}const $j={near:0,far:0};function Ldt(e,t){const i=u3(),{eye:r,frustum:s,viewForward:n}=e;t.forAll(o=>{const a=_(o.offsetObb)?o.offsetObb:o.obb,l=xe(Kl(Pc,a.center,r),n),c=CU(a,n);if(d$(i,l-c)&&d$(i,l+c))return;const h=zdt(a,s);if(h===-1)return;if(h===0)return lm.far=l+c,lm.near=l-c,void L2(i,lm);const p=p$.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<p$.length;o++){const a=p$.data[o];if(d$(i,a.near)&&d$(i,a.far))continue;lm.far=a.far,lm.near=1/0,kdt(_(a.object.offsetObb)?a.object.offsetObb:a.object.obb,r,Ndt,c=>{let h=Fdt;for(let p=0;p<oTe&&c.length>0;p++){if((a.mask&1<<p)==0)continue;Udt(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){ie(Wa,c.data[p+0],c.data[p+1],c.data[p+2]);const f=xe(Kl(Wa,Wa,r),n);lm.near=Math.min(lm.near,f)}})===0&&(lm.near=0),L2(i,lm)}return p$.length=0,i}const p$=new Bt({allocator:e=>e||{near:1/0,far:-1/0,mask:0,object:null},deallocator:e=>(e.object=null,e)}),lm=u3(),Wa=O(),O_=O(),Ndt=new Bt({deallocator:null}),Fdt=new Bt({deallocator:null});function Udt(e,t,i){i.length=0;const r=t.length-3;AV(Wa,t,r);const s=ir(e,Wa);s<=0&&(i.push(Wa[0]),i.push(Wa[1]),i.push(Wa[2]));let n=0,o=s;for(;n<r;n+=3){AV(O_,t,n);const a=ir(e,O_);o*a<0&&(en(Wa,O_,Wa,a/(a-o)),Xa(i,Wa)),a<=0&&Xa(i,O_),o=a,se(Wa,O_)}o*s<0&&(AV(O_,t,r),en(Wa,O_,Wa,s/(s-o)),Xa(i,Wa))}function AV(e,t,i){return ie(e,t.data[i+0],t.data[i+1],t.data[i+2])}function Xa(e,t){e.push(t[0]),e.push(t[1]),e.push(t[2])}function kdt(e,t,i,r){Cg(Yoe,e.quaternion),Kl(Pc,t,e.center),eu(Pc,Pc,Yoe);const s=8*((Pc[0]<-e.halfSize[0]?-1:Pc[0]>e.halfSize[0]?1:0)+3*(Pc[1]<-e.halfSize[1]?-1:Pc[1]>e.halfSize[1]?1:0)+9*(Pc[2]<-e.halfSize[2]?-1:Pc[2]>e.halfSize[2]?1:0)+13),n=Xoe[s];if(n===0)return n;m5(f$,e.quaternion),HX(f$,f$,e.halfSize);const o=(a,l)=>{const c=Xoe[s+l+1];return ie(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),ql(a,a,f$),de(a,e.center,a)};return i.length=0,Xa(i,o(RV,0)),Xa(i,o(Zoe,1)),Xa(i,o(Pc,2)),Xa(i,o(Qoe,3)),r(i),n===1||(i.length=0,Xa(i,RV),Xa(i,Qoe),Xa(i,o(Pc,4)),Xa(i,o(Joe,5)),r(i),n===2||(i.length=0,Xa(i,RV),Xa(i,Joe),Xa(i,o(Pc,6)),Xa(i,Zoe),r(i))),n}const Xoe=(()=>{const e=new Int8Array(216);let t=0;const i=r=>{for(let s=0;s<r.length;s++)e[t+s]=r[s];t+=8};return i([3,0,6,2,3,1,5,4]),i([2,0,2,3,1,5,4,0]),i([3,1,0,2,3,7,5,4]),i([2,0,1,3,2,6,4,0]),i([1,0,1,3,2,0,0,0]),i([2,1,5,7,3,2,0,0]),i([3,2,0,1,3,7,6,4]),i([2,2,0,1,3,7,6,0]),i([3,3,0,1,5,7,6,2]),i([2,0,1,5,4,6,2,0]),i([1,0,1,5,4,0,0,0]),i([2,1,3,7,5,4,0,0]),i([1,0,2,6,4,0,0,0]),i([0,0,0,0,0,0,0,0]),i([1,1,3,7,5,0,0,0]),i([2,2,3,7,6,4,0,0]),i([1,2,3,7,6,0,0,0]),i([2,3,1,5,7,6,2,0]),i([3,4,0,1,5,7,6,2]),i([2,5,7,6,4,0,1,0]),i([3,5,0,1,3,7,6,4]),i([2,4,5,7,6,2,0,0]),i([1,4,5,7,6,0,0,0]),i([2,5,1,3,7,6,4,0]),i([3,6,0,2,3,7,5,4]),i([2,6,2,3,7,5,4,0]),i([3,7,6,2,3,1,5,4]),e})(),oTe=4;function zdt(e,t){let i=0;for(let r=0;r<oTe;r++){const s=b1(e,t[r]);if(s>0)return-1;s===0&&(i|=1<<r)}return i}const f$=Sr(),Yoe=Dg(),Pc=O(),RV=O(),Zoe=O(),Qoe=O(),Joe=O();class Vdt{constructor(t){this._objects=t}submit(t,i){this._objects.preSubmit(i),this._objects.visibleObjects.forAll(r=>r.renderable.material.submit(t,i,r))}queryShadowCasterDepthRange(t){return this._objects.visibleObjects.length?Ldt(t,this._objects.visibleObjects):null}}function Bdt(e){const t=Kr().vec3f(A.POSITION);return e.normals&&t.vec2i16(A.NORMALCOMPRESSED,{glNormalized:!0}),e.textureCoordinates===Zs.Default?t.vec2f(A.UV0):e.textureCoordinates===Zs.Atlas&&(t.vec2f(A.UV0),t.vec4u16(A.UVREGION,{glNormalized:!0})),e.colors&&t.vec4u8(A.COLOR,{glNormalized:!0}),t.alignTo(4)}class Gdt extends jr{constructor(t,i){super(t,"int",$i.Draw,(r,s,n)=>r.setUniform1i(t,i(s,n)))}}var jd;(function(e){e[e.Uniform=0]="Uniform",e[e.Varying=1]="Varying",e[e.COUNT=2]="COUNT"})(jd||(jd={}));const LZ=429496.7296;function aTe(e,t){BM(e/LZ*.5+.5,t)}function jdt(e,t){switch(t.componentData){case jd.Varying:return Hdt(e);case jd.Uniform:return qdt(e);case jd.COUNT:return;default:t.componentData}}function Hdt(e){const{vertex:t,fragment:i}=e;t.include(uc),t.uniforms.add([new $r("componentColorTex"),new ag("componentColorTexInvDim")]),e.attributes.add(A.COMPONENTINDEX,"float"),e.varyings.add("vExternalColorMixMode","mediump float"),e.varyings.add("vExternalColor","vec4"),e.include(Wbe),t.constants.add("elevationScale","float",2*LZ),t.code.add(x`vec4 _readComponentColor() {
float normalizedIndex = (componentIndex * 2.0 + 0.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return texture2D(componentColorTex, indexCoord);
}
float readElevationOffset() {
float normalizedIndex = (componentIndex * 2.0 + 1.5) * componentColorTexInvDim.x;
vec2 indexCoord = vec2(
mod(normalizedIndex, 1.0),
(floor(normalizedIndex) + 0.5) * componentColorTexInvDim.y
);
return (rgba2float(texture2D(componentColorTex, indexCoord)) - 0.5) * elevationScale;
}
vec4 forwardExternalColor(out bool castShadows) {
vec4 componentColor = _readComponentColor() * 255.0;
float shadowFlag = mod(componentColor.b * 255.0, 2.0);
componentColor.b -= shadowFlag;
castShadows = shadowFlag >= 1.0;
int decodedColorMixMode;
vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451;
vExternalColorMixMode = float(decodedColorMixMode) + 0.5;
return vExternalColor;
}`),i.code.add(x`void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
externalColor = vExternalColor;
externalColorMixMode = int(vExternalColorMixMode);
}`)}function qdt(e){const{vertex:t,fragment:i}=e;t.uniforms.add(new zF("externalColor",r=>r.componentParameters.externalColor)),i.uniforms.add(new Gdt("externalColorMixMode",r=>r.componentParameters.externalColorMixMode)),e.varyings.add("vExternalColor","vec4"),t.code.add(x`float readElevationOffset() {
return 0.0;
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),i.code.add(x`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}`)}var mh;function Wdt(e,t){const i=e.vertex;switch(i.code.add(x`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),t.vertexDiscardMode){case mh.None:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) {}`);break;case mh.Opaque:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case mh.Transparent:i.code.add(x`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(mh||(mh={}));var ff;function hbt(e){return e&&If(e)?ff.Mars:e&&$f(e)?ff.Moon:ff.Earth}(function(e){e[e.Earth=1]="Earth",e[e.Mars=2]="Mars",e[e.Moon=3]="Moon",e[e.COUNT=4]="COUNT"})(ff||(ff={}));var Koe,qc;(function(e){e[e.None=0]="None",e[e.Transparent=1]="Transparent",e[e.Opaque=2]="Opaque",e[e.COUNT=3]="COUNT"})(Koe||(Koe={})),function(e){e[e.None=0]="None",e[e.NoOverlay=1]="NoOverlay",e[e.ColorOverlay=2]="ColorOverlay",e[e.ColorOverlayWithWater=3]="ColorOverlayWithWater",e[e.COUNT=4]="COUNT"}(qc||(qc={}));class si extends Ra{constructor(){super(...arguments),this.output=J.Color,this.textureCoordinateType=Zs.None,this.componentData=jd.Uniform,this.cullFace=or.Back,this.vertexDiscardMode=mh.None,this.doubleSidedMode=Lr.WindingOrder,this.alphaDiscardMode=sr.Opaque,this.integratedMeshMode=qc.None,this.transparencyPassType=gt.NONE,this.ellipsoidMode=ff.Earth,this.pbrMode=Rt.Disabled,this.normalType=Tr.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetalnessAndRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.isGround=!1,this.hasCloudsReflections=!0,this.snowCover=!1}}u([G({count:J.COUNT})],si.prototype,"output",void 0),u([G({count:Zs.COUNT})],si.prototype,"textureCoordinateType",void 0),u([G({count:jd.COUNT})],si.prototype,"componentData",void 0),u([G({count:or.COUNT})],si.prototype,"cullFace",void 0),u([G({count:mh.COUNT})],si.prototype,"vertexDiscardMode",void 0),u([G({count:Lr.COUNT})],si.prototype,"doubleSidedMode",void 0),u([G({count:sr.COUNT})],si.prototype,"alphaDiscardMode",void 0),u([G({count:qc.COUNT})],si.prototype,"integratedMeshMode",void 0),u([G({count:gt.COUNT})],si.prototype,"transparencyPassType",void 0),u([G({count:ff.COUNT})],si.prototype,"ellipsoidMode",void 0),u([G({count:Rt.COUNT})],si.prototype,"pbrMode",void 0),u([G({count:Tr.COUNT})],si.prototype,"normalType",void 0),u([G()],si.prototype,"spherical",void 0),u([G()],si.prototype,"doublePrecisionRequiresObfuscation",void 0),u([G()],si.prototype,"hasVertexColors",void 0),u([G()],si.prototype,"hasNormals",void 0),u([G()],si.prototype,"hasSlicePlane",void 0),u([G()],si.prototype,"hasBaseColorTexture",void 0),u([G()],si.prototype,"receiveAmbientOcclusion",void 0),u([G()],si.prototype,"receiveShadows",void 0),u([G()],si.prototype,"blendingEnabled",void 0),u([G()],si.prototype,"hasScreenSpaceReflections",void 0),u([G()],si.prototype,"hasPolygonOffset",void 0),u([G()],si.prototype,"hasMetalnessAndRoughnessTexture",void 0),u([G()],si.prototype,"hasEmissionTexture",void 0),u([G()],si.prototype,"hasOcclusionTexture",void 0),u([G()],si.prototype,"hasNormalTexture",void 0),u([G()],si.prototype,"hasOccludees",void 0),u([G()],si.prototype,"hasMultipassTerrain",void 0),u([G()],si.prototype,"cullAboveGround",void 0),u([G()],si.prototype,"isGround",void 0),u([G()],si.prototype,"hasCloudsReflections",void 0),u([G()],si.prototype,"snowCover",void 0),u([G({constValue:$i.Draw})],si.prototype,"pbrTextureBindType",void 0),u([G({constValue:!0})],si.prototype,"hasSliceHighlight",void 0),u([G({constValue:!1})],si.prototype,"hasSliceInVertexProgram",void 0),u([G({constValue:!1})],si.prototype,"useCustomDTRExponentForWater",void 0),u([G({constValue:!1})],si.prototype,"hasVertexTangents",void 0),u([G({constValue:!0})],si.prototype,"supportsTextureAtlas",void 0),u([G({constValue:!1})],si.prototype,"highStepCount",void 0),u([G({constValue:!1})],si.prototype,"instancedDoublePrecision",void 0),u([G({constValue:!0})],si.prototype,"useFillLights",void 0);function eae(e,t){e.include(Tw,t),e.fragment.include(YM);const i=e.fragment;i.uniforms.add(new zF("baseColor",r=>r.baseColor)),i.uniforms.add(new Ybe("objectOpacity",r=>r.objectOpacity)),t.hasVertexColors?i.code.add(x`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):i.code.add(x`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),i.code.add(x`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function tae(e,t){const i=e.fragment;switch(t.doubleSidedMode){case Lr.None:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case Lr.View:e.include(hS,t),i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case Lr.WindingOrder:i.code.add(x`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:t.doubleSidedMode;case Lr.COUNT:}switch(t.normalType){case Tr.Attribute:case Tr.CompressedAttribute:e.include(X5,t),i.code.add(x`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Tr.ScreenDerivative:e.extensions.add("GL_OES_standard_derivatives"),e.include(hS,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Tr.Ground:t.spherical?(e.include(hS,t),i.code.add(x`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):i.code.add(x`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),e.extensions.add("GL_OES_standard_derivatives"),i.code.add(x`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:t.normalType;case Tr.COUNT:}}function Xdt(e,t){const i=e.fragment;if(t.hasBaseColorTexture){e.include(LX,t);const r=t.textureCoordinateType===Zs.Atlas;i.uniforms.add(yR("baseColorTexture",s=>s.texture,r)),r?(e.include(ove),i.code.add(x`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, baseColorTextureSize, vuv0, vuvRegion);
}`)):i.code.add(x`vec4 readBaseColorTexture() {
return texture2D(baseColorTexture, vuv0);
}`)}else i.code.add(x`vec4 readBaseColorTexture() { return vec4(1.0); }`)}const lTe=new Map([[A.POSITION,0],[A.NORMAL,1],[A.NORMALCOMPRESSED,1],[A.COLOR,2],[A.UV0,3],[A.UVREGION,4],[A.COMPONENTINDEX,5]]);function Ydt(e){const t=new Bi;t.include(hS,e),t.include(X5,e),t.include(Tw,e),t.include(og,e),t.include(s3,e),t.include(jdt,e),t.include(Det,e),t.include(HZe,e),t.include(Xdt,e),t.include(Wdt,e);const{vertex:i,fragment:r}=t;r.uniforms.add(new vv("view")),e.pbrMode!==Rt.Normal&&e.pbrMode!==Rt.Schematic||(t.include(kX,e),e.hasNormalTexture&&t.include(Jbe,e)),e.output===J.Shadow&&e.componentData===jd.Varying?i.code.add(x`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):i.code.add(x`#define discardShadows(castShadows) {}`);const s=e.integratedMeshMode===qc.ColorOverlay||e.integratedMeshMode===qc.ColorOverlayWithWater,n=s&&e.output===J.Color&&e.pbrMode===Rt.WaterOnIntegratedMesh;return s&&(t.include(iw,e),t.include(Qut,e),e.spherical?i.code.add(x`
      const float invEllipsoidRadius = ${x.float(1/(e.ellipsoidMode===ff.Earth?Ei.radius:e.ellipsoidMode===ff.Mars?cf.radius:yg.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):i.code.add(x`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),n&&(t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),t.varyings.add("groundNormal","vec3")),i.code.add(x`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      if (externalColor.a < ${x.float(Eo)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${n?e.spherical?x`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:x`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${s?x`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),e.output===J.Alpha&&(r.include(gu),t.include(yu,e),t.include(eae,e),s&&r.uniforms.add(new zt("ovColorTex",(o,a)=>Ej(o,a))),r.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${s?x`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        gl_FragColor = vec4(materialColor.a);
      }
    `)),e.output===J.Color&&(r.include(gu),t.include(yu,e),t.include(eae,e),t.include(tae,e),t.include(iw,e),e.receiveShadows?(t.include(Y5,e),r.code.add(x`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):r.code.add(x`float evaluateShadow() { return 0.0; }`),s&&r.uniforms.add(new zt("ovColorTex",(o,a)=>Ej(o,a))),r.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${e.hasMultipassTerrain?x`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${s?x`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),e.pbrMode===Rt.Normal||e.pbrMode===Rt.Schematic?(r.uniforms.add(new xt("lightingMainIntensity",(o,a)=>a.lighting.mainLight.intensity)),r.code.add(x`
        ${e.pbrMode===Rt.Normal?x`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * lightingMainIntensity[2];
      `),e.hasNormalTexture?r.code.add(x`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):r.code.add(x`vec3 shadingNormal = normalVertex;`),r.code.add(x`${e.spherical?x`vec3 normalGround = normalize(positionWorld());`:x`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),r.code.add(x`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${e.snowCover?x`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${s?x` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(e.receiveShadows?r.code.add(x`float shadow = evaluateShadow();`):e.spherical?(r.uniforms.add(new We("lightingGlobalFactor",(o,a)=>a.lighting.globalFactor)),r.code.add(x`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):r.code.add(x`float shadow = 0.0;`),n&&r.uniforms.add(new zt("ovNormalTex",(o,a)=>NZ(a))),e.snowCover&&(t.extensions.add("GL_OES_standard_derivatives"),r.code.add(x`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`)),r.code.add(x`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${s?x` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${n?x`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),r.code.add(x`
        gl_FragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${e.transparencyPassType===gt.Color?"gl_FragColor = premultiplyAlpha(gl_FragColor);":""}
      }
    `)),e.output!==J.Depth&&e.output!==J.Shadow||(t.include(Bv,e),r.code.add(x`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),e.output===J.Normal&&(t.include(tae,e),r.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${e.normalType===Tr.Ground?"0.0":"1.0"};
        gl_FragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),e.output===J.Highlight&&(t.include(Bg),r.code.add(x`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${s?x`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  gl_FragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),t}function NZ(e){return e.overlays.length===0?null:e.overlays[Pr.INNER].getValidTexture(fs.Water)}const Zdt=Object.freeze(Object.defineProperty({__proto__:null,attributeLocations:lTe,build:Ydt,getOverlayNormalTexture:NZ},Symbol.toStringTag,{value:"Module"}));class AU extends lr{bindDraw(t,i){const r=this.program;r.bindDraw(t,i),r.rebindTextures(),t.componentParameters.type===jd.Varying&&t.componentParameters.texture.bind(r,"componentColorTex","componentColorTexInvDim")}initializeConfiguration(t,i){i.spherical=t.viewingMode===Ve.Global,i.doublePrecisionRequiresObfuscation=r3(t.rctx)}initializeProgram(t){const i=AU.shader.get(),r=i.build(this.configuration);return new Ji(t.rctx,r,i.attributeLocations)}_setPipelineState(t){const i=this.configuration,r=i.integratedMeshMode!==qc.None,s=t===gt.NONE,n=t===gt.FrontFace;return Ut({blending:i.output!==J.Color&&i.output!==J.Alpha||!i.blendingEnabled?null:s?au:Gg(t),culling:h5(i.cullFace),depthTest:{func:Vv(t)},depthWrite:s||n?pl:null,colorWrite:Jt,stencilWrite:r||i.hasOccludees?Pf:null,stencilTest:r?OKe(al.IntegratedMeshMaskExcluded):i.hasOccludees?Gv:null,polygonOffset:s||n?i.hasPolygonOffset?{factor:2,units:2}:null:N5})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}}AU.shader=new Qi(Zdt,()=>import("./ComponentShader.glsl.0c6883b7.js"));class Qdt extends Us{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const t of this._parameterBlocks)this[t]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const t of this._parameterBlocks)if(this[t].dirty)return!0;return!1}}class FZ{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}}function kr(e={}){return(t,i)=>{var s;const r=(s=t._parameterCount)!=null?s:0;if(t._parameterCount=r+1,e.vectorOps){const n=e.vectorOps;Object.defineProperty(t,i,{get(){return this[r]},set(o){const a=this[r];if(a==null)this[r]=o;else{if(n.equals(a,o))return;n.copy(a,o)}this._setDirty()}})}else Object.defineProperty(t,i,{get(){return this[r]},set(n){this[r]!==n&&(e.dispose&&this[r]&&this[r].dispose(),this[r]=n,this._setDirty())}})}}function iae(){return(e,t)=>{var r;const i=(r=e._parameterCount)!=null?r:0;e._parameterCount=i+1,e._parameterBlocks=e._parameterBlocks||[],e._parameterBlocks.push(i),Object.defineProperty(e,t,{get(){return this[i]},set(s){this[i]!==s&&(this[i]=s,this._setDirty())}})}}class RU{constructor(t){this._low=wi(),this._high=wi(),t&&this.set(t)}get low(){return this._low}get high(){return this._high}set(t){const i=this._low,r=this._high;se(i,t),Kl(r,t,i)}setElements(t,i,r){ie(rae,t,i,r),this.set(rae)}get(t){return de(t,this._low,this._high)}getLowScaled(t){return oe(t,this._low,1)}}const rae=O();class bn extends Qdt{constructor(t,i){super(),this.toMapSpace=i,this.baseColor=Ph(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Ai(1,1,.5),this.emissiveFactor=Ai(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new _L,this.componentParameters=new LR,this.textureAlphaCutoff=gF,this.alphaDiscardMode=sr.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=ff.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new si;const r=new RU(t.position),s=axe(t.rotationScale);ww(s,s),this.transformNormalGlobalFromModel=Ah(s,s),this.transformWorldFromModelTL=r.low,this.transformWorldFromModelTH=r.high,this.transformWorldFromModelRS=t.rotationScale}dispose(){this._technique=Wi(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return _(this.baseColorTexture)?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return _(this.metallicRoughnessTexture)?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return _(this.emissionTexture)?this.emissionTexture.glTexture:null}get textureOcclusion(){return _(this.occlusionTexture)?this.occlusionTexture.glTexture:null}get textureNormal(){return _(this.normalTexture)?this.normalTexture.glTexture:null}prepareTechnique(t,i,r,s){const n=this._techniqueConfiguration;n.hasVertexColors=s.colors,n.hasNormals=s.normals,n.textureCoordinateType=s.textureCoordinates,n.hasMetalnessAndRoughnessTexture=_(this.metallicRoughnessTexture),n.hasEmissionTexture=_(this.emissionTexture),n.hasOcclusionTexture=_(this.occlusionTexture),n.hasNormalTexture=_(this.normalTexture),n.transparencyPassType=i.identifier===Zc.Material&&r.transparencyPassType!=null?r.transparencyPassType:gt.NONE,n.hasMultipassTerrain=i.identifier===Zc.Material&&r.multipassTerrain!=null&&r.multipassTerrain.enabled,n.cullAboveGround=i.identifier===Zc.Material&&r.multipassTerrain!=null&&r.multipassTerrain.cullAboveGround,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?Lr.View:Lr.None,n.hasBaseColorTexture=_(this.baseColorTexture);const o=this._computeWhichMaterialPass();n.blendingEnabled=o===pa.Transparent||o===pa.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?ept(r)?NZ(r)?qc.ColorOverlayWithWater:qc.ColorOverlay:qc.NoOverlay:qc.None,n.isGround=this.isIntegratedMesh,n.hasPolygonOffset=this.polygonOffsetEnabled;const a=this.hasParametersFromSource&&R(this.baseColorTexture);return n.pbrMode=n.integratedMeshMode===qc.ColorOverlayWithWater?Rt.WaterOnIntegratedMesh:this.usePBR?a?Rt.Schematic:Rt.Normal:Rt.Disabled,n.normalType=n.integratedMeshMode===qc.None?n.hasNormals?Tr.CompressedAttribute:Tr.ScreenDerivative:Tr.Ground,n.hasSlicePlane=_(r.slicePlane)&&this.commonMaterialParameters.hasSlicePlane,i.identifier===Zc.ShadowMap?(n.output=J.Shadow,n.vertexDiscardMode=mh.None):i.identifier===Zc.Highlight?(n.output=J.Highlight,n.vertexDiscardMode=mh.None):(this._computeWhichMaterialPass()===pa.OpaqueAndTransparent?n.vertexDiscardMode=i.transparent?mh.Opaque:mh.Transparent:n.vertexDiscardMode=mh.None,n.output=Jdt(i.subPass),i.subPass===Hn.Alpha&&(n.hasOccludees=r.hasOccludees),i.subPass===Hn.Color?(n.receiveAmbientOcclusion=r.ssaoHelper.ready,n.hasOccludees=r.hasOccludees,n.receiveShadows=r.shadowMap.ready,n.hasScreenSpaceReflections=r.ssr.enabled,n.hasCloudsReflections=_(r.clouds.data)):(n.receiveAmbientOcclusion=!1,n.receiveShadows=!1),n.snowCover=this.hasSnowCover(r)),this._technique=t.releaseAndAcquire(AU,n,this._technique),this._setClean(),this._technique}hasSnowCover(t){return _(t.weather)&&t.weatherVisible&&t.weather.type==="snowy"&&t.weather.snowCover==="enabled"}submit(t,i,r){if(this.objectOpacity===0)return;const s=r.renderable.geometry,n=r.components,o=r.renderable.meta.cameraDepthSquared,a=n.geometryRanges,l=n.highlightRanges,c=n.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case pa.Opaque:t.materialOpaque.submitDraw(this,s,a,o);break;case pa.Transparent:t.materialTransparent.submitDraw(this,s,a,o);break;case pa.OpaqueAndTransparent:t.materialOpaque.submitDraw(this,s,a,o),t.materialTransparent.submitDraw(this,s,a,o);break;case pa.IntegratedMesh:t.materialIntegratedMesh.submitDraw(this,s,a,o),Kdt(i)&&t.highlightIntegratedMesh.submitDraw(this,s,a,o)}const h=this.componentParameters.castShadows!==cn.None;h&&t.shadowMap.submitDraw(this,s,a,o),_(l)&&(t.highlight.submitDraw(this,s,l,o),h&&t.highlightShadowMap.submitDraw(this,s,l,o)),h&&_(c)&&t.defaultShadowMap.submitDraw(this,s,c,o)}get attributeLocations(){return lTe}_computeWhichMaterialPass(){return this.isIntegratedMesh?pa.IntegratedMesh:this.objectOpacity<1?pa.Transparent:this.componentParameters.opaqueOverride===cn.All?pa.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===sr.Blend||this.alphaDiscardMode===sr.MaskBlend?pa.Transparent:this.componentParameters.transparent===cn.None?pa.Opaque:this.componentParameters.transparent===cn.All?pa.Transparent:pa.OpaqueAndTransparent}}var sae,pa,cn;u([kr({vectorOps:Nle})],bn.prototype,"baseColor",void 0),u([kr()],bn.prototype,"usePBR",void 0),u([kr()],bn.prototype,"hasParametersFromSource",void 0),u([kr({vectorOps:YZ})],bn.prototype,"mrrFactors",void 0),u([kr({vectorOps:YZ})],bn.prototype,"emissiveFactor",void 0),u([kr({dispose:!0})],bn.prototype,"baseColorTexture",void 0),u([kr({dispose:!0})],bn.prototype,"metallicRoughnessTexture",void 0),u([kr({dispose:!0})],bn.prototype,"emissionTexture",void 0),u([kr({dispose:!0})],bn.prototype,"occlusionTexture",void 0),u([kr({dispose:!0})],bn.prototype,"normalTexture",void 0),u([kr()],bn.prototype,"objectOpacity",void 0),u([iae()],bn.prototype,"commonMaterialParameters",void 0),u([iae()],bn.prototype,"componentParameters",void 0),u([kr()],bn.prototype,"textureAlphaCutoff",void 0),u([kr()],bn.prototype,"alphaDiscardMode",void 0),u([kr()],bn.prototype,"isIntegratedMesh",void 0),u([kr()],bn.prototype,"polygonOffsetEnabled",void 0),u([kr()],bn.prototype,"ellipsoidMode",void 0),u([kr()],bn.prototype,"hasOccludees",void 0),function(e){e[e.VERTEX=0]="VERTEX",e[e.GROUND=1]="GROUND",e[e.SCREEN_DERIVATIVE=2]="SCREEN_DERIVATIVE"}(sae||(sae={})),function(e){e[e.Opaque=0]="Opaque",e[e.Transparent=1]="Transparent",e[e.OpaqueAndTransparent=2]="OpaqueAndTransparent",e[e.IntegratedMesh=3]="IntegratedMesh"}(pa||(pa={}));class _L extends FZ{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=or.Back,this.hasSlicePlane=!0}}u([kr()],_L.prototype,"doubleSided",void 0),u([kr()],_L.prototype,"cullFace",void 0),u([kr()],_L.prototype,"hasSlicePlane",void 0);class LR extends FZ{constructor(){super(...arguments),this.externalColor=Ph(1,1,1,1),this.externalColorMixMode=gs.Multiply,this.castShadows=cn.All}get transparent(){return this.externalColor[3]<1?cn.All:cn.None}get opaqueOverride(){return this.externalColorMixMode===gs.Replace&&this.externalColor[3]===1?cn.All:cn.None}get visible(){return this.externalColor[3]>0?cn.All:cn.None}get type(){return jd.Uniform}}u([kr({vectorOps:Nle})],LR.prototype,"externalColor",void 0),u([kr()],LR.prototype,"externalColorMixMode",void 0),u([kr()],LR.prototype,"castShadows",void 0),function(e){e[e.All=0]="All",e[e.Some=1]="Some",e[e.None=2]="None"}(cn||(cn={}));class kA extends FZ{constructor(){super(...arguments),this.texture=null,this.transparent=cn.None,this.opaqueOverride=cn.None,this.castShadows=cn.None}get type(){return jd.Varying}}function Jdt(e){switch(e){case Hn.Color:return J.Color;case Hn.Alpha:return J.Alpha;case Hn.Depth:return J.Depth;case Hn.Normal:return J.Normal}}function Kdt(e){return e.overlays.length!==0&&_(e.overlays[Pr.INNER].getValidTexture(fs.Highlight))}function ept(e){return e.overlays.length!==0&&_(e.overlays[Pr.INNER].getColorTextureNoRasterImage())}u([kr()],kA.prototype,"texture",void 0),u([kr()],kA.prototype,"transparent",void 0),u([kr()],kA.prototype,"opaqueOverride",void 0),u([kr()],kA.prototype,"castShadows",void 0);const oO=Kr().vec3f(A.POSITION).u16(A.COMPONENTINDEX).u16(A.U16PADDING),cTe=Kr().vec2u8(A.SIDENESS),nae=hc(cTe),uTe=Kr().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u8(A.VARIANTOFFSET,{glNormalized:!0}).u8(A.VARIANTSTROKE).u8(A.VARIANTEXTENSION,{glNormalized:!0}).u8(A.U8PADDING,{glPadding:!0}).u16(A.U16PADDING,{glPadding:!0}),Dj=uTe.clone().vec3f(A.NORMAL),Lj=uTe.clone().vec3f(A.NORMALA).vec3f(A.NORMALB),Nj=new Map([[A.POSITION0,0],[A.POSITION1,1],[A.COMPONENTINDEX,2],[A.VARIANTOFFSET,3],[A.VARIANTSTROKE,4],[A.VARIANTEXTENSION,5],[A.NORMAL,6],[A.NORMALA,6],[A.NORMALB,7],[A.SIDENESS,8]]);function oae(e,t,i){const r=t/3,s=new Uint32Array(i+1),n=new Uint32Array(i+1),o=(b,S)=>{b<S?s[b+1]++:n[S+1]++};for(let b=0;b<r;b++){const S=e[3*b],T=e[3*b+1],E=e[3*b+2];o(S,T),o(T,E),o(E,S)}let a=0,l=0;for(let b=0;b<i;b++){const S=s[b+1],T=n[b+1];s[b+1]=a,n[b+1]=l,a+=S,l+=T}const c=new Uint32Array(6*r),h=s[i],p=(b,S,T)=>{if(b<S){const E=s[b+1]++;c[2*E]=S,c[2*E+1]=T}else{const E=n[S+1]++;c[2*h+2*E]=b,c[2*h+2*E+1]=T}};for(let b=0;b<r;b++){const S=e[3*b],T=e[3*b+1],E=e[3*b+2];p(S,T,b),p(T,E,b),p(E,S,b)}const f=(b,S)=>{const T=2*b,E=S-b;for(let C=1;C<E;C++){const M=c[T+2*C],I=c[T+2*C+1];let N=C-1;for(;N>=0&&c[T+2*N]>M;N--)c[T+2*N+2]=c[T+2*N],c[T+2*N+3]=c[T+2*N+1];c[T+2*N+2]=M,c[T+2*N+3]=I}};for(let b=0;b<i;b++)f(s[b],s[b+1]),f(h+n[b],h+n[b+1]);const m=new Int32Array(3*r),y=(b,S)=>b===e[3*S]?0:b===e[3*S+1]?1:b===e[3*S+2]?2:-1,v=(b,S)=>{const T=y(b,S);m[3*S+T]=-1},w=(b,S,T,E)=>{const C=y(b,S);m[3*S+C]=E;const M=y(T,E);m[3*E+M]=S};for(let b=0;b<i;b++){let S=s[b];const T=s[b+1];let E=n[b];const C=n[b+1];for(;S<T&&E<C;){const M=c[2*S],I=c[2*h+2*E];M===I?(w(b,c[2*S+1],I,c[2*h+2*E+1]),S++,E++):M<I?(v(b,c[2*S+1]),S++):(v(I,c[2*h+2*E+1]),E++)}for(;S<T;)v(b,c[2*S+1]),S++;for(;E<C;)v(c[2*h+2*E],c[2*h+2*E+1]),E++}return m}function VF(e,t){return t.push(e.buffer),{buffer:e.buffer,layout:tpt(e.layout)}}function m$(e){return ipt(e.layout).createView(e.buffer)}function tpt(e){const t=new Array;return e.fields.forEach((i,r)=>{const s=ve(F({},i),{constructor:hTe(i.constructor)});t.push([r,s])}),{stride:e.stride,fields:t,fieldNames:e.fieldNames}}function ipt(e){const t=Kr();return t.stride=e.stride,t.fieldNames=e.fieldNames,e.fields.forEach(i=>t.fields.set(i[0],ve(F({},i[1]),{constructor:spt(i[1].constructor)}))),t}const rpt=[GO,Rh,Vi,On,Jd,d2,p2,f2,vs,jb,_v,bv,Ag,Hb,wv,fl,qb,m2,Wb,xv,Xb,g2,EM,CM,y2,Yb,AM,RM,MM,Zb,OM,PM,IM,$M,DM,LM];function hTe(e){return`${e.ElementType}_${e.ElementCount}`}function spt(e){return dTe.get(e)}const dTe=new Map;rpt.forEach(e=>dTe.set(hTe(e),e));class pTe{updateSettings(t){this.settings=t,this.edgeHashFunction=t.reducedPrecision?opt:npt}write(t,i,r){const s=this.edgeHashFunction(r);y$.seed=s;const n=y$.getIntRange(0,255),o=y$.getIntRange(0,this.settings.variants-1),a=.7,l=y$.getFloat(),c=255*(.5*apt(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);t.position0.setVec(i,r.position0),t.position1.setVec(i,r.position1),t.componentIndex.set(i,r.componentIndex),t.variantOffset.set(i,n),t.variantStroke.set(i,o),t.variantExtension.set(i,c)}trim(t,i){return t.slice(0,i)}}const UZ=new Float32Array(6),BF=new Uint32Array(UZ.buffer),Z0=new Uint32Array(1);function npt(e){const t=UZ;t[0]=e.position0[0],t[1]=e.position0[1],t[2]=e.position0[2],t[3]=e.position1[0],t[4]=e.position1[1],t[5]=e.position1[2],Z0[0]=5381;for(let i=0;i<BF.length;i++)Z0[0]=31*Z0[0]+BF[i];return Z0[0]}function opt(e){const t=UZ;t[0]=xx(e.position0[0]),t[1]=xx(e.position0[1]),t[2]=xx(e.position0[2]),t[3]=xx(e.position1[0]),t[4]=xx(e.position1[1]),t[5]=xx(e.position1[2]),Z0[0]=5381;for(let i=0;i<BF.length;i++)Z0[0]=31*Z0[0]+BF[i];return Z0[0]}const aae=1e4;function xx(e){return Math.round(e*aae)/aae}function apt(e,t){const i=e<0?-1:1;return Math.abs(e)**t*i}class GF{constructor(){this.commonWriter=new pTe}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return Dj.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),de(g$,r.faceNormal0,r.faceNormal1),we(g$,g$),t.normal.setVec(i,g$)}trim(t,i){return this.commonWriter.trim(t,i)}}GF.Layout=Dj,GF.glLayout=hc(Dj,1);class jF{constructor(){this.commonWriter=new pTe}updateSettings(t){this.commonWriter.updateSettings(t)}allocate(t){return Lj.createBuffer(t)}write(t,i,r){this.commonWriter.write(t,i,r),t.normalA.setVec(i,r.faceNormal0),t.normalB.setVec(i,r.faceNormal1)}trim(t,i){return this.commonWriter.trim(t,i)}}jF.Layout=Lj,jF.glLayout=hc(Lj,1);const g$=O(),y$=new nh,w1=-1;var HF;function Fj(e,t,i,r=ppt){const s=e.vertices.position,n=e.vertices.componentIndex,o=$t(r.anglePlanar),a=$t(r.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=Uj.edge,p=h.position0,f=h.position1,m=h.faceNormal0,y=h.faceNormal1,v=dpt(e),w=hpt(e),b=w.length/4,S=t.allocate(b);let T=0;const E=b,C=i.allocate(E);let M=0,I=0,N=0;const D=c2e(0,b),z=new Float32Array(b);d2e(z,(le,ne,$)=>{s.getVec(w[4*ne+0],p),s.getVec(w[4*ne+1],f),$[ne]=nr(p,f)}),D.sort((le,ne)=>z[ne]-z[le]);const V=new Array,k=new Array;for(let le=0;le<b;le++){const ne=D[le],$=z[ne],U=w[4*ne+0],B=w[4*ne+1],H=w[4*ne+2],W=w[4*ne+3],K=W===w1;if(s.getVec(U,p),s.getVec(B,f),K)ie(m,v[3*H+0],v[3*H+1],v[3*H+2]),se(y,m),h.componentIndex=n.get(U),h.cosAngle=xe(m,y);else{if(ie(m,v[3*H+0],v[3*H+1],v[3*H+2]),ie(y,v[3*W+0],v[3*W+1],v[3*W+2]),h.componentIndex=n.get(U),h.cosAngle=xe(m,y),cpt(h,c))continue;h.cosAngle<-.9999&&se(y,m)}I+=$,N++,K||lpt(h,l)?(t.write(S,T++,h),V.push($)):upt(h,o)&&(i.write(C,M++,h),k.push($))}const Y=new Float32Array(V.reverse()),Z=new Float32Array(k.reverse());return{regular:{instancesData:t.trim(S,T),lodInfo:{lengths:Y}},silhouette:{instancesData:i.trim(C,M),lodInfo:{lengths:Z}},averageEdgeLength:I/N}}function lpt(e,t){return e.cosAngle<t}function cpt(e,t){return e.cosAngle>t}function upt(e,t){const i=tn(e.cosAngle),r=Uj.fwd,s=Uj.ortho;return Og(r,e.position1,e.position0),i*(xe(lt(s,e.faceNormal0,e.faceNormal1),r)>0?-1:1)>t}function hpt(e){const t=e.faces.length/3,i=e.faces,r=e.neighbors;let s=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],m=i[3*a+2];s+=l===w1||p<f?1:0,s+=c===w1||f<m?1:0,s+=h===w1||m<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<t;a++){const l=r[3*a+0],c=r[3*a+1],h=r[3*a+2],p=i[3*a+0],f=i[3*a+1],m=i[3*a+2];(l===w1||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===w1||f<m)&&(n[o++]=f,n[o++]=m,n[o++]=a,n[o++]=c),(h===w1||m<p)&&(n[o++]=m,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function dpt(e){const t=e.faces.length/3,i=e.vertices.position,r=e.faces,s=MV.v0,n=MV.v1,o=MV.v2,a=new Float32Array(3*t);for(let l=0;l<t;l++){const c=r[3*l+0],h=r[3*l+1],p=r[3*l+2];i.getVec(c,s),i.getVec(h,n),i.getVec(p,o),pe(n,n,s),pe(o,o,s),lt(s,n,o),we(s,s),a[3*l+0]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH"})(HF||(HF={}));const Uj={edge:{position0:O(),position1:O(),faceNormal0:O(),faceNormal1:O(),componentIndex:0,cosAngle:0},ortho:O(),fwd:O()},MV={v0:O(),v1:O(),v2:O()},ppt={anglePlanar:4,angleSignificantEdge:35};class fTe{async extract(t){const i=OV(t),r=kZ(i),s=[i.data.buffer];return{result:fpt(r,s),transferList:s}}async extractComponentsEdgeLocations(t){const i=OV(t),r=kj(i.data,i.skipDeduplicate,i.indices,i.indicesLength),s=Fj(r,vpt,uae),n=[];return{result:VF(s.regular.instancesData,n),transferList:n}}async extractEdgeLocations(t){const i=OV(t),r=kj(i.data,i.skipDeduplicate,i.indices,i.indicesLength),s=Fj(r,ypt,uae),n=[];return{result:VF(s.regular.instancesData,n),transferList:n}}}function kZ(e){const t=kj(e.data,e.skipDeduplicate,e.indices,e.indicesLength);return lae.updateSettings(e.writerSettings),cae.updateSettings(e.writerSettings),Fj(t,lae,cae)}function OV(e){return{data:oO.createView(e.dataBuffer),indices:e.indicesType==="Uint32Array"?new Uint32Array(e.indicesBuffer):e.indicesType==="Uint16Array"?new Uint16Array(e.indicesBuffer):void 0,indicesLength:e.indicesLength,writerSettings:e.writerSettings,skipDeduplicate:e.skipDeduplicate}}function fpt(e,t){return t.push(e.regular.lodInfo.lengths.buffer),t.push(e.silhouette.lodInfo.lengths.buffer),{regular:{instancesData:VF(e.regular.instancesData,t),lodInfo:{lengths:e.regular.lodInfo.lengths.buffer}},silhouette:{instancesData:VF(e.silhouette.instancesData,t),lodInfo:{lengths:e.silhouette.lodInfo.lengths.buffer}},averageEdgeLength:e.averageEdgeLength}}function kj(e,t,i,r){if(t)return{faces:i,facesLength:r,neighbors:oae(i,r,e.count),vertices:e};const s=nbe(e.buffer,e.stride/4,{originalIndices:i,originalIndicesLength:r}),n=oae(s.indices,r,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:oO.createView(s.buffer)}}const lae=new GF,cae=new jF;class mpt{allocate(t){return mTe.createBuffer(t)}trim(t,i){return t.slice(0,i)}write(t,i,r){t.position0.setVec(i,r.position0),t.position1.setVec(i,r.position1)}}class gpt{allocate(t){return zZ.createBuffer(t)}trim(t,i){return t.slice(0,i)}write(t,i,r){t.position0.setVec(i,r.position0),t.position1.setVec(i,r.position1),t.componentIndex.set(i,r.componentIndex)}}const ypt=new mpt,vpt=new gpt,uae={allocate:()=>null,write:()=>{},trim:()=>null},mTe=Kr().vec3f(A.POSITION0).vec3f(A.POSITION1),zZ=Kr().vec3f(A.POSITION0).vec3f(A.POSITION1).u16(A.COMPONENTINDEX).u16(A.U16PADDING,{glPadding:!0});function _pt(){return new fTe}var bpt=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",EdgeProcessingWorker:fTe,default:_pt,extract:kZ,extractComponentsEdgeLocationsLayout:zZ,extractEdgeLocationsLayout:mTe});class wpt{constructor(t){this.maxCount=t,this._nextIndex=0,this.recycledIndices=[]}get activeCount(){return this._nextIndex-this.recycledIndices.length}get availableCount(){return this.recycledIndices.length+this.maxCount-this._nextIndex}acquire(){return this.recycledIndices.length>0?this.recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(t){this.recycledIndices.push(t)}}class xpt{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.textureWidth=4096,this.dirty=!0,this.texture=new st(this.rctx,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,width:this.textureWidth,height:1,flipped:!1}),this.data=new fl(new ArrayBuffer(4*this.textureWidth))}dispose(){this.texture.dispose(),this.texture=void 0,this.data=void 0}setData(t,i,r,s,n,o){const a=t*this.fieldCount+i;this.dirty=!0,this.data.set(a,0,r),this.data.set(a,1,s),this.data.set(a,2,n),this.data.set(a,3,o)}setDataElement(t,i,r,s){const n=t*this.fieldCount+i;this.dirty=!0,this.data.set(n,r,s)}resizeToFit(t){const i=t*this.fieldCount;if(i>=this.data.count){const r=Math.ceil((i+1)/this.textureWidth)*this.textureWidth,s=new fl(new ArrayBuffer(4*r));s.typedBuffer.set(this.data.typedBuffer),this.data=s}}updateTexture(){if(!this.dirty)return;const t=this.texture.descriptor.width,i=this.texture.descriptor.height;this.data.count>t*i&&this.texture.resize(t,this.data.count/t),this.texture.setData(this.data.typedBuffer),this.dirty=!1}bind(t,i,r){t.bindTexture(i,this.texture),t.setUniform2f(r,1/this.texture.descriptor.width,1/this.texture.descriptor.height)}}const gTe=65536;class Tpt{constructor(t,i=1){this.textureBuffer=new xpt(t,i),this.indexManager=new wpt(gTe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this.indexManager.availableCount}get activeCount(){return this.indexManager.activeCount}acquireIndex(){const t=this.indexManager.acquire();return this.textureBuffer.resizeToFit(t),t}releaseIndex(t){this.indexManager.release(t)}}class yTe{constructor(t,i=1){this.rctx=t,this.fieldCount=i,this.buffers=[]}garbageCollect(){this.buffers=this.buffers.filter(t=>t.activeCount!==0||(t.dispose(),!1))}destroy(){this.buffers.forEach(t=>t.dispose()),this.buffers=[]}getBuffer(t){for(const r of this.buffers)if(r.availableCount>=t)return r;if(t>gTe)return null;const i=new Tpt(this.rctx,this.fieldCount);return this.buffers.push(i),i}updateTextures(){for(const t of this.buffers)t.textureBuffer.updateTexture()}}const hae=me.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class Spt{constructor(t,i){this._renderManager=t,this._viewingMode=i,this._objects=[new Bt,new Bt],this._renderSubmit=new Vdt(this),this._renderManager.register(this._renderSubmit),this._componentBufferManager=new yTe(t.rctx,2)}dispose(){dt(this._objects[_S.Hidden].length===0&&this._objects[_S.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy()}createObject(t){const i=new Ij;return i.toMapSpace=t.toMapSpace,i.transform=t.transform,i.obb=joe(t.obb),i.components=new Tdt(this._componentBufferManager,t.geometry.componentOffsets),i.renderable=this._createRenderable(t,i.components),i.intersectionGeometry=new Odt(t.geometry.positionData,i.components),this._objects[i.visible].push(i),i}destroyObject(t){const i=t;this._objects[i.visible].removeUnordered(i),i.dispose(),this._notifyDirty()}setObjectVisibility(t,i){const r=t;i!==r.visible&&(this._objects[r.visible].removeUnordered(r),this._objects[i].push(r),r.visible=i,this._notifyDirty())}preSubmit(t){const i=t.camera.eye;this.visibleObjects.forAll(r=>r.renderable.meta.cameraDepthSquared=$s(i,r.obb.center))}getMaterial(t){return t.renderable.material}updateMaterial(t,i){const r=t.renderable.material;i(r),r.dirty&&this._notifyDirty()}setAllComponentVisibilities(t,i){const r=t;r.components.visibility.reset(i),r.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(t,i){return t.components.visibility.forEachComponent(i)}getComponentCount(t){const i=t,r=i.components.visibility.componentCount();return{visible:r,invisible:i.components.count-r}}setComponentData(t,i){const r=t,s=r.renderable.material,n=r.components,o=n.materialDataBuffer,a=n.materialDataIndices,l={castShadows:!0,pickable:!0,externalColor:mZ(),externalColorMixMode:gs.Multiply,elevationOffset:0},c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,m=0,y=0,v=n.verticalOffsets,w=1/0,b=-1/0,S=!1,T=!1,E=0;for(let C=0;C<n.count;C++)i(C,l),f+=+(l.externalColor[3]<1),m+=+(l.externalColorMixMode===gs.Replace&&l.externalColor[3]===1),y+=+l.castShadows,qbe(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[C],0,h[0],h[1],h[2],h[3]),S||(S=C>0&&E!==p[0]),E=p[0],T||(T=l.elevationOffset!==0),T&&R(v)&&(v=new Array(C).fill(0)),_(v)&&(v[C]=l.elevationOffset),w=Math.min(w,l.elevationOffset),b=Math.max(b,l.elevationOffset),aTe(l.elevationOffset,h),c.setData(a[C],1,h[0],h[1],h[2],h[3]),l.pickable!==rTe(n.pickability,C)&&(n.pickability=Edt(n.pickability,n.count,C,l.pickable));n.verticalOffsets=T?v:null,r.offsetObb=T?fdt(r.obb,w,b,this._viewingMode,_(r.offsetObb)?r.offsetObb:joe(r.obb)):null,S||T?(s.componentParameters=new kA,s.componentParameters.castShadows=PV(y,n.count),s.componentParameters.transparent=PV(f,n.count),s.componentParameters.opaqueOverride=PV(m,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new LR,s.componentParameters.castShadows=l.castShadows?cn.All:cn.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._notifyDirty()}getComponentAabb(t,i,r,s=!1){t.intersectionGeometry.getComponentAabb(i,r);const n=t,o=n.components.verticalOffsets;if(s||R(o))return r;const a=o[i];if(this._viewingMode===Ve.Local||a===0)return r[2]+=a,r[5]+=a,r;const l=Mqe(a);return l.localOrigin=n.transform.position,l.applyToAabb(r)}getComponentObb(t){return t.obb}getObjectTransform(t){return t.transform}getComponentPositions(t,i,r){return t.intersectionGeometry.getComponentPositions(i,r)}intersect(t,i,r,s,n,o){const a=t;_(n)&&(n.localOrigin=a.transform.position);const l=ww(dae,a.transform.rotationScale);Kl(v$,i,a.transform.position),Kl(_$,r,a.transform.position),ql(v$,v$,l),ql(_$,_$,l);const c=Ah(dae,l);return a.intersectionGeometry.intersect(v$,_$,s,c,n,a.components.verticalOffsets,o)}addEdges(t,i,r,s){const n=t,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return i.addComponentObject(t,n.transform,{center:n.obb.center,radius:Xht(n.obb)},a,o,l,r,s)}async extractEdgeInformation(t,i,r){const s=t,n=s.components.visibility;if(n.allInvisible())return{buffer:zZ.createBuffer(0),origin:[0,0,0]};const{indices:o,positions:a}=s.intersectionGeometry,l=s.components.offsets,c=oO.createBuffer(a.count);cU(c.position,a),Mv(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,o,l);const h=c.count,p=this._computeVisibilityIndices(o,n,l,h);return{origin:Is(s.transform.position),buffer:await i.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},r)}}_setComponentIndices(t,i,r){let s=0;for(let n=0;n<r.length-1;n++){const o=r[n],a=r[n+1];for(let l=o;l<a;l++){const c=i?i[l]:l;t.set(c,s)}s++}}_computeVisibilityIndices(t,i,r,s){if(t&&i.allVisible())return t;let n=0;i.forEachComponentRange((l,c)=>(n+=r[c]-r[l],!0));const o=(t==null?void 0:t.BYTES_PER_ELEMENT)===2||s<=65536?new Uint16Array(n):new Uint32Array(n);let a=0;return i.forEachComponentRange((l,c)=>{const h=r[l],p=r[c];for(let f=h;f<p;f++)o[a++]=t?t[f]:f;return!0}),o}addComponentHighlight(t,i){const r=t.components;R(r.highlightCounts)&&(r.highlightCounts=new Uint32Array(r.count+1)),r.highlightCounts[i]++===0&&(r.highlightsDirty(),this._notifyDirty()),r.highlightCounts[r.count]++}removeComponentHighlight(t,i){const r=t.components;if(R(r.highlightCounts))return void hae.warn("Removing non-existing highlight.");const s=r.highlightCounts[i],n=r.highlightCounts[r.count];if(s!==0){if(s>1)return r.highlightCounts[i]=s-1,void(r.highlightCounts[r.count]=n-1);r.highlightCounts[i]=0,r.highlightsDirty(),this._notifyDirty(),n===1?r.highlightCounts=null:r.highlightCounts[r.count]=n-1}else hae.warn("Removing non-existing highlight.")}clearHighlights(t){const i=t.components;_(i.highlightCounts)&&(i.highlightCounts=null,i.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(t){return t.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[_S.Visible]}_createRenderable(t,i){const r=this._renderManager.rctx,s=t.geometry,n=s.vertices.layoutParameters,o=ti.createVertex(r,yi.STATIC_DRAW,s.vertices.data),a=qs(s.indices,v=>ti.createIndex(r,yi.STATIC_DRAW,v)),l=hc(Bdt(n)),c=new Uint16Array(s.vertices.count);for(let v=0;v<i.count;v++){const w=i.offsets[v],b=i.offsets[v+1],S=i.materialDataIndices[v];if(_(s.indices))for(let T=w;T<b;T++)c[s.indices[T]]=S;else for(let T=w;T<b;T++)c[T]=S}const h=ti.createVertex(r,yi.STATIC_DRAW,c.buffer),p=new bn(t.transform,t.toMapSpace),f=new Ns(r,p.attributeLocations,{data:l,componentIndices:Ept},{data:o,componentIndices:h},a),m=new nTe(f,Pt.TRIANGLES,n,_(a)),y={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteSize+h.byteSize+(_(a)?a.byteSize:0)};return new $dt(p,m,y)}_notifyDirty(){this._renderManager.notifyDirty()}}const Ept=hc(Kr().u16(A.COMPONENTINDEX));function PV(e,t){return e===t?cn.All:e===0?cn.None:cn.Some}const dae=hg(),v$=O(),_$=O();class vTe extends Us{constructor(){super(...arguments),this.overlayIndex=0,this.opacity=1}}function Cpt(e){const t=new Bi;t.include(zv);const i=t.fragment;switch(e.function){case Hl.Standard:i.uniforms.add(new zt("tex",r=>r.texture)),e.hasOpacityFactor?(i.uniforms.add(new We("opacity",r=>r.opacity)),i.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv) * opacity;
}`)):i.code.add(x`void main() {
gl_FragColor = texture2D(tex, uv);
}`);break;case Hl.OverlayWithTransparency:i.uniforms.add(new zt("tex",r=>r.texture)),i.uniforms.add(new n3("overlayIdx",r=>r.overlayIndex)),e.hasOpacityFactor&&i.uniforms.add(new We("opacity",r=>r.opacity)),i.code.add(x`
        void main() {
          vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
          gl_FragColor = texture2D(tex, overlayUV) ${e.hasOpacityFactor?"* opacity":""};
        }`);break;case Hl.TransparentToHUDVisibility:i.uniforms.add(new zt("tex",r=>r.texture)),i.code.add(x`void main() {
gl_FragColor = vec4(1.0 - texture2D(tex, uv).a);
}`);break;case Hl.Transparency:i.uniforms.add([new zt("colorTexture",r=>r.colorTexture),new zt("alphaTexture",r=>r.alphaTexture),new zt("frontFaceTexture",r=>r.frontFaceTexture)]),i.code.add(x`void main() {
vec4 srcColor = texture2D(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture2D(alphaTexture, uv).r;
vec4 frontFace = texture2D(frontFaceTexture, uv);
gl_FragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`);break;case Hl.COUNT:break;default:e.function}return t}const Apt=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:vTe,build:Cpt},Symbol.toStringTag,{value:"Module"}));class aO extends lr{initializeProgram(t){const i=aO.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){if(this.configuration.function===Hl.TransparentToHUDVisibility)return Ut({colorWrite:{r:!1,g:!0,b:!1,a:!1}});switch(this.configuration.alphaMode){case bo.None:return Ut({colorWrite:Jt});case bo.Alpha:return Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt});default:return Ut({blending:zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt})}}}aO.shader=new Qi(Apt,()=>import("./Compositing.glsl.e0d26e27.js"));class Rpt{constructor(t,i){this._rctx=t,this._techniqueRepository=i,this._configuration=new KD,this._passParameters=new vTe}dispose(){this._vao=Ye(this._vao)}compositeTransparent(t,i,r,s,n=1){this._configuration.alphaMode=bo.Alpha,this._configuration.function=Hl.Transparency,this._configuration.hasOpacityFactor=n!==1,this._passParameters.colorTexture=i,this._passParameters.alphaTexture=r,this._passParameters.frontFaceTexture=s;const o=this._rctx,a=this._techniqueRepository.acquire(aO,this._configuration);o.bindTechnique(a,this._passParameters,t);const l=this._ensureVAO();o.bindVAO(l),o.drawArrays(Pt.TRIANGLE_STRIP,0,xo(l,"geometry")),a.release()}composite(t,i,r=bo.None,s=1,n=Hl.Standard,o=Pr.INNER){const a=this._rctx;this._configuration.alphaMode=r,this._configuration.function=n,this._configuration.hasOpacityFactor=s!==1,this._passParameters.overlayIndex=o,this._passParameters.texture=i,this._passParameters.opacity=s;const l=this._techniqueRepository.acquire(aO,this._configuration);a.bindTechnique(l,this._passParameters,t);const c=this._ensureVAO();a.bindVAO(c),a.drawArrays(Pt.TRIANGLE_STRIP,0,xo(c,"geometry")),l.release()}_ensureVAO(){return R(this._vao)&&(this._vao=Ma(this._rctx)),this._vao}}const Mpt=1e4,zj=100,Opt=500,Ppt=500,Ipt=.1;function $pt(e,t,i){return OY(t,e)*(i[1]-i[0])+i[0]}function Dpt(e,t,i){if(t.size<Mpt)return Bpt.compute(e,t);const r=u3();return i.forAll(s=>{s.isVisible&&L2(r,Lpt(e,s))}),r}function Lpt(e,t){if(!t.isVisible)return;const i=u3(),r=t.getSpatialQueryAccelerator();return _(r)?Npt(i,e,r):Fpt(i,e,t.objects),i}function Npt(e,t,i){const r=t.eye,s=t.viewForward,n=t.frustum,o=l=>l.isVisible,a=i.objectCount;if(a<Opt)nO(ih,t.near,Math.min(e.near,t.far)),i.forEachInDepthRange(r,s,Ud.DepthOrder.FRONT_TO_BACK,ih,(l,c)=>{Vj(e,t,l),ih.far=e.near,c.setRange(ih)},n,o),nO(ih,Math.max(e.far,t.near),t.far),i.forEachInDepthRange(r,s,Ud.DepthOrder.BACK_TO_FRONT,ih,(l,c)=>{Vj(e,t,l),ih.near=e.far,c.setRange(ih)},n,o);else{const l=Math.max(Math.min(a,Ppt),Math.ceil(a*Ipt)),c=i.findClosest(s,Ud.DepthOrder.FRONT_TO_BACK,n,o,l),h=i.findClosest(s,Ud.DepthOrder.BACK_TO_FRONT,n,o,l);c&&h&&(pae(e,t,c.boundingVolumeWorldSpace.bounds),pae(e,t,h.boundingVolumeWorldSpace.bounds))}}function Fpt(e,t,i){Tx.clear(),i.forAll(r=>{r.isVisible&&r.geometryRecords.length!==0&&Tx.add(r)}),Tx.empty||(Tx.sort(t),nO(ih,t.near,Math.min(e.near,t.far)),Tx.forEachInDepthRange(ih,Ud.DepthOrder.FRONT_TO_BACK,(r,s)=>{s<e.near&&Vj(e,t,r)}),nO(ih,Math.max(e.far,t.near),t.far),Tx.forEachInDepthRange(ih,Ud.DepthOrder.BACK_TO_FRONT,(r,s,n)=>{e.far=Math.max(e.far,n)}))}function Vj(e,t,i){if(!i.isVisible||!H0(t.frustum,i.boundingVolumeWorldSpace.bounds))return;const r=i.transformation,s=Vpt;i.geometryRecords.forEach(n=>{Nr(s,r,n.getShaderTransformation());const o=Lb(s);_Te(e,t,n.geometry.boundingInfo,s,o)})}function _Te(e,t,i,r,s){if(R(i))return;const n=t.eye,o=t.viewForward;Ue(vo,i.center,r);const a=o[0]*(vo[0]-n[0])+o[1]*(vo[1]-n[1])+o[2]*(vo[2]-n[2]);if(vo[3]=i.radius*s,!(a-vo[3]>e.near&&a+vo[3]<e.far)&&H0(t.frustum,vo))if(i.radius>zj&&i.getChildren()){const l=i.getChildren();for(let c=0;c<8;++c)l[c]&&_Te(e,t,l[c],r,s)}else Bj.unionDepthRangeWithAABB(e,t.viewProjectionMatrix,r,i.bbMin,i.bbMax)}function pae(e,t,i){const r=t.eye,s=t.viewForward,n=(i[0]-r[0])*s[0]+(i[1]-r[1])*s[1]+(i[2]-r[2])*s[2];e.near=Math.min(e.near,n-i[3]),e.far=Math.max(e.far,n+i[3])}class Upt{constructor(){this._items=new Bt({allocator:t=>t||{obj:null,distance:0,near:0,far:0},deallocator:t=>(t.obj=null,t.distance=0,t.near=0,t.far=0,t)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(t){this._items.pushNew().obj=t}sort(t){const i=t.eye,r=t.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-i[0])*r[0]+(n[1]-i[1])*r[1]+(n[2]-i[2])*r[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(t,i,r){if(i===Ud.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<t.near||n.near>t.far||r(n.obj,n.near,n.far)}}}class kpt{constructor(){this.view=Ae(),this.viewProj=Ae(),this.frustum=UM(),this.geometries=[],this.near=[],this.far=[],this.nearCandidates=[],this.farCandidates=[],this.range={near:0,far:0},this.looseRange={near:0,far:0}}compute(t,i){this._reset(),ms(this.view,t.viewMatrix),Nr(this.viewProj,t.projectionMatrix,this.view),tF(this.frustum,t.frustum);const r=this.view,s=r[2],n=r[6],o=r[10],a=r[14],l=this.range;let c=0;if(i.forEach(m=>{if(!m.instanceParameters.visible||!m.castShadow)return;let y;m.hasShaderTransformation?(m.computeBoundingSphere(m.getShaderTransformation(),vo,1),y=vo):y=m.boundingSphere;const v=s*y[0]+n*y[1]+o*y[2]+a,w=v-y[3],b=v+y[3];this.geometries[c]=m,this.near[c]=-b,this.far[c]=-w,++c}),this.geometries.length===0)return l;for(let m=0;m<this.geometries.length;++m)this.near[m]>l.far&&(l.far=this.near[m]),this.near[m]>2&&this.far[m]<l.near&&(l.near=this.far[m]);const h=this.looseRange;h.near=Math.max(.5*l.near,2),h.far=2*l.far;let p=0,f=0;for(let m=0;m<this.geometries.length;++m)this.near[m]<l.near&&(this.near[m]>=h.near?l.near=this.near[m]:this.nearCandidates[p++]=m),this.far[m]>l.far&&(this.far[m]<=h.far?l.far=this.far[m]:this.farCandidates[f++]=m);if(this.nearCandidates.length===0&&this.farCandidates.length===0)return l;this.nearCandidates.sort((m,y)=>this.near[m]<this.near[y]?-1:this.near[m]>this.near[y]?1:0),this.farCandidates.sort((m,y)=>this.far[m]<this.far[y]?1:this.far[m]>this.far[y]?-1:0);for(let m=0;m<this.nearCandidates.length;++m){const y=this.nearCandidates[m];if(this.near[y]<l.near){const v=this.geometries[y],w=v.boundingInfo;this._includeNearBoundingInfoRec(w,v.getShaderTransformation())}}for(let m=0;m<this.farCandidates.length;++m){const y=this.farCandidates[m];if(this.far[y]>l.far){const v=this.geometries[y],w=v.boundingInfo;this._includeFarBoundingInfoRec(w,v.getShaderTransformation())}}return l}_reset(){this.geometries.length=0,this.near.length=0,this.far.length=0,this.nearCandidates.length=0,this.farCandidates.length=0,this.range.near=Number.MAX_VALUE,this.range.far=-Number.MAX_VALUE}_includeNearBoundingInfoRec(t,i){if(R(t))return;const r=t.getCenter();Ue(vo,r,i);const s=Lb(i),n=vo[0],o=vo[1],a=vo[2],l=t.getBSRadius()*s,c=this.frustum;if(c[0][0]*n+c[0][1]*o+c[0][2]*a+c[0][3]>l||c[1][0]*n+c[1][1]*o+c[1][2]*a+c[1][3]>l||c[2][0]*n+c[2][1]*o+c[2][2]*a+c[2][3]>l||c[3][0]*n+c[3][1]*o+c[3][2]*a+c[3][3]>l)return;const h=this.view[2]*n+this.view[6]*o+this.view[10]*a+this.view[14],p=h+l;if(!(-(h-l)<2||-p>=this.range.near))if(-p>this.looseRange.near)this.range.near=-p;else{if(l>zj){const f=t.getChildren();if(f!==void 0){for(let m=0;m<8;++m)f[m]!==void 0&&this._includeNearBoundingInfoRec(f[m],i);return}}Bj.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}_includeFarBoundingInfoRec(t,i){if(R(t))return;let r=t.getBSRadius();const s=t.getCenter();Ue(vo,s,i);const n=Lb(i),o=vo[0],a=vo[1],l=vo[2];r*=n;const c=this.frustum;if(c[0][0]*o+c[0][1]*a+c[0][2]*l+c[0][3]>r||c[1][0]*o+c[1][1]*a+c[1][2]*l+c[1][3]>r||c[2][0]*o+c[2][1]*a+c[2][2]*l+c[2][3]>r||c[3][0]*o+c[3][1]*a+c[3][2]*l+c[3][3]>r)return;const h=this.view[2]*o+this.view[6]*a+this.view[10]*l+this.view[14]-r;if(!(-h<=this.range.far))if(-h<this.looseRange.far)this.range.far=-h;else{if(r>zj){const p=t.getChildren();if(p!==void 0){for(let f=0;f<8;++f)p[f]!==void 0&&this._includeFarBoundingInfoRec(p[f],i);return}}Bj.unionDepthRangeWithAABB(this.range,this.viewProj,i,t.getBBMin(),t.getBBMax())}}}class zpt{constructor(){this.modelViewProj=Ae(),this.clipPosition=[Gt(),Gt(),Gt(),Gt(),Gt(),Gt(),Gt(),Gt()]}unionDepthRangeWithAABB(t,i,r,s,n){const o=this.modelViewProj;Nr(o,i,r);let a=!1;for(let l=0;l<8;++l){const c=this.clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this.clipPosition[IV[l][0]],h=this.clipPosition[IV[l][1]],p=this.clipPosition[IV[l][2]],f=this._clipTriangle(c,h,p);let m=!0;for(let y=0;y<f.length;++y)if(f[y][3]>=2){m=!1;break}if(!m){a=!0;for(let y=0;y<f.length;++y){const v=f[y][3];v<t.near&&(t.near=v),v>t.far&&(t.far=v)}}}return a}_inside(t,i){return i===0?t[0]>=-t[3]:i===1?t[1]>=-t[3]:i===2?t[0]<=t[3]:i===3?t[1]<=t[3]:void dt(!1)}_intersect(t,i,r){let s=0;return r===0?s=(-t[3]-t[0])/(i[0]-t[0]+i[3]-t[3]):r===1?s=(-t[3]-t[1])/(i[1]-t[1]+i[3]-t[3]):r===2?s=(t[3]-t[0])/(i[0]-t[0]-i[3]+t[3]):r===3&&(s=(t[3]-t[1])/(i[1]-t[1]-i[3]+t[3])),ZF(Gt(),t,i,s)}_clipTriangle(t,i,r){let s=[t,i,r];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}}const IV=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],vo=fn(),Vpt=Ae(),ih=u3(),Tx=new Upt,Bpt=new kpt,Bj=new zpt;class Gpt extends Us{constructor(){super(...arguments),this.maskEnabled=!1,this.overlayEnabled=!1}}function jpt(){const e=new Bi;return e.attributes.add(A.POSITION,"vec2"),e.vertex.uniforms.add(new xa("drawPosition")),e.varyings.add("vUV","vec2"),e.vertex.code.add(x`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),e.fragment.uniforms.add(new $r("textureInput")),e.fragment.uniforms.add(new $r("textureMask")),e.fragment.uniforms.add(new $r("textureOverlay")),e.fragment.uniforms.add(new Gb("maskEnabled",t=>t.maskEnabled)),e.fragment.uniforms.add(new Gb("overlayEnabled",t=>t.overlayEnabled)),e.fragment.code.add(x`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture2D(textureMask, vUV).a : 1.0;
vec4 inputColor = texture2D(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture2D(textureOverlay, vUV) : vec4(0);
gl_FragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),e}async function Hpt(e){const t=import("./mask-svg.d736db49.js"),i=import("./overlay-svg.ddc1dd43.js"),r=Qd((await t).default,{signal:e}),s=Qd((await i).default,{signal:e}),n={mask:await r,overlay:await s};return li(e),n}let dT=class extends Ee{constructor(){super(...arguments),this._handles=new qt,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new Gpt,this.events=new us,this.attributeLocations=new Map([[A.POSITION,0]]),this.tmpScreenPoint=Vr(),this.tmpRenderPoint=GAe()}get updating(){return R(this._imageSources)&&_(this._imageLoadTask)&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const t=()=>{this._updateResourceLoading(),this.events.emit("request-render")};_(this._magnifier)&&this._handles.add(ae(()=>qs(this._magnifier,i=>i.version),t)),t()}get enabled(){return _(this._validMagnifier)}get _validMagnifier(){return _(this._magnifier)&&this._magnifier.visible&&_(this._magnifier.position)&&this._magnifier.size>0?this._magnifier:null}get factor(){return _(this._magnifier)&&this._magnifier.factor||1}dispose(){this._magnifier=null,this._handles.destroy(),_(this._imageLoadTask)&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,t){const i=this._validMagnifier;if(R(i))return;const r=t.camera.pixelRatio,s=Math.ceil(r*i.size);if(this._updateResources(e,s),R(this._resources))return;this._passParameters.maskEnabled=i.maskEnabled,this._passParameters.overlayEnabled=i.overlayEnabled;const n=this._resources.program;e.useProgram(n),n.bindPass(this._passParameters,t);const o=this._resources.textures,a=Math.ceil(1/this.factor*s);o.input.resize(a,a);const l=t.camera.fullWidth,c=t.camera.fullHeight;qm(i.position,this.tmpScreenPoint);const h=t.camera.screenToRender(this.tmpScreenPoint,this.tmpRenderPoint),p=.5*a,f=.5*a;h[0]=$e(h[0],p,l-p-1),h[1]=$e(h[1],f,c-f-1);const m=Math.floor(h[0]-p),y=Math.floor(h[1]-f);n.bindTexture("textureInput",o.input),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,m,y,a,a,0);const v=i.offset.x*r,w=i.offset.y*r,b=(h[0]+v)/l*2-1,S=(h[1]-w)/c*2-1,T=s/l*2,E=s/c*2;e.bindVAO(this._resources.vao),n.bindTexture("textureOverlay",o.overlay),n.bindTexture("textureMask",o.mask),n.setUniform4f("drawPosition",b,S,T,E),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Pt.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(R(e))return;const t=e.maskUrl,i=e.overlayUrl;!_(this._imageLoadTask)||this._imageLoadTask.maskUrl===t&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),_(this._imageSources)||_(this._imageLoadTask)||(this._imageLoadTask={maskUrl:t,overlayUrl:i,task:mO(async r=>{const s=R(t)||R(i)?Hpt(r):null,n=_(t)?Qd(t,{signal:r}):s.then(a=>a.mask),o=_(i)?Qd(i,{signal:r}):s.then(a=>a.overlay);this._imageSources={mask:await n,overlay:await o},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,t){if(!this.enabled)return void this._disposeResources();if(_(this._resources)){if(this._resources.textures.size!==t){const r=this._createTextureResources(e,t);if(R(r))return void this._disposeResources();this._disposeTextureResources(this._resources.textures),this._resources.textures=r}return}const i=this._createTextureResources(e,t);R(i)||(this._resources={textures:i,program:this._createProgram(e),vao:Ma(e,MX,this.attributeLocations,0,1),pipelineState:Ut({blending:zf(Re.ONE,Re.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Jt})})}_disposeResources(){R(this._resources)||(this._disposeTextureResources(this._resources.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,t){if(R(this._imageSources))return null;this._imageSources.overlay.width=t,this._imageSources.overlay.height=t,this._imageSources.mask.width=t,this._imageSources.mask.height=t;const i=new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!0,preMultiplyAlpha:!yq(this._imageSources.overlay.src)||!e.driverTest.svgAlwaysPremultipliesAlpha},this._imageSources.overlay),r=new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.ALPHA,internalFormat:ze.ALPHA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!0},this._imageSources.mask);return{input:new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR,flipped:!1}),mask:r,overlay:i,size:t}}_createProgram(e){return new Ji(e,jpt(),this.attributeLocations)}};u([d()],dT.prototype,"_imageSources",void 0),u([d()],dT.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],dT.prototype,"updating",null),dT=u([P("esri/views/3d/webgl-engine/lib/MagnifierHelper")],dT);const qpt=.5,Wpt=1e3/30;var lO;(function(e){e[e.FrontToBack=0]="FrontToBack",e[e.BackToFront=1]="BackToFront"})(lO||(lO={}));class Cy{constructor(t,i,r=lO.FrontToBack){this._rctx=t,this._techniqueRepository=i,this._sorting=r,this._draws=new Bt({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(t,i,r,s){const n=this._draws.pushNew();n.geometry=i,n.geometryRanges=r,n.material=t,n.depthSquaredHint=s,n.indexType=i.indexed?i.vao.indexBuffer.indexType:0}dispatch(t,i){const r=this._rctx;this._previouslyBoundDraw.clear();let s=null;const n=this._draws.map(a=>a.material.prepareTechnique(this._techniqueRepository,t,i,a.geometry.parameters)),o=this._draws.length;for(let a=0;a<o;a++){const l=n[a];l===s&&l.configuration.transparencyPassType===gt.NONE||(r.bindTechnique(l,t,i),s=l);const c=this._draws.data[a],h=c.geometry;r.bindVAO(h.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.bindDraw(c.material,i),this._previouslyBoundDraw.set(l,c.material));const p=c.geometryRanges,f=p.length;if(c.indexType!==0){const m=bL.get(c.indexType);for(let y=0;y<f;y+=2){const v=p[y],w=p[y+1];r.drawElements(h.primitiveType,w,c.indexType,v*m)}}else for(let m=0;m<f;m+=2){const y=p[m],v=p[m+1];r.drawArrays(h.primitiveType,y,v)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const t=this._sorting===lO.FrontToBack?1:-1;this._draws.sort((i,r)=>{const s=t*(i.depthSquaredHint-r.depthSquaredHint);return s!==0?s:i.geometry.vao.size-r.geometry.vao.size})}get count(){return this._draws.length}}const bL=new Map;bL.set(ht.UNSIGNED_BYTE,1),bL.set(ht.UNSIGNED_SHORT,2),bL.set(ht.UNSIGNED_INT,4);class Xpt{constructor(t,i){this.rctx=t,this.shaderTechniqueRepository=i,this.canRender=!0,this._materialPassParameters=new Wut,this._shadowPassParameters=new Xut,this._highlightPassParameters=new Yut,this._systems=new Set,this._passes={materialOpaque:new Cy(t,i),materialTransparent:new Cy(t,i,lO.BackToFront),materialIntegratedMesh:new Cy(t,i),shadowMap:new Cy(t,i),highlight:new Cy(t,i),highlightIntegratedMesh:new Cy(t,i),highlightShadowMap:new Cy(t,i),defaultShadowMap:new Cy(t,i)}}register(t){this._systems.add(t)}prepareRender(t){if(this._systems.size!==0){for(const i of Object.values(this._passes))i.prepareSubmit();this._systems.forEach(i=>i.submit(this._passes,t.bindParameters));for(const i of Object.values(this._passes))i.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}render(t){if(this._systems.size!==0)switch(this._configure(t),t.bindParameters.slot){case Se.OPAQUE_MATERIAL:switch(t.pass){case je.MATERIAL:return this._materialPassParameters.subPass=Hn.Color,this._passes.materialOpaque.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_DEPTH:return this._materialPassParameters.subPass=Hn.Depth,this._passes.materialOpaque.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_NORMAL:return this._materialPassParameters.subPass=Hn.Normal,this._passes.materialOpaque.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_HIGHLIGHT:return this._passes.highlight.dispatch(this._highlightPassParameters,t.bindParameters);case je.MATERIAL_DEPTH_SHADOWMAP_ALL:return this._passes.shadowMap.dispatch(this._shadowPassParameters,t.bindParameters);case je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT:return this._passes.highlightShadowMap.dispatch(this._shadowPassParameters,t.bindParameters);case je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT:return this._passes.defaultShadowMap.dispatch(this._shadowPassParameters,t.bindParameters)}return;case Se.TRANSPARENT_MATERIAL:switch(t.pass){case je.MATERIAL:return this._materialPassParameters.subPass=Hn.Color,this._passes.materialTransparent.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_ALPHA:return this._materialPassParameters.subPass=Hn.Alpha,this._passes.materialTransparent.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_DEPTH:return this._materialPassParameters.subPass=Hn.Depth,this._passes.materialTransparent.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_NORMAL:return this._materialPassParameters.subPass=Hn.Normal,this._passes.materialTransparent.dispatch(this._materialPassParameters,t.bindParameters)}return;case Se.INTEGRATED_MESH:switch(t.pass){case je.MATERIAL:return this._materialPassParameters.subPass=Hn.Color,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_DEPTH:return this._materialPassParameters.subPass=Hn.Depth,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_NORMAL:return this._materialPassParameters.subPass=Hn.Normal,this._passes.materialIntegratedMesh.dispatch(this._materialPassParameters,t.bindParameters);case je.MATERIAL_HIGHLIGHT:return this._passes.highlightIntegratedMesh.dispatch(this._highlightPassParameters,t.bindParameters)}return}}notifyDirty(){this._context.requestRender()}slots(){return[Se.OPAQUE_MATERIAL,Se.TRANSPARENT_MATERIAL,Se.INTEGRATED_MESH]}initializeRenderContext(t){this._context=t}uninitializeRenderContext(){}queryDepthRange(t){const i={near:1/0,far:-1/0};return this._systems.forEach(r=>{const s=r.queryShadowCasterDepthRange(t);_(s)&&L2(i,s,i)}),i}_configure(t){const i=t.pass===je.MATERIAL_DEPTH_SHADOWMAP_ALL||t.pass===je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT||t.pass===je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT?this._shadowPassParameters:t.pass===je.MATERIAL_HIGHLIGHT?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(t,i)}_updateParameters(t,i){const r=t.bindParameters.camera,s=r.viewInverseTransposeMatrix;ie($V,s[3],s[7],s[11]),DV.set($V),se(i.transformWorldFromViewTH,DV.high),se(i.transformWorldFromViewTL,DV.low),se(i.slicePlaneLocalOrigin,$V),Ch(i.transformViewFromCameraRelativeRS,r.viewMatrix),ms(i.transformProjFromView,r.projectionMatrix),i.identifier===Zc.Material&&(this._materialPassParameters.transparent=t.bindParameters.slot===Se.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=t.bindParameters.slot===Se.INTEGRATED_MESH,Ah(fae,i.transformViewFromCameraRelativeRS),ww(i.transformNormalViewFromGlobal,fae))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}}const $V=O(),fae=Sr(),DV=new RU,Ypt=8.6,Zpt=.4;function Qpt(){const e=new Bi,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(A.POSITION,"vec2"),e.varyings.add("uv","vec2"),e.attributes.add(A.UV0,"vec2"),t.uniforms.add(new zt("coverageTex",n=>n.coverageTexture)),r.add(x`void main() {
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),i.uniforms.add(new zt("tex",n=>n.blurColorTexture)),i.uniforms.add(new zt("origin",n=>n.highlightColorTexture)),i.uniforms.add(new ei("uColor",n=>n.color)),i.uniforms.add(new ei("haloColor",n=>n.haloColor)),i.uniforms.add(new ei("opacities",n=>qi(Jpt,n.haloOpacity,n.haloOpacityOccluded,n.fillOpacity,n.fillOpacityOccluded))),i.constants.add("outlineSize","float",Ypt),i.constants.add("blurSize","float",Zpt),s.add(x`void main() {
vec4 blurredHighlightValue = texture2D(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture2D(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
gl_FragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),e}const Jpt=Gt(),Kpt=Object.freeze(Object.defineProperty({__proto__:null,build:Qpt},Symbol.toStringTag,{value:"Module"}));class MU extends lr{initializeProgram(t){const i=MU.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt})}}MU.shader=new Qi(Kpt,()=>import("./HighlightApply.glsl.35d997a5.js"));class bTe extends Us{constructor(){super(...arguments),this.blurSize=tt()}}function eft(){const e=new Bi,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(A.POSITION,"vec2"),e.attributes.add(A.UV0,"vec2"),e.varyings.add("blurCoordinate","vec3"),t.uniforms.add(new zt("coverageTex",n=>n.coverageTexture)),i.uniforms.add(new NX("blurSize",n=>n.blurSize)),r.add(x`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture2D(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),i.uniforms.add(new FX("tex",n=>n.blurInputTexture)),s.add(x`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture2D(tex, uv);
if (blurCoordinate.z == 1.0) {
gl_FragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture2D(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture2D(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture2D(tex, uv - blurSize * 3.294215) * 0.093913;
gl_FragColor = sum;
}
}`),e}const tft=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:bTe,build:eft},Symbol.toStringTag,{value:"Module"}));class OU extends lr{initializeProgram(t){const i=OU.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({colorWrite:Jt})}}OU.shader=new Qi(tft,()=>import("./HighlightBlur.glsl.c0565de7.js"));class wTe extends Us{constructor(){super(...arguments),this.invFramebufferDim=tt()}}function ift(){const e=new Bi,{vertex:t,fragment:i}=e,r=t.code,s=i.code;return e.attributes.add(A.POSITION,"vec2"),r.add(x`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),i.uniforms.add(new FX("tex",n=>n.inputTexture)),i.uniforms.add(new NX("invFramebufferDim",n=>n.invFramebufferDim)),s.add(x`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture2D(tex, coord);
float mx = floor(max(value.g, value.b));
gl_FragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),e}const rft=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:wTe,build:ift},Symbol.toStringTag,{value:"Module"}));class PU extends lr{initializeProgram(t){const i=PU.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({colorWrite:Jt})}}PU.shader=new Qi(rft,()=>import("./HighlightDownsample.glsl.16a14f88.js"));class mae extends Us{constructor(){super(...arguments),this.color=Ph(1,0,1,1),this.haloColor=Ph(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=fi(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}}const sft=32;class nft{constructor(t,i){this._techniqueRep=t,this._rctx=i,this.viewportToRestore=Gt(),this._passParameters=new mae,this._downsampleDrawParameters=new wTe,this._blurDrawParameters=new bTe,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this.quadVAO)return;this.quadVAO=Ma(this._rctx);const t={colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE,width:0,height:0},i={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:0,height:0};this.blur0Fbo=new xr(this._rctx,t,i),this.blur1Fbo=new xr(this._rctx,t,i);const r=new Ra;this._blurTechnique=this._techniqueRep.acquire(OU,r),this._downsampleTechnique=this._techniqueRep.acquire(PU,r),this._applyTechnique=this._techniqueRep.acquire(MU,r)}dispose(){if(this._blurTechnique=Wi(this._blurTechnique),this._downsampleTechnique=Wi(this._downsampleTechnique),this._applyTechnique=Wi(this._applyTechnique),this._grid.coverageMipmap)for(let t=1;t<this._grid.coverageMipmap.length;t++)this._grid.coverageMipmap[t].dispose();this._grid.vao&&this._grid.vao.dispose(!0),this.quadVAO&&(this.quadVAO.dispose(!0),this.quadVAO=null),this.blur0Fbo=Ye(this.blur0Fbo),this.blur1Fbo=Ye(this.blur1Fbo)}setDefaultOptions(t){this._passParameters=F(F({},new mae),t)}render(t,i,r){this._passParameters.highlightColorTexture=i.colorTexture,this._assertResources();const s=t.camera;Pd(this.viewportToRestore,s.fullViewport);const n=s.fullWidth,o=s.fullHeight,a=s.pixelRatio,l=Math.ceil(n/a),c=Math.ceil(o/a);this.blur0Fbo.resize(l,c),this.blur1Fbo.resize(l,c);const h=this._rctx;h.bindVAO(this.quadVAO);let p=null;this._gridUpdateResources(i,sft),this._gridComputeMipmap(t),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,p=this._grid.vao;const f=h.bindTechnique(this._blurTechnique,this._passParameters,t);h.bindVAO(p),h.bindFramebuffer(this.blur0Fbo),h.setViewport(0,0,l,c),h.setClearColor(0,0,0,0),h.clear(Xi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=i.colorTexture,hi(this._blurDrawParameters.blurSize,1/l,0),f.bindDraw(this._blurDrawParameters,t),h.drawArrays(this._blurTechnique.primitiveType,0,xo(p,"geometry")),h.bindFramebuffer(this.blur1Fbo),h.clear(Xi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this.blur0Fbo.colorTexture,hi(this._blurDrawParameters.blurSize,0,1/c),f.bindDraw(this._blurDrawParameters,t),h.drawArrays(this._blurTechnique.primitiveType,0,xo(p,"geometry")),h.bindFramebuffer(r),h.setViewport(this.viewportToRestore[0],this.viewportToRestore[1],this.viewportToRestore[2],this.viewportToRestore[3]),this._passParameters.blurColorTexture=this.blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,t),h.drawArrays(this._applyTechnique.primitiveType,0,xo(p,"geometry")),h.bindVAO(null)}_gridUpdateResources(t,i){const r=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[t],n=!0),s.viewportWidth===t.width&&s.viewportHeight===t.height||(n=!0,s.viewportWidth=t.width,s.viewportHeight=t.height),s.coverageMipmap[0]=t,s.cellPixelSize!==i&&(s.cellPixelSize=i,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h={target:pt.TEXTURE_2D,pixelFormat:ze.RGB,dataType:St.UNSIGNED_SHORT_5_6_5,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)},p={colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE,width:Math.ceil(c.width/2),height:Math.ceil(c.height/2)};s.coverageMipmap[l+1]=new xr(r,p,h)}}const o=Math.ceil(t.height/s.cellPixelSize),a=Math.ceil(t.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,m=4,y=new Float32Array(f*m*l*c);let v=0;for(let w=0;w<l;w++)for(let b=0;b<c;b++)y[v+0]=(b-.5)*p*2-1,y[v+1]=(w-.5)*h*2-1,y[v+2]=b*p,y[v+3]=w*h,y[v+4]=(b+.5)*p*2-1,y[v+5]=(w-.5)*h*2-1,y[v+6]=b*p,y[v+7]=w*h,y[v+8]=(b-.5)*p*2-1,y[v+9]=(w+.5)*h*2-1,y[v+10]=b*p,y[v+11]=w*h,y[v+12]=(b-.5)*p*2-1,y[v+13]=(w+.5)*h*2-1,y[v+14]=b*p,y[v+15]=w*h,y[v+16]=(b+.5)*p*2-1,y[v+17]=(w-.5)*h*2-1,y[v+18]=b*p,y[v+19]=w*h,y[v+20]=(b+.5)*p*2-1,y[v+21]=(w+.5)*h*2-1,y[v+22]=b*p,y[v+23]=w*h,v+=f*m;s.vao&&s.vao.dispose(!0),s.vao=new Ns(r,Di,{geometry:VO},{geometry:ti.createVertex(r,yi.STATIC_DRAW,y)})}}_gridComputeMipmap(t){const i=this._rctx,r=this._grid,s=i.bindTechnique(this._downsampleTechnique,this._passParameters,t);i.bindVAO(this.quadVAO);for(let n=0;n<r.mipmapLevels;n++){i.bindFramebuffer(r.coverageMipmap[n+1]);const o=r.coverageMipmap[n+1].width,a=r.coverageMipmap[n+1].height;this._downsampleDrawParameters.inputTexture=r.coverageMipmap[n].colorTexture,hi(this._downsampleDrawParameters.invFramebufferDim,1/o,1/a),s.bindDraw(this._downsampleDrawParameters,t),i.setViewport(0,0,o,a),i.drawArrays(Pt.TRIANGLE_STRIP,0,xo(this.quadVAO,"geometry"))}}get gpuMemoryUsage(){let t=(_(this.blur0Fbo)?this.blur0Fbo.gpuMemoryUsage:0)+(_(this.blur1Fbo)?this.blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const i of this._grid.coverageMipmap)t+=i.gpuMemoryUsage;return t}get test(){return{coverage:this._grid.coverageMipmap,blur:[this.blur0Fbo,this.blur1Fbo]}}}const oft={dataType:St.UNSIGNED_BYTE,internalFormat:ze.RGBA},aft={};class lft{constructor(t){this.rctx=t,this._activeTargets=new Set,this._depthTextures=new Map,this._depthBuffers=new Map,this._colorTextures=new Map,this._framebuffers=new Map,this.depthTextureSupported=t.capabilities.depthTexture}dispose(){this._depthBuffers.forEach(t=>t.dispose()),this._depthBuffers.clear(),this._depthTextures.forEach(t=>t.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(t=>t.dispose()),this._colorTextures.clear(),this._framebuffers.forEach(t=>t.dispose()),this._framebuffers.clear(),this._activeTargets.clear()}disposeTargetResource(t){const i=t.id;this._activeTargets.has(i)&&(this._activeTargets.delete(i),this._disposeWithFramebuffers(this._depthTextures,i),this._disposeWithFramebuffers(this._depthBuffers,i),this._disposeWithFramebuffers(this._colorTextures,i))}_disposeWithFramebuffers(t,i){const r=t.get(i);r&&(this._framebuffers.forEach((s,n)=>{s.colorAttachment!==r&&s.depthStencilAttachment!==r||(s.detachAll(),s.dispose(),this._framebuffers.delete(n))}),r.dispose(),t.delete(i))}getDepthTexture(t,i){if(!this.depthTextureSupported)return null;let r=this._depthTextures.get(t.id);return!r||r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null),r||(r=new st(this.rctx,{target:pt.TEXTURE_2D,pixelFormat:ze.DEPTH_STENCIL,dataType:St.UNSIGNED_INT_24_8,samplingMode:Ke.NEAREST,wrapMode:_t.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._depthTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedDepthTexture(t){return this._depthTextures.get(t.id)}getDepthBuffer(t,i){if(this.depthTextureSupported)return null;let r=this._depthBuffers.get(t.id);return r?r.descriptor.width===i.width&&r.descriptor.height===i.height||r.resize(i.width,i.height):(r=new oT(this.rctx,F({internalFormat:va.DEPTH_STENCIL},i)),this._depthBuffers.set(t.id,r),this._activeTargets.add(t.id)),r}getColorTexture(t,i){let r=this._colorTextures.get(t.id);return r&&(r.descriptor.width===i.width&&r.descriptor.height===i.height||(r.dispose(),r=null)),r||(r=new st(this.rctx,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,internalFormat:t.internalFormat,dataType:t.dataType,samplingMode:t.samplingMode!=null?t.samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:i.width,height:i.height}),this._colorTextures.set(t.id,r),this._activeTargets.add(t.id)),r}getAllocatedColorTexture(t){return this._colorTextures.get(t.id)}registerDepthTarget(t={}){return F(F({id:sl()},aft),t)}registerColorTarget(t={}){return F(F({id:sl()},oft),t)}getFramebuffer(t,i,r){const s=this._getKey(i,r);let n=this._framebuffers.get(s);const o=this.getColorTexture(i,t);if(this.depthTextureSupported){const l=r?this.getDepthTexture(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o||n.depthStencilTexture!==l)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilTexture(l)),n):(n=_(r)?new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.DEPTH_STENCIL_TEXTURE},o,l):new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},o),this._framebuffers.set(s,n),n)}const a=r?this.getDepthBuffer(r,t):void 0;return n?((n.width!==t.width||n.height!==t.height||n.colorTexture!==o)&&(n.detachAll(),n.resize(t.width,t.height),n.attachColorTexture(o),n.attachDepthStencilBuffer(a)),n):(n=new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:r?xi.DEPTH_STENCIL_RENDER_BUFFER:xi.NONE},o,a),this._framebuffers.set(s,n),n)}_getKey(t,i){return`${t.id}_${i?i.id:"X"}_${t.name}${i?"_"+i.name:""}`}get gpuMemoryUsage(){let t=0;const i=new Set,r=s=>{i.has(s)||(i.add(s),t+=Bb(s))};return this._depthTextures.forEach(r),this._colorTextures.forEach(r),this._depthBuffers.forEach(r),t}}class cft{constructor(t,i){this._rctx=t,this._compositingHelper=i,this._mainColorTarget=0,this._dimensions={width:4,height:4},this._needLastFrameColorTexture=!1,this._background={type:"color",color:[0,0,0,1]};const r=t.type===ai.WEBGL2;this._renderTargetHelper=new lft(t);const s=this._renderTargetHelper;this.mainColorTargets=[s.registerColorTarget({name:"mainColorTarget0"}),s.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=s.registerColorTarget({name:"frontFaceTarget"});const n=o=>s.registerColorTarget({name:o,dataType:St.FLOAT,internalFormat:r?ft.RGBA32F:ze.RGBA,samplingMode:Ke.NEAREST});this.colorFloatTarget=n("colorFloatTarget"),this.alphaFloatTarget=n("alphaFloatTarget"),this.mainDepth=s.registerDepthTarget({name:"mainDepth"}),this.linearDepth=s.registerColorTarget({name:"linearDepth",samplingMode:Ke.NEAREST}),this.terrainLinearDepth=s.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=s.registerColorTarget({name:"geometryLinearDepth"}),this.normal=s.registerColorTarget({name:"normal"}),this.highlight=s.registerColorTarget({name:"highlight",internalFormat:r?ft.RGBA4:ze.RGBA,dataType:St.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=s.registerColorTarget({name:"hudVisibility",internalFormat:r?ft.RGBA4:ze.RGBA,dataType:St.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=s.registerColorTarget({name:"tmpColor"}),this.tmpDepth=s.registerDepthTarget({name:"tmpDepth"}),this.hudColor=s.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}get width(){return this._dimensions.width}get height(){return this._dimensions.height}set background(t){this._background=t}get background(){return this._background}get currentColorTarget(){return this.mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this.mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(t,i){return this._renderTargetHelper.getFramebuffer(this._dimensions,t,i)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}advanceCurrentRenderTarget(){this._mainColorTarget=this._mainColorTarget===0&&this._needLastFrameColorTexture?1:0}initializeFrame(t){const i=this._rctx;this._dimensions.width=t.fullWidth,this._dimensions.height=t.fullHeight,this.bindTarget(this.currentColorTarget,this.mainDepth),i.setClearStencil(0);const r=this._background.color;i.setClearColor(r[0]*r[3],r[1]*r[3],r[2]*r[3],r[3]),i.clearSafe(Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT|Xi.STENCIL_BUFFER_BIT)}composite(t){_(this.colorTexture)&&this._compositingHelper.composite(t,this.colorTexture,bo.None)}renderTmpAndCompositeToMain(t,i,r,s=!1){this.renderToTargets(t,this.tmpColor,s?this.tmpDepth:this.mainDepth,uft),this._compositingHelper.composite(i,this._getColorTexture(this.tmpColor),r)}renderHUDVisibility(t,i=!1){this.renderToTargets(t,this.hudVisibility,i?this.tmpDepth:this.mainDepth,hft)}compositeTransparentTerrainOntoHUDVisibility(t){this.renderToTargets(()=>this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),bo.None,1,Hl.TransparentToHUDVisibility),this.hudVisibility,this.tmpDepth)}renderOITPass(t,i,r){let s,n;switch(i){case gt.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case gt.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case gt.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0]}r?this.renderToTargets(t,s,this.tmpDepth,n,!0,!0):this.renderToTargets(t,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(t){this.bindFramebuffer(),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),bo.PremultipliedAlpha)}compositeOccludedOntoMain(t,i){this.bindFramebuffer(),this._compositingHelper.composite(t,this._getColorTexture(this.tmpColor),bo.PremultipliedAlpha,i)}compositeTransparentOntoOpaque(t,i){i?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeTransparent(t,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(t){this.bindTarget(this.currentColorTarget),t(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(t){this._renderTargetHelper.disposeTargetResource(t)}set needLastFrameColorTexture(t){!t&&this._needLastFrameColorTexture&&(this._mainColorTarget=0,this.disposeTarget(this.mainColorTargets[1])),this._needLastFrameColorTexture=t}get needLastFrameColorTexture(){return this._needLastFrameColorTexture}renderToTargets(t,i,r,s,n=!1,o=!1){const a=this._rctx,l=this.bindTarget(i,r);let c=0;if(s){const p=Math.max(1e-13,s[3]);a.setClearColor(s[0],s[1],s[2],p),c|=Xi.COLOR_BUFFER_BIT}return n&&(c|=Xi.DEPTH_BUFFER_BIT),o===!1?o=0:(o===!0&&(o=255),c|=Xi.STENCIL_BUFFER_BIT),c&&a.clearSafe(c,o),t(),a.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth),l}bindTarget(t,i){const r=this._renderTargetHelper.getFramebuffer(this._dimensions,t,i);return this._rctx.bindFramebuffer(r),r}_getColorTexture(t){return this._renderTargetHelper.getColorTexture(t,this._dimensions)}get gpuMemoryUsage(){let t=0;return this._renderTargetHelper&&(t+=this._renderTargetHelper.gpuMemoryUsage),t}}const uft=[0,0,0,0],hft=[0,1,0,1];class dft{constructor(t){this.context=t,this._renderPlugins=new Bt,this.slots=[];for(let i=0;i<Se.MAX_SLOTS;++i)this.slots[i]=[]}add(t,i,r){const s=()=>{if(r==null?void 0:r.aborted)throw i.uninitializeRenderContext(),ui();this._renderPlugins.push(i);for(const o of t)this.slots[o].push(i);this.context.requestRender()},n=i.initializeRenderContext(this.context,r);if(vu(n))return n.then(s);s()}remove(t){if(this._renderPlugins.removeUnordered(t)!=null){for(let i=0;i<this.slots.length;++i)this.slots[i]=this.slots[i].filter(r=>r!==t);t.uninitializeRenderContext(),this.context.requestRender()}}prepareRender(){this._renderPlugins.forAll(t=>{t.prepareRender&&t.prepareRender(this.context.renderContext)})}updateAnimation(t){let i=!1;return this._renderPlugins.forAll(r=>{r.updateAnimation&&(i=r.updateAnimation(t)||i)}),i}render(){const t=this.slots[this.context.renderContext.bindParameters.slot],i=new Array;t.filter(r=>{if(!r.canRender)return!1;if(pft(r)){const s=r.prepareTechnique(this.context.renderContext);return!!s&&(i.push(s),!0)}return i.push(null),!0}).forEach((r,s)=>r.render(this.context.renderContext,i[s]))}queryDepthRange(t){const i=fft;return i.near=1/0,i.far=-1/0,this._renderPlugins.forAll(r=>{if(r.queryDepthRange){const s=r.queryDepthRange(t);s&&L2(i,s,i)}}),i}get needsTransparentPass(){return this._renderPlugins.some(t=>t.needsTransparentPass)}get needsHighlight(){return this._renderPlugins.some(t=>t.needsHighlight)}get needsLinearDepth(){return this._renderPlugins.some(t=>t.needsLinearDepth)}get needsLaserlineWithContrastControl(){const t=this.slots[Se.LASERLINES_CONTRAST_CONTROL];return!!t&&t.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce((t,i)=>t|i.renderOccludedFlags,0)}}function pft(e){return"prepareTechnique"in e}const fft={near:0,far:0};class xTe extends Rbe{}const IU=255,mft=1/IU;function gft(){const e=new Bi,t=e.fragment;return t.include(uc),t.include(gu),e.include(K5),e.include(zv),e.include(Y5,{receiveShadows:!0}),t.uniforms.add([new zt("depthMap",i=>i.linearDepthTexture),new vr("inverseViewMatrix",(i,r)=>cs(gae,Aa(gae,r.camera.viewMatrix,r.camera.center))),new di("nearFar",(i,r)=>r.camera.nearFar)]),t.constants.add("sampleValue","float",mft),t.code.add(x`void main(void) {
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
gl_FragColor = vec4(sampleValue);
}`),e}const gae=Ae(),yft=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:xTe,shadowCastMaxSamples:IU,build:gft},Symbol.toStringTag,{value:"Module"}));var ow;(function(e){e[e.Gradient=0]="Gradient",e[e.Threshold=1]="Threshold",e[e.COUNT=2]="COUNT"})(ow||(ow={}));class Gj extends Ra{constructor(){super(...arguments),this.visualization=ow.Gradient,this.bandsEnabled=!1}}u([G({count:ow.COUNT})],Gj.prototype,"visualization",void 0),u([G()],Gj.prototype,"bandsEnabled",void 0);function vft(e){const t=new Bi,i=t.fragment;i.include(uc),i.include(gu),t.include(K5),t.include(zv);const{visualization:r,bandsEnabled:s}=e;i.constants.add("inverseSampleValue","float",IU),i.uniforms.add([new zt("shadowCastMap",a=>a.shadowCastMap),new We("sampleScale",a=>a.sampleScale),new We("opacityFromElevation",a=>a.opacityFromElevation),new ei("uColor",a=>a.color)]);const n=r===ow.Gradient,o=r===ow.Threshold;return n&&s?i.uniforms.add(new We("bandSize",a=>a.bandSize)):o&&i.uniforms.add(new We("threshold",a=>a.threshold)),i.code.add(x`
      void main(void) {
        vec4 record = texture2D(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?x`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?x`strength = ceil(strength / bandSize) * bandSize;`:""}

        gl_FragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?x`* strength`:""});
      }
    `),t}const _ft=Object.freeze(Object.defineProperty({__proto__:null,build:vft},Symbol.toStringTag,{value:"Module"}));class $U extends lr{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=$U.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:au,colorWrite:Jt,depthTest:null,depthWrite:null})}get primitiveType(){return Pt.TRIANGLE_STRIP}}$U.shader=new Qi(_ft,()=>import("./ShadowCastVisualize.glsl.ed127b8b.js"));const bft=fi(.01,0,.25,1),wft=4e4,xft=5e4,TTe=1/512;let wL=class extends Ee{constructor(e,t,i,r){super({}),this._techniqueRepository=e,this._rctx=t,this._shadowAccumulator=i,this._requestRender=r,this._passParameters={shadowCastMap:this._shadowCastTexture,sampleScale:0,color:bft,threshold:.5,bandSize:.1,opacityFromElevation:1,__tagStrict:"NoParameters"},this._techniqueConfig=new Gj,this._enabled=!1,this._vao=Ma(t),this._techniqueConfig.visualization=ow.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=Ye(this._vao),this._techniqueRepository.release(this._technique),this._technique=null,this._shadowAccumulator=null}get visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire($U,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._isRenderingVisualization)return;this._passParameters.sampleScale=1/this._computedSamples;const t=this.visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(t,this._passParameters,e),this._rctx.drawArrays(t.primitiveType,0,xo(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _isRenderingVisualization(){return this._enabled&&this._computedSamples>0&&this.opacityFromElevation>TTe}get _computedSamples(){return this._shadowAccumulator.computedSamples}get _shadowCastTexture(){return this._shadowAccumulator.shadowCastTexture}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const t=this._passParameters.color;kR(e,t)||(Pd(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],wL.prototype,"opacityFromElevation",null),wL=u([P("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],wL);class DU extends lr{constructor(t,i){super(t,i,()=>this.destroy())}initializeProgram(t){const i=DU.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:so(Re.ONE,Re.ONE,Re.ONE,Re.ONE),colorWrite:Jt,depthTest:null,depthWrite:null})}get primitiveType(){return Pt.TRIANGLE_STRIP}}DU.shader=new Qi(yft,()=>import("./ShadowCastAccumulate.glsl.2b82e269.js"));var zA;let Fo=zA=class extends Ee{constructor(e,t,i,r,s,n){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=r,this._renderToShadowMap=s,this._requestRender=n,this._progress=0,this._sampleCount=0,this._passParameters=new xTe,this._enabled=!1,this._cachedLightDirections=[],this._depthRange=$j,this._previewing=!1,this._handles=new qt,this._cameraForcedForScreenshot=!1,this._bindParameters=new y5(new YY(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._bindParameters.camera=new Yi,this._vao=Ma(e);const o={colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE,width:0,height:0},a={target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:0,height:0};this._fbo=new xr(e,o,a),this._accumulationRenderer=new wL(t,e,this,n);const l=this._stage.resourceController.scheduler;this._handles.add(l.registerTask(mt.SHADOW_ACCUMULATOR,this)),this._handles.add(ae(()=>i.renderView,c=>{this._handles.remove(zA.renderViewHandleKey),R(c)||this._handles.add(c.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),zA.renderViewHandleKey)},Ms))}normalizeCtorArgs(){return{}}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get accumulationTechnique(){if(R(this._accumulationTechnique)){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechnique=new DU(e,new Ra)}return this._accumulationTechnique}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._enabled&&this._sampleCount>0}get canAccumulate(){return this._passParameters.linearDepthTexture!==null&&this._depthRange!==$j&&this._opacityFromElevation>TTe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const t=this._cachedLightDirections;if(uv(t,e,Tb))return;const i=e.length;t.length=i,this._sampleCount=Math.min(IU,i);for(let r=0;r<i;++r){const s=e[r],n=t[r]||O();se(n,s),t[r]=n}this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,t,i,r){if(this._passParameters.linearDepthTexture=e,this._depthRange=t,this._updateCamera(i),this._bindParameters.contentCamera=r,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const s=this._cameraForcedForScreenshot?this._sampleCount:Math.min(zA.previewSamples,this._sampleCount-this._progress);for(let n=0;n<s;++n)this._accumulateShadow();this._cameraForcedForScreenshot=!1}render(e){this._accumulationRenderer.render(e)}dispose(){this._stop(),this._handles.destroy(),this._accumulationRenderer=Ye(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=Ye(this._fbo),this._vao=Ye(this._vao),this._accumulationTechnique=Wi(this._accumulationTechnique),this._cachedLightDirections.length=0,this._sampleCount=0}setOptions(e){e.enabled!==void 0&&(this.enabled=e.enabled),e.previewing!==void 0&&(this.previewing=e.previewing),e.lightDirections!==void 0&&(this.lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}set previewing(e){this._previewing!==e&&(this._previewing=e,this._requestRenderIfEnabled())}set lightDirections(e){this._lightDirections=e}readAccumulatedShadow(e,t){if(!this._isActive||this._progress<1||e<0||e>this._fbo.width||t<0||t>this._fbo.height)return 0;const i=Tft;return this._fbo.readPixels(e,t,1,1,ze.RGBA,St.UNSIGNED_BYTE,i),i[0]/this._progress}_start(){this._progress=0,this._enabled=!0}_stop(){this._enabled=!1}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Xi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){const e=this._lightDirections[this._progress];this._renderToShadowMap(this._bindParameters,e,this._depthRange),this._passParameters.origin=this._bindParameters.camera.center,this._rctx.bindFramebuffer(this._fbo);const t=this.accumulationTechnique;this._rctx.bindTechnique(t,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(t.primitiveType,0,xo(this._vao,"geometry")),this._progress++}_updateCamera(e){e.equals(this._bindParameters.camera)||(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-TS(wft,xft,e.relativeElevation))}set enabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfEnabled(){this._enabled&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};Fo.previewSamples=6,Fo.renderViewHandleKey="renderView",u([d()],Fo.prototype,"_progress",void 0),u([d()],Fo.prototype,"_sampleCount",void 0),u([d()],Fo.prototype,"_enabled",void 0),u([d()],Fo.prototype,"_depthRange",void 0),u([d()],Fo.prototype,"_previewing",void 0),u([d()],Fo.prototype,"_accumulationRenderer",void 0),u([d()],Fo.prototype,"_isRefining",null),u([d()],Fo.prototype,"_isActive",null),u([d()],Fo.prototype,"canAccumulate",null),u([d()],Fo.prototype,"_isDoneAccumulating",null),u([d()],Fo.prototype,"_opacityFromElevation",null),u([d()],Fo.prototype,"running",null),Fo=zA=u([P("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],Fo);const Tft=new Uint8Array(4),yae={highlightedThreshold:.99999,selfShadowThreshold:.025};function Sft(){const e=new Bi;e.include(tw,{receiveShadows:!0});const t=e.fragment;return t.include(uc),t.include(gu),e.include(K5),e.include(zv),t.uniforms.add([new zt("defaultDepthTex",(i,r)=>r.shadowMap.getSnapshot(M2.Default)),new zt("highlightDepthTex",(i,r)=>r.shadowMap.getSnapshot(M2.Highlight)),new zt("depthMap",(i,r)=>r.linearDepthTexture),new zt("highlightMap",(i,r)=>r.highlightColorTexture),new ei("uColor",i=>i.shadowColor),new di("nearFar",(i,r)=>r.camera.nearFar),new We("opacity",i=>i.shadowOpacity),new We("occludedOpacity",i=>i.occludedShadowOpacity),new We("terminationFactor",i=>i.opacityElevation*i.dayNightTerminator),new xt("lightingMainDirectionView",(i,r)=>we(_ae,Ue(_ae,r.lighting.lightingMainDirection,r.camera.viewInverseTransposeMatrix))),new di("texelSize",(i,r)=>_(r.linearDepthTexture)?hi(Eft,1/r.linearDepthTexture.descriptor.width,1/r.linearDepthTexture.descriptor.height):Sh),new vr("inverseViewMatrix",(i,r)=>cs(vae,Aa(vae,r.camera.viewMatrix,r.camera.center)))]),t.constants.add("unoccludedHighlightFlag","vec4",w1e).add("highlightedThreshold","float",yae.highlightedThreshold).add("selfShadowThreshold","float",yae.selfShadowThreshold),t.code.add(x`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),t.code.add(x`void main(void) {
vec4 highlightInfo = texture2D(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture2D(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
gl_FragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}const vae=Ae(),_ae=O(),Eft=tt(),Cft=Object.freeze(Object.defineProperty({__proto__:null,build:Sft},Symbol.toStringTag,{value:"Module"}));class Aft extends Us{constructor(){super(...arguments),this.shadowColor=fi(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}}class LU extends lr{constructor(t){super(t,null,()=>this.destroy())}initializeProgram(t){const i=LU.shader.get().build();return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({blending:so(Re.SRC_ALPHA,Re.ONE,Re.ONE_MINUS_SRC_ALPHA,Re.ONE_MINUS_SRC_ALPHA),colorWrite:Jt,depthTest:null,depthWrite:null})}get primitiveType(){return Pt.TRIANGLE_STRIP}}LU.shader=new Qi(Cft,()=>import("./ShadowHighlight.glsl.d6c2cc73.js"));const Rft=.001953125,Mft=4e4,Oft=5e4;class Pft{constructor(t,i){this._rctx=t,this._viewingMode=i,this._maxOpacity=1,this._passParameters=new Aft,this._drawParameters=new Rbe,this._vao=Ma(this._rctx)}get technique(){return R(this._technique)&&(this._technique=new LU({rctx:this._rctx,viewingMode:this._viewingMode})),this._technique}render(t,i){if(!t.shadowMap.enabled||!t.linearDepthTexture||!this.isVisible)return;const r=this.technique;this._drawParameters.origin=t.camera.center,this._rctx.bindFramebuffer(i),this._rctx.bindTechnique(r,this._passParameters,t).bindDraw(this._drawParameters,t),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(r.primitiveType,0,xo(this._vao,"geometry"))}get gpuMemoryUsage(){var t,i;return(i=(t=this._vao)==null?void 0:t.size)!=null?i:0}setDefaultOptions(t){this._passParameters=F(F({},this._passParameters),t),this._updateMaxOpacity()}updateParameters(t,i){this._passParameters.opacityElevation=1-TS(Mft,Oft,t.relativeElevation);const r=this._viewingMode===Ve.Global?we(bae,t.center):ie(bae,0,0,1),s=xe(r,i);this._passParameters.dayNightTerminator=TS(0,1,$e(30*s,0,1))}dispose(){this._vao=Ye(this._vao),this._technique=Wi(this._technique)}get isVisible(){const{opacityElevation:t,dayNightTerminator:i}=this._passParameters;return this._maxOpacity*t*i>=Rft}_updateMaxOpacity(){const t=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=t*this._passParameters.shadowColor[3]}}const bae=O(),wae=Uv();class Ift{constructor(){this._plane=Uv()}get isEnabled(){return!Ope(this.plane,wae)}get plane(){return this._plane}set plane(t){yw(t||wae,this._plane)}}var mf;(function(e){e[e.EdgeDetector=0]="EdgeDetector",e[e.BlendWeight=1]="BlendWeight",e[e.Blur=2]="Blur",e[e.COUNT=3]="COUNT"})(mf||(mf={}));class STe extends Ra{constructor(){super(...arguments),this.output=mf.EdgeDetector}}u([G({count:mf.COUNT})],STe.prototype,"output",void 0);const Ay={threshold:.05,localConstrastAdaption:2,maxSearchSteps:8,maxDistanceAreaTex:16};function $ft(e){const t=new Bi;return e.output===mf.EdgeDetector&&(t.attributes.add(A.POSITION,"vec2"),t.vertex.uniforms.add(new xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.vertex.code.add(x`void SMAAEdgeDetectionVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
fOffset[2] = texcoord.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAAEdgeDetectionVS( fTexCoord );
}`),t.fragment.uniforms.add(new $r("tColor")),t.fragment.code.add(x`
      vec4 SMAAColorEdgeDetectionPS( vec2 texcoord, vec4 offset[3], sampler2D colorTex ) {
        vec2 threshold = vec2( ${x.float(Ay.threshold)} );

        // Calculate color deltas:
        vec4 delta;
        vec3 C = texture2D( colorTex, texcoord ).rgb;

        vec3 Cleft = texture2D( colorTex, offset[0].xy ).rgb;
        vec3 t = abs( C - Cleft );
        delta.x = max( max( t.r, t.g ), t.b );

        vec3 Ctop = texture2D( colorTex, offset[0].zw ).rgb;
        t = abs( C - Ctop );
        delta.y = max( max( t.r, t.g ), t.b );

        // We do the usual threshold:
        vec2 edges = step( threshold, delta.xy );

        // Then discard if there is no edge:
        if ( dot( edges, vec2( 1.0, 1.0 ) ) == 0.0 )
            discard;

        // Calculate right and bottom deltas:
        vec3 Cright = texture2D( colorTex, offset[1].xy ).rgb;
        t = abs( C - Cright );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Cbottom  = texture2D( colorTex, offset[1].zw ).rgb;
        t = abs( C - Cbottom );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the maximum delta in the direct neighborhood:
        float maxDelta = max( max( max( delta.x, delta.y ), delta.z ), delta.w );

        // Calculate left-left and top-top deltas:
        vec3 Cleftleft  = texture2D( colorTex, offset[2].xy ).rgb;
        t = abs( C - Cleftleft );
        delta.z = max( max( t.r, t.g ), t.b );

        vec3 Ctoptop = texture2D( colorTex, offset[2].zw ).rgb;
        t = abs( C - Ctoptop );
        delta.w = max( max( t.r, t.g ), t.b );

        // Calculate the final maximum delta:
        maxDelta = max( max( maxDelta, delta.z ), delta.w );

        // Local contrast adaptation in action:
        edges.xy *= step( maxDelta, float(${x.float(Ay.localConstrastAdaption)}) * delta.xy );

        return vec4( edges, 0.0, 0.0 );
      }

      void main() {
        gl_FragColor = SMAAColorEdgeDetectionPS( fTexCoord, fOffset, tColor );
      }
    `)),e.output===mf.BlendWeight&&(t.attributes.add(A.POSITION,"vec2"),t.vertex.uniforms.add(new xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[3]","vec4"),t.varyings.add("fPixCoord","vec2"),t.vertex.code.add(x`
      void SMAABlendingWeightCalculationVS( vec2 texcoord ) {
        fPixCoord = texcoord * resolution.zw;
        fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        fOffset[2] = vec4( fOffset[0].xz, fOffset[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${x.int(Ay.maxSearchSteps)} );
      }

      void main() {
        fTexCoord = (position + 1.0 ) * 0.5;
        gl_Position = vec4(position, 0, 1);
        SMAABlendingWeightCalculationVS( fTexCoord );
      }
    `),t.fragment.uniforms.add(new $r("tEdges")),t.fragment.uniforms.add(new $r("tArea")),t.fragment.uniforms.add(new $r("tSearch")),t.fragment.uniforms.add(new $r("tColor")),t.fragment.uniforms.add(new xa("resolution")),t.fragment.code.add(x`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 SMAASampleLevelZeroOffset(sampler2D texture, vec2 coord, vec2 offset) {
        return texture2D(texture, coord + offset.x * resolution.xy, 0.0);
      }

      vec2 round( vec2 x ) {
        return sign( x ) * floor( abs( x ) + 0.5 );
      }

      float SMAASearchLength( sampler2D searchTex, vec2 e, float bias, float scale ) {
        e.r = bias + e.r * scale;
        return 255.0 * texture2D( searchTex, e, 0.0 ).r;
      }

      float SMAASearchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(Ay.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * SMAASearchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float SMAASearchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${x.int(Ay.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * SMAASearchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float SMAASearchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(Ay.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * SMAASearchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float SMAASearchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${x.int(Ay.maxSearchSteps)}; i ++ ) {
          e = texture2D( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * SMAASearchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 SMAAArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${x.int(Ay.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture2D( areaTex, texcoord, 0.0 ).rg;
      }

      vec4 SMAABlendingWeightCalculationPS( vec2 texcoord, vec2 pixcoord, vec4 offset[ 3 ], sampler2D edgesTex, sampler2D areaTex, sampler2D searchTex, ivec4 subsampleIndices ) {
        vec4 weights = vec4( 0.0, 0.0, 0.0, 0.0 );
        vec2 e = texture2D( edgesTex, texcoord ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = SMAASearchXLeft( edgesTex, searchTex, offset[ 0 ].xy, offset[ 2 ].x );
          coords.y = offset[ 1 ].y;
          d.x = coords.x;
          float e1 = texture2D( edgesTex, coords, 0.0 ).r;
          coords.x = SMAASearchXRight( edgesTex, searchTex, offset[ 0 ].zw, offset[ 2 ].y );
          d.y = coords.x;
          d = d * resolution.z - pixcoord.x;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = SMAASearchYUp( edgesTex, searchTex, offset[ 1 ].xy, offset[ 2 ].z );
          coords.x = offset[ 0 ].x;
          d.x = coords.y;
          float e1 = texture2D( edgesTex, coords, 0.0 ).g;
          coords.y = SMAASearchYDown( edgesTex, searchTex, offset[ 1 ].zw, offset[ 2 ].w );
          d.y = coords.y;
          d = d * resolution.w - pixcoord.y;
          vec2 sqrt_d = sqrt( abs( d ) );
          coords.y -= 1.0 * resolution.y;
          float e2 = SMAASampleLevelZeroOffset( edgesTex, coords, vec2( 0.0, 1.0 ) ).g;
          weights.ba = SMAAArea( areaTex, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offset[ 0 ]+offset[ 1 ]+offset[ 2 ] + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0,1,0,1),dbg);
        }
        return weights;
      }

      void main() {
        gl_FragColor = SMAABlendingWeightCalculationPS( fTexCoord, fPixCoord, fOffset, tEdges, tArea, tSearch, ivec4( 0.0 ) );
      }
    `)),e.output===mf.Blur&&(t.attributes.add(A.POSITION,"vec2"),t.vertex.uniforms.add(new xa("resolution")),t.varyings.add("fTexCoord","vec2"),t.varyings.add("fOffset[2]","vec4"),t.vertex.code.add(x`void SMAANeighborhoodBlendingVS( vec2 texcoord ) {
fOffset[0] = texcoord.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
fOffset[1] = texcoord.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}
void main() {
fTexCoord = (position + 1.0 ) * 0.5;
gl_Position = vec4(position, 0, 1);
SMAANeighborhoodBlendingVS(fTexCoord);
}`),t.fragment.uniforms.add(new $r("tBlendWeights")),t.fragment.uniforms.add(new $r("tColor")),t.fragment.uniforms.add(new xa("resolution")),t.fragment.code.add(x`vec4 SMAANeighborhoodBlendingPS( vec2 texcoord, vec4 offset[ 2 ], sampler2D colorTex, sampler2D blendTex ) {
vec4 a;
a.xz = texture2D( blendTex, texcoord ).xz;
a.y = texture2D( blendTex, offset[ 1 ].zw ).g;
a.w = texture2D( blendTex, offset[ 1 ].xy ).a;
if ( dot(a, vec4( 1.0, 1.0, 1.0, 1.0 )) < 1e-5 ) {
return texture2D( colorTex, texcoord, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture2D( colorTex, texcoord, 0.0 );
texcoord += sign( offset ) * resolution.xy;
vec4 Cop = texture2D( colorTex, texcoord, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
vec4 mixed = mix(C, Cop, s);
return mixed;
}
}
void main() {
gl_FragColor = SMAANeighborhoodBlendingPS( fTexCoord, fOffset, tColor, tBlendWeights );
}`)),t}const Dft=Object.freeze(Object.defineProperty({__proto__:null,build:$ft},Symbol.toStringTag,{value:"Module"}));class NU extends lr{initializeProgram(t){const i=NU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Di)}initializePipeline(){return Ut({colorWrite:Jt})}}NU.shader=new Qi(Dft,()=>import("./SMAA.glsl.9bc475fa.js"));let VA=class extends Ee{constructor(e,t){super({}),this.rctx=e,this._techniqueRep=t,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=xh(this._abortController),this.disable()}_loadResources(e){if(_(this._abortController))return!1;if(_(this._searchTexture))return!0;this._abortController=new AbortController;const t=this._abortController.signal;return import("./SmaaRenderPassData.e07ab82b.js").then(i=>this._loadTextures(i,t)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,t){return li(t),Promise.all([this._loadTextureFromBase64(e.areaTexture,Ke.LINEAR,ze.RGB),this._loadTextureFromBase64(e.searchTexure,Ke.NEAREST,ze.LUMINANCE)]).then(([i,r])=>{Xs(t)?(i.dispose(),r.dispose(),li(t)):(this._areaTexture=i,this._searchTexture=r)})}get updating(){return _(this._abortController)}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const t=new STe,i=(r,s)=>this._techniqueRep.releaseAndAcquire(NU,r,s);t.output=mf.EdgeDetector,this._edgeDetectTechnique=i(t,this._edgeDetectTechnique),t.output=mf.BlendWeight,this._blendWeightsTechnique=i(t,this._blendWeightsTechnique),t.output=mf.Blur,this._blurTechnique=i(t,this._blurTechnique)}return!!this._loadResources(e)&&(this._vao=i7e(this.rctx),this._edges=new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,pixelFormat:ze.RGB,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:4,height:4}),this._blend=new xr(this.rctx,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.LINEAR,wrapMode:_t.CLAMP_TO_EDGE,width:4,height:4}),this._isEnabled=!0,!0)}disable(){this._isEnabled&&(this._vao=Ye(this._vao),this._areaTexture=Ye(this._areaTexture),this._searchTexture=Ye(this._searchTexture),this._blend=Ye(this._blend),this._edges=Ye(this._edges),this._isEnabled=!1)}render(e){if(!this._isEnabled)return;const t=this.rctx,i=t.getBoundFramebufferObject(),r={x:0,y:0,width:e.descriptor.width,height:e.descriptor.height};t.bindVAO(this._vao),t.setViewport(r.x,r.y,r.width,r.height),this._edges.resize(r.width,r.height),t.bindFramebuffer(this._edges),t.setClearColor(0,0,0,1),t.clear(Xi.COLOR_BUFFER_BIT);const s=t.bindTechnique(this._edgeDetectTechnique);s.bindTexture("tColor",e),s.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),t.drawArrays(Pt.TRIANGLES,0,3),this._blend.resize(r.width,r.height),t.bindFramebuffer(this._blend),t.setClearColor(0,0,1,1),t.clear(Xi.COLOR_BUFFER_BIT);const n=t.bindTechnique(this._blendWeightsTechnique);n.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),n.bindTexture("tSearch",this._searchTexture),n.bindTexture("tArea",this._areaTexture),n.bindTexture("tEdges",this._edges.colorTexture),t.drawArrays(Pt.TRIANGLES,0,3),t.bindFramebuffer(i),t.setClearColor(0,1,0,1),t.clear(Xi.COLOR_BUFFER_BIT);const o=t.bindTechnique(this._blurTechnique);o.setUniform4f("resolution",1/r.width,1/r.height,r.width,r.height),o.bindTexture("tColor",e),o.bindTexture("tBlendWeights",this._blend.colorTexture),t.drawArrays(Pt.TRIANGLES,0,3)}_loadTextureFromBase64(e,t,i){return Qd(e).then(r=>new st(this.rctx,{pixelFormat:i,dataType:St.UNSIGNED_BYTE,wrapMode:_t.CLAMP_TO_EDGE,width:r.width,height:r.height,samplingMode:t},r))}};u([d()],VA.prototype,"_abortController",void 0),u([d({readOnly:!0})],VA.prototype,"updating",null),VA=u([P("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],VA);function Lft(e,t){const i=t,r=-e[0],s=-e[1],n=-e[2],o=i[3],a=i[7],l=i[11],c=i[15];i[0]+=o*r,i[1]+=o*s,i[2]+=o*n,i[4]+=a*r,i[5]+=a*s,i[6]+=a*n,i[8]+=l*r,i[9]+=l*s,i[10]+=l*n,i[12]+=c*r,i[13]+=c*s,i[14]+=c*n}function Nft(e,t){const i=t,r=e[0],s=e[1],n=e[2];i[12]+=r*i[0]+s*i[4]+n*i[8],i[13]+=r*i[1]+s*i[5]+n*i[9],i[14]+=r*i[2]+s*i[6]+n*i[10],i[14]+=r*i[3]+s*i[7]+n*i[11]}class Fft{constructor(t){this.factory=t,this.originData=new Map}acquire(t){return this.register(this.factory.getOrigin(t))}register(t){const i=this.originData.get(t.id);return i?(i.refCount++,i.origin):(this.originData.set(t.id,{refCount:1,viewMatrix:Ae(),origin:t}),t)}release(t){const i=this.originData.get(t.id);i&&(i.refCount--,i.refCount===0&&this.originData.delete(t.id))}updateViewMatrices(t){this.originData.forEach(i=>{ms(i.viewMatrix,t),Nft(i.origin.vec3,i.viewMatrix)})}getViewMatrix(t){return this.originData.get(t.id).viewMatrix}}class Uft extends Tbe{constructor(t,i,r){super(),this.distanceFalloffFactor=t,this.minimumEdgeLength=i,this.transparency=r,this.transformNormalViewFromGlobal=Sr()}}class kft extends Sbe{constructor(){super(...arguments),this.transformNormalViewFromGlobal=Sr(),this.slicePlaneLocalOrigin=O(),this.transformNormalGlobalFromModel=Sr()}}function zft(e){const t=x`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;e.code.add(t)}const Vft=Oi(.5,-4e-4);function Bft(e,t){const i=e.vertex;i.include(zft),i.constants.add("depthBias","vec2",Vft),i.uniforms.add(new di("inverseViewport",(r,s)=>s.inverseViewport)),t.legacy?(i.uniforms.add(new vv("localView")),i.uniforms.add(new vr("proj",(r,s)=>s.camera.projectionMatrix)),i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(i.uniforms.add(new ZO("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal)),i.uniforms.add(new vr("transformProjFromView",r=>r.transformProjFromView)),i.code.add(x`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),i.code.add(x`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function Gft(e,t){const i=e.fragment;i.constants.add("coverageTestThreshold","float",.01),t.antialiasing?i.code.add(x`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):i.code.add(x`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function jft(e,t){const i=e.vertex;t.silhouette?(i.code.add(x`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),t.legacy?i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):i.code.add(x`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function Hft(e,t){const i=e.vertex;i.include(uc),i.uniforms.add(new We("distanceFalloffFactor",r=>r.distanceFalloffFactor)),i.code.add(x`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),i.uniforms.add(new $r("componentDataTex")),i.uniforms.add(new ag("componentDataTexInvDim")),e.attributes.add(A.COMPONENTINDEX,"float"),i.constants.add("componentColorFieldOffset","float",0),i.constants.add("componentOtherFieldOffset","float",1),i.constants.add("componentVerticalOffsetFieldOffset","float",2),i.constants.add("componentFieldCount","float",3),i.constants.add("lineWidthFractionFactor","float",8),i.constants.add("extensionLengthOffset","float",128),i.constants.add("componentTexWidth","float",4096),i.constants.add("verticalOffsetScale","float",2*LZ),i.code.add(x`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float rowIndex = floor(fieldIndex / componentTexWidth);
float colIndex = mod(fieldIndex, componentTexWidth);
vec2 linearIndex = vec2(
(colIndex + 0.5) / componentTexWidth,
(rowIndex + 0.5) * componentDataTexInvDim.y
);
return linearIndex;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
float verticalOffset;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
vec4 colorValue = texture2D(componentDataTex, colorIndex);
vec4 otherValue = texture2D(componentDataTex, otherIndex);
float verticalOffset = (rgba2float(texture2D(componentDataTex, verticalOffsetIndex)) - 0.5) * verticalOffsetScale;
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5,
verticalOffset
);
}`),t.legacy?i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(i.uniforms.add(new xM("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel)),i.code.add(x`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),t.silhouette?(e.attributes.add(A.NORMALA,"vec3"),e.attributes.add(A.NORMALB,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(e.attributes.add(A.NORMAL,"vec3"),i.code.add(x`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),t.legacy?i.code.add(x`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(i.include(TF,t),i.include(TF,t),i.uniforms.add([new ZO("transformViewFromCameraRelativeRS",r=>r.transformViewFromCameraRelativeRS),new xM("transformWorldFromModelRS",r=>r.transformWorldFromModelRS),new Sa("transformWorldFromModelTL",r=>r.transformWorldFromModelTL),new Sa("transformWorldFromModelTH",r=>r.transformWorldFromModelTH),new xt("transformWorldFromViewTL",r=>r.transformWorldFromViewTL),new xt("transformWorldFromViewTH",r=>r.transformWorldFromViewTH)]),i.code.add(x`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${t.spherical?x`normalize(transformWorldFromModelTL + rotatedModelPosition);`:x`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),i.uniforms.add(new vr("transformProjFromView",(r,s)=>s.camera.projectionMatrix)),i.code.add(x`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),i.code.add(x`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function ETe(e){return e.mode===Os.SKETCH||e.mode===Os.MIXED}var Os;(function(e){e[e.SOLID=0]="SOLID",e[e.SKETCH=1]="SKETCH",e[e.MIXED=2]="MIXED",e[e.COUNT=3]="COUNT"})(Os||(Os={}));function qft(e,t){const i=e.vertex;switch(t.mode){case Os.SKETCH:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case Os.MIXED:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) { if (unpackedAttributes.type <= 0.0 && lineLengthPixels <= 3.0) { gl_Position = vec4(10.0, 10.0, 10.0, 1.0); return; }}`);break;case Os.SOLID:i.code.add(x`#define discardShortEdges(unpackedAttributes, lineLengthPixels) {}`)}}function VZ(e,t){const i=e.vertex;switch(e.attributes.add(A.SIDENESS,"vec2"),t.mode===Os.MIXED?i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):i.code.add(x`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),t.mode){case Os.MIXED:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case Os.SKETCH:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Os.SOLID:i.code.add(x`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Os.COUNT:break;default:t.mode}}function Wft(e,t){const i=e.vertex;switch(e.include(VZ,t),ETe(t)&&i.uniforms.add(new Pi("strokesAmplitude")),t.mode){case Os.SOLID:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case Os.SKETCH:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case Os.MIXED:i.code.add(x`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function Xft(e,t){const i=e.vertex;e.include(VZ,t);const r=e.fragment;switch(ETe(t)&&(i.uniforms.add(new ag("strokesTextureScale")),i.uniforms.add(new Pi("strokesLog2Resolution")),i.uniforms.add(new Pi("strokeVariants")),e.varyings.add("vStrokeUV","vec2"),r.uniforms.add(new $r("strokesTexture")),r.uniforms.add(new Pi("strokesNormalizationScale")),i.code.add(x`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) * strokesTextureScale;
vStrokeUV.x += variantOffset;
}`),e.fragment.include(uc),r.code.add(x`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture2D(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture2D(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),t.mode){case Os.SOLID:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),r.code.add(x`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case Os.SKETCH:i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),r.code.add(x`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case Os.MIXED:e.varyings.add("vType","float"),i.code.add(x`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),r.code.add(x`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function Yft(e){const t=new Bi,i=t.vertex,r=t.fragment;return e.legacy&&i.uniforms.add(new vv("model")),e.antialiasing&&(i.code.add(x`#define ANTIALIASING 1`),r.code.add(x`#define ANTIALIASING 1`)),t.include(Bft,e),t.include(Hft,e),t.include(Wft,e),t.include(VZ,e),t.include(Xft,e),t.include(ls,e),t.include(jft,e),t.include(Gft,e),t.include(qft,e),t.include(yu,e),t.varyings.add("vColor","vec4"),t.varyings.add("vRadius","float"),t.varyings.add("vPosition","vec3"),t.varyings.add("vWorldPosition","vec3"),t.varyings.add("vViewPos","vec3"),t.varyings.add("vLineLengthPixels","float"),t.varyings.add("vSizeFalloffFactor","float"),i.uniforms.add(new di("pixelToNDC",(s,n)=>hi(Zft,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3]))),i.uniforms.add(new ei("viewport",(s,n)=>n.camera.fullViewport)),i.uniforms.add(new We("pixelRatio",(s,n)=>n.camera.pixelRatio)),t.attributes.add(A.POSITION0,"vec3"),t.attributes.add(A.POSITION1,"vec3"),t.attributes.add(A.VARIANTOFFSET,"float"),t.attributes.add(A.VARIANTSTROKE,"float"),t.attributes.add(A.VARIANTEXTENSION,"float"),i.code.add(x`const float opaqueCutoff = 1.0 / 255.0;
void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
vec2 sideness = unpackedAttributes.sideness;
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;
vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
vViewPos = viewPos;
vec4 projPosV0 = projFromViewPosition(viewPosV0);
vec4 projPosV1 = projFromViewPosition(viewPosV1);
vec4 projPos = projFromViewPosition(viewPos);
vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
vec2 ndcToPixel = viewport.zw * 0.5;
vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
float lineLengthPixels = length(screenSpaceLinePixels);
float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;
float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;
float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;
vSizeFalloffFactor = falloffFactor;
float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;
#ifdef ANTIALIASING
const float aaPaddingPixels = 1.0;
float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;
#else
float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;
#endif
vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;
vec2 ndcOffset = (
screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
+ perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
);
projPos.xy += ndcOffset * projPos.w;
projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;
projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));
float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;
float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;
vPosition = vec3(
halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
pixelPositionAlongLine,
pixelPositionAlongLine / extendedLineLengthPixels
);
vRadius = lineWidthPixels * 0.5;
vLineLengthPixels = extendedLineLengthPixels;
discardShortEdges(unpackedAttributes, lineLengthPixels);
gl_Position = projPos;
}
void main() {
ComponentData component = readComponentData();
UnpackedAttributes unpackedAttributes = unpackAttributes(component);
vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);
vColor = component.color;
if (vColor.a < opaqueCutoff) {
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return;
}
if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
return;
}
calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);
calculateStyleOutputs(unpackedAttributes);
}`),t.fragment.code.add(x`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float lineOffset = calculateLineOffset();
      float positionX = position.x - lineOffset;

      if (radius < 1.0) {
        // Handle this specifically for subpixel sizes:
        // 1. Compute correct coverage (note coverage is computed by
        //    0.5 - dist, so we make sure that that will lead to correct
        //    subpixel coverage
        // 2. Ignore rounded caps
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);

        float coverage = min(coverageX, coverageY);

        return vec2(0.5 - coverage, 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${e.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      float alpha = vColor.a * coverage;

      gl_FragColor = vec4(vColor.rgb, alpha);

    }
  `),t}const Zft=tt(),Qft=Object.freeze(Object.defineProperty({__proto__:null,build:Yft},Symbol.toStringTag,{value:"Module"}));class FU extends lr{initializeProgram(t){const i=FU.shader.get().build(this.configuration);return new Ji(t.rctx,i,Nj)}initializePipeline(t){return t.blendMinMax?Ut({blending:so(Re.ONE,Re.ONE,Re.ZERO,Re.ONE,Sg.ADD,t.blendMinMax.MAX),depthTest:{func:hr.LEQUAL},colorWrite:Jt}):Ut({depthTest:{func:hr.LEQUAL},depthWrite:pl,colorWrite:Jt})}}FU.shader=new Qi(Qft,()=>import("./EdgeShader.glsl.c0c25608.js"));class Vp extends Ho{constructor(){super(...arguments),this.mode=Os.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}}u([G({count:Os.COUNT})],Vp.prototype,"mode",void 0),u([G()],Vp.prototype,"hasSlicePlane",void 0),u([G()],Vp.prototype,"silhouette",void 0),u([G()],Vp.prototype,"legacy",void 0),u([G()],Vp.prototype,"antialiasing",void 0),u([G()],Vp.prototype,"doublePrecisionRequiresObfuscation",void 0),u([G()],Vp.prototype,"hasMultipassTerrain",void 0),u([G()],Vp.prototype,"cullAboveGround",void 0),u([G()],Vp.prototype,"spherical",void 0);const Jft=8,LV=128,Kft={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0};class emt{constructor(){this._value=0}get value(){return this._value}increment(){this._value++}decrement(){this._value--}}const tmt={solid:Os.SOLID,sketch:Os.SKETCH,uber:Os.MIXED};class NR{constructor(t,i,r){this.rctx=t,this.shaderTechniqueRepository=i,this._configuration=new Vp,this.refCount=new emt,this.renderables=new Set,this.sortedRenderables={[It.TRANSPARENT]:{[It.TRANSPARENT]:new Bt,[It.OPAQUE]:new Bt},[It.OPAQUE]:{[It.TRANSPARENT]:new Bt,[It.OPAQUE]:new Bt}},this._renderablesDirty=!1,this._drawParameters=new kft,this._settings=F(F({},Kft),r),this.key=NR.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:zi.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=tmt[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this.rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=r3(t),this._configuration.spherical=r.spherical}dispose(){this._technique=Wi(this._technique)}addRenderable(t){this.renderables.add(t),this._renderablesDirty=!0}removeRenderable(t){this.renderables.delete(t),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(t,i){this._renderablesDirty&&this._sortRenderables(),this.sortedRenderables[i][It.TRANSPARENT].forAll(t),this.sortedRenderables[i][It.OPAQUE].forAll(t)}updateTechnique(t,i){return this._configuration.hasMultipassTerrain=!!t.multipassTerrain.enabled,this._configuration.cullAboveGround=!!t.multipassTerrain.cullAboveGround,this._configuration.silhouette=i,this._technique=this.shaderTechniqueRepository.releaseAndAcquire(FU,this._configuration,this._technique),this._technique}bindRegularEdges(t,i){return this.rctx.bindTechnique(this.updateTechnique(i,!1),t,i)}bindSilhouetteEdges(t,i){return this.rctx.bindTechnique(this.updateTechnique(i,!0),t,i)}renderRegularEdges(t,i,r,s,n){this._render(t,i,i.regular.vao,r,s,n)}renderSilhouetteEdges(t,i,r,s,n){this._render(t,i,i.silhouette.vao,r,s,n)}_render(t,i,r,s,n,o){this._bindDraw(t,i,s,o),this.rctx.bindVAO(r),this.rctx.capabilities.instancing.drawArraysInstanced(Pt.TRIANGLE_FAN,0,4,n)}_bindDraw(t,i,r,s){if(i.components.buffer.textureBuffer.bind(t,imt,rmt),"origin"in i.transform)t.setUniformMatrix4fv("localView",s),t.setUniformMatrix4fv("model",i.transform.modelMatrix),se(this._drawParameters.slicePlaneLocalOrigin,i.transform.origin.vec3);else{const n=new RU(i.transform.position),o=Ah(xae,ww(xae,i.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=n.low,this._drawParameters.transformWorldFromModelTH=n.high,this._drawParameters.transformWorldFromModelRS=i.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=o;const a=r.camera.viewInverseTransposeMatrix;ie(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11])}t.bindDraw(this._drawParameters,r),this._settings.type!=="uber"&&this._settings.type!=="sketch"||this._setSketchUniforms(t)}_setSketchUniforms(t){const i=this._settings.strokesTexture,r=i.texture;R(r)||(t.bindTexture("strokesTexture",r),t.setUniform2f("strokesTextureScale",1/r.descriptor.width,1/r.descriptor.height),t.setUniform1f("strokesLog2Resolution",Math.log2(i.resolution)),t.setUniform1f("strokesNormalizationScale",i.normalizationScale),t.setUniform1f("strokesAmplitude",i.amplitude),t.setUniform1f("strokeVariants",i.variants))}_sortRenderables(){this._renderablesDirty=!1,this.sortedRenderables[It.TRANSPARENT][It.TRANSPARENT].clear(),this.sortedRenderables[It.TRANSPARENT][It.OPAQUE].clear(),this.sortedRenderables[It.OPAQUE][It.TRANSPARENT].clear(),this.sortedRenderables[It.OPAQUE][It.OPAQUE].clear(),this.renderables.forEach(i=>{i.objectTransparency!==It.INVISIBLE&&i.edgeTransparency!==It.INVISIBLE&&this.sortedRenderables[i.objectTransparency][i.edgeTransparency].push(i)});const t=(i,r)=>"origin"in i.transform&&"origin"in r.transform?i.transform.origin.id<r.transform.origin.id?-1:i.transform.origin.id>r.transform.origin.id?1:0:0;this.sortedRenderables[It.TRANSPARENT][It.TRANSPARENT].sort(t),this.sortedRenderables[It.TRANSPARENT][It.OPAQUE].sort(t),this.sortedRenderables[It.OPAQUE][It.TRANSPARENT].sort(t),this.sortedRenderables[It.OPAQUE][It.OPAQUE].sort(t)}static getKey(t,i,r){return`edges-t:${t}:${i}:${r}`}}const imt="componentDataTex",rmt="componentDataTexInvDim",xae=hg();class smt extends oxe{constructor(t){super("EdgeProcessingWorker","extract",{extract:i=>[i.dataBuffer],extractComponentsEdgeLocations:i=>[i.dataBuffer],extractEdgeLocations:i=>[i.dataBuffer]},t)}async process(t,i,r){if(r)return kZ(t);const s=this._packInput(t),n=await this.invoke(s,i);return this._unpackOutput(n)}async extractEdgeLocations(t,i){const r=this._packInput(t),s=await this.invokeMethod("extractEdgeLocations",r,i);return m$(s)}async extractComponentsEdgeLocations(t,i){const r=this._packInput(t),s=await this.invokeMethod("extractComponentsEdgeLocations",r,i);return m$(s)}_packInput(t){return{dataBuffer:t.data.buffer,writerSettings:t.writerSettings,skipDeduplicate:t.skipDeduplicate,indicesBuffer:t.indices.buffer,indicesType:UL(t.indices)?"Uint32Array":"Uint16Array",indicesLength:t.indicesLength}}_unpackOutput(t){return{regular:{instancesData:m$(t.regular.instancesData),lodInfo:{lengths:new Float32Array(t.regular.lodInfo.lengths)}},silhouette:{instancesData:m$(t.silhouette.instancesData),lodInfo:{lengths:new Float32Array(t.silhouette.lodInfo.lengths)}},averageEdgeLength:t.averageEdgeLength}}}function nmt(e){const i=wC.resolution,r=i/2,s=new Uint8Array(4*i*i),n=4*i*r,o=wC.amplitude,a=2*o,l=4*i,c=Math.log2(i)+1,h=wC.strokes.length;let p=(c-1)*h*l;for(const{distance:m,pressure:y}of wC.strokes){let v=m,w=y,b=p;for(let S=0;S<c;S++){S!==0&&(v=Tae(v,cO.DISTANCE),w=Tae(w,cO.PRESSURE));for(let T=0;T<wC.resolution;T++){const E=.5+(v?v[T%v.length]/a:0),C=w?w[T%w.length]:1;BM(E,s,b),BM(C,s,b+n),b+=4}b-=l*(h+1)}p+=l}const f=new st(e,{pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,hasMipmap:!1,samplingMode:Ke.LINEAR,width:i,height:i,wrapMode:_t.REPEAT},s);return new amt(i,a,o,h,f)}function Tae(e,t){if(!e)return null;const i=e.length/2,r=omt*i,s=new Array(i);let n=0;const o=t===cO.PRESSURE;for(let a=0;a<e.length;a+=2){const l=(e[a]+e[a+1])/2;s[n++]=o?Math.min(r,1-(1-l)*Sae):Math.min(r,l*Sae)}return s}var cO;(function(e){e[e.DISTANCE=0]="DISTANCE",e[e.PRESSURE=1]="PRESSURE"})(cO||(cO={}));const omt=.1,Sae=.5;class amt{constructor(t,i,r,s,n){this.resolution=t,this.normalizationScale=i,this.amplitude=r,this.variants=s,this.texture=n}dispose(){this.texture=Ye(this.texture)}}const wC={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function Eae(e){let t=null;for(const i of e){const r=i.type;if(lmt(i)){if(R(t))t=r;else if(t!==r)return"uber"}}return _(t)?t:"uber"}function NV(e){let t=It.INVISIBLE;for(const{material:i}of e)if(CTe(i)){if(i.color[3]*i.opacity<1)return It.TRANSPARENT;t=It.OPAQUE}return t}function FV(e){let t=It.INVISIBLE;for(const{material:i}of e)if(CTe(i)){switch(i.objectTransparency){case It.TRANSPARENT:case It.INVISIBLE:return It.TRANSPARENT;case It.OPAQUE:if(i.opacity<1)return It.TRANSPARENT}t=It.OPAQUE}return t}function CTe(e){return e.size*e.color[3]*e.opacity>0}function lmt(e){return e.size*e.color[3]>0}function cmt(e,t){const i=Ule(e,t,!0);return i===-1?t<e[0]?0:e.length:i}function Cae(e,t,i){return e.length-cmt(e,t*i.minimumEdgeLength)}function Aae(e,t,i,r){for(let s=0;s<e.length;s++){const n=e[s].index,o=t[s],a=t[s+1];if(r)for(let l=o;l<a;l++){const c=r[l];i.set(c,n)}else for(let l=o;l<a;l++)i.set(l,n)}}const umt=me.getLogger("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView");let dd=class extends Ee{constructor(e){super(e),this.updatingHandles=new uf,this.perObjectData=new Map,this.perObjectDataEvictionCache=new Set,this.renderers=new Map,this.numberOfRenderedEdges={[It.TRANSPARENT]:0,[It.OPAQUE]:0},this.gpuMemoryUsage=0,this.workerAbort=new AbortController,this.tmpModelPosition=O(),this.localOrigins=new Fft(new XY(e.renderSR))}initialize(){this.worker=new smt(this.schedule),this.componentColorManager=new yTe(this.rctx,3);const e=cTe.createBuffer(4);for(let t=0;t<4;t++)e.sideness.set(t,0,t===0||t===3?0:1),e.sideness.set(t,1,t===0||t===1?0:1);this.verticesBufferObject=ti.createVertex(this.rctx,yi.STATIC_DRAW,e.buffer)}destroy(){this.destroyed||(this.perObjectData.forEach(e=>this._discardObjectEntry(e)),this.perObjectData.clear(),this.strokesTexture=Ye(this.strokesTexture),this.componentColorManager=ot(this.componentColorManager),this.workerAbort.abort(),this.worker.destroy(),this.verticesBufferObject=Ye(this.verticesBufferObject),this.renderers.clear(),this.updatingHandles.destroy())}get updating(){return this.updatingHandles.updating}get usedMemory(){return this.gpuMemoryUsage}get numberOfRenderedPrimitives(){return this.numberOfRenderedEdges[It.TRANSPARENT]+this.numberOfRenderedEdges[It.OPAQUE]}shouldRender(){return this.renderers.size>0}async addComponentObject(e,t,i,r,s,n,o,a){if(this.hasObject(e))return this.getObjectMemoryUsage(e);let l;const c=new Rae(new Promise(p=>l=p),i.center,i.radius);this.perObjectData.set(e,c);const h=await this.updatingHandles.addPromise(this._addComponentGeometry(t,c,r,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(e,t,i,r){if(this.destroyed)return void umt.warn("Attempt to add an object to a destroyed instance");const s=this.perObjectData.get(e);let n;(s==null?void 0:s.renderables.length)>0&&this.perObjectDataEvictionCache.add(s);const o=e.boundingVolumeWorldSpace.bounds,a=new Rae(new Promise(c=>n=c),o,sg(o));this.perObjectData.set(e,a);const l=new Array;if(i.mergeGeometries&&e.geometries.length>1&&dmt(e))l.push(this._addObjectMergedGeometries(e,a,t,i,r));else for(let c=0;c<e.geometries.length;c++){const h=e.geometryRecords[c];if(!h.material.supportsEdges)continue;const p=e.geometries[c];l.push(this._addGeometry(e,a,p,h,t[0],i,r))}await this.updatingHandles.addPromise(Promise.all(l)),this.perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(e){e&&(e.renderables.length&&(e.renderables.forEach(t=>this._removeRenderable(t)),this.setNeedsRender()),e.loaded=null)}hasObject(e){return this.perObjectData.has(e)}async updateAllComponentOpacities(e,t){const i=t instanceof Array?r=>t[r]:()=>t;(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(r=>{const s=r.components.meta.length;for(let n=0;n<s;n++){const o=i(n),a=r.components.meta[n],l=a.index;a.material.opacity=o,r.components.buffer.textureBuffer.setDataElement(l,1,3,255*o)}this._updateTransparency(r)}),this.setNeedsRender()}async getObjectMemoryUsage(e){return(await this._getObjectEntry(e)).renderables.reduce((t,i)=>t+i.statistics.gpuMemoryUsage,0)}async updateAllComponentMaterials(e,t,i,r){const s=e instanceof Hg,n=!!i.hasSlicePlane,o=Eae(t),a=NR.getKey(o,n,s);(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(l=>{if(a!==l.rendererKey){const c=this.renderers.get(l.rendererKey),h=this._acquireRenderer(o,n,s);c.removeRenderable(l),c.refCount.decrement(),l.rendererKey=a,h.addRenderable(l)}for(let c=0;c<t.length;c++)l.components.meta[c].material=t[c];r&&this._updateComponentBuffer(l.components),this._updateTransparency(l)}),this.setNeedsRender()}async updateAllVerticalOffsets(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(i=>{var s;const r=i.components.meta;for(let n=0;n<r.length;n++)i.components.meta[n].verticalOffset=(s=t==null?void 0:t[n])!=null?s:0;this._updateComponentBuffer(i.components)}),this.setNeedsRender()}async updateObjectVisibility(e,t){(await this.updatingHandles.addPromise(this._getObjectEntry(e))).renderables.forEach(i=>i.visible=t),this.setNeedsRender()}removeObject(e){const t=this.perObjectData.get(e);t&&(this.perObjectData.delete(e),this._discardObjectEntry(t))}async _getObjectEntry(e){const t=this.perObjectData.get(e);if(!t)throw"no object";if(await t.loaded,t.loaded==null)throw ui();return t}removeAll(){this.perObjectData.forEach((e,t)=>this.removeObject(t))}render(e,t){if(this.numberOfRenderedEdges[t]=0,R(this.componentColorManager))return;this.localOrigins.updateViewMatrices(e.camera.viewMatrix);const i=e.camera.viewInverseTransposeMatrix,r=O(),s=new RU;let n=0,o=0;if(this.renderers.forEach(h=>{h.refCount.value===0?(this.renderers.delete(h.key),h.dispose()):h.forEachRenderable(p=>{p.visible&&(n+=p.statistics.averageEdgeLength,o++,p.regular&&h.updateTechnique(e,!1),p.silhouette&&h.updateTechnique(e,!0))},t)}),this.componentColorManager.garbageCollect(),this.componentColorManager.updateTextures(),o===0)return;const a=40*n/o,l=e.camera.perScreenPixelRatio,c=new Uft(a,l,t);ie(r,i[3],i[7],i[11]),s.set(r),se(c.transformWorldFromViewTH,s.high),se(c.transformWorldFromViewTL,s.low),Ch(c.transformViewFromCameraRelativeRS,e.camera.viewMatrix),Ah(Mae,c.transformViewFromCameraRelativeRS),ww(c.transformNormalViewFromGlobal,Mae),c.transformProjFromView=e.camera.projectionMatrix,this._updateObjectCameraDistances(e),this.renderers.forEach(h=>{this._renderRegularEdges(h,e,c),this._renderSilhouetteEdges(h,e,c)})}_updateTransparency(e){const t=NV(e.components.meta),i=FV(e.components.meta);t===e.edgeTransparency&&i===e.objectTransparency||(e.edgeTransparency=t,e.objectTransparency=i,this.renderers.get(e.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(e,t,i){if(e.getCombinedStaticTransformation(t,i),_(t.origin))this.localOrigins.register(t.origin);else{const r=ie(this.tmpModelPosition,i[12],i[13],i[14]);t.origin=this.localOrigins.acquire(r)}return Lft(t.origin.vec3,i),t.origin}_updateComponentBuffer(e){const{meta:t,buffer:i}=e,r=new Uint8Array(4);for(let s=0;s<t.length;s++){const n=t[s].material,o=t[s].index,a=$e(Math.round(n.size*Jft),0,255),l=$e(n.extensionLength,-LV,255-LV)+LV,c=n.type==="solid"?HF.SOLID:HF.SKETCH,h=255*n.opacity,p=n.color,f=255*p[0],m=255*p[1],y=255*p[2],v=255*p[3];i.textureBuffer.setData(o,0,f,m,y,v),i.textureBuffer.setData(o,1,a,l,c,h),aTe(t[s].verticalOffset,r),i.textureBuffer.setData(o,2,r[0],r[1],r[2],r[3])}}_createComponentBuffers(e){if(R(this.componentColorManager))return null;const t=new Array,i=this.componentColorManager.getBuffer(e.length);for(let s=0;s<e.length;s++){const n=e[s],o=i.acquireIndex();t.push({index:o,verticalOffset:0,material:n})}const r={meta:t,buffer:i};return this._updateComponentBuffer(r),r}_extractEdges(e,t,i,r,s,n=s.length){return this.worker.process({data:t,indices:s,indicesLength:n,writerSettings:e,skipDeduplicate:i},this.workerAbort.signal,r)}_createEdgeResources(e){const t={};if(R(this.verticesBufferObject))return t;if(e.regular.lodInfo.lengths.length>0){const i=new Ns(this.rctx,Nj,{vertices:nae,instances:GF.glLayout},{vertices:this.verticesBufferObject,instances:ti.createVertex(this.rctx,yi.STATIC_DRAW,e.regular.instancesData.buffer)});t.regular={vao:i,lod:e.regular.lodInfo}}if(e.silhouette.lodInfo.lengths.length>0){const i=new Ns(this.rctx,Nj,{vertices:nae,instances:jF.glLayout},{vertices:this.verticesBufferObject,instances:ti.createVertex(this.rctx,yi.STATIC_DRAW,e.silhouette.instancesData.buffer)});t.silhouette={vao:i,lod:e.silhouette.lodInfo}}return t}async _addGeometry(e,t,i,r,s,n,o){const a=i.vertexAttributes.get(A.POSITION),l=i.indices.get(A.POSITION),c=Ae(),h={position:a,indices:l,modelTransform:c,origin:this._computeModelTransformWithLocalOrigin(e,r,c)};return this._addPositionData(t,h,i.edgeIndicesLength,s,n,o)}async _addPositionData(e,t,i,r,s,n=!1){if(e.loaded==null)return;const o=this._createComponentBuffers([r]);if(R(o)||i<=0)return;const a=this._acquireRenderer(r.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=t,h=t.indices,p=t.position,f=p.data.length/p.size,m=oO.createBuffer(f);for(let T=0;T<f;T++)m.position.set(T,0,p.data[T*p.size+0]),m.position.set(T,1,p.data[T*p.size+1]),m.position.set(T,2,p.data[T*p.size+2]);Aae(o.meta,[0,m.componentIndex.count],m.componentIndex);const y=await this.updatingHandles.addPromise(this._extractEdges(a.writerSettings,m,!1,n,h,i));if(e.loaded==null)return;const{regular:v,silhouette:w}=this._createEdgeResources(y),b=(v?v.vao.size:0)+(w?w.vao.size:0),S={regular:v,silhouette:w,transform:{modelMatrix:l,origin:c},statistics:{gpuMemoryUsage:b,externalMemoryUsage:!1,averageEdgeLength:y.averageEdgeLength},components:o,visible:!0,edgeTransparency:NV(o.meta),objectTransparency:FV(o.meta),distanceToCamera:0,rendererKey:a.key};e.renderables.push(S),a.addRenderable(S),this.gpuMemoryUsage+=b}async _addComponentGeometry(e,t,i,r,s,n,o){if(t.loaded==null)return 0;const a=this._createComponentBuffers(n);if(R(a))return 0;const l=Eae(n),c=this._acquireRenderer(l,o.hasSlicePlane||!1,!1),h=oO.createBuffer(i.count);cU(h.position,i),Aae(a.meta,s,h.componentIndex,r);const p=!0,f=c.writerSettings,m=await this.updatingHandles.addPromise(this._extractEdges(f,h,p,!1,r));if(t.loaded==null)return 0;const{regular:y,silhouette:v}=this._createEdgeResources(m),w=(y?y.vao.size:0)+(v?v.vao.size:0),b={regular:y,silhouette:v,transform:e,statistics:{gpuMemoryUsage:w,externalMemoryUsage:!0,averageEdgeLength:m.averageEdgeLength},components:a,visible:!0,edgeTransparency:NV(a.meta),objectTransparency:FV(a.meta),distanceToCamera:0,rendererKey:c.key};return t.renderables.push(b),c.addRenderable(b),w}async _addObjectMergedGeometries(e,t,i,r,s){const n=new Map;let o=0,a=null,l=0;for(let b=0;b<e.geometries.length;b++){const S=e.geometries[b],T=e.geometryRecords[b];if(!T.material.supportsEdges)continue;!a&&T.origin&&(a=T);const E=S.vertexAttributes.get(A.POSITION);l+=E.data.length/E.size,o+=S.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let b=0;b<e.geometries.length;b++){const S=e.geometries[b];if(!e.geometryRecords[b].material.supportsEdges)continue;const T=S.vertexAttributes.get(A.POSITION),E=S.indices.get(A.POSITION);let C=n.get(T.data);if(C==null){C=p.length/3;for(let M=0;M<T.data.length;M+=T.size)p.push(T.data[M+0]),p.push(T.data[M+1]),p.push(T.data[M+2]);n.set(T.data,C)}if(E)for(let M=0;M<S.edgeIndicesLength;M++)h[f++]=C+E[M]}const m=a||e.geometryRecords[0],y=Ae(),v=this._computeModelTransformWithLocalOrigin(e,m,y);for(let b=0;b<e.geometryRecords.length;b++)e.geometryRecords[b].origin=v;const w={position:{data:p,size:3},indices:h,modelTransform:y,origin:v};await this.updatingHandles.addPromise(this._addPositionData(t,w,h.length,i[0],r,s))}_acquireRenderer(e,t,i){const r=NR.getKey(e,t,i);let s=this.renderers.get(r);return R(this.strokesTexture)&&(this.strokesTexture=nmt(this.rctx)),s||(s=new NR(this.rctx,this.techniqueRepository,{type:e,hasSlicePlane:t,strokesTexture:this.strokesTexture,legacy:i,spherical:this.viewingMode===Ve.Global}),this.renderers.set(r,s)),s.refCount.increment(),s}_removeRenderable(e){hmt(e);const t=this.renderers.get(e.rendererKey);if(t){t.removeRenderable(e),t.refCount.decrement(),"origin"in e.transform&&this.localOrigins.release(e.transform.origin),this.gpuMemoryUsage-=e.statistics.externalMemoryUsage?0:e.statistics.gpuMemoryUsage;for(const i of e.components.meta)e.components.buffer.releaseIndex(i.index)}}_updateObjectCameraDistances(e){const t=e.camera.eye,i=e.camera.viewForward,r=O(),s=n=>{const{center:o,radius:a}=n;Kl(r,o,t);const l=xe(r,i),c=l<-a?1/0:l<a?0:l-a;n.renderables.forEach(h=>h.distanceToCamera=c)};this.perObjectData.forEach(s),this.perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(e,t,i){const r=e.bindRegularEdges(i,t),s=i.transparency;e.forEachRenderable(n=>{if(!n.visible||!n.regular)return;const o=Cae(n.regular.lod.lengths,n.distanceToCamera,i),a="origin"in n.transform?this.localOrigins.getViewMatrix(n.transform.origin):Ks;e.renderRegularEdges(r,n,t,o,a),this.numberOfRenderedEdges[s]+=o},s)}_renderSilhouetteEdges(e,t,i){const r=e.bindSilhouetteEdges(i,t),s=i.transparency;e.forEachRenderable(n=>{if(!n.visible||!n.silhouette)return;const o=Cae(n.silhouette.lod.lengths,n.distanceToCamera,i),a="origin"in n.transform?this.localOrigins.getViewMatrix(n.transform.origin):Ks;e.renderSilhouetteEdges(r,n,t,o,a),this.numberOfRenderedEdges[s]+=o},s)}};function hmt(e){e.regular&&(e.regular.vao.vertexBuffers.instances.dispose(),e.regular.vao.dispose(!1),e.regular.vao=null),e.silhouette&&(e.silhouette.vao.vertexBuffers.instances.dispose(),e.silhouette.vao.dispose(!1),e.silhouette.vao=null)}function dmt(e){let t=null,i=null;for(let r=0;r<e.geometries.length;r++){const s=e.geometryRecords[r];if(s.material.supportsEdges){if(t){if(!uv(t,s.transformation))return!1}else t=s.transformation;if(!i&&_(s.origin))i=s;else if(_(i==null?void 0:i.origin)&&_(s.origin)&&i.origin.id!==s.origin.id)return!1}}return!0}u([d({constructOnly:!0})],dd.prototype,"rctx",void 0),u([d({constructOnly:!0})],dd.prototype,"renderSR",void 0),u([d({constructOnly:!0})],dd.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],dd.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],dd.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],dd.prototype,"schedule",void 0),u([d({readOnly:!0})],dd.prototype,"updatingHandles",void 0),u([d({readOnly:!0})],dd.prototype,"updating",null),dd=u([P("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],dd);class Rae{constructor(t,i,r){this.center=i,this.radius=r,this.renderables=new Array,this.loaded=t,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}const Mae=Sr();function pmt(e){const t=e.capabilities.disjointTimerQuery;return R(t)?null:t.timestampBits()>0?new fmt(t):jj?null:new mmt(t)}class fmt{constructor(t){this.timer=t,this.start=t.createQuery(),t.createTimestamp(this.start)}stop(t,i=50){this.end=this.timer.createQuery(),this.timer.createTimestamp(this.end),this._checkQueryResult(t,i)}_checkQueryResult(t,i){if(!this.timer.resultAvailable(this.end))return void setTimeout(()=>this._checkQueryResult(t,i),i);if(this.timer.disjoint())return void t(null);const r=this.timer.getResult(this.start),s=this.timer.getResult(this.end);t((s-r)/1e6)}}class mmt{constructor(t){this.timer=t,this.query=t.createQuery(),jj=!0,this.timer.beginTimeElapsed(this.query)}stop(t,i=50){this.timer.endTimeElapsed(),jj=!1,this._checkQueryResult(t,i)}_checkQueryResult(t,i){const r=this.timer.resultAvailable(this.query),s=this.timer.disjoint();if(!r||s)s?t(null):setTimeout(()=>this._checkQueryResult(t,i),i);else{const n=this.timer.getResult(this.query);t(n/1e6)}}}let jj=!1;var Ss;(function(e){e[e.Prepare=0]="Prepare",e[e.Shadowmap=1]="Shadowmap",e[e.Lineardepth=2]="Lineardepth",e[e.Normals=3]="Normals",e[e.SSAO=4]="SSAO",e[e.Opaque=5]="Opaque",e[e.OpaqueEdges=6]="OpaqueEdges",e[e.Transparent=7]="Transparent",e[e.TransparentEdges=8]="TransparentEdges",e[e.Hudvisibility=9]="Hudvisibility",e[e.TransparentTerrain=10]="TransparentTerrain",e[e.Atmosphere=11]="Atmosphere",e[e.Laserline=12]="Laserline",e[e.Occluded=13]="Occluded",e[e.Antialiasing=14]="Antialiasing",e[e.Highlights=15]="Highlights",e[e.HudOccluded=16]="HudOccluded",e[e.HudNotoccluded=17]="HudNotoccluded"})(Ss||(Ss={}));const gmt=["prepare","shadowmap","lineardepth","normals","ssao","opaque","opaque edges","transparent","transparent edges","hudvisibility","transparent terrain","atmosphere","laserline","occluded","antialiasing","highlights","hudOccluded","hudNotoccluded"];class ymt extends Q0{constructor(){super("total"),this.total=0,this.frameCount=0}}class vmt{constructor(){this._startTime=0,this._lastSample=0,this._enableGPUTimer=0,this.totalTime=new ymt,this.gpuTime=new Q0("gpu",9),this.renderPassTimings=gmt.map(t=>new Q0(t))}get elapsedTime(){return performance.now()-this._startTime}enableGPUTimer(){return++this._enableGPUTimer,{remove:AH(()=>--this._enableGPUTimer)}}prerender(t){this._startTime=this._lastSample=performance.now(),this._enableGPUTimer&&(this._gpuTimer=pmt(t))}advance(t){const i=performance.now();this.renderPassTimings[t].record(i-this._lastSample),this._lastSample=i}postrender(){_(this._gpuTimer)&&(this._gpuTimer.stop(i=>_(i)&&this.gpuTime.record(i),16),this._gpuTimer=null);const t=performance.now()-this._startTime;this.totalTime.record(t),this.totalTime.total+=t,this.totalTime.frameCount++}}const Oae=.9;let $m=class extends Ee{constructor(e,t,i,r,s,n,o,a,l){super({}),this._materialRepository=e,this._shaderTechniqueRepository=i,this._rctx=r,this._compositingHelper=s,this._magnifierHelper=n,this._requestRender=o,this._stage=l,this._materialRenderers=new Map,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._content=new Map,this._isRendering=!1,this._fallbackDepthStencilTexture=null,this.performanceInfo=new vmt,this._antialiasing=k1.SMAA,this._oitEnabled=!1,this._multipassTerrain=!0,this._transparentTerrain=!1,this._hasAnimations=!1,this._animationTimestep=0,this._handles=new qt,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this._smaaPass=new VA(this._rctx,i),this._oitEnabled=this._hasOITSupport,this._requestRender(),this._offscreenRendering=new cft(this._rctx,this._compositingHelper),this._sliceHelper=new Ift,this._shadowMap=new YY(this._rctx,l.viewingMode,2),this._ssaoHelper=new Fbe(i,this._rctx,()=>this._requestRender()),this._highlight=new nft(i,this._rctx),this._shadowHighlight=new Pft(this._rctx,l.viewingMode),this._shadowAccumulator=new Fo(this._rctx,i,l,c=>{const h=this.shadowsEnabled;this._shadowMap.enabled=!0,this._ensureCameraBindParameters(c.camera,c.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=h},(c,h,p)=>{c.shadowMap.start(c.camera,h,p),this._renderShadowCascades(je.MATERIAL_DEPTH_SHADOWMAP_ALL,c.shadowMap),c.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(c.camera,c.contentCamera)},()=>this._requestRender()),this._renderContext=new zKe(this._rctx,this._offscreenRendering,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new dft({renderContext:this._renderContext,shaderTechniqueRepository:i,textureRep:t,materialRep:this._materialRepository,requestRender:this._requestRender,schedule:a}),this.renderPassManager=new Xpt(this._rctx,this._shaderTechniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([ae(()=>this._stage.state.camera,()=>this._requestRender(),Ms),ae(()=>zi.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,c=>{this._renderHiddenTransparentEdges=c?()=>this._renderEdges(It.TRANSPARENT):()=>{},this._requestRender()},Ft)])}get _bindParameters(){return this._renderContext.bindParameters}get hasWater(){return this._hasWater||this._hasOverlayWater}get hasWaterReflection(){return this.hasWater&&this._waterReflectionEnabled}normalizeCtorArgs(){return{}}dispose(){this._handles.destroy(),this._smaaPass.dispose(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._edgeView=ot(this._edgeView),this._offscreenRendering.dispose(),this._fallbackDepthStencilTexture=Ye(this._fallbackDepthStencilTexture),this._shadowMap.enabled=!1,this._shadowMap.dispose(),this._ssaoHelper.enabled=!1,this._ssaoHelper.dispose(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),v5.prune(),this._content.clear()}disposeOffscreenBuffers(){this._offscreenRendering.dispose(),this._shadowMap.dispose(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing===k1.SMAA&&this._smaaPass.updating||_(this._edgeView)&&this._edgeView.updating||this._shadowAccumulator.running||!this.isCameraFinal}ensureEdgeView(){return R(this._edgeView)&&(this._edgeView=new dd({rctx:this._rctx,renderSR:this._stage.renderSR,viewingMode:this._stage.viewingMode,techniqueRepository:this._shaderTechniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:e=>this._stage.resourceController.schedule(e)}),this._handles.add(ae(()=>qs(this._edgeView,e=>e.updating),()=>this._requestRender(),rr)),this._requestRender()),this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return Tde(this._bindParameters.ssr.reprojectionMatrix,Ks)}set _reprojectionMatrix(e){vH(this._bindParameters.ssr.reprojectionMatrix,e)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){var e;return!!((e=this._shadowMap)==null?void 0:e.enabled)}setRenderParameters(e){const{_shadowMap:t,_ssaoHelper:i,_bindParameters:r}=this;if(e.screenSpaceReflectionsEnabled!==void 0&&r.ssr.enabled!==e.screenSpaceReflectionsEnabled&&(r.ssr.enabled=e.screenSpaceReflectionsEnabled,this._requestRender()),e.shadowMap!==void 0&&t.enabled!==e.shadowMap&&(t.enabled=e.shadowMap,this._requestRender()),e.shadowMapMaxCascades!==void 0&&t.maxCascades!==e.shadowMapMaxCascades&&(t.maxCascades=e.shadowMapMaxCascades,this._requestRender()),_(e.environment)){_(e.environment.weather)&&(this._bindParameters.weather=e.environment.weather,this._bindParameters.weatherVisible=e.weatherVisible,this._renderContext.bindParameters.weather=e.environment.weather,this._renderContext.bindParameters.weatherVisible=e.weatherVisible),e.environment.lighting.ambientOcclusionEnabled!==void 0&&i.enabled!==e.environment.lighting.ambientOcclusionEnabled&&(i.enabled=e.environment.lighting.ambientOcclusionEnabled,this._requestRender()),e.environment.lighting.waterReflectionEnabled!==void 0&&this._waterReflectionEnabled!==e.environment.lighting.waterReflectionEnabled&&(this._waterReflectionEnabled=e.environment.lighting.waterReflectionEnabled,this._requestRender());const n=e.environment.lighting.type==="sun";r.enableFillLights!==n&&(r.enableFillLights=n,this._requestRender())}e.background&&this._offscreenRendering.background!==e.background&&(this._offscreenRendering.background=e.background,this._requestRender());const s=e.antialiasingEnabled?k1.SMAA:k1.NONE;e.antialiasingEnabled!==void 0&&this._antialiasing!==s&&(this._antialiasing=s,this._requestRender()),e.highQualityTransparency!==void 0&&this._multipassTerrain!==e.highQualityTransparency&&(this._multipassTerrain=e.highQualityTransparency,this._oitEnabled=e.highQualityTransparency&&this._hasOITSupport,this._requestRender()),e.defaultHighlightOptions!==void 0&&(this._highlight.setDefaultOptions(e.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(e.defaultHighlightOptions),this._requestRender()),e.overlays!==void 0&&this._bindParameters.overlays!==e.overlays&&(this._bindParameters.overlays=e.overlays,this._requestRender()),e.slicePlane!==void 0&&this._sliceHelper.plane!==e.slicePlane&&(this._sliceHelper.plane=e.slicePlane,this._requestRender()),e.transparentTerrain!==void 0&&this._transparentTerrain!==e.transparentTerrain&&(this._transparentTerrain=e.transparentTerrain,this._requestRender()),e.hasOverlayWater!==void 0&&this._hasOverlayWater!==e.hasOverlayWater&&(this._hasOverlayWater=e.hasOverlayWater,this._requestRender()),e.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(e.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlendWorking}modify(e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:t,removes:i,updates:r}=e;if(t.length===0&&i.length===0&&r.length===0)return;i.forAll(({id:o})=>this._content.delete(o)),t.forAll(o=>this._content.set(o.id,o));const s=xbe(e);let n=!1;s.forEach((o,a)=>{let l=this._materialRenderers.get(a);if(!l){if(!(o.adds.length>0))return;l=new Dbe(this._rctx,this._materialRepository,a),this._materialRenderers.set(a,l)}l.modify(o),l.isEmpty&&(n=!0)}),n&&this._materialRenderers.forEach((o,a)=>{o.isEmpty&&(this._materialRenderers.delete(a),o.dispose())}),this._hasHighlights=Ws(this._materialRenderers,o=>o.hasHighlights),this._bindParameters.hasOccludees=Ws(this._materialRenderers,o=>o.hasOccludees),this._hasWater=Ws(this._materialRenderers,o=>o.hasWater),this._needsTransparentPass=Ws(this._materialRenderers,o=>o.requiresSlot(Se.TRANSPARENT_MATERIAL,je.MATERIAL)),this._hasHUDElements=Ws(this._materialRenderers,o=>o.requiresSlot(Se.LINE_CALLOUTS_HUD_DEPTH,je.MATERIAL)||o.requiresSlot(Se.HUD_MATERIAL,je.MATERIAL)||o.requiresSlot(Se.LABEL_MATERIAL,je.MATERIAL)),this._requestRender()}updateAnimation(e){return this._hasAnimations=!1,this._materialRenderers.forEach(t=>this._hasAnimations=t.updateAnimation(e)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(e)||this._hasAnimations,this._hasAnimations}get animationTimestep(){return this._animationTimestep}updateLightSources(e,t,i){this._bindParameters.lighting.groundLightingFactor=t,this._bindParameters.lighting.globalFactor=i,this._bindParameters.lighting.set(e)}render(e,t,i,r){this._isRendering=!0,this.performanceInfo.prerender(this._rctx),this._bindParameters.transparencyPassType=gt.NONE;const s=this._offscreenRendering;s.needLastFrameColorTexture=this.hasWaterReflection,s.advanceCurrentRenderTarget();const n=Uv(this._sliceHelper.plane);r===Vb.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(e),t.setGLViewport(this._rctx),this._ensureCameraBindParameters(t,i),this._renderPlugins.prepareRender(),this.performanceInfo.advance(Ss.Prepare);const o=this._computeDepthRange(t);this._renderShadowMap(e,t,this._bindParameters.lighting.lightingMainDirection,o),this.performanceInfo.advance(Ss.Shadowmap),s.initializeFrame(t),this._ensureBindParameters(t,i),this._renderLinearDepth(),this.performanceInfo.advance(Ss.Lineardepth),this._accumulateShadows(o,t,i),this._renderNormal(),this.performanceInfo.advance(Ss.Normals),this._ensureBindParametersSSR(),this._ssaoHelper.computeSSAO(this._bindParameters,s.linearDepthTexture,s.normalTexture),this.performanceInfo.advance(Ss.SSAO),this._renderContext.pass=je.MATERIAL,s.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Ss.Opaque);const a=this._multipassTerrain&&this._transparentTerrain;this._renderTerrainLinearDepth(a),this._setMultipassEnabled(a),this._setTerrainCulling(a),this._renderEdges(It.OPAQUE),this.performanceInfo.advance(Ss.OpaqueEdges),this._offscreenRendering.bindTarget(this._offscreenRendering.currentColorTarget,this._offscreenRendering.mainDepth),this._renderSlot(Se.VOXEL),this._renderHiddenTransparentEdges();const l=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Ss.Transparent),this._renderGeometryLinearDepth(a);const c=this._renderHUDVisibility();a||this._renderInternalSlot(Se.LINE_CALLOUTS),this.performanceInfo.advance(Ss.Hudvisibility),this._renderEdges(It.TRANSPARENT,a),this.performanceInfo.advance(Ss.TransparentEdges),this._renderTransparentTerrain(),this._transparentTerrain&&c&&(a?this._renderLineCallouts(th.Occluded):s.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(th.Occluded,s.framebuffer),this.performanceInfo.advance(Ss.HudOccluded)),this.performanceInfo.advance(Ss.TransparentTerrain),this._setTerrainCulling(!1),this._transparentTerrain&&(s.compositeTransparentTerrainOntoMain(this._bindParameters),a&&(this._renderEdges(It.OPAQUE),this.performanceInfo.advance(Ss.OpaqueEdges),l&&(this._oitEnabled?this._renderOrderIndependentTransparency(()=>this._renderTransparentGeometry(),!1):this._renderTransparentGeometry()),this.performanceInfo.advance(Ss.Transparent),this._renderEdges(It.TRANSPARENT),this.performanceInfo.advance(Ss.TransparentEdges))),a&&this._renderLineCallouts(th.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),s.renderToTargets(()=>{this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(Se.LASERLINES)},s.currentColorTarget,s.mainDepth),this.performanceInfo.advance(Ss.Atmosphere),this._renderPlugins.needsLaserlineWithContrastControl&&s.renderTmpAndCompositeToMain(()=>this._renderSlot(Se.LASERLINES_CONTRAST_CONTROL),this._bindParameters,bo.PremultipliedAlpha),this.performanceInfo.advance(Ss.Laserline),this._renderOccluded(),this.performanceInfo.advance(Ss.Occluded);const h=r===Vb.ON&&this._magnifierHelper.enabled,p=h&&R(e)?this._offscreenRendering.getFramebuffer(this._offscreenRendering.tmpColor,this._offscreenRendering.tmpDepth):e;this._rctx.bindFramebuffer(p);const f=this._offscreenRendering.colorTexture;!this._renderAntiAliasing(this._antialiasing,f)&&_(f)&&this._compositingHelper.composite(this._bindParameters,f,bo.None),this.performanceInfo.advance(Ss.Antialiasing),this._renderHUD(th.NotOccluded,p),this.performanceInfo.advance(Ss.HudNotoccluded),this._renderHighlights(p,this._bindParameters),this.performanceInfo.advance(Ss.Highlights),h&&this._magnifierHelper.render(this._rctx,this._bindParameters),p!==e&&(this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.tmpColorTexture,bo.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=n,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.postrender()}finish(e){if(this._hasAnimations||(this._animationTimestep=0),e===Rs.BACKGROUND){this._rctx.gl.getError();const t=this.performanceInfo.elapsedTime/qpt;this._animationTimestep=Math.max(this._animationTimestep*Oae+t*(1-Oae),Wpt)}}readDepthPixels(e,t,i){const r=this._offscreenRendering.bindTarget(this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(e,e),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const s=Xi.COLOR_BUFFER_BIT|Xi.DEPTH_BUFFER_BIT|Xi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(s),this._renderGeometryAndTransparentTerrainPass(je.MATERIAL_DEPTH)}r.readPixels(t[0],t[1],t[2],t[3],ze.RGBA,St.UNSIGNED_BYTE,i)}readHUDVisibility(e,t,i,r,s){this._offscreenRendering.bindTarget(this._offscreenRendering.hudVisibility).readPixels(e,t,i,r,ze.RGBA,St.UNSIGNED_BYTE,s)}readAccumulatedShadow(e,t){return this._shadowAccumulator.readAccumulatedShadow(e,t)}_setMultipassEnabled(e){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=e}_setTerrainCulling(e){this._bindParameters.multipassTerrain.cullAboveGround=e}_renderSlot(e){this._bindParameters.slot=e,this._renderPlugins.render()}_renderEdges(e,t=!1){const i=this._edgeView;_(i)&&i.shouldRender()&&this._offscreenRendering.renderTmpAndCompositeToMain(()=>i.render(this._bindParameters,e),this._bindParameters,bo.Alpha,t)}_renderShadowMap(e,t,i,r){const s=this._shadowMap;s.enabled&&(s.start(t,i,r),this._shadowHighlight.updateParameters(t,i),this.needsShadowHighlight?(this._renderShadowCascades(je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,M2.Highlight)),s.clear(),this._renderShadowCascades(je.MATERIAL_DEPTH_SHADOWMAP_DEFAULT,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,M2.Default),this._renderGeometryAndTransparentTerrainPass(je.MATERIAL_DEPTH_SHADOWMAP_HIGHLIGHT)})):this._renderShadowCascades(je.MATERIAL_DEPTH_SHADOWMAP_ALL),s.finish(e),t.setGLViewport(this._rctx))}_renderShadowCascades(e,t=this._shadowMap,i=r=>{}){for(const r of t.getCascades())r.camera.setGLViewport(this._rctx),this._ensureCameraBindParameters(r.camera,r.camera),this._renderGeometryAndTransparentTerrainPass(e),i(r)}get _needsLinearDepth(){return this._ssaoHelper.enabled||this._renderPlugins.needsLinearDepth||this._hasWater&&this._waterReflectionEnabled||this.needsShadowHighlight||this.needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreenRendering.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(je.MATERIAL_DEPTH),this._offscreenRendering.linearDepth,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.linearDepth),this._bindParameters.linearDepthTexture=this._offscreenRendering.linearDepthTexture}_renderTerrainLinearDepth(e){if(e){const t=this._renderContext.pass;this._renderContext.pass=je.MATERIAL_DEPTH,this._offscreenRendering.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreenRendering.terrainLinearDepth,this._offscreenRendering.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreenRendering.terrainLinearDepthTexture}_renderGeometryLinearDepth(e){if(e){const t=this._renderContext.pass;this._offscreenRendering.renderToTargets(()=>this._renderGeometryPass(je.MATERIAL_DEPTH),this._offscreenRendering.geometryLinearDepth,this._offscreenRendering.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.pass=t}else this._offscreenRendering.disposeTarget(this._offscreenRendering.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreenRendering.geometryLinearDepthTexture}get needsNormal(){return this._ssaoHelper.enabled}_renderNormal(){this.needsNormal?this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(je.MATERIAL_NORMAL)},this._offscreenRendering.normal,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0):this._offscreenRendering.disposeTarget(this._offscreenRendering.normal)}get needsDepthRange(){return this._shadowMap.enabled||this.needsShadowCast}_computeDepthRange(e){if(!this.needsDepthRange)return $j;const t=Dpt(e,this._content,this._stage.layers);return L2(t,this.renderPlugins.queryDepthRange(e)),t.near=Math.max(e.near,t.near),t.far=Math.min(e.far,t.far),t}_renderGeometryAndTransparentTerrainPass(e){this._renderContext.pass=e,this._renderGeometryPass(e),this._renderTransparentTerrain()}_renderGeometryPass(e){this._renderContext.pass=e,this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderOpaqueGeometry(){this._renderSlot(Se.INTEGRATED_MESH),this._renderSlot(Se.OPAQUE_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.OPAQUE_MATERIAL),this._renderSlot(Se.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(Se.TRANSPARENT_MATERIAL),this._renderSlot(Se.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(Se.TRANSPARENT_TERRAIN)}_renderHUDVisibility(){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(Se.OCCLUSION_PIXELS)},this._multipassTerrain&&this._transparentTerrain),e}_renderLineCallouts(e){this._bindParameters.renderTransparentlyOccludedHUD=e,e===th.Occluded?this._offscreenRendering.renderToTargets(()=>this._renderInternalSlot(Se.LINE_CALLOUTS),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderInternalSlot(Se.LINE_CALLOUTS)}_renderHUD(e,t){this._hasHUDElements&&(this._oitEnabled?(this._renderOrderIndependentTransparency(()=>this._renderHUDElements(e),!0),this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreenRendering.hudColorTexture,bo.PremultipliedAlpha)):e===th.Occluded?this._offscreenRendering.renderToTargets(()=>this._renderHUDElements(th.Occluded),this._offscreenRendering.currentColorTarget,this._offscreenRendering.tmpDepth,void 0,!0,!0):this._renderHUDElements(e))}_renderHUDElements(e){this._bindParameters.renderTransparentlyOccludedHUD=e,this._renderInternalSlot(Se.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(Se.HUD_MATERIAL),this._renderInternalSlot(Se.LABEL_MATERIAL)}get needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this.needsHighlight}_renderHighlights(e,t){if(!this.needsHighlight)return void this._offscreenRendering.disposeTarget(this._offscreenRendering.highlight);const i=this._highlight,r=this._offscreenRendering.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(je.MATERIAL_HIGHLIGHT),this._rctx.clearSafe(Xi.DEPTH_BUFFER_BIT),this._renderHUDElements(th.Both)},this._offscreenRendering.highlight,this._offscreenRendering.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=r.colorTexture,this.needsShadowHighlight&&this._shadowHighlight.render(t,e),i.render(this._bindParameters,r,e)}get needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(e,t,i){this.needsShadowCast&&this._shadowAccumulator.renderAccumulation(this._offscreenRendering.linearDepthTexture,e,t,i)}_renderOrderIndependentTransparency(e,t){const i=s=>{this._bindParameters.transparencyPassType=s,this._offscreenRendering.renderOITPass(()=>e(),s,t)},r=this._renderContext.pass;this._renderContext.pass=je.MATERIAL_ALPHA,i(gt.Alpha),this._renderContext.pass=je.MATERIAL,i(gt.Color),i(gt.FrontFace),this._offscreenRendering.compositeTransparentOntoOpaque(this._bindParameters,t),this._bindParameters.transparencyPassType=gt.NONE,this._renderContext.pass=r,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreenRendering.disposeTarget(this._offscreenRendering.alphaFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.colorFloatTarget),this._offscreenRendering.disposeTarget(this._offscreenRendering.frontFaceTarget)),this._oitUsed=!1}_renderOccluded(){let e=0;this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&o.renderOccluded===Mr.OccludeAndTransparentStencil&&(e|=o.renderOccluded,TC.push(o))});const t=this._offscreenRendering,i=(n,o,a,l,c)=>{(e&o)!=0&&(t.renderToTargets(a,t.tmpColor,t.mainDepth,[0,0,0,0],l,c),t.compositeOccludedOntoMain(this._bindParameters,n))};TC.length!==0&&(this._renderInternalSlot(Se.OCCLUDER_MATERIAL,TC),i(.5,Mr.OccludeAndTransparentStencil,()=>this._renderInternalSlot(Se.TRANSPARENT_OCCLUDER_MATERIAL,TC),!1,!1),TC.length=0),this._materialRenderers.forEach((n,o)=>{o&&o.isVisible()&&(o.renderOccluded===Mr.OccludeAndTransparent||o.renderOccluded===Mr.Transparent||o.renderOccluded===Mr.Opaque)&&(e|=o.renderOccluded,xC.push(o))});const r=this._renderPlugins.renderOccludedFlags;if(e|=r,!e)return;const s=n=>{this._renderContext.renderOccludedMask=n,r>Mr.Occlude&&this._renderSlot(Se.OCCLUDED_TERRAIN),this._renderInternalSlot(Se.OPAQUE_MATERIAL,xC),this._renderInternalSlot(Se.TRANSPARENT_MATERIAL,xC),this._renderInternalSlot(Se.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,xC),this._renderContext.resetRenderOccludedMask()};this._renderContext.pass=je.MATERIAL,i(.5,Mr.OccludeAndTransparent,()=>s(Mr.OccludeAndTransparent),!0,al.OutlineVisualElementMask),i(.5,Mr.Transparent,()=>s(Mr.Transparent),!0,al.OutlineVisualElementMask),i(1,Mr.Opaque,()=>s(Mr.Opaque),!0,al.OutlineVisualElementMask),xC.length=0}_renderAntiAliasing(e,t){if(e===k1.SMAA){if(this._smaaPass.enable(()=>this._requestRender())&&_(t))return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_ensureCameraBindParameters(e,t){this._bindParameters.camera=e,this._bindParameters.contentCamera=t}_ensureBindParameters(e,t){var r;this._ensureCameraBindParameters(e,t);const i=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=i.hudVisibilityTexture,this._bindParameters.highlightDepthTexture=(r=i.depthTexture)!=null?r:this._getFallbackDepthTexture()}_ensureBindParametersSSR(){this.hasWaterReflection?(this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Ks:(cs(Iae,this._bindParameters.camera.viewMatrix),cs(Pae,this._bindParameters.camera.projectionMatrix),Nr(Sx,Iae,Pae),Nr(Sx,this._renderContext.lastFrameCamera.viewMatrix,Sx),Nr(Sx,this._renderContext.lastFrameCamera.projectionMatrix,Sx),this._reprojectionMatrix=Sx),this._bindParameters.ssr.lastFrameColorTexture=this._offscreenRendering.lastFrameColorTexture):this._bindParameters.ssr.lastFrameColorTexture=null,this._bindParameters.ssr.enabled=this.hasWaterReflection}_renderInternalSlot(e,t){let i=!1;return this._bindParameters.slot=e,_(t)?t.forEach(r=>{if(!r.shouldRender(this._renderContext))return;const s=this._materialRenderers.get(r);_(s)&&(i=s.render(this._renderContext.pass,this._bindParameters)||i)}):this._materialRenderers.forEach((r,s)=>{s.shouldRender(this._renderContext)&&r.render(this._renderContext.pass,this._bindParameters)&&(i=!0)}),i}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=Y0e(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){var e,t,i,r,s,n,o,a,l,c;return{offscreen:(t=(e=this._offscreenRendering)==null?void 0:e.gpuMemoryUsage)!=null?t:0,highlights:((r=(i=this._highlight)==null?void 0:i.gpuMemoryUsage)!=null?r:0)+((n=(s=this._shadowHighlight)==null?void 0:s.gpuMemoryUsage)!=null?n:0),shadows:(a=(o=this._shadowMap)==null?void 0:o.gpuMemoryUsage)!=null?a:0,ssao:(c=(l=this._ssaoHelper)==null?void 0:l.gpuMemoryUsage)!=null?c:0}}get test(){const e=this;return{offscreen:this._offscreenRendering,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,getFramebufferTexture:t=>{switch(t){case w0.Color:return e._offscreenRendering.colorTexture;case w0.LinearDepth:return e._offscreenRendering.linearDepthTexture;case w0.Normals:return e._offscreenRendering.normalTexture;case w0.ShadowMap:return e._shadowMap.depthTexture;case w0.HudVisibility:return e._offscreenRendering.hudVisibilityTexture;case w0.Highlight:return e._offscreenRendering.highlightTexture}}}}};var w0;u([d()],$m.prototype,"_shadowAccumulator",void 0),u([d()],$m.prototype,"_smaaPass",void 0),u([d()],$m.prototype,"_antialiasing",void 0),u([d()],$m.prototype,"_edgeView",void 0),u([d()],$m.prototype,"updating",null),u([d()],$m.prototype,"isCameraFinal",null),$m=u([P("esri.views.3d.webgl-engine.lib.Renderer")],$m),function(e){e[e.Color=0]="Color",e[e.LinearDepth=1]="LinearDepth",e[e.Normals=2]="Normals",e[e.ShadowMap=3]="ShadowMap",e[e.HudVisibility=4]="HudVisibility",e[e.Highlight=5]="Highlight"}(w0||(w0={}));const xC=[],TC=[],Pae=Ae(),Iae=Ae(),Sx=Ae();class $ae{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Re.ONE,dstRGB:Re.ZERO,srcAlpha:Re.ONE,dstAlpha:Re.ZERO},this.blendEquation={mode:Sg.ADD,modeAlpha:Sg.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=Fd.BACK,this.frontFace=a2.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=hr.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:Fd.FRONT_AND_BACK,func:hr.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:Fd.FRONT_AND_BACK,fail:Jr.KEEP,zFail:Jr.KEEP,zPass:Jr.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array}}class _mt{constructor(t){this._allocations=new Map,t?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(t){this._allocations.set(t,new Error().stack)}remove(t){this._allocations.delete(t)}print(){if(this._allocations.size>0){console.log(`${this._allocations.size} live object allocations:`);const t=new Map;this._allocations.forEach(i=>{var r;t.set(i,((r=t.get(i))!=null?r:0)+1)}),t.forEach((i,r)=>{const s=r.split(`
`);s.shift(),s.shift(),console.log(`${i}: ${s.shift()}`),s.forEach(n=>console.log("   ",n))})}}}const bmt={RECORD_ALLOCATIONS:!1};class wmt{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new _mt(bmt.RECORD_ALLOCATIONS);this._current.length<dn.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(t,i){const r=++this._current[t];this._max[t]=Math.max(r,this._max[t]),this._allocations.add(i)}decrement(t,i){--this._current[t],this._allocations.remove(i)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((t,i)=>t+i,0)}printResourceCount(){if(this.total>0){console.log("Live objects:");for(let t=0;t<dn.COUNT;++t){const i=this._current[t];i>0&&console.log(`${dn[t]}: ${i}`)}}this._allocations.print()}}const xmt=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var Dae,ATe={exports:{}};(Dae=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(ATe.exports=Dae);const Tmt=ATe.exports;var Lae,RTe={exports:{}};Lae=RTe,function(e){var t=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];t!==void 0&&(Lae.exports=t)}();const Nae=RTe.exports;var MTe={exports:{}};(function(e){(function(t){var i=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT"]}();i!==void 0&&(e.exports=i)})()})(MTe);const Smt=MTe.exports;var Wh=999,Fae=9999,UV=0,kV=1,Uae=2,kae=3,zae=4,b$=5,Emt=6,Cmt=7,Amt=8,Vae=9,Rmt=10,Bae=11,Mmt=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function Omt(){var e,t,i,r=0,s=0,n=Wh,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,m="";return function(k){return a=[],k!==null?v(k.replace?k.replace(/\r\n/g,`
`):k):w()};function y(k){k.length&&a.push({type:Mmt[n],data:k,position:h,line:l,column:c})}function v(k){var Y;for(r=0,i=(m+=k).length;e=m[r],r<i;){switch(Y=r,n){case UV:r=C();break;case kV:r=E();break;case Uae:r=T();break;case kae:r=M();break;case zae:r=D();break;case Bae:r=N();break;case b$:r=z();break;case Fae:r=V();break;case Vae:r=S();break;case Wh:r=b()}Y!==r&&(m[Y]===`
`?(c=0,++l):++c)}return s+=r,m=m.slice(r),a}function w(k){return o.length&&y(o.join("")),n=Rmt,y("(eof)"),a}function b(){return o=o.length?[]:o,t==="/"&&e==="*"?(h=s+r-1,n=UV,t=e,r+1):t==="/"&&e==="/"?(h=s+r-1,n=kV,t=e,r+1):e==="#"?(n=Uae,h=s+r,r):/\s/.test(e)?(n=Vae,h=s+r,r):(p=/\d/.test(e),f=/[^\w_]/.test(e),h=s+r,n=p?zae:f?kae:Fae,r)}function S(){return/[^\s]/g.test(e)?(y(o.join("")),n=Wh,r):(o.push(e),t=e,r+1)}function T(){return e!=="\r"&&e!==`
`||t==="\\"?(o.push(e),t=e,r+1):(y(o.join("")),n=Wh,r)}function E(){return T()}function C(){return e==="/"&&t==="*"?(o.push(e),y(o.join("")),n=Wh,r+1):(o.push(e),t=e,r+1)}function M(){if(t==="."&&/\d/.test(e))return n=b$,r;if(t==="/"&&e==="*")return n=UV,r;if(t==="/"&&e==="/")return n=kV,r;if(e==="."&&o.length){for(;I(o););return n=b$,r}if(e===";"||e===")"||e==="("){if(o.length)for(;I(o););return y(e),n=Wh,r+1}var k=o.length===2&&e!=="=";if(/[\w_\d\s]/.test(e)||k){for(;I(o););return n=Wh,r}return o.push(e),t=e,r+1}function I(k){for(var Y,Z,le=0;;){if(Y=Nae.indexOf(k.slice(0,k.length+le).join("")),Z=Nae[Y],Y===-1){if(le--+k.length>0)continue;Z=k.slice(0,1).join("")}return y(Z),h+=Z.length,(o=o.slice(Z.length)).length}}function N(){return/[^a-fA-F0-9]/.test(e)?(y(o.join("")),n=Wh,r):(o.push(e),t=e,r+1)}function D(){return e==="."||/[eE]/.test(e)?(o.push(e),n=b$,t=e,r+1):e==="x"&&o.length===1&&o[0]==="0"?(n=Bae,o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=Wh,r):(o.push(e),t=e,r+1)}function z(){return e==="f"&&(o.push(e),t=e,r+=1),/[eE]/.test(e)||e==="-"&&/[eE]/.test(t)?(o.push(e),t=e,r+1):/[^\d]/.test(e)?(y(o.join("")),n=Wh,r):(o.push(e),t=e,r+1)}function V(){if(/[^\d\w_]/.test(e)){var k=o.join("");return n=Tmt.indexOf(k)>-1?Amt:Smt.indexOf(k)>-1?Cmt:Emt,y(o.join("")),n=Wh,r}return o.push(e),t=e,r+1}}function Pmt(e){var t=Omt(),i=[];return i=(i=i.concat(t(e))).concat(t(null))}function Imt(e){return Pmt(e)}function $mt(e){return e.map(t=>t.type!=="eof"?t.data:"").join("")}const zV=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function Dmt(e,t="100",i="300 es"){const r=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of e)if(s.type==="preprocessor"){const n=r.exec(s.data);if(n){const o=n[1].replace(/\s\s+/g," ");if(o===i)return o;if(o===t)return s.data="#version "+i,t;throw new Error("unknown glsl version: "+o)}}return e.splice(0,0,{type:"preprocessor",data:"#version "+i},{type:"whitespace",data:`
`}),null}function Lmt(e,t){for(let i=t-1;i>=0;i--){const r=e[i];if(r.type!=="whitespace"&&r.type!=="block-comment"){if(r.type!=="keyword")break;if(r.data==="attribute"||r.data==="in")return!0}}return!1}function BA(e,t,i,r){r=r||i;for(const s of e)if(s.type==="ident"&&s.data===i)return r in t?t[r]++:t[r]=0,BA(e,t,r+"_"+t[r],r);return i}function OTe(e,t,i="afterVersion"){function r(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const m=l[f];if(m.type==="preprocessor"&&(m.data.match(/\#(if|ifdef|ifndef)\s+.+/)?++h:m.data.match(/\#endif\s*.*/)&&--h),i!=="afterVersion"&&i!=="afterPrecision"||m.type==="preprocessor"&&/^#version/.test(m.data)&&(p=Math.max(p,f)),i==="afterPrecision"&&m.type==="keyword"&&m.data==="precision"){const y=r(l,f);if(y===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,y)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<e.length&&/[^\r\n]$/.test(e[l].data);let a=s(e);o(a-1)&&e.splice(a++,0,n);for(const l of t)e.splice(a++,0,l);o(a-1)&&o(a)&&e.splice(a,0,n)}function Nmt(e,t,i,r="lowp"){OTe(e,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function Fmt(e,t,i,r,s="lowp"){OTe(e,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:r.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"ident",data:t},{type:"operator",data:";"}],"afterPrecision")}function Umt(e,t){let i,r,s=-1;for(let n=t;n<e.length;n++){const o=e[n];if(o.type==="operator"&&(o.data==="["&&(i=n),o.data==="]")){r=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return i&&r&&e.splice(i,r-i+1),s}function Gae(e,t){const i=kmt();if(_(i))return i;const r=Imt(e);if(Dmt(r,"100","300 es")==="300 es")return e;let s=null,n=null;const o={},a={};for(let l=0;l<r.length;++l){const c=r[l];switch(c.type){case"keyword":t===Hc.VERTEX_SHADER&&c.data==="attribute"?c.data="in":c.data==="varying"&&(c.data=t===Hc.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(c.data.trim())&&(c.data=c.data.replace(/(2D|Cube|EXT)/g,"")),t===Hc.FRAGMENT_SHADER&&c.data==="gl_FragColor"&&(s||(s=BA(r,o,"fragColor"),Nmt(r,s,"vec4")),c.data=s),t===Hc.FRAGMENT_SHADER&&c.data==="gl_FragData"){const h=Umt(r,l+1),p=BA(r,o,"fragData");Fmt(r,p,"vec4",h,"mediump"),c.data=p}else t===Hc.FRAGMENT_SHADER&&c.data==="gl_FragDepthEXT"&&(n||(n=BA(r,o,"gl_FragDepth")),c.data=n);break;case"ident":if(xmt.includes(c.data)){if(t===Hc.VERTEX_SHADER&&Lmt(r,l))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");c.data in a||(a[c.data]=BA(r,o,c.data)),c.data=a[c.data]}}}for(let l=r.length-1;l>=0;--l){const c=r[l];if(c.type==="preprocessor"){const h=c.data.match(/\#extension\s+(.*)\:/);if(h&&h[1]&&zV.includes(h[1].trim())){const m=r[l+1];r.splice(l,m&&m.type==="whitespace"?2:1)}const p=c.data.match(/\#ifdef\s+(.*)/);p&&p[1]&&zV.includes(p[1].trim())&&(c.data="#if 1");const f=c.data.match(/\#ifndef\s+(.*)/);f&&f[1]&&zV.includes(f[1].trim())&&(c.data="#if 0")}}return zmt(e,$mt(r))}function kmt(e){return null}function zmt(e,t){return t}const Vmt=4294967295;class Bmt{constructor(t,i,r,s,n=new Map){this._context=t,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,t||console.error("RenderingContext isn't initialized!"),i.length===0&&console.error("Shaders source should not be empty!"),this._context.type===ai.WEBGL2&&(i=Gae(i,Hc.VERTEX_SHADER),r=Gae(r,Hc.FRAGMENT_SHADER)),this._vShader=jae(this._context,Hc.VERTEX_SHADER,i),this._fShader=jae(this._context,Hc.FRAGMENT_SHADER,r),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(dn.Shader,this),vM()&&(this.vertexShader=i,this.fragmentShader=r)}get glName(){if(_(this._glName))return this._glName;if(R(this._vShader))return null;const t=this._context.gl,i=t.createProgram();if(t.attachShader(i,this._vShader),t.attachShader(i,this._fShader),this._locations.forEach((r,s)=>t.bindAttribLocation(i,r,s)),t.linkProgram(i),vM()&&!t.getProgramParameter(i,t.LINK_STATUS)&&console.error(`Could not link shader
validated: ${t.getProgramParameter(i,t.VALIDATE_STATUS)}, gl error ${t.getError()}, vertex: ${t.getShaderParameter(this._vShader,t.COMPILE_STATUS)}, fragment: ${t.getShaderParameter(this._fShader,t.COMPILE_STATUS)}, info log: ${t.getProgramInfoLog(i)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===ai.WEBGL2){const r=t;for(const[s,n]of this._uniformBlockBindings){const o=r.getUniformBlockIndex(i,s);o<Vmt&&r.uniformBlockBinding(i,o,n)}}return this._glName=i,this._context.instanceCounter.increment(dn.Program,this),i}get hasGLName(){return _(this._glName)}get isCompiled(){if(this._compiled)return!0;const t=this._context.gl.getExtension("KHR_parallel_shader_compile");return t==null?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,t.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const t=this._context.gl;this._vShader&&(t.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(dn.Shader,this)),this._fShader&&(t.deleteShader(this._fShader),this._fShader=null),this._glName&&(t.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(dn.Program,this))}ref(){++this._refCount}_getUniformLocation(t){return this._nameToUniformLocation[t]===void 0&&(this._nameToUniformLocation[t]=this._context.gl.getUniformLocation(this.glName,t)),this._nameToUniformLocation[t]}hasUniform(t){return this._getUniformLocation(t)!==null}setUniform1i(t,i){const r=this._nameToUniform1[t];r!==void 0&&i===r||(this._context.gl.uniform1i(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1iv(t,i){bp(this._nameToUniform1v,t,i)&&this._context.gl.uniform1iv(this._getUniformLocation(t),i)}setUniform2iv(t,i){bp(this._nameToUniform2,t,i)&&this._context.gl.uniform2iv(this._getUniformLocation(t),i)}setUniform3iv(t,i){bp(this._nameToUniform3,t,i)&&this._context.gl.uniform3iv(this._getUniformLocation(t),i)}setUniform4iv(t,i){bp(this._nameToUniform4,t,i)&&this._context.gl.uniform4iv(this._getUniformLocation(t),i)}setUniform1f(t,i){const r=this._nameToUniform1[t];r!==void 0&&i===r||(this._context.gl.uniform1f(this._getUniformLocation(t),i),this._nameToUniform1[t]=i)}setUniform1fv(t,i){bp(this._nameToUniform1v,t,i)&&this._context.gl.uniform1fv(this._getUniformLocation(t),i)}setUniform2f(t,i,r){const s=this._nameToUniform2.get(t);s===void 0?(this._context.gl.uniform2f(this._getUniformLocation(t),i,r),this._nameToUniform2.set(t,[i,r])):i===s[0]&&r===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(t),i,r),s[0]=i,s[1]=r)}setUniform2fv(t,i){bp(this._nameToUniform2,t,i)&&this._context.gl.uniform2fv(this._getUniformLocation(t),i)}setUniform3f(t,i,r,s){const n=this._nameToUniform3.get(t);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(t),i,r,s),this._nameToUniform3[t]=[i,r,s]):i===n[0]&&r===n[1]&&s===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(t),i,r,s),n[0]=i,n[1]=r,n[2]=s)}setUniform3fv(t,i){bp(this._nameToUniform3,t,i)&&this._context.gl.uniform3fv(this._getUniformLocation(t),i)}setUniform4f(t,i,r,s,n){const o=this._nameToUniform4.get(t);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(t),i,r,s,n),this._nameToUniform4.set(t,[i,r,s,n])):o!==void 0&&i===o[0]&&r===o[1]&&s===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(t),i,r,s,n),o[0]=i,o[1]=r,o[2]=s,o[3]=n)}setUniform4fv(t,i){bp(this._nameToUniform4,t,i)&&this._context.gl.uniform4fv(this._getUniformLocation(t),i)}setUniformMatrix3fv(t,i,r=!1){bp(this._nameToUniformMatrix3,t,i)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(t),r,i)}setUniformMatrix4fv(t,i,r=!1){bp(this._nameToUniformMatrix4,t,i)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(t),r,i)}stop(){}}function jae(e,t,i){const r=e.gl,s=r.createShader(t);return r.shaderSource(s,i),r.compileShader(s),vM()&&!r.getShaderParameter(s,r.COMPILE_STATUS)&&(console.error("Compile error in ".concat(t===Hc.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(r.getShaderInfoLog(s)),console.error(Gmt(i))),s}function Gmt(e){let t=2;return e.replace(/\n/g,()=>`
`+jmt(t++)+":")}function jmt(e){return e>=1e3?e.toString():("  "+e).slice(-3)}function bp(e,t,i){const r=e.get(t);return r?vH(r,i):(e.set(t,Array.from(i)),!0)}class Hmt{constructor(t){this._rctx=t,this._store=new qY}dispose(){this._store.forEach(t=>t.forEach(i=>i.dispose())),this._store.clear()}acquire(t,i,r,s){const n=this._store.get(t,i);if(_(n))return n.ref(),n;const o=new Bmt(this._rctx,t,i,r,s);return o.ref(),this._store.set(t,i,o),o}get test(){let t=0;return this._store.forEach(i=>i.forEach(r=>t+=r.hasGLName?2:1)),{cachedWebGLObjects:t}}}function Hae(e,t){const i=new xr(e,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,wrapMode:_t.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:1,height:1});function r(b,S){const T=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${t?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,E=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `,C=e.programCache.acquire(T,E,new Map([["position",0]])),M=new Float32Array(6);U7(b,M,3);const I=new Float32Array(6);return U7(S,I,3),e.useProgram(C),C.setUniform3f("u_highA",M[0],M[2],M[4]),C.setUniform3f("u_lowA",M[1],M[3],M[5]),C.setUniform3f("u_highB",I[0],I[2],I[4]),C.setUniform3f("u_lowB",I[1],I[3],I[5]),C}const s=ti.createVertex(e,yi.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),n=new Ns(e,new Map([["position",0]]),{geometry:[new to("position",2,ht.UNSIGNED_SHORT,0,4)]},{geometry:s}),o=Fe(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),a=Fe(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),l=r(o,a),c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:m}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.bindVAO(n),e.drawArrays(Pt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);i.readPixels(0,0,1,1,ze.RGBA,St.UNSIGNED_BYTE,y),l.dispose(),n.dispose(!1),s.dispose(),i.dispose(),e.setViewport(h,p,f,m),e.bindFramebuffer(c);const v=(o[2]-a[2])/25,w=OY(y);return Math.abs(v-w)}var qae,Wae,Xae,PTe={exports:{}};function qmt(e){var y,v,w,b,S;if(!e.gl)return!1;if(e.type===ai.WEBGL1)return!(!((y=e.capabilities.textureFloat)==null?void 0:y.textureFloat)||!((v=e.capabilities.colorBufferFloat)==null?void 0:v.textureFloat));if(!(((w=e.capabilities.textureFloat)==null?void 0:w.textureFloat)&&((b=e.capabilities.colorBufferFloat)==null?void 0:b.textureFloat)&&((S=e.capabilities.colorBufferFloat)==null?void 0:S.floatBlend)))return!1;const t=new xr(e,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,wrapMode:_t.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:St.FLOAT,internalFormat:ft.RGBA32F,samplingMode:Ke.NEAREST,width:1,height:1}),i=ti.createVertex(e,yi.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),r=new Ns(e,new Map([["a_pos",0]]),{geometry:[new to("a_pos",2,ht.UNSIGNED_SHORT,0,4)]},{geometry:i}),s=`
  precision highp float;
  attribute vec2 a_pos;

  void main() {
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,n=`
   precision highp float;

   void main() {
    gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
   }
  `,o=e.programCache.acquire(s,n,new Map([["a_pos",0]]));e.useProgram(o);const a=e.getBoundFramebufferObject(),{x:l,y:c,width:h,height:p}=e.getViewport();e.bindFramebuffer(t),e.setViewport(0,0,1,1),e.bindVAO(r),e.drawArrays(Pt.TRIANGLE_STRIP,0,4);const f=Ut({blending:T1e});e.setPipelineState(f),e.drawArrays(Pt.TRIANGLE_STRIP,0,4),PTe.exports.init(e);const m=e.gl.getError();return e.setViewport(l,c,h,p),e.bindFramebuffer(a),o.dispose(),r.dispose(!1),i.dispose(),t.dispose(),m!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}qae=PTe,Wae=function(){var e=function(v){window.console&&window.console.log&&window.console.log(v)},t=function(v){window.console&&window.console.error?window.console.error(v):e(v)},i={enable:{1:{0:!0}},disable:{1:{0:!0}},getParameter:{1:{0:!0}},drawArrays:{3:{0:!0}},drawElements:{4:{0:!0,2:!0}},createShader:{1:{0:!0}},getShaderParameter:{2:{1:!0}},getProgramParameter:{2:{1:!0}},getShaderPrecisionFormat:{2:{0:!0,1:!0}},getVertexAttrib:{2:{1:!0}},vertexAttribPointer:{6:{2:!0}},bindTexture:{2:{0:!0}},activeTexture:{1:{0:!0}},getTexParameter:{2:{0:!0,1:!0}},texParameterf:{3:{0:!0,1:!0}},texParameteri:{3:{0:!0,1:!0,2:!0}},texImage2D:{9:{0:!0,2:!0,6:!0,7:!0},6:{0:!0,2:!0,3:!0,4:!0}},texSubImage2D:{9:{0:!0,6:!0,7:!0},7:{0:!0,4:!0,5:!0}},copyTexImage2D:{8:{0:!0,2:!0}},copyTexSubImage2D:{8:{0:!0}},generateMipmap:{1:{0:!0}},compressedTexImage2D:{7:{0:!0,2:!0}},compressedTexSubImage2D:{8:{0:!0,6:!0}},bindBuffer:{2:{0:!0}},bufferData:{3:{0:!0,2:!0}},bufferSubData:{3:{0:!0}},getBufferParameter:{2:{0:!0,1:!0}},pixelStorei:{2:{0:!0,1:!0}},readPixels:{7:{4:!0,5:!0}},bindRenderbuffer:{2:{0:!0}},bindFramebuffer:{2:{0:!0}},checkFramebufferStatus:{1:{0:!0}},framebufferRenderbuffer:{4:{0:!0,1:!0,2:!0}},framebufferTexture2D:{5:{0:!0,1:!0,2:!0}},getFramebufferAttachmentParameter:{3:{0:!0,1:!0,2:!0}},getRenderbufferParameter:{2:{0:!0,1:!0}},renderbufferStorage:{4:{0:!0,1:!0}},clear:{1:{0:{enumBitwiseOr:["COLOR_BUFFER_BIT","DEPTH_BUFFER_BIT","STENCIL_BUFFER_BIT"]}}},depthFunc:{1:{0:!0}},blendFunc:{2:{0:!0,1:!0}},blendFuncSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},blendEquation:{1:{0:!0}},blendEquationSeparate:{2:{0:!0,1:!0}},stencilFunc:{3:{0:!0}},stencilFuncSeparate:{4:{0:!0,1:!0}},stencilMaskSeparate:{2:{0:!0}},stencilOp:{3:{0:!0,1:!0,2:!0}},stencilOpSeparate:{4:{0:!0,1:!0,2:!0,3:!0}},cullFace:{1:{0:!0}},frontFace:{1:{0:!0}},drawArraysInstancedANGLE:{4:{0:!0}},drawElementsInstancedANGLE:{5:{0:!0,2:!0}},blendEquationEXT:{1:{0:!0}}},r=null,s=null;function n(v){if(r==null)for(var w in r={},s={},v)typeof v[w]=="number"&&(r[v[w]]=w,s[w]=v[w])}function o(){if(r==null)throw"WebGLDebugUtils.init(ctx) not called"}function a(v){return o(),r[v]!==void 0}function l(v){o();var w=r[v];return w!==void 0?"gl."+w:"/*UNKNOWN WebGL ENUM*/ 0x"+v.toString(16)}function c(v,w,b,S){var T;if((T=i[v])!==void 0&&(T=T[w])!==void 0&&T[b]){if(typeof T[b]=="object"&&T[b].enumBitwiseOr!==void 0){for(var E=T[b].enumBitwiseOr,C=0,M=[],I=0;I<E.length;++I){var N=s[E[I]];(S&N)!=0&&(C|=N,M.push(l(N)))}return C===S?M.join(" | "):l(S)}return l(S)}return S===null?"null":S===void 0?"undefined":S.toString()}function h(v,w){for(var b="",S=w.length,T=0;T<S;++T)b+=(T==0?"":", ")+c(v,S,T,w[T]);return b}function p(v,w,b){v.__defineGetter__(b,function(){return w[b]}),v.__defineSetter__(b,function(S){w[b]=S})}function f(v,w,b,S){S=S||v,n(v),w=w||function(N,D,z){for(var V="",k=z.length,Y=0;Y<k;++Y)V+=(Y==0?"":", ")+c(D,k,Y,z[Y]);t("WebGL error "+l(N)+" in "+D+"("+V+")")};var T={};function E(N,D){return function(){b&&b(D,arguments);var z=N[D].apply(N,arguments),V=S.getError();return V!=0&&(T[V]=!0,w(V,D,arguments)),z}}var C={};for(var M in v)if(typeof v[M]=="function")if(M!="getExtension")C[M]=E(v,M);else{var I=E(v,M);C[M]=function(){return f(I.apply(v,arguments),w,b,S)}}else p(C,v,M);return C.getError=function(){for(var N in T)if(T.hasOwnProperty(N)&&T[N])return T[N]=!1,N;return v.NO_ERROR},C}function m(v){var w=v.getParameter(v.MAX_VERTEX_ATTRIBS),b=v.createBuffer();v.bindBuffer(v.ARRAY_BUFFER,b);for(var S=0;S<w;++S)v.disableVertexAttribArray(S),v.vertexAttribPointer(S,4,v.FLOAT,!1,0,0),v.vertexAttrib1f(S,0);v.deleteBuffer(b);var T=v.getParameter(v.MAX_TEXTURE_IMAGE_UNITS);for(S=0;S<T;++S)v.activeTexture(v.TEXTURE0+S),v.bindTexture(v.TEXTURE_CUBE_MAP,null),v.bindTexture(v.TEXTURE_2D,null);for(v.activeTexture(v.TEXTURE0),v.useProgram(null),v.bindBuffer(v.ARRAY_BUFFER,null),v.bindBuffer(v.ELEMENT_ARRAY_BUFFER,null),v.bindFramebuffer(v.FRAMEBUFFER,null),v.bindRenderbuffer(v.RENDERBUFFER,null),v.disable(v.BLEND),v.disable(v.CULL_FACE),v.disable(v.DEPTH_TEST),v.disable(v.DITHER),v.disable(v.SCISSOR_TEST),v.blendColor(0,0,0,0),v.blendEquation(v.FUNC_ADD),v.blendFunc(v.ONE,v.ZERO),v.clearColor(0,0,0,0),v.clearDepth(1),v.clearStencil(-1),v.colorMask(!0,!0,!0,!0),v.cullFace(v.BACK),v.depthFunc(v.LESS),v.depthMask(!0),v.depthRange(0,1),v.frontFace(v.CCW),v.hint(v.GENERATE_MIPMAP_HINT,v.DONT_CARE),v.lineWidth(1),v.pixelStorei(v.PACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_ALIGNMENT,4),v.pixelStorei(v.UNPACK_FLIP_Y_WEBGL,!1),v.pixelStorei(v.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),v.UNPACK_COLORSPACE_CONVERSION_WEBGL&&v.pixelStorei(v.UNPACK_COLORSPACE_CONVERSION_WEBGL,v.BROWSER_DEFAULT_WEBGL),v.polygonOffset(0,0),v.sampleCoverage(1,!1),v.scissor(0,0,v.canvas.width,v.canvas.height),v.stencilFunc(v.ALWAYS,0,4294967295),v.stencilMask(4294967295),v.stencilOp(v.KEEP,v.KEEP,v.KEEP),v.viewport(0,0,v.canvas.width,v.canvas.height),v.clear(v.COLOR_BUFFER_BIT|v.DEPTH_BUFFER_BIT|v.STENCIL_BUFFER_BIT);v.getError(););}function y(v){var w,b,S=[],T=[],E={},C=1,M=!1,I=[],N=0,D=0,z=!1,V=0,k={};function Y(j){return typeof j=="function"?j:function(ee){j.handleEvent(ee)}}v.getContext=(b=v.getContext,function(){var j=b.apply(v,arguments);if(j instanceof WebGLRenderingContext){if(j!=w){if(w)throw"got different context";E=K(w=j)}return E}return j});var Z=function(j){S.push(Y(j))},le=function(j){T.push(Y(j))};function ne(j){var ee=j.addEventListener;j.addEventListener=function(ye,Te,Ne){switch(ye){case"webglcontextlost":Z(Te);break;case"webglcontextrestored":le(Te);break;default:ee.apply(j,arguments)}}}function $(){for(var j=Object.keys(k),ee=0;ee<j.length;++ee)delete k[j]}function U(){++D,M||N==D&&v.loseContext()}function B(j,ee){var ye=j[ee];return function(){if(U(),!M)return ye.apply(j,arguments)}}function H(){for(var j=0;j<I.length;++j){var ee=I[j];ee instanceof WebGLBuffer?w.deleteBuffer(ee):ee instanceof WebGLFramebuffer?w.deleteFramebuffer(ee):ee instanceof WebGLProgram?w.deleteProgram(ee):ee instanceof WebGLRenderbuffer?w.deleteRenderbuffer(ee):ee instanceof WebGLShader?w.deleteShader(ee):ee instanceof WebGLTexture&&w.deleteTexture(ee)}}function W(j){return{statusMessage:j,preventDefault:function(){z=!0}}}return ne(v),v.loseContext=function(){if(!M){for(M=!0,N=0,++C;w.getError(););$(),k[w.CONTEXT_LOST_WEBGL]=!0;var j=W("context lost"),ee=S.slice();setTimeout(function(){for(var ye=0;ye<ee.length;++ye)ee[ye](j);V>=0&&setTimeout(function(){v.restoreContext()},V)},0)}},v.restoreContext=function(){M&&T.length&&setTimeout(function(){if(!z)throw"can not restore. webglcontestlost listener did not call event.preventDefault";H(),m(w),M=!1,D=0,z=!1;for(var j=T.slice(),ee=W("context restored"),ye=0;ye<j.length;++ye)j[ye](ee)},0)},v.loseContextInNCalls=function(j){if(M)throw"You can not ask a lost contet to be lost";N=D+j},v.getNumCalls=function(){return D},v.setRestoreTimeout=function(j){V=j},v;function K(j){for(var ee in j)typeof j[ee]=="function"?E[ee]=B(j,ee):p(E,j,ee);E.getError=function(){if(U(),!M)for(;Ce=w.getError();)k[Ce]=!0;for(var Ce in k)if(k[Ce])return delete k[Ce],Ce;return E.NO_ERROR};for(var ye=["createBuffer","createFramebuffer","createProgram","createRenderbuffer","createShader","createTexture"],Te=0;Te<ye.length;++Te){var Ne=ye[Te];E[Ne]=function(Ce){return function(){if(U(),M)return null;var Le=Ce.apply(j,arguments);return Le.__webglDebugContextLostId__=C,I.push(Le),Le}}(j[Ne])}var _e=["getActiveAttrib","getActiveUniform","getBufferParameter","getContextAttributes","getAttachedShaders","getFramebufferAttachmentParameter","getParameter","getProgramParameter","getProgramInfoLog","getRenderbufferParameter","getShaderParameter","getShaderInfoLog","getShaderSource","getTexParameter","getUniform","getUniformLocation","getVertexAttrib"];for(Te=0;Te<_e.length;++Te)Ne=_e[Te],E[Ne]=function(Ce){return function(){return U(),M?null:Ce.apply(j,arguments)}}(E[Ne]);var ge=["isBuffer","isEnabled","isFramebuffer","isProgram","isRenderbuffer","isShader","isTexture"];for(Te=0;Te<ge.length;++Te)Ne=ge[Te],E[Ne]=function(Ce){return function(){return U(),!M&&Ce.apply(j,arguments)}}(E[Ne]);return E.checkFramebufferStatus=function(Ce){return function(){return U(),M?E.FRAMEBUFFER_UNSUPPORTED:Ce.apply(j,arguments)}}(E.checkFramebufferStatus),E.getAttribLocation=function(Ce){return function(){return U(),M?-1:Ce.apply(j,arguments)}}(E.getAttribLocation),E.getVertexAttribOffset=function(Ce){return function(){return U(),M?0:Ce.apply(j,arguments)}}(E.getVertexAttribOffset),E.isContextLost=function(){return M},E}}return{init:n,mightBeEnum:a,glEnumToString:l,glFunctionArgToString:c,glFunctionArgsToString:h,makeDebugContext:f,makeLostContextSimulatingCanvas:y,resetToInitialState:m}},(Xae=Wae())!==void 0&&(qae.exports=Xae);const Wmt=me.getLogger("esri.views.WebGLDriverTest");function Xmt(e){const t=new xr(e,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,wrapMode:_t.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:1,height:1}),i=`
precision highp float;
attribute vec2 a_pos;
uniform highp sampler2D u_texture;
varying vec4 v_color;

float getBit(in float bitset, in int bitIndex) {
  float offset = pow(2.0, float(bitIndex));
  return mod(floor(bitset / offset), 2.0);
}

void main() {
  vec4 value = texture2D(u_texture, vec2(0.0));
  float bit = getBit(value.x * 255.0, 1);

  v_color = bit * vec4(1.0);
  gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
}
`,r=`
precision highp float;
varying vec4 v_color;

void main() {
  gl_FragColor = v_color;
}
`,s=new Uint8Array(4),n=ti.createVertex(e,yi.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Ns(e,new Map([["a_position",0]]),{geometry:[new to("a_position",2,ht.SHORT,0,4)]},{geometry:n}),a=e.programCache.acquire(i,r,new Map([["a_pos",0]]));e.useProgram(a);const l=new st(e,{target:pt.TEXTURE_2D,wrapMode:_t.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:1,height:1},new Uint8Array([2,255,0,0]));a.setUniform1i("u_texture",0),e.bindTexture(l,0);const c=e.getBoundFramebufferObject();e.bindFramebuffer(t),e.useProgram(a);const{x:h,y:p,width:f,height:m}=e.getViewport();e.setViewport(0,0,1,1),e.bindVAO(o),e.drawArrays(Pt.TRIANGLE_STRIP,0,4),e.setViewport(h,p,f,m),t.readPixels(0,0,1,1,ze.RGBA,St.UNSIGNED_BYTE,s),a.dispose(),o.dispose(!1),n.dispose(),t.dispose();const y=s[0]!==255||s[1]!==255||s[2]!==255||s[3]!==255;return y&&Wmt.warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${s[0]}.${s[1]}.${s[2]}.${s[3]}]`),e.bindFramebuffer(c),y}new to("a_pos",2,ht.BYTE,0,2);new to("a_pos",2,ht.BYTE,0,4),new to("a_tex",2,ht.BYTE,2,4);const Ymt={geometry:[new to("a_pos",2,ht.UNSIGNED_SHORT,0,4)]};async function Zmt(e){const t=new Image;if(t.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",t.width=5,t.height=5,await t.decode(),!e.gl)return!0;const i=new xr(e,{colorTarget:Zr.TEXTURE,depthStencilTarget:xi.NONE},{target:pt.TEXTURE_2D,wrapMode:_t.CLAMP_TO_EDGE,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,samplingMode:Ke.NEAREST,width:1,height:1}),r=ti.createVertex(e,yi.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),s=new Ns(e,new Map([["a_pos",0]]),Ymt,{geometry:r}),n=`
  precision highp float;

  attribute vec2 a_pos;
  varying vec2 v_uv;

  void main() {
    v_uv = a_pos;
    gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
  }
  `,o=`
  precision highp float;

  varying vec2 v_uv;
  uniform sampler2D u_texture;

  void main() {
    gl_FragColor = texture2D(u_texture, v_uv);
  }
  `,a=e.programCache.acquire(n,o,new Map([["a_pos",0]]));e.useProgram(a);const l=new st(e,{dataType:St.UNSIGNED_BYTE,pixelFormat:ze.RGBA,preMultiplyAlpha:!1,wrapMode:_t.CLAMP_TO_EDGE,samplingMode:Ke.LINEAR},t);e.bindTexture(l,0),a.setUniform1i("u_texture",0);const c=e.getBoundFramebufferObject(),{x:h,y:p,width:f,height:m}=e.getViewport();e.bindFramebuffer(i),e.setViewport(0,0,1,1),e.setClearColor(0,0,0,0),e.setBlendingEnabled(!1),e.clearSafe(Xi.COLOR_BUFFER_BIT),e.bindVAO(s),e.drawArrays(Pt.TRIANGLE_STRIP,0,4);const y=new Uint8Array(4);return i.readPixels(0,0,1,1,ze.RGBA,St.UNSIGNED_BYTE,y),a.dispose(),s.dispose(!1),r.dispose(),i.dispose(),l.dispose(),e.setViewport(h,p,f,m),e.bindFramebuffer(c),t.src="",y[0]===255}class Qmt{constructor(t){this.context=t,this._floatBufferBlendWorking=qmt(t),Zmt(t).then(i=>this._svgAlwaysPremultipliesAlpha=!i)}get floatBufferBlendWorking(){if(R(this._floatBufferBlendWorking))throw new Error("floatBufferBlendWorking test not yet available");return this._floatBufferBlendWorking}get svgAlwaysPremultipliesAlpha(){if(R(this._svgAlwaysPremultipliesAlpha))throw new Error("svgAlwaysPremultipliesAlpha test not yet available");return this._svgAlwaysPremultipliesAlpha}get doublePrecisionRequiresObfuscation(){if(R(this._doublePrecisionRequiresObfuscation)){const t=Hae(this.context,!1),i=Hae(this.context,!0);this._doublePrecisionRequiresObfuscation=t!==0&&(i===0||t/i>5)}return this._doublePrecisionRequiresObfuscation}get ignoresSamplerPrecision(){return R(this._ignoresSamplerPrecision)&&(this._ignoresSamplerPrecision=Xmt(this.context)),this._ignoresSamplerPrecision}}class Yae{constructor(t,i,r,s,n,o,a,l){this.createQuery=t,this.resultAvailable=i,this.getResult=r,this.disjoint=s,this.beginTimeElapsed=n,this.endTimeElapsed=o,this.createTimestamp=a,this.timestampBits=l}}function Jmt(e,t){if(t.disjointTimerQuery)return null;let i=e.getExtension("EXT_disjoint_timer_query_webgl2");return i&&Cn(e)?new Yae(()=>e.createQuery(),r=>e.getQueryParameter(r,e.QUERY_RESULT_AVAILABLE),r=>e.getQueryParameter(r,e.QUERY_RESULT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>e.beginQuery(i.TIME_ELAPSED_EXT,r),()=>e.endQuery(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>e.getQuery(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):(i=e.getExtension("EXT_disjoint_timer_query"),i?new Yae(()=>i.createQueryEXT(),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_AVAILABLE_EXT),r=>i.getQueryObjectEXT(r,i.QUERY_RESULT_EXT),()=>e.getParameter(i.GPU_DISJOINT_EXT),r=>i.beginQueryEXT(i.TIME_ELAPSED_EXT,r),()=>i.endQueryEXT(i.TIME_ELAPSED_EXT),r=>i.queryCounterEXT(r,i.TIMESTAMP_EXT),()=>i.getQueryEXT(i.TIMESTAMP_EXT,i.QUERY_COUNTER_BITS_EXT)):null)}function Kmt(e,t){if(t.disjointTimerQuery)return null;if(Cn(e))return{drawBuffers:e.drawBuffers.bind(e),MAX_DRAW_BUFFERS:e.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:e.MAX_COLOR_ATTACHMENTS};if(t.drawBuffers)return null;const i=e.getExtension("WEBGL_draw_buffers");return i?{drawBuffers:i.drawBuffersWEBGL.bind(i),MAX_DRAW_BUFFERS:i.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:i.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function egt(e){if(Cn(e))return{drawArraysInstanced:e.drawArraysInstanced.bind(e),drawElementsInstanced:e.drawElementsInstanced.bind(e),vertexAttribDivisor:e.vertexAttribDivisor.bind(e)};const t=e.getExtension("ANGLE_instanced_arrays");return t?{drawArraysInstanced:t.drawArraysInstancedANGLE.bind(t),drawElementsInstanced:t.drawElementsInstancedANGLE.bind(t),vertexAttribDivisor:t.vertexAttribDivisorANGLE.bind(t)}:null}function tgt(e,t){if(t.compressedTextureETC)return null;const i=e.getExtension("WEBGL_compressed_texture_etc");return i?{COMPRESSED_R11_EAC:i.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:i.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:i.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:i.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:i.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:i.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:i.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:i.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:i.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function igt(e,t){if(t.compressedTextureS3TC)return null;const i=e.getExtension("WEBGL_compressed_texture_s3tc");return i?{COMPRESSED_RGB_S3TC_DXT1:i.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:i.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:i.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:i.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function rgt(e,t){if(Cn(e))return{MIN:e.MIN,MAX:e.MAX};if(t.blendMinMax)return null;{const i=e.getExtension("EXT_blend_minmax");return i?{MIN:i.MIN_EXT,MAX:i.MAX_EXT}:null}}function sgt(e,t){if(t.textureFilterAnisotropic)return null;const i=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return i?{MAX_TEXTURE_MAX_ANISOTROPY:i.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:i.TEXTURE_MAX_ANISOTROPY_EXT}:null}function ngt(e,t){if(Cn(e))return{textureFloat:!0,textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:e.HALF_FLOAT,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F};if(e instanceof WebGLRenderingContext){const i=!t.textureHalfFloat&&e.getExtension("OES_texture_half_float");return{textureFloat:!t.textureFloat&&!!e.getExtension("OES_texture_float"),textureFloatLinear:!t.textureFloatLinear&&!!e.getExtension("OES_texture_float_linear"),textureHalfFloat:!!i,textureHalfFloatLinear:!t.textureHalfFloatLinear&&!!e.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:i?i.HALF_FLOAT_OES:void 0}}return null}function ogt(e,t){if(Cn(e)){const i=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float")||!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),r=!t.colorBufferFloat&&e.getExtension("EXT_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,R16F:e.R16F,RG16F:e.RG16F,RGBA16F:e.RGBA16F,R32F:e.R32F,RG32F:e.RG32F,RGBA32F:e.RGBA32F,R11F_G11F_B10F:e.R11F_G11F_B10F,RGB16F:e.RGB16F}:null}if(e instanceof WebGLRenderingContext){const i=!t.colorBufferHalfFloat&&e.getExtension("EXT_color_buffer_half_float"),r=!t.colorBufferFloat&&e.getExtension("WEBGL_color_buffer_float"),s=!t.floatBlend&&!t.colorBufferFloat&&e.getExtension("EXT_float_blend");return i||r||s?{textureFloat:!!r,textureHalfFloat:!!i,floatBlend:!!s,RGBA16F:i?i.RGBA16F_EXT:void 0,RGB16F:i?i.RGB16F_EXT:void 0,RGBA32F:r?r.RGBA32F_EXT:void 0}:null}return null}function SC(e,t,i,r,s){if(r&&Cn(e))return!0;if(t[i])return!1;for(const n of s)if(e.getExtension(n))return!0;return!1}function agt(e,t){if(!Cn(e)||t.textureNorm16)return null;const i=e.getExtension("EXT_texture_norm16");return i?{R16:i.R16_EXT,RG16:i.RG16_EXT,RGB16:i.RGB16_EXT,RGBA16:i.RGBA16_EXT,R16_SNORM:i.R16_SNORM_EXT,RG16_SNORM:i.RG16_SNORM_EXT,RGB16_SNORM:i.RGB16_SNORM_EXT,RGBA16_SNORM:i.RGBA16_SNORM_EXT}:null}function lgt(e,t){const i=t.loseContext&&e.getExtension("WEBGL_lose_context");return i?{loseRenderingContext:()=>i.loseContext()}:null}function cgt(e,t){if(Cn(e))return{createVertexArray:e.createVertexArray.bind(e),deleteVertexArray:e.deleteVertexArray.bind(e),bindVertexArray:e.bindVertexArray.bind(e)};if(t.vao)return null;const i=e.getExtension("OES_vertex_array_object")||e.getExtension("MOZ_OES_vertex_array_object")||e.getExtension("WEBKIT_OES_vertex_array_object");return i?{createVertexArray:i.createVertexArrayOES.bind(i),deleteVertexArray:i.deleteVertexArrayOES.bind(i),bindVertexArray:i.bindVertexArrayOES.bind(i)}:null}class ugt{constructor(t,i){this.gl=t,this._depthTexture=null,this._standardDerivatives=null,this._shaderTextureLOD=null,this._fragDepth=null,this._textureFloatLinear=null,this._disabledExtensions=i.disabledExtensions||{},this._debugWebGLExtensions=i.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=Kmt(this.gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=egt(this.gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=cgt(this.gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=tgt(this.gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=igt(this.gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=sgt(this.gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=Jmt(this.gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=ngt(this.gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=ogt(this.gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=rgt(this.gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=SC(this.gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get standardDerivatives(){return this._standardDerivatives===null&&(this._standardDerivatives=SC(this.gl,this._disabledExtensions,"standardDerivatives",!0,["OES_standard_derivatives"])),this._standardDerivatives}get shaderTextureLOD(){return this._shaderTextureLOD===null&&(this._shaderTextureLOD=SC(this.gl,this._disabledExtensions,"shaderTextureLOD",!0,["EXT_shader_texture_lod"])),this._shaderTextureLOD}get fragDepth(){return this._fragDepth===null&&(this._fragDepth=SC(this.gl,this._disabledExtensions,"fragDepth",!0,["EXT_frag_depth"])),this._fragDepth}get loseContext(){return this._loseContext||(this._loseContext=lgt(this.gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=agt(this.gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear===null&&(this._textureFloatLinear=SC(this.gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(t){return this[t]}}class hgt{constructor(t,i){this.gl=t,this.instanceCounter=new wmt,this.programCache=new Hmt(this),this._state=new $ae,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=Cn(t)?ai.WEBGL2:ai.WEBGL1,this._loadExtensions(),this.configure(i)}configure(t){this._capabilities=new ugt(this.gl,t),this._parameters=this._loadParameters(t);const i=this.gl.getParameter(this.gl.VIEWPORT);this._state=new $ae,this._state.viewport={x:i[0],y:i[1],width:i[2],height:i[3]},this._stateTracker=new qGe({setBlending:r=>{if(r){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(r.opRgb,r.opAlpha),this.setBlendFunctionSeparate(r.srcRgb,r.dstRgb,r.srcAlpha,r.dstAlpha);const s=r.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:r=>{r?(this.setFaceCullingEnabled(!0),this.setCullFace(r.face),this.setFrontFace(r.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:r=>{r?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(r.factor,r.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:r=>{r?(this.setDepthTestEnabled(!0),this.setDepthFunction(r.func)):this.setDepthTestEnabled(!1)},setStencilTest:r=>{if(r){this.setStencilTestEnabled(!0);const s=r.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=r.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:r=>{r?(this.setDepthWriteEnabled(!0),this.setDepthRange(r.zNear,r.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:r=>{r?this.setColorMask(r.r,r.g,r.b,r.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:r=>{r?this.setStencilWriteMask(r.mask):this.setStencilWriteMask(0)}}),this.enforceState(),this._driverTest=new Qmt(this)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}dispose(){this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(bt.ARRAY_BUFFER),this.unbindBuffer(bt.ELEMENT_ARRAY_BUFFER),Cn(this.gl)&&(this.unbindBuffer(bt.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(bt.PIXEL_PACK_BUFFER),this.unbindBuffer(bt.PIXEL_UNPACK_BUFFER),this.unbindBuffer(bt.COPY_READ_BUFFER),this.unbindBuffer(bt.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,Ju()&&this.instanceCounter.printResourceCount()}setPipelineState(t){this._stateTracker.setPipeline(t)}setBlendingEnabled(t){this._state.blend!==t&&(t===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=t,this._stateTracker.invalidateBlending())}externalProgramUpdate(){var t;(t=this._state.program)==null||t.stop(),this._state.program=null}externalTextureUnitUpdate(t,i){for(let r=0;r<t.length;++r)this._state.textureUnitMap[t[r]]=null;i>=0&&(this._state.activeTexture=i)}externalVertexArrayObjectUpdate(){const t=this.capabilities.vao;t&&(t.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(t,i,r,s){t===this._state.blendColor.r&&i===this._state.blendColor.g&&r===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(t,i,r,s),this._state.blendColor.r=t,this._state.blendColor.g=i,this._state.blendColor.b=r,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(t,i){t===this._state.blendFunction.srcRGB&&i===this._state.blendFunction.dstRGB||(this.gl.blendFunc(t,i),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=t,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=i,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(t,i,r,s){this._state.blendFunction.srcRGB===t&&this._state.blendFunction.srcAlpha===r&&this._state.blendFunction.dstRGB===i&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(t,i,r,s),this._state.blendFunction.srcRGB=t,this._state.blendFunction.srcAlpha=r,this._state.blendFunction.dstRGB=i,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(t){this._state.blendEquation.mode!==t&&(this.gl.blendEquation(t),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=t,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(t,i){this._state.blendEquation.mode===t&&this._state.blendEquation.modeAlpha===i||(this.gl.blendEquationSeparate(t,i),this._state.blendEquation.mode=t,this._state.blendEquation.modeAlpha=i,this._stateTracker.invalidateBlending())}setColorMask(t,i,r,s){this._state.colorMask.r===t&&this._state.colorMask.g===i&&this._state.colorMask.b===r&&this._state.colorMask.a===s||(this.gl.colorMask(t,i,r,s),this._state.colorMask.r=t,this._state.colorMask.g=i,this._state.colorMask.b=r,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(t,i,r,s){this._state.clearColor.r===t&&this._state.clearColor.g===i&&this._state.clearColor.b===r&&this._state.clearColor.a===s||(this.gl.clearColor(t,i,r,s),this._state.clearColor.r=t,this._state.clearColor.g=i,this._state.clearColor.b=r,this._state.clearColor.a=s)}setFaceCullingEnabled(t){this._state.faceCulling!==t&&(t===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=t,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(t){this._state.polygonOffsetFill!==t&&(t===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=t,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(t,i){this._state.polygonOffset[0]===t&&this._state.polygonOffset[1]===i||(this._state.polygonOffset[0]=t,this._state.polygonOffset[1]=i,this.gl.polygonOffset(t,i),this._stateTracker.invalidatePolygonOffset())}setCullFace(t){this._state.cullFace!==t&&(this.gl.cullFace(t),this._state.cullFace=t,this._stateTracker.invalidateCulling())}setFrontFace(t){this._state.frontFace!==t&&(this.gl.frontFace(t),this._state.frontFace=t,this._stateTracker.invalidateCulling())}setScissorTestEnabled(t){this._state.scissorTest!==t&&(t===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=t)}setScissorRect(t,i,r,s){this._state.scissorRect.x===t&&this._state.scissorRect.y===i&&this._state.scissorRect.width===r&&this._state.scissorRect.height===s||(this.gl.scissor(t,i,r,s),this._state.scissorRect.x=t,this._state.scissorRect.y=i,this._state.scissorRect.width=r,this._state.scissorRect.height=s)}setDepthTestEnabled(t){this._state.depthTest!==t&&(t===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=t,this._stateTracker.invalidateDepthTest())}setClearDepth(t){this._state.clearDepth!==t&&(this.gl.clearDepth(t),this._state.clearDepth=t)}setDepthFunction(t){this._state.depthFunction!==t&&(this.gl.depthFunc(t),this._state.depthFunction=t,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(t){this._state.depthWrite!==t&&(this.gl.depthMask(t),this._state.depthWrite=t,this._stateTracker.invalidateDepthWrite())}setDepthRange(t,i){this._state.depthRange.zNear===t&&this._state.depthRange.zFar===i||(this.gl.depthRange(t,i),this._state.depthRange.zNear=t,this._state.depthRange.zFar=i,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(t){this._state.stencilTest!==t&&(t===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=t,this._stateTracker.invalidateStencilTest())}setClearStencil(t){t!==this._state.clearStencil&&(this.gl.clearStencil(t),this._state.clearStencil=t)}setStencilFunction(t,i,r){this._state.stencilFunction.func===t&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===r||(this.gl.stencilFunc(t,i,r),this._state.stencilFunction.face=Fd.FRONT_AND_BACK,this._state.stencilFunction.func=t,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=r,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(t,i,r,s){this._state.stencilFunction.face===t&&this._state.stencilFunction.func===i&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(t,i,r,s),this._state.stencilFunction.face=t,this._state.stencilFunction.func=i,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(t){this._state.stencilWriteMask!==t&&(this.gl.stencilMask(t),this._state.stencilWriteMask=t,this._stateTracker.invalidateStencilWrite())}setStencilOp(t,i,r){this._state.stencilOperation.face===Fd.FRONT_AND_BACK&&this._state.stencilOperation.fail===t&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===r||(this.gl.stencilOp(t,i,r),this._state.stencilOperation.face=Fd.FRONT_AND_BACK,this._state.stencilOperation.fail=t,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=r,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(t,i,r,s){this._state.stencilOperation.face===t&&this._state.stencilOperation.fail===i&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(t,i,r,s),this._state.stencilOperation.face=t,this._state.stencilOperation.fail=i,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(t,i=!1){const r=this._state.activeTexture;return t>=0&&(i||t!==this._state.activeTexture)&&(this.gl.activeTexture(A6+t),this._state.activeTexture=t),r}clear(t){t&&this.gl.clear(t)}clearSafe(t,i=255){t&&(t&Xi.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),t&Xi.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),t&Xi.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(i),this.gl.clear(t))}drawArrays(t,i,r){if(Ju()&&(this._numOfDrawCalls++,this._numOfTriangles+=Zae(t,r)),this.gl.drawArrays(t,i,r),Ju()){const s=die(this);s&&console.error("drawArrays:",s)}}drawElements(t,i,r,s){var n;if(Ju()&&(this._numOfDrawCalls++,this._numOfTriangles+=Zae(t,i)),this.gl.drawElements(t,i,r,s),Ju()){const o=die(this);if(o){const a=this.getBoundVAO(),l=a==null?void 0:a.indexBuffer,c=a==null?void 0:a.vertexBuffers,h={indexBuffer:l,vertexBuffers:c},p={mode:t,count:i,type:r,offset:s},f=(n=qs(l,v=>v.size))!=null?n:0,m=s+i,y=f<m?`. Buffer is too small. Attempted to draw index ${m} of ${f}`:"";console.error(`drawElements: ${o}${y}`,{args:p,vao:h})}}}logInfo(){Ju()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){Ju()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(t,i,r,s){r=Math.max(Math.round(r),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===t&&n.y===i&&n.width===r&&n.height===s||(n.x=t,n.y=i,n.width=r,n.height=s,this.gl.viewport(t,i,r,s))}getViewport(){return{x:this._state.viewport.x,y:this._state.viewport.y,width:this._state.viewport.width,height:this._state.viewport.height}}useProgram(t){var i,r;this._state.program!==t&&((i=this._state.program)==null||i.stop(),this._state.program=t,this.gl.useProgram((r=t==null?void 0:t.glName)!=null?r:null))}bindTexture(t,i,r=!1){(i>=this.parameters.maxTextureImageUnits||i<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[i];return R(t)||t.glName==null?(_(s)&&(this.setActiveTexture(i,r),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[i]=null,s):r||s!==t?(this.setActiveTexture(i,r),this.gl.bindTexture(t.descriptor.target,t.glName),t.applyChanges(),this._state.textureUnitMap[i]=t,s):(t.isDirty&&(this.setActiveTexture(i,r),t.applyChanges()),s)}unbindTexture(t){if(!R(t))for(let i=0;i<this.parameters.maxTextureImageUnits;i++)this._state.textureUnitMap[i]===t&&(this.bindTexture(null,i),this._state.textureUnitMap[i]=null)}bindFramebuffer(t,i=!1){if(i||this._state.readFramebuffer!==t||this._state.drawFramebuffer!==t){if(R(t))return this.gl.bindFramebuffer(Tn.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);t.initializeAndBind(Tn.FRAMEBUFFER),this._state.readFramebuffer=t,this._state.drawFramebuffer=t}}bindFramebufferSeparate(t,i,r=!1){const s=i===Tn.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(r||n!==t)&&(R(t)?this.gl.bindFramebuffer(i,null):t.initializeAndBind(i),s?this._state.readFramebuffer=yt(t,null):this._state.drawFramebuffer=yt(t,null))}blitFramebuffer(t,i,r=0,s=0,n=t.width,o=t.height,a=0,l=0,c=i.width,h=i.height,p=Xi.COLOR_BUFFER_BIT,f=Ke.NEAREST){this.bindFramebufferSeparate(t,Tn.READ_FRAMEBUFFER),this.bindFramebufferSeparate(i,Tn.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(r,s,n,o,a,l,c,h,p,f)}bindBuffer(t,i){if(t)switch(i!=null||(i=t.bufferType),i){case bt.ARRAY_BUFFER:this._state.vertexBuffer=xl(this.gl,t,i,this._state.vertexBuffer);break;case bt.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=xl(this.gl,t,i,this._state.indexBuffer);break;case bt.UNIFORM_BUFFER:this._state.uniformBuffer=xl(this.gl,t,i,this._state.uniformBuffer);break;case bt.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=xl(this.gl,t,i,this._state.pixelPackBuffer);break;case bt.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=xl(this.gl,t,i,this._state.pixelUnpackBuffer);break;case bt.COPY_READ_BUFFER:this._state.copyReadBuffer=xl(this.gl,t,i,this._state.copyReadBuffer);break;case bt.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=xl(this.gl,t,i,this._state.copyWriteBuffer)}}bindRenderbuffer(t){const i=this.gl;t||(i.bindRenderbuffer(i.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==t&&(i.bindRenderbuffer(i.RENDERBUFFER,t.glName),this._state.renderbuffer=t)}_getBufferBinding(t,i){if(i>=this.parameters.maxUniformBufferBindings||i<0)return console.error("Uniform buffer binding point is out of range!"),null;const r=this._state.uniformBufferBindingPoints;let s=r[i];return R(s)&&(s={buffer:null,offset:0,size:0},r[i]=s),s}bindBufferBase(t,i,r){const s=this._getBufferBinding(t,i);R(s)||s.buffer===r&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(t,i,r?r.glName:null),s.buffer=r,s.offset=0,s.size=0)}bindBufferRange(t,i,r,s,n){const o=this._getBufferBinding(t,i);if(!R(o)&&!(o.buffer===r&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(t,i,r.glName,s,n),o.buffer=r,o.offset=s,o.size=n}}bindUBO(t,i,r,s){R(i)?this.bindBufferBase(bt.UNIFORM_BUFFER,t,null):(Ju()&&(s!=null?s:i.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),i.initialize(),r!==void 0&&s!==void 0?this.bindBufferRange(bt.UNIFORM_BUFFER,t,i.buffer,r,s):this.bindBufferBase(bt.UNIFORM_BUFFER,t,i.buffer))}unbindUBO(t){for(let i=0,r=this._state.uniformBufferBindingPoints.length;i<r;i++){const s=this._state.uniformBufferBindingPoints[i];_(s)&&s.buffer===t.buffer&&this.bindBufferBase(bt.UNIFORM_BUFFER,i,null)}}unbindBuffer(t){switch(t){case bt.ARRAY_BUFFER:this._state.vertexBuffer=xl(this.gl,null,t,this._state.vertexBuffer);break;case bt.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=xl(this.gl,null,t,this._state.indexBuffer);break;case bt.UNIFORM_BUFFER:this._state.uniformBuffer=xl(this.gl,null,t,this._state.uniformBuffer);break;case bt.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=xl(this.gl,null,t,this._state.pixelPackBuffer);break;case bt.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=xl(this.gl,null,t,this._state.pixelUnpackBuffer);break;case bt.COPY_READ_BUFFER:this._state.copyReadBuffer=xl(this.gl,null,t,this._state.copyReadBuffer);break;case bt.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=xl(this.gl,null,t,this._state.copyWriteBuffer)}}bindVAO(t=null){R(t)?this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null):this._state.vertexArrayObject!==t&&(t.bind(),this._state.vertexArrayObject=t)}async clientWaitAsync(t=10){const i=this.gl,r=i.fenceSync(M7.SYNC_GPU_COMMANDS_COMPLETE,0);let s;this.instanceCounter.increment(dn.Sync,r),i.flush();do await CS(t),s=i.clientWaitSync(r,0,0);while(s===qN.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(dn.Sync,r),i.deleteSync(r),s===qN.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(t=Tn.FRAMEBUFFER){return t===Tn.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(bt.ARRAY_BUFFER),this.unbindBuffer(bt.ELEMENT_ARRAY_BUFFER),Cn(this.gl)&&(this.unbindBuffer(bt.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(bt.PIXEL_PACK_BUFFER),this.unbindBuffer(bt.PIXEL_UNPACK_BUFFER),this.unbindBuffer(bt.COPY_READ_BUFFER),this.unbindBuffer(bt.COPY_WRITE_BUFFER));for(let t=0;t<this.parameters.maxTextureImageUnits;++t)this.bindTexture(null,t);this.setBlendingEnabled(!1),this.setBlendFunction(Re.ONE,Re.ZERO),this.setBlendEquation(Sg.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(Fd.BACK),this.setFrontFace(a2.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(hr.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(hr.ALWAYS,0,0),this.setStencilOp(Jr.KEEP,Jr.KEEP,Jr.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){var r,s,n,o,a,l;const t=this.gl,i=this.capabilities.vao;i&&i.bindVertexArray(null);for(let c=0;c<this.parameters.maxVertexAttributes;c++)t.disableVertexAttribArray(c);if(this._state.vertexBuffer?t.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):t.bindBuffer(bt.ARRAY_BUFFER,null),this._state.indexBuffer?t.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):t.bindBuffer(bt.ELEMENT_ARRAY_BUFFER,null),Cn(t)){this._state.uniformBuffer?t.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):t.bindBuffer(bt.UNIFORM_BUFFER,null);for(let c=0;c<this._parameters.maxUniformBufferBindings;c++){const h=this._state.uniformBufferBindingPoints[c];if(_(h)){const{buffer:p,offset:f,size:m}=h;p!==null?f===0&&m===0?t.bindBufferBase(bt.UNIFORM_BUFFER,c,p.glName):t.bindBufferRange(bt.UNIFORM_BUFFER,c,p.glName,f,m):t.bindBufferBase(bt.UNIFORM_BUFFER,c,null)}}this._state.pixelPackBuffer?t.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):t.bindBuffer(bt.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?t.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):t.bindBuffer(bt.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?t.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):t.bindBuffer(bt.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?t.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):t.bindBuffer(bt.COPY_WRITE_BUFFER,null),t.bindFramebuffer(Tn.READ_FRAMEBUFFER,null),t.readBuffer(t.BACK),this._state.readFramebuffer&&(t.bindFramebuffer(Tn.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),t.readBuffer(Lc.COLOR_ATTACHMENT0)),t.bindFramebuffer(Tn.DRAW_FRAMEBUFFER,(s=(r=this._state.drawFramebuffer)==null?void 0:r.glName)!=null?s:null)}else this._state.readFramebuffer=this._state.drawFramebuffer,t.bindFramebuffer(Tn.FRAMEBUFFER,(o=(n=this._state.drawFramebuffer)==null?void 0:n.glName)!=null?o:null);if(i&&this._state.vertexArrayObject){const c=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(c)}t.useProgram((l=(a=this._state.program)==null?void 0:a.glName)!=null?l:null),t.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),t.bindRenderbuffer(t.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?t.enable(this.gl.BLEND):t.disable(this.gl.BLEND),t.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),t.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),t.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),t.clearDepth(this._state.clearDepth),t.clearStencil(this._state.clearStencil),t.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),t.cullFace(this._state.cullFace),t.depthFunc(this._state.depthFunction),t.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?t.enable(t.DEPTH_TEST):t.disable(t.DEPTH_TEST),t.depthMask(this._state.depthWrite),t.frontFace(this._state.frontFace),t.lineWidth(1),this._state.faceCulling===!0?t.enable(t.CULL_FACE):t.disable(t.CULL_FACE),t.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?t.enable(t.POLYGON_OFFSET_FILL):t.disable(t.POLYGON_OFFSET_FILL),t.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),t.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),t.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?t.enable(t.STENCIL_TEST):t.disable(t.STENCIL_TEST),t.stencilMask(this._state.stencilWriteMask);for(let c=0;c<this.parameters.maxTextureImageUnits;c++){t.activeTexture(A6+c),t.bindTexture(pt.TEXTURE_2D,null),t.bindTexture(pt.TEXTURE_CUBE_MAP,null),Cn(t)&&(t.bindTexture(pt.TEXTURE_3D,null),t.bindTexture(pt.TEXTURE_2D_ARRAY,null));const h=this._state.textureUnitMap[c];_(h)&&t.bindTexture(h.descriptor.target,h.glName)}t.activeTexture(A6+this._state.activeTexture),t.viewport(this._state.viewport.x,this._state.viewport.y,this._state.viewport.width,this._state.viewport.height),this.resetInfo()}_loadExtensions(){this.type===ai.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}_loadParameters(t){var a;const i=this.capabilities.textureFilterAnisotropic,r=(a=t.maxAnisotropy)!=null?a:1/0,s=Cn(this.gl),n=this.gl,o={versionString:this.gl.getParameter(this.gl.VERSION),maxVertexTextureImageUnits:this.gl.getParameter(this.gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),maxVertexAttributes:this.gl.getParameter(this.gl.MAX_VERTEX_ATTRIBS),maxMaxAnisotropy:i?Math.min(this.gl.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY),r):1,maxTextureImageUnits:this.gl.getParameter(this.gl.MAX_TEXTURE_IMAGE_UNITS),maxTextureSize:this.gl.getParameter(this.gl.MAX_TEXTURE_SIZE),maxUniformBufferBindings:s?n.getParameter(n.MAX_UNIFORM_BUFFER_BINDINGS):0,maxVertexUniformBlocks:s?n.getParameter(n.MAX_VERTEX_UNIFORM_BLOCKS):0,maxFragmentUniformBlocks:s?n.getParameter(n.MAX_FRAGMENT_UNIFORM_BLOCKS):0,maxUniformBlockSize:s?n.getParameter(n.MAX_UNIFORM_BLOCK_SIZE):0,uniformBufferOffsetAlignment:s?n.getParameter(n.UNIFORM_BUFFER_OFFSET_ALIGNMENT):1,maxArrayTextureLayers:s?n.getParameter(n.MAX_ARRAY_TEXTURE_LAYERS):1,maxSamples:s?n.getParameter(n.MAX_SAMPLES):1};return st.TEXTURE_UNIT_FOR_UPDATES=o.maxTextureImageUnits-1,o}}function xl(e,t,i,r){return t?r!==t&&e.bindBuffer(i,t.glName):e.bindBuffer(i,null),t}function Zae(e,t){switch(e){case Pt.POINTS:return 2*t;case Pt.TRIANGLES:return t/3;case Pt.TRIANGLE_STRIP:case Pt.TRIANGLE_FAN:return t-2;default:return 0}}class dgt extends hgt{constructor(t,i,r){super(t,i),this.newCache=r,this._refCount=1}dispose(){--this._refCount>0||super.dispose()}ref(){++this._refCount}bindTechnique(t,i,r,s){this.useProgram(t.program);const n=_(r)?r.slot:null;return t.bindPipelineState(this,n,s),_(i)&&_(r)&&t.bindPass(i,r),t.program}get test(){return this.programCache.test}}const ITe=me.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository");let pT=class extends Ee{constructor(e,t,i){super({}),this._stage=e,this._techniqueRepository=t,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new us,this._frameTask=e.resourceController.scheduler.registerTask(mt.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}dispose(){this._frameTask.remove(),this._stage.forEachOfType(Kd.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return R(this._textureTechnique)&&(this._textureTechnique=this._techniqueRepository.acquire(o3,new ZY)),this._textureTechnique}acquire(e){const t=this._textures.get(e);return t?(t.ref(),yt(t.loadingPromise,t)):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(t=>{const i=t.texture.frameUpdate(this._rctx,this.textureTechnique,t.previousToken);i>=0&&i!==t.previousToken&&(t.previousToken=i,e=!0)}),e&&this.events.emit("changed",Rs.BACKGROUND)}_createNewRef(e){const t=this._stage.getObject(e);if(R(t))return dt(t!==void 0),null;const i=t.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),r=new pgt(e,()=>{this._frameTask.schedule(()=>{r.isUnreferenced&&t.unload()})});return this._textures.set(e,r),r.ref(),_(t.glTexture)?(this._updateGLTexture(r,t.glTexture),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r):(this._loadingCount++,r.loadingPromise=this._stage.schedule(()=>{const s=t.load(this._rctx,()=>this.textureTechnique),n=a=>(this._loadingCount--,r.loadingPromise=null,this._updateGLTexture(r,a),t.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:t,previousToken:-1}),r),o=a=>(this._loadingCount--,r.loadingPromise=null,Gr(a)||ITe.error(a),null);return vu(s)?s.then(n,o):n(s)}),r.loadingPromise)}_updateGLTexture(e,t){e.glTexture=t,this.events.emit("changed",Rs.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],pT.prototype,"_loadingCount",void 0),u([d()],pT.prototype,"_frameTask",void 0),u([d()],pT.prototype,"updating",null),pT=u([P("esri.views.3d.webgl-engine.lib.TextureRepository")],pT);class pgt{constructor(t,i){this.id=t,this._release=i,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(ITe.error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}}const fgt=me.getLogger("esri.views.3d.webgl-engine.materials.internal.waterMaterialUtils");let GA=class extends Ee{constructor(){super(...arguments),this._data=new Array,this._state=kl.NOT_LOADED}dispose(){this._state=kl.NOT_LOADED,this._data.forEach(e=>e.dispose()),this._data.length=0}get updating(){return this._state===kl.LOADING}get resourceState(){return this._state}loadTextures(e){const t=[Mi("esri/images/materials/water/normals.jpg"),Mi("esri/images/materials/water/perturbation.jpg")];this._state=kl.LOADING,Promise.all(t.map(i=>Qd(i))).then(i=>{i.forEach(r=>this._data.push(new st(e,{target:pt.TEXTURE_2D,pixelFormat:ze.RGBA,dataType:St.UNSIGNED_BYTE,wrapMode:_t.REPEAT,samplingMode:Ke.LINEAR_MIPMAP_LINEAR,hasMipmap:!0,maxAnisotropy:8,width:r.width,height:r.height},r))),this._state=kl.LOADED}).catch(i=>{fgt.error("Failed to load textures for water material.",i),this._state=kl.NOT_LOADED})}bind(e){this._state===kl.LOADED&&(e.bindTexture("texWaveNormal",this._data[0]),e.bindTexture("texWavePerturbation",this._data[1]))}};u([d()],GA.prototype,"_state",void 0),u([d({type:Boolean,readOnly:!0})],GA.prototype,"updating",null),GA=u([P("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],GA);class mgt extends j5{constructor(t,i,r,s,n,o){super(),this._rctx=t,this._renderScene=i,this._requestRenderScene=r,this._renderOverlay=s,this._forceCameraHook=n,this._disposeOffscreenBuffers=o,this.supersample=!0,this._screenshotQueue=new Array}dispose(){this._rctx=null}takeScreenshot(t){this._requestRenderScene(Rs.BACKGROUND);const i=Wd();return this._screenshotQueue.push({settings:t,resolver:i}),i.promise}update(t){for(const i of this._screenshotQueue){if(this.isDisposed){i.resolver.reject();continue}const r=ve(F({},i.settings),{pixelRatio:i.settings.pixelRatio*t.viewCamera.pixelRatio}),s=this._renderScreenshot(t,r);i.resolver(s)}this._screenshotQueue.length=0}_renderScreenshotOverlay(t,i,r){if(R(this._renderOverlay))return i;t.width=i.width,t.height=i.height;const s=t.getContext("2d"),n=r.pixelRatio;return s.save(),s.translate(0,i.height),s.scale(1,-1),r.region&&s.translate(-r.region.x,-r.region.y),s.scale(n,n),i=this._renderOverlay(t,i),s.restore(),i}_readbackScreenshot(t,i){return t.resample?this._readbackScreenshotResampled(t,i):this._readbackScreenshotImmediate(t,i)}_readbackScreenshotResampled(t,i){const{framebufferWidth:r,framebufferHeight:s,region:n,resample:o}=t,a=this._ensureScreenshotEncodeCanvas();let l=kz(r,s,a);this._rctx.gl.readPixels(0,0,r,s,ze.RGBA,ht.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),i(),l=this._renderScreenshotOverlay(a,l,ve(F({},t),{region:null}));const c=kz(n.width,n.height,a);return yit(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(t,i){const{framebufferHeight:r,region:s}=t,n=this._ensureScreenshotEncodeCanvas(),o=kz(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,r-(s.y+s.height),s.width,s.height,ze.RGBA,ht.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),i(),this._renderScreenshotOverlay(n,o,t)}_renderScreenshot(t,i){let r=null;const s=t.viewCamera,{framebufferWidth:n,framebufferHeight:o}=i;let a=!1;const l=i.disableDecorations&&t.frameHasDecorations,c=n!==s.fullWidth||o!==s.fullHeight,h=i.ignorePadding&&s.pixelRatio!==i.pixelRatio,p=c||l||h;if(p){const y=s.clone();if(i.ignorePadding){const b=M4(y.padding);for(let S=0;S<4;S++)b[S]=Math.round(b[S]/y.pixelRatio*i.pixelRatio);y.padding=b}y.fullWidth=n,y.fullHeight=o,y.pixelRatio=i.pixelRatio;const v=s.fovX-y.fovX,w=s.fovY-y.fovY;v<0&&v<w?y.fovX=s.fovX:w<0&&w<v&&(y.fovY=s.fovY),this._forceCameraHook(y),a=!0,r=new xr(this._rctx,{width:y.fullWidth,height:y.fullHeight,colorTarget:Zr.TEXTURE,depthStencilTarget:xi.DEPTH_STENCIL_RENDER_BUFFER}),this._renderScene(r,y,i.disableDecorations?Vb.OFF:Vb.ON),this._disposeOffscreenBuffers()}const f=()=>{this._rctx.bindFramebuffer(null),Ye(r)},m=this._readbackScreenshot(i,f);if(f(),p&&!this._rctx.contextAttributes.alpha)for(let y=3;y<m.data.length;y+=4)m.data[y]=255;return a&&this._forceCameraHook(s),m}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}}const Qae=me.getLogger("esri.views.3d.webgl-engine.parts.View");let mo=class extends G5(Ee){constructor(e){super({}),this.events=new us,this.waterTextureRepository=new GA,this._magnifierHelper=new dT,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=e.container,this._viewingMode=e.viewingMode,this._initializeContext(e),ae(()=>{var t;return(t=this.waterTextureRepository)==null?void 0:t.updating},()=>this.requestRender(),Ft),this._magnifierHelper.events.on("request-render",()=>this.requestRender()),this._stippleTextureRepository=new Ube(this._rctx),this._shaderTechniqueRepository=new abe({rctx:this._rctx,viewingMode:e.viewingMode,stippleTextureRepository:this._stippleTextureRepository,waterTextureRepository:this.waterTextureRepository}),this._textureRepository=new pT(e,this._shaderTechniqueRepository,this._rctx),this._textureRepository.events.on("changed",t=>this.requestRender(t)),this._materialRepository=new lbe(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new Rpt(this._rctx,this._shaderTechniqueRepository),this._renderer=new $m(this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,t=>this.requestRender(t),(t,i)=>e.schedule(t,i),e),this._screenshotManager=new mgt(this._rctx,(t,i,r)=>this._renderer.render(t,i,i,r),t=>this.requestRender(t),e.options.screenshot.renderOverlay,t=>this.events.emit("force-camera-for-screenshot",t),()=>this._renderer.disposeOffscreenBuffers()),this._registerFrameTask(e)}normalizeCtorArgs(){return{}}dispose(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Ds(this._frameTask),this._shaderTechniqueRepository=Ye(this._shaderTechniqueRepository),super.dispose(),this._tmpDepthBuffer=null,this._rctx=null}get performanceInfo(){const e=this._rctx.gl;return{renderer:this._renderer.performanceInfo,textureMemory:e.getUsedTextureMemory!==void 0?e.getUsedTextureMemory():void 0,renderbufferMemory:e.getUsedRenderbufferMemory!==void 0?e.getUsedRenderbufferMemory():void 0,VBOMemory:e.getUsedVBOMemory!==void 0?e.getUsedVBOMemory():void 0}}requestRender(e=Rs.UPDATE){e===Rs.UPDATE?this._needsUpdate=!0:this._needsRender=!0}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this._renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}ensureEdgeView(){return this._renderer.ensureEdgeView()}get edgeView(){return this._renderer.edgeView}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(e){this._magnifierHelper.magnifier=e}updateLightSources(e,t,i){this._renderer.updateLightSources(e,t,i),this.requestRender()}setRenderParameters(e){e.idleSuspend!==void 0&&this._idleSuspend!==!!e.idleSuspend&&(this._idleSuspend=!!e.idleSuspend,this.requestRender()),this._renderer.setRenderParameters(e)}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}modify(e){this._renderer.modify(e),e.clear()}get canvas(){return this._canvas}takeScreenshot(e){return this._screenshotManager.takeScreenshot(e)}getAlpha(){return this._rctx.contextAttributes.alpha}get shadowsEnabled(){return this._renderer.shadowsEnabled}readAccumulatedShadow(e){return this._renderer.readAccumulatedShadow(e[0],e[1])}readHUDVisibility(e,t,i,r,s){this._renderer.readHUDVisibility(e,t,i,r,s)}getMinimalDepthForArea(e,t,i,r,s,n=s){const o=r.constrainWindowSize(t,i,s*r.pixelRatio,n*r.pixelRatio),a=this._ensureDepthBuffer(o);this._renderer.readDepthPixels(r,o,a);let l=Number.MAX_VALUE;for(let c=0;c<o[2]*o[3];c++){const h=$pt(4*c,a,r.nearFar);l>h&&h!==r.nearFar[0]&&h!==r.nearFar[1]&&(l=h)}if(_(e)){const c=e.pickDepth(t*r.pixelRatio,i*r.pixelRatio,r);_(c)&&l>c&&c!==r.nearFar[0]&&c!==r.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(e){const t=4*e[2]*e[3];return(R(this._tmpDepthBuffer)||this._tmpDepthBuffer.byteLength<t)&&(this._tmpDepthBuffer=new Uint8Array(t)),this._tmpDepthBuffer}get renderPlugins(){return this._renderer.renderPlugins}get test(){return{renderer:this._renderer}}get gpuMemoryUsage(){return this._renderer.gpuMemoryUsage}async reloadShaders(){hxe(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}get animationTimestep(){return this._renderer.animationTimestep}_registerFrameTask(e){const t=e.state,i={viewCamera:t.camera,frameHasDecorations:!1};let r=!1,s=Rs.BACKGROUND,n=!1;const o={preRender:a=>{r=this.updating,s=this._needsUpdate?Rs.UPDATE:Rs.BACKGROUND,e.processSyncLayers();const l=a.time-this._lastAnimationUpdate;(l>this.animationTimestep||_(this.forcedAnimationTime)||r||this._needsRender)&&(this._renderer.updateAnimation({camera:t.camera,dt:l,forcedTime:this.forcedAnimationTime})&&this.requestRender(Rs.BACKGROUND),this._lastAnimationUpdate=a.time)},render:()=>{if((this._needsUpdate||this._needsRender||!this._idleSuspend||!this._renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&t.camera.fullWidth>0&&t.camera.fullHeight>0){const a=this._needsUpdate&&this._idleSuspend&&this._renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this._renderer.render(null,t.camera,t.contentCamera,Vb.ON),n=!0,a&&this._renderer.hasWaterReflection&&(this.requestRender(Rs.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:()=>{i.viewCamera=t.camera,i.frameHasDecorations=this._renderer.hasSlicePlane||this._magnifierHelper.enabled,this._textureRepository.update(),this._screenshotManager.update(i)},finish:()=>{n&&(this._renderer.finish(s),n=!1)}};this._frameTask=Eb(o)}_initializeContext(e){var s;const t=e.options;this._canvas=t.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const i={alpha:t.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:t.stencil==null||t.stencil,powerPreference:"high-performance",preserveDrawingBuffer:(s=t.preserveDrawingBuffer)!=null?s:!1},r=WGe("3d",this._canvas,i);if(R(r)){const n=he("esri-force-webgl");Qae.error(n)}else this._rctx=this._newRenderingContext(r,e),this._loadShaderOnlyExtensions(),!t.alpha&&this._rctx.contextAttributes.alpha&&Qae.error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&he("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)}_newRenderingContext(e,t){const i={disabledExtensions:t.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:t.options.debugWebGLExtensions||{},maxAnisotropy:8},r=(s,n)=>t.resourceController.memoryController.newCache(s,n);return new dgt(e,i,r)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("standardDerivatives"),this._rctx.capabilities.enable("shaderTextureLOD"),this._rctx.capabilities.enable("textureFloat")}get componentObjectCollection(){return R(this._componentObjectCollection)&&(this._componentObjectCollection=new Spt(this._renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(e){this._componentObjectCollection=e}};u([d({type:Boolean,readOnly:!0})],mo.prototype,"updating",null),u([go()],mo.prototype,"_rctx",void 0),u([go()],mo.prototype,"_container",void 0),u([go()],mo.prototype,"_canvas",void 0),u([go()],mo.prototype,"_stippleTextureRepository",void 0),u([go(),d()],mo.prototype,"waterTextureRepository",void 0),u([go(),d()],mo.prototype,"_magnifierHelper",void 0),u([go(),d()],mo.prototype,"_textureRepository",void 0),u([go()],mo.prototype,"_compositingHelper",void 0),u([go()],mo.prototype,"_renderer",void 0),u([go()],mo.prototype,"_screenshotManager",void 0),u([go()],mo.prototype,"componentObjectCollection",null),u([go()],mo.prototype,"_componentObjectCollection",void 0),u([d()],mo.prototype,"_needsUpdate",void 0),u([d()],mo.prototype,"_needsWaterReflectionUpdate",void 0),mo=u([P("esri.views.3d.webgl-engine.parts.RenderView")],mo);var xL;let Ha=xL=class extends G5(Ee){constructor(e){super(e),this._handles=new qt,this._model=new mL,this._layers=new Bt,this._changeSet=new wbe,this._layerSyncSet=new Set}initialize(){this._set("renderView",new mo(this)),this._frameTask=this.resourceController.scheduler.registerTask(mt.STAGE,this),this._handles.add(this._frameTask)}destroy(){Kb.pool.prune(0),this._handles.destroy(),this.dispose()}get viewingMode(){return this.state.viewingMode}get updating(){return this._model.dirtySet.dirty||this.renderView.updating||this._frameTask.updating}add(e){this._model.add(e),bF(e)&&(e.attachStage(this),this._addLayer(e)),this.renderView.requestRender()}remove(e){R(e)||(this.renderView.requestRender(),this._model.remove(e),bF(e)&&(this._removeLayer(e),e.detachStage()))}addMany(e){_(e)&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){_(e)&&(this._model.removeMany(e),this.renderView.requestRender())}async load(e){R(e)||(Array.isArray(e)||(e=[e]),await Promise.all(e.filter(t=>R(t.glTexture)).map(t=>this.schedule(()=>this._model.has(t)?t.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique):null))))}loadImmediate(e){return e.load(this.renderView.renderingContext,()=>this.renderView.textureRepository.textureTechnique)}forEachOfType(e,t){this._model.forEachOfType(e,t)}handleEvent(e,t){this.destroyed||(this._model.dirtySet[e](t),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty}runTask(e){this._frameTask.processQueue(e),e.done||this._commit()}_commit(){const e=this._model.dirtySet;xL.DebugSettings.logDirtySet&&console.log("Dirty set: "+e.formatDebugInfo()),e.commit(this._changeSet),xL.DebugSettings.logDirtySet&&(console.log("RGs add: "+this._changeSet.adds.map(t=>t.id)),console.log("RGs remove: "+this._changeSet.removes.map(t=>t.id))),this._layerSyncSet.clear(),this.renderView.modify(this._changeSet),this.renderView.requestRender()}schedule(e,t){return this._frameTask.schedule(e,t)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}processSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(t=>{(this._layerSyncSet.has(t.id)||t.updatePolicy===l2.SYNC)&&(e.commitLayer(t.id,this._changeSet),this._layerSyncSet.delete(t.id))});for(const t of this._layerSyncSet)e.commitLayer(t,this._changeSet);this._layerSyncSet.clear(),this.renderView.modify(this._changeSet)}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commit(),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._changeSet.removes),this.renderView.modify(this._changeSet))}addRenderPlugin(e,t,i){const r=this.renderView.renderPlugins.add(e,t,i),s=()=>{eoe(t)&&this.sceneIntersectionHelper.addIntersectionHandler(t)};if(vu(r))return r.then(s);s()}removeRenderPlugin(e){eoe(e)&&this.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderView.renderPlugins.remove(e)}get performanceInfo(){return{renderView:this.renderView.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:t=>e._model.test.content.filter(i=>i.type===t).length,model:e._model}}};Ha.DebugSettings={endFrameContentValidation:!1,logDirtySet:!1},u([d({constructOnly:!0})],Ha.prototype,"resourceController",void 0),u([d({constructOnly:!0})],Ha.prototype,"options",void 0),u([d({constructOnly:!0})],Ha.prototype,"state",void 0),u([d({constructOnly:!0})],Ha.prototype,"sceneIntersectionHelper",void 0),u([d({readOnly:!0})],Ha.prototype,"viewingMode",null),u([d({constructOnly:!0})],Ha.prototype,"container",void 0),u([d({constructOnly:!0})],Ha.prototype,"renderSR",void 0),u([d({constructOnly:!0})],Ha.prototype,"_handles",void 0),u([d({readOnly:!0})],Ha.prototype,"updating",null),u([d({constructOnly:!0})],Ha.prototype,"_model",void 0),u([go(),d()],Ha.prototype,"renderView",void 0),Ha=xL=u([P("esri.views.3d.webgl-engine.Stage")],Ha);function $Te(e){return Bf(e)&&e.intersector===Dr.PCL&&!!e.target}function UU(e){return Bf(e)&&e.intersector===Dr.I3S&&!!e.target}function ggt(e){return Bf(e)&&e.intersector===Dr.TERRAIN&&!!e.target}function DTe(e){return Bf(e)&&e.intersector===Dr.OVERLAY&&!!e.target}function BZ(e){return Bf(e)&&e.intersector===Dr.LOD&&!!e.target}function Jae(e,t){var i;return b5(e)||w5(e)?uO(e.target.object.metadata,t):ggt(e)?(i=t.map)==null?void 0:i.ground:$Te(e)||UU(e)||DTe(e)?uO(e.target,t):null}function dbt(e,t){const i=Hj(e,t);return _(i)&&i.type==="graphic"?i.graphic:null}function Hj(e,t){if(R(e))return null;if(b5(e)||w5(e))return Kae(e.target.object.metadata,t);if($Te(e)){const i=e.target.createGraphic();return{type:"graphic",graphic:i,layer:i.layer}}return DTe(e)||BZ(e)?Kae(e.target,t):UU(e)?ygt(e.target,t):null}function Kae(e,t){if(R(e)||R(e.graphicUid))return null;const i=uO(e,t);if(R(i))return null;if(i===t.graphics)return R(t.graphicsView)||typeof e.graphicUid!="number"?null:t.graphicsView.getHit(e.graphicUid);const r=t.allLayerViews.find(s=>s.layer===i);return!r||r.suspended||R(e.graphicUid)?null:"getHit"in r?r.getHit(e.graphicUid):null}function ygt(e,t){const i=uO(e,t);if(R(i))return null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getGraphicFromIntersectorTarget"in r?_gt(r.getGraphicFromIntersectorTarget(e)):null}function vgt(e,t){const i=uO(e,t);if(R(i))return null;const r=t.allLayerViews.find(s=>s.layer===i);return r&&!r.suspended&&"getAABBFromIntersectorTarget"in r?r.getAABBFromIntersectorTarget(e):null}function _gt(e){return _(e)?{type:"graphic",graphic:e,layer:e.layer}:null}function uO(e,t){return R(e.layerUid)?null:_(t.graphicsView)&&e.layerUid===t.graphicsView.processor.layer.id?t.graphics:t.map.findLayerByUid(e.layerUid)}function pbt(e,t){if(b5(e)||w5(e))return sg(e.target.object.boundingVolumeWorldSpace.bounds);if(BZ(e)){_de(w$,e.transformation);const i=Math.max(w$[0],w$[1],w$[2]);return e.target.baseBoundingSphere.radius*i}return UU(e)?qs(vgt(e.target,t),i=>.5*she(i)):null}function fbt(e){return!b5(e)&&!w5(e)&&(BZ(e)?e.target.numLodLevels>1:!!UU(e))}const w$=O();async function bgt(e,t){if(e.type==="2d")return e.hitTest(t);const i=await e.hitTest(t);if(i.results.length===0)return i;const r=i.results[0],s=_(r.distance)?r.distance*(1+wgt):r.distance,n=i.results.findIndex(o=>o.distance>s);return n!==-1&&(i.results=i.results.slice(0,n)),i}const wgt=.05;let VV,BV;function xgt(e){const t=H0e(e);for(;t.length>1;){const i=ele(t.shift());if(i.available)return i}return ele(t.shift())}function ele(e){switch(e){case ai.WEBGL1:return Tgt();case ai.WEBGL2:return Sgt()}}function Tgt(){return VV||(VV=Agt()),VV}function Sgt(){return BV||(BV=Rgt()),BV}class LTe{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1,this.supportsTextureHalfFloat=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1}}class Egt extends LTe{constructor(){super(...arguments),this.type=ai.WEBGL1}}class Cgt extends LTe{constructor(){super(...arguments),this.type=ai.WEBGL2,this.supportsElementIndexUint=!0,this.supportsStandardDerivatives=!0,this.supportsInstancedArrays=!0,this.supportsTextureFloat=!0,this.supportsTextureHalfFloat=!0}}function NTe(e,t){var n;if(e===ai.WEBGL1&&typeof WebGLRenderingContext===void 0||e===ai.WEBGL2&&typeof WebGL2RenderingContext===void 0)return null;const i=document.createElement("canvas");if(!i)return null;let r=WN(i,e,{failIfMajorPerformanceCaveat:!0});if(R(r)&&(r=WN(i,e),_(r)&&(t.majorPerformanceCaveat=!0)),R(r))return r;if(e===ai.WEBGL1){const o=(n=r.getParameter(r.VERSION))==null?void 0:n.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);t.available=a>=.94}}else t.available=!0;t.maxTextureSize=r.getParameter(r.MAX_TEXTURE_SIZE),t.supportsVertexShaderSamplers=r.getParameter(r.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=r.getShaderPrecisionFormat(r.FRAGMENT_SHADER,r.HIGH_FLOAT);return s&&(t.supportsHighPrecisionFragment=s.precision>0),r}function Agt(){const e=new Egt,t=NTe(ai.WEBGL1,e);return R(t)||(e.supportsElementIndexUint=t.getExtension("OES_element_index_uint")!==null,e.supportsStandardDerivatives=t.getExtension("OES_standard_derivatives")!==null,e.supportsInstancedArrays=t.getExtension("ANGLE_instanced_arrays")!==null,e.supportsTextureFloat=t.getExtension("OES_texture_float")!==null,e.supportsTextureHalfFloat=t.getExtension("OES_texture_half_float")!==null,e.supportsColorBufferFloat=t.getExtension("WEBGL_color_buffer_float")!==null,e.supportsColorBufferFloatBlend=t.getExtension("EXT_float_blend")!==null,e.supportsColorBufferHalfFloat=t.getExtension("EXT_color_buffer_half_float")!==null),e}function Rgt(){const e=new Cgt,t=NTe(ai.WEBGL2,e);return R(t)||(e.supportsColorBufferFloat=t.getExtension("EXT_color_buffer_float")!==null,e.supportsColorBufferFloatBlend=t.getExtension("EXT_float_blend")!==null,e.supportsColorBufferHalfFloat=e.supportsColorBufferFloat||t.getExtension("EXT_color_buffer_half_float")!==null),e}function Mgt(e){const t=xgt(e);if(!t.available)return new q("webgl:required","WebGL is required but not supported.");if(e==="3d"&&t.majorPerformanceCaveat)return new q("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!t.supportsHighPrecisionFragment)return new q("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!t.supportsVertexShaderSamplers)return new q("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(t.type===ai.WEBGL1){if(!t.supportsElementIndexUint)return new q("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!t.supportsStandardDerivatives)return new q("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!t.supportsInstancedArrays)return new q("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function Ogt(e){return e&&"nodeType"in e}function Pgt(e){return e&&typeof e.render=="function"}const tle={component:"esri-component"};let x1=class extends Ee{constructor(){super(...arguments),this.widget=null}destroy(){this.widget&&this.widget.destroy(),this.node=null}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const t=this._get("node");e!==t&&(e&&e.classList.add(tle.component),t&&t.classList.remove(tle.component),this._set("node",e))}castNode(e){return e?typeof e=="string"||Ogt(e)?(this._set("widget",null),x4(e)):(Pgt(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],x1.prototype,"id",null),u([d()],x1.prototype,"node",null),u([Ot("node")],x1.prototype,"castNode",null),u([d({readOnly:!0})],x1.prototype,"widget",void 0),x1=u([P("esri.views.ui.Component")],x1);const TL=x1,Igt={left:0,top:0,bottom:0,right:0},FTe={bottom:30,top:15,right:15,left:15},GV="manual",Ua={ui:"esri-ui",corner:"esri-ui-corner",innerContainer:"esri-ui-inner-container",manualContainer:"esri-ui-manual-container",cornerContainer:"esri-ui-corner-container",topLeft:"esri-ui-top-left",topRight:"esri-ui-top-right",bottomLeft:"esri-ui-bottom-left",bottomRight:"esri-ui-bottom-right"};function $gt(e){return e&&!e._started&&typeof e.postMixInProperties=="function"&&typeof e.buildRendering=="function"&&typeof e.postCreate=="function"&&typeof e.startup=="function"}function jV(e){const t=e,i=typeof t=="object"&&t!==null&&Object.getPrototypeOf(t);return(i===null||i===Object.prototype)&&("component"in t||"index"in t||"position"in t)?e:null}function HV(e,{top:t,bottom:i,left:r,right:s}){e.style.top=t,e.style.bottom=i,e.style.left=r,e.style.right=s}let Dm=class extends us.EventedAccessor{constructor(e){super(e),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentToKey=new Map,this._handles=new qt,this.view=null,this._applyViewPadding=()=>{const t=this.container;t&&HV(t,this._toPxPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const t=this._innerContainer;t&&HV(t,this._toPxPosition(this.padding))},this._initContainers()}initialize(){this._handles.add([ae(()=>{var e;return[(e=this.view)==null?void 0:e.padding,this.container]},this._applyViewPadding,Ft),ae(()=>this.padding,this._applyUIPadding,Ft)])}destroy(){this.container=null;for(const e of this._components)e.destroy();this._components.length=0,this._handles.destroy(),this._componentToKey.clear()}set container(e){const t=this._get("container");e!==t&&(e&&(e.classList.add(Ua.ui),zLe(e),this._attachContainers(e)),t&&(t.classList.remove(Ua.ui),HV(t,{top:"",bottom:"",left:"",right:""}),Qhe(t)),this._set("container",e))}get height(){const e=this.get("view.height")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.top+t.bottom;return Math.max(e-i,0)}get padding(){return this._get("padding")}set padding(e){e?this._override("padding",e):this._clearOverride("padding")}castPadding(e){return typeof e=="number"?{bottom:e,top:e,right:e,left:e}:F(F({},FTe),e)}get width(){const e=this.get("view.width")||0;if(e===0)return e;const t=this._getViewPadding(),i=t.left+t.right;return Math.max(e-i,0)}add(e,t){let i,r;if(Array.isArray(e))return void e.forEach(n=>this.add(n,t));const s=jV(e);s&&({index:i,position:t,component:e,key:r}=s),t&&typeof t=="object"&&({index:i,key:r,position:t}=t),!e||t&&!this._isValidPosition(t)||this._add(e,t,i,r)}remove(e,t){if(!e)return;if(Array.isArray(e))return e.map(r=>this.remove(r,t));const i=this._find(e);if(i){const r=this._componentToKey;if(r.has(e)&&r.get(e)!==t)return;const s=this._components.indexOf(i);return i.node.parentNode&&i.node.parentNode.removeChild(i.node),this._componentToKey.delete(e),this._components.splice(s,1)[0]}}empty(e){return Array.isArray(e)?e.map(t=>this.empty(t)).reduce((t,i)=>t.concat(i)):(e=e||GV)===GV?Array.prototype.slice.call(this._manualContainer.children).filter(t=>!t.classList.contains(Ua.corner)).map(t=>this.remove(t)):this._isValidPosition(e)?Array.prototype.slice.call(this._cornerNameToContainerLookup[e].children).map(this.remove,this):null}move(e,t){if(Array.isArray(e)&&e.forEach(n=>this.move(n,t)),!e)return;let i;const r=jV(e)||jV(t);if(r&&(i=r.index,t=r.position,e=r.component||e),t&&!this._isValidPosition(t))return;const s=this.remove(e);s&&this.add(s,{position:t,index:i})}find(e){if(!e)return null;const t=this._findById(e);return t&&(t.widget||t.node)}getPosition(e){for(const t in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[t].contains(e))return t;return null}_add(e,t,i,r){e instanceof TL||(e=new TL({node:e})),this._place({component:e,position:t,index:i}),this._components.push(e),r&&this._componentToKey.set(e,r)}_find(e){return e?e instanceof TL?this._findByComponent(e):typeof e=="string"?this._findById(e):this._findByNode(e.domNode||e):null}_getViewPadding(){return this.get("view.padding")||Igt}_attachContainers(e){e.appendChild(this._innerContainer),e.appendChild(this._manualContainer)}_initContainers(){const e=document.createElement("div");e.classList.add(Ua.innerContainer),e.classList.add(Ua.cornerContainer);const t=document.createElement("div");t.classList.add(Ua.innerContainer),t.classList.add(Ua.manualContainer);const i=document.createElement("div");i.classList.add(Ua.topLeft),i.classList.add(Ua.corner),e.appendChild(i);const r=document.createElement("div");r.classList.add(Ua.topRight),r.classList.add(Ua.corner),e.appendChild(r);const s=document.createElement("div");s.classList.add(Ua.bottomLeft),s.classList.add(Ua.corner),e.appendChild(s);const n=document.createElement("div");n.classList.add(Ua.bottomRight),n.classList.add(Ua.corner),e.appendChild(n),this._innerContainer=e,this._manualContainer=t;const o=B0();this._cornerNameToContainerLookup={"top-left":i,"top-right":r,"bottom-left":s,"bottom-right":n,"top-leading":o?r:i,"top-trailing":o?i:r,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup=F({manual:t},this._cornerNameToContainerLookup)}_isValidPosition(e){return!!this._positionNameToContainerLookup[e]}_place(e){const t=e.component,i=e.position||GV,r=e.index,s=this._positionNameToContainerLookup[i],n=r>-1;if($gt(t.widget)&&t.widget.startup(),!n)return void s.appendChild(t.node);const o=Array.prototype.slice.call(s.children);if(r===0)return void(s.firstChild?ZQ(t.node,s.firstChild):s.appendChild(t.node));r>=o.length?s.appendChild(t.node):ZQ(t.node,o[r])}_toPxPosition(e){return{top:this._toPxUnit(e.top),left:this._toPxUnit(e.left),right:this._toPxUnit(e.right),bottom:this._toPxUnit(e.bottom)}}_toPxUnit(e){return e===0?"0":e+"px"}_findByComponent(e){let t,i=null;return this._components.some(r=>(t=r===e,t&&(i=r),t)),i}_findById(e){let t,i=null;return this._components.some(r=>(t=r.id===e,t&&(i=r),t)),i}_findByNode(e){let t,i=null;return this._components.some(r=>(t=r.node===e,t&&(i=r),t)),i}};u([d()],Dm.prototype,"container",null),u([d()],Dm.prototype,"height",null),u([d({value:FTe})],Dm.prototype,"padding",null),u([Ot("padding")],Dm.prototype,"castPadding",null),u([d()],Dm.prototype,"view",void 0),u([d()],Dm.prototype,"width",null),Dm=u([P("esri.views.ui.UI")],Dm);const Dgt=Dm;function ile(e,t){return e&&"copyright"in e&&(!t||typeof e.originOf=="function"&&e.originOf("copyright")==="user")}function Lgt(e,t){return e.length!==t.length||e.some((i,r)=>i.text!==t[r].text)}function x$(e,t,i){!i||!t||e.find(r=>r.layerView===t&&r.text===i)||e.push({text:i,layerView:t})}function Ngt(e){return e.type==="bing-maps"}const Ry=[];let fT=class extends kS{constructor(e){super(e),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new at,this.view=null,this._allLayerViewsChange=t=>{this.handles.remove("suspension");const i=this.get("view.allLayerViews");i&&this.handles.add(i.map(r=>ae(()=>{var s;return[r.suspended,(s=r.layer)==null?void 0:s.attributionVisible]},()=>this._updateAttributionItems())),"suspension"),t&&t.removed&&t.removed.forEach(r=>{this._pendingAttributions.delete(r),this._fetchedAttributionData.delete(r)}),this._updateAttributionItems()},this.handles.add([eo(()=>{var t;return(t=this.view)==null?void 0:t.allLayerViews},"change",t=>this._allLayerViewsChange(t),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),cl(()=>{var t;return((t=this.view)==null?void 0:t.stationary)===!0},()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const e=this.get("view.allLayerViews");Ry.length=0,e?(e.forEach(t=>{var s;if(t.suspended||!((s=t.layer)==null?void 0:s.attributionVisible))return;const i=t.layer;if(ile(i,"user"))return void x$(Ry,t,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(t)){const n=this._fetchedAttributionData.get(t);return void(n?x$(Ry,t,this._getDynamicAttribution(n,this.view,i)):ile(i)&&x$(Ry,t,i.copyright))}return void this._fetchAttributionData(t)}const r=i.get("portalItem.accessInformation");x$(Ry,t,r||i.copyright)}),Lgt(this.items,Ry)&&(this.items.removeAll(),this.items.addMany(Ry)),Ry.length=0,this.notifyChange("state")):this._clear()}async _fetchAttributionData(e){if(this._pendingAttributions.has(e))return;this._pendingAttributions.add(e);const t=await nc(e.layer.fetchAttributionData());if(this._pendingAttributions.has(e)){const i=t.ok?this._createContributionIndex(t.value,Ngt(e.layer)):null;this._pendingAttributions.delete(e),this._fetchedAttributionData.set(e,i)}this._updateAttributionItems()}_createContributionIndex(e,t){const i=e.contributors,r={};if(!i)return r;for(let s=0;s<i.length;s++){const n=i[s],o=n.coverageAreas;if(!o)return;for(const a of o){const l=a.bbox,c=a.zoomMin-(t&&a.zoomMin?1:0),h=a.zoomMax-(t&&a.zoomMax?1:0),p={xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:Xe.WGS84},f={extent:rg(p),attribution:n.attribution||"",score:a.score!=null?a.score:100,id:s};for(let m=c;m<=h;m++)r[m]=r[m]||[],r[m].push(f)}}return r.maxKey=Math.max.apply(null,Object.keys(r)),r}_getDynamicAttribution(e,t,i){const{extent:r,scale:s}=t;let n=i.tileInfo.scaleToZoom(s);if(n=Math.min(e.maxKey,Math.round(n)),!r||n==null||n<=-1)return"";const o=e[n],a=aw(r.center.clone().normalize(),t.spatialReference),l={};return o?o.filter(c=>{const h=!l[c.id]&&a&&zH(c.extent,a);return h&&(l[c.id]=!0),h}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:at})],fT.prototype,"items",void 0),u([d({readOnly:!0})],fT.prototype,"state",null),u([d()],fT.prototype,"view",void 0),fT=u([P("esri.widgets.Attribution.AttributionViewModel")],fT);const UTe=fT,My={base:"esri-attribution esri-widget",poweredBy:"esri-attribution__powered-by",sources:"esri-attribution__sources",open:"esri-attribution--open",sourcesOpen:"esri-attribution__sources--open",link:"esri-attribution__link",widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let qa=class extends ml{constructor(e,t){super(e,t),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(i=>i.forEach(({target:r})=>this._checkSourceTextOverflow(r))),this.iconClass=My.widgetIcon,this.itemDelimiter=" | ",this.label=void 0,this.messages=null,this.view=null,this.viewModel=new UTe}initialize(){this.own(eo(()=>{var e;return(e=this.viewModel)==null?void 0:e.items},"change",()=>this.scheduleRender()))}destroy(){var e;(e=this._resizeObserver)==null||e.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,t)=>(e.includes(t.text)||e.push(t.text),e),[]).join(this.itemDelimiter)}render(){const e={[My.open]:this._isOpen};return ue("div",{bind:this,class:this.classes(My.base,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return ue("div",{class:My.poweredBy},"Powered by"," ",ue("a",{class:My.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,t=this._isInteractive,i=t?"0":"",{attributionText:r}=this,s={[My.sourcesOpen]:e,[My.interactive]:t};return ue("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(My.sources,s),innerHTML:r,tabindex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let t=!1;const{clientHeight:i,clientWidth:r,scrollWidth:s}=e,n=s>r,o=this._attributionTextOverflowed!==n;if(this._attributionTextOverflowed=n,o&&(t=!0),this._isOpen){const a=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,a&&(this._isOpen=!1,t=!0)}t&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],qa.prototype,"_isOpen",void 0),u([d()],qa.prototype,"_isInteractive",null),u([d()],qa.prototype,"_attributionTextOverflowed",void 0),u([d()],qa.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],qa.prototype,"attributionText",null),u([d()],qa.prototype,"iconClass",void 0),u([d()],qa.prototype,"itemDelimiter",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],qa.prototype,"label",void 0),u([d(),Ql("esri/widgets/Attribution/t9n/Attribution")],qa.prototype,"messages",void 0),u([wt("viewModel.view")],qa.prototype,"view",void 0),u([d({type:UTe})],qa.prototype,"viewModel",void 0),u([Zu()],qa.prototype,"_toggleState",null),qa=u([P("esri.widgets.Attribution")],qa);const Fgt=qa,Ugt="esri.widgets.CompassViewModel";let T1=class extends Kye(Ee){constructor(e){super(e),this._handles=new qt,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(ae(()=>this.view,this._updateRotationWatcher,Ft))}destroy(){this._handles=Ds(this._handles),this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){if(!this.get("view.ready"))return;const e={};this.view.type==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const t=-e.heading;this.orientation={x:0,y:0,z:t}}_updateRotationWatcher(e){this._handles.removeAll(),e&&this._handles.add(e.type==="2d"?ae(()=>e==null?void 0:e.rotation,this._updateForRotation,Ft):ae(()=>e==null?void 0:e.camera,this._updateForCamera,Ft))}};u([d({readOnly:!0})],T1.prototype,"canShowNorth",null),u([d()],T1.prototype,"orientation",void 0),u([d({readOnly:!0})],T1.prototype,"state",null),u([d()],T1.prototype,"view",void 0),T1=u([P(Ugt)],T1);const kTe=T1,Oy={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let Bp=class extends ml{constructor(e,t){super(e,t),this.goToOverride=null,this.iconClass=Oy.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new kTe}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:t}=this.viewModel,i=t==="disabled",r=(t==="rotation"?"rotation":"compass")=="compass",s=i?-1:0,n={[Oy.disabled]:i,[Oy.interactive]:!i},o={[Oy.northIcon]:r,[Oy.rotationIcon]:!r},{messages:a}=this;return ue("div",{bind:this,class:this.classes(Oy.base,n),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:s,"aria-label":a.reset,title:a.reset},ue("span",{"aria-hidden":"true",class:this.classes(Oy.icon,o),styles:this._toRotationTransform(e)}),ue("span",{class:Oy.text},a.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([wt("viewModel.goToOverride")],Bp.prototype,"goToOverride",void 0),u([d()],Bp.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Bp.prototype,"label",void 0),u([d(),Ql("esri/widgets/Compass/t9n/Compass")],Bp.prototype,"messages",void 0),u([wt("viewModel.view")],Bp.prototype,"view",void 0),u([d({type:kTe})],Bp.prototype,"viewModel",void 0),u([Zu()],Bp.prototype,"_reset",null),Bp=u([P("esri.widgets.Compass")],Bp);const kgt=Bp;let mT=class extends Ee{constructor(e){super(e),this._handles=new qt,this.navigationMode="pan",this.view=null}initialize(){this._handles.add(cl(()=>{var e;return(e=this.view)==null?void 0:e.inputManager},()=>this._setNavigationMode()))}destroy(){this._handles.destroy(),this._handles=null,this.view=null}get state(){return this.get("view.ready")&&this.view.type==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],mT.prototype,"state",null),u([d()],mT.prototype,"navigationMode",void 0),u([d()],mT.prototype,"view",void 0),mT=u([P("esri.widgets.NavigationToggleViewModel")],mT);const zTe=mT,Lu={base:"esri-navigation-toggle esri-widget",button:"esri-navigation-toggle__button esri-widget--button",activeButton:"esri-navigation-toggle__button--active",panButton:"esri-navigation-toggle__button--pan",rotateButton:"esri-navigation-toggle__button--rotate",isLayoutHorizontal:"esri-navigation-toggle--horizontal",rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let Gp=class extends ml{constructor(e,t){super(e,t),this.iconClass=Lu.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new zTe}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",t=this.get("viewModel.navigationMode")==="pan",i={[Lu.disabled]:e,[Lu.isLayoutHorizontal]:this.layout==="horizontal"},r={[Lu.activeButton]:t},s={[Lu.activeButton]:!t},n=e?-1:0,o=this.messages.toggle;return ue("div",{bind:this,class:this.classes(Lu.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:n,"aria-label":o,title:o},ue("div",{class:this.classes(Lu.button,Lu.panButton,r)},ue("span",{class:Lu.panIcon})),ue("div",{class:this.classes(Lu.button,Lu.rotateButton,s)},ue("span",{class:Lu.rotationIcon})))}_toggle(){this.toggle()}};u([d()],Gp.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Gp.prototype,"label",void 0),u([d({value:"vertical"})],Gp.prototype,"layout",null),u([d(),Ql("esri/widgets/NavigationToggle/t9n/NavigationToggle")],Gp.prototype,"messages",void 0),u([wt("viewModel.view")],Gp.prototype,"view",void 0),u([d({type:zTe})],Gp.prototype,"viewModel",void 0),u([Zu()],Gp.prototype,"_toggle",null),Gp=u([P("esri.widgets.NavigationToggle")],Gp);const zgt=Gp,EC={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let a0=class extends ml{constructor(){super(...arguments),this.enabled=!0,this.iconClass="",this.title=""}render(){const e=this.enabled?0:-1,t={[EC.disabled]:!this.enabled,[EC.interactive]:this.enabled},i={[this.iconClass]:!!this.iconClass};return ue("div",{bind:this,class:this.classes(EC.button,t),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:e,title:this.title},ue("span",{"aria-hidden":"true",role:"presentation",class:this.classes(EC.icon,i)}),ue("span",{class:EC.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],a0.prototype,"action",void 0),u([d()],a0.prototype,"enabled",void 0),u([d()],a0.prototype,"iconClass",void 0),u([d()],a0.prototype,"title",void 0),u([Zu()],a0.prototype,"_triggerAction",null),a0=u([P("esri.widgets.IconButton")],a0);const rle=a0;let gT=class extends Ee{get canZoomIn(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMaxScale");return t===0||e>t}get canZoomOut(){if(!this.get("view.ready"))return!1;const e=this.get("view.animation.target.scale")||this.get("view.scale"),t=this.get("view.constraints.effectiveMinScale");return t===0||e<t}};u([d({readOnly:!0})],gT.prototype,"canZoomIn",null),u([d({readOnly:!0})],gT.prototype,"canZoomOut",null),u([d()],gT.prototype,"view",void 0),gT=u([P("esri.widgets.Zoom.ZoomConditions2D")],gT);const Vgt=gT;let yT=class extends Ee{get canZoomIn(){return!!this.get("view.ready")}get canZoomOut(){return!!this.get("view.ready")}};u([d({readOnly:!0})],yT.prototype,"canZoomIn",null),u([d({readOnly:!0})],yT.prototype,"canZoomOut",null),u([d()],yT.prototype,"view",void 0),yT=u([P("esri.widgets.Zoom.ZoomConditions3D")],yT);const Bgt=yT;let l0=class extends Ee{constructor(e){super(e),this.canZoomIn=!1,this.canZoomOut=!1}destroy(){this.view=null}get state(){return this.get("view.ready")?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new Vgt({view:e}):e.type==="3d"&&(this._zoomConditions=new Bgt({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():s8(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():s8(e.goTo({zoomFactor:.5}))}};u([d()],l0.prototype,"_zoomConditions",void 0),u([d({aliasOf:"_zoomConditions.canZoomIn",readOnly:!0})],l0.prototype,"canZoomIn",void 0),u([d({aliasOf:"_zoomConditions.canZoomOut",readOnly:!0})],l0.prototype,"canZoomOut",void 0),u([d({readOnly:!0})],l0.prototype,"state",null),u([d()],l0.prototype,"view",null),l0=u([P("esri.widgets.Zoom.ZoomViewModel")],l0);const VTe=l0,CC={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let Lm=class extends ml{constructor(e,t){super(e,t),this.iconClass=CC.widgetIcon,this.label=void 0,this.messages=null,this.view=null,this.viewModel=new VTe}initialize(){this._zoomInButton=new rle({action:this.zoomIn.bind(this),iconClass:CC.zoomInIcon}),this._zoomOutButton=new rle({action:this.zoomOut.bind(this),iconClass:CC.zoomOutIcon})}destroy(){this._zoomInButton.destroy(),this._zoomOutButton.destroy(),this._zoomInButton=null,this._zoomOutButton=null}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}render(){const e=this.viewModel,t={[CC.horizontalLayout]:this.layout==="horizontal"};return this._zoomInButton.enabled=e.state==="ready"&&e.canZoomIn,this._zoomOutButton.enabled=e.state==="ready"&&e.canZoomOut,this._zoomInButton.title=this.messages.zoomIn,this._zoomOutButton.title=this.messages.zoomOut,ue("div",{class:this.classes(CC.base,t)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],Lm.prototype,"iconClass",void 0),u([d({aliasOf:{source:"messages.widgetLabel",overridable:!0}})],Lm.prototype,"label",void 0),u([d({value:"vertical"})],Lm.prototype,"layout",null),u([d(),Ql("esri/widgets/Zoom/t9n/Zoom")],Lm.prototype,"messages",void 0),u([wt("viewModel.view")],Lm.prototype,"view",void 0),u([d({type:VTe})],Lm.prototype,"viewModel",void 0),Lm=u([P("esri.widgets.Zoom")],Lm);const Ggt=Lm,BTe="esri.views.ui.DefaultUI";function jgt(e){return e&&e.view!==void 0}me.getLogger(BTe);let SL=class extends Dgt{constructor(e){super(e),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[]}initialize(){this._handles.add([ae(()=>this.components,this._componentsWatcher.bind(this),Ft),ae(()=>this.view,this._updateViewAwareWidgets.bind(this),Ft)])}_add(e,t,i,r){if(typeof e=="string"&&this._defaultPositionLookup[e]){if(this._find(e))return;e=this._createComponent(e)}super._add(e,t,i,r)}_removeComponents(e){e.forEach(t=>{const i=this._find(t);i&&(this.remove(i),i.destroy())})}_updateViewAwareWidgets(e){this.components.forEach(t=>{const i=this._find(t),r=i&&i.widget;jgt(r)&&(r.view=e)})}_componentsWatcher(e,t){this._removeComponents(t),this._addComponents(e),this._adjustPadding(e)}_adjustPadding(e){if(!e.includes("attribution")&&!this._isOverridden("padding")){const{top:t}=this.padding;this.padding=t}}_addComponents(e){this.initialized&&e.forEach(t=>this.add(this._createComponent(t),this._defaultPositionLookup[t]))}_createComponent(e){const t=this._createWidget(e);if(t)return new TL({id:e,node:t})}_createWidget(e){return e==="attribution"?this._createAttribution():e==="compass"?this._createCompass():e==="navigation-toggle"?this._createNavigationToggle():e==="zoom"?this._createZoom():void 0}_createAttribution(){return new Fgt({view:this.view})}_createCompass(){return new kgt({view:this.view})}_createNavigationToggle(){return new zgt({view:this.view})}_createZoom(){return new Ggt({view:this.view})}};u([d()],SL.prototype,"components",void 0),SL=u([P(BTe)],SL);const Hgt=SL;let EL=class extends Hgt{constructor(e){super(e),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],EL.prototype,"components",void 0),EL=u([P("esri.views.ui.3d.DefaultUI3D")],EL);const GTe=EL,xc=me.getLogger("esri.views.SceneView");let it=class extends dIe(gBe(PBe(M9e))){constructor(e){super(e),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this.propertiesPool=new Tg({slicePlane:Tpe},this),this._resourceController=jat(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new ej({view:this}),this.labeler=new f1({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new WS,this.basemapTerrain=null,this.elevationProvider=null,this.camera=null,this.canvas=null,this.center=null,this.constraints=new U1,this.environmentManager=new cd,this.extent=null,this.floors=new at,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new I9e({view:this}),this.groundView=null,this.navigating=!1,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new Not,this.scale=null,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new GTe,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.viewpoint=null,this.zoom=null,this.highlightOptions=new yj,this.voxelWasm=null,this.voxelWasmPromise=null,OOe(),e&&e.environment||(this._defaults.environment=new sT,this.environment=this._defaults.environment);const t=(i=null)=>{_(i)&&i.type===ji.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async r=>{try{await r.when()}catch{}this._updatingChanged()}))};this.handles.add([eo(()=>{var i;return(i=this.map)==null?void 0:i.allLayers},"after-changes",i=>t(i),{onListenerAdd:()=>t(),onListenerRemove:()=>t(),sync:!0}),this.allLayerViews.on("after-changes",i=>this._updateUpdatingMonitors(i)),ae(()=>this.map,i=>{i&&"load"in i&&i.load&&i.load().catch(()=>{})})]),this.inputManager=new zYe({view:this}),this.stateManager=new lat({view:this})}initialize(){this.groundView=new OBe({view:this}),this._updateUpdatingMonitors();const e=()=>this._updateDefaultToMapOptions();this.handles.add(eo(()=>{var t;return(t=this.map)==null?void 0:t.allLayers},"after-changes",e,{onListenerAdd:e,onListenerRemove:e})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,t=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=t)},Ft),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,t=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=t)},Ft),this.updatingHandles.add(()=>this.qualitySettings.frameRate,t=>X2e(t>0?1e3/Math.ceil(t):0),Ft),this.updatingHandles.add(()=>{var t;return(t=this.map)==null?void 0:t.ground},e,Ms),this.updatingHandles.add(()=>{var t,i;return(i=(t=this.map)==null?void 0:t.ground)==null?void 0:i.opacity},()=>this._updateDefaultHitTestOptions(),Ms),this.handles.add(ae(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),rr))}destroy(){this.destroyed||(this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=ot(this.sharedSymbolResources),this.labeler.destroy(),this._set("labeler",null),this.deconflictor.destroy(),this._set("deconflictor",null),this._resourceController=ot(this._resourceController),this.stateManager.destroy(),this._set("stateManager",null),this.inputManager.destroy(),this._set("inputManager",null),this.propertiesPool.destroy(),this.handles.remove("updatingMonitors"),this.environmentManager.destroy(),this._set("environmentManager",null),this.groundView=ot(this.groundView))}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){var e;return(e=this.basemapTerrain)==null?void 0:e.spatialReference}installContentCameraReset(e={sticky:!1}){return this.stateManager.installContentCameraReset(e)}get clippingArea(){if(this.viewingMode==="global")return null;let e=this._userClippingArea||this.get("map.clippingArea");return!(!!this._userClippingArea||this.get("map.clippingEnabled"))||R(e)?(this._clippingArea=null,null):e instanceof ci?this.spatialReference&&(e=T$(e,this.spatialReference),R(e))?(xc.error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(e=e.clone(),R(e.intersection(this.groundAndLayersExtent))&&(e.xmin=e.xmax,e.ymin=e.ymax),e.zmin=void 0,e.zmax=void 0,e.equals(this._clippingArea)||(this._clippingArea=e),this._clippingArea):(xc.error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(e){this.ready&&this.viewingMode==="global"&&_(e)?xc.error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=e}get renderDataExtent(){if(this.state.viewingMode===Ve.Global)return null;const e=this.renderSpatialReference,t=this.dataExtent;return R(t)||R(e)||t.spatialReference.equals(e)?t:T$(t,e)}get dataExtent(){let e=this.groundAndLayersExtent;const t=this.spatialReference||Xe.WGS84,i=T$(this.clippingArea,t);_(i)&&(e=_(e)?e.intersection(i):i);const r=this._get("dataExtent");return _(e)&&e.equals(r)?r:e}get groundAndLayersExtent(){const e=this.spatialReference||Xe.WGS84;let t;const i=n=>{const o=T$(n,e);R(o)||(_(t)?t.union(o):t=o.clone())},r=this.basemapTerrain;if(r==null?void 0:r.spatialReference){const n=r.groundExtent;i(new ci({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:r.spatialReference}))}if(this.map){const n=o=>{!_(o.fullExtent)||o.type==="graphics"&&o.internal||i(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(R(t))return null;t.hasZ?(t.zmin=Math.min(0,t.zmin),t.zmax=Math.max(0,t.zmax)):(t.zmin=0,t.zmax=0);const s=this._get("groundAndLayersExtent");return t.equals(s)?s:t}set environment(e){e!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",e)}castEnvironment(e){return e?e instanceof sT?e:e instanceof n2?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(e):sT.fromWebsceneEnvironment(e):Qr(sT,e):new sT}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||_(this.activeTool)}get stationary(){return!this.animation&&!this.resizing&&(R(this.state)||this.state.stationary)}set qualityProfile(e){aL.isValidProfile(e)&&(aL.apply(e,this.qualitySettings),this._set("qualityProfile",e))}get qualityProfile(){return this._get("qualityProfile")||aL.getDefaultProfile()}set slicePlane(e){if(_(this._stage)&&this._stage.renderView.setRenderParameters({slicePlane:e}),R(e))return void this._set("slicePlane",null);const t=this.propertiesPool.get("slicePlane");yw(e,t),this._set("slicePlane",t)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?kpe(this.scale,this.spatialReference):0}get heightModelInfo(){const e=this.getDefaultHeightModelInfo();return e!=null?Nv.deriveUnitFromSR(e,this.spatialReference):null}get updating(){var r,s,n;if(this.destroyed)return!1;let e=0,t=this.layerViewManager.updating,i=t?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(o=>{if(o.isFulfilled()){if(o.updating){if(t=!0,o.suspended||iO(o))return;++i,e+=o.updatingProgress}}else++i});for(const o of[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this.featureTreeDebugger,this.toolViewManager,this.analysisViewManager])_(o)&&o.updating&&(i+=.1,e+=.5*.1);for(const o of[this.deconflictor,this.labeler,this.basemapTerrain])_(o)&&o.updating&&(++i,e+=o.updatingProgress);if(t=!!(t||i>0||this.updatingHandles.updating||!this.ready||!this.stationary||this._createGraphicsViewController||((r=this.inputManager)==null?void 0:r.hasPendingInputs)||((n=(s=this.map)==null?void 0:s.allLayers)==null?void 0:n.some(o=>!o.isFulfilled()))),t?(this._numUpdating=Math.max(i,this._numUpdating),e+=this._numUpdating-i):this._numUpdating=0,this._numUpdating>0?e/=this._numUpdating:e=t?0:1,this._get("updatingProgress")!==e){const o=performance.now();if(e<1){const a=Math.min((o-this._lastUpdateTime)/2e3,1);e=this.updatingProgress*(1-a)+e*a}this._set("updatingProgress",e),this._lastUpdateTime=t&&e<1?o:0}return t}get viewingMode(){var i;const e=this._predeterminedViewingMode;if(_(e))return w6(e);const t=this.spatialReference;return t?_((i=this.defaultsFromMap)==null?void 0:i.viewingMode)&&t.equals(this.defaultsFromMap.spatialReference)?w6(this.defaultsFromMap.viewingMode):w2(t,Ve.Global)?"global":"local":"global"}set viewingMode(e){this.ready?xc.error("#viewingMode","viewingMode cannot be set once view is ready"):e?this._override("viewingMode",e):e===void 0&&this._clearOverride("viewingMode")}get resourceController(){return this._resourceController}get performanceInfo(){return new plt(this)}forceAnimationTime(e){this._stage.renderView.forcedAnimationTime=this.basemapTerrain.overlayManager.forcedAnimationTime=e}on(e,t,i,r){return this.viewEvents.on(e,t,i,r)||super.on(e,t)}hasEventListener(e){return super.hasEventListener(e)||this.viewEvents.hasHandler(e)}toMap(e,t){if(!this.ready)return xc.error("#toMap()","Scene view cannot be used before it is ready"),null;const i=t?this.externalToInternalIntersectOptions(t):this._defaultToMapOptions,r=_(i.graphics)&&(_(i.graphics.include)||_(i.graphics.exclude)),s=Hte(e)?jte(this,e):e,n=qm(s);i.enableDraped=i.include&&!i.include.has(Rd)||i.exclude&&i.exclude.has(Rd);const o=this.sceneIntersectionHelper,a=Mh(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=r?io.ALL:io.MIN,o.intersectIntersectorScreen(n,a,i),r){for(const l of a.results.all){const c=Hj(l,this);if(R(c))return this._intersectResultToMapPoint(l);if(c.type!=="graphic"||this._testGraphicUidFilter(i.graphics,c.graphic))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(e){if(!this.ready)return xc.error("#toScreen()","Scene view cannot be used before it is ready"),null;const t=yt(e.z==null&&lf(this.elevationProvider,e),0);return Mn(e,Ex,this.renderSpatialReference,t),this.state.camera.projectToScreen(Ex,qV),Xd(qV[0],qV[1])}pixelSizeAt(e){return this.ready?e?(Mn(e,Ex,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(Ex)):0:(xc.error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(e){const t=this.basemapTerrain.overlayManager;return t?t.overlayPixelSizeInMapUnits(e):1}hitTest(e,t){if(!this.ready)return xc.error("#hitTest()","Scene view cannot be used before it is ready"),null;const i=Hte(e)?jte(this,e):e,r=Vr(i.x,i.y),s=t?this.externalToInternalIntersectOptions(t):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=Mh(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=io.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(r,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=Jae(a,this),c=_(l)&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:i,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Bf(a)?a.distanceInRenderSpace:0,layer:c}};return zi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}async popupHitTest(e){const{results:t,ground:i}=await bgt(this,e);let r=null;return!(t.length===0||Math.abs(yt(t[0].distance,0)-i.distance)<1e-5)||i.layer&&i.layer.type==="integrated-mesh"||(r=i.mapPoint),{results:t,screenPoint:e,mapPoint:r}}goTo(e,t){return this.updatingHandles.addPromise(this.stateManager.goTo(e,t))}async whenAnalysisView(e){if(R(e.parent))throw new q("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return e.parent.type==="line-of-sight"?(await this.whenLayerView(e.parent)).whenAnalysisView():this.analysisViewManager.whenAnalysisView(e)}whenLayerView(e){return super.whenLayerView(e)}async takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return dit(i,t,this._pixelFormat())}async _takeScreenshot(e){const t=this._completeSettings(e);await this.whenReady();const i=await this._stage.renderView.takeScreenshot(t);return pit(i,this._pixelFormat())}_completeSettings(e){const t=hit(e,this);return t.pixelRatio/=this.state.pixelRatio,vit(t,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:e=>this._takeScreenshot(e)}}addUpdatingPromise(e){return this.updatingHandles.addPromise(e)}importLayerView(e){return Jte.importLayerView(e)}hasLayerViewModule(e){return Jte.hasLayerViewModule(e)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){var e,t,i,r;return this.map&&"initialViewProperties"in this.map&&((t=(e=this.map)==null?void 0:e.initialViewProperties)==null?void 0:t.spatialReference)||((i=this.defaultsFromMap)==null?void 0:i.spatialReference)||((r=this.defaultsFromMap)==null?void 0:r.ready)&&this._initialDefaultSpatialReference||null}async validate(){let e=Mgt(this.type);if(he("safari")&&he("safari")<9&&(e=new q("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:he("safari")})),_(e))throw xc.warn("#validate()",e.message),e}get _predeterminedViewingMode(){var t,i;const e=this._isOverridden("viewingMode")?this._get("viewingMode"):(i=this.map&&"initialViewProperties"in this.map?(t=this.map.initialViewProperties)==null?void 0:t.viewingMode:null)!=null?i:null;return _(e)?Yte(e):null}getSpatialReferenceSupport({spatialReference:e,layer:t}){const i=this._predeterminedViewingMode;if(_(i))return this._validateSpatialReferenceForViewingMode(e,t,i)?{constraints:this._makeSpatialReferenceConstraints(e,t,i)}:null;const r=this._validateSpatialReferenceForViewingMode(e,t,Ve.Local),s=this._validateSpatialReferenceForViewingMode(e,t,Ve.Global);return r||s?r&&s?{constraints:this._makeSpatialReferenceConstraints(e,t,null)}:r?{constraints:this._makeSpatialReferenceConstraints(e,t,Ve.Local)}:{constraints:this._makeSpatialReferenceConstraints(e,t,Ve.Global)}:null}_validateSpatialReferenceForViewingMode(e,t,i){return!!w2(e,i)&&(!!R(t)||!!MJ(t)||(!sR(t)||!R(vU(t,e,i)))&&(!RJ(t)||i!==Ve.Global))}_makeSpatialReferenceConstraints(e,t,i){if(R(t))return[{spatialReference:e,viewingMode:i}];const r=e.isWebMercator,s=e.isWGS84;return MJ(t)&&(r||s)?!s||i===Ve.Local||_Z(t.tileInfo,t.fullExtent,e,Ve.Global)===null?[{spatialReference:e,viewingMode:i},{spatialReference:Xe.WebMercator,viewingMode:i}]:[{spatialReference:r?Xe.WGS84:Xe.WebMercator,viewingMode:i}]:sR(t)||RJ(t)||!r&&!s?sR(t)&&r&&i!==Ve.Global?[{spatialReference:e,viewingMode:i},{spatialReference:Xe.WGS84,viewingMode:Ve.Local}]:[{spatialReference:e,viewingMode:i}]:[{spatialReference:e,viewingMode:i},{spatialReference:r?Xe.WGS84:Xe.WebMercator,viewingMode:i}]}_validateSpatialReference(e){const t=_(this.getSpatialReferenceSupport({spatialReference:e})),i=this._predeterminedViewingMode;return t||(_(i)?xc.warnOnce(`Spatial reference defined on view not supported in ${w6(i)} viewing mode.`):e.isGeographic&&xc.warnOnce("Spatial reference is geographic but not supported.")),t}whenReady(){return new Promise(e=>{this.ready?e(this):this._resolveWhenReady.push(e)})}computeMapPointFromVec3d(e,t){let i=this.spatialReference||Xe.WGS84;return Js(e,this.renderSpatialReference,e,i)||(i=Xe.WGS84,Js(e,this.renderSpatialReference,e,i)),t?(t.x=e[0],t.y=e[1],t.z=e[2],t.spatialReference=i):t=new nt(e,i),t}trackGraphicState(e){if(!e.graphic)return xc.error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const t=this.getViewForGraphic(e.graphic);let i=null,r=!1;const s=n=>{var o;!r&&_(n)&&"processor"in n&&((o=n.processor)==null?void 0:o.type)==="graphics-3d"&&n.processor.graphicsCore&&(i=n.processor.graphicsCore.trackGraphicState(e))};return _(t)?s(t):this.whenViewForGraphic(e.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}highlight(e){if(Array.isArray(e))return ES(e.map(i=>this.highlight(i)));if(at.isCollection(e))return ES(e.toArray().map(i=>this.highlight(i)));const t=this.getViewForGraphic(e);return t&&"highlight"in t?t.highlight(e):Th()}maskOccludee(e){if(!e)return xc.error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const t=this.getViewForGraphic(e);let i=null,r=!1;const s=n=>{!r&&_(n)&&eBe(n)&&(i=n.maskOccludee(e))};return _(t)?s(t):this.whenViewForGraphic(e,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{r=!0,_(i)&&(i.remove(),i=null)}}}getViewForGraphic(e){return e.layer===this.graphics?this.graphicsView:e.layer?this.allLayerViews.find(t=>t.layer===e.layer):null}graphicChanged(e){_(this.graphicsView)&&this.graphicsView.graphicChanged(e)}async whenViewForGraphic(e,t){if(e.layer===this)return await BR(()=>this.graphicsView),this.graphicsView;if(!e.layer||!this.map)throw new q("no-view-for-graphic");return t&&t.waitForLayer&&!this.map.allLayers.includes(e.layer)?new Promise((i,r)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(e.layer)&&(s.remove(),this.whenLayerView(e.layer).then(i,r))})}):this.whenLayerView(e.layer)}externalToInternalIntersectOptions(e){const t=this._externalToInternalRenderItems(e.include,FR.INCLUDE),i=this._externalToInternalRenderItems(e.exclude,FR.EXCLUDE);return{include:t.layerUids,exclude:i.layerUids,graphics:{include:t.graphicUids,exclude:i.graphicUids}}}_intersectResultToMapPoint(e,t){return e.getIntersectionPoint(Ex)?(t=this.computeMapPointFromVec3d(Ex,t),e.intersector===Dr.TERRAIN&&this.basemapTerrain&&(t.z=yt(lf(this.basemapTerrain,t),0)),t):null}_intersectResultsToHits(e,t){const i=new Array;let r=null;for(let s=0;s<e.length;s++){const n=e[s],o=Jae(n,this);if(_(o)&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=Hj(n,this);if(R(a))continue;if(a.type==="graphic"){if(R(r)&&s!==e.length-1&&(r=new Set),_(r)){const h=this._getGraphicFilterUid(a.graphic);if(r.has(h))continue;r.add(h)}if(!this._testGraphicUidFilter(t,a.graphic))continue}const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;i.push(ve(F({},a),{mapPoint:l,distance:c}))}return i}_getGraphicFilterUid(e){if(e.layer&&"objectIdField"in e.layer){const t=e.attributes[e.layer.objectIdField];if(t)return`o-${e.layer.id}-${t}`}return`u-${e.uid}`}_testGraphicUidFilter(e,t){const i=this._getGraphicFilterUid(t);return R(e)||(R(e.include)||e.include.has(i))&&(R(e.exclude)||!e.exclude.has(i))}_externalToInternalRenderItems(e,t,i={layerUids:null,graphicUids:null}){if(!e)return i;if(e instanceof Ca)qgt(i,this._getGraphicFilterUid(e)),t===FR.INCLUDE&&(_(this.graphicsView)&&e.layer===this?AC(i,this.graphicsView.processor.layer.id):e.layer&&AC(i,e.layer.uid));else if(Oce(e))for(const r of e)r===this.graphics&&_(this.graphicsView)?AC(i,this.graphicsView.processor.layer.id):r===this.map.ground?AC(i,Rd):this._externalToInternalRenderItems(r,t,i);else"uid"in e&&AC(i,e.uid);return i}_initBasemapTerrain(){this._set("basemapTerrain",new pht({view:this})),this._set("elevationProvider",new NA({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new ko({view:this})),this._set("featureTiles",new Bn({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.contentCameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const e=()=>{var i;const t=(i=this.basemapTerrain)==null?void 0:i.extent;if(this.clippingArea||t)if(t&&this.basemapTerrain.spatialReference){const r=_(this.basemapTerrain.extent)?AO(h4(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;_(this.clippingArea)?this.featureTiles.filterExtent=this.clippingArea.intersection(r):this.featureTiles.filterExtent=r}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.handles.add([this.updatingHandles.add(()=>zi.FEATURE_TILE_TREE_SHOW_TILES,t=>{t&&this.featureTiles&&!this.featureTreeDebugger?this.updatingHandles.addPromise(import("./FeatureTileTree3DDebugger.5186eac8.js")).then(({FeatureTileTree3DDebugger:i})=>{!this.featureTreeDebugger&&zi.FEATURE_TILE_TREE_SHOW_TILES&&(this.featureTreeDebugger=new i({view:this}))}):t||!this.featureTreeDebugger||zi.FEATURE_TILE_TREE_SHOW_TILES||(this.featureTreeDebugger.destroy(),this.featureTreeDebugger=null)},Ms),this.updatingHandles.add(()=>this.clippingArea,e,Ms),this.updatingHandles.add(()=>this.basemapTerrain.extent,e,Ms)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.deinit(),this.handles.remove("render-coords-helper"),this.handles.remove("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const e=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(e)||this._set("mapCoordsHelper",new Mat(this.map,e));const t=this.state.isGlobal,i=Fpe(t,e);i!==this.renderSpatialReference&&(this._set("renderCoordsHelper",DF.create(this.state.viewingMode,i)),t||this.handles.add(ae(()=>{var r;return(r=this.basemapTerrain)==null?void 0:r.extent},r=>{const s=this.renderCoordsHelper.spatialReference;r&&(r[0]!==0||r[1]!==0||r[2]!==0||r[3]!==0)&&A4(r,this.basemapTerrain.spatialReference,sle,s)&&(this.renderCoordsHelper.extent=sle)},rr),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance(_2/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.handles.remove("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(e=null){_(e)&&e.type===ji.MOVE||(this.handles.remove("updatingMonitors"),this.allLayerViews.forEach(t=>{t.destroyed||(this.handles.add(ae(()=>[t.updating,t.updatingProgress],()=>this._updatingChanged(),rr),"updatingMonitors"),t.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}_renderScreenshotOverlay(e,t){if(!this.overlay||!this.overlay.hasVisibleItems)return t;const i=e.getContext("2d");return i.putImageData(t,0,0),this.overlay.renderCanvas(e),i.getImageData(0,0,t.width,t.height)}_initStage(){const e={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{renderOverlay:(a,l)=>this._renderScreenshotOverlay(a,l)}},t=new pat(this.state.viewingMode,a=>this._stage.layers.forAll(a),this);this._set("sceneIntersectionHelper",t);const i=x4(this.surface),{resourceController:r,state:s,renderSpatialReference:n}=this;this._stage=new Ha({options:e,container:i,resourceController:r,state:s,sceneIntersectionHelper:t,renderSR:n}),this._stage.renderView.setRenderParameters({slicePlane:this.slicePlane}),this._lostWebGLContextHandle=fO(this._stage.renderView.canvas,"webglcontextlost",()=>this.fatalError=new q("webgl-context-lost")),this.handles.add([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderView.setRenderParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),Ft),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,()=>this._stage.renderView.setRenderParameters({highQualityTransparency:this.qualitySettings.highQualityTransparency}),Ft),ae(()=>this.magnifier,a=>this._stage.renderView.magnifier=a,Ms)],"stage");const o=()=>{this._stage.renderView.setRenderParameters({defaultHighlightOptions:yj.toEngineOptions(this.highlightOptions)})};this.handles.add(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],o),"stage"),o(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance(_2/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage.destroy(),this._stage=null,this._lostWebGLContextHandle.remove(),this._lostWebGLContextHandle=null,this.handles.remove("stage"),this._set("canvas",null)}_initSurface(e){this._exitSurface(),this.state.init(e,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new mlt({view:this,viewingMode:e,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state,objectResourceCache:new yot})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.handles.remove("graphics-view"),this._createGraphicsViewController=new AbortController;const e=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(e,e),this._updatingChanged()}async _createGraphicsViewAsync(e){const t=(await import("./GraphicsView3D.8f1e9c88.js")).default;li(e),await BR(()=>{var i;return(i=this.basemapTerrain)==null?void 0:i.ready},e),this._set("graphicsView",new t({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.handles.remove("graphics-view"),_(this.graphicsView)&&(this.handles.remove(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const e=Yte(this.viewingMode);if(e===Ve.Global&&(this._clippingArea=null),this._initSurface(e),this._set("ready",!0),this.handles.add(eo(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const i=this.get("map.initialViewProperties.environment");i&&(this.environment=i)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const t=this._resolveWhenReady;this._resolveWhenReady=[],t.forEach(i=>i(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.handles.remove("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Rd);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(e.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Rd);for(const e of this.map.allLayers.items)e.type==="integrated-mesh"&&e.opacity<1&&this._defaultToMapOptions.exclude.add(e.uid)}}addVoxelLayerViewToWasm(e){return R(this.voxelWasm)?(R(this.voxelWasmPromise)&&(this.voxelWasmPromise=import("./VoxelWasmPerSceneView.3ae7cba4.js").then(t=>(this.voxelWasm=new t.default(this),this.voxelWasm))),this.voxelWasmPromise.then(t=>t.addVoxelLayer(e))):this.voxelWasm.addVoxelLayer(e)}removeVoxelLayerViewFromWasm(e){_(this.voxelWasm)&&this.voxelWasm.removeVoxelLayer(e)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function AC(e,t){e.layerUids||(e.layerUids=new Set),e.layerUids.add(t)}function qgt(e,t){e.graphicUids||(e.graphicUids=new Set),e.graphicUids.add(t)}function T$(e,t){return _(e)&&bg(e.spatialReference,t)?AO(e,t):null}var FR;it.type="3d",u([d()],it.prototype,"_userClippingArea",void 0),u([d()],it.prototype,"_resourceController",void 0),u([d()],it.prototype,"_stage",void 0),u([d({readOnly:!0})],it.prototype,"deconflictor",void 0),u([d({readOnly:!0})],it.prototype,"labeler",void 0),u([d(GB(WS,"analyses"))],it.prototype,"analyses",void 0),u([d({type:s2,readOnly:!0,aliasOf:"state.animation"})],it.prototype,"animation",void 0),u([d({readOnly:!0})],it.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],it.prototype,"elevationProvider",void 0),u([d({type:rc,aliasOf:"stateManager.camera"})],it.prototype,"camera",void 0),u([d({type:rc,aliasOf:"stateManager.contentCamera"})],it.prototype,"contentCamera",void 0),u([d({readOnly:!0})],it.prototype,"canvas",void 0),u([d({type:nt,aliasOf:"stateManager.center"})],it.prototype,"center",void 0),u([d({type:ci})],it.prototype,"clippingArea",null),u([d({type:U1})],it.prototype,"constraints",void 0),u([d({type:ci,readOnly:!0})],it.prototype,"renderDataExtent",null),u([d({type:ci,readOnly:!0})],it.prototype,"dataExtent",null),u([d({type:ci,readOnly:!0})],it.prototype,"groundAndLayersExtent",null),u([d({value:null,type:sT})],it.prototype,"environment",null),u([Ot("environment")],it.prototype,"castEnvironment",null),u([d({readOnly:!0})],it.prototype,"environmentManager",void 0),u([d({type:ci,aliasOf:"stateManager.extent"})],it.prototype,"extent",void 0),u([d()],it.prototype,"floors",void 0),u([d({readOnly:!0,aliasOf:"stateManager.screenCenter"})],it.prototype,"screenCenter",void 0),u([d({aliasOf:"stateManager.frustum"})],it.prototype,"frustum",void 0),u([d({type:Number,readOnly:!0})],it.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],it.prototype,"graphicsView",void 0),u([d({readOnly:!0})],it.prototype,"analysisViewManager",void 0),u([d()],it.prototype,"groundView",void 0),u([d({type:Boolean})],it.prototype,"initialExtentRequired",null),u([d()],it.prototype,"_defaultsFromMapSettings",null),u([d({type:Boolean,readOnly:!0})],it.prototype,"interacting",null),u([d()],it.prototype,"stationary",null),u([d({aliasOf:"state.navigating"})],it.prototype,"navigating",void 0),u([d()],it.prototype,"map",void 0),u([d({readOnly:!0})],it.prototype,"mapCoordsHelper",void 0),u([d({aliasOf:"stateManager.padding"})],it.prototype,"padding",void 0),u([d({type:ko,readOnly:!0})],it.prototype,"pointsOfInterest",void 0),u([d({type:Bn,readOnly:!0})],it.prototype,"featureTiles",void 0),u([d()],it.prototype,"featureTreeDebugger",void 0),u([d({type:Boolean})],it.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],it.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],it.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],it.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],it.prototype,"state",void 0),u([d({readOnly:!0})],it.prototype,"inputManager",void 0),u([d({readOnly:!0})],it.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],it.prototype,"qualityProfile",null),u([d({type:ioe,get(){let e=this._get("qualitySettings");return e||(e=new ioe,aL.apply(this.qualityProfile,e)),e}})],it.prototype,"qualitySettings",void 0),u([d()],it.prototype,"slicePlane",null),u([d({readOnly:!0})],it.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],it.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],it.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],it.prototype,"resolution",null),u([d({type:Number,aliasOf:"stateManager.scale"})],it.prototype,"scale",void 0),u([d()],it.prototype,"heightModelInfo",null),u([d()],it.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],it.prototype,"alphaCompositingEnabled",void 0),u([d({constructOnly:!0})],it.prototype,"preserveDrawingBufferEnabled",void 0),u([d({type:Boolean})],it.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],it.prototype,"type",void 0),u([d({type:GTe})],it.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.hasPendingInputs","toolViewManager.updating","analysisViewManager.updating"]})],it.prototype,"updating",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],it.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],it.prototype,"viewingMode",null),u([d({type:sc,aliasOf:"stateManager.viewpoint"})],it.prototype,"viewpoint",void 0),u([d({type:Number,aliasOf:"stateManager.zoom"})],it.prototype,"zoom",void 0),u([d({type:yj})],it.prototype,"highlightOptions",void 0),it=u([P("esri.views.SceneView")],it),function(e){e[e.INCLUDE=0]="INCLUDE",e[e.EXCLUDE=1]="EXCLUDE"}(FR||(FR={}));const Ex=O(),qV=Vr(),sle=Dt(),mbt=it;function Wgt(e){return e&&"getAtOrigin"in e&&"originOf"in e}function nle(e){e&&e.writtenProperties&&e.writtenProperties.forEach(({target:t,propName:i,newOrigin:r})=>{Wgt(t)&&r&&t.originOf(i)!==r&&t.updateOrigin(i,r)})}let c0=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],c0.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],c0.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],c0.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],c0.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],c0.prototype,"sublayerId",void 0),c0=u([P("esri.layers.support.FacilityLayerInfo")],c0);const Xgt=c0;let pd=class extends fe{constructor(e){super(e),this.facilityIdField=null,this.layerId=null,this.levelIdField=null,this.levelNumberField=null,this.longNameField=null,this.shortNameField=null,this.sublayerId=null,this.verticalOrderField=null}};u([d({type:String,json:{write:!0}})],pd.prototype,"facilityIdField",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"levelIdField",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"levelNumberField",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"longNameField",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"shortNameField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],pd.prototype,"sublayerId",void 0),u([d({type:String,json:{write:!0}})],pd.prototype,"verticalOrderField",void 0),pd=u([P("esri.layers.support.LevelLayerInfo")],pd);const Ygt=pd;let S1=class extends fe{constructor(e){super(e),this.layerId=null,this.nameField=null,this.siteIdField=null,this.sublayerId=null}};u([d({type:String,json:{write:!0}})],S1.prototype,"layerId",void 0),u([d({type:String,json:{write:!0}})],S1.prototype,"nameField",void 0),u([d({type:String,json:{write:!0}})],S1.prototype,"siteIdField",void 0),u([d({type:Number,json:{read:{source:"subLayerId"},write:{target:"subLayerId"},origins:{"web-scene":{read:!1,write:!1}}}})],S1.prototype,"sublayerId",void 0),S1=u([P("esri.layers.support.SiteLayerInfo")],S1);const Zgt=S1;let vT=class extends fe{constructor(e){super(e),this.levelLayer=null,this.facilityLayer=null,this.siteLayer=null}};u([d({type:Ygt,json:{write:!0}})],vT.prototype,"levelLayer",void 0),u([d({type:Xgt,json:{write:!0}})],vT.prototype,"facilityLayer",void 0),u([d({type:Zgt,json:{write:!0}})],vT.prototype,"siteLayer",void 0),vT=u([P("esri.support.MapFloorInfo")],vT);const Qgt=vT,Jgt="webscene:failed-to-copy-embedded-resources",Kgt="webscene:schema-validation";function eyt(){return new q(Jgt,"Copying of embedded resources is currently not supported")}function tyt(e){return new q(Kgt,"Failed to save webscene due to schema validation errors. See 'details.errors' for more detailed information",{errors:e})}async function iyt(e,t={},i){await e.load(i);const r=du(e.itemUrl,"resources"),{start:s=1,num:n=10,sortOrder:o="asc",sortField:a="created"}=t,l={query:{start:s,num:n,sortOrder:o,sortField:a,token:e.apiKey},signal:Yr(i,"signal")},c=await e.portal._request(r,l);return{total:c.total,nextStart:c.nextStart,resources:c.resources.map(({created:h,size:p,resource:f})=>({created:new Date(h),size:p,resource:e.resourceFromPath(f)}))}}async function ryt(e,t,i,r){if(!e.hasPath())throw new q(`portal-item-resource-${t}:invalid-path`,"Resource does not have a valid path");const s=e.portalItem;await s.load(r);const n=du(s.userItemUrl,t==="add"?"addResources":"updateResources"),[o,a]=jTe(e.path),l=await HTe(i),c=new FormData;return o&&o!=="."&&c.append("resourcesPrefix",o),c.append("fileName",a),c.append("file",l,a),c.append("f","json"),_(r)&&r.access&&c.append("access",r.access),await s.portal._request(n,{method:"post",body:c,signal:Yr(r,"signal")}),e}async function syt(e,t,i){if(!t.hasPath())throw new q("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await e.load(i);const r=du(e.userItemUrl,"removeResources");await e.portal._request(r,{method:"post",query:{resource:t.path},signal:Yr(i,"signal")}),t.portalItem=null}async function nyt(e,t){await e.load(t);const i=du(e.userItemUrl,"removeResources");return e.portal._request(i,{method:"post",query:{deleteAll:!0},signal:Yr(t,"signal")})}function jTe(e){const t=e.lastIndexOf("/");return t===-1?[".",e]:[e.slice(0,t),e.slice(t+1)]}function GZ(e){const[t,i]=oyt(e),[r,s]=jTe(t);return[r,s,i]}function oyt(e){const t=YRe(e);return R(t)?[e,""]:[e.slice(0,e.length-t.length-1),`.${t}`]}async function HTe(e){return e instanceof Blob?e:(await ur(e.url,{responseType:"blob"})).data}function ayt(e,t){if(!e.hasPath())return null;const[i,,r]=GZ(e.path);return e.portalItem.resourceFromPath(du(i,t+r))}function qTe(e,t){if(!e.hasPath())return null;const[i,,r]=GZ(e.path);return e.portalItem.resourceFromPath(du(i,t+r))}var jA=Object.freeze({__proto__:null,[Symbol.toStringTag]:"Module",addOrUpdateResource:ryt,contentToBlob:HTe,fetchResources:iyt,getSiblingOfSameType:ayt,getSiblingOfSameTypeI:qTe,removeAllResources:nyt,removeResource:syt,splitPrefixFileNameAndExtension:GZ});async function ole(e,t,i){if(!t||!t.resources)return;const r=t.portalItem===e.portalItem?new Set(e.paths):new Set;e.paths.length=0,e.portalItem=t.portalItem;const s=new Set(t.resources.toKeep.map(c=>c.resource.path)),n=new Set,o=[];s.forEach(c=>{r.delete(c),e.paths.push(c)});for(const c of t.resources.toUpdate)if(r.delete(c.resource.path),s.has(c.resource.path)||n.has(c.resource.path)){const{resource:h,content:p,finish:f,error:m}=c,y=qTe(h,pfe());e.paths.push(y.path),o.push(ale({resource:y,content:p,finish:f,error:m},i))}else e.paths.push(c.resource.path),o.push(lyt(c,i)),n.add(c.resource.path);for(const c of t.resources.toAdd)o.push(ale(c,i)),e.paths.push(c.resource.path);if(r.forEach(c=>{const h=t.portalItem.resourceFromPath(c);o.push(h.portalItem.removeResource(h).catch(()=>{}))}),o.length===0)return;const a=await pn(o);li(i);const l=a.filter(c=>"error"in c).map(c=>c.error);if(l.length>0)throw new q("save:resources","Failed to save one or more resources",{errors:l})}async function ale(e,t){const i=await nc(e.resource.portalItem.addResource(e.resource,e.content,t));if(i.ok!==!0)throw e.error&&e.error(i.error),i.error;e.finish&&e.finish(e.resource)}async function lyt(e,t){const i=await nc(e.resource.update(e.content,t));if(i.ok!==!0)throw e.error(i.error),i.error;e.finish(e.resource)}const cyt={width:600,height:400},S$=1.5;function uyt(e,t){t=t||cyt;let{width:i,height:r}=t;const s=i/r;return s<S$?r=i/S$:s>S$&&(i=r*S$),i>e.width&&(r*=e.width/i,i=e.width),r>e.height&&(i*=e.height/r,r=e.height),{width:Math.round(i),height:Math.round(r)}}function lle(e){return{enabled:!!(e==null?void 0:e.length)}}var qj;let _T=qj=class extends fe{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new qj({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],_T.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],_T.prototype,"name",void 0),u([ct(CW)],_T.prototype,"type",void 0),_T=qj=u([P("esri.webdoc.applicationProperties.SearchLayerField")],_T);const hyt=_T;var Wj;let bT=Wj=class extends fe{constructor(e){super(e),this.field=null,this.id=null,this.subLayer=null}clone(){return new Wj(te({field:this.field,id:this.id,subLayer:this.subLayer}))}};u([d({type:hyt,json:{write:{isRequired:!0}}})],bT.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],bT.prototype,"id",void 0),u([d({type:yr,json:{write:!0}})],bT.prototype,"subLayer",void 0),bT=Wj=u([P("esri.webdoc.applicationProperties.SearchLayer")],bT);const dyt=bT;var Xj;let wT=Xj=class extends fe{constructor(e){super(e),this.exactMatch=!1,this.name=null,this.type=null}clone(){return new Xj({exactMatch:this.exactMatch,type:this.type,name:this.name})}};u([d({type:Boolean,json:{write:!0}})],wT.prototype,"exactMatch",void 0),u([d({type:String,json:{write:!0}})],wT.prototype,"name",void 0),u([ct(CW)],wT.prototype,"type",void 0),wT=Xj=u([P("esri.webdoc.applicationProperties.SearchTableField")],wT);const pyt=wT;var Yj;let HA=Yj=class extends fe{constructor(e){super(e),this.field=null,this.id=null}clone(){return new Yj(te({field:this.field,id:this.id}))}};u([d({type:pyt,json:{write:{isRequired:!0}}})],HA.prototype,"field",void 0),u([d({type:String,json:{write:{isRequired:!0}}})],HA.prototype,"id",void 0),HA=Yj=u([P("esri.webdoc.applicationProperties.SearchTable")],HA);const fyt=HA;var Zj;const WTe=at.ofType(dyt),XTe=at.ofType(fyt);let jp=Zj=class extends fe{constructor(e){super(e),this.addressSearchEnabled=!0,this.enabled=!0,this.hintText=null,this.layers=new WTe,this.tables=new XTe}readAddressSearchEnabled(e){return!e}writeAddressSearchEnabled(e,t,i){t[i]=!e}clone(){return new Zj(te({addressSearchEnabled:this.addressSearchEnabled,enabled:this.enabled,hintText:this.hintText,layers:this.layers,tables:this.tables}))}};u([d({type:Boolean,nonNullable:!0,json:{read:{source:"disablePlaceFinder"},write:{target:"disablePlaceFinder",isRequired:!0},origins:{"web-scene":{read:!1,write:!1}}}})],jp.prototype,"addressSearchEnabled",void 0),u([ke("addressSearchEnabled")],jp.prototype,"readAddressSearchEnabled",null),u([Be("addressSearchEnabled")],jp.prototype,"writeAddressSearchEnabled",null),u([d({type:Boolean,nonNullable:!0,json:{write:!0,origins:{"web-map":{write:{isRequired:!0}},"web-scene":{default:!0,write:!0}}}})],jp.prototype,"enabled",void 0),u([d({type:String,json:{write:!0}})],jp.prototype,"hintText",void 0),u([d({type:WTe,json:{write:{overridePolicy:lle},origins:{"web-scene":{write:{isRequired:!0}}}}})],jp.prototype,"layers",void 0),u([d({type:XTe,json:{read:!0,write:{overridePolicy:lle}}})],jp.prototype,"tables",void 0),jp=Zj=u([P("esri.webdoc.applicationProperties.Search")],jp);const myt=jp;var Qj;let CL=Qj=class extends fe{constructor(e){super(e),this.search=null}clone(){return new Qj(te({search:this.search}))}};u([d({type:myt,json:{write:!0}})],CL.prototype,"search",void 0),CL=Qj=u([P("esri.webdoc.applicationProperties.Viewing")],CL);const gyt=CL;var Jj;let AL=Jj=class extends fe{constructor(e){super(e),this.viewing=null}clone(){return new Jj({viewing:this.viewing?this.viewing.clone():null})}};u([d({type:gyt,json:{write:!0}})],AL.prototype,"viewing",void 0),AL=Jj=u([P("esri.webscene.ApplicationProperties")],AL);const yyt=AL;var Kj;let E1=Kj=class extends fe{constructor(e){super(e),this.environment=new n2,this.spatialReference=null,this.viewpoint=null}set viewingMode(e){this._set("viewingMode",e)}clone(){return new Kj({environment:this.environment.clone(),spatialReference:this.spatialReference?this.spatialReference.clone():null,viewingMode:this.viewingMode,viewpoint:this.viewpoint?this.viewpoint.clone():null})}};u([d({type:n2,json:{write:{isRequired:!0}}})],E1.prototype,"environment",void 0),u([d({type:Xe})],E1.prototype,"spatialReference",void 0),u([d({type:["local","global"]})],E1.prototype,"viewingMode",null),u([d({type:sc,json:{write:{isRequired:!0}}})],E1.prototype,"viewpoint",void 0),E1=Kj=u([P("esri.webscene.InitialViewProperties")],E1);const qF=E1;var eH;let tg=eH=class extends fe{constructor(){super(...arguments),this.url=""}destroy(){this.url=""}clone(){return new eH({url:this.url})}};u([d({type:String,json:{write:{isRequired:!0}}})],tg.prototype,"url",void 0),tg=eH=u([P("esri.webdoc.support.SlideThumbnail")],tg);var tH;let RL=tH=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new tH({text:this.text})}};u([d({type:String,json:{write:!0}})],RL.prototype,"text",void 0),RL=tH=u([P("esri.webscene.support.Description")],RL);const ML=RL;var iH;let HT=iH=class extends fe{constructor(){super(...arguments),this.lighting=new kb,this.weather=new jN}clone(){return new iH({lighting:te(this.lighting),weather:te(this.weather)})}};u([d({types:S0e,json:{write:!0}})],HT.prototype,"lighting",void 0),u([d({types:SX,json:{write:!0}})],HT.prototype,"weather",void 0),HT=iH=u([P("esri.webscene.Environment")],HT);var OL;let PL=OL=class extends fe{constructor(){super(...arguments),this.opacity=null}clone(){return new OL({opacity:this.opacity})}cloneAndApplyTo(e){return this.opacity==null||((e=e!=null?e.clone():new mM).opacity=this.opacity),e}static fromGround(e){return new OL({opacity:e.opacity})}};u([d({type:Number,json:{type:yr,read:{reader:LS,source:"transparency"},write:{writer:(e,t)=>{t.transparency=xO(e)},target:"transparency"}}})],PL.prototype,"opacity",void 0),PL=OL=u([P("esri.webscene.support.SlideGround")],PL);const YTe=PL;var rH;let qT=rH=class extends fe{constructor(e){super(e),this.id="",this.sublayerIds=null}clone(){return new rH({id:this.id,sublayerIds:te(this.sublayerIds)})}};u([d({type:String,json:{write:!0}})],qT.prototype,"id",void 0),u([d({type:[yr],json:{read:{source:"subLayerIds"},write:{target:"subLayerIds"}}})],qT.prototype,"sublayerIds",void 0),qT=rH=u([P("esri.webscene.support.SlideVisibleLayer")],qT);var sH;let IL=sH=class extends fe{constructor(){super(...arguments),this.text=""}clone(){return new sH({text:this.text})}};u([d({type:String,json:{write:{isRequired:!0}}})],IL.prototype,"text",void 0),IL=sH=u([P("esri.webscene.support.Title")],IL);const UR=IL;let vyt=0;const nH=at.ofType(qT),_yt=me.getLogger("esri.webscene.Slide");let Uo=class extends fe{constructor(e){super(e),this.id=Date.now().toString(16)+"-slide-"+vyt++,this.title=new UR,this.description=new ML,this.thumbnail=new tg,this.viewpoint=null,this.basemap=null,this.ground=null,this.environment=new HT,this.visibleLayers=new nH}destroy(){this.visibleLayers.removeAll(),this.basemap=null,this.thumbnail&&this.thumbnail.destroy(),this.description=null,this.title=null,this.thumbnail=null}castTitle(e){return typeof e=="string"?new UR({text:e}):Qr(UR,e)}castDescription(e){return typeof e=="string"?new ML({text:e}):Qr(ML,e)}castThumbnail(e){return typeof e=="string"?new tg({url:e}):Qr(tg,e)}castBasemap(e){return xX(e)}set visibleLayers(e){this._set("visibleLayers",_g(e,this._get("visibleLayers"),nH))}castVisibleLayers(e){return e&&typeof e.map=="function"?e.map(t=>{if(typeof t=="string")return{id:t};if(t instanceof hM){const i=cle(t);return{id:t.id,sublayerIds:i}}return t.id?{id:t.id,sublayerIds:t.sublayerIds}:(_yt.warn('Invalid visible layer, expected { id }, Layer or "id"'),t)}):null}clone(){return new this.constructor({id:this.id,title:this.title.clone(),thumbnail:this.thumbnail.clone(),description:this.description&&this.description.clone()||null,viewpoint:this.viewpoint&&this.viewpoint.clone()||null,basemap:this.basemap&&this.basemap.clone()||null,ground:this.ground&&this.ground.clone()||null,visibleLayers:this.visibleLayers.clone(),environment:this.environment&&this.environment.clone()||null})}_updateVisibleLayersFrom(e){const t=[];return pn(this._getLayers(e.map).map(i=>e.whenLayerView(i).then(r=>{if(r.visible){const s=cle(i);t.push(new qT({id:r.layer.id,sublayerIds:s}))}})).toArray()).then(()=>{this.visibleLayers.removeAll(),this.visibleLayers.addMany(t)})}updateFrom(e,t){return t={screenshot:F({format:"png",quality:80,width:120,height:75,disableDecorations:!0},t&&t.screenshot)},e.when(()=>(this.viewpoint=e.viewpoint.clone(),this.environment.lighting=e.environment.lighting.type==="virtual"?zO.prototype.clone.apply(e.environment.lighting):kb.prototype.clone.apply(e.environment.lighting),this.environment.weather=e.environment.weather.clone(),this.basemap=e.map.basemap&&e.map.basemap.clone()||null,this.ground=e.map.ground?YTe.fromGround(e.map.ground):null,this._updateVisibleLayersFrom(e))).then(()=>e.takeScreenshot(t.screenshot)).then(i=>(this.thumbnail=new tg({url:i.dataUrl}),this))}async applyTo(e,t){_(this._applyToController)&&this._applyToController.abort();let i=new AbortController;this._applyToController=i;const r=r4(t,()=>i.abort()),s=e.resourceController.scheduler.registerTask(mt.SLIDE);let n=!1;t=ve(F({animate:!0},t),{signal:this._applyToController.signal});const o=async()=>{await Promise.all([s.schedule(()=>n=this._setViewpointOfInterest(e,t)),s.schedule(()=>this._applyBasemap(e,t),t.signal)]),await Promise.all([s.schedule(()=>this._applyLayerVisibility(e),t.signal),s.schedule(()=>this._applyGround(e),t.signal),s.schedule(()=>this._applyViewpoint(e,t),t.signal)]),await s.schedule(()=>e.environment.weather=this.environment.weather.clone())},a=await nc(e.addUpdatingPromise(o()));if(n&&(e.contentCamera=null),s.remove(),this._applyToController===i&&(this._applyToController=null),i=null,r==null||r.remove(),a.ok===!1)throw a.error;return this}async _applyBasemap(e,t){if(this.basemap){try{await this.basemap.load(t)}catch(i){if(Gr(i))throw i}e.map.basemap=WBe(this.basemap,e.map.basemap)}}_applyGround(e){this.ground&&(e.map.ground=this.ground.cloneAndApplyTo(e.map.ground))}_getLayers(e){const t=new at;return this._collectLayers(e,t),this._collectLayers(e.ground,t),t}_collectLayers(e,t){e.layers.forEach(i=>{Lze(i)&&(t.add(i),"layers"in i&&this._collectLayers(i,t))})}_applyLayerVisibility(e){!this.visibleLayers||this._getLayers(e.map).forEach(t=>{const i=this.visibleLayers.find(n=>n.id===t.id);t.visible=i!=null;const r=i&&i.sublayerIds,s=ZTe(t);r&&s&&s.forEach(n=>n.visible=r.includes(n.id))})}_setViewpointOfInterest(e,t){if(e.state.fixedContentCamera||!this.viewpoint||t.ignoreViewpoint||!t.useDestinationCamera)return!1;const i=hZ(e,this.viewpoint);return e.contentCamera=i,_(i)}async _applyViewpoint(e,t){if(this.viewpoint&&!t.ignoreViewpoint){if(_(this.viewpoint.camera)&&(this.viewpoint.camera.fov=e.camera.fov),t.animate&&this.get("environment.lighting.date"))return void await this._animateToLighting(e,t);t.animate&&(e.environment.applyLighting(this.environment.lighting.clone()),await e.goTo(this.viewpoint,t)),e.viewpoint=this.viewpoint}e.environment.applyLighting(this.environment.lighting.clone())}async _animateToLighting(e,t){let i=null;return e.environment.lighting.type==="sun"&&this.environment.lighting.type==="sun"&&(e.viewingMode==="global"&&(i=this._animateLightingWithCamera(e,e.environment.lighting,this.environment.lighting)),e.environment.lighting.cameraTrackingEnabled=!1),e.environment.lighting.directShadowsEnabled=this.environment.lighting.directShadowsEnabled,this.environment.lighting.type==="virtual"||e.environment.lighting.type==="virtual"?(e.environment.applyLighting(this.environment.lighting.clone()),e.environment.lighting.type==="sun"&&(e.environment.lighting.cameraTrackingEnabled=!1)):this.environment.lighting.displayUTCOffset!=null&&(e.environment.lighting.displayUTCOffset=this.environment.lighting.displayUTCOffset),e.goTo(this.viewpoint,t).then(()=>e.environment.applyLighting(this.environment.lighting.clone())).finally(()=>{Ds(i),e.environment.lighting.type==="sun"&&(e.environment.lighting.cameraTrackingEnabled=!0)})}_getTime(e){return[e.getTime(),3600*e.getUTCHours()+60*e.getUTCMinutes()+e.getUTCSeconds()]}_setTime(e,t,i){return e.setTime(t),e.setUTCHours(i/3600),e.setUTCMinutes(i%3600/60),e.setUTCSeconds(i%3600%60),e}_animateLightingWithCamera(e,t,i){const r=new Date(t.date.toString()),[s,n]=this._getTime(r),[o,a]=this._getTime(i.date),l=byt(n,a),c=e.renderCoordsHelper,h=O();c.toRenderCoords(e.camera.position,h);const p=O(),f=O();_(this.viewpoint.camera)&&c.toRenderCoords(this.viewpoint.camera.position,p);const m=new Date;return ae(()=>e.camera,y=>{c.toRenderCoords(y.position,f);const v=$s(h,f),w=$s(p,f);let b=0;v+w!==0&&(b=v/(v+w));const S=s+(o-s)*b,T=wyt(n,l*b);t.date=this._setTime(m,S,T)})}static createFrom(e,t){return new this().updateFrom(e,t)}};function ZTe(e){if(e.type==="building-scene"||e.type==="map-image")return e.allSublayers.toArray()}function cle(e){const t=ZTe(e);if(t)return t.filter(i=>i.visible).map(i=>i.id)}u([d({type:String,json:{write:{isRequired:!0}}})],Uo.prototype,"id",void 0),u([d({type:UR,json:{default:()=>new UR({text:""}),write:{isRequired:!0}}})],Uo.prototype,"title",void 0),u([Ot("title")],Uo.prototype,"castTitle",null),u([d({type:ML,json:{write:{overridePolicy:e=>({enabled:!(!e||!e.text)})}}})],Uo.prototype,"description",void 0),u([Ot("description")],Uo.prototype,"castDescription",null),u([d({type:tg,json:{default:()=>new tg({url:""}),write:{isRequired:!0}}})],Uo.prototype,"thumbnail",void 0),u([Ot("thumbnail")],Uo.prototype,"castThumbnail",null),u([d({type:sc,nonNullable:!0,json:{write:{isRequired:!0}}})],Uo.prototype,"viewpoint",void 0),u([d({type:t2,json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],Uo.prototype,"basemap",void 0),u([Ot("basemap")],Uo.prototype,"castBasemap",null),u([d({type:YTe,json:{write:!0}})],Uo.prototype,"ground",void 0),u([d({type:nH,json:{write:{isRequired:!0}}})],Uo.prototype,"visibleLayers",null),u([Ot("visibleLayers")],Uo.prototype,"castVisibleLayers",null),u([d({type:HT,json:{write:!0}})],Uo.prototype,"environment",void 0),Uo=u([P("esri.webscene.Slide")],Uo);const oH=86400,ule=43200;function byt(e,t){let i=t-e;return i>ule&&(i-=oH),i<-ule&&(i+=oH),i}function wyt(e,t){return EPe(e+t,oH)}const xyt=Uo,aH=at.ofType(xyt);let $L=class extends fe{constructor(e){super(e),this.slides=new aH}destroy(){this.slides.forEach(e=>e.destroy()),this.slides.removeAll()}set slides(e){e&&(e=e.filter(t=>!!t.viewpoint)),this._set("slides",_g(e,this._get("slides"),aH))}clone(){return new this.constructor({slides:this.slides.clone()})}};u([d({type:aH,nonNullable:!0,json:{write:!0}}),Ot(bq)],$L.prototype,"slides",null),$L=u([P("esri.webscene.Presentation")],$L);const QTe=$L;var lH;let xT=lH=class extends fe{constructor(e){super(e)}clone(){return new lH({name:this.name,path:this.path,title:this.title})}};u([d({type:String,json:{write:!0}})],xT.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],xT.prototype,"path",void 0),u([d({type:String,json:{write:!0}})],xT.prototype,"title",void 0),xT=lH=u([P("esri.webscene.TransportationNetwork")],xT);const Tyt=xT;class WF extends Iv{constructor(t,i){super(t,i,"webscene")}get supportsGround(){return this.since(1,8)}get supportsVisibleElevationLayersInSlides(){return this.lessThan(1,8)}}const Cx=me.getLogger("esri.WebScene"),bS=new WF(1,28),Syt=()=>{const t=[],i=bS.major;for(let r=8;r<=bS.minor;r++)t.push(`${i}.${r}`);return t},WV="Web Scene",E$="ViewingMode-Local";let Gi=class extends Sf.LoadableMixin(SO(rX(u0e))){constructor(e){super(e),this._handles=new qt,this.applicationProperties=null,this.clippingArea=null,this.clippingEnabled=!1,this.floorInfo=null,this.heightModelInfo=null,this.sourceVersion=null,this.transportationNetworks=null,this.presentation=new QTe,this.initialViewProperties=new qF,this.portalItem=null,this.resourceInfo=null,this._debouncedSaveOperations=EH(async(t,i,r)=>{switch(t){case WT.SAVE:return this._saveImpl(i);case WT.SAVE_AS:return this._saveAsImpl(r,i)}}),this.resourceReferences={portalItem:null,paths:[]},this.authoringApp=null,this.authoringAppVersion=null,this._isAuthoringAppSetByUser=!1,this._isAuthoringAppVersionSetByUser=!1}initialize(){if(this.when().catch(e=>{Cx.error("#load()","Failed to load web scene",e)}),this.resourceInfo){let e;try{e=this._validateJSON(this.resourceInfo)}catch(t){return void this.addResolvingPromise(Promise.reject(t))}this.read(e),this.addResolvingPromise(this._validateSpatialReference()),this.addResolvingPromise(this._validateHeightModelInfo())}this._handles.add(this.allLayers.on("change",()=>this._scheduleLayersIdGC()))}destroy(){this._unscheduleLayersIdGC(),this._handles.destroy(),this.presentation&&this.presentation.destroy();const e=this.portalItem;this.portalItem=null,e==null||e.destroy()}writeClippingArea(e,t){t.clippingArea||(t.clippingArea={}),t.clippingArea.geometry=e.toJSON()}readClippingEnabled(e,t){return!!t.clippingArea&&!!t.clippingArea.clip}writeClippingEnabled(e,t){this.clippingArea&&(t.clippingArea||(t.clippingArea={}),t.clippingArea.clip=e)}writeLayers(e,t,i,r){const s=ve(F({},r),{layerContainerType:"operational-layers"}),n=e.map(o=>this.verifyWriteLayer(o,r)?o.write({},s):null).filter(o=>!!o);t[i]=n.toArray()}verifyWriteLayer(e,t){return"write"in e||(t&&t.messages&&t.messages.push(new q("layer:unsupported",`Layers (${e.title}, ${e.id}) of type '${e.declaredClass}' cannot be persisted in web scenes`,{layer:e})),!1)}readSourceVersion(e,t){const[i,r]=t.version.split(".");return new WF(parseInt(i,10),parseInt(r,10))}writeSourceVersion(e,t,i){t[i]=`${bS.major}.${bS.minor}`}get thumbnailUrl(){return this.portalItem&&this.portalItem.thumbnailUrl||null}set thumbnailUrl(e){e?this._override("thumbnailUrl",e):(this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}set authoringApp(e){this._isAuthoringAppSetByUser=!0,this._set("authoringApp",e)}writeAuthoringApp(e,t){e&&this._isAuthoringAppSetByUser?t.authoringApp=e:t.authoringApp="ArcGIS API for JavaScript"}set authoringAppVersion(e){this._isAuthoringAppVersionSetByUser=!0,this._set("authoringAppVersion",e)}writeAuthoringAppVersion(e,t){e&&this._isAuthoringAppVersionSetByUser?t.authoringAppVersion=e:t.authoringAppVersion=wq}writeGround(e,t,i,r){t[i]=e?e.write({},r):{transparency:0,layers:[]}}readInitialViewProperties(e,t){const i={};return t.initialState&&t.initialState.environment&&(i.environment=n2.fromJSON(t.initialState.environment)),t.spatialReference?i.spatialReference=Xe.fromJSON(t.spatialReference):i.spatialReference=Xe.WebMercator,i.viewingMode=t.viewingMode||"global",t.initialState&&t.initialState.viewpoint&&(i.viewpoint=sc.fromJSON(t.initialState.viewpoint)),new qF(i)}get spatialReference(){var e,t;return(t=(e=this.initialViewProperties)==null?void 0:e.spatialReference)!=null?t:Xe.WebMercator}get viewingMode(){var e,t;return(t=(e=this.initialViewProperties)==null?void 0:e.viewingMode)!=null?t:"global"}load(e){return this.addResolvingPromise(this._loadFromSource()),Promise.resolve(this)}loadAll(){return wX(this,e=>{const t=this.presentation&&this.presentation.slides;e(this.ground,this.basemap,this.layers,t&&t.map(i=>i.basemap))})}read(e,t){t=ve(F({},t),{origin:"web-scene"});const i=this._isAuthoringAppVersionSetByUser,r=this._isAuthoringAppSetByUser;if(Hce(this,e,s=>super.read(e,s),t),r||(this._isAuthoringAppSetByUser=!1),i||(this._isAuthoringAppVersionSetByUser=!1),e.baseMap&&Array.isArray(e.baseMap.elevationLayers)&&this.sourceVersion.supportsVisibleElevationLayersInSlides){const s=e.baseMap.elevationLayers.map(l=>({id:l.id})),n=this.presentation.slides,o=(l,c)=>l.visibleLayers.some(h=>h.id===c),a=s.filter(l=>!n.some(c=>o(c,l.id)));n.forEach(l=>{l.visibleLayers.addMany(a)})}}_writeBasemapElevationLayers(e){const t=e.ground&&e.ground.layers;!e.baseMap&&t&&t.length&&(e.baseMap={title:"Basemap",baseMapLayers:[]}),e.baseMap&&(e.baseMap.elevationLayers=te(t))}write(e,t){if(this.loadStatus!=="loaded"){const s=new q("webscene:not-loaded","Web scene must be loaded before it can be serialized");throw Cx.error("#toJSON()","Web scene must be loaded before it can be serialized",this.loadError||this.loadStatus),s}this._runLayersIdGC();const i=!(t==null?void 0:t.messages);t=ve(F({messages:[]},t),{origin:"web-scene"});const r=super.write(e,t);if(i){const s=t.messages.filter(n=>n.name==="web-document-write:property-required");if(s.length){const n=new q("web-document:property-required","One or more properties that are required in the webscene JSON are missing, see details for the specific errors",{errors:s});throw Cx.error("#toJSON()","One or more properties that are required in the webscene JSON are missing",s),n}}return this._writeBasemapElevationLayers(r),r}async save(e){return this._debouncedSaveOperations(WT.SAVE,e)}async _saveImpl(e){this.portalItem||(Cx.error("save(): requires the .portalItem property to be set"),await Promise.reject(new q("webscene:portal-item-not-set","Portal item to save to has not been set on the WebScene"))),this.portalItem.type!==WV&&await Promise.reject(new q("webscene:portal-item-wrong-type",`Portal item needs to have type "${WV}"`));const t=this._updateFromPromise;await this._ensureLoadBeforeSave();const i=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:this.portalItem.itemUrl&&hn(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||Kn.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),r=this.write({},i);return await Promise.all(i.resources.pendingOperations),await this._verifySave(r,i,e),this._updateTypeKeywords(this.portalItem),await this.portalItem.update({data:r}),await ole(this.resourceReferences,i,null),nle(i),t&&await t,await this._saveThumbnail(),this.portalItem}async saveAs(e,t){return this._debouncedSaveOperations(WT.SAVE_AS,t,e)}async _saveAsImpl(e,t){let i=e2.from(e);i||(Cx.error("saveAs(portalItem): requires a portal item parameter"),await Promise.reject(new q("webscene:portal-item-required","saveAs requires a portal item to save to"))),i.id&&(i=i.clone(),i.id=null);const r=i.portal||Kn.getDefault();await this._ensureLoadBeforeSave(),i.type=WV,i.portal=r;const s=this._enableVerifyItemRelativeUrls({origin:"web-scene",url:null,messages:[],portal:r,portalItem:i,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}}),n=this.write({},s);await Promise.all(s.resources.pendingOperations),await this._verifySaveAs(n,s,t);const o=this.thumbnailUrl,a=!this._isOverridden("thumbnailUrl");return this._updateTypeKeywords(i),await r._signIn(),await r.user.addItem({item:i,folder:t&&t.folder,data:n}),await ole(this.resourceReferences,s,null),this.portalItem=i,RG.prototype.read.call(this,{version:n.version,authoringApp:n.authoringApp,authoringAppVersion:n.authoringAppVersion},{name:"web-scene",ignoreDefaults:!0,url:i.itemUrl&&hn(i.itemUrl)}),nle(s),o&&(this.thumbnailUrl=a?vq(o,"w","8192"):o),s.portalItem=i,await this._saveThumbnail(),i}async _saveThumbnail(){this._isOverridden("thumbnailUrl")&&(await this.portalItem.updateThumbnail({thumbnail:this.thumbnailUrl}),this._clearOverride("thumbnailUrl"),this.clear("thumbnailUrl","user"))}_verifySave(e,t,i,r=!1){if(!RS(this.spatialReference))return Promise.reject(new q("webscene:unsupported-spatial-reference","Webscenes using spatial reference systems from Mars or Moon can not be saved currently."));let s,n=t.messages.filter(a=>a.type==="error").map(a=>new q(a.name,a.message,a.details));t.blockedRelativeUrls&&(n=n.concat(t.blockedRelativeUrls.map(a=>new q("url:unsupported",`Relative url '${a}' is not supported in Web Scene`)))),i&&i.ignoreUnsupported&&(n=n.filter(a=>a.name!=="layer:unsupported"&&a.name!=="symbol:unsupported"&&a.name!=="symbol-layer:unsupported"&&a.name!=="property:unsupported"&&a.name!=="url:unsupported"&&a.name!=="scenemodification:unsupported")),(i==null?void 0:i.requiredPropertyChecksDisabled)&&(n=n.filter(a=>a.name!=="web-document-write:property-required"));const o=i&&i.strictSchemaValidationEnabled;return s=o?import("./schemaValidator.5b80f5de.js").then(a=>{const l=a.validate(e);if(l.length>0){const c=`webscene did not validate:
${l.join(`
`)}`;Cx.error(`${r?"saveAs":"save"}(): ${c}`)}return l.map(c=>new q("webscene:schema-validation",c))}).then(a=>{if(o&&a.length>0)throw tyt(a.concat(n));return n}):Promise.resolve(n),s.then(a=>{if(a.length>0)throw new q("webscene:save","Failed to save webscene due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:a})})}_verifySaveAs(e,t,i){return this.canNotSaveAs(t)?Promise.reject(eyt()):this._verifySave(e,t,i,!0)}verifySaveAs(e){const t=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),i=this.write({},t);return this._verifySaveAs(i,t,e)}canNotSaveAs(e){return e||(e=this._enableVerifyItemRelativeUrls({origin:"web-scene",messages:[]}),this.write({},e)),e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.length>0}async updateFrom(e,t={}){const i=this._updateFrom(e,t);this._updateFromPromise=i,await i,this._updateFromPromise===i&&(this._updateFromPromise=null)}async _updateFrom(e,t={}){if(await e.whenReady(),!t.environmentExcluded&&e.environment&&(this.initialViewProperties.environment=n2.prototype.clone.apply(e.environment)),!t.viewpointExcluded&&e.viewpoint&&(this.initialViewProperties.viewpoint=e.viewpoint.clone()),this.initialViewProperties.spatialReference=e.spatialReference.clone(),this.initialViewProperties.viewingMode=e.viewingMode,_(e.clippingArea)?e.clippingArea!==this.clippingArea&&(this.clippingArea=e.clippingArea.clone(),this.clippingEnabled=!0):this.clippingEnabled=!1,e.heightModelInfo&&(this.heightModelInfo=e.heightModelInfo.clone()),e.map===this)for(const i of e.allLayerViews){const r="visible";r in i&&r in i.layer&&i._isOverridden(r)&&(i.layer[r]=i[r])}(t.thumbnailExcluded===!1||t.thumbnailExcluded==null&&!t.viewpointExcluded)&&await this._updateFromThumbnail(e,t.thumbnailSize||void 0)}async _updateFromThumbnail(e,t){const i=uyt(e,t),r=await e.takeScreenshot({format:"jpg",width:i.width,height:i.height,disableDecorations:!0});this.thumbnailUrl=r.dataUrl}_loadFromSource(){return this.resourceInfo?this._loadFromJSON(this.resourceInfo,{origin:"web-scene"}):this.portalItem&&this.portalItem.id?this._loadFromItem(this.portalItem):this._loadObjectsWithLayers()}_readAndLoadFromJSON(e,t){const i=this._validateJSON(e);return this.read(i,t),this._loadFromJSON(i,t)}_extractOperationalLayers(e){const t=[];if(!this.sourceVersion.supportsGround&&e.baseMap&&Array.isArray(e.baseMap.elevationLayers))for(const s of e.baseMap.elevationLayers)t.push(s);const i=[],r=s=>(s.layers&&(s.layers=s.layers.filter(r)),s.layerType!=="ArcGISTiledElevationServiceLayer"||(this.sourceVersion.supportsGround||i.push(s),!1));return{operationalLayers:e.operationalLayers?e.operationalLayers.filter(r):[],operationalElevationLayers:i,basemapElevationLayers:t}}_loadFromJSON(e,t){const i=new at;return this._validateSpatialReference().then(()=>this._validateHeightModelInfo()).then(()=>import("./layersCreator.f5e21211.js")).then(({populateOperationalLayers:r})=>{const{operationalLayers:s,operationalElevationLayers:n,basemapElevationLayers:o}=this._extractOperationalLayers(e),a=[],l={context:ve(F({},t),{layerContainerType:"operational-layers"})};if(this.portalItem&&(l.context.portal=this.portalItem.portal||Kn.getDefault()),o.length>0){const c=ve(F({},l),{context:ve(F({},l.context),{layerContainerType:"ground"})});c.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(r(this.ground.layers,o,c))}if(n.length>0){const c=ve(F({},l),{context:ve(F({},l.context),{layerContainerType:"ground"})});c.defaultLayerType="ArcGISTiledElevationServiceLayer",a.push(r(i,n,c))}return s&&s.length>0&&a.push(r(this.layers,s,l)),pn(a).then(()=>{})}).then(()=>this._loadObjectsWithLayers()).then(()=>{this.ground.layers.addMany(i)})}async _ensureLoadBeforeSave(){await this.load(),await this._loadObjectsWithLayers();const e=[];for(const t of this.allLayers.items)if("beforeSave"in t&&typeof t.beforeSave=="function"){const i=t.beforeSave();i&&e.push(i)}await pn(e)}async _loadObjectsWithLayers(){const e=[];this.ground&&e.push(this.ground.load()),this.basemap&&e.push(this.basemap.load()),this.presentation.slides.forEach(t=>{t.basemap&&e.push(t.basemap.load())}),await pn(e)}async _loadFromItem(e){if(await e.load().catch(r=>{throw new q("webscene:load-portal-item","Failed to load portal item",{error:r})}),e.type!=="Web Scene")throw new q("webscene:invalid-portal-item","Invalid portal item type '${type}', expected 'Web Scene'",{type:e.type});const t=await e.fetchData();this.resourceInfo=t;const i={origin:"web-scene",url:hn(e.itemUrl),portal:e.portal||Kn.getDefault(),portalItem:e,readResourcePaths:[]};await this._readAndLoadFromJSON(t,i),this.resourceReferences={portalItem:e,paths:i.readResourcePaths}}_validateSpatialReference(){const e=this.initialViewProperties,t=this._sceneSpatialReference;let i;if(e.viewingMode!=="local"){if(!w2(t,Ve.Global))return Promise.reject(new q("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in global mode, only Web Mercator, WGS84 GCS or CGCS2000 are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=a=>!a||bg(a,t)}else{if(!w2(t,Ve.Local))return Promise.reject(new q("webscene:unsupported-spatial-reference","Unsupported spatial reference (${spatialReference.wkid}) in local mode, only projected coordinate systems are supported",{spatialReference:t,viewingMode:e.viewingMode}));i=a=>!a||a.equals(t)}const r=a=>a&&(_(a.camera)&&a.camera.position&&a.camera.position.spatialReference||_(a.targetGeometry)&&a.targetGeometry.spatialReference),s=e.viewpoint,n=r(s);if(n&&!i(n))return Promise.reject(new q("webscene:incompatible-camera-spatial-reference","Camera spatial reference (${cameraSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{cameraSpatialReference:n,sceneSpatialReference:t,viewingMode:e.viewingMode}));const o=this.presentation.slides.find(a=>!i(r(a.viewpoint)));if(o){const a=r(o.viewpoint);return Promise.reject(new q("webscene:incompatible-slide-spatial-reference","Slide spatial reference (${slideSpatialReference.wkid}) is incompatible with the scene spatial reference (${sceneSpatialReference.wkid})",{slideSpatialReference:a,sceneSpatialReference:t,viewingMode:e.viewingMode}))}return Promise.resolve()}_validateHeightModelInfo(){const e=this._sceneSpatialReference,t=T9e(this.heightModelInfo,e);return t?Promise.reject(t):Promise.resolve()}_validateJSON(e){const t=WF.parse(e.version||"","webscene");return bS.validate(t),e.version=`${t.major}.${t.minor}`,t.major===1&&t.minor<=2&&(e.spatialReference=Xe.WebMercator.toJSON()),e}_updateTypeKeywords(e){this.initialViewProperties.viewingMode==="local"?e.typeKeywords?e.typeKeywords.includes(E$)||e.typeKeywords.push(E$):e.typeKeywords=[E$]:this.initialViewProperties.viewingMode==="global"&&e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter(t=>t!==E$)),e.typeKeywords&&(e.typeKeywords=e.typeKeywords.filter((t,i,r)=>r.indexOf(t)===i))}get _sceneSpatialReference(){return this.initialViewProperties.spatialReference||Xe.WebMercator}get _verifyItemRelativeRootPath(){return this.portalItem&&this.portalItem.itemUrl?hn(this.portalItem.itemUrl).path:null}_enableVerifyItemRelativeUrls(e){const t=this._verifyItemRelativeRootPath;return t&&(e.verifyItemRelativeUrls={rootPath:t,writtenUrls:[]}),e}_unscheduleLayersIdGC(){this._layersIdGCTimeoutId&&(clearTimeout(this._layersIdGCTimeoutId),this._layersIdGCTimeoutId=0)}_scheduleLayersIdGC(){this._unscheduleLayersIdGC(),this._layersIdGCTimeoutId=setTimeout(()=>{this._layersIdGCTimeoutId=0,this._runLayersIdGC()},3e3)}_runLayersIdGC(){this._unscheduleLayersIdGC();const e=this.applicationProperties&&this.applicationProperties.viewing&&this.applicationProperties.viewing.search,t=r=>this.allLayers.some(s=>s.id===r);e&&e.layers&&(e.layers=e.layers.filter(r=>t(r.id)));const i=this.presentation&&this.presentation.slides;i&&i.forEach(r=>{r.visibleLayers&&(r.visibleLayers=r.visibleLayers.filter(s=>t(s.id)))})}static fromJSON(e){if(!e)throw new q("webscene:empty-resource","Expected a JSON resource but got nothing");return new this({resourceInfo:e})}};var WT;Gi.VERSION=bS,u([d({type:yyt,json:{write:!0}})],Gi.prototype,"applicationProperties",void 0),u([d({json:{read:{source:"baseMap"},write:{target:"baseMap"}}})],Gi.prototype,"basemap",void 0),u([d({type:ci,json:{read:{source:"clippingArea.geometry",reader:yf},write:{target:"clippingArea.geometry"}}})],Gi.prototype,"clippingArea",void 0),u([Be("clippingArea")],Gi.prototype,"writeClippingArea",null),u([d({type:Boolean,json:{write:{target:"clippingArea.clip"}}})],Gi.prototype,"clippingEnabled",void 0),u([ke("clippingEnabled",["clippingArea"])],Gi.prototype,"readClippingEnabled",null),u([Be("clippingEnabled")],Gi.prototype,"writeClippingEnabled",null),u([d({type:Qgt,json:{read:{source:"mapFloorInfo"},write:{target:"mapFloorInfo"}}})],Gi.prototype,"floorInfo",void 0),u([d({type:Nv,json:{write:!0}})],Gi.prototype,"heightModelInfo",void 0),u([d({json:{write:{target:"operationalLayers",ignoreOrigin:!0}}})],Gi.prototype,"layers",void 0),u([Be("layers")],Gi.prototype,"writeLayers",null),u([d({readOnly:!0,type:WF,json:{type:Syt(),write:{ignoreOrigin:!0,target:"version",isRequired:!0,overridePolicy:()=>({enabled:!0,allowNull:!0,ignoreOrigin:!0})}}})],Gi.prototype,"sourceVersion",void 0),u([ke("sourceVersion",["version"])],Gi.prototype,"readSourceVersion",null),u([Be("sourceVersion")],Gi.prototype,"writeSourceVersion",null),u([d({json:{read:!1,write:!1}})],Gi.prototype,"tables",void 0),u([d()],Gi.prototype,"thumbnailUrl",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Gi.prototype,"authoringApp",null),u([Be("authoringApp")],Gi.prototype,"writeAuthoringApp",null),u([d({type:String,json:{write:{writerEnsuresNonNull:!0,ignoreOrigin:!0}}})],Gi.prototype,"authoringAppVersion",null),u([Be("authoringAppVersion")],Gi.prototype,"writeAuthoringAppVersion",null),u([d({json:{write:{isRequired:!0,allowNull:!0,ignoreOrigin:!0,enabled:!0}}})],Gi.prototype,"ground",void 0),u([Be("ground")],Gi.prototype,"writeGround",null),u([d({type:at.ofType(Tyt),json:{write:!0}})],Gi.prototype,"transportationNetworks",void 0),u([d({type:QTe,nonNullable:!0,json:{write:{ignoreOrigin:!0,writer:(e,t,i,r)=>{if(e.slides&&e.slides.length>0){const s=ve(F({},r),{isPresentation:!0});t.presentation=e.write({},s)}}}}})],Gi.prototype,"presentation",void 0),u([d({type:qF,nonNullable:!0,json:{write:{target:"initialState",isRequired:!0,ignoreOrigin:!0},default:()=>new qF({viewingMode:"global",spatialReference:Xe.WebMercator})}})],Gi.prototype,"initialViewProperties",void 0),u([ke("initialViewProperties",["initialState.environment","spatialReference","viewingMode","initialState.viewpoint"])],Gi.prototype,"readInitialViewProperties",null),u([d({type:Xe,json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Gi.prototype,"spatialReference",null),u([d({type:["local","global"],json:{read:!1,write:{isRequired:!0,ignoreOrigin:!0}}})],Gi.prototype,"viewingMode",null),u([d({type:e2})],Gi.prototype,"portalItem",void 0),u([d()],Gi.prototype,"resourceInfo",void 0),Gi=u([P("esri.WebScene")],Gi),function(e){e[e.SAVE=0]="SAVE",e[e.SAVE_AS=1]="SAVE_AS"}(WT||(WT={}));const gbt=Gi;/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.0-beta.82
 */function Eyt(e){return e.map(t=>{let i="";for(let r=0;r<t;r++)i+=((1+Math.random())*65536|0).toString(16).substring(1);return i}).join("-")}const Cyt=()=>Eyt([2,1,1,1,3]);/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.0.0-beta.82
 */const Ayt='@charset "UTF-8";@-webkit-keyframes in{0%{opacity:0}100%{opacity:1}}@keyframes in{0%{opacity:0}100%{opacity:1}}@-webkit-keyframes in-down{0%{opacity:0;-webkit-transform:translate3D(0, -5px, 0);transform:translate3D(0, -5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@keyframes in-down{0%{opacity:0;-webkit-transform:translate3D(0, -5px, 0);transform:translate3D(0, -5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@-webkit-keyframes in-up{0%{opacity:0;-webkit-transform:translate3D(0, 5px, 0);transform:translate3D(0, 5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@keyframes in-up{0%{opacity:0;-webkit-transform:translate3D(0, 5px, 0);transform:translate3D(0, 5px, 0)}100%{opacity:1;-webkit-transform:translate3D(0, 0, 0);transform:translate3D(0, 0, 0)}}@-webkit-keyframes in-scale{0%{opacity:0;-webkit-transform:scale3D(0.95, 0.95, 1);transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;-webkit-transform:scale3D(1, 1, 1);transform:scale3D(1, 1, 1)}}@keyframes in-scale{0%{opacity:0;-webkit-transform:scale3D(0.95, 0.95, 1);transform:scale3D(0.95, 0.95, 1)}100%{opacity:1;-webkit-transform:scale3D(1, 1, 1);transform:scale3D(1, 1, 1)}}:root{--calcite-animation-timing:calc(150ms * var(--calcite-internal-duration-factor));--calcite-internal-duration-factor:var(--calcite-duration-factor, 1);--calcite-internal-animation-timing-fast:calc(100ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-medium:calc(200ms * var(--calcite-internal-duration-factor));--calcite-internal-animation-timing-slow:calc(300ms * var(--calcite-internal-duration-factor))}.calcite-animate{opacity:0;-webkit-animation-fill-mode:both;animation-fill-mode:both;-webkit-animation-duration:var(--calcite-animation-timing);animation-duration:var(--calcite-animation-timing)}.calcite-animate__in{-webkit-animation-name:in;animation-name:in}.calcite-animate__in-down{-webkit-animation-name:in-down;animation-name:in-down}.calcite-animate__in-up{-webkit-animation-name:in-up;animation-name:in-up}.calcite-animate__in-scale{-webkit-animation-name:in-scale;animation-name:in-scale}:root{--calcite-popper-transition:var(--calcite-animation-timing)}:host([hidden]){display:none}:host{position:relative;margin-left:auto;margin-right:auto;display:none;-ms-flex-align:center;align-items:center;-ms-flex-pack:center;justify-content:center;padding-top:4rem;padding-bottom:4rem;opacity:1;min-height:var(--calcite-loader-size);font-size:var(--calcite-loader-font-size);stroke:var(--calcite-ui-brand);stroke-width:3;fill:none;-webkit-transform:scale(1, 1);transform:scale(1, 1);animation:loader-color-shift 6s alternate-reverse infinite linear}:host([scale=s]){--calcite-loader-font-size:var(--calcite-font-size--2);--calcite-loader-size:2rem;--calcite-loader-size-inline:0.75rem}:host([scale=m]){--calcite-loader-font-size:var(--calcite-font-size-0);--calcite-loader-size:4rem;--calcite-loader-size-inline:1rem}:host([scale=l]){--calcite-loader-font-size:var(--calcite-font-size-2);--calcite-loader-size:6rem;--calcite-loader-size-inline:1.5rem}:host([no-padding]){padding-top:0px;padding-bottom:0px}:host{display:none}:host([active]){display:-ms-flexbox;display:flex}.loader__text{display:block;text-align:center;font-size:var(--calcite-font-size--2);line-height:1rem;color:var(--calcite-ui-text-1);margin-top:calc(var(--calcite-loader-size) + 1.5rem)}.loader__percentage{position:absolute;display:block;text-align:center;color:var(--calcite-ui-text-1);font-size:var(--calcite-loader-font-size);width:var(--calcite-loader-size);left:50%;margin-left:calc(var(--calcite-loader-size) / 2 * -1);line-height:0.25;-webkit-transform:scale(1, 1);transform:scale(1, 1)}.loader__svgs{position:absolute;overflow:visible;opacity:1;width:var(--calcite-loader-size);height:var(--calcite-loader-size);left:50%;margin-left:calc(var(--calcite-loader-size) / 2 * -1);-webkit-transform:scale(1, 1);transform:scale(1, 1)}.loader__svg{position:absolute;top:0px;left:0px;-webkit-transform-origin:center;transform-origin:center;overflow:visible;width:var(--calcite-loader-size);height:var(--calcite-loader-size);-webkit-animation-iteration-count:infinite;animation-iteration-count:infinite;-webkit-animation-timing-function:linear;animation-timing-function:linear;-webkit-animation-name:loader-clockwise;animation-name:loader-clockwise}@supports (display: grid){.loader__svg--1{-webkit-animation-name:loader-offset-1;animation-name:loader-offset-1}.loader__svg--2{-webkit-animation-name:loader-offset-2;animation-name:loader-offset-2}.loader__svg--3{-webkit-animation-name:loader-offset-3;animation-name:loader-offset-3}}:host([type=determinate]){-webkit-animation:none;animation:none;stroke:var(--calcite-ui-border-3)}:host([type=determinate]) .loader__svg--3{-webkit-animation:none;animation:none;stroke:var(--calcite-ui-brand);stroke-dasharray:150.79632;-webkit-transform:rotate(-90deg);transform:rotate(-90deg);-webkit-transition:all var(--calcite-internal-animation-timing-fast) linear;transition:all var(--calcite-internal-animation-timing-fast) linear}:host([inline]){position:relative;margin:0px;-webkit-animation:none;animation:none;stroke:currentColor;stroke-width:2;padding-top:0px;padding-bottom:0px;height:var(--calcite-loader-size-inline);min-height:var(--calcite-loader-size-inline);width:var(--calcite-loader-size-inline);-webkit-margin-end:calc(var(--calcite-loader-size-inline) * 0.5);margin-inline-end:calc(var(--calcite-loader-size-inline) * 0.5);vertical-align:calc(var(--calcite-loader-size-inline) * -1 * 0.2)}:host([active][inline]){display:inline-block}:host([inline]) .loader__svgs{top:0px;left:0px;margin:0px;width:var(--calcite-loader-size-inline);height:var(--calcite-loader-size-inline)}:host([inline]) .loader__svg{width:var(--calcite-loader-size-inline);height:var(--calcite-loader-size-inline)}:host([complete]){opacity:0;-webkit-transform:scale(0.75, 0.75);transform:scale(0.75, 0.75);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, transform var(--calcite-internal-animation-timing-medium) linear 1000ms;transition:opacity var(--calcite-internal-animation-timing-medium) linear 1000ms, transform var(--calcite-internal-animation-timing-medium) linear 1000ms, -webkit-transform var(--calcite-internal-animation-timing-medium) linear 1000ms}:host([complete]) .loader__svgs{opacity:0;-webkit-transform:scale(0.75, 0.75);transform:scale(0.75, 0.75);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms;transition:opacity calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms, -webkit-transform calc(180ms * var(--calcite-internal-duration-factor)) linear 800ms}:host([complete]) .loader__percentage{color:var(--calcite-ui-brand);-webkit-transform:scale(1.05, 1.05);transform:scale(1.05, 1.05);-webkit-transform-origin:center;transform-origin:center;-webkit-transition:color var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, transform var(--calcite-internal-animation-timing-medium) linear;transition:color var(--calcite-internal-animation-timing-medium) linear, transform var(--calcite-internal-animation-timing-medium) linear, -webkit-transform var(--calcite-internal-animation-timing-medium) linear}.loader__svg--1{stroke-dasharray:27.9252444444% 139.6262222222%;-webkit-animation-duration:0.72s;animation-duration:0.72s}@-webkit-keyframes loader-offset-1{0%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-83.7757333333%}100%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-1{0%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-83.7757333333%}100%{stroke-dasharray:27.9252444444% 251.3272%;stroke-dashoffset:-279.2524444444%}}.loader__svg--2{stroke-dasharray:55.8504888889% 139.6262222222%;-webkit-animation-duration:0.96s;animation-duration:0.96s}@-webkit-keyframes loader-offset-2{0%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-97.7383555556%}100%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-2{0%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-97.7383555556%}100%{stroke-dasharray:55.8504888889% 223.4019555556%;stroke-dashoffset:-279.2524444444%}}.loader__svg--3{stroke-dasharray:13.9626222222% 139.6262222222%;-webkit-animation-duration:1.16s;animation-duration:1.16s}@-webkit-keyframes loader-offset-3{0%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-76.7944222222%}100%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:-279.2524444444%}}@keyframes loader-offset-3{0%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:0}50%{stroke-dasharray:139.6262222222% 139.6262222222%;stroke-dashoffset:-76.7944222222%}100%{stroke-dasharray:13.9626222222% 265.2898222222%;stroke-dashoffset:-279.2524444444%}}@-webkit-keyframes loader-color-shift{0%{stroke:var(--calcite-ui-brand)}33%{stroke:var(--calcite-ui-brand-press)}66%{stroke:var(--calcite-ui-brand-hover)}100%{stroke:var(--calcite-ui-brand)}}@keyframes loader-color-shift{0%{stroke:var(--calcite-ui-brand)}33%{stroke:var(--calcite-ui-brand-press)}66%{stroke:var(--calcite-ui-brand-hover)}100%{stroke:var(--calcite-ui-brand)}}@-webkit-keyframes loader-clockwise{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}@keyframes loader-clockwise{0%{-webkit-transform:rotate(0deg);transform:rotate(0deg)}100%{-webkit-transform:rotate(360deg);transform:rotate(360deg)}}',Ryt=TDe(class extends V$e{constructor(){super();this.__registerHost(),this.__attachShadow(),this.active=!1,this.inline=!1,this.scale="m",this.value=0,this.text="",this.noPadding=!1}render(){const{el:e,inline:t,label:i,scale:r,text:s,type:n,value:o}=this,a=e.id||Cyt(),l=.45,c=t?this.getInlineSize(r):this.getSize(r),h=c*l,p=`0 0 ${c} ${c}`,f=n==="determinate",m=2*h*Math.PI,y=o/100*m,v=m-y,w=Math.floor(o),b={"aria-valuenow":w,"aria-valuemin":0,"aria-valuemax":100,complete:w===100},S={r:h,cx:c/2,cy:c/2},T={"stroke-dasharray":`${y} ${v}`};return Wu(vfe,Object.assign({"aria-label":i,id:a,role:"progressbar"},f?b:{}),Wu("div",{class:"loader__svgs"},Wu("svg",{class:"loader__svg loader__svg--1",viewBox:p},Wu("circle",Object.assign({},S))),Wu("svg",{class:"loader__svg loader__svg--2",viewBox:p},Wu("circle",Object.assign({},S))),Wu("svg",Object.assign({class:"loader__svg loader__svg--3",viewBox:p},f?{style:T}:{}),Wu("circle",Object.assign({},S)))),s&&Wu("div",{class:"loader__text"},s),f&&Wu("div",{class:"loader__percentage"},o))}getSize(e){return{s:32,m:56,l:80}[e]}getInlineSize(e){return{s:12,m:16,l:20}[e]}get el(){return this}static get style(){return Ayt}},[1,"calcite-loader",{active:[516],inline:[516],label:[1],scale:[513],type:[513],value:[2],text:[1],noPadding:[4,"no-padding"]}]);function Myt(){if(typeof customElements=="undefined")return;["calcite-loader"].forEach(t=>{switch(t){case"calcite-loader":customElements.get(t)||customElements.define(t,Ryt);break}})}Myt();export{us as $,Gr as A,ae as B,p1t as C,f1t as D,hM as E,XQe as F,Eg as G,Cd as H,at as I,Ms as J,Th as K,o1t as L,g1t as M,q as N,n6e as O,A_t as P,_4 as Q,R_t as R,Dv as S,CO as T,rr as U,M_t as V,Rq as W,f4 as X,Sye as Y,WAe as Z,C_t as _,u as a,tot as a$,s1t as a0,M3e as a1,ol as a2,Af as a3,eot as a4,jJe as a5,nc as a6,li as a7,_H as a8,he as a9,rE as aA,mt as aB,Ds as aC,hbe as aD,pn as aE,Ws as aF,Hyt as aG,Yc as aH,Wn as aI,hv as aJ,Yr as aK,Id as aL,ie as aM,Js as aN,de as aO,oe as aP,nt as aQ,Bc as aR,yP as aS,r1t as aT,vJ as aU,J_t as aV,qJe as aW,v4 as aX,bg as aY,Lyt as aZ,fw as a_,C0t as aa,me as ab,Mh as ac,io as ad,zS as ae,xze as af,yt as ag,cr as ah,lq as ai,se as aj,xf as ak,hu as al,O as am,Ls as an,Tg as ao,ci as ap,r2 as aq,Bt as ar,d1t as as,h1t as at,E1t as au,XY as av,u1t as aw,c1t as ax,cl as ay,eo as az,L0 as b,B4 as b$,NY as b0,vf as b1,tX as b2,Qs as b3,F2 as b4,Dt as b5,Hwe as b6,A0t as b7,ar as b8,A4 as b9,Evt as bA,DVe as bB,e2 as bC,Kn as bD,OC as bE,Xe as bF,q0t as bG,AO as bH,hn as bI,Jc as bJ,lw as bK,C9e as bL,z_t as bM,Hlt as bN,$1t as bO,_Z as bP,mw as bQ,SO as bR,cc as bS,Wc as bT,Yd as bU,Nl as bV,TO as bW,Or as bX,A as bY,EH as bZ,ub as b_,D_t as ba,vg as bb,ihe as bc,cb as bd,LQ as be,rhe as bf,wot as bg,vi as bh,Vyt as bi,Ble as bj,zle as bk,Mi as bl,je as bm,Se as bn,ai as bo,hr as bp,Fd as bq,Jr as br,ur as bs,Je as bt,tr as bu,DF as bv,Ve as bw,Fpe as bx,C0 as by,Svt as bz,uf as c,sdt as c$,zi as c0,Wo as c1,Xs as c2,ui as c3,Zt as c4,Cs as c5,_t as c6,Pr as c7,O2 as c8,L_t as c9,Ut as cA,Gg as cB,h5 as cC,Vv as cD,pl as cE,D5 as cF,Jt as cG,Pf as cH,Ov as cI,Gv as cJ,F5 as cK,Gf as cL,L5 as cM,O5 as cN,ew as cO,J5 as cP,tet as cQ,UX as cR,uE as cS,K1e as cT,gs as cU,M4 as cV,qs as cW,Qht as cX,Tue as cY,n0t as cZ,xAe as c_,H$ as ca,aw as cb,Aat as cc,Bi as cd,ou as ce,To as cf,di as cg,tpe as ch,x as ci,ls as cj,yu as ck,zt as cl,We as cm,J as cn,gF as co,Vf as cp,gt as cq,zf as cr,Re as cs,G as ct,or as cu,Qi as cv,Ho as cw,lr as cx,Ji as cy,Di as cz,d,Ch as d$,mze as d0,Oj as d1,ES as d2,lu as d3,IBe as d4,RG as d5,ke as d6,yr as d7,T_t as d8,Sf as d9,Dr as dA,Mqe as dB,abt as dC,j1t as dD,lbt as dE,sY as dF,jS as dG,DZ as dH,ibt as dI,J1t as dJ,K1t as dK,Q1t as dL,c9 as dM,o1e as dN,hc as dO,Bdt as dP,Z1t as dQ,Iht as dR,pE as dS,obt as dT,$ht as dU,W0t as dV,joe as dW,_S as dX,fb as dY,Nr as dZ,s3e as d_,EVe as da,Oye as db,FVe as dc,Eze as dd,$6e as de,oX as df,wO as dg,ct as dh,_i as di,AVe as dj,tce as dk,d4 as dl,FQ as dm,Kc as dn,lhe as dp,ql as dq,jg as dr,oxe as ds,QF as dt,Eb as du,l3e as dv,Ue as dw,sg as dx,mPe as dy,Ae as dz,gbt as e,ba as e$,hg as e0,Z0t as e1,fi as e2,Zs as e3,Wd as e4,W1t as e5,N3e as e6,Zht as e7,ab as e8,nbt as e9,Wi as eA,hbt as eB,V_t as eC,xS as eD,sr as eE,Oht as eF,xvt as eG,F1t as eH,gh as eI,te as eJ,r4 as eK,Yyt as eL,UM as eM,HR as eN,_u as eO,l1t as eP,Xve as eQ,Pd as eR,rJe as eS,pdt as eT,fdt as eU,G1t as eV,H0 as eW,fPe as eX,$s as eY,nr as eZ,xe as e_,qi as ea,j2 as eb,sbt as ec,It as ed,rdt as ee,Wge as ef,Xge as eg,a1t as eh,rbt as ei,Y1t as ej,X1t as ek,Iq as el,gN as em,sq as en,lk as eo,$e as ep,Ei as eq,Q4 as er,Gt as es,u0t as et,fe as eu,jq as ev,Me as ew,ubt as ex,cbt as ey,vu as ez,mbt as f,Uvt as f$,pe as f0,Ef as f1,LD as f2,sf as f3,ndt as f4,Yte as f5,q1t as f6,DQ as f7,N_t as f8,Pat as f9,i0t as fA,YRe as fB,Ice as fC,_q as fD,Ib as fE,KR as fF,Wgt as fG,P0 as fH,ru as fI,eMe as fJ,FS as fK,n4 as fL,pfe as fM,du as fN,D0t as fO,TT as fP,WA as fQ,K0 as fR,Cb as fS,yJ as fT,$Ne as fU,qvt as fV,PK as fW,Xvt as fX,s0t as fY,Yce as fZ,dCe as f_,N2e as fa,a2e as fb,wvt as fc,bf as fd,H3e as fe,q3e as ff,Be as fg,X0t as fh,bH as fi,fpe as fj,ECe as fk,ICe as fl,lb as fm,Mme as fn,vue as fo,zH as fp,Kyt as fq,ul as fr,k2 as fs,SW as ft,INe as fu,NS as fv,ac as fw,dme as fx,yf as fy,y4e as fz,Ca as g,vV as g$,Cme as g0,Rme as g1,Sme as g2,d0t as g3,X_t as g4,mue as g5,NCe as g6,t0t as g7,lc as g8,Ike as g9,e4e as gA,i1t as gB,Rr as gC,_me as gD,mye as gE,zv as gF,$et as gG,Us as gH,au as gI,Pt as gJ,qp as gK,Zr as gL,xi as gM,pt as gN,ze as gO,ft as gP,St as gQ,Ke as gR,xr as gS,Ma as gT,st as gU,Ra as gV,Ye as gW,Xi as gX,xo as gY,Sg as gZ,Kr as g_,$ke as ga,IO as gb,Z2 as gc,yme as gd,e1t as ge,gze as gf,S_t as gg,D2e as gh,h0t as gi,o0t as gj,l0t as gk,a0t as gl,c0t as gm,qR as gn,_h as go,wAe as gp,U1e as gq,Z_t as gr,HQe as gs,t1t as gt,the as gu,x0t as gv,Gyt as gw,D1t as gx,_0t as gy,h4 as gz,Ft as h,to as h$,hi as h0,HN as h1,kv as h2,P5 as h3,q_t as h4,tt as h5,Jn as h6,qde as h7,Q0t as h8,kpe as h9,gFe as hA,mFe as hB,Si as hC,H0t as hD,Wyt as hE,sv as hF,J0 as hG,rP as hH,WH as hI,qH as hJ,XH as hK,ume as hL,e0t as hM,Z1 as hN,k1t as hO,z1t as hP,S0t as hQ,uRe as hR,b1 as hS,U1t as hT,_F as hU,vv as hV,vr as hW,ag as hX,rl as hY,uc as hZ,Bg as h_,p_t as ha,o4 as hb,kvt as hc,Fyt as hd,Mn as he,QY as hf,ll as hg,ji as hh,C$ as hi,yue as hj,Xyt as hk,u_t as hl,Wvt as hm,y_t as hn,bq as ho,_g as hp,ij as hq,mO as hr,xh as hs,hvt as ht,U6e as hu,cw as hv,Uf as hw,SS as hx,MQ as hy,cme as hz,pw as i,R1t as i$,ht as i0,R0t as i1,OO as i2,wi as i3,gi as i4,qo as i5,nhe as i6,V1t as i7,B1t as i8,aq as i9,gg as iA,s4 as iB,Lq as iC,adt as iD,Rde as iE,H1t as iF,bCe as iG,Jxe as iH,Fe as iI,Ule as iJ,hk as iK,CS as iL,Oct as iM,xgt as iN,qB as iO,rs as iP,HB as iQ,XB as iR,fN as iS,A3e as iT,gb as iU,rde as iV,Kp as iW,M1t as iX,I1t as iY,axe as iZ,yoe as i_,aPe as ia,E4 as ib,W_t as ic,Ns as id,ti as ie,yi as ig,S1t as ih,ebt as ii,tbt as ij,nme as ik,sA as il,bpe as im,F2e as io,XN as ip,M3 as iq,N1t as ir,Noe as is,L1t as it,Zo as iu,oS as iv,XLe as iw,i2 as ix,oc as iy,hb as iz,BR as j,z4 as j$,O1t as j0,A1t as j1,IR as j2,oD as j3,Ilt as j4,Ph as j5,Pyt as j6,WX as j7,_a as j8,moe as j9,Cie as jA,$t as jB,lf as jC,nde as jD,POe as jE,JT as jF,R3e as jG,ei as jH,so as jI,Mr as jJ,kR as jK,y1t as jL,SAe as jM,Iyt as jN,Hs as jO,k0t as jP,U0t as jQ,VOe as jR,kOe as jS,tde as jT,V0t as jU,j0t as jV,G0t as jW,B0t as jX,rf as jY,yM as jZ,wo as j_,llt as ja,clt as jb,$_t as jc,mX as jd,I_t as je,Ot as jf,ys as jg,nh as jh,BM as ji,Pvt as jj,uu as jk,NNe as jl,cIe as jm,D3e as jn,lvt as jo,$3e as jp,we as jq,lt as jr,C2 as js,Db as jt,su as ju,Y0t as jv,nvt as jw,ovt as jx,EX as jy,y8 as jz,tq as k,s8 as k$,_vt as k0,bvt as k1,yvt as k2,vvt as k3,ms as k4,Hg as k5,Ta as k6,mZ as k7,yat as k8,VT as k9,uvt as kA,rGe as kB,aGe as kC,jB as kD,Xd as kE,Vr as kF,AX as kG,GAe as kH,He as kI,Is as kJ,avt as kK,CPe as kL,LH as kM,oh as kN,bQ as kO,pY as kP,Ff as kQ,Yn as kR,tl as kS,mb as kT,TWe as kU,H_t as kV,G_t as kW,j_t as kX,ivt as kY,smt as kZ,AS as k_,lj as ka,sw as kb,Oi as kc,nT as kd,Yde as ke,ro as kf,en as kg,Ya as kh,ZF as ki,uv as kj,Q9e as kk,jl as kl,wd as km,Bs as kn,M0e as ko,CX as kp,XT as kq,eA as kr,Og as ks,Xq as kt,qS as ku,ir as kv,rR as kw,I4 as kx,cvt as ky,Tb as kz,qe as l,dbt as l$,LQe as l0,QQe as l1,k_t as l2,j1 as l3,Kl as l4,z0t as l5,Yi as l6,Gte as l7,AH as l8,qm as l9,J0t as lA,Rd as lB,gu as lC,K5 as lD,$r as lE,Aa as lF,xa as lG,Pi as lH,fn as lI,r1e as lJ,evt as lK,sZe as lL,mu as lM,Qc as lN,nPe as lO,Kd as lP,h1e as lQ,S2 as lR,wS as lS,IY as lT,T4 as lU,$yt as lV,r2e as lW,svt as lX,UU as lY,vN as lZ,ggt as l_,Kve as la,gw as lb,Wq as lc,g0t as ld,rvt as le,w0t as lf,Bte as lg,Nf as lh,kq as li,Lde as lj,Cf as lk,Sr as ll,Mf as lm,xt as ln,Eo as lo,N5 as lp,I5 as lq,dt as lr,Vi as ls,E0t as lt,Pne as lu,qq as lv,cs as lw,gM as lx,F_t as ly,v0t as lz,H2 as m,Tde as m$,fbt as m0,pbt as m1,dH as m2,wH as m3,b0t as m4,P_ as m5,Vte as m6,Dp as m7,vO as m8,Zq as m9,Plt as mA,Pg as mB,QR as mC,Nv as mD,Aze as mE,PD as mF,Byt as mG,l6e as mH,Zyt as mI,Y_t as mJ,hCe as mK,m_t as mL,v6e as mM,qUe as mN,cAe as mO,$0t as mP,dVe as mQ,pVe as mR,fVe as mS,Z0e as mT,IX as mU,Q0e as mV,Dg as mW,Wl as mX,vs as mY,fu as mZ,t3 as m_,iM as ma,BS as mb,y0t as mc,iXe as md,Qq as me,yde as mf,VS as mg,dPe as mh,one as mi,ec as mj,Uv as mk,qPe as ml,wg as mm,D4 as mn,S7e as mo,K0t as mp,C1t as mq,e4 as mr,yw as ms,pu as mt,e3e as mu,hf as mv,dze as mw,Dze as mx,Bze as my,rX as mz,P as n,P_t as n$,Ks as n0,cU as n1,g3e as n2,b1t as n3,u2 as n4,Mv as n5,v1t as n6,w1t as n7,_1t as n8,Lit as n9,eAe as nA,RFe as nB,Yvt as nC,kFe as nD,bK as nE,vme as nF,Hvt as nG,sOe as nH,g_t as nI,VB as nJ,Fk as nK,Uk as nL,r8 as nM,i2e as nN,Uyt as nO,kyt as nP,Gc as nQ,Dvt as nR,zyt as nS,Vl as nT,Bvt as nU,Z4 as nV,Vxe as nW,Ai as nX,Cg as nY,eu as nZ,N0 as n_,kit as na,Nit as nb,Fit as nc,Uit as nd,YFe as ne,qFe as nf,Lvt as ng,jvt as nh,Gvt as ni,XFe as nj,wye as nk,CW as nl,v4e as nm,Ome as nn,Vvt as no,zvt as np,p0t as nq,f0t as nr,m0t as ns,t2e as nt,K_t as nu,IK as nv,Q_t as nw,sl as nx,HFe as ny,S6e as nz,ot as o,tv as o$,Ud as o0,zZ as o1,tvt as o2,xPe as o3,Jyt as o4,Qyt as o5,kRe as o6,JR as o7,gq as o8,P1t as o9,G2 as oA,__t as oB,x1t as oC,nrt as oD,US as oE,KA as oF,RB as oG,b_t as oH,gvt as oI,fvt as oJ,TDe as oK,V$e as oL,Wu as oM,vfe as oN,mvt as oO,pvt as oP,Za as oQ,Qa as oR,Vo as oS,ic as oT,kf as oU,uD as oV,cM as oW,qW as oX,LN as oY,Es as oZ,mke as o_,zl as oa,xH as ob,goe as oc,U_t as od,Ql as oe,ml as of,ue as og,mm as oh,u9 as oi,Qfe as oj,Ps as ok,Wle as ol,KT as om,mhe as on,P0t as oo,fO as op,Ii as oq,bh as or,g4 as os,N2 as ot,L0t as ou,P6e as ov,v_t as ow,h_t as ox,jRe as oy,O6e as oz,IQ as p,yF as p$,ya as p0,pke as p1,Eh as p2,lke as p3,ske as p4,rke as p5,Ub as p6,Vc as p7,Lge as p8,G4e as p9,Rke as pA,Mke as pB,oke as pC,ake as pD,hke as pE,Ske as pF,$W as pG,c_t as pH,tke as pI,ike as pJ,KUe as pK,JUe as pL,RT as pM,kxe as pN,iht as pO,KS as pP,aze as pQ,TGe as pR,B7e as pS,gve as pT,Eje as pU,Xje as pV,YX as pW,Jje as pX,yHe as pY,AHe as pZ,ZZe as p_,QUe as pa,eke as pb,Qt as pc,Dge as pd,tu as pe,fke as pf,cke as pg,_w as ph,BH as pi,gke as pj,yke as pk,vke as pl,jW as pm,bke as pn,_ke as po,wke as pp,wq as pq,lM as pr,WUe as ps,dke as pt,uke as pu,nke as pv,Oke as pw,Ake as px,Cke as py,o_t as pz,kS as q,dvt as q$,Net as q0,Vet as q1,Cet as q2,un as q3,Qn as q4,mct as q5,vTe as q6,Cpt as q7,U3 as q8,uk as q9,Qpt as qA,bTe as qB,eft as qC,wTe as qD,ift as qE,xTe as qF,gft as qG,IU as qH,Sft as qI,$ft as qJ,y4 as qK,O0t as qL,N0t as qM,qDe as qN,pme as qO,_9 as qP,j9 as qQ,F9 as qR,sP as qS,bd as qT,r4e as qU,eze as qV,tc as qW,WFe as qX,nle as qY,rW as qZ,n2e as q_,gRe as qa,Aje as qb,LJe as qc,Mvt as qd,Rvt as qe,Cvt as qf,ET as qg,FNe as qh,Avt as qi,Ovt as qj,LNe as qk,_O as ql,ntt as qm,Ivt as qn,$vt as qo,Tvt as qp,Tet as qq,vct as qr,yct as qs,bU as qt,_ct as qu,wF as qv,AKe as qw,lTe as qx,Ydt as qy,NZ as qz,_ as r,UN as r$,JKe as r0,vft as r1,Yft as r2,Ytt as r3,Vit as r4,rnt as r5,Cnt as r6,bnt as r7,pze as r8,Xze as r9,Qze as rA,OQ as rB,xue as rC,TVe as rD,aX as rE,a5 as rF,ite as rG,ED as rH,n5 as rI,Cze as rJ,hX as rK,Rye as rL,Jge as rM,wt as rN,n8 as rO,Nk as rP,REe as rQ,$Ve as rR,tE as rS,Zi as rT,zge as rU,jge as rV,KNe as rW,Jke as rX,eFe as rY,Yge as rZ,iye as r_,Wze as ra,Wue as rb,sze as rc,wX as rd,E_t as re,Mze as rf,Pze as rg,lze as rh,nX as ri,uze as rj,hze as rk,ole as rl,fv as rm,t9e as rn,KBe as ro,ZBe as rp,Ete as rq,Ea as rr,jR as rs,Rze as rt,Ih as ru,b4 as rv,Lv as rw,Uze as rx,fze as ry,yze as rz,jt as s,s_t as s$,qyt as s0,kge as s1,kN as s2,cze as s3,r0t as s4,Qr as s5,jyt as s6,Pb as s7,T0t as s8,Iv as s9,x_t as sA,rCe as sB,sQ as sC,L as sD,F0t as sE,Epe as sF,BPe as sG,zo as sH,n9e as sI,f_t as sJ,$8e as sK,Hye as sL,Xye as sM,c1 as sN,yX as sO,gX as sP,R8e as sQ,Zvt as sR,vX as sS,gVe as sT,yVe as sU,vVe as sV,n_t as sW,pee as sX,Qvt as sY,dee as sZ,Tke as s_,SH as sa,kx as sb,PVe as sc,YL as sd,mR as se,GB as sf,o0e as sg,Tf as sh,gf as si,Bue as sj,whe as sk,Nyt as sl,L6e as sm,iv as sn,Zee as so,LS as sp,eX as sq,$ze as sr,Ize as ss,U2 as st,Yhe as su,w_t as sv,zd as sw,M0t as sx,The as sy,Oze as sz,R as t,l_t as t0,a_t as t1,Kvt as t2,Jvt as t3,e_t as t4,t_t as t5,r_t as t6,ZUe as t7,mee as t8,i_t as t9,HY as tA,frt as tB,bwe as tC,lrt as tD,Swe as tE,xwe as tF,prt as tG,dj as tH,Twe as tI,xv as tJ,crt as tK,wv as tL,tj as tM,Wb as tN,ZJe as tO,Brt as tP,Vrt as tQ,zrt as tR,B_t as tS,TMe as tT,Nvt as tU,Fvt as tV,d_t as tW,O_t as tX,n1t as tY,T1t as tZ,xke as ta,r5 as tb,Fge as tc,Uge as td,fq as te,Au as tf,Dit as tg,m1t as th,Lf as ti,x7e as tj,Q3e as tk,Y3e as tl,of as tm,fwe as tn,TH as to,d7e as tp,I0t as tq,Ewe as tr,Awe as ts,RR as tt,B1 as tu,On as tv,fl as tw,Rh as tx,nx as ty,Dyt as tz,qt as u,cu as v,SR as w,l2 as x,Ee as y,E6e as z};

(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))i(s);new MutationObserver(s=>{for(const n of s)if(n.type==="childList")for(const o of n.addedNodes)o.tagName==="LINK"&&o.rel==="modulepreload"&&i(o)}).observe(document,{childList:!0,subtree:!0});function r(s){const n={};return s.integrity&&(n.integrity=s.integrity),s.referrerPolicy&&(n.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?n.credentials="include":s.crossOrigin==="anonymous"?n.credentials="omit":n.credentials="same-origin",n}function i(s){if(s.ep)return;s.ep=!0;const n=r(s);fetch(s.href,n)}})();const p4e="modulepreload",f4e=function(t,e){return new URL(t,e).href},ise={},J=function(e,r,i){if(!r||r.length===0)return e();const s=document.getElementsByTagName("link");return Promise.all(r.map(n=>{if(n=f4e(n,i),n in ise)return;ise[n]=!0;const o=n.endsWith(".css"),a=o?'[rel="stylesheet"]':"";if(!!i)for(let h=s.length-1;h>=0;h--){const p=s[h];if(p.href===n&&(!o||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${n}"]${a}`))return;const c=document.createElement("link");if(c.rel=o?"stylesheet":p4e,o||(c.as="script",c.crossOrigin=""),c.href=n,document.head.appendChild(c),o)return new Promise((h,p)=>{c.addEventListener("load",h),c.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${n}`)))})})).then(()=>e()).catch(n=>{const o=new Event("vite:preloadError",{cancelable:!0});if(o.payload=n,window.dispatchEvent(o),!o.defaultPrevented)throw n})};function u(t,e,r,i){var s,n=arguments.length,o=n<3?e:i===null?i=Object.getOwnPropertyDescriptor(e,r):i;if(typeof Reflect=="object"&&typeof Reflect.decorate=="function")o=Reflect.decorate(t,e,r,i);else for(var a=t.length-1;a>=0;a--)(s=t[a])&&(o=(n<3?s(o):n>3?s(e,r,o):s(e,r))||o);return n>3&&o&&Object.defineProperty(e,r,o),o}function wDt(t,e,r,i){function s(n){return n instanceof r?n:new r(function(o){o(n)})}return new(r||(r=Promise))(function(n,o){function a(h){try{c(i.next(h))}catch(p){o(p)}}function l(h){try{c(i.throw(h))}catch(p){o(p)}}function c(h){h.done?n(h.value):s(h.value).then(a,l)}c((i=i.apply(t,e||[])).next())})}let PM=class cw{constructor(e=1){this._seed=e}set seed(e){this._seed=e??Math.random()*cw._m}getInt(){return this._seed=(cw._a*this._seed+cw._c)%cw._m,this._seed}getFloat(){return this.getInt()/(cw._m-1)}getIntRange(e,r){return Math.round(this.getFloatRange(e,r))}getFloatRange(e,r){const i=r-e;return e+this.getInt()/cw._m*i}};PM._m=2147483647,PM._a=48271,PM._c=0;const v6=1.5,m4e=1/v6,g4e=.5;function b6(t,e){return e?t.filter((r,i,s)=>s.findIndex(e.bind(null,r))===i):t.filter((r,i,s)=>s.indexOf(r)===i)}function T0(t,e,r){if(t==null&&e==null)return!0;if(t==null||e==null||t.length!==e.length)return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function AJ(t,e){let r=t.length!==e.length;r&&(t.length=e.length);for(let i=0;i<e.length;++i)t[i]!==e[i]&&(t[i]=e[i],r=!0);return r}function y4e(t,e,r){let i,s;return r?(i=e.filter(n=>!t.some(o=>r(o,n))),s=t.filter(n=>!e.some(o=>r(o,n)))):(i=e.filter(n=>!t.includes(n)),s=t.filter(n=>!e.includes(n))),{added:i,removed:s}}function _4e(t){return t&&typeof t.length=="number"}function v4e(t,e){const r=t.length;if(r===0)return[];const i=[];for(let s=0;s<r;s+=e)i.push(t.slice(s,s+e));return i}const b4e=!!Array.prototype.fill;function xDt(t,e){if(b4e)return new Array(t).fill(e);const r=new Array(t);for(let i=0;i<t;i++)r[i]=e;return r}function w4e(t,e){e===void 0&&(e=t,t=0);const r=new Array(e-t);for(let i=t;i<e;i++)r[i-t]=i;return r}function U0e(t,e,r){const i=t.length;let s=0,n=i-1;for(;s<n;){const a=s+Math.floor((n-s)/2);e>t[a]?s=a+1:n=a}const o=t[s];return r?e>=t[i-1]?-1:o===e?s:s-1:o===e?s:-1}let V0e=class{constructor(){this.last=0}};const z0e=new V0e;function Rj(t,e,r,i){i=i||z0e;const s=Math.max(0,i.last-10);for(let o=s;o<r;++o)if(t[o]===e)return i.last=o,o;const n=Math.min(s,r);for(let o=0;o<n;++o)if(t[o]===e)return i.last=o,o;return-1}function MI(t,e,r,i){const s=r??t.length,n=Rj(t,e,s,i);if(n!==-1)return t[n]=t[s-1],r==null&&t.pop(),e}const op=new Set;function x4e(t,e,r=t.length,i=e.length,s,n){if(i===0||r===0)return r;op.clear();for(let a=0;a<i;++a)op.add(e[a]);s=s||z0e;const o=Math.max(0,s.last-10);for(let a=o;a<r;++a)if(op.has(t[a])&&(n&&n.push(t[a]),op.delete(t[a]),t[a]=t[r-1],--r,--a,op.size===0||r===0))return op.clear(),r;for(let a=0;a<o;++a)if(op.has(t[a])&&(n&&n.push(t[a]),op.delete(t[a]),t[a]=t[r-1],--r,--a,op.size===0||r===0))return op.clear(),r;return op.clear(),r}function T4e(t,e){let r=0;for(let i=0;i<t.length;++i){const s=t[i];e(s,i)&&(t[r]=s,r++)}t.length=r}function S4e(t){return t?(sse.seed=t,()=>sse.getFloat()):Math.random}function SDt(t,e){const r=S4e(e);for(let i=t.length-1;i>0;i--){const s=Math.floor(r()*(i+1)),n=t[i];t[i]=t[s],t[s]=n}return t}const sse=new PM;function II(t,e){const r=t.indexOf(e);return r!==-1?(t.splice(r,1),e):null}function EDt(t,e){const r=new Map,i=t.length;for(let s=0;s<i;s++){const n=t[s],o=e(n,s,t),a=r.get(o);a?a.push(n):r.set(o,[n])}return r}function Ia(t,e){return t!=null}const E4e=[];let t1;function le(t){return typeof t1[t]=="function"?t1[t]=t1[t](globalThis):t1[t]}t1=globalThis.dojoConfig?.has||globalThis.esriConfig?.has?{...globalThis.dojoConfig?.has,...globalThis.esriConfig?.has}:{},le.add=(t,e,r,i)=>((i||t1[t]===void 0)&&(t1[t]=e),r&&le(t)),le.cache=t1,le.add("esri-deprecation-warnings",!0),le.add("esri-force-fullscreen-debug",!1),(()=>{le.add("host-webworker",globalThis.WorkerGlobalScope!==void 0&&self instanceof globalThis.WorkerGlobalScope);const t=typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document;if(le.add("host-browser",t),le.add("host-node",typeof globalThis.process=="object"&&globalThis.process.versions?.node&&globalThis.process.versions.v8),le.add("dom",t),le("host-browser")){const e=navigator,r=e.userAgent,i=e.appVersion,s=parseFloat(i);if(le.add("wp",parseFloat(r.split("Windows Phone")[1])||void 0),le.add("msapp",parseFloat(r.split("MSAppHost/")[1])||void 0),le.add("khtml",i.includes("Konqueror")?s:void 0),le.add("edge",parseFloat(r.split("Edge/")[1])||void 0),le.add("opr",parseFloat(r.split("OPR/")[1])||void 0),le.add("webkit",!le("wp")&&!le("edge")&&parseFloat(r.split("WebKit/")[1])||void 0),le.add("chrome",!le("edge")&&!le("opr")&&parseFloat(r.split("Chrome/")[1])||void 0),le.add("android",!le("wp")&&parseFloat(r.split("Android ")[1])||void 0),le.add("safari",!i.includes("Safari")||le("wp")||le("chrome")||le("android")||le("edge")||le("opr")?void 0:parseFloat(i.split("Version/")[1])),le.add("mac",i.includes("Macintosh")),!le("wp")&&/(iPhone|iPod|iPad)/.test(r)){const n=RegExp.$1.replace(/P/,"p"),o=/OS ([\d_]+)/.test(r)?RegExp.$1:"1",a=parseFloat(o.replace(/_/,".").replaceAll("_",""));le.add(n,a),le.add("ios",a)}le("webkit")||(!r.includes("Gecko")||le("wp")||le("khtml")||le("edge")||le.add("mozilla",s),le("mozilla")&&le.add("ff",parseFloat(r.split("Firefox/")[1]||r.split("Minefield/")[1])||void 0))}})(),(()=>{if(globalThis.navigator){const t=navigator.userAgent,e=/Android|webOS|iPhone|iPad|iPod|BlackBerry|Opera Mini|IEMobile/i.test(t),r=/iPhone/i.test(t);e&&le.add("esri-mobile",e),r&&le.add("esri-iPhone",r),le.add("esri-geolocation",!!navigator.geolocation)}le.add("esri-wasm","WebAssembly"in globalThis),le.add("esri-shared-array-buffer",()=>{const t="SharedArrayBuffer"in globalThis,e=globalThis.crossOriginIsolated===!1;return t&&!e}),le.add("wasm-simd",()=>{const t=[0,97,115,109,1,0,0,0,1,5,1,96,0,1,123,3,2,1,0,10,10,1,8,0,65,0,253,15,253,98,11];return WebAssembly.validate(new Uint8Array(t))}),le.add("esri-atomics","Atomics"in globalThis),le.add("esri-workers","Worker"in globalThis),le.add("web-feat:cache","caches"in globalThis),le.add("esri-workers-arraybuffer-transfer",!le("safari")||Number(le("safari"))>=12),le.add("workers-pool-size",8),le.add("featurelayer-simplify-thresholds",[.5,.5,.5,.5]),le.add("featurelayer-simplify-payload-size-factors",[1,1,4]),le.add("featurelayer-animation-enabled",!0),le.add("featurelayer-snapshot-enabled",!0),le.add("featurelayer-snapshot-point-min-threshold",8e4),le.add("featurelayer-snapshot-point-max-threshold",4e5),le.add("featurelayer-snapshot-point-coverage",.1),le.add("featurelayer-advanced-symbols",!1),le.add("featurelayer-pbf",!0),le.add("featurelayer-pbf-statistics",!1),le.add("feature-layers-workers",!0),le.add("feature-polyline-generalization-factor",1),le.add("mapview-transitions-duration",200),le.add("mapview-srswitch-adjust-rotation-scale-threshold",24e6),le.add("mapserver-pbf-version-support",10.81),le.add("mapservice-popup-identify-max-tolerance",20),le.add("heatmap-allow-raster-fallback",!1),le.add("heatmap-force-raster",!1),le("host-webworker")||le("host-browser")&&(le.add("esri-csp-restrictions",()=>{try{new Function}catch{return!0}return!1}),le.add("esri-image-decode",()=>{if("decode"in new Image){const t=new Image;return t.src='data:image/svg+xml;charset=UTF-8,<svg version="1.1" xmlns="http://www.w3.org/2000/svg"></svg>',void t.decode().then(()=>{le.add("esri-image-decode",!0,!0,!0)}).catch(()=>{le.add("esri-image-decode",!1,!0,!0)})}return!1}),le.add("esri-url-encodes-apostrophe",()=>{const t=window.document.createElement("a");return t.href="?'",t.href.includes("?%27")}))})();function XR(t){return t instanceof ArrayBuffer}function OJ(t){return t?.constructor?.name==="Int8Array"}function r1(t){return t?.constructor?.name==="Uint8Array"}function B0e(t){return t?.constructor?.name==="Uint8ClampedArray"}function w6(t){return t?.constructor?.name==="Int16Array"}function x6(t){return t?.constructor?.name==="Uint16Array"}function T6(t){return t?.constructor?.name==="Int32Array"}function S6(t){return t?.constructor?.name==="Uint32Array"}function WA(t){return t?.constructor?.name==="Float32Array"}function ZA(t){return t?.constructor?.name==="Float64Array"}function Cf(t){return!("buffer"in t)}function i1(t){return t!=null?Cf(t)?8*t.length+12:t.byteLength+G0e:0}const G0e=145,wh=1024;function C4e(t){return ZA(t)||WA(t)||T6(t)||w6(t)||OJ(t)}function A4e(t){return ZA(t)||WA(t)}function O4e(t){return ZA(t)?179769e303:WA(t)?3402823e32:S6(t)?4294967295:x6(t)?65535:r1(t)||B0e(t)?255:T6(t)?2147483647:w6(t)?32767:OJ(t)?127:256}function E6(t,e){let r;if(e)for(r in t)t.hasOwnProperty(r)&&(t[r]===void 0?delete t[r]:t[r]instanceof Object&&E6(t[r],!0));else for(r in t)t.hasOwnProperty(r)&&t[r]===void 0&&delete t[r];return t}function re(t){if(!t||typeof t!="object"||typeof t=="function")return t;const e=q0e(t);if(e!=null)return e;if(R5(t))return t.clone();if(j0e(t))return t.map(re);if(H0e(t))return t.clone();const r={};for(const i of Object.getOwnPropertyNames(t))r[i]=re(t[i]);return r}function Mj(t){if(!t||typeof t!="object"||typeof t=="function"||"HTMLElement"in globalThis&&t instanceof HTMLElement)return t;const e=q0e(t);if(e!=null)return e;if(j0e(t)){let r=!0;const i=t.map(s=>{const n=Mj(s);return s!=null&&n==null&&(r=!1),n});return r?i:null}if(R5(t))return t.clone();if(t instanceof File||t instanceof Blob)return t;if(!H0e(t)){const r=new(Object.getPrototypeOf(t)).constructor;for(const i of Object.getOwnPropertyNames(t)){const s=t[i],n=Mj(s);if(s!=null&&n==null)return null;r[i]=n}return r}return null}function R5(t){return typeof t.clone=="function"}function j0e(t){return typeof t.map=="function"&&typeof t.forEach=="function"}function H0e(t){return typeof t.notifyChange=="function"&&typeof t.watch=="function"}function nse(t){if(Object.prototype.toString.call(t)!=="[object Object]")return!1;const e=Object.getPrototypeOf(t);return e===null||e===Object.prototype}function q0e(t){if(OJ(t)||r1(t)||B0e(t)||w6(t)||x6(t)||T6(t)||S6(t)||WA(t)||ZA(t))return t.slice();if(t instanceof Date)return new Date(t.getTime());if(t instanceof ArrayBuffer)return t.slice(0,t.byteLength);if(t instanceof Map){const e=new Map;for(const[r,i]of t)e.set(r,re(i));return e}if(t instanceof Set){const e=new Set;for(const r of t)e.add(re(r));return e}return null}function RJ(t,e){return t===e||typeof t=="number"&&isNaN(t)&&typeof e=="number"&&isNaN(e)||typeof(t||{}).getTime=="function"&&typeof(e||{}).getTime=="function"&&t.getTime()===e.getTime()||!1}function W0e(t,e){return t===e||(t==null||typeof t=="string"?t===e:typeof t=="number"?t===e||typeof e=="number"&&isNaN(t)&&isNaN(e):t instanceof Date?e instanceof Date&&t.getTime()===e.getTime():Array.isArray(t)?Array.isArray(e)&&T0(t,e):t instanceof Set?e instanceof Set&&M4e(t,e):t instanceof Map?e instanceof Map&&I4e(t,e):!!nse(t)&&nse(e)&&R4e(t,e))}function R4e(t,e){if(t===null||e===null)return!1;const r=Object.keys(t);if(e===null||Object.keys(e).length!==r.length)return!1;for(const i of r)if(t[i]!==e[i]||!Object.prototype.hasOwnProperty.call(e,i))return!1;return!0}function M4e(t,e){if(t.size!==e.size)return!1;for(const r of t)if(!e.has(r))return!1;return!0}function I4e(t,e){if(t.size!==e.size)return!1;for(const[r,i]of t){const s=e.get(r);if(s!==i||s===void 0&&!e.has(r))return!1}return!0}function Z0e(t,e,r=!1){return Y0e(t,e,r)}function Ky(t,e){if(e!=null)return e[t]||X0e(t.split("."),!1,e)}function Ul(t,e,r){const i=t.split("."),s=i.pop(),n=X0e(i,!0,r);n&&s&&(n[s]=e)}function X0e(t,e,r){let i=r;for(const s of t){if(i==null)return;if(!(s in i)){if(!e)return;i[s]={}}i=i[s]}return i}function Y0e(t,e,r){return e?Object.keys(e).reduce((i,s)=>{let n=i[s],o=e[s];return n===o?i:n===void 0?(i[s]=re(o),i):(Array.isArray(o)||Array.isArray(i)?(n=n?Array.isArray(n)?i[s]=n.concat():i[s]=[n]:i[s]=[],o&&(Array.isArray(o)||(o=[o]),r?o.forEach(a=>{n.includes(a)||n.push(a)}):i[s]=o.concat())):o&&typeof o=="object"?i[s]=Y0e(n,o,r):i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[s]=o),i)},t||{}):t}let kr=class{constructor(e,r={ignoreUnknown:!1,useNumericKeys:!1}){this._jsonToAPI=e,this._options=r,this.apiValues=[],this.jsonValues=[],this._apiToJSON=this._invertMap(e),this.apiValues=this._getKeysSorted(this._apiToJSON),this.jsonValues=this._getKeysSorted(this._jsonToAPI),this.read=i=>this.fromJSON(i),this.write=(i,s,n)=>{const o=this.toJSON(i);o!==void 0&&Ul(n,o,s)},this.write.isJSONMapWriter=!0}toJSON(e){if(e==null)return null;if(this._apiToJSON.hasOwnProperty(e)){const r=this._apiToJSON[e];return this._options.useNumericKeys?+r:r}return this._options.ignoreUnknown?void 0:e}fromJSON(e){return e!=null&&this._jsonToAPI.hasOwnProperty(e)?this._jsonToAPI[e]:this._options.ignoreUnknown?void 0:e}_invertMap(e){const r={};for(const i in e)r[e[i]]=i;return r}_getKeysSorted(e){const r=[];for(const i in e)r.push(i);return r.sort(),r}};function zl(){return function(t,e){return new kr(t,{ignoreUnknown:!0,...e})}}let $M;const P4e=globalThis.esriConfig?.locale??globalThis.dojoConfig?.locale;function J0e(){return P4e??globalThis.navigator?.language??"en"}function Ld(){return $M===void 0&&($M=J0e()),$M}const LM=[];function Q0e(t){return LM.push(t),{remove(){LM.splice(LM.indexOf(t),1)}}}const Ij=[];function MJ(t){return Ij.push(t),{remove(){LM.splice(Ij.indexOf(t),1)}}}function $4e(){const t=J0e();$M!==t&&($M=t,[...Ij].forEach(e=>{e.call(null,t)}),[...LM].forEach(e=>{e.call(null,t)}))}globalThis.addEventListener?.("languagechange",$4e);class tS extends Error{}class L4e extends tS{constructor(e){super(`Invalid DateTime: ${e.toMessage()}`)}}class D4e extends tS{constructor(e){super(`Invalid Interval: ${e.toMessage()}`)}}class N4e extends tS{constructor(e){super(`Invalid Duration: ${e.toMessage()}`)}}class YR extends tS{}class K0e extends tS{constructor(e){super(`Invalid unit ${e}`)}}class bd extends tS{}class s_ extends tS{constructor(){super("Zone is an abstract class")}}const We="numeric",Af="short",mh="long",M5={year:We,month:We,day:We},e_e={year:We,month:Af,day:We},F4e={year:We,month:Af,day:We,weekday:Af},t_e={year:We,month:mh,day:We},r_e={year:We,month:mh,day:We,weekday:mh},i_e={hour:We,minute:We},s_e={hour:We,minute:We,second:We},n_e={hour:We,minute:We,second:We,timeZoneName:Af},o_e={hour:We,minute:We,second:We,timeZoneName:mh},a_e={hour:We,minute:We,hourCycle:"h23"},l_e={hour:We,minute:We,second:We,hourCycle:"h23"},c_e={hour:We,minute:We,second:We,hourCycle:"h23",timeZoneName:Af},u_e={hour:We,minute:We,second:We,hourCycle:"h23",timeZoneName:mh},h_e={year:We,month:We,day:We,hour:We,minute:We},d_e={year:We,month:We,day:We,hour:We,minute:We,second:We},p_e={year:We,month:Af,day:We,hour:We,minute:We},f_e={year:We,month:Af,day:We,hour:We,minute:We,second:We},k4e={year:We,month:Af,day:We,weekday:Af,hour:We,minute:We},m_e={year:We,month:mh,day:We,hour:We,minute:We,timeZoneName:Af},g_e={year:We,month:mh,day:We,hour:We,minute:We,second:We,timeZoneName:Af},y_e={year:We,month:mh,day:We,weekday:mh,hour:We,minute:We,timeZoneName:mh},__e={year:We,month:mh,day:We,weekday:mh,hour:We,minute:We,second:We,timeZoneName:mh};class XA{get type(){throw new s_}get name(){throw new s_}get ianaName(){return this.name}get isUniversal(){throw new s_}offsetName(e,r){throw new s_}formatOffset(e,r){throw new s_}offset(e){throw new s_}equals(e){throw new s_}get isValid(){throw new s_}}let a9=null;class C6 extends XA{static get instance(){return a9===null&&(a9=new C6),a9}get type(){return"system"}get name(){return new Intl.DateTimeFormat().resolvedOptions().timeZone}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return b_e(e,r,i)}formatOffset(e,r){return NM(this.offset(e),r)}offset(e){return-new Date(e).getTimezoneOffset()}equals(e){return e.type==="system"}get isValid(){return!0}}let yF={};function U4e(t){return yF[t]||(yF[t]=new Intl.DateTimeFormat("en-US",{hour12:!1,timeZone:t,year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit",era:"short"})),yF[t]}const V4e={year:0,month:1,day:2,era:3,hour:4,minute:5,second:6};function z4e(t,e){const r=t.format(e).replace(/\u200E/g,""),i=/(\d+)\/(\d+)\/(\d+) (AD|BC),? (\d+):(\d+):(\d+)/.exec(r),[,s,n,o,a,l,c,h]=i;return[o,s,n,a,l,c,h]}function B4e(t,e){const r=t.formatToParts(e),i=[];for(let s=0;s<r.length;s++){const{type:n,value:o}=r[s],a=V4e[n];n==="era"?i[a]=o:gi(a)||(i[a]=parseInt(o,10))}return i}let Z$={};class Of extends XA{static create(e){return Z$[e]||(Z$[e]=new Of(e)),Z$[e]}static resetCache(){Z$={},yF={}}static isValidSpecifier(e){return this.isValidZone(e)}static isValidZone(e){if(!e)return!1;try{return new Intl.DateTimeFormat("en-US",{timeZone:e}).format(),!0}catch{return!1}}constructor(e){super(),this.zoneName=e,this.valid=Of.isValidZone(e)}get type(){return"iana"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(e,{format:r,locale:i}){return b_e(e,r,i,this.name)}formatOffset(e,r){return NM(this.offset(e),r)}offset(e){const r=new Date(e);if(isNaN(r))return NaN;const i=U4e(this.name);let[s,n,o,a,l,c,h]=i.formatToParts?B4e(i,r):z4e(i,r);a==="BC"&&(s=-Math.abs(s)+1);const f=$J({year:s,month:n,day:o,hour:l===24?0:l,minute:c,second:h,millisecond:0});let m=+r;const g=m%1e3;return m-=g>=0?g:1e3+g,(f-m)/(60*1e3)}equals(e){return e.type==="iana"&&e.name===this.name}get isValid(){return this.valid}}let ose={};function G4e(t,e={}){const r=JSON.stringify([t,e]);let i=ose[r];return i||(i=new Intl.ListFormat(t,e),ose[r]=i),i}let Pj={};function $j(t,e={}){const r=JSON.stringify([t,e]);let i=Pj[r];return i||(i=new Intl.DateTimeFormat(t,e),Pj[r]=i),i}let Lj={};function j4e(t,e={}){const r=JSON.stringify([t,e]);let i=Lj[r];return i||(i=new Intl.NumberFormat(t,e),Lj[r]=i),i}let Dj={};function H4e(t,e={}){const{base:r,...i}=e,s=JSON.stringify([t,i]);let n=Dj[s];return n||(n=new Intl.RelativeTimeFormat(t,e),Dj[s]=n),n}let JR=null;function q4e(){return JR||(JR=new Intl.DateTimeFormat().resolvedOptions().locale,JR)}function W4e(t){const e=t.indexOf("-x-");e!==-1&&(t=t.substring(0,e));const r=t.indexOf("-u-");if(r===-1)return[t];{let i,s;try{i=$j(t).resolvedOptions(),s=t}catch{const l=t.substring(0,r);i=$j(l).resolvedOptions(),s=l}const{numberingSystem:n,calendar:o}=i;return[s,n,o]}}function Z4e(t,e,r){return(r||e)&&(t.includes("-u-")||(t+="-u"),r&&(t+=`-ca-${r}`),e&&(t+=`-nu-${e}`)),t}function X4e(t){const e=[];for(let r=1;r<=12;r++){const i=kt.utc(2016,r,1);e.push(t(i))}return e}function Y4e(t){const e=[];for(let r=1;r<=7;r++){const i=kt.utc(2016,11,13+r);e.push(t(i))}return e}function X$(t,e,r,i,s){const n=t.listingMode(r);return n==="error"?null:n==="en"?i(e):s(e)}function J4e(t){return t.numberingSystem&&t.numberingSystem!=="latn"?!1:t.numberingSystem==="latn"||!t.locale||t.locale.startsWith("en")||new Intl.DateTimeFormat(t.intl).resolvedOptions().numberingSystem==="latn"}class Q4e{constructor(e,r,i){this.padTo=i.padTo||0,this.floor=i.floor||!1;const{padTo:s,floor:n,...o}=i;if(!r||Object.keys(o).length>0){const a={useGrouping:!1,...i};i.padTo>0&&(a.minimumIntegerDigits=i.padTo),this.inf=j4e(e,a)}}format(e){if(this.inf){const r=this.floor?Math.floor(e):e;return this.inf.format(r)}else{const r=this.floor?Math.floor(e):PJ(e,3);return Oo(r,this.padTo)}}}class K4e{constructor(e,r,i){this.opts=i,this.originalZone=void 0;let s;if(this.opts.timeZone)this.dt=e;else if(e.zone.type==="fixed"){const o=-1*(e.offset/60),a=o>=0?`Etc/GMT+${o}`:`Etc/GMT${o}`;e.offset!==0&&Of.create(a).valid?(s=a,this.dt=e):(s="UTC",this.dt=e.offset===0?e:e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone)}else e.zone.type==="system"?this.dt=e:e.zone.type==="iana"?(this.dt=e,s=e.zone.name):(s="UTC",this.dt=e.setZone("UTC").plus({minutes:e.offset}),this.originalZone=e.zone);const n={...this.opts};n.timeZone=n.timeZone||s,this.dtf=$j(r,n)}format(){return this.originalZone?this.formatToParts().map(({value:e})=>e).join(""):this.dtf.format(this.dt.toJSDate())}formatToParts(){const e=this.dtf.formatToParts(this.dt.toJSDate());return this.originalZone?e.map(r=>{if(r.type==="timeZoneName"){const i=this.originalZone.offsetName(this.dt.ts,{locale:this.dt.locale,format:this.opts.timeZoneName});return{...r,value:i}}else return r}):e}resolvedOptions(){return this.dtf.resolvedOptions()}}class e5e{constructor(e,r,i){this.opts={style:"long",...i},!r&&v_e()&&(this.rtf=H4e(e,i))}format(e,r){return this.rtf?this.rtf.format(e,r):y5e(r,e,this.opts.numeric,this.opts.style!=="long")}formatToParts(e,r){return this.rtf?this.rtf.formatToParts(e,r):[]}}class Ks{static fromOpts(e){return Ks.create(e.locale,e.numberingSystem,e.outputCalendar,e.defaultToEN)}static create(e,r,i,s=!1){const n=e||Co.defaultLocale,o=n||(s?"en-US":q4e()),a=r||Co.defaultNumberingSystem,l=i||Co.defaultOutputCalendar;return new Ks(o,a,l,n)}static resetCache(){JR=null,Pj={},Lj={},Dj={}}static fromObject({locale:e,numberingSystem:r,outputCalendar:i}={}){return Ks.create(e,r,i)}constructor(e,r,i,s){const[n,o,a]=W4e(e);this.locale=n,this.numberingSystem=r||o||null,this.outputCalendar=i||a||null,this.intl=Z4e(this.locale,this.numberingSystem,this.outputCalendar),this.weekdaysCache={format:{},standalone:{}},this.monthsCache={format:{},standalone:{}},this.meridiemCache=null,this.eraCache={},this.specifiedLocale=s,this.fastNumbersCached=null}get fastNumbers(){return this.fastNumbersCached==null&&(this.fastNumbersCached=J4e(this)),this.fastNumbersCached}listingMode(){const e=this.isEnglish(),r=(this.numberingSystem===null||this.numberingSystem==="latn")&&(this.outputCalendar===null||this.outputCalendar==="gregory");return e&&r?"en":"intl"}clone(e){return!e||Object.getOwnPropertyNames(e).length===0?this:Ks.create(e.locale||this.specifiedLocale,e.numberingSystem||this.numberingSystem,e.outputCalendar||this.outputCalendar,e.defaultToEN||!1)}redefaultToEN(e={}){return this.clone({...e,defaultToEN:!0})}redefaultToSystem(e={}){return this.clone({...e,defaultToEN:!1})}months(e,r=!1,i=!0){return X$(this,e,i,T_e,()=>{const s=r?{month:e,day:"numeric"}:{month:e},n=r?"format":"standalone";return this.monthsCache[n][e]||(this.monthsCache[n][e]=X4e(o=>this.extract(o,s,"month"))),this.monthsCache[n][e]})}weekdays(e,r=!1,i=!0){return X$(this,e,i,C_e,()=>{const s=r?{weekday:e,year:"numeric",month:"long",day:"numeric"}:{weekday:e},n=r?"format":"standalone";return this.weekdaysCache[n][e]||(this.weekdaysCache[n][e]=Y4e(o=>this.extract(o,s,"weekday"))),this.weekdaysCache[n][e]})}meridiems(e=!0){return X$(this,void 0,e,()=>A_e,()=>{if(!this.meridiemCache){const r={hour:"numeric",hourCycle:"h12"};this.meridiemCache=[kt.utc(2016,11,13,9),kt.utc(2016,11,13,19)].map(i=>this.extract(i,r,"dayperiod"))}return this.meridiemCache})}eras(e,r=!0){return X$(this,e,r,O_e,()=>{const i={era:e};return this.eraCache[e]||(this.eraCache[e]=[kt.utc(-40,1,1),kt.utc(2017,1,1)].map(s=>this.extract(s,i,"era"))),this.eraCache[e]})}extract(e,r,i){const s=this.dtFormatter(e,r),n=s.formatToParts(),o=n.find(a=>a.type.toLowerCase()===i);return o?o.value:null}numberFormatter(e={}){return new Q4e(this.intl,e.forceSimple||this.fastNumbers,e)}dtFormatter(e,r={}){return new K4e(e,this.intl,r)}relFormatter(e={}){return new e5e(this.intl,this.isEnglish(),e)}listFormatter(e={}){return G4e(this.intl,e)}isEnglish(){return this.locale==="en"||this.locale.toLowerCase()==="en-us"||new Intl.DateTimeFormat(this.intl).resolvedOptions().locale.startsWith("en-us")}equals(e){return this.locale===e.locale&&this.numberingSystem===e.numberingSystem&&this.outputCalendar===e.outputCalendar}}let l9=null;class Ja extends XA{static get utcInstance(){return l9===null&&(l9=new Ja(0)),l9}static instance(e){return e===0?Ja.utcInstance:new Ja(e)}static parseSpecifier(e){if(e){const r=e.match(/^utc(?:([+-]\d{1,2})(?::(\d{2}))?)?$/i);if(r)return new Ja(O6(r[1],r[2]))}return null}constructor(e){super(),this.fixed=e}get type(){return"fixed"}get name(){return this.fixed===0?"UTC":`UTC${NM(this.fixed,"narrow")}`}get ianaName(){return this.fixed===0?"Etc/UTC":`Etc/GMT${NM(-this.fixed,"narrow")}`}offsetName(){return this.name}formatOffset(e,r){return NM(this.fixed,r)}get isUniversal(){return!0}offset(){return this.fixed}equals(e){return e.type==="fixed"&&e.fixed===this.fixed}get isValid(){return!0}}class t5e extends XA{constructor(e){super(),this.zoneName=e}get type(){return"invalid"}get name(){return this.zoneName}get isUniversal(){return!1}offsetName(){return null}formatOffset(){return""}offset(){return NaN}equals(){return!1}get isValid(){return!1}}function Hv(t,e){if(gi(t)||t===null)return e;if(t instanceof XA)return t;if(r5e(t)){const r=t.toLowerCase();return r==="default"?e:r==="local"||r==="system"?C6.instance:r==="utc"||r==="gmt"?Ja.utcInstance:Ja.parseSpecifier(r)||Of.create(t)}else return Jx(t)?Ja.instance(t):typeof t=="object"&&t.offset&&typeof t.offset=="number"?t:new t5e(t)}let ase=()=>Date.now(),lse="system",cse=null,use=null,hse=null,dse=60,pse;class Co{static get now(){return ase}static set now(e){ase=e}static set defaultZone(e){lse=e}static get defaultZone(){return Hv(lse,C6.instance)}static get defaultLocale(){return cse}static set defaultLocale(e){cse=e}static get defaultNumberingSystem(){return use}static set defaultNumberingSystem(e){use=e}static get defaultOutputCalendar(){return hse}static set defaultOutputCalendar(e){hse=e}static get twoDigitCutoffYear(){return dse}static set twoDigitCutoffYear(e){dse=e%100}static get throwOnInvalid(){return pse}static set throwOnInvalid(e){pse=e}static resetCaches(){Ks.resetCache(),Of.resetCache()}}function gi(t){return typeof t>"u"}function Jx(t){return typeof t=="number"}function A6(t){return typeof t=="number"&&t%1===0}function r5e(t){return typeof t=="string"}function i5e(t){return Object.prototype.toString.call(t)==="[object Date]"}function v_e(){try{return typeof Intl<"u"&&!!Intl.RelativeTimeFormat}catch{return!1}}function s5e(t){return Array.isArray(t)?t:[t]}function fse(t,e,r){if(t.length!==0)return t.reduce((i,s)=>{const n=[e(s),s];return i&&r(i[0],n[0])===i[0]?i:n},null)[1]}function n5e(t,e){return e.reduce((r,i)=>(r[i]=t[i],r),{})}function XC(t,e){return Object.prototype.hasOwnProperty.call(t,e)}function e0(t,e,r){return A6(t)&&t>=e&&t<=r}function o5e(t,e){return t-e*Math.floor(t/e)}function Oo(t,e=2){const r=t<0;let i;return r?i="-"+(""+-t).padStart(e,"0"):i=(""+t).padStart(e,"0"),i}function $v(t){if(!(gi(t)||t===null||t===""))return parseInt(t,10)}function Eb(t){if(!(gi(t)||t===null||t===""))return parseFloat(t)}function IJ(t){if(!(gi(t)||t===null||t==="")){const e=parseFloat("0."+t)*1e3;return Math.floor(e)}}function PJ(t,e,r=!1){const i=10**e;return(r?Math.trunc:Math.round)(t*i)/i}function kP(t){return t%4===0&&(t%100!==0||t%400===0)}function DM(t){return kP(t)?366:365}function I5(t,e){const r=o5e(e-1,12)+1,i=t+(e-r)/12;return r===2?kP(i)?29:28:[31,null,31,30,31,30,31,31,30,31,30,31][r-1]}function $J(t){let e=Date.UTC(t.year,t.month-1,t.day,t.hour,t.minute,t.second,t.millisecond);return t.year<100&&t.year>=0&&(e=new Date(e),e.setUTCFullYear(t.year,t.month-1,t.day)),+e}function P5(t){const e=(t+Math.floor(t/4)-Math.floor(t/100)+Math.floor(t/400))%7,r=t-1,i=(r+Math.floor(r/4)-Math.floor(r/100)+Math.floor(r/400))%7;return e===4||i===3?53:52}function Nj(t){return t>99?t:t>Co.twoDigitCutoffYear?1900+t:2e3+t}function b_e(t,e,r,i=null){const s=new Date(t),n={hourCycle:"h23",year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"};i&&(n.timeZone=i);const o={timeZoneName:e,...n},a=new Intl.DateTimeFormat(r,o).formatToParts(s).find(l=>l.type.toLowerCase()==="timezonename");return a?a.value:null}function O6(t,e){let r=parseInt(t,10);Number.isNaN(r)&&(r=0);const i=parseInt(e,10)||0,s=r<0||Object.is(r,-0)?-i:i;return r*60+s}function w_e(t){const e=Number(t);if(typeof t=="boolean"||t===""||Number.isNaN(e))throw new bd(`Invalid unit value ${t}`);return e}function $5(t,e){const r={};for(const i in t)if(XC(t,i)){const s=t[i];if(s==null)continue;r[e(i)]=w_e(s)}return r}function NM(t,e){const r=Math.trunc(Math.abs(t/60)),i=Math.trunc(Math.abs(t%60)),s=t>=0?"+":"-";switch(e){case"short":return`${s}${Oo(r,2)}:${Oo(i,2)}`;case"narrow":return`${s}${r}${i>0?`:${i}`:""}`;case"techie":return`${s}${Oo(r,2)}${Oo(i,2)}`;default:throw new RangeError(`Value format ${e} is out of range for property format`)}}function R6(t){return n5e(t,["hour","minute","second","millisecond"])}const a5e=["January","February","March","April","May","June","July","August","September","October","November","December"],x_e=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],l5e=["J","F","M","A","M","J","J","A","S","O","N","D"];function T_e(t){switch(t){case"narrow":return[...l5e];case"short":return[...x_e];case"long":return[...a5e];case"numeric":return["1","2","3","4","5","6","7","8","9","10","11","12"];case"2-digit":return["01","02","03","04","05","06","07","08","09","10","11","12"];default:return null}}const S_e=["Monday","Tuesday","Wednesday","Thursday","Friday","Saturday","Sunday"],E_e=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],c5e=["M","T","W","T","F","S","S"];function C_e(t){switch(t){case"narrow":return[...c5e];case"short":return[...E_e];case"long":return[...S_e];case"numeric":return["1","2","3","4","5","6","7"];default:return null}}const A_e=["AM","PM"],u5e=["Before Christ","Anno Domini"],h5e=["BC","AD"],d5e=["B","A"];function O_e(t){switch(t){case"narrow":return[...d5e];case"short":return[...h5e];case"long":return[...u5e];default:return null}}function p5e(t){return A_e[t.hour<12?0:1]}function f5e(t,e){return C_e(e)[t.weekday-1]}function m5e(t,e){return T_e(e)[t.month-1]}function g5e(t,e){return O_e(e)[t.year<0?0:1]}function y5e(t,e,r="always",i=!1){const s={years:["year","yr."],quarters:["quarter","qtr."],months:["month","mo."],weeks:["week","wk."],days:["day","day","days"],hours:["hour","hr."],minutes:["minute","min."],seconds:["second","sec."]},n=["hours","minutes","seconds"].indexOf(t)===-1;if(r==="auto"&&n){const p=t==="days";switch(e){case 1:return p?"tomorrow":`next ${s[t][0]}`;case-1:return p?"yesterday":`last ${s[t][0]}`;case 0:return p?"today":`this ${s[t][0]}`}}const o=Object.is(e,-0)||e<0,a=Math.abs(e),l=a===1,c=s[t],h=i?l?c[1]:c[2]||c[1]:l?s[t][0]:t;return o?`${a} ${h} ago`:`in ${a} ${h}`}function mse(t,e){let r="";for(const i of t)i.literal?r+=i.val:r+=e(i.val);return r}const _5e={D:M5,DD:e_e,DDD:t_e,DDDD:r_e,t:i_e,tt:s_e,ttt:n_e,tttt:o_e,T:a_e,TT:l_e,TTT:c_e,TTTT:u_e,f:h_e,ff:p_e,fff:m_e,ffff:y_e,F:d_e,FF:f_e,FFF:g_e,FFFF:__e};class Pl{static create(e,r={}){return new Pl(e,r)}static parseFormat(e){let r=null,i="",s=!1;const n=[];for(let o=0;o<e.length;o++){const a=e.charAt(o);a==="'"?(i.length>0&&n.push({literal:s||/^\s+$/.test(i),val:i}),r=null,i="",s=!s):s||a===r?i+=a:(i.length>0&&n.push({literal:/^\s+$/.test(i),val:i}),i=a,r=a)}return i.length>0&&n.push({literal:s||/^\s+$/.test(i),val:i}),n}static macroTokenToFormatOpts(e){return _5e[e]}constructor(e,r){this.opts=r,this.loc=e,this.systemLoc=null}formatWithSystemDefault(e,r){return this.systemLoc===null&&(this.systemLoc=this.loc.redefaultToSystem()),this.systemLoc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTime(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).format()}formatDateTimeParts(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).formatToParts()}formatInterval(e,r={}){return this.loc.dtFormatter(e.start,{...this.opts,...r}).dtf.formatRange(e.start.toJSDate(),e.end.toJSDate())}resolvedOptions(e,r={}){return this.loc.dtFormatter(e,{...this.opts,...r}).resolvedOptions()}num(e,r=0){if(this.opts.forceSimple)return Oo(e,r);const i={...this.opts};return r>0&&(i.padTo=r),this.loc.numberFormatter(i).format(e)}formatDateTimeFromString(e,r){const i=this.loc.listingMode()==="en",s=this.loc.outputCalendar&&this.loc.outputCalendar!=="gregory",n=(m,g)=>this.loc.extract(e,m,g),o=m=>e.isOffsetFixed&&e.offset===0&&m.allowZ?"Z":e.isValid?e.zone.formatOffset(e.ts,m.format):"",a=()=>i?p5e(e):n({hour:"numeric",hourCycle:"h12"},"dayperiod"),l=(m,g)=>i?m5e(e,m):n(g?{month:m}:{month:m,day:"numeric"},"month"),c=(m,g)=>i?f5e(e,m):n(g?{weekday:m}:{weekday:m,month:"long",day:"numeric"},"weekday"),h=m=>{const g=Pl.macroTokenToFormatOpts(m);return g?this.formatWithSystemDefault(e,g):m},p=m=>i?g5e(e,m):n({era:m},"era"),f=m=>{switch(m){case"S":return this.num(e.millisecond);case"u":case"SSS":return this.num(e.millisecond,3);case"s":return this.num(e.second);case"ss":return this.num(e.second,2);case"uu":return this.num(Math.floor(e.millisecond/10),2);case"uuu":return this.num(Math.floor(e.millisecond/100));case"m":return this.num(e.minute);case"mm":return this.num(e.minute,2);case"h":return this.num(e.hour%12===0?12:e.hour%12);case"hh":return this.num(e.hour%12===0?12:e.hour%12,2);case"H":return this.num(e.hour);case"HH":return this.num(e.hour,2);case"Z":return o({format:"narrow",allowZ:this.opts.allowZ});case"ZZ":return o({format:"short",allowZ:this.opts.allowZ});case"ZZZ":return o({format:"techie",allowZ:this.opts.allowZ});case"ZZZZ":return e.zone.offsetName(e.ts,{format:"short",locale:this.loc.locale});case"ZZZZZ":return e.zone.offsetName(e.ts,{format:"long",locale:this.loc.locale});case"z":return e.zoneName;case"a":return a();case"d":return s?n({day:"numeric"},"day"):this.num(e.day);case"dd":return s?n({day:"2-digit"},"day"):this.num(e.day,2);case"c":return this.num(e.weekday);case"ccc":return c("short",!0);case"cccc":return c("long",!0);case"ccccc":return c("narrow",!0);case"E":return this.num(e.weekday);case"EEE":return c("short",!1);case"EEEE":return c("long",!1);case"EEEEE":return c("narrow",!1);case"L":return s?n({month:"numeric",day:"numeric"},"month"):this.num(e.month);case"LL":return s?n({month:"2-digit",day:"numeric"},"month"):this.num(e.month,2);case"LLL":return l("short",!0);case"LLLL":return l("long",!0);case"LLLLL":return l("narrow",!0);case"M":return s?n({month:"numeric"},"month"):this.num(e.month);case"MM":return s?n({month:"2-digit"},"month"):this.num(e.month,2);case"MMM":return l("short",!1);case"MMMM":return l("long",!1);case"MMMMM":return l("narrow",!1);case"y":return s?n({year:"numeric"},"year"):this.num(e.year);case"yy":return s?n({year:"2-digit"},"year"):this.num(e.year.toString().slice(-2),2);case"yyyy":return s?n({year:"numeric"},"year"):this.num(e.year,4);case"yyyyyy":return s?n({year:"numeric"},"year"):this.num(e.year,6);case"G":return p("short");case"GG":return p("long");case"GGGGG":return p("narrow");case"kk":return this.num(e.weekYear.toString().slice(-2),2);case"kkkk":return this.num(e.weekYear,4);case"W":return this.num(e.weekNumber);case"WW":return this.num(e.weekNumber,2);case"o":return this.num(e.ordinal);case"ooo":return this.num(e.ordinal,3);case"q":return this.num(e.quarter);case"qq":return this.num(e.quarter,2);case"X":return this.num(Math.floor(e.ts/1e3));case"x":return this.num(e.ts);default:return h(m)}};return mse(Pl.parseFormat(r),f)}formatDurationFromString(e,r){const i=l=>{switch(l[0]){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":return"hour";case"d":return"day";case"w":return"week";case"M":return"month";case"y":return"year";default:return null}},s=l=>c=>{const h=i(c);return h?this.num(l.get(h),c.length):c},n=Pl.parseFormat(r),o=n.reduce((l,{literal:c,val:h})=>c?l:l.concat(h),[]),a=e.shiftTo(...o.map(i).filter(l=>l));return mse(n,s(a))}}class af{constructor(e,r){this.reason=e,this.explanation=r}toMessage(){return this.explanation?`${this.reason}: ${this.explanation}`:this.reason}}const R_e=/[A-Za-z_+-]{1,256}(?::?\/[A-Za-z0-9_+-]{1,256}(?:\/[A-Za-z0-9_+-]{1,256})?)?/;function YA(...t){const e=t.reduce((r,i)=>r+i.source,"");return RegExp(`^${e}$`)}function JA(...t){return e=>t.reduce(([r,i,s],n)=>{const[o,a,l]=n(e,s);return[{...r,...o},a||i,l]},[{},null,1]).slice(0,2)}function QA(t,...e){if(t==null)return[null,null];for(const[r,i]of e){const s=r.exec(t);if(s)return i(s)}return[null,null]}function M_e(...t){return(e,r)=>{const i={};let s;for(s=0;s<t.length;s++)i[t[s]]=$v(e[r+s]);return[i,null,r+s]}}const I_e=/(?:(Z)|([+-]\d\d)(?::?(\d\d))?)/,v5e=`(?:${I_e.source}?(?:\\[(${R_e.source})\\])?)?`,LJ=/(\d\d)(?::?(\d\d)(?::?(\d\d)(?:[.,](\d{1,30}))?)?)?/,P_e=RegExp(`${LJ.source}${v5e}`),DJ=RegExp(`(?:T${P_e.source})?`),b5e=/([+-]\d{6}|\d{4})(?:-?(\d\d)(?:-?(\d\d))?)?/,w5e=/(\d{4})-?W(\d\d)(?:-?(\d))?/,x5e=/(\d{4})-?(\d{3})/,T5e=M_e("weekYear","weekNumber","weekDay"),S5e=M_e("year","ordinal"),E5e=/(\d{4})-(\d\d)-(\d\d)/,$_e=RegExp(`${LJ.source} ?(?:${I_e.source}|(${R_e.source}))?`),C5e=RegExp(`(?: ${$_e.source})?`);function mC(t,e,r){const i=t[e];return gi(i)?r:$v(i)}function A5e(t,e){return[{year:mC(t,e),month:mC(t,e+1,1),day:mC(t,e+2,1)},null,e+3]}function KA(t,e){return[{hours:mC(t,e,0),minutes:mC(t,e+1,0),seconds:mC(t,e+2,0),milliseconds:IJ(t[e+3])},null,e+4]}function UP(t,e){const r=!t[e]&&!t[e+1],i=O6(t[e+1],t[e+2]),s=r?null:Ja.instance(i);return[{},s,e+3]}function VP(t,e){const r=t[e]?Of.create(t[e]):null;return[{},r,e+1]}const O5e=RegExp(`^T?${LJ.source}$`),R5e=/^-?P(?:(?:(-?\d{1,20}(?:\.\d{1,20})?)Y)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20}(?:\.\d{1,20})?)W)?(?:(-?\d{1,20}(?:\.\d{1,20})?)D)?(?:T(?:(-?\d{1,20}(?:\.\d{1,20})?)H)?(?:(-?\d{1,20}(?:\.\d{1,20})?)M)?(?:(-?\d{1,20})(?:[.,](-?\d{1,20}))?S)?)?)$/;function M5e(t){const[e,r,i,s,n,o,a,l,c]=t,h=e[0]==="-",p=l&&l[0]==="-",f=(m,g=!1)=>m!==void 0&&(g||m&&h)?-m:m;return[{years:f(Eb(r)),months:f(Eb(i)),weeks:f(Eb(s)),days:f(Eb(n)),hours:f(Eb(o)),minutes:f(Eb(a)),seconds:f(Eb(l),l==="-0"),milliseconds:f(IJ(c),p)}]}const I5e={GMT:0,EDT:-4*60,EST:-5*60,CDT:-5*60,CST:-6*60,MDT:-6*60,MST:-7*60,PDT:-7*60,PST:-8*60};function NJ(t,e,r,i,s,n,o){const a={year:e.length===2?Nj($v(e)):$v(e),month:x_e.indexOf(r)+1,day:$v(i),hour:$v(s),minute:$v(n)};return o&&(a.second=$v(o)),t&&(a.weekday=t.length>3?S_e.indexOf(t)+1:E_e.indexOf(t)+1),a}const P5e=/^(?:(Mon|Tue|Wed|Thu|Fri|Sat|Sun),\s)?(\d{1,2})\s(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)\s(\d{2,4})\s(\d\d):(\d\d)(?::(\d\d))?\s(?:(UT|GMT|[ECMP][SD]T)|([Zz])|(?:([+-]\d\d)(\d\d)))$/;function $5e(t){const[,e,r,i,s,n,o,a,l,c,h,p]=t,f=NJ(e,s,i,r,n,o,a);let m;return l?m=I5e[l]:c?m=0:m=O6(h,p),[f,new Ja(m)]}function L5e(t){return t.replace(/\([^()]*\)|[\n\t]/g," ").replace(/(\s\s+)/g," ").trim()}const D5e=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun), (\d\d) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) (\d{4}) (\d\d):(\d\d):(\d\d) GMT$/,N5e=/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday), (\d\d)-(Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec)-(\d\d) (\d\d):(\d\d):(\d\d) GMT$/,F5e=/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun) (Jan|Feb|Mar|Apr|May|Jun|Jul|Aug|Sep|Oct|Nov|Dec) ( \d|\d\d) (\d\d):(\d\d):(\d\d) (\d{4})$/;function gse(t){const[,e,r,i,s,n,o,a]=t;return[NJ(e,s,i,r,n,o,a),Ja.utcInstance]}function k5e(t){const[,e,r,i,s,n,o,a]=t;return[NJ(e,a,r,i,s,n,o),Ja.utcInstance]}const U5e=YA(b5e,DJ),V5e=YA(w5e,DJ),z5e=YA(x5e,DJ),B5e=YA(P_e),L_e=JA(A5e,KA,UP,VP),G5e=JA(T5e,KA,UP,VP),j5e=JA(S5e,KA,UP,VP),H5e=JA(KA,UP,VP);function q5e(t){return QA(t,[U5e,L_e],[V5e,G5e],[z5e,j5e],[B5e,H5e])}function W5e(t){return QA(L5e(t),[P5e,$5e])}function Z5e(t){return QA(t,[D5e,gse],[N5e,gse],[F5e,k5e])}function X5e(t){return QA(t,[R5e,M5e])}const Y5e=JA(KA);function J5e(t){return QA(t,[O5e,Y5e])}const Q5e=YA(E5e,C5e),K5e=YA($_e),eke=JA(KA,UP,VP);function tke(t){return QA(t,[Q5e,L_e],[K5e,eke])}const rke="Invalid Duration",D_e={weeks:{days:7,hours:7*24,minutes:7*24*60,seconds:7*24*60*60,milliseconds:7*24*60*60*1e3},days:{hours:24,minutes:24*60,seconds:24*60*60,milliseconds:24*60*60*1e3},hours:{minutes:60,seconds:60*60,milliseconds:60*60*1e3},minutes:{seconds:60,milliseconds:60*1e3},seconds:{milliseconds:1e3}},ike={years:{quarters:4,months:12,weeks:52,days:365,hours:365*24,minutes:365*24*60,seconds:365*24*60*60,milliseconds:365*24*60*60*1e3},quarters:{months:3,weeks:13,days:91,hours:91*24,minutes:91*24*60,seconds:91*24*60*60,milliseconds:91*24*60*60*1e3},months:{weeks:4,days:30,hours:30*24,minutes:30*24*60,seconds:30*24*60*60,milliseconds:30*24*60*60*1e3},...D_e},Mh=146097/400,SS=146097/4800,ske={years:{quarters:4,months:12,weeks:Mh/7,days:Mh,hours:Mh*24,minutes:Mh*24*60,seconds:Mh*24*60*60,milliseconds:Mh*24*60*60*1e3},quarters:{months:3,weeks:Mh/28,days:Mh/4,hours:Mh*24/4,minutes:Mh*24*60/4,seconds:Mh*24*60*60/4,milliseconds:Mh*24*60*60*1e3/4},months:{weeks:SS/7,days:SS,hours:SS*24,minutes:SS*24*60,seconds:SS*24*60*60,milliseconds:SS*24*60*60*1e3},...D_e},uw=["years","quarters","months","weeks","days","hours","minutes","seconds","milliseconds"],nke=uw.slice(0).reverse();function n_(t,e,r=!1){const i={values:r?e.values:{...t.values,...e.values||{}},loc:t.loc.clone(e.loc),conversionAccuracy:e.conversionAccuracy||t.conversionAccuracy,matrix:e.matrix||t.matrix};return new Ei(i)}function oke(t){return t<0?Math.floor(t):Math.ceil(t)}function N_e(t,e,r,i,s){const n=t[s][r],o=e[r]/n,a=Math.sign(o)===Math.sign(i[s]),l=!a&&i[s]!==0&&Math.abs(o)<=1?oke(o):Math.trunc(o);i[s]+=l,e[r]-=l*n}function ake(t,e){nke.reduce((r,i)=>gi(e[i])?r:(r&&N_e(t,e,r,e,i),i),null)}function lke(t){const e={};for(const[r,i]of Object.entries(t))i!==0&&(e[r]=i);return e}class Ei{constructor(e){const r=e.conversionAccuracy==="longterm"||!1;let i=r?ske:ike;e.matrix&&(i=e.matrix),this.values=e.values,this.loc=e.loc||Ks.create(),this.conversionAccuracy=r?"longterm":"casual",this.invalid=e.invalid||null,this.matrix=i,this.isLuxonDuration=!0}static fromMillis(e,r){return Ei.fromObject({milliseconds:e},r)}static fromObject(e,r={}){if(e==null||typeof e!="object")throw new bd(`Duration.fromObject: argument expected to be an object, got ${e===null?"null":typeof e}`);return new Ei({values:$5(e,Ei.normalizeUnit),loc:Ks.fromObject(r),conversionAccuracy:r.conversionAccuracy,matrix:r.matrix})}static fromDurationLike(e){if(Jx(e))return Ei.fromMillis(e);if(Ei.isDuration(e))return e;if(typeof e=="object")return Ei.fromObject(e);throw new bd(`Unknown duration argument ${e} of type ${typeof e}`)}static fromISO(e,r){const[i]=X5e(e);return i?Ei.fromObject(i,r):Ei.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static fromISOTime(e,r){const[i]=J5e(e);return i?Ei.fromObject(i,r):Ei.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static invalid(e,r=null){if(!e)throw new bd("need to specify a reason the Duration is invalid");const i=e instanceof af?e:new af(e,r);if(Co.throwOnInvalid)throw new N4e(i);return new Ei({invalid:i})}static normalizeUnit(e){const r={year:"years",years:"years",quarter:"quarters",quarters:"quarters",month:"months",months:"months",week:"weeks",weeks:"weeks",day:"days",days:"days",hour:"hours",hours:"hours",minute:"minutes",minutes:"minutes",second:"seconds",seconds:"seconds",millisecond:"milliseconds",milliseconds:"milliseconds"}[e&&e.toLowerCase()];if(!r)throw new K0e(e);return r}static isDuration(e){return e&&e.isLuxonDuration||!1}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}toFormat(e,r={}){const i={...r,floor:r.round!==!1&&r.floor!==!1};return this.isValid?Pl.create(this.loc,i).formatDurationFromString(this,e):rke}toHuman(e={}){const r=uw.map(i=>{const s=this.values[i];return gi(s)?null:this.loc.numberFormatter({style:"unit",unitDisplay:"long",...e,unit:i.slice(0,-1)}).format(s)}).filter(i=>i);return this.loc.listFormatter({type:"conjunction",style:e.listStyle||"narrow",...e}).format(r)}toObject(){return this.isValid?{...this.values}:{}}toISO(){if(!this.isValid)return null;let e="P";return this.years!==0&&(e+=this.years+"Y"),(this.months!==0||this.quarters!==0)&&(e+=this.months+this.quarters*3+"M"),this.weeks!==0&&(e+=this.weeks+"W"),this.days!==0&&(e+=this.days+"D"),(this.hours!==0||this.minutes!==0||this.seconds!==0||this.milliseconds!==0)&&(e+="T"),this.hours!==0&&(e+=this.hours+"H"),this.minutes!==0&&(e+=this.minutes+"M"),(this.seconds!==0||this.milliseconds!==0)&&(e+=PJ(this.seconds+this.milliseconds/1e3,3)+"S"),e==="P"&&(e+="T0S"),e}toISOTime(e={}){if(!this.isValid)return null;const r=this.toMillis();if(r<0||r>=864e5)return null;e={suppressMilliseconds:!1,suppressSeconds:!1,includePrefix:!1,format:"extended",...e};const i=this.shiftTo("hours","minutes","seconds","milliseconds");let s=e.format==="basic"?"hhmm":"hh:mm";(!e.suppressSeconds||i.seconds!==0||i.milliseconds!==0)&&(s+=e.format==="basic"?"ss":":ss",(!e.suppressMilliseconds||i.milliseconds!==0)&&(s+=".SSS"));let n=i.toFormat(s);return e.includePrefix&&(n="T"+n),n}toJSON(){return this.toISO()}toString(){return this.toISO()}toMillis(){return this.as("milliseconds")}valueOf(){return this.toMillis()}plus(e){if(!this.isValid)return this;const r=Ei.fromDurationLike(e),i={};for(const s of uw)(XC(r.values,s)||XC(this.values,s))&&(i[s]=r.get(s)+this.get(s));return n_(this,{values:i},!0)}minus(e){if(!this.isValid)return this;const r=Ei.fromDurationLike(e);return this.plus(r.negate())}mapUnits(e){if(!this.isValid)return this;const r={};for(const i of Object.keys(this.values))r[i]=w_e(e(this.values[i],i));return n_(this,{values:r},!0)}get(e){return this[Ei.normalizeUnit(e)]}set(e){if(!this.isValid)return this;const r={...this.values,...$5(e,Ei.normalizeUnit)};return n_(this,{values:r})}reconfigure({locale:e,numberingSystem:r,conversionAccuracy:i,matrix:s}={}){const o={loc:this.loc.clone({locale:e,numberingSystem:r}),matrix:s,conversionAccuracy:i};return n_(this,o)}as(e){return this.isValid?this.shiftTo(e).get(e):NaN}normalize(){if(!this.isValid)return this;const e=this.toObject();return ake(this.matrix,e),n_(this,{values:e},!0)}rescale(){if(!this.isValid)return this;const e=lke(this.normalize().shiftToAll().toObject());return n_(this,{values:e},!0)}shiftTo(...e){if(!this.isValid)return this;if(e.length===0)return this;e=e.map(o=>Ei.normalizeUnit(o));const r={},i={},s=this.toObject();let n;for(const o of uw)if(e.indexOf(o)>=0){n=o;let a=0;for(const c in i)a+=this.matrix[c][o]*i[c],i[c]=0;Jx(s[o])&&(a+=s[o]);const l=Math.trunc(a);r[o]=l,i[o]=(a*1e3-l*1e3)/1e3;for(const c in s)uw.indexOf(c)>uw.indexOf(o)&&N_e(this.matrix,s,c,r,o)}else Jx(s[o])&&(i[o]=s[o]);for(const o in i)i[o]!==0&&(r[n]+=o===n?i[o]:i[o]/this.matrix[n][o]);return n_(this,{values:r},!0).normalize()}shiftToAll(){return this.isValid?this.shiftTo("years","months","weeks","days","hours","minutes","seconds","milliseconds"):this}negate(){if(!this.isValid)return this;const e={};for(const r of Object.keys(this.values))e[r]=this.values[r]===0?0:-this.values[r];return n_(this,{values:e},!0)}get years(){return this.isValid?this.values.years||0:NaN}get quarters(){return this.isValid?this.values.quarters||0:NaN}get months(){return this.isValid?this.values.months||0:NaN}get weeks(){return this.isValid?this.values.weeks||0:NaN}get days(){return this.isValid?this.values.days||0:NaN}get hours(){return this.isValid?this.values.hours||0:NaN}get minutes(){return this.isValid?this.values.minutes||0:NaN}get seconds(){return this.isValid?this.values.seconds||0:NaN}get milliseconds(){return this.isValid?this.values.milliseconds||0:NaN}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}equals(e){if(!this.isValid||!e.isValid||!this.loc.equals(e.loc))return!1;function r(i,s){return i===void 0||i===0?s===void 0||s===0:i===s}for(const i of uw)if(!r(this.values[i],e.values[i]))return!1;return!0}}const ES="Invalid Interval";function cke(t,e){return!t||!t.isValid?Rn.invalid("missing or invalid start"):!e||!e.isValid?Rn.invalid("missing or invalid end"):e<t?Rn.invalid("end before start",`The end of an interval must be after its start, but you had start=${t.toISO()} and end=${e.toISO()}`):null}class Rn{constructor(e){this.s=e.start,this.e=e.end,this.invalid=e.invalid||null,this.isLuxonInterval=!0}static invalid(e,r=null){if(!e)throw new bd("need to specify a reason the Interval is invalid");const i=e instanceof af?e:new af(e,r);if(Co.throwOnInvalid)throw new D4e(i);return new Rn({invalid:i})}static fromDateTimes(e,r){const i=FO(e),s=FO(r),n=cke(i,s);return n??new Rn({start:i,end:s})}static after(e,r){const i=Ei.fromDurationLike(r),s=FO(e);return Rn.fromDateTimes(s,s.plus(i))}static before(e,r){const i=Ei.fromDurationLike(r),s=FO(e);return Rn.fromDateTimes(s.minus(i),s)}static fromISO(e,r){const[i,s]=(e||"").split("/",2);if(i&&s){let n,o;try{n=kt.fromISO(i,r),o=n.isValid}catch{o=!1}let a,l;try{a=kt.fromISO(s,r),l=a.isValid}catch{l=!1}if(o&&l)return Rn.fromDateTimes(n,a);if(o){const c=Ei.fromISO(s,r);if(c.isValid)return Rn.after(n,c)}else if(l){const c=Ei.fromISO(i,r);if(c.isValid)return Rn.before(a,c)}}return Rn.invalid("unparsable",`the input "${e}" can't be parsed as ISO 8601`)}static isInterval(e){return e&&e.isLuxonInterval||!1}get start(){return this.isValid?this.s:null}get end(){return this.isValid?this.e:null}get isValid(){return this.invalidReason===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}length(e="milliseconds"){return this.isValid?this.toDuration(e).get(e):NaN}count(e="milliseconds"){if(!this.isValid)return NaN;const r=this.start.startOf(e),i=this.end.startOf(e);return Math.floor(i.diff(r,e).get(e))+(i.valueOf()!==this.end.valueOf())}hasSame(e){return this.isValid?this.isEmpty()||this.e.minus(1).hasSame(this.s,e):!1}isEmpty(){return this.s.valueOf()===this.e.valueOf()}isAfter(e){return this.isValid?this.s>e:!1}isBefore(e){return this.isValid?this.e<=e:!1}contains(e){return this.isValid?this.s<=e&&this.e>e:!1}set({start:e,end:r}={}){return this.isValid?Rn.fromDateTimes(e||this.s,r||this.e):this}splitAt(...e){if(!this.isValid)return[];const r=e.map(FO).filter(o=>this.contains(o)).sort(),i=[];let{s}=this,n=0;for(;s<this.e;){const o=r[n]||this.e,a=+o>+this.e?this.e:o;i.push(Rn.fromDateTimes(s,a)),s=a,n+=1}return i}splitBy(e){const r=Ei.fromDurationLike(e);if(!this.isValid||!r.isValid||r.as("milliseconds")===0)return[];let{s:i}=this,s=1,n;const o=[];for(;i<this.e;){const a=this.start.plus(r.mapUnits(l=>l*s));n=+a>+this.e?this.e:a,o.push(Rn.fromDateTimes(i,n)),i=n,s+=1}return o}divideEqually(e){return this.isValid?this.splitBy(this.length()/e).slice(0,e):[]}overlaps(e){return this.e>e.s&&this.s<e.e}abutsStart(e){return this.isValid?+this.e==+e.s:!1}abutsEnd(e){return this.isValid?+e.e==+this.s:!1}engulfs(e){return this.isValid?this.s<=e.s&&this.e>=e.e:!1}equals(e){return!this.isValid||!e.isValid?!1:this.s.equals(e.s)&&this.e.equals(e.e)}intersection(e){if(!this.isValid)return this;const r=this.s>e.s?this.s:e.s,i=this.e<e.e?this.e:e.e;return r>=i?null:Rn.fromDateTimes(r,i)}union(e){if(!this.isValid)return this;const r=this.s<e.s?this.s:e.s,i=this.e>e.e?this.e:e.e;return Rn.fromDateTimes(r,i)}static merge(e){const[r,i]=e.sort((s,n)=>s.s-n.s).reduce(([s,n],o)=>n?n.overlaps(o)||n.abutsStart(o)?[s,n.union(o)]:[s.concat([n]),o]:[s,o],[[],null]);return i&&r.push(i),r}static xor(e){let r=null,i=0;const s=[],n=e.map(l=>[{time:l.s,type:"s"},{time:l.e,type:"e"}]),o=Array.prototype.concat(...n),a=o.sort((l,c)=>l.time-c.time);for(const l of a)i+=l.type==="s"?1:-1,i===1?r=l.time:(r&&+r!=+l.time&&s.push(Rn.fromDateTimes(r,l.time)),r=null);return Rn.merge(s)}difference(...e){return Rn.xor([this].concat(e)).map(r=>this.intersection(r)).filter(r=>r&&!r.isEmpty())}toString(){return this.isValid?`[${this.s.toISO()} – ${this.e.toISO()})`:ES}toLocaleString(e=M5,r={}){return this.isValid?Pl.create(this.s.loc.clone(r),e).formatInterval(this):ES}toISO(e){return this.isValid?`${this.s.toISO(e)}/${this.e.toISO(e)}`:ES}toISODate(){return this.isValid?`${this.s.toISODate()}/${this.e.toISODate()}`:ES}toISOTime(e){return this.isValid?`${this.s.toISOTime(e)}/${this.e.toISOTime(e)}`:ES}toFormat(e,{separator:r=" – "}={}){return this.isValid?`${this.s.toFormat(e)}${r}${this.e.toFormat(e)}`:ES}toDuration(e,r){return this.isValid?this.e.diff(this.s,e,r):Ei.invalid(this.invalidReason)}mapEndpoints(e){return Rn.fromDateTimes(e(this.s),e(this.e))}}class Y${static hasDST(e=Co.defaultZone){const r=kt.now().setZone(e).set({month:12});return!e.isUniversal&&r.offset!==r.set({month:6}).offset}static isValidIANAZone(e){return Of.isValidZone(e)}static normalizeZone(e){return Hv(e,Co.defaultZone)}static months(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||Ks.create(r,i,n)).months(e)}static monthsFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null,outputCalendar:n="gregory"}={}){return(s||Ks.create(r,i,n)).months(e,!0)}static weekdays(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||Ks.create(r,i,null)).weekdays(e)}static weekdaysFormat(e="long",{locale:r=null,numberingSystem:i=null,locObj:s=null}={}){return(s||Ks.create(r,i,null)).weekdays(e,!0)}static meridiems({locale:e=null}={}){return Ks.create(e).meridiems()}static eras(e="short",{locale:r=null}={}){return Ks.create(r,null,"gregory").eras(e)}static features(){return{relative:v_e()}}}function yse(t,e){const r=s=>s.toUTC(0,{keepLocalTime:!0}).startOf("day").valueOf(),i=r(e)-r(t);return Math.floor(Ei.fromMillis(i).as("days"))}function uke(t,e,r){const i=[["years",(l,c)=>c.year-l.year],["quarters",(l,c)=>c.quarter-l.quarter+(c.year-l.year)*4],["months",(l,c)=>c.month-l.month+(c.year-l.year)*12],["weeks",(l,c)=>{const h=yse(l,c);return(h-h%7)/7}],["days",yse]],s={},n=t;let o,a;for(const[l,c]of i)r.indexOf(l)>=0&&(o=l,s[l]=c(t,e),a=n.plus(s),a>e?(s[l]--,t=n.plus(s)):t=a);return[t,s,a,o]}function hke(t,e,r,i){let[s,n,o,a]=uke(t,e,r);const l=e-s,c=r.filter(p=>["hours","minutes","seconds","milliseconds"].indexOf(p)>=0);c.length===0&&(o<e&&(o=s.plus({[a]:1})),o!==s&&(n[a]=(n[a]||0)+l/(o-s)));const h=Ei.fromObject(n,i);return c.length>0?Ei.fromMillis(l,i).shiftTo(...c).plus(h):h}const FJ={arab:"[٠-٩]",arabext:"[۰-۹]",bali:"[᭐-᭙]",beng:"[০-৯]",deva:"[०-९]",fullwide:"[０-９]",gujr:"[૦-૯]",hanidec:"[〇|一|二|三|四|五|六|七|八|九]",khmr:"[០-៩]",knda:"[೦-೯]",laoo:"[໐-໙]",limb:"[᥆-᥏]",mlym:"[൦-൯]",mong:"[᠐-᠙]",mymr:"[၀-၉]",orya:"[୦-୯]",tamldec:"[௦-௯]",telu:"[౦-౯]",thai:"[๐-๙]",tibt:"[༠-༩]",latn:"\\d"},_se={arab:[1632,1641],arabext:[1776,1785],bali:[6992,7001],beng:[2534,2543],deva:[2406,2415],fullwide:[65296,65303],gujr:[2790,2799],khmr:[6112,6121],knda:[3302,3311],laoo:[3792,3801],limb:[6470,6479],mlym:[3430,3439],mong:[6160,6169],mymr:[4160,4169],orya:[2918,2927],tamldec:[3046,3055],telu:[3174,3183],thai:[3664,3673],tibt:[3872,3881]},dke=FJ.hanidec.replace(/[\[|\]]/g,"").split("");function pke(t){let e=parseInt(t,10);if(isNaN(e)){e="";for(let r=0;r<t.length;r++){const i=t.charCodeAt(r);if(t[r].search(FJ.hanidec)!==-1)e+=dke.indexOf(t[r]);else for(const s in _se){const[n,o]=_se[s];i>=n&&i<=o&&(e+=i-n)}}return parseInt(e,10)}else return e}function ap({numberingSystem:t},e=""){return new RegExp(`${FJ[t||"latn"]}${e}`)}const fke="missing Intl.DateTimeFormat.formatToParts support";function Hi(t,e=r=>r){return{regex:t,deser:([r])=>e(pke(r))}}const mke=String.fromCharCode(160),F_e=`[ ${mke}]`,k_e=new RegExp(F_e,"g");function gke(t){return t.replace(/\./g,"\\.?").replace(k_e,F_e)}function vse(t){return t.replace(/\./g,"").replace(k_e," ").toLowerCase()}function lp(t,e){return t===null?null:{regex:RegExp(t.map(gke).join("|")),deser:([r])=>t.findIndex(i=>vse(r)===vse(i))+e}}function bse(t,e){return{regex:t,deser:([,r,i])=>O6(r,i),groups:e}}function J$(t){return{regex:t,deser:([e])=>e}}function yke(t){return t.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function _ke(t,e){const r=ap(e),i=ap(e,"{2}"),s=ap(e,"{3}"),n=ap(e,"{4}"),o=ap(e,"{6}"),a=ap(e,"{1,2}"),l=ap(e,"{1,3}"),c=ap(e,"{1,6}"),h=ap(e,"{1,9}"),p=ap(e,"{2,4}"),f=ap(e,"{4,6}"),m=v=>({regex:RegExp(yke(v.val)),deser:([b])=>b,literal:!0}),_=(v=>{if(t.literal)return m(v);switch(v.val){case"G":return lp(e.eras("short",!1),0);case"GG":return lp(e.eras("long",!1),0);case"y":return Hi(c);case"yy":return Hi(p,Nj);case"yyyy":return Hi(n);case"yyyyy":return Hi(f);case"yyyyyy":return Hi(o);case"M":return Hi(a);case"MM":return Hi(i);case"MMM":return lp(e.months("short",!0,!1),1);case"MMMM":return lp(e.months("long",!0,!1),1);case"L":return Hi(a);case"LL":return Hi(i);case"LLL":return lp(e.months("short",!1,!1),1);case"LLLL":return lp(e.months("long",!1,!1),1);case"d":return Hi(a);case"dd":return Hi(i);case"o":return Hi(l);case"ooo":return Hi(s);case"HH":return Hi(i);case"H":return Hi(a);case"hh":return Hi(i);case"h":return Hi(a);case"mm":return Hi(i);case"m":return Hi(a);case"q":return Hi(a);case"qq":return Hi(i);case"s":return Hi(a);case"ss":return Hi(i);case"S":return Hi(l);case"SSS":return Hi(s);case"u":return J$(h);case"uu":return J$(a);case"uuu":return Hi(r);case"a":return lp(e.meridiems(),0);case"kkkk":return Hi(n);case"kk":return Hi(p,Nj);case"W":return Hi(a);case"WW":return Hi(i);case"E":case"c":return Hi(r);case"EEE":return lp(e.weekdays("short",!1,!1),1);case"EEEE":return lp(e.weekdays("long",!1,!1),1);case"ccc":return lp(e.weekdays("short",!0,!1),1);case"cccc":return lp(e.weekdays("long",!0,!1),1);case"Z":case"ZZ":return bse(new RegExp(`([+-]${a.source})(?::(${i.source}))?`),2);case"ZZZ":return bse(new RegExp(`([+-]${a.source})(${i.source})?`),2);case"z":return J$(/[a-z_+-/]{1,256}?/i);case" ":return J$(/[^\S\n\r]/);default:return m(v)}})(t)||{invalidReason:fke};return _.token=t,_}const vke={year:{"2-digit":"yy",numeric:"yyyyy"},month:{numeric:"M","2-digit":"MM",short:"MMM",long:"MMMM"},day:{numeric:"d","2-digit":"dd"},weekday:{short:"EEE",long:"EEEE"},dayperiod:"a",dayPeriod:"a",hour:{numeric:"h","2-digit":"hh"},minute:{numeric:"m","2-digit":"mm"},second:{numeric:"s","2-digit":"ss"},timeZoneName:{long:"ZZZZZ",short:"ZZZ"}};function bke(t,e){const{type:r,value:i}=t;if(r==="literal"){const o=/^\s+$/.test(i);return{literal:!o,val:o?" ":i}}const s=e[r];let n=vke[r];if(typeof n=="object"&&(n=n[s]),n)return{literal:!1,val:n}}function wke(t){return[`^${t.map(r=>r.regex).reduce((r,i)=>`${r}(${i.source})`,"")}$`,t]}function xke(t,e,r){const i=t.match(e);if(i){const s={};let n=1;for(const o in r)if(XC(r,o)){const a=r[o],l=a.groups?a.groups+1:1;!a.literal&&a.token&&(s[a.token.val[0]]=a.deser(i.slice(n,n+l))),n+=l}return[i,s]}else return[i,{}]}function Tke(t){const e=n=>{switch(n){case"S":return"millisecond";case"s":return"second";case"m":return"minute";case"h":case"H":return"hour";case"d":return"day";case"o":return"ordinal";case"L":case"M":return"month";case"y":return"year";case"E":case"c":return"weekday";case"W":return"weekNumber";case"k":return"weekYear";case"q":return"quarter";default:return null}};let r=null,i;return gi(t.z)||(r=Of.create(t.z)),gi(t.Z)||(r||(r=new Ja(t.Z)),i=t.Z),gi(t.q)||(t.M=(t.q-1)*3+1),gi(t.h)||(t.h<12&&t.a===1?t.h+=12:t.h===12&&t.a===0&&(t.h=0)),t.G===0&&t.y&&(t.y=-t.y),gi(t.u)||(t.S=IJ(t.u)),[Object.keys(t).reduce((n,o)=>{const a=e(o);return a&&(n[a]=t[o]),n},{}),r,i]}let c9=null;function Ske(){return c9||(c9=kt.fromMillis(1555555555555)),c9}function Eke(t,e){if(t.literal)return t;const r=Pl.macroTokenToFormatOpts(t.val),i=z_e(r,e);return i==null||i.includes(void 0)?t:i}function U_e(t,e){return Array.prototype.concat(...t.map(r=>Eke(r,e)))}function V_e(t,e,r){const i=U_e(Pl.parseFormat(r),t),s=i.map(o=>_ke(o,t)),n=s.find(o=>o.invalidReason);if(n)return{input:e,tokens:i,invalidReason:n.invalidReason};{const[o,a]=wke(s),l=RegExp(o,"i"),[c,h]=xke(e,l,a),[p,f,m]=h?Tke(h):[null,null,void 0];if(XC(h,"a")&&XC(h,"H"))throw new YR("Can't include meridiem when specifying 24-hour format");return{input:e,tokens:i,regex:l,rawMatches:c,matches:h,result:p,zone:f,specificOffset:m}}}function Cke(t,e,r){const{result:i,zone:s,specificOffset:n,invalidReason:o}=V_e(t,e,r);return[i,s,n,o]}function z_e(t,e){return t?Pl.create(e,t).formatDateTimeParts(Ske()).map(s=>bke(s,t)):null}const B_e=[0,31,59,90,120,151,181,212,243,273,304,334],G_e=[0,31,60,91,121,152,182,213,244,274,305,335];function Md(t,e){return new af("unit out of range",`you specified ${e} (of type ${typeof e}) as a ${t}, which is invalid`)}function j_e(t,e,r){const i=new Date(Date.UTC(t,e-1,r));t<100&&t>=0&&i.setUTCFullYear(i.getUTCFullYear()-1900);const s=i.getUTCDay();return s===0?7:s}function H_e(t,e,r){return r+(kP(t)?G_e:B_e)[e-1]}function q_e(t,e){const r=kP(t)?G_e:B_e,i=r.findIndex(n=>n<e),s=e-r[i];return{month:i+1,day:s}}function Fj(t){const{year:e,month:r,day:i}=t,s=H_e(e,r,i),n=j_e(e,r,i);let o=Math.floor((s-n+10)/7),a;return o<1?(a=e-1,o=P5(a)):o>P5(e)?(a=e+1,o=1):a=e,{weekYear:a,weekNumber:o,weekday:n,...R6(t)}}function wse(t){const{weekYear:e,weekNumber:r,weekday:i}=t,s=j_e(e,1,4),n=DM(e);let o=r*7+i-s-3,a;o<1?(a=e-1,o+=DM(a)):o>n?(a=e+1,o-=DM(e)):a=e;const{month:l,day:c}=q_e(a,o);return{year:a,month:l,day:c,...R6(t)}}function u9(t){const{year:e,month:r,day:i}=t,s=H_e(e,r,i);return{year:e,ordinal:s,...R6(t)}}function xse(t){const{year:e,ordinal:r}=t,{month:i,day:s}=q_e(e,r);return{year:e,month:i,day:s,...R6(t)}}function Ake(t){const e=A6(t.weekYear),r=e0(t.weekNumber,1,P5(t.weekYear)),i=e0(t.weekday,1,7);return e?r?i?!1:Md("weekday",t.weekday):Md("week",t.week):Md("weekYear",t.weekYear)}function Oke(t){const e=A6(t.year),r=e0(t.ordinal,1,DM(t.year));return e?r?!1:Md("ordinal",t.ordinal):Md("year",t.year)}function W_e(t){const e=A6(t.year),r=e0(t.month,1,12),i=e0(t.day,1,I5(t.year,t.month));return e?r?i?!1:Md("day",t.day):Md("month",t.month):Md("year",t.year)}function Z_e(t){const{hour:e,minute:r,second:i,millisecond:s}=t,n=e0(e,0,23)||e===24&&r===0&&i===0&&s===0,o=e0(r,0,59),a=e0(i,0,59),l=e0(s,0,999);return n?o?a?l?!1:Md("millisecond",s):Md("second",i):Md("minute",r):Md("hour",e)}const h9="Invalid DateTime",Tse=864e13;function Q$(t){return new af("unsupported zone",`the zone "${t.name}" is not supported`)}function d9(t){return t.weekData===null&&(t.weekData=Fj(t.c)),t.weekData}function DO(t,e){const r={ts:t.ts,zone:t.zone,c:t.c,o:t.o,loc:t.loc,invalid:t.invalid};return new kt({...r,...e,old:r})}function X_e(t,e,r){let i=t-e*60*1e3;const s=r.offset(i);if(e===s)return[i,e];i-=(s-e)*60*1e3;const n=r.offset(i);return s===n?[i,s]:[t-Math.min(s,n)*60*1e3,Math.max(s,n)]}function Sse(t,e){t+=e*60*1e3;const r=new Date(t);return{year:r.getUTCFullYear(),month:r.getUTCMonth()+1,day:r.getUTCDate(),hour:r.getUTCHours(),minute:r.getUTCMinutes(),second:r.getUTCSeconds(),millisecond:r.getUTCMilliseconds()}}function _F(t,e,r){return X_e($J(t),e,r)}function Ese(t,e){const r=t.o,i=t.c.year+Math.trunc(e.years),s=t.c.month+Math.trunc(e.months)+Math.trunc(e.quarters)*3,n={...t.c,year:i,month:s,day:Math.min(t.c.day,I5(i,s))+Math.trunc(e.days)+Math.trunc(e.weeks)*7},o=Ei.fromObject({years:e.years-Math.trunc(e.years),quarters:e.quarters-Math.trunc(e.quarters),months:e.months-Math.trunc(e.months),weeks:e.weeks-Math.trunc(e.weeks),days:e.days-Math.trunc(e.days),hours:e.hours,minutes:e.minutes,seconds:e.seconds,milliseconds:e.milliseconds}).as("milliseconds"),a=$J(n);let[l,c]=X_e(a,r,t.zone);return o!==0&&(l+=o,c=t.zone.offset(l)),{ts:l,o:c}}function NO(t,e,r,i,s,n){const{setZone:o,zone:a}=r;if(t&&Object.keys(t).length!==0||e){const l=e||a,c=kt.fromObject(t,{...r,zone:l,specificOffset:n});return o?c:c.setZone(a)}else return kt.invalid(new af("unparsable",`the input "${s}" can't be parsed as ${i}`))}function K$(t,e,r=!0){return t.isValid?Pl.create(Ks.create("en-US"),{allowZ:r,forceSimple:!0}).formatDateTimeFromString(t,e):null}function p9(t,e){const r=t.c.year>9999||t.c.year<0;let i="";return r&&t.c.year>=0&&(i+="+"),i+=Oo(t.c.year,r?6:4),e?(i+="-",i+=Oo(t.c.month),i+="-",i+=Oo(t.c.day)):(i+=Oo(t.c.month),i+=Oo(t.c.day)),i}function Cse(t,e,r,i,s,n){let o=Oo(t.c.hour);return e?(o+=":",o+=Oo(t.c.minute),(t.c.second!==0||!r)&&(o+=":")):o+=Oo(t.c.minute),(t.c.second!==0||!r)&&(o+=Oo(t.c.second),(t.c.millisecond!==0||!i)&&(o+=".",o+=Oo(t.c.millisecond,3))),s&&(t.isOffsetFixed&&t.offset===0&&!n?o+="Z":t.o<0?(o+="-",o+=Oo(Math.trunc(-t.o/60)),o+=":",o+=Oo(Math.trunc(-t.o%60))):(o+="+",o+=Oo(Math.trunc(t.o/60)),o+=":",o+=Oo(Math.trunc(t.o%60)))),n&&(o+="["+t.zone.ianaName+"]"),o}const Y_e={month:1,day:1,hour:0,minute:0,second:0,millisecond:0},Rke={weekNumber:1,weekday:1,hour:0,minute:0,second:0,millisecond:0},Mke={ordinal:1,hour:0,minute:0,second:0,millisecond:0},J_e=["year","month","day","hour","minute","second","millisecond"],Ike=["weekYear","weekNumber","weekday","hour","minute","second","millisecond"],Pke=["year","ordinal","hour","minute","second","millisecond"];function Ase(t){const e={year:"year",years:"year",month:"month",months:"month",day:"day",days:"day",hour:"hour",hours:"hour",minute:"minute",minutes:"minute",quarter:"quarter",quarters:"quarter",second:"second",seconds:"second",millisecond:"millisecond",milliseconds:"millisecond",weekday:"weekday",weekdays:"weekday",weeknumber:"weekNumber",weeksnumber:"weekNumber",weeknumbers:"weekNumber",weekyear:"weekYear",weekyears:"weekYear",ordinal:"ordinal"}[t.toLowerCase()];if(!e)throw new K0e(t);return e}function Ose(t,e){const r=Hv(e.zone,Co.defaultZone),i=Ks.fromObject(e),s=Co.now();let n,o;if(gi(t.year))n=s;else{for(const c of J_e)gi(t[c])&&(t[c]=Y_e[c]);const a=W_e(t)||Z_e(t);if(a)return kt.invalid(a);const l=r.offset(s);[n,o]=_F(t,l,r)}return new kt({ts:n,zone:r,loc:i,o})}function Rse(t,e,r){const i=gi(r.round)?!0:r.round,s=(o,a)=>(o=PJ(o,i||r.calendary?0:2,!0),e.loc.clone(r).relFormatter(r).format(o,a)),n=o=>r.calendary?e.hasSame(t,o)?0:e.startOf(o).diff(t.startOf(o),o).get(o):e.diff(t,o).get(o);if(r.unit)return s(n(r.unit),r.unit);for(const o of r.units){const a=n(o);if(Math.abs(a)>=1)return s(a,o)}return s(t>e?-0:0,r.units[r.units.length-1])}function Mse(t){let e={},r;return t.length>0&&typeof t[t.length-1]=="object"?(e=t[t.length-1],r=Array.from(t).slice(0,t.length-1)):r=Array.from(t),[e,r]}class kt{constructor(e){const r=e.zone||Co.defaultZone;let i=e.invalid||(Number.isNaN(e.ts)?new af("invalid input"):null)||(r.isValid?null:Q$(r));this.ts=gi(e.ts)?Co.now():e.ts;let s=null,n=null;if(!i)if(e.old&&e.old.ts===this.ts&&e.old.zone.equals(r))[s,n]=[e.old.c,e.old.o];else{const a=r.offset(this.ts);s=Sse(this.ts,a),i=Number.isNaN(s.year)?new af("invalid input"):null,s=i?null:s,n=i?null:a}this._zone=r,this.loc=e.loc||Ks.create(),this.invalid=i,this.weekData=null,this.c=s,this.o=n,this.isLuxonDateTime=!0}static now(){return new kt({})}static local(){const[e,r]=Mse(arguments),[i,s,n,o,a,l,c]=r;return Ose({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static utc(){const[e,r]=Mse(arguments),[i,s,n,o,a,l,c]=r;return e.zone=Ja.utcInstance,Ose({year:i,month:s,day:n,hour:o,minute:a,second:l,millisecond:c},e)}static fromJSDate(e,r={}){const i=i5e(e)?e.valueOf():NaN;if(Number.isNaN(i))return kt.invalid("invalid input");const s=Hv(r.zone,Co.defaultZone);return s.isValid?new kt({ts:i,zone:s,loc:Ks.fromObject(r)}):kt.invalid(Q$(s))}static fromMillis(e,r={}){if(Jx(e))return e<-Tse||e>Tse?kt.invalid("Timestamp out of range"):new kt({ts:e,zone:Hv(r.zone,Co.defaultZone),loc:Ks.fromObject(r)});throw new bd(`fromMillis requires a numerical input, but received a ${typeof e} with value ${e}`)}static fromSeconds(e,r={}){if(Jx(e))return new kt({ts:e*1e3,zone:Hv(r.zone,Co.defaultZone),loc:Ks.fromObject(r)});throw new bd("fromSeconds requires a numerical input")}static fromObject(e,r={}){e=e||{};const i=Hv(r.zone,Co.defaultZone);if(!i.isValid)return kt.invalid(Q$(i));const s=Co.now(),n=gi(r.specificOffset)?i.offset(s):r.specificOffset,o=$5(e,Ase),a=!gi(o.ordinal),l=!gi(o.year),c=!gi(o.month)||!gi(o.day),h=l||c,p=o.weekYear||o.weekNumber,f=Ks.fromObject(r);if((h||a)&&p)throw new YR("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(c&&a)throw new YR("Can't mix ordinal dates with month/day");const m=p||o.weekday&&!h;let g,_,v=Sse(s,n);m?(g=Ike,_=Rke,v=Fj(v)):a?(g=Pke,_=Mke,v=u9(v)):(g=J_e,_=Y_e);let b=!1;for(const P of g){const F=o[P];gi(F)?b?o[P]=_[P]:o[P]=v[P]:b=!0}const x=m?Ake(o):a?Oke(o):W_e(o),T=x||Z_e(o);if(T)return kt.invalid(T);const S=m?wse(o):a?xse(o):o,[O,A]=_F(S,n,i),M=new kt({ts:O,zone:i,o:A,loc:f});return o.weekday&&h&&e.weekday!==M.weekday?kt.invalid("mismatched weekday",`you can't specify both a weekday of ${o.weekday} and a date of ${M.toISO()}`):M}static fromISO(e,r={}){const[i,s]=q5e(e);return NO(i,s,r,"ISO 8601",e)}static fromRFC2822(e,r={}){const[i,s]=W5e(e);return NO(i,s,r,"RFC 2822",e)}static fromHTTP(e,r={}){const[i,s]=Z5e(e);return NO(i,s,r,"HTTP",r)}static fromFormat(e,r,i={}){if(gi(e)||gi(r))throw new bd("fromFormat requires an input string and a format");const{locale:s=null,numberingSystem:n=null}=i,o=Ks.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0}),[a,l,c,h]=Cke(o,e,r);return h?kt.invalid(h):NO(a,l,i,`format ${r}`,e,c)}static fromString(e,r,i={}){return kt.fromFormat(e,r,i)}static fromSQL(e,r={}){const[i,s]=tke(e);return NO(i,s,r,"SQL",e)}static invalid(e,r=null){if(!e)throw new bd("need to specify a reason the DateTime is invalid");const i=e instanceof af?e:new af(e,r);if(Co.throwOnInvalid)throw new L4e(i);return new kt({invalid:i})}static isDateTime(e){return e&&e.isLuxonDateTime||!1}static parseFormatForOpts(e,r={}){const i=z_e(e,Ks.fromObject(r));return i?i.map(s=>s?s.val:null).join(""):null}static expandFormat(e,r={}){return U_e(Pl.parseFormat(e),Ks.fromObject(r)).map(s=>s.val).join("")}get(e){return this[e]}get isValid(){return this.invalid===null}get invalidReason(){return this.invalid?this.invalid.reason:null}get invalidExplanation(){return this.invalid?this.invalid.explanation:null}get locale(){return this.isValid?this.loc.locale:null}get numberingSystem(){return this.isValid?this.loc.numberingSystem:null}get outputCalendar(){return this.isValid?this.loc.outputCalendar:null}get zone(){return this._zone}get zoneName(){return this.isValid?this.zone.name:null}get year(){return this.isValid?this.c.year:NaN}get quarter(){return this.isValid?Math.ceil(this.c.month/3):NaN}get month(){return this.isValid?this.c.month:NaN}get day(){return this.isValid?this.c.day:NaN}get hour(){return this.isValid?this.c.hour:NaN}get minute(){return this.isValid?this.c.minute:NaN}get second(){return this.isValid?this.c.second:NaN}get millisecond(){return this.isValid?this.c.millisecond:NaN}get weekYear(){return this.isValid?d9(this).weekYear:NaN}get weekNumber(){return this.isValid?d9(this).weekNumber:NaN}get weekday(){return this.isValid?d9(this).weekday:NaN}get ordinal(){return this.isValid?u9(this.c).ordinal:NaN}get monthShort(){return this.isValid?Y$.months("short",{locObj:this.loc})[this.month-1]:null}get monthLong(){return this.isValid?Y$.months("long",{locObj:this.loc})[this.month-1]:null}get weekdayShort(){return this.isValid?Y$.weekdays("short",{locObj:this.loc})[this.weekday-1]:null}get weekdayLong(){return this.isValid?Y$.weekdays("long",{locObj:this.loc})[this.weekday-1]:null}get offset(){return this.isValid?+this.o:NaN}get offsetNameShort(){return this.isValid?this.zone.offsetName(this.ts,{format:"short",locale:this.locale}):null}get offsetNameLong(){return this.isValid?this.zone.offsetName(this.ts,{format:"long",locale:this.locale}):null}get isOffsetFixed(){return this.isValid?this.zone.isUniversal:null}get isInDST(){return this.isOffsetFixed?!1:this.offset>this.set({month:1,day:1}).offset||this.offset>this.set({month:5}).offset}get isInLeapYear(){return kP(this.year)}get daysInMonth(){return I5(this.year,this.month)}get daysInYear(){return this.isValid?DM(this.year):NaN}get weeksInWeekYear(){return this.isValid?P5(this.weekYear):NaN}resolvedLocaleOptions(e={}){const{locale:r,numberingSystem:i,calendar:s}=Pl.create(this.loc.clone(e),e).resolvedOptions(this);return{locale:r,numberingSystem:i,outputCalendar:s}}toUTC(e=0,r={}){return this.setZone(Ja.instance(e),r)}toLocal(){return this.setZone(Co.defaultZone)}setZone(e,{keepLocalTime:r=!1,keepCalendarTime:i=!1}={}){if(e=Hv(e,Co.defaultZone),e.equals(this.zone))return this;if(e.isValid){let s=this.ts;if(r||i){const n=e.offset(this.ts),o=this.toObject();[s]=_F(o,n,e)}return DO(this,{ts:s,zone:e})}else return kt.invalid(Q$(e))}reconfigure({locale:e,numberingSystem:r,outputCalendar:i}={}){const s=this.loc.clone({locale:e,numberingSystem:r,outputCalendar:i});return DO(this,{loc:s})}setLocale(e){return this.reconfigure({locale:e})}set(e){if(!this.isValid)return this;const r=$5(e,Ase),i=!gi(r.weekYear)||!gi(r.weekNumber)||!gi(r.weekday),s=!gi(r.ordinal),n=!gi(r.year),o=!gi(r.month)||!gi(r.day),a=n||o,l=r.weekYear||r.weekNumber;if((a||s)&&l)throw new YR("Can't mix weekYear/weekNumber units with year/month/day or ordinals");if(o&&s)throw new YR("Can't mix ordinal dates with month/day");let c;i?c=wse({...Fj(this.c),...r}):gi(r.ordinal)?(c={...this.toObject(),...r},gi(r.day)&&(c.day=Math.min(I5(c.year,c.month),c.day))):c=xse({...u9(this.c),...r});const[h,p]=_F(c,this.o,this.zone);return DO(this,{ts:h,o:p})}plus(e){if(!this.isValid)return this;const r=Ei.fromDurationLike(e);return DO(this,Ese(this,r))}minus(e){if(!this.isValid)return this;const r=Ei.fromDurationLike(e).negate();return DO(this,Ese(this,r))}startOf(e){if(!this.isValid)return this;const r={},i=Ei.normalizeUnit(e);switch(i){case"years":r.month=1;case"quarters":case"months":r.day=1;case"weeks":case"days":r.hour=0;case"hours":r.minute=0;case"minutes":r.second=0;case"seconds":r.millisecond=0;break}if(i==="weeks"&&(r.weekday=1),i==="quarters"){const s=Math.ceil(this.month/3);r.month=(s-1)*3+1}return this.set(r)}endOf(e){return this.isValid?this.plus({[e]:1}).startOf(e).minus(1):this}toFormat(e,r={}){return this.isValid?Pl.create(this.loc.redefaultToEN(r)).formatDateTimeFromString(this,e):h9}toLocaleString(e=M5,r={}){return this.isValid?Pl.create(this.loc.clone(r),e).formatDateTime(this):h9}toLocaleParts(e={}){return this.isValid?Pl.create(this.loc.clone(e),e).formatDateTimeParts(this):[]}toISO({format:e="extended",suppressSeconds:r=!1,suppressMilliseconds:i=!1,includeOffset:s=!0,extendedZone:n=!1}={}){if(!this.isValid)return null;const o=e==="extended";let a=p9(this,o);return a+="T",a+=Cse(this,o,r,i,s,n),a}toISODate({format:e="extended"}={}){return this.isValid?p9(this,e==="extended"):null}toISOWeekDate(){return K$(this,"kkkk-'W'WW-c")}toISOTime({suppressMilliseconds:e=!1,suppressSeconds:r=!1,includeOffset:i=!0,includePrefix:s=!1,extendedZone:n=!1,format:o="extended"}={}){return this.isValid?(s?"T":"")+Cse(this,o==="extended",r,e,i,n):null}toRFC2822(){return K$(this,"EEE, dd LLL yyyy HH:mm:ss ZZZ",!1)}toHTTP(){return K$(this.toUTC(),"EEE, dd LLL yyyy HH:mm:ss 'GMT'")}toSQLDate(){return this.isValid?p9(this,!0):null}toSQLTime({includeOffset:e=!0,includeZone:r=!1,includeOffsetSpace:i=!0}={}){let s="HH:mm:ss.SSS";return(r||e)&&(i&&(s+=" "),r?s+="z":e&&(s+="ZZ")),K$(this,s,!0)}toSQL(e={}){return this.isValid?`${this.toSQLDate()} ${this.toSQLTime(e)}`:null}toString(){return this.isValid?this.toISO():h9}valueOf(){return this.toMillis()}toMillis(){return this.isValid?this.ts:NaN}toSeconds(){return this.isValid?this.ts/1e3:NaN}toUnixInteger(){return this.isValid?Math.floor(this.ts/1e3):NaN}toJSON(){return this.toISO()}toBSON(){return this.toJSDate()}toObject(e={}){if(!this.isValid)return{};const r={...this.c};return e.includeConfig&&(r.outputCalendar=this.outputCalendar,r.numberingSystem=this.loc.numberingSystem,r.locale=this.loc.locale),r}toJSDate(){return new Date(this.isValid?this.ts:NaN)}diff(e,r="milliseconds",i={}){if(!this.isValid||!e.isValid)return Ei.invalid("created by diffing an invalid DateTime");const s={locale:this.locale,numberingSystem:this.numberingSystem,...i},n=s5e(r).map(Ei.normalizeUnit),o=e.valueOf()>this.valueOf(),a=o?this:e,l=o?e:this,c=hke(a,l,n,s);return o?c.negate():c}diffNow(e="milliseconds",r={}){return this.diff(kt.now(),e,r)}until(e){return this.isValid?Rn.fromDateTimes(this,e):this}hasSame(e,r){if(!this.isValid)return!1;const i=e.valueOf(),s=this.setZone(e.zone,{keepLocalTime:!0});return s.startOf(r)<=i&&i<=s.endOf(r)}equals(e){return this.isValid&&e.isValid&&this.valueOf()===e.valueOf()&&this.zone.equals(e.zone)&&this.loc.equals(e.loc)}toRelative(e={}){if(!this.isValid)return null;const r=e.base||kt.fromObject({},{zone:this.zone}),i=e.padding?this<r?-e.padding:e.padding:0;let s=["years","months","days","hours","minutes","seconds"],n=e.unit;return Array.isArray(e.unit)&&(s=e.unit,n=void 0),Rse(r,this.plus(i),{...e,numeric:"always",units:s,unit:n})}toRelativeCalendar(e={}){return this.isValid?Rse(e.base||kt.fromObject({},{zone:this.zone}),this,{...e,numeric:"auto",units:["years","months","days"],calendary:!0}):null}static min(...e){if(!e.every(kt.isDateTime))throw new bd("min requires all arguments be DateTimes");return fse(e,r=>r.valueOf(),Math.min)}static max(...e){if(!e.every(kt.isDateTime))throw new bd("max requires all arguments be DateTimes");return fse(e,r=>r.valueOf(),Math.max)}static fromFormatExplain(e,r,i={}){const{locale:s=null,numberingSystem:n=null}=i,o=Ks.fromOpts({locale:s,numberingSystem:n,defaultToEN:!0});return V_e(o,e,r)}static fromStringExplain(e,r,i={}){return kt.fromFormatExplain(e,r,i)}static get DATE_SHORT(){return M5}static get DATE_MED(){return e_e}static get DATE_MED_WITH_WEEKDAY(){return F4e}static get DATE_FULL(){return t_e}static get DATE_HUGE(){return r_e}static get TIME_SIMPLE(){return i_e}static get TIME_WITH_SECONDS(){return s_e}static get TIME_WITH_SHORT_OFFSET(){return n_e}static get TIME_WITH_LONG_OFFSET(){return o_e}static get TIME_24_SIMPLE(){return a_e}static get TIME_24_WITH_SECONDS(){return l_e}static get TIME_24_WITH_SHORT_OFFSET(){return c_e}static get TIME_24_WITH_LONG_OFFSET(){return u_e}static get DATETIME_SHORT(){return h_e}static get DATETIME_SHORT_WITH_SECONDS(){return d_e}static get DATETIME_MED(){return p_e}static get DATETIME_MED_WITH_SECONDS(){return f_e}static get DATETIME_MED_WITH_WEEKDAY(){return k4e}static get DATETIME_FULL(){return m_e}static get DATETIME_FULL_WITH_SECONDS(){return g_e}static get DATETIME_HUGE(){return y_e}static get DATETIME_HUGE_WITH_SECONDS(){return __e}}function FO(t){if(kt.isDateTime(t))return t;if(t&&t.valueOf&&Jx(t.valueOf()))return kt.fromJSDate(t);if(t&&typeof t=="object")return kt.fromObject(t);throw new bd(`Unknown datetime argument: ${t}, of type ${typeof t}`)}const $ke={year:void 0,month:void 0,day:void 0,weekday:void 0},Lke={hour:void 0,minute:void 0,second:void 0},Dke={timeZone:Intl.DateTimeFormat().resolvedOptions().timeZone},kJ={timeZone:"Etc/UTC"},qf={year:"numeric",month:"numeric",day:"numeric"},kO={year:"numeric",month:"long",day:"numeric"},UO={year:"numeric",month:"short",day:"numeric"},VO={year:"numeric",month:"long",weekday:"long",day:"numeric"},Gh={hour:"numeric",minute:"numeric"},cp={...Gh,second:"numeric"},eO={"short-date":qf,"short-date-short-time":{...qf,...Gh},"short-date-short-time-24":{...qf,...Gh,hour12:!1},"short-date-long-time":{...qf,...cp},"short-date-long-time-24":{...qf,...cp,hour12:!1},"short-date-le":qf,"short-date-le-short-time":{...qf,...Gh},"short-date-le-short-time-24":{...qf,...Gh,hour12:!1},"short-date-le-long-time":{...qf,...cp},"short-date-le-long-time-24":{...qf,...cp,hour12:!1},"long-month-day-year":kO,"long-month-day-year-short-time":{...kO,...Gh},"long-month-day-year-short-time-24":{...kO,...Gh,hour12:!1},"long-month-day-year-long-time":{...kO,...cp},"long-month-day-year-long-time-24":{...kO,...cp,hour12:!1},"day-short-month-year":UO,"day-short-month-year-short-time":{...UO,...Gh},"day-short-month-year-short-time-24":{...UO,...Gh,hour12:!1},"day-short-month-year-long-time":{...UO,...cp},"day-short-month-year-long-time-24":{...UO,...cp,hour12:!1},"long-date":VO,"long-date-short-time":{...VO,...Gh},"long-date-short-time-24":{...VO,...Gh,hour12:!1},"long-date-long-time":{...VO,...cp},"long-date-long-time-24":{...VO,...cp,hour12:!1},"long-month-year":{month:"long",year:"numeric"},"short-month-year":{month:"short",year:"numeric"},year:{year:"numeric"},"short-time":Gh,"long-time":cp},Nke=zl()({shortDate:"short-date",shortDateShortTime:"short-date-short-time",shortDateShortTime24:"short-date-short-time-24",shortDateLongTime:"short-date-long-time",shortDateLongTime24:"short-date-long-time-24",shortDateLE:"short-date-le",shortDateLEShortTime:"short-date-le-short-time",shortDateLEShortTime24:"short-date-le-short-time-24",shortDateLELongTime:"short-date-le-long-time",shortDateLELongTime24:"short-date-le-long-time-24",longMonthDayYear:"long-month-day-year",longMonthDayYearShortTime:"long-month-day-year-short-time",longMonthDayYearShortTime24:"long-month-day-year-short-time-24",longMonthDayYearLongTime:"long-month-day-year-long-time",longMonthDayYearLongTime24:"long-month-day-year-long-time-24",dayShortMonthYear:"day-short-month-year",dayShortMonthYearShortTime:"day-short-month-year-short-time",dayShortMonthYearShortTime24:"day-short-month-year-short-time-24",dayShortMonthYearLongTime:"day-short-month-year-long-time",dayShortMonthYearLongTime24:"day-short-month-year-long-time-24",longDate:"long-date",longDateShortTime:"long-date-short-time",longDateShortTime24:"long-date-short-time-24",longDateLongTime:"long-date-long-time",longDateLongTime24:"long-date-long-time-24",longMonthYear:"long-month-year",shortMonthYear:"short-month-year",year:"year"}),Q_e={ar:"ar-u-nu-latn-ca-gregory"};let kj=new WeakMap,K_e=eO["short-date-short-time"];function Fke(t){const e=t||K_e;let r=kj.get(e);if(!r){const i=Ld(),s=Q_e[i]||i;r=new Intl.DateTimeFormat(s,e),kj.set(e,r)}return r}function zE(t){return eO[t]}function Vd(t,e){return Fke(e).format(t)}function UJ(t,e=eO["short-date"]){return Vd(new Date(t),{...e,...kJ,...Lke})}function VJ(t,e=eO["short-time"]){return Vd(new Date(`1970-01-01T${t}Z`),{...e,...kJ,...$ke})}function zJ(t,e=eO["short-date-short-time"]){const r=kt.fromISO(t,{setZone:!0}),i=Ld(),s=Q_e[i]??i;return r.toLocaleString({...Dke,...e},{locale:s})}MJ(()=>{kj=new WeakMap,K_e=eO["short-date-short-time"]});function Dl(t,e){return t!=null?e(t):null}function Ha(t,e){return rS(t,e),t}function rS(t,e){if(t==null)throw new Error(e??"value is None")}function Re(t){return t?.destroy(),null}function ze(t){return t?.dispose(),null}function Pi(t){return t?.remove(),null}function Do(t){return t?.abort(),null}function as(t){return t?.release(),null}function kke(t,e,r){return t!=null&&e!=null?r!=null?r(t,e):t.equals(e):t===e}function tO(t){return null}function ADt(t,e){const r=new Array;for(const i of t)r.push(i!=null?e(i):null);return r}function ODt(t,e){for(const r of t)Dl(r,e)}function RDt(t){return t}const Uke={ar:"ar-u-nu-latn"};let vF=new WeakMap,eve={};function Vke(t){const e=t||eve;if(!vF.has(e)){const r=Ld(),i=Uke[Ld()]||r;vF.set(e,new Intl.NumberFormat(i,t))}return vF.get(e)}function tve(t={}){const e={};return t.digitSeparator!=null&&(e.useGrouping=t.digitSeparator),t.places!=null&&(e.minimumFractionDigits=e.maximumFractionDigits=t.places),e}function zd(t,e){return Object.is(t,-0)&&(t=0),Vke(e).format(t)}MJ(()=>{vF=new WeakMap,eve={}});const qr={analysisTheme:{accentColor:[255,127,0],textColor:"white"},apiKey:void 0,applicationName:"",applicationUrl:globalThis.location?.href,assetsPath:"",fontsUrl:"https://static.arcgis.com/fonts",geometryServiceUrl:"https://utility.arcgisonline.com/arcgis/rest/services/Geometry/GeometryServer",geoRSSServiceUrl:"https://utility.arcgis.com/sharing/rss",kmlServiceUrl:"https://utility.arcgis.com/sharing/kml",userPrivilegesApplied:!1,portalUrl:"https://www.arcgis.com",routeServiceUrl:"https://route-api.arcgis.com/arcgis/rest/services/World/Route/NAServer/Route_World",workers:{loaderConfig:{has:{},paths:{},map:{},packages:[]}},request:{crossOriginNoCorsDomains:null,httpsDomains:["arcgis.com","arcgisonline.com","esrikr.com","premiumservices.blackbridge.com","esripremium.accuweather.com","gbm.digitalglobe.com","firstlook.digitalglobe.com","msi.digitalglobe.com"],interceptors:[],maxUrlLength:2e3,priority:"high",proxyRules:[],proxyUrl:null,timeout:6e4,trustedServers:[],useIdentity:!0},log:{interceptors:[],level:null}};if(globalThis.esriConfig&&(Z0e(qr,globalThis.esriConfig,!0),delete qr.has),!qr.assetsPath){{const t="4.27";qr.assetsPath=`https://js.arcgis.com/${t}/@arcgis/core/assets`}qr.defaultAssetsPath=qr.assetsPath}const zke=/\{([^\}]+)\}/g;function Ise(t){return t??""}function fg(t,e){return t.replaceAll(zke,typeof e=="object"?(r,i)=>Ise(Ky(i,e)):(r,i)=>Ise(e(i)))}function MDt(t,e){return t.replaceAll(/([\.$?*|{}\(\)\[\]\\\/\+\-^])/g,r=>e&&e.includes(r)?r:`\\${r}`)}function BJ(t){let e=0;for(let r=0;r<t.length;r++)e=(e<<5)-e+t.charCodeAt(r),e|=0;return e}function IDt(t){return new DOMParser().parseFromString(t||"","text/html").body.innerText||""}function PI(t,e){return new RegExp(`{${e}}`,"ig").test(t)}const Pse={info:0,warn:1,error:2,none:3};let K=class gl{constructor(e){this.level=null,this._module="",this._parent=null,this.writer=null,this._loggedMessages={error:new Map,warn:new Map,info:new Map},e.level!=null&&(this.level=e.level),e.writer!=null&&(this.writer=e.writer),this._module=e.module,gl._loggers.set(this.module,this);const r=this.module.lastIndexOf(".");r!==-1&&(this._parent=gl.getLogger(this.module.slice(0,r)))}get module(){return this._module}get parent(){return this._parent}error(...e){this._log("error","always",...e)}warn(...e){this._log("warn","always",...e)}info(...e){this._log("info","always",...e)}errorOnce(...e){this._log("error","once",...e)}warnOnce(...e){this._log("warn","once",...e)}infoOnce(...e){this._log("info","once",...e)}errorOncePerTick(...e){this._log("error","oncePerTick",...e)}warnOncePerTick(...e){this._log("warn","oncePerTick",...e)}infoOncePerTick(...e){this._log("info","oncePerTick",...e)}get test(){const e=this;return{loggedMessages:e._loggedMessages,clearLoggedWarnings:()=>e._loggedMessages.warn.clear()}}static get test(){return{resetLoggers(e=new Map){const r=gl._loggers;return gl._loggers=e,r},set throttlingDisabled(e){gl._throttlingDisabled=e}}}static getLogger(e){return e=typeof e!="string"?e.declaredClass:e,gl._loggers.get(e)||new gl({module:e})}_log(e,r,...i){if(this._matchLevel(e)){if(r!=="always"&&!gl._throttlingDisabled){const s=this._argsToKey(i),n=this._loggedMessages[e].get(s);if(r==="once"&&n!=null||r==="oncePerTick"&&n&&n>=gl._tickCounter)return;this._loggedMessages[e].set(s,gl._tickCounter),gl._scheduleTickCounterIncrement()}for(const s of qr.log.interceptors)if(s(e,this.module,...i))return;this._inheritedWriter()(e,this.module,...i)}}_parentWithMember(e,r){let i=this;for(;i!=null;){const s=i[e];if(s!=null)return s;i=i.parent}return r}_inheritedWriter(){return this._parentWithMember("writer",this._consoleWriter)}_consoleWriter(e,r,...i){console[e](`[${r}]`,...i)}_matchLevel(e){const r=qr.log.level||"warn";return Pse[this._parentWithMember("level",r)]<=Pse[e]}_argsToKey(...e){return BJ(JSON.stringify(e,(i,s)=>typeof s!="object"||Array.isArray(s)?s:"[Object]"))}static _scheduleTickCounterIncrement(){gl._tickCounterScheduled||(gl._tickCounterScheduled=!0,Promise.resolve().then(()=>{gl._tickCounter++,gl._tickCounterScheduled=!1}))}};K._loggers=new Map,K._tickCounter=0,K._tickCounterScheduled=!1,K._throttlingDisabled=!1;const rve=K.getLogger("esri.intl.substitute");function s1(t,e,r={}){const{format:i={}}=r;return fg(t,s=>Bke(s,e,i))}function Bke(t,e,r){let i,s;const n=t.indexOf(":");if(n===-1?i=t.trim():(i=t.slice(0,n).trim(),s=t.slice(n+1).trim()),!i)return"";const o=Ky(i,e);if(o==null)return"";const a=(s?r?.[s]:null)??r?.[i];return a?Gke(o,a):s?jke(o,s):GJ(o)}function Gke(t,e){switch(e.type){case"date":return Vd(t,e.intlOptions);case"number":return zd(t,e.intlOptions);default:return rve.warn("missing format descriptor for key {key}"),GJ(t)}}function jke(t,e){switch(e.toLowerCase()){case"dateformat":return Vd(t);case"numberformat":return zd(t);default:return rve.warn(`inline format is unsupported since 4.12: ${e}`),/^(dateformat|datestring)/i.test(e)?Vd(t):/^numberformat/i.test(e)?zd(t):GJ(t)}}function GJ(t){switch(typeof t){case"string":return t;case"number":return zd(t);case"boolean":return""+t;default:return t instanceof Date?Vd(t):""}}function Hke(t,e){return t.replaceAll(/\$\{([^\s\:\}]*)(?:\:([^\s\:\}]+))?\}/g,(r,i)=>i===""?"$":(Ky(i,e)??"").toString())}let ive=class{constructor(e,r,i){this.name=e,this.details=i,this.message=(r&&Hke(r,i))??""}toString(){return"["+this.name+"]: "+this.message}},D=class sve extends ive{constructor(e,r,i){super(e,r,i)}toJSON(){if(this.details!=null)try{return{name:this.name,message:this.message,details:JSON.parse(JSON.stringify(this.details,(e,r)=>{if(r&&typeof r=="object"&&typeof r.toJSON=="function")return r;try{return re(r)}catch{return"[object]"}}))}}catch(e){throw K.getLogger("esri.core.Error").error(e),e}return{name:this.name,message:this.message,details:this.details}}static fromJSON(e){return new sve(e.name,e.message,e.details)}};D.prototype.type="error";function qke(t){return{setTimeout:(e,r)=>{const i=t.setTimeout(e,r);return{remove:()=>t.clearTimeout(i)}}}}const zP=qke(globalThis);function M6(t){return t&&(typeof t.on=="function"||typeof t.addEventListener=="function")}function w1(t,e,r){if(!M6(t))throw new TypeError("target is not a Evented or EventTarget object");if("on"in t)return t.on(e,r);if(Array.isArray(e)){const i=e.slice();for(const s of i)t.addEventListener(s,r);return{remove(){for(const s of i)t.removeEventListener(s,r)}}}return t.addEventListener(e,r),{remove(){t.removeEventListener(e,r)}}}function nve(t,e,r){if(!M6(t))throw new TypeError("target is not a Evented or EventTarget object");if("once"in t)return t.once(e,r);const i=w1(t,e,s=>{i.remove(),r.call(t,s)});return{remove(){i.remove()}}}const Wke={Win:"Meta",Scroll:"ScrollLock",Spacebar:" ",Down:"ArrowDown",Left:"ArrowLeft",Right:"ArrowRight",Up:"ArrowUp",Del:"Delete",Apps:"ContextMenu",Esc:"Escape",Multiply:"*",Add:"+",Subtract:"-",Decimal:".",Divide:"/"};function Zke({key:t}){return Wke[t]||t}function Tr(t="Aborted"){return new D("AbortError",t)}function Dt(t,e="Aborted"){if(dn(t))throw Tr(e)}function I6(t){return t!=null?"aborted"in t?t:t.signal:t}function dn(t){const e=I6(t);return e!=null&&e.aborted}function xa(t){if(ws(t))throw t}function Uj(t){if(!ws(t))throw t}function xn(t,e){const r=I6(t);if(r!=null){if(!r.aborted)return nve(r,"abort",()=>e());e()}}function jJ(t,e){const r=I6(t);if(r!=null)return Dt(r),nve(r,"abort",()=>e(Tr()))}function gT(t,e){return I6(e)==null?t:new Promise((r,i)=>{let s=xn(e,()=>i(Tr()));const n=()=>s=Pi(s);t.then(n,n),t.then(r,i)})}function ws(t){return t?.name==="AbortError"}async function gC(t){try{return await t}catch(e){if(!ws(e))throw e;return}}async function $Dt(t,e=K.getLogger("esri")){try{return await t}catch(r){ws(r)||e.error(r)}}async function Oh(t){if(!t)return;if(typeof t.forEach!="function"){const r=Object.keys(t),i=r.map(o=>t[o]),s=await Oh(i),n={};return r.map((o,a)=>n[o]=s[a]),n}const e=t;return Promise.allSettled(e).then(r=>Array.from(e,(i,s)=>{const n=r[s];return n.status==="fulfilled"?{promise:i,value:n.value}:{promise:i,error:n.reason}}))}async function L5(t){return(await Oh(t)).filter(e=>!!e.value).map(e=>e.value)}function YC(t,e=void 0,r){const i=new AbortController;return xn(r,()=>i.abort()),new Promise((s,n)=>{let o=setTimeout(()=>{o=0,s(e)},t);xn(i,()=>{o&&(clearTimeout(o),n(Tr()))})})}function Rh(t){return t&&typeof t.then=="function"}function Vj(t){return Rh(t)?t:Promise.resolve(t)}function x1(t,e=-1){let r,i,s,n,o=null;const a=(...l)=>{if(r){i=l,n&&n.reject(Tr()),n=nn();const f=n.promise;if(o){const m=o;o=null,m.abort()}return f}if(s=n||nn(),n=null,e>0){const f=new AbortController;r=Vj(t(...l,f.signal));const m=r;YC(e).then(()=>{r===m&&(n?f.abort():o=f)})}else r=1,r=Vj(t(...l));const c=()=>{const f=i;i=s=r=o=null,f!=null&&a(...f)},h=r,p=s;return h.then(c,c),h.then(p.resolve,p.reject),p.promise};return a}function nn(){let t,e;const r=new Promise((s,n)=>{t=s,e=n}),i=s=>{t(s)};return i.resolve=s=>t(s),i.reject=s=>e(s),i.timeout=(s,n)=>zP.setTimeout(()=>i.reject(n),s),i.promise=r,i}function LDt(t,e){return t.then(e,e)}async function $se(t){await Promise.resolve(),Dt(t)}const Lse=/^([a-z]{2})(?:[-_]([A-Za-z]{2}))?$/,Xke={ar:!0,bg:!0,bs:!0,ca:!0,cs:!0,da:!0,de:!0,el:!0,en:!0,es:!0,et:!0,fi:!0,fr:!0,he:!0,hr:!0,hu:!0,id:!0,it:!0,ja:!0,ko:!0,lt:!0,lv:!0,nb:!0,nl:!0,pl:!0,"pt-BR":!0,"pt-PT":!0,ro:!0,ru:!0,sk:!0,sl:!0,sr:!0,sv:!0,th:!0,tr:!0,uk:!0,vi:!0,"zh-CN":!0,"zh-HK":!0,"zh-TW":!0};function Dse(t){return t in Xke}const QR=[],yC=new Map;function Nse(t){for(const e of yC.keys())ave(t.pattern,e)&&yC.delete(e)}function Yke(t){return QR.includes(t)||(Nse(t),QR.unshift(t)),{remove(){const e=QR.indexOf(t);e>-1&&(QR.splice(e,1),Nse(t))}}}async function ove(t){const e=Ld();yC.has(t)||yC.set(t,Qke(t,e));const r=yC.get(t);return r&&await Kke.add(r),r}function Jke(t){if(!Lse.test(t))return null;const e=Lse.exec(t);if(e===null)return null;const[,r,i]=e,s=r+(i?"-"+i.toUpperCase():"");return Dse(s)?s:Dse(r)?r:null}async function Qke(t,e){const r=[];for(const i of QR)if(ave(i.pattern,t))try{return await i.fetchMessageBundle(t,e)}catch(s){r.push(s)}throw r.length?new D("intl:message-bundle-error",`Errors occurred while loading "${t}"`,{errors:r}):new D("intl:no-message-bundle-loader",`No loader found for message bundle "${t}"`)}function ave(t,e){return typeof t=="string"?e.startsWith(t):t.test(e)}MJ(()=>{yC.clear()});const Kke=new class{constructor(){this._numLoading=0,this._dfd=null}async waitForAll(){this._dfd&&await this._dfd.promise}add(t){return this._increase(),t.then(()=>this._decrease(),()=>this._decrease()),this.waitForAll()}_increase(){this._numLoading++,this._dfd||(this._dfd=nn())}_decrease(){this._numLoading=Math.max(this._numLoading-1,0),this._dfd&&this._numLoading===0&&(this._dfd.resolve(),this._dfd=null)}},eUe=/^https:\/\/([a-z\d-]+)(\.maps([^.]*))?\.arcgis\.com/i,tUe={devext:{customBaseUrl:"mapsdevext.arcgis.com",portalHostname:"devext.arcgis.com"},qaext:{customBaseUrl:"mapsqa.arcgis.com",portalHostname:"qaext.arcgis.com"},www:{customBaseUrl:"maps.arcgis.com",portalHostname:"www.arcgis.com"}};function zj(t){const e=t?.match(eUe);if(!e)return null;const[,r,i,s]=e;if(!r)return null;let n=null,o=null,a=null;const{devext:l,qaext:c,www:h}=tUe;if(i)if(n=r,s)switch(s.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qa":({customBaseUrl:o,portalHostname:a}=c);break;default:return null}else({customBaseUrl:o,portalHostname:a}=h);else switch(r.toLowerCase()){case"devext":({customBaseUrl:o,portalHostname:a}=l);break;case"qaext":({customBaseUrl:o,portalHostname:a}=c);break;case"www":({customBaseUrl:o,portalHostname:a}=h);break;default:return null}return{customBaseUrl:o,isPortal:!1,portalHostname:a,urlKey:n}}function lve(t){return/\/(sharing|usrsvcs)\/(appservices|servers)\//i.test(t)}function rUe(t){const e=atob(t),r=new Uint8Array(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return r.buffer}const iUe=K.getLogger("esri.core.urlUtils"),rO=qr.request,Fse="esri/config: esriConfig.request.proxyUrl is not set.",cve=/^\s*[a-z][a-z0-9-+.]*:(?![0-9])/i,uve=/^\s*http:/i,sUe=/^\s*https:/i,nUe=/^\s*file:/i,oUe=/:\d+$/,aUe=/^https?:\/\/[^/]+\.arcgis.com\/sharing(\/|$)/i,lUe=new RegExp("^(([^:/?#]+):)?(//([^/?#]*))?([^?#]*)(\\?([^#]*))?(#(.*))?$"),cUe=new RegExp("^((([^\\[:]+):)?([^@]+)@)?(\\[([^\\]]+)\\]|([^\\[:]*))(:([0-9]+))?$");let uh=class{constructor(e=""){this.uri=e,this.scheme=null,this.authority=null,this.path=null,this.query=null,this.fragment=null,this.user=null,this.password=null,this.host=null,this.port=null;let r=this.uri.match(lUe);this.scheme=r[2]||(r[1]?"":null),this.authority=r[4]||(r[3]?"":null),this.path=r[5],this.query=r[7]||(r[6]?"":null),this.fragment=r[9]||(r[8]?"":null),this.authority!=null&&(r=this.authority.match(cUe),this.user=r[3]||null,this.password=r[4]||null,this.host=r[6]||r[7],this.port=r[9]||null)}toString(){return this.uri}};const eL={},uUe=new uh(qr.applicationUrl);let $l=uUe;const hUe=dUe();let HJ=hUe;const qJ=()=>$l,NDt=()=>HJ;function dUe(){const t=$l.path,e=t.substring(0,t.lastIndexOf(t.split("/")[t.split("/").length-1]));return`${`${$l.scheme}://${$l.host}${$l.port!=null?`:${$l.port}`:""}`}${e}`}function Fn(t){if(!t)return null;const e={path:null,query:null},r=new uh(t),i=t.indexOf("?");return r.query===null?e.path=t:(e.path=t.substring(0,i),e.query=Vx(r.query)),r.fragment&&(e.hash=r.fragment,r.query===null&&(e.path=e.path.substring(0,e.path.length-(r.fragment.length+1)))),e}function Vx(t){const e=t.split("&"),r={};for(const i of e){if(!i)continue;const s=i.indexOf("=");let n,o;s<0?(n=decodeURIComponent(i),o=""):(n=decodeURIComponent(i.slice(0,s)),o=decodeURIComponent(i.slice(s+1)));let a=r[n];typeof a=="string"&&(a=r[n]=[a]),Array.isArray(a)?a.push(o):r[n]=o}return r}function kse(t){return t&&typeof t=="object"&&"toJSON"in t&&typeof t.toJSON=="function"}function yT(t,e){return t?e&&typeof e=="function"?Object.keys(t).map(r=>encodeURIComponent(r)+"="+encodeURIComponent(e(r,t[r]))).join("&"):Object.keys(t).map(r=>{const i=t[r];if(i==null)return"";const s=encodeURIComponent(r)+"=",n=e&&e[r];return n?s+encodeURIComponent(n(i)):Array.isArray(i)?i.map(o=>kse(o)?s+encodeURIComponent(JSON.stringify(o)):s+encodeURIComponent(o)).join("&"):kse(i)?s+encodeURIComponent(JSON.stringify(i)):s+encodeURIComponent(i)}).filter(r=>r).join("&"):""}function pUe(t=!1){let e,r=rO.proxyUrl;if(typeof t=="string"){e=vUe(t);const i=BP(t);i&&(r=i.proxyUrl)}else e=!!t;if(!r)throw iUe.warn(Fse),new D("urlutils:proxy-not-set",Fse);return e&&Bj()&&(r=QJ(r)),Fn(r)}function FDt(t){const e=BP(t);let r,i;if(e){const s=WJ(e.proxyUrl);r=s.path,i=s.query?Vx(s.query):null}if(r){const s=Fn(t);t=r+"?"+s.path;const n=yT({...i,...s.query});n&&(t=`${t}?${n}`)}return t}const zO={path:"",query:""};function WJ(t){const e=t.indexOf("?");return e!==-1?(zO.path=t.slice(0,e),zO.query=t.slice(e+1)):(zO.path=t,zO.query=null),zO}function hve(t){return t=(t=N5(t=SUe(t=WJ(t).path),!0)).toLowerCase()}function fUe(t){const e={proxyUrl:t.proxyUrl,urlPrefix:hve(t.urlPrefix)},r=rO.proxyRules,i=e.urlPrefix;let s=r.length;for(let n=0;n<r.length;n++){const o=r[n].urlPrefix;if(i.indexOf(o)===0){if(i.length===o.length)return-1;s=n;break}o.indexOf(i)===0&&(s=n+1)}return r.splice(s,0,e),s}function BP(t){const e=rO.proxyRules,r=hve(t);for(let i=0;i<e.length;i++)if(r.indexOf(e[i].urlPrefix)===0)return e[i]}function mUe(t,e){if(!t||!e)return!1;t=D5(t),e=D5(e);const r=zj(t),i=zj(e);return r!=null&&i!=null?r.portalHostname===i.portalHostname:r==null&&i==null&&nu(t,e,!0)}function dve(t,e){return t=D5(t),e=D5(e),N5(t)===N5(e)}function D5(t){const e=(t=Dd(t)).indexOf("/sharing");return e>0?t.substring(0,e):t.replace(/\/+$/,"")}function pve(t){const e=i=>i==null||i instanceof RegExp&&i.test(t)||typeof i=="string"&&t.startsWith(i),r=rO.interceptors;if(r){for(const i of r)if(Array.isArray(i.urls)){if(i.urls.some(e))return i}else if(e(i.urls))return i}return null}function nu(t,e,r=!1){if(!t||!e)return!1;const i=jj(t),s=jj(e);return!(!r&&i.scheme!==s.scheme)&&i.host!=null&&s.host!=null&&i.host.toLowerCase()===s.host.toLowerCase()&&i.port===s.port}function ZJ(t){if(typeof t=="string"){if(!wu(t))return!0;t=jj(t)}if(nu(t,$l))return!0;const e=rO.trustedServers||[];for(let r=0;r<e.length;r++){const i=gUe(e[r]);for(let s=0;s<i.length;s++)if(nu(t,i[s]))return!0}return!1}function gUe(t){return eL[t]||(JJ(t)||mg(t)?eL[t]=[new uh(pc(t))]:eL[t]=[new uh(`http://${t}`),new uh(`https://${t}`)]),eL[t]}function pc(t,e=HJ,r){return mg(t)?r&&r.preserveProtocolRelative?t:$l.scheme==="http"&&$l.authority===_f(t).slice(2)?`http:${t}`:`https:${t}`:JJ(t)?t:Cu(t[0]==="/"?TUe(e):e,t)}function XJ(t,e=HJ,r){if(t==null||!wu(t))return t;const i=Dd(t),s=i.toLowerCase(),n=Dd(e).toLowerCase().replace(/\/+$/,""),o=r?Dd(r).toLowerCase().replace(/\/+$/,""):null;if(o&&n.indexOf(o)!==0)return t;const a=(p,f,m)=>(m=p.indexOf(f,m))===-1?p.length:m;let l=a(s,"/",s.indexOf("//")+2),c=-1;for(;s.slice(0,l+1)===n.slice(0,l)+"/"&&(c=l+1,l!==s.length);)l=a(s,"/",l+1);if(c===-1||o&&c<o.length)return t;t=i.slice(c);const h=n.slice(c-1).replaceAll(/[^/]+/g,"").length;if(h>0)for(let p=0;p<h;p++)t=`../${t}`;else t=`./${t}`;return t}function Dd(t){return t=AUe(t=CUe(t=EUe(t=pc(t=t.trim()))))}function Cu(...t){const e=t.filter(Ia);if(!e||!e.length)return;const r=[];if(wu(e[0])){const s=e[0],n=s.indexOf("//");n!==-1&&(r.push(s.slice(0,n+1)),wUe(e[0])&&(r[0]+="/"),e[0]=s.slice(n+2))}else e[0][0]==="/"&&r.push("");const i=e.reduce((s,n)=>n?s.concat(n.split("/")):s,[]);for(let s=0;s<i.length;s++){const n=i[s];n===".."&&r.length>0&&r[r.length-1]!==".."?r.pop():(!n&&s===i.length-1||n&&(n!=="."||r.length===0))&&r.push(n)}return r.join("/")}function _f(t,e=!1){if(t==null||$1(t)||Ig(t))return null;let r=t.indexOf("://");if(r===-1&&mg(t))r=2;else{if(r===-1)return null;r+=3}const i=t.indexOf("/",r);return i!==-1&&(t=t.slice(0,i)),e&&(t=N5(t,!0)),t}function wu(t){return mg(t)||JJ(t)}function $1(t){return t!=null&&t.slice(0,5)==="blob:"}function Ig(t){return t!=null&&t.slice(0,5)==="data:"}function YJ(t){const e=_T(t);return e&&e.isBase64?rUe(e.data):null}function f9(t){return btoa(String.fromCharCode.apply(null,t)).replaceAll("+","-").replaceAll("/","_").replace(/=+$/,"")}const yUe=/^data:(.*?)(;base64)?,(.*)$/;function _T(t){const e=t.match(yUe);if(!e)return null;const[,r,i,s]=e;return{mediaType:r,isBase64:!!i,data:s}}function fve(t){return t.isBase64?`data:${t.mediaType};base64,${t.data}`:`data:${t.mediaType},${t.data}`}function kDt(t){const e=YJ(t);if(!e)return null;const r=_T(t);return new Blob([e],{type:r.mediaType})}function UDt(t,e){_Ue(t,e)}function _Ue(t,e){if(!t)return!1;const r=document.createElement("a");if(!("download"in r))return!1;const i=URL.createObjectURL(t);return r.download=e,r.href=i,r.style.display="none",document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(i),!0}function mg(t){return t!=null&&t[0]==="/"&&t[1]==="/"}function JJ(t){return t!=null&&cve.test(t)}function vUe(t){return t!=null&&sUe.test(t)||$l.scheme==="https"&&mg(t)}function bUe(t){return t!=null&&uve.test(t)||$l.scheme==="http"&&mg(t)}function wUe(t){return t!=null&&nUe.test(t)}function QJ(t){return mg(t)?`https:${t}`:t.replace(uve,"https:")}function xUe(){return $l.scheme==="http"}function Bj(){return $l.scheme==="https"}function N5(t,e=!1){return mg(t)?t.slice(2):(t=t.replace(cve,""),e&&t.length>1&&t[0]==="/"&&t[1]==="/"&&(t=t.slice(2)),t)}function TUe(t){const e=t.indexOf("//"),r=t.indexOf("/",e+2);return r===-1?t:t.slice(0,r)}function KJ(t){let e=0;if(wu(t)){const i=t.indexOf("//");i!==-1&&(e=i+2)}const r=t.lastIndexOf("/");return r<e?t:t.slice(0,r+1)}function VDt(t,e){if(!t)return"";const r=Fn(t).path.replace(/\/+$/,""),i=r.substring(r.lastIndexOf("/")+1);if(!e?.length)return i;const s=new RegExp(`.(${e.join("|")})$`,"ig");return i.replace(s,"")}function SUe(t){return t&&t[t.length-1]==="/"?t:`${t}/`}function mve(t){return t.replace(/\/+$/,"")}function EUe(t){if(/^https?:\/\//i.test(t)){const e=WJ(t);t=(t=e.path.replaceAll(/\/{2,}/g,"/")).replace("/","//"),e.query&&(t+=`?${e.query}`)}return t}function CUe(t){return t.replace(/^(https?:\/\/)(arcgis\.com)/i,"$1www.$2")}function AUe(t){const e=rO.httpsDomains;if(!bUe(t))return t;const r=t.indexOf("/",7);let i;if(i=r===-1?t:t.slice(0,r),i=i.toLowerCase().slice(7),oUe.test(i)){if(!i.endsWith(":80"))return t;i=i.slice(0,-3),t=t.replace(":80","")}return xUe()&&i===$l.authority&&!aUe.test(t)||(Bj()&&i===$l.authority||e&&e.some(s=>i===s||i.endsWith(`.${s}`))||Bj()&&!BP(t))&&(t=QJ(t)),t}function Gj(t,e,r){if(!(e&&r&&t&&wu(t)))return t;const i=t.indexOf("//"),s=t.indexOf("/",i+2),n=t.indexOf(":",i+2),o=Math.min(s<0?t.length:s,n<0?t.length:n);return t.slice(i+2,o).toLowerCase()!==e.toLowerCase()?t:`${t.slice(0,i+2)}${r}${t.slice(o)}`}function jj(t){return typeof t=="string"?new uh(pc(t)):(t.scheme||(t.scheme=$l.scheme),t)}function gve(t){return OUe.test(t)}function yve(t,e){const r=Fn(t),i=Object.keys(r.query||{});return i.length>0&&e&&e.warn("removeQueryParameters()",`Url query parameters are not supported, the following parameters have been removed: ${i.join(", ")}.`),r.path}function _ve(t,e,r){const i=Fn(t),s=i.query||{};return s[e]=String(r),`${i.path}?${yT(s)}`}function bF(t,e){const r=Fn(t),i=r.query||{};for(const n in e)i[n]=e[n];const s=yT(i);return s?`${r.path}?${s}`:r.path}function eQ(t){if(t==null)return null;const e=t.match(vve);return e?e[2]:null}function Use(t){if(t==null)return null;const e=t.match(vve);return e?{path:e[1],extension:e[2]}:{path:t,extension:null}}async function zDt(t){return typeof t=="string"?_T(t)??{data:t}:new Promise((e,r)=>{const i=new FileReader;i.readAsDataURL(t),i.onload=()=>e(_T(i.result)),i.onerror=s=>r(s)})}const vve=/([^.]*)\.([^\/]*)$/,OUe=/(^data:image\/svg|\.svg$)/i,bve="20230615",wve="1f5db620f7f53ad9484d45c023aeb6d5fbf0f873",RUe="4.27";let tQ=RUe;tQ="4.27.1";const MUe={async request(t,e){const{default:r}=await J(()=>Promise.resolve().then(()=>Ave),void 0,import.meta.url),i=t.options,s=i.responseType;i.signal=e?.signal,i.responseType=s==="native"||s==="native-request-init"?"native-request-init":s&&["blob","json","text"].includes(s)&&pve(t.url)?.after?s:"array-buffer";const n=await r(t.url,i),o={data:n.data,httpStatus:n.httpStatus,ssl:n.ssl};switch(n.requestOptions?.responseType){case"native-request-init":return delete o.data.signal,o;case"blob":o.data=await o.data.arrayBuffer();break;case"json":o.data=new TextEncoder().encode(JSON.stringify(o.data)).buffer;break;case"text":o.data=new TextEncoder().encode(o.data).buffer}return{result:o,transferList:[o.data]}}};let Gt;function IUe(t){Gt=t}function BDt(t){const e=Gt?.findCredential(t);return e?.token?_ve(t,"token",e.token):t}le("host-webworker");const PUe=["elevation3d.arcgis.com","js.arcgis.com","jsdev.arcgis.com","jsqa.arcgis.com","static.arcgis.com"];function xve(t){const e=_f(t,!0);return!!e&&e.endsWith(".arcgis.com")&&!PUe.includes(e)&&!t.endsWith("/sharing/rest/generateToken")}function Tve(t,e,r=!1,i){return new Promise((s,n)=>{if(dn(i))return void n(Vse());let o=()=>{c(),n(new Error(`Unable to load ${e}`))},a=()=>{const h=t;c(),s(h)},l=()=>{if(!t)return;const h=t;c(),h.src="",n(Vse())};const c=()=>{le("esri-image-decode")||(t.removeEventListener("error",o),t.removeEventListener("load",a)),o=null,a=null,t=null,i?.removeEventListener("abort",l),l=null,r&&URL.revokeObjectURL(e)};i?.addEventListener("abort",l),le("esri-image-decode")?t.decode().then(a,o):(t.addEventListener("error",o),t.addEventListener("load",a))})}function Vse(){try{return new DOMException("Aborted","AbortError")}catch{const t=new Error;return t.name="AbortError",t}}const Sve="Timeout exceeded";function $Ue(){return new Error(Sve)}function GDt(t){return typeof t=="object"&&!!t&&"message"in t&&t.message===Sve}function LUe(t){qr.request.crossOriginNoCorsDomains||(qr.request.crossOriginNoCorsDomains={});const e=qr.request.crossOriginNoCorsDomains;for(let r of t)r=r.toLowerCase(),/^https?:\/\//.test(r)?e[_f(r)??""]=0:(e[_f("http://"+r)??""]=0,e[_f("https://"+r)??""]=0)}function DUe(t){const e=qr.request.crossOriginNoCorsDomains;if(e){let r=_f(t);if(r)return r=r.toLowerCase(),!nu(r,qJ())&&e[r]<Date.now()-36e5}return!1}async function NUe(t){const e=qr.request.crossOriginNoCorsDomains,r=_f(t);e&&r&&(e[r.toLowerCase()]=Date.now());const i=Fn(t);t=i.path,i.query?.f==="json"&&(t+="?f=json");try{await fetch(t,{mode:"no-cors",credentials:"include"})}catch{}}async function Lt(t,e){t instanceof URL&&(t=t.toString()),e?.query instanceof URLSearchParams&&(e.query=Vx(e.query.toString().replaceAll("+"," ")));const r=Ig(t),i=$1(t);i||r||(t=Dd(t));const s={url:t,requestOptions:{...e}};let n=pve(t);if(n){const c=await jUe(n,s);if(c!=null)return{data:c,getHeader:rQ,httpStatus:200,requestOptions:s.requestOptions,url:s.url};n.after||n.error||(n=null)}if(t=s.url,(e=s.requestOptions).responseType==="image"&&(le("host-webworker")||le("host-node")))throw rg("request:invalid-parameters",new Error("responseType 'image' is not supported in Web Workers or Node environment"),s);if(e.method==="head"){if(e.body)throw rg("request:invalid-parameters",new Error("body parameter cannot be set when method is 'head'"),s);if(r||i)throw rg("request:invalid-parameters",new Error("data and blob URLs are not supported for method 'head'"),s)}if(await zUe(),F5)return F5.execute(t,e);const o=new AbortController;xn(e,()=>o.abort());const a={controller:o,credential:void 0,credentialToken:void 0,fetchOptions:void 0,hasToken:!1,interceptor:n,params:s,redoRequest:!1,useIdentity:Jp.useIdentity,useProxy:!1,useSSL:!1,withCredentials:!1},l=await qUe(a);return n?.after?.(l),l}let F5;const Jp=qr.request,Eve="FormData"in globalThis,FUe=[499,498,403,401],kUe=["COM_0056","COM_0057","SB_0008"],UUe=[/\/arcgis\/tokens/i,/\/sharing(\/rest)?\/generatetoken/i,/\/rest\/info/i],rQ=()=>null,k5=Symbol();function VUe(t){const e=_f(t);e&&!Lt._corsServers.includes(e)&&Lt._corsServers.push(e)}function zse(t){const e=_f(t);return!e||e.endsWith(".arcgis.com")||Lt._corsServers.includes(e)||ZJ(e)}function rg(t,e,r,i){let s="Error";const n={url:r.url,requestOptions:r.requestOptions,getHeader:rQ,ssl:!1};if(e instanceof D)return e.details?(e.details=re(e.details),e.details.url=r.url,e.details.requestOptions=r.requestOptions):e.details=n,e;if(e){const o=i&&(c=>i.headers.get(c)),a=i?.status,l=e.message;l&&(s=l),o&&(n.getHeader=o),n.httpStatus=(e.httpCode!=null?e.httpCode:e.code)||a||0,n.subCode=e.subcode,n.messageCode=e.messageCode,typeof e.details=="string"?n.messages=[e.details]:n.messages=e.details,n.raw=k5 in e?e[k5]:e}return ws(e)?Tr():new D(t,s,n)}async function zUe(){le("host-webworker")?F5||(F5=await J(()=>import("./request-895e71fc.js"),[],import.meta.url)):Lt._abortableFetch||(Lt._abortableFetch=globalThis.fetch.bind(globalThis))}async function Hj(){Gt||await J(()=>Promise.resolve().then(()=>Mnt),void 0,import.meta.url)}async function BUe(t){const e=t.params.url,r=t.params.requestOptions,i=t.controller.signal,s=r.body;let n=null,o=null;if(Eve&&"HTMLFormElement"in globalThis&&(s instanceof FormData?n=s:s instanceof HTMLFormElement&&(n=new FormData(s))),typeof s=="string"&&(o=s),t.fetchOptions={cache:r.cacheBust&&!("polyfill"in Lt._abortableFetch)?"no-cache":"default",credentials:"same-origin",headers:r.headers||{},method:r.method==="head"?"HEAD":"GET",mode:"cors",priority:Jp.priority,redirect:"follow",signal:i},(n||o)&&(t.fetchOptions.body=n||o),r.authMode==="anonymous"&&(t.useIdentity=!1),t.hasToken=!!(/token=/i.test(e)||r.query?.token||n?.get("token")),!t.hasToken&&qr.apiKey&&xve(e)&&(r.query||(r.query={}),r.query.token=qr.apiKey,t.hasToken=!0),t.useIdentity&&!t.hasToken&&!t.credentialToken&&!Cve(e)&&!dn(i)){let a;r.authMode==="immediate"?(await Hj(),a=await Gt.getCredential(e,{signal:i}),t.credential=a):r.authMode==="no-prompt"?(await Hj(),a=await Gt.getCredential(e,{prompt:!1,signal:i}).catch(()=>{}),t.credential=a):Gt&&(a=Gt.findCredential(e)),a&&(t.credentialToken=a.token,t.useSSL=!!a.ssl)}}function Cve(t){return UUe.some(e=>e.test(t))}async function GUe(t){let e=t.params.url;const r=t.params.requestOptions,i=t.fetchOptions??{},s=$1(e)||Ig(e),n=r.responseType||"json",o=s?0:r.timeout!=null?r.timeout:Jp.timeout;let a=!1;if(!s){t.useSSL&&(e=QJ(e)),r.cacheBust&&i.cache==="default"&&(e=_ve(e,"request.preventCache",Date.now()));let f={...r.query};t.credentialToken&&(f.token=t.credentialToken);let m=yT(f);le("esri-url-encodes-apostrophe")&&(m=m.replaceAll("'","%27"));const g=e.length+1+m.length;let _;a=r.method==="delete"||r.method==="post"||r.method==="put"||!!r.body||g>Jp.maxUrlLength;const v=r.useProxy||!!BP(e);if(v){const b=pUe(e);_=b.path,!a&&_.length+1+g>Jp.maxUrlLength&&(a=!0),b.query&&(f={...b.query,...f})}if(i.method==="HEAD"&&(a||v)){if(a)throw g>Jp.maxUrlLength?rg("request:invalid-parameters",new Error("URL exceeds maximum length"),t.params):rg("request:invalid-parameters",new Error("cannot use POST request when method is 'head'"),t.params);if(v)throw rg("request:invalid-parameters",new Error("cannot use proxy when method is 'head'"),t.params)}a?(i.method=r.method==="delete"?"DELETE":r.method==="put"?"PUT":"POST",r.body?e=bF(e,f):(i.body=yT(f),i.headers||(i.headers={}),i.headers["Content-Type"]="application/x-www-form-urlencoded")):e=bF(e,f),v&&(t.useProxy=!0,e=`${_}?${e}`),f.token&&Eve&&i.body instanceof FormData&&!lve(e)&&i.body.set("token",f.token),r.hasOwnProperty("withCredentials")?t.withCredentials=r.withCredentials:nu(e,qJ())||(ZJ(e)||Gt&&Gt.findServerInfo(e)?.webTierAuth)&&(t.withCredentials=!0),t.withCredentials&&(i.credentials="include",DUe(e)&&await NUe(a?bF(e,f):e))}let l,c,h=0,p=!1;o>0&&(h=setTimeout(()=>{p=!0,t.controller.abort()},o));try{if(r.responseType==="native-request-init")c=i,c.url=e;else if(r.responseType!=="image"||i.cache!=="default"||i.method!=="GET"||a||HUe(r.headers)||!s&&!t.useProxy&&Jp.proxyUrl&&!zse(e)){if(l=await Lt._abortableFetch(e,i),t.useProxy||VUe(e),r.responseType==="native")c=l;else if(i.method!=="HEAD")if(l.ok){switch(n){case"array-buffer":c=await l.arrayBuffer();break;case"blob":case"image":c=await l.blob();break;default:c=await l.text()}if(h&&(clearTimeout(h),h=0),n==="json"||n==="xml"||n==="document")if(c)switch(n){case"json":c=JSON.parse(c);break;case"xml":c=Bse(c,"application/xml");break;case"document":c=Bse(c,"text/html")}else c=null;if(c){if(n==="array-buffer"||n==="blob"){const f=l.headers.get("Content-Type");if(f&&/application\/json|text\/plain/i.test(f)&&c[n==="blob"?"size":"byteLength"]<=750)try{const m=await new Response(c).json();m.error&&(c=m)}catch{}}n==="image"&&c instanceof Blob&&(c=await Gse(URL.createObjectURL(c),t,!0))}}else{c=await l.text();try{c=JSON.parse(c)}catch{}}}else c=await Gse(e,t)}catch(f){if(f.name==="AbortError")throw p?$Ue():Tr("Request canceled");if(!(!l&&f instanceof TypeError&&Jp.proxyUrl)||r.body||r.method==="delete"||r.method==="head"||r.method==="post"||r.method==="put"||t.useProxy||zse(e))throw f;t.redoRequest=!0,fUe({proxyUrl:Jp.proxyUrl,urlPrefix:_f(e)??""})}finally{h&&clearTimeout(h)}return[l,c]}async function jUe(t,e){if(t.responseData!=null)return t.responseData;if(t.headers&&(e.requestOptions.headers={...e.requestOptions.headers,...t.headers}),t.query&&(e.requestOptions.query={...e.requestOptions.query,...t.query}),t.before){let r,i;try{i=await t.before(e)}catch(s){r=rg("request:interceptor",s,e)}if((i instanceof Error||i instanceof D)&&(r=rg("request:interceptor",i,e)),r)throw t.error&&t.error(r),r;return i}}function HUe(t){if(t){for(const e of Object.getOwnPropertyNames(t))if(t[e])return!0}return!1}function Bse(t,e){let r;try{r=new DOMParser().parseFromString(t,e)}catch{}if(!r||r.getElementsByTagName("parsererror").length)throw new SyntaxError("XML Parse error");return r}async function qUe(t){let e,r;await BUe(t);try{do[e,r]=await GUe(t);while(!await WUe(t,e,r))}catch(n){const o=rg("request:server",n,t.params,e);throw o.details.ssl=t.useSSL,t.interceptor?.error&&t.interceptor.error(o),o}const i=t.params.url;if(r&&/\/sharing\/rest\/(accounts|portals)\/self/i.test(i)){if(!t.hasToken&&!t.credentialToken&&r.user?.username&&!ZJ(i)){const n=_f(i,!0);n&&Jp.trustedServers.push(n)}Array.isArray(r.authorizedCrossOriginNoCorsDomains)&&LUe(r.authorizedCrossOriginNoCorsDomains)}const s=t.credential;if(s&&Gt){let o=Gt.findServerInfo(s.server)?.owningSystemUrl;if(o){o=o.replace(/\/?$/,"/sharing");const a=Gt.findCredential(o,s.userId);a&&Gt._getIdenticalSvcIdx(o,a)===-1&&a.resources.unshift(o)}}return{data:r,getHeader:e?n=>e?.headers.get(n):rQ,httpStatus:e?.status??200,requestOptions:t.params.requestOptions,ssl:t.useSSL,url:t.params.url}}async function WUe(t,e,r){if(t.redoRequest)return t.redoRequest=!1,!1;const i=t.params.requestOptions;if(!e||i.responseType==="native"||i.responseType==="native-request-init")return!0;let s,n;if(r&&(r.error?s=r.error:r.status==="error"&&Array.isArray(r.messages)&&(s={...r},s[k5]=r,s.details=r.messages)),!s&&!e.ok)throw s=new Error(`Unable to load ${e.url} status: ${e.status}`),s[k5]=r,s;let o,a=null;s&&(n=Number(s.code),a=s.hasOwnProperty("subcode")?Number(s.subcode):null,o=s.messageCode,o=o?.toUpperCase());const l=i.authMode;if(n===403&&(a===4||s.message?.toLowerCase().includes("ssl")&&!s.message.toLowerCase().includes("permission"))){if(!t.useSSL)return t.useSSL=!0,!1}else if(!t.hasToken&&t.useIdentity&&(l!=="no-prompt"||n===498)&&n!==void 0&&FUe.includes(n)&&!Cve(t.params.url)&&(n!==403||o&&!kUe.includes(o)&&(a==null||a===2&&t.credentialToken))){await Hj();try{const c=await Gt.getCredential(t.params.url,{error:rg("request:server",s,t.params),prompt:l!=="no-prompt",signal:t.controller.signal,token:t.credentialToken});return t.credential=c,t.credentialToken=c.token,t.useSSL=t.useSSL||c.ssl,!1}catch(c){if(l==="no-prompt")return t.credential=void 0,t.credentialToken=void 0,!1;s=c}}if(s)throw s;return!0}function Gse(t,e,r=!1){const i=e.controller.signal,s=new Image;return e.withCredentials?s.crossOrigin="use-credentials":s.crossOrigin="anonymous",s.alt="",s.fetchPriority=Jp.priority,s.src=t,Tve(s,t,r,i)}Lt._abortableFetch=null,Lt._corsServers=["https://server.arcgisonline.com","https://services.arcgisonline.com"];const Ave=Object.freeze(Object.defineProperty({__proto__:null,default:Lt},Symbol.toStringTag,{value:"Module"}));async function ZUe(t,e,r,i){const s=e.exec(r);if(!s)throw new D("esri-intl:invalid-bundle",`Bundle id "${r}" is not compatible with the pattern "${e}"`);const n=s[1]?`${s[1]}/`:"",o=s[2],a=Jke(i),l=`${n}${o}.json`,c=a?`${n}${o}_${a}.json`:l;let h;try{h=await jse(t(c))}catch(p){if(c===l)throw new D("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:p});try{h=await jse(t(l))}catch(f){throw new D("intl:unknown-bundle",`Bundle "${r}" cannot be loaded`,{error:f})}}return h}async function jse(t){if(Hse.fetchBundleAsset!=null)return Hse.fetchBundleAsset(t);const e=await Lt(t,{responseType:"text"});return JSON.parse(e.data)}let XUe=class{constructor({base:e="",pattern:r,location:i=new URL(window.location.href)}){let s;s=typeof i=="string"?n=>new URL(n,new URL(i,window.location.href)).href:i instanceof URL?n=>new URL(n,i).href:i,this.pattern=typeof r=="string"?new RegExp(`^${r}`):r,this.getAssetUrl=s,e=e?e.endsWith("/")?e:e+"/":"",this.matcher=new RegExp(`^${e}(?:(.*)/)?(.*)$`)}fetchMessageBundle(e,r){return ZUe(this.getAssetUrl,this.matcher,e,r)}};function YUe(t){return new XUe(t)}const Hse={},JUe=K.getLogger("esri.assets");function QUe(t,e){return Lt(Dr(t),e)}function Dr(t){if(!qr.assetsPath)throw JUe.errorOnce("The API assets location needs to be set using config.assetsPath. More information: https://arcg.is/1OzLe50"),new D("assets:path-not-set","config.assetsPath is not set");return Cu(qr.assetsPath,t)}Yke(YUe({pattern:"esri/",location:Dr}));function HDt(t){const e=[];return function*(){yield*e;for(const r of t)e.push(r),yield r}}function KUe(t,e){for(const r of t)if(r!=null&&e(r))return r}function qj(t){return t!=null&&typeof t[Symbol.iterator]=="function"}let li=class Wj{constructor(){this._groups=new Map}destroy(){this.removeAll()}get size(){let e=0;return this._groups.forEach(r=>{e+=r.length}),e}add(e,r){if(qj(e)){const i=this._getOrCreateGroup(r);for(const s of e)this._isHandle(s)&&i.push(s)}else this._isHandle(e)&&this._getOrCreateGroup(r).push(e);return this}forEach(e,r){if(typeof e=="function")this._groups.forEach(i=>i.forEach(e));else{const i=this._getGroup(e);i&&r&&i.forEach(r)}}has(e){return this._groups.has(this._ensureGroupKey(e))}remove(e){if(typeof e!="string"&&qj(e)){for(const r of e)this.remove(r);return this}return this.has(e)?(this._removeAllFromGroup(this._getGroup(e)),this._groups.delete(this._ensureGroupKey(e)),this):this}removeAll(){return this._groups.forEach(e=>this._removeAllFromGroup(e)),this._groups.clear(),this}_isHandle(e){return e&&(!!e.remove||e instanceof Wj)}_getOrCreateGroup(e){if(this.has(e))return this._getGroup(e);const r=[];return this._groups.set(this._ensureGroupKey(e),r),r}_getGroup(e){return this._groups.get(this._ensureGroupKey(e))}_ensureGroupKey(e){return e||"_default_"}_removeAllFromGroup(e){for(const r of e)r instanceof Wj?r.removeAll():r.remove()}};const Ove=Symbol("Accessor-beforeDestroy");function Sc(t){return Zr(()=>t.forEach(e=>e!=null&&e.remove()))}function Zr(t){return{remove:()=>{t&&(t(),t=void 0)}}}function qDt(t){return Zr(()=>{const e=t();e?.remove()})}function e6e(t){return Zr(()=>t?.abort())}function WDt(t){return Zr(t!=null?()=>t.destroy():void 0)}function tl(t){return t.__accessor__??null}function t6e(t,e){return t!=null&&t.metadatas&&t.metadatas[e]!=null}function wF(t,e,r){return r?U5(t,e,{policy:r,path:""}):U5(t,e,null)}function U5(t,e,r){return e?Object.keys(e).reduce((i,s)=>{const n=s;let o=null,a="merge";if(r&&(o=r.path?`${r.path}.${s}`:s,a=r.policy(o)),a==="replace"||a==="replace-arrays"&&Array.isArray(i[n]))return i[n]=e[n],i;if(i[n]===void 0)return i[n]=re(e[n]),i;let l=i[n],c=e[n];if(l===c)return i;if(Array.isArray(c)||Array.isArray(i))l=l?Array.isArray(l)?i[n]=l.concat():i[n]=[l]:i[n]=[],c&&(Array.isArray(c)||(c=[c]),c.forEach(h=>{l.includes(h)||l.push(h)}));else if(c&&typeof c=="object")if(r){const h=r.path;r.path=o,i[n]=U5(l,c,r),r.path=h}else i[n]=U5(l,c,null);else i.hasOwnProperty(s)&&!e.hasOwnProperty(s)||(i[n]=c);return i},t||{}):t}function Rve(t){return Array.isArray(t)?t:t.split(".")}function qse(t){return t.includes(",")?t.split(",").map(e=>e.trim()):[t.trim()]}function r6e(t){if(Array.isArray(t)){const e=[];for(const r of t)e.push(...qse(r));return e}return qse(t)}function Mve(t,e,r,i){const s=r6e(e);if(s.length!==1){const n=s.map(o=>i(t,o,r));return Sc(n)}return i(t,s[0],r)}function iQ(t){let e=!1;return()=>{e||(e=!0,t())}}function Ive(t,e){const r=t[t.length-1]==="?"?t.slice(0,-1):t;if(e.getItemAt!=null||Array.isArray(e)){const s=parseInt(r,10);if(!isNaN(s))return Array.isArray(e)?e[s]:e.at(s)}const i=tl(e);return t6e(i,r)?i.get(r):e[r]}function Pve(t,e,r){if(t==null)return t;const i=Ive(e[r],t);return!i&&r<e.length-1?void 0:r===e.length-1?i:Pve(i,e,r+1)}function GP(t,e,r=0){return typeof e!="string"||e.includes(".")?Pve(t,Rve(e),r):Ive(e,t)}function V5(t,e){return GP(t,e)}function Wse(t,e){return GP(e,t)!==void 0}function jP(t){let e=t.constructor.__accessorMetadata__;const r=Object.prototype.hasOwnProperty.call(t.constructor,"__accessorMetadata__");if(e){if(!r){e=Object.create(e);for(const i in e)e[i]=re(e[i]);Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0})}}else e={},Object.defineProperty(t.constructor,"__accessorMetadata__",{value:e,enumerable:!1,configurable:!0,writable:!0});return t.constructor.__accessorMetadata__}function HP(t,e){const r=jP(t);let i=r[e];return i||(i=r[e]={}),i}function i6e(t,e){return wF(t,e,n6e)}const s6e=/^(?:[^.]+\.)?(?:value|type|(?:json\.type|json\.origins\.[^.]\.type))$/;function n6e(t){return s6e.test(t)?"replace":"merge"}function o6e(t){return t&&t.release&&typeof t.release=="function"}function a6e(t){return t&&t.acquire&&typeof t.acquire=="function"}let $o=class Zj{constructor(e,r,i,s=1,n=0){if(this._ctor=e,this._acquireFunction=r,this._releaseFunction=i,this.allocationSize=s,this._pool=new Array(n),this._initialSize=n,this._ctor)for(let o=0;o<n;o++)this._pool[o]=new this._ctor;this.allocationSize=Math.max(s,1)}destroy(){this.prune(0)}acquire(...e){let r;if(Zj.test.disabled)r=new this._ctor;else{if(this._pool.length===0){const i=this.allocationSize;for(let s=0;s<i;s++)this._pool[s]=new this._ctor}r=this._pool.pop()}return this._acquireFunction?this._acquireFunction(r,...e):a6e(r)&&r.acquire(...e),r}release(e){e&&!Zj.test.disabled&&(this._releaseFunction?this._releaseFunction(e):o6e(e)&&e.release(),this._pool.push(e))}prune(e=this._initialSize){if(!(e>=this._pool.length)){for(let r=e;r<this._pool.length;++r){const i=this._pool[r];this._dispose(i)}this._pool.length=e}}_dispose(e){e.dispose&&typeof e.dispose=="function"&&e.dispose()}};$o.test={disabled:!1};var Yy;(function(t){t[t.INITIALIZING=0]="INITIALIZING",t[t.CONSTRUCTING=1]="CONSTRUCTING",t[t.CONSTRUCTED=2]="CONSTRUCTED"})(Yy||(Yy={}));let l6e=class{constructor(e,r){this._observers=e,this._observer=r}remove(){II(this._observers,this._observer)}},$ve=class{constructor(){this._observers=null,this.destroyed=!1}observe(e){if(this.destroyed||e.destroyed)return c6e;this._observers==null&&(this._observers=[]);const r=this._observers;let i=!1,s=!1;const n=r.length;for(let o=0;o<n;++o){const a=r[o];if(a.destroyed)s=!0;else if(a===e){i=!0;break}}return i||(r.push(e),s&&this._removeDestroyedObservers()),new l6e(r,e)}_removeDestroyedObservers(){const e=this._observers;if(!e||e.length===0)return;const r=e.length;let i=0;for(let s=0;s<r;++s){for(;s+i<r&&e[s+i].destroyed;)++i;if(i>0){if(!(s+i<r))break;e[s]=e[s+i]}}e.length=r-i}destroy(){if(this.destroyed)return;this.destroyed=!0;const e=this._observers;if(e!=null){for(const r of e)r.onCommitted();this._observers=null}}};const c6e=Zr();var _r;(function(t){t[t.DEFAULTS=0]="DEFAULTS",t[t.COMPUTED=1]="COMPUTED",t[t.SERVICE=2]="SERVICE",t[t.PORTAL_ITEM=3]="PORTAL_ITEM",t[t.WEB_SCENE=4]="WEB_SCENE",t[t.WEB_MAP=5]="WEB_MAP",t[t.LINK_CHART=6]="LINK_CHART",t[t.USER=7]="USER"})(_r||(_r={}));const Xj=_r.USER+1;function t0(t){switch(t){case"defaults":return _r.DEFAULTS;case"service":return _r.SERVICE;case"portal-item":return _r.PORTAL_ITEM;case"web-scene":return _r.WEB_SCENE;case"web-map":return _r.WEB_MAP;case"link-chart":return _r.LINK_CHART;case"user":return _r.USER;default:return null}}function z5(t){switch(t){case _r.DEFAULTS:return"defaults";case _r.SERVICE:return"service";case _r.PORTAL_ITEM:return"portal-item";case _r.WEB_SCENE:return"web-scene";case _r.WEB_MAP:return"web-map";case _r.LINK_CHART:return"link-chart";case _r.USER:return"user"}return void 0}function u6e(t){return z5(t)}var Wi;(function(t){t[t.Dirty=1]="Dirty",t[t.Overriden=2]="Overriden",t[t.Computing=4]="Computing",t[t.NonNullable=8]="NonNullable",t[t.HasDefaultValue=16]="HasDefaultValue",t[t.DepTrackingInitialized=32]="DepTrackingInitialized",t[t.AutoTracked=64]="AutoTracked",t[t.ExplicitlyTracking=128]="ExplicitlyTracking"})(Wi||(Wi={}));const B5={onObservableAccessed:()=>{},onTrackingEnd:()=>{}},KR=[];let FM=B5;function Jt(t){FM.onObservableAccessed(t)}let xF=!1,TF=!1;function S0(t,e,r){if(xF)return sQ(t,e,r);Lve(t);const i=e.call(r);return Dve(),i}function h6e(t,e){return S0(B5,t,e)}function sQ(t,e,r){const i=xF;xF=!0,Lve(t);let s=null;try{s=e.call(r)}catch(n){TF&&K.getLogger("esri.core.accessorSupport.tracking").error(n)}return Dve(),xF=i,s}function Lve(t){FM=t,KR.push(t)}function Dve(){const t=KR.length;if(t>1){const e=KR.pop();FM=KR[t-2],e.onTrackingEnd()}else if(t===1){const e=KR.pop();FM=B5,e.onTrackingEnd()}else FM=B5}function Nve(t,e){const r=e.observerObject;if(r.flags&Wi.DepTrackingInitialized)return;const i=TF;TF=!1,r.flags&Wi.AutoTracked?sQ(e,e.metadata.get,t):Fve(t,e),TF=i}const d6e=[];function Fve(t,e){const r=e.observerObject;r.flags&Wi.ExplicitlyTracking||(r.flags|=Wi.ExplicitlyTracking,sQ(e,()=>{const i=e.metadata.dependsOn||d6e;for(const s of i)if(typeof s!="string"||s.includes(".")){const n=Rve(s);for(let o=0,a=t;o<n.length&&a!=null&&typeof a=="object";++o)a=Zse(a,n[o],o!==n.length-1)}else Zse(t,s,!1)}),r.flags&=~Wi.ExplicitlyTracking)}function Zse(t,e,r){const i=e[e.length-1]==="?"?e.slice(0,-1):e;if(t.getItemAt!=null||Array.isArray(t)){const n=parseInt(i,10);if(!isNaN(n))return Array.isArray(t)?t[n]:t.at(n)}const s=tl(t);if(s){const n=s.propertiesByName.get(i);n&&(Jt(n.observerObject),Nve(t,n))}return r?t[i]:void 0}let Xse=class{constructor(e,r){this.propertyName=e,this.metadata=r,this.observerObject=new p6e,this._accessed=null,this._handles=null,this.observerObject.flags=Wi.Dirty|(r.nonNullable?Wi.NonNullable:0)|(r.hasOwnProperty("value")?Wi.HasDefaultValue:0)|(r.get===void 0?Wi.DepTrackingInitialized:0)|(r.dependsOn===void 0?Wi.AutoTracked:0)}destroy(){this.observerObject.destroy(),this._accessed=null,this._clearObservationHandles()}getComputed(e){const r=this.observerObject;Jt(r);const i=e.store,s=this.propertyName,n=r.flags,o=i.get(s);if(n&Wi.Computing||~n&Wi.Dirty&&i.has(s))return o;r.flags|=Wi.Computing;const a=e.host;let l;n&Wi.AutoTracked?l=S0(this,this.metadata.get,a):(Fve(a,this),l=this.metadata.get.call(a)),i.set(s,l,_r.COMPUTED);const c=i.get(s);return c===o?r.flags&=~Wi.Dirty:h6e(this.commit,this),r.flags&=~Wi.Computing,c}onObservableAccessed(e){if(e===this.observerObject)return;let r=this._accessed;if(r==null)r=[],this._accessed=r;else if(r.includes(e))return;r.push(e)}onTrackingEnd(){this._clearObservationHandles();const e=this.observerObject;e.flags|=Wi.DepTrackingInitialized;const r=this._accessed;if(r==null||r.length===0)return;let i=this._handles;i==null&&(i=[],this._handles=i);for(let s=0;s<r.length;++s)i.push(r[s].observe(e));r.length=0}notifyChange(){const e=this.observerObject;e.onInvalidated(),e.onCommitted()}invalidate(){this.observerObject.onInvalidated()}commit(){const e=this.observerObject;e.flags&=~Wi.Dirty,e.onCommitted()}_clearObservationHandles(){const e=this._handles;if(e!==null){for(let r=0;r<e.length;++r)e[r].remove();e.length=0}}},p6e=class extends $ve{constructor(){super(...arguments),this.flags=0}onInvalidated(){~this.flags&Wi.Overriden&&(this.flags|=Wi.Dirty);const e=this._observers;if(e&&e.length>0)for(const r of e)r.onInvalidated()}onCommitted(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onCommitted()}}destroy(){this.flags&Wi.Dirty&&this.onCommitted(),super.destroy()}},f6e=class kve{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new kve;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,re(i))}),r}get(e){return this._values.get(e)}originOf(){return _r.USER}keys(){return[...this._values.keys()]}set(e,r){this._values.set(e,r)}delete(e){this._values.delete(e)}has(e){return this._values.has(e)}forEach(e){this._values.forEach(e)}};function tL(t,e,r){return t!==void 0}function Yse(t,e,r,i){return t!==void 0&&(!(r==null&&t.observerObject.flags&Wi.NonNullable)||(i.lifecycle,Yy.INITIALIZING,!1))}function m6e(t){return t&&typeof t.destroy=="function"}K.getLogger("esri.core.accessorSupport.Properties");let g6e=class{constructor(e){this.host=e,this.propertiesByName=new Map,this.ctorArgs=null,this.destroyed=!1,this.lifecycle=Yy.INITIALIZING,this.store=new f6e,this._origin=_r.USER;const r=this.host.constructor.__accessorMetadata__;for(const i in r){const s=new Xse(i,r[i]);this.propertiesByName.set(i,s)}this.metadatas=r}initialize(){this.lifecycle=Yy.CONSTRUCTING}constructed(){this.lifecycle=Yy.CONSTRUCTED}destroy(){this.destroyed=!0;for(const[e,r]of this.propertiesByName){if(r.metadata.autoDestroy){const i=this.internalGet(e);i&&m6e(i)&&(i.destroy(),~r.observerObject.flags&Wi.NonNullable&&this._internalSet(r,null))}r.destroy()}}get initialized(){return this.lifecycle!==Yy.INITIALIZING}get(e){const r=this.propertiesByName.get(e);if(r.metadata.get)return r.getComputed(this);Jt(r.observerObject);const i=this.store;return i.has(e)?i.get(e):r.metadata.value}originOf(e){const r=this.store.originOf(e);if(r===void 0){const i=this.propertiesByName.get(e);if(i!==void 0&&i.observerObject.flags&Wi.HasDefaultValue)return"defaults"}return z5(r)}has(e){return!!this.propertiesByName.has(e)&&this.store.has(e)}keys(){return[...this.propertiesByName.keys()]}internalGet(e){const r=this.propertiesByName.get(e);if(tL(r))return this.store.has(e)?this.store.get(e):r.metadata.value}internalSet(e,r){const i=this.propertiesByName.get(e);tL(i)&&this._internalSet(i,r)}getDependsInfo(e,r,i){const s=this.propertiesByName.get(r);if(!tL(s))return"";const n=new Set,o=S0({onObservableAccessed:l=>n.add(l),onTrackingEnd:()=>{}},()=>s.metadata.get?.call(e));let a=`${i}${e.declaredClass.split(".").pop()}.${r}: ${o}
`;if(n.size===0)return a;i+="  ";for(const l of n)l instanceof Xse&&(a+=`${i}${l.propertyName}: undefined
`);return a}setAtOrigin(e,r,i){const s=this.propertiesByName.get(e);if(tL(s))return this._setAtOrigin(s,r,i)}isOverridden(e){const r=this.propertiesByName.get(e);return r!==void 0&&!!(r.observerObject.flags&Wi.Overriden)}clearOverride(e){const r=this.propertiesByName.get(e),i=r?.observerObject;i&&i.flags&Wi.Overriden&&(i.flags&=~Wi.Overriden,r.notifyChange())}override(e,r){const i=this.propertiesByName.get(e);if(!Yse(i,e,r,this))return;const s=i.metadata.cast;if(s){const n=this._cast(s,r),{valid:o,value:a}=n;if(m9.release(n),!o)return;r=a}i.observerObject.flags|=Wi.Overriden,this._internalSet(i,r)}set(e,r){const i=this.propertiesByName.get(e);if(!Yse(i,e,r,this))return;const s=i.metadata.cast;if(s){const o=this._cast(s,r),{valid:a,value:l}=o;if(m9.release(o),!a)return;r=l}const n=i.metadata.set;n?n.call(this.host,r):this._internalSet(i,r)}setDefaultOrigin(e){this._origin=t0(e)}getDefaultOrigin(){return z5(this._origin)}notifyChange(e){const r=this.propertiesByName.get(e);r!==void 0&&r.notifyChange()}invalidate(e){const r=this.propertiesByName.get(e);r!==void 0&&r.invalidate()}commit(e){const r=this.propertiesByName.get(e);r!==void 0&&r.commit()}_internalSet(e,r){const i=this.lifecycle!==Yy.INITIALIZING?this._origin:_r.DEFAULTS;this._setAtOrigin(e,r,i)}_setAtOrigin(e,r,i){const s=this.store,n=e.propertyName;s.has(n,i)&&RJ(r,s.get(n))&&~e.observerObject.flags&Wi.Overriden&&i===s.originOf(n)||(e.invalidate(),s.set(n,r,i),e.commit(),Nve(this.host,e))}_cast(e,r){const i=m9.acquire();return i.valid=!0,i.value=r,e&&(i.value=e.call(this.host,r,i)),i}},y6e=class{constructor(){this.value=null,this.valid=!0}acquire(){this.valid=!0}release(){this.value=null}};const m9=new $o(y6e);function G5(t,e,r){if(t&&e)if(typeof e=="object")for(const i of Object.getOwnPropertyNames(e))G5(t,i,e[i]);else{if(e.includes(".")){const s=e.split("."),n=s.splice(s.length-1,1)[0];return void G5(V5(t,s),n,r)}const i=t.__accessor__;i!=null&&_6e(e,i),t[e]=r}}function _6e(t,e){if(le("esri-unknown-property-errors")&&!v6e(t,e))throw new D("set:unknown-property",b6e(t,e))}function v6e(t,e){return e.metadatas[t]!=null}function b6e(t,e){return"setting unknown property '"+t+"' on instance of "+e.host.declaredClass}let w6e;function x6e(){return w6e}function T6e(t){t.length=0}let pu=class{constructor(e=50,r=50){this._pool=new $o(Array,void 0,T6e,r,e)}acquire(){return this._pool.acquire()}release(e){this._pool.release(e)}prune(){this._pool.prune(0)}static acquire(){return g9.acquire()}static release(e){return g9.release(e)}static prune(){g9.prune()}};const g9=new pu(100);let Uve=class extends $o{constructor(){super(...arguments),this._set=new Set}destroy(){super.destroy(),this._set=tO(this._set)}acquire(...e){const r=super.acquire(...e);return this._set.delete(r),r}release(e){e&&!this._set.has(e)&&(super.release(e),this._set.add(e))}_dispose(e){this._set.delete(e),super._dispose(e)}};const rL=[];function JC(t){rL.push(t),rL.length===1&&queueMicrotask(()=>{const e=rL.slice();rL.length=0;for(const r of e)r()})}let r0=class{constructor(e,r=30){this.name=e,this._counter=0,this._samples=new Array(r)}record(e){e!=null&&(this._samples[++this._counter%this._samples.length]=e)}get median(){return this._samples.slice().sort((e,r)=>e-r)[Math.floor(this._samples.length/2)]}get average(){return this._samples.reduce((e,r)=>e+r,0)/this._samples.length}get last(){return this._samples[this._counter%this._samples.length]}};var Yj;(function(t){const e=(n,o,a,l)=>{let c=o,h=o;const p=a>>>1,f=n[c-1];for(;h<=p;){h=c<<1,h<a&&l(n[h-1],n[h])<0&&++h;const m=n[h-1];if(l(m,f)<=0)break;n[c-1]=m,c=h}n[c-1]=f},r=(n,o)=>n<o?-1:n>o?1:0;function i(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l);const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l)}}function*s(n,o,a,l){o===void 0&&(o=0),a===void 0&&(a=n.length),l===void 0&&(l=r);for(let h=a>>>1;h>o;h--)e(n,h,a,l),yield;const c=o+1;for(let h=a-1;h>o;h--){const p=n[o];n[o]=n[h],n[h]=p,e(n,c,h,l),yield}}t.sort=i,t.iterableSort=s})(Yj||(Yj={}));const Jse=Yj,S6e=1.5,E6e=1.1;let qt=class{constructor(e){this.data=[],this._length=0,this._allocator=void 0,this._deallocator=()=>null,this._shrink=()=>{},this._hint=new V0e,e&&(e.initialSize&&(this.data=new Array(e.initialSize)),e.allocator&&(this._allocator=e.allocator),e.deallocator!==void 0&&(this._deallocator=e.deallocator),e.shrink&&(this._shrink=()=>Qse(this)))}toArray(){return this.data.slice(0,this.length)}filter(e){const r=new Array;for(let i=0;i<this._length;i++){const s=this.data[i];e(s)&&r.push(s)}return r}at(e){if((e=Math.trunc(e)||0)<0&&(e+=this._length),!(e<0||e>=this._length))return this.data[e]}includes(e,r){const i=this.data.indexOf(e,r);return i!==-1&&i<this.length}get length(){return this._length}set length(e){if(e>this._length){if(this._allocator){for(;this._length<e;)this.data[this._length++]=this._allocator(this.data[this._length]);return}this._length=e}else{if(this._deallocator)for(let r=e;r<this._length;++r)this.data[r]=this._deallocator(this.data[r]);this._length=e,this._shrink()}}clear(){this.length=0}prune(){this.clear(),this.data=[]}push(e){this.data[this._length++]=e}pushArray(e,r=e.length){for(let i=0;i<r;i++)this.data[this._length++]=e[i]}fill(e,r){for(let i=0;i<r;i++)this.data[this._length++]=e}pushNew(){this._allocator&&(this.data[this.length]=this._allocator(this.data[this.length]));const e=this.data[this._length];return++this._length,e}unshift(e){this.data.unshift(e),this._length++,Qse(this)}pop(){if(this.length===0)return;const e=this.data[this.length-1];return this.length=this.length-1,this._shrink(),e}remove(e){const r=Rj(this.data,e,this.length,this._hint);if(r!==-1)return this.data.splice(r,1),this.length=this.length-1,e}removeUnordered(e){return this.removeUnorderedIndex(Rj(this.data,e,this.length,this._hint))}removeUnorderedIndex(e){if(!(e>=this.length||e<0))return this.swapElements(e,this.length-1),this.pop()}removeUnorderedMany(e,r=e.length,i){this.length=x4e(this.data,e,this.length,r,this._hint,i),this._shrink()}front(){if(this.length!==0)return this.data[0]}back(){if(this.length!==0)return this.data[this.length-1]}swapElements(e,r){if(e>=this.length||r>=this.length||e===r)return;const i=this.data[e];this.data[e]=this.data[r],this.data[r]=i}sort(e){Jse.sort(this.data,0,this.length,e)}iterableSort(e){return Jse.iterableSort(this.data,0,this.length,e)}some(e,r){for(let i=0;i<this.length;++i)if(e.call(r,this.data[i],i,this.data))return!0;return!1}find(e,r){for(let i=0;i<this.length;++i){const s=this.data[i];if(e.call(r,s,i))return s}}filterInPlace(e,r){let i=0;for(let s=0;s<this._length;++s){const n=this.data[s];e.call(r,n,s,this.data)&&(this.data[s]=this.data[i],this.data[i]=n,i++)}if(this._deallocator)for(let s=i;s<this._length;s++)this.data[s]=this._deallocator(this.data[s]);return this._length=i,this._shrink(),this}forAll(e,r){const i=this.length,s=this.data;for(let n=0;n<i;++n)e.call(r,s[n],n,s)}forEach(e,r){for(let i=0;i<this.length;++i)e.call(r,this.data[i],i,this.data)}map(e,r){const i=new Array(this.length);for(let s=0;s<this.length;++s)i[s]=e.call(r,this.data[s],s,this.data);return i}reduce(e,r){let i=r;for(let s=0;s<this.length;++s)i=e(i,this.data[s],s,this.data);return i}has(e){const r=this.length,i=this.data;for(let s=0;s<r;++s)if(i[s]===e)return!0;return!1}};function Qse(t){t.data.length>S6e*t.length&&(t.data.length=Math.floor(t.length*E6e))}function sNt(t){return t}function Vve(t){return 1e3*t}function nQ(t){return .001*t}function C6e(){return performance.now()}let A6e=class{constructor(e){this.phases=e,this.paused=!1,this.ticks=-1,this.removed=!1}},O6e=class{constructor(e){this.callback=e,this.isActive=!0}remove(){this.isActive=!1}},Jj=0,Qj=0;const BO={time:0,deltaTime:0,elapsedFrameTime:0,frameDuration:0},Kj=["prepare","preRender","render","postRender","update","finish"],e7=[],vT=new qt;let R6e=class{constructor(e){this._task=e}remove(){this._task.removed=!0}pause(){this._task.paused=!0}resume(){this._task.paused=!1}};const j5={frameTasks:vT,willDispatch:!1,clearFrameTasks:M6e,dispatch:Gve,executeFrameTasks:P6e};function iO(t){const e=new O6e(t);return e7.push(e),j5.willDispatch||(j5.willDispatch=!0,JC(Gve)),e}function QC(t){const e=new A6e(t);return vT.push(e),H5==null&&(Jj=performance.now(),H5=requestAnimationFrame(zve)),new R6e(e)}let H5=null;function M6e(t=!1){vT.forAll(e=>{e.removed=!0}),t&&Bve()}function I6e(t){Qj=Math.max(0,t)}function zve(){const t=performance.now();H5=null,H5=vT.length>0?requestAnimationFrame(zve):null,j5.executeFrameTasks(t)}function P6e(t){const e=t-Jj;Jj=t;const r=Qj>0?Qj:1e3/60,i=Math.max(0,e-r);BO.time=t,BO.frameDuration=r-i;for(let s=0;s<Kj.length;s++){const n=performance.now(),o=Kj[s];vT.forAll(a=>{a.paused||a.removed||(s===0&&a.ticks++,a.phases[o]&&(BO.elapsedFrameTime=performance.now()-t,BO.deltaTime=a.ticks===0?0:e,a.phases[o]?.call(a,BO)))}),$6e[s].record(performance.now()-n)}Bve(),L6e.record(performance.now()-t)}const iL=new qt;function Bve(){vT.forAll(t=>{t.removed&&iL.push(t)}),vT.removeUnorderedMany(iL.data,iL.length),iL.clear()}function Gve(){for(;e7.length;){const t=e7.shift();t.isActive&&t.callback()}j5.willDispatch=!1}function lNt(t=1,e){const r=nn(),i=()=>{dn(e)?r.reject(Tr()):t===0?r():(--t,JC(()=>i()))};return i(),r.promise}const $6e=Kj.map(t=>new r0(t)),L6e=new r0("total");function SF(t,e){for(const r of t.entries())if(e(r[0]))return!0;return!1}let D6e=0;const N6e=0;function vc(){return++D6e}let P6=class{constructor(e){this._accessed=[],this._handles=[],this._observerObject=new F6e(e),Kse.register(this,new WeakRef(this._observerObject),this)}destroy(){Kse.unregister(this._observerObject),this._accessed.length=0,this._observerObject?.destroy(),this.clear()}onObservableAccessed(e){const r=this._accessed;r.includes(e)||r.push(e)}onTrackingEnd(){const e=this._handles,r=this._accessed,i=this._observerObject;for(let s=0;s<r.length;++s)e.push(r[s].observe(i));r.length=0}clear(){const e=this._handles;for(let r=0;r<e.length;++r)e[r].remove();e.length=0}},F6e=class{constructor(e){this._notify=e,this._invalidCount=0,this.destroyed=!1}onInvalidated(){this._invalidCount++}onCommitted(){if(this.destroyed)return;const e=this._invalidCount;if(e===1)return this._invalidCount=0,void this._notify();this._invalidCount=e>0?e-1:0}destroy(){this.destroyed=!0,this._notify=k6e}};const Kse=new FinalizationRegistry(t=>{t.deref()?.destroy()});function k6e(){}let _C=!1;const q5=[];function jve(t,e){let r=new P6(n),i=null,s=!1;function n(){if(!r||s)return;if(_C)return void Wve(n);const a=i;r.clear(),_C=!0,s=!0,i=S0(r,t),s=!1,_C=!1,e(i,a),Zve()}function o(){r&&(r.destroy(),r=null,i=null)}return s=!0,i=S0(r,t),s=!1,{remove:o}}function Hve(t,e){let r=new P6(s),i=null;function s(){e(i,o)}function n(){r&&(r.destroy(),r=null),i=null}function o(){return r?(r.clear(),i=S0(r,t),i):null}return o(),{remove:n}}function qve(t){let e=new P6(i),r=!1;function i(){e&&!r&&(_C?Wve(i):(e.clear(),_C=!0,r=!0,S0(e,t),r=!1,_C=!1,Zve()))}function s(){e&&(e.destroy(),e=null)}return r=!0,S0(e,t),r=!1,{remove:s}}function Wve(t){q5.includes(t)||q5.unshift(t)}function Zve(){for(;q5.length;)q5.pop()()}var kM;(function(t){t[t.Untracked=0]="Untracked",t[t.Tracked=1]="Tracked"})(kM||(kM={}));let $I=class{constructor(){this.uid=vc(),this.removed=!1,this.type=null,this.oldValue=null,this.callback=null,this.getValue=null,this.target=null,this.path=null,this.equals=null}static acquireUntracked(e,r,i,s,n){return this.pool.acquire(kM.Untracked,e,r,i,s,n,RJ)}static acquireTracked(e,r,i,s){return this.pool.acquire(kM.Tracked,e,r,i,null,null,s)}notify(e,r){this.type===kM.Untracked?this.callback.call(this.target,e,r,this.path,this.target):this.callback.call(null,e,r,void 0,void 0)}acquire(e,r,i,s,n,o,a){this.uid=vc(),this.removed=!1,this.type=e,this.oldValue=r,this.callback=i,this.getValue=s,this.target=n,this.path=o,this.equals=a}release(){this.target=this.path=this.oldValue=this.callback=this.getValue=null,this.uid=vc(),this.removed=!0}};$I.pool=new Uve($I);const EF=new pu,o0=new Set;let W5;function Z5(t){o0.delete(t),o0.add(t),W5||(W5=iO(z6e))}function U6e(t){if(t.removed)return;const e=t.oldValue,r=t.getValue();t.equals(e,r)||(t.oldValue=r,t.notify(r,e))}function V6e(t){for(const e of o0.values())e.target===t&&(e.removed=!0)}function z6e(){let t=10;for(;W5&&t--;){W5=null;const e=B6e(),r=EF.acquire();for(const i of e){const s=i.uid;U6e(i),s===i.uid&&i.removed&&r.push(i)}for(const i of o0)i.removed&&(r.push(i),o0.delete(i));for(const i of r)$I.pool.release(i);EF.release(r),EF.release(e),t7.forEach(i=>i())}}function B6e(){const t=EF.acquire();t.length=o0.size;let e=0;for(const r of o0)t[e]=r,++e;return o0.clear(),t}const t7=new Set;function Xve(t){return t7.add(t),{remove(){t7.delete(t)}}}function G6e(t,e,r){let i=Mve(t,e,r,(s,n,o)=>{let a,l,c=Hve(()=>GP(s,n),(h,p)=>{s.__accessor__.destroyed||a&&a.uid!==l?i.remove():(a||(a=$I.acquireUntracked(h,o,p,s,n),l=a.uid),Z5(a))});return{remove:iQ(()=>{c.remove(),a&&(a.uid!==l||a.removed||(a.removed=!0,Z5(a)),a=null),i=c=null})}});return i}function j6e(t,e,r){const i=Mve(t,e,r,(s,n,o)=>{let a=!1;return jve(()=>GP(s,n),(l,c)=>{s.__accessor__.destroyed?i.remove():a||(a=!0,RJ(c,l)||o.call(s,l,c,n,s),a=!1)})});return i}function H6e(t,e,r,i=!1){return!t.__accessor__||t.__accessor__.destroyed?{remove(){}}:i?j6e(t,e,r):G6e(t,e,r)}function q6e(t,e,r){let i,s,n=Hve(t,(o,a)=>{i&&i.uid!==s?n.remove():(i||(i=$I.acquireTracked(o,e,a,r),s=i.uid),Z5(i))});return{remove:iQ(()=>{n.remove(),i&&(i.uid!==s||i.removed||(i.removed=!0,Z5(i)),i=null),n=null})}}function W6e(t,e,r){let i=!1;return jve(t,(s,n)=>{i||(i=!0,r(n,s)||e(s,n),i=!1)})}function Z6e(t,e,r=!1,i=W0e){return r?W6e(t,e,i):q6e(t,e,i)}function ene(t){return SF(o0,e=>e.oldValue===t)}function ra(t,e){for(const[r,i]of t)if(e(i,r))return!0;return!1}function dNt(t,e){for(const[r,i]of t)if(e(i,r))return i;return null}function BE(t,e,r){const i=t.get(e);if(i!==void 0)return i;const s=r();return t.set(e,s),s}const vC=K.getLogger("esri.core.accessorSupport.ensureTypes");function X6e(t){return t==null?t:new Date(t)}function Y6e(t){return t==null?t:!!t}function qP(t){return t==null?t:t.toString()}function wd(t){return t==null?t:(t=parseFloat(t),isNaN(t)?0:t)}function oQ(t){return t==null?t:Math.round(parseFloat(t))}function Yve(t){return t&&t.constructor&&t.constructor.__accessorMetadata__!==void 0}function X5(t,e){return e!=null&&t&&!(e instanceof t)}function Jve(t){return t&&"isCollection"in t}function tne(t){return t&&t.Type?typeof t.Type=="function"?t.Type:t.Type.base:null}function J6e(t,e){if(!e||!e.constructor||!Jve(e.constructor))return r7(t,e)?e:new t(e);const r=tne(t.prototype.itemType),i=tne(e.constructor.prototype.itemType);return r?i?r===i?e:r.prototype.isPrototypeOf(i.prototype)?new t(e):(r7(t,e),e):new t(e):e}function r7(t,e){return!!Yve(e)&&(vC.error("Accessor#set","Assigning an instance of '"+(e.declaredClass||"unknown")+"' which is not a subclass of '"+$6(t)+"'"),!0)}function bT(t,e){return e==null?e:Jve(t)?J6e(t,e):X5(t,e)?r7(t,e)?e:new t(e):e}function $6(t){return t&&t.prototype&&t.prototype.declaredClass||"unknown"}const Q6e=new WeakMap;function K6e(t){switch(t){case Number:return wd;case Ki:return oQ;case Boolean:return Y6e;case String:return qP;case Date:return X6e;default:return BE(Q6e,t,()=>bT.bind(null,t))}}function Sn(t,e){const r=K6e(t);return arguments.length===1?r:r(e)}function LI(t,e,r){return arguments.length===1?LI.bind(null,t):e&&(Array.isArray(e)?e.map(i=>t(i,r)):[t(e,r)])}function eVe(t,e){return arguments.length===1?LI(r=>Sn(t,r)):LI(r=>Sn(t,r),e)}function Qve(t,e,r){return e!==0&&Array.isArray(r)?r.map(i=>Qve(t,e-1,i)):t(r)}function Y5(t,e,r){if(arguments.length===2)return n=>Y5(t,e,n);if(!r)return r;r=Qve(t,e,r);let i=e,s=r;for(;i>0&&Array.isArray(s);)i--,s=s[0];if(s!==void 0)for(let n=0;n<i;n++)r=[r];return r}function tVe(t,e,r){return arguments.length===2?Y5(i=>Sn(t,i),e):Y5(i=>Sn(t,i),e,r)}function Kve(t){return!!Array.isArray(t)&&!t.some(e=>{const r=typeof e;return!(r==="string"||r==="number"||r==="function"&&t.length>1)})}function i7(t,e){if(arguments.length===2)return i7(t).call(null,e);const r=new Set,i=t.filter(a=>typeof a!="function"),s=t.filter(a=>typeof a=="function");for(const a of t)typeof a!="string"&&typeof a!="number"||r.add(a);let n=null,o=null;return(a,l)=>{if(a==null)return a;const c=typeof a,h=c==="string"||c==="number";return h&&(r.has(a)||s.some(p=>c==="string"&&p===String||c==="number"&&p===Number))||c==="object"&&s.some(p=>!X5(a,p))?a:(h&&i.length?(n||(n=i.map(p=>typeof p=="string"?`'${p}'`:`${p}`).join(", ")),vC.error("Accessor#set",`'${a}' is not a valid value for this property, only the following values are valid: ${n}`)):typeof a=="object"&&s.length?(o||(o=s.map(p=>$6(p)).join(", ")),vC.error("Accessor#set",`'${a}' is not a valid value for this property, value must be one of ${o}`)):vC.error("Accessor#set",`'${a}' is not a valid value for this property`),l&&(l.valid=!1),null)}}function Rf(t,e){if(arguments.length===2)return Rf(t).call(null,e);const r={},i=[],s=[];for(const l in t.typeMap){const c=t.typeMap[l];r[l]=Sn(c),i.push($6(c)),s.push(l)}const n=()=>`'${i.join("', '")}'`,o=()=>`'${s.join("', '")}'`,a=typeof t.key=="string"?l=>l[t.key]:t.key;return l=>{if(t.base&&!X5(t.base,l)||l==null)return l;const c=a(l)||t.defaultKeyValue,h=r[c];if(!h)return vC.error("Accessor#set",`Invalid property value, value needs to be one of ${n()}, or a plain object that can autocast (having .type = ${o()})`),null;if(!X5(t.typeMap[c],l))return l;if(typeof t.key=="string"&&!Yve(l)){const p={};for(const f in l)f!==t.key&&(p[f]=l[f]);return h(p)}return h(l)}}let Ki=class{};const fNt={native:t=>({type:"native",value:t}),array:t=>({type:"array",value:t}),oneOf:t=>({type:"one-of",values:t})};function rVe(t){if(!t||!("type"in t))return!1;switch(t.type){case"native":case"array":case"one-of":return!0}return!1}function e1e(t){switch(t.type){case"native":return Sn(t.value);case"array":return LI(e1e(t.value));case"one-of":return iVe(t);default:return null}}function iVe(t){let e=null;return(r,i)=>n7(r,t)?r:(e==null&&(e=s7(t)),vC.error("Accessor#set",`Invalid property value, value needs to be of type ${e}`),i&&(i.valid=!1),null)}function s7(t){switch(t.type){case"native":switch(t.value){case Number:return"number";case String:return"string";case Boolean:return"boolean";case Ki:return"integer";case Date:return"date";default:return $6(t.value)}case"array":return`array of ${s7(t.value)}`;case"one-of":{const e=t.values.map(r=>s7(r));return`one of ${e.slice(0,e.length-1)} or ${e[e.length-1]}`}}return"unknown"}function n7(t,e){if(t==null)return!0;switch(e.type){case"native":switch(e.value){case Number:case Ki:return typeof t=="number";case Boolean:return typeof t=="boolean";case String:return typeof t=="string"}return t instanceof e.value;case"array":return!!Array.isArray(t)&&!t.some(r=>!n7(r,e.value));case"one-of":return e.values.some(r=>n7(t,r))}}function d(t={}){return(e,r)=>{if(e===Function.prototype)throw new Error(`Inappropriate use of @property() on a static field: ${e.name}.${r}. Accessor does not support static properties.`);const i=Object.getOwnPropertyDescriptor(e,r),s=HP(e,r);i&&(i.get||i.set?(s.get=i.get||s.get,s.set=i.set||s.set):"value"in i&&("value"in t&&K.getLogger("esri.core.accessorSupport.decorators.property").warn(`@property() will redefine the value of "${r}" on "${e.constructor.name}" already defined in the metadata`,t),s.value=t.value=i.value)),t.readOnly!=null&&(s.readOnly=t.readOnly);const n=t.aliasOf;if(n){const l=typeof n=="string"?n:n.source,c=typeof n=="string"?null:n.overridable===!0;let h;s.dependsOn=[l],s.get=function(){let p=V5(this,l);if(typeof p=="function"){h||(h=l.split(".").slice(0,-1).join("."));const f=V5(this,h);f&&(p=p.bind(f))}return p},s.readOnly||(s.set=c?function(p){this._override(r,p)}:function(p){G5(this,l,p)})}const o=t.type,a=t.types;s.cast||(o?s.cast=sVe(o):a&&(Array.isArray(a)?s.cast=LI(Rf(a[0])):s.cast=Rf(a))),i6e(s,t),t.range&&(s.cast=nVe(s.cast,t.range))}}function aQ(t,e,r){const i=HP(t,r);i.json||(i.json={});let s=i.json;return e!==void 0&&(s.origins||(s.origins={}),s.origins[e]||(s.origins[e]={}),s=s.origins[e]),s}function sVe(t){let e=0,r=t;if(rVe(t))return e1e(t);for(;Array.isArray(r)&&r.length===1&&typeof r[0]!="string"&&typeof r[0]!="number";)r=r[0],e++;const i=r;if(Kve(i))return e===0?i7(i):Y5(i7(i),e);if(e===1)return eVe(i);if(e>1)return tVe(i,e);const s=t;return s.from?s.from:Sn(s)}function nVe(t,e){return r=>{let i=+t(r);return e.step!=null&&(i=Math.round(i/e.step)*e.step),e.min!=null&&(i=Math.max(e.min,i)),e.max!=null&&(i=Math.min(e.max,i)),i}}function oVe(t){if(t.json&&t.json.origins){const e=t.json.origins,r={"web-document":["web-scene","web-map"]};for(const i in r)if(e[i]){const s=e[i];r[i].forEach(n=>{e[n]=s}),delete e[i]}}}let Bd=class extends ive{constructor(e,r,i){super(e,r,i)}};Bd.prototype.type="warning";function t1e(t){return!!t&&t.prototype&&t.prototype.declaredClass&&t.prototype.declaredClass.indexOf("esri.core.Collection")===0}const o7=K.getLogger("esri.core.accessorSupport.extensions.serializableProperty.reader");function rne(t,e,r){t&&(!r&&!e.read||e.read?.reader||e.read?.enabled===!1||cVe(t)&&Ul("read.reader",sO(t),e))}function sO(t){const e=t.ndimArray??0;if(e>1)return lVe(t);if(e===1)return ine(t);if("type"in t&&i1e(t.type)){const r=t.type.prototype?.itemType?.Type,i=ine(typeof r=="function"?{type:r}:{types:r});return(s,n,o)=>{const a=i(s,n,o);return a&&new t.type(a)}}return lQ(t)}function lQ(t){return"type"in t?aVe(t.type):uVe(t.types)}function aVe(t){return t.prototype.read?(e,r,i)=>{if(e==null)return e;const s=typeof e;if(s!=="object")return void o7.error(`Expected JSON value of type 'object' to deserialize type '${t.prototype.declaredClass}', but got '${s}'`);const n=new t;return n.read(e,i),n}:t.fromJSON}function r1e(t,e,r,i){return i!==0&&Array.isArray(e)?e.map(s=>r1e(t,s,r,i-1)):t(e,void 0,r)}function lVe(t){const e=lQ(t),r=r1e.bind(null,e),i=t.ndimArray??0;return(s,n,o)=>{if(s==null)return s;s=r(s,o,i);let a=i,l=s;for(;a>0&&Array.isArray(l);)a--,l=l[0];if(l!==void 0)for(let c=0;c<a;c++)s=[s];return s}}function ine(t){const e=lQ(t);return(r,i,s)=>{if(r==null)return r;if(Array.isArray(r)){const o=[];for(const a of r){const l=e(a,void 0,s);l!==void 0&&o.push(l)}return o}const n=e(r,void 0,s);return n!==void 0?[n]:void 0}}function i1e(t){if(!t1e(t))return!1;const e=t.prototype.itemType;return!(!e||!e.Type)&&(typeof e.Type=="function"?cQ(e.Type):s1e(e.Type))}function cVe(t){return"types"in t?s1e(t.types):cQ(t.type)}function cQ(t){return!Array.isArray(t)&&!!t&&t.prototype&&("read"in t.prototype||"fromJSON"in t||i1e(t))}function s1e(t){for(const e in t.typeMap)if(!cQ(t.typeMap[e]))return!1;return!0}function uVe(t){let e=null;const r=t.errorContext??"type";return(i,s,n)=>{if(i==null)return i;const o=typeof i;if(o!=="object")return void o7.error(`Expected JSON value of type 'object' to deserialize, but got '${o}'`);e||(e=hVe(t));const a=t.key;if(typeof a!="string")return;const l=i[a],c=l?e[l]:t.defaultKeyValue?t.typeMap[t.defaultKeyValue]:void 0;if(!c){const p=`Type '${l||"unknown"}' is not supported`;return n&&n.messages&&i&&n.messages.push(new Bd(`${r}:unsupported`,p,{definition:i,context:n})),void o7.error(p)}const h=new c;return h.read(i,n),h}}function hVe(t){const e={};for(const r in t.typeMap){const i=t.typeMap[r],s=jP(i.prototype);if(typeof t.key=="function")continue;const n=s[t.key];if(!n)continue;n.json?.type&&Array.isArray(n.json.type)&&n.json.type.length===1&&typeof n.json.type[0]=="string"&&(e[n.json.type[0]]=i);const o=n.json?.write;if(!o||!o.writer){e[r]=i;continue}const a=o.target,l=typeof a=="string"?a:t.key,c={};o.writer(r,c,l),c[l]&&(e[c[l]]=i)}return e}function dVe(t){if(t.json||(t.json={}),nne(t.json),one(t.json),sne(t.json),t.json.origins)for(const e in t.json.origins)nne(t.json.origins[e]),one(t.json.origins[e]),sne(t.json.origins[e]);return!0}function sne(t){t.name&&(t.read&&typeof t.read=="object"?t.read.source===void 0&&(t.read.source=t.name):t.read={source:t.name},t.write&&typeof t.write=="object"?t.write.target===void 0&&(t.write.target=t.name):t.write={target:t.name})}function nne(t){typeof t.read=="boolean"?t.read={enabled:t.read}:typeof t.read=="function"?t.read={enabled:!0,reader:t.read}:t.read&&typeof t.read=="object"&&t.read.enabled===void 0&&(t.read.enabled=!0)}function one(t){typeof t.write=="boolean"?t.write={enabled:t.write}:typeof t.write=="function"?t.write={enabled:!0,writer:t.write}:t.write&&typeof t.write=="object"&&t.write.enabled===void 0&&(t.write.enabled=!0)}function ane(t,e){if(!e.write||e.write.writer||e.write.enabled===!1&&!e.write.overridePolicy)return;const r=t?.ndimArray??0;t&&(r===1||"type"in t&&t1e(t.type))?e.write.writer=mVe:r>1?e.write.writer=gVe(r):e.types?Array.isArray(e.types)?e.write.writer=fVe(e.types[0]):e.write.writer=pVe(e.types):e.write.writer=DI}function pVe(t){return(e,r,i,s)=>e?n1e(e,t,s)?DI(e,r,i,s):void 0:DI(e,r,i,s)}function n1e(t,e,r){for(const i in e.typeMap)if(t instanceof e.typeMap[i])return!0;if(r?.messages){const i=e.errorContext??"type",s=`Values of type '${(typeof e.key!="function"?t[e.key]:t.declaredClass)??"Unknown"}' cannot be written`;r&&r.messages&&t&&r.messages.push(new D(`${i}:unsupported`,s,{definition:t,context:r})),K.getLogger("esri.core.accessorSupport.extensions.serializableProperty.writer").error(s)}return!1}function fVe(t){return(e,r,i,s)=>!e||!Array.isArray(e)?DI(e,r,i,s):DI(e.filter(n=>n1e(n,t,s)),r,i,s)}function DI(t,e,r,i){Ul(r,J5(t,i),e)}function J5(t,e){return t&&typeof t.write=="function"?t.write({},e):t&&typeof t.toJSON=="function"?t.toJSON():typeof t=="number"?Q5(t):t}function Q5(t){return t===-1/0?-Number.MAX_VALUE:t===1/0?Number.MAX_VALUE:isNaN(t)?null:t}function mVe(t,e,r,i){let s;t===null?s=null:t&&typeof t.map=="function"?(s=t.map(n=>J5(n,i)),typeof s.toArray=="function"&&(s=s.toArray())):s=[J5(t,i)],Ul(r,s,e)}function o1e(t,e,r){return r!==0&&Array.isArray(t)?t.map(i=>o1e(i,e,r-1)):J5(t,e)}function gVe(t){return(e,r,i,s)=>{let n;if(e===null)n=null;else{n=o1e(e,s,t);let o=t,a=n;for(;o>0&&Array.isArray(a);)o--,a=a[0];if(a!==void 0)for(let l=0;l<o;l++)n=[n]}Ul(i,n,r)}}function yVe(t,e){return uQ(t,"any",e?.origin)}function a7(t,e){return uQ(t,"read",e?.origin)}function a1e(t,e){return uQ(t,"write",e?.origin)}function uQ(t,e,r){let i=t?.json;if(i?.origins&&r){let s;s=r==="link-chart"?i.origins[r]&&(e==="any"||e in i.origins[r])?i.origins[r]:i.origins["web-map"]:i.origins[r],s&&(e==="any"||e in s)&&(i=s)}return i}function _Ve(t){const e=vVe(t);if(t.json.origins)for(const r in t.json.origins){const i=t.json.origins[r],s=i.types?bVe(i):e;rne(s,i,!1),i.types&&!i.write&&t.json.write&&t.json.write.enabled&&(i.write={...t.json.write}),ane(s,i)}rne(e,t.json,!0),ane(e,t.json)}function vVe(t){return t.json.types?l7(t.json):t.type?l1e(t):l7(t)}function bVe(t){return t.type?l1e(t):l7(t)}function l1e(t){if(!t.type)return;let e=0,r=t.type;for(;Array.isArray(r)&&!Kve(r);)r=r[0],e++;return{type:r,ndimArray:e}}function l7(t){if(!t.types)return;let e=0,r=t.types;for(;Array.isArray(r);)r=r[0],e++;return{types:r,ndimArray:e}}function wVe(t){dVe(t)&&(oVe(t),_Ve(t))}const y9=new Set,_9=new Set;function R(t){return e=>{e.prototype.declaredClass=t,TVe(e);const r=[],i=[];let s=e.prototype;for(;s;)s.hasOwnProperty("initialize")&&!y9.has(s.initialize)&&(y9.add(s.initialize),r.push(s.initialize)),s.hasOwnProperty("destroy")&&!_9.has(s.destroy)&&(_9.add(s.destroy),i.push(s.destroy)),s=Object.getPrototypeOf(s);y9.clear(),_9.clear();class n extends e{constructor(...a){if(super(...a),this.constructor===n&&typeof this.postscript=="function"){if(r.length&&Object.defineProperty(this,"initialize",{enumerable:!1,configurable:!0,value(){for(let l=r.length-1;l>=0;l--)r[l].call(this)}}),i.length){let l=!1;const c=this[Ove];Object.defineProperty(this,"destroy",{enumerable:!1,configurable:!0,value(){if(!l){l=!0,c.call(this);for(let h=0;h<i.length;h++)i[h].call(this)}}})}this.postscript(...a)}}}return n.__accessorMetadata__=jP(e.prototype),n.prototype.declaredClass=t,n}}function xVe(t,e){return e.get==null?function(){const r=this.__accessor__,i=r.propertiesByName.get(t);if(i===void 0)return;Jt(i.observerObject);const s=r.store;return s.has(t)?s.get(t):i.metadata.value}:function(){const r=this.__accessor__,i=r.propertiesByName.get(t);if(i!==void 0)return i.getComputed(r)}}function TVe(t){const e=t.prototype,r=jP(e),i={};for(const s of Object.getOwnPropertyNames(r)){const n=r[s];wVe(n),i[s]={enumerable:!0,configurable:!0,get:xVe(s,n),set(o){const a=this.__accessor__;if(a!==void 0){if(!Object.isFrozen(this)){if(a.initialized&&n.readOnly)throw new TypeError(`[accessor] cannot assign to read-only property '${s}' of ${this.declaredClass}`);if(a.lifecycle===Yy.CONSTRUCTED&&n.constructOnly)throw new TypeError(`[accessor] cannot assign to construct-only property '${s}' of ${this.declaredClass}`);a.set(s,o)}}else Object.defineProperty(this,s,{enumerable:!0,configurable:!0,writable:!0,value:o})}}}Object.defineProperties(t.prototype,i)}var c1e,u1e;function SVe(t){if(t==null)return{value:t};if(Array.isArray(t))return{type:[t[0]],value:null};switch(typeof t){case"object":return t.constructor?.__accessorMetadata__||t instanceof Date?{type:t.constructor,value:t}:t;case"boolean":return{type:Boolean,value:t};case"string":return{type:String,value:t};case"number":return{type:Number,value:t};case"function":return{type:t,value:null};default:return}}const B_=Symbol("Accessor-Handles"),c7=Symbol("Accessor-Initialized");let me=class h1e{static createSubclass(e={}){if(Array.isArray(e))throw new Error("Multi-inheritance unsupported since 4.16");const{properties:r,declaredClass:i,constructor:s}=e;delete e.declaredClass,delete e.properties,delete e.constructor;const n=this;class o extends n{constructor(...l){super(...l),this.inherited=null,s&&s.apply(this,l)}}jP(o.prototype);for(const a in e){const l=e[a];o.prototype[a]=typeof l=="function"?function(...c){const h=this.inherited;let p;this.inherited=function(...f){if(n.prototype[a])return n.prototype[a].apply(this,f)};try{p=l.apply(this,c)}catch(f){throw this.inherited=h,f}return this.inherited=h,p}:e[a]}for(const a in r){const l=SVe(r[a]);d(l)(o.prototype,a)}return R(i)(o)}constructor(...e){if(this[c1e]=null,this[u1e]=!1,this.constructor===h1e)throw new Error("[accessor] cannot instantiate Accessor. This can be fixed by creating a subclass of Accessor");const r=new g6e(this);Object.defineProperty(this,"__accessor__",{enumerable:!1,value:r}),e.length>0&&this.normalizeCtorArgs&&(r.ctorArgs=this.normalizeCtorArgs.apply(this,e)),lne.register(this,r.propertiesByName,this)}postscript(e){const r=this.__accessor__,i=r.ctorArgs||e;r.initialize(),i&&(this.set(i),r.ctorArgs=null),r.constructed(),this.initialize(),this[c7]=!0}initialize(){}[Ove](){this[B_]=Re(this[B_])}destroy(){this.destroyed||(lne.unregister(this),V6e(this),this.__accessor__.destroy(),x6e()?.onInstanceDestroy(this))}get constructed(){return this.__accessor__&&this.__accessor__.initialized||!1}get initialized(){return this[c7]}get destroyed(){return this.__accessor__&&this.__accessor__.destroyed||!1}commitProperty(e){this.get(e)}get(e){return V5(this,e)}hasOwnProperty(e){return this.__accessor__?this.__accessor__.has(e):Object.prototype.hasOwnProperty.call(this,e)}keys(){return this.__accessor__?this.__accessor__.keys():[]}set(e,r){return G5(this,e,r),this}watch(e,r,i){return H6e(this,e,r,i)}own(e){this.addHandles(e)}addHandles(e,r){if(this.destroyed){const s=Array.isArray(e)?e:[e];for(const n of s)n.remove();return}let i=this[B_];i==null&&(i=this[B_]=new li),i.add(e,r)}removeHandles(e){const r=this[B_];r?.remove(e)}removeAllHandles(){const e=this[B_];e?.removeAll()}hasHandles(e){const r=this[B_];return r!=null&&r.has(e)}_override(e,r){r===void 0?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_clearOverride(e){return this.__accessor__.clearOverride(e)}_overrideIfSome(e,r){r==null?this.__accessor__.clearOverride(e):this.__accessor__.override(e,r)}_isOverridden(e){return this.__accessor__.isOverridden(e)}notifyChange(e){this.__accessor__.notifyChange(e)}_get(e){return this.__accessor__.internalGet(e)}_set(e,r){return this.__accessor__.internalSet(e,r),this}};c1e=B_,u1e=c7;const lne=new FinalizationRegistry(t=>{for(const e of t.values())e.destroy()});function Q(t,e,r={}){return hQ(t,e,r,d1e)}function No(t,e,r={}){return hQ(t,e,r,p1e)}function hQ(t,e,r={},i){let s=null;const n=r.once?(o,a)=>{i(o)&&(Pi(s),e(o,a))}:(o,a)=>{i(o)&&e(o,a)};if(s=Z6e(t,n,r.sync,r.equals),r.initial){const o=t();n(o,o)}return s}function Vs(t,e,r,i={}){let s=null,n=null,o=null;function a(){s&&n&&(n.remove(),i.onListenerRemove?.(s),s=null,n=null)}function l(h){i.once&&i.once&&Pi(o),r(h)}const c=Q(t,(h,p)=>{a(),M6(h)&&(s=h,n=w1(h,e,l),i.onListenerAdd?.(h))},{sync:i.sync,initial:!0});return o=Zr(()=>{c.remove(),a()}),o}function Pn(t,e){return EVe(t,p1e,e)}function EVe(t,e,r){if(dn(r))return Promise.reject(Tr());const i=t();if(e?.(i))return Promise.resolve(i);let s=null;function n(){s=Pi(s)}return new Promise((o,a)=>{s=Sc([xn(r,()=>{n(),a(Tr())}),hQ(t,l=>{n(),o(l)},{sync:!1,once:!0},e??d1e)])})}function d1e(t){return!0}function p1e(t){return!!t}function gNt(t,e,r={}){let i=!1;const s=Q(t,(n,o)=>{i||e(n,o)},r);return{remove(){s.remove()},pause(){i=!0},resume(){i=!1}}}const Rr={sync:!0},xt={initial:!0},Ri={sync:!0,initial:!0};let vf=class extends me{constructor(){super(...arguments),this.updating=!1,this._handleId=0,this._handles=new li,this._scheduleHandleId=0,this._pendingPromises=new Set}destroy(){this.removeAll(),this._handles.destroy()}add(e,r,i={}){return this._installWatch(e,r,i,Q)}addWhen(e,r,i={}){return this._installWatch(e,r,i,No)}addOnCollectionChange(e,r,{initial:i=!1,final:s=!1}={}){const n=++this._handleId;return this._handles.add([Vs(e,"after-changes",this._createSyncUpdatingCallback(),Rr),Vs(e,"change",r,{onListenerAdd:i?o=>r({added:o.toArray(),removed:[]}):void 0,onListenerRemove:s?o=>r({added:[],removed:o.toArray()}):void 0})],n),Zr(()=>this._handles.remove(n))}addPromise(e){if(e==null)return e;const r=++this._handleId;this._handles.add({remove:()=>{this._pendingPromises.delete(e)&&(this._pendingPromises.size!==0||this._handles.has(sL)||this._set("updating",!1))}},r),this._pendingPromises.add(e),this._set("updating",!0);const i=()=>this._handles.remove(r);return e.then(i,i),e}removeAll(){this._pendingPromises.clear(),this._handles.removeAll(),this._set("updating",!1)}_installWatch(e,r,i={},s){const n=++this._handleId;i.sync||this._installSyncUpdatingWatch(e,n);const o=s(e,r,i);return this._handles.add(o,n),Zr(()=>this._handles.remove(n))}_installSyncUpdatingWatch(e,r){const i=this._createSyncUpdatingCallback(),s=Q(e,i,{sync:!0,equals:()=>!1});return this._handles.add(s,r),s}_createSyncUpdatingCallback(){return()=>{this._handles.remove(sL),++this._scheduleHandleId;const e=this._scheduleHandleId;this._get("updating")||this._set("updating",!0),this._handles.add(iO(()=>{e===this._scheduleHandleId&&(this._set("updating",this._pendingPromises.size>0),this._handles.remove(sL))}),sL)}}};u([d({readOnly:!0})],vf.prototype,"updating",void 0),vf=u([R("esri.core.support.WatchUpdatingTracking")],vf);const sL=-42,Oc=t=>{let e=class extends t{constructor(){super(...arguments),this._handles=new li,this._updatingHandles=new vf}destroy(){this.destroyed||(this._handles.destroy(),this._updatingHandles.destroy())}get handles(){return this._handles}get updatingHandles(){return this._updatingHandles}};return u([d({readOnly:!0})],e.prototype,"handles",null),u([d({readOnly:!0})],e.prototype,"updatingHandles",null),e=u([R("esri.core.HandleOwner")],e),e};let wT=class extends Oc(me){};wT=u([R("esri.core.HandleOwner")],wT);const CVe=Object.prototype.toString;function AVe(t){const e="__accessorMetadata__"in t?Sn(t):t;return function(...r){if(r.push(e),typeof r[2]=="number")throw new Error("Using @cast has parameter decorator is not supported since 4.16");return OVe.apply(this,r)}}function OVe(t,e,r,i){HP(t,e).cast=i}function RVe(t){return(e,r)=>{HP(e,t).cast=e[r]}}function or(...t){if(t.length!==3||typeof t[1]!="string")return t.length===1&&CVe.call(t[0])==="[object Function]"?AVe(t[0]):t.length===1&&typeof t[0]=="string"?RVe(t[0]):void 0}var L1;function f1e(t,e){switch(t.type){case"range":{const r="range"in t?t.range[0]:t.minValue,i="range"in t?t.range[1]:t.maxValue;if(r!=null&&+e<r||i!=null&&+e>i)return L1.VALUE_OUT_OF_RANGE;break}case"coded-value":case"codedValue":if(t.codedValues==null||t.codedValues.every(r=>r==null||r.code!==e))return L1.INVALID_CODED_VALUE}return null}function dQ(t){if(!(!t||t.type!=="range"))return{min:"range"in t?t.range[0]:t.minValue,max:"range"in t?t.range[1]:t.maxValue}}(function(t){t.VALUE_OUT_OF_RANGE="domain-validation-error::value-out-of-range",t.INVALID_CODED_VALUE="domain-validation-error::invalid-coded-value"})(L1||(L1={}));let MVe=class m1e{constructor(){this._values=new Map,this.multipleOriginsSupported=!1}clone(e){const r=new m1e;return this._values.forEach((i,s)=>{e&&e.has(s)||r.set(s,re(i.value),i.origin)}),r}get(e,r){r=this._normalizeOrigin(r);const i=this._values.get(e);return r==null||i?.origin===r?i?.value:void 0}originOf(e){return this._values.get(e)?.origin??_r.USER}keys(e){e=this._normalizeOrigin(e);const r=[...this._values.keys()];return e==null?r:r.filter(i=>this._values.get(i)?.origin===e)}set(e,r,i){if((i=this._normalizeOrigin(i))===_r.DEFAULTS){const s=this._values.get(e);if(s&&s.origin!=null&&s.origin>i)return}this._values.set(e,new IVe(r,i))}delete(e,r){(r=this._normalizeOrigin(r))!=null&&this._values.get(e)?.origin!==r||this._values.delete(e)}has(e,r){return(r=this._normalizeOrigin(r))!=null?this._values.get(e)?.origin===r:this._values.has(e)}forEach(e){this._values.forEach(({value:r},i)=>e(r,i))}_normalizeOrigin(e){if(e!=null)return e===_r.DEFAULTS?e:_r.USER}},IVe=class{constructor(e,r){this.value=e,this.origin=r}};function g1e(t,e,r){e.keys().forEach(s=>{r.set(s,e.get(s),_r.DEFAULTS)});const i=t.metadatas;Object.keys(i).forEach(s=>{t.internalGet(s)&&r.set(s,t.internalGet(s),_r.DEFAULTS)})}function PVe(t,e,r){if(!t||!t.read||t.read.enabled===!1||!t.read.source)return!1;const i=t.read.source;if(typeof i=="string"){if(i===e||i.includes(".")&&i.indexOf(e)===0&&Wse(i,r))return!0}else for(const s of i)if(s===e||s.includes(".")&&s.indexOf(e)===0&&Wse(s,r))return!0;return!1}function $Ve(t){return t&&(!t.read||t.read.enabled!==!1&&!t.read.source)}function LVe(t,e,r,i,s){let n=a7(e[r],s);$Ve(n)&&(t[r]=!0);for(const o of Object.getOwnPropertyNames(e))n=a7(e[o],s),PVe(n,r,i)&&(t[o]=!0)}function DVe(t,e,r,i){const s=r.metadatas,n=yVe(s[e],i),o=n?.default;if(o===void 0)return;const a=typeof o=="function"?o.call(t,e,i):o;a!==void 0&&r.set(e,a)}const y1e={origin:"service"};function _1e(t,e,r=y1e){if(!e||typeof e!="object")return;const i=tl(t),s=i.metadatas,n={};for(const o of Object.getOwnPropertyNames(e))LVe(n,s,o,e,r);i.setDefaultOrigin(r.origin);for(const o of Object.getOwnPropertyNames(n)){const a=a7(s[o],r).read,l=a&&a.source;let c;c=l&&typeof l=="string"?GP(e,l):e[o],a&&a.reader&&(c=a.reader.call(t,c,e,r)),c!==void 0&&i.set(o,c)}if(!r||!r.ignoreDefaults){i.setDefaultOrigin("defaults");for(const o of Object.getOwnPropertyNames(s))n[o]||DVe(t,o,i,r)}i.setDefaultOrigin("user")}function NVe(t,e,r,i=y1e){const s={...i,messages:[]};r(s),s.messages?.forEach(n=>{n.type!=="warning"||t.loaded?i&&i.messages&&i.messages.push(n):t.loadWarnings.push(n)})}function FVe(t,e,r,i,s){const n={};return e.write?.writer?.call(t,i,n,r,s),n}function v1e(t,e,r,i,s,n){if(!i||!i.write)return!1;const o=t.get(r);if(!s&&i.write.overridePolicy){const a=i.write.overridePolicy.call(t,o,r,n??void 0);a!==void 0&&(s=a)}if(s||(s=i.write),!s||s.enabled===!1)return!1;if((o===null&&!s.allowNull&&!s.writerEnsuresNonNull||o===void 0)&&s.isRequired){const a=new D("web-document-write:property-required",`Missing value for required property '${r}' on '${t.declaredClass}'`,{propertyName:r,target:t});return a&&n&&n.messages?n.messages.push(a):a&&!n&&K.getLogger("esri.core.accessorSupport.write").error(a.name,a.message),!1}return!(o===void 0||o===null&&!s.allowNull&&!s.writerEnsuresNonNull||!s.alwaysWriteDefaults&&(!e.store.multipleOriginsSupported||e.store.originOf(r)===_r.DEFAULTS)&&kVe(t,r,n,i,o)||!s.ignoreOrigin&&n&&n.origin&&e.store.multipleOriginsSupported&&e.store.originOf(r)<t0(n.origin))}function kVe(t,e,r,i,s){const n=i.default;if(n===void 0)return!1;if(i.defaultEquals!=null)return i.defaultEquals(s);if(typeof n=="function"){if(Array.isArray(s)){const o=n.call(t,e,r??void 0);return T0(o,s)}return!1}return n===s}function UVe(t,e,r,i){const s=tl(t),n=s.metadatas,o=a1e(n[e],i);return!!o&&v1e(t,s,e,o,r,i)}function b1e(t,e,r){if(t&&typeof t.toJSON=="function"&&(!t.toJSON.isDefaultToJSON||!t.write))return wF(e,t.toJSON(r));const i=tl(t),s=i.metadatas;for(const n in s){const o=a1e(s[n],r);if(!v1e(t,i,n,o,void 0,r))continue;const a=t.get(n),l=FVe(t,o,o.write&&typeof o.write.target=="string"?o.write.target:n,a,r);Object.keys(l).length>0&&(e=wF(e,l),r?.resources?.pendingOperations?.length&&r.resources.pendingOperations.push(Promise.all(r.resources.pendingOperations).then(()=>wF(e,l,()=>"replace-arrays"))),r&&r.writtenProperties&&r.writtenProperties.push({target:t,propName:n,oldOrigin:u6e(i.store.originOf(n)),newOrigin:r.origin}))}return e}const iS=t=>{let e=class extends t{constructor(...r){super(...r);const i=tl(this),s=i.store,n=new MVe;i.store=n,g1e(i,s,n)}read(r,i){_1e(this,r,i)}write(r,i){return b1e(this,r??{},i)}toJSON(r){return this.write({},r)}static fromJSON(r,i){return VVe.call(this,r,i)}};return e=u([R("esri.core.JSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function VVe(t,e){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const r=new this;return r.read(t,e),r}let he=class extends iS(me){};he=u([R("esri.core.JSONSupport")],he);function Ae(t,e,r){let i,s;return e===void 0||Array.isArray(e)?(s=t,r=e,i=[void 0]):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;i.forEach(l=>{const c=aQ(n,l,s);c.read&&typeof c.read=="object"||(c.read={}),c.read.reader=a[o],r&&(c.read.source=(c.read.source||[]).concat(r))})}}let pQ=class{constructor(e,r,i,s){this.semiMajorAxis=e,this.flattening=r,this.outerAtmosphereRimWidth=i;const n=1-this.flattening;this.semiMinorAxis=this.semiMajorAxis*n,this.halfSemiMajorAxis=this.semiMajorAxis/2,this.halfCircumference=Math.PI*this.semiMajorAxis,this.metersPerDegree=this.halfCircumference/180,this.inverseFlattening=1/(1-this.flattening)-1,this.eccentricitySquared=s||2*this.flattening-this.flattening*this.flattening,this.meanRadiusSemiAxes=(2*this.semiMajorAxis+this.semiMinorAxis)/3}get radius(){return this.semiMajorAxis}};const ur=new pQ(6378137,1/298.257223563,3e5,.006694379990137799),ig=new pQ(3396190,1/169.8944472236118,23e4),E0=new pQ(1737400,0,0);var Ad;(function(t){t[t.CGCS2000=4490]="CGCS2000",t[t.GCSMARS2000=104971]="GCSMARS2000",t[t.GCSMARS2000_SPHERE=104905]="GCSMARS2000_SPHERE",t[t.GCSMOON2000=104903]="GCSMOON2000"})(Ad||(Ad={}));let y;const L={values:[1,.3048,.3048006096012192,.3047972654,.9143917962,.201166195164,.9143984146160287,.3047994715386762,20.11676512155263,20.11678249437587,.9143985307444408,.91439523,.3047997101815088,20.1168,20.116756,5e4,15e4],units:["Meter","Foot","Foot_US","Foot_Clarke","Yard_Clarke","Link_Clarke","Yard_Sears","Foot_Sears","Chain_Sears","Chain_Benoit_1895_B","Yard_Indian","Yard_Indian_1937","Foot_Gold_Coast","Chain","Chain_Sears_1922_Truncated","50_Kilometers","150_Kilometers"],2066:5,2136:12,2155:2,2157:0,2158:0,2159:12,2160:12,2204:2,2219:0,2220:0,2254:2,2255:2,2256:1,2265:1,2266:1,2267:2,2268:2,2269:1,2270:1,2271:2,2272:2,2273:1,2294:0,2295:0,2314:3,2899:2,2900:2,2901:1,2909:1,2910:1,2911:2,2912:2,2913:1,2914:1,2992:1,2993:0,2994:1,3080:1,3089:2,3090:0,3091:2,3102:2,3141:0,3142:0,3167:14,3359:2,3360:0,3361:1,3362:0,3363:2,3364:0,3365:2,3366:3,3404:2,3405:0,3406:0,3407:3,3439:0,3440:0,3479:1,3480:0,3481:1,3482:0,3483:1,3484:0,3485:2,3486:0,3487:2,3488:0,3489:0,3490:2,3491:0,3492:2,3493:0,3494:2,3495:0,3496:2,3497:0,3498:2,3499:0,3500:2,3501:0,3502:2,3503:0,3504:2,3505:0,3506:2,3507:0,3508:2,3509:0,3510:2,3511:0,3512:2,3513:0,3514:0,3515:2,3516:0,3517:2,3518:0,3519:2,3520:0,3521:2,3522:0,3523:2,3524:0,3525:2,3526:0,3527:2,3528:0,3529:2,3530:0,3531:2,3532:0,3533:2,3534:0,3535:2,3536:0,3537:2,3538:0,3539:2,3540:0,3541:2,3542:0,3543:2,3544:0,3545:2,3546:0,3547:2,3548:0,3549:2,3550:0,3551:2,3552:0,3553:2,3582:2,3583:0,3584:2,3585:0,3586:2,3587:0,3588:1,3589:0,3590:1,3591:0,3592:0,3593:1,3598:2,3599:0,3600:2,3605:1,3606:0,3607:0,3608:2,3609:0,3610:2,3611:0,3612:2,3613:0,3614:2,3615:0,3616:2,3617:0,3618:2,3619:0,3620:2,3621:0,3622:2,3623:0,3624:2,3625:0,3626:2,3627:0,3628:2,3629:0,3630:2,3631:0,3632:2,3633:0,3634:1,3635:0,3636:1,3640:2,3641:0,3642:2,3643:0,3644:1,3645:0,3646:1,3647:0,3648:1,3649:0,3650:2,3651:0,3652:2,3653:0,3654:2,3655:0,3656:1,3657:0,3658:2,3659:0,3660:2,3661:0,3662:2,3663:0,3664:2,3668:2,3669:0,3670:2,3671:0,3672:2,3673:0,3674:2,3675:0,3676:1,3677:2,3678:0,3679:1,3680:2,3681:0,3682:1,3683:2,3684:0,3685:0,3686:2,3687:0,3688:2,3689:0,3690:2,3691:0,3692:2,3696:2,3697:0,3698:2,3699:0,3700:2,3793:0,3794:0,3812:0,3854:0,3857:0,3920:0,3978:0,3979:0,3991:2,3992:2,4026:0,4037:0,4038:0,4071:0,4082:0,4083:0,4087:0,4088:0,4217:2,4414:0,4415:0,4417:0,4434:0,4437:0,4438:2,4439:2,4462:0,4467:0,4471:0,4474:0,4559:0,4647:0,4822:0,4826:0,4839:0,5018:0,5041:0,5042:0,5048:0,5167:0,5168:0,5221:0,5223:0,5234:0,5235:0,5243:0,5247:0,5266:0,5316:0,5320:0,5321:0,5325:0,5337:0,5361:0,5362:0,5367:0,5382:0,5383:0,5396:0,5456:0,5457:0,5469:0,5472:4,5490:0,5513:0,5514:0,5523:0,5559:0,5588:1,5589:3,5596:0,5627:0,5629:0,5641:0,5643:0,5644:0,5646:2,5654:2,5655:2,5659:0,5700:0,5825:0,5836:0,5837:0,5839:0,5842:0,5844:0,5858:0,5879:0,5880:0,5887:0,5890:0,6128:1,6129:1,6141:1,6204:0,6210:0,6211:0,6307:0,6312:0,6316:0,6362:0,6391:1,6405:1,6406:0,6407:1,6408:0,6409:1,6410:0,6411:2,6412:0,6413:2,6414:0,6415:0,6416:2,6417:0,6418:2,6419:0,6420:2,6421:0,6422:2,6423:0,6424:2,6425:0,6426:2,6427:0,6428:2,6429:0,6430:2,6431:0,6432:2,6433:0,6434:2,6435:0,6436:2,6437:0,6438:2,6439:0,6440:0,6441:2,6442:0,6443:2,6444:0,6445:2,6446:0,6447:2,6448:0,6449:2,6450:0,6451:2,6452:0,6453:2,6454:0,6455:2,6456:0,6457:2,6458:0,6459:2,6460:0,6461:2,6462:0,6463:2,6464:0,6465:2,6466:0,6467:2,6468:0,6469:2,6470:0,6471:2,6472:0,6473:2,6474:0,6475:2,6476:0,6477:2,6478:0,6479:2,6484:2,6485:0,6486:2,6487:0,6488:2,6489:0,6490:2,6491:0,6492:2,6493:0,6494:1,6495:0,6496:1,6497:0,6498:0,6499:1,6500:0,6501:2,6502:0,6503:2,6504:0,6505:2,6506:0,6507:2,6508:0,6509:0,6510:2,6515:1,6516:0,6518:0,6519:2,6520:0,6521:2,6522:0,6523:2,6524:0,6525:2,6526:0,6527:2,6528:0,6529:2,6530:0,6531:2,6532:0,6533:2,6534:0,6535:2,6536:0,6537:2,6538:0,6539:2,6540:0,6541:2,6542:0,6543:2,6544:0,6545:1,6546:0,6547:1,6548:0,6549:2,6550:0,6551:2,6552:0,6553:2,6554:0,6555:2,6556:0,6557:1,6558:0,6559:1,6560:0,6561:1,6562:0,6563:2,6564:0,6565:2,6566:0,6567:0,6568:2,6569:0,6570:1,6571:0,6572:2,6573:0,6574:2,6575:0,6576:2,6577:0,6578:2,6582:2,6583:0,6584:2,6585:0,6586:2,6587:0,6588:2,6589:0,6590:2,6591:0,6592:0,6593:2,6594:0,6595:2,6596:0,6597:2,6598:0,6599:2,6600:0,6601:2,6602:0,6603:2,6605:2,6606:0,6607:2,6608:0,6609:2,6610:0,6611:0,6612:2,6613:0,6614:2,6615:0,6616:2,6617:0,6618:2,6633:2,6646:0,6703:0,6784:0,6785:1,6786:0,6787:1,6788:0,6789:1,6790:0,6791:1,6792:0,6793:1,6794:0,6795:1,6796:0,6797:1,6798:0,6799:1,6800:0,6801:1,6802:0,6803:1,6804:0,6805:1,6806:0,6807:1,6808:0,6809:1,6810:0,6811:1,6812:0,6813:1,6814:0,6815:1,6816:0,6817:1,6818:0,6819:1,6820:0,6821:1,6822:0,6823:1,6824:0,6825:1,6826:0,6827:1,6828:0,6829:1,6830:0,6831:1,6832:0,6833:1,6834:0,6835:1,6836:0,6837:1,6838:0,6839:1,6840:0,6841:1,6842:0,6843:1,6844:0,6845:1,6846:0,6847:1,6848:0,6849:1,6850:0,6851:1,6852:0,6853:1,6854:0,6855:1,6856:0,6857:1,6858:0,6859:1,6860:0,6861:1,6862:0,6863:1,6867:0,6868:1,6870:0,6875:0,6876:0,6879:0,6880:2,6884:0,6885:1,6886:0,6887:1,6915:0,6922:0,6923:2,6924:0,6925:2,6962:0,6984:0,6991:0,7128:2,7131:0,7132:2,7142:0,7257:0,7258:2,7259:0,7260:2,7261:0,7262:2,7263:0,7264:2,7265:0,7266:2,7267:0,7268:2,7269:0,7270:2,7271:0,7272:2,7273:0,7274:2,7275:0,7276:2,7277:0,7278:2,7279:0,7280:2,7281:0,7282:2,7283:0,7284:2,7285:0,7286:2,7287:0,7288:2,7289:0,7290:2,7291:0,7292:2,7293:0,7294:2,7295:0,7296:2,7297:0,7298:2,7299:0,7300:2,7301:0,7302:2,7303:0,7304:2,7305:0,7306:2,7307:0,7308:2,7309:0,7310:2,7311:0,7312:2,7313:0,7314:2,7315:0,7316:2,7317:0,7318:2,7319:0,7320:2,7321:0,7322:2,7323:0,7324:2,7325:0,7326:2,7327:0,7328:2,7329:0,7330:2,7331:0,7332:2,7333:0,7334:2,7335:0,7336:2,7337:0,7338:2,7339:0,7340:2,7341:0,7342:2,7343:0,7344:2,7345:0,7346:2,7347:0,7348:2,7349:0,7350:2,7351:0,7352:2,7353:0,7354:2,7355:0,7356:2,7357:0,7358:2,7359:0,7360:2,7361:0,7362:2,7363:0,7364:2,7365:0,7366:2,7367:0,7368:2,7369:0,7370:2,7877:0,7878:0,7882:0,7883:0,7887:0,7899:0,7991:0,7992:0,8035:2,8036:2,8058:0,8059:0,8082:0,8083:0,8088:0,8090:0,8091:2,8092:0,8093:2,8095:0,8096:2,8097:0,8098:2,8099:0,8100:2,8101:0,8102:2,8103:0,8104:2,8105:0,8106:2,8107:0,8108:2,8109:0,8110:2,8111:0,8112:2,8113:0,8114:2,8115:0,8116:2,8117:0,8118:2,8119:0,8120:2,8121:0,8122:2,8123:0,8124:2,8125:0,8126:2,8127:0,8128:2,8129:0,8130:2,8131:0,8132:2,8133:0,8134:2,8135:0,8136:2,8137:0,8138:2,8139:0,8140:2,8141:0,8142:2,8143:0,8144:2,8145:0,8146:2,8147:0,8148:2,8149:0,8150:2,8151:0,8152:2,8153:0,8154:2,8155:0,8156:2,8157:0,8158:2,8159:0,8160:2,8161:0,8162:2,8163:0,8164:2,8165:0,8166:2,8167:0,8168:2,8169:0,8170:2,8171:0,8172:2,8173:0,8177:2,8179:0,8180:2,8181:0,8182:2,8184:0,8185:2,8187:0,8189:2,8191:0,8193:2,8196:0,8197:2,8198:0,8200:2,8201:0,8202:2,8203:0,8204:2,8205:0,8206:2,8207:0,8208:2,8209:0,8210:2,8212:0,8213:2,8214:0,8216:2,8218:0,8220:2,8222:0,8224:2,8225:0,8226:2,8311:0,8312:1,8313:0,8314:1,8315:0,8316:1,8317:0,8318:1,8319:0,8320:1,8321:0,8322:1,8323:0,8324:1,8325:0,8326:1,8327:0,8328:1,8329:0,8330:1,8331:0,8332:1,8333:0,8334:1,8335:0,8336:1,8337:0,8338:1,8339:0,8340:1,8341:0,8342:1,8343:0,8344:1,8345:0,8346:1,8347:0,8348:1,8352:0,8353:0,8379:0,8380:2,8381:0,8382:2,8383:0,8384:2,8385:0,8387:2,8391:0,8395:0,8433:0,8441:0,8455:0,8456:0,8531:2,8682:0,8686:0,8687:0,8692:0,8693:0,8826:0,8903:0,8950:0,8951:0,9039:0,9040:0,9141:0,9149:0,9150:0,9191:0,9221:0,9222:0,9249:0,9250:0,9252:0,9254:0,9265:0,9284:0,9285:0,9300:0,9354:0,9367:0,9373:0,9377:0,9387:0,9391:0,9456:0,9473:0,9498:0,9674:0,9678:0,9680:0,9709:0,9712:0,9713:0,9716:0,9741:0,9748:2,9749:2,9761:0,9766:0,9793:0,9794:0,9869:0,9874:0,9875:0,9880:0,9943:0,9945:0,9947:0,9967:0,9972:0,9977:0,20042:0,20050:1,20499:0,20538:0,20539:0,20790:0,20791:0,21291:0,21292:0,21500:0,21817:0,21818:0,22032:0,22033:0,22091:0,22092:0,22239:0,22240:0,22332:0,22337:0,22338:0,22391:0,22392:0,22639:0,22700:0,22739:0,22770:0,22780:0,22832:0,23090:0,23095:0,23239:0,23240:0,23433:0,23700:0,24047:0,24048:0,24100:3,24200:0,24305:0,24306:0,24382:10,24383:0,24500:0,24547:0,24548:0,24571:9,24600:0,25e3:0,25231:0,25884:0,25932:0,26237:0,26331:0,26332:0,26432:0,26591:0,26592:0,26632:0,26692:0,27120:0,27200:0,27291:6,27292:6,27429:0,27492:0,27493:0,27500:0,27700:0,28232:0,28600:0,28991:0,28992:0,29100:0,29101:0,29220:0,29221:0,29333:0,29635:0,29636:0,29701:0,29738:0,29739:0,29849:0,29850:0,29871:8,29872:7,29873:0,29874:0,30200:5,30339:0,30340:0,30591:0,30592:0,30791:0,30792:0,30800:0,31028:0,31121:0,31154:0,31170:0,31171:0,31370:0,31528:0,31529:0,31600:0,31700:0,31838:0,31839:0,31900:0,31901:0,32061:0,32062:0,32098:0,32099:2,32100:0,32104:0,32161:0,32766:0,53048:0,53049:0,54090:0,54091:0,65061:2,65062:2,65161:0,65163:0,102041:2,102064:11,102068:15,102069:16,102118:2,102119:1,102120:2,102121:2,102217:2,102218:0,102219:2,102220:2,102378:1,102379:1,102380:0,102381:1,102589:2,102599:2,102600:2,102604:2,102647:0,102704:2,102705:2,102706:0,102731:0,102732:0,102759:1,102760:1,102761:2,102762:0,102763:2,102764:0,102765:0,102766:2,102970:1,102974:2,102993:0,102994:0,102995:2,102996:2,103015:0,103016:2,103017:0,103018:2,103025:0,103026:0,103027:2,103028:2,103035:0,103036:0,103037:2,103038:2,103039:0,103040:0,103041:2,103042:2,103043:0,103044:0,103045:2,103046:2,103047:0,103048:0,103049:2,103050:2,103051:0,103052:2,103053:0,103054:2,103055:0,103056:2,103057:0,103058:0,103059:2,103060:2,103061:0,103062:0,103063:2,103064:2,103069:2,103070:0,103071:0,103072:2,103073:2,103086:0,103087:0,103088:2,103089:2,103094:1,103095:0,103096:2,103103:0,103104:2,103105:0,103106:2,103121:0,103122:2,103123:0,103124:0,103125:1,103126:1,103127:0,103128:0,103129:2,103130:2,103131:0,103132:0,103133:2,103134:2,103135:0,103136:0,103137:1,103138:1,103139:0,103140:2,103141:0,103142:2,103143:0,103144:2,103145:0,103146:1,103147:0,103148:0,103149:2,103150:2,103151:0,103152:2,103172:0,103173:2,103174:0,103175:0,103176:2,103177:2,103178:0,103179:0,103180:2,103181:2,103182:0,103183:0,103184:2,103185:2,103228:0,103229:0,103230:2,103231:2,103250:0,103251:2,103252:0,103253:2,103260:0,103261:0,103262:2,103263:2,103270:0,103271:0,103272:2,103273:2,103274:0,103275:0,103276:2,103277:2,103278:0,103279:0,103280:2,103281:2,103282:0,103283:0,103284:2,103285:2,103286:0,103287:2,103288:0,103289:2,103290:0,103291:2,103292:0,103293:0,103294:2,103295:2,103296:0,103297:0,103298:2,103299:2,103376:2,103377:0,103378:0,103379:2,103380:2,103393:0,103394:0,103395:2,103396:2,103472:0,103473:1,103474:0,103475:2,103482:0,103483:2,103484:0,103485:2,103500:0,103501:2,103502:0,103503:0,103504:1,103505:1,103506:0,103507:0,103508:2,103509:2,103510:0,103511:0,103512:2,103513:2,103514:0,103515:2,103516:0,103517:2,103518:0,103519:2,103520:0,103521:1,103522:0,103523:0,103524:2,103525:2,103526:0,103527:2,103561:2,103562:2,103563:0,103564:0,103565:2,103566:2,103567:0,103568:0,103569:2,103570:2,103584:0,103585:2,103586:0,103587:2,103588:1,103589:0,103590:2,103591:1,103592:0,103593:2,103594:1,103695:2};for(y=2e3;y<=2045;y++)L[y]=0;for(y=2056;y<=2065;y++)L[y]=0;for(y=2067;y<=2135;y++)L[y]=0;for(y=2137;y<=2154;y++)L[y]=0;for(y=2161;y<=2170;y++)L[y]=0;for(y=2172;y<=2193;y++)L[y]=0;for(y=2195;y<=2198;y++)L[y]=0;for(y=2200;y<=2203;y++)L[y]=0;for(y=2205;y<=2217;y++)L[y]=0;for(y=2222;y<=2224;y++)L[y]=1;for(y=2225;y<=2250;y++)L[y]=2;for(y=2251;y<=2253;y++)L[y]=1;for(y=2257;y<=2264;y++)L[y]=2;for(y=2274;y<=2279;y++)L[y]=2;for(y=2280;y<=2282;y++)L[y]=1;for(y=2283;y<=2289;y++)L[y]=2;for(y=2290;y<=2292;y++)L[y]=0;for(y=2308;y<=2313;y++)L[y]=0;for(y=2315;y<=2491;y++)L[y]=0;for(y=2494;y<=2866;y++)L[y]=0;for(y=2867;y<=2869;y++)L[y]=1;for(y=2870;y<=2888;y++)L[y]=2;for(y=2891;y<=2895;y++)L[y]=2;for(y=2896;y<=2898;y++)L[y]=1;for(y=2902;y<=2908;y++)L[y]=2;for(y=2915;y<=2920;y++)L[y]=2;for(y=2921;y<=2923;y++)L[y]=1;for(y=2924;y<=2930;y++)L[y]=2;for(y=2931;y<=2962;y++)L[y]=0;for(y=2964;y<=2968;y++)L[y]=2;for(y=2969;y<=2973;y++)L[y]=0;for(y=2975;y<=2991;y++)L[y]=0;for(y=2995;y<=3051;y++)L[y]=0;for(y=3054;y<=3079;y++)L[y]=0;for(y=3081;y<=3088;y++)L[y]=0;for(y=3092;y<=3101;y++)L[y]=0;for(y=3106;y<=3138;y++)L[y]=0;for(y=3146;y<=3151;y++)L[y]=0;for(y=3153;y<=3166;y++)L[y]=0;for(y=3168;y<=3172;y++)L[y]=0;for(y=3174;y<=3203;y++)L[y]=0;for(y=3294;y<=3358;y++)L[y]=0;for(y=3367;y<=3403;y++)L[y]=0;for(y=3408;y<=3416;y++)L[y]=0;for(y=3417;y<=3438;y++)L[y]=2;for(y=3441;y<=3446;y++)L[y]=2;for(y=3447;y<=3450;y++)L[y]=0;for(y=3451;y<=3459;y++)L[y]=2;for(y=3460;y<=3478;y++)L[y]=0;for(y=3554;y<=3559;y++)L[y]=0;for(y=3560;y<=3570;y++)L[y]=2;for(y=3571;y<=3581;y++)L[y]=0;for(y=3594;y<=3597;y++)L[y]=0;for(y=3601;y<=3604;y++)L[y]=0;for(y=3637;y<=3639;y++)L[y]=0;for(y=3665;y<=3667;y++)L[y]=0;for(y=3693;y<=3695;y++)L[y]=0;for(y=3701;y<=3727;y++)L[y]=0;for(y=3728;y<=3739;y++)L[y]=2;for(y=3740;y<=3751;y++)L[y]=0;for(y=3753;y<=3760;y++)L[y]=2;for(y=3761;y<=3773;y++)L[y]=0;for(y=3775;y<=3777;y++)L[y]=0;for(y=3779;y<=3781;y++)L[y]=0;for(y=3783;y<=3785;y++)L[y]=0;for(y=3788;y<=3791;y++)L[y]=0;for(y=3797;y<=3802;y++)L[y]=0;for(y=3814;y<=3816;y++)L[y]=0;for(y=3825;y<=3829;y++)L[y]=0;for(y=3832;y<=3841;y++)L[y]=0;for(y=3844;y<=3852;y++)L[y]=0;for(y=3873;y<=3885;y++)L[y]=0;for(y=3890;y<=3893;y++)L[y]=0;for(y=3907;y<=3912;y++)L[y]=0;for(y=3942;y<=3950;y++)L[y]=0;for(y=3968;y<=3970;y++)L[y]=0;for(y=3973;y<=3976;y++)L[y]=0;for(y=3986;y<=3989;y++)L[y]=0;for(y=3994;y<=3997;y++)L[y]=0;for(y=4048;y<=4051;y++)L[y]=0;for(y=4056;y<=4063;y++)L[y]=0;for(y=4093;y<=4096;y++)L[y]=0;for(y=4390;y<=4398;y++)L[y]=0;for(y=4399;y<=4413;y++)L[y]=2;for(y=4418;y<=4433;y++)L[y]=2;for(y=4455;y<=4457;y++)L[y]=2;for(y=4484;y<=4489;y++)L[y]=0;for(y=4491;y<=4554;y++)L[y]=0;for(y=4568;y<=4589;y++)L[y]=0;for(y=4652;y<=4656;y++)L[y]=0;for(y=4766;y<=4800;y++)L[y]=0;for(y=5014;y<=5016;y++)L[y]=0;for(y=5069;y<=5072;y++)L[y]=0;for(y=5105;y<=5130;y++)L[y]=0;for(y=5173;y<=5188;y++)L[y]=0;for(y=5253;y<=5259;y++)L[y]=0;for(y=5269;y<=5275;y++)L[y]=0;for(y=5292;y<=5311;y++)L[y]=0;for(y=5329;y<=5331;y++)L[y]=0;for(y=5343;y<=5349;y++)L[y]=0;for(y=5355;y<=5357;y++)L[y]=0;for(y=5387;y<=5389;y++)L[y]=0;for(y=5459;y<=5463;y++)L[y]=0;for(y=5479;y<=5482;y++)L[y]=0;for(y=5518;y<=5520;y++)L[y]=0;for(y=5530;y<=5539;y++)L[y]=0;for(y=5550;y<=5552;y++)L[y]=0;for(y=5562;y<=5583;y++)L[y]=0;for(y=5623;y<=5625;y++)L[y]=2;for(y=5631;y<=5639;y++)L[y]=0;for(y=5649;y<=5653;y++)L[y]=0;for(y=5663;y<=5680;y++)L[y]=0;for(y=5682;y<=5685;y++)L[y]=0;for(y=5875;y<=5877;y++)L[y]=0;for(y=5896;y<=5899;y++)L[y]=0;for(y=5921;y<=5940;y++)L[y]=0;for(y=6050;y<=6125;y++)L[y]=0;for(y=6244;y<=6275;y++)L[y]=0;for(y=6328;y<=6348;y++)L[y]=0;for(y=6350;y<=6356;y++)L[y]=0;for(y=6366;y<=6372;y++)L[y]=0;for(y=6381;y<=6387;y++)L[y]=0;for(y=6393;y<=6404;y++)L[y]=0;for(y=6480;y<=6483;y++)L[y]=0;for(y=6511;y<=6514;y++)L[y]=0;for(y=6579;y<=6581;y++)L[y]=0;for(y=6619;y<=6624;y++)L[y]=0;for(y=6625;y<=6627;y++)L[y]=2;for(y=6628;y<=6632;y++)L[y]=0;for(y=6634;y<=6637;y++)L[y]=0;for(y=6669;y<=6692;y++)L[y]=0;for(y=6707;y<=6709;y++)L[y]=0;for(y=6720;y<=6723;y++)L[y]=0;for(y=6732;y<=6738;y++)L[y]=0;for(y=6931;y<=6933;y++)L[y]=0;for(y=6956;y<=6959;y++)L[y]=0;for(y=7005;y<=7007;y++)L[y]=0;for(y=7057;y<=7070;y++)L[y]=2;for(y=7074;y<=7082;y++)L[y]=0;for(y=7109;y<=7118;y++)L[y]=0;for(y=7119;y<=7127;y++)L[y]=1;for(y=7374;y<=7376;y++)L[y]=0;for(y=7528;y<=7586;y++)L[y]=0;for(y=7587;y<=7645;y++)L[y]=2;for(y=7692;y<=7696;y++)L[y]=0;for(y=7755;y<=7787;y++)L[y]=0;for(y=7791;y<=7795;y++)L[y]=0;for(y=7799;y<=7801;y++)L[y]=0;for(y=7803;y<=7805;y++)L[y]=0;for(y=7825;y<=7831;y++)L[y]=0;for(y=7845;y<=7859;y++)L[y]=0;for(y=8013;y<=8032;y++)L[y]=0;for(y=8065;y<=8068;y++)L[y]=1;for(y=8518;y<=8529;y++)L[y]=2;for(y=8533;y<=8536;y++)L[y]=2;for(y=8538;y<=8540;y++)L[y]=2;for(y=8677;y<=8679;y++)L[y]=0;for(y=8836;y<=8840;y++)L[y]=0;for(y=8857;y<=8859;y++)L[y]=0;for(y=8908;y<=8910;y++)L[y]=0;for(y=9154;y<=9159;y++)L[y]=0;for(y=9205;y<=9218;y++)L[y]=0;for(y=9271;y<=9273;y++)L[y]=0;for(y=9295;y<=9297;y++)L[y]=0;for(y=9356;y<=9360;y++)L[y]=0;for(y=9404;y<=9407;y++)L[y]=0;for(y=9476;y<=9482;y++)L[y]=0;for(y=9487;y<=9494;y++)L[y]=0;for(y=9697;y<=9699;y++)L[y]=0;for(y=9821;y<=9865;y++)L[y]=0;for(y=20002;y<=20032;y++)L[y]=0;for(y=20047;y<=20049;y++)L[y]=0;for(y=20062;y<=20092;y++)L[y]=0;for(y=20135;y<=20138;y++)L[y]=0;for(y=20248;y<=20258;y++)L[y]=0;for(y=20348;y<=20358;y++)L[y]=0;for(y=20436;y<=20440;y++)L[y]=0;for(y=20822;y<=20824;y++)L[y]=0;for(y=20904;y<=20932;y++)L[y]=0;for(y=20934;y<=20936;y++)L[y]=0;for(y=21004;y<=21032;y++)L[y]=0;for(y=21035;y<=21037;y++)L[y]=0;for(y=21095;y<=21097;y++)L[y]=0;for(y=21148;y<=21150;y++)L[y]=0;for(y=21207;y<=21264;y++)L[y]=0;for(y=21307;y<=21364;y++)L[y]=0;for(y=21413;y<=21423;y++)L[y]=0;for(y=21453;y<=21463;y++)L[y]=0;for(y=21473;y<=21483;y++)L[y]=0;for(y=21780;y<=21782;y++)L[y]=0;for(y=21891;y<=21894;y++)L[y]=0;for(y=21896;y<=21899;y++)L[y]=0;for(y=22171;y<=22177;y++)L[y]=0;for(y=22181;y<=22187;y++)L[y]=0;for(y=22191;y<=22197;y++)L[y]=0;for(y=22207;y<=22222;y++)L[y]=0;for(y=22234;y<=22236;y++)L[y]=0;for(y=22243;y<=22250;y++)L[y]=0;for(y=22262;y<=22265;y++)L[y]=0;for(y=22307;y<=22322;y++)L[y]=0;for(y=22348;y<=22357;y++)L[y]=0;for(y=22407;y<=22422;y++)L[y]=0;for(y=22462;y<=22465;y++)L[y]=0;for(y=22521;y<=22525;y++)L[y]=0;for(y=22607;y<=22622;y++)L[y]=0;for(y=22641;y<=22646;y++)L[y]=0;for(y=22648;y<=22657;y++)L[y]=0;for(y=22707;y<=22722;y++)L[y]=0;for(y=22762;y<=22765;y++)L[y]=0;for(y=22991;y<=22994;y++)L[y]=0;for(y=23028;y<=23038;y++)L[y]=0;for(y=23830;y<=23853;y++)L[y]=0;for(y=23866;y<=23872;y++)L[y]=0;for(y=23877;y<=23884;y++)L[y]=0;for(y=23886;y<=23894;y++)L[y]=0;for(y=23946;y<=23948;y++)L[y]=0;for(y=24311;y<=24313;y++)L[y]=0;for(y=24342;y<=24347;y++)L[y]=0;for(y=24370;y<=24374;y++)L[y]=10;for(y=24375;y<=24381;y++)L[y]=0;for(y=24718;y<=24721;y++)L[y]=0;for(y=24817;y<=24821;y++)L[y]=0;for(y=24877;y<=24882;y++)L[y]=0;for(y=24891;y<=24893;y++)L[y]=0;for(y=25391;y<=25395;y++)L[y]=0;for(y=25828;y<=25838;y++)L[y]=0;for(y=26191;y<=26195;y++)L[y]=0;for(y=26391;y<=26393;y++)L[y]=0;for(y=26701;y<=26722;y++)L[y]=0;for(y=26729;y<=26799;y++)L[y]=2;for(y=26801;y<=26803;y++)L[y]=2;for(y=26811;y<=26813;y++)L[y]=2;for(y=26847;y<=26870;y++)L[y]=2;for(y=26891;y<=26899;y++)L[y]=0;for(y=26901;y<=26923;y++)L[y]=0;for(y=26929;y<=26946;y++)L[y]=0;for(y=26948;y<=26998;y++)L[y]=0;for(y=27037;y<=27040;y++)L[y]=0;for(y=27205;y<=27232;y++)L[y]=0;for(y=27258;y<=27260;y++)L[y]=0;for(y=27391;y<=27398;y++)L[y]=0;for(y=27561;y<=27564;y++)L[y]=0;for(y=27571;y<=27574;y++)L[y]=0;for(y=27581;y<=27584;y++)L[y]=0;for(y=27591;y<=27594;y++)L[y]=0;for(y=28191;y<=28193;y++)L[y]=0;for(y=28348;y<=28358;y++)L[y]=0;for(y=28402;y<=28432;y++)L[y]=0;for(y=28462;y<=28492;y++)L[y]=0;for(y=29118;y<=29122;y++)L[y]=0;for(y=29168;y<=29172;y++)L[y]=0;for(y=29177;y<=29185;y++)L[y]=0;for(y=29187;y<=29195;y++)L[y]=0;for(y=29900;y<=29903;y++)L[y]=0;for(y=30161;y<=30179;y++)L[y]=0;for(y=30491;y<=30494;y++)L[y]=0;for(y=30729;y<=30732;y++)L[y]=0;for(y=31251;y<=31259;y++)L[y]=0;for(y=31265;y<=31268;y++)L[y]=0;for(y=31275;y<=31279;y++)L[y]=0;for(y=31281;y<=31297;y++)L[y]=0;for(y=31461;y<=31469;y++)L[y]=0;for(y=31491;y<=31495;y++)L[y]=0;for(y=31917;y<=31922;y++)L[y]=0;for(y=31965;y<=32e3;y++)L[y]=0;for(y=32001;y<=32003;y++)L[y]=2;for(y=32005;y<=32031;y++)L[y]=2;for(y=32033;y<=32060;y++)L[y]=2;for(y=32064;y<=32067;y++)L[y]=2;for(y=32074;y<=32077;y++)L[y]=2;for(y=32081;y<=32086;y++)L[y]=0;for(y=32107;y<=32130;y++)L[y]=0;for(y=32133;y<=32159;y++)L[y]=0;for(y=32164;y<=32167;y++)L[y]=2;for(y=32180;y<=32199;y++)L[y]=0;for(y=32201;y<=32260;y++)L[y]=0;for(y=32301;y<=32360;y++)L[y]=0;for(y=32601;y<=32662;y++)L[y]=0;for(y=32664;y<=32667;y++)L[y]=2;for(y=32701;y<=32761;y++)L[y]=0;for(y=53001;y<=53004;y++)L[y]=0;for(y=53008;y<=53019;y++)L[y]=0;for(y=53021;y<=53032;y++)L[y]=0;for(y=53034;y<=53037;y++)L[y]=0;for(y=53042;y<=53046;y++)L[y]=0;for(y=53074;y<=53080;y++)L[y]=0;for(y=54001;y<=54004;y++)L[y]=0;for(y=54008;y<=54019;y++)L[y]=0;for(y=54021;y<=54032;y++)L[y]=0;for(y=54034;y<=54037;y++)L[y]=0;for(y=54042;y<=54046;y++)L[y]=0;for(y=54048;y<=54053;y++)L[y]=0;for(y=54074;y<=54080;y++)L[y]=0;for(y=54098;y<=54101;y++)L[y]=0;for(y=102001;y<=102040;y++)L[y]=0;for(y=102042;y<=102063;y++)L[y]=0;for(y=102065;y<=102067;y++)L[y]=0;for(y=102070;y<=102117;y++)L[y]=0;for(y=102122;y<=102216;y++)L[y]=0;for(y=102221;y<=102377;y++)L[y]=0;for(y=102382;y<=102388;y++)L[y]=0;for(y=102389;y<=102398;y++)L[y]=2;for(y=102399;y<=102444;y++)L[y]=0;for(y=102445;y<=102447;y++)L[y]=2;for(y=102448;y<=102458;y++)L[y]=0;for(y=102459;y<=102468;y++)L[y]=2;for(y=102469;y<=102499;y++)L[y]=0;for(y=102500;y<=102519;y++)L[y]=1;for(y=102520;y<=102524;y++)L[y]=0;for(y=102525;y<=102529;y++)L[y]=2;for(y=102530;y<=102588;y++)L[y]=0;for(y=102590;y<=102598;y++)L[y]=0;for(y=102601;y<=102603;y++)L[y]=0;for(y=102605;y<=102628;y++)L[y]=0;for(y=102629;y<=102646;y++)L[y]=2;for(y=102648;y<=102700;y++)L[y]=2;for(y=102701;y<=102703;y++)L[y]=0;for(y=102707;y<=102730;y++)L[y]=2;for(y=102733;y<=102758;y++)L[y]=2;for(y=102767;y<=102900;y++)L[y]=0;for(y=102901;y<=102933;y++)L[y]=2;for(y=102934;y<=102950;y++)L[y]=13;for(y=102951;y<=102955;y++)L[y]=0;for(y=102961;y<=102963;y++)L[y]=0;for(y=102965;y<=102969;y++)L[y]=0;for(y=102971;y<=102973;y++)L[y]=0;for(y=102975;y<=102989;y++)L[y]=0;for(y=102990;y<=102992;y++)L[y]=1;for(y=102997;y<=103002;y++)L[y]=0;for(y=103003;y<=103008;y++)L[y]=2;for(y=103009;y<=103011;y++)L[y]=0;for(y=103012;y<=103014;y++)L[y]=2;for(y=103019;y<=103021;y++)L[y]=0;for(y=103022;y<=103024;y++)L[y]=2;for(y=103029;y<=103031;y++)L[y]=0;for(y=103032;y<=103034;y++)L[y]=2;for(y=103065;y<=103068;y++)L[y]=0;for(y=103074;y<=103076;y++)L[y]=0;for(y=103077;y<=103079;y++)L[y]=1;for(y=103080;y<=103082;y++)L[y]=0;for(y=103083;y<=103085;y++)L[y]=2;for(y=103090;y<=103093;y++)L[y]=0;for(y=103097;y<=103099;y++)L[y]=0;for(y=103100;y<=103102;y++)L[y]=2;for(y=103107;y<=103109;y++)L[y]=0;for(y=103110;y<=103112;y++)L[y]=2;for(y=103113;y<=103116;y++)L[y]=0;for(y=103117;y<=103120;y++)L[y]=2;for(y=103153;y<=103157;y++)L[y]=0;for(y=103158;y<=103162;y++)L[y]=2;for(y=103163;y<=103165;y++)L[y]=0;for(y=103166;y<=103168;y++)L[y]=1;for(y=103169;y<=103171;y++)L[y]=2;for(y=103186;y<=103188;y++)L[y]=0;for(y=103189;y<=103191;y++)L[y]=2;for(y=103192;y<=103195;y++)L[y]=0;for(y=103196;y<=103199;y++)L[y]=2;for(y=103200;y<=103224;y++)L[y]=0;for(y=103225;y<=103227;y++)L[y]=1;for(y=103232;y<=103237;y++)L[y]=0;for(y=103238;y<=103243;y++)L[y]=2;for(y=103244;y<=103246;y++)L[y]=0;for(y=103247;y<=103249;y++)L[y]=2;for(y=103254;y<=103256;y++)L[y]=0;for(y=103257;y<=103259;y++)L[y]=2;for(y=103264;y<=103266;y++)L[y]=0;for(y=103267;y<=103269;y++)L[y]=2;for(y=103300;y<=103375;y++)L[y]=0;for(y=103381;y<=103383;y++)L[y]=0;for(y=103384;y<=103386;y++)L[y]=1;for(y=103387;y<=103389;y++)L[y]=0;for(y=103390;y<=103392;y++)L[y]=2;for(y=103397;y<=103399;y++)L[y]=0;for(y=103400;y<=103471;y++)L[y]=2;for(y=103476;y<=103478;y++)L[y]=0;for(y=103479;y<=103481;y++)L[y]=2;for(y=103486;y<=103488;y++)L[y]=0;for(y=103489;y<=103491;y++)L[y]=2;for(y=103492;y<=103495;y++)L[y]=0;for(y=103496;y<=103499;y++)L[y]=2;for(y=103528;y<=103543;y++)L[y]=0;for(y=103544;y<=103548;y++)L[y]=2;for(y=103549;y<=103551;y++)L[y]=0;for(y=103552;y<=103554;y++)L[y]=1;for(y=103555;y<=103557;y++)L[y]=2;for(y=103558;y<=103560;y++)L[y]=0;for(y=103571;y<=103573;y++)L[y]=0;for(y=103574;y<=103576;y++)L[y]=2;for(y=103577;y<=103580;y++)L[y]=0;for(y=103581;y<=103583;y++)L[y]=2;for(y=103595;y<=103694;y++)L[y]=0;for(y=103696;y<=103699;y++)L[y]=0;for(y=103700;y<=103793;y++)L[y]=2;for(y=103794;y<=103890;y++)L[y]=0;for(y=103891;y<=103896;y++)L[y]=2;for(y=103900;y<=103971;y++)L[y]=2;for(y=103972;y<=103977;y++)L[y]=0;for(y=112e3;y<=112101;y++)L[y]=0;const zVe={102113:!0,102100:!0,3857:!0,3785:!0},BVe={4326:!0,3785:!0,3857:!0,102113:!0,102100:!0,104905:!0,104971:!0},cne='PROJCS["WGS_1984_Web_Mercator_Auxiliary_Sphere",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator_Auxiliary_Sphere"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],PARAMETER["Auxiliary_Sphere_Type",0.0],UNIT["Meter",1.0]]',nL=[-20037508342788905e-9,20037508342788905e-9],oL=[-20037508342787e-6,20037508342787e-6],w1e={102113:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:nL,origin:oL,dx:1e-5},102100:{wkTemplate:cne,valid:nL,origin:oL,dx:1e-5},3785:{wkTemplate:'PROJCS["WGS_1984_Web_Mercator",GEOGCS["GCS_WGS_1984_Major_Auxiliary_Sphere",DATUM["D_WGS_1984_Major_Auxiliary_Sphere",SPHEROID["WGS_1984_Major_Auxiliary_Sphere",6378137.0,0.0]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Mercator"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],PARAMETER["Standard_Parallel_1",0.0],UNIT["Meter",1.0]]',valid:nL,origin:oL,dx:1e-5},3857:{wkTemplate:cne,valid:nL,origin:oL,dx:1e-5},4326:{wkTemplate:'GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",{Central_Meridian}],UNIT["Degree",0.0174532925199433]]',altTemplate:'PROJCS["WGS_1984_Plate_Carree",GEOGCS["GCS_WGS_1984",DATUM["D_WGS_1984",SPHEROID["WGS_1984",6378137.0,298.257223563]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]],PROJECTION["Plate_Carree"],PARAMETER["False_Easting",0.0],PARAMETER["False_Northing",0.0],PARAMETER["Central_Meridian",{Central_Meridian}],UNIT["Degrees",111319.491]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104971:{wkTemplate:'GEOGCS["Mars_2000_(Sphere)",DATUM["Mars_2000_(Sphere)",SPHEROID["Mars_2000_(Sphere)",3396190.0,0.0]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5},104905:{wkTemplate:'GEOGCS["GCS_Mars_2000",DATUM["D_Mars_2000",SPHEROID["Mars_2000_IAU_IAG",3396190.0,169.8944472236118]],PRIMEM["Reference_Meridian",0.0],UNIT["Degree",0.0174532925199433]]',valid:[-180,180],origin:[-180,90],dx:1e-5}};function Bn(t,e){return t===e||t!=null&&e!=null&&(t.wkid!=null||e.wkid!=null?t.wkid===e.wkid||xT(t)&&xT(e)||e.latestWkid!=null&&t.wkid===e.latestWkid||t.latestWkid!=null&&e.wkid===t.latestWkid:!(!t.wkt||!e.wkt)&&t.wkt.toUpperCase()===e.wkt.toUpperCase())}function T1(t){return Qa(t)&&t.wkid&&w1e[t.wkid]||null}function fQ(t){return!!Qa(t)&&(t.wkid?L[t.wkid]==null:!!t.wkt&&!!/^\s*GEOGCS/i.test(t.wkt))}function NI(t){return!(Pg(t)||$g(t))}function FI(t){return Qa(t)&&t.wkid===4326}function x1e(t){return Qa(t)&&t.wkid===Ad.CGCS2000}function xT(t){return Qa(t)&&t.wkid!=null&&zVe[t.wkid]===!0}function kI(t){return Qa(t)&&t.wkid===32662}function mQ(t){return t===Ad.GCSMARS2000||t===Ad.GCSMARS2000_SPHERE}function Pg(t){return Qa(t)&&t.wkid!=null&&mQ(t.wkid)}function gQ(t){return t===Ad.GCSMOON2000}function $g(t){return Qa(t)&&t.wkid!=null&&gQ(t.wkid)}function GVe(t){return Qa(t)&&t.wkid!=null&&BVe[t.wkid]===!0}function Qa(t){return t!=null&&(t.wkid!=null&&t.wkid>=2e3||t.wkt!=null)}const jVe={wkid:4326,wkt:fg(w1e[4326].wkTemplate,{Central_Meridian:"0.0"})},HVe={wkid:102100,latestWkid:3857},qVe={wkid:32662};function yQ(t){return{wkt:`GEOCCS["Spherical geocentric",
    DATUM["Not specified",
      SPHEROID["Sphere",${t.radius},0]],
    PRIMEM["Greenwich",0.0,
      AUTHORITY["EPSG","8901"]],
    UNIT["m",1.0],
    AXIS["Geocentric X",OTHER],
    AXIS["Geocentric Y",EAST],
    AXIS["Geocentric Z",NORTH]
  ]`}}const T1e=yQ(ur),_Q=yQ(ig),vQ=yQ(E0),S1e={wkt:`GEOCCS["WGS 84",
  DATUM["WGS_1984",
    SPHEROID["WGS 84",${ur.radius},298.257223563,
      AUTHORITY["EPSG","7030"]],
    AUTHORITY["EPSG","6326"]],
  PRIMEM["Greenwich",0,
    AUTHORITY["EPSG","8901"]],
  UNIT["m",1.0,
    AUTHORITY["EPSG","9001"]],
  AXIS["Geocentric X",OTHER],
  AXIS["Geocentric Y",OTHER],
  AXIS["Geocentric Z",NORTH],
  AUTHORITY["EPSG","4978"]
]`};function Ir(t){return t!=null&&(Pg(t)||Bn(t,_Q))?ig:t!=null&&($g(t)||Bn(t,vQ))?E0:ur}function xNt(t){return mQ(t)?ig:gQ(t)?E0:ur}const bQ=39.37,WVe=ur.radius*Math.PI/200,E1e=/UNIT\[([^\]]+)\]\]$/i,Qx=L,C1e=/UNIT\[([^\]]+)\]/i,ZVe=new Set([4261,4305,4807,4810,4811,4812,4816,4819,4821,4901,4902,37225,104139,104140]),XVe=zl()({meter:"meters",foot:"feet",foot_us:"us-feet",foot_clarke:"clarke-feet",yard_clarke:"clarke-yards",link_clarke:"clarke-links",yard_sears:"sears-yards",foot_sears:"sears-feet",chain_sears:"sears-chains",chain_benoit_1895_b:"benoit-1895-b-chains",yard_indian:"indian-yards",yard_indian_1937:"indian-1937-yards",foot_gold_coast:"gold-coast-feet",chain_sears_1922_truncated:"sears-1922-truncated-chains","50_kilometers":"50-kilometers","150_kilometers":"150-kilometers"}),Wf=t=>t*t,o_=t=>t*t*t,UI={length:{baseUnit:"meters",units:{millimeters:{inBaseUnits:.001},centimeters:{inBaseUnits:.01},decimeters:{inBaseUnits:.1},meters:{inBaseUnits:1},kilometers:{inBaseUnits:1e3},inches:{inBaseUnits:.0254},feet:{inBaseUnits:.3048},yards:{inBaseUnits:.9144},miles:{inBaseUnits:1609.344},"nautical-miles":{inBaseUnits:1852},"us-feet":{inBaseUnits:1200/3937}}},area:{baseUnit:"square-meters",units:{"square-millimeters":{inBaseUnits:Wf(.001)},"square-centimeters":{inBaseUnits:Wf(.01)},"square-decimeters":{inBaseUnits:Wf(.1)},"square-meters":{inBaseUnits:1},"square-kilometers":{inBaseUnits:Wf(1e3)},"square-inches":{inBaseUnits:Wf(.0254)},"square-feet":{inBaseUnits:Wf(.3048)},"square-yards":{inBaseUnits:Wf(.9144)},"square-miles":{inBaseUnits:Wf(1609.344)},"square-us-feet":{inBaseUnits:Wf(1200/3937)},acres:{inBaseUnits:.0015625*Wf(1609.344)},ares:{inBaseUnits:100},hectares:{inBaseUnits:1e4}}},volume:{baseUnit:"liters",units:{liters:{inBaseUnits:1},"cubic-millimeters":{inBaseUnits:1e3*o_(.001)},"cubic-centimeters":{inBaseUnits:1e3*o_(.01)},"cubic-decimeters":{inBaseUnits:1e3*o_(.1)},"cubic-meters":{inBaseUnits:1e3},"cubic-kilometers":{inBaseUnits:1e3*o_(1e3)},"cubic-inches":{inBaseUnits:1e3*o_(.0254)},"cubic-feet":{inBaseUnits:1e3*o_(.3048)},"cubic-yards":{inBaseUnits:1e3*o_(.9144)},"cubic-miles":{inBaseUnits:1e3*o_(1609.344)}}},angle:{baseUnit:"radians",units:{radians:{inBaseUnits:1},degrees:{inBaseUnits:Math.PI/180}}}},YVe=(()=>{const t={};for(const e in UI)for(const r in UI[e].units)t[r]=e;return t})();function JVe(t,e,r){return t*UI[r].units[e].inBaseUnits}function QVe(t,e,r){return t/UI[r].units[e].inBaseUnits}const A1e=["metric","imperial","inches","feet","yards","miles","nautical-miles","us-feet","meters","kilometers"],KVe=new Map([["meters","square-meters"],["feet","square-feet"],["us-feet","square-us-feet"]]);function u7(t){const e=YVe[t];if(!e)throw new Error("unknown type");return e}function une(t,e=null){return e=e||u7(t),UI[e].baseUnit===t}function Ci(t,e,r){if(e===r)return t;const i=u7(e);if(i!==u7(r))throw new Error("incompatible units");const s=une(e,i)?t:JVe(t,e,i);return une(r,i)?s:QVe(s,r,i)}function TNt(t,e,r){switch(r){case"metric":return wQ(t,e);case"imperial":return TQ(t,e);default:return r}}function SNt(t,e,r){switch(r){case"metric":return xQ(t,e);case"imperial":return SQ(t,e);default:return r}}function wQ(t,e){const r=Ci(t,e,"meters");return Math.abs(r)<3e3?"meters":"kilometers"}function xQ(t,e){const r=Ci(t,e,"meters");return Math.abs(r)<1e5?"meters":"kilometers"}function TQ(t,e){const r=Ci(t,e,"feet");return Math.abs(r)<1e3?"feet":"miles"}function SQ(t,e){const r=Ci(t,e,"feet");return Math.abs(r)<1e5?"feet":"miles"}function e8e(t,e){const r=Ci(t,e,"square-meters");return Math.abs(r)<3e6?"square-meters":"square-kilometers"}function t8e(t,e){const r=Ci(t,e,"square-feet");return Math.abs(r)<1e6?"square-feet":"square-miles"}function O1e(t,e,r){return Ci(t,e,"meters")/(r*Math.PI/180)}function R1e(t){return XVe.fromJSON(t.toLowerCase())||null}function VI(t){if(t!=null&&!NI(t))return 1;const e=Uo(t);return e>1e5?1:e}function M1e(t){return Uo(t)>=Ir(t).metersPerDegree?"meters":WP(t)}function Uo(t,e=ur.metersPerDegree){return r8e(t,!0)??e}function r8e(t,e=!1){const r=t!=null?t.wkid:null,i=t!=null?t.wkt:null;let s=null;if(r){if(mQ(r))return ig.metersPerDegree;if(gQ(r))return E0.metersPerDegree;s=Qx.values[Qx[r]],!s&&e&&ZVe.has(r)&&(s=WVe)}else i&&($1e(i)?s=dne(E1e.exec(i),s):P1e(i)&&(s=dne(C1e.exec(i),s)));return s}function hne(t){return t.isGeographic?1:Uo(t)}function dne(t,e){return t&&t[1]?I1e(t[1]):e}function I1e(t){return parseFloat(t.split(",")[1])}function WP(t){const e=t!=null?t.wkid:null,r=t!=null?t.wkt:null;let i=null;if(e)i=Qx.units[Qx[e]];else if(r){const s=$1e(r)?E1e:P1e(r)?C1e:null;if(s){const n=s.exec(r);n&&n[1]&&(i=s8e(n[1]))}}return i!=null?R1e(i):null}function ENt(t){const e=WP(t);return e!=null&&A1e.includes(e)?e:null}function CNt(t){const e=M1e(t);return e!=null&&A1e.includes(e)?e:null}function ANt(t){const e=WP(t);return e==null?null:KVe.get(e)}function P1e(t){return/^GEOCCS/i.test(t)}function $1e(t){return/^PROJCS/i.test(t)}const i8e=1e-7;function s8e(t){const e=/[\\"\\']{1}([^\\"\\']+)/.exec(t);let r=e&&e[1];if(!r||!Qx.units.includes(r)){const i=I1e(t);r=null;const s=Qx.values;for(let n=0;n<s.length;++n)if(Math.abs(i-s[n])<i8e){r=Qx.units[n];break}}return r}function ONt(t){const e=WP(t);if(e==null)return null;switch(e){case"feet":case"us-feet":case"clarke-feet":case"clarke-yards":case"clarke-links":case"sears-yards":case"sears-feet":case"sears-chains":case"benoit-1895-b-chains":case"indian-yards":case"indian-1937-yards":case"gold-coast-feet":case"sears-1922-truncated-chains":return"imperial";case"50-kilometers":case"150-kilometers":case"meters":return"metric"}return null}const n8e={esriAcres:"acres",esriAres:"ares",esriHectares:"hectares",esriSquareCentimeters:"square-centimeters",esriSquareDecimeters:"square-decimeters",esriSquareFeet:"square-feet",esriSquareInches:"square-inches",esriSquareKilometers:"square-kilometers",esriSquareMeters:"square-meters",esriSquareMiles:"square-miles",esriSquareMillimeters:"square-millimeters",esriSquareUsFeet:"square-us-feet",esriSquareYards:"square-yards"},o8e={esriCentimeters:"centimeters",esriDecimeters:"decimeters",esriFeet:"feet",esriInches:"inches",esriKilometers:"kilometers",esriMeters:"meters",esriMiles:"miles",esriMillimeters:"millimeters",esriNauticalMiles:"nautical-miles",esriYards:"yards"},a8e={esriDUDecimalDegrees:"degrees",esriDURadians:"radians"},l8e=zl()(n8e),c8e=zl()(o8e),RNt=zl()(a8e);function Ve(t,e,r){let i,s;return e===void 0?(s=t,i=[void 0]):typeof e!="string"?(s=t,i=[void 0],r=e):(s=e,i=Array.isArray(t)?t:[t]),(n,o)=>{const a=n.constructor.prototype;for(const l of i){const c=aQ(n,l,s);c.write&&typeof c.write=="object"||(c.write={}),r&&(c.write.target=r),c.write.writer=a[o]}}}var mm;let ki=mm=class extends he{static fromJSON(t){if(!t)return null;if(t.wkid){if(t.wkid===102100)return mm.WebMercator;if(t.wkid===4326)return mm.WGS84}const e=new mm;return e.read(t),e}constructor(t){super(t),this.latestWkid=null,this.wkid=null,this.wkt=null,this.vcsWkid=null,this.latestVcsWkid=null,this.imageCoordinateSystem=null}normalizeCtorArgs(t){return t&&typeof t=="object"?t:{[typeof t=="string"?"wkt":"wkid"]:t}}get isWGS84(){return FI(this)}get isWebMercator(){return xT(this)}get isGeographic(){return fQ(this)}get isWrappable(){return GVe(this)}get metersPerUnit(){return Uo(this)}get unit(){return WP(this)||(this.isGeographic?"degrees":null)}writeWkt(t,e){this.wkid||(e.wkt=t)}clone(){if(this===mm.WGS84)return mm.WGS84;if(this===mm.WebMercator)return mm.WebMercator;const t=new mm;return this.wkid!=null?(t.wkid=this.wkid,this.latestWkid!=null&&(t.latestWkid=this.latestWkid),this.vcsWkid!=null&&(t.vcsWkid=this.vcsWkid),this.latestVcsWkid!=null&&(t.latestVcsWkid=this.latestVcsWkid)):this.wkt!=null&&(t.wkt=this.wkt),this.imageCoordinateSystem&&(t.imageCoordinateSystem=re(this.imageCoordinateSystem)),t}equals(t){if(t==null)return!1;if(this.imageCoordinateSystem||t.imageCoordinateSystem){if(this.imageCoordinateSystem==null||t.imageCoordinateSystem==null)return!1;const{id:e,referenceServiceName:r}=t.imageCoordinateSystem,{geodataXform:i}=t.imageCoordinateSystem,s=this.imageCoordinateSystem;return e==null||i?JSON.stringify(s)===JSON.stringify(t.imageCoordinateSystem):r?s.id===e&&s.referenceServiceName===r:s.id===e}return Bn(this,t)}toJSON(t){return this.write(void 0,t)}};ki.GCS_NAD_1927=null,ki.WGS84=null,ki.WebMercator=null,ki.PlateCarree=null,u([d({readOnly:!0})],ki.prototype,"isWGS84",null),u([d({readOnly:!0})],ki.prototype,"isWebMercator",null),u([d({readOnly:!0})],ki.prototype,"isGeographic",null),u([d({readOnly:!0})],ki.prototype,"isWrappable",null),u([d({type:Ki,json:{write:!0}})],ki.prototype,"latestWkid",void 0),u([d({readOnly:!0})],ki.prototype,"metersPerUnit",null),u([d({readOnly:!0})],ki.prototype,"unit",null),u([d({type:Ki,json:{write:!0,origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkt==null}}}}}}})],ki.prototype,"wkid",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{overridePolicy(){return{isRequired:this.wkid==null}}}}}}})],ki.prototype,"wkt",void 0),u([Ve("wkt"),Ve("web-scene","wkt")],ki.prototype,"writeWkt",null),u([d({type:Ki,json:{write:!0}})],ki.prototype,"vcsWkid",void 0),u([d({type:Ki,json:{write:!0}})],ki.prototype,"latestVcsWkid",void 0),u([d()],ki.prototype,"imageCoordinateSystem",void 0),ki=mm=u([R("esri.geometry.SpatialReference")],ki),ki.prototype.toJSON.isDefaultToJSON=!0,ki.GCS_NAD_1927=new ki({wkid:4267,wkt:'GEOGCS["GCS_North_American_1927",DATUM["D_North_American_1927",SPHEROID["Clarke_1866",6378206.4,294.9786982]],PRIMEM["Greenwich",0.0],UNIT["Degree",0.0174532925199433]]'}),ki.WGS84=new ki(jVe),ki.WebMercator=new ki(HVe),ki.PlateCarree=new ki(qVe),Object.freeze&&(Object.freeze(ki.GCS_NAD_1927),Object.freeze(ki.WGS84),Object.freeze(ki.WebMercator));const qe=ki;let gm=class extends he{constructor(...e){super(...e),this.type=null,this.hasM=!1,this.hasZ=!1,this.spatialReference=qe.WGS84}get cache(){return this.commitProperty("spatialReference"),{}}get extent(){return null}readSpatialReference(e,r){if(e instanceof qe)return e;if(e!=null){const i=new qe;return i.read(e,r),i}return e}clone(){return console.warn(".clone() is not implemented for "+this.declaredClass),null}clearCache(){this.notifyChange("cache")}getCacheValue(e){return this.cache[e]}setCacheValue(e,r){this.cache[e]=r}};u([d()],gm.prototype,"type",void 0),u([d({readOnly:!0})],gm.prototype,"cache",null),u([d({readOnly:!0})],gm.prototype,"extent",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],gm.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],gm.prototype,"hasZ",void 0),u([d({type:qe,json:{write:!0},value:qe.WGS84})],gm.prototype,"spatialReference",void 0),u([Ae("spatialReference")],gm.prototype,"readSpatialReference",null),gm=u([R("esri.geometry.Geometry")],gm);const ob=gm;function u8e(t,e){const r=t.x-e.x,i=t.y-e.y,s=t.hasZ&&e.hasZ?t.z-e.z:0;return Math.sqrt(r*r+i*i+s*s)}const h8e=57.29577951308232,d8e=.017453292519943;function pne(t){return t*h8e}function fne(t){return t*d8e}function mne(t){return t/ur.radius}function K5(t){return Math.PI/2-2*Math.atan(Math.exp(-t/ur.radius))}function h7(t){return t.wkid!=null||t.wkt!=null}const v9=[0,0];function ek(t,e,r,i,s){const n=t,o=s;if(o.spatialReference=r,"x"in n&&"x"in o)[o.x,o.y]=e(n.x,n.y,v9,i);else if("xmin"in n&&"xmin"in o)[o.xmin,o.ymin]=e(n.xmin,n.ymin,v9,i),[o.xmax,o.ymax]=e(n.xmax,n.ymax,v9,i);else if("paths"in n&&"paths"in o||"rings"in n&&"rings"in o){const a="paths"in n?n.paths:n.rings,l=[];let c;for(let h=0;h<a.length;h++){const p=a[h];c=[],l.push(c);for(let f=0;f<p.length;f++)c.push(e(p[f][0],p[f][1],[0,0],i)),p[f].length>2&&c[f].push(p[f][2]),p[f].length>3&&c[f].push(p[f][3])}"paths"in o?o.paths=l:o.rings=l}else if("points"in n&&"points"in o){const a=n.points,l=[];for(let c=0;c<a.length;c++)l[c]=e(a[c][0],a[c][1],[0,0],i),a[c].length>2&&l[c].push(a[c][2]),a[c].length>3&&l[c].push(a[c][3]);o.points=l}return s}function S1(t,e){const r=t&&(h7(t)?t:t.spatialReference),i=e&&(h7(e)?e:e.spatialReference);return!(t&&"type"in t&&t.type==="mesh"||e&&"type"in e&&e.type==="mesh"||!r||!i)&&(!!Bn(i,r)||xT(i)&&FI(r)||xT(r)&&FI(i))}function sS(t,e){if(t==null)return null;const r=t.spatialReference,i=e&&(h7(e)?e:e.spatialReference);return S1(r,i)?Bn(r,i)?re(t):xT(i)?ek(t,GE,qe.WebMercator,!1,re(t)):FI(i)?ek(t,UM,qe.WGS84,!1,re(t)):null:null}function GE(t,e,r=[0,0]){e>89.99999?e=89.99999:e<-89.99999&&(e=-89.99999);const i=fne(e);return r[0]=fne(t)*ur.radius,r[1]=ur.halfSemiMajorAxis*Math.log((1+Math.sin(i))/(1-Math.sin(i))),r}function UM(t,e,r=[0,0],i=!1){const s=pne(t/ur.radius);return r[0]=i?s:s-360*Math.floor((s+180)/360),r[1]=pne(Math.PI/2-2*Math.atan(Math.exp(-e/ur.radius))),r}function bC(t,e=!1,r=re(t)){return ek(t,GE,qe.WebMercator,e,r)}function jE(t,e=!1,r=re(t)){return ek(t,UM,qe.WGS84,e,r)}var CF;const GO=[0,0];function gne(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let Kl=CF=class extends ob{static copy(t,e){e._set("x",t._get("x")),e._set("y",t._get("y")),e._set("z",t._get("z")),e._set("m",t._get("m"));const r=t._get("spatialReference");e._set("spatialReference",Object.isFrozen(r)?r:r.clone())}constructor(...t){super(...t),this.x=0,this.y=0,this.z=void 0,this.m=void 0,this.type="point"}normalizeCtorArgs(t,e,r,i,s){let n;if(Array.isArray(t))n=t,s=e,t=n[0],e=n[1],r=n[2],i=n[3];else if(t&&typeof t=="object"){if(n=t,t=n.x!=null?n.x:n.longitude,e=n.y!=null?n.y:n.latitude,r=n.z,i=n.m,(s=n.spatialReference)&&s.declaredClass!=="esri.geometry.SpatialReference"&&(s=new qe(s)),n.longitude!=null||n.latitude!=null){if(n.longitude==null)K.getLogger(this).warn(".longitude=","Latitude was defined without longitude");else if(n.latitude==null)K.getLogger(this).warn(".latitude=","Longitude was defined without latitude");else if(!n.declaredClass&&s&&s.isWebMercator){const a=GE(n.longitude,n.latitude,GO);t=a[0],e=a[1]}}}else gne(r)?(s=r,r=null):gne(i)&&(s=i,i=null);const o={x:t,y:e};return o.x==null&&o.y!=null?K.getLogger(this).warn(".y=","Y coordinate was defined without an X coordinate"):o.y==null&&o.x!=null&&K.getLogger(this).warn(".x=","X coordinate was defined without a Y coordinate"),s!=null&&(o.spatialReference=s),r!=null&&(o.z=r),i!=null&&(o.m=i),o}get cache(){return this.commitProperty("x"),this.commitProperty("y"),this.commitProperty("z"),this.commitProperty("m"),this.commitProperty("spatialReference"),{}}get hasM(){return this.m!==void 0}set hasM(t){t!==(this._get("m")!==void 0)&&(this._set("m",t?0:void 0),this._set("hasM",t))}get hasZ(){return this.z!==void 0}set hasZ(t){t!==(this._get("z")!==void 0)&&(this._set("z",t?0:void 0),this._set("hasZ",t))}get latitude(){const{spatialReference:t,x:e,y:r}=this;if(t){if(t.isWebMercator)return UM(e,r,GO)[1];if(t.isGeographic)return r}return null}set latitude(t){const{spatialReference:e,x:r}=this;t!=null&&e&&(e.isWebMercator?this._set("y",GE(r,t,GO)[1]):e.isGeographic&&this._set("y",t),this._set("latitude",t))}get longitude(){const{x:t,y:e,spatialReference:r}=this;if(r){if(r.isWebMercator)return UM(t,e,GO)[0];if(r.isGeographic)return t}return null}set longitude(t){const{y:e,spatialReference:r}=this;t!=null&&r&&(r.isWebMercator?this._set("x",GE(t,e,GO)[0]):r.isGeographic&&this._set("x",t),this._set("longitude",t))}writeX(t,e,r){e[r]=isNaN(t)?"NaN":t}readX(t){return typeof t=="string"?NaN:t}clone(){const t=new CF;return t.x=this.x,t.y=this.y,t.z=this.z,t.m=this.m,t.spatialReference=this.spatialReference,t}copy(t){return CF.copy(t,this),this}equals(t){if(t==null)return!1;const{x:e,y:r,z:i,m:s,spatialReference:n}=this,{z:o,m:a}=t;let{x:l,y:c,spatialReference:h}=t;if(!n.equals(h))if(n.isWebMercator&&h.isWGS84)[l,c]=GE(l,c),h=n;else{if(!n.isWGS84||!h.isWebMercator)return!1;[l,c]=UM(l,c),h=n}return e===l&&r===c&&i===o&&s===a&&n.wkid===h.wkid}offset(t,e,r){return this.x+=t,this.y+=e,r!=null&&(this.z=(this.z??0)+r),this}normalize(){if(!this.spatialReference)return this;const t=T1(this.spatialReference);if(!t)return this;let e=this.x;const[r,i]=t.valid,s=2*i;let n;return e>i?(n=Math.ceil(Math.abs(e-i)/s),e-=n*s):e<r&&(n=Math.ceil(Math.abs(e-r)/s),e+=n*s),this._set("x",e),this}distance(t){return u8e(this,t)}toArray(){const t=this.hasZ,e=this.hasM;return t&&e?[this.x,this.y,this.z,this.m]:t?[this.x,this.y,this.z]:e?[this.x,this.y,this.m]:[this.x,this.y]}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],Kl.prototype,"cache",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Kl.prototype,"hasM",null),u([d({type:Boolean,json:{read:!1,write:{enabled:!1,overridePolicy:null}}})],Kl.prototype,"hasZ",null),u([d({type:Number})],Kl.prototype,"latitude",null),u([d({type:Number})],Kl.prototype,"longitude",null),u([d({type:Number,json:{type:[Number,String],write:{isRequired:!0,allowNull:!0}}}),or(t=>isNaN(t)?t:wd(t))],Kl.prototype,"x",void 0),u([Ve("x")],Kl.prototype,"writeX",null),u([Ae("x")],Kl.prototype,"readX",null),u([d({type:Number,json:{write:!0}})],Kl.prototype,"y",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Kl.prototype,"z",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.hasM}}}}})],Kl.prototype,"m",void 0),Kl=CF=u([R("esri.geometry.Point")],Kl),Kl.prototype.toJSON.isDefaultToJSON=!0;const ht=Kl,b9=[0,0];function EQ(t,e){return e!=null&&Cl(t,e.x,e.y,e.z)}function INt(t,e){if(!e.points||e.points.length)return!1;for(const r of e.points)if(!KC(t,r))return!1;return!0}function p8e(t,e){const{xmin:r,ymin:i,zmin:s,xmax:n,ymax:o,zmax:a}=e;return t.hasZ&&e.hasZ?Cl(t,r,i,s)&&Cl(t,r,o,s)&&Cl(t,n,o,s)&&Cl(t,n,i,s)&&Cl(t,r,i,a)&&Cl(t,r,o,a)&&Cl(t,n,o,a)&&Cl(t,n,i,a):Cl(t,r,i)&&Cl(t,r,o)&&Cl(t,n,o)&&Cl(t,n,i)}function KC(t,e){return Cl(t,e[0],e[1])}function f8e(t,e){return Cl(t,e[0],e[1],e[2])}function Cl(t,e,r,i){return e>=t.xmin&&e<=t.xmax&&r>=t.ymin&&r<=t.ymax&&(i==null||!t.hasZ||i>=t.zmin&&i<=t.zmax)}function m8e(t,e){return b9[1]=e.y,b9[0]=e.x,g8e(t,b9)}function g8e(t,e){return L1e(t.rings,e)}function L1e(t,e){if(!t)return!1;if(y8e(t))return yne(!1,t,e);let r=!1;for(let i=0,s=t.length;i<s;i++)r=yne(r,t[i],e);return r}function y8e(t){return!Array.isArray(t[0][0])}function yne(t,e,r){const[i,s]=r;let n=t,o=0;for(let a=0,l=e.length;a<l;a++){o++,o===l&&(o=0);const[c,h]=e[a],[p,f]=e[o];(h<s&&f>=s||f<s&&h>=s)&&c+(s-h)/(f-h)*(p-c)<i&&(n=!n)}return n}function _8e(t,e){return EQ(t,e)}function v8e(t,e){const r=t.hasZ&&e.hasZ;let i,s,n;if(t.xmin<=e.xmin){if(i=e.xmin,t.xmax<i)return!1}else if(i=t.xmin,e.xmax<i)return!1;if(t.ymin<=e.ymin){if(s=e.ymin,t.ymax<s)return!1}else if(s=t.ymin,e.ymax<s)return!1;if(r&&e.hasZ){if(t.zmin<=e.zmin){if(n=e.zmin,t.zmax<n)return!1}else if(n=t.zmin,e.zmax<n)return!1}return!0}function b8e(t,e){const{points:r,hasZ:i}=e,s=i?f8e:KC;for(const n of r)if(s(t,n))return!0;return!1}const TT=[0,0],ST=[0,0],ET=[0,0],CT=[0,0],w8e=[TT,ST,ET,CT],D1e=[[ET,TT],[TT,ST],[ST,CT],[CT,ET]];function x8e(t,e){return T8e(t,e.rings)}function T8e(t,e){TT[0]=t.xmin,TT[1]=t.ymax,ST[0]=t.xmax,ST[1]=t.ymax,ET[0]=t.xmin,ET[1]=t.ymin,CT[0]=t.xmax,CT[1]=t.ymin;for(const r of w8e)if(L1e(e,r))return!0;for(const r of e){if(!r.length)continue;let i=r[0];if(KC(t,i))return!0;for(let s=1;s<r.length;s++){const n=r[s];if(KC(t,n)||N1e(i,n,D1e))return!0;i=n}}return!1}function S8e(t,e){TT[0]=t.xmin,TT[1]=t.ymax,ST[0]=t.xmax,ST[1]=t.ymax,ET[0]=t.xmin,ET[1]=t.ymin,CT[0]=t.xmax,CT[1]=t.ymin;const r=e.paths;for(const i of r){if(!r.length)continue;let s=i[0];if(KC(t,s))return!0;for(let n=1;n<i.length;n++){const o=i[n];if(KC(t,o)||N1e(s,o,D1e))return!0;s=o}}return!1}const da=[0,0];function E8e(t){for(let e=0;e<t.length;e++){const r=t[e];for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let a=e+1;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){const c=t[a][l],h=t[a][l+1];if(zI(n,o,c,h,da)&&!(da[0]===n[0]&&da[1]===n[1]||da[0]===c[0]&&da[1]===c[1]||da[0]===o[0]&&da[1]===o[1]||da[0]===h[0]&&da[1]===h[1]))return!0}}const i=r.length;if(!(i<=4))for(let s=0;s<i-3;s++){let n=i-1;s===0&&(n=i-2);const o=r[s],a=r[s+1];for(let l=s+2;l<n;l++){const c=r[l],h=r[l+1];if(zI(o,a,c,h,da)&&!(da[0]===o[0]&&da[1]===o[1]||da[0]===c[0]&&da[1]===c[1]||da[0]===a[0]&&da[1]===a[1]||da[0]===h[0]&&da[1]===h[1]))return!0}}}return!1}function N1e(t,e,r){for(let i=0;i<r.length;i++)if(zI(t,e,r[i][0],r[i][1]))return!0;return!1}function zI(t,e,r,i,s){const[n,o]=t,[a,l]=e,[c,h]=r,[p,f]=i,m=p-c,g=n-c,_=a-n,v=f-h,b=o-h,x=l-o,T=v*_-m*x;if(T===0)return!1;const S=(m*b-v*g)/T,O=(_*b-x*g)/T;return S>=0&&S<=1&&O>=0&&O<=1&&(s&&(s[0]=n+S*(a-n),s[1]=o+S*(l-o)),!0)}function C8e(t){switch(t){case"esriGeometryEnvelope":case"extent":return v8e;case"esriGeometryMultipoint":case"multipoint":return b8e;case"esriGeometryPoint":case"point":return _8e;case"esriGeometryPolygon":case"polygon":return x8e;case"esriGeometryPolyline":case"polyline":return S8e}}var jh;function A8e(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}function a_(t,e,r){return e==null?r:r==null?e:t(e,r)}let Ho=jh=class extends ob{constructor(...t){super(...t),this.type="extent",this.xmin=0,this.ymin=0,this.mmin=void 0,this.zmin=void 0,this.xmax=0,this.ymax=0,this.mmax=void 0,this.zmax=void 0}normalizeCtorArgs(t,e,r,i,s){return A8e(t)?{spatialReference:t,xmin:0,ymin:0,xmax:0,ymax:0}:typeof t=="object"?(t.spatialReference=t.spatialReference==null?qe.WGS84:t.spatialReference,t):{xmin:t,ymin:e,xmax:r,ymax:i,spatialReference:s??qe.WGS84}}static fromBounds(t,e){return new jh({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}static fromPoint(t){return new jh({xmin:t.x,ymin:t.y,zmin:t.z,xmax:t.x,ymax:t.y,zmax:t.z,spatialReference:t.spatialReference})}get cache(){return this.commitProperty("xmin"),this.commitProperty("ymin"),this.commitProperty("zmin"),this.commitProperty("mmin"),this.commitProperty("xmax"),this.commitProperty("ymax"),this.commitProperty("zmax"),this.commitProperty("mmax"),this.commitProperty("spatialReference"),{}}get center(){const t=new ht({x:.5*(this.xmin+this.xmax),y:.5*(this.ymin+this.ymax),spatialReference:this.spatialReference});return this.hasZ&&(t.z=.5*(this.zmin+this.zmax)),this.hasM&&(t.m=.5*(this.mmin+this.mmax)),t}get extent(){return this.clone()}get hasM(){return this.mmin!=null&&this.mmax!=null}get hasZ(){return this.zmin!=null&&this.zmax!=null}get height(){return Math.abs(this.ymax-this.ymin)}get width(){return Math.abs(this.xmax-this.xmin)}centerAt(t){const e=this.center;return t.z!=null&&this.hasZ?this.offset(t.x-e.x,t.y-e.y,t.z-e.z):this.offset(t.x-e.x,t.y-e.y)}clone(){const t=new jh;return t.xmin=this.xmin,t.ymin=this.ymin,t.xmax=this.xmax,t.ymax=this.ymax,t.spatialReference=this.spatialReference,this.zmin!=null&&(t.zmin=this.zmin,t.zmax=this.zmax),this.mmin!=null&&(t.mmin=this.mmin,t.mmax=this.mmax),t}contains(t){if(!t)return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&S1(e,r)&&(t=e.isWebMercator?bC(t):jE(t,!0)),t.type==="point"?EQ(this,t):t.type==="extent"&&p8e(this,t)}equals(t){if(this===t)return!0;if(t==null)return!1;const e=this.spatialReference,r=t.spatialReference;return e&&r&&!e.equals(r)&&S1(e,r)&&(t=e.isWebMercator?bC(t):jE(t,!0)),this.xmin===t.xmin&&this.ymin===t.ymin&&this.zmin===t.zmin&&this.mmin===t.mmin&&this.xmax===t.xmax&&this.ymax===t.ymax&&this.zmax===t.zmax&&this.mmax===t.mmax}expand(t){const e=.5*(1-t),r=this.width*e,i=this.height*e;if(this.xmin+=r,this.ymin+=i,this.xmax-=r,this.ymax-=i,this.hasZ){const s=(this.zmax-this.zmin)*e;this.zmin+=s,this.zmax-=s}if(this.hasM){const s=(this.mmax-this.mmin)*e;this.mmin+=s,this.mmax-=s}return this}intersects(t){if(t==null)return!1;t.type==="mesh"&&(t=t.extent);const e=this.spatialReference,r=t.spatialReference;return e&&r&&!Bn(e,r)&&S1(e,r)&&(t=e.isWebMercator?bC(t):jE(t,!0)),C8e(t.type)(this,t)}normalize(){const t=this._normalize(!1,!0);return Array.isArray(t)?t:[t]}offset(t,e,r){return this.xmin+=t,this.ymin+=e,this.xmax+=t,this.ymax+=e,r!=null&&(this.zmin+=r,this.zmax+=r),this}shiftCentralMeridian(){return this._normalize(!0)}union(t){return this===t||(this.xmin=Math.min(this.xmin,t.xmin),this.ymin=Math.min(this.ymin,t.ymin),this.xmax=Math.max(this.xmax,t.xmax),this.ymax=Math.max(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=a_(Math.min,this.zmin,t.zmin),this.zmax=a_(Math.max,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=a_(Math.min,this.mmin,t.mmin),this.mmax=a_(Math.max,this.mmax,t.mmax))),this}intersection(t){return this===t?this:t!=null&&this.intersects(t)?(this.xmin=Math.max(this.xmin,t.xmin),this.ymin=Math.max(this.ymin,t.ymin),this.xmax=Math.min(this.xmax,t.xmax),this.ymax=Math.min(this.ymax,t.ymax),(this.hasZ||t.hasZ)&&(this.zmin=a_(Math.max,this.zmin,t.zmin),this.zmax=a_(Math.min,this.zmax,t.zmax)),(this.hasM||t.hasM)&&(this.mmin=a_(Math.max,this.mmin,t.mmin),this.mmax=a_(Math.min,this.mmax,t.mmax)),this):null}toJSON(t){return this.write({},t)}_shiftCM(t=T1(this.spatialReference)){if(!t||!this.spatialReference)return this;const e=this.spatialReference,r=this._getCM(t);if(r){const i=e.isWebMercator?jE(r):r;this.xmin-=r.x,this.xmax-=r.x,e.isWebMercator||(i.x=this._normalizeX(i.x,t).x),this.spatialReference=new qe(fg((e.isWGS84?t.altTemplate:null)??t.wkTemplate,{Central_Meridian:i.x}))}return this}_getCM(t){let e=null;const[r,i]=t.valid,s=this.xmin,n=this.xmax;return s>=r&&s<=i&&n>=r&&n<=i||(e=this.center),e}_normalize(t,e,r){const i=this.spatialReference;if(!i)return this;const s=r??T1(i);if(s==null)return this;const n=this._getParts(s).map(l=>l.extent);if(n.length<2)return n[0]||this;if(n.length>2)return t?this._shiftCM(s):this.set({xmin:s.valid[0],xmax:s.valid[1]});if(t)return this._shiftCM(s);if(e)return n;let o=!0,a=!0;return n.forEach(l=>{l.hasZ||(o=!1),l.hasM||(a=!1)}),{rings:n.map(l=>{const c=[[l.xmin,l.ymin],[l.xmin,l.ymax],[l.xmax,l.ymax],[l.xmax,l.ymin],[l.xmin,l.ymin]];if(o){const h=(l.zmax-l.zmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}if(a){const h=(l.mmax-l.mmin)/2;for(let p=0;p<c.length;p++)c[p].push(h)}return c}),hasZ:o,hasM:a,spatialReference:i}}_getParts(t){let e=this.cache._parts;if(!e){e=[];const{ymin:s,ymax:n,spatialReference:o}=this,a=this.width,l=this.xmin,c=this.xmax;let h;t=t||T1(o);const[p,f]=t.valid;h=this._normalizeX(this.xmin,t);const m=h.x,g=h.frameId;h=this._normalizeX(this.xmax,t);const _=h.x,v=h.frameId,b=m===_&&a>0;if(a>2*f){const x=new jh(l<c?m:_,s,f,n,o),T=new jh(p,s,l<c?_:m,n,o),S=new jh(0,s,f,n,o),O=new jh(p,s,0,n,o),A=[],M=[];x.contains(S)&&A.push(g),x.contains(O)&&M.push(g),T.contains(S)&&A.push(v),T.contains(O)&&M.push(v);for(let P=g+1;P<v;P++)A.push(P),M.push(P);e.push({extent:x,frameIds:[g]},{extent:T,frameIds:[v]},{extent:S,frameIds:A},{extent:O,frameIds:M})}else m>_||b?e.push({extent:new jh(m,s,f,n,o),frameIds:[g]},{extent:new jh(p,s,_,n,o),frameIds:[v]}):e.push({extent:new jh(m,s,_,n,o),frameIds:[g]});this.cache._parts=e}const r=this.hasZ,i=this.hasM;if(r||i){const s={};r&&(s.zmin=this.zmin,s.zmax=this.zmax),i&&(s.mmin=this.mmin,s.mmax=this.mmax);for(let n=0;n<e.length;n++)e[n].extent.set(s)}return e}_normalizeX(t,e){const[r,i]=e.valid,s=2*i;let n,o=0;return t>i?(n=Math.ceil(Math.abs(t-i)/s),t-=n*s,o=n):t<r&&(n=Math.ceil(Math.abs(t-r)/s),t+=n*s,o=-n),{x:t,frameId:o}}};u([d({readOnly:!0})],Ho.prototype,"cache",null),u([d({readOnly:!0})],Ho.prototype,"center",null),u([d({readOnly:!0})],Ho.prototype,"extent",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],Ho.prototype,"hasM",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:null}}})],Ho.prototype,"hasZ",null),u([d({readOnly:!0})],Ho.prototype,"height",null),u([d({readOnly:!0})],Ho.prototype,"width",null),u([d({type:Number,json:{type:[Number,String],write:{enabled:!0,allowNull:!0}}})],Ho.prototype,"xmin",void 0),u([d({type:Number,json:{write:!0}})],Ho.prototype,"ymin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],Ho.prototype,"mmin",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Ho.prototype,"zmin",void 0),u([d({type:Number,json:{write:!0}})],Ho.prototype,"xmax",void 0),u([d({type:Number,json:{write:!0}})],Ho.prototype,"ymax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasM}}}}})],Ho.prototype,"mmax",void 0),u([d({type:Number,json:{origins:{"web-scene":{write:!1}},write:{overridePolicy(){return{enabled:this.hasZ}}}}})],Ho.prototype,"zmax",void 0),Ho=jh=u([R("esri.geometry.Extent")],Ho),Ho.prototype.toJSON.isDefaultToJSON=!0;const vr=Ho;function eA(t,e,r=!1){let{hasM:i,hasZ:s}=t;Array.isArray(e)?e.length!==4||i||s?e.length===3&&r&&!i?(s=!0,i=!1):e.length===3&&i&&s&&(i=!1,s=!1):(i=!0,s=!0):(s=!s&&e.hasZ&&(!i||e.hasM),i=!i&&e.hasM&&(!s||e.hasZ)),t.hasZ=s,t.hasM=i}var d7;function _ne(t){return(e,r)=>e==null?r:r==null?e:t(e,r)}function O8e(t){return t&&(t.declaredClass==="esri.geometry.SpatialReference"||t.wkid!=null)}let G_=d7=class extends ob{constructor(...t){super(...t),this.points=[],this.type="multipoint"}normalizeCtorArgs(t,e){if(!t&&!e)return{};const r={};Array.isArray(t)?(r.points=t,r.spatialReference=e):O8e(t)?r.spatialReference=t:(t.points&&(r.points=t.points),t.spatialReference&&(r.spatialReference=t.spatialReference),t.hasZ&&(r.hasZ=t.hasZ),t.hasM&&(r.hasM=t.hasM));const i=r.points&&r.points[0];return i&&(r.hasZ===void 0&&r.hasM===void 0?(r.hasZ=i.length>2,r.hasM=!1):r.hasZ===void 0?r.hasZ=i.length>3:r.hasM===void 0&&(r.hasM=i.length>3)),r}get cache(){return this.commitProperty("points"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const t=this.points;if(!t.length)return null;const e=new vr,r=this.hasZ,i=this.hasM,s=r?3:2,n=t[0],o=_ne(Math.min),a=_ne(Math.max);let l,c,h,p,[f,m]=n,[g,_]=n;for(let v=0,b=t.length;v<b;v++){const x=t[v],[T,S]=x;if(f=o(f,T),m=o(m,S),g=a(g,T),_=a(_,S),r&&x.length>2){const O=x[2];l=o(l,O),h=a(h,O)}if(i&&x.length>s){const O=x[s];c=o(c,O),p=a(p,O)}}return e.xmin=f,e.ymin=m,e.xmax=g,e.ymax=_,e.spatialReference=this.spatialReference,r?(e.zmin=l,e.zmax=h):(e.zmin=void 0,e.zmax=void 0),i?(e.mmin=c,e.mmax=p):(e.mmin=void 0,e.mmax=void 0),e}writePoints(t,e){e.points=re(this.points)}addPoint(t){return eA(this,t),Array.isArray(t)?this.points.push(t):this.points.push(t.toArray()),this.notifyChange("points"),this}clone(){const t={points:re(this.points),spatialReference:this.spatialReference};return this.hasZ&&(t.hasZ=!0),this.hasM&&(t.hasM=!0),new d7(t)}getPoint(t){if(!this._validateInputs(t))return null;const e=this.points[t],r={x:e[0],y:e[1],spatialReference:this.spatialReference};let i=2;return this.hasZ&&(r.z=e[2],i=3),this.hasM&&(r.m=e[i]),new ht(r)}removePoint(t){if(!this._validateInputs(t))return null;const e=new ht(this.points.splice(t,1)[0],this.spatialReference);return this.notifyChange("points"),e}setPoint(t,e){return this._validateInputs(t)?(eA(this,e),Array.isArray(e)||(e=e.toArray()),this.points[t]=e,this.notifyChange("points"),this):this}toJSON(t){return this.write({},t)}_validateInputs(t){return t!=null&&t>=0&&t<this.points.length}};u([d({readOnly:!0})],G_.prototype,"cache",null),u([d()],G_.prototype,"extent",null),u([d({type:[[Number]],json:{write:{isRequired:!0}}})],G_.prototype,"points",void 0),u([Ve("points")],G_.prototype,"writePoints",null),G_=d7=u([R("esri.geometry.Multipoint")],G_),G_.prototype.toJSON.isDefaultToJSON=!0;const ZP=G_;function PNt(t){const e=[];for(t.reset();t.nextPath();){const r=[];for(;t.nextPoint();)r.push([t.x,t.y]);e.push(r)}return t.reset(),e}function R8e(t){const e=[];for(;t.nextPoint();)e.push([t.x,t.y]);return t.seekPathStart(),e}function vne(t){if(!t)return null;if(Array.isArray(t))return t;const e=t.hasZ,r=t.hasM;if(t.type==="point")return r&&e?[t.x,t.y,t.z,t.m]:e?[t.x,t.y,t.z]:r?[t.x,t.y,t.m]:[t.x,t.y];if(t.type==="polygon")return t.rings.slice(0);if(t.type==="polyline")return t.paths.slice(0);if(t.type==="multipoint")return t.points.slice(0);if(t.type==="extent"){const i=t.clone().normalize();if(!i)return null;let s=!1,n=!1;return i.forEach(o=>{o.hasZ&&(s=!0),o.hasM&&(n=!0)}),i.map(o=>{const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(s&&o.hasZ){const l=.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(n&&o.hasM){const l=.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a})}return null}function L6(t,e){const r=e[0]-t[0],i=e[1]-t[1];if(t.length>2&&e.length>2){const s=t[2]-e[2];return Math.sqrt(r*r+i*i+s*s)}return Math.sqrt(r*r+i*i)}function F1e(t,e,r){const i=t[0]+r*(e[0]-t[0]),s=t[1]+r*(e[1]-t[1]);return t.length>2&&e.length>2?[i,s,t[2]+r*(e[2]-t[2])]:[i,s]}function $Nt(t,e,r,i){const[s,n]=e,[o,a]=r[i],[l,c]=r[i+1],h=l-o,p=c-a,f=h*h+p*p,m=(s-o)*h+(n-a)*p,g=Math.min(1,Math.max(0,m/f));return t[0]=o+h*g,t[1]=a+p*g,t}function LNt(t,e,r){let i,s,n,o,a=!1,l=1/0;for(r.reset();r.nextPath();)if(r.nextPoint())for(i=r.x,s=r.y;r.nextPoint();)n=r.x,o=r.y,s>e!=o>e&&t<(n-i)*(e-s)/(o-s)+i&&(a=!a),l=Math.min(l,M8e(t,e,i,s,n,o)),i=n,s=o;return l===0?0:(a?1:-1)*Math.sqrt(l)}function M8e(t,e,r,i,s,n){let o=r,a=i,l=s-o,c=n-a;if(l!==0||c!==0){const h=((t-o)*l+(e-a)*c)/(l*l+c*c);h>1?(o=s,a=n):h>0&&(o+=l*h,a+=c*h)}return l=t-o,c=e-a,l*l+c*c}function k1e(t,e){return F1e(t,e,.5)}function U1e(t){const e=t.length;let r=0;for(let i=0;i<e-1;++i)r+=L6(t[i],t[i+1]);return r}function V1e(t,e){if(e<=0)return t[0];const r=t.length;let i=0;for(let s=0;s<r-1;++s){const n=L6(t[s],t[s+1]);if(e-i<n){const o=(e-i)/n;return F1e(t[s],t[s+1],o)}i+=n}return t[r-1]}function CQ(t,e,r){const i=t.length;let s=0,n=0,o=0;for(let a=0;a<i;a++){const l=t[a],c=t[(a+1)%i];let h=2;s+=l[0]*c[1]-c[0]*l[1],l.length>2&&c.length>2&&r&&(n+=l[0]*c[2]-c[0]*l[2],h=3),l.length>h&&c.length>h&&e&&(o+=l[0]*c[h]-c[0]*l[h])}return s<=0&&n<=0&&o<=0}function I8e(t){const e=t.length;return e>2&&T0(t[0],t[e-1])}function DNt(t){if("rings"in t&&(P8e(t),t.rings.length>0&&!CQ(t.rings[0],t.hasM??!1,t.hasZ??!1)))for(const e of t.rings)e.reverse()}function P8e(t){if("rings"in t)for(const e of t.rings)I8e(e)||e.push(e[0].slice())}function NNt(t){return t.type!=="polygon"&&t.type!=="polyline"||$8e(t.type==="polygon"?t.rings:t.paths,t.spatialReference),t}function $8e(t,e){const r=T1(e);if(!r)return;const i=r.valid[0],s=r.valid[1],n=s-i;for(const o of t){let a=1/0,l=-1/0;for(const h of o){const p=L8e(h[0],i,s);a=Math.min(a,p),l=Math.max(l,p),h[0]=p}const c=l-a;n-c<c&&o.forEach(h=>{h[0]<0&&(h[0]+=n)})}}function L8e(t,e,r){const i=r-e;return t<e?r-(e-t)%i:t>r?e+(t-e)%i:t}function FNt(t){if(!t||t.length<3)return 0;let e=0;const r=t.length-1;for(let i=0;i<r;i++)e+=(t[i][0]-t[i+1][0])*(t[i][1]+t[i+1][1]);return e+=(t[r][0]-t[0][0])*(t[r][1]+t[0][1]),-.5*e}function z1e(t){if(!t||t.numPoints<3)return 0;let e,r,i=0;if(t.seekPathStart(),!t.nextPoint())return 0;e=t.x,r=t.y;const s=e,n=r;for(;t.nextPoint();)i+=(e-t.x)*(r+t.y),e=t.x,r=t.y;return i+=(e-s)*(r+n),-.5*i}function kNt(t,e){if(t===e)return!0;if(t.type!==e.type)return!1;if(t.type==="point"||t.type==="mesh"||t.type==="extent")return!0;if(t.type==="multipoint")return t.points.length===e.points.length;const[r,i]=t.type==="polyline"?[t.paths,e.paths]:[t.rings,e.rings];return r.length===i.length&&r.every((s,n)=>s.length===i[n].length)}function UNt(t){return t?t.hasZ?[t.xmax-t.xmin/2,t.ymax-t.ymin/2,t.zmax-t.zmin/2]:[t.xmax-t.xmin/2,t.ymax-t.ymin/2]:null}function D8e(t){return t?B1e(t.rings,t.hasZ??!1):null}function B1e(t,e){if(!t||!t.length)return null;const r=[],i=[],s=e?[1/0,-1/0,1/0,-1/0,1/0,-1/0]:[1/0,-1/0,1/0,-1/0];for(let n=0,o=t.length;n<o;n++){const a=G1e(t[n],e,s);a&&i.push(a)}if(i.sort((n,o)=>{let a=n[2]-o[2];return a===0&&e&&(a=n[4]-o[4]),a}),i.length&&(r[0]=i[0][0],r[1]=i[0][1],e&&(r[2]=i[0][3]),(r[0]<s[0]||r[0]>s[1]||r[1]<s[2]||r[1]>s[3]||e&&(r[2]<s[4]||r[2]>s[5]))&&(r.length=0)),!r.length){const n=t[0]&&t[0].length?N8e(t[0],e):null;if(!n)return null;r[0]=n[0],r[1]=n[1],e&&n.length>2&&(r[2]=n[2])}return r}function G1e(t,e,r){let i=0,s=0,n=0,o=0,a=0;const l=t.length?t[0][0]:0,c=t.length?t[0][1]:0,h=t.length&&e?t[0][2]:0;for(let f=0;f<t.length;f++){const m=t[f],g=t[(f+1)%t.length],[_,v,b]=m,x=_-l,T=v-c,[S,O,A]=g,M=S-l,P=O-c,F=x*P-M*T;if(o+=F,i+=(x+M)*F,s+=(T+P)*F,e&&m.length>2&&g.length>2){const $=b-h,N=A-h,U=x*N-M*$;n+=($+N)*U,a+=U}_<r[0]&&(r[0]=_),_>r[1]&&(r[1]=_),v<r[2]&&(r[2]=v),v>r[3]&&(r[3]=v),e&&(b<r[4]&&(r[4]=b),b>r[5]&&(r[5]=b))}if(o>0&&(o*=-1),a>0&&(a*=-1),!o)return null;o*=.5,a*=.5;const p=[i/(6*o)+l,s/(6*o)+c,o];return e&&(r[4]===r[5]||a===0?(p[3]=(r[4]+r[5])/2,p[4]=0):(p[3]=n/(6*a)+h,p[4]=a)),p}function N8e(t,e){const r=e?[0,0,0]:[0,0],i=e?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;for(let l=0,c=t.length;l<c-1;l++){const h=t[l],p=t[l+1];if(h&&p){r[0]=h[0],r[1]=h[1],i[0]=p[0],i[1]=p[1],e&&h.length>2&&p.length>2&&(r[2]=h[2],i[2]=p[2]);const f=L6(r,i);if(f){s+=f;const m=k1e(h,p);n+=f*m[0],o+=f*m[1],e&&m.length>2&&(a+=f*m[2])}}}return s>0?e?[n/s,o/s,a/s]:[n/s,o/s]:t.length?t[0]:null}function F8e(t){const{hasZ:e,numPaths:r}=t;if(r===0)return null;const i=[],s=[],n=e?[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY]:[Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY,Number.POSITIVE_INFINITY,Number.NEGATIVE_INFINITY];for(t.reset();t.nextPath();){const o=G1e(R8e(t),t.hasZ,n);o&&s.push(o)}if(s.sort((o,a)=>{let l=o[2]-a[2];return l===0&&e&&(l=o[4]-a[4]),l}),s.length&&(i[0]=s[0][0],i[1]=s[0][1],e&&(i[2]=s[0][3]),(i[0]<n[0]||i[0]>n[1]||i[1]<n[2]||i[1]>n[3]||e&&(i[2]<n[4]||i[2]>n[5]))&&(i.length=0)),!i.length){t.reset(),t.nextPath();const o=t.numPoints?k8e(t):null;if(!o)return null;i[0]=o[0],i[1]=o[1],e&&o.length>2&&(i[2]=o[2])}return i}function k8e(t){const{hasZ:e}=t,r=e?[0,0,0]:[0,0],i=e?[0,0,0]:[0,0];let s=0,n=0,o=0,a=0;if(t.nextPoint()){let l=t.x,c=t.y,h=t.z;for(;t.nextPoint();){const p=t.x,f=t.y,m=t.z;r[0]=l,r[1]=c,i[0]=p,i[1]=f,e&&(r[2]=h,i[2]=m);const g=L6(r,i);if(g){s+=g;const _=k1e(r,i);n+=g*_[0],o+=g*_[1],e&&_.length>2&&(a+=g*_[2])}l=p,c=f,h=m}}return s>0?e?[n/s,o/s,a/s]:[n/s,o/s]:t.numPoints?(t.seekPathStart(),t.nextPoint(),[t.x,t.y]):null}const U8e=1e-6;function VNt(t){let e=0;for(t.reset();t.nextPath();)e+=z1e(t);if(e<U8e){const s=F8e(t);return s?[s[0],s[1]]:null}const r=[0,0];if(t.reset(),!t.nextPath()||!t.nextPoint())return null;const i=[t.x,t.y];for(t.reset();t.nextPath();)z8e(r,i,t);return r[0]*=1/e,r[1]*=1/e,r[0]+=i[0],r[1]+=i[1],r}const V8e=1/3;function z8e(t,e,r){if(!t||!r||r.numPoints<3)return null;r.nextPoint();const i=r.x,s=r.y;r.nextPoint();let n,o=r.x-i,a=r.y-s,l=0,c=0;for(;r.nextPoint();)l=r.x-i,c=r.y-s,n=.5*V8e*(l*a-c*o),t[0]+=n*(o+l),t[1]+=n*(a+c),o=l,a=c;const h=z1e(r),p=[i,s];return p[0]-=e[0],p[1]-=e[1],p[0]*=h,p[1]*=h,t[0]+=p[0],t[1]+=p[1],t}function C(){return[0,0,0]}function $i(t){return[t[0],t[1],t[2]]}function Ee(t,e,r){return[t,e,r]}function Ml(t){const e=C(),r=Math.min(3,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function AQ(t,e){return new Float64Array(t,e,3)}function j1e(){return C()}function H1e(){return Ee(1,1,1)}function q1e(){return Ee(1,0,0)}function W1e(){return Ee(0,1,0)}function OQ(){return Ee(0,0,1)}const Nl=j1e(),i0=H1e(),Z1e=q1e(),X1e=W1e(),RQ=OQ();Object.freeze(Object.defineProperty({__proto__:null,ONES:i0,UNIT_X:Z1e,UNIT_Y:X1e,UNIT_Z:RQ,ZEROS:Nl,clone:$i,create:C,createView:AQ,fromArray:Ml,fromValues:Ee,ones:H1e,unitX:q1e,unitY:W1e,unitZ:OQ,zeros:j1e},Symbol.toStringTag,{value:"Module"}));let MQ=1e-6;function sl(){return MQ}function B8e(t){MQ=t}const XP=Math.random,G8e=Math.PI/180,j8e=180/Math.PI;function D6(t){return t*G8e}function H8e(t){return t*j8e}function q8e(t,e){return Math.abs(t-e)<=MQ*Math.max(1,Math.abs(t),Math.abs(e))}Object.freeze(Object.defineProperty({__proto__:null,RANDOM:XP,equals:q8e,getEpsilon:sl,setEpsilon:B8e,toDegree:H8e,toRadian:D6},Symbol.toStringTag,{value:"Module"}));function Oe(t){const e=t[0],r=t[1],i=t[2];return Math.sqrt(e*e+r*r+i*i)}function oe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t}function ie(t,e,r,i){return t[0]=e,t[1]=r,t[2]=i,t}function ue(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t}function pe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t}function N6(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t}function tk(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t}function W8e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t}function Y1e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t}function rk(t,e){return t[0]=Math.abs(e[0]),t[1]=Math.abs(e[1]),t[2]=Math.abs(e[2]),t}function J1e(t,e){return t[0]=Math.sign(e[0]),t[1]=Math.sign(e[1]),t[2]=Math.sign(e[2]),t}function IQ(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t}function Z8e(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t}function X8e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t}function ae(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t}function gu(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t}function _i(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return Math.sqrt(r*r+i*i+s*s)}function kn(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function Xa(t){const e=t[0],r=t[1],i=t[2];return e*e+r*r+i*i}function el(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t}function Y8e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t}function _e(t,e){const r=e[0],i=e[1],s=e[2];let n=r*r+i*i+s*s;return n>0&&(n=1/Math.sqrt(n),t[0]=e[0]*n,t[1]=e[1]*n,t[2]=e[2]*n),t}function de(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function st(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];return t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o,t}function Wr(t,e,r,i){const s=e[0],n=e[1],o=e[2];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t}function J8e(t,e,r,i,s,n){const o=n*n,a=o*(2*n-3)+1,l=o*(n-2)+n,c=o*(n-1),h=o*(3-2*n);return t[0]=e[0]*a+r[0]*l+i[0]*c+s[0]*h,t[1]=e[1]*a+r[1]*l+i[1]*c+s[1]*h,t[2]=e[2]*a+r[2]*l+i[2]*c+s[2]*h,t}function Q8e(t,e,r,i,s,n){const o=1-n,a=o*o,l=n*n,c=a*o,h=3*n*a,p=3*l*o,f=l*n;return t[0]=e[0]*c+r[0]*h+i[0]*p+s[0]*f,t[1]=e[1]*c+r[1]*h+i[1]*p+s[1]*f,t[2]=e[2]*c+r[2]*h+i[2]*p+s[2]*f,t}function K8e(t,e){e=e||1;const r=XP,i=2*r()*Math.PI,s=2*r()-1,n=Math.sqrt(1-s*s)*e;return t[0]=Math.cos(i)*n,t[1]=Math.sin(i)*n,t[2]=s*e,t}function Ne(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12],t[1]=r[1]*i+r[5]*s+r[9]*n+r[13],t[2]=r[2]*i+r[6]*s+r[10]*n+r[14],t}function yu(t,e,r){const i=e[0],s=e[1],n=e[2];return t[0]=i*r[0]+s*r[3]+n*r[6],t[1]=i*r[1]+s*r[4]+n*r[7],t[2]=i*r[2]+s*r[5]+n*r[8],t}function xu(t,e,r){const i=r[0],s=r[1],n=r[2],o=r[3],a=e[0],l=e[1],c=e[2];let h=s*c-n*l,p=n*a-i*c,f=i*l-s*a,m=s*f-n*p,g=n*h-i*f,_=i*p-s*h;const v=2*o;return h*=v,p*=v,f*=v,m*=2,g*=2,_*=2,t[0]=a+h+m,t[1]=l+p+g,t[2]=c+f+_,t}function e9e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0],n[1]=s[1]*Math.cos(i)-s[2]*Math.sin(i),n[2]=s[1]*Math.sin(i)+s[2]*Math.cos(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function t9e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[2]*Math.sin(i)+s[0]*Math.cos(i),n[1]=s[1],n[2]=s[2]*Math.cos(i)-s[0]*Math.sin(i),t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function r9e(t,e,r,i){const s=[],n=[];return s[0]=e[0]-r[0],s[1]=e[1]-r[1],s[2]=e[2]-r[2],n[0]=s[0]*Math.cos(i)-s[1]*Math.sin(i),n[1]=s[0]*Math.sin(i)+s[1]*Math.cos(i),n[2]=s[2],t[0]=n[0]+r[0],t[1]=n[1]+r[1],t[2]=n[2]+r[2],t}function Q1e(t,e){oe(aL,t),oe(lL,e),_e(aL,aL),_e(lL,lL);const r=de(aL,lL);return r>1?0:r<-1?Math.PI:Math.acos(r)}const aL=C(),lL=C();function i9e(t){return"vec3("+t[0]+", "+t[1]+", "+t[2]+")"}function Jr(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function D1(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=e[0],o=e[1],a=e[2],l=sl();return Math.abs(r-n)<=l*Math.max(1,Math.abs(r),Math.abs(n))&&Math.abs(i-o)<=l*Math.max(1,Math.abs(i),Math.abs(o))&&Math.abs(s-a)<=l*Math.max(1,Math.abs(s),Math.abs(a))}function F0(t,e,r){const i=r[0]-e[0],s=r[1]-e[1],n=r[2]-e[2];let o=i*i+s*s+n*n;return o>0?(o=1/Math.sqrt(o),t[0]=i*o,t[1]=s*o,t[2]=n*o,t):(t[0]=0,t[1]=0,t[2]=0,t)}const Mi=pe,s9e=N6,n9e=tk,YP=_i,F6=kn,ou=Oe,tA=Xa,bne=Object.freeze(Object.defineProperty({__proto__:null,abs:rk,add:ue,angle:Q1e,bezier:Q8e,ceil:W8e,copy:oe,cross:st,direction:F0,dist:YP,distance:_i,div:n9e,divide:tk,dot:de,equals:D1,exactEquals:Jr,floor:Y1e,hermite:J8e,inverse:Y8e,len:ou,length:Oe,lerp:Wr,max:Z8e,min:IQ,mul:s9e,multiply:N6,negate:el,normalize:_e,random:K8e,rotateX:e9e,rotateY:t9e,rotateZ:r9e,round:X8e,scale:ae,scaleAndAdd:gu,set:ie,sign:J1e,sqrDist:F6,sqrLen:tA,squaredDistance:kn,squaredLength:Xa,str:i9e,sub:Mi,subtract:pe,transformMat3:yu,transformMat4:Ne,transformQuat:xu},Symbol.toStringTag,{value:"Module"}));function Id(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function zi(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function PQ(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function K1e(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function ebe(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t[2]=e[2]*r[2],t[3]=e[3]*r[3],t}function tbe(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t[2]=e[2]/r[2],t[3]=e[3]/r[3],t}function o9e(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t[2]=Math.ceil(e[2]),t[3]=Math.ceil(e[3]),t}function a9e(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t[2]=Math.floor(e[2]),t[3]=Math.floor(e[3]),t}function l9e(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t[2]=Math.min(e[2],r[2]),t[3]=Math.min(e[3],r[3]),t}function c9e(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t[2]=Math.max(e[2],r[2]),t[3]=Math.max(e[3],r[3]),t}function u9e(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t[2]=Math.round(e[2]),t[3]=Math.round(e[3]),t}function AT(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function h9e(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}function rbe(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return Math.sqrt(r*r+i*i+s*s+n*n)}function ik(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2],n=e[3]-t[3];return r*r+i*i+s*s+n*n}function $Q(t){const e=t[0],r=t[1],i=t[2],s=t[3];return Math.sqrt(e*e+r*r+i*i+s*s)}function LQ(t){const e=t[0],r=t[1],i=t[2],s=t[3];return e*e+r*r+i*i+s*s}function d9e(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=-e[3],t}function p9e(t,e){return t[0]=1/e[0],t[1]=1/e[1],t[2]=1/e[2],t[3]=1/e[3],t}function ibe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*r+i*i+s*s+n*n;return o>0&&(o=1/Math.sqrt(o),t[0]=r*o,t[1]=i*o,t[2]=s*o,t[3]=n*o),t}function sbe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]+t[3]*e[3]}function k6(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t[2]=o+i*(r[2]-o),t[3]=a+i*(r[3]-a),t}function f9e(t,e){const r=XP;let i,s,n,o,a,l;e=e||1;do i=2*r()-1,s=2*r()-1,a=i*i+s*s;while(a>=1);do n=2*r()-1,o=2*r()-1,l=n*n+o*o;while(l>=1);const c=Math.sqrt((1-a)/l);return t[0]=e*i,t[1]=e*s,t[2]=e*n*c,t[3]=e*o*c,t}function ph(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3];return t[0]=r[0]*i+r[4]*s+r[8]*n+r[12]*o,t[1]=r[1]*i+r[5]*s+r[9]*n+r[13]*o,t[2]=r[2]*i+r[6]*s+r[10]*n+r[14]*o,t[3]=r[3]*i+r[7]*s+r[11]*n+r[15]*o,t}function m9e(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2],c=r[3],h=c*i+a*n-l*s,p=c*s+l*i-o*n,f=c*n+o*s-a*i,m=-o*i-a*s-l*n;return t[0]=h*c+m*-o+p*-l-f*-a,t[1]=p*c+m*-a+f*-o-h*-l,t[2]=f*c+m*-l+h*-a-p*-o,t[3]=e[3],t}function g9e(t){return"vec4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function wC(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function sk(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=sl();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}const y9e=K1e,_9e=ebe,v9e=tbe,b9e=rbe,w9e=ik,x9e=$Q,T9e=LQ,nbe=Object.freeze(Object.defineProperty({__proto__:null,add:PQ,ceil:o9e,copy:Id,dist:b9e,distance:rbe,div:v9e,divide:tbe,dot:sbe,equals:sk,exactEquals:wC,floor:a9e,inverse:p9e,len:x9e,length:$Q,lerp:k6,max:c9e,min:l9e,mul:_9e,multiply:ebe,negate:d9e,normalize:ibe,random:f9e,round:u9e,scale:AT,scaleAndAdd:h9e,set:zi,sqrDist:w9e,sqrLen:T9e,squaredDistance:ik,squaredLength:LQ,str:g9e,sub:y9e,subtract:K1e,transformMat4:ph,transformQuat:m9e},Symbol.toStringTag,{value:"Module"})),wne=new Float32Array(1);function S9e(t){--t;for(let e=1;e<32;e<<=1)t|=t>>e;return t+1}function ye(t,e,r){return Math.min(Math.max(t,e),r)}function OT(t){return(t&t-1)==0}function zNt(t){return t--,t|=t>>1,t|=t>>2,t|=t>>4,t|=t>>8,t|=t>>16,++t}function BNt(t){return 10**Math.ceil(Math.LOG10E*Math.log(t))}function Et(t,e,r){return t+(e-t)*r}function zt(t){return t*Math.PI/180}function Vl(t){return 180*t/Math.PI}function p7(t,e=1e-6){return(t<0?-1:1)/Math.max(Math.abs(t),e)}function oo(t){return Math.acos(ye(t,-1,1))}function Gd(t){return Math.asin(ye(t,-1,1))}function a0(t,e,r=1e-6){return t===e?!0:!Number.isFinite(t)||!Number.isFinite(e)?!1:(t>e?t-e:e-t)<=r}const nk=new DataView(new ArrayBuffer(Float64Array.BYTES_PER_ELEMENT));function f7(t){return nk.setFloat64(0,t),nk.getBigInt64(0)}function E9e(t){return nk.setBigInt64(0,t),nk.getFloat64(0)}const AF=BigInt("1000000"),C9e=obe(1);function obe(t){const e=f7(t=Math.abs(t)),r=E9e(e<=AF?AF:e-AF);return Math.abs(t-r)}function GNt(t,e,r=C9e){if(t===e)return!0;if(!Number.isFinite(t)||!Number.isFinite(e))return!1;if(r!=null&&obe(Math.min(Math.abs(t),Math.abs(e)))<r)return Math.abs(t-e)<=r;const i=f7(t),s=f7(e);return i<0!=s<0?!1:!((i<s?s-i:i-s)>AF)}function A9e(t,e,r=1e-6){if(t===e)return!0;if(!Number.isFinite(t)||!Number.isFinite(e))return!1;const i=Math.abs(t-e),s=Math.abs(t),n=Math.abs(e);if(t===0||e===0||s<1e-12&&n<1e-12){if(i>.01*r)return!1}else if(i/(s+n)>r)return!1;return!0}function O9e(t){return abe(Math.max(-m7,Math.min(t,m7)))}function abe(t){return wne[0]=t,wne[0]}function BI(t,e,r){const i=ye((r-t)/(e-t),0,1);return i*i*(3-2*i)}function xne(t,e){const r=Oe(t),i=Gd(t[2]/r),s=Math.atan2(t[1]/r,t[0]/r);return ie(e,r,i,s),e}function jNt(t,e,r){return zi(t,e[0],e[1],e[2],e[3]*r)}function HNt(t){const e=t[0]*t[0]+t[1]*t[1]+t[2]*t[2],r=t[3]*t[3]+t[4]*t[4]+t[5]*t[5],i=t[6]*t[6]+t[7]*t[7]+t[8]*t[8];return!(a0(e,1)&&a0(r,1)&&a0(i,1))}const m7=abe(34028234663852886e22);function Ht(t=P9e){return[t[0],t[1],t[2],t[3]]}function qNt(t){return[t[0],t[1],t[2],t[3]]}function C0(t,e){return t!==e&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3]),t}function DQ(t,e,r,i,s=Ht()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function lbe(t,e=Ht()){return e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax,e}function U6(t,e){return new vr({xmin:t[0],ymin:t[1],xmax:t[2],ymax:t[3],spatialReference:e})}function xC(t,e){e[0]<t[0]&&(t[0]=e[0]),e[0]>t[2]&&(t[2]=e[0]),e[1]<t[1]&&(t[1]=e[1]),e[1]>t[3]&&(t[3]=e[1])}function E1(t,e,r){if(e!=null)if("length"in e)_7(e)?(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[2]),r[3]=Math.max(t[3],e[3])):e.length!==2&&e.length!==3||(r[0]=Math.min(t[0],e[0]),r[1]=Math.min(t[1],e[1]),r[2]=Math.max(t[2],e[0]),r[3]=Math.max(t[3],e[1]));else switch(e.type){case"extent":r[0]=Math.min(t[0],e.xmin),r[1]=Math.min(t[1],e.ymin),r[2]=Math.max(t[2],e.xmax),r[3]=Math.max(t[3],e.ymax);break;case"point":r[0]=Math.min(t[0],e.x),r[1]=Math.min(t[1],e.y),r[2]=Math.max(t[2],e.x),r[3]=Math.max(t[3],e.y)}else C0(r,t)}function w9(t,e,r=t){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3];for(let l=0;l<i;l++){const c=e[l];s=Math.min(s,c[0]),n=Math.min(n,c[1]),o=Math.max(o,c[0]),a=Math.max(a,c[1])}return r[0]=s,r[1]=n,r[2]=o,r[3]=a,r}function g7(t){for(let e=0;e<4;e++)if(!isFinite(t[e]))return!1;return!0}function hh(t){return t==null||t[0]>=t[2]?0:t[2]-t[0]}function Mf(t){return t[1]>=t[3]?0:t[3]-t[1]}function cbe(t){return hh(t)*Mf(t)}function NQ(t,e=[0,0]){return e[0]=(t[0]+t[2])/2,e[1]=(t[1]+t[3])/2,e}function ube(t,e){return V6(t,e[0],e[1])}function Tne(t,e){const r=e[3],i=.5*(t[0]+t[2]),s=Math.abs(e[0]-i),n=.5*(t[2]-t[0]);if(s>r+n)return!1;const o=.5*(t[1]+t[3]),a=.5*(t[3]-t[1]),l=Math.abs(e[1]-o);if(l>r+a)return!1;if(s<n||l<a)return!0;const c=s-n,h=l-a;return c*c+h*h<=r*r}function WNt(t,e,r){const i=t[0],s=t[1],n=t[2],o=t[3],{x:a,y:l}=e,{x:c,y:h}=r,p=(v,b)=>(h-l)*v+(a-c)*b+(c*l-a*h)<0,f=p(i,o),m=p(n,o),g=p(n,s),_=p(i,s);return!(f===m&&m===g&&g===_&&_===f||a<i&&c<i||a>n&&c>n||l>o&&h>o||l<s&&h<s)}function ZNt(t,e){return V6(t,e.x,e.y)}function V6(t,e,r){return e>=t[0]&&r>=t[1]&&e<=t[2]&&r<=t[3]}function R9e(t,e,r){return e[0]>=t[0]-r&&e[1]>=t[1]-r&&e[0]<=t[2]+r&&e[1]<=t[3]+r}function JP(t,e){return Math.max(e[0],t[0])<=Math.min(e[2],t[2])&&Math.max(e[1],t[1])<=Math.min(e[3],t[3])}function Sne(t,e){return e[0]>=t[0]&&e[2]<=t[2]&&e[1]>=t[1]&&e[3]<=t[3]}function y7(t,e,r){if(e==null)return C0(r,t);const i=e[0],s=e[1],n=e[2],o=e[3];return r[0]=ye(t[0],i,n),r[1]=ye(t[1],s,o),r[2]=ye(t[2],i,n),r[3]=ye(t[3],s,o),r}function M9e(t,e){const r=(t[0]+t[2])/2,i=(t[1]+t[3])/2,s=Math.max(Math.abs(e[0]-r)-hh(t)/2,0),n=Math.max(Math.abs(e[1]-i)-Mf(t)/2,0);return Math.sqrt(s*s+n*n)}function ok(t,e,r,i=t){return i[0]=t[0]+e,i[1]=t[1]+r,i[2]=t[2]+e,i[3]=t[3]+r,i}function Au(t){return t?C0(t,v7):Ht(v7)}function _7(t){return t!=null&&t.length===4}function I9e(t){return!(hh(t)!==0&&isFinite(t[0])||Mf(t)!==0&&isFinite(t[1]))}function Kx(t,e){return _7(t)&&_7(e)?t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]:t===e}const XNt=[-1/0,-1/0,1/0,1/0],v7=[1/0,1/0,-1/0,-1/0],P9e=[0,0,0,0];function hbe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function dbe(t){return t.points!==void 0}function pbe(t){return t.x!==void 0&&t.y!==void 0}function fbe(t){return t.paths!==void 0}function mbe(t){return t.rings!==void 0}function gbe(t){function e(r,i){return r==null?i:i==null?r:t(r,i)}return e}const n1=gbe(Math.min),o1=gbe(Math.max);function YNt(t,e){return fbe(e)?rA(t,e.paths,!1,!1):mbe(e)?rA(t,e.rings,!1,!1):dbe(e)?FQ(t,e.points,!1,!1,!1,!1):hbe(e)?ybe(t,e):(pbe(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.x,t[3]=e.y),t)}function JNt(t){let e,r,i,s;for(t.reset(),e=i=1/0,r=s=-1/0;t.nextPath();){const n=$9e(t);e=Math.min(n[0],e),i=Math.min(n[1],i),r=Math.max(n[2],r),s=Math.max(n[3],s)}return Ht([e,i,r,s])}function $9e(t){let e,r,i,s;for(e=i=1/0,r=s=-1/0;t.nextPoint();)e=Math.min(t.x,e),i=Math.min(t.y,i),r=Math.max(t.x,r),s=Math.max(t.y,s);return Ht([e,i,r,s])}function QNt(t,e){return fbe(e)?rA(t,e.paths,!0,!1):mbe(e)?rA(t,e.rings,!0,!1):dbe(e)?FQ(t,e.points,!0,!1,!0,!1):hbe(e)?ybe(t,e,!0,!1,!0,!1):(pbe(e)&&(t[0]=e.x,t[1]=e.y,t[2]=e.z,t[3]=e.x,t[4]=e.y,t[5]=e.z),t)}function rA(t,e,r,i){const s=r?3:2;if(!e.length||!e[0].length)return null;let n,o,a,l,[c,h]=e[0][0],[p,f]=e[0][0];for(let m=0;m<e.length;m++){const g=e[m];for(let _=0;_<g.length;_++){const v=g[_],[b,x]=v;if(c=n1(c,b),h=n1(h,x),p=o1(p,b),f=o1(f,x),r&&v.length>2){const T=v[2];n=n1(n,T),o=o1(o,T)}if(i&&v.length>s){const T=v[s];a=n1(n,T),l=o1(o,T)}}}return r?i?(t[0]=c,t[1]=h,t[2]=n,t[3]=a,t[4]=p,t[5]=f,t[6]=o,t[7]=l,t.length=8,t):(t[0]=c,t[1]=h,t[2]=n,t[3]=p,t[4]=f,t[5]=o,t.length=6,t):i?(t[0]=c,t[1]=h,t[2]=a,t[3]=p,t[4]=f,t[5]=l,t.length=6,t):(t[0]=c,t[1]=h,t[2]=p,t[3]=f,t.length=4,t)}function ybe(t,e,r,i,s,n){const o=e.xmin,a=e.xmax,l=e.ymin,c=e.ymax;let h=e.zmin,p=e.zmax,f=e.mmin,m=e.mmax;return s?(h=h||0,p=p||0,n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=h,t[3]=f,t[4]=a,t[5]=c,t[6]=p,t[7]=m,t):(t[0]=o,t[1]=l,t[2]=h,t[3]=a,t[4]=c,t[5]=p,t)):n?(f=f||0,m=m||0,t[0]=o,t[1]=l,t[2]=f,t[3]=a,t[4]=c,t[5]=m,t):(t[0]=o,t[1]=l,t[2]=a,t[3]=c,t)}function FQ(t,e,r,i,s,n){const o=r?3:2,a=i&&n,l=r&&s;if(!e.length||!e[0].length)return null;let c,h,p,f,[m,g]=e[0],[_,v]=e[0];for(let b=0;b<e.length;b++){const x=e[b],[T,S]=x;if(m=n1(m,T),g=n1(g,S),_=o1(_,T),v=o1(v,S),l&&x.length>2){const O=x[2];c=n1(c,O),h=o1(h,O)}if(a&&x.length>o){const O=x[o];p=n1(c,O),f=o1(h,O)}}return s?(c=c||0,h=h||0,n?(p=p||0,f=f||0,t[0]=m,t[1]=g,t[2]=c,t[3]=p,t[4]=_,t[5]=v,t[6]=h,t[7]=f,t):(t[0]=m,t[1]=g,t[2]=c,t[3]=_,t[4]=v,t[5]=h,t)):n?(p=p||0,f=f||0,t[0]=m,t[1]=g,t[2]=p,t[3]=_,t[4]=v,t[5]=f,t):(t[0]=m,t[1]=g,t[2]=_,t[3]=v,t)}function L9e(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function D9e(t){return t.points!==void 0}function N9e(t){return t.x!==void 0&&t.y!==void 0}function F9e(t){return t.paths!==void 0}function k9e(t){return t.rings!==void 0}const kQ=[];function _be(t,e,r,i){return{xmin:t,ymin:e,xmax:r,ymax:i}}function vbe(t,e,r,i,s,n){return{xmin:t,ymin:e,zmin:r,xmax:i,ymax:s,zmax:n}}function bbe(t,e,r,i,s,n){return{xmin:t,ymin:e,mmin:r,xmax:i,ymax:s,mmax:n}}function wbe(t,e,r,i,s,n,o,a){return{xmin:t,ymin:e,zmin:r,mmin:i,xmax:s,ymax:n,zmax:o,mmax:a}}function UQ(t,e=!1,r=!1){return e?r?wbe(t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7]):vbe(t[0],t[1],t[2],t[3],t[4],t[5]):r?bbe(t[0],t[1],t[2],t[3],t[4],t[5]):_be(t[0],t[1],t[2],t[3])}function KNt(t){return t?L9e(t)?t:N9e(t)?V9e(t):k9e(t)?xbe(t):F9e(t)?Tbe(t):D9e(t)?U9e(t):null:null}function U9e(t){const{hasZ:e,hasM:r,points:i}=t;return UQ(FQ(kQ,i,e??!1,r??!1),e,r)}function V9e(t){const{x:e,y:r,z:i,m:s}=t,n=s!=null;return i!=null?n?wbe(e,r,i,s,e,r,i,s):vbe(e,r,i,e,r,i):n?bbe(e,r,s,e,r,s):_be(e,r,e,r)}function xbe(t){const{hasZ:e,hasM:r,rings:i}=t,s=rA(kQ,i,e??!1,r??!1);return s?UQ(s,e,r):null}function Tbe(t){const{hasZ:e,hasM:r,paths:i}=t,s=rA(kQ,i,e??!1,r??!1);return s?UQ(s,e,r):null}var OF;function Ene(t){return!Array.isArray(t[0])}let ym=OF=class extends ob{static fromExtent(t){const e=t.clone().normalize(),r=t.spatialReference;let i=!1,s=!1;for(const o of e)o.hasZ&&(i=!0),o.hasM&&(s=!0);const n={rings:e.map(o=>{const a=[[o.xmin,o.ymin],[o.xmin,o.ymax],[o.xmax,o.ymax],[o.xmax,o.ymin],[o.xmin,o.ymin]];if(i&&o.hasZ){const l=o.zmin+.5*(o.zmax-o.zmin);for(let c=0;c<a.length;c++)a[c].push(l)}if(s&&o.hasM){const l=o.mmin+.5*(o.mmax-o.mmin);for(let c=0;c<a.length;c++)a[c].push(l)}return a}),spatialReference:r};return i&&(n.hasZ=!0),s&&(n.hasM=!0),new OF(n)}constructor(...t){super(...t),this.rings=[],this.type="polygon"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.rings??null,e||(t.spatialReference?e=t.spatialReference:t.rings||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||qe.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=n.length>3):r===void 0?r=i?n.length>3:n.length>2:i===void 0&&(i=r?n.length>3:n.length>2)),{rings:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("rings"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get centroid(){const t=D8e(this);if(!t||isNaN(t[0])||isNaN(t[1])||this.hasZ&&isNaN(t[2]))return null;const e=new ht;return e.x=t[0],e.y=t[1],e.spatialReference=this.spatialReference,this.hasZ&&(e.z=t[2]),e}get extent(){const{spatialReference:t}=this,e=xbe(this);if(!e)return null;const r=new vr(e);return r.spatialReference=t,r}get isSelfIntersecting(){return E8e(this.rings)}writeRings(t,e){e.rings=re(this.rings)}addRing(t){if(!t)return;const e=this.rings,r=e.length;if(Ene(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("rings"),this}clone(){const t=new OF;return t.spatialReference=this.spatialReference,t.rings=re(this.rings),t.hasZ=this.hasZ,t.hasM=this.hasM,t}equals(t){if(this===t)return!0;if(t==null)return!1;const e=this.spatialReference,r=t.spatialReference;if(e!=null!=(r!=null)||e!=null&&r!=null&&!e.equals(r)||this.rings.length!==t.rings.length)return!1;const i=([s,n,o,a],[l,c,h,p])=>s===l&&n===c&&(o==null&&h==null||o===h)&&(a==null&&p==null||a===p);for(let s=0;s<this.rings.length;s++){const n=this.rings[s],o=t.rings[s];if(!T0(n,o,i))return!1}return!0}contains(t){if(!t)return!1;const e=sS(t,this.spatialReference);return m8e(this,e??t)}isClockwise(t){let e;return e=Ene(t)?t.map(r=>this.hasZ?this.hasM?[r.x,r.y,r.z,r.m]:[r.x,r.y,r.z]:[r.x,r.y]):t,CQ(e,this.hasM,this.hasZ)}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.rings[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new ht(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new ht(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new ht(r[0],r[1],r[2],r[3],this.spatialReference):new ht(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(eA(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t].splice(e,0,r),this.notifyChange("rings"),this):this}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new ht(this.rings[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("rings"),r}removeRing(t){if(!this._validateInputs(t,null))return null;const e=this.rings.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new ht(s,r));return this.notifyChange("rings"),i}setPoint(t,e,r){return this._validateInputs(t,e)?(eA(this,r),Array.isArray(r)||(r=r.toArray()),this.rings[t][e]=r,this.notifyChange("rings"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.rings.length)return!1;if(e!=null){const i=this.rings[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],ym.prototype,"cache",null),u([d({readOnly:!0})],ym.prototype,"centroid",null),u([d({readOnly:!0})],ym.prototype,"extent",null),u([d({readOnly:!0})],ym.prototype,"isSelfIntersecting",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],ym.prototype,"rings",void 0),u([Ve("rings")],ym.prototype,"writeRings",null),ym=OF=u([R("esri.geometry.Polygon")],ym),ym.prototype.toJSON.isDefaultToJSON=!0;const bc=ym;var b7;function z9e(t){return!Array.isArray(t[0])}let j_=b7=class extends ob{constructor(...t){super(...t),this.paths=[],this.type="polyline"}normalizeCtorArgs(t,e){let r,i,s=null,n=null;return t&&!Array.isArray(t)?(s=t.paths??null,e||(t.spatialReference?e=t.spatialReference:t.paths||(e=t)),r=t.hasZ,i=t.hasM):s=t,s=s||[],e=e||qe.WGS84,s.length&&s[0]&&s[0][0]!=null&&typeof s[0][0]=="number"&&(s=[s]),n=s[0]&&s[0][0],n&&(r===void 0&&i===void 0?(r=n.length>2,i=!1):r===void 0?r=!i&&n.length>3:i===void 0&&(i=!r&&n.length>3)),{paths:s,spatialReference:e,hasZ:r,hasM:i}}get cache(){return this.commitProperty("paths"),this.commitProperty("hasZ"),this.commitProperty("hasM"),this.commitProperty("spatialReference"),{}}get extent(){const{spatialReference:t}=this,e=Tbe(this);if(!e)return null;const r=new vr(e);return r.spatialReference=t,r}writePaths(t,e){e.paths=re(this.paths)}addPath(t){if(!t)return;const e=this.paths,r=e.length;if(z9e(t)){const i=[];for(let s=0,n=t.length;s<n;s++)i[s]=t[s].toArray();e[r]=i}else e[r]=t.concat();return this.notifyChange("paths"),this}clone(){const t=new b7;return t.spatialReference=this.spatialReference,t.paths=re(this.paths),t.hasZ=this.hasZ,t.hasM=this.hasM,t}getPoint(t,e){if(!this._validateInputs(t,e))return null;const r=this.paths[t][e],i=this.hasZ,s=this.hasM;return i&&!s?new ht(r[0],r[1],r[2],void 0,this.spatialReference):s&&!i?new ht(r[0],r[1],void 0,r[2],this.spatialReference):i&&s?new ht(r[0],r[1],r[2],r[3],this.spatialReference):new ht(r[0],r[1],this.spatialReference)}insertPoint(t,e,r){return this._validateInputs(t,e,!0)?(eA(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t].splice(e,0,r),this.notifyChange("paths"),this):this}removePath(t){if(!this._validateInputs(t,null))return null;const e=this.paths.splice(t,1)[0],r=this.spatialReference,i=e.map(s=>new ht(s,r));return this.notifyChange("paths"),i}removePoint(t,e){if(!this._validateInputs(t,e))return null;const r=new ht(this.paths[t].splice(e,1)[0],this.spatialReference);return this.notifyChange("paths"),r}setPoint(t,e,r){return this._validateInputs(t,e)?(eA(this,r),Array.isArray(r)||(r=r.toArray()),this.paths[t][e]=r,this.notifyChange("paths"),this):this}_validateInputs(t,e,r=!1){if(t==null||t<0||t>=this.paths.length)return!1;if(e!=null){const i=this.paths[t];if(r&&(e<0||e>i.length)||!r&&(e<0||e>=i.length))return!1}return!0}toJSON(t){return this.write({},t)}};u([d({readOnly:!0})],j_.prototype,"cache",null),u([d({readOnly:!0})],j_.prototype,"extent",null),u([d({type:[[[Number]]],json:{write:{isRequired:!0}}})],j_.prototype,"paths",void 0),u([Ve("paths")],j_.prototype,"writePaths",null),j_=b7=u([R("esri.geometry.Polyline")],j_),j_.prototype.toJSON.isDefaultToJSON=!0;const QP=j_,Sbe=zl()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon"}),Cne=zl()({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh"});function Ebe(t){return t.xmin!==void 0&&t.ymin!==void 0&&t.xmax!==void 0&&t.ymax!==void 0}function VQ(t){return t.points!==void 0}function zQ(t){return t.x!==void 0&&t.y!==void 0}function BQ(t){return t.paths!==void 0}function TC(t){return t.rings!==void 0}function N1(t){return t==null?null:t instanceof ob?t:zQ(t)?ht.fromJSON(t):BQ(t)?QP.fromJSON(t):TC(t)?bc.fromJSON(t):VQ(t)?ZP.fromJSON(t):Ebe(t)?vr.fromJSON(t):null}function GQ(t){return t?zQ(t)?"esriGeometryPoint":BQ(t)?"esriGeometryPolyline":TC(t)?"esriGeometryPolygon":Ebe(t)?"esriGeometryEnvelope":VQ(t)?"esriGeometryMultipoint":null:null}const B9e={esriGeometryPoint:ht,esriGeometryPolyline:QP,esriGeometryPolygon:bc,esriGeometryEnvelope:vr,esriGeometryMultipoint:ZP};function G9e(t){return t&&B9e[t]||null}const nS={base:ob,key:"type",typeMap:{extent:vr,multipoint:ZP,point:ht,polyline:QP,polygon:bc}};Rf(nS);const j9e=K.getLogger("esri.support.arcadeOnDemand");let x9;function If(){return x9||(x9=(async()=>{const t=await J(()=>import("./arcadeUtils-9442db4c.js").then(e=>e.au),["./arcadeUtils-9442db4c.js","./number-5a528621.js","./arcadeTimeUtils-b60b3eed.js","./hash-6f442295.js"],import.meta.url);return{arcade:t.arcade,arcadeUtils:t,Dictionary:t.Dictionary,Feature:t.arcadeFeature}})()),x9}const H9e=(t,e,r)=>jQ.create(t,e,r,null,["$feature"],[]),q9e=(t,e,r)=>jQ.create(t,e,r,null,["$feature","$view"],[]),W9e=(t,e,r,i)=>jQ.create(t,e,r,i,["$feature","$view"],[]);let jQ=class Cbe{constructor(e,r,i,s,n,o,a){this.services=null,this.script=e,this.evaluate=s;const l=Array.isArray(o)?o:o.fields;this.fields=l,this._syntaxTree=i,this._arcade=r,this._arcadeFeature=n,this._spatialReference=a,this._referencesGeometry=r.scriptTouchesGeometry(this._syntaxTree),this._referencesScale=this._arcade.referencesMember(this._syntaxTree,"scale")}static async create(e,r,i,s,n,o){const{arcade:a,Feature:l,Dictionary:c}=await If(),h=qe.fromJSON(r);let p;try{p=a.parseScript(e,o)}catch(P){return j9e.error(new D("arcade-bad-expression","Failed to parse arcade script",{script:e,error:P})),null}const f=n.reduce((P,F)=>({...P,[F]:null}),{});let m=null;s!=null&&(m=new c(s),m.immutable=!0,f.$config=null);const g=a.scriptUsesGeometryEngine(p),_=g&&a.enableGeometrySupport(),v=a.scriptUsesFeatureSet(p)&&a.enableFeatureSetSupport(),b=a.scriptIsAsync(p),x=b&&a.enableAsyncSupport(),T={vars:f,spatialReference:h,useAsync:!!x};await Promise.all([_,v,x]);const S=new Set;await a.loadDependentModules(S,p,null,b,g);const O=new c;O.immutable=!1,O.setField("scale",0);const A=a.compileScript(p,T),M=(P,F)=>("$view"in P&&P.$view&&(O.setField("scale",typeof P.$view=="object"&&"scale"in P.$view?P.$view.scale:void 0),P.$view=O),m&&(P.$config=m),A({vars:P,spatialReference:h,services:F}));return new Cbe(e,a,p,M,new l,i,h)}repurposeFeature(e){return e.geometry&&!e.geometry.spatialReference&&(e.geometry.spatialReference=this._spatialReference),this._arcadeFeature.repurposeFromGraphicLikeObject(e.geometry,e.attributes,{fields:this.fields}),this._arcadeFeature}referencesGeometry(){return this._referencesGeometry}referencesScale(){return this._referencesScale}};const Z9e=/^([0-9_])/,X9e=/[^a-z0-9_\u0080-\uffff]+/gi;function Y9e(t){return t==null?null:t.trim().replaceAll(X9e,"_").replace(Z9e,"F$1")||null}const J9e=["field","field2","field3","normalizationField","rotationInfo.field","proportionalSymbolInfo.field","proportionalSymbolInfo.normalizationField","colorInfo.field","colorInfo.normalizationField"],Q9e=["field","normalizationField"];function ak(t,e){if(t!=null&&e!=null){for(const r of Array.isArray(t)?t:[t])if(Ane(J9e,r,e),"visualVariables"in r&&r.visualVariables)for(const i of r.visualVariables)Ane(Q9e,i,e)}}function Ane(t,e,r){if(t)for(const i of t){const s=Ky(i,e),n=s&&typeof s!="function"&&r.get(s);n&&Ul(i,n.name,e)}}function Abe(t,e){if(t!=null&&e?.fields?.length)if("startField"in t){const r=e.get(t.startField),i=e.get(t.endField);t.startField=r?.name??null,t.endField=i?.name??null}else{const r=e.get(t.startTimeField),i=e.get(t.endTimeField);t.startTimeField=r?.name??null,t.endTimeField=i?.name??null}}const T9=new Set;function KP(t,e){return t&&e?(T9.clear(),GI(T9,t,e),Array.from(T9).sort()):[]}function GI(t,e,r){if(r)if(e?.fields?.length)if(r.includes("*"))for(const{name:i}of e.fields)t.add(i);else for(const i of r)gh(t,e,i);else{if(r.includes("*"))return t.clear(),void t.add("*");for(const i of r)i!=null&&t.add(i)}}function gh(t,e,r){if(typeof r=="string")if(e){const i=e.get(r);i&&t.add(i.name)}else t.add(r)}function K9e(t,e){return e==null||t==null?[]:e.includes("*")?(t.fields??[]).map(r=>r.name):e}async function Ec(t,e,r){if(!r)return;const{arcadeUtils:i}=await If(),s=i.extractFieldNames(r,e?.fields?.map(n=>n.name));for(const n of s)gh(t,e,n)}async function Obe(t,e,r){if(r&&r!=="1=1"){const{WhereClause:i}=await J(()=>import("./WhereClause-dc16111f.js").then(n=>n.W),[],import.meta.url),s=i.create(r,e);if(!s.isStandardized)throw new D("fieldUtils:collectFilterFields","Where clause is not standardized",{where:r});GI(t,e,s.fieldNames)}}function HQ({displayField:t,fields:e}){return t||(e&&e.length?S9(e,"name-or-title")||S9(e,"unique-identifier")||S9(e,"type-or-category")||eze(e):null)}function eze(t){for(const e of t){if(!e||!e.name)continue;const r=e.name.toLowerCase();if(r.includes("name")||r.includes("title"))return e.name}return null}function S9(t,e){for(const r of t)if(r&&r.valueType&&r.valueType===e)return r.name;return null}async function eFt(t,e){if(!e)return;const r=e.elevationInfo?.featureExpressionInfo;return r?r.collectRequiredFields(t,e.fieldsIndex):void 0}function tze(t,e,r){r.onStatisticExpression?Ec(t,e,r.onStatisticExpression.expression):t.add(r.onStatisticField)}async function tFt(t,e,r){if(!e||!r||!("fields"in r))return;const i=[],s=r.popupTemplate;i.push(rze(t,e,s)),r.fields&&i.push(...r.fields.map(async n=>tze(t,e.fieldsIndex,n))),await Promise.all(i)}async function rze(t,e,r){const i=[];r?.expressionInfos&&i.push(...r.expressionInfos.map(n=>Ec(t,e.fieldsIndex,n.expression)));const s=r?.content;if(Array.isArray(s))for(const n of s)n.type==="expression"&&n.expressionInfo&&i.push(Ec(t,e.fieldsIndex,n.expressionInfo.expression));await Promise.all(i)}async function rFt(t,e,r){e&&(e.timeInfo&&r!=null&&r.timeExtent&&GI(t,e.fieldsIndex,[e.timeInfo.startField,e.timeInfo.endField]),e.floorInfo&&GI(t,e.fieldsIndex,[e.floorInfo.floorField]),r!=null&&r.where!=null&&await Obe(t,e.fieldsIndex,r.where))}async function iFt(t,e,r){e&&r&&await Promise.all(r.map(i=>ize(t,e,i)))}async function ize(t,e,r){e&&r&&(r.valueExpression?await Ec(t,e.fieldsIndex,r.valueExpression):r.field&&gh(t,e.fieldsIndex,r.field))}function sze(t){return t?KP(t.fieldsIndex,Rbe(t)):[]}function nze(t){if(!t)return[];const e=t.geometryFieldsInfo;return e?KP(t.fieldsIndex,[e.shapeAreaField,e.shapeLengthField]):[]}const oze=["oid","global-id","guid"],aze=["oid","global-id"],lze=[/^fnode_$/i,/^tnode_$/i,/^lpoly_$/i,/^rpoly_$/i,/^poly_$/i,/^subclass$/i,/^subclass_$/i,/^rings_ok$/i,/^rings_nok$/i,/shape/i,/perimeter/i,/objectid/i,/_i$/i];function cze(t){const e=new Set;qQ(t).forEach(i=>e.add(i)),nze(t).forEach(i=>e.add(i.toLowerCase()));const r=t&&"infoFor3D"in t?t.infoFor3D:void 0;return r&&(Object.values(r.assetMapFieldRoles).forEach(i=>e.add(i.toLowerCase())),Object.values(r.transformFieldRoles).forEach(i=>e.add(i.toLowerCase()))),Array.from(e)}function Rbe(t){if(!t)return[];const e="editFieldsInfo"in t&&t.editFieldsInfo;if(!e)return[];const{creationDateField:r,creatorField:i,editDateField:s,editorField:n}=e;return[r,i,s,n].filter(Boolean)}function qQ(t){return Rbe(t).map(e=>e.toLowerCase())}function uze(t,e){return t.editable&&!oze.includes(t.type)&&!qQ(e).includes(t.name?.toLowerCase()??"")}function Mbe(t,e){const r=t.name?.toLowerCase()??"";return!(e?.objectIdField!=null&&r===e.objectIdField.toLowerCase()||e?.globalIdField!=null&&r===e.globalIdField.toLowerCase()||cze(e).includes(r)||aze.includes(t.type)||lze.some(i=>i.test(r)))}async function sFt(t,e){const{labelingInfo:r,fieldsIndex:i}=e;r&&r.length&&await Promise.all(r.map(s=>hze(t,i,s)))}async function hze(t,e,r){if(!r)return;const i=r.getLabelExpression(),s=r.where;if(i.type==="arcade")await Ec(t,e,i.expression);else{const n=i.expression.match(/{[^}]*}/g);n&&n.forEach(o=>{gh(t,e,o.slice(1,-1))})}await Obe(t,e,s)}function dze(t){const e=t.defaultValue;return e!==void 0&&$be(t,e)?e:t.nullable?null:void 0}function Ibe(t){return typeof t=="number"&&!isNaN(t)&&isFinite(t)}function pze(t){return t===null||Ibe(t)}const WQ="isInteger"in Number?Number.isInteger:t=>typeof t=="number"&&isFinite(t)&&Math.floor(t)===t;function fze(t){return t===null||WQ(t)}function Pbe(t){return t!=null&&typeof t=="string"}function mze(t){return t===null||Pbe(t)}function gze(){return!0}function $be(t,e){let r;switch(t.type){case"date":case"integer":case"long":case"small-integer":case"esriFieldTypeDate":case"esriFieldTypeInteger":case"esriFieldTypeLong":case"esriFieldTypeSmallInteger":r=t.nullable?fze:WQ;break;case"double":case"single":case"esriFieldTypeSingle":case"esriFieldTypeDouble":r=t.nullable?pze:Ibe;break;case"string":case"esriFieldTypeString":r=t.nullable?mze:Pbe;break;default:r=gze}return arguments.length===1?r:r(e)}const yze=["integer","small-integer","single","double"],_ze=new Set([...yze,"esriFieldTypeInteger","esriFieldTypeSmallInteger","esriFieldTypeSingle","esriFieldTypeDouble"]),vze=["date","date-only","time-only","timestamp-offset"],bze=new Set([...vze,"esriFieldTypeDate","esriFieldTypeDateOnly","esriFieldTypeTimeOnly","esriFieldTypeTimestampOffset"]);function eT(t){return t!=null&&_ze.has(t.type)}function One(t){return t!=null&&(t.type==="string"||t.type==="esriFieldTypeString")}function w7(t){return t!=null&&bze.has(t.type)}var jI,iA;function nFt(t){return t==null||typeof t=="number"&&isNaN(t)?null:t}function wze(t,e){return t==null||t.nullable&&e===null?null:eT(t)&&!xze(t.type,Number(e))?jI.OUT_OF_RANGE:$be(t,e)?t.domain?f1e(t.domain,e):null:iA.INVALID_TYPE}function xze(t,e){const r=typeof t=="string"?ZQ(t):t;if(!r)return!1;const i=r.min,s=r.max;return r.isInteger?WQ(e)&&e>=i&&e<=s:e>=i&&e<=s}function Lbe(t){return dQ(t.domain)||(eT(t)?ZQ(t.type):void 0)}function ZQ(t){switch(t){case"esriFieldTypeSmallInteger":case"small-integer":return Tze;case"esriFieldTypeInteger":case"integer":return Sze;case"esriFieldTypeBigInteger":case"big-integer":return Eze;case"esriFieldTypeSingle":case"single":return Cze;case"esriFieldTypeDouble":case"double":return Aze}}(function(t){t.OUT_OF_RANGE="numeric-range-validation-error::out-of-range"})(jI||(jI={})),function(t){t.INVALID_TYPE="type-validation-error::invalid-type"}(iA||(iA={}));const Tze={min:-32768,max:32767,isInteger:!0},Sze={min:-2147483648,max:2147483647,isInteger:!0},Eze={min:-Number.MAX_SAFE_INTEGER,max:Number.MAX_SAFE_INTEGER,isInteger:!0},Cze={min:-34e37,max:12e37,isInteger:!1},Aze={min:-Number.MAX_VALUE,max:Number.MAX_VALUE,isInteger:!1};function oFt(t,e,r){switch(t){case L1.INVALID_CODED_VALUE:return`Value ${r} is not in the coded domain - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case L1.VALUE_OUT_OF_RANGE:return`Value ${r} is out of the range of valid values - field: ${e.name}, domain: ${JSON.stringify(e.domain)}`;case iA.INVALID_TYPE:return`Value ${r} is not a valid value for the field type - field: ${e.name}, type: ${e.type}, nullable: ${e.nullable}`;case jI.OUT_OF_RANGE:{const{min:i,max:s}=ZQ(e.type);return`Value ${r} is out of range for the number type - field: ${e.name}, type: ${e.type}, value range is ${i} to ${s}`}}}function Oze(t,e){return!Rze(t,e,null)}function Rze(t,e,r){if(!e||!e.attributes||!t){if(r!=null)for(const n of t??[])r.add(n);return!0}const i=e.attributes;let s=!1;for(const n of t)if(!(n in i)){if(s=!0,r==null)break;r.add(n)}return s}function x7(t){return!!t&&["raster.itempixelvalue","raster.servicepixelvalue"].some(e=>t.toLowerCase().startsWith(e))}var sA;(function(t){t[t.KILOBYTES=1024]="KILOBYTES",t[t.MEGABYTES=1048576]="MEGABYTES",t[t.GIGABYTES=1073741824]="GIGABYTES"})(sA||(sA={}));let F1=class{constructor(e,r){this.min=e,this.max=r,this.range=r-e}ndiff(e,r=0){return Math.ceil((e-r)/this.range)*this.range+r}_normalize(e,r,i,s=0,n=!1){return(i-=s)<e?i+=this.ndiff(e-i):i>r&&(i-=this.ndiff(i-r)),n&&i===r&&(i=e),i+s}normalize(e,r=0,i=!1){return this._normalize(this.min,this.max,e,r,i)}clamp(e,r=0){return ye(e-r,this.min,this.max)+r}monotonic(e,r,i){return e<r?r:r+this.ndiff(e-r,i)}minimalMonotonic(e,r,i){return this._normalize(e,e+this.range,r,i)}center(e,r,i){return r=this.monotonic(e,r,i),this.normalize((e+r)/2,i)}diff(e,r,i){return this.monotonic(e,r,i)-e}shortestSignedDiff(e,r){e=this.normalize(e);const i=(r=this.normalize(r))-e,s=r<e?this.minimalMonotonic(e,r)-e:r-this.minimalMonotonic(r,e);return Math.abs(i)<Math.abs(s)?i:s}contains(e,r,i){return r=this.minimalMonotonic(e,r),(i=this.minimalMonotonic(e,i))>e&&i<r}};function XQ(t){for(const e in t){const r=t[e];r instanceof Function&&(t[e]=r.bind(t))}return t}const Mze=XQ(new F1(0,2*Math.PI)),k1=XQ(new F1(-Math.PI,Math.PI)),z6=XQ(new F1(0,360));function Dbe(t,e,r){return t.units[e][r]}function nO(t,e,r,i=2,s="abbr"){return`${zd(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:e>0?"never":"exceptZero"})} ${Dbe(t,r,s)}`}function B6(t,e,r,i=2,s="abbr"){return`${zd(e,{minimumFractionDigits:i,maximumFractionDigits:i,signDisplay:"exceptZero"})} ${Dbe(t,r,s)}`}function lFt(t,e,r,i=2,s="abbr"){const n=wQ(e,r);return nO(t,Ci(e,r,n),n,i,s)}function cFt(t,e,r,i=2,s="abbr"){const n=wQ(e,r);return B6(t,Ci(e,r,n),n,i,s)}function uFt(t,e,r,i=2,s="abbr"){const n=xQ(e,r);return nO(t,Ci(e,r,n),n,i,s)}function hFt(t,e,r,i=2,s="abbr"){const n=xQ(e,r);return B6(t,Ci(e,r,n),n,i,s)}function dFt(t,e,r,i=2,s="abbr"){const n=TQ(e,r);return nO(t,Ci(e,r,n),n,i,s)}function pFt(t,e,r,i=2,s="abbr"){const n=TQ(e,r);return B6(t,Ci(e,r,n),n,i,s)}function fFt(t,e,r,i=2,s="abbr"){const n=SQ(e,r);return nO(t,Ci(e,r,n),n,i,s)}function mFt(t,e,r,i=2,s="abbr"){const n=SQ(e,r);return B6(t,Ci(e,r,n),n,i,s)}function gFt(t,e,r,i=2,s="abbr"){const n=e8e(e,r);return nO(t,Ci(e,r,n),n,i,s)}function yFt(t,e,r,i=2,s="abbr"){const n=t8e(e,r);return nO(t,Ci(e,r,n),n,i,s)}function _Ft(t,e,r,i,s){s=s??2;let n=z6.normalize(Ize(Ci(t,e,"degrees"),r,i),0,!0);const o={style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:s,minimumFractionDigits:s,signDisplay:n>0?"never":"exceptZero"};return n=Nbe(n,o),zd(n,o)}function vFt(t,e,r,i,s){r!==i&&(t=-t);const n={style:"unit",unitDisplay:"narrow",unit:"degree",maximumFractionDigits:s=s??2,minimumFractionDigits:s,signDisplay:"exceptZero"};let o=Ci(t,e,"degrees")%360;return o=Nbe(o,n),zd(o,n)}const Rne=new Map;function Nbe(t,e){const r=JSON.stringify(e);let i=Rne.get(r);return i||(i=new Intl.NumberFormat("en-US",e),Rne.set(r,i)),/\-?\+?360/.test(i.format(t))?0:t}function Ize(t,e,r){if(e===r)return t;switch(r){case"arithmetic":return Pze(t);case"geographic":return $ze(t)}}function Pze(t){return 90-t}function $ze(t){return-t-90}const Mne=["B","kB","MB","GB","TB"];function Lze(t,e){let r=e===0?0:Math.floor(Math.log(e)/Math.log(sA.KILOBYTES));r=ye(r,0,Mne.length-1);const i=zd(e/sA.KILOBYTES**r,{maximumFractionDigits:2});return fg(t.units.bytes[Mne[r]],{fileSize:i})}function G6(t){return typeof t=="string"?document.getElementById(t):t??null}function Fbe(t){for(;t.hasChildNodes();)t.removeChild(t.firstChild)}function Ine(t,e){const r=e.parentNode;r&&r.insertBefore(t,e)}function Pne(t,e){for(;;){const r=t.firstChild;if(!r)break;e.appendChild(r)}}let RF=class kbe{constructor(){this._emitter=new kbe.EventEmitter(this)}emit(e,r){return this._emitter.emit(e,r)}on(e,r){return this._emitter.on(e,r)}once(e,r){return this._emitter.once(e,r)}hasEventListener(e){return this._emitter.hasEventListener(e)}};(function(t){class e{constructor(s=null){this._target=s,this._listenersMap=null}clear(){this._listenersMap?.clear(),this._listenersMap=null}destroy(){this.clear()}emit(s,n){const o=this._listenersMap&&this._listenersMap.get(s);if(!o)return!1;const a=this._target||this;return[...o].forEach(l=>{l.call(a,n)}),o.length>0}on(s,n){if(Array.isArray(s)){const a=s.map(l=>this.on(l,n));return Sc(a)}if(s.includes(","))throw new TypeError("Evented.on() with a comma delimited string of event types is not supported");this._listenersMap||(this._listenersMap=new Map);const o=this._listenersMap.get(s)||[];return o.push(n),this._listenersMap.set(s,o),{remove:()=>{const a=this._listenersMap&&this._listenersMap.get(s)||[],l=a.indexOf(n);l>=0&&a.splice(l,1)}}}once(s,n){const o=this.on(s,a=>{o.remove(),n.call(null,a)});return o}hasEventListener(s){const n=this._listenersMap&&this._listenersMap.get(s);return n!=null&&n.length>0}}t.EventEmitter=e,t.EventedMixin=i=>{let s=class extends i{constructor(){super(...arguments),this._emitter=new e}destroy(){this._emitter.clear()}emit(n,o){return this._emitter.emit(n,o)}on(n,o){return this._emitter.on(n,o)}once(n,o){return this._emitter.once(n,o)}hasEventListener(n){return this._emitter.hasEventListener(n)}};return s=u([R("esri.core.Evented")],s),s};let r=class extends me{constructor(){super(...arguments),this._emitter=new RF.EventEmitter(this)}destroy(){this._emitter.clear()}emit(i,s){return this._emitter.emit(i,s)}on(i,s){return this._emitter.on(i,s)}once(i,s){return this._emitter.once(i,s)}hasEventListener(i){return this._emitter.hasEventListener(i)}};r=u([R("esri.core.Evented")],r),t.EventedAccessor=r})(RF||(RF={}));const Xr=RF;var Lv;(function(t){t[t.PENDING=0]="PENDING",t[t.RESOLVED=1]="RESOLVED",t[t.REJECTED=2]="REJECTED"})(Lv||(Lv={}));let Dze=class{constructor(){this._resolver=nn(),this._status=Lv.PENDING,this._resolvingPromises=[],this._resolver.promise.then(()=>{this._status=Lv.RESOLVED,this._cleanUp()},()=>{this._status=Lv.REJECTED,this._cleanUp()}),this.promise=this._resolver.promise}destroy(){this._cleanUp()}addResolvingPromise(e){this._resolvingPromises.push(e),this._tryResolve()}isResolved(){return this._status===Lv.RESOLVED}isRejected(){return this._status===Lv.REJECTED}isFulfilled(){return this._status!==Lv.PENDING}abort(){this._resolver.reject(Tr())}_cleanUp(){this._allPromise=null,this._resolvingPromises=null}_tryResolve(){if(this.isFulfilled())return;const e=nn(),r=[...this._resolvingPromises,e.promise],i=this._allPromise=Promise.all(r);i.then(()=>{this.isFulfilled()||this._allPromise!==i||this._resolver.resolve()},s=>{this.isFulfilled()||this._allPromise!==i||ws(s)||this._resolver.reject(s)}),e.resolve()}};const e$=t=>{let e=class extends t{constructor(...r){super(...r),this._promiseProps=new Dze,this.addResolvingPromise(Promise.resolve())}destroy(){this._promiseProps?.destroy()}isResolved(){return this._promiseProps.isResolved()}isRejected(){return this._promiseProps.isRejected()}isFulfilled(){return this._promiseProps.isFulfilled()}when(r,i){return this._promiseProps.promise.then(()=>this).then(r,i)}catch(r){return this.when(null,r)}addResolvingPromise(r){r&&!this._promiseProps.isFulfilled()&&this._promiseProps.addResolvingPromise("_promiseProps"in r?r.when():r)}};return e=u([R("esri.core.Promise")],e),e};let lk=class extends e$(me){};lk=u([R("esri.core.Promise")],lk);const Nze="randomUUID"in crypto;function j6(){if(Nze)return crypto.randomUUID();const t=crypto.getRandomValues(new Uint16Array(8));t[3]=4095&t[3]|16384,t[4]=16383&t[4]|32768;const e=r=>t[r].toString(16).padStart(4,"0");return e(0)+e(1)+"-"+e(2)+"-"+e(3)+"-"+e(4)+"-"+e(5)+e(6)+e(7)}function $ne(){return`{${j6()}}`}/*!
 * @esri/arcgis-html-sanitizer - v3.0.1 - Tue Nov 15 2022 09:46:54 GMT-0800 (Pacific Standard Time)
 * Copyright (c) 2022 - Environmental Systems Research Institute, Inc.
 * Apache-2.0
 * 
 * js-xss
 * Copyright (c) 2012-2018 Zongmin Lei(雷宗民) <leizongmin@gmail.com>
 * http://ucdok.com
 * MIT License, see https://github.com/leizongmin/js-xss/blob/master/LICENSE for details
 */var Fze=function(t){if(typeof t!="object"||t===null||Object.prototype.toString.call(t)!=="[object Object]")return!1;var e=Object.getPrototypeOf(t);if(e===null)return!0;for(;Object.getPrototypeOf(e)!==null;)e=Object.getPrototypeOf(e);return Object.getPrototypeOf(t)===e},yx={exports:{}},En={},HI={exports:{}},oS={};function Ube(){var t={};return t["align-content"]=!1,t["align-items"]=!1,t["align-self"]=!1,t["alignment-adjust"]=!1,t["alignment-baseline"]=!1,t.all=!1,t["anchor-point"]=!1,t.animation=!1,t["animation-delay"]=!1,t["animation-direction"]=!1,t["animation-duration"]=!1,t["animation-fill-mode"]=!1,t["animation-iteration-count"]=!1,t["animation-name"]=!1,t["animation-play-state"]=!1,t["animation-timing-function"]=!1,t.azimuth=!1,t["backface-visibility"]=!1,t.background=!0,t["background-attachment"]=!0,t["background-clip"]=!0,t["background-color"]=!0,t["background-image"]=!0,t["background-origin"]=!0,t["background-position"]=!0,t["background-repeat"]=!0,t["background-size"]=!0,t["baseline-shift"]=!1,t.binding=!1,t.bleed=!1,t["bookmark-label"]=!1,t["bookmark-level"]=!1,t["bookmark-state"]=!1,t.border=!0,t["border-bottom"]=!0,t["border-bottom-color"]=!0,t["border-bottom-left-radius"]=!0,t["border-bottom-right-radius"]=!0,t["border-bottom-style"]=!0,t["border-bottom-width"]=!0,t["border-collapse"]=!0,t["border-color"]=!0,t["border-image"]=!0,t["border-image-outset"]=!0,t["border-image-repeat"]=!0,t["border-image-slice"]=!0,t["border-image-source"]=!0,t["border-image-width"]=!0,t["border-left"]=!0,t["border-left-color"]=!0,t["border-left-style"]=!0,t["border-left-width"]=!0,t["border-radius"]=!0,t["border-right"]=!0,t["border-right-color"]=!0,t["border-right-style"]=!0,t["border-right-width"]=!0,t["border-spacing"]=!0,t["border-style"]=!0,t["border-top"]=!0,t["border-top-color"]=!0,t["border-top-left-radius"]=!0,t["border-top-right-radius"]=!0,t["border-top-style"]=!0,t["border-top-width"]=!0,t["border-width"]=!0,t.bottom=!1,t["box-decoration-break"]=!0,t["box-shadow"]=!0,t["box-sizing"]=!0,t["box-snap"]=!0,t["box-suppress"]=!0,t["break-after"]=!0,t["break-before"]=!0,t["break-inside"]=!0,t["caption-side"]=!1,t.chains=!1,t.clear=!0,t.clip=!1,t["clip-path"]=!1,t["clip-rule"]=!1,t.color=!0,t["color-interpolation-filters"]=!0,t["column-count"]=!1,t["column-fill"]=!1,t["column-gap"]=!1,t["column-rule"]=!1,t["column-rule-color"]=!1,t["column-rule-style"]=!1,t["column-rule-width"]=!1,t["column-span"]=!1,t["column-width"]=!1,t.columns=!1,t.contain=!1,t.content=!1,t["counter-increment"]=!1,t["counter-reset"]=!1,t["counter-set"]=!1,t.crop=!1,t.cue=!1,t["cue-after"]=!1,t["cue-before"]=!1,t.cursor=!1,t.direction=!1,t.display=!0,t["display-inside"]=!0,t["display-list"]=!0,t["display-outside"]=!0,t["dominant-baseline"]=!1,t.elevation=!1,t["empty-cells"]=!1,t.filter=!1,t.flex=!1,t["flex-basis"]=!1,t["flex-direction"]=!1,t["flex-flow"]=!1,t["flex-grow"]=!1,t["flex-shrink"]=!1,t["flex-wrap"]=!1,t.float=!1,t["float-offset"]=!1,t["flood-color"]=!1,t["flood-opacity"]=!1,t["flow-from"]=!1,t["flow-into"]=!1,t.font=!0,t["font-family"]=!0,t["font-feature-settings"]=!0,t["font-kerning"]=!0,t["font-language-override"]=!0,t["font-size"]=!0,t["font-size-adjust"]=!0,t["font-stretch"]=!0,t["font-style"]=!0,t["font-synthesis"]=!0,t["font-variant"]=!0,t["font-variant-alternates"]=!0,t["font-variant-caps"]=!0,t["font-variant-east-asian"]=!0,t["font-variant-ligatures"]=!0,t["font-variant-numeric"]=!0,t["font-variant-position"]=!0,t["font-weight"]=!0,t.grid=!1,t["grid-area"]=!1,t["grid-auto-columns"]=!1,t["grid-auto-flow"]=!1,t["grid-auto-rows"]=!1,t["grid-column"]=!1,t["grid-column-end"]=!1,t["grid-column-start"]=!1,t["grid-row"]=!1,t["grid-row-end"]=!1,t["grid-row-start"]=!1,t["grid-template"]=!1,t["grid-template-areas"]=!1,t["grid-template-columns"]=!1,t["grid-template-rows"]=!1,t["hanging-punctuation"]=!1,t.height=!0,t.hyphens=!1,t.icon=!1,t["image-orientation"]=!1,t["image-resolution"]=!1,t["ime-mode"]=!1,t["initial-letters"]=!1,t["inline-box-align"]=!1,t["justify-content"]=!1,t["justify-items"]=!1,t["justify-self"]=!1,t.left=!1,t["letter-spacing"]=!0,t["lighting-color"]=!0,t["line-box-contain"]=!1,t["line-break"]=!1,t["line-grid"]=!1,t["line-height"]=!1,t["line-snap"]=!1,t["line-stacking"]=!1,t["line-stacking-ruby"]=!1,t["line-stacking-shift"]=!1,t["line-stacking-strategy"]=!1,t["list-style"]=!0,t["list-style-image"]=!0,t["list-style-position"]=!0,t["list-style-type"]=!0,t.margin=!0,t["margin-bottom"]=!0,t["margin-left"]=!0,t["margin-right"]=!0,t["margin-top"]=!0,t["marker-offset"]=!1,t["marker-side"]=!1,t.marks=!1,t.mask=!1,t["mask-box"]=!1,t["mask-box-outset"]=!1,t["mask-box-repeat"]=!1,t["mask-box-slice"]=!1,t["mask-box-source"]=!1,t["mask-box-width"]=!1,t["mask-clip"]=!1,t["mask-image"]=!1,t["mask-origin"]=!1,t["mask-position"]=!1,t["mask-repeat"]=!1,t["mask-size"]=!1,t["mask-source-type"]=!1,t["mask-type"]=!1,t["max-height"]=!0,t["max-lines"]=!1,t["max-width"]=!0,t["min-height"]=!0,t["min-width"]=!0,t["move-to"]=!1,t["nav-down"]=!1,t["nav-index"]=!1,t["nav-left"]=!1,t["nav-right"]=!1,t["nav-up"]=!1,t["object-fit"]=!1,t["object-position"]=!1,t.opacity=!1,t.order=!1,t.orphans=!1,t.outline=!1,t["outline-color"]=!1,t["outline-offset"]=!1,t["outline-style"]=!1,t["outline-width"]=!1,t.overflow=!1,t["overflow-wrap"]=!1,t["overflow-x"]=!1,t["overflow-y"]=!1,t.padding=!0,t["padding-bottom"]=!0,t["padding-left"]=!0,t["padding-right"]=!0,t["padding-top"]=!0,t.page=!1,t["page-break-after"]=!1,t["page-break-before"]=!1,t["page-break-inside"]=!1,t["page-policy"]=!1,t.pause=!1,t["pause-after"]=!1,t["pause-before"]=!1,t.perspective=!1,t["perspective-origin"]=!1,t.pitch=!1,t["pitch-range"]=!1,t["play-during"]=!1,t.position=!1,t["presentation-level"]=!1,t.quotes=!1,t["region-fragment"]=!1,t.resize=!1,t.rest=!1,t["rest-after"]=!1,t["rest-before"]=!1,t.richness=!1,t.right=!1,t.rotation=!1,t["rotation-point"]=!1,t["ruby-align"]=!1,t["ruby-merge"]=!1,t["ruby-position"]=!1,t["shape-image-threshold"]=!1,t["shape-outside"]=!1,t["shape-margin"]=!1,t.size=!1,t.speak=!1,t["speak-as"]=!1,t["speak-header"]=!1,t["speak-numeral"]=!1,t["speak-punctuation"]=!1,t["speech-rate"]=!1,t.stress=!1,t["string-set"]=!1,t["tab-size"]=!1,t["table-layout"]=!1,t["text-align"]=!0,t["text-align-last"]=!0,t["text-combine-upright"]=!0,t["text-decoration"]=!0,t["text-decoration-color"]=!0,t["text-decoration-line"]=!0,t["text-decoration-skip"]=!0,t["text-decoration-style"]=!0,t["text-emphasis"]=!0,t["text-emphasis-color"]=!0,t["text-emphasis-position"]=!0,t["text-emphasis-style"]=!0,t["text-height"]=!0,t["text-indent"]=!0,t["text-justify"]=!0,t["text-orientation"]=!0,t["text-overflow"]=!0,t["text-shadow"]=!0,t["text-space-collapse"]=!0,t["text-transform"]=!0,t["text-underline-position"]=!0,t["text-wrap"]=!0,t.top=!1,t.transform=!1,t["transform-origin"]=!1,t["transform-style"]=!1,t.transition=!1,t["transition-delay"]=!1,t["transition-duration"]=!1,t["transition-property"]=!1,t["transition-timing-function"]=!1,t["unicode-bidi"]=!1,t["vertical-align"]=!1,t.visibility=!1,t["voice-balance"]=!1,t["voice-duration"]=!1,t["voice-family"]=!1,t["voice-pitch"]=!1,t["voice-range"]=!1,t["voice-rate"]=!1,t["voice-stress"]=!1,t["voice-volume"]=!1,t.volume=!1,t["white-space"]=!1,t.widows=!1,t.width=!0,t["will-change"]=!1,t["word-break"]=!0,t["word-spacing"]=!0,t["word-wrap"]=!0,t["wrap-flow"]=!1,t["wrap-through"]=!1,t["writing-mode"]=!1,t["z-index"]=!1,t}function kze(t,e,r){}function Uze(t,e,r){}var Vze=/javascript\s*\:/img;function zze(t,e){return Vze.test(e)?"":e}oS.whiteList=Ube();oS.getDefaultWhiteList=Ube;oS.onAttr=kze;oS.onIgnoreAttr=Uze;oS.safeAttrValue=zze;var Bze={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},trimRight:function(t){return String.prototype.trimRight?t.trimRight():t.replace(/(\s*$)/g,"")}},jO=Bze;function Gze(t,e){t=jO.trimRight(t),t[t.length-1]!==";"&&(t+=";");var r=t.length,i=!1,s=0,n=0,o="";function a(){if(!i){var h=jO.trim(t.slice(s,n)),p=h.indexOf(":");if(p!==-1){var f=jO.trim(h.slice(0,p)),m=jO.trim(h.slice(p+1));if(f){var g=e(s,o.length,f,m,h);g&&(o+=g+"; ")}}}s=n+1}for(;n<r;n++){var l=t[n];if(l==="/"&&t[n+1]==="*"){var c=t.indexOf("*/",n+2);if(c===-1)break;n=c+1,s=n+1,i=!1}else l==="("?i=!0:l===")"?i=!1:l===";"?i||a():l===`
`&&a()}return jO.trim(o)}var jze=Gze,cL=oS,Hze=jze;function Lne(t){return t==null}function qze(t){var e={};for(var r in t)e[r]=t[r];return e}function Vbe(t){t=qze(t||{}),t.whiteList=t.whiteList||cL.whiteList,t.onAttr=t.onAttr||cL.onAttr,t.onIgnoreAttr=t.onIgnoreAttr||cL.onIgnoreAttr,t.safeAttrValue=t.safeAttrValue||cL.safeAttrValue,this.options=t}Vbe.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onAttr,n=r.onIgnoreAttr,o=r.safeAttrValue,a=Hze(t,function(l,c,h,p,f){var m=i[h],g=!1;if(m===!0?g=m:typeof m=="function"?g=m(p):m instanceof RegExp&&(g=m.test(p)),g!==!0&&(g=!1),p=o(h,p),!!p){var _={position:c,sourcePosition:l,source:f,isWhite:g};if(g){var v=s(h,p,_);return Lne(v)?h+":"+p:v}else{var v=n(h,p,_);if(!Lne(v))return v}}});return a};var Wze=Vbe;(function(t,e){var r=oS,i=Wze;function s(o,a){var l=new i(a);return l.process(o)}e=t.exports=s,e.FilterCSS=i;for(var n in r)e[n]=r[n]})(HI,HI.exports);var YQ={indexOf:function(t,e){var r,i;if(Array.prototype.indexOf)return t.indexOf(e);for(r=0,i=t.length;r<i;r++)if(t[r]===e)return r;return-1},forEach:function(t,e,r){var i,s;if(Array.prototype.forEach)return t.forEach(e,r);for(i=0,s=t.length;i<s;i++)e.call(r,t[i],i,t)},trim:function(t){return String.prototype.trim?t.trim():t.replace(/(^\s*)|(\s*$)/g,"")},spaceIndex:function(t){var e=/\s|\n|\t/,r=e.exec(t);return r?r.index:-1}},Zze=HI.exports.FilterCSS,Xze=HI.exports.getDefaultWhiteList,ck=YQ;function zbe(){return{a:["target","href","title"],abbr:["title"],address:[],area:["shape","coords","href","alt"],article:[],aside:[],audio:["autoplay","controls","crossorigin","loop","muted","preload","src"],b:[],bdi:["dir"],bdo:["dir"],big:[],blockquote:["cite"],br:[],caption:[],center:[],cite:[],code:[],col:["align","valign","span","width"],colgroup:["align","valign","span","width"],dd:[],del:["datetime"],details:["open"],div:[],dl:[],dt:[],em:[],figcaption:[],figure:[],font:["color","size","face"],footer:[],h1:[],h2:[],h3:[],h4:[],h5:[],h6:[],header:[],hr:[],i:[],img:["src","alt","title","width","height"],ins:["datetime"],li:[],mark:[],nav:[],ol:[],p:[],pre:[],s:[],section:[],small:[],span:[],sub:[],summary:[],sup:[],strong:[],strike:[],table:["width","border","align","valign"],tbody:["align","valign"],td:["width","rowspan","colspan","align","valign"],tfoot:["align","valign"],th:["width","rowspan","colspan","align","valign"],thead:["align","valign"],tr:["rowspan","align","valign"],tt:[],u:[],ul:[],video:["autoplay","controls","crossorigin","loop","muted","playsinline","poster","preload","src","height","width"]}}var Bbe=new Zze;function Yze(t,e,r){}function Jze(t,e,r){}function Qze(t,e,r){}function Kze(t,e,r){}function Gbe(t){return t.replace(tBe,"&lt;").replace(rBe,"&gt;")}function eBe(t,e,r,i){if(r=Xbe(r),e==="href"||e==="src"){if(r=ck.trim(r),r==="#")return"#";if(!(r.substr(0,7)==="http://"||r.substr(0,8)==="https://"||r.substr(0,7)==="mailto:"||r.substr(0,4)==="tel:"||r.substr(0,11)==="data:image/"||r.substr(0,6)==="ftp://"||r.substr(0,2)==="./"||r.substr(0,3)==="../"||r[0]==="#"||r[0]==="/"))return""}else if(e==="background"){if(uL.lastIndex=0,uL.test(r))return""}else if(e==="style"){if(Dne.lastIndex=0,Dne.test(r)||(Nne.lastIndex=0,Nne.test(r)&&(uL.lastIndex=0,uL.test(r))))return"";i!==!1&&(i=i||Bbe,r=i.process(r))}return r=Ybe(r),r}var tBe=/</g,rBe=/>/g,iBe=/"/g,sBe=/&quot;/g,nBe=/&#([a-zA-Z0-9]*);?/gim,oBe=/&colon;?/gim,aBe=/&newline;?/gim,uL=/((j\s*a\s*v\s*a|v\s*b|l\s*i\s*v\s*e)\s*s\s*c\s*r\s*i\s*p\s*t\s*|m\s*o\s*c\s*h\s*a):/gi,Dne=/e\s*x\s*p\s*r\s*e\s*s\s*s\s*i\s*o\s*n\s*\(.*/gi,Nne=/u\s*r\s*l\s*\(.*/gi;function jbe(t){return t.replace(iBe,"&quot;")}function Hbe(t){return t.replace(sBe,'"')}function qbe(t){return t.replace(nBe,function(r,i){return i[0]==="x"||i[0]==="X"?String.fromCharCode(parseInt(i.substr(1),16)):String.fromCharCode(parseInt(i,10))})}function Wbe(t){return t.replace(oBe,":").replace(aBe," ")}function Zbe(t){for(var e="",r=0,i=t.length;r<i;r++)e+=t.charCodeAt(r)<32?" ":t.charAt(r);return ck.trim(e)}function Xbe(t){return t=Hbe(t),t=qbe(t),t=Wbe(t),t=Zbe(t),t}function Ybe(t){return t=jbe(t),t=Gbe(t),t}function lBe(){return""}function cBe(t,e){typeof e!="function"&&(e=function(){});var r=!Array.isArray(t);function i(o){return r?!0:ck.indexOf(t,o)!==-1}var s=[],n=!1;return{onIgnoreTag:function(o,a,l){if(i(o))if(l.isClosing){var c="[/removed]",h=l.position+c.length;return s.push([n!==!1?n:l.position,h]),n=!1,c}else return n||(n=l.position),"[removed]";else return e(o,a,l)},remove:function(o){var a="",l=0;return ck.forEach(s,function(c){a+=o.slice(l,c[0]),l=c[1]}),a+=o.slice(l),a}}}function uBe(t){for(var e="",r=0;r<t.length;){var i=t.indexOf("<!--",r);if(i===-1){e+=t.slice(r);break}e+=t.slice(r,i);var s=t.indexOf("-->",i);if(s===-1)break;r=s+3}return e}function hBe(t){var e=t.split("");return e=e.filter(function(r){var i=r.charCodeAt(0);return i===127?!1:i<=31?i===10||i===13:!0}),e.join("")}En.whiteList=zbe();En.getDefaultWhiteList=zbe;En.onTag=Yze;En.onIgnoreTag=Jze;En.onTagAttr=Qze;En.onIgnoreTagAttr=Kze;En.safeAttrValue=eBe;En.escapeHtml=Gbe;En.escapeQuote=jbe;En.unescapeQuote=Hbe;En.escapeHtmlEntities=qbe;En.escapeDangerHtml5Entities=Wbe;En.clearNonPrintableCharacter=Zbe;En.friendlyAttrValue=Xbe;En.escapeAttrValue=Ybe;En.onIgnoreTagStripAll=lBe;En.StripTagBody=cBe;En.stripCommentTag=uBe;En.stripBlankChar=hBe;En.cssFilter=Bbe;En.getDefaultCSSWhiteList=Xze;var H6={},Dv=YQ;function dBe(t){var e=Dv.spaceIndex(t),r;return e===-1?r=t.slice(1,-1):r=t.slice(1,e+1),r=Dv.trim(r).toLowerCase(),r.slice(0,1)==="/"&&(r=r.slice(1)),r.slice(-1)==="/"&&(r=r.slice(0,-1)),r}function pBe(t){return t.slice(0,2)==="</"}function fBe(t,e,r){var i="",s=0,n=!1,o=!1,a=0,l=t.length,c="",h="";e:for(a=0;a<l;a++){var p=t.charAt(a);if(n===!1){if(p==="<"){n=a;continue}}else if(o===!1){if(p==="<"){i+=r(t.slice(s,a)),n=a,s=a;continue}if(p===">"){i+=r(t.slice(s,n)),h=t.slice(n,a+1),c=dBe(h),i+=e(n,i.length,c,h,pBe(h)),s=a+1,n=!1;continue}if(p==='"'||p==="'")for(var f=1,m=t.charAt(a-f);m.trim()===""||m==="=";){if(m==="="){o=p;continue e}m=t.charAt(a-++f)}}else if(p===o){o=!1;continue}}return s<t.length&&(i+=r(t.substr(s))),i}var mBe=/[^a-zA-Z0-9\\_:.-]/gim;function gBe(t,e){var r=0,i=0,s=[],n=!1,o=t.length;function a(f,m){if(f=Dv.trim(f),f=f.replace(mBe,"").toLowerCase(),!(f.length<1)){var g=e(f,m||"");g&&s.push(g)}}for(var l=0;l<o;l++){var c=t.charAt(l),h,p;if(n===!1&&c==="="){n=t.slice(r,l),r=l+1,i=t.charAt(r)==='"'||t.charAt(r)==="'"?r:_Be(t,l+1);continue}if(n!==!1&&l===i){if(p=t.indexOf(c,l+1),p===-1)break;h=Dv.trim(t.slice(i+1,p)),a(n,h),n=!1,l=p,r=l+1;continue}if(/\s|\n|\t/.test(c))if(t=t.replace(/\s|\n|\t/g," "),n===!1)if(p=yBe(t,l),p===-1){h=Dv.trim(t.slice(r,l)),a(h),n=!1,r=l+1;continue}else{l=p-1;continue}else if(p=vBe(t,l-1),p===-1){h=Dv.trim(t.slice(r,l)),h=Fne(h),a(n,h),n=!1,r=l+1;continue}else continue}return r<t.length&&(n===!1?a(t.slice(r)):a(n,Fne(Dv.trim(t.slice(r))))),Dv.trim(s.join(" "))}function yBe(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="="?e:-1}}function _Be(t,e){for(;e<t.length;e++){var r=t[e];if(r!==" ")return r==="'"||r==='"'?e:-1}}function vBe(t,e){for(;e>0;e--){var r=t[e];if(r!==" ")return r==="="?e:-1}}function bBe(t){return t[0]==='"'&&t[t.length-1]==='"'||t[0]==="'"&&t[t.length-1]==="'"}function Fne(t){return bBe(t)?t.substr(1,t.length-2):t}H6.parseTag=fBe;H6.parseAttr=gBe;var wBe=HI.exports.FilterCSS,Xp=En,Jbe=H6,xBe=Jbe.parseTag,TBe=Jbe.parseAttr,MF=YQ;function hL(t){return t==null}function SBe(t){var e=MF.spaceIndex(t);if(e===-1)return{html:"",closing:t[t.length-2]==="/"};t=MF.trim(t.slice(e+1,-1));var r=t[t.length-1]==="/";return r&&(t=MF.trim(t.slice(0,-1))),{html:t,closing:r}}function EBe(t){var e={};for(var r in t)e[r]=t[r];return e}function CBe(t){var e={};for(var r in t)Array.isArray(t[r])?e[r.toLowerCase()]=t[r].map(function(i){return i.toLowerCase()}):e[r.toLowerCase()]=t[r];return e}function Qbe(t){t=EBe(t||{}),t.stripIgnoreTag&&(t.onIgnoreTag&&console.error('Notes: cannot use these two options "stripIgnoreTag" and "onIgnoreTag" at the same time'),t.onIgnoreTag=Xp.onIgnoreTagStripAll),t.whiteList||t.allowList?t.whiteList=CBe(t.whiteList||t.allowList):t.whiteList=Xp.whiteList,t.onTag=t.onTag||Xp.onTag,t.onTagAttr=t.onTagAttr||Xp.onTagAttr,t.onIgnoreTag=t.onIgnoreTag||Xp.onIgnoreTag,t.onIgnoreTagAttr=t.onIgnoreTagAttr||Xp.onIgnoreTagAttr,t.safeAttrValue=t.safeAttrValue||Xp.safeAttrValue,t.escapeHtml=t.escapeHtml||Xp.escapeHtml,this.options=t,t.css===!1?this.cssFilter=!1:(t.css=t.css||{},this.cssFilter=new wBe(t.css))}Qbe.prototype.process=function(t){if(t=t||"",t=t.toString(),!t)return"";var e=this,r=e.options,i=r.whiteList,s=r.onTag,n=r.onIgnoreTag,o=r.onTagAttr,a=r.onIgnoreTagAttr,l=r.safeAttrValue,c=r.escapeHtml,h=e.cssFilter;r.stripBlankChar&&(t=Xp.stripBlankChar(t)),r.allowCommentTag||(t=Xp.stripCommentTag(t));var p=!1;r.stripIgnoreTagBody&&(p=Xp.StripTagBody(r.stripIgnoreTagBody,n),n=p.onIgnoreTag);var f=xBe(t,function(m,g,_,v,b){var x={sourcePosition:m,position:g,isClosing:b,isWhite:Object.prototype.hasOwnProperty.call(i,_)},T=s(_,v,x);if(!hL(T))return T;if(x.isWhite){if(x.isClosing)return"</"+_+">";var S=SBe(v),O=i[_],A=TBe(S.html,function(M,P){var F=MF.indexOf(O,M)!==-1,$=o(_,M,P,F);return hL($)?F?(P=l(_,M,P,h),P?M+'="'+P+'"':M):($=a(_,M,P,F),hL($)?void 0:$):$});return v="<"+_,A&&(v+=" "+A),S.closing&&(v+=" /"),v+=">",v}else return T=n(_,v,x),hL(T)?c(v):T},c);return p&&(f=p.remove(f)),f};var ABe=Qbe;(function(t,e){var r=En,i=H6,s=ABe;function n(a,l){var c=new s(l);return c.process(a)}e=t.exports=n,e.filterXSS=n,e.FilterXSS=s,function(){for(var a in r)e[a]=r[a];for(var l in i)e[l]=i[l]}();function o(){return typeof self<"u"&&typeof DedicatedWorkerGlobalScope<"u"&&self instanceof DedicatedWorkerGlobalScope}o()&&(self.filterXSS=t.exports)})(yx,yx.exports);var OBe=function(){function t(e,r){var i=this;this.arcgisWhiteList={a:["href","style","target"],abbr:["title"],audio:["autoplay","controls","loop","muted","preload"],b:[],br:[],dd:["style"],div:["align","style"],dl:["style"],dt:["style"],em:[],figcaption:["style"],figure:["style"],font:["color","face","size","style"],h1:["style"],h2:["style"],h3:["style"],h4:["style"],h5:["style"],h6:["style"],hr:[],i:[],img:["alt","border","height","src","style","width"],li:[],ol:[],p:["style"],source:["media","src","type"],span:["style"],strong:[],sub:["style"],sup:["style"],table:["border","cellpadding","cellspacing","height","style","width"],tbody:[],tr:["align","height","style","valign"],td:["align","colspan","height","nowrap","rowspan","style","valign","width"],th:["align","colspan","height","nowrap","rowspan","style","valign","width"],u:[],ul:[],video:["autoplay","controls","height","loop","muted","poster","preload","width"]},this.allowedProtocols=["http","https","mailto","iform","tel","flow","lfmobile","arcgis-navigator","arcgis-appstudio-player","arcgis-survey123","arcgis-collector","arcgis-workforce","arcgis-explorer","arcgis-trek2there","arcgis-quickcapture","mspbi","comgooglemaps","pdfefile","pdfehttp","pdfehttps","boxapp","boxemm","awb","awbs","gropen","radarscope"],this.arcgisFilterOptions={allowCommentTag:!0,safeAttrValue:function(n,o,a,l){return n==="a"&&o==="href"||(n==="img"||n==="source")&&o==="src"?i.sanitizeUrl(a):yx.exports.safeAttrValue(n,o,a,l)}},this._entityMap={"&":"&#x38;","<":"&#x3C;",">":"&#x3E;",'"':"&#x22;","'":"&#x27;","/":"&#x2F;"};var s;e&&!r?s=e:e&&r?(s=Object.create(this.arcgisFilterOptions),Object.keys(e).forEach(function(n){n==="whiteList"?s.whiteList=i._extendObjectOfArrays([i.arcgisWhiteList,e.whiteList||{}]):s[n]=e[n]})):(s=Object.create(this.arcgisFilterOptions),s.whiteList=this.arcgisWhiteList),this.xssFilterOptions=s,this._xssFilter=new yx.exports.FilterXSS(s)}return t.prototype.sanitize=function(e,r){switch(r===void 0&&(r={}),typeof e){case"number":return isNaN(e)||!isFinite(e)?null:e;case"boolean":return e;case"string":return this._xssFilter.process(e);case"object":return this._iterateOverObject(e,r);default:return r.allowUndefined&&typeof e>"u"?void 0:null}},t.prototype.sanitizeUrl=function(e,r){var i=(r??{}).isProtocolRequired,s=i===void 0?!0:i,n=this._trim(e.substring(0,e.indexOf(":"))),o=e==="/",a=/^#/.test(e),l=n&&this.allowedProtocols.indexOf(n.toLowerCase())>-1;return o||a||l?yx.exports.escapeAttrValue(e):!n&&!s?yx.exports.escapeAttrValue("https://".concat(e)):""},t.prototype.sanitizeHTMLAttribute=function(e,r,i,s){return typeof this.xssFilterOptions.safeAttrValue=="function"?this.xssFilterOptions.safeAttrValue(e,r,i,s):yx.exports.safeAttrValue(e,r,i,s)},t.prototype.validate=function(e,r){r===void 0&&(r={});var i=this.sanitize(e,r);return{isValid:e===i,sanitized:i}},t.prototype.encodeHTML=function(e){var r=this;return String(e).replace(/[&<>"'\/]/g,function(i){return r._entityMap[i]})},t.prototype.encodeAttrValue=function(e){var r=/^[a-zA-Z0-9]$/;return String(e).replace(/[\x00-\xFF]/g,function(i,s){return r.test(i)?i:"&#x".concat(Number(e.charCodeAt(s)).toString(16),";")})},t.prototype._extendObjectOfArrays=function(e){var r={};return e.forEach(function(i){Object.keys(i).forEach(function(s){Array.isArray(i[s])&&Array.isArray(r[s])?r[s]=r[s].concat(i[s]):r[s]=i[s]})}),r},t.prototype._iterateOverObject=function(e,r){var i=this;r===void 0&&(r={});try{var s=!1,n=void 0;if(Array.isArray(e))n=e.reduce(function(a,l){var c=i.validate(l,r);return c.isValid?a.concat([l]):(s=!0,a.concat([c.sanitized]))},[]);else if(Fze(e)){var o=Object.keys(e);n=o.reduce(function(a,l){var c=e[l],h=i.validate(c,r);return h.isValid?a[l]=c:(s=!0,a[l]=h.sanitized),a},{})}else return r.allowUndefined&&typeof e>"u"?void 0:null;return s?n:e}catch{return null}},t.prototype._trim=function(e){return String.prototype.trim?e.trim():e.replace(/(^\s*)|(\s*$)/g,"")},t}();const q6=new Map;function Kbe(){q6.clear()}function RBe(t){return q6.get(t)}function MBe(t,e){q6.set(t,e)}function E9(t){q6.delete(t)}var RT,nA,IBe=function(t){if("WebkitTransition"in t.style)RT="webkitTransitionEnd",nA="webkitAnimationEnd";else{if(!("transition"in t.style))throw new Error("Your browser is not supported!");RT="transitionend",nA="animationend"}},ewe=function(t){RT||IBe(t)},PBe=function(t,e){return e===void 0&&(e=t+"-active"),function(r){ewe(r);var i=!1,s=function(n){i||(i=!0,r.removeEventListener(RT,s),r.removeEventListener(nA,s),r.classList.remove(t),r.classList.remove(e))};r.classList.add(t),r.addEventListener(RT,s),r.addEventListener(nA,s),requestAnimationFrame(function(){r.classList.add(e)})}},$Be=function(t,e){return e===void 0&&(e=t+"-active"),function(r,i){ewe(r);var s=!1,n=function(o){s||(s=!0,r.removeEventListener(RT,n),r.removeEventListener(nA,n),i())};r.classList.add(t),r.addEventListener(RT,n),r.addEventListener(nA,n),requestAnimationFrame(function(){r.classList.add(e)})}};const LBe=K.getLogger("esri.widgets.support.widgetUtils");function JQ(t){const e=pu.acquire();for(let i=0;i<arguments.length;i++){const s=arguments[i],n=typeof s;if(n==="string")e.push(s);else if(Array.isArray(s))e.push.apply(e,s);else if(n==="object")for(const o in s)s[o]&&e.push(o)}const r=e.join(" ");return pu.release(e),r}(()=>{const t=new Map,e=new ResizeObserver(i=>{Kbe();for(const s of i)t.get(s.target)?.(s)}),r=(i,s,n)=>(t.has(i)&&LBe.error("Already observing element",i),t.set(i,s),e.observe(i,n),Zr(()=>{e.unobserve(i),t.delete(i)}));return(i,s,n)=>{let o=null;return Q(()=>typeof i=="function"?i():i,a=>{o?.remove(),a&&(o=r(a,s,n))},Ri)}})();function T7(t){const e=t?.closest("[dir]");return e!==null&&e instanceof HTMLElement&&e.dir==="rtl"||document.dir==="rtl"}function kne(t){const e="data-node-ref";this[t.getAttribute(e)]=null}function uk(t){const e="data-node-ref";this[t.getAttribute(e)]=t}function xFt(t,e){return(t==="enter"?PBe:$Be)(e)}const DBe=["dd","dl","dt","h1","h2","h3","h4","h5","h6","sub","sup","animate","animatetransform","circle","clippath","defs","ellipse","g","image","line","lineargradient","marker","mask","path","pattern","polygon","polyline","radialgradient","rect","stop","svg","switch","symbol","text","textpath","tspan","use"],NBe=DBe.reduce((t,e)=>(t[e]=[],t),{}),FBe=["align","alink","alt","bgcolor","border","cellpadding","cellspacing","class","color","cols","colspan","coords","d","dir","face","height","hspace","ismap","lang","marginheight","marginwidth","multiple","nohref","noresize","noshade","nowrap","ref","rel","rev","rows","rowspan","scrolling","shape","span","summary","tabindex","title","usemap","valign","value","vlink","vspace","width"],twe=new OBe({whiteList:NBe,onTagAttr:(t,e,r)=>{const i=`${e}="${r}"`;if(FBe.includes(e))return i},stripIgnoreTag:!0,stripIgnoreTagBody:["script","style"]},!0);function kBe(t){return t==="Enter"||t===" "}const rwe="http://www.w3.org/",W6=`${rwe}2000/svg`,iwe=`${rwe}1999/xlink`;let Une=[],QQ=(t,e)=>{let r={};return Object.keys(t).forEach(i=>{r[i]=t[i]}),e&&Object.keys(e).forEach(i=>{r[i]=e[i]}),r},KQ=(t,e)=>t.vnodeSelector===e.vnodeSelector&&(t.properties&&e.properties?t.properties.key===e.properties.key&&t.properties.bind===e.properties.bind:!t.properties&&!e.properties),swe=t=>{if(typeof t!="string")throw new Error("Style values must be strings")},UBe=(t,e,r)=>{if(e.vnodeSelector!==""){for(let i=r;i<t.length;i++)if(KQ(t[i],e))return i}return-1},C9=(t,e,r,i)=>{let s=t[e];if(s.vnodeSelector==="")return;let n=s.properties;if(!(n&&(n.key===void 0?n.bind:n.key))){for(let o=0;o<t.length;o++)if(o!==e){let a=t[o];if(KQ(a,s))throw new Error(`${r.vnodeSelector} had a ${s.vnodeSelector} child ${i==="added"?i:"removed"}, but there is now more than one. You must add unique key properties to make them distinguishable.`)}}},VBe=t=>{if(t.properties){let e=t.properties.enterAnimation;e&&e(t.domNode,t.properties)}},S7=[],E7=!1,nwe=t=>{(t.children||[]).forEach(nwe),t.properties&&t.properties.afterRemoved&&t.properties.afterRemoved.apply(t.properties.bind||t.properties,[t.domNode])},Vne=()=>{E7=!1,S7.forEach(nwe),S7.length=0},zne=t=>{S7.push(t),E7||(E7=!0,typeof window<"u"&&"requestIdleCallback"in window?window.requestIdleCallback(Vne,{timeout:16}):setTimeout(Vne,16))},Bne=t=>{let e=t.domNode;if(t.properties){let r=t.properties.exitAnimation;if(r)return e.style.pointerEvents="none",void r(e,()=>{e.parentNode&&(e.parentNode.removeChild(e),zne(t))},t.properties)}e.parentNode&&(e.parentNode.removeChild(e),zne(t))},zBe=(t,e,r)=>{if(!e)return;let i=r.eventHandlerInterceptor,s=Object.keys(e),n=s.length;for(let o=0;o<n;o++){let a=s[o],l=e[a];if(a==="className")throw new Error('Property "className" is not supported, use "class".');if(a==="class")C7(t,l,!0);else if(a==="classes"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p];l[f]&&t.classList.add(f)}}else if(a==="styles"){let c=Object.keys(l),h=c.length;for(let p=0;p<h;p++){let f=c[p],m=l[f];m&&(swe(m),r.styleApplyer(t,f,m))}}else if(a!=="key"&&l!=null){let c=typeof l;c==="function"?(a.lastIndexOf("on",0)===0&&(i&&(l=i(a,l,t,e)),a==="oninput"&&function(){let h=l;l=function(p){h.apply(this,[p]),p.target["oninput-value"]=p.target.value}}()),t[a]=l):r.namespace===W6?a==="href"?t.setAttributeNS(iwe,a,l):t.setAttribute(a,l):c==="string"&&a!=="value"?a==="innerHTML"?t[a]=twe.sanitize(l):owe(t)&&a in t?t[a]=l:t.setAttribute(a,l):t[a]=l}}};function owe(t){if(!(t instanceof Element&&t.tagName.includes("-")))return!1;const e=window.customElements.get(t.tagName.toLowerCase());return!!e&&t instanceof e}let hk,BBe=(t,e,r)=>{if(e)for(let i of e)HE(i,t,void 0,r)},awe=(t,e,r)=>{BBe(t,e.children,r),e.text&&(t.textContent=e.text),zBe(t,e.properties,r),e.properties&&e.properties.afterCreate&&e.properties.afterCreate.apply(e.properties.bind||e.properties,[t,r,e.vnodeSelector,e.properties,e.children])},HE=(t,e,r,i)=>{let s,n=0,o=t.vnodeSelector,a=e.ownerDocument;if(o==="")s=t.domNode=a.createTextNode(t.text),r!==void 0?e.insertBefore(s,r):e.appendChild(s);else{for(let l=0;l<=o.length;++l){let c=o.charAt(l);if(l===o.length||c==="."||c==="#"){let h=o.charAt(n-1),p=o.slice(n,l);h==="."?s.classList.add(p):h==="#"?s.id=p:(p==="svg"&&(i=QQ(i,{namespace:W6})),i.namespace!==void 0?s=t.domNode=a.createElementNS(i.namespace,p):(s=t.domNode=t.domNode||a.createElement(p),p==="input"&&t.properties&&t.properties.type!==void 0&&s.setAttribute("type",t.properties.type)),r!==void 0?e.insertBefore(s,r):s.parentNode!==e&&e.appendChild(s)),n=l+1}}awe(s,t,i)}},C7=(t,e,r)=>{e&&e.split(" ").forEach(i=>{i&&t.classList.toggle(i,r)})},GBe=(t,e,r,i)=>{if(!r)return;let s=!1,n=Object.keys(r),o=n.length;for(let a=0;a<o;a++){let l=n[a],c=r[l],h=e[l];if(l==="class")h!==c&&(C7(t,h,!1),C7(t,c,!0));else if(l==="classes"){let p=t.classList,f=Object.keys(c),m=f.length;for(let g=0;g<m;g++){let _=f[g],v=!!c[_];v!==!!h[_]&&(s=!0,v?p.add(_):p.remove(_))}}else if(l==="styles"){let p=Object.keys(c),f=p.length;for(let m=0;m<f;m++){let g=p[m],_=c[g];_!==h[g]&&(s=!0,_?(swe(_),i.styleApplyer(t,g,_)):i.styleApplyer(t,g,""))}}else if(c||typeof h!="string"||(c=""),l==="value"){let p=t[l];p!==c&&(t["oninput-value"]?p===t["oninput-value"]:c!==h)&&(t[l]=c,t["oninput-value"]=void 0),c!==h&&(s=!0)}else if(c!==h){let p=typeof c;p==="function"&&i.eventHandlerInterceptor||(i.namespace===W6?l==="href"?t.setAttributeNS(iwe,l,c):t.setAttribute(l,c):p==="string"?l==="innerHTML"?t[l]=twe.sanitize(c):l==="role"&&c===""?t.removeAttribute(l):owe(t)&&l in t?t[l]=c:t.setAttribute(l,c):t[l]!==c&&(t[l]=c),s=!0)}}return s},jBe=(t,e,r,i,s)=>{if(r===i)return!1;i=i||Une;let n,o=(r=r||Une).length,a=i.length,l=0,c=0,h=!1;for(;c<a;){let p=l<o?r[l]:void 0,f=i[c];if(p!==void 0&&KQ(p,f))h=hk(p,f,s)||h,l++;else{let m=UBe(r,f,l+1);if(m>=0){for(n=l;n<m;n++)Bne(r[n]),C9(r,n,t,"removed");h=hk(r[m],f,s)||h,l=m+1}else HE(f,e,l<o?r[l].domNode:void 0,s),VBe(f),C9(i,c,t,"added")}c++}if(o>l)for(n=l;n<o;n++)Bne(r[n]),C9(r,n,t,"removed");return h};hk=(t,e,r)=>{let i=t.domNode,s=!1;if(t===e)return!1;let n=!1;if(e.vnodeSelector===""){if(e.text!==t.text){let o=i.ownerDocument.createTextNode(e.text);return i.parentNode.replaceChild(o,i),e.domNode=o,s=!0,s}e.domNode=i}else e.vnodeSelector.lastIndexOf("svg",0)===0&&(r=QQ(r,{namespace:W6})),t.text!==e.text&&(n=!0,e.text===void 0?i.removeChild(i.firstChild):i.textContent=e.text),e.domNode=i,n=jBe(e,i,t.children,e.children,r)||n,n=GBe(i,t.properties,e.properties,r)||n,e.properties&&e.properties.afterUpdate&&e.properties.afterUpdate.apply(e.properties.bind||e.properties,[i,r,e.vnodeSelector,e.properties,e.children]);return n&&e.properties&&e.properties.updateAnimation&&e.properties.updateAnimation(i,e.properties,t.properties),s};let HO=(t,e)=>({getLastRender:()=>t,update:r=>{if(t.vnodeSelector!==r.vnodeSelector)throw new Error("The selector for the root VNode may not be changed. (consider using dom.merge and add one extra level to the virtual DOM)");let i=t;t=r,hk(i,r,e)},domNode:t.domNode});const HBe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{e.charAt(0)==="-"?t.style.setProperty(e,r):t.style[e]=r}};let U2=t=>QQ(HBe,t),a1={create:(t,e)=>(e=U2(e),HE(t,document.createElement("div"),void 0,e),HO(t,e)),append:(t,e,r)=>(r=U2(r),HE(e,t,void 0,r),HO(e,r)),insertBefore:(t,e,r)=>(r=U2(r),HE(e,t.parentNode,t,r),HO(e,r)),merge:(t,e,r)=>(r=U2(r),e.domNode=t,awe(t,e,r),HO(e,r)),replace:(t,e,r)=>(r=U2(r),HE(e,t.parentNode,t,r),t.parentNode.removeChild(t),HO(e,r))},lwe,qBe=(t,e)=>{let r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r};lwe=Array.prototype.find?(t,e)=>t.find(e):(t,e)=>t.filter(e)[0];let WBe=(t,e)=>{let r=t;return e.forEach(i=>{r=r&&r.children?lwe(r.children,s=>s.domNode===i):void 0}),r},ZBe=(t,e,r)=>{let i=function(s){r("domEvent",s);let n=e(),o=qBe(s.currentTarget,n.domNode);o.reverse();let a,l=WBe(n.getLastRender(),o);return t.scheduleRender(),l&&(a=l.properties[`on${s.type}`].apply(l.properties.bind||this,arguments)),r("domEventProcessed",s),a};return(s,n,o,a)=>i},A7=t=>{let e,r,i=U2(t),s=i.performanceLogger,n=!0,o=!1,a=[],l=[],c=(p,f,m)=>{let g,_=()=>g;i.eventHandlerInterceptor=ZBe(e,_,s),g=p(f,m(),i),a.push(g),l.push(m)},h=()=>{if(r=void 0,n){n=!1,s("renderStart",void 0);for(let p=0;p<a.length;p++){let f=l[p]();s("rendered",void 0),a[p].update(f),s("patched",void 0)}s("renderDone",void 0),n=!0}};return e={renderNow:h,scheduleRender:()=>{r||o||(r=requestAnimationFrame(h))},stop:()=>{r&&(cancelAnimationFrame(r),r=void 0),o=!0},resume:()=>{o=!1,n=!0,e.scheduleRender()},append:(p,f)=>{c(a1.append,p,f)},insertBefore:(p,f)=>{c(a1.insertBefore,p,f)},merge:(p,f)=>{c(a1.merge,p,f)},replace:(p,f)=>{c(a1.replace,p,f)},detach:p=>{for(let f=0;f<l.length;f++)if(l[f]===p)return l.splice(f,1),a.splice(f,1)[0];throw new Error("renderFunction was not found")}},e};const XBe={handleInterceptedEvent:(t,e,r,i)=>(t.scheduleRender(),e.properties[`on${i.type}`].apply(e.properties.bind||r,[i]))},YBe={namespace:void 0,performanceLogger:()=>{},eventHandlerInterceptor:void 0,styleApplyer:(t,e,r)=>{t.style[e]=r}},JBe=t=>({...YBe,...t}),QBe=(t,e)=>{const r=[];for(;t&&t!==e;)r.push(t),t=t.parentNode;return r},KBe=(t,e)=>t.find(e),Gne=(t,e,r=!1)=>{let i=t;return e.forEach((s,n)=>{const o=i?.children?KBe(i.children,a=>a.domNode===s):void 0;r&&!o&&n!==e.length-1||(i=o)}),i},eGe=t=>{let e;const r={...XBe,...t},i=JBe(r),s=i.performanceLogger;let n,o=!0,a=!1;const l=[],c=[],h=(f,m,g)=>{let _;i.eventHandlerInterceptor=(b,x,T,S)=>function(O){let A;s("domEvent",O);const M=QBe(O.currentTarget,_.domNode),P=M.some($=>customElements.get($?.tagName?.toLowerCase()));if(O.eventPhase===Event.CAPTURING_PHASE||!P)M.reverse(),A=Gne(_.getLastRender(),M);else{const $=O.composedPath(),N=$.slice($.indexOf(O.currentTarget),$.indexOf(_.domNode)).filter(U=>U.getRootNode()===U.ownerDocument).reverse();A=Gne(_.getLastRender(),N,!0)}let F;return A&&(F=r.handleInterceptedEvent(e,A,this,O)),s("domEventProcessed",O),F},r.postProcessProjectionOptions?.(i);const v=g();_=f(m,v,i),l.push(_),c.push(g),r.afterFirstVNodeRendered&&r.afterFirstVNodeRendered(_,v)};let p=()=>{if(n=void 0,o){o=!1,s("renderStart",void 0);for(let f=0;f<l.length;f++){const m=c[f]();s("rendered",void 0),l[f].update(m),s("patched",void 0)}s("renderDone",void 0),o=!0}};return r.modifyDoRenderImplementation&&(p=r.modifyDoRenderImplementation(p,l,c)),e={renderNow:p,scheduleRender:()=>{n||a||(n=requestAnimationFrame(p))},stop:()=>{n&&(cancelAnimationFrame(n),n=void 0),a=!0},resume:()=>{a=!1,o=!0,e.scheduleRender()},append:(f,m)=>{h(a1.append,f,m)},insertBefore:(f,m)=>{h(a1.insertBefore,f,m)},merge:(f,m)=>{h(a1.merge,f,m)},replace:(f,m)=>{h(a1.replace,f,m)},detach:f=>{for(let m=0;m<c.length;m++)if(c[m]===f)return c.splice(m,1),l.splice(m,1)[0];throw new Error("renderFunction was not found")}},e},V2={allRenderFn:!1,cmpDidLoad:!0,cmpDidUnload:!1,cmpDidUpdate:!0,cmpDidRender:!0,cmpWillLoad:!0,cmpWillUpdate:!0,cmpWillRender:!0,connectedCallback:!0,disconnectedCallback:!0,element:!0,event:!0,hasRenderFn:!0,lifecycle:!0,hostListener:!0,hostListenerTargetWindow:!0,hostListenerTargetDocument:!0,hostListenerTargetBody:!0,hostListenerTargetParent:!1,hostListenerTarget:!0,member:!0,method:!0,mode:!0,observeAttribute:!0,prop:!0,propMutable:!0,reflect:!0,scoped:!0,shadowDom:!0,slot:!0,cssAnnotations:!0,state:!0,style:!0,svg:!0,updatable:!0,vdomAttribute:!0,vdomXlink:!0,vdomClass:!0,vdomFunctional:!0,vdomKey:!0,vdomListener:!0,vdomRef:!0,vdomPropOrAttr:!0,vdomRender:!0,vdomStyle:!0,vdomText:!0,watchCallback:!0,taskQueue:!0,hotModuleReplacement:!1,isDebug:!1,isDev:!1,isTesting:!1,hydrateServerSide:!1,hydrateClientSide:!1,lifecycleDOMEvents:!1,lazyLoad:!1,profile:!1,slotRelocation:!0,appendChildSlotFix:!1,cloneNodeFix:!1,hydratedAttribute:!1,hydratedClass:!0,safari10:!1,scriptDataOpts:!1,scopedSlotTextContentFix:!1,shadowDomShim:!1,slotChildNodesFix:!1,invisiblePrehydration:!0,propBoolean:!0,propNumber:!0,propString:!0,cssVarShim:!1,constructableCSS:!0,cmpShouldUpdate:!0,devTools:!1,dynamicImportShim:!1,shadowDelegatesFocus:!0,initializeNextTick:!1,asyncLoading:!1,asyncQueue:!1,transformTagName:!1,attachStyles:!0};let z2,cwe,Z6,uwe=!1,dk=!1,eK=!1,th=!1,jne=null,O7=!1;const tGe=t=>{const e=new URL(t,$a.$resourcesUrl$);return e.origin!==i$.location.origin?e.href:e.pathname},rGe=t=>$a.$resourcesUrl$=t,MT=(t,e="")=>()=>{},Hne="http://www.w3.org/1999/xlink",qne={},iGe="http://www.w3.org/2000/svg",sGe="http://www.w3.org/1999/xhtml",nGe=t=>t!=null,tK=t=>(t=typeof t,t==="object"||t==="function");function oGe(t){var e,r,i;return(i=(r=(e=t.head)===null||e===void 0?void 0:e.querySelector('meta[name="csp-nonce"]'))===null||r===void 0?void 0:r.getAttribute("content"))!==null&&i!==void 0?i:void 0}const hwe=(t,e,...r)=>{let i=null,s=null,n=null,o=!1,a=!1;const l=[],c=p=>{for(let f=0;f<p.length;f++)i=p[f],Array.isArray(i)?c(i):i!=null&&typeof i!="boolean"&&((o=typeof t!="function"&&!tK(i))&&(i=String(i)),o&&a?l[l.length-1].$text$+=i:l.push(o?pk(null,i):i),a=o)};if(c(r),e){e.key&&(s=e.key),e.name&&(n=e.name);{const p=e.className||e.class;p&&(e.class=typeof p!="object"?p:Object.keys(p).filter(f=>p[f]).join(" "))}}if(typeof t=="function")return t(e===null?{}:e,l,cGe);const h=pk(t,null);return h.$attrs$=e,l.length>0&&(h.$children$=l),h.$key$=s,h.$name$=n,h},pk=(t,e)=>{const r={$flags$:0,$tag$:t,$text$:e,$elm$:null,$children$:null};return r.$attrs$=null,r.$key$=null,r.$name$=null,r},aGe={},lGe=t=>t&&t.$tag$===aGe,cGe={forEach:(t,e)=>t.map(Wne).forEach(e),map:(t,e)=>t.map(Wne).map(e).map(uGe)},Wne=t=>({vattrs:t.$attrs$,vchildren:t.$children$,vkey:t.$key$,vname:t.$name$,vtag:t.$tag$,vtext:t.$text$}),uGe=t=>{if(typeof t.vtag=="function"){const r=Object.assign({},t.vattrs);return t.vkey&&(r.key=t.vkey),t.vname&&(r.name=t.vname),hwe(t.vtag,r,...t.vchildren||[])}const e=pk(t.vtag,t.vtext);return e.$attrs$=t.vattrs,e.$children$=t.vchildren,e.$key$=t.vkey,e.$name$=t.vname,e},hGe=t=>kGe.map(e=>e(t)).find(e=>!!e),dGe=(t,e)=>t!=null&&!tK(t)?e&4?t==="false"?!1:t===""||!!t:e&2?parseFloat(t):e&1?String(t):t:t,pGe=t=>t,TFt=(t,e,r)=>{const i=pGe(t);return{emit:s=>fGe(i,e,{bubbles:!!(r&4),composed:!!(r&2),cancelable:!!(r&1),detail:s})}},fGe=(t,e,r)=>{const i=$a.ce(e,r);return t.dispatchEvent(i),i},Zne=new WeakMap,mGe=(t,e,r)=>{let i=mk.get(t);zGe&&r?(i=i||new CSSStyleSheet,typeof i=="string"?i=e:i.replaceSync(e)):i=e,mk.set(t,i)},gGe=(t,e,r,i)=>{var s;let n=dwe(e,r);const o=mk.get(n);if(t=t.nodeType===11?t:bf,o)if(typeof o=="string"){t=t.head||t;let a=Zne.get(t),l;if(a||Zne.set(t,a=new Set),!a.has(n)){{l=bf.createElement("style"),l.innerHTML=o;const c=(s=$a.$nonce$)!==null&&s!==void 0?s:oGe(bf);c!=null&&l.setAttribute("nonce",c),t.insertBefore(l,t.querySelector("link"))}a&&a.add(n)}}else t.adoptedStyleSheets.includes(o)||(t.adoptedStyleSheets=[...t.adoptedStyleSheets,o]);return n},yGe=t=>{const e=t.$cmpMeta$,r=t.$hostElement$,i=e.$flags$,s=MT("attachStyles",e.$tagName$),n=gGe(r.shadowRoot?r.shadowRoot:r.getRootNode(),e,t.$modeName$);i&10&&(r["s-sc"]=n,r.classList.add(n+"-h"),i&2&&r.classList.add(n+"-s")),s()},dwe=(t,e)=>"sc-"+(e&&t.$flags$&32?t.$tagName$+"-"+e:t.$tagName$),Xne=(t,e,r,i,s,n)=>{if(r!==i){let o=Kne(t,e),a=e.toLowerCase();if(e==="class"){const l=t.classList,c=Yne(r),h=Yne(i);l.remove(...c.filter(p=>p&&!h.includes(p))),l.add(...h.filter(p=>p&&!c.includes(p)))}else if(e==="style"){for(const l in r)(!i||i[l]==null)&&(l.includes("-")?t.style.removeProperty(l):t.style[l]="");for(const l in i)(!r||i[l]!==r[l])&&(l.includes("-")?t.style.setProperty(l,i[l]):t.style[l]=i[l])}else if(e!=="key")if(e==="ref")i&&i(t);else if(!t.__lookupSetter__(e)&&e[0]==="o"&&e[1]==="n")e[2]==="-"?e=e.slice(3):Kne(i$,a)?e=a.slice(2):e=a[2]+e.slice(3),r&&$a.rel(t,e,r,!1),i&&$a.ael(t,e,i,!1);else{const l=tK(i);if((o||l&&i!==null)&&!s)try{if(t.tagName.includes("-"))t[e]=i;else{const h=i??"";e==="list"?o=!1:(r==null||t[e]!=h)&&(t[e]=h)}}catch{}let c=!1;a!==(a=a.replace(/^xlink\:?/,""))&&(e=a,c=!0),i==null||i===!1?(i!==!1||t.getAttribute(e)==="")&&(c?t.removeAttributeNS(Hne,e):t.removeAttribute(e)):(!o||n&4||s)&&!l&&(i=i===!0?"":i,c?t.setAttributeNS(Hne,e,i):t.setAttribute(e,i))}}},_Ge=/\s/,Yne=t=>t?t.split(_Ge):[],pwe=(t,e,r,i)=>{const s=e.$elm$.nodeType===11&&e.$elm$.host?e.$elm$.host:e.$elm$,n=t&&t.$attrs$||qne,o=e.$attrs$||qne;for(i in n)i in o||Xne(s,i,n[i],void 0,r,e.$flags$);for(i in o)Xne(s,i,n[i],o[i],r,e.$flags$)},fk=(t,e,r,i)=>{const s=e.$children$[r];let n=0,o,a,l;if(uwe||(eK=!0,s.$tag$==="slot"&&(z2&&i.classList.add(z2+"-s"),s.$flags$|=s.$children$?2:1)),s.$text$!==null)o=s.$elm$=bf.createTextNode(s.$text$);else if(s.$flags$&1)o=s.$elm$=bf.createTextNode("");else{if(th||(th=s.$tag$==="svg"),o=s.$elm$=bf.createElementNS(th?iGe:sGe,s.$flags$&2?"slot-fb":s.$tag$),th&&s.$tag$==="foreignObject"&&(th=!1),pwe(null,s,th),nGe(z2)&&o["s-si"]!==z2&&o.classList.add(o["s-si"]=z2),s.$children$)for(n=0;n<s.$children$.length;++n)a=fk(t,s,n,o),a&&o.appendChild(a);s.$tag$==="svg"?th=!1:o.tagName==="foreignObject"&&(th=!0)}return o["s-hn"]=Z6,s.$flags$&3&&(o["s-sr"]=!0,o["s-cr"]=cwe,o["s-sn"]=s.$name$||"",l=t&&t.$children$&&t.$children$[r],l&&l.$tag$===s.$tag$&&t.$elm$&&qI(t.$elm$,!1)),o},qI=(t,e)=>{$a.$flags$|=1;const r=t.childNodes;for(let i=r.length-1;i>=0;i--){const s=r[i];s["s-hn"]!==Z6&&s["s-ol"]&&(gwe(s).insertBefore(s,rK(s)),s["s-ol"].remove(),s["s-ol"]=void 0,eK=!0),e&&qI(s,e)}$a.$flags$&=-2},fwe=(t,e,r,i,s,n)=>{let o=t["s-cr"]&&t["s-cr"].parentNode||t,a;for(o.shadowRoot&&o.tagName===Z6&&(o=o.shadowRoot);s<=n;++s)i[s]&&(a=fk(null,r,s,t),a&&(i[s].$elm$=a,o.insertBefore(a,rK(e))))},mwe=(t,e,r,i,s)=>{for(;e<=r;++e)(i=t[e])&&(s=i.$elm$,vwe(i),dk=!0,s["s-ol"]?s["s-ol"].remove():qI(s,!0),s.remove())},vGe=(t,e,r,i)=>{let s=0,n=0,o=0,a=0,l=e.length-1,c=e[0],h=e[l],p=i.length-1,f=i[0],m=i[p],g,_;for(;s<=l&&n<=p;)if(c==null)c=e[++s];else if(h==null)h=e[--l];else if(f==null)f=i[++n];else if(m==null)m=i[--p];else if(dL(c,f))B2(c,f),c=e[++s],f=i[++n];else if(dL(h,m))B2(h,m),h=e[--l],m=i[--p];else if(dL(c,m))(c.$tag$==="slot"||m.$tag$==="slot")&&qI(c.$elm$.parentNode,!1),B2(c,m),t.insertBefore(c.$elm$,h.$elm$.nextSibling),c=e[++s],m=i[--p];else if(dL(h,f))(c.$tag$==="slot"||m.$tag$==="slot")&&qI(h.$elm$.parentNode,!1),B2(h,f),t.insertBefore(h.$elm$,c.$elm$),h=e[--l],f=i[++n];else{for(o=-1,a=s;a<=l;++a)if(e[a]&&e[a].$key$!==null&&e[a].$key$===f.$key$){o=a;break}o>=0?(_=e[o],_.$tag$!==f.$tag$?g=fk(e&&e[n],r,o,t):(B2(_,f),e[o]=void 0,g=_.$elm$),f=i[++n]):(g=fk(e&&e[n],r,n,t),f=i[++n]),g&&gwe(c.$elm$).insertBefore(g,rK(c.$elm$))}s>l?fwe(t,i[p+1]==null?null:i[p+1].$elm$,r,i,n,p):n>p&&mwe(e,s,l)},dL=(t,e)=>t.$tag$===e.$tag$?t.$tag$==="slot"?t.$name$===e.$name$:t.$key$===e.$key$:!1,rK=t=>t&&t["s-ol"]||t,gwe=t=>(t["s-ol"]?t["s-ol"]:t).parentNode,B2=(t,e)=>{const r=e.$elm$=t.$elm$,i=t.$children$,s=e.$children$,n=e.$tag$,o=e.$text$;let a;o===null?(th=n==="svg"?!0:n==="foreignObject"?!1:th,n==="slot"||pwe(t,e,th),i!==null&&s!==null?vGe(r,i,e,s):s!==null?(t.$text$!==null&&(r.textContent=""),fwe(r,null,e,s,0,s.length-1)):i!==null&&mwe(i,0,i.length-1),th&&n==="svg"&&(th=!1)):(a=r["s-cr"])?a.parentNode.textContent=o:t.$text$!==o&&(r.data=o)},ywe=t=>{const e=t.childNodes;let r,i,s,n,o,a;for(i=0,s=e.length;i<s;i++)if(r=e[i],r.nodeType===1){if(r["s-sr"]){for(o=r["s-sn"],r.hidden=!1,n=0;n<s;n++)if(a=e[n].nodeType,e[n]["s-hn"]!==r["s-hn"]||o!==""){if(a===1&&o===e[n].getAttribute("slot")){r.hidden=!0;break}}else if(a===1||a===3&&e[n].textContent.trim()!==""){r.hidden=!0;break}}ywe(r)}},rf=[],_we=t=>{let e,r,i,s,n,o,a=0;const l=t.childNodes,c=l.length;for(;a<c;a++){if(e=l[a],e["s-sr"]&&(r=e["s-cr"])&&r.parentNode)for(i=r.parentNode.childNodes,s=e["s-sn"],o=i.length-1;o>=0;o--)r=i[o],!r["s-cn"]&&!r["s-nr"]&&r["s-hn"]!==e["s-hn"]&&(Jne(r,s)?(n=rf.find(h=>h.$nodeToRelocate$===r),dk=!0,r["s-sn"]=r["s-sn"]||s,n?n.$slotRefNode$=e:rf.push({$slotRefNode$:e,$nodeToRelocate$:r}),r["s-sr"]&&rf.map(h=>{Jne(h.$nodeToRelocate$,r["s-sn"])&&(n=rf.find(p=>p.$nodeToRelocate$===r),n&&!h.$slotRefNode$&&(h.$slotRefNode$=n.$slotRefNode$))})):rf.some(h=>h.$nodeToRelocate$===r)||rf.push({$nodeToRelocate$:r}));e.nodeType===1&&_we(e)}},Jne=(t,e)=>t.nodeType===1?t.getAttribute("slot")===null&&e===""||t.getAttribute("slot")===e:t["s-sn"]===e?!0:e==="",vwe=t=>{t.$attrs$&&t.$attrs$.ref&&t.$attrs$.ref(null),t.$children$&&t.$children$.map(vwe)},bGe=(t,e)=>{const r=t.$hostElement$,i=t.$cmpMeta$,s=t.$vnode$||pk(null,null),n=lGe(e)?e:hwe(null,null,e);Z6=r.tagName,i.$attrsToReflect$&&(n.$attrs$=n.$attrs$||{},i.$attrsToReflect$.map(([o,a])=>n.$attrs$[a]=r[o])),n.$tag$=null,n.$flags$|=4,t.$vnode$=n,n.$elm$=s.$elm$=r.shadowRoot||r,z2=r["s-sc"],cwe=r["s-cr"],uwe=(i.$flags$&1)!==0,dk=!1,B2(s,n);{if($a.$flags$|=1,eK){_we(n.$elm$);let o,a,l,c,h,p,f=0;for(;f<rf.length;f++)o=rf[f],a=o.$nodeToRelocate$,a["s-ol"]||(l=bf.createTextNode(""),l["s-nr"]=a,a.parentNode.insertBefore(a["s-ol"]=l,a));for(f=0;f<rf.length;f++)if(o=rf[f],a=o.$nodeToRelocate$,o.$slotRefNode$){for(c=o.$slotRefNode$.parentNode,h=o.$slotRefNode$.nextSibling,l=a["s-ol"];l=l.previousSibling;)if(p=l["s-nr"],p&&p["s-sn"]===a["s-sn"]&&c===p.parentNode&&(p=p.nextSibling,!p||!p["s-nr"])){h=p;break}(!h&&c!==a.parentNode||a.nextSibling!==h)&&a!==h&&(!a["s-hn"]&&a["s-ol"]&&(a["s-hn"]=a["s-ol"].parentNode.nodeName),c.insertBefore(a,h))}else a.nodeType===1&&(a.hidden=!0)}dk&&ywe(n.$elm$),$a.$flags$&=-2,rf.length=0}},wGe=(t,e)=>{},iK=(t,e)=>(t.$flags$|=16,wGe(t,t.$ancestorComponent$),jGe(()=>xGe(t,e))),xGe=(t,e)=>{const r=t.$hostElement$,i=MT("scheduleUpdate",t.$cmpMeta$.$tagName$),s=r;let n;return e?n=SC(s,"componentWillLoad"):n=SC(s,"componentWillUpdate"),n=Qne(n,()=>SC(s,"componentWillRender")),i(),Qne(n,()=>TGe(t,s,e))},TGe=async(t,e,r)=>{const i=t.$hostElement$,s=MT("update",t.$cmpMeta$.$tagName$);i["s-rc"],r&&yGe(t);const n=MT("render",t.$cmpMeta$.$tagName$);SGe(t,e,i),n(),s(),EGe(t)},SGe=(t,e,r)=>{try{jne=e,e=e.render&&e.render(),t.$flags$&=-17,t.$flags$|=2,(V2.hasRenderFn||V2.reflect)&&(V2.vdomRender||V2.reflect)&&(V2.hydrateServerSide||bGe(t,e))}catch(a){r$(a,t.$hostElement$)}return jne=null,null},EGe=t=>{const e=t.$cmpMeta$.$tagName$,r=t.$hostElement$,i=MT("postUpdate",e),s=r;t.$ancestorComponent$,SC(s,"componentDidRender"),t.$flags$&64?(SC(s,"componentDidUpdate"),i()):(t.$flags$|=64,SC(s,"componentDidLoad"),i())},SFt=t=>{{const e=t$(t),r=e.$hostElement$.isConnected;return r&&(e.$flags$&18)===2&&iK(e,!1),r}},SC=(t,e,r)=>{if(t&&t[e])try{return t[e](r)}catch(i){r$(i)}},Qne=(t,e)=>t&&t.then?t.then(e):e(),CGe=(t,e)=>t$(t).$instanceValues$.get(e),AGe=(t,e,r,i)=>{const s=t$(t),n=t,o=s.$instanceValues$.get(e),a=s.$flags$,l=n;r=dGe(r,i.$members$[e][0]);const c=Number.isNaN(o)&&Number.isNaN(r);if(r!==o&&!c){s.$instanceValues$.set(e,r);{if(i.$watchers$&&a&128){const p=i.$watchers$[e];p&&p.map(f=>{try{l[f](r,o,e)}catch(m){r$(m,n)}})}if((a&18)===2){if(l.componentShouldUpdate&&l.componentShouldUpdate(r,o,e)===!1)return;iK(s,!1)}}}},OGe=(t,e,r)=>{if(e.$members$){t.watchers&&(e.$watchers$=t.watchers);const i=Object.entries(e.$members$),s=t.prototype;i.map(([n,[o]])=>{(o&31||o&32)&&Object.defineProperty(s,n,{get(){return CGe(this,n)},set(a){AGe(this,n,a,e)},configurable:!0,enumerable:!0})});{const n=new Map;s.attributeChangedCallback=function(o,a,l){$a.jmp(()=>{const c=n.get(o);if(this.hasOwnProperty(c))l=this[c],delete this[c];else if(s.hasOwnProperty(c)&&typeof this[c]=="number"&&this[c]==l)return;this[c]=l===null&&typeof this[c]=="boolean"?!1:l})},t.observedAttributes=i.filter(([o,a])=>a[0]&15).map(([o,a])=>{const l=a[1]||o;return n.set(l,o),a[0]&512&&e.$attrsToReflect$.push([o,l]),l})}}return t},RGe=async(t,e,r,i,s)=>{if(!(e.$flags$&32)&&(s=t.constructor,e.$flags$|=32,customElements.whenDefined(r.$tagName$).then(()=>e.$flags$|=128),s.style)){let o=s.style;typeof o!="string"&&(o=o[e.$modeName$=hGe(t)]);const a=dwe(r,e.$modeName$);if(!mk.has(a)){const l=MT("registerStyles",r.$tagName$);mGe(a,o,!!(r.$flags$&1)),l()}}e.$ancestorComponent$,(()=>iK(e,!0))()},MGe=t=>{},IGe=t=>{if(!($a.$flags$&1)){const e=t$(t),r=e.$cmpMeta$,i=MT("connectedCallback",r.$tagName$);e.$flags$&1?(bwe(t,e,r.$listeners$),MGe(e.$lazyInstance$)):(e.$flags$|=1,r.$flags$&12&&PGe(t),r.$members$&&Object.entries(r.$members$).map(([s,[n]])=>{if(n&31&&t.hasOwnProperty(s)){const o=t[s];delete t[s],t[s]=o}}),RGe(t,e,r)),i()}},PGe=t=>{const e=t["s-cr"]=bf.createComment("");e["s-cn"]=!0,t.insertBefore(e,t.firstChild)},$Ge=t=>{if(!($a.$flags$&1)){const e=t$(t);e.$rmListeners$&&(e.$rmListeners$.map(r=>r()),e.$rmListeners$=void 0)}},EFt=(t,e)=>{const r={$flags$:e[0],$tagName$:e[1]};r.$members$=e[2],r.$listeners$=e[3],r.$watchers$=t.$watchers$,r.$attrsToReflect$=[];const i=t.prototype.connectedCallback,s=t.prototype.disconnectedCallback;return Object.assign(t.prototype,{__registerHost(){FGe(this,r)},connectedCallback(){IGe(this),i&&i.call(this)},disconnectedCallback(){$Ge(this),s&&s.call(this)},__attachShadow(){this.attachShadow({mode:"open",delegatesFocus:!!(r.$flags$&16)})}}),t.is=r.$tagName$,OGe(t,r)},CFt=(t,e)=>e,bwe=(t,e,r,i)=>{r&&r.map(([s,n,o])=>{const a=DGe(t,s),l=LGe(e,o),c=NGe(s);$a.ael(a,n,l,c),(e.$rmListeners$=e.$rmListeners$||[]).push(()=>$a.rel(a,n,l,c))})},LGe=(t,e)=>r=>{try{V2.lazyLoad||t.$hostElement$[e](r)}catch(i){r$(i)}},DGe=(t,e)=>e&4?bf:e&8?i$:e&16?bf.body:t,NGe=t=>UGe?{passive:(t&1)!==0,capture:(t&2)!==0}:(t&2)!==0,wwe=new WeakMap,t$=t=>wwe.get(t),FGe=(t,e)=>{const r={$flags$:0,$hostElement$:t,$cmpMeta$:e,$instanceValues$:new Map};return bwe(t,r,e.$listeners$),wwe.set(t,r)},Kne=(t,e)=>e in t,r$=(t,e)=>(0,console.error)(t,e),mk=new Map,kGe=[],i$=typeof window<"u"?window:{},bf=i$.document||{head:{}},AFt=i$.HTMLElement||class{},$a={$flags$:0,$resourcesUrl$:"",jmp:t=>t(),raf:t=>requestAnimationFrame(t),ael:(t,e,r,i)=>t.addEventListener(e,r,i),rel:(t,e,r,i)=>t.removeEventListener(e,r,i),ce:(t,e)=>new CustomEvent(t,e)},UGe=(()=>{let t=!1;try{bf.addEventListener("e",null,Object.defineProperty({},"passive",{get(){t=!0}}))}catch{}return t})(),VGe=t=>Promise.resolve(t),zGe=(()=>{try{return new CSSStyleSheet,typeof new CSSStyleSheet().replaceSync=="function"}catch{}return!1})(),eoe=[],xwe=[],BGe=(t,e)=>r=>{t.push(r),O7||(O7=!0,e&&$a.$flags$&4?GGe(R7):$a.raf(R7))},toe=t=>{for(let e=0;e<t.length;e++)try{t[e](performance.now())}catch(r){r$(r)}t.length=0},R7=()=>{toe(eoe),toe(xwe),(O7=eoe.length>0)&&$a.raf(R7)},GGe=t=>VGe().then(t),jGe=BGe(xwe,!0);/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.4.2
 */const Twe="calcite-mode-auto",Swe="calcite-mode-dark",HGe="calcite-mode-light",OFt={autoMode:Twe,darkMode:Swe,lightMode:HGe,rtl:"calcite--rtl",calciteAnimate:"calcite-animate",calciteAnimateIn:"calcite-animate__in",calciteAnimateInUp:"calcite-animate__in-up",calciteAnimateInDown:"calcite-animate__in-down",calciteAnimateInRight:"calcite-animate__in-right",calciteAnimateInLeft:"calcite-animate__in-left",calciteAnimateInScale:"calcite-animate__in-scale"};/*!
* tabbable 6.1.2
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var Ewe=["input:not([inert])","select:not([inert])","textarea:not([inert])","a[href]:not([inert])","button:not([inert])","[tabindex]:not(slot):not([inert])","audio[controls]:not([inert])","video[controls]:not([inert])",'[contenteditable]:not([contenteditable="false"]):not([inert])',"details>summary:first-of-type:not([inert])","details:not([inert])"],gk=Ewe.join(","),Cwe=typeof Element>"u",IT=Cwe?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,yk=!Cwe&&Element.prototype.getRootNode?function(t){var e;return t==null||(e=t.getRootNode)===null||e===void 0?void 0:e.call(t)}:function(t){return t?.ownerDocument},_k=function t(e,r){var i;r===void 0&&(r=!0);var s=e==null||(i=e.getAttribute)===null||i===void 0?void 0:i.call(e,"inert"),n=s===""||s==="true",o=n||r&&e&&t(e.parentNode);return o},qGe=function(e){var r,i=e==null||(r=e.getAttribute)===null||r===void 0?void 0:r.call(e,"contenteditable");return i===""||i==="true"},Awe=function(e,r,i){if(_k(e))return[];var s=Array.prototype.slice.apply(e.querySelectorAll(gk));return r&&IT.call(e,gk)&&s.unshift(e),s=s.filter(i),s},Owe=function t(e,r,i){for(var s=[],n=Array.from(e);n.length;){var o=n.shift();if(!_k(o,!1))if(o.tagName==="SLOT"){var a=o.assignedElements(),l=a.length?a:o.children,c=t(l,!0,i);i.flatten?s.push.apply(s,c):s.push({scopeParent:o,candidates:c})}else{var h=IT.call(o,gk);h&&i.filter(o)&&(r||!e.includes(o))&&s.push(o);var p=o.shadowRoot||typeof i.getShadowRoot=="function"&&i.getShadowRoot(o),f=!_k(p,!1)&&(!i.shadowRootFilter||i.shadowRootFilter(o));if(p&&f){var m=t(p===!0?o.children:p.children,!0,i);i.flatten?s.push.apply(s,m):s.push({scopeParent:o,candidates:m})}else n.unshift.apply(n,o.children)}}return s},Rwe=function(e,r){return e.tabIndex<0&&(r||/^(AUDIO|VIDEO|DETAILS)$/.test(e.tagName)||qGe(e))&&isNaN(parseInt(e.getAttribute("tabindex"),10))?0:e.tabIndex},WGe=function(e,r){return e.tabIndex===r.tabIndex?e.documentOrder-r.documentOrder:e.tabIndex-r.tabIndex},Mwe=function(e){return e.tagName==="INPUT"},ZGe=function(e){return Mwe(e)&&e.type==="hidden"},XGe=function(e){var r=e.tagName==="DETAILS"&&Array.prototype.slice.apply(e.children).some(function(i){return i.tagName==="SUMMARY"});return r},YGe=function(e,r){for(var i=0;i<e.length;i++)if(e[i].checked&&e[i].form===r)return e[i]},JGe=function(e){if(!e.name)return!0;var r=e.form||yk(e),i=function(a){return r.querySelectorAll('input[type="radio"][name="'+a+'"]')},s;if(typeof window<"u"&&typeof window.CSS<"u"&&typeof window.CSS.escape=="function")s=i(window.CSS.escape(e.name));else try{s=i(e.name)}catch(o){return console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",o.message),!1}var n=YGe(s,e.form);return!n||n===e},QGe=function(e){return Mwe(e)&&e.type==="radio"},KGe=function(e){return QGe(e)&&!JGe(e)},eje=function(e){var r,i=e&&yk(e),s=(r=i)===null||r===void 0?void 0:r.host,n=!1;if(i&&i!==e){var o,a,l;for(n=!!((o=s)!==null&&o!==void 0&&(a=o.ownerDocument)!==null&&a!==void 0&&a.contains(s)||e!=null&&(l=e.ownerDocument)!==null&&l!==void 0&&l.contains(e));!n&&s;){var c,h,p;i=yk(s),s=(c=i)===null||c===void 0?void 0:c.host,n=!!((h=s)!==null&&h!==void 0&&(p=h.ownerDocument)!==null&&p!==void 0&&p.contains(s))}}return n},roe=function(e){var r=e.getBoundingClientRect(),i=r.width,s=r.height;return i===0&&s===0},tje=function(e,r){var i=r.displayCheck,s=r.getShadowRoot;if(getComputedStyle(e).visibility==="hidden")return!0;var n=IT.call(e,"details>summary:first-of-type"),o=n?e.parentElement:e;if(IT.call(o,"details:not([open]) *"))return!0;if(!i||i==="full"||i==="legacy-full"){if(typeof s=="function"){for(var a=e;e;){var l=e.parentElement,c=yk(e);if(l&&!l.shadowRoot&&s(l)===!0)return roe(e);e.assignedSlot?e=e.assignedSlot:!l&&c!==e.ownerDocument?e=c.host:e=l}e=a}if(eje(e))return!e.getClientRects().length;if(i!=="legacy-full")return!0}else if(i==="non-zero-area")return roe(e);return!1},rje=function(e){if(/^(INPUT|BUTTON|SELECT|TEXTAREA)$/.test(e.tagName))for(var r=e.parentElement;r;){if(r.tagName==="FIELDSET"&&r.disabled){for(var i=0;i<r.children.length;i++){var s=r.children.item(i);if(s.tagName==="LEGEND")return IT.call(r,"fieldset[disabled] *")?!0:!s.contains(e)}return!0}r=r.parentElement}return!1},vk=function(e,r){return!(r.disabled||_k(r)||ZGe(r)||tje(r,e)||XGe(r)||rje(r))},M7=function(e,r){return!(KGe(r)||Rwe(r)<0||!vk(e,r))},ije=function(e){var r=parseInt(e.getAttribute("tabindex"),10);return!!(isNaN(r)||r>=0)},sje=function t(e){var r=[],i=[];return e.forEach(function(s,n){var o=!!s.scopeParent,a=o?s.scopeParent:s,l=Rwe(a,o),c=o?t(s.candidates):a;l===0?o?r.push.apply(r,c):r.push(a):i.push({documentOrder:n,tabIndex:l,item:s,isScope:o,content:c})}),i.sort(WGe).reduce(function(s,n){return n.isScope?s.push.apply(s,n.content):s.push(n.content),s},[]).concat(r)},nje=function(e,r){r=r||{};var i;return r.getShadowRoot?i=Owe([e],r.includeContainer,{filter:M7.bind(null,r),flatten:!1,getShadowRoot:r.getShadowRoot,shadowRootFilter:ije}):i=Awe(e,r.includeContainer,M7.bind(null,r)),sje(i)},RFt=function(e,r){r=r||{};var i;return r.getShadowRoot?i=Owe([e],r.includeContainer,{filter:vk.bind(null,r),flatten:!0,getShadowRoot:r.getShadowRoot}):i=Awe(e,r.includeContainer,vk.bind(null,r)),i},MFt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return IT.call(e,gk)===!1?!1:M7(r,e)},oje=Ewe.concat("iframe").join(","),IFt=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return IT.call(e,oje)===!1?!1:vk(r,e)};const aje={getShadowRoot:!0};function PFt(t){return Array.isArray(t)?t:Array.from(t)}function $Ft(t){const e="dir",r=`[${e}]`,i=lje(t,r);return i?i.getAttribute(e):"ltr"}function LFt(t,e,r){const i=`[${e}]`,s=t.closest(i);return s?s.getAttribute(e):r}function sK(t){return t.getRootNode()}function DFt(t){const e=sK(t);return"host"in e?e:null}function Iwe(t){return t.host||null}function NFt(t,{selector:e,id:r}){function i(s){if(!s)return null;s.assignedSlot&&(s=s.assignedSlot);const n=sK(s),o=r?"getElementById"in n?n.getElementById(r):null:e?n.querySelector(e):null,a=Iwe(n);return o||(a?i(a):null)}return i(t)}function lje(t,e){function r(i){return i?i.closest(e)||r(Iwe(sK(i))):null}return r(t)}function cje(t,e){return Pwe(t,e)}function Pwe(t,e){if(!t)return;const r=e(t);if(r!==void 0)return r;const{parentNode:i}=t;return Pwe(i instanceof ShadowRoot?i.host:i,e)}function FFt(t,e){return!!cje(e,r=>r===t?!0:void 0)}function uje(t){return typeof t?.setFocus=="function"}async function kFt(t){if(t)return uje(t)?t.setFocus():t.focus()}function UFt(t){t&&(nje(t,aje)[0]||t).focus()}const WI=":not([slot])";function VFt(t,e,r){e&&!Array.isArray(e)&&typeof e!="string"&&(r=e,e=null);const i=e?Array.isArray(e)?e.map(s=>`[slot="${s}"]`).join(","):`[slot="${e}"]`:WI;return r?.all?hje(t,i,r):dje(t,i,r)}function $we(t,e){return t?Array.from(t.children||[]).filter(r=>r?.matches(e)):[]}function hje(t,e,r){let i=e===WI?$we(t,WI):Array.from(t.querySelectorAll(e));i=r&&r.direct===!1?i:i.filter(n=>n.parentElement===t),i=r?.matches?i.filter(n=>n?.matches(r.matches)):i;const s=r?.selector;return s?i.map(n=>Array.from(n.querySelectorAll(s))).reduce((n,o)=>[...n,...o],[]).filter(n=>!!n):i}function dje(t,e,r){let i=e===WI?$we(t,WI)[0]||null:t.querySelector(e);i=r&&r.direct===!1||i?.parentElement===t?i:null,i=r?.matches?i?.matches(r.matches)?i:null:i;const s=r?.selector;return s?i?.querySelector(s):i}function zFt(t,e,r){if(typeof e=="string"&&e!=="")return e;if(e==="")return t[r]}function BFt(t){return(!!t).toString()}function GFt(t){return!!pje(t).length}function pje(t){return t.target.assignedElements({flatten:!0})}function jFt(t){return!!(t.isPrimary&&t.button===0)}/*!
 * All material copyright ESRI, All Rights Reserved, unless otherwise specified.
 * See https://github.com/Esri/calcite-components/blob/master/LICENSE.md for details.
 * v1.4.2
 */function ioe(){const{classList:t}=document.body,e=window.matchMedia("(prefers-color-scheme: dark)").matches,r=()=>t.contains(Swe)||t.contains(Twe)&&e?"dark":"light",i=o=>document.body.dispatchEvent(new CustomEvent("calciteModeChange",{bubbles:!0,detail:{mode:o}})),s=o=>{n!==o&&i(o),n=o};let n=r();i(n),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",o=>s(o.matches?"dark":"light")),new MutationObserver(()=>s(r())).observe(document.body,{attributes:!0,attributeFilter:["class"]})}function fje(){typeof window<"u"&&typeof location<"u"&&typeof document<"u"&&window.location===location&&window.document===document&&(document.readyState==="interactive"?ioe():document.addEventListener("DOMContentLoaded",()=>ioe(),{once:!0}))}const mje=fje;mje();let Lwe;function gje(){try{tGe(".")}catch{rGe(pc(Dr(Lwe)))}}function oO(t){const e=[];for(const r of Object.keys(t))customElements.get(`calcite-${r}`)||e.push(t[r]?.());return Promise.all(e)}Lwe="components/assets";const Dwe=Symbol("widget"),yje=Symbol("widget-test-data"),_je=[],vje={},bk=new WeakMap;function Nwe(t,e){let r=e.children;if(r&&r.length)for(let s=0;s<r.length;++s)r[s]=Nwe(t,r[s]);else r=_je;const i=e.vnodeSelector;if(nK(i)){const s=e.properties||vje,n=s.key||i;return{vnodeSelector:"div",properties:{key:n,afterCreate:bje,afterUpdate:wje,afterRemoved:Fwe,parentWidget:t,widgetConstructor:i,widgetProperties:{...s,key:n,children:r}},children:void 0,text:void 0,domNode:null}}return e}function bje(t,e,r,{parentWidget:i,widgetConstructor:s,widgetProperties:n}){const o=new s(n);o.container=t,bk.set(t,o),o.afterCreate?.(o,t),i._internalHandles.add(Zr(()=>Fwe(t)))}function wje(t,e,r,{widgetProperties:i}){const s=bk.get(t);s&&(s.set(i),s.afterUpdate?.(s,t))}function Fwe(t){const e=bk.get(t);e&&(e.afterRemoved?.(e,t),e.destroy(),bk.delete(t))}function nK(t){return typeof t=="function"&&t[Dwe]}const soe=new Set;function xje(t){soe.add(t),t.finally(()=>soe.delete(t))}var kwe;const Tje="esri.widgets.Widget";let Sje=0;const Eje={widgetIcon:"esri-icon-checkbox-unchecked"};function Uwe(t,e){for(const r in e)t[r]!=null&&(typeof t[r]=="object"&&typeof e[r]=="object"?Uwe(t[r],e?.[r]):t[r]=e[r]);return t}const Cje=eGe({postProcessProjectionOptions(t){const e=t.eventHandlerInterceptor,r=/capture$/i;t.eventHandlerInterceptor=(i,s,n,o)=>{const a=e?.(i,s,n,o),l=r.test(i);if(!((i=i.replace(r,"")).toLowerCase()in n)||l){const c=i[2].toLowerCase()+i.slice(3),h=m=>a?.call(n,m);n.addEventListener(c,h,l);const p=()=>n.removeEventListener(c,h,l),f=o.afterRemoved;o.afterRemoved=m=>{f?.(m),p()}}return a}},handleInterceptedEvent(t,e,r,i){const{eventPhase:s,type:n}=i,o=s===Event.CAPTURING_PHASE;let a=`on${n}${o?"capture":""}`;const l=e.properties;(l&&a in l||(a=`on${n[0].toUpperCase()}${n.slice(1)}${o?"Capture":""}`,l&&a in l))&&(Kbe(),t.scheduleRender(),l[a].call(l.bind||r,i))}});let A9=!1,mo=class extends e$(Xr.EventedAccessor){constructor(e,r){super(e,r),this._attached=!1,this._internalHandles=new li,this._projector=Cje,this._readyForTrueRender=!1,this.iconClass=Eje.widgetIcon,this.icon=null,this.key=this,this._loadLocale=x1(async()=>{if(this._messageBundleProps&&this._messageBundleProps.length){const o=await Oh(this._messageBundleProps.map(async({bundlePath:a,propertyName:l})=>{if(this.destroyed)return;let c=await ove(a);this.uiStrings&&Object.keys(this.uiStrings)&&(c=Uwe(re(c),this.uiStrings)),this[l]=c}));if(this.destroyed)return;for(const a of o)a.error&&K.getLogger(this).error("widget-intl:locale-error",this.declaredClass,a.error)}await this.loadLocale()}),gje();const i="esri-widget-uid-"+j6(),s=this.render.bind(this);this._trackingTarget=new P6(()=>this.scheduleRender());const n=()=>{if(!this._readyForTrueRender||this.destroyed)return null;const o=s();let{properties:a}=o;a||(o.properties=a={});const{key:l}=a;l||(a.key=i),this.visible?a.styles||(a.styles={}):(a.class="",a.styles={display:"none"}),a.styles.display||(a.styles.display="");let c=0;return o.children?.forEach(h=>{if(nK(h.vnodeSelector))return;let{properties:p}=h;p||(h.properties=p={}),p.key||(p.key=`${this.id}--${c++}`)}),Nwe(this,o)};this.render=()=>{if(A9)return n();let o=RBe(this)??null;if(o)return o;this._trackingTarget.clear(),A9=!0;try{o=S0(this._trackingTarget,n)}catch(a){throw console.error(a),a}finally{A9=!1}return o&&MBe(this,o),o},this.addResolvingPromise(this._resourcesFetch=this.beforeFirstRender().then(()=>{this._readyForTrueRender=!0,this._postInitialize()})),xje(this._resourcesFetch)}normalizeCtorArgs(e,r){const i={...e};return r&&(i.container=r),i}postInitialize(){}beforeFirstRender(){return Promise.all([this.loadDependencies(),this._loadLocale()]).then(()=>{}).catch(Uj)}async loadDependencies(){}async loadLocale(){}destroy(){this.destroyed||(Re(this._trackingTarget),Re(this.viewModel),this._detach(this.container),this._set("container",null),this._internalHandles.destroy(),this._emitter.clear(),this.render=()=>null,this._projector=null,E9(this))}set container(e){this._get("container")||this._set("container",e)}castContainer(e){return G6(e)}get domNode(){return this.container}set domNode(e){this.container=e}get id(){return this._get("id")||this.get("container.id")||Date.now().toString(16)+"-widget-"+Sje++}set id(e){e&&this._set("id",e)}get label(){return this.declaredClass.split(".").pop()}set label(e){this._overrideIfSome("label",e)}get renderable(){return this._resourcesFetch}get visible(){return this._get("visible")}set visible(e){this._set("visible",e)}get[(kwe=Dwe,yje)](){return{projector:this._projector}}render(){throw new Error("not implemented")}scheduleRender(){this.destroyed||(E9(this),this._projector.scheduleRender())}classes(...e){return JQ.apply(this,e)}renderNow(){E9(this),this._projector.renderNow()}_postInitialize(){if(this.destroyed)return;this.scheduleRender(),this._delegatedEventNames?.length&&this._internalHandles.add(Q(()=>this.viewModel,(r,i)=>{i&&this._internalHandles.remove("delegated-events"),r&&M6(r)&&this._internalHandles.add(this._delegatedEventNames.map(s=>w1(r,s,n=>{this.emit(s,n)})),"delegated-events")},xt)),this.postInitialize();const e=async()=>{await this._loadLocale().catch(Uj),this.scheduleRender()};this._internalHandles.add([Q0e(e),Q(()=>this.uiStrings,e),No(()=>this.container,r=>{this.destroyed||this._attach(r)},{initial:!0,once:!0})])}_attach(e){e&&(this._projector.merge(e,this.render),this._attached=!0)}_detach(e){this._attached&&(this._projector.detach(this.render),this._attached=!1),e?.parentNode?.removeChild(e)}};mo[kwe]=!0,u([d()],mo.prototype,"_readyForTrueRender",void 0),u([d({value:null})],mo.prototype,"container",null),u([or("container")],mo.prototype,"castContainer",null),u([d()],mo.prototype,"iconClass",void 0),u([d()],mo.prototype,"icon",void 0),u([d()],mo.prototype,"id",null),u([d()],mo.prototype,"label",null),u([d()],mo.prototype,"renderable",null),u([d()],mo.prototype,"uiStrings",void 0),u([d()],mo.prototype,"viewModel",void 0),u([d({value:!0})],mo.prototype,"visible",null),u([d()],mo.prototype,"key",void 0),u([d()],mo.prototype,"children",void 0),u([d()],mo.prototype,"afterCreate",void 0),u([d()],mo.prototype,"afterUpdate",void 0),u([d()],mo.prototype,"afterRemoved",void 0),mo=u([R(Tje)],mo);const Rc=mo,rs=t=>{let e=class extends t{clone(){const r=Ha(tl(this),"unable to clone instance of non-accessor class"),i=r.metadatas,s=r.store,n={},o=new Map;for(const l in i){const c=i[l],h=s?.originOf(l),p=c.clonable;if(c.readOnly||p===!1||h!==_r.USER&&h!==_r.DEFAULTS&&h!==_r.WEB_MAP&&h!==_r.WEB_SCENE)continue;const f=this[l];let m=null;m=typeof p=="function"?p(f):p==="reference"?f:Mj(f),f!=null&&m==null||(h===_r.DEFAULTS?o.set(l,m):n[l]=m)}const a=new(Object.getPrototypeOf(this)).constructor(n);if(o.size){const l=tl(a)?.store;if(l)for(const[c,h]of o)l.set(c,h,_r.DEFAULTS)}return a}};return e=u([R("esri.core.Clonable")],e),e};let noe=class extends rs(me){};noe=u([R("esri.core.Clonable")],noe);var mi;(function(t){t[t.ADD=1]="ADD",t[t.REMOVE=2]="REMOVE",t[t.MOVE=4]="MOVE"})(mi||(mi={}));function oK(t){return(e,r)=>{e[r]=t}}let X6=class extends $ve{notify(){const e=this._observers;if(e&&e.length>0){const r=e.slice();for(const i of r)i.onInvalidated(),i.onCommitted()}}};var qy;let Aje=class{constructor(){this.target=null,this.cancellable=!1,this.defaultPrevented=!1,this.item=void 0,this.type=void 0}preventDefault(){this.cancellable&&(this.defaultPrevented=!0)}reset(e){this.defaultPrevented=!1,this.item=e}};const Ih=new $o(Aje,void 0,t=>{t.item=null,t.target=null,t.defaultPrevented=!1,t.cancellable=!1}),Oje=()=>{};function O9(t){return t?t instanceof _x?t.toArray():t.length?Array.prototype.slice.apply(t):[]:[]}function R9(t){if(t&&t.length)return t[0]}function Rje(t,e,r,i){const s=Math.min(t.length-r,e.length-i);let n=0;for(;n<s&&t[r+n]===e[i+n];)n++;return n}function Vwe(t,e,r,i){e&&e.forEach((s,n,o)=>{t.push(s),Vwe(t,r.call(i,s,n,o),r,i)})}const l_=new Set,c_=new Set,u_=new Set,M9=new Map;let Mje=0,_x=qy=class extends Xr.EventedAccessor{static isCollection(t){return t!=null&&t instanceof qy}constructor(t){super(t),this._chgListeners=[],this._notifications=null,this._timer=null,this._observable=new X6,this.length=0,this._items=[],Object.defineProperty(this,"uid",{value:Mje++})}normalizeCtorArgs(t){return t?Array.isArray(t)||t instanceof qy?{items:t}:t:{}}destroy(){this._removeAllRaw()}*[Symbol.iterator](){yield*this.items}get items(){return Jt(this._observable),this._items}set items(t){this._emitBeforeChanges(mi.ADD)||(this._splice(0,this.length,O9(t)),this._emitAfterChanges(mi.ADD))}hasEventListener(t){return t==="change"?this._chgListeners.length>0:this._emitter.hasEventListener(t)}on(t,e){if(t==="change"){const r=this._chgListeners,i={removed:!1,callback:e};return r.push(i),this._notifications&&this._notifications.push({listeners:r.slice(),items:this._items.slice(),changes:[]}),{remove(){this.remove=Oje,i.removed=!0,r.splice(r.indexOf(i),1)}}}return this._emitter.on(t,e)}once(t,e){const r=this.on(t,e);return{remove(){r.remove()}}}add(t,e){if(Jt(this._observable),this._emitBeforeChanges(mi.ADD))return this;const r=this.getNextIndex(e??null);return this._splice(r,0,[t]),this._emitAfterChanges(mi.ADD),this}addMany(t,e=this._items.length){if(Jt(this._observable),!t||!t.length)return this;if(this._emitBeforeChanges(mi.ADD))return this;const r=this.getNextIndex(e);return this._splice(r,0,O9(t)),this._emitAfterChanges(mi.ADD),this}at(t){if(Jt(this._observable),(t=Math.trunc(t)||0)<0&&(t+=this.length),!(t<0||t>=this.length))return this._items[t]}removeAll(){if(Jt(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return[];const t=this._removeAllRaw();return this._emitAfterChanges(mi.REMOVE),t}_removeAllRaw(){return this.length===0?[]:this._splice(0,this.length)||[]}clone(){return Jt(this._observable),this._createNewInstance({items:this._items.map(re)})}concat(...t){Jt(this._observable);const e=t.map(O9);return this._createNewInstance({items:this._items.concat(...e)})}drain(t,e){if(Jt(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const r=this._splice(0,this.length),i=r.length;for(let s=0;s<i;s++)t.call(e,r[s],s,r);this._emitAfterChanges(mi.REMOVE)}every(t,e){return Jt(this._observable),this._items.every(t,e)}filter(t,e){let r;return Jt(this._observable),r=arguments.length===2?this._items.filter(t,e):this._items.filter(t),this._createNewInstance({items:r})}find(t,e){return Jt(this._observable),this._items.find(t,e)}findIndex(t,e){return Jt(this._observable),this._items.findIndex(t,e)}flatten(t,e){Jt(this._observable);const r=[];return Vwe(r,this,t,e),new qy(r)}forEach(t,e){return Jt(this._observable),this._items.forEach(t,e)}getItemAt(t){return Jt(this._observable),this._items[t]}getNextIndex(t){Jt(this._observable);const e=this.length;return(t=t??e)<0?t=0:t>e&&(t=e),t}includes(t,e=0){return Jt(this._observable),this._items.includes(t,e)}indexOf(t,e=0){return Jt(this._observable),this._items.indexOf(t,e)}join(t=","){return Jt(this._observable),this._items.join(t)}lastIndexOf(t,e=this.length-1){return Jt(this._observable),this._items.lastIndexOf(t,e)}map(t,e){Jt(this._observable);const r=this._items.map(t,e);return new qy({items:r})}reorder(t,e=this.length-1){Jt(this._observable);const r=this.indexOf(t);if(r!==-1){if(e<0?e=0:e>=this.length&&(e=this.length-1),r!==e){if(this._emitBeforeChanges(mi.MOVE))return t;this._splice(r,1),this._splice(e,0,[t]),this._emitAfterChanges(mi.MOVE)}return t}}pop(){if(Jt(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const t=R9(this._splice(this.length-1,1));return this._emitAfterChanges(mi.REMOVE),t}push(...t){return Jt(this._observable),this._emitBeforeChanges(mi.ADD)||(this._splice(this.length,0,t),this._emitAfterChanges(mi.ADD)),this.length}reduce(t,e){Jt(this._observable);const r=this._items;return arguments.length===2?r.reduce(t,e):r.reduce(t)}reduceRight(t,e){Jt(this._observable);const r=this._items;return arguments.length===2?r.reduceRight(t,e):r.reduceRight(t)}remove(t){return Jt(this._observable),this.removeAt(this.indexOf(t))}removeAt(t){if(Jt(this._observable),t<0||t>=this.length||this._emitBeforeChanges(mi.REMOVE))return;const e=R9(this._splice(t,1));return this._emitAfterChanges(mi.REMOVE),e}removeMany(t){if(Jt(this._observable),!t||!t.length||this._emitBeforeChanges(mi.REMOVE))return[];const e=t instanceof qy?t.toArray():t,r=this._items,i=[],s=e.length;for(let n=0;n<s;n++){const o=e[n],a=r.indexOf(o);if(a>-1){const l=1+Rje(e,r,n+1,a+1),c=this._splice(a,l);c&&c.length>0&&i.push.apply(i,c),n+=l-1}}return this._emitAfterChanges(mi.REMOVE),i}reverse(){if(Jt(this._observable),this._emitBeforeChanges(mi.MOVE))return this;const t=this._splice(0,this.length);return t&&(t.reverse(),this._splice(0,0,t)),this._emitAfterChanges(mi.MOVE),this}shift(){if(Jt(this._observable),!this.length||this._emitBeforeChanges(mi.REMOVE))return;const t=R9(this._splice(0,1));return this._emitAfterChanges(mi.REMOVE),t}slice(t=0,e=this.length){return Jt(this._observable),this._createNewInstance({items:this._items.slice(t,e)})}some(t,e){return Jt(this._observable),this._items.some(t,e)}sort(t){if(Jt(this._observable),!this.length||this._emitBeforeChanges(mi.MOVE))return this;const e=this._splice(0,this.length);return arguments.length?e.sort(t):e.sort(),this._splice(0,0,e),this._emitAfterChanges(mi.MOVE),this}splice(t,e,...r){Jt(this._observable);const i=(e?mi.REMOVE:0)|(r.length?mi.ADD:0);if(this._emitBeforeChanges(i))return[];const s=this._splice(t,e,r)||[];return this._emitAfterChanges(i),s}toArray(){return Jt(this._observable),this._items.slice()}toJSON(){return Jt(this._observable),this.toArray()}toLocaleString(){return Jt(this._observable),this._items.toLocaleString()}toString(){return Jt(this._observable),this._items.toString()}unshift(...t){return Jt(this._observable),!t.length||this._emitBeforeChanges(mi.ADD)||(this._splice(0,0,t),this._emitAfterChanges(mi.ADD)),this.length}_createNewInstance(t){return new this.constructor(t)}_splice(t,e,r){const i=this._items,s=this.itemType;let n,o;if(!this._notifications&&this.hasEventListener("change")&&(this._notifications=[{listeners:this._chgListeners.slice(),items:this._items.slice(),changes:[]}],this._timer&&this._timer.remove(),this._timer=iO(()=>this._dispatchChange())),e){if(o=i.splice(t,e),this.hasEventListener("before-remove")){const a=Ih.acquire();a.target=this,a.cancellable=!0;for(let l=0,c=o.length;l<c;l++)n=o[l],a.reset(n),this.emit("before-remove",a),a.defaultPrevented&&(o.splice(l,1),i.splice(t,0,n),t+=1,l-=1,c-=1);Ih.release(a)}if(this.length=this._items.length,this.hasEventListener("after-remove")){const a=Ih.acquire();a.target=this,a.cancellable=!1;const l=o.length;for(let c=0;c<l;c++)a.reset(o[c]),this.emit("after-remove",a);Ih.release(a)}}if(r&&r.length){if(s){const h=[];for(const p of r){const f=s.ensureType(p);f==null&&p!=null||h.push(f)}r=h}const a=this.hasEventListener("before-add"),l=this.hasEventListener("after-add"),c=t===this.length;if(a||l){const h=Ih.acquire();h.target=this,h.cancellable=!0;const p=Ih.acquire();p.target=this,p.cancellable=!1;for(const f of r)a?(h.reset(f),this.emit("before-add",h),h.defaultPrevented||(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),l&&(p.reset(f),this.emit("after-add",p)))):(c?i.push(f):i.splice(t++,0,f),this._set("length",i.length),p.reset(f),this.emit("after-add",p));Ih.release(p),Ih.release(h)}else{if(c)for(const h of r)i.push(h);else i.splice(t,0,...r);this._set("length",i.length)}}return(r&&r.length||o&&o.length)&&this._notifyChangeEvent(r,o),o}_emitBeforeChanges(t){let e=!1;if(this.hasEventListener("before-changes")){const r=Ih.acquire();r.target=this,r.cancellable=!0,r.type=t,this.emit("before-changes",r),e=r.defaultPrevented,Ih.release(r)}return e}_emitAfterChanges(t){if(this.hasEventListener("after-changes")){const e=Ih.acquire();e.target=this,e.cancellable=!1,e.type=t,this.emit("after-changes",e),Ih.release(e)}this._observable.notify()}_notifyChangeEvent(t,e){this.hasEventListener("change")&&this._notifications&&this._notifications[this._notifications.length-1].changes.push({added:t,removed:e})}_dispatchChange(){if(this._timer&&(this._timer.remove(),this._timer=null),!this._notifications)return;const t=this._notifications;this._notifications=null;for(const e of t){const r=e.changes;l_.clear(),c_.clear(),u_.clear();for(const{added:l,removed:c}of r){if(l)if(u_.size===0&&c_.size===0)for(const h of l)l_.add(h);else for(const h of l)c_.has(h)?(u_.add(h),c_.delete(h)):u_.has(h)||l_.add(h);if(c)if(u_.size===0&&l_.size===0)for(const h of c)c_.add(h);else for(const h of c)l_.has(h)?l_.delete(h):(u_.delete(h),c_.add(h))}const i=pu.acquire();l_.forEach(l=>{i.push(l)});const s=pu.acquire();c_.forEach(l=>{s.push(l)});const n=this._items,o=e.items,a=pu.acquire();if(u_.forEach(l=>{o.indexOf(l)!==n.indexOf(l)&&a.push(l)}),e.listeners&&(i.length||s.length||a.length)){const l={target:this,added:i,removed:s,moved:a},c=e.listeners.length;for(let h=0;h<c;h++){const p=e.listeners[h];p.removed||p.callback.call(this,l)}}pu.release(i),pu.release(s),pu.release(a)}l_.clear(),c_.clear(),u_.clear()}};_x.ofType=t=>{if(!t)return qy;if(M9.has(t))return M9.get(t);let e=null;if(typeof t=="function")e=t.prototype.declaredClass;else if(t.base)e=t.base.prototype.declaredClass;else for(const i in t.typeMap){const s=t.typeMap[i].prototype.declaredClass;e?e+=` | ${s}`:e=s}let r=class extends qy{};return u([oK({Type:t,ensureType:typeof t=="function"?Sn(t):Rf(t)})],r.prototype,"itemType",void 0),r=u([R(`esri.core.Collection<${e}>`)],r),M9.set(t,r),r},u([d()],_x.prototype,"length",void 0),u([d()],_x.prototype,"items",null),_x=qy=u([R("esri.core.Collection")],_x);const Ke=_x;let IF=class extends he{constructor(e){super(e),this.type=null}};u([d({type:["attachments","custom","fields","media","text","expression","relationship"],readOnly:!0,json:{read:!1,write:!0}})],IF.prototype,"type",void 0),IF=u([R("esri.popup.content.Content")],IF);const ab=IF;var I7;let hw=I7=class extends ab{constructor(t){super(t),this.description=null,this.displayType="auto",this.title=null,this.type="attachments"}clone(){return new I7({description:this.description,displayType:this.displayType,title:this.title})}};u([d({type:String,json:{write:!0}})],hw.prototype,"description",void 0),u([d({type:["auto","preview","list"],json:{write:!0}})],hw.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],hw.prototype,"title",void 0),u([d({type:["attachments"],readOnly:!0,json:{read:!1,write:!0}})],hw.prototype,"type",void 0),hw=I7=u([R("esri.popup.content.AttachmentsContent")],hw);const ZI=hw;var P7;let dw=P7=class extends ab{constructor(t){super(t),this.creator=null,this.destroyer=null,this.outFields=null,this.type="custom"}clone(){return new P7({creator:this.creator,destroyer:this.destroyer,outFields:Array.isArray(this.outFields)?re(this.outFields):null})}};u([d()],dw.prototype,"creator",void 0),u([d()],dw.prototype,"destroyer",void 0),u([d()],dw.prototype,"outFields",void 0),u([d({type:["custom"],readOnly:!0})],dw.prototype,"type",void 0),dw=P7=u([R("esri.popup.content.CustomContent")],dw);const Ije=dw;var $7;let G2=$7=class extends he{constructor(t){super(t),this.title=null,this.expression=null,this.returnType="dictionary"}clone(){return new $7({title:this.title,expression:this.expression})}};u([d({type:String,json:{write:!0}})],G2.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],G2.prototype,"expression",void 0),u([d({type:["dictionary"],readOnly:!0,json:{read:!1,write:!0}})],G2.prototype,"returnType",void 0),G2=$7=u([R("esri.popup.ElementExpressionInfo")],G2);const Pje=G2;var L7;let e3=L7=class extends ab{constructor(t){super(t),this.expressionInfo=null,this.type="expression"}clone(){return new L7({expressionInfo:this.expressionInfo?.clone()})}};u([d({type:Pje,json:{write:!0}})],e3.prototype,"expressionInfo",void 0),u([d({type:["expression"],readOnly:!0,json:{read:!1,write:!0}})],e3.prototype,"type",void 0),e3=L7=u([R("esri.popup.content.ExpressionContent")],e3);const aK=e3;function nt(t,e={}){const r=t instanceof kr?t:new kr(t,e),i={type:e?.ignoreUnknown??1?r.apiValues:String,json:{type:r.jsonValues,read:!e?.readOnly&&{reader:r.read},write:{writer:r.write}}};return e?.readOnly!==void 0&&(i.readOnly=!!e.readOnly),e?.default!==void 0&&(i.json.default=e.default),e?.name!==void 0&&(i.json.name=e.name),e?.nonNullable!==void 0&&(i.nonNullable=e.nonNullable),d(i)}let j2=class extends rs(he){constructor(e){super(e),this.dateFormat=null,this.digitSeparator=!1,this.places=null}formatNumber(e){return zd(e,tve(this))}formatDate(e,r=!1){return this.dateFormat?Vd(e,{...zE(this.dateFormat),...r&&kJ}):this.formatNumber(e)}formatDateOnly(e){const r=(this.dateFormat&&zE(this.dateFormat))??void 0;return UJ(e,r)}formatTimeOnly(e){const r=(this.dateFormat&&zE(this.dateFormat))??void 0;return VJ(e,r)}formatTimestamp(e){const r=(this.dateFormat&&zE(this.dateFormat))??void 0;return zJ(e,r)}formatRasterPixelValue(e){return e.includes("-")?e:e.trim().includes(",")?this._formatDelimitedString(e,",",", "):e.trim().includes(";")?this._formatDelimitedString(e,";","; "):e.trim().includes(" ")?this._formatDelimitedString(e," "," "):this.formatNumber(Number(e))}_formatDelimitedString(e,r,i){return e&&r&&i?e.trim().split(r).map(s=>this.formatNumber(Number(s))).join(i):e}};u([nt(Nke)],j2.prototype,"dateFormat",void 0),u([d({type:Boolean,json:{write:!0}})],j2.prototype,"digitSeparator",void 0),u([d({type:Ki,json:{write:!0}})],j2.prototype,"places",void 0),j2=u([R("esri.popup.support.FieldInfoFormat")],j2);const qE=j2;var D7;let Tp=D7=class extends he{constructor(t){super(t),this.fieldName=null,this.format=null,this.isEditable=!0,this.label=null,this.stringFieldOption="text-box",this.statisticType=null,this.tooltip=null,this.visible=!0}clone(){return new D7({fieldName:this.fieldName,format:this.format?re(this.format):null,isEditable:this.isEditable,label:this.label,stringFieldOption:this.stringFieldOption,statisticType:this.statisticType,tooltip:this.tooltip,visible:this.visible})}};u([d({type:String,json:{write:!0}})],Tp.prototype,"fieldName",void 0),u([d({type:qE,json:{write:!0}})],Tp.prototype,"format",void 0),u([d({type:Boolean,json:{write:{alwaysWriteDefaults:!0},default:!0}})],Tp.prototype,"isEditable",void 0),u([d({type:String,json:{write:!0}})],Tp.prototype,"label",void 0),u([nt(new kr({richtext:"rich-text",textarea:"text-area",textbox:"text-box"}),{default:"text-box"})],Tp.prototype,"stringFieldOption",void 0),u([d({type:["count","sum","min","max","avg","stddev","var"],json:{write:!0}})],Tp.prototype,"statisticType",void 0),u([d({type:String,json:{write:!0}})],Tp.prototype,"tooltip",void 0),u([d({type:Boolean,json:{write:!0}})],Tp.prototype,"visible",void 0),Tp=D7=u([R("esri.popup.FieldInfo")],Tp);const lK=Tp;var N7;let uy=N7=class extends ab{constructor(t){super(t),this.attributes=null,this.description=null,this.fieldInfos=null,this.title=null,this.type="fields"}writeFieldInfos(t,e){e.fieldInfos=t&&t.map(r=>r.toJSON())}clone(){return new N7(re({attributes:this.attributes,description:this.description,fieldInfos:this.fieldInfos,title:this.title}))}};u([d({type:Object,json:{write:!0}})],uy.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],uy.prototype,"description",void 0),u([d({type:[lK]})],uy.prototype,"fieldInfos",void 0),u([Ve("fieldInfos")],uy.prototype,"writeFieldInfos",null),u([d({type:String,json:{write:!0}})],uy.prototype,"title",void 0),u([d({type:["fields"],readOnly:!0,json:{read:!1,write:!0}})],uy.prototype,"type",void 0),uy=N7=u([R("esri.popup.content.FieldsContent")],uy);const XI=uy;let pw=class extends he{constructor(e){super(e),this.altText=null,this.caption="",this.title="",this.type=null}};u([d({type:String,json:{write:!0}})],pw.prototype,"altText",void 0),u([d({type:String,json:{write:!0}})],pw.prototype,"caption",void 0),u([d({type:String,json:{write:!0}})],pw.prototype,"title",void 0),u([d({type:["image","bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],pw.prototype,"type",void 0),pw=u([R("esri.popup.content.mixins.MediaInfo")],pw);const cK=pw;var F7;let H2=F7=class extends me{constructor(t){super(t),this.fieldName=null,this.tooltip=null,this.value=null}clone(){return new F7({fieldName:this.fieldName,tooltip:this.tooltip,value:this.value})}};u([d()],H2.prototype,"fieldName",void 0),u([d()],H2.prototype,"tooltip",void 0),u([d()],H2.prototype,"value",void 0),H2=F7=u([R("esri.popup.content.support.ChartMediaInfoValueSeries")],H2);const $je=H2;var k7;let fw=k7=class extends he{constructor(t){super(t),this.fields=[],this.normalizeField=null,this.series=[],this.tooltipField=null}clone(){return new k7({fields:re(this.fields),normalizeField:this.normalizeField,tooltipField:this.tooltipField})}};u([d({type:[String],json:{write:!0}})],fw.prototype,"fields",void 0),u([d({type:String,json:{write:!0}})],fw.prototype,"normalizeField",void 0),u([d({type:[$je],json:{read:!1}})],fw.prototype,"series",void 0),u([d({type:String,json:{write:!0}})],fw.prototype,"tooltipField",void 0),fw=k7=u([R("esri.popup.content.support.ChartMediaInfoValue")],fw);const Lje=fw;let t3=class extends cK{constructor(e){super(e),this.type=null,this.value=null}};u([d({type:["bar-chart","column-chart","line-chart","pie-chart"],readOnly:!0,json:{read:!1,write:!0}})],t3.prototype,"type",void 0),u([d({type:Lje,json:{write:!0}})],t3.prototype,"value",void 0),t3=u([R("esri.popup.content.mixins.ChartMediaInfo")],t3);const Y6=t3,J6=zl()({barchart:"bar-chart",columnchart:"column-chart",linechart:"line-chart",piechart:"pie-chart"});var U7;let PF=U7=class extends Y6{constructor(t){super(t),this.type="bar-chart"}clone(){return new U7({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["bar-chart"],readOnly:!0,json:{type:["barchart"],read:!1,write:J6.write}})],PF.prototype,"type",void 0),PF=U7=u([R("esri.popup.content.BarChartMediaInfo")],PF);const zwe=PF;var V7;let $F=V7=class extends Y6{constructor(t){super(t),this.type="column-chart"}clone(){return new V7({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["column-chart"],readOnly:!0,json:{type:["columnchart"],read:!1,write:J6.write}})],$F.prototype,"type",void 0),$F=V7=u([R("esri.popup.content.ColumnChartMediaInfo")],$F);const Bwe=$F;var z7;let r3=z7=class extends he{constructor(t){super(t),this.linkURL=null,this.sourceURL=null}clone(){return new z7({linkURL:this.linkURL,sourceURL:this.sourceURL})}};u([d({type:String,json:{write:!0}})],r3.prototype,"linkURL",void 0),u([d({type:String,json:{write:!0}})],r3.prototype,"sourceURL",void 0),r3=z7=u([R("esri.popup.content.support.ImageMediaInfoValue")],r3);const Dje=r3;var B7;let q2=B7=class extends cK{constructor(t){super(t),this.refreshInterval=null,this.type="image",this.value=null}clone(){return new B7({altText:this.altText,title:this.title,caption:this.caption,refreshInterval:this.refreshInterval,value:this.value?this.value.clone():null})}};u([d({type:Number,json:{write:!0}})],q2.prototype,"refreshInterval",void 0),u([d({type:["image"],readOnly:!0,json:{read:!1,write:!0}})],q2.prototype,"type",void 0),u([d({type:Dje,json:{write:!0}})],q2.prototype,"value",void 0),q2=B7=u([R("esri.popup.content.ImageMediaInfo")],q2);const Gwe=q2;var G7;let LF=G7=class extends Y6{constructor(t){super(t),this.type="line-chart"}clone(){return new G7({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["line-chart"],readOnly:!0,json:{type:["linechart"],read:!1,write:J6.write}})],LF.prototype,"type",void 0),LF=G7=u([R("esri.popup.content.LineChartMediaInfo")],LF);const jwe=LF;var j7;let DF=j7=class extends Y6{constructor(t){super(t),this.type="pie-chart"}clone(){return new j7({altText:this.altText,title:this.title,caption:this.caption,value:this.value?this.value.clone():null})}};u([d({type:["pie-chart"],readOnly:!0,json:{type:["piechart"],read:!1,write:J6.write}})],DF.prototype,"type",void 0),DF=j7=u([R("esri.popup.content.PieChartMediaInfo")],DF);const Hwe=DF,qwe={base:cK,key:"type",defaultKeyValue:"image",typeMap:{"bar-chart":zwe,"column-chart":Bwe,"line-chart":jwe,"pie-chart":Hwe,image:Gwe}};var H7;let Sp=H7=class extends ab{constructor(t){super(t),this.activeMediaInfoIndex=null,this.attributes=null,this.description=null,this.mediaInfos=null,this.title=null,this.type="media"}readMediaInfos(t){return t&&t.map(e=>e.type==="image"?Gwe.fromJSON(e):e.type==="barchart"?zwe.fromJSON(e):e.type==="columnchart"?Bwe.fromJSON(e):e.type==="linechart"?jwe.fromJSON(e):e.type==="piechart"?Hwe.fromJSON(e):void 0).filter(Boolean)}writeMediaInfos(t,e){e.mediaInfos=t&&t.map(r=>r.toJSON())}clone(){return new H7(re({activeMediaInfoIndex:this.activeMediaInfoIndex,attributes:this.attributes,description:this.description,mediaInfos:this.mediaInfos,title:this.title}))}};u([d()],Sp.prototype,"activeMediaInfoIndex",void 0),u([d({type:Object,json:{write:!0}})],Sp.prototype,"attributes",void 0),u([d({type:String,json:{write:!0}})],Sp.prototype,"description",void 0),u([d({types:[qwe]})],Sp.prototype,"mediaInfos",void 0),u([Ae("mediaInfos")],Sp.prototype,"readMediaInfos",null),u([Ve("mediaInfos")],Sp.prototype,"writeMediaInfos",null),u([d({type:String,json:{write:!0}})],Sp.prototype,"title",void 0),u([d({type:["media"],readOnly:!0,json:{read:!1,write:!0}})],Sp.prototype,"type",void 0),Sp=H7=u([R("esri.popup.content.MediaContent")],Sp);const wk=Sp;var q7;let i3=q7=class extends he{constructor(t){super(t),this.field=null,this.order=null}clone(){return new q7({field:this.field,order:this.order})}};u([d({type:String,json:{write:!0}})],i3.prototype,"field",void 0),u([d({type:["asc","desc"],json:{write:!0}})],i3.prototype,"order",void 0),i3=q7=u([R("esri.popup.support.RelatedRecordsInfoFieldOrder")],i3);const uK=i3;let _m=class extends rs(ab){constructor(e){super(e),this.description=null,this.displayCount=null,this.displayType="list",this.orderByFields=null,this.relationshipId=null,this.title=null,this.type="relationship"}};u([d({type:String,json:{write:!0}})],_m.prototype,"description",void 0),u([d({type:Number,json:{type:Ki,write:!0}})],_m.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],_m.prototype,"displayType",void 0),u([d({type:[uK],json:{write:!0}})],_m.prototype,"orderByFields",void 0),u([d({type:Number,json:{type:Ki,write:!0}})],_m.prototype,"relationshipId",void 0),u([d({type:String,json:{write:!0}})],_m.prototype,"title",void 0),u([d({type:["relationship"],readOnly:!0,json:{read:!1,write:!0}})],_m.prototype,"type",void 0),_m=u([R("esri.popup.content.RelationshipContent")],_m);const xk=_m;var W7;let s3=W7=class extends ab{constructor(t){super(t),this.text=null,this.type="text"}clone(){return new W7({text:this.text})}};u([d({type:String,json:{write:!0}})],s3.prototype,"text",void 0),u([d({type:["text"],readOnly:!0,json:{read:!1,write:!0}})],s3.prototype,"type",void 0),s3=W7=u([R("esri.popup.content.TextContent")],s3);const Tk=s3,Nje={base:null,key:"type",typeMap:{attachment:ZI,media:wk,text:Tk,expression:aK,field:XI,relationship:xk}};var Z7;let mw=Z7=class extends he{constructor(t){super(t),this.name=null,this.title=null,this.expression=null,this.returnType=null}clone(){return new Z7({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],mw.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],mw.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],mw.prototype,"expression",void 0),u([d({type:["string","number"],json:{write:!0}})],mw.prototype,"returnType",void 0),mw=Z7=u([R("esri.popup.ExpressionInfo")],mw);const Fje=mw;var X7;let n3=X7=class extends he{constructor(t){super(t),this.returnTopmostRaster=null,this.showNoDataRecords=null}clone(){return new X7({showNoDataRecords:this.showNoDataRecords,returnTopmostRaster:this.returnTopmostRaster})}};u([d({type:Boolean,json:{write:!0}})],n3.prototype,"returnTopmostRaster",void 0),u([d({type:Boolean,json:{write:!0}})],n3.prototype,"showNoDataRecords",void 0),n3=X7=u([R("esri.popup.LayerOptions")],n3);const kje=n3;var Y7;let o3=Y7=class extends he{constructor(t){super(t),this.showRelatedRecords=null,this.orderByFields=null}clone(){return new Y7({showRelatedRecords:this.showRelatedRecords,orderByFields:this.orderByFields?re(this.orderByFields):null})}};u([d({type:Boolean,json:{write:!0}})],o3.prototype,"showRelatedRecords",void 0),u([d({type:[uK],json:{write:!0}})],o3.prototype,"orderByFields",void 0),o3=Y7=u([R("esri.popup.RelatedRecordsInfo")],o3);const Uje=o3;let Wwe=0;const aS=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Date.now().toString(16)+"-object-"+Wwe++})}};return e=u([R("esri.core.Identifiable")],e),e},e4t=t=>{let e=class extends t{constructor(...r){super(...r),Object.defineProperty(this,"uid",{writable:!1,configurable:!1,value:Wwe++})}};return e=u([R("esri.core.NumericIdentifiable")],e),e};let ooe=class extends aS(class{}){};ooe=u([R("esri.core.Identifiable")],ooe);var J7;let Hh=J7=class extends aS(me){constructor(t){super(t),this.active=!1,this.className=null,this.disabled=!1,this.icon=null,this.id=null,this.indicator=!1,this.title=null,this.type=null,this.visible=!0}clone(){return new J7({active:this.active,className:this.className,disabled:this.disabled,icon:this.icon,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible})}};u([d()],Hh.prototype,"active",void 0),u([d()],Hh.prototype,"className",void 0),u([d()],Hh.prototype,"disabled",void 0),u([d()],Hh.prototype,"icon",void 0),u([d()],Hh.prototype,"id",void 0),u([d()],Hh.prototype,"indicator",void 0),u([d()],Hh.prototype,"title",void 0),u([d()],Hh.prototype,"type",void 0),u([d()],Hh.prototype,"visible",void 0),Hh=J7=u([R("esri.support.actions.ActionBase")],Hh);const s$=Hh;var Q7;let NF=Q7=class extends s${constructor(t){super(t),this.image=null,this.type="button"}clone(){return new Q7({active:this.active,className:this.className,disabled:this.disabled,icon:this.icon,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image})}};u([d()],NF.prototype,"image",void 0),NF=Q7=u([R("esri.support.Action.ActionButton")],NF);const Zwe=NF;var K7;let a3=K7=class extends s${constructor(t){super(t),this.image=null,this.type="toggle",this.value=!1}clone(){return new K7({active:this.active,className:this.className,disabled:this.disabled,icon:this.icon,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,image:this.image,value:this.value})}};u([d()],a3.prototype,"image",void 0),u([d()],a3.prototype,"value",void 0),a3=K7=u([R("esri.support.Action.ActionToggle")],a3);const Xwe=a3,Vje="esri.PopupTemplate",zje=K.getLogger(Vje),qO="relationships/",aoe="expression/",Bje=Ke.ofType({key:"type",defaultKeyValue:"button",base:s$,typeMap:{button:Zwe,toggle:Xwe}}),Gje={base:ab,key:"type",typeMap:{media:wk,custom:Ije,text:Tk,attachments:ZI,fields:XI,expression:aK,relationship:xk}},jje=["attachments","fields","media","text","expression","relationship"];let qo=class extends rs(he){constructor(){super(...arguments),this.actions=null,this.content="",this.expressionInfos=null,this.fieldInfos=null,this.layerOptions=null,this.lastEditInfoEnabled=!0,this.outFields=null,this.overwriteActions=!1,this.returnGeometry=!1,this.title=""}castContent(e){return Array.isArray(e)?e.map(r=>Rf(Gje,r)):typeof e=="string"||typeof e=="function"||e instanceof HTMLElement||Rh(e)?e:(zje.error("content error","unsupported content value",{value:e}),null)}readContent(e,r){const{popupElements:i}=r;return Array.isArray(i)&&i.length>0?this._readPopupInfoElements(r.description,r.mediaInfos,i):this._readPopupInfo(r)}writeContent(e,r,i,s){typeof e!="string"?Array.isArray(e)&&(r.popupElements=e.filter(n=>jje.includes(n.type)).map(n=>n&&n.toJSON(s)),r.popupElements.forEach(n=>{n.type==="attachments"?this._writeAttachmentContent(r):n.type==="media"?this._writeMediaContent(n,r):n.type==="text"?this._writeTextContent(n,r):n.type==="relationship"&&this._writeRelationshipContent(n,r)})):r.description=e}writeFieldInfos(e,r,i,s){const{content:n}=this,o=Array.isArray(n)?n:null;if(e){const a=o?o.filter(c=>c.type==="fields"):[],l=a.length&&a.every(c=>c.fieldInfos?.length);r.fieldInfos=e.filter(Boolean).map(c=>{const h=c.toJSON(s);return l&&(h.visible=!1),h})}if(o)for(const a of o)a.type==="fields"&&this._writeFieldsContent(a,r)}writeLayerOptions(e,r,i,s){r[i]=!e||e.showNoDataRecords===null&&e.returnTopmostRaster===null?null:e.toJSON(s)}writeTitle(e,r){r.title=e||""}async collectRequiredFields(e,r){const i=this.expressionInfos||[];await this._collectExpressionInfoFields(e,r,[...i,...this._getContentExpressionInfos(this.content,i)]),GI(e,r,[...this.outFields||[],...this._getActionsFields(this.actions),...this._getTitleFields(this.title),...this._getContentFields(this.content)])}async getRequiredFields(e){const r=new Set;return await this.collectRequiredFields(r,e),[...r].sort()}_writeFieldsContent(e,r){if(!Array.isArray(e.fieldInfos)||!e.fieldInfos.length)return;const i=re(e.fieldInfos);Array.isArray(r.fieldInfos)?i.forEach(s=>{const n=r.fieldInfos.find(o=>o.fieldName.toLowerCase()===s.fieldName.toLowerCase());n?n.visible=!0:r.fieldInfos.push(s)}):r.fieldInfos=i}_writeAttachmentContent(e){e.showAttachments||(e.showAttachments=!0)}_writeRelationshipContent(e,r){const i=e.orderByFields?.map(n=>this._toFieldOrderJSON(n,e.relationshipId))||[],s=[...r.relatedRecordsInfo?.orderByFields||[],...i];r.relatedRecordsInfo={showRelatedRecords:!0,...s?.length&&{orderByFields:s}}}_writeTextContent(e,r){!r.description&&e.text&&(r.description=e.text)}_writeMediaContent(e,r){if(!Array.isArray(e.mediaInfos)||!e.mediaInfos.length)return;const i=re(e.mediaInfos);Array.isArray(r.mediaInfos)?r.mediaInfos=[...r.mediaInfos,...i]:r.mediaInfos=i}_readPopupInfoElements(e,r,i){const s={description:!1,mediaInfos:!1};return i.map(n=>n.type==="media"?(n.mediaInfos||!r||s.mediaInfos||(n.mediaInfos=r,s.mediaInfos=!0),wk.fromJSON(n)):n.type==="text"?(n.text||!e||s.description||(n.text=e,s.description=!0),Tk.fromJSON(n)):n.type==="attachments"?ZI.fromJSON(n):n.type==="fields"?XI.fromJSON(n):n.type==="expression"?aK.fromJSON(n):n.type==="relationship"?xk.fromJSON(n):void 0).filter(Boolean)}_toRelationshipContent(e){const{field:r,order:i}=e;if(!r?.startsWith(qO))return null;const s=r.replace(qO,"").split("/");if(s.length!==2)return null;const n=parseInt(s[0],10),o=s[1];return typeof n=="number"&&o?xk.fromJSON({relationshipId:n,orderByFields:[{field:o,order:i}]}):null}_toFieldOrderJSON(e,r){const{order:i,field:s}=e;return{field:`${qO}${r}/${s}`,order:i}}_readPopupInfo({description:e,mediaInfos:r,showAttachments:i,relatedRecordsInfo:s={showRelatedRecords:!1}}){const n=[];e?n.push(new Tk({text:e})):n.push(new XI),Array.isArray(r)&&r.length&&n.push(wk.fromJSON({mediaInfos:r})),i&&n.push(ZI.fromJSON({displayType:"auto"}));const{showRelatedRecords:o,orderByFields:a}=s;return o&&a?.length&&a.forEach(l=>{const c=this._toRelationshipContent(l);c&&n.push(c)}),n.length?n:e}_getContentElementFields(e){const r=e?.type;if(r==="attachments")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description)];if(r==="custom")return e.outFields||[];if(r==="fields")return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...this._getFieldInfoFields(e.fieldInfos??this.fieldInfos)];if(r==="media"){const i=e.mediaInfos||[];return[...this._extractFieldNames(e.title),...this._extractFieldNames(e.description),...i.reduce((s,n)=>[...s,...this._getMediaInfoFields(n)],[])]}return r==="text"?this._extractFieldNames(e.text):[]}_getMediaInfoFields(e){const{caption:r,title:i,value:s}=e,n=s||{},{fields:o,normalizeField:a,tooltipField:l,sourceURL:c,linkURL:h}=n,p=[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(c),...this._extractFieldNames(h),...o??[]];return a&&p.push(a),l&&p.push(l),p}_getContentExpressionInfos(e,r){return Array.isArray(e)?e.reduce((i,s)=>[...i,...s.type==="expression"&&s.expressionInfo?[s.expressionInfo]:[]],r):[]}_getContentFields(e){return typeof e=="string"?this._extractFieldNames(e):Array.isArray(e)?e.reduce((r,i)=>[...r,...this._getContentElementFields(i)],[]):[]}async _collectExpressionInfoFields(e,r,i){i&&await Promise.all(i.map(s=>Ec(e,r,s.expression)))}_getFieldInfoFields(e){return e?e.filter(r=>r.visible===void 0||!!r.visible).map(r=>r.fieldName).filter(r=>!r.startsWith(qO)&&!r.startsWith(aoe)):[]}_getActionsFields(e){return e?e.toArray().reduce((r,i)=>[...r,...this._getActionFields(i)],[]):[]}_getActionFields(e){const{className:r,title:i,type:s}=e,n=s==="button"||s==="toggle"?e.image:"";return[...this._extractFieldNames(i),...this._extractFieldNames(r),...this._extractFieldNames(n)]}_getTitleFields(e){return typeof e=="string"?this._extractFieldNames(e):[]}_extractFieldNames(e){if(!e||typeof e!="string")return[];const r=/{[^}]*}/g,i=e.match(r);if(!i)return[];const s=/\{(\w+):.+\}/,n=i.filter(o=>!(o.indexOf(`{${qO}`)===0||o.indexOf(`{${aoe}`)===0)).map(o=>o.replace(s,"{$1}"));return n?n.map(o=>o.slice(1,-1)):[]}};u([d({type:Bje})],qo.prototype,"actions",void 0),u([d()],qo.prototype,"content",void 0),u([or("content")],qo.prototype,"castContent",null),u([Ae("content",["description","fieldInfos","popupElements","mediaInfos","showAttachments","relatedRecordsInfo"])],qo.prototype,"readContent",null),u([Ve("content",{popupElements:{type:Ke.ofType(Nje)},showAttachments:{type:Boolean},mediaInfos:{type:Ke.ofType(qwe)},description:{type:String},relatedRecordsInfo:{type:Uje}})],qo.prototype,"writeContent",null),u([d({type:[Fje],json:{write:!0}})],qo.prototype,"expressionInfos",void 0),u([d({type:[lK]})],qo.prototype,"fieldInfos",void 0),u([Ve("fieldInfos")],qo.prototype,"writeFieldInfos",null),u([d({type:kje})],qo.prototype,"layerOptions",void 0),u([Ve("layerOptions")],qo.prototype,"writeLayerOptions",null),u([d({type:Boolean,json:{read:{source:"showLastEditInfo"},write:{target:"showLastEditInfo"},default:!0}})],qo.prototype,"lastEditInfoEnabled",void 0),u([d()],qo.prototype,"outFields",void 0),u([d()],qo.prototype,"overwriteActions",void 0),u([d()],qo.prototype,"returnGeometry",void 0),u([d({json:{type:String}})],qo.prototype,"title",void 0),u([Ve("title")],qo.prototype,"writeTitle",null),qo=u([R("esri.PopupTemplate")],qo);const aO=qo,Sk={transparent:[0,0,0,0],black:[0,0,0,1],silver:[192,192,192,1],gray:[128,128,128,1],white:[255,255,255,1],maroon:[128,0,0,1],red:[255,0,0,1],purple:[128,0,128,1],fuchsia:[255,0,255,1],green:[0,128,0,1],lime:[0,255,0,1],olive:[128,128,0,1],yellow:[255,255,0,1],navy:[0,0,128,1],blue:[0,0,255,1],teal:[0,128,128,1],aqua:[0,255,255,1],aliceblue:[240,248,255,1],antiquewhite:[250,235,215,1],aquamarine:[127,255,212,1],azure:[240,255,255,1],beige:[245,245,220,1],bisque:[255,228,196,1],blanchedalmond:[255,235,205,1],blueviolet:[138,43,226,1],brown:[165,42,42,1],burlywood:[222,184,135,1],cadetblue:[95,158,160,1],chartreuse:[127,255,0,1],chocolate:[210,105,30,1],coral:[255,127,80,1],cornflowerblue:[100,149,237,1],cornsilk:[255,248,220,1],crimson:[220,20,60,1],cyan:[0,255,255,1],darkblue:[0,0,139,1],darkcyan:[0,139,139,1],darkgoldenrod:[184,134,11,1],darkgray:[169,169,169,1],darkgreen:[0,100,0,1],darkgrey:[169,169,169,1],darkkhaki:[189,183,107,1],darkmagenta:[139,0,139,1],darkolivegreen:[85,107,47,1],darkorange:[255,140,0,1],darkorchid:[153,50,204,1],darkred:[139,0,0,1],darksalmon:[233,150,122,1],darkseagreen:[143,188,143,1],darkslateblue:[72,61,139,1],darkslategray:[47,79,79,1],darkslategrey:[47,79,79,1],darkturquoise:[0,206,209,1],darkviolet:[148,0,211,1],deeppink:[255,20,147,1],deepskyblue:[0,191,255,1],dimgray:[105,105,105,1],dimgrey:[105,105,105,1],dodgerblue:[30,144,255,1],firebrick:[178,34,34,1],floralwhite:[255,250,240,1],forestgreen:[34,139,34,1],gainsboro:[220,220,220,1],ghostwhite:[248,248,255,1],gold:[255,215,0,1],goldenrod:[218,165,32,1],greenyellow:[173,255,47,1],grey:[128,128,128,1],honeydew:[240,255,240,1],hotpink:[255,105,180,1],indianred:[205,92,92,1],indigo:[75,0,130,1],ivory:[255,255,240,1],khaki:[240,230,140,1],lavender:[230,230,250,1],lavenderblush:[255,240,245,1],lawngreen:[124,252,0,1],lemonchiffon:[255,250,205,1],lightblue:[173,216,230,1],lightcoral:[240,128,128,1],lightcyan:[224,255,255,1],lightgoldenrodyellow:[250,250,210,1],lightgray:[211,211,211,1],lightgreen:[144,238,144,1],lightgrey:[211,211,211,1],lightpink:[255,182,193,1],lightsalmon:[255,160,122,1],lightseagreen:[32,178,170,1],lightskyblue:[135,206,250,1],lightslategray:[119,136,153,1],lightslategrey:[119,136,153,1],lightsteelblue:[176,196,222,1],lightyellow:[255,255,224,1],limegreen:[50,205,50,1],linen:[250,240,230,1],magenta:[255,0,255,1],mediumaquamarine:[102,205,170,1],mediumblue:[0,0,205,1],mediumorchid:[186,85,211,1],mediumpurple:[147,112,219,1],mediumseagreen:[60,179,113,1],mediumslateblue:[123,104,238,1],mediumspringgreen:[0,250,154,1],mediumturquoise:[72,209,204,1],mediumvioletred:[199,21,133,1],midnightblue:[25,25,112,1],mintcream:[245,255,250,1],mistyrose:[255,228,225,1],moccasin:[255,228,181,1],navajowhite:[255,222,173,1],oldlace:[253,245,230,1],olivedrab:[107,142,35,1],orange:[255,165,0,1],orangered:[255,69,0,1],orchid:[218,112,214,1],palegoldenrod:[238,232,170,1],palegreen:[152,251,152,1],paleturquoise:[175,238,238,1],palevioletred:[219,112,147,1],papayawhip:[255,239,213,1],peachpuff:[255,218,185,1],peru:[205,133,63,1],pink:[255,192,203,1],plum:[221,160,221,1],powderblue:[176,224,230,1],rebeccapurple:[102,51,153,1],rosybrown:[188,143,143,1],royalblue:[65,105,225,1],saddlebrown:[139,69,19,1],salmon:[250,128,114,1],sandybrown:[244,164,96,1],seagreen:[46,139,87,1],seashell:[255,245,238,1],sienna:[160,82,45,1],skyblue:[135,206,235,1],slateblue:[106,90,205,1],slategray:[112,128,144,1],slategrey:[112,128,144,1],snow:[255,250,250,1],springgreen:[0,255,127,1],steelblue:[70,130,180,1],tan:[210,180,140,1],thistle:[216,191,216,1],tomato:[255,99,71,1],turquoise:[64,224,208,1],violet:[238,130,238,1],wheat:[245,222,179,1],whitesmoke:[245,245,245,1],yellowgreen:[154,205,50,1]};function Ywe(t){return!!Sk[t]||!!Sk[t.toLowerCase()]}function hK(t){return Sk[t]??Sk[t.toLowerCase()]}function Hje(t){return[...hK(t)]}function I9(t,e,r){r<0&&++r,r>1&&--r;const i=6*r;return i<1?t+(e-t)*i:2*r<1?e:3*r<2?t+(e-t)*(2/3-r)*6:t}function Jwe(t,e,r,i=1){const s=(t%360+360)%360/360,n=r<=.5?r*(e+1):r+e-r*e,o=2*r-n;return[Math.round(255*I9(o,n,s+1/3)),Math.round(255*I9(o,n,s)),Math.round(255*I9(o,n,s-1/3)),i]}function qje(t){const e=t.length>5,r=e?8:4,i=(1<<r)-1,s=e?1:17,n=e?t.length===9:t.length===5;let o=+("0x"+t.substr(1));if(isNaN(o))return null;const a=[0,0,0,1];let l;return n&&(l=o&i,o>>=r,a[3]=s*l/255),l=o&i,o>>=r,a[2]=s*l,l=o&i,o>>=r,a[1]=s*l,l=o&i,o>>=r,a[0]=s*l,a}function pL(t){return ye(oQ(t),0,255)}function fL(t,e,r){return t=Number(t),isNaN(t)?r:t<e?e:t>r?r:t}let FF=class ka{static blendColors(e,r,i,s=new ka){return s.r=Math.round(e.r+(r.r-e.r)*i),s.g=Math.round(e.g+(r.g-e.g)*i),s.b=Math.round(e.b+(r.b-e.b)*i),s.a=e.a+(r.a-e.a)*i,s._sanitize()}static fromRgb(e,r){const i=e.toLowerCase().match(/^(rgba?|hsla?)\(([\s\.\-,%0-9]+)\)/);if(i){const s=i[2].split(/\s*,\s*/),n=i[1];if(n==="rgb"&&s.length===3||n==="rgba"&&s.length===4){const o=s[0];if(o.charAt(o.length-1)==="%"){const a=s.map(l=>2.56*parseFloat(l));return s.length===4&&(a[3]=parseFloat(s[3])),ka.fromArray(a,r)}return ka.fromArray(s.map(a=>parseFloat(a)),r)}if(n==="hsl"&&s.length===3||n==="hsla"&&s.length===4)return ka.fromArray(Jwe(parseFloat(s[0]),parseFloat(s[1])/100,parseFloat(s[2])/100,parseFloat(s[3])),r)}return null}static fromHex(e,r=new ka){if(e.length!==4&&e.length!==7||e[0]!=="#")return null;const i=e.length===4?4:8,s=(1<<i)-1;let n=+("0x"+e.substr(1));return isNaN(n)?null:(["b","g","r"].forEach(o=>{const a=n&s;n>>=i,r[o]=i===4?17*a:a}),r.a=1,r)}static fromArray(e,r=new ka){return r._set(Number(e[0]),Number(e[1]),Number(e[2]),Number(e[3])),isNaN(r.a)&&(r.a=1),r._sanitize()}static fromString(e,r){const i=Ywe(e)?hK(e):null;return i&&ka.fromArray(i,r)||ka.fromRgb(e,r)||ka.fromHex(e,r)}static fromJSON(e){return e&&new ka([e[0],e[1],e[2],e[3]/255])}static toUnitRGB(e){return e!=null?[e.r/255,e.g/255,e.b/255]:null}static toUnitRGBA(e){return e!=null?[e.r/255,e.g/255,e.b/255,e.a!=null?e.a:1]:null}constructor(e){this.r=255,this.g=255,this.b=255,this.a=1,e&&this.setColor(e)}get isBright(){return .299*this.r+.587*this.g+.114*this.b>=127}setColor(e){return typeof e=="string"?ka.fromString(e,this):Array.isArray(e)?ka.fromArray(e,this):(this._set(e.r??0,e.g??0,e.b??0,e.a??1),e instanceof ka||this._sanitize()),this}toRgb(){return[this.r,this.g,this.b]}toRgba(){return[this.r,this.g,this.b,this.a]}toHex(){const e=this.r.toString(16),r=this.g.toString(16),i=this.b.toString(16);return`#${e.length<2?"0"+e:e}${r.length<2?"0"+r:r}${i.length<2?"0"+i:i}`}toCss(e=!1){const r=this.r+", "+this.g+", "+this.b;return e?`rgba(${r}, ${this.a})`:`rgb(${r})`}toString(){return this.toCss(!0)}toJSON(){return this.toArray()}toArray(e=ka.AlphaMode.ALWAYS){const r=pL(this.r),i=pL(this.g),s=pL(this.b);return e===ka.AlphaMode.ALWAYS||this.a!==1?[r,i,s,pL(255*this.a)]:[r,i,s]}clone(){return new ka(this.toRgba())}hash(){return this.r<<24|this.g<<16|this.b<<8|255*this.a}equals(e){return e!=null&&e.r===this.r&&e.g===this.g&&e.b===this.b&&e.a===this.a}_sanitize(){return this.r=Math.round(fL(this.r,0,255)),this.g=Math.round(fL(this.g,0,255)),this.b=Math.round(fL(this.b,0,255)),this.a=fL(this.a,0,1),this}_set(e,r,i,s){this.r=e,this.g=r,this.b=i,this.a=s}};FF.prototype.declaredClass="esri.Color",function(t){var e;(e=t.AlphaMode||(t.AlphaMode={}))[e.ALWAYS=0]="ALWAYS",e[e.UNLESS_OPAQUE=1]="UNLESS_OPAQUE"}(FF||(FF={}));const Le=FF,loe=new kr({esriSMS:"simple-marker",esriPMS:"picture-marker",esriSLS:"simple-line",esriSFS:"simple-fill",esriPFS:"picture-fill",esriTS:"text",esriSHD:"shield-label-symbol",PointSymbol3D:"point-3d",LineSymbol3D:"line-3d",PolygonSymbol3D:"polygon-3d",WebStyleSymbol:"web-style",MeshSymbol3D:"mesh-3d",LabelSymbol3D:"label-3d",CIMSymbolReference:"cim"});let Wje=0,W2=class extends he{constructor(e){super(e),this.id="sym"+Wje++,this.type=null,this.color=new Le([0,0,0,1])}readColor(e){return e&&e[0]!=null?[e[0],e[1],e[2],e[3]/255]:e}async collectRequiredFields(e,r){}hash(){return JSON.stringify(this.toJSON())}clone(){}};u([d({type:loe.apiValues,readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0,writer:loe.write}}})],W2.prototype,"type",void 0),u([d({type:Le,json:{write:{allowNull:!0}}})],W2.prototype,"color",void 0),u([Ae("color")],W2.prototype,"readColor",null),W2=u([R("esri.symbols.Symbol")],W2);const Mu=W2;var eH;let H_=eH=class extends Mu{constructor(t){super(t),this.data=null,this.type="cim"}readData(t,e){return e}writeData(t,e){Object.assign(e,t)}async collectRequiredFields(t,e){if(this.data?.type==="CIMSymbolReference"){const r=this.data.primitiveOverrides;if(r){const i=r.map(s=>{const n=s.valueExpressionInfo;return Ec(t,e,n.expression)});await Promise.all(i)}}}clone(){return new eH({data:re(this.data)})}hash(){return BJ(JSON.stringify(this.data)).toString()}};u([d({json:{write:!1}})],H_.prototype,"color",void 0),u([d({json:{write:!0}})],H_.prototype,"data",void 0),u([Ae("data",["symbol"])],H_.prototype,"readData",null),u([Ve("data",{})],H_.prototype,"writeData",null),u([nt({CIMSymbolReference:"cim"},{readOnly:!0})],H_.prototype,"type",void 0),H_=eH=u([R("esri.symbols.CIMSymbol")],H_);const lO=H_;let Z2=class extends he{constructor(e){super(e),this.enabled=!0,this.type=null,this.ignoreDrivers=!1}writeEnabled(e,r,i){e||(r[i]=e)}};u([d({type:Boolean,json:{read:{source:"enable"},write:{target:"enable"}}})],Z2.prototype,"enabled",void 0),u([Ve("enabled")],Z2.prototype,"writeEnabled",null),u([d({type:["icon","object","line","path","fill","water","extrude","text"],readOnly:!0})],Z2.prototype,"type",void 0),Z2=u([R("esri.symbols.Symbol3DLayer")],Z2);const Lg=Z2,Zje=/^-?(\d+(\.\d+)?)\s*((px)|(pt))?$/i,Xje="screenUtils.toPt: input not recognized!",Qwe=96;function vi(t){return t?t/72*Qwe:0}function Fl(t){return t?72*t/Qwe:0}function oi(t){if(typeof t=="string"){const e=t.match(Zje);if(e){const r=Number(e[1]),i=e[3]&&e[3].toLowerCase(),s=t.charAt(0)==="-",n=i==="px"?Fl(r):r;return s?-n:n}return console.warn(Xje),null}return t}function xh(t=0,e=0){return{x:t,y:e}}function cs(t=0,e=0){return[t,e]}function Kwe(t=0,e=0){return[t,e]}function Lo(t=0,e=0,r=0){return[t,e,r]}function n4t(t){return t}function o4t(t){return t}function a4t(t){return t}function qm(t,e){return e?(e[0]=t.x,e[1]=t.y,e.length>2&&(e[2]=0),e):[t.x,t.y]}function Q6(t){const e=oQ(100*(1-t));return Math.max(0,Math.min(e,100))}function oA(t){const e=1-t/100;return Math.max(0,Math.min(e,1))}function Yje(t,e){const r=e.transparency!=null?oA(e.transparency):1,i=e.color;return i&&Array.isArray(i)?new Le([i[0]||0,i[1]||0,i[2]||0,r]):null}function Jje(t,e){e.color=t.toJSON().slice(0,3);const r=Q6(t.a);r!==0&&(e.transparency=r)}const k0={type:Le,json:{type:[Ki],default:null,read:{source:["color","transparency"],reader:Yje},write:{target:{color:{type:[Ki]},transparency:{type:Ki}},writer:Jje}}},gg={type:Number,cast:oi,json:{write:!0}};let gw=class extends he{constructor(e){super(e),this.color=new Le([0,0,0,1]),this.extensionLength=0,this.size=Fl(1)}clone(){}cloneProperties(){return{color:re(this.color),size:this.size,extensionLength:this.extensionLength}}};u([d({type:["solid","sketch"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],gw.prototype,"type",void 0),u([d(k0)],gw.prototype,"color",void 0),u([d({...gg,json:{write:{overridePolicy:t=>({enabled:!!t})}}})],gw.prototype,"extensionLength",void 0),u([d(gg)],gw.prototype,"size",void 0),gw=u([R("esri.symbols.edges.Edges3D")],gw);const dK=gw;var tH;let kF=tH=class extends dK{constructor(t){super(t),this.type="sketch"}clone(){return new tH(this.cloneProperties())}};u([nt({sketch:"sketch"},{readOnly:!0})],kF.prototype,"type",void 0),kF=tH=u([R("esri.symbols.edges.SketchEdges3D")],kF);const Qje=kF;var rH;let UF=rH=class extends dK{constructor(t){super(t),this.type="solid"}clone(){return new rH(this.cloneProperties())}};u([nt({solid:"solid"},{readOnly:!0})],UF.prototype,"type",void 0),UF=rH=u([R("esri.symbols.support.SolidEdges3D")],UF);const Kje=UF,exe={types:{key:"type",base:dK,typeMap:{solid:Kje,sketch:Qje}},json:{write:!0}};var iH;let yh=iH=class extends he{constructor(t){super(t),this.color=null}clone(){const t={color:this.color!=null?this.color.clone():null};return new iH(t)}};u([d(k0)],yh.prototype,"color",void 0),yh=iH=u([R("esri.symbols.support.Symbol3DMaterial")],yh);var sH;let q_=sH=class extends Lg{constructor(t){super(t),this.type="extrude",this.size=1,this.material=null,this.castShadows=!0,this.edges=null}clone(){return new sH({edges:this.edges&&this.edges.clone(),enabled:this.enabled,material:this.material!=null?this.material.clone():null,castShadows:this.castShadows,size:this.size})}};u([nt({Extrude:"extrude"},{readOnly:!0})],q_.prototype,"type",void 0),u([d({type:Number,json:{write:{enabled:!0,isRequired:!0}},nonNullable:!0})],q_.prototype,"size",void 0),u([d({type:yh,json:{write:!0}})],q_.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],q_.prototype,"castShadows",void 0),u([d(exe)],q_.prototype,"edges",void 0),q_=sH=u([R("esri.symbols.ExtrudeSymbol3DLayer")],q_);const txe=q_;let l3=class extends Mu{constructor(e){super(e),this.type="simple-line",this.width=.75}hash(){return`${this.type}.${this.width}`}};u([nt({esriSLS:"simple-line"},{readOnly:!0})],l3.prototype,"type",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],l3.prototype,"width",void 0),l3=u([R("esri.symbols.LineSymbol")],l3);const e7e=l3,t7e=["begin","end","begin-end"],rxe=["arrow","circle","square","diamond","cross","x"];var nH;let vm=nH=class extends he{constructor(t){super(t),this.placement="begin-end",this.type="line-marker",this.style="arrow"}writeStyle(t,e,r,i){e[r]=i?.origin==="web-map"?"arrow":t}set color(t){this._set("color",t)}readColor(t){return t&&t[0]!=null?[t[0],t[1],t[2],t[3]/255]:t}writeColor(t,e,r,i){i?.origin==="web-map"||(e[r]=t)}clone(){return new nH({color:re(this.color),placement:this.placement,style:this.style})}hash(){return`${this.placement}.${this.color?.hash()}.${this.style}`}};u([d({type:["begin","end","begin-end"],json:{write:!0}})],vm.prototype,"placement",void 0),u([nt({"line-marker":"line-marker"},{readOnly:!0}),d({json:{origins:{"web-map":{write:!1}}}})],vm.prototype,"type",void 0),u([d({type:rxe})],vm.prototype,"style",void 0),u([Ve("style")],vm.prototype,"writeStyle",null),u([d({type:Le,value:null,json:{write:{allowNull:!0}}})],vm.prototype,"color",null),u([Ae("color")],vm.prototype,"readColor",null),u([Ve("color")],vm.prototype,"writeColor",null),vm=nH=u([R("esri.symbols.LineSymbolMarker")],vm);const r7e=vm;var oH;const P9=new kr({esriSLSSolid:"solid",esriSLSDash:"dash",esriSLSDot:"dot",esriSLSDashDot:"dash-dot",esriSLSDashDotDot:"long-dash-dot-dot",esriSLSNull:"none",esriSLSInsideFrame:"inside-frame",esriSLSShortDash:"short-dash",esriSLSShortDot:"short-dot",esriSLSShortDashDot:"short-dash-dot",esriSLSShortDashDotDot:"short-dash-dot-dot",esriSLSLongDash:"long-dash",esriSLSLongDashDot:"long-dash-dot"});let hy=oH=class extends e7e{constructor(...t){super(...t),this.type="simple-line",this.style="solid",this.cap="round",this.join="round",this.marker=null,this.miterLimit=2}normalizeCtorArgs(t,e,r,i,s,n){if(t&&typeof t!="string")return t;const o={};return t!=null&&(o.style=t),e!=null&&(o.color=e),r!=null&&(o.width=oi(r)),i!=null&&(o.cap=i),s!=null&&(o.join=s),n!=null&&(o.miterLimit=oi(n)),o}clone(){return new oH({color:re(this.color),style:this.style,width:this.width,cap:this.cap,join:this.join,miterLimit:this.miterLimit,marker:this.marker?.clone()})}hash(){return`${super.hash()}.${this.color?.hash()}.${this.style}.${this.cap}.${this.join}.${this.miterLimit}.${this.marker?.hash()}`}};u([nt({esriSLS:"simple-line"},{readOnly:!0})],hy.prototype,"type",void 0),u([d({type:P9.apiValues,json:{read:P9.read,write:P9.write}})],hy.prototype,"style",void 0),u([d({type:["butt","round","square"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],hy.prototype,"cap",void 0),u([d({type:["miter","round","bevel"],json:{write:{overridePolicy:(t,e,r)=>({enabled:t!=="round"&&(r==null||r.origin==null)})}}})],hy.prototype,"join",void 0),u([d({types:{key:"type",base:null,defaultKeyValue:"line-marker",typeMap:{"line-marker":r7e}},json:{write:!0,origins:{"web-scene":{write:!1}}}})],hy.prototype,"marker",void 0),u([d({type:Number,json:{read:!1,write:!1}})],hy.prototype,"miterLimit",void 0),hy=oH=u([R("esri.symbols.SimpleLineSymbol")],hy);const Iu=hy,i7e=Object.freeze(Object.defineProperty({__proto__:null,default:Iu},Symbol.toStringTag,{value:"Module"}));let c3=class extends Mu{constructor(e){super(e),this.outline=null,this.type=null}hash(){return`${this.type}.${this.outline&&this.outline.hash()}`}};u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Iu}},json:{default:null,write:!0}})],c3.prototype,"outline",void 0),u([d({type:["simple-fill","picture-fill"],readOnly:!0})],c3.prototype,"type",void 0),c3=u([R("esri.symbols.FillSymbol")],c3);const ixe=c3;let VF=class extends he{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],VF.prototype,"type",void 0),VF=u([R("esri.symbols.patterns.LinePattern3D")],VF);const sxe=VF,s7e=["dash","dash-dot","dot","long-dash","long-dash-dot","long-dash-dot-dot","none","short-dash","short-dash-dot","short-dash-dot-dot","short-dot","solid"];var aH;const n7e=zl()({dash:"dash","dash-dot":"dash-dot","dash-dot-dot":"long-dash-dot-dot",dot:"dot","long-dash":"long-dash","long-dash-dot":"long-dash-dot",null:"none","short-dash":"short-dash","short-dash-dot":"short-dash-dot","short-dash-dot-dot":"short-dash-dot-dot","short-dot":"short-dot",solid:"solid"});let u3=aH=class extends sxe{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new aH(t)}};u([d({type:["style"]})],u3.prototype,"type",void 0),u([nt(n7e),d({type:s7e})],u3.prototype,"style",void 0),u3=aH=u([R("esri.symbols.patterns.LineStylePattern3D")],u3);const pK=u3;let zF=class extends he{constructor(e){super(e)}clone(){}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],zF.prototype,"type",void 0),zF=u([R("esri.symbols.patterns.Pattern3D")],zF);const nxe=zF,o7e=["backward-diagonal","cross","diagonal-cross","forward-diagonal","horizontal","none","solid","vertical"];var lH;let h3=lH=class extends nxe{constructor(t){super(t),this.type="style",this.style="solid"}clone(){const t={style:this.style};return new lH(t)}};u([d({type:["style"]})],h3.prototype,"type",void 0),u([d({type:o7e,json:{read:!0,write:!0}})],h3.prototype,"style",void 0),h3=lH=u([R("esri.symbols.patterns.StylePattern3D")],h3);const oxe=h3,a7e={types:{key:"type",base:nxe,typeMap:{style:oxe}},json:{write:!0}},axe={types:{key:"type",base:sxe,typeMap:{style:pK}},json:{write:!0}},VM=new Le("white");new Le("black");const l7e=new Le([255,255,255,0]);function c7e(t){return t.r===0&&t.g===0&&t.b===0}var cH;let zM=cH=class extends yh{constructor(t){super(t),this.colorMixMode=null}clone(){const t={color:this.color!=null?this.color.clone():null,colorMixMode:this.colorMixMode};return new cH(t)}};u([nt({multiply:"multiply",replace:"replace",tint:"tint"})],zM.prototype,"colorMixMode",void 0),zM=cH=u([R("esri.symbols.support.Symbol3DFillMaterial")],zM);function Gn(t=dxe){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function PT(t,e,r,i,s,n,o=Gn()){return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function p4t(t,e){const r=isFinite(t[2])||isFinite(t[5]);return new vr(r?{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],zmin:t[2],zmax:t[5],spatialReference:e}:{xmin:t[0],xmax:t[3],ymin:t[1],ymax:t[4],spatialReference:e})}function aA(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[3]),t[4]=Math.max(t[4],e[4]),t[5]=Math.max(t[5],e[5])}function u7e(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[3]=Math.max(t[3],e[2]),t[4]=Math.max(t[4],e[3])}function yg(t,e){t[0]=Math.min(t[0],e[0]),t[1]=Math.min(t[1],e[1]),t[2]=Math.min(t[2],e[2]),t[3]=Math.max(t[3],e[0]),t[4]=Math.max(t[4],e[1]),t[5]=Math.max(t[5],e[2])}function fh(t,e,r=0,i=e.length/3){let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];for(let h=0;h<i;h++)s=Math.min(s,e[r+3*h]),n=Math.min(n,e[r+3*h+1]),o=Math.min(o,e[r+3*h+2]),a=Math.max(a,e[r+3*h]),l=Math.max(l,e[r+3*h+1]),c=Math.max(c,e[r+3*h+2]);t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function $9(t,e,r){const i=e.length;let s=t[0],n=t[1],o=t[2],a=t[3],l=t[4],c=t[5];if(r)for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),o=Math.min(o,p[2]),a=Math.max(a,p[0]),l=Math.max(l,p[1]),c=Math.max(c,p[2])}else for(let h=0;h<i;h++){const p=e[h];s=Math.min(s,p[0]),n=Math.min(n,p[1]),a=Math.max(a,p[0]),l=Math.max(l,p[1])}t[0]=s,t[1]=n,t[2]=o,t[3]=a,t[4]=l,t[5]=c}function h7e(t){for(let e=0;e<6;e++)if(!isFinite(t[e]))return!1;return!0}function lS(t){return t[0]>=t[3]?0:t[3]-t[0]}function cS(t){return t[1]>=t[4]?0:t[4]-t[1]}function lb(t){return t[2]>=t[5]?0:t[5]-t[2]}function lxe(t){const e=lS(t),r=lb(t),i=cS(t);return Math.sqrt(e*e+r*r+i*i)}function lf(t,e=[0,0,0]){return e[0]=t[0]+lS(t)/2,e[1]=t[1]+cS(t)/2,e[2]=t[2]+lb(t)/2,e}function mL(t,e=[0,0,0]){return e[0]=lS(t),e[1]=cS(t),e[2]=lb(t),e}function fK(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[0]<=t[3]&&e[1]<=t[4]&&e[2]<=t[5]}function f4t(t,e){return e[0]>=t[0]&&e[1]>=t[1]&&e[2]>=t[2]&&e[3]<=t[3]&&e[4]<=t[4]&&e[5]<=t[5]}function d7e(t,e){return Math.max(e[0],t[0])<=Math.min(e[3],t[3])&&Math.max(e[1],t[1])<=Math.min(e[4],t[4])&&Math.max(e[2],t[2])<=Math.min(e[5],t[5])}function cf(t,e){return e==null||d7e(t,e)}function cxe(t,e,r,i,s=t){return s[0]=t[0]+e,s[1]=t[1]+r,s[2]=t[2]+i,s[3]=t[3]+e,s[4]=t[4]+r,s[5]=t[5]+i,s}function m4t(t,e,r=t){const i=t[0]+lS(t)/2,s=t[1]+cS(t)/2,n=t[2]+lb(t)/2;return r[0]=i+(t[0]-i)*e,r[1]=s+(t[1]-s)*e,r[2]=n+(t[2]-n)*e,r[3]=i+(t[3]-i)*e,r[4]=s+(t[4]-s)*e,r[5]=n+(t[5]-n)*e,r}function g4t(t,e){return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function uxe(t,e,r=t){return r[0]=e[0],r[1]=e[1],r[2]=e[2],r!==t&&(r[3]=t[3],r[4]=t[4],r[5]=t[5]),r}function hxe(t,e,r=t){return r[3]=e[0],r[4]=e[1],r[5]=e[2],r!==t&&(r[0]=t[0],r[1]=t[1],r[2]=t[2]),t}function K6(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function Gi(t){return t?K6(t,coe):Gn(coe)}function mK(t,e){return e||(e=Ht()),e[0]=t[0],e[1]=t[1],e[2]=t[3],e[3]=t[4],e}function y4t(t,e){return t[0]=e[0],t[1]=e[1],t[2]=Number.NEGATIVE_INFINITY,t[3]=e[2],t[4]=e[3],t[5]=Number.POSITIVE_INFINITY,t}function p7e(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=Number.NEGATIVE_INFINITY,t[3]=i,t[4]=s,t[5]=Number.POSITIVE_INFINITY,t}function uH(t){return t.length===6}function gK(t){return lS(t)===0&&cS(t)===0&&lb(t)===0}function _4t(t,e,r){if(t==null||e==null)return t===e;if(!uH(t)||!uH(e))return!1;if(r){for(let i=0;i<t.length;i++)if(!r(t[i],e[i]))return!1}else for(let i=0;i<t.length;i++)if(t[i]!==e[i])return!1;return!0}function f7e(t,e,r,i,s,n){return PT(t,e,r,i,s,n,m7e)}const v4t=[-1/0,-1/0,-1/0,1/0,1/0,1/0],coe=[1/0,1/0,1/0,-1/0,-1/0,-1/0],dxe=[0,0,0,0,0,0],m7e=Gn();function L9(t,{isPrimitive:e,width:r,depth:i,height:s}){const n=e?10:1;if(r==null&&s==null&&i==null)return[n*t[0],n*t[1],n*t[2]];const o=Ee(r,i,s);let a;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/t[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=t[l]*a);return o}const g7e=PT(-.5,-.5,-.5,.5,.5,.5),y7e=PT(-.5,-.5,0,.5,.5,1),_7e=PT(-.5,-.5,0,.5,.5,.5);function v7e(t){switch(t){case"sphere":case"cube":case"diamond":return g7e;case"cylinder":case"cone":case"inverted-cone":return y7e;case"tetrahedron":return _7e;default:return}}const yK=["butt","square","round"],b7e=[...yK,"none"],pxe=["miter","bevel","round"];var hH;let yw=hH=class extends he{constructor(t){super(t),this.color=new Le([0,0,0,1]),this.size=Fl(1),this.pattern=null,this.patternCap="butt"}clone(){const t={color:this.color!=null?this.color.clone():null,size:this.size,pattern:this.pattern!=null?this.pattern.clone():null,patternCap:this.patternCap};return new hH(t)}};u([d(k0)],yw.prototype,"color",void 0),u([d(gg)],yw.prototype,"size",void 0),u([d(axe)],yw.prototype,"pattern",void 0),u([d({type:yK,json:{default:"butt",write:{overridePolicy(){return{enabled:this.pattern!=null}}}}})],yw.prototype,"patternCap",void 0),yw=hH=u([R("esri.symbols.support.Symbol3DOutline")],yw);var BF;let dy=BF=class extends Lg{constructor(t){super(t),this.type="fill",this.material=null,this.pattern=null,this.castShadows=!0,this.outline=null,this.edges=null}clone(){const t={edges:this.edges!=null?this.edges.clone():null,enabled:this.enabled,material:this.material!=null?this.material.clone():null,pattern:this.pattern!=null?this.pattern.clone():null,castShadows:this.castShadows,outline:this.outline!=null?this.outline.clone():null};return new BF(t)}static fromSimpleFillSymbol(t){const e=t.outline&&t.outline.style&&t.outline.style!=="inside-frame"&&t.outline.style!=="solid"?new pK({style:t.outline.style}):null,r={size:t.outline?.width??0,color:(t.outline?.color??VM).clone(),pattern:e};return e&&t.outline?.cap&&(r.patternCap=t.outline.cap),new BF({material:new zM({color:(t.color??l7e).clone()}),pattern:t.style&&t.style!=="solid"?new oxe({style:t.style}):null,outline:r})}};u([nt({Fill:"fill"},{readOnly:!0})],dy.prototype,"type",void 0),u([d({type:zM,json:{write:!0}})],dy.prototype,"material",void 0),u([d(a7e)],dy.prototype,"pattern",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],dy.prototype,"castShadows",void 0),u([d({type:yw,json:{write:!0}})],dy.prototype,"outline",void 0),u([d(exe)],dy.prototype,"edges",void 0),dy=BF=u([R("esri.symbols.FillSymbol3DLayer")],dy);const cO=dy,w7e=["none","underline","line-through"],x7e=["normal","italic","oblique"],T7e=["normal","lighter","bold","bolder"],fxe={type:Number,cast:t=>{const e=wd(t);return e===0?1:ye(e,.1,4)},nonNullable:!0},S7e=["left","right","center"],E7e=["baseline","top","middle","bottom"],mxe={type:S7e,nonNullable:!0},gxe={type:E7e,nonNullable:!0},b4t=8;var dH;let py=dH=class extends he{constructor(t){super(t),this.decoration="none",this.family="sans-serif",this.size=9,this.style="normal",this.weight="normal"}castSize(t){return oi(t)}clone(){return new dH({decoration:this.decoration,family:this.family,size:this.size,style:this.style,weight:this.weight})}hash(){return`${this.decoration}.${this.family}.${this.size}.${this.style}.${this.weight}`}};u([d({type:w7e,json:{default:"none",write:!0}})],py.prototype,"decoration",void 0),u([d({type:String,json:{write:!0}})],py.prototype,"family",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.textSymbol3D})}}})],py.prototype,"size",void 0),u([or("size")],py.prototype,"castSize",null),u([d({type:x7e,json:{default:"normal",write:!0}})],py.prototype,"style",void 0),u([d({type:T7e,json:{default:"normal",write:!0}})],py.prototype,"weight",void 0),py=dH=u([R("esri.symbols.Font")],py);const eV=py;function A0(t,e){const r=e&&e.url&&e.url.path;if(t&&r&&(t=pc(t,r,{preserveProtocolRelative:!0}),e.portalItem&&e.readResourcePaths)){const i=XJ(t,e.portalItem.itemUrl);i!=null&&C7e.test(i)&&e.readResourcePaths.push(e.portalItem.resourceFromPath(i).path)}return pH(t,e&&e.portal)}function O0(t,e,r=lA.YES){if(t==null)return t;!wu(t)&&e&&e.blockedRelativeUrls&&e.blockedRelativeUrls.push(t);let i=pc(t);if(e){const s=e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.rootPath||e.url&&e.url.path;if(s){const n=pH(s,e.portal),o=pH(i,e.portal);i=XJ(o,n,n),i!=null&&i!==o&&i!==t&&e.verifyItemRelativeUrls&&e.verifyItemRelativeUrls.writtenUrls.push(i)}}return i=bxe(i,e?.portal),wu(i)&&(i=Dd(i)),e?.resources&&e?.portalItem&&!wu(i)&&!Ig(i)&&r===lA.YES&&e.resources.toKeep.push({resource:e.portalItem.resourceFromPath(i),compress:!1}),i}function tV(t,e,r){return A0(t,r)}function U1(t,e,r,i){const s=O0(t,i);s!==void 0&&(e[r]=s)}const yxe=/\/items\/([^\/]+)\/resources\/(.*)/,C7e=/^\.\/resources\//;function _xe(t){return(t?.match(yxe)??null)?.[1]??null}function vxe(t){const e=t?.match(yxe)??null;if(e==null)return null;const r=e[2],i=r.lastIndexOf("/");if(i===-1){const{path:o,extension:a}=Use(r);return{prefix:null,filename:o,extension:a}}const{path:s,extension:n}=Use(r.slice(i+1));return{prefix:r.slice(0,i),filename:s,extension:n}}function bxe(t,e){return e&&!e.isPortal&&e.urlKey&&e.customBaseUrl?Gj(t,`${e.urlKey}.${e.customBaseUrl}`,e.portalHostname):t}function pH(t,e){if(!e||e.isPortal||!e.urlKey||!e.customBaseUrl)return t;const r=`${e.urlKey}.${e.customBaseUrl}`,i=qJ();return nu(i,`${i.scheme}://${r}`)?Gj(t,e.portalHostname,r):Gj(t,r,e.portalHostname)}var lA;(function(t){t[t.YES=0]="YES",t[t.NO=1]="NO"})(lA||(lA={}));const A7e=Object.freeze(Object.defineProperty({__proto__:null,get MarkKeep(){return lA},ensureMainOnlineDomain:bxe,fromJSON:A0,itemIdFromResourceUrl:_xe,prefixAndFilenameFromResourceUrl:vxe,read:tV,toJSON:O0,write:U1},Symbol.toStringTag,{value:"Module"}));var fH;const O7e=zl()({circle:"circle",square:"square",cross:"cross",x:"x",kite:"kite",triangle:"triangle"});let _w=fH=class extends he{constructor(t){super(t)}readHref(t,e,r){return t?A0(t,r):e.dataURI}writeHref(t,e,r,i){t&&(Ig(t)?e.dataURI=t:(e.href=O0(t,i),wu(e.href)&&(e.href=Dd(e.href))))}clone(){return new fH({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{write:!0,read:{source:["href","dataURI"]}}})],_w.prototype,"href",void 0),u([Ae("href")],_w.prototype,"readHref",null),u([Ve("href",{href:{type:String},dataURI:{type:String}})],_w.prototype,"writeHref",null),u([nt(O7e)],_w.prototype,"primitive",void 0),_w=fH=u([R("esri.symbols.support.IconSymbol3DLayerResource")],_w);const wxe="circle";var mH;let WE=mH=class extends me{constructor(){super(...arguments),this.x=0,this.y=0}clone(){return new mH({x:this.x,y:this.y})}};u([d({type:Number})],WE.prototype,"x",void 0),u([d({type:Number})],WE.prototype,"y",void 0),WE=mH=u([R("esri.symbols.support.Symbol3DAnchorPosition2D")],WE);var gH;let d3=gH=class extends he{constructor(t){super(t),this.color=new Le([0,0,0,1]),this.size=Fl(1)}clone(){const t={color:this.color!=null?this.color.clone():null,size:this.size};return new gH(t)}};u([d(k0)],d3.prototype,"color",void 0),u([d(gg)],d3.prototype,"size",void 0),d3=gH=u([R("esri.symbols.support.Symbol3DIconOutline")],d3);var X2;const xxe="esri.symbols.IconSymbol3DLayer";let bm=X2=class extends Lg{constructor(t){super(t),this.material=null,this.resource=null,this.type="icon",this.size=12,this.anchor="center",this.anchorPosition=null,this.outline=null}clone(){return new X2({anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),enabled:this.enabled,material:this.material!=null?this.material.clone():null,outline:this.outline!=null?this.outline.clone():null,resource:this.resource&&this.resource.clone(),size:this.size})}static fromSimpleMarkerSymbol(t){const e=t.color||VM,r=uoe(t),i=t.outline&&t.outline.width>0?{size:t.outline.width,color:(t.outline.color||VM).clone()}:null;return new X2({size:t.size,resource:{primitive:M7e(t.style)},material:{color:e},outline:i,anchor:r?"relative":void 0,anchorPosition:r})}static fromPictureMarkerSymbol(t){const e=!t.color||c7e(t.color)?VM:t.color,r=uoe(t);return new X2({size:t.width<=t.height?t.height:t.width,resource:{href:t.url},material:{color:e.clone()},anchor:r?"relative":void 0,anchorPosition:r})}static fromCIMSymbol(t){return new X2({resource:{href:fve({mediaType:"application/json",data:JSON.stringify(t.data)})}})}};function uoe(t){const e="width"in t?t.width:t.size,r="height"in t?t.height:t.size,i=hoe(t.xoffset),s=hoe(t.yoffset);return(i||s)&&e&&r?{x:-i/e,y:s/r}:null}function hoe(t){return isFinite(t)?t:0}u([d({type:yh,json:{write:!0}})],bm.prototype,"material",void 0),u([d({type:_w,json:{write:!0}})],bm.prototype,"resource",void 0),u([nt({Icon:"icon"},{readOnly:!0})],bm.prototype,"type",void 0),u([d(gg)],bm.prototype,"size",void 0),u([nt({center:"center",left:"left",right:"right",top:"top",bottom:"bottom",topLeft:"top-left",topRight:"top-right",bottomLeft:"bottom-left",bottomRight:"bottom-right",relative:"relative"}),d({json:{default:"center"}})],bm.prototype,"anchor",void 0),u([d({type:WE,json:{type:[Number],read:{reader:t=>new WE({x:t[0],y:t[1]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],bm.prototype,"anchorPosition",void 0),u([d({type:d3,json:{write:!0}})],bm.prototype,"outline",void 0),bm=X2=u([R(xxe)],bm);const R7e={circle:"circle",cross:"cross",diamond:"kite",square:"square",x:"x",triangle:"triangle",path:null};function M7e(t){return R7e[t]||(K.getLogger(xxe).warn(`${t} cannot be mapped to Icon symbol. Fallback to "circle"`),"circle")}const l1=bm;function $T(t,e,r=Ke){return e||(e=new r),e===t||(e.removeAll(),I7e(t)?e.addMany(t):t&&e.add(t)),e}function Txe(t){return t}function I7e(t){return t&&(Array.isArray(t)||"items"in t&&Array.isArray(t.items))}const P7e="not-loaded",$7e="loading",L7e="failed",doe="loaded",Sxe=t=>{let e=class extends t{constructor(...r){super(...r),this._loadController=null,this.loadError=null,this.loadStatus="not-loaded",this._set("loadWarnings",[]),this.addResolvingPromise(new Promise(i=>{const s=this.load.bind(this);this.load=n=>{const o=new Promise((a,l)=>{const c=jJ(n,l);this.destroyed&&l(new D("load:instance-destroyed",`Instance of '${this.declaredClass||this.constructor.name}' is already destroyed`,{instance:this})),this.when(a,l).finally(()=>{c&&c.remove()})});if(this.loadStatus===P7e){this._set("loadStatus",$7e);const a=this._loadController=new AbortController;s({signal:a.signal}),xn(a.signal,()=>{this._promiseProps.abort()})}return i(),o}})),this.when(()=>{this._set("loadStatus",doe),this._loadController=null},i=>{this._set("loadStatus",L7e),this._set("loadError",i),this._loadController=null})}destroy(){this._loadController=Do(this._loadController),this._set("loadError",null),this._set("loadWarnings",[])}get loaded(){return this.loadStatus===doe}get loadWarnings(){return this._get("loadWarnings")}load(){return null}cancelLoad(){return this.isFulfilled()||(this._set("loadError",new D("load:cancelled","Cancelled")),this._loadController?.abort()),this}};return u([d({readOnly:!0})],e.prototype,"loaded",null),u([d({readOnly:!0})],e.prototype,"loadError",void 0),u([d({clonable:!1})],e.prototype,"loadStatus",void 0),u([d({type:[Bd],readOnly:!0})],e.prototype,"loadWarnings",null),e=u([R("esri.core.Loadable")],e),e};let p3=class extends Sxe(lk){};p3=u([R("esri.core.Loadable")],p3),function(t){function e(r){return!(!r||!r.load)}t.LoadableMixin=Sxe,t.isLoadable=e}(p3||(p3={}));const _g=p3;let gL;function D7e(t){return gL&&!gL.destroyed||(gL=t()),gL}var yH;const N7e=new kr({avgRating:"avg-rating",numRatings:"num-ratings",numComments:"num-comments",numViews:"num-views"});let qh=yH=class extends me{constructor(t){super(t),this.categories=null,this.disableExtraQuery=!1,this.extent=null,this.filter=null,this.num=10,this.query=null,this.sortField=null,this.start=1}get sortOrder(){return this._get("sortOrder")||"asc"}set sortOrder(t){t!=="asc"&&t!=="desc"||this._set("sortOrder",t)}clone(){return new yH({categories:this.categories?re(this.categories):null,disableExtraQuery:this.disableExtraQuery,extent:this.extent?this.extent.clone():null,filter:this.filter,num:this.num,query:this.query,sortField:this.sortField,sortOrder:this.sortOrder,start:this.start})}toRequestOptions(t,e){let r=[];this.categories&&(r=this.categories.map(o=>Array.isArray(o)?JSON.stringify(o):o));let i="";if(this.extent){const o=sS(this.extent,qe.WGS84);o!=null&&(i=`${o.xmin},${o.ymin},${o.xmax},${o.ymax}`)}let s=this.query;!this.disableExtraQuery&&t.extraQuery&&(s="("+s+")"+t.extraQuery);const n={categories:r,bbox:i,q:s,filter:this.filter,num:this.num,sortField:null,sortOrder:null,start:this.start};return this.sortField&&(n.sortField=this.sortField.split(",").map(o=>N7e.toJSON(o.trim())).join(","),n.sortOrder=this.sortOrder),{query:{...e,...n}}}};u([d()],qh.prototype,"categories",void 0),u([d()],qh.prototype,"disableExtraQuery",void 0),u([d({type:vr})],qh.prototype,"extent",void 0),u([d()],qh.prototype,"filter",void 0),u([d()],qh.prototype,"num",void 0),u([d()],qh.prototype,"query",void 0),u([d()],qh.prototype,"sortField",void 0),u([d()],qh.prototype,"sortOrder",null),u([d()],qh.prototype,"start",void 0),qh=yH=u([R("esri.portal.PortalQueryParams")],qh);const Wm=qh;let vw=class extends me{constructor(e){super(e),this.nextQueryParams=null,this.queryParams=null,this.results=null,this.total=null}};u([d()],vw.prototype,"nextQueryParams",void 0),u([d()],vw.prototype,"queryParams",void 0),u([d()],vw.prototype,"results",void 0),u([d()],vw.prototype,"total",void 0),vw=u([R("esri.portal.PortalQueryResult")],vw);const F7e=vw;let fy=class extends he{constructor(e){super(e),this.created=null,this.id=null,this.portal=null,this.title=null,this.username=null}get url(){const e=this.get("portal.restUrl");return e?`${e}/content/users/${this.username}/${this.id}`:null}toJSON(){throw new D("internal:not-yet-implemented","PortalFolder.toJSON is not yet implemented")}};u([d({type:Date})],fy.prototype,"created",void 0),u([d()],fy.prototype,"id",void 0),u([d()],fy.prototype,"portal",void 0),u([d()],fy.prototype,"title",void 0),u([d({readOnly:!0})],fy.prototype,"url",null),u([d()],fy.prototype,"username",void 0),fy=u([R("esri.portal.PortalFolder")],fy);const k7e=fy;let Wo=class extends he{constructor(e){super(e),this.access=null,this.created=null,this.description=null,this.id=null,this.isInvitationOnly=!1,this.modified=null,this.owner=null,this.portal=null,this.snippet=null,this.sortField=null,this.sortOrder=null,this.tags=null,this.title=null}get thumbnailUrl(){const e=this.url,r=this.thumbnail;return e&&r&&this.portal?this.portal?.normalizeUrl(`${e}/info/${r}?f=json`):null}get url(){const e=this.get("portal.restUrl");return e?e+"/community/groups/"+this.id:null}fetchCategorySchema(e){return Ha(this.portal).request(this.url+"/categorySchema",e).then(r=>{const i=r.categorySchema||[];return i.some(s=>s.source==="contentCategorySetsGroupQuery.LivingAtlas")?this._fetchCategorySchemaSet("LivingAtlas",e):i})}fetchMembers(e){return Ha(this.portal).request(this.url+"/users",e)}getThumbnailUrl(e){let r=this.thumbnailUrl;return r&&e&&(r+=`&w=${e}`),r}toJSON(){throw new D("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}queryItems(e,r){let i=Sn(Wm,e);const s=Ha(this.portal);return parseFloat(s.currentVersion)>5?(i=i||new Wm,s.queryPortal(`/content/groups/${this.id}/search`,i,"PortalItem",r)):(i=i?i.clone():new Wm,i.query="group:"+this.id+(i.query?" "+i.query:""),s.queryItems(i,r))}_fetchCategorySchemaSet(e,r){const i=Ha(this.portal);return i.fetchSelf(i.authMode,!0,r).then(s=>{const n=s.contentCategorySetsGroupQuery;if(n){const o=new Wm;return o.disableExtraQuery=!0,o.num=1,o.query=n,i.queryGroups(o,r)}throw new D("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery value not found")}).then(s=>{if(s.total){const n=s.results[0],o=new Wm;return o.num=1,o.query=`typekeywords:"${e}"`,n.queryItems(o,r)}throw new D("portal-group:fetchCategorySchema","contentCategorySetsGroupQuery group not found")}).then(s=>s.total?s.results[0].fetchData("json",r).then(n=>{const o=n&&n.categorySchema;return o&&o.length?o:[]}):[])}};u([d()],Wo.prototype,"access",void 0),u([d({type:Date})],Wo.prototype,"created",void 0),u([d()],Wo.prototype,"description",void 0),u([d()],Wo.prototype,"id",void 0),u([d()],Wo.prototype,"isInvitationOnly",void 0),u([d({type:Date})],Wo.prototype,"modified",void 0),u([d()],Wo.prototype,"owner",void 0),u([d()],Wo.prototype,"portal",void 0),u([d()],Wo.prototype,"snippet",void 0),u([d()],Wo.prototype,"sortField",void 0),u([d()],Wo.prototype,"sortOrder",void 0),u([d()],Wo.prototype,"tags",void 0),u([d()],Wo.prototype,"thumbnail",void 0),u([d({readOnly:!0})],Wo.prototype,"thumbnailUrl",null),u([d()],Wo.prototype,"title",void 0),u([d({readOnly:!0})],Wo.prototype,"url",null),Wo=u([R("esri.portal.PortalGroup")],Wo);const _H=Wo,U7e=Object.freeze(Object.defineProperty({__proto__:null,default:_H},Symbol.toStringTag,{value:"Module"}));var vH;let $s=vH=class extends he{constructor(...t){super(...t),this.access=null,this.created=null,this.culture=null,this.description=null,this.email=null,this.fullName=null,this.modified=null,this.orgId=null,this.portal=null,this.preferredView=null,this.privileges=null,this.region=null,this.role=null,this.roleId=null,this.sourceJSON=null,this.units=null,this.username=null,this.userType=null}get thumbnailUrl(){const t=this.url,e=this.thumbnail;return t&&e?this.portal.normalizeUrl(`${t}/info/${e}?f=json`):null}get userContentUrl(){const t=this.get("portal.restUrl");return t?`${t}/content/users/${this.username}`:null}get url(){const t=this.get("portal.restUrl");return t?`${t}/community/users/${this.username}`:null}addItem(t){const e=t&&t.item,r=t&&t.data,i=t&&t.folder,s={method:"post"};e&&(s.query=e.createPostQuery(),r!=null&&(typeof r=="string"?s.query.text=r:typeof r=="object"&&(s.query.text=JSON.stringify(r))));let n=this.userContentUrl;return i&&(n+="/"+(typeof i=="string"?i:i.id)),this.portal.request(n+"/addItem",s).then(o=>(e.id=o.id,e.portal=this.portal,e.loaded?e.reload():e.load()))}deleteItem(t){let e=this.userContentUrl;return t.ownerFolder&&(e+="/"+t.ownerFolder),this.portal.request(e+`/items/${t.id}/delete`,{method:"post"}).then(()=>{t.id=null,t.portal=null})}deleteItems(t){const e=this.userContentUrl+"/deleteItems",r=t.map(i=>i.id);if(r.length){const i={method:"post",query:{items:r.join(",")}};return this.portal.request(e,i).then(()=>{t.forEach(s=>{s.id=null,s.portal=null})})}return Promise.resolve(void 0)}fetchFolders(){const t={query:{num:1}};return this.portal.request(this.userContentUrl??"",t).then(e=>{let r;return r=e&&e.folders?e.folders.map(i=>{const s=k7e.fromJSON(i);return s.portal=this.portal,s}):[],r})}fetchGroups(){return this.portal.request(this.url??"").then(t=>{let e;return e=t&&t.groups?t.groups.map(r=>{const i=_H.fromJSON(r);return i.portal=this.portal,i}):[],e})}fetchItems(t){const e=t??{};let r,i=this.userContentUrl??"";return e.folder&&(i+="/"+e.folder.id),J(()=>Promise.resolve().then(()=>S2e),void 0,import.meta.url).then(({default:s})=>{r=s;const n={folders:!1,num:e.num||10,start:e.start||1,sortField:e.sortField||"created",sortOrder:e.sortOrder||"asc"};return this.portal.request(i,{query:n})}).then(s=>{let n;return s&&s.items?(n=s.items.map(o=>{const a=r.fromJSON(o);return a.portal=this.portal,a}),Promise.all(n.map(o=>o.load())).catch(o=>o).then(()=>({items:n,nextStart:s.nextStart,total:s.total}))):{items:[],nextStart:-1,total:0}})}fetchTags(){return this.portal.request(this.url+"/tags").then(t=>t.tags)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}queryFavorites(t){return this.favGroupId?(this._favGroup||(this._favGroup=new _H({id:this.favGroupId,portal:this.portal})),this._favGroup.queryItems(t)):Promise.reject(new D("internal:unknown","Unknown internal error",{internalError:"Unknown favGroupId"}))}toJSON(){throw new D("internal:not-yet-implemented","PortalGroup.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");const e=new vH;return e.sourceJSON=t,e.read(t),e}};u([d()],$s.prototype,"access",void 0),u([d({type:Date})],$s.prototype,"created",void 0),u([d()],$s.prototype,"culture",void 0),u([d()],$s.prototype,"description",void 0),u([d()],$s.prototype,"email",void 0),u([d()],$s.prototype,"favGroupId",void 0),u([d()],$s.prototype,"fullName",void 0),u([d({type:Date})],$s.prototype,"modified",void 0),u([d()],$s.prototype,"orgId",void 0),u([d()],$s.prototype,"portal",void 0),u([d()],$s.prototype,"preferredView",void 0),u([d()],$s.prototype,"privileges",void 0),u([d()],$s.prototype,"region",void 0),u([d()],$s.prototype,"role",void 0),u([d()],$s.prototype,"roleId",void 0),u([d()],$s.prototype,"sourceJSON",void 0),u([d()],$s.prototype,"thumbnail",void 0),u([d({readOnly:!0})],$s.prototype,"thumbnailUrl",null),u([d()],$s.prototype,"units",void 0),u([d({readOnly:!0})],$s.prototype,"userContentUrl",null),u([d({readOnly:!0})],$s.prototype,"url",null),u([d()],$s.prototype,"username",void 0),u([d()],$s.prototype,"userType",void 0),$s=vH=u([R("esri.portal.PortalUser")],$s);const _K=$s,V7e=Object.freeze(Object.defineProperty({__proto__:null,default:_K},Symbol.toStringTag,{value:"Module"}));var my;let yL;const poe={PortalGroup:()=>J(()=>Promise.resolve().then(()=>U7e),void 0,import.meta.url),PortalItem:()=>J(()=>Promise.resolve().then(()=>S2e),void 0,import.meta.url),PortalUser:()=>J(()=>Promise.resolve().then(()=>V7e),void 0,import.meta.url)};let De=my=class extends iS(_g){constructor(t){super(t),this._esriIdCredentialCreateHandle=null,this.access=null,this.allSSL=!1,this.authMode="auto",this.authorizedCrossOriginDomains=null,this.basemapGalleryGroupQuery=null,this.basemapGalleryGroupQuery3D=null,this.bingKey=null,this.canListApps=!1,this.canListData=!1,this.canListPreProvisionedItems=!1,this.canProvisionDirectPurchase=!1,this.canSearchPublic=!0,this.canShareBingPublic=!1,this.canSharePublic=!1,this.canSignInArcGIS=!1,this.canSignInIDP=!1,this.colorSetsGroupQuery=null,this.commentsEnabled=!1,this.created=null,this.culture=null,this.customBaseUrl=null,this.defaultBasemap=null,this.defaultDevBasemap=null,this.defaultExtent=null,this.defaultVectorBasemap=null,this.description=null,this.devBasemapGalleryGroupQuery=null,this.eueiEnabled=null,this.featuredGroups=null,this.featuredItemsGroupQuery=null,this.galleryTemplatesGroupQuery=null,this.livingAtlasGroupQuery=null,this.hasCategorySchema=!1,this.helperServices=null,this.homePageFeaturedContent=null,this.homePageFeaturedContentCount=null,this.httpPort=null,this.httpsPort=null,this.id=null,this.ipCntryCode=null,this.isPortal=!1,this.isReadOnly=!1,this.layerTemplatesGroupQuery=null,this.maxTokenExpirationMinutes=null,this.modified=null,this.name=null,this.portalHostname=null,this.portalMode=null,this.portalProperties=null,this.region=null,this.rotatorPanels=null,this.showHomePageDescription=!1,this.sourceJSON=null,this.supportsHostedServices=!1,this.symbolSetsGroupQuery=null,this.templatesGroupQuery=null,this.units=null,this.url=qr.portalUrl,this.urlKey=null,this.user=null,this.use3dBasemaps=!0,this.useStandardizedQuery=!1,this.useVectorBasemaps=!1,this.vectorBasemapGalleryGroupQuery=null}normalizeCtorArgs(t){return typeof t=="string"?{url:t}:t}destroy(){foe.unregister(this),this.defaultBasemap=Re(this.defaultBasemap),this.defaultDevBasemap=Re(this.defaultDevBasemap),this.defaultVectorBasemap=Re(this.defaultVectorBasemap),this._esriIdCredentialCreateHandle=Pi(this._esriIdCredentialCreateHandle)}readAuthorizedCrossOriginDomains(t){if(t)for(const e of t)qr.request.trustedServers.includes(e)||qr.request.trustedServers.push(e);return t}readDefaultBasemap(t){return this._readBasemap(t)}readDefaultDevBasemap(t){return this._readBasemap(t)}readDefaultVectorBasemap(t){return this._readBasemap(t)}get extraQuery(){const t=!(this.user&&this.user.orgId)||this.canSearchPublic;return this.id&&!t?` AND orgid:${this.id}`:null}get isOrganization(){return!!this.access}get itemPageUrl(){return this.url?`${this.url}/home/item.html`:null}get restUrl(){let t=this.url;if(t){const e=t.indexOf("/sharing");t=e>0?t.substring(0,e):this.url.replace(/\/+$/,""),t+="/sharing/rest"}return t}get thumbnailUrl(){const t=this.restUrl,e=this.thumbnail;return t&&e?this._normalizeSSL(t+"/portals/self/resources/"+e):null}readUrlKey(t){return t&&t.toLowerCase()}readUser(t){let e=null;return t&&(e=_K.fromJSON(t),e.portal=this),e}load(t){const e=J(()=>Promise.resolve().then(()=>Zst),void 0,import.meta.url).then(({default:r})=>{Dt(t),yL=r}).then(()=>this.sourceJSON?this.sourceJSON:this.fetchSelf(this.authMode,!1,t)).then(r=>{if(Gt){const i=Gt;this.credential=i.findCredential(this.restUrl),this.credential||this.authMode!==my.AUTH_MODE_AUTO||(this._esriIdCredentialCreateHandle?.remove(),this._esriIdCredentialCreateHandle=i.on("credential-create",z7e(new WeakRef(this))),foe.register(this,this._esriIdCredentialCreateHandle,this))}this.sourceJSON=r,this.read(r)});return this.addResolvingPromise(e),Promise.resolve(this)}async createElevationLayers(){await this.load();const t=this._getHelperService("defaultElevationLayers"),e=(await J(()=>import("./ElevationLayer-346dfd19.js"),["./ElevationLayer-346dfd19.js","./ArcGISCachedService-0c9ef884.js","./TileInfoTilemapCache-c3c2150d.js","./TilemapCache-e77fcad4.js"],import.meta.url)).default;return t?t.map(r=>new e({id:r.id,url:r.url})):[]}async fetchBasemaps(t,e){const r=await this._fetchBasemaps(t,e);if(e?.include3d===!0&&this.use3dBasemaps!==!1){const i=await this._fetchBasemaps3D(t,e);r.unshift(...i)}return r}fetchCategorySchema(t){return this.hasCategorySchema?this.request(this.restUrl+"/portals/self/categorySchema",t).then(e=>e.categorySchema):dn(t)?Promise.reject(Tr()):Promise.resolve([])}fetchFeaturedGroups(t){const e=this.featuredGroups,r=new Wm;if(r.num=100,r.sortField="title",e&&e.length){const i=[];for(const s of e)i.push(`(title:"${s.title}" AND owner:${s.owner})`);return r.query=i.join(" OR "),this.queryGroups(r,t).then(s=>s.results)}return dn(t)?Promise.reject(Tr()):Promise.resolve([])}fetchRegions(t){const e=this.user?.culture||this.culture||Ld();return this.request(this.restUrl+"/portals/regions",{...t,query:{culture:e}})}fetchSettings(t){const e=this.user?.culture||this.culture||Ld();return this.request(this.restUrl+"/portals/self/settings",{...t,query:{culture:e}})}static getDefault(){return D7e(()=>new my)}queryGroups(t,e){return this.queryPortal("/community/groups",t,"PortalGroup",e)}queryItems(t,e){return this.queryPortal("/search",t,"PortalItem",e)}queryUsers(t,e){return t.sortField||(t.sortField="username"),this.queryPortal("/community/users",t,"PortalUser",e)}fetchSelf(t=this.authMode,e=!1,r){const i=this.restUrl+"/portals/self",s={authMode:t,query:{culture:Ld().toLowerCase()},...r};return s.authMode==="auto"&&(s.authMode="no-prompt"),e&&(s.query.default=!0),this.request(i,s)}queryPortal(t,e,r,i){const s=Sn(Wm,e),n=o=>this.request(this.restUrl+t,{...s.toRequestOptions(this),...i}).then(a=>{const l=s.clone();return l.start=a.nextStart,new F7e({nextQueryParams:l,queryParams:s,total:a.total,results:my._resultsToTypedArray(o,{portal:this},a,i)})}).then(a=>Promise.all(a.results.map(l=>typeof l.when=="function"?l.when():a)).then(()=>a,l=>(xa(l),a)));return r&&poe[r]?poe[r]().then(({default:o})=>(Dt(i),n(o))):n()}signIn(){if(this.authMode===my.AUTH_MODE_ANONYMOUS)return Promise.reject(new D("portal:invalid-auth-mode",`Current "authMode"' is "${this.authMode}"`));if(this.loadStatus==="failed")return Promise.reject(this.loadError);const t=e=>Promise.resolve().then(()=>this.loadStatus==="not-loaded"?(e||(this.authMode="immediate"),this.load().then(()=>null)):this.loadStatus==="loading"?this.load().then(()=>this.credential?null:(this.credential=e,this.fetchSelf("immediate"))):this.user&&this.credential===e?null:(this.credential=e,this.fetchSelf("immediate"))).then(r=>{r&&(this.sourceJSON=r,this.read(r))});return Gt?Gt.getCredential(this.restUrl).then(e=>t(e)):t(this.credential)}normalizeUrl(t){const e=this.credential&&this.credential.token;return this._normalizeSSL(e?t+(t.includes("?")?"&":"?")+"token="+e:t)}requestToTypedArray(t,e,r){return this.request(t,e).then(i=>{const s=my._resultsToTypedArray(r,{portal:this},i);return Promise.all(s.map(n=>typeof n.when=="function"?n.when():i)).then(()=>s,()=>s)})}request(t,e={}){const r={f:"json",...e.query},{authMode:i=this.authMode===my.AUTH_MODE_ANONYMOUS?"anonymous":"auto",body:s=null,cacheBust:n=!1,method:o="auto",responseType:a="json",signal:l}=e,c={authMode:i,body:s,cacheBust:n,method:o,query:r,responseType:a,timeout:0,signal:l};return Lt(this._normalizeSSL(t),c).then(h=>h.data)}toJSON(){throw new D("internal:not-yet-implemented","Portal.toJSON is not yet implemented")}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new my({sourceJSON:t})}_getHelperService(t){const e=this.helperServices&&this.helperServices[t];if(!e)throw new D("portal:service-not-found",`The \`helperServices\` do not include an entry named "${t}"`);return e}async _fetchBasemaps(t,e){const r=new Wm;r.query=t||(qr.apiKey&&xve(this.url)?this.devBasemapGalleryGroupQuery:this.useVectorBasemaps?this.vectorBasemapGalleryGroupQuery:this.basemapGalleryGroupQuery),r.disableExtraQuery=!0;const i=await this.queryGroups(r,e);if(!i.total)return[];const s=i.results[0];r.num=100,r.query='type:"Web Map" -type:"Web Application"',r.sortField=s.sortField||"name",r.sortOrder=s.sortOrder||"desc";const n=await s.queryItems(r,e);return n.total?n.results.filter(o=>o.type==="Web Map").map(o=>new yL({portalItem:o})):[]}async _fetchBasemaps3D(t,e){const r=t||this.basemapGalleryGroupQuery3D;if(!r)return[];const i=new Wm({query:r,disableExtraQuery:!0}),s=await this.queryGroups(i,e);if(!s.total)return[];const n=s.results[0];i.num=100,i.query='type:"Web Scene"',i.sortField=n.sortField||"name",i.sortOrder=n.sortOrder||"desc";const o=await n.queryItems(i,e);return o.total?o.results.filter(a=>a.type==="Web Scene").map(a=>new yL({portalItem:a})):[]}_normalizeSSL(t){return t.replace(/^http:/i,"https:").replace(":7080",":7443")}_readBasemap(t){if(t){const e=yL.fromJSON(t);return e.portalItem={portal:this},e}return null}static _resultsToTypedArray(t,e,r,i){let s=[];if(r){const n=i!=null?i.signal:null;s=r.listings||r.notifications||r.userInvitations||r.tags||r.items||r.groups||r.comments||r.provisions||r.results||r.relatedItems||r,(t||e)&&(s=s.map(o=>{const a=Object.assign(t?t.fromJSON(o):o,e);return typeof a.load=="function"&&a.load(n),a}))}else s=[];return s}};De.AUTH_MODE_ANONYMOUS="anonymous",De.AUTH_MODE_AUTO="auto",De.AUTH_MODE_IMMEDIATE="immediate",u([d()],De.prototype,"access",void 0),u([d()],De.prototype,"allSSL",void 0),u([d()],De.prototype,"authMode",void 0),u([d()],De.prototype,"authorizedCrossOriginDomains",void 0),u([Ae("authorizedCrossOriginDomains")],De.prototype,"readAuthorizedCrossOriginDomains",null),u([d()],De.prototype,"basemapGalleryGroupQuery",void 0),u([d({json:{name:"3DBasemapGalleryGroupQuery"}})],De.prototype,"basemapGalleryGroupQuery3D",void 0),u([d()],De.prototype,"bingKey",void 0),u([d()],De.prototype,"canListApps",void 0),u([d()],De.prototype,"canListData",void 0),u([d()],De.prototype,"canListPreProvisionedItems",void 0),u([d()],De.prototype,"canProvisionDirectPurchase",void 0),u([d()],De.prototype,"canSearchPublic",void 0),u([d()],De.prototype,"canShareBingPublic",void 0),u([d()],De.prototype,"canSharePublic",void 0),u([d()],De.prototype,"canSignInArcGIS",void 0),u([d()],De.prototype,"canSignInIDP",void 0),u([d()],De.prototype,"colorSetsGroupQuery",void 0),u([d()],De.prototype,"commentsEnabled",void 0),u([d({type:Date})],De.prototype,"created",void 0),u([d()],De.prototype,"credential",void 0),u([d()],De.prototype,"culture",void 0),u([d()],De.prototype,"currentVersion",void 0),u([d()],De.prototype,"customBaseUrl",void 0),u([d()],De.prototype,"defaultBasemap",void 0),u([Ae("defaultBasemap")],De.prototype,"readDefaultBasemap",null),u([d()],De.prototype,"defaultDevBasemap",void 0),u([Ae("defaultDevBasemap")],De.prototype,"readDefaultDevBasemap",null),u([d({type:vr})],De.prototype,"defaultExtent",void 0),u([d()],De.prototype,"defaultVectorBasemap",void 0),u([Ae("defaultVectorBasemap")],De.prototype,"readDefaultVectorBasemap",null),u([d()],De.prototype,"description",void 0),u([d()],De.prototype,"devBasemapGalleryGroupQuery",void 0),u([d()],De.prototype,"eueiEnabled",void 0),u([d({readOnly:!0})],De.prototype,"extraQuery",null),u([d()],De.prototype,"featuredGroups",void 0),u([d()],De.prototype,"featuredItemsGroupQuery",void 0),u([d()],De.prototype,"galleryTemplatesGroupQuery",void 0),u([d()],De.prototype,"livingAtlasGroupQuery",void 0),u([d()],De.prototype,"hasCategorySchema",void 0),u([d()],De.prototype,"helpBase",void 0),u([d()],De.prototype,"helperServices",void 0),u([d()],De.prototype,"helpMap",void 0),u([d()],De.prototype,"homePageFeaturedContent",void 0),u([d()],De.prototype,"homePageFeaturedContentCount",void 0),u([d()],De.prototype,"httpPort",void 0),u([d()],De.prototype,"httpsPort",void 0),u([d()],De.prototype,"id",void 0),u([d()],De.prototype,"ipCntryCode",void 0),u([d({readOnly:!0})],De.prototype,"isOrganization",null),u([d()],De.prototype,"isPortal",void 0),u([d()],De.prototype,"isReadOnly",void 0),u([d({readOnly:!0})],De.prototype,"itemPageUrl",null),u([d()],De.prototype,"layerTemplatesGroupQuery",void 0),u([d()],De.prototype,"maxTokenExpirationMinutes",void 0),u([d({type:Date})],De.prototype,"modified",void 0),u([d()],De.prototype,"name",void 0),u([d()],De.prototype,"portalHostname",void 0),u([d()],De.prototype,"portalMode",void 0),u([d()],De.prototype,"portalProperties",void 0),u([d()],De.prototype,"region",void 0),u([d({readOnly:!0})],De.prototype,"restUrl",null),u([d()],De.prototype,"rotatorPanels",void 0),u([d()],De.prototype,"showHomePageDescription",void 0),u([d()],De.prototype,"sourceJSON",void 0),u([d()],De.prototype,"staticImagesUrl",void 0),u([d({json:{name:"2DStylesGroupQuery"}})],De.prototype,"stylesGroupQuery2d",void 0),u([d({json:{name:"stylesGroupQuery"}})],De.prototype,"stylesGroupQuery3d",void 0),u([d()],De.prototype,"supportsHostedServices",void 0),u([d()],De.prototype,"symbolSetsGroupQuery",void 0),u([d()],De.prototype,"templatesGroupQuery",void 0),u([d()],De.prototype,"thumbnail",void 0),u([d({readOnly:!0})],De.prototype,"thumbnailUrl",null),u([d()],De.prototype,"units",void 0),u([d()],De.prototype,"url",void 0),u([d()],De.prototype,"urlKey",void 0),u([Ae("urlKey")],De.prototype,"readUrlKey",null),u([d()],De.prototype,"user",void 0),u([Ae("user")],De.prototype,"readUser",null),u([d()],De.prototype,"use3dBasemaps",void 0),u([d()],De.prototype,"useStandardizedQuery",void 0),u([d()],De.prototype,"useVectorBasemaps",void 0),u([d()],De.prototype,"vectorBasemapGalleryGroupQuery",void 0),De=my=u([R("esri.portal.Portal")],De);const ao=De,foe=new FinalizationRegistry(t=>{t.remove()});function z7e(t){const e=Gt;return()=>{const r=t.deref();r&&e.findCredential(r.restUrl)&&r.signIn().catch(()=>{})}}let bw=class extends rs(he){constructor(e){super(e),this.type="style",this.placement="begin-end",this.style="arrow",this.color=null}equals(e){return e!=null&&e.placement===this.placement&&e.style===this.style&&(this.color==null&&e.color==null||this.color!=null&&e.color!=null&&this.color.toJSON()===e.color.toJSON())}};u([d({type:["style"],readOnly:!0,json:{read:!0,write:{ignoreOrigin:!0}}})],bw.prototype,"type",void 0),u([d({type:t7e,json:{default:"begin-end",write:!0}})],bw.prototype,"placement",void 0),u([d({type:rxe,json:{default:"arrow",write:!0}})],bw.prototype,"style",void 0),u([d({type:Le,json:{type:[Ki],default:null,write:!0}})],bw.prototype,"color",void 0),bw=u([R("esri.symbols.LineStyleMarker3D")],bw);const bH=bw;var GF;let wm=GF=class extends Lg{constructor(t){super(t),this.material=null,this.type="line",this.join="miter",this.cap="butt",this.size=Fl(1),this.pattern=null,this.marker=null}clone(){const t={enabled:this.enabled,material:this.material!=null?this.material.clone():null,size:this.size,join:this.join,cap:this.cap,pattern:this.pattern!=null?this.pattern.clone():null,marker:this.marker!=null?this.marker.clone():null};return new GF(t)}static fromSimpleLineSymbol(t){const e={enabled:!0,size:t.width??Fl(1),cap:t.cap||"butt",join:t.join||"miter",pattern:t.style&&t.style!=="inside-frame"?new pK({style:t.style}):null,material:new yh({color:(t.color||VM).clone()}),marker:t.marker?new bH({placement:t.marker.placement,style:t.marker.style,color:t.marker.color?.clone()??null}):null};return new GF(e)}};u([d({type:yh,json:{write:!0}})],wm.prototype,"material",void 0),u([nt({Line:"line"},{readOnly:!0})],wm.prototype,"type",void 0),u([d({type:pxe,json:{write:!0,default:"miter"}})],wm.prototype,"join",void 0),u([d({type:yK,json:{write:!0,default:"butt"}})],wm.prototype,"cap",void 0),u([d(gg)],wm.prototype,"size",void 0),u([d(axe)],wm.prototype,"pattern",void 0),u([d({types:{key:"type",base:bH,typeMap:{style:bH}},json:{write:!0}})],wm.prototype,"marker",void 0),wm=GF=u([R("esri.symbols.LineSymbol3DLayer")],wm);const n$=wm;var wH;const B7e=zl()({sphere:"sphere",cylinder:"cylinder",cube:"cube",cone:"cone",diamond:"diamond",tetrahedron:"tetrahedron",invertedCone:"inverted-cone"});let f3=wH=class extends he{clone(){return new wH({href:this.href,primitive:this.primitive})}};u([d({type:String,json:{read:tV,write:U1}})],f3.prototype,"href",void 0),u([nt(B7e)],f3.prototype,"primitive",void 0),f3=wH=u([R("esri.symbols.support.ObjectSymbol3DLayerResource")],f3);const vK="sphere";var xH;let vx=xH=class extends me{constructor(){super(...arguments),this.x=0,this.y=0,this.z=0}clone(){return new xH({x:this.x,y:this.y,z:this.z})}};u([d({type:Number})],vx.prototype,"x",void 0),u([d({type:Number})],vx.prototype,"y",void 0),u([d({type:Number})],vx.prototype,"z",void 0),vx=xH=u([R("esri.symbols.support.Symbol3DAnchorPosition3D")],vx);var TH;let yl=TH=class extends Lg{constructor(t){super(t),this.material=null,this.castShadows=!0,this.resource=null,this.type="object",this.width=void 0,this.height=void 0,this.depth=void 0,this.anchor=void 0,this.anchorPosition=void 0,this.heading=void 0,this.tilt=void 0,this.roll=void 0}clone(){return new TH({heading:this.heading,tilt:this.tilt,roll:this.roll,anchor:this.anchor,anchorPosition:this.anchorPosition&&this.anchorPosition.clone(),depth:this.depth,enabled:this.enabled,height:this.height,material:this.material!=null?this.material.clone():null,castShadows:this.castShadows,resource:this.resource&&this.resource.clone(),width:this.width})}get isPrimitive(){return!this.resource||typeof this.resource.href!="string"}};u([d({type:yh,json:{write:!0}})],yl.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],yl.prototype,"castShadows",void 0),u([d({type:f3,json:{write:!0}})],yl.prototype,"resource",void 0),u([nt({Object:"object"},{readOnly:!0})],yl.prototype,"type",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"width",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"height",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"depth",void 0),u([nt({center:"center",top:"top",bottom:"bottom",origin:"origin",relative:"relative"}),d({json:{default:"origin"}})],yl.prototype,"anchor",void 0),u([d({type:vx,json:{type:[Number],read:{reader:t=>new vx({x:t[0],y:t[1],z:t[2]})},write:{writer:(t,e)=>{e.anchorPosition=[t.x,t.y,t.z]},overridePolicy(){return{enabled:this.anchor==="relative"}}}}})],yl.prototype,"anchorPosition",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"heading",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"tilt",void 0),u([d({type:Number,json:{write:!0}})],yl.prototype,"roll",void 0),u([d({readOnly:!0})],yl.prototype,"isPrimitive",null),yl=TH=u([R("esri.symbols.ObjectSymbol3DLayer")],yl);const bK=yl;var SH;let ec=SH=class extends Lg{constructor(t){super(t),this.material=null,this.castShadows=!0,this.type="path",this.profile="circle",this.join="miter",this.cap="butt",this.width=void 0,this.height=void 0,this.anchor="center",this.profileRotation="all"}readWidth(t,e){return t??(e.height==null&&e.size!=null?e.size:void 0)}readHeight(t,e){return t??(e.width==null&&e.size!=null?e.size:void 0)}clone(){return new SH({enabled:this.enabled,material:this.material!=null?this.material.clone():null,castShadows:this.castShadows,profile:this.profile,join:this.join,cap:this.cap,width:this.width,height:this.height,profileRotation:this.profileRotation,anchor:this.anchor})}};u([d({type:yh,json:{write:!0}})],ec.prototype,"material",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:!0,default:!0}})],ec.prototype,"castShadows",void 0),u([nt({Path:"path"},{readOnly:!0})],ec.prototype,"type",void 0),u([d({type:["circle","quad"],json:{write:!0,default:"circle"}})],ec.prototype,"profile",void 0),u([d({type:pxe,json:{write:!0,default:"miter"}})],ec.prototype,"join",void 0),u([d({type:b7e,json:{write:!0,default:"butt"}})],ec.prototype,"cap",void 0),u([d({type:Number,json:{write:{enabled:!0,target:{width:{type:Number},size:{type:Number}}}}})],ec.prototype,"width",void 0),u([Ae("width",["width","size","height"])],ec.prototype,"readWidth",null),u([d({type:Number,json:{write:!0}})],ec.prototype,"height",void 0),u([Ae("height",["height","size","width"])],ec.prototype,"readHeight",null),u([d({type:["center","bottom","top"],json:{write:!0,default:"center"}})],ec.prototype,"anchor",void 0),u([d({type:["heading","all"],json:{write:!0,default:"all"}})],ec.prototype,"profileRotation",void 0),ec=SH=u([R("esri.symbols.PathSymbol3DLayer")],ec);const wK=ec;var EH;let ZE=EH=class extends he{constructor(){super(...arguments),this.color=new Le([0,0,0,1]),this.size=0}clone(){const t={color:re(this.color),size:this.size};return new EH(t)}};u([d(k0)],ZE.prototype,"color",void 0),u([d(gg)],ZE.prototype,"size",void 0),ZE=EH=u([R("esri.symbols.support.Symbol3DHalo")],ZE);let BM=class extends rs(he){constructor(e){super(e),this.color=null}};u([d(k0)],BM.prototype,"color",void 0),BM=u([R("esri.symbols.support.Symbol3DTextBackground")],BM);var jF;let Bc=jF=class extends Lg{constructor(t){super(t),this._userSize=void 0,this.halo=null,this.horizontalAlignment="center",this.lineHeight=1,this.material=null,this.background=null,this.text=null,this.type="text",this.verticalAlignment="baseline"}get font(){return this._get("font")||null}set font(t){t!=null&&this._userSize!=null&&(t.size=this._userSize),this._set("font",t)}writeFont(t,e,r,i){const s={...i,textSymbol3D:!0};e.font=t.write({},s),delete e.font.size}get size(){return this._userSize!=null?this._userSize:this.font!=null&&this.font.size!=null?this.font.size:9}set size(t){this._userSize=t,this.font!=null&&(this.font.size=this._userSize),this.notifyChange("size")}clone(){const t=new jF({enabled:this.enabled,font:this.font&&re(this.font),halo:this.halo&&re(this.halo),horizontalAlignment:this.horizontalAlignment,lineHeight:this.lineHeight,material:this.material!=null?this.material.clone():null,text:this.text,verticalAlignment:this.verticalAlignment,background:re(this.background)});return t._userSize=this._userSize,t}static fromTextSymbol(t){return new jF({font:t.font!=null?t.font.clone():new eV,halo:G7e(t.haloColor,t.haloSize),horizontalAlignment:t.horizontalAlignment,lineHeight:t.lineHeight,material:t.color?new yh({color:t.color.clone()}):null,text:t.text,verticalAlignment:t.verticalAlignment,background:t.backgroundColor?new BM({color:t.backgroundColor.clone()}):null})}};function G7e(t,e){return t&&e!=null&&e>0?new ZE({color:re(t),size:e}):null}u([d({type:eV,json:{write:!0}})],Bc.prototype,"font",null),u([Ve("font")],Bc.prototype,"writeFont",null),u([d({type:ZE,json:{write:!0}})],Bc.prototype,"halo",void 0),u([d({...mxe,json:{default:"center",write:!0}})],Bc.prototype,"horizontalAlignment",void 0),u([d({...fxe,json:{default:1,write:!0}})],Bc.prototype,"lineHeight",void 0),u([d({type:yh,json:{write:!0}})],Bc.prototype,"material",void 0),u([d({type:BM,json:{write:!0}})],Bc.prototype,"background",void 0),u([d(gg)],Bc.prototype,"size",null),u([d({type:String,json:{write:!0}})],Bc.prototype,"text",void 0),u([nt({Text:"text"},{readOnly:!0})],Bc.prototype,"type",void 0),u([d({...gxe,json:{default:"baseline",write:!0}})],Bc.prototype,"verticalAlignment",void 0),Bc=jF=u([R("esri.symbols.TextSymbol3DLayer")],Bc);const uS=Bc;var CH;let W_=CH=class extends Lg{constructor(t){super(t),this.color=AH.clone(),this.type="water",this.waterbodySize="medium",this.waveDirection=null,this.waveStrength="moderate"}clone(){return new CH({color:re(this.color),waterbodySize:this.waterbodySize,waveDirection:this.waveDirection,waveStrength:this.waveStrength})}};u([d({type:Le,nonNullable:!0,json:{type:[Ki],write:(t,e,r)=>e[r]=t.toArray(Le.AlphaMode.UNLESS_OPAQUE),default:()=>AH.clone(),defaultEquals:t=>t.toCss(!0)===AH.toCss(!0)}})],W_.prototype,"color",void 0),u([nt({Water:"water"},{readOnly:!0})],W_.prototype,"type",void 0),u([d({type:["small","medium","large"],json:{write:!0,default:"medium"}})],W_.prototype,"waterbodySize",void 0),u([d({type:Number,json:{write:!0,default:null}})],W_.prototype,"waveDirection",void 0),u([d({type:["calm","rippled","slight","moderate"],json:{write:!0,default:"moderate"}})],W_.prototype,"waveStrength",void 0),W_=CH=u([R("esri.symbols.WaterSymbol3DLayer")],W_);const AH=new Le([0,119,190]),Exe=W_;var OH;let ww=OH=class extends me{constructor(t){super(t),this.name=null,this.styleUrl=null,this.styleName=null,this.portal=null}clone(){return new OH({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}};u([d({type:String})],ww.prototype,"name",void 0),u([d({type:String})],ww.prototype,"styleUrl",void 0),u([d({type:String})],ww.prototype,"styleName",void 0),u([d({type:ao})],ww.prototype,"portal",void 0),ww=OH=u([R("esri.symbols.support.StyleOrigin")],ww);const YI=ww;var RH;let tT=RH=class extends me{constructor(){super(...arguments),this.url=""}clone(){return new RH({url:this.url})}};u([d({type:String})],tT.prototype,"url",void 0),tT=RH=u([R("esri.symbols.support.Thumbnail")],tT);const Cxe={icon:l1,object:bK,line:n$,path:wK,fill:cO,extrude:txe,text:uS,water:Exe},j7e=Ke.ofType({base:Lg,key:"type",typeMap:Cxe,errorContext:"symbol-layer"});let xm=class extends Mu{constructor(e){super(e),this.styleOrigin=null,this.thumbnail=null,this.type=null;const r=this.__accessor__&&this.__accessor__.metadatas&&this.__accessor__.metadatas.symbolLayers,i=r&&r.type||Ke;this._set("symbolLayers",new i)}get color(){return null}set color(e){this.constructed&&K.getLogger(this).error("Symbol3D does not support colors on the symbol level. Colors may be set on individual symbol layer materials instead.")}set symbolLayers(e){$T(e,this._get("symbolLayers"))}readStyleOrigin(e,r,i){if(e.styleUrl&&e.name){const s=A0(e.styleUrl,i);return new YI({styleUrl:s,name:e.name})}if(e.styleName&&e.name)return new YI({portal:i&&i.portal||ao.getDefault(),styleName:e.styleName,name:e.name});i&&i.messages&&i.messages.push(new Bd("symbol3d:incomplete-style-origin","Style origin requires either a 'styleUrl' or 'styleName' and a 'name' property",{context:i,definition:e}))}writeStyleOrigin(e,r,i,s){if(e.styleUrl&&e.name){let n=O0(e.styleUrl,s);wu(n)&&(n=Dd(n)),r.styleOrigin={styleUrl:n,name:e.name}}else e.styleName&&e.name&&(e.portal&&s&&s.portal&&!dve(e.portal.restUrl,s.portal.restUrl)?s&&s.messages&&s.messages.push(new Bd("symbol:cross-portal","The symbol style origin cannot be persisted because it refers to an item on a different portal than the one being saved to.",{symbol:this})):r.styleOrigin={styleName:e.styleName,name:e.name})}normalizeCtorArgs(e){return e instanceof Lg||e&&Cxe[e.type]?{symbolLayers:[e]}:Array.isArray(e)?{symbolLayers:e}:e}};u([d({json:{read:!1,write:!1}})],xm.prototype,"color",null),u([d({type:j7e,nonNullable:!0,json:{write:!0}}),or(Txe)],xm.prototype,"symbolLayers",null),u([d({type:YI})],xm.prototype,"styleOrigin",void 0),u([Ae("styleOrigin")],xm.prototype,"readStyleOrigin",null),u([Ve("styleOrigin",{"styleOrigin.styleUrl":{type:String},"styleOrigin.styleName":{type:String},"styleOrigin.name":{type:String}})],xm.prototype,"writeStyleOrigin",null),u([d({type:tT,json:{read:!1}})],xm.prototype,"thumbnail",void 0),u([d({type:["point-3d","line-3d","polygon-3d","mesh-3d","label-3d"],readOnly:!0})],xm.prototype,"type",void 0),xm=u([R("esri.symbols.Symbol3D")],xm);const uO=xm;let m3=class extends he{constructor(e){super(e),this.visible=!0}clone(){}};u([d({type:["line"],readOnly:!0,json:{read:!1,write:{ignoreOrigin:!0}}})],m3.prototype,"type",void 0),u([d({readOnly:!0})],m3.prototype,"visible",void 0),m3=u([R("esri.symbols.callouts.Callout3D")],m3);const Axe=m3;var MH;let HF=MH=class extends he{constructor(){super(...arguments),this.color=new Le("white")}clone(){return new MH({color:re(this.color)})}};u([d(k0)],HF.prototype,"color",void 0),HF=MH=u([R("esri.symbols.callouts.LineCallout3DBorder")],HF);const Oxe=HF;Object.freeze(Object.defineProperty({__proto__:null,default:Oxe},Symbol.toStringTag,{value:"Module"}));var IH;let Z_=IH=class extends Axe{constructor(t){super(t),this.type="line",this.color=new Le([0,0,0,1]),this.size=Fl(1),this.border=null}get visible(){return this.size>0&&this.color!=null&&this.color.a>0}clone(){return new IH({color:re(this.color),size:this.size,border:re(this.border)})}};u([nt({line:"line"},{readOnly:!0})],Z_.prototype,"type",void 0),u([d(k0)],Z_.prototype,"color",void 0),u([d(gg)],Z_.prototype,"size",void 0),u([d({type:Oxe,json:{write:!0}})],Z_.prototype,"border",void 0),u([d({readOnly:!0})],Z_.prototype,"visible",null),Z_=IH=u([R("esri.symbols.callouts.LineCallout3D")],Z_);const H7e=Z_;function xK(t){if(!t)return!1;const e=t.verticalOffset;return!!e&&!(e.screenLength<=0||e.maxWorldLength!=null&&e.maxWorldLength<=0)}function Rxe(t){if(!t||!t.supportsCallout||!t.supportsCallout())return!1;const e=t.callout;return!!e&&!!e.visible&&!!xK(t)}function TK(t){return t.type==="point-3d"||t.type==="label-3d"}function Mxe(t){return t.horizontalAlignment==="center"}const Ixe={types:{key:"type",base:Axe,typeMap:{line:H7e}},json:{write:!0}};var PH;let Y2=PH=class extends he{constructor(t){super(t),this.screenLength=0,this.minWorldLength=0,this.maxWorldLength=null}clone(){return new PH({screenLength:this.screenLength,minWorldLength:this.minWorldLength,maxWorldLength:this.maxWorldLength})}};u([d(gg)],Y2.prototype,"screenLength",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0,default:0}})],Y2.prototype,"minWorldLength",void 0),u([d({type:Number,json:{write:!0}})],Y2.prototype,"maxWorldLength",void 0),Y2=PH=u([R("esri.symbols.support.Symbol3DVerticalOffset")],Y2);const Pxe=Y2;var qF;const $xe=Ke.ofType({base:null,key:"type",typeMap:{text:uS}});let X_=qF=class extends uO{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.styleOrigin=null,this.symbolLayers=new $xe,this.type="label-3d"}supportsCallout(){return!0}hasVisibleCallout(){return Rxe(this)}hasVisibleVerticalOffset(){return xK(this)}clone(){return new qF({styleOrigin:re(this.styleOrigin),symbolLayers:re(this.symbolLayers),thumbnail:re(this.thumbnail),callout:re(this.callout),verticalOffset:re(this.verticalOffset)})}static fromTextSymbol(t){return new qF({symbolLayers:[uS.fromTextSymbol(t)]})}};u([d({type:Pxe,json:{write:!0}})],X_.prototype,"verticalOffset",void 0),u([d(Ixe)],X_.prototype,"callout",void 0),u([d({json:{read:!1,write:!1}})],X_.prototype,"styleOrigin",void 0),u([d({type:$xe})],X_.prototype,"symbolLayers",void 0),u([nt({LabelSymbol3D:"label-3d"},{readOnly:!0})],X_.prototype,"type",void 0),X_=qF=u([R("esri.symbols.LabelSymbol3D")],X_);const rV=X_;var WF;const Lxe=Ke.ofType({base:null,key:"type",typeMap:{line:n$,path:wK}}),q7e=Ke.ofType({base:null,key:"type",typeMap:{line:n$,path:wK}});let g3=WF=class extends uO{constructor(t){super(t),this.symbolLayers=new Lxe,this.type="line-3d"}clone(){return new WF({styleOrigin:re(this.styleOrigin),symbolLayers:re(this.symbolLayers),thumbnail:re(this.thumbnail)})}static fromSimpleLineSymbol(t){return new WF({symbolLayers:[n$.fromSimpleLineSymbol(t)]})}};u([d({type:Lxe,json:{type:q7e}})],g3.prototype,"symbolLayers",void 0),u([nt({LineSymbol3D:"line-3d"},{readOnly:!0})],g3.prototype,"type",void 0),g3=WF=u([R("esri.symbols.LineSymbol3D")],g3);const iV=g3;let Y_=class extends Mu{constructor(e){super(e),this.angle=0,this.type=null,this.xoffset=0,this.yoffset=0,this.size=9}hash(){return`${this.type}.${this.angle}.${this.size}.${this.xoffset}.${this.yoffset}`}};u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],Y_.prototype,"angle",void 0),u([d({type:["simple-marker","picture-marker"],readOnly:!0})],Y_.prototype,"type",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Y_.prototype,"xoffset",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Y_.prototype,"yoffset",void 0),u([d({type:Number,cast:t=>t==="auto"?t:oi(t),json:{write:!0}})],Y_.prototype,"size",void 0),Y_=u([R("esri.symbols.MarkerSymbol")],Y_);const Dxe=Y_;var ZF;const Nxe=Ke.ofType({base:null,key:"type",typeMap:{fill:cO}});let y3=ZF=class extends uO{constructor(t){super(t),this.symbolLayers=new Nxe,this.type="mesh-3d"}clone(){return new ZF({styleOrigin:re(this.styleOrigin),symbolLayers:re(this.symbolLayers),thumbnail:re(this.thumbnail)})}static fromSimpleFillSymbol(t){return new ZF({symbolLayers:[cO.fromSimpleFillSymbol(t)]})}};u([d({type:Nxe})],y3.prototype,"symbolLayers",void 0),u([nt({MeshSymbol3D:"mesh-3d"},{readOnly:!0})],y3.prototype,"type",void 0),y3=ZF=u([R("esri.symbols.MeshSymbol3D")],y3);const o$=y3;function W7e(t,e,r){return e.imageData?fve({mediaType:e.contentType||"image/png",isBase64:!0,data:e.imageData}):Fxe(e.url,r)}function Fxe(t,e){return X7e(e)&&!wu(t)&&e?.layer?.parsedUrl?Cu(e.layer.parsedUrl.path,"images",t):A0(t,e)}function Z7e(t,e,r,i){if(Ig(t)){const s=_T(t);if(!s)return;e.contentType=s.mediaType,e.imageData=s.data,r&&r.imageData===e.imageData&&r.url&&U1(r.url,e,"url",i)}else U1(t,e,"url",i)}const kxe={json:{read:{source:["imageData","url"],reader:W7e},write:{writer(t,e,r,i){Z7e(t,e,this.source,i)}}}},Uxe={readOnly:!0,json:{read:{source:["imageData","url"],reader(t,e,r){const i={};return e.imageData&&(i.imageData=e.imageData),e.contentType&&(i.contentType=e.contentType),e.url&&(i.url=Fxe(e.url,r)),i}}}};function X7e(t){return!(t==null||t.origin!=="service"&&t.origin!=="portal-item"||t.layer?.type!=="feature"&&t.layer?.type!=="stream")}var $H;let Wh=$H=class extends ixe{constructor(...t){super(...t),this.type="picture-fill",this.url=null,this.xscale=1,this.yscale=1,this.width=12,this.height=12,this.xoffset=0,this.yoffset=0,this.source=null}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string"&&t.imageData==null)return t;const s={};return t&&(s.url=t),e&&(s.outline=e),r!=null&&(s.width=oi(r)),i!=null&&(s.height=oi(i)),s}clone(){const t=new $H({color:re(this.color),height:this.height,outline:this.outline&&this.outline.clone(),url:this.url,width:this.width,xoffset:this.xoffset,xscale:this.xscale,yoffset:this.yoffset,yscale:this.yscale});return t._set("source",re(this.source)),t}hash(){return`${super.hash()}.${this.color?.hash()}.${this.height}.${this.url}.${this.width}.${this.xoffset}.${this.xscale}.${this.yoffset}.${this.yscale}`}};u([nt({esriPFS:"picture-fill"},{readOnly:!0})],Wh.prototype,"type",void 0),u([d(kxe)],Wh.prototype,"url",void 0),u([d({type:Number,json:{write:!0}})],Wh.prototype,"xscale",void 0),u([d({type:Number,json:{write:!0}})],Wh.prototype,"yscale",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Wh.prototype,"width",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Wh.prototype,"height",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Wh.prototype,"xoffset",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Wh.prototype,"yoffset",void 0),u([d(Uxe)],Wh.prototype,"source",void 0),Wh=$H=u([R("esri.symbols.PictureFillSymbol")],Wh);const Vxe=Wh;var LH;let Ep=LH=class extends Dxe{constructor(...t){super(...t),this.color=null,this.type="picture-marker",this.url=null,this.source=null,this.height=12,this.width=12,this.size=null}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string"&&t.imageData==null)return t;const i={};return t&&(i.url=t),e!=null&&(i.width=oi(e)),r!=null&&(i.height=oi(r)),i}readHeight(t,e){return e.size||t}readWidth(t,e){return e.size||t}clone(){const t=new LH({angle:this.angle,height:this.height,url:this.url,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset});return t._set("source",re(this.source)),t}hash(){return`${super.hash()}.${this.height}.${this.url}.${this.width}`}};u([d({json:{write:!1}})],Ep.prototype,"color",void 0),u([nt({esriPMS:"picture-marker"},{readOnly:!0})],Ep.prototype,"type",void 0),u([d(kxe)],Ep.prototype,"url",void 0),u([d(Uxe)],Ep.prototype,"source",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],Ep.prototype,"height",void 0),u([Ae("height",["height","size"])],Ep.prototype,"readHeight",null),u([d({type:Number,cast:oi,json:{write:!0}})],Ep.prototype,"width",void 0),u([d({json:{write:!1}})],Ep.prototype,"size",void 0),Ep=LH=u([R("esri.symbols.PictureMarkerSymbol")],Ep);const sV=Ep;var xw;const zxe=Ke.ofType({base:null,key:"type",typeMap:{icon:l1,object:bK,text:uS}});let Tw=xw=class extends uO{constructor(t){super(t),this.verticalOffset=null,this.callout=null,this.symbolLayers=new zxe,this.type="point-3d"}supportsCallout(){if((this.symbolLayers?this.symbolLayers.length:0)<1)return!1;for(const t of this.symbolLayers.items)switch(t.type){case"icon":case"text":case"object":continue;default:return!1}return!0}hasVisibleCallout(){return Rxe(this)}hasVisibleVerticalOffset(){return xK(this)}clone(){return new xw({verticalOffset:re(this.verticalOffset),callout:re(this.callout),styleOrigin:re(this.styleOrigin),symbolLayers:re(this.symbolLayers),thumbnail:re(this.thumbnail)})}static fromSimpleMarkerSymbol(t){return new xw({symbolLayers:[l1.fromSimpleMarkerSymbol(t)]})}static fromPictureMarkerSymbol(t){return new xw({symbolLayers:[l1.fromPictureMarkerSymbol(t)]})}static fromCIMSymbol(t){if(t.data?.symbol?.type!=="CIMPointSymbol")return null;const r=t.data.symbol;return new xw(r?.callout?{symbolLayers:[l1.fromCIMSymbol(t)],callout:{type:"line",size:.5,color:[0,0,0]},verticalOffset:{screenLength:40}}:{symbolLayers:[l1.fromCIMSymbol(t)]})}static fromTextSymbol(t){return new xw({symbolLayers:[uS.fromTextSymbol(t)]})}};u([d({type:Pxe,json:{write:!0}})],Tw.prototype,"verticalOffset",void 0),u([d(Ixe)],Tw.prototype,"callout",void 0),u([d({type:zxe,json:{origins:{"web-scene":{write:!0}}}})],Tw.prototype,"symbolLayers",void 0),u([nt({PointSymbol3D:"point-3d"},{readOnly:!0})],Tw.prototype,"type",void 0),Tw=xw=u([R("esri.symbols.PointSymbol3D")],Tw);const c1=Tw;var _3;const Bxe=Ke.ofType({base:null,key:"type",typeMap:{extrude:txe,fill:cO,icon:l1,line:n$,object:bK,text:uS,water:Exe}});let v3=_3=class extends uO{constructor(t){super(t),this.symbolLayers=new Bxe,this.type="polygon-3d"}clone(){return new _3({styleOrigin:re(this.styleOrigin),symbolLayers:re(this.symbolLayers),thumbnail:re(this.thumbnail)})}static fromJSON(t){const e=new _3;if(e.read(t),e.symbolLayers.length===2&&e.symbolLayers.at(0).type==="fill"&&e.symbolLayers.at(1).type==="line"){const r=e.symbolLayers.at(0),i=e.symbolLayers.at(1);!i.enabled||t.symbolLayers&&t.symbolLayers[1]&&t.symbolLayers[1].enable===!1||(r.outline={size:i.size,color:i.material!=null?i.material.color:null}),e.symbolLayers.removeAt(1)}return e}static fromSimpleFillSymbol(t){return new _3({symbolLayers:[cO.fromSimpleFillSymbol(t)]})}};u([d({type:Bxe,json:{write:!0}})],v3.prototype,"symbolLayers",void 0),u([nt({PolygonSymbol3D:"polygon-3d"},{readOnly:!0})],v3.prototype,"type",void 0),v3=_3=u([R("esri.symbols.PolygonSymbol3D")],v3);const a$=v3;var DH;const D9=new kr({esriSFSSolid:"solid",esriSFSNull:"none",esriSFSHorizontal:"horizontal",esriSFSVertical:"vertical",esriSFSForwardDiagonal:"forward-diagonal",esriSFSBackwardDiagonal:"backward-diagonal",esriSFSCross:"cross",esriSFSDiagonalCross:"diagonal-cross"});let Sw=DH=class extends ixe{constructor(...t){super(...t),this.color=new Le([0,0,0,.25]),this.outline=new Iu,this.type="simple-fill",this.style="solid"}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.style=t),e&&(i.outline=e),r&&(i.color=r),i}clone(){return new DH({color:re(this.color),outline:this.outline&&this.outline.clone(),style:this.style})}hash(){return`${super.hash()}${this.style}.${this.color&&this.color.hash()}`}};u([d()],Sw.prototype,"color",void 0),u([d()],Sw.prototype,"outline",void 0),u([nt({esriSFS:"simple-fill"},{readOnly:!0})],Sw.prototype,"type",void 0),u([d({type:D9.apiValues,json:{read:D9.read,write:D9.write}})],Sw.prototype,"style",void 0),Sw=DH=u([R("esri.symbols.SimpleFillSymbol")],Sw);const U0=Sw,Y7e=Object.freeze(Object.defineProperty({__proto__:null,default:U0},Symbol.toStringTag,{value:"Module"}));var NH;const N9=new kr({esriSMSCircle:"circle",esriSMSSquare:"square",esriSMSCross:"cross",esriSMSX:"x",esriSMSDiamond:"diamond",esriSMSTriangle:"triangle",esriSMSPath:"path"});let Tm=NH=class extends Dxe{constructor(...t){super(...t),this.color=new Le([255,255,255,.25]),this.type="simple-marker",this.size=12,this.style="circle",this.outline=new Iu}normalizeCtorArgs(t,e,r,i){if(t&&typeof t!="string")return t;const s={};return t&&(s.style=t),e!=null&&(s.size=oi(e)),r&&(s.outline=r),i&&(s.color=i),s}writeColor(t,e){t&&this.style!=="x"&&this.style!=="cross"&&(e.color=t.toJSON()),t===null&&(e.color=null)}set path(t){this.style="path",this._set("path",t)}clone(){return new NH({angle:this.angle,color:re(this.color),outline:this.outline&&this.outline.clone(),path:this.path,size:this.size,style:this.style,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${super.hash()}.${this.color&&this.color.hash()}.${this.path}.${this.style}.${this.outline?.hash()}`}};u([d()],Tm.prototype,"color",void 0),u([Ve("color")],Tm.prototype,"writeColor",null),u([nt({esriSMS:"simple-marker"},{readOnly:!0})],Tm.prototype,"type",void 0),u([d()],Tm.prototype,"size",void 0),u([d({type:N9.apiValues,json:{read:N9.read,write:N9.write}})],Tm.prototype,"style",void 0),u([d({type:String,json:{write:!0}})],Tm.prototype,"path",null),u([d({types:{key:"type",base:null,defaultKeyValue:"simple-line",typeMap:{"simple-line":Iu}},json:{default:null,write:!0}})],Tm.prototype,"outline",void 0),Tm=NH=u([R("esri.symbols.SimpleMarkerSymbol")],Tm);const Pf=Tm,J7e=Object.freeze(Object.defineProperty({__proto__:null,default:Pf},Symbol.toStringTag,{value:"Module"}));var FH;let qs=FH=class extends Mu{constructor(...t){super(...t),this.backgroundColor=null,this.borderLineColor=null,this.borderLineSize=null,this.font=new eV,this.horizontalAlignment="center",this.kerning=!0,this.haloColor=null,this.haloSize=null,this.rightToLeft=null,this.rotated=!1,this.text="",this.type="text",this.verticalAlignment="baseline",this.xoffset=0,this.yoffset=0,this.angle=0,this.width=null,this.lineWidth=192,this.lineHeight=1}normalizeCtorArgs(t,e,r){if(t&&typeof t!="string")return t;const i={};return t&&(i.text=t),e&&(i.font=e),r&&(i.color=r),i}writeLineWidth(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}castLineWidth(t){return oi(t)}writeLineHeight(t,e,r,i){i&&typeof i!="string"?i.origin:e[r]=t}clone(){return new FH({angle:this.angle,backgroundColor:re(this.backgroundColor),borderLineColor:re(this.borderLineColor),borderLineSize:this.borderLineSize,color:re(this.color),font:this.font&&this.font.clone(),haloColor:re(this.haloColor),haloSize:this.haloSize,horizontalAlignment:this.horizontalAlignment,kerning:this.kerning,lineHeight:this.lineHeight,lineWidth:this.lineWidth,rightToLeft:this.rightToLeft,rotated:this.rotated,text:this.text,verticalAlignment:this.verticalAlignment,width:this.width,xoffset:this.xoffset,yoffset:this.yoffset})}hash(){return`${this.backgroundColor&&this.backgroundColor.hash()}.${this.borderLineColor}.${this.borderLineSize}.${this.color?.hash()}.${this.font&&this.font.hash()}.${this.haloColor&&this.haloColor.hash()}.${this.haloSize}.${this.horizontalAlignment}.${this.kerning}.${this.rightToLeft}.${this.rotated}.${this.text}.${this.verticalAlignment}.${this.width}.${this.xoffset}.${this.yoffset}.${this.lineHeight}.${this.lineWidth}.${this.angle}`}};u([d({type:Le,json:{write:!0}})],qs.prototype,"backgroundColor",void 0),u([d({type:Le,json:{write:!0}})],qs.prototype,"borderLineColor",void 0),u([d({type:Number,json:{write:!0},cast:oi})],qs.prototype,"borderLineSize",void 0),u([d({type:eV,json:{write:!0}})],qs.prototype,"font",void 0),u([d({...mxe,json:{write:!0}})],qs.prototype,"horizontalAlignment",void 0),u([d({type:Boolean,json:{write:!0}})],qs.prototype,"kerning",void 0),u([d({type:Le,json:{write:!0}})],qs.prototype,"haloColor",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],qs.prototype,"haloSize",void 0),u([d({type:Boolean,json:{write:!0}})],qs.prototype,"rightToLeft",void 0),u([d({type:Boolean,json:{write:!0}})],qs.prototype,"rotated",void 0),u([d({type:String,json:{write:!0}})],qs.prototype,"text",void 0),u([nt({esriTS:"text"},{readOnly:!0})],qs.prototype,"type",void 0),u([d({...gxe,json:{write:!0}})],qs.prototype,"verticalAlignment",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],qs.prototype,"xoffset",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],qs.prototype,"yoffset",void 0),u([d({type:Number,json:{read:t=>t&&-1*t,write:(t,e)=>e.angle=t&&-1*t}})],qs.prototype,"angle",void 0),u([d({type:Number,json:{write:!0}})],qs.prototype,"width",void 0),u([d({type:Number})],qs.prototype,"lineWidth",void 0),u([Ve("lineWidth")],qs.prototype,"writeLineWidth",null),u([or("lineWidth")],qs.prototype,"castLineWidth",null),u([d(fxe)],qs.prototype,"lineHeight",void 0),u([Ve("lineHeight")],qs.prototype,"writeLineHeight",null),qs=FH=u([R("esri.symbols.TextSymbol")],qs);const hO=qs;var kH;let Cp=kH=class extends Mu{constructor(t){super(t),this.styleName=null,this.portal=null,this.styleUrl=null,this.thumbnail=null,this.name=null,this.type="web-style"}get _fetchCacheKey(){const t=this.portal!=null?this.portal:ao.getDefault(),e=t.user?t.user.username:null;return`${this.styleName}:${this.styleUrl}:${this.name}:${e}:${t.url}`}read(t,e){this.portal=e?.portal,super.read(t,e)}clone(){return new kH({name:this.name,styleUrl:this.styleUrl,styleName:this.styleName,portal:this.portal})}fetchSymbol(t){return this._fetchSymbol("webRef",t)}fetchCIMSymbol(t){return this._fetchSymbol("cimRef",t)}async _fetchSymbol(t,e){const r=e!=null?e.cache:null,i=r?this._fetchCacheKey:null;if(r!=null){const a=i&&r.get(i);if(a)return a.clone()}const{resolveWebStyleSymbol:s}=await J(()=>Promise.resolve().then(()=>Xet),void 0,import.meta.url);Dt(e);const n=s(this,{portal:this.portal},t,e);n.catch(a=>{K.getLogger(this).error("#fetchSymbol()","Failed to create symbol from style",a)});const o=await n;return t==="webRef"&&o.type==="point-3d"||t==="cimRef"&&o.type==="cim"?(r?.set(i,o.clone()),o):null}};u([d({json:{write:!1}})],Cp.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Cp.prototype,"styleName",void 0),u([d({type:ao,json:{write:!1}})],Cp.prototype,"portal",void 0),u([d({type:String,json:{read:tV,write:U1}})],Cp.prototype,"styleUrl",void 0),u([d({type:tT,json:{read:!1}})],Cp.prototype,"thumbnail",void 0),u([d({type:String,json:{write:!0}})],Cp.prototype,"name",void 0),u([nt({styleSymbolReference:"web-style"},{readOnly:!0})],Cp.prototype,"type",void 0),u([d()],Cp.prototype,"_fetchCacheKey",null),Cp=kH=u([R("esri.symbols.WebStyleSymbol")],Cp);const hS=Cp;function nV(t){if(!t)return!1;switch(t.type){case"picture-fill":case"picture-marker":case"simple-fill":case"simple-line":case"simple-marker":case"text":case"cim":return!0;default:return!1}}function V1(t){if(!t)return!1;switch(t.type){case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":return!0;default:return!1}}const uf={base:Mu,key:"type",typeMap:{"simple-fill":U0,"picture-fill":Vxe,"picture-marker":sV,"simple-line":Iu,"simple-marker":Pf,text:hO,"label-3d":rV,"line-3d":iV,"mesh-3d":o$,"point-3d":c1,"polygon-3d":a$,"web-style":hS,cim:lO},errorContext:"symbol"},Q7e={base:Mu,key:"type",typeMap:{"picture-marker":sV,"simple-marker":Pf,text:hO,"web-style":hS,cim:lO},errorContext:"symbol"},K7e=sO({types:uf}),Gxe={base:Mu,key:"type",typeMap:{"simple-fill":U0,"picture-fill":Vxe,"picture-marker":sV,"simple-line":Iu,"simple-marker":Pf,text:hO,"line-3d":iV,"mesh-3d":o$,"point-3d":c1,"polygon-3d":a$,"web-style":hS,cim:lO},errorContext:"symbol"},eHe={base:Mu,key:"type",typeMap:{text:hO,"label-3d":rV},errorContext:"symbol"},moe={base:Mu,key:"type",typeMap:{"line-3d":iV,"mesh-3d":o$,"point-3d":c1,"polygon-3d":a$,"web-style":hS,cim:lO},errorContext:"symbol"},tHe={base:Mu,key:"type",typeMap:{"label-3d":rV},errorContext:"symbol"},jxe=Rf(uf);var UH;function rHe(t){if(!t)return null;const e={};for(const r in t){const i=N1(t[r]);i&&(e[r]=i)}return Object.keys(e).length!==0?e:null}function iHe(t){if(t==null)return null;const e={};for(const r in t){const i=t[r];i&&(e[r]=i.toJSON())}return Object.keys(e).length!==0?e:null}let Gc=UH=class extends rs(he){constructor(...t){super(...t),this.isAggregate=!1,this.layer=null,this.popupTemplate=null,this.sourceLayer=null,Object.defineProperty(this,"uid",{value:vc(),configurable:!0})}normalizeCtorArgs(t,e,r,i){return t&&!t.declaredClass?t:{geometry:t,symbol:e,attributes:r,popupTemplate:i}}set aggregateGeometries(t){const e=this._get("aggregateGeometries");JSON.stringify(e)!==JSON.stringify(t)&&this._set("aggregateGeometries",t)}set attributes(t){const e=this._get("attributes");e!==t&&(this._set("attributes",t),this._notifyLayer("attributes",e,t))}set geometry(t){const e=this._get("geometry");e!==t&&(this._set("geometry",t),this._notifyLayer("geometry",e,t))}set symbol(t){const e=this._get("symbol");e!==t&&(this._set("symbol",t),this._notifyLayer("symbol",e,t))}set visible(t){const e=this._get("visible");e!==t&&(this._set("visible",t),this._notifyLayer("visible",e,t))}cloneShallow(){return new UH({aggregateGeometries:this.aggregateGeometries,attributes:this.attributes,geometry:this.geometry,isAggregate:this.isAggregate,layer:this.layer,popupTemplate:this.popupTemplate,sourceLayer:this.sourceLayer,symbol:this.symbol,visible:this.visible})}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;for(const e of[this.sourceLayer,this.layer])if(e){if("popupTemplate"in e&&e.popupTemplate)return e.popupTemplate;if(t&&"defaultPopupTemplate"in e&&e.defaultPopupTemplate!=null)return e.defaultPopupTemplate}return null}getAttribute(t){return this.attributes?.[t]}setAttribute(t,e){if(this.attributes){const r=this.getAttribute(t);this.attributes[t]=e,this._notifyLayer("attributes",r,e,t)}else this.attributes={[t]:e},this._notifyLayer("attributes",void 0,e,t)}getObjectId(){return this.sourceLayer&&"objectIdField"in this.sourceLayer&&this.sourceLayer.objectIdField?this.getAttribute(this.sourceLayer.objectIdField):null}toJSON(){return{aggregateGeometries:iHe(this.aggregateGeometries),geometry:this.geometry!=null?this.geometry.toJSON():null,symbol:this.symbol!=null?this.symbol.toJSON():null,attributes:{...this.attributes},popupTemplate:this.popupTemplate&&this.popupTemplate.toJSON()}}notifyGeometryChanged(){this._notifyLayer("geometry",this.geometry,this.geometry)}notifyMeshTransformChanged(t={}){const{geometry:e}=this;if(e?.type==="mesh"){const r={origin:e.origin,transform:e.transform};this._notifyLayer("origin-transform",r,r,t.action)}}_notifyLayer(t,e,r,i){if(!this.layer||!("graphicChanged"in this.layer))return;const s={graphic:this,property:t,oldValue:e,newValue:r};t==="origin-transform"&&(s.action=i),t==="attributes"&&(s.attributeName=i),this.layer.graphicChanged(s)}};u([d({value:null,json:{read:rHe}})],Gc.prototype,"aggregateGeometries",null),u([d({value:null})],Gc.prototype,"attributes",null),u([d({value:null,types:nS,json:{read:N1}})],Gc.prototype,"geometry",null),u([d({type:Boolean})],Gc.prototype,"isAggregate",void 0),u([d({clonable:"reference"})],Gc.prototype,"layer",void 0),u([d({type:aO})],Gc.prototype,"popupTemplate",void 0),u([d({clonable:"reference"})],Gc.prototype,"sourceLayer",void 0),u([d({value:null,types:uf})],Gc.prototype,"symbol",null),u([d({type:Boolean,value:!0})],Gc.prototype,"visible",null),Gc=UH=u([R("esri.Graphic")],Gc),function(t){t.generateUID=vc}(Gc||(Gc={}));const oa=Gc;function sHe(t){const{exifInfo:e,exifName:r,tagName:i}=t;if(!e||!r||!i)return null;const s=e.find(n=>n.name===r);return s?nHe({tagName:i,tags:s.tags}):null}function nHe(t){const{tagName:e,tags:r}=t;if(!r||!e)return null;const i=r.find(s=>s.name===e);return i&&i.value||null}var VH;const oHe={1:{id:1,rotation:0,mirrored:!1},2:{id:2,rotation:0,mirrored:!0},3:{id:3,rotation:180,mirrored:!1},4:{id:4,rotation:180,mirrored:!0},5:{id:5,rotation:-90,mirrored:!0},6:{id:6,rotation:90,mirrored:!1},7:{id:7,rotation:90,mirrored:!0},8:{id:8,rotation:-90,mirrored:!1}};let jc=VH=class extends he{constructor(t){super(t),this.contentType=null,this.exifInfo=null,this.id=null,this.globalId=null,this.keywords=null,this.name=null,this.parentGlobalId=null,this.parentObjectId=null,this.size=null,this.url=null}get orientationInfo(){const{exifInfo:t}=this,e=sHe({exifName:"Exif IFD0",tagName:"Orientation",exifInfo:t});return oHe[e]||null}clone(){return new VH({contentType:this.contentType,exifInfo:this.exifInfo,id:this.id,globalId:this.globalId,keywords:this.keywords,name:this.name,parentGlobalId:this.parentGlobalId,parentObjectId:this.parentObjectId,size:this.size,url:this.url})}};u([d({type:String})],jc.prototype,"contentType",void 0),u([d()],jc.prototype,"exifInfo",void 0),u([d({readOnly:!0})],jc.prototype,"orientationInfo",null),u([d({type:Ki})],jc.prototype,"id",void 0),u([d({type:String})],jc.prototype,"globalId",void 0),u([d({type:String})],jc.prototype,"keywords",void 0),u([d({type:String})],jc.prototype,"name",void 0),u([d({json:{read:!1}})],jc.prototype,"parentGlobalId",void 0),u([d({json:{read:!1}})],jc.prototype,"parentObjectId",void 0),u([d({type:Ki})],jc.prototype,"size",void 0),u([d({json:{read:!1}})],jc.prototype,"url",void 0),jc=VH=u([R("esri.layers.support.AttachmentInfo")],jc);const aHe=jc;var zH;let fa=zH=class extends he{constructor(t){super(t),this.attachmentTypes=null,this.attachmentsWhere=null,this.cacheHint=void 0,this.keywords=null,this.globalIds=null,this.name=null,this.num=null,this.objectIds=null,this.returnMetadata=!1,this.size=null,this.start=null,this.where=null}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new zH(re({attachmentTypes:this.attachmentTypes,attachmentsWhere:this.attachmentsWhere,cacheHint:this.cacheHint,keywords:this.keywords,where:this.where,globalIds:this.globalIds,name:this.name,num:this.num,objectIds:this.objectIds,returnMetadata:this.returnMetadata,size:this.size,start:this.start}))}};u([d({type:[String],json:{write:!0}})],fa.prototype,"attachmentTypes",void 0),u([d({type:String,json:{read:{source:"attachmentsDefinitionExpression"},write:{target:"attachmentsDefinitionExpression"}}})],fa.prototype,"attachmentsWhere",void 0),u([d({type:Boolean,json:{write:!0}})],fa.prototype,"cacheHint",void 0),u([d({type:[String],json:{write:!0}})],fa.prototype,"keywords",void 0),u([d({type:[Number],json:{write:!0}})],fa.prototype,"globalIds",void 0),u([d({json:{write:!0}})],fa.prototype,"name",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],fa.prototype,"num",void 0),u([d({type:[Number],json:{write:!0}})],fa.prototype,"objectIds",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],fa.prototype,"returnMetadata",void 0),u([d({type:[Number],json:{write:!0}})],fa.prototype,"size",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],fa.prototype,"start",void 0),u([Ve("start"),Ve("num")],fa.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],fa.prototype,"where",void 0),fa=zH=u([R("esri.rest.support.AttachmentQuery")],fa),fa.from=Sn(fa);const BH=fa;function Hxe(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type==="feature"}function GM(t){const e=t?.type;return e==="base-tile"||e==="tile"||e==="elevation"||e==="imagery-tile"||e==="base-elevation"||e==="open-street-map"||e==="wcs"||e==="web-tile"||e==="wmts"||e==="vector-tile"}function cA(t){return t!=null&&"type"in t&&t.type==="group"}const M4t={Point:"SceneLayer","3DObject":"SceneLayer",IntegratedMesh:"IntegratedMeshLayer",PointCloud:"PointCloudLayer",Building:"BuildingSceneLayer"};function qxe(t){const e=t?.type;return e==="building-scene"||e==="integrated-mesh"||e==="point-cloud"||e==="scene"}function goe(t){return t?.type==="voxel"}function yoe(t){return t?.type==="imagery-tile"}function Wxe(t){return t!=null&&t.parent!=null&&"declaredClass"in t.parent&&t.parent.declaredClass==="esri.Basemap"&&t.parent.baseLayers.includes(t)}function SK(t){return t?.type==="feature"&&!t.url&&t.source?.type==="memory"}function I4t(t){return t?.type==="feature"&&t.source?.type==="feature-layer"}function lHe(t){if(t.activeLayer){const e=t.activeLayer.tileMatrixSet;if(e)return e;const r=t.activeLayer.tileMatrixSets;if(r)return r}return null}async function EK(t,e){const r=Gt?.findServerInfo(t);if(r?.currentVersion!=null)return r.owningSystemUrl||null;const i=t.toLowerCase().indexOf("/rest/services");if(i===-1)return null;const s=`${t.substring(0,i)}/rest/info`,n=e!=null?e.signal:null,{data:o}=await Lt(s,{query:{f:"json"},responseType:"json",signal:n});return o?.owningSystemUrl||null}function cHe(t){if(!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"imagery":case"knowledge-graph-sublayer":case"ogc-feature":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":case"wfs":return!0;default:return!1}}function uA(t){return t!=null&&typeof t=="object"&&"isTable"in t&&!!t.isTable}function vg(t){return cHe(t)?"effectiveCapabilities"in t?t.effectiveCapabilities:t.capabilities:null}function uHe(t){if(!("editingEnabled"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"oriented-imagery":case"scene":case"subtype-group":case"subtype-sublayer":return!0;default:return!1}}function oV(t){return!!uHe(t)&&("effectiveEditingEnabled"in t?t.effectiveEditingEnabled:t.editingEnabled)}const hHe="esri.widgets.Feature.support.featureUtils",_oe=K.getLogger(hHe),dHe=/href=(""|'')/gi,pHe=/(\{([^\{\r\n]+)\})/g,fHe=/\'/g,Zxe=/^\s*expression\//i,mHe=/(\n)/gi,gHe=/[\u00A0-\u9999<>\&]/gim,yHe=/href\s*=\s*(?:\"([^\"]+)\"|\'([^\']+)\')/gi,_He=/^(?:mailto:|tel:)/,Xxe="relationships/",voe=zE("short-date-short-time");function vHe(t){if(t!=null)return t.get("sourceLayer")||t.get("layer")}async function P4t(t,e){return typeof t=="function"?t(e):t}function $4t(t=""){if(t)return!_He.test(t.trim().toLowerCase())}function bHe(t){return!!t&&Zxe.test(t)}function wHe(t,e){if(!bHe(e)||!t)return null;const r=e.replace(Zxe,"").toLowerCase();let i=null;return t.some(s=>s.name.toLowerCase()===r&&(i=s,!0)),i}function L4t(t,e){const r=wHe(e,t?.fieldName);return r?r.title||null:t?t.label||t.fieldName:null}function xHe(t,e){const r=e.get(t.toLowerCase());return`{${r&&r.fieldName||t}}`}function THe(t){return t.replaceAll(dHe,"")}function CK(t,e){const r=AK(e,t);return r?r.name:t}function D4t(t,e){return t&&t.map(r=>CK(r,e))}function AK(t,e){return t&&typeof t.getField=="function"&&e?t.getField(e)??null:null}function Yxe(t){return`${t}`.trim()}function N4t({attributes:t,globalAttributes:e,layer:r,text:i,expressionAttributes:s,fieldInfoMap:n}){return i?SHe({formattedAttributes:e,template:RHe(i,{...e,...s,...t},r),fieldInfoMap:n}):""}function SHe({formattedAttributes:t,template:e,fieldInfoMap:r}){return Yxe(THe(fg(fg(e,i=>xHe(i,r)),t)))}function EHe(t,e,r=!1){const i=e[t];if(typeof i=="string"){const s="%27",n=(r?encodeURIComponent(i):i).replaceAll(fHe,s);e[t]=n}}function CHe(t,e=!1){const r={...t};return Object.keys(r).forEach(i=>EHe(i,r,e)),r}function AHe(t,e,r){const i=(e=Yxe(e))&&e[0]!=="{";return fg(t,CHe(r,i||!1))}function OHe(t,e){return t.replaceAll(pHe,(r,i,s)=>{const n=AK(e,s);return n?`{${n.name}}`:i})}function RHe(t,e,r){const i=OHe(t,r);return i&&i.replaceAll(yHe,(s,n,o)=>AHe(s,n||o,e))}function MHe(t,e){if(typeof t=="string"&&e&&e.dateFormat==null&&(e.places!=null||e.digitSeparator!=null)){const r=Number(t);if(!isNaN(r))return r}return t}function boe(t){return t!=null&&typeof t=="object"&&"layer"in t&&!!t.layer}function IHe(t){return t!=null&&typeof t=="object"&&"type"in t&&t.type==="map-image"}function PHe(t){return t!=null&&typeof t=="object"&&"fieldsIndex"in t&&"geometryType"in t&&"getField"in t&&"load"in t&&"loaded"in t&&"objectIdField"in t&&"spatialReference"in t&&"type"in t&&t.type==="feature"&&"when"in t}function $He(t){return t!=null&&typeof t=="object"&&"createQuery"in t&&"queryFeatureCount"in t&&"queryObjectIds"in t&&"queryRelatedFeatures"in t&&"queryRelatedFeaturesCount"in t&&"relationships"in t}function aV(t){return PHe(t)&&$He(t)}function LHe(t){return!!t&&typeof t=="object"&&"sourceLayer"in t&&aV(t.sourceLayer)}function DHe(t,e){const{fieldInfos:r,fieldName:i,preventPlacesFormatting:s,layer:n}=e,o=NHe(r,i),a=o?.clone(),l=AK(n,i);if(a&&!x7(i)){const h=l?.type;if(h==="date"||h==="date-only"||h==="time-only"||h==="timestamp-offset"||a.format?.dateFormat){const p=a.format??new qE;if(p.dateFormat??(p.dateFormat=h==="date-only"?"short-date":"short-date-short-time"),typeof t=="number"){const f=!boe(n)&&Hxe(n)&&n.datesInUnknownTimezone||boe(n)&&IHe(n.layer)&&n.layer.datesInUnknownTimezone;return p.formatDate(t,f)}switch(h){case"date-only":return p.formatDateOnly(t);case"time-only":return p.formatTimeOnly(t);case"timestamp-offset":return p.formatTimestamp(t)}}}const c=a?.format;return typeof t=="string"&&x7(i)&&c?c.formatRasterPixelValue(t):typeof(t=MHe(t,c))=="string"||t==null||c==null?Jxe(t):s?zd(t,{...tve(c),minimumFractionDigits:0,maximumFractionDigits:20}):c.formatNumber(t)}function NHe(t,e){if(t&&t.length&&e)return t.find(r=>r.fieldName?.toLowerCase()===e.toLowerCase())}function FHe({fieldName:t,graphic:e,layer:r}){if(Kxe(t)||!r||typeof r.getFeatureType!="function")return null;const{typeIdField:i}=r;if(!i||t!==i)return null;const s=r.getFeatureType(e);return s?s.name:null}function kHe({fieldName:t,value:e,graphic:r,layer:i}){if(Kxe(t)||!i||typeof i.getFieldDomain!="function")return null;const s=r&&i.getFieldDomain(t,{feature:r});return s&&s.type==="coded-value"?s.getName(e):null}function F4t(t,e){const{creatorField:r,creationDateField:i,editorField:s,editDateField:n}=t;if(!e)return;const o=e[n];if(typeof o=="number"){const l=e[s];return{type:"edit",date:Vd(o,voe),user:l}}const a=e[i];if(typeof a=="number"){const l=e[r];return{type:"create",date:Vd(a,voe),user:l}}return null}function k4t(t,e){const r=new Map;return t&&t.forEach(i=>{const s=CK(i.fieldName,e);i.fieldName=s,r.set(s.toLowerCase(),i)}),r}function U4t(t){const e=[];if(!t)return e;const{fieldInfos:r,content:i}=t;return r&&e.push(...r),i&&Array.isArray(i)&&i.forEach(s=>{if(s.type==="fields"){const n=s&&s.fieldInfos;n&&e.push(...n)}}),e}function V4t(t){return t.replaceAll(gHe,e=>`&#${e.charCodeAt(0)};`)}function Jxe(t){return typeof t=="string"?t.replaceAll(mHe,'<br class="esri-text-new-line" />'):t}function Qxe(t){const{value:e,fieldName:r,fieldInfos:i,fieldInfoMap:s,layer:n,graphic:o}=t;if(e==null)return"";const a=kHe({fieldName:r,value:e,graphic:o,layer:n});if(a)return a;const l=FHe({fieldName:r,graphic:o,layer:n});if(l)return l;if(s.get(r.toLowerCase()))return DHe(e,{fieldInfos:i||Array.from(s.values()),fieldName:r,layer:n});switch(n?.fieldsIndex?.get(r)?.type){case"date":return Vd(e);case"date-only":return UJ(e);case"time-only":return VJ(e);case"timestamp-offset":return zJ(e)}return Jxe(e)}function z4t({fieldInfos:t,attributes:e,layer:r,graphic:i,fieldInfoMap:s,relatedInfos:n}){const o={};return n?.forEach(a=>BHe({attributes:o,relatedInfo:a,fieldInfoMap:s,fieldInfos:t,layer:r})),e&&Object.keys(e).forEach(a=>{const l=e[a];o[a]=Qxe({fieldName:a,fieldInfos:t,fieldInfoMap:s,layer:r,value:l,graphic:i})}),o}async function UHe(t,e){const{layer:r,graphic:i,outFields:s,objectIds:n,returnGeometry:o,spatialReference:a}=t,l=n[0];if(typeof l!="number"&&typeof l!="string"){const h="Could not query required fields for the specified feature. The feature's ID is invalid.",p={layer:r,graphic:i,objectId:l,requiredFields:s};return _oe.warn(h,p),null}if(!vg(r)?.operations?.supportsQuery){const h="The specified layer cannot be queried. The following fields will not be available.",p={layer:r,graphic:i,requiredFields:s,returnGeometry:o};return _oe.warn(h,p),null}const c=r.createQuery();return c.objectIds=n,c.outFields=s?.length?s:[r.objectIdField],c.returnGeometry=!!o,c.returnZ=!!o,c.returnM=!!o,c.outSpatialReference=a,(await r.queryFeatures(c,e)).features[0]}async function VHe(t){if(!t.expressionInfos?.length)return!1;const e=await If(),{arcadeUtils:{hasGeometryFunctions:r}}=e;return r(t)}async function B4t({graphic:t,popupTemplate:e,layer:r,spatialReference:i},s){if(!r||!e||(typeof r.load=="function"&&await r.load(s),!t.attributes))return;const n=t.attributes[r.objectIdField];if(n==null)return;const o=[n],a=await e.getRequiredFields(r.fieldsIndex),l=Oze(a,t),c=l?[]:a,h=e.returnGeometry||await VHe(e);if(l&&!h)return;const p=await UHe({layer:r,graphic:t,outFields:c,objectIds:o,returnGeometry:h,spatialReference:i},s);p&&(p.geometry&&(t.geometry=p.geometry),p.attributes&&(t.attributes={...t.attributes,...p.attributes}))}function Kxe(t=""){return!!t&&t.includes(Xxe)}function zHe(t){return t?`${Xxe}${t.layerId}/${t.fieldName}`:""}function woe({attributes:t,graphic:e,relatedInfo:r,fieldInfos:i,fieldInfoMap:s,layer:n}){t&&e&&r&&Object.keys(e.attributes).forEach(o=>{const a=zHe({layerId:r.relation.id.toString(),fieldName:o}),l=e.attributes[o];t[a]=Qxe({fieldName:a,fieldInfos:i,fieldInfoMap:s,layer:n,value:l,graphic:e})})}function BHe({attributes:t,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s}){t&&e&&(e.relatedFeatures&&e.relatedFeatures&&e.relatedFeatures.forEach(n=>woe({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})),e.relatedStatsFeatures&&e.relatedStatsFeatures&&e.relatedStatsFeatures.forEach(n=>woe({attributes:t,graphic:n,relatedInfo:e,fieldInfoMap:r,fieldInfos:i,layer:s})))}const xoe=t=>{if(!t)return!1;const e=t.toUpperCase();return e.includes("CURRENT_TIMESTAMP")||e.includes("CURRENT_DATE")||e.includes("CURRENT_TIME")},eTe=({layer:t,method:e,query:r,definitionExpression:i})=>{if(!t.capabilities?.query?.supportsCacheHint||e==="attachments")return;const s=r.where!=null?r.where:null,n=r.geometry!=null?r.geometry:null;xoe(i)||xoe(s)||n?.type==="extent"||r.resultType==="tile"||(r.cacheHint=!0)},G4t=({query:t,layer:e,method:r})=>{eTe({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})},j4t=({queryPayload:t,layer:e,method:r})=>{eTe({layer:e,method:r,query:t,definitionExpression:`${e.definitionExpression} ${e.serviceDefinitionExpression}`})};function GHe(t,e,r){return t&&e&&r?Toe(t.allLayers,e,r)||Toe(t.allTables,e,r):null}function Toe(t,e,r){return t.filter(aV).find(i=>i!==e&&i.url===e.url&&i.layerId===r.relatedTableId)}const Soe={editing:!1,operations:{add:!0,update:!0,delete:!0}},tTe=Ke.ofType(aHe);let Hc=class extends me{constructor(e){super(e),this._getAttachmentsPromise=null,this._attachmentLayer=null,this.capabilities={...Soe},this.activeAttachmentInfo=null,this.activeFileInfo=null,this.attachmentInfos=new tTe,this.fileInfos=new Ke,this.graphic=null,this.mode="view",this.filesEnabled=!1,this.addHandles(Q(()=>this.graphic,()=>this._graphicChanged(),xt))}destroy(){this._attachmentLayer=null,this.graphic=null}castCapabilities(e){return{...Soe,...e}}get state(){return this._getAttachmentsPromise?"loading":this.graphic?"ready":"disabled"}get supportsResizeAttachments(){const{graphic:e}=this;if(!e)return!1;const r=e.layer||e.sourceLayer;return r?.loaded&&"capabilities"in r&&r.capabilities&&"operations"in r.capabilities&&"supportsResizeAttachments"in r.capabilities.operations&&r.capabilities.operations.supportsResizeAttachments||!1}async getAttachments(){const{_attachmentLayer:e,attachmentInfos:r}=this;if(!e||typeof e.queryAttachments!="function")throw new D("invalid-layer","getAttachments(): A valid layer is required.");const i=this._getObjectId(),s=new BH({objectIds:[i],returnMetadata:!0}),n=[],o=e.queryAttachments(s).then(l=>l[i]||n).catch(()=>n);this._getAttachmentsPromise=o,this.notifyChange("state");const a=await o;return r.removeAll(),a.length&&r.addMany(a),this._getAttachmentsPromise=null,this.notifyChange("state"),a}async addAttachment(e,r=this.graphic){const{_attachmentLayer:i,attachmentInfos:s,capabilities:n}=this;if(!r)throw new D("invalid-graphic","addAttachment(): A valid graphic is required.",{graphic:r});if(!e)throw new D("invalid-attachment","addAttachment(): An attachment is required.",{attachment:e});if(!n.operations?.add)throw new D("invalid-capabilities","addAttachment(): add capabilities are required.");if(!i||typeof i.addAttachment!="function")throw new D("invalid-layer","addAttachment(): A valid layer is required.");const o=i.addAttachment(r,e).then(l=>this._queryAttachment(l.objectId,r)),a=await o;return s.add(a),a}async deleteAttachment(e){const{_attachmentLayer:r,attachmentInfos:i,graphic:s,capabilities:n}=this;if(!e)throw new D("invalid-attachment-info","deleteAttachment(): An attachmentInfo is required.",{attachmentInfo:e});if(!n.operations?.delete)throw new D("invalid-capabilities","deleteAttachment(): delete capabilities are required.");if(!r||typeof r.deleteAttachments!="function")throw new D("invalid-layer","deleteAttachment(): A valid layer is required.");if(!s)throw new D("invalid-graphic","deleteAttachment(): A graphic is required.");const o=r.deleteAttachments(s,[e.id]).then(()=>e),a=await o;return i.remove(a),a}async updateAttachment(e,r=this.activeAttachmentInfo){const{_attachmentLayer:i,attachmentInfos:s,graphic:n,capabilities:o}=this;if(!e)throw new D("invalid-attachment","updateAttachment(): An attachment is required.",{attachment:e});if(!r)throw new D("invalid-attachment-info","updateAttachment(): An attachmentInfo is required.",{attachmentInfo:r});if(!o.operations?.update)throw new D("invalid-capabilities","updateAttachment(): Update capabilities are required.");const a=s.findIndex(h=>h===r);if(!i||typeof i.updateAttachment!="function")throw new D("invalid-layer","updateAttachment(): A valid layer is required.");if(!n)throw new D("invalid-graphic","updateAttachment(): A graphic is required.");const l=i.updateAttachment(n,r.id,e).then(h=>this._queryAttachment(h.objectId)),c=await l;return s.splice(a,1,c),c}async commitFiles(){return await Promise.all(this.fileInfos.items.map(e=>this.addAttachment(e.form))),this.fileInfos.removeAll(),this.getAttachments()}addFile(e,r){if(!e||!r)return null;const i={file:e,form:r};return this.fileInfos.add(i),i}updateFile(e,r,i=this.activeFileInfo){if(!e||!r||!i)return null;const s=this.fileInfos.findIndex(n=>i===n);return s>-1&&this.fileInfos.splice(s,1,{file:e,form:r}),this.fileInfos.items[s]}deleteFile(e){const r=this.fileInfos.find(i=>i.file===e);return r?(this.fileInfos.remove(r),r):null}async _queryAttachment(e,r){const{_attachmentLayer:i}=this;if(!e||!i?.queryAttachments)throw new D("invalid-attachment-id","Could not query attachment.");const s=this._getObjectId(r),n=new BH({objectIds:[s],attachmentsWhere:`AttachmentId=${e}`,returnMetadata:!0});return i.queryAttachments(n).then(o=>o[s][0])}_getObjectId(e=this.graphic){return e?.getObjectId()??null}_graphicChanged(){this.graphic&&(this._setAttachmentLayer(),this.getAttachments().catch(()=>{}))}_setAttachmentLayer(){const{graphic:e}=this,r=vHe(e);this._attachmentLayer=r?r.type==="scene"&&r.associatedLayer!=null?r.associatedLayer:r:null}};u([d()],Hc.prototype,"capabilities",void 0),u([or("capabilities")],Hc.prototype,"castCapabilities",null),u([d()],Hc.prototype,"activeAttachmentInfo",void 0),u([d()],Hc.prototype,"activeFileInfo",void 0),u([d({readOnly:!0,type:tTe})],Hc.prototype,"attachmentInfos",void 0),u([d()],Hc.prototype,"fileInfos",void 0),u([d({type:oa})],Hc.prototype,"graphic",void 0),u([d()],Hc.prototype,"mode",void 0),u([d({readOnly:!0})],Hc.prototype,"state",null),u([d()],Hc.prototype,"filesEnabled",void 0),u([d({readOnly:!0})],Hc.prototype,"supportsResizeAttachments",null),Hc=u([R("esri.widgets.Attachments.AttachmentsViewModel")],Hc);const OK=Hc;function Eoe(t){const e=t.toLowerCase();return e==="image/bmp"||e==="image/emf"||e==="image/exif"||e==="image/gif"||e==="image/x-icon"||e==="image/jpeg"||e==="image/png"||e==="image/tiff"||e==="image/x-wmf"}function jHe(t){const e=Dr("esri/themes/base/images/files/");return t?t==="text/plain"?`${e}text-32.svg`:t==="application/pdf"?`${e}pdf-32.svg`:t==="text/csv"?`${e}csv-32.svg`:t==="application/gpx+xml"?`${e}gpx-32.svg`:t==="application/x-dwf"?`${e}cad-32.svg`:t==="application/postscript"||t==="application/json"||t==="text/xml"||t==="model/vrml"?`${e}code-32.svg`:t==="application/x-zip-compressed"||t==="application/x-7z-compressed"||t==="application/x-gzip"||t==="application/x-tar"||t==="application/x-gtar"||t==="application/x-bzip2"||t==="application/gzip"||t==="application/x-compress"||t==="application/x-apple-diskimage"||t==="application/x-rar-compressed"||t==="application/zip"?`${e}zip-32.svg`:t.includes("image/")?`${e}image-32.svg`:t.includes("audio/")?`${e}sound-32.svg`:t.includes("video/")?`${e}video-32.svg`:t.includes("msexcel")||t.includes("ms-excel")||t.includes("spreadsheetml")?`${e}excel-32.svg`:t.includes("msword")||t.includes("ms-word")||t.includes("wordprocessingml")?`${e}word-32.svg`:t.includes("powerpoint")||t.includes("presentationml")?`${e}report-32.svg`:`${e}generic-32.svg`:`${e}generic-32.svg`}function Aa(t){return(e,r)=>{e.hasOwnProperty("_messageBundleProps")||(e._messageBundleProps=e._messageBundleProps?e._messageBundleProps.slice():[]),e._messageBundleProps.push({bundlePath:t,propertyName:r})}}var HHe=function(t){return{vnodeSelector:"",properties:void 0,children:void 0,text:t.toString(),domNode:null}},rTe=function(t,e){for(var r=0,i=t.length;r<i;r++){var s=t[r];Array.isArray(s)?rTe(s,e):s!=null&&s!==!1&&(s.hasOwnProperty("vnodeSelector")||(s=HHe(s)),e.push(s))}},qHe=function(t,e){for(var r=[],i=2;i<arguments.length;i++)r[i-2]=arguments[i];if(r.length===1&&typeof r[0]=="string")return{vnodeSelector:t,properties:e||void 0,children:void 0,text:r[0],domNode:null};var s=[];return rTe(r,s),{vnodeSelector:t,properties:e||void 0,children:s,text:void 0,domNode:null}};function j(t,e,...r){return typeof t!="function"||nK(t)?qHe(t,e,...r):t(e,...r)}const Coe={addButton:!0,addSubmitButton:!0,cancelAddButton:!0,cancelUpdateButton:!0,deleteButton:!0,errorMessage:!0,progressBar:!0,updateButton:!0},ti="esri-attachments",Cb="esri-button",Be={base:ti,loaderContainer:`${ti}__loader-container`,loader:`${ti}__loader`,fadeIn:`${ti}--fade-in`,container:`${ti}__container`,containerList:`${ti}__container--list`,containerPreview:`${ti}__container--preview`,actions:`${ti}__actions`,deleteButton:`${ti}__delete-button`,addAttachmentButton:`${ti}__add-attachment-button`,errorMessage:`${ti}__error-message`,items:`${ti}__items`,item:`${ti}__item`,itemButton:`${ti}__item-button`,itemMask:`${ti}__item-mask`,itemMaskIcon:`${ti}__item-mask--icon`,itemImage:`${ti}__image`,itemImageResizable:`${ti}__image--resizable`,itemLabel:`${ti}__label`,itemFilename:`${ti}__filename`,itemChevronIcon:`${ti}__item-chevron-icon`,itemLink:`${ti}__item-link`,itemLinkOverlay:`${ti}__item-link-overlay`,itemLinkOverlayIcon:`${ti}__item-link-overlay-icon`,itemEditIcon:`${ti}__item-edit-icon`,itemAddIcon:`${ti}__item-add-icon`,itemAddButton:`${ti}__item-add-button`,formNode:`${ti}__form-node`,fileFieldset:`${ti}__file-fieldset`,fileLabel:`${ti}__file-label`,fileName:`${ti}__file-name`,fileInput:`${ti}__file-input`,metadata:`${ti}__metadata`,metadataFieldset:`${ti}__metadata-fieldset`,progressBar:`${ti}__progress-bar`,esriWidget:"esri-widget",esriButton:Cb,buttonDisabled:`${Cb}--disabled`,esriButtonSecondary:`${Cb}--secondary`,esriButtonTertiary:`${Cb}--tertiary`,esriButtonThird:`${Cb}--third`,esriButtonSmall:`${Cb}--small`,esriButtonHalf:`${Cb}--half`,empty:"esri-widget__content--empty",iconExternalLink:"esri-icon-link-external",iconEdit:"esri-icon-edit",iconRight:"esri-icon-right",iconLeft:"esri-icon-left",iconPlus:"esri-icon-plus"},F9=window.CSS;let _l=class extends Rc{constructor(e,r){super(e,r),this.displayType="auto",this.messages=null,this.messagesUnits=null,this.selectedFile=null,this.submitting=!1,this.viewModel=null,this.visibleElements={...Coe},this._supportsImageOrientation=F9&&F9.supports&&F9.supports("image-orientation","from-image"),this._addAttachmentForm=null,this._updateAttachmentForm=null}initialize(){this.viewModel||(this.viewModel=new OK),this.addHandles([Vs(()=>this.viewModel?.attachmentInfos,"change",()=>this.scheduleRender()),Vs(()=>this.viewModel?.fileInfos,"change",()=>this.scheduleRender()),Q(()=>this.viewModel?.mode,()=>this._modeChanged(),xt)])}loadDependencies(){return oO({icon:()=>J(()=>import("./calcite-icon-94f83e8a.js"),["./calcite-icon-94f83e8a.js","./icon-6c56dd6f.js","./observers-333b9ff3.js"],import.meta.url)})}get capabilities(){return this.viewModel.capabilities}set capabilities(e){this.viewModel.capabilities=e}get effectiveDisplayType(){const{displayType:e}=this;return e&&e!=="auto"?e:this.viewModel.supportsResizeAttachments?"preview":"list"}get graphic(){return this.viewModel.graphic}set graphic(e){this.viewModel.graphic=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}castVisibleElements(e){return{...Coe,...e}}addAttachment(){const{_addAttachmentForm:e,viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.addAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new D("attachments:add-attachment",this.messages.addErrorMessage,i)),i})}deleteAttachment(e){const{viewModel:r}=this;return this._set("submitting",!0),this._set("error",null),r.deleteAttachment(e).then(i=>(this._set("submitting",!1),this._set("error",null),r.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new D("attachments:delete-attachment",this.messages.deleteErrorMessage,i)),i})}updateAttachment(){const{viewModel:e}=this,{_updateAttachmentForm:r}=this;return this._set("submitting",!0),this._set("error",null),e.updateAttachment(r).then(i=>(this._set("submitting",!1),this._set("error",null),e.mode="view",i)).catch(i=>{throw this._set("submitting",!1),this._set("error",new D("attachments:update-attachment",this.messages.updateErrorMessage,i)),i})}addFile(){const e=this.viewModel.addFile(this.selectedFile,this._addAttachmentForm);return this.viewModel.mode="view",e}updateFile(){const{viewModel:e}=this,r=e.updateFile(this.selectedFile,this._updateAttachmentForm,e.activeFileInfo);return e.mode="view",r}deleteFile(e){const r=this.viewModel.deleteFile(e||this.viewModel.activeFileInfo?.file);return this.viewModel.mode="view",r}render(){const{submitting:e,viewModel:r}=this,{state:i}=r;return j("div",{class:this.classes(Be.base,Be.esriWidget)},e?this.renderProgressBar():null,i==="loading"?this.renderLoading():this.renderAttachments(),this.renderErrorMessage())}renderErrorMessage(){const{error:e,visibleElements:r}=this;return e&&r.errorMessage?j("div",{key:"error-message",class:Be.errorMessage},e.message):null}renderAttachments(){const{activeFileInfo:e,mode:r,activeAttachmentInfo:i}=this.viewModel;return r==="add"?this.renderAddForm():r==="edit"?this.renderDetailsForm(i||e):this.renderAttachmentContainer()}renderLoading(){return j("div",{class:Be.loaderContainer,key:"loader"},j("div",{class:Be.loader}))}renderProgressBar(){return this.visibleElements.progressBar?j("div",{class:Be.progressBar,key:"progress-bar"}):null}renderAddForm(){const{submitting:e,selectedFile:r}=this,i=e||!r,s=this.visibleElements.cancelAddButton?j("button",{type:"button",bind:this,disabled:e,onclick:this._cancelForm,class:this.classes(Be.esriButton,Be.esriButtonTertiary,Be.esriButtonSmall,Be.esriButtonHalf,e&&Be.buttonDisabled)},this.messages.cancel):null,n=this.visibleElements.addSubmitButton?j("button",{type:"submit",disabled:i,class:this.classes(Be.esriButton,Be.esriButtonSecondary,Be.esriButtonSmall,Be.esriButtonHalf,{[Be.buttonDisabled]:i})},this.messages.add):null,o=r?j("span",{key:"file-name",class:Be.fileName},r.name):null,a=j("form",{bind:this,afterCreate:uk,afterRemoved:kne,"data-node-ref":"_addAttachmentForm",onsubmit:this._submitAddAttachment},j("fieldset",{class:Be.fileFieldset},o,j("label",{class:this.classes(Be.fileLabel,Be.esriButton,Be.esriButtonSecondary)},r?this.messages.changeFile:this.messages.selectFile,j("input",{class:Be.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))),n,s);return j("div",{key:"add-form-container",class:Be.formNode},a)}renderDetailsForm(e){const{visibleElements:r,viewModel:i,selectedFile:s,submitting:n}=this,{capabilities:o}=i,a=n||!s;let l,c,h,p;s?(l=s.type,c=s.name,h=s.size):e&&"file"in e?(l=e.file.type,c=e.file.name,h=e.file.size):e&&"contentType"in e&&(l=e.contentType,c=e.name,h=e.size,p=e.url);const f=o.editing&&o.operations?.delete&&r.deleteButton?j("button",{key:"delete-button",type:"button",disabled:n,bind:this,onclick:S=>this._submitDeleteAttachment(S,e),class:this.classes(Be.esriButton,Be.esriButtonSmall,Be.esriButtonTertiary,Be.deleteButton,{[Be.buttonDisabled]:n})},this.messages.delete):void 0,m=o.editing&&o.operations?.update&&r.updateButton?j("button",{disabled:a,key:"update-button",type:"submit",class:this.classes(Be.esriButton,Be.esriButtonSmall,Be.esriButtonThird,{[Be.buttonDisabled]:a})},this.messages.update):void 0,g=this.visibleElements.cancelUpdateButton?j("button",{disabled:n,key:"cancel-button",type:"button",bind:this,onclick:this._cancelForm,class:this.classes(Be.esriButton,Be.esriButtonSmall,Be.esriButtonTertiary,Be.esriButtonThird,{[Be.buttonDisabled]:n})},this.messages.cancel):void 0,_=o.editing&&o.operations?.update?j("fieldset",{key:"file",class:Be.fileFieldset},j("span",{key:"file-name",class:Be.fileName},c),j("label",{class:this.classes(Be.fileLabel,Be.esriButton,Be.esriButtonSecondary)},this.messages.changeFile,j("input",{class:Be.fileInput,type:"file",name:"attachment",bind:this,onchange:this._handleFileInputChange}))):void 0,v=j("fieldset",{key:"size",class:Be.metadataFieldset},j("label",null,Lze(this.messagesUnits,h??0))),b=j("fieldset",{key:"content-type",class:Be.metadataFieldset},j("label",null,l)),x=p!=null?j("a",{class:Be.itemLink,href:p,rel:"noreferrer",target:"_blank"},this.renderImageMask(e,400),j("div",{class:Be.itemLinkOverlay},j("span",{class:Be.itemLinkOverlayIcon},j("calcite-icon",{icon:"launch"})))):this.renderImageMask(e,400),T=j("form",{bind:this,afterCreate:uk,afterRemoved:kne,"data-node-ref":"_updateAttachmentForm",onsubmit:S=>this._submitUpdateAttachment(S,e)},j("div",{class:Be.metadata},v,b),_,j("div",{class:Be.actions},f,g,m));return j("div",{key:"edit-form-container",class:Be.formNode},x,T)}renderImageMask(e,r){return e?"file"in e?this.renderGenericImageMask(e.file.name,e.file.type):this.renderImageMaskForAttachment(e,r):null}renderGenericImageMask(e,r){const{supportsResizeAttachments:i}=this.viewModel,s=jHe(r),n={[Be.itemImageResizable]:i};return j("div",{class:this.classes(Be.itemMaskIcon,Be.itemMask)},j("img",{title:e,alt:e,src:s,class:this.classes(n,Be.itemImage)}))}renderImageMaskForAttachment(e,r){const{supportsResizeAttachments:i}=this.viewModel;if(!e)return null;const{contentType:s,name:n,url:o}=e;if(!i||!Eoe(s))return this.renderGenericImageMask(n,s);const a=this._getCSSTransform(e),l=a?{transform:a,"image-orientation":"none"}:{},c=`${o}${o?.includes("?")?"&":"?"}w=${r}`,h={[Be.itemImageResizable]:i};return j("div",{class:this.classes(Be.itemMask)},j("img",{styles:l,alt:n,title:n,src:c,class:this.classes(h,Be.itemImage)}))}renderFile(e){const{file:r}=e;return j("li",{class:Be.item,key:r},j("button",{key:"details-button",bind:this,class:Be.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,onclick:()=>this._startEditFile(e),type:"button"},this.renderImageMask(e),j("label",{class:Be.itemLabel},j("span",{class:Be.itemFilename},r.name||this.messages.noTitle),j("span",{"aria-hidden":"true",class:this.classes(Be.itemChevronIcon,T7(this.container)?Be.iconLeft:Be.iconRight)}))))}renderAttachmentInfo({attachmentInfo:e,displayType:r}){const{viewModel:i,effectiveDisplayType:s}=this,{capabilities:n,supportsResizeAttachments:o}=i,{contentType:a,name:l,url:c}=e,h=this.renderImageMask(e,r==="list"?48:400),p=n.editing?j("span",{"aria-hidden":"true",class:this.classes(Be.itemChevronIcon,T7(this.container)?Be.iconLeft:Be.iconRight)}):null,f=[h,s==="preview"&&o&&Eoe(a)?null:j("label",{class:Be.itemLabel},j("span",{class:Be.itemFilename},l||this.messages.noTitle),p)],m=n.editing?j("button",{key:"details-button",bind:this,class:Be.itemButton,title:this.messages.attachmentDetails,"aria-label":this.messages.attachmentDetails,"data-attachment-info-id":e.id,onclick:()=>this._startEditAttachment(e),type:"button"},f):j("a",{key:"details-link",class:Be.itemButton,href:c??void 0,target:"_blank"},f);return j("li",{class:Be.item,key:e},m)}renderAttachmentContainer(){const{effectiveDisplayType:e,viewModel:r,visibleElements:i}=this,{attachmentInfos:s,capabilities:n,fileInfos:o}=r,a=!!s?.length,l=!!o?.length,c={[Be.containerList]:e!=="preview",[Be.containerPreview]:e==="preview"},h=n.editing&&n.operations?.add&&i.addButton?j("button",{bind:this,onclick:()=>this._startAddAttachment(),class:this.classes(Be.esriButton,Be.esriButtonTertiary,Be.addAttachmentButton),type:"button"},j("span",{"aria-hidden":"true",class:this.classes(Be.itemAddIcon,Be.iconPlus)}),this.messages.add):void 0,p=a?j("ul",{key:"attachments-list",class:Be.items},s.toArray().map(g=>this.renderAttachmentInfo({attachmentInfo:g,displayType:e}))):void 0,f=l?j("ul",{key:"file-list",class:Be.items},o.toArray().map(g=>this.renderFile(g))):void 0,m=l||a?void 0:j("div",{class:Be.empty},this.messages.noAttachments);return j("div",{key:"attachments-container",class:this.classes(Be.container,c)},p,f,m,h)}_modeChanged(){this._set("error",null),this._set("selectedFile",null)}_handleFileInputChange(e){const r=e.target,i=r&&r.files&&r.files.item(0);this._set("selectedFile",i)}_submitDeleteAttachment(e,r){e.preventDefault(),r&&("file"in r?this.deleteFile(r.file):r&&this.deleteAttachment(r))}_submitAddAttachment(e){e.preventDefault(),this.viewModel.filesEnabled?this.addFile():this.addAttachment()}_submitUpdateAttachment(e,r){e.preventDefault(),r&&"file"in r?this.updateFile():this.updateAttachment()}_startEditAttachment(e){const{viewModel:r}=this;r.activeFileInfo=null,r.activeAttachmentInfo=e,r.mode="edit"}_startEditFile(e){const{viewModel:r}=this;r.activeAttachmentInfo=null,r.activeFileInfo=e,r.mode="edit"}_startAddAttachment(){this.viewModel.mode="add"}_cancelForm(e){e.preventDefault(),this.viewModel.mode="view"}_getCSSTransform(e){const{orientationInfo:r}=e;return!this._supportsImageOrientation&&r?[r.rotation?`rotate(${r.rotation}deg)`:"",r.mirrored?"scaleX(-1)":""].join(" "):""}};u([d()],_l.prototype,"capabilities",null),u([d()],_l.prototype,"displayType",void 0),u([d({readOnly:!0})],_l.prototype,"effectiveDisplayType",null),u([d()],_l.prototype,"graphic",null),u([d()],_l.prototype,"label",null),u([d(),Aa("esri/widgets/Attachments/t9n/Attachments")],_l.prototype,"messages",void 0),u([d(),Aa("esri/core/t9n/Units")],_l.prototype,"messagesUnits",void 0),u([d({readOnly:!0})],_l.prototype,"selectedFile",void 0),u([d({readOnly:!0})],_l.prototype,"submitting",void 0),u([d({readOnly:!0})],_l.prototype,"error",void 0),u([d({type:OK})],_l.prototype,"viewModel",void 0),u([d()],_l.prototype,"visibleElements",void 0),u([or("visibleElements")],_l.prototype,"castVisibleElements",null),_l=u([R("esri.widgets.Attachments")],_l);const WHe=_l;function W4t(t){}function ZHe(t){return()=>t}const Aoe=new Set;function XHe(t,e,r=!1){r&&Aoe.has(e)||(r&&Aoe.add(e),t.warn(`🛑 DEPRECATED - ${e}`))}function Ka(t,e,r={}){if(le("esri-deprecation-warnings")){const{moduleName:i}=r;z1(t,`Property: ${(i?i+"::":"")+e}`,r)}}function z1(t,e,r={}){if(le("esri-deprecation-warnings")){const{replacement:i,version:s,see:n,warnOnce:o}=r;let a=e;i&&(a+=`
	🛠️ Replacement: ${i}`),s&&(a+=`
	⚙️ Version: ${s}`),n&&(a+=`
	🔗 See ${n} for more details.`),XHe(t,a,o)}}const ud="esri-feature-form",h_=`${ud}__group`,up=`${ud}__input`,Ooe=`${ud}__related-records`,wr={base:ud,form:`${ud}__form`,formHeader:`${ud}__form-header`,label:`${ud}__label`,relationshipLabel:`${ud}__relationship-label`,fieldInputWrapper:`${up}-wrapper`,fieldInputLoader:`${up}-loader`,fieldInput:`${up}`,inputDate:`${up}--date`,inputTime:`${up}--time`,inputRadioGroup:`${up}--radio-group`,inputRadio:`${up}--radio`,inputRadioLabel:`${up}--radio-label`,inputDisabled:`${up}--disabled`,inputSwitch:`${up}--switch`,inputInvalid:`${up}--invalid`,centeredButton:`${ud}__centered-button`,description:`${ud}__description-text`,listObserver:`${ud}__list-observer`,relatedRecordsHeader:`${Ooe}_header`,relatedRecordsList:`${Ooe}_list`,dateInputContainer:`${`${ud}__date`}-input-container`,group:h_,groupLabel:`${h_}-label`,groupHeader:`${h_}-header`,groupTitle:`${h_}-title`,groupToggleIcon:`${h_}-toggle-icon`,groupCollapsed:`${h_}--collapsed`,groupSequential:`${h_}--sequential`,groupActive:`${h_}--active`,collapseIcon:"esri-icon-up",expandIcon:"esri-icon-down",widget:"esri-widget",panel:"esri-widget--panel",input:"esri-input"},qv=t=>t?.type==="field",C1=t=>t?.type==="group",EC=t=>t?.type==="relationship",k9=t=>!C1(t)&&t.group!=null,iTe=t=>t.type==="field",U9=t=>t.type==="group",Roe=t=>t.type==="relationship",sTe=t=>t.reduce((e,r)=>C1(r)?[...e,...r.inputs]:[...e,r],[]),Moe=t=>sTe(t).filter(qv),YHe=t=>sTe(t).filter(EC),bx=(t,e)=>t!=null&&t.input?.type===e,Ioe=t=>t!=null&&(bx(t,"text-box")||bx(t,"text-area")),Poe=({domain:t,inputType:e="text-box",dataType:r})=>r==="number"&&e==="text-box"&&(!t||t.type!=="coded-value"),nTe=t=>"items"in t,$oe={typeFieldName:null,types:[]};function GH(t,e,r){const i=Object.keys(e).filter(o=>PI(t,o)),s=i.map(o=>e[o]),n=i.map(o=>r.get(o)).filter(Ia);return QHe(t,oTe(s,n))}function oTe(t,e){const r=e.map((i,s)=>{let n=t[s];if(i.domain&&i.domain.type==="coded-value"){const o=i.domain.codedValues.find(a=>a.code===n);o?.name&&(n=o.name)}return w7(i)&&(n=aTe(i,n)),[i.name,n]});return Object.fromEntries(r)}function aTe(t,e){if(!t||e==null)return null;switch(t.type){case"date":return Vd(e);case"date-only":return UJ(e);case"time-only":return VJ(e);case"timestamp-offset":return zJ(e);default:return null}}const JHe=new Set(["date-only","time-only","timestamp-offset"]);function QHe(t,e){return fg(fg(t,r=>`{${r.toLowerCase()}}`),Object.fromEntries(Object.entries(e).map(([r,i])=>[r.toLowerCase(),i])))}const jH=t=>t?t.type==="subtype-sublayer"?{typeFieldName:t.parent?.subtypeField,types:t.parent?.subtypes??[]}:"types"in t&&t.types?{typeFieldName:t.typeIdField,types:t.types.map(({id:e,name:r,domains:i})=>({code:e,name:r,domains:i}))}:$oe:$oe,KHe=(t,e)=>{if(!t)return!0;const{operations:r}=t;switch(e){case"INSERT":return r.supportsAdd;case"UPDATE":case"DELETE":return r.supportsUpdate;default:return!0}};var Ek;(function(t){t.TOO_SHORT="length-validation-error::too-short"})(Ek||(Ek={}));const Loe={type:"number"},Doe={type:"number",intlOptions:{notation:"scientific"}},Noe={type:"date",intlOptions:{day:"2-digit",month:"2-digit",year:"numeric",hour:"numeric",minute:"numeric",second:"numeric"}};function Foe(t){return t>=1e7||t<=-1e7}const eqe=(t,e)=>{const{dataType:r,domain:i,error:s,field:n,minLength:o,value:a,required:l}=t;if(!e||!s)return null;if(l&&a===null)return e.validationErrors.cannotBeNull;if(s===L1.VALUE_OUT_OF_RANGE||s===jI.OUT_OF_RANGE){const c=dQ(i)||Lbe(n);return s1(e.validationErrors.outsideRange,c,{format:{max:r==="date"?Noe:Foe(c.max)?Doe:Loe,min:r==="date"?Noe:Foe(c.min)?Doe:Loe}})}return s===L1.INVALID_CODED_VALUE?e.validationErrors.invalidCodedValue:s===iA.INVALID_TYPE?e.validationErrors.invalidType:s===Ek.TOO_SHORT?s1(e.validationErrors.tooShort,{min:o}):null},tqe=t=>{if(!t)return;const e=t.layer,r=e&&"geometryType"in e?e.geometryType:void 0,i=t.geometry?.type;return i==="polyline"||r==="polyline"?"line":i||r||"table"},rqe=t=>{const e=[];if(t.formTemplate){const{description:r,title:i}=t.formTemplate;t.fields?.forEach(s=>{const n=i&&PI(i,s.name),o=r&&PI(r,s.name);(n||o)&&e.push(s.name)})}return e};function iqe(t){return"formTemplate"in t&&t.formTemplate?(t.formTemplate.elements?.filter(iTe)??[]).some(({fieldName:e})=>!t.fieldsIndex.get(e)):!1}var HH;let Ew=HH=class extends he{constructor(t){super(t),this.expression=null,this.name=null,this.returnType="boolean",this.title=null}clone(){return new HH({name:this.name,title:this.title,expression:this.expression,returnType:this.returnType})}};u([d({type:String,json:{write:!0}})],Ew.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],Ew.prototype,"name",void 0),u([d({type:["boolean","date","number","string"],json:{write:!0}})],Ew.prototype,"returnType",void 0),u([d({type:String,json:{write:!0}})],Ew.prototype,"title",void 0),Ew=HH=u([R("esri.form.ExpressionInfo")],Ew);const sqe=Ew;let Cw=class extends he{constructor(e){super(e),this.description=null,this.label=null,this.type=null,this.visibilityExpression=null}};u([d({type:String,json:{write:!0}})],Cw.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Cw.prototype,"label",void 0),u([d()],Cw.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Cw.prototype,"visibilityExpression",void 0),Cw=u([R("esri.form.elements.Element")],Cw);const hA=Cw;var qH;let XF=qH=class extends he{constructor(t){super(t),this.type=null}clone(){return new qH({type:this.type})}};u([d({type:["attachment","audio","document","image","signature","video"],json:{write:!0}})],XF.prototype,"type",void 0),XF=qH=u([R("esri.form.elements.inputs.AttachmentInput")],XF);const nqe=XF;var WH;let Aw=WH=class extends hA{constructor(t){super(t),this.attachmentKeyword=null,this.editable=!0,this.input=null,this.type="attachment"}clone(){return new WH({attachmentKeyword:this.attachmentKeyword,description:this.description,editable:this.editable,input:this.input,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({type:String,json:{write:!0}})],Aw.prototype,"attachmentKeyword",void 0),u([d({type:Boolean,json:{write:!0}})],Aw.prototype,"editable",void 0),u([d({type:nqe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],Aw.prototype,"input",void 0),u([d({type:["attachment"],json:{read:!1,write:!0}})],Aw.prototype,"type",void 0),Aw=WH=u([R("esri.form.elements.AttachmentElement")],Aw);const koe=Aw;let YF=class extends he{constructor(e){super(e),this.type=null}};u([d()],YF.prototype,"type",void 0),YF=u([R("esri.form.elements.inputs.Input")],YF);const dO=YF;let b3=class extends dO{constructor(e){super(e),this.maxLength=null,this.minLength=0}};u([d({type:Number,json:{write:!0}})],b3.prototype,"maxLength",void 0),u([d({type:Number,json:{write:!0}})],b3.prototype,"minLength",void 0),b3=u([R("esri.form.elements.inputs.TextInput")],b3);const RK=b3;var ZH;let JF=ZH=class extends RK{constructor(t){super(t),this.type="barcode-scanner"}clone(){return new ZH({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["barcode-scanner"],json:{read:!1,write:!0}})],JF.prototype,"type",void 0),JF=ZH=u([R("esri.form.elements.inputs.BarcodeScannerInput")],JF);const oqe=JF;var XH;let J2=XH=class extends dO{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="combo-box"}clone(){return new XH({showNoValueOption:this.showNoValueOption,noValueOptionLabel:this.noValueOptionLabel})}};u([d({type:String,json:{write:!0}})],J2.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],J2.prototype,"showNoValueOption",void 0),u([d({type:["combo-box"],json:{read:!1,write:!0}})],J2.prototype,"type",void 0),J2=XH=u([R("esri.form.elements.inputs.ComboBoxInput")],J2);const aqe=J2;var YH;function Uoe(t){return t!=null?new Date(t):null}function Voe(t){return t?t.getTime():null}let Ap=YH=class extends dO{constructor(t){super(t),this.includeTime=!1,this.max=null,this.min=null,this.type="datetime-picker"}readMax(t,e){return Uoe(e.max)}writeMax(t,e){e.max=Voe(t)}readMin(t,e){return Uoe(e.min)}writeMin(t,e){e.min=Voe(t)}clone(){return new YH({includeTime:this.includeTime,max:this.max,min:this.min})}};u([d({type:Boolean,json:{write:!0}})],Ap.prototype,"includeTime",void 0),u([d({type:Date,json:{type:Number,write:!0}})],Ap.prototype,"max",void 0),u([Ae("max")],Ap.prototype,"readMax",null),u([Ve("max")],Ap.prototype,"writeMax",null),u([d({type:Date,json:{type:Number,write:!0}})],Ap.prototype,"min",void 0),u([Ae("min")],Ap.prototype,"readMin",null),u([Ve("min")],Ap.prototype,"writeMin",null),u([d({type:["datetime-picker"],json:{read:!1,write:!0}})],Ap.prototype,"type",void 0),Ap=YH=u([R("esri.form.elements.inputs.DateTimePickerInput")],Ap);const lqe=Ap;var JH;let Q2=JH=class extends dO{constructor(t){super(t),this.noValueOptionLabel=null,this.showNoValueOption=!0,this.type="radio-buttons"}clone(){return new JH({noValueOptionLabel:this.noValueOptionLabel,showNoValueOption:this.showNoValueOption})}};u([d({type:String,json:{write:!0}})],Q2.prototype,"noValueOptionLabel",void 0),u([d({type:Boolean,json:{write:!0}})],Q2.prototype,"showNoValueOption",void 0),u([d({type:["radio-buttons"],json:{read:!1,write:!0}})],Q2.prototype,"type",void 0),Q2=JH=u([R("esri.form.elements.inputs.RadioButtonsInput")],Q2);const cqe=Q2;var QH;let K2=QH=class extends dO{constructor(t){super(t),this.offValue=null,this.onValue=null,this.type="switch"}clone(){return new QH({offValue:this.offValue,onValue:this.onValue})}};u([d({type:[String,Number],json:{write:!0}})],K2.prototype,"offValue",void 0),u([d({type:[String,Number],json:{write:!0}})],K2.prototype,"onValue",void 0),u([d({type:["switch"],json:{read:!1,write:!0}})],K2.prototype,"type",void 0),K2=QH=u([R("esri.form.elements.inputs.SwitchInput")],K2);const uqe=K2;var KH;let QF=KH=class extends RK{constructor(t){super(t),this.type="text-area"}clone(){return new KH({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-area"],json:{read:!1,write:!0}})],QF.prototype,"type",void 0),QF=KH=u([R("esri.form.elements.inputs.TextAreaInput")],QF);const hqe=QF;var eq;let KF=eq=class extends RK{constructor(t){super(t),this.type="text-box"}clone(){return new eq({maxLength:this.maxLength,minLength:this.minLength})}};u([d({type:["text-box"],json:{read:!1,write:!0}})],KF.prototype,"type",void 0),KF=eq=u([R("esri.form.elements.inputs.TextBoxInput")],KF);const dqe=KF,pqe={base:dO,key:"type",typeMap:{"barcode-scanner":oqe,"combo-box":aqe,"datetime-picker":lqe,"radio-buttons":cqe,switch:uqe,"text-area":hqe,"text-box":dqe}};var tq;let XE=tq=class extends he{constructor(t){super(t),this.name=null,this.code=null}clone(){return new tq({name:this.name,code:this.code})}};u([d({type:String,json:{write:!0}})],XE.prototype,"name",void 0),u([d({type:[String,Number],json:{write:!0}})],XE.prototype,"code",void 0),XE=tq=u([R("esri.layers.support.CodedValue")],XE);const fqe=new kr({inherited:"inherited",codedValue:"coded-value",range:"range"});let w3=class extends he{constructor(e){super(e),this.name=null,this.type=null}};u([d({type:String,json:{write:!0}})],w3.prototype,"name",void 0),u([nt(fqe)],w3.prototype,"type",void 0),w3=u([R("esri.layers.support.Domain")],w3);const lV=w3;var rq;let x3=rq=class extends lV{constructor(t){super(t),this.codedValues=null,this.type="coded-value"}getName(t){let e=null;if(this.codedValues){const r=String(t);this.codedValues.some(i=>(String(i.code)===r&&(e=i.name),!!e))}return e}clone(){return new rq({codedValues:re(this.codedValues),name:this.name})}};u([d({type:[XE],json:{write:!0}})],x3.prototype,"codedValues",void 0),u([nt({codedValue:"coded-value"})],x3.prototype,"type",void 0),x3=rq=u([R("esri.layers.support.CodedValueDomain")],x3);const MK=x3;var iq;let e4=iq=class extends lV{constructor(t){super(t),this.type="inherited"}clone(){return new iq}};u([nt({inherited:"inherited"})],e4.prototype,"type",void 0),e4=iq=u([R("esri.layers.support.InheritedDomain")],e4);const lTe=e4;var sq;let eE=sq=class extends lV{constructor(t){super(t),this.maxValue=null,this.minValue=null,this.type="range"}clone(){return new sq({maxValue:this.maxValue,minValue:this.minValue,name:this.name})}};u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[1]},write:{enabled:!1,overridePolicy(){return{enabled:this.maxValue!=null&&this.minValue==null}},target:"range",writer(t,e,r){e[r]=[this.minValue||0,t]}}}})],eE.prototype,"maxValue",void 0),u([d({type:Number,json:{type:[Number],read:{source:"range",reader:(t,e)=>e.range&&e.range[0]},write:{target:"range",writer(t,e,r){e[r]=[t,this.maxValue||0]}}}})],eE.prototype,"minValue",void 0),u([nt({range:"range"})],eE.prototype,"type",void 0),eE=sq=u([R("esri.layers.support.RangeDomain")],eE);const cTe=eE,uTe={key:"type",base:lV,typeMap:{range:cTe,"coded-value":MK,inherited:lTe}};function cV(t){if(!t||!t.type)return null;switch(t.type){case"range":return cTe.fromJSON(t);case"codedValue":return MK.fromJSON(t);case"inherited":return lTe.fromJSON(t)}return null}var nq;const hTe="esri.form.elements.FieldElement",zoe=K.getLogger(hTe);let Zh=nq=class extends hA{constructor(t){super(t),this.domain=null,this.editableExpression=null,this.fieldName=null,this.hint=null,this.input=null,this.requiredExpression=null,this.type="field",this.valueExpression=null}get editable(){return Ka(zoe,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._get("editable")??!0}set editable(t){Ka(zoe,"editable",{replacement:"editableExpression",version:"4.26",warnOnce:!0}),this._set("editable",t)}clone(){return new nq({description:this.description,domain:this.domain,editable:this.editable,editableExpression:this.editableExpression,fieldName:this.fieldName,hint:this.hint,input:this.input,label:this.label,requiredExpression:this.requiredExpression,valueExpression:this.valueExpression,visibilityExpression:this.visibilityExpression})}};u([d({types:uTe,json:{read:{reader:cV},write:!0}})],Zh.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],Zh.prototype,"editable",null),u([d({type:String,json:{write:!0}})],Zh.prototype,"editableExpression",void 0),u([d({type:String,json:{write:!0}})],Zh.prototype,"fieldName",void 0),u([d({type:String,json:{write:!0}})],Zh.prototype,"hint",void 0),u([d({types:pqe,json:{read:{source:"inputType"},write:{target:"inputType"}}})],Zh.prototype,"input",void 0),u([d({type:String,json:{write:!0}})],Zh.prototype,"requiredExpression",void 0),u([d({type:String,json:{read:!1,write:!0}})],Zh.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Zh.prototype,"valueExpression",void 0),Zh=nq=u([R(hTe)],Zh);const Boe=Zh;var oq;let gy=oq=class extends hA{constructor(t){super(t),this.displayCount=null,this.displayType="list",this.editableExpression=null,this.orderByFields=null,this.relationshipId=null,this.type="relationship"}clone(){return new oq({description:this.description,displayCount:this.displayCount,displayType:this.displayType,editableExpression:this.editableExpression,label:this.label,orderByFields:re(this.orderByFields),relationshipId:this.relationshipId,visibilityExpression:this.visibilityExpression})}};u([d({type:Number,json:{write:!0}})],gy.prototype,"displayCount",void 0),u([d({type:["list"],json:{write:!0}})],gy.prototype,"displayType",void 0),u([d({type:String,json:{write:!0}})],gy.prototype,"editableExpression",void 0),u([d({type:[uK],json:{write:!0}})],gy.prototype,"orderByFields",void 0),u([d({type:Number,json:{write:!0}})],gy.prototype,"relationshipId",void 0),u([d({type:["relationship"],json:{read:!1,write:!0}})],gy.prototype,"type",void 0),gy=oq=u([R("esri.form.elements.RelationshipElement")],gy);const Goe=gy;function dTe(t){return{typesWithGroup:{base:hA,key:"type",typeMap:{attachment:koe,field:Boe,group:t,relationship:Goe}},typesWithoutGroup:{base:hA,key:"type",typeMap:{attachment:koe,field:Boe,relationship:Goe}}}}function pTe(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>i[s.type].fromJSON(s))}function fTe(t,e,r=!0){if(!t)return null;const i=r?e.typesWithGroup.typeMap:e.typesWithoutGroup.typeMap;return t.filter(s=>i[s.type]).map(s=>s.toJSON())}function mTe(t,e,r=!0){return t?t.map(i=>Rf(r?e.typesWithGroup:e.typesWithoutGroup,i)):null}var aq;let Um=aq=class extends hA{constructor(t){super(t),this.elements=null,this.initialState="expanded",this.type="group"}castElements(t){return mTe(t,V9,!1)}readElements(t,e){return pTe(e.formElements,V9,!1)}writeElements(t,e){e.formElements=fTe(t,V9,!1)}clone(){return new aq({description:this.description,elements:re(this.elements),initialState:this.initialState,label:this.label,visibilityExpression:this.visibilityExpression})}};u([d({json:{write:!0}})],Um.prototype,"elements",void 0),u([or("elements")],Um.prototype,"castElements",null),u([Ae("elements",["formElements"])],Um.prototype,"readElements",null),u([Ve("elements")],Um.prototype,"writeElements",null),u([d({type:["collapsed","expanded"],json:{write:!0}})],Um.prototype,"initialState",void 0),u([d({type:String,json:{read:!1,write:!0}})],Um.prototype,"type",void 0),Um=aq=u([R("esri.form.elements.GroupElement")],Um);const V9=dTe(Um),mqe=Um;var lq;const z9=dTe(mqe);let Op=lq=class extends he{constructor(t){super(t),this.description=null,this.elements=null,this.expressionInfos=null,this.preserveFieldValuesWhenHidden=!1,this.title=null}castElements(t){return mTe(t,z9)}readElements(t,e){return pTe(e.formElements,z9)}writeElements(t,e){e.formElements=fTe(t,z9)}clone(){return new lq({description:this.description,expressionInfos:re(this.expressionInfos),elements:re(this.elements),title:this.title,preserveFieldValuesWhenHidden:this.preserveFieldValuesWhenHidden})}};u([d({type:String,json:{write:!0}})],Op.prototype,"description",void 0),u([d({json:{write:!0}})],Op.prototype,"elements",void 0),u([or("elements")],Op.prototype,"castElements",null),u([Ae("elements",["formElements"])],Op.prototype,"readElements",null),u([Ve("elements")],Op.prototype,"writeElements",null),u([d({type:[sqe],json:{write:!0}})],Op.prototype,"expressionInfos",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Op.prototype,"preserveFieldValuesWhenHidden",void 0),u([d({type:String,json:{write:!0}})],Op.prototype,"title",void 0),Op=lq=u([R("esri.form.FormTemplate")],Op);const gTe=Op;let Ow=class extends me{constructor(e){super(e),this.maxValue=null,this.minValue=null,this.codedValue=null}};u([d()],Ow.prototype,"objectType",void 0),u([d()],Ow.prototype,"maxValue",void 0),u([d()],Ow.prototype,"minValue",void 0),u([d()],Ow.prototype,"codedValue",void 0),Ow=u([R("esri.layers.support.ContingentValue")],Ow);const va=Ow,gqe=[["binary","application/octet-stream","bin",""]];function K4t(t){return l$(t?.supportedFormats??[]).flatMap($K).map(e=>`.${e}`)}function e5t(t){const e={};for(const r of l$(t?.supportedFormats??[])){const i=PK(r),s=$K(r).map(n=>`.${n}`);e[i]??(e[i]=[]),e[i].push(...s)}return[{description:"3D Models",accept:e}]}function yqe(t,e){return IK(bqe(t,e))}function _qe(t,e){return IK(wqe(t,e))}function t5t(t,e){return PK(vqe(t,e))}function l$(t){return[...gqe,...t]}function vqe(t,e){return l$(e).find(r=>IK(r)===t)}function bqe(t,e){return l$(e).find(r=>PK(r)===t)}function wqe(t,e){const r=t.toLowerCase();return l$(e).find(i=>$K(i).some(s=>r.endsWith(s)))}function IK(t){return t?.[0]}function PK(t){return t?.[1]}function $K(t){return t?.[2].split(",")??[]}function r5t(t){return t.tables?.find(e=>e.role==="assetMaps")}function uV(t){return!(!(t&&typeof t=="object"&&"loaded"in t&&t.loaded&&vg(t)?.operations?.supportsEditing&&"type"in t)||"editingEnabled"in t&&!oV(t)||t.type==="scene"&&!xqe(t))}function xqe(t){const e=t.infoFor3D;if(!e)return!0;const{supportedFormats:r,queryFormats:i}=e,s=yqe("model/gltf-binary",r)??_qe("glb",r);return s!=null&&i.includes(s)}const yTe={mapserver:"MapServer",imageserver:"ImageServer",featureserver:"FeatureServer",sceneserver:"SceneServer",streamserver:"StreamServer",vectortileserver:"VectorTileServer"},_Te=Object.values(yTe),vTe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/rest\\/services\\/(.+?)\\/(${_Te.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),Tqe=new RegExp(`^((?:https?:)?\\/\\/\\S+?\\/([^\\/\\n]+)\\/(${_Te.join("|")}))(?:\\/(?:layers\\/)?(\\d+))?`,"i"),Sqe=/(.*?)\/(?:layers\/)?(\d+)\/?$/i;function i5t(t){return!!vTe.test(t)}function sg(t){if(t==null)return null;const e=Fn(t),r=e.path.match(vTe)||e.path.match(Tqe);if(!r)return null;const[,i,s,n,o]=r,a=s.indexOf("/");return{title:hV(a!==-1?s.slice(a+1):s),serverType:yTe[n.toLowerCase()],sublayer:o!=null&&o!==""?parseInt(o,10):null,url:{path:i}}}function Eqe(t){const e=Fn(t).path.match(Sqe);return e?{serviceUrl:e[1],sublayerId:Number(e[2])}:null}function hV(t){return(t=t.replaceAll(/\s*[/_]+\s*/g," "))[0].toUpperCase()+t.slice(1)}function bTe(t,e){const r=[];if(t){const i=sg(t);i!=null&&i.title&&r.push(i.title)}if(e){const i=hV(e);r.push(i)}if(r.length===2){if(r[0].toLowerCase().includes(r[1].toLowerCase()))return r[0];if(r[1].toLowerCase().includes(r[0].toLowerCase()))return r[1]}return r.join(" - ")}function LK(t){if(!t)return!1;const e=".arcgis.com/",r="//services",i="//tiles",s="//features",n=(t=t.toLowerCase()).includes(e),o=t.includes(r)||t.includes(i)||t.includes(s);return n&&o}function Cqe(t,e){return t&&mve(yve(t,e))}function wTe(t){let{url:e}=t;if(!e)return{url:e};e=yve(e,t.logger);const r=Fn(e),i=sg(r.path);let s;if(i!=null)i.sublayer!=null&&t.layer.layerId==null&&(s=i.sublayer),e=i.url.path;else if(t.nonStandardUrlAllowed){const n=Eqe(r.path);n!=null&&(e=n.serviceUrl,s=n.sublayerId)}return{url:mve(e),layerId:s}}function xTe(t,e,r,i,s){U1(e,i,"url",s),i.url&&t.layerId!=null&&(i.url=Cu(i.url,r,t.layerId.toString()))}function s5t(t){if(!t)return!1;const e=t.toLowerCase(),r=e.includes("/services/"),i=e.includes("/mapserver/wmsserver"),s=e.includes("/imageserver/wmsserver"),n=e.includes("/wmsserver");return r&&(i||s||n)}let Rw=class extends me{constructor(e){super(e),this.isRetired=!1}};u([d()],Rw.prototype,"id",void 0),u([d()],Rw.prototype,"isRetired",void 0),u([d()],Rw.prototype,"subtype",void 0),u([d()],Rw.prototype,"values",void 0),Rw=u([R("esri.layers.support.Contingency")],Rw);const joe=Rw;let T3=class extends me{constructor(e){super(e)}};u([d()],T3.prototype,"fieldGroup",void 0),u([d()],T3.prototype,"type",void 0),T3=u([R("esri.layers.support.ContingencyConstraintViolation")],T3);const Hoe=T3;let S3=class extends me{constructor(e){super(e)}};u([d()],S3.prototype,"contingentValuesAllGroups",void 0),u([d()],S3.prototype,"contingentValuesByFieldGroup",void 0),S3=u([R("esri.layers.support.ContingentValuesResult")],S3);const Aqe=S3;let Mw=class extends me{constructor(e){super(e),this.fields=null,this.isEditingRestrictive=!1}};u([d()],Mw.prototype,"name",void 0),u([d()],Mw.prototype,"fields",void 0),u([d()],Mw.prototype,"isEditingRestrictive",void 0),u([d()],Mw.prototype,"contingencies",void 0),Mw=u([R("esri.layers.support.FieldGroup")],Mw);const cq=Mw;let yy=class extends he{constructor(){super(...arguments),this.code=null,this.defaultValues={},this.domains=null,this.name=null}readDomains(e){if(!e)return null;const r={};for(const i of Object.keys(e))r[i]=cV(e[i]);return r}writeDomains(e,r){if(!e)return;const i={};for(const s of Object.keys(e))e[s]&&(i[s]=e[s]?.toJSON());r.domains=i}};u([d({type:Number,json:{write:!0}})],yy.prototype,"code",void 0),u([d({type:Object,json:{write:!0}})],yy.prototype,"defaultValues",void 0),u([d({json:{write:!0}})],yy.prototype,"domains",void 0),u([Ae("domains")],yy.prototype,"readDomains",null),u([Ve("domains")],yy.prototype,"writeDomains",null),u([d({type:String,json:{write:!0}})],yy.prototype,"name",void 0),yy=u([R("esri.layers.support.Subtype")],yy);const qoe=yy;var J_;let Q_=J_=class extends iS(_g){constructor(t){super(t),this.request=Lt,this.fieldGroups=null,this.fieldGroupDefinitions=null}initialize(){}get subtypeFieldName(){const{layer:t}=this;return t.type==="subtype-group"?t.subtypeField:t.typeIdField}static async createLoadedLayerContingentValuesCache(t){await t.load();const e=t.sourceJSON;if(t.layerId===void 0)return null;const r=e.hasContingentValuesDefinition;if(r)return new J_({layer:t}).load();if(r===void 0){const i=sg(t.url);if(i==null)return null;const s=i.url.path;if((await J_._staticFetchEnterpriseFeatureRoot(s)).supportsQueryDataElements){const n=t.layerId.toString(),o=await J_._staticFetchEnterpriseFieldGroup(s,n);if(o){const a=o.map(l=>({name:l.name,isEditingRestrictive:l.isEditingRestrictive,fields:l.fieldNames.names}));return new J_({layer:t,fieldGroupDefinitions:a}).load()}}}return null}async load(t){const e=this.layer.load(t).then(()=>this._initializeContingentValues(this.fieldGroupDefinitions,t));return this.addResolvingPromise(e),this}validateContingencyConstraints(t,e){const r=Object.keys(t),i=[],s=[];for(const n of this.fieldGroups){const o=n.isEditingRestrictive?"error":"warning";if(e&&!n.fields.some(h=>e.includes(h)))continue;if(!n.fields.every(h=>r.includes(h))){s.push(new Hoe({fieldGroup:n,type:o}));continue}let a=!1;const l=t[this.subtypeFieldName],c=n.contingencies.filter(h=>!(!h.isRetired&&h.subtype)||h.subtype.code===l);for(const h of c){let p=!0;for(const f in h.values){const m=h.values[f];if(m.objectType!=="any"){if(m.objectType==="null"){if(t[f]!=null){p=!1;break}}else if(m.objectType==="code"){if(t[f]!==m.codedValue.code){p=!1;break}}else if(m.objectType==="range"){const g=t[f];if(g<m.minValue||g>m.maxValue){p=!1;break}}}}if(p){a=!0;break}}a||i.push(new Hoe({fieldGroup:n,type:o}))}return{invalid:i,incomplete:s}}getContingentValues(t,e,r=!1){const i=t[this.subtypeFieldName],s=i!=null,n={};let o=[];const a=this.fieldGroups.filter(l=>l.fields.includes(e));o.push(new va({objectType:"any"}));for(const l of a){let c=[];const h=l.contingencies.filter(m=>!(m.isRetired||m.subtype&&s&&m.subtype.code!==i));let p=!1;const f={};for(const m of h){let g,_=!0;for(const v in m.values){const b=m.values[v];if(e!==v){if(t[v]!==void 0&&b.objectType!=="any"){if(b.objectType==="null")t[v]!==null&&(_=!1);else if(b.objectType==="code")t[v]!==b.codedValue.code&&(_=!1);else if(b.objectType==="range"){const x=t[v];(x<b.minValue||x>b.maxValue)&&(_=!1)}}}else g=b,p=p||b.objectType==="range"}if(g&&_){if(g.objectType==="any"){c.length=0,c.push(g);break}const v=this._generateKey(g);f[v]||c.push(g),f[v]=!0}}p&&(c=this._joinRange(c)),n[l.name]=c,o=r?this._filterIntersection(o,c):[]}return a.length===1&&r&&(o=[]),new Aqe({contingentValuesAllGroups:o,contingentValuesByFieldGroup:n})}_generateKey(t){switch(t.objectType){case"any":return"@any@";case"null":return"@null@";case"code":return t.codedValue.name+t.codedValue.code.toString();case"range":return t.minValue.toString()+"-"+t.maxValue.toString()}}_joinRange(t){let e,r;t.sort((s,n)=>s.objectType==="null"?-1:n.objectType==="null"?1:s.minValue-n.minValue);const i=[];for(const s of t)s.objectType!=="null"?e!=null&&r!=null?r<s.minValue?(i.push(new va({objectType:"range",minValue:e,maxValue:r})),e=s.minValue,r=s.maxValue):r<s.maxValue&&(r=s.maxValue):(e=s.minValue,r=s.maxValue):i.push(s);return i.push(new va({objectType:"range",minValue:e,maxValue:r})),i}_filterIntersection(t,e){if(t.length===0||e.length===0)return[];if(t[0].objectType==="any")return e;if(e[0].objectType==="any")return t;const r=t[0].objectType==="range"||t[1]?.objectType==="range",i=e[0].objectType==="range"||e[1]?.objectType==="range";return r||i?this._intersectRanges(t,e):this._intersectValues(t,e)}_intersectRanges(t,e){const r=[];let i,s=0;for(const n of t)for(;s<e.length;s++){const o=e[s];if(n.objectType==="null"&&o.objectType==="null")r.push(new va({objectType:"null"}));else{if(n.objectType==="null")break;if(o.objectType==="null")continue}if(n.maxValue<o.minValue)break;if(n.maxValue===o.minValue){r.push(new va({objectType:"range",minValue:n.maxValue,maxValue:o.minValue}));break}if(!(n.minValue>o.maxValue))if(n.minValue!==o.maxValue){if(i=n.minValue>o.minValue?n.minValue:o.minValue,n.maxValue<o.maxValue){r.push(new va({objectType:"range",minValue:i,maxValue:n.maxValue}));break}r.push(new va({objectType:"range",minValue:i,maxValue:o.maxValue}))}else r.push(new va({objectType:"range",minValue:n.minValue,maxValue:o.maxValue}))}return r}_intersectValues(t,e){const r=[];for(const i of t)e.some(s=>{if(i.objectType===s.objectType)switch(i.objectType){case"any":case"null":return!0;case"code":return i.codedValue.code===s.codedValue.code&&i.codedValue.name===s.codedValue.name}return!1})&&r.push(i);return r}static async _staticFetchEnterpriseFeatureRoot(t,e){return Lt(t,{responseType:"json",query:{f:"json"},...e}).then(r=>r.data)}static async _staticFetchEnterpriseFieldGroup(t,e,r){return Lt(`${t}/queryDataElements`,{responseType:"json",query:{layers:JSON.stringify([e]),f:"json"},...r}).then(i=>i.data.layerDataElements?.[0].dataElement.fieldGroups)}async _initializeContingentValues(t,e){const r=t??await this._fetchFieldGroupDefs(e);if(r.length===0)return void(this.fieldGroups=[]);const i=await this._fetchContingentValues(r,e);this.fieldGroups=i}async _fetchFieldGroupDefs(t){if(this.layer.layerId===void 0)return[];const e=this.layer.sourceJSON,r=this.layer.layerId.toString(),i=sg(this.layer.url).url.path;return e.hasContingentValuesDefinition?(await this._fetchAGOLFieldGroup(i,r,t)).map(s=>({name:s.name,isEditingRestrictive:s.restrictive,fields:s.fields.map(n=>this.layer.fieldsIndex.normalizeFieldName(n))})):e.hasContingentValuesDefinition!==void 0?[]:this._fetchEnterpriseFeatureRoot(i,t).then(async s=>s.supportsQueryDataElements?(await this._fetchEnterpriseFieldGroup(i,r,t)).map(n=>({name:n.name,isEditingRestrictive:n.isEditingRestrictive,fields:n.fieldNames.names.map(o=>this.layer.fieldsIndex.normalizeFieldName(o))})):[])}async _fetchAGOLFieldGroup(t,e,r){return Lt(`${t}/${e}/fieldgroups`,{responseType:"json",query:{f:"json"},...r}).then(i=>i.data.fieldGroups)}async _fetchEnterpriseFieldGroup(t,e,r){return J_._staticFetchEnterpriseFieldGroup(t,e,r)}async _fetchEnterpriseFeatureRoot(t,e){return J_._staticFetchEnterpriseFeatureRoot(t,e)}async _fetchContingentValues(t,e){if(this.layer.layerId===void 0)return[];const r=this.layer.sourceJSON,i=this.layer.layerId.toString(),s=sg(this.layer.url).url.path;if(r.hasContingentValuesDefinition){const o=await this._fetchAGOLContingentValues(s,i,e);return this._constructFieldGroupsAGOL(t,o)}const n=await this._fetchEnterpriseContingentValues(s,i,e);return this._constructFieldGroupsEnterprise(t,n)}_constructFieldGroupsAGOL(t,e){return t.map(r=>{const i=e.contingentValuesDefinition.fieldGroups.find(s=>s.name===r.name);if(i){let s=[];return s=e.contingentValuesDefinition.hasSubType?this._parseAGOLFieldGroupSubtype(r,e,i.subTypes):this._parseAGOLFieldGroup(r,e,i.contingentValues),new cq({name:r.name,isEditingRestrictive:r.isEditingRestrictive,fields:r.fields,contingencies:s})}return null}).filter(Ia)}_parseAGOLFieldGroupSubtype(t,e,r){let i=[];return r?.forEach(s=>{const n=this._getSubtypeAGOL(s.name);i=i.concat(this._parseAGOLFieldGroup(t,e,s.contingentValues,n))}),i}_parseAGOLFieldGroup(t,e,r,i=null){const s=[];for(const n of r??[]){const o=this._parseAGOLContingency(n,t,e,i);s.push(o)}return s}_parseAGOLContingency(t,e,r,i){const s=t.id,n=!!t.retired&&t.retired===1,o={};for(let a=0,l=0;a<e.fields.length;a++){const c=e.fields[a],h=r.typeCodes[t.types[a]];if(h==="Code"){let p=t.values[l];l++;const f=this._getDomain(i,c);if(this.layer.getField(c)?.type==="string"){const v=r.stringDicts.find(b=>b.domain===f.name);v&&(p=v.entries[p])}const g=f.codedValues.find(v=>v.code===p),_=new va({codedValue:g,objectType:"code"});o[c]=_}else if(h==="Range"){const p=t.values[l];l++;const f=p.range[0],m=p.range[1],g=new va({minValue:f,maxValue:m,objectType:"range"});o[c]=g}else if(h==="Any"){const p=new va({objectType:"any"});o[c]=p}else{const p=new va({objectType:"null"});o[c]=p}}return new joe({id:s,isRetired:n,subtype:i,values:o})}_constructFieldGroupsEnterprise(t,e){const r=e.fieldGroups;return t.map(i=>{const s=r.find(n=>n.name===i.name);if(s){const n=s.contingencies.map(o=>{const a=o.id,l=o.isRetired||!1,c=this._getSubtypeEnterprise(o.subtypeCode),h={};for(let p=0;p<i.fields.length;p++){const f=i.fields[p];let m=o.values[p];if(typeof m=="number"||typeof m=="string"){const g=this._getDomain(c,f),_=this.layer.getField(f);_?.type==="string"?m=e.stringDictionary[m]:_?.type==="date"&&(m=new Date(`${m}+00:00`).getTime());const v=g.codedValues.find(x=>x.code===m),b=new va({codedValue:v,objectType:"code"});h[f]=b}else if(typeof m=="object"){const g=m.minValue,_=m.maxValue,v=new va({minValue:g,maxValue:_,objectType:"range"});h[f]=v}else if(m){const g=new va({objectType:"any"});h[f]=g}else{const g=new va({objectType:"null"});h[f]=g}}return new joe({id:a,isRetired:l,subtype:c,values:h})});return new cq({name:i.name,isEditingRestrictive:i.isEditingRestrictive,fields:i.fields,contingencies:n})}return null}).filter(Ia)}async _fetchEnterpriseContingentValues(t,e,r){return Lt(`${t}/queryContingentValues`,{responseType:"json",query:{layers:JSON.stringify([e]),f:"json"},...r}).then(i=>i.data.contingentValueSets?.[0])}async _fetchAGOLContingentValues(t,e,r){return Lt(`${t}/${e}/contingentValues`,{responseType:"json",query:{f:"json"},...r}).then(i=>i.data)}_getSubtypeEnterprise(t){const e=this.layer.sourceJSON;let r;if(e.subtypes){const i=e.subtypes.find(s=>s.code===t);r=qoe.fromJSON(i)}return r||null}_getSubtypeAGOL(t){const e=this.layer.sourceJSON;let r;if(e.subtypes){const i=e.subtypes.find(s=>s.name===t);r=qoe.fromJSON(i)}return r||null}_getDomain(t,e){const r=t?t.domains?.[e]:this.layer.getFieldDomain(e);return r?.type==="inherited"?this.layer.getFieldDomain(e):r}};u([d({constructOnly:!0})],Q_.prototype,"layer",void 0),u([d({constructOnly:!0})],Q_.prototype,"request",void 0),u([d({type:[cq]})],Q_.prototype,"fieldGroups",void 0),u([d({constructOnly:!0})],Q_.prototype,"fieldGroupDefinitions",void 0),u([d()],Q_.prototype,"subtypeFieldName",null),Q_=J_=u([R("esri.layers.support.LayerContingentValuesCache")],Q_);const Oqe=Q_;let Xh=class extends Oc(me){constructor(e){super(e),this.element=null,this.feature=null,this.layer=null,this.type=null,this.visibilityExpressionExecutor=null}get description(){return this.element?.description}get evaluatedVisibilityExpression(){const{visibilityExpressionExecutor:e}=this;return e!=null?!!e.lastEvaluatedValue:null}get label(){return this.element?.label}get visible(){return this.evaluatedVisibilityExpression!=null?this.evaluatedVisibilityExpression:this.element!=null}};u([d({readOnly:!0})],Xh.prototype,"description",null),u([d({constructOnly:!0})],Xh.prototype,"element",void 0),u([d()],Xh.prototype,"evaluatedVisibilityExpression",null),u([d()],Xh.prototype,"feature",void 0),u([d()],Xh.prototype,"label",null),u([d()],Xh.prototype,"layer",void 0),u([d()],Xh.prototype,"type",void 0),u([d()],Xh.prototype,"visible",null),u([d()],Xh.prototype,"visibilityExpressionExecutor",void 0),Xh=u([R("esri.widgets.FeatureForm.InputBase")],Xh);const TTe=Xh;let K_=class extends TTe{constructor(e){super(e),this.arcadeEditType="NA",this.editableExpressionExecutor=null}get editable(){return!!this.layerAllowsEdits&&(this.evaluatedEditableExpression??!1)}get evaluatedEditableExpression(){const{editableExpressionExecutor:e}=this;return e!=null?!!e.lastEvaluatedValue:null}get layerAllowsEdits(){const{layer:e}=this;if(!e)return!1;const r=vg(e),i=r?.operations.supportsEditing,s=KHe(r,this.arcadeEditType);return!(!i||!s)}};u([d()],K_.prototype,"arcadeEditType",void 0),u([d()],K_.prototype,"editable",null),u([d()],K_.prototype,"editableExpressionExecutor",void 0),u([d()],K_.prototype,"evaluatedEditableExpression",null),u([d()],K_.prototype,"layerAllowsEdits",null),K_=u([R("esri.widgets.FeatureForm.EditableInput")],K_);const STe=K_;var od;(function(t){t.Text="text",t.Number="number",t.Date="date",t.Unsupported="unsupported"})(od||(od={}));const Rqe="__internal-type-based-coded-value-domain__";let jr=class extends STe{constructor(e){super(e),this._storedValue=null,this.error=null,this.field=null,this.group=null,this.requiredExpressionExecutor=null,this.type="field",this.valueExpressionExecutor=null}get _dateRange(){const{element:e}=this;if(e?.input?.type==="datetime-picker"){const{max:r,min:i}=e.input;return{max:r,min:i}}return{min:null,max:null}}get _configAllowsEdits(){const{element:e,layer:r,name:i}=this;return e!=null?e.editableExpression?!!this.evaluatedEditableExpression:e.editable!==!1:r?.userHasUpdateItemPrivileges?!0:(r&&"popupTemplate"in r?r?.popupTemplate?.fieldInfos?.find(({fieldName:n})=>n===i):null)?.isEditable??!0}get _layerAndFieldAllowEdits(){return this.layerAllowsEdits&&this.field?.editable}get _isVisibleByDefault(){const{field:e,layer:r}=this;return!!e?.visible&&Mbe(e,r)}get _isEditTrackingField(){return qQ(this.layer).includes(this.name?.toLowerCase())}get _shouldUseValueExpression(){return this._layerAndFieldAllowEdits&&!this._configAllowsEdits&&this.valueExpressionExecutor!=null}get dataType(){const{field:e}=this;return eT(e)?od.Number:One(e)?od.Text:w7(e)?od.Date:od.Unsupported}get dateDataType(){if(this.dataType===od.Date)return this.field.type!=="date"?"string":"number"}get domain(){const{layer:e}=this,{typeFieldName:r,types:i}=jH(e);if(r===this.name&&this.field.domain==null)return new MK({name:Rqe,codedValues:i.map(({code:a,name:l})=>new XE({code:a,name:l}))});const{feature:s}=this,n=e?.getFieldDomain(this.name,{feature:s}),o=this.element?.domain;return o!=null&&this._isDomainCompatible(o)?o:n}get editable(){return!!this._layerAndFieldAllowEdits&&(this.evaluatedEditableExpression??this._configAllowsEdits)}get evaluatedRequiredExpression(){const{requiredExpressionExecutor:e}=this;return e!=null?!!e.lastEvaluatedValue:null}get evaluatedValueExpression(){const{valueExpressionExecutor:e}=this;return e!=null?e.lastEvaluatedValue:null}get hint(){return this.element?.hint}get includeDate(){return!(this.dataType!==od.Date||this.field.type==="time-only")}get includeTime(){const{element:e,field:r}=this;if(this.dataType!==od.Date)return!1;if(r.type==="time-only")return!0;if(r.type==="date-only")return!1;const i=e?.input?.type==="datetime-picker"?e.input.includeTime:void 0;return i===void 0||i}get includeTimestamp(){return this.field.type==="timestamp-offset"}set initialFeature(e){this._set("initialFeature",e),this.notifyChange("valid")}get inputType(){return this.element?.input?.type}get isRelationshipKeyField(){const{field:e,layer:r}=this;return aV(r)&&!!r.relationships?.some(i=>i.keyField===e.name)}get label(){return this.element?.label||this.field.alias||this.field.name}get maxLength(){if(this.dataType===od.Date)return-1;const{field:r,element:i}=this,s=r?.length,n=Ioe(i)?i.input.maxLength:NaN;return n!=null&&!isNaN(n)&&n>=-1&&(s===-1||n<=s)?n:s}get minLength(){if(this.dataType===od.Date)return-1;const{field:r,element:i}=this,s=r?.length,n=Ioe(i)?i.input.minLength:NaN;return n!=null&&!isNaN(n)&&n>=-1&&(s===-1||n<=s)?n:-1}get name(){return this.field?.name}get range(){const{_dateRange:e,domain:r,field:i}=this,{max:s,min:n}=e,o=s!=null&&Woe(s)?s.getTime():null,a=n!=null&&Woe(n)?n.getTime():null,l=dQ(r)||Lbe(i);if(!l)return{max:o,min:a};const c=l.max===Number.MAX_VALUE?null:l.max,h=l.min===Number.MIN_VALUE?null:l.min;return{max:o!=null&&(c===null||c!=null&&o<c)?o:c,min:a!=null&&(h===null||h!=null&&a>h)?a:h}}get required(){const{editable:e,evaluatedRequiredExpression:r,field:i,visible:s}=this;return!!e&&(i?.nullable===!1||!(!s||r==null)&&r)}set required(e){this._overrideIfSome("required",e)}get submittable(){const{field:e,required:r,valid:i,value:s}=this;return(!r||s!=null)&&(!!i||this.initialFeature.getAttribute(e.name)===s)}get updating(){const{editableExpressionExecutor:e,valueExpressionExecutor:r}=this;return r!=null&&r.updating||e!=null&&e.updating}get valid(){const e=this.editable?this._validate():null;return this._set("error",e),e===null}get value(){if(this._shouldUseValueExpression){const e=this.evaluatedValueExpression;if(this.dataType===od.Date){if(e instanceof Date)return e.getTime();if(typeof e!="number")return parseInt(e,10)}return e!=null&&typeof e=="object"?e.toString():e}return this.get("_storedValue")}set value(e){this.notifyChange("evaluatedVisibilityExpression"),this.set("_storedValue",e)}get visible(){return!this._isEditTrackingField&&(this.evaluatedVisibilityExpression!=null?this.evaluatedVisibilityExpression:this.element!=null||this._isVisibleByDefault)}_isDomainCompatible(e){const{field:r}=this;if(e?.type==="coded-value"){const i=typeof e.codedValues[0].code;if(i==="string"&&One(r)||i==="number"&&eT(r))return!0}return!!(e?.type==="range"&&eT(r)||w7(r))}_validate(){const{dataType:e,domain:r,field:i,initialFeature:s,minLength:n,required:o,valid:a,value:l}=this,c=o&&l===null,h=a!==void 0;return!c&&s.getAttribute(i.name)===l&&h?null:c?iA.INVALID_TYPE:e==="text"&&n>-1&&typeof l=="string"&&l.length<n?Ek.TOO_SHORT:r?l!==null||o?f1e(r,l):null:wze(i,l)}};u([d()],jr.prototype,"_storedValue",void 0),u([d()],jr.prototype,"_configAllowsEdits",null),u([d()],jr.prototype,"_layerAndFieldAllowEdits",null),u([d()],jr.prototype,"_isVisibleByDefault",null),u([d()],jr.prototype,"_isEditTrackingField",null),u([d()],jr.prototype,"_shouldUseValueExpression",null),u([d()],jr.prototype,"dataType",null),u([d()],jr.prototype,"dateDataType",null),u([d()],jr.prototype,"domain",null),u([d()],jr.prototype,"editable",null),u([d({readOnly:!0})],jr.prototype,"error",void 0),u([d()],jr.prototype,"evaluatedRequiredExpression",null),u([d()],jr.prototype,"evaluatedValueExpression",null),u([d()],jr.prototype,"field",void 0),u([d()],jr.prototype,"group",void 0),u([d({readOnly:!0})],jr.prototype,"hint",null),u([d()],jr.prototype,"includeDate",null),u([d()],jr.prototype,"includeTime",null),u([d()],jr.prototype,"includeTimestamp",null),u([d()],jr.prototype,"initialFeature",null),u([d({readOnly:!0})],jr.prototype,"inputType",null),u([d()],jr.prototype,"label",null),u([d()],jr.prototype,"maxLength",null),u([d()],jr.prototype,"minLength",null),u([d({readOnly:!0})],jr.prototype,"name",null),u([d()],jr.prototype,"range",null),u([d()],jr.prototype,"required",null),u([d()],jr.prototype,"requiredExpressionExecutor",void 0),u([d()],jr.prototype,"submittable",null),u([d({readOnly:!0})],jr.prototype,"type",void 0),u([d()],jr.prototype,"updating",null),u([d()],jr.prototype,"valid",null),u([d({value:null})],jr.prototype,"value",null),u([d()],jr.prototype,"valueExpressionExecutor",void 0),u([d()],jr.prototype,"visible",null),jr=u([R("esri.widgets.FeatureForm.FieldInput")],jr);const Woe=t=>t&&!Number.isNaN(t.valueOf()),Zoe=jr;var Or;(function(t){t.AsyncNotEnabled="AsyncNotEnabled",t.ModulesNotSupported="ModulesNotSupported",t.CircularModules="CircularModules",t.NeverReach="NeverReach",t.UnsupportedHashType="UnsupportedHashType",t.InvalidParameter="InvalidParameter",t.UnexpectedToken="UnexpectedToken",t.Unrecognised="Unrecognised",t.UnrecognisedType="UnrecognisedType",t.MaximumCallDepth="MaximumCallDepth",t.BooleanConditionRequired="BooleanConditionRequired",t.TypeNotAllowedInFeature="TypeNotAllowedInFeature",t.KeyMustBeString="KeyMustBeString",t.WrongNumberOfParameters="WrongNumberOfParameters",t.CallNonFunction="CallNonFunction",t.NoFunctionInTemplateLiteral="NoFunctionInTemplateLiteral",t.NoFunctionInDictionary="NoFunctionInDictionary",t.NoFunctionInArray="NoFunctionInArray",t.AssignModuleFunction="AssignModuleFunction",t.LogicExpressionOrAnd="LogicExpressionOrAnd",t.LogicalExpressionOnlyBoolean="LogicalExpressionOnlyBoolean",t.FunctionNotFound="FunctionNotFound",t.InvalidMemberAccessKey="InvalidMemberAccessKey",t.UnsupportedUnaryOperator="UnsupportUnaryOperator",t.InvalidIdentifier="InvalidIdentifier",t.MemberOfNull="MemberOfNull",t.UnsupportedOperator="UnsupportedOperator",t.Cancelled="Cancelled",t.ModuleAccessorMustBeString="ModuleAccessorMustBeString",t.ModuleExportNotFound="ModuleExportNotFound",t.Immutable="Immutable",t.OutOfBounds="OutOfBounds",t.IllegalResult="IllegalResult",t.FieldNotFound="FieldNotFound",t.PortalRequired="PortalRequired",t.LogicError="LogicError",t.ArrayAccessorMustBeNumber="ArrayAccessMustBeNumber",t.KeyAccessorMustBeString="KeyAccessorMustBeString",t.WrongSpatialReference="WrongSpatialReference"})(Or||(Or={}));const ETe={[Or.TypeNotAllowedInFeature]:"Feature attributes only support dates, numbers, strings, guids.",[Or.LogicError]:"Logic error - {reason}",[Or.NeverReach]:"Encountered unreachable logic",[Or.AsyncNotEnabled]:"Async Arcade must be enabled for this script",[Or.ModuleAccessorMustBeString]:"Module accessor must be a string",[Or.ModuleExportNotFound]:"Module has no export with provided identifier",[Or.ModulesNotSupported]:"Current profile does not support modules",[Or.ArrayAccessorMustBeNumber]:"Array accessor must be a number",[Or.FunctionNotFound]:"Function not found",[Or.FieldNotFound]:"Key not found - {key}",[Or.CircularModules]:"Circular module dependencies are not allowed",[Or.Cancelled]:"Execution cancelled",[Or.UnsupportedHashType]:"Type not supported in hash function",[Or.IllegalResult]:"Value is not a supported return type",[Or.PortalRequired]:"Portal is required",[Or.InvalidParameter]:"Invalid parameter",[Or.WrongNumberOfParameters]:"Call with wrong number of parameters",[Or.Unrecognised]:"Unrecognised code structure",[Or.UnrecognisedType]:"Unrecognised type",[Or.WrongSpatialReference]:"Cannot work with geometry in this spatial reference. It is different to the execution spatial reference",[Or.BooleanConditionRequired]:"Conditions must use booleans",[Or.NoFunctionInDictionary]:"Dictionaries cannot contain functions.",[Or.NoFunctionInArray]:"Arrays cannot contain functions.",[Or.NoFunctionInTemplateLiteral]:"Template Literals do not expect functions by value.",[Or.KeyAccessorMustBeString]:"Accessor must be a string",[Or.KeyMustBeString]:"Object keys must be a string",[Or.Immutable]:"Object is immutable",[Or.UnexpectedToken]:"Unexpected token",[Or.MemberOfNull]:"Cannot access property of null object",[Or.MaximumCallDepth]:"Exceeded maximum function depth",[Or.OutOfBounds]:"Out of bounds",[Or.InvalidIdentifier]:"Identifier not recognised",[Or.CallNonFunction]:"Expression is not a function",[Or.InvalidMemberAccessKey]:"Cannot access value using a key of this type",[Or.AssignModuleFunction]:"Cannot assign function to module variable",[Or.UnsupportedUnaryOperator]:"Unsupported unary operator",[Or.UnsupportedOperator]:"Unsupported operator",[Or.LogicalExpressionOnlyBoolean]:"Logical expressions must be boolean",[Or.LogicExpressionOrAnd]:"Logical expression can only be combined with || or &&"};let Mqe=class extends Error{constructor(...e){super(...e)}},Xoe=class CTe extends Mqe{constructor(e,r){super(DK(r)+e.message,{cause:e}),this.loc=null,Error.captureStackTrace&&Error.captureStackTrace(this,CTe),r&&r.loc&&(this.loc=r.loc)}},f5t=class ATe extends Error{constructor(e,r,i,s){super("Execution error - "+DK(i)+dV(ETe[r],s)),this.loc=null,this.declaredRootClass="esri.arcade.arcadeexecutionerror",Error.captureStackTrace&&Error.captureStackTrace(this,ATe),i&&i.loc&&(this.loc=i.loc)}};function DK(t){return t&&t.loc?`Line : ${t.loc.start?.line}, ${t.loc.start?.column}: `:""}let m5t=class OTe extends Error{constructor(e,r,i,s){super("Compilation error - "+DK(i)+dV(ETe[r],s)),this.loc=null,this.declaredRootClass="esri.arcade.arcadecompilationerror",Error.captureStackTrace&&Error.captureStackTrace(this,OTe),i&&i.loc&&(this.loc=i.loc)}},g5t=class RTe extends Error{constructor(){super("Uncompilable code structures"),this.declaredRootClass="esri.arcade.arcadeuncompilableerror",Error.captureStackTrace&&Error.captureStackTrace(this,RTe)}};function dV(t,e){try{if(!e)return t;for(const r in e){let i=e[r];i||(i=""),t=t.replace("{"+r+"}",e[r])}}catch{}return t}function y5t(t,e,r){return r.declaredRootClass==="esri.arcade.arcadeexecutionerror"||r.declaredRootClass==="esri.arcade.arcadecompilationerror"?r.loc===null&&e&&e.loc?new Xoe(r,{cause:r}):r:(r.declaredRootClass==="esri.arcade.featureset.support.featureseterror"||r.declaredRootClass==="esri.arcade.featureset.support.sqlerror"||r.declaredRootClass,e&&e.loc?new Xoe(r,{cause:r}):r)}var Ck;(function(t){t.UnrecognisedUri="UnrecognisedUri",t.UnsupportedUriProtocol="UnsupportedUriProtocol"})(Ck||(Ck={}));const Iqe={[Ck.UnrecognisedUri]:"Unrecognised uri - {uri}",[Ck.UnsupportedUriProtocol]:"Unrecognised uri protocol"};let _5t=class MTe extends Error{constructor(e,r){super(dV(Iqe[e],r)),this.declaredRootClass="esri.arcade.arcademoduleerror",Error.captureStackTrace&&Error.captureStackTrace(this,MTe)}},Nv=class{};var Ak;Nv.instance=new Of("Etc/UTC"),function(t){t.TimeZoneNotRecognised="TimeZoneNotRecognised"}(Ak||(Ak={}));const Pqe={[Ak.TimeZoneNotRecognised]:"Timezone identifier has not been recognised."};let $qe=class ITe extends Error{constructor(e,r){super(dV(Pqe[e],r)),this.declaredRootClass="esri.arcade.arcadedate.dateerror",Error.captureStackTrace&&Error.captureStackTrace(this,ITe)}},B9=class go{constructor(e){this._date=e,this.declaredRootClass="esri.arcade.arcadedate"}static fromParts(e=0,r=1,i=1,s=0,n=0,o=0,a=0,l){if(isNaN(e)||isNaN(r)||isNaN(i)||isNaN(s)||isNaN(n)||isNaN(o)||isNaN(a))return null;let c=0;const h=kt.local(e,r).daysInMonth;i<1&&(c=i-1,i=1),i>h&&(c=i-h,i=h);let p=0;r>12?(p=r-12,r=12):r<1&&(p=r-1,r=1);let f=0;n>59?(f=n-59,n=59):n<0&&(f=n,n=0);let m=0;o>59?(m=o-59,o=59):o<0&&(m=o,o=0);let g=0;a>999?(g=a-999,a=999):a<0&&(g=a,a=0);let _=kt.fromObject({day:i,year:e,month:r,hour:s,minute:n,second:o,millisecond:a},{zone:_L(l)});return p!==0&&(_=_.plus({months:p})),c!==0&&(_=_.plus({days:c})),f!==0&&(_=_.plus({minutes:f})),m!==0&&(_=_.plus({seconds:m})),g!==0&&(_=_.plus({milliseconds:g})),new go(_)}static get systemTimeZoneCanonicalName(){return Intl.DateTimeFormat().resolvedOptions().timeZone??"system"}static arcadeDateAndZoneToArcadeDate(e,r){const i=_L(r);return e.isUnknownTimeZone||i===Nv.instance?go.fromParts(e.year,e.monthJS+1,e.day,e.hour,e.minute,e.second,e.millisecond,i):new go(e._date.setZone(r))}static dateJSToArcadeDate(e){return new go(kt.fromJSDate(e,{zone:"system"}))}static dateJSAndZoneToArcadeDate(e,r="system"){return new go(kt.fromJSDate(e,{zone:r}))}static unknownEpochToArcadeDate(e){return new go(kt.fromMillis(e,{zone:Nv.instance}))}static unknownDateJSToArcadeDate(e){return new go(kt.fromMillis(e.getTime(),{zone:Nv.instance}))}static epochToArcadeDate(e,r="system"){return new go(kt.fromMillis(e,{zone:r}))}static dateTimeToArcadeDate(e){return new go(e)}clone(){return new go(this._date)}changeTimeZone(e){const r=_L(e);return go.dateTimeToArcadeDate(this._date.setZone(r))}static dateTimeAndZoneToArcadeDate(e,r){const i=_L(r);return e.zone===Nv.instance||i===Nv.instance?go.fromParts(e.year,e.month,e.day,e.hour,e.minute,e.second,e.millisecond,i):new go(e.setZone(i))}static nowToArcadeDate(e){return new go(kt.fromJSDate(new Date,{zone:e}))}static nowUTCToArcadeDate(){return new go(kt.utc())}get isSystem(){return this.timeZone==="system"||this.timeZone===go.systemTimeZoneCanonicalName}equals(e){return this.isSystem&&e.isSystem?this.toNumber()===e.toNumber():this.isUnknownTimeZone===e.isUnknownTimeZone&&this._date.equals(e._date)}get isUnknownTimeZone(){return this._date.zone===Nv.instance}get isValid(){return this._date.isValid}get hour(){return this._date.hour}get second(){return this._date.second}get day(){return this._date.day}get dayOfWeekISO(){return this._date.weekday}get dayOfWeekJS(){let e=this._date.weekday;return e>6&&(e=0),e}get millisecond(){return this._date.millisecond}get monthISO(){return this._date.month}get weekISO(){return this._date.weekNumber}get yearISO(){return this._date.weekYear}get monthJS(){return this._date.month-1}get year(){return this._date.year}get minute(){return this._date.minute}get zone(){return this._date.zone}get timeZoneOffset(){return this.isUnknownTimeZone?0:this._date.offset}get timeZone(){if(this.isUnknownTimeZone)return"unknown";if(this._date.zone.type==="system")return"system";const e=this.zone;return e.type==="fixed"?e.fixed===0?"utc":e.formatOffset(0,"short"):e.name}stringify(){return JSON.stringify(this.toJSDate())}plus(e){return new go(this._date.plus(e))}diff(e,r="milliseconds"){return this._date.diff(e._date,r)[r]}toISOString(e){return e?this._date.toISO({suppressMilliseconds:!0,includeOffset:!this.isUnknownTimeZone}):this._date.toISO({includeOffset:!this.isUnknownTimeZone})}toFormat(e,r){return this._date.toFormat(e,r)}toJSDate(){return this._date.toJSDate()}toSQLString(){return"timestamp '"+this._date.toFormat("yyyy-LL-dd HH:mm:ss")+"'"}toDateTime(){return this._date}toNumber(){return this._date.toMillis()}getTime(){return this._date.toMillis()}toUTC(){return new go(this._date.toUTC())}toLocal(){return new go(this._date.toLocal())}toString(){return this.toISOString(!0)}};function _L(t){if(t instanceof XA)return t;if(t.toLowerCase()==="system")return"system";if(t.toLowerCase()==="utc")return"utc";if(t.toLowerCase()==="unknown")return Nv.instance;if(/^[\+\-]?[0-9]{1,2}([:][0-9]{2})?$/.test(t)){const r=Ja.parseSpecifier("UTC"+(t.startsWith("+")||t.startsWith("-")?"":"+")+t);if(r)return r}const e=Of.create(t);if(!e.isValid)throw new $qe(Ak.TimeZoneNotRecognised);return e}let Lqe=class{constructor(e=[]){this._elements=e}length(){return this._elements.length}get(e){return this._elements[e]}toArray(){const e=[];for(let r=0;r<this.length();r++)e.push(this.get(r));return e}};var uq;let E3=uq=class extends he{constructor(t){super(t),this.minValue=0,this.maxValue=0}clone(){return new uq({minValue:this.minValue,maxValue:this.maxValue})}};u([d({type:Number,json:{write:!0}})],E3.prototype,"minValue",void 0),u([d({type:Number,json:{write:!0}})],E3.prototype,"maxValue",void 0),E3=uq=u([R("esri.renderer.support.AuthoringInfoClassBreakInfo")],E3);var hq;let Fv=hq=class extends he{constructor(t){super(t),this.field="",this.normalizationField="",this.label="",this.classBreakInfos=[]}clone(){return new hq({field:this.field,normalizationField:this.normalizationField,label:this.label,classBreakInfos:re(this.classBreakInfos)})}};u([d({type:String,json:{write:!0}})],Fv.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],Fv.prototype,"normalizationField",void 0),u([d({type:String,json:{write:!0}})],Fv.prototype,"label",void 0),u([d({type:[E3],json:{write:!0}})],Fv.prototype,"classBreakInfos",void 0),Fv=hq=u([R("esri.renderers.support.AuthoringInfoFieldInfo")],Fv);var dq;const vL=new kr({percentTotal:"percent-of-total",ratio:"ratio",percent:"percent"}),bL=new kr({sizeInfo:"size",colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation"}),Yoe={key:t=>typeof t=="number"?"number":"string",typeMap:{number:Number,string:String},base:null},Joe=["high-to-low","above-and-below","centered-on","extremes"],Qoe=[...new Set(["high-to-low","above-and-below","centered-on","extremes","90-10","above","below","high-to-low","above-and-below","90-10","above","below"])],Koe=["seconds","minutes","hours","days","months","years"];let qc=dq=class extends he{constructor(t){super(t),this.endTime=null,this.field=null,this.maxSliderValue=null,this.minSliderValue=null,this.startTime=null,this.type=null,this.units=null}castEndTime(t){return typeof t=="string"||typeof t=="number"?t:null}castStartTime(t){return typeof t=="string"||typeof t=="number"?t:null}get style(){return this.type==="color"?this._get("style"):null}set style(t){this._set("style",t)}get theme(){return this.type==="color"||this.type==="size"?this._get("theme")||"high-to-low":null}set theme(t){this._set("theme",t)}clone(){return new dq({endTime:this.endTime,field:this.field,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,startTime:this.startTime,style:this.style,theme:this.theme,type:this.type,units:this.units})}};u([d({types:Yoe,json:{write:!0}})],qc.prototype,"endTime",void 0),u([or("endTime")],qc.prototype,"castEndTime",null),u([d({type:String,json:{write:!0}})],qc.prototype,"field",void 0),u([d({type:Number,json:{write:!0}})],qc.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0}})],qc.prototype,"minSliderValue",void 0),u([d({types:Yoe,json:{write:!0}})],qc.prototype,"startTime",void 0),u([or("startTime")],qc.prototype,"castStartTime",null),u([d({type:vL.apiValues,value:null,json:{type:vL.jsonValues,read:vL.read,write:vL.write}})],qc.prototype,"style",null),u([d({type:Qoe,value:null,json:{type:Qoe,origins:{"web-scene":{type:Joe,write:{writer:(t,e)=>{Joe.includes(t)&&(e.theme=t)}}}},write:!0}})],qc.prototype,"theme",null),u([d({type:bL.apiValues,json:{type:bL.jsonValues,read:bL.read,write:bL.write}})],qc.prototype,"type",void 0),u([d({type:Koe,json:{type:Koe,write:!0}})],qc.prototype,"units",void 0),qc=dq=u([R("esri.renderers.support.AuthoringInfoVisualVariable")],qc);const Dqe=qc;let t4=class extends he{constructor(e){super(e),this.type=null}};u([d({readOnly:!0,json:{read:!1,write:!0}})],t4.prototype,"type",void 0),t4=u([R("esri.rest.support.ColorRamp")],t4);const NK=t4;var pq;let Iw=pq=class extends NK{constructor(t){super(t),this.algorithm=null,this.fromColor=null,this.toColor=null,this.type="algorithmic"}clone(){return new pq({fromColor:re(this.fromColor),toColor:re(this.toColor),algorithm:this.algorithm})}};u([nt({esriCIELabAlgorithm:"cie-lab",esriHSVAlgorithm:"hsv",esriLabLChAlgorithm:"lab-lch"})],Iw.prototype,"algorithm",void 0),u([d({type:Le,json:{type:[Ki],write:!0}})],Iw.prototype,"fromColor",void 0),u([d({type:Le,json:{type:[Ki],write:!0}})],Iw.prototype,"toColor",void 0),u([d({type:["algorithmic"]})],Iw.prototype,"type",void 0),Iw=pq=u([R("esri.rest.support.AlgorithmicColorRamp")],Iw);const FK=Iw;var fq;let C3=fq=class extends NK{constructor(t){super(t),this.colorRamps=null,this.type="multipart"}clone(){return new fq({colorRamps:re(this.colorRamps)})}};u([d({type:[FK],json:{write:!0}})],C3.prototype,"colorRamps",void 0),u([d({type:["multipart"]})],C3.prototype,"type",void 0),C3=fq=u([R("esri.rest.support.MultipartColorRamp")],C3);const PTe=C3,Nqe={key:"type",base:NK,typeMap:{algorithmic:FK,multipart:PTe}};function Fqe(t){return t&&t.type?t.type==="algorithmic"?FK.fromJSON(t):t.type==="multipart"?PTe.fromJSON(t):null:null}var mq;const Ab=new kr({esriClassifyDefinedInterval:"defined-interval",esriClassifyEqualInterval:"equal-interval",esriClassifyManual:"manual",esriClassifyNaturalBreaks:"natural-breaks",esriClassifyQuantile:"quantile",esriClassifyStandardDeviation:"standard-deviation"}),wL=new kr({pieChart:"pie-chart",classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density",flow:"flow"}),eae=new kr({classedSize:"class-breaks-size",classedColor:"class-breaks-color",univariateColorSize:"univariate-color-size",relationship:"relationship",predominance:"predominance",dotDensity:"dot-density"}),tae=["inches","feet","yards","miles","nautical-miles","millimeters","centimeters","decimeters","meters","kilometers","decimal-degrees"],kqe=["high-to-low","above-and-below","above","below","90-10"],Uqe=["flow-line","wave-front"],Vqe=["caret","circle-caret","arrow","circle-arrow","plus-minus","circle-plus-minus","square","circle","triangle","happy-sad","thumb","custom"];let _n=mq=class extends he{constructor(t){super(t),this.colorRamp=null,this.fadeRatio=null,this.isAutoGenerated=!1,this.lengthUnit=null,this.maxSliderValue=null,this.minSliderValue=null,this.visualVariables=null}get classificationMethod(){const t=this._get("classificationMethod"),e=this.type;return e&&e!=="relationship"?e==="class-breaks-size"||e==="class-breaks-color"?t||"manual":null:t}set classificationMethod(t){this._set("classificationMethod",t)}readColorRamp(t){return t?Fqe(t):void 0}get fields(){return this.type&&this.type!=="predominance"?null:this._get("fields")}set fields(t){this._set("fields",t)}get field1(){return this.type&&this.type!=="relationship"?null:this._get("field1")}set field1(t){this._set("field1",t)}get field2(){return this.type&&this.type!=="relationship"?null:this._get("field2")}set field2(t){this._set("field2",t)}get flowTheme(){return this.type==="flow"?this._get("flowTheme"):null}set flowTheme(t){this._set("flowTheme",t)}get focus(){return this.type&&this.type!=="relationship"?null:this._get("focus")}set focus(t){this._set("focus",t)}get numClasses(){return this.type&&this.type!=="relationship"?null:this._get("numClasses")}set numClasses(t){this._set("numClasses",t)}get statistics(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("statistics"):null}set statistics(t){this._set("statistics",t)}get standardDeviationInterval(){const t=this.type;return t&&t!=="relationship"&&t!=="class-breaks-size"&&t!=="class-breaks-color"||this.classificationMethod&&this.classificationMethod!=="standard-deviation"?null:this._get("standardDeviationInterval")}set standardDeviationInterval(t){this._set("standardDeviationInterval",t)}get type(){return this._get("type")}set type(t){let e=t;t==="classed-size"?e="class-breaks-size":t==="classed-color"&&(e="class-breaks-color"),this._set("type",e)}get univariateSymbolStyle(){return this.type==="univariate-color-size"&&this.univariateTheme==="above-and-below"?this._get("univariateSymbolStyle"):null}set univariateSymbolStyle(t){this._set("univariateSymbolStyle",t)}get univariateTheme(){return this.type==="univariate-color-size"?this._get("univariateTheme"):null}set univariateTheme(t){this._set("univariateTheme",t)}clone(){return new mq({classificationMethod:this.classificationMethod,colorRamp:re(this.colorRamp),fadeRatio:re(this.fadeRatio),fields:this.fields&&this.fields.slice(0),field1:re(this.field1),field2:re(this.field2),isAutoGenerated:this.isAutoGenerated,focus:this.focus,numClasses:this.numClasses,maxSliderValue:this.maxSliderValue,minSliderValue:this.minSliderValue,lengthUnit:this.lengthUnit,statistics:this.statistics,standardDeviationInterval:this.standardDeviationInterval,type:this.type,visualVariables:this.visualVariables&&this.visualVariables.map(t=>t.clone()),univariateSymbolStyle:this.univariateSymbolStyle,univariateTheme:this.univariateTheme,flowTheme:this.flowTheme})}};u([d({type:Ab.apiValues,value:null,json:{type:Ab.jsonValues,read:Ab.read,write:Ab.write,origins:{"web-document":{default:"manual",type:Ab.jsonValues,read:Ab.read,write:Ab.write}}}})],_n.prototype,"classificationMethod",null),u([d({types:Nqe,json:{write:!0}})],_n.prototype,"colorRamp",void 0),u([Ae("colorRamp")],_n.prototype,"readColorRamp",null),u([d({json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],_n.prototype,"fadeRatio",void 0),u([d({type:[String],value:null,json:{write:!0}})],_n.prototype,"fields",null),u([d({type:Fv,value:null,json:{write:!0}})],_n.prototype,"field1",null),u([d({type:Fv,value:null,json:{write:!0}})],_n.prototype,"field2",null),u([d({type:Uqe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],_n.prototype,"flowTheme",null),u([d({type:["HH","HL","LH","LL"],value:null,json:{write:!0}})],_n.prototype,"focus",null),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1}}}})],_n.prototype,"isAutoGenerated",void 0),u([d({type:Number,value:null,json:{type:Ki,write:!0}})],_n.prototype,"numClasses",null),u([d({type:tae,json:{type:tae,read:!1,write:!1,origins:{"web-scene":{read:!0,write:!0}}}})],_n.prototype,"lengthUnit",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],_n.prototype,"maxSliderValue",void 0),u([d({type:Number,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],_n.prototype,"minSliderValue",void 0),u([d({type:Object,value:null,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],_n.prototype,"statistics",null),u([d({type:[.25,.33,.5,1],value:null,json:{type:[.25,.33,.5,1],write:!0}})],_n.prototype,"standardDeviationInterval",null),u([d({type:wL.apiValues,value:null,json:{type:wL.jsonValues,read:wL.read,write:wL.write,origins:{"web-scene":{type:eae.jsonValues,write:{writer:eae.write,overridePolicy:t=>({enabled:t!=="flow"})}}}}})],_n.prototype,"type",null),u([d({type:[Dqe],json:{write:!0}})],_n.prototype,"visualVariables",void 0),u([d({type:Vqe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],_n.prototype,"univariateSymbolStyle",null),u([d({type:kqe,value:null,json:{write:!0,origins:{"web-scene":{write:!1}}}})],_n.prototype,"univariateTheme",null),_n=mq=u([R("esri.renderers.support.AuthoringInfo")],_n);const kK=_n,G9=new kr({simple:"simple",uniqueValue:"unique-value",classBreaks:"class-breaks",heatmap:"heatmap",dotDensity:"dot-density",dictionary:"dictionary",pieChart:"pie-chart"},{ignoreUnknown:!0});let A3=class extends he{constructor(e){super(e),this.authoringInfo=null,this.type=null}async getRequiredFields(e){if(!this.collectRequiredFields)return[];const r=new Set;return await this.collectRequiredFields(r,e),Array.from(r).sort()}getSymbol(e,r){}async getSymbolAsync(e,r){}getSymbols(){return[]}getAttributeHash(){return JSON.stringify(this)}getMeshHash(){return JSON.stringify(this)}};u([d({type:kK,json:{write:!0}})],A3.prototype,"authoringInfo",void 0),u([d({type:G9.apiValues,readOnly:!0,json:{type:G9.jsonValues,read:!1,write:{writer:G9.write,ignoreOrigin:!0}}})],A3.prototype,"type",void 0),A3=u([R("esri.renderers.Renderer")],A3);const V0=A3;function zqe(t){return t.match(Bqe)?.[1]?.replace(/\\'/g,"'")??null}const Bqe=/^hash\(\$feature\['((\\'|[^'])+)'\]\) \* 8\.381e-8$/;var gq;let CC=gq=class extends he{constructor(){super(...arguments),this.title=null}clone(){return new gq({title:this.title})}};u([d({type:String,json:{write:!0}})],CC.prototype,"title",void 0),CC=gq=u([R("esri.renderers.support.LegendOptions")],CC);var yq;let r4=yq=class extends CC{constructor(){super(...arguments),this.showLegend=null}clone(){return new yq({title:this.title,showLegend:this.showLegend})}};u([d({type:Boolean,json:{write:!0}})],r4.prototype,"showLegend",void 0),r4=yq=u([R("esri.renderers.visualVariables.support.VisualVariableLegendOptions")],r4);const $Te=r4,j9=new kr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"});let Rp=class extends he{constructor(e){super(e),this.index=null,this.type=null,this.field=null,this.valueExpression=null,this.valueExpressionTitle=null,this.legendOptions=null}castField(e){return e==null?e:typeof e=="function"?(K.getLogger(this).error(".field: field must be a string value"),null):qP(e)}get arcadeRequired(){return!!this.valueExpression}clone(){}getAttributeHash(){return`${this.type}-${this.field}-${this.valueExpression}`}};u([d()],Rp.prototype,"index",void 0),u([d({type:j9.apiValues,readOnly:!0,json:{read:j9.read,write:j9.write}})],Rp.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Rp.prototype,"field",void 0),u([or("field")],Rp.prototype,"castField",null),u([d({type:String,json:{write:!0}})],Rp.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],Rp.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],Rp.prototype,"arcadeRequired",null),u([d({type:$Te,json:{write:!0}})],Rp.prototype,"legendOptions",void 0),Rp=u([R("esri.renderers.visualVariables.VisualVariable")],Rp);const c$=Rp;var _q;let Pw=_q=class extends he{constructor(t){super(t),this.color=null,this.label=null,this.value=null}writeValue(t,e,r){e[r]=t??0}clone(){return new _q({color:this.color&&this.color.clone(),label:this.label,value:this.value})}};u([d({type:Le,json:{type:[Ki],write:!0}})],Pw.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],Pw.prototype,"label",void 0),u([d({type:Number,json:{write:{writerEnsuresNonNull:!0}}})],Pw.prototype,"value",void 0),u([Ve("value")],Pw.prototype,"writeValue",null),Pw=_q=u([R("esri.renderers.visualVariables.support.ColorStop")],Pw);const Gqe=Pw;var vq;let $w=vq=class extends c${constructor(t){super(t),this.type="color",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new vq({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],$w.prototype,"cache",null),u([d({type:["color"],json:{type:["colorInfo"]}})],$w.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],$w.prototype,"normalizationField",void 0),u([d({type:[Gqe],json:{write:!0}})],$w.prototype,"stops",null),$w=vq=u([R("esri.renderers.visualVariables.ColorVariable")],$w);const LTe=$w;var bq;let ev=bq=class extends he{constructor(t){super(t),this.label=null,this.opacity=null,this.value=null}readOpacity(t,e){return oA(e.transparency)}writeOpacity(t,e,r){e[r]=Q6(t)}clone(){return new bq({label:this.label,opacity:this.opacity,value:this.value})}};u([d({type:String,json:{write:!0}})],ev.prototype,"label",void 0),u([d({type:Number,json:{type:Ki,write:{target:"transparency"}}})],ev.prototype,"opacity",void 0),u([Ae("opacity",["transparency"])],ev.prototype,"readOpacity",null),u([Ve("opacity")],ev.prototype,"writeOpacity",null),u([d({type:Number,json:{write:!0}})],ev.prototype,"value",void 0),ev=bq=u([R("esri.renderers.visualVariables.support.OpacityStop")],ev);const jqe=ev;var wq;let Lw=wq=class extends c${constructor(t){super(t),this.type="opacity",this.normalizationField=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null}}set stops(t){t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value),this._set("stops",t)}clone(){return new wq({field:this.field,normalizationField:this.normalizationField,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,stops:this.stops&&this.stops.map(t=>t.clone()),legendOptions:this.legendOptions&&this.legendOptions.clone()})}getAttributeHash(){return`${super.getAttributeHash()}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],Lw.prototype,"cache",null),u([d({type:["opacity"],json:{type:["transparencyInfo"]}})],Lw.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Lw.prototype,"normalizationField",void 0),u([d({type:[jqe],json:{write:!0}})],Lw.prototype,"stops",null),Lw=wq=u([R("esri.renderers.visualVariables.OpacityVariable")],Lw);const DTe=Lw;var xq;let _y=xq=class extends c${constructor(t){super(t),this.axis=null,this.type="rotation",this.rotationType="geographic",this.valueExpressionTitle=null}get cache(){return{hasExpression:!!this.valueExpression,compiledFunc:null}}writeValueExpressionTitleWebScene(t,e,r,i){if(i&&i.messages){const s=`visualVariables[${this.index}]`;i.messages.push(new D("property:unsupported",this.type+"VisualVariable.valueExpressionTitle is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:s+".valueExpressionTitle",context:i}))}}clone(){return new xq({axis:this.axis,rotationType:this.rotationType,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,legendOptions:this.legendOptions&&this.legendOptions.clone()})}};u([d({readOnly:!0})],_y.prototype,"cache",null),u([d({type:["heading","tilt","roll"],json:{origins:{"web-scene":{default:"heading",write:!0}}}})],_y.prototype,"axis",void 0),u([d({type:["rotation"],json:{type:["rotationInfo"]}})],_y.prototype,"type",void 0),u([d({type:["geographic","arithmetic"],json:{write:!0,origins:{"web-document":{write:!0,default:"geographic"}}}})],_y.prototype,"rotationType",void 0),u([d({type:String,json:{write:!0}})],_y.prototype,"valueExpressionTitle",void 0),u([Ve("web-scene","valueExpressionTitle")],_y.prototype,"writeValueExpressionTitleWebScene",null),_y=xq=u([R("esri.renderers.visualVariables.RotationVariable")],_y);const NTe=_y;var Tq;let tE=Tq=class extends he{constructor(t){super(t),this.label=null,this.size=null,this.value=null}clone(){return new Tq({label:this.label,size:this.size,value:this.value})}};u([d({type:String,json:{write:!0}})],tE.prototype,"label",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],tE.prototype,"size",void 0),u([d({type:Number,json:{write:!0}})],tE.prototype,"value",void 0),tE=Tq=u([R("esri.renderers.visualVariables.support.SizeStop")],tE);const rE=tE;var Sq;let i4=Sq=class extends $Te{constructor(){super(...arguments),this.customValues=null}clone(){return new Sq({title:this.title,showLegend:this.showLegend,customValues:this.customValues&&this.customValues.slice(0)})}};u([d({type:[Number],json:{write:!0}})],i4.prototype,"customValues",void 0),i4=Sq=u([R("esri.renderers.visualVariables.support.SizeVariableLegendOptions")],i4);const Hqe=i4;var l0,Ro;function u1(t){return t&&t.declaredClass==="esri.renderers.visualVariables.SizeVariable"}function JI(t){return t!=null&&!isNaN(t)&&isFinite(t)}function FTe(t){return t.valueExpression?l0.Expression:t.field&&typeof t.field=="string"?l0.Field:l0.Unknown}function kTe(t,e){const r=e||FTe(t),i=t.valueUnit||"unknown";return r===l0.Unknown?Ro.Constant:t.stops?Ro.Stops:t.minSize!=null&&t.maxSize!=null&&t.minDataValue!=null&&t.maxDataValue!=null?Ro.ClampedLinear:i==="unknown"?t.minSize!=null&&t.minDataValue!=null?t.minSize&&t.minDataValue?Ro.Proportional:Ro.Additive:Ro.Identity:Ro.RealWorldSize}(function(t){t.Unknown="unknown",t.Expression="expression",t.Field="field"})(l0||(l0={})),function(t){t.Unknown="unknown",t.Stops="stops",t.ClampedLinear="clamped-linear",t.Proportional="proportional",t.Additive="additive",t.Constant="constant",t.Identity="identity",t.RealWorldSize="real-world-size"}(Ro||(Ro={}));const LT={unknown:1,inches:Ci(1,"meters","inches"),feet:Ci(1,"meters","feet"),"us-feet":Ci(1,"meters","us-feet"),yards:Ci(1,"meters","yards"),miles:Ci(1,"meters","miles"),"nautical-miles":Ci(1,"meters","nautical-miles"),millimeters:Ci(1,"meters","millimeters"),centimeters:Ci(1,"meters","centimeters"),decimeters:Ci(1,"meters","decimeters"),meters:Ci(1,"meters","meters"),kilometers:Ci(1,"meters","kilometers"),"decimal-degrees":1/O1e(1,"meters",ur.radius)},B1=K.getLogger("esri.renderers.visualVariables.support.visualVariableUtils"),rae=new oa,s4=Math.PI,UTe=/^\s*(return\s+)?\$view\.scale\s*(;)?\s*$/i;function VTe(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(g=>g.type==="color"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.ColorVariable")return void B1.warn("The visualVariable should be an instance of esri.renderers.visualVariables.ColorVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const g=i.stops;return g&&g[0]&&g[0].color}if(typeof a!="number")if(h){if(r==null||r.arcade==null)return void B1.error("Use of arcade expressions requires an arcade context");const g={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,v=_.getViewInfo(g),b=_.createExecContext(n,v);if(!p){const x=_.createSyntaxTree(i.valueExpression);p=_.createFunction(x),i.cache.compiledFunc=p}a=_.executeFunction(p,b)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const g=zK(a,c);if(g){const _=g[0],v=g[1],b=_===v?i.stops[_].color:Le.blendColors(i.stops[_].color,i.stops[v].color,g[2],r?.color);return new Le(b)}}}function zTe(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(g=>g.type==="opacity"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.OpacityVariable")return void B1.warn("The visualVariable should be an instance of esri.renderers.visualVariables.OpacityVariable");const s=typeof e=="number",n=s?null:e,o=n&&n.attributes;let a=s?e:null;const l=i.field,{ipData:c,hasExpression:h}=i.cache;let p=i.cache.compiledFunc;if(!l&&!h){const g=i.stops;return g&&g[0]&&g[0].opacity}if(typeof a!="number")if(h){if(r==null||r.arcade==null)return void B1.error("Use of arcade expressions requires an arcade context");const g={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},_=r.arcade.arcadeUtils,v=_.getViewInfo(g),b=_.createExecContext(n,v);if(!p){const x=_.createSyntaxTree(i.valueExpression);p=_.createFunction(x),i.cache.compiledFunc=p}a=_.executeFunction(p,b)}else o&&(a=o[l]);const f=i.normalizationField,m=o!=null&&f!=null?parseFloat(o[f]):void 0;if(a!=null&&(!f||s||!isNaN(m)&&m!==0)){isNaN(m)||s||(a/=m);const g=zK(a,c);if(g){const _=g[0],v=g[1];if(_===v)return i.stops[_].opacity;{const b=i.stops[_].opacity;return b+(i.stops[v].opacity-b)*g[2]}}}}function UK(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(m=>m.type==="rotation"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.RotationVariable")return void B1.warn("The visualVariable should be an instance of esri.renderers.visualVariables.RotationVariable");const s=i.axis||"heading",n=s==="heading"&&i.rotationType==="arithmetic"?90:0,o=s==="heading"&&i.rotationType==="arithmetic"?-1:1,a=typeof e=="number"?null:e,l=a&&a.attributes,c=i.field,{hasExpression:h}=i.cache;let p=i.cache.compiledFunc,f=0;if(!c&&!h)return f;if(h){if(r==null||r.arcade==null)return void B1.error("Use of arcade expressions requires an arcade context");const m={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},g=r.arcade.arcadeUtils,_=g.getViewInfo(m),v=g.createExecContext(a,_);if(!p){const b=g.createSyntaxTree(i.valueExpression);p=g.createFunction(b),i.cache.compiledFunc=p}f=g.executeFunction(p,v)}else l&&(f=l[c]||0);return f=typeof f!="number"||isNaN(f)?null:n+o*f,f}function qqe(t,e,r){const i=typeof e=="number",s=i?null:e,n=s&&s.attributes;let o=i?e:null;const{isScaleDriven:a}=t.cache;let l=t.cache.compiledFunc;if(a){const h=r?.scale,p=r?.view;o=h==null||p==="3d"?Wqe(t):h}else if(!i)switch(t.inputValueType){case l0.Expression:{if(r==null||r.arcade==null)return void B1.error("Use of arcade expressions requires an arcade context");const h={viewingMode:r.viewingMode,scale:r.scale,spatialReference:r.spatialReference},p=r.arcade.arcadeUtils,f=p.getViewInfo(h),m=p.createExecContext(s,f);if(!l){const g=p.createSyntaxTree(t.valueExpression);l=p.createFunction(g),t.cache.compiledFunc=l}o=p.executeFunction(l,m);break}case l0.Field:n&&(o=n[t.field]);break;case l0.Unknown:o=null}if(!JI(o))return null;if(i||!t.normalizationField)return o;const c=n?parseFloat(n[t.normalizationField]):null;return JI(c)&&c!==0?o/c:null}function Wqe(t){let e=null,r=null;const i=t.stops;return i?(e=i[0].value,r=i[i.length-1].value):(e=t.minDataValue||0,r=t.maxDataValue||0),(e+r)/2}function u$(t,e,r){const i="visualVariables"in t&&t.visualVariables?t.visualVariables.find(n=>n.type==="size"):t;if(!i)return;if(i.declaredClass!=="esri.renderers.visualVariables.SizeVariable")return void B1.warn("The visualVariable should be an instance of esri.renderers.visualVariables.SizeVariable");const s=GTe(qqe(i,e,r),i,e,r,i.cache.ipData);return s==null||isNaN(s)?0:s}function Tu(t,e,r){return t==null?null:u1(t)?u$(t,e,r):JI(t)?t:null}function BTe(t,e,r){return JI(r)&&t>r?r:JI(e)&&t<e?e:t}function Zqe(t,e,r,i){return t+((Tu(e.minSize,r,i)||e.minDataValue)??0)}function Xqe(t,e,r){const i=t.stops;let s=i&&i.length&&i[0].size;return s==null&&(s=t.minSize),Tu(s,e,r)}function Yqe(t,e,r,i){const s=(t-e.minDataValue)/(e.maxDataValue-e.minDataValue),n=Tu(e.minSize,r,i),o=Tu(e.maxSize,r,i),a=i?.shape;if(t<=e.minDataValue)return n;if(t>=e.maxDataValue)return o;if(n==null||o==null)return null;if(e.scaleBy==="area"&&a){const l=a==="circle",c=l?s4*(n/2)**2:n*n,h=c+s*((l?s4*(o/2)**2:o*o)-c);return l?2*Math.sqrt(h/s4):Math.sqrt(h)}return n+s*(o-n)}function Jqe(t,e,r,i){const s=i?.shape,n=t/e.minDataValue,o=Tu(e.minSize,r,i),a=Tu(e.maxSize,r,i);let l=null;return l=s==="circle"?2*Math.sqrt(n*(o/2)**2):s==="square"||s==="diamond"||s==="image"?Math.sqrt(n*o**2):n*o,BTe(l,o,a)}function Qqe(t,e,r,i,s){const[n,o,a]=zK(t,s);if(n===o)return Tu(e.stops?.[n].size,r,i);{const l=Tu(e.stops?.[n].size,r,i);return l+(Tu(e.stops?.[o].size,r,i)-l)*a}}function Kqe(t,e,r,i){const s=(i!=null&&i.resolution?i.resolution:1)*LT[e.valueUnit],n=Tu(e.minSize,r,i),o=Tu(e.maxSize,r,i),{valueRepresentation:a}=e;let l=null;return l=a==="area"?2*Math.sqrt(t/s4)/s:a==="radius"||a==="distance"?2*t/s:t/s,BTe(l,n,o)}function GTe(t,e,r,i,s){switch(e.transformationType){case Ro.Additive:return Zqe(t,e,r,i);case Ro.Constant:return Xqe(e,r,i);case Ro.ClampedLinear:return Yqe(t,e,r,i);case Ro.Proportional:return Jqe(t,e,r,i);case Ro.Stops:return Qqe(t,e,r,i,s);case Ro.RealWorldSize:return Kqe(t,e,r,i);case Ro.Identity:return t;case Ro.Unknown:return null}}function eWe(t,e,r){const{isScaleDriven:i}=t.cache;if(!(i&&r==="3d"||e))return null;const s={scale:e,view:r};let n=Tu(t.minSize,rae,s),o=Tu(t.maxSize,rae,s);if(n!=null||o!=null){if(n>o){const a=o;o=n,n=a}return{minSize:n,maxSize:o}}}function VK(t,e,r){if(!t.visualVariables)return;const i=[],s=[],n=[],o=[],a=[];for(const l of t.visualVariables)switch(l.type){case"color":s.push(l);break;case"opacity":n.push(l);break;case"rotation":a.push(l);break;case"size":o.push(l)}return s.forEach(l=>{const c=VTe(l,e,r);i.push({variable:l,value:c})}),n.forEach(l=>{const c=zTe(l,e,r);i.push({variable:l,value:c})}),a.forEach(l=>{const c=UK(l,e,r);i.push({variable:l,value:c})}),o.forEach(l=>{const c=u$(l,e,r);i.push({variable:l,value:c})}),i.filter(l=>l.value!=null)}function zK(t,e){if(!e)return;let r=0,i=e.length-1;return e.some((s,n)=>t<s?(i=n,!0):(r=n,!1)),[r,i,(t-e[r])/(e[i]-e[r])]}function tWe(t,e,r){const i=["proportional","proportional","proportional"];for(const s of t){const n=s.useSymbolValue?"symbol-value":u$(s,e,r);switch(s.axis){case"width":i[0]=n;break;case"depth":i[1]=n;break;case"height":i[2]=n;break;case"width-and-depth":i[0]=n,i[1]=n;break;case"all":case void 0:case null:i[0]=n,i[1]=n,i[2]=n;break;default:s.axis}}return i}const rWe=Object.freeze(Object.defineProperty({__proto__:null,getAllSizes:tWe,getColor:VTe,getOpacity:zTe,getRotationAngle:UK,getSize:u$,getSizeForValue:GTe,getSizeFromNumberOrVariable:Tu,getSizeRangeAtScale:eWe,getVisualVariableValues:VK,viewScaleRE:UTe},Symbol.toStringTag,{value:"Module"}));var Eq;const xL=new kr({width:"width",depth:"depth",height:"height",widthAndDepth:"width-and-depth",all:"all"}),Cq=new kr({unknown:"unknown",inch:"inches",foot:"feet",yard:"yards",mile:"miles","nautical-mile":"nautical-miles",millimeter:"millimeters",centimeter:"centimeters",decimeter:"decimeters",meter:"meters",kilometer:"kilometers","decimal-degree":"decimal-degrees"});function iae(t){if(t!=null)return typeof t=="string"||typeof t=="number"?oi(t):t.type==="size"?u1(t)?t:(delete(t={...t}).type,new Si(t)):void 0}function sae(t,e,r){if(typeof t!="object")return t;const i=new Si;return i.read(t,r),i}let Si=Eq=class extends c${constructor(t){super(t),this.axis=null,this.legendOptions=null,this.normalizationField=null,this.scaleBy=null,this.target=null,this.type="size",this.useSymbolValue=null,this.valueExpression=null,this.valueRepresentation=null,this.valueUnit=null}get cache(){return{ipData:this._interpolateData(),hasExpression:!!this.valueExpression,compiledFunc:null,isScaleDriven:this.valueExpression!=null&&UTe.test(this.valueExpression)}}set expression(t){K.getLogger(this).warn("'expression' is deprecated since version 4.2. Use 'valueExpression' instead. The only supported expression is 'view.scale'."),t==="view.scale"?(this.valueExpression="$view.scale",this._set("expression",t)):this._set("expression",null)}set index(t){u1(this.maxSize)&&(this.maxSize.index=`visualVariables[${t}].maxSize`),u1(this.minSize)&&(this.minSize.index=`visualVariables[${t}].minSize`),this._set("index",t)}get inputValueType(){return FTe(this)}set maxDataValue(t){t&&this.stops&&(K.getLogger(this).warn("cannot set maxDataValue when stops is not null."),t=null),this._set("maxDataValue",t)}set maxSize(t){t&&this.stops&&(K.getLogger(this).warn("cannot set maxSize when stops is not null."),t=null),this._set("maxSize",t)}castMaxSize(t){return iae(t)}readMaxSize(t,e,r){return sae(t,e,r)}set minDataValue(t){t&&this.stops&&(K.getLogger(this).warn("cannot set minDataValue when stops is not null."),t=null),this._set("minDataValue",t)}set minSize(t){t&&this.stops&&(K.getLogger(this).warn("cannot set minSize when stops is not null."),t=null),this._set("minSize",t)}castMinSize(t){return iae(t)}readMinSize(t,e,r){return sae(t,e,r)}get arcadeRequired(){return!!this.valueExpression||this.minSize!=null&&typeof this.minSize=="object"&&this.minSize.arcadeRequired||this.maxSize!=null&&typeof this.maxSize=="object"&&this.maxSize.arcadeRequired}set stops(t){this.minDataValue==null&&this.maxDataValue==null&&this.minSize==null&&this.maxSize==null?t&&Array.isArray(t)&&(t=t.filter(e=>!!e)).sort((e,r)=>e.value-r.value):t&&(K.getLogger(this).warn("cannot set stops when one of minDataValue, maxDataValue, minSize or maxSize is not null."),t=null),this._set("stops",t)}get transformationType(){return kTe(this,this.inputValueType)}readValueExpression(t,e){return t||e.expression&&"$view.scale"}writeValueExpressionWebScene(t,e,r,i){if(t==="$view.scale"){if(i&&i.messages){const s=this.index,n=typeof s=="string"?s:`visualVariables[${s}]`;i.messages.push(new D("property:unsupported",this.type+"VisualVariable.valueExpression = '$view.scale' is not supported in Web Scene. Please remove this property to save the Web Scene.",{instance:this,propertyName:n+".valueExpression",context:i}))}}else e[r]=t}readValueUnit(t){return t?Cq.read(t):null}clone(){return new Eq({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:u1(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:u1(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone()})}flipSizes(){if(this.transformationType===Ro.ClampedLinear){const{minSize:t,maxSize:e}=this;return this.minSize=e,this.maxSize=t,this}if(this.transformationType===Ro.Stops){const t=this.stops;if(!t)return this;const e=t.map(i=>i.size).reverse(),r=t.length;for(let i=0;i<r;i++)t[i].size=e[i];return this}return this}getAttributeHash(){return`${super.getAttributeHash()}-${this.target}-${this.normalizationField}`}_interpolateData(){return this.stops&&this.stops.map(t=>t.value||0)}};u([d({readOnly:!0})],Si.prototype,"cache",null),u([d({type:xL.apiValues,json:{type:xL.jsonValues,origins:{"web-map":{read:!1}},read:xL.read,write:xL.write}})],Si.prototype,"axis",void 0),u([d({type:String,value:null,json:{read:!1}})],Si.prototype,"expression",null),u([d()],Si.prototype,"index",null),u([d({type:String,readOnly:!0})],Si.prototype,"inputValueType",null),u([d({type:Hqe,json:{write:!0}})],Si.prototype,"legendOptions",void 0),u([d({type:Number,value:null,json:{write:!0}})],Si.prototype,"maxDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Si.prototype,"maxSize",null),u([or("maxSize")],Si.prototype,"castMaxSize",null),u([Ae("maxSize")],Si.prototype,"readMaxSize",null),u([d({type:Number,value:null,json:{write:!0}})],Si.prototype,"minDataValue",null),u([d({type:Number,value:null,json:{write:!0}})],Si.prototype,"minSize",null),u([or("minSize")],Si.prototype,"castMinSize",null),u([Ae("minSize")],Si.prototype,"readMinSize",null),u([d({type:String,json:{write:!0}})],Si.prototype,"normalizationField",void 0),u([d({readOnly:!0})],Si.prototype,"arcadeRequired",null),u([d({type:String})],Si.prototype,"scaleBy",void 0),u([d({type:[rE],value:null,json:{write:!0}})],Si.prototype,"stops",null),u([d({type:["outline"],json:{write:!0}})],Si.prototype,"target",void 0),u([d({type:String,readOnly:!0})],Si.prototype,"transformationType",null),u([d({type:["size"],json:{type:["sizeInfo"]}})],Si.prototype,"type",void 0),u([d({type:Boolean,json:{write:!0,origins:{"web-map":{read:!1}}}})],Si.prototype,"useSymbolValue",void 0),u([d({type:String,json:{write:!0}})],Si.prototype,"valueExpression",void 0),u([Ae("valueExpression",["valueExpression","expression"])],Si.prototype,"readValueExpression",null),u([Ve("web-scene","valueExpression")],Si.prototype,"writeValueExpressionWebScene",null),u([d({type:["radius","diameter","area","width","distance"],json:{write:!0}})],Si.prototype,"valueRepresentation",void 0),u([d({type:Cq.apiValues,json:{write:Cq.write,origins:{"web-map":{read:!1},"web-scene":{write:!0},"portal-item":{write:!0}}}})],Si.prototype,"valueUnit",void 0),u([Ae("valueUnit")],Si.prototype,"readValueUnit",null),Si=Eq=u([R("esri.renderers.visualVariables.SizeVariable")],Si);const pV=Si,iWe={color:LTe,size:pV,opacity:DTe,rotation:NTe},sWe=new kr({colorInfo:"color",transparencyInfo:"opacity",rotationInfo:"rotation",sizeInfo:"size"}),nWe=/^\[([^\]]+)\]$/i;let n4=class extends me{constructor(){super(...arguments),this.colorVariables=null,this.opacityVariables=null,this.rotationVariables=null,this.sizeVariables=null}set visualVariables(e){if(this._resetVariables(),(e=e&&e.filter(r=>!!r))&&e.length){for(const r of e)switch(r.type){case"color":this.colorVariables.push(r);break;case"opacity":this.opacityVariables.push(r);break;case"rotation":this.rotationVariables.push(r);break;case"size":this.sizeVariables.push(r)}this.sizeVariables.length&&this.sizeVariables.some(r=>!!r.target)&&e.sort((r,i)=>{let s=null;return s=r.target===i.target?0:r.target?1:-1,s});for(let r=0;r<e.length;r++)e[r].index=r;this._set("visualVariables",e)}else this._set("visualVariables",e)}readVariables(e,r,i){const{rotationExpression:s,rotationType:n}=r,o=s&&s.match(nWe),a=o&&o[1];if(a&&(e||(e=[]),e.push({type:"rotationInfo",rotationType:n,field:a})),e)return e.map(l=>{const c=sWe.read(l.type),h=iWe[c];h||(K.getLogger(this).warn(`Unknown variable type: ${c}`),i&&i.messages&&i.messages.push(new Bd("visual-variable:unsupported",`visualVariable of type '${c}' is not supported`,{definition:l,context:i})));const p=new h;return p.read(l,i),p})}writeVariables(e,r){const i=[];for(const s of e){const n=s.toJSON(r);n&&i.push(n)}return i}_resetVariables(){this.colorVariables=[],this.opacityVariables=[],this.rotationVariables=[],this.sizeVariables=[]}};u([d()],n4.prototype,"visualVariables",null),n4=u([R("esri.renderers.visualVariables.VisualVariableFactory")],n4);const oWe=n4,aWe={base:c$,key:"type",typeMap:{opacity:DTe,color:LTe,rotation:NTe,size:pV}},pO=t=>{let e=class extends t{constructor(){super(...arguments),this._vvFactory=new oWe}set visualVariables(r){this._vvFactory.visualVariables=r,this._set("visualVariables",this._vvFactory.visualVariables)}readVisualVariables(r,i,s){return this._vvFactory.readVariables(r,i,s)}writeVisualVariables(r,i,s,n){i[s]=this._vvFactory.writeVariables(r,n)}get arcadeRequiredForVisualVariables(){if(!this.visualVariables)return!1;for(const r of this.visualVariables)if(r.arcadeRequired)return!0;return!1}hasVisualVariables(r,i){return r?this.getVisualVariablesForType(r,i).length>0:this.getVisualVariablesForType("size",i).length>0||this.getVisualVariablesForType("color",i).length>0||this.getVisualVariablesForType("opacity",i).length>0||this.getVisualVariablesForType("rotation",i).length>0}getVisualVariablesForType(r,i){const s=this.visualVariables;return s?s.filter(n=>n.type===r&&(typeof i=="string"?n.target===i:i!==!1||!n.target)):[]}async collectVVRequiredFields(r,i){let s=[];this.visualVariables&&(s=s.concat(this.visualVariables));for(const n of s)n&&(n.field&&gh(r,i,n.field),n.normalizationField&&gh(r,i,n.normalizationField),n.valueExpression&&(lWe(n.valueExpression,r,i)||await Ec(r,i,n.valueExpression)))}};return u([d({types:[aWe],value:null,json:{write:!0}})],e.prototype,"visualVariables",null),u([Ae("visualVariables",["visualVariables","rotationType","rotationExpression"])],e.prototype,"readVisualVariables",null),u([Ve("visualVariables")],e.prototype,"writeVisualVariables",null),e=u([R("esri.renderers.mixins.VisualVariablesMixin")],e),e};function lWe(t,e,r){const i=zqe(t);return i!=null&&(gh(e,r,i),!0)}const WO={retainId:!1,ignoreDrivers:!1,hasLabelingContext:!0};function jTe(t,e=WO){if(!t)return{symbol:null};const{retainId:r=WO.retainId,ignoreDrivers:i=WO.ignoreDrivers,hasLabelingContext:s=WO.hasLabelingContext,retainCIM:n=WO.retainCIM}=e;let o=null;if(V1(t)||t instanceof hS)o=t.clone();else if(t.type==="cim"){const a=t.data?.symbol?.type;if(a!=="CIMPointSymbol")return{error:new D("symbol-conversion:unsupported-cim-symbol",`CIM symbol of type '${a||"unknown"}' is unsupported in 3D`,{symbol:t})};o=n?t.clone():c1.fromCIMSymbol(t)}else if(t instanceof Iu)o=iV.fromSimpleLineSymbol(t);else if(t instanceof Pf)o=c1.fromSimpleMarkerSymbol(t);else if(t instanceof sV)o=c1.fromPictureMarkerSymbol(t);else if(t instanceof U0)o=e.geometryType&&e.geometryType==="mesh"?o$.fromSimpleFillSymbol(t):a$.fromSimpleFillSymbol(t);else{if(!(t instanceof hO))return{error:new D("symbol-conversion:unsupported-2d-symbol",`2D symbol of type '${t.type||t.declaredClass}' is unsupported in 3D`,{symbol:t})};o=s?rV.fromTextSymbol(t):c1.fromTextSymbol(t)}return r&&o&&o.type!=="cim"&&(o.id=t.id),i&&V1(o)&&o.symbolLayers.forEach(a=>a.ignoreDrivers=!0),{symbol:o}}function Ok(t,e,r,i){const s=HTe(t,{},{context:i,isLabelSymbol:!1});s!=null&&(e[r]=s)}function nae(t,e,r,i){const s=HTe(t,{},{context:i,isLabelSymbol:!0});s!=null&&(e[r]=s)}function oae(t){return t instanceof uO||t instanceof hS}function HTe(t,e,r){if(t==null)return null;const{context:i,isLabelSymbol:s}=r,n=i?.origin,o=i?.messages;if(n==="web-scene"&&!oae(t)){const a=jTe(t,{retainCIM:!0,hasLabelingContext:s});return a.symbol!=null?a.symbol.write(e,i):(o?.push(new D("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in scenes. Use 3D symbology instead when working with WebScene and SceneView`,{symbol:t,context:i,error:a.error})),null)}return(n==="web-map"||n==="portal-item"&&!qxe(i?.layer))&&oae(t)?(o?.push(new D("symbol:unsupported",`Symbols of type '${t.declaredClass}' are not supported in web maps and portal items. Use 2D symbology and CIMSymbol instead when working with MapView`,{symbol:t,context:i})),null):t.write(e,i)}function qTe(t,e){return K7e(t,null,e)}const fO={types:Gxe,json:{write:{writer:Ok},origins:{"web-scene":{types:moe,write:{writer:Ok},read:{reader:sO({types:moe})}}}}},WTe={types:{base:Mu,key:"type",typeMap:{"simple-fill":uf.typeMap["simple-fill"],"picture-fill":uf.typeMap["picture-fill"],"polygon-3d":uf.typeMap["polygon-3d"]}},json:{write:{writer:Ok},origins:{"web-scene":{type:a$,write:{writer:Ok}}}}},o4={cast:t=>t==null||typeof t=="string"||typeof t=="number"?t:`${t}`,json:{type:String,write:{writer:(t,e)=>{e.value=t?.toString()}}}};var Aq;let tv=Aq=class extends he{constructor(t){super(t),this.description=null,this.label=null,this.minValue=null,this.maxValue=0,this.symbol=null}clone(){return new Aq({description:this.description,label:this.label,minValue:this.minValue,maxValue:this.maxValue,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol);return`${this.minValue}.${this.maxValue}.${t}`}};u([d({type:String,json:{write:!0}})],tv.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],tv.prototype,"label",void 0),u([d({type:Number,json:{read:{source:"classMinValue"},write:{target:"classMinValue"}}})],tv.prototype,"minValue",void 0),u([d({type:Number,json:{read:{source:"classMaxValue"},write:{target:"classMaxValue"}}})],tv.prototype,"maxValue",void 0),u([d(fO)],tv.prototype,"symbol",void 0),tv=Aq=u([R("esri.renderers.support.ClassBreakInfo")],tv);const Rk=tv;var Oq;const ZTe="log",a4="percent-of-total",l4="field",TL=new kr({esriNormalizeByLog:ZTe,esriNormalizeByPercentOfTotal:a4,esriNormalizeByField:l4}),cWe=Sn(Rk);let yo=Oq=class extends pO(V0){constructor(t){super(t),this._compiledValueExpression={valueExpression:null,compiledFunction:null},this.backgroundFillSymbol=null,this.classBreakInfos=null,this.defaultLabel=null,this.defaultSymbol=null,this.field=null,this.isMaxInclusive=!0,this.legendOptions=null,this.normalizationField=null,this.normalizationTotal=null,this.type="class-breaks",this.valueExpression=null,this.valueExpressionTitle=null,this._set("classBreakInfos",[])}readClassBreakInfos(t,e,r){if(!Array.isArray(t))return;let i=e.minValue;return t.map(s=>{const n=new Rk;return n.read(s,r),n.minValue==null&&(n.minValue=i),n.maxValue==null&&(n.maxValue=n.minValue),i=n.maxValue,n})}writeClassBreakInfos(t,e,r,i){const s=t.map(n=>n.write({},i));this._areClassBreaksConsecutive()&&s.forEach(n=>delete n.classMinValue),e[r]=s}castField(t){return t==null?t:typeof t=="function"?(K.getLogger(this).error(".field: field must be a string value"),null):qP(t)}get minValue(){return this.classBreakInfos&&this.classBreakInfos[0]&&this.classBreakInfos[0].minValue||0}get normalizationType(){let t=this._get("normalizationType");const e=!!this.normalizationField,r=this.normalizationTotal!=null;return e||r?(t=e&&l4||r&&a4||null,e&&r&&K.getLogger(this).warn("warning: both normalizationField and normalizationTotal are set!")):t!==l4&&t!==a4||(t=null),t}set normalizationType(t){this._set("normalizationType",t)}addClassBreakInfo(t,e,r){let i=null;i=typeof t=="number"?new Rk({minValue:t,maxValue:e,symbol:jxe(r)}):cWe(re(t)),this.classBreakInfos.push(i),this.classBreakInfos.length===1&&this.notifyChange("minValue")}removeClassBreakInfo(t,e){const r=this.classBreakInfos.length;for(let i=0;i<r;i++){const s=[this.classBreakInfos[i].minValue,this.classBreakInfos[i].maxValue];if(s[0]===t&&s[1]===e){this.classBreakInfos.splice(i,1);break}}}getBreakIndex(t,e){return!this.valueExpression||e!=null&&e.arcade!=null||K.getLogger(this).warn(""),this.valueExpression?this._getBreakIndexForExpression(t,e):this._getBreakIndexForField(t)}async getClassBreakInfo(t,e){let r=e;!this.valueExpression||e!=null&&e.arcade!=null||(r={...r,arcade:await If()});const i=this.getBreakIndex(t,r);return i!==-1?this.classBreakInfos[i]:null}getSymbol(t,e){if(this.valueExpression&&(e==null||e.arcade==null))return void K.getLogger(this).error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this.getBreakIndex(t,e);return r>-1?this.classBreakInfos[r].symbol:this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(e==null||e.arcade==null)){const s=await If(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this.getBreakIndex(t,r);return i>-1?this.classBreakInfos[i].symbol:this.defaultSymbol}getSymbols(){const t=[];return this.classBreakInfos.forEach(e=>{e.symbol&&t.push(e.symbol)}),this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=`${this.normalizationField}.${this.normalizationType}.${this.normalizationTotal}`;return`${t}.${e}.${this.classBreakInfos.reduce((i,s)=>i+s.getMeshHash(),"")}.${r}.${this.field}.${this.valueExpression}`}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}clone(){return new Oq({field:this.field,backgroundFillSymbol:this.backgroundFillSymbol&&this.backgroundFillSymbol.clone(),defaultLabel:this.defaultLabel,defaultSymbol:this.defaultSymbol&&this.defaultSymbol.clone(),valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,classBreakInfos:re(this.classBreakInfos),isMaxInclusive:this.isMaxInclusive,normalizationField:this.normalizationField,normalizationTotal:this.normalizationTotal,normalizationType:this.normalizationType,visualVariables:re(this.visualVariables),legendOptions:re(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Ec(t,e,this.valueExpression)];gh(t,e,this.field),gh(t,e,this.normalizationField),await Promise.all(r)}_getBreakIndexForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=e??{},{valueExpression:o}=this;let a=this._compiledValueExpression.valueExpression===o?this._compiledValueExpression.compiledFunction:null;const l=n.arcadeUtils;if(!a){const h=l.createSyntaxTree(o);a=l.createFunction(h),this._compiledValueExpression.compiledFunction=a}this._compiledValueExpression.valueExpression=o;const c=l.executeFunction(a,l.createExecContext(t,l.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._getBreakIndexfromInfos(c)}_getBreakIndexForField(t){const e=this.field,r=t.attributes,i=this.normalizationType;let s=parseFloat(r[e]);if(i){const n=this.normalizationTotal,o=parseFloat(this.normalizationField?r[this.normalizationField]:void 0);if(i===ZTe)s=Math.log(s)*Math.LOG10E;else if(i!==a4||n==null||isNaN(n)){if(i===l4&&!isNaN(o)){if(isNaN(s)||isNaN(o))return-1;s/=o}}else s=s/n*100}return this._getBreakIndexfromInfos(s)}_getBreakIndexfromInfos(t){const e=this.isMaxInclusive;if(t!=null&&typeof t=="number"&&!isNaN(t))for(let r=0;r<this.classBreakInfos.length;r++){const i=[this.classBreakInfos[r].minValue,this.classBreakInfos[r].maxValue];if(i[0]<=t&&(e?t<=i[1]:t<i[1]))return r}return-1}_areClassBreaksConsecutive(){const t=this.classBreakInfos,e=t.length;for(let r=1;r<e;r++)if(t[r-1].maxValue!==t[r].minValue)return!1;return!0}};u([d(WTe)],yo.prototype,"backgroundFillSymbol",void 0),u([d({type:[Rk]})],yo.prototype,"classBreakInfos",void 0),u([Ae("classBreakInfos")],yo.prototype,"readClassBreakInfos",null),u([Ve("classBreakInfos")],yo.prototype,"writeClassBreakInfos",null),u([d({type:String,json:{write:!0}})],yo.prototype,"defaultLabel",void 0),u([d(fO)],yo.prototype,"defaultSymbol",void 0),u([d({type:String,json:{write:!0}})],yo.prototype,"field",void 0),u([or("field")],yo.prototype,"castField",null),u([d({type:Boolean})],yo.prototype,"isMaxInclusive",void 0),u([d({type:CC,json:{write:!0}})],yo.prototype,"legendOptions",void 0),u([d({type:Number,readOnly:!0,value:null,json:{read:!1,write:{overridePolicy(){return this.classBreakInfos.length!==0&&this._areClassBreaksConsecutive()?{enabled:!0}:{enabled:!1}}}}})],yo.prototype,"minValue",null),u([d({type:String,json:{write:!0}})],yo.prototype,"normalizationField",void 0),u([d({type:Number,cast:t=>wd(t),json:{write:!0}})],yo.prototype,"normalizationTotal",void 0),u([d({type:TL.apiValues,value:null,json:{type:TL.jsonValues,read:TL.read,write:TL.write}})],yo.prototype,"normalizationType",null),u([nt({classBreaks:"class-breaks"})],yo.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],yo.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],yo.prototype,"valueExpressionTitle",void 0),yo=Oq=u([R("esri.renderers.ClassBreaksRenderer")],yo);const XTe=yo,c4=-3;var Wy;(function(t){t[t.ALL=0]="ALL",t[t.SOME=1]="SOME"})(Wy||(Wy={}));let uWe=class{constructor(e,r,i){this.name=e,this._storage=r,this.id=hWe+++":",this.size=0,this.maxSize=0,this._removeFunc=!1,this._hit=0,this._miss=0,this._storage.register(this),i&&(this._storage.registerRemoveFunc(this.id,i),this._removeFunc=!0)}destroy(){this._storage.clear(this),this._removeFunc&&this._storage.deregisterRemoveFunc(this.id),this._storage.deregister(this),this._storage=null}get hitRate(){return this._hit/(this._hit+this._miss)}get sizeAll(){return this._storage.size}resetHitRate(){this._hit=this._miss=0}put(e,r,i,s=0){this._storage.put(this,e,r,i,s)}get(e){const r=this._storage.get(this,e);return r===void 0?++this._miss:++this._hit,r}pop(e){const r=this._storage.pop(this,e);return r===void 0?++this._miss:++this._hit,r}updateSize(e,r,i){this._storage.updateSize(this,e,r,i)}clear(){this._storage.clear(this)}clearAll(){this._storage.clearAll()}get performanceInfo(){return this._storage.performanceInfo}resetStats(){this._storage.resetStats()}},YTe=class{get size(){return this._size}constructor(e=10485760){this._maxSize=e,this._db=new Map,this._size=0,this._hit=0,this._miss=0,this._removeFuncs=new qt,this._users=new qt}destroy(){this.clearAll(),this._removeFuncs.clear(),this._users.clear(),this._db=null}register(e){this._users.push(e)}deregister(e){this._users.removeUnordered(e)}registerRemoveFunc(e,r){this._removeFuncs.push([e,r])}deregisterRemoveFunc(e){this._removeFuncs.filterInPlace(r=>r[0]!==e)}get maxSize(){return this._maxSize}set maxSize(e){this._maxSize=Math.max(e,0),this._checkSizeLimits()}put(e,r,i,s,n){r=e.id+r;const o=this._db.get(r);if(o&&(this._size-=o.size,e.size-=o.size,this._db.delete(r),o.entry!==i&&this._notifyRemove(r,o.entry,Wy.ALL)),s>this._maxSize)return void this._notifyRemove(r,i,Wy.ALL);if(i===void 0)return void console.warn("Refusing to cache undefined entry ");if(!s||s<0)return void console.warn("Refusing to cache entry with invalid size "+s);const a=1+Math.max(n,c4)-c4;this._db.set(r,{entry:i,size:s,lifetime:a,lives:a}),this._size+=s,e.size+=s,this._checkSizeLimits()}updateSize(e,r,i,s){r=e.id+r;const n=this._db.get(r);if(n&&n.entry===i){for(this._size-=n.size,e.size-=n.size;s>this._maxSize;){const o=this._notifyRemove(r,i,Wy.SOME);if(!(o!=null&&o>0))return void this._db.delete(r);s=o}n.size=s,this._size+=s,e.size+=s,this._checkSizeLimits()}}pop(e,r){r=e.id+r;const i=this._db.get(r);if(i)return this._size-=i.size,e.size-=i.size,this._db.delete(r),++this._hit,i.entry;++this._miss}get(e,r){r=e.id+r;const i=this._db.get(r);if(i!==void 0)return this._db.delete(r),i.lives=i.lifetime,this._db.set(r,i),++this._hit,i.entry;++this._miss}get performanceInfo(){const e={Size:Math.round(this._size/1048576)+"/"+Math.round(this._maxSize/1048576)+"MB","Hit rate":Math.round(100*this._getHitRate())+"%",Entries:this._db.size.toString()},r={},i=new Array;this._db.forEach((o,a)=>{const l=o.lifetime;i[l]=(i[l]||0)+o.size,this._users.forAll(c=>{const{id:h,name:p}=c;if(a.startsWith(h)){const f=r[p]||0;r[p]=f+o.size}})});const s={};this._users.forAll(o=>{const a=o.name;if("hitRate"in o&&typeof o.hitRate=="number"&&!isNaN(o.hitRate)&&o.hitRate>0){const l=r[a]||0;r[a]=l,s[a]=Math.round(100*o.hitRate)+"%"}else s[a]="0%"});const n=Object.keys(r);n.sort((o,a)=>r[a]-r[o]),n.forEach(o=>e[o]=Math.round(r[o]/2**20)+"MB / "+s[o]);for(let o=i.length-1;o>=0;--o){const a=i[o];a&&(e["Priority "+(o+c4-1)]=Math.round(a/this._size*100)+"%")}return e}resetStats(){this._hit=this._miss=0,this._users.forAll(e=>e.resetHitRate())}clear(e){const r=e.id;this._db.forEach((i,s)=>{s.startsWith(r)&&(this._size-=i.size,this._db.delete(s),this._notifyRemove(s,i.entry,Wy.ALL))}),e.size=0}clearAll(){this._db.forEach((e,r)=>this._notifyRemove(r,e.entry,Wy.ALL)),this._users.forEach(e=>e.size=0),this._size=0,this._db.clear()}_getHitRate(){return this._hit/(this._hit+this._miss)}_notifyRemove(e,r,i){let s;return this._removeFuncs.some(n=>{if(e.startsWith(n[0])){const o=n[1](r,i);return typeof o=="number"&&(s=o),!0}return!1}),s}_checkSizeLimits(){if(this._size>this._maxSize){for(const[e,r]of this._db)if(this._purgeItem(e,r),this._size<=.9*this.maxSize)return}this._users.forEach(e=>{if(e.maxSize>0&&e.size>e.maxSize){for(const[r,i]of this._db)if(r.startsWith(e.id)&&(this._purgeItem(r,i,e),e.size<=.9*e.maxSize))return}})}_purgeItem(e,r,i=this._users.find(s=>e.startsWith(s.id))){if(this._db.delete(e),r.lives<=1){this._size-=r.size,i&&(i.size-=r.size);const s=this._notifyRemove(e,r.entry,Wy.SOME);s!=null&&s>0&&(this._size+=s,i&&(i.size+=s),r.lives=r.lifetime,r.size=s,this._db.set(e,r))}else--r.lives,this._db.set(e,r)}},hWe=0,JTe=class{constructor(e,r){this._storage=new YTe,this.id="",this.name="",this.size=0,this._storage.maxSize=e,this._storage.register(this),r&&this._storage.registerRemoveFunc("",r)}destroy(){this._storage.deregister(this),this._storage.destroy()}put(e,r,i=1){this._storage.put(this,e,r,i,1)}pop(e){return this._storage.pop(this,e)}get(e){return this._storage.get(this,e)}clear(){this._storage.clearAll()}get maxSize(){return this._storage.maxSize}set maxSize(e){this._storage.maxSize=e}resetHitRate(){}},DT=class{constructor(e,r,i=""){this.major=e,this.minor=r,this._context=i}lessThan(e,r){return this.major<e||e===this.major&&this.minor<r}since(e,r){return!this.lessThan(e,r)}validate(e){if(this.major!==e.major){const r=this._context&&this._context+":",i=this._context&&this._context+" ";throw new D(r+"unsupported-version",`Required major ${i}version is '${this.major}', but got '\${version.major}.\${version.minor}'`,{version:e})}}clone(){return new DT(this.major,this.minor,this._context)}static parse(e,r=""){const[i,s]=e.split("."),n=/^\s*\d+\s*$/;if(!i||!i.match||!n.test(i))throw new D((r&&r+":")+"invalid-version","Expected major version to be a number, but got '${version}'",{version:e});if(!s||!s.match||!n.test(s))throw new D((r&&r+":")+"invalid-version","Expected minor version to be a number, but got '${version}'",{version:e});const o=parseInt(i,10),a=parseInt(s,10);return new DT(o,a,r)}};function dWe(t){return t.type==="date"||t.type==="esriFieldTypeDate"||t.type==="date-only"||t.type==="esriFieldTypeDateOnly"||t.type==="timestamp-offset"||t.type==="esriFieldTypeTimestampOffset"}function aae(t){return t.type==="oid"||t.type==="esriFieldTypeOID"}function lae(t){return t.type==="global-id"||t.type==="esriFieldTypeGlobalID"}let BK=class{constructor(e=[]){if(this.fields=[],this._fieldsMap=new Map,this._normalizedFieldsMap=new Map,this._dateFieldsSet=new Set,this._numericFieldsSet=new Set,this.dateFields=[],this.numericFields=[],this._requiredFields=null,!e)return;this.fields=e;const r=[];for(const i of e){const s=i?.name,n=uae(i?.name);if(s&&n){const o=cae(s);this._fieldsMap.set(s,i),this._fieldsMap.set(o,i),this._normalizedFieldsMap.set(n,i),r.push(o),dWe(i)?(this.dateFields.push(i),this._dateFieldsSet.add(i)):eT(i)&&(this._numericFieldsSet.add(i),this.numericFields.push(i)),aae(i)||lae(i)||(i.editable=i.editable==null||!!i.editable,i.nullable=i.nullable==null||!!i.nullable)}}r.sort(),this.uid=r.join(",")}destroy(){this._fieldsMap.clear()}get requiredFields(){if(!this._requiredFields){this._requiredFields=[];for(const e of this.fields)aae(e)||lae(e)||e.nullable||dze(e)!==void 0||this._requiredFields.push(e)}return this._requiredFields}has(e){return this.get(e)!=null}get(e){if(!e)return;let r=this._fieldsMap.get(e);return r||(r=this._fieldsMap.get(cae(e))??this._normalizedFieldsMap.get(uae(e)),r&&this._fieldsMap.set(e,r),r)}isDateField(e){return this._dateFieldsSet.has(this.get(e))}isNumericField(e){return this._numericFieldsSet.has(this.get(e))}normalizeFieldName(e){const r=this.get(e);if(r)return r.name??void 0}};function cae(t){return t.trim().toLowerCase()}function uae(t){return Y9e(t)?.toLowerCase()??""}const hae="esri.renderers.support.DictionaryLoader",pWe={type:"CIMSimpleLineCallout",lineSymbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",width:.5,color:[0,0,0,255]}]}};let GK=class{constructor(e,r,i){this.config=null,this.fieldMap=null,this.url=null,this._ongoingRequests=new Map,this._symbolCache=new JTe(100),this._dictionaryVersion=null,this._fieldIndex=null,this._dictionaryPromise=null,this.url=e,this.config=r,this.fieldMap=i}getSymbolFields(){return this._symbolFields}async getSymbolAsync(e,r){let i;this._dictionaryPromise||(this._dictionaryPromise=this.fetchResources(r));try{i=await this._dictionaryPromise}catch(g){if(ws(g))return this._dictionaryPromise=null,null}const s=this._dictionaryVersion&&this._dictionaryVersion.since(4,0),n={};if(this.fieldMap)for(const g of this._symbolFields){const _=this._getFieldName(this.fieldMap[g]);n[g]=_?s?e.attributes[_]:""+e.attributes[_]:""}let o=null;try{o=i?.(n,r)}catch{return null}if(!o||typeof o!="string")return null;const a=BJ(o).toString(),l=this._symbolCache.get(a);if(l)return l.catch(()=>{this._symbolCache.pop(a)}),l;const c=o.split(";"),h=[],p=[];for(const g of c)if(g)if(g.includes("po:")){const _=g.substr(3).split("|");if(_.length===3){const v=_[0],b=_[1];let x=_[2];if(b==="DashTemplate")x=x.split(" ").map(T=>Number(T));else if(b==="Color"){const T=new Le(x).toRgba();x=[T[0],T[1],T[2],255*T[3]]}else x=Number(x);p.push({primitiveName:v,propertyName:b,value:x})}}else if(g.includes("|")){for(const _ of g.split("|"))if(this._itemNames.has(_)){h.push(_);break}}else this._itemNames.has(g)&&h.push(g);const f=e.geometry==null||!e.geometry.hasZ&&e.geometry.type==="point",m=this._cimPartsToCIMSymbol(h,p,f,r);return this._symbolCache.put(a,m,1),m}async fetchResources(e){if(this._dictionaryPromise)return this._dictionaryPromise;if(!this.url)return void K.getLogger(hae).error("no valid URL!");const r=Lt(this.url+"/resources/styles/dictionary-info.json",{responseType:"json",query:{f:"json"},signal:e!=null?e.signal:null}),[{data:i}]=await Promise.all([r,If()]);if(!i)throw this._dictionaryPromise=null,new D("esri.renderers.DictionaryRenderer","Bad dictionary data!");const{authoringInfo:s,dictionary_version:n,expression:o,itemsNames:a}=i,l=o;let c=!1;n&&(this._dictionaryVersion=DT.parse(n),c=this._dictionaryVersion.since(4,0)),this._refSymbolUrlTemplate=this.url+"/"+i.cimRefTemplateUrl,this._itemNames=new Set(a),this._symbolFields=s.symbol;const h={};if(this.config){const m=this.config;for(const g in m)h[g]=m[g]}if(s.configuration)for(const m of s.configuration)h.hasOwnProperty(m.name)||(h[m.name]=m.value);const p=[];if(e!=null&&e.fields&&this.fieldMap)for(const m of this._symbolFields){const g=this.fieldMap[m],_=e.fields.filter(v=>v.name.toLowerCase()===g?.toLowerCase());_.length>0&&p.push({..._[0],type:c?_[0].type:"esriFieldTypeString"})}p.length>0&&(this._fieldIndex=new BK(p));const f=W9e(l,e!=null?e.spatialReference:null,p,h).then(m=>{const g={scale:0};return(_,v)=>{if(m==null)return null;const b=m.repurposeFeature({geometry:null,attributes:_});return g.scale=v!=null?v.scale??void 0:void 0,m.evaluate({$feature:b,$view:g},m.services)}}).catch(m=>(K.getLogger(hae).error("Creating dictinoary expression failed:",m),null));return this._dictionaryPromise=f,f}async _cimPartsToCIMSymbol(e,r,i,s){const n=new Array(e.length);for(let l=0;l<e.length;l++)n[l]=this._getSymbolPart(e[l],s);const o=await Promise.all(n),a=this.fieldMap;if(a)for(const l of o)QTe(l,a);return new lO({data:this._combineSymbolParts(o,r,i)})}async _getSymbolPart(e,r){if(this._ongoingRequests.has(e))return this._ongoingRequests.get(e).then(n=>n.data);const i=this._refSymbolUrlTemplate.replaceAll(/\{itemName\}/gi,e),s=Lt(i,{responseType:"json",query:{f:"json"},...r});this._ongoingRequests.set(e,s);try{return(await s).data}catch(n){throw this._ongoingRequests.delete(e),n}}_combineSymbolParts(e,r,i){if(!e||e.length===0)return null;const s={...e[0]};if(e.length>1){s.symbolLayers=[];for(const n of e){const o=n;s.symbolLayers.unshift(...o.symbolLayers)}}return i&&(s.callout=pWe),{type:"CIMSymbolReference",symbol:s,primitiveOverrides:r}}_getFieldName(e){if(this._fieldIndex!==null){const r=this._fieldIndex.get(e);return r?r.name:e}return e}};function QTe(t,e){if(!t)return;const r=t.symbolLayers;if(!r)return;let i=r.length;for(;i--;){const s=r[i];s&&s.enable!==!1&&s.type==="CIMVectorMarker"&&fWe(s,e)}}function fWe(t,e){const r=t.markerGraphics;if(r)for(const i of r){if(!i)continue;const s=i.symbol;if(s)switch(s.type){case"CIMPointSymbol":case"CIMLineSymbol":case"CIMPolygonSymbol":QTe(s,e);break;case"CIMTextSymbol":s.fieldMap=e}}}const I5t=Object.freeze(Object.defineProperty({__proto__:null,DictionaryLoader:GK},Symbol.toStringTag,{value:"Module"}));var Rq;let Mp=Rq=class extends pO(V0){constructor(t){super(t),this.config=null,this.fieldMap=null,this.scaleExpression=null,this.scaleExpressionTitle=null,this.url=null,this.type="dictionary"}get _loader(){return new GK(this.url,this.config,this.fieldMap)}writeData(t,e){t&&(e.scalingExpressionInfo={expression:t,returnType:"number"})}writeVisualVariables(t,e,r,i){i?.origin||super.writeVisualVariables(t,e,r,i)}clone(){return new Rq({config:re(this.config),scaleExpression:this.scaleExpression,scaleExpressionTitle:this.scaleExpressionTitle,fieldMap:re(this.fieldMap),url:re(this.url),visualVariables:re(this.visualVariables)})}async getSymbolAsync(t,e){return this._loader.getSymbolAsync(t,e)}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e),this.scaleExpression&&await Ec(t,e,this.scaleExpression);for(const r in this.fieldMap){const i=this.fieldMap[r];e.has(i)&&t.add(i)}}get arcadeRequired(){return!0}getSymbol(){return null}getSymbols(){return[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return`${this.url}-${JSON.stringify(this.fieldMap)}`}getSymbolFields(){return this._loader.getSymbolFields()}};u([d({type:GK})],Mp.prototype,"_loader",null),u([d({type:Object,json:{read:{source:"configuration"},write:{target:"configuration"}}})],Mp.prototype,"config",void 0),u([d({type:Object,json:{write:!0}})],Mp.prototype,"fieldMap",void 0),u([d({type:String,json:{read:{source:"scalingExpressionInfo.expression"},write:!0}})],Mp.prototype,"scaleExpression",void 0),u([Ve("scaleExpression")],Mp.prototype,"writeData",null),u([d({type:String,json:{read:{source:"scalingExpressionInfo.title"},write:{target:"scalingExpressionInfo.title",overridePolicy(t){return{enabled:!!t&&!!this.scaleExpression}}}}})],Mp.prototype,"scaleExpressionTitle",void 0),u([d({type:String,json:{write:!0}})],Mp.prototype,"url",void 0),u([Ve("visualVariables")],Mp.prototype,"writeVisualVariables",null),Mp=Rq=u([R("esri.renderers.DictionaryRenderer")],Mp);const mWe=Mp;var Mq;let vy=Mq=class extends he{constructor(t){super(t),this.color=null,this.field=null,this.label=null,this.valueExpression=null,this.valueExpressionTitle=null}castField(t){return t==null?t:typeof t=="function"?(K.getLogger(this).error(".field: field must be a string value"),null):qP(t)}getAttributeHash(){return`${this.field}-${this.valueExpression}`}clone(){return new Mq({color:this.color&&this.color.clone(),field:this.field,label:this.label,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:Le,json:{type:[Number],write:!0}})],vy.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],vy.prototype,"field",void 0),u([or("field")],vy.prototype,"castField",null),u([d({type:String,json:{write:!0}})],vy.prototype,"label",void 0),u([d({type:String,json:{write:!0}})],vy.prototype,"valueExpression",void 0),u([d({type:String,json:{write:!0}})],vy.prototype,"valueExpressionTitle",void 0),vy=Mq=u([R("esri.renderers.support.AttributeColorInfo")],vy);const KTe=vy;var Iq;let u4=Iq=class extends he{constructor(){super(...arguments),this.unit=null}clone(){return new Iq({unit:this.unit})}};u([d({type:String,json:{write:!0}})],u4.prototype,"unit",void 0),u4=Iq=u([R("esri.renderers.support.DotDensityLegendOptions")],u4);const gWe=u4;var Pq;let Wc=Pq=class extends pO(V0){constructor(t){super(t),this.attributes=null,this.backgroundColor=new Le([0,0,0,0]),this.dotBlendingEnabled=!0,this.dotShape="square",this.dotSize=1,this.legendOptions=null,this.outline=new Iu,this.dotValue=null,this.referenceScale=null,this.seed=1,this.type="dot-density"}calculateDotValue(t){if(this.referenceScale==null)return this.dotValue;const e=t/this.referenceScale*this.dotValue;return e<1?1:e}getSymbol(){return new U0({outline:this.outline})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}getAttributeHash(){return this.attributes?.reduce((t,e)=>t+e.getAttributeHash(),"")??""}getMeshHash(){return JSON.stringify(this.outline)}clone(){return new Pq({attributes:re(this.attributes),backgroundColor:re(this.backgroundColor),dotBlendingEnabled:re(this.dotBlendingEnabled),dotShape:re(this.dotShape),dotSize:re(this.dotSize),dotValue:re(this.dotValue),legendOptions:re(this.legendOptions),outline:re(this.outline),referenceScale:re(this.referenceScale),visualVariables:re(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}getControllerHash(){return`${this.attributes?.map(e=>e.field||e.valueExpression||"")}-${this.outline&&JSON.stringify(this.outline.toJSON())||""}`}async collectRequiredFields(t,e){await this.collectVVRequiredFields(t,e);for(const r of this.attributes??[])r.valueExpression&&await Ec(t,e,r.valueExpression),r.field&&t.add(r.field)}};u([d({type:[KTe],json:{write:!0}})],Wc.prototype,"attributes",void 0),u([d({type:Le,json:{write:!0}})],Wc.prototype,"backgroundColor",void 0),u([d({type:Boolean,json:{write:!0}})],Wc.prototype,"dotBlendingEnabled",void 0),u([d({type:String,json:{write:!1}})],Wc.prototype,"dotShape",void 0),u([d({type:Number,json:{write:!0}})],Wc.prototype,"dotSize",void 0),u([d({type:gWe,json:{write:!0}})],Wc.prototype,"legendOptions",void 0),u([d({type:Iu,json:{default:null,write:!0}})],Wc.prototype,"outline",void 0),u([d({type:Number,json:{write:!0}})],Wc.prototype,"dotValue",void 0),u([d({type:Number,json:{write:!0}})],Wc.prototype,"referenceScale",void 0),u([d({type:Number,json:{write:!0}})],Wc.prototype,"seed",void 0),u([nt({dotDensity:"dot-density"})],Wc.prototype,"type",void 0),Wc=Pq=u([R("esri.renderers.DotDensityRenderer")],Wc);const yWe=Wc;var $q;let O3=$q=class extends he{constructor(t){super(t),this.color=null,this.ratio=null}clone(){return new $q({color:this.color,ratio:this.ratio})}};u([d({type:Le,json:{type:[Ki],default:null,write:!0}})],O3.prototype,"color",void 0),u([d({type:Number,json:{write:!0}})],O3.prototype,"ratio",void 0),O3=$q=u([R("esri.renderers.support.HeatmapColorStop")],O3);const h4=O3;let iE=class extends rs(he){constructor(){super(...arguments),this.minLabel=null,this.maxLabel=null,this.title=null}};u([d({type:String,json:{write:!0}})],iE.prototype,"minLabel",void 0),u([d({type:String,json:{write:!0}})],iE.prototype,"maxLabel",void 0),u([d({type:String,json:{write:!0}})],iE.prototype,"title",void 0),iE=u([R("esri.renderers.support.HeatmapLegendOptions")],iE);function Qt(){return[0,0,0,0]}function h$(t){return[t[0],t[1],t[2],t[3]]}function Vt(t,e,r,i){return[t,e,r,i]}function jK(t){const e=Qt(),r=Math.min(4,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function eSe(t,e){return new Float64Array(t,e,4)}function tSe(){return Qt()}function rSe(){return Vt(1,1,1,1)}function iSe(){return Vt(1,0,0,0)}function sSe(){return Vt(0,1,0,0)}function nSe(){return Vt(0,0,1,0)}function oSe(){return Vt(0,0,0,1)}const ng=tSe(),Od=rSe(),_We=iSe(),vWe=sSe(),bWe=nSe(),wWe=oSe();Object.freeze(Object.defineProperty({__proto__:null,ONES:Od,UNIT_W:wWe,UNIT_X:_We,UNIT_Y:vWe,UNIT_Z:bWe,ZEROS:ng,clone:h$,create:Qt,createView:eSe,fromArray:jK,fromValues:Vt,ones:rSe,unitW:oSe,unitX:iSe,unitY:sSe,unitZ:nSe,zeros:tSe},Symbol.toStringTag,{value:"Module"}));const HK=2.4;function xWe(t){return Fl(t*HK)}function TWe(t){return vi(t)/HK}function SWe(t,e,r,i){let{color:s,ratio:n}=e,{color:o,ratio:a}=r;a===n&&(a===1?n-=1e-6:a+=1e-6);const l=ye((i-n)/(a-n),0,1);k6(t,s.toArray(),o.toArray(),l)}function $5t(t){const r=new Uint8ClampedArray(2048);if(t=t.filter(({ratio:a})=>a>=0&&a<=1).sort((a,l)=>a.ratio-l.ratio).map(({color:a,ratio:l})=>({color:a,ratio:Math.max(l,.001)})),t.length<1)return r;let i=t[0],s=t[0],n=1;const o=Qt();for(let a=0;a<512;a++){const l=(a+.5)/512;for(;l>s.ratio&&n<t.length;)i=s,s=t[n++];SWe(o,i,s,l),r.set(o,4*a)}return r}function L5t(t,e,r,i){const{radius:s,fieldOffset:n,field:o}=e,a=Math.round(vi(s)),l=new Float64Array(r*i);let c,h=Number.NEGATIVE_INFINITY;const p=CWe(o,n),f=new Set;for(const m of t){const g=m.getCursor();for(;g.next();){const _=g.getObjectId();if(f.has(_))continue;f.add(_);const v=g.readLegacyPointGeometry(),b=128;if(v.x<-b||v.x>=r+b||v.y<-b||v.y>i+b)continue;const x=+p(g),T=Math.max(0,Math.round(v.x)-a),S=Math.max(0,Math.round(v.y)-a),O=Math.min(i,Math.round(v.y)+a),A=Math.min(r,Math.round(v.x)+a);for(let M=S;M<O;M++)for(let P=T;P<A;P++){const F=M*r+P,$=EWe(v.x-P,v.y-M,a);c=l[F]+=$*x,c>h&&(h=c)}}}return{matrix:l.buffer,max:h}}function EWe(t,e,r){const i=Math.sqrt(t**2+e**2)/r;return i>1?0:3/(Math.PI*r**2)*(1-i**2)**2}function D5t(t,e){return typeof t=="function"?t:t?typeof e=="string"?r=>-1*+r[t]:r=>+r[t]+e:()=>1}function CWe(t,e){return t!=null?typeof e=="string"?r=>-1*+r.readAttribute(t):r=>+r.readAttribute(t)+e:r=>1}var Lq;const aSe="esri.renderers.HeatmapRenderer",AWe=K.getLogger(aSe);function dae(t){if(t!=null){const{maxDensity:e,minDensity:r,radius:i}=t;if(e!=null||r!=null||i!=null){const{blurRadius:s,maxPixelIntensity:n,minPixelIntensity:o,...a}=t;return a}}return t}let Zo=Lq=class extends V0{constructor(t){super(t),this.authoringInfo=null,this.colorStops=[new h4({ratio:0,color:new Le("rgba(255, 140, 0, 0)")}),new h4({ratio:.75,color:new Le("rgba(255, 140, 0, 1)")}),new h4({ratio:.9,color:new Le("rgba(255, 0,   0, 1)")})],this.field=null,this.fieldOffset=0,this.legendOptions=null,this.maxDensity=.04,this.minDensity=0,this.radius=18,this.referenceScale=0,this.type="heatmap",this.valueExpression=null,this.valueExpressionTitle=null,this._warnedProps={blurRadius:!1,maxPixelIntensity:!1,minPixelIntensity:!1}}normalizeCtorArgs(t){return dae(t)}get blurRadius(){return TWe(this.radius)}set blurRadius(t){const e=this.maxPixelIntensity,r=this.minPixelIntensity;this._set("radius",xWe(t)),this._warnAboutDeprecatedGaussianBlurProp("blurRadius","radius"),this._set("maxDensity",e*this._pixelIntensityToDensity),this._set("minDensity",r*this._pixelIntensityToDensity)}get maxPixelIntensity(){return this.maxDensity/this._pixelIntensityToDensity}set maxPixelIntensity(t){this._set("maxDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("maxPixelIntensity","maxDensity")}get minPixelIntensity(){return this.minDensity/this._pixelIntensityToDensity}set minPixelIntensity(t){this._set("minDensity",t*this._pixelIntensityToDensity),this._warnAboutDeprecatedGaussianBlurProp("minPixelIntensity","minDensity")}get _pixelIntensityToDensity(){return 24/(HK**2*this.blurRadius**4)}_warnAboutDeprecatedGaussianBlurProp(t,e){this._warnedProps[t]||tl(this).getDefaultOrigin()==="user"&&(this._warnedProps[t]=!0,iO(()=>{Ka(AWe,t,{replacement:`${String(e)} (suggested value: ${this._get(e)})`,version:"4.24"})}))}read(t,e){t=dae(t),super.read(t,e)}getSymbol(){return new Pf}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol()]}async collectRequiredFields(t,e){const r=this.field,i=this.valueExpression;r&&typeof r=="string"&&await gh(t,e,r),i&&typeof i=="string"&&await Ec(t,e,i)}getAttributeHash(){return null}getMeshHash(){return`${JSON.stringify(this.colorStops)}.${this.blurRadius}.${this.field}`}clone(){return new Lq({authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),colorStops:re(this.colorStops),field:this.field,legendOptions:re(this.legendOptions),maxDensity:this.maxDensity,minDensity:this.minDensity,radius:this.radius,referenceScale:this.referenceScale,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle})}};u([d({type:kK,json:{write:!0,origins:{"web-scene":{write:!1,read:!1}}}})],Zo.prototype,"authoringInfo",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Zo.prototype,"blurRadius",null),u([d({type:[h4],json:{write:!0}})],Zo.prototype,"colorStops",void 0),u([d({type:String,json:{write:!0}})],Zo.prototype,"field",void 0),u([d({type:Number,json:{write:{overridePolicy:(t,e,r)=>({enabled:r==null})},origins:{"web-scene":{write:!1}}}})],Zo.prototype,"fieldOffset",void 0),u([d({type:iE,json:{write:!0}})],Zo.prototype,"legendOptions",void 0),u([d({type:Number,json:{write:!0}})],Zo.prototype,"maxDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Zo.prototype,"maxPixelIntensity",null),u([d({type:Number,json:{write:!0}})],Zo.prototype,"minDensity",void 0),u([d({type:Number,json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],Zo.prototype,"minPixelIntensity",null),u([d({type:Number,cast:oi,json:{write:!0}})],Zo.prototype,"radius",void 0),u([d({type:Number,range:{min:0},json:{default:0,write:!0}})],Zo.prototype,"referenceScale",void 0),u([nt({heatmap:"heatmap"})],Zo.prototype,"type",void 0),u([d({type:String,json:{write:!0,origins:{"web-document":{write:!1},"portal-item":{write:!1}}}})],Zo.prototype,"valueExpression",void 0),u([d({type:String})],Zo.prototype,"valueExpressionTitle",void 0),u([d({readOnly:!0})],Zo.prototype,"_pixelIntensityToDensity",null),Zo=Lq=u([R(aSe)],Zo);const lSe=Zo;let wx=class extends rs(he){constructor(){super(...arguments),this.color=new Le([0,0,0,0]),this.label=null,this.threshold=0}};u([d({type:Le,json:{write:!0}})],wx.prototype,"color",void 0),u([d({type:String,json:{write:!0}})],wx.prototype,"label",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],wx.prototype,"threshold",void 0),wx=u([R("esri.renderers.support.OthersCategory")],wx);let d4=class extends rs(he){constructor(){super(...arguments),this.title=null}};u([d({type:String,json:{write:!0}})],d4.prototype,"title",void 0),d4=u([R("esri.renderers.support.PieChartLegendOptions")],d4);let ju=class extends pO(rs(V0)){constructor(e){super(e),this.attributes=null,this.backgroundFillSymbol=null,this.defaultColor=new Le([0,0,0,0]),this.defaultLabel=null,this.holePercentage=0,this.othersCategory=new wx,this.legendOptions=null,this.outline=null,this.size=12,this.type="pie-chart"}getSymbol(){return new Pf({size:this.size?this.size/2+(this.outline?.width||0):0})}async getSymbolAsync(){return this.getSymbol()}getSymbols(){return[this.getSymbol(),this.backgroundFillSymbol].filter(Ia)}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((e,r)=>e+r.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((e,r)=>e+JSON.stringify(r),"")}async collectRequiredFields(e,r){await this.collectVVRequiredFields(e,r);for(const i of this.attributes)i.valueExpression&&await Ec(e,r,i.valueExpression),i.field&&e.add(i.field)}};u([d({type:[KTe],json:{write:!0}})],ju.prototype,"attributes",void 0),u([d({type:U0,json:{default:null,write:!0}})],ju.prototype,"backgroundFillSymbol",void 0),u([d({type:Le,json:{write:!0}})],ju.prototype,"defaultColor",void 0),u([d({type:String,json:{write:!0}})],ju.prototype,"defaultLabel",void 0),u([d({type:Number,range:{min:0,max:1},json:{write:!0}})],ju.prototype,"holePercentage",void 0),u([d({type:wx,json:{write:!0}})],ju.prototype,"othersCategory",void 0),u([d({type:d4,json:{write:!0}})],ju.prototype,"legendOptions",void 0),u([d({type:Iu,json:{default:null,write:!0}})],ju.prototype,"outline",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],ju.prototype,"size",void 0),u([nt({pieChart:"pie-chart"})],ju.prototype,"type",void 0),ju=u([R("esri.renderers.PieChartRenderer")],ju);const OWe=ju;var Dq;let Dw=Dq=class extends pO(V0){constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.type="simple"}async collectRequiredFields(t,e){await Promise.all([this.collectSymbolFields(t,e),this.collectVVRequiredFields(t,e)])}async collectSymbolFields(t,e){await Promise.all(this.getSymbols().map(r=>r.collectRequiredFields(t,e)))}getSymbol(t,e){return this.symbol}async getSymbolAsync(t,e){return this.symbol}getSymbols(){return this.symbol?[this.symbol]:[]}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){return this.getSymbols().reduce((t,e)=>t+JSON.stringify(e),"")}get arcadeRequired(){return this.arcadeRequiredForVisualVariables}clone(){return new Dq({description:this.description,label:this.label,symbol:this.symbol&&this.symbol.clone(),visualVariables:re(this.visualVariables),authoringInfo:this.authoringInfo&&this.authoringInfo.clone()})}};u([d({type:String,json:{write:!0}})],Dw.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Dw.prototype,"label",void 0),u([d(fO)],Dw.prototype,"symbol",void 0),u([nt({simple:"simple"})],Dw.prototype,"type",void 0),Dw=Dq=u([R("esri.renderers.SimpleRenderer")],Dw);const fV=Dw,RWe=["esri.Color","esri.portal.Portal","esri.symbols.support.Symbol3DAnchorPosition2D","esri.symbols.support.Symbol3DAnchorPosition3D"];function Nq(t){return t instanceof me}function pae(t){return t instanceof Ke?Object.keys(t.items):Nq(t)?tl(t).keys():t?Object.keys(t):[]}function SL(t,e){return t instanceof Ke?t.items[e]:t[e]}function MWe(t,e){return!(!Array.isArray(t)||!Array.isArray(e))&&t.length!==e.length}function jM(t){return t?t.declaredClass:null}function cSe(t,e){const r=t.diff;if(r&&typeof r=="function")return r(t,e);const i=pae(t),s=pae(e);if(i.length===0&&s.length===0)return;if(!i.length||!s.length||MWe(t,e))return{type:"complete",oldValue:t,newValue:e};const n=s.filter(p=>!i.includes(p)),o=i.filter(p=>!s.includes(p)),a=i.filter(p=>s.includes(p)&&SL(t,p)!==SL(e,p)).concat(n,o).sort(),l=jM(t);if(l&&RWe.includes(l)&&a.length)return{type:"complete",oldValue:t,newValue:e};let c;const h=Nq(t)&&Nq(e);for(const p of a){const f=SL(t,p),m=SL(e,p);let g;if((h||typeof f!="function"&&typeof m!="function")&&f!==m&&(f!=null||m!=null)){if(r&&r[p]&&typeof r[p]=="function")g=r[p]?.(f,m);else if(f instanceof Date&&m instanceof Date){if(f.getTime()===m.getTime())continue;g={type:"complete",oldValue:f,newValue:m}}else g=typeof f=="object"&&typeof m=="object"&&jM(f)===jM(m)?cSe(f,m):{type:"complete",oldValue:f,newValue:m};g!=null&&(c!=null?c.diff[p]=g:c={type:"partial",diff:{[p]:g}})}}return c}function IWe(t,e){if(t==null)return!1;const r=e.split(".");let i=t;for(const s of r){if(i.type==="complete")return!0;if(i.type!=="partial")return!1;{const n=i.diff[s];if(!n)return!1;i=n}}return!0}function U5t(t,e){for(const r of e)if(IWe(t,r))return!0;return!1}function uSe(t,e){if(typeof t!="function"&&typeof e!="function"&&(t!=null||e!=null))return t==null||e==null||typeof t=="object"&&typeof e=="object"&&jM(t)!==jM(e)?{type:"complete",oldValue:t,newValue:e}:cSe(t,e)}function EL(t){if(t==null)return!0;switch(t.type){case"complete":return!1;case"collection":{const e=t;for(const r of e.added)if(!EL(r))return!1;for(const r of e.removed)if(!EL(r))return!1;for(const r of e.changed)if(!EL(r))return!1;return!0}case"partial":for(const e in t.diff)if(!EL(t.diff[e]))return!1;return!0}}let sE=class extends rs(he){constructor(e){super(e),this.value=null,this.value2=null,this.value3=null}};u([d(o4)],sE.prototype,"value",void 0),u([d(o4)],sE.prototype,"value2",void 0),u([d(o4)],sE.prototype,"value3",void 0),sE=u([R("esri.renderers.support.UniqueValue")],sE);const AC=sE;let rv=class extends rs(he){constructor(e){super(e),this.description=null,this.label=null,this.symbol=null,this.values=null}castValues(e){if(e==null)return null;const r=typeof(e=Array.isArray(e)?e:[e])[0];return r==="string"||r==="number"?e.map(i=>new AC({value:i})):r==="object"?e[0]instanceof AC?e:e.map(i=>new AC(i)):null}};u([d({type:String,json:{write:!0}})],rv.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],rv.prototype,"label",void 0),u([d(fO)],rv.prototype,"symbol",void 0),u([d({type:[AC],json:{type:[[String]],read:{reader:t=>t?t.map(e=>new AC({value:e[0],value2:e[1],value3:e[2]})):null},write:{writer:(t,e)=>{const r=[];for(const i of t){const s=[i.value,i.value2,i.value3].filter(Ia).map(n=>n.toString());r.push(s)}e.values=r}}}})],rv.prototype,"values",void 0),u([or("values")],rv.prototype,"castValues",null),rv=u([R("esri.renderers.support.UniqueValueClass")],rv);const hSe=rv;let R3=class extends rs(he){constructor(e){super(e),this.heading=null,this.classes=null}};u([d({type:String,json:{write:!0}})],R3.prototype,"heading",void 0),u([d({type:[hSe],json:{write:!0}})],R3.prototype,"classes",void 0),R3=u([R("esri.renderers.support.UniqueValueGroup")],R3);const Fq=R3;var kq;let Nw=kq=class extends he{constructor(t){super(t),this.description=null,this.label=null,this.symbol=null,this.value=null}clone(){return new kq({value:this.value,description:this.description,label:this.label,symbol:this.symbol?this.symbol.clone():null})}getMeshHash(){const t=JSON.stringify(this.symbol&&this.symbol.toJSON());return`${this.value}.${t}`}};u([d({type:String,json:{write:!0}})],Nw.prototype,"description",void 0),u([d({type:String,json:{write:!0}})],Nw.prototype,"label",void 0),u([d(fO)],Nw.prototype,"symbol",void 0),u([d(o4)],Nw.prototype,"value",void 0),Nw=kq=u([R("esri.renderers.support.UniqueValueInfo")],Nw);const HM=Nw,PWe=()=>!!le("enable-feature:force-wosr"),G5t=()=>!!le("enable-feature:direct-3d-object-feature-layer-display"),$We=()=>le.add("enable-feature:direct-3d-object-feature-layer-display",!0,!0,!0),LWe=()=>le.add("enable-feature:direct-3d-object-feature-layer-display",!1,!0,!0),qK=()=>!!le("enable-i3s-patching"),DWe=()=>le.add("enable-i3s-patching",!0,!0,!0),NWe=()=>le.add("enable-i3s-patching",!1,!0,!0),QI=()=>!!le("enable-feature:SceneLayer-editing"),FWe=(t="i3s-patching")=>{switch(NWe(),LWe(),le.add("enable-feature:SceneLayer-editing",!0,!0,!0),t){case"feature-layer-view":$We();break;case"i3s-patching":DWe()}};FWe("i3s-patching");let H9={};async function kWe(t,e){try{return{data:(await ZK(t,e)).data,baseUrl:KJ(t),styleUrl:t}}catch(r){return xa(r),null}}function UWe(t,e,r){const i=e.portal!=null?e.portal:ao.getDefault();let s;const n=`${i.url} - ${i.user&&i.user.username} - ${t}`;return H9[n]||(H9[n]=VWe(t,i,r).then(o=>(s=o,o.fetchData())).then(o=>({data:o,baseUrl:s.itemUrl??"",styleName:t}))),H9[n]}function VWe(t,e,r){return e.load(r).then(()=>{const i=new Wm({disableExtraQuery:!0,query:`owner:${fae} AND type:${mae} AND typekeywords:"${t}"`});return e.queryItems(i,r)}).then(({results:i})=>{let s=null;const n=t.toLowerCase();if(i&&Array.isArray(i)){for(const o of i)if(o.typeKeywords?.some(l=>l.toLowerCase()===n)&&o.type===mae&&o.owner===fae){s=o;break}}if(!s)throw new D("symbolstyleutils:style-not-found",`The style '${t}' could not be found`,{styleName:t});return s.load(r)})}function WK(t,e,r){return t&&t.styleUrl!=null?kWe(t.styleUrl,r):t&&t.styleName!=null?UWe(t.styleName,e,r):Promise.reject(new D("symbolstyleutils:style-url-and-name-missing","Either styleUrl or styleName is required to resolve a style"))}function dSe(t){return t===null||t.type==="CIMSymbolReference"?t:{type:"CIMSymbolReference",symbol:t}}function pSe(t,e,r=["gltf"]){if(e==="cimRef")return t.cimRef;if(t.formatInfos&&!PWe())for(const i of r){const s=t.formatInfos.find(n=>n.type===i);if(s)return s.href}return t.webRef}function ZK(t,e){const r={responseType:"json",query:{f:"json"},...e};return Lt(Dd(t),r)}const fae="esri_en",mae="Style",zWe="https://cdn.arcgis.com/sharing/rest/content/items/220936cc6ed342c9937abd8f180e7d1e/resources/styles/cim/{SymbolName}.json?f=json";var M3;const fSe="esri.renderers.UniqueValueRenderer",d_=K.getLogger(fSe),gae="uvInfos-watcher",yae="uvGroups-watcher",BWe=",",GWe=Sn(HM);function jWe(t){const{field1:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueInfos:n,valueExpression:o}=t,a=!(!e||!r);return[{classes:(n??[]).map(l=>{const{symbol:c,label:h,value:p,description:f}=l,[m,g,_]=a?p?.toString()?.split(s||"")||[]:[p],v=[];return(e||o)&&v.push(m),r&&v.push(g),i&&v.push(_),{symbol:c,label:h,values:[v],description:f}})}]}let Ws=M3=class extends pO(V0){constructor(t){super(t),this._valueInfoMap={},this._isDefaultSymbolDerived=!1,this._isInfosSource=null,this.type="unique-value",this.backgroundFillSymbol=null,this.orderByClassesEnabled=!1,this.valueExpressionTitle=null,this.legendOptions=null,this.defaultLabel=null,this.portal=null,this.styleOrigin=null,this.diff={uniqueValueInfos(e,r){if(!e&&!r)return;if(!e||!r)return{type:"complete",oldValue:e,newValue:r};let i=!1;const s={type:"collection",added:[],removed:[],changed:[],unchanged:[]};for(let n=0;n<r.length;n++){const o=e.find(a=>a.value===r[n].value);o?uSe(o,r[n])?(s.changed.push({type:"complete",oldValue:o,newValue:r[n]}),i=!0):s.unchanged.push({oldValue:o,newValue:r[n]}):(s.added.push(r[n]),i=!0)}for(let n=0;n<e.length;n++)r.find(o=>o.value===e[n].value)||(s.removed.push(e[n]),i=!0);return i?s:void 0}},this._set("uniqueValueInfos",[]),this._set("uniqueValueGroups",[])}get _cache(){return{compiledFunc:null}}set field(t){this._set("field",t),this._updateFieldDelimiter(),this._updateUniqueValues()}castField(t){return t==null||typeof t=="function"?t:qP(t)}writeField(t,e,r,i){typeof t=="string"?e[r]=t:i&&i.messages?i.messages.push(new D("property:unsupported","UniqueValueRenderer.field set to a function cannot be written to JSON")):d_.error(".field: cannot write field to JSON since it's not a string value")}set field2(t){this._set("field2",t),this._updateFieldDelimiter(),this._updateUniqueValues()}set field3(t){this._set("field3",t),this._updateUniqueValues()}set valueExpression(t){this._set("valueExpression",t),this._updateUniqueValues()}set defaultSymbol(t){this._isDefaultSymbolDerived=!1,this._set("defaultSymbol",t)}set fieldDelimiter(t){this._set("fieldDelimiter",t),this._updateUniqueValues()}readPortal(t,e,r){return r.portal||ao.getDefault()}readStyleOrigin(t,e,r){if(e.styleName)return Object.freeze({styleName:e.styleName});if(e.styleUrl){const i=A0(e.styleUrl,r);return Object.freeze({styleUrl:i})}}writeStyleOrigin(t,e,r,i){t.styleName?e.styleName=t.styleName:t.styleUrl&&(e.styleUrl=O0(t.styleUrl,i))}set uniqueValueGroups(t){this.styleOrigin?d_.error("#uniqueValueGroups=","Cannot modify unique value groups of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueGroups",t),this._updateInfosFromGroups(),this._isInfosSource=!1,this._watchUniqueValueGroups())}set uniqueValueInfos(t){this.styleOrigin?d_.error("#uniqueValueInfos=","Cannot modify unique value infos of a UniqueValueRenderer created from a web style"):(this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos())}addUniqueValueInfo(t,e){if(this.styleOrigin)return void d_.error("#addUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");let r;r=typeof t=="object"?GWe(t):new HM({value:t,symbol:jxe(e)}),this.uniqueValueInfos?.push(r),this._valueInfoMap[r.value]=r,this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}removeUniqueValueInfo(t){if(this.styleOrigin)return void d_.error("#removeUniqueValueInfo()","Cannot modify unique value infos of a UniqueValueRenderer created from a web style");const e=this.uniqueValueInfos;if(e){for(let r=0;r<e.length;r++)if(e[r].value===t+""){delete this._valueInfoMap[t],e.splice(r,1);break}}this._updateGroupsFromInfos(),this._isInfosSource=!0,this._watchUniqueValueInfos()}async getUniqueValueInfo(t,e){let r=e;return!this.valueExpression||e!=null&&e.arcade!=null||(r={...r,arcade:await If()}),this._getUniqueValueInfo(t,r)}getSymbol(t,e){if(this.valueExpression&&(e==null||e.arcade==null))return void d_.error("#getSymbol()","Please use getSymbolAsync if valueExpression is used");const r=this._getUniqueValueInfo(t,e);return r&&r.symbol||this.defaultSymbol}async getSymbolAsync(t,e){let r=e;if(this.valueExpression&&(r==null||r.arcade==null)){const s=await If(),{arcadeUtils:n}=s;n.hasGeometryOperations(this.valueExpression)&&await n.enableGeometryOperations(),r={...r,arcade:s}}const i=this._getUniqueValueInfo(t,r);return i&&i.symbol||this.defaultSymbol}getSymbols(){const t=[];for(const e of this.uniqueValueInfos??[])e.symbol&&t.push(e.symbol);return this.defaultSymbol&&t.push(this.defaultSymbol),t}getAttributeHash(){return this.visualVariables&&this.visualVariables.reduce((t,e)=>t+e.getAttributeHash(),"")}getMeshHash(){const t=JSON.stringify(this.backgroundFillSymbol),e=JSON.stringify(this.defaultSymbol),r=this.uniqueValueInfos?.reduce((i,s)=>i+s.getMeshHash(),"");return`${t}.${e}.${r}.${`${this.field}.${this.field2}.${this.field3}.${this.fieldDelimiter}`}.${this.valueExpression}`}clone(){const t=new M3({field:this.field,field2:this.field2,field3:this.field3,defaultLabel:this.defaultLabel,defaultSymbol:re(this.defaultSymbol),orderByClassesEnabled:this.orderByClassesEnabled,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,fieldDelimiter:this.fieldDelimiter,visualVariables:re(this.visualVariables),legendOptions:re(this.legendOptions),authoringInfo:this.authoringInfo&&this.authoringInfo.clone(),backgroundFillSymbol:re(this.backgroundFillSymbol)});this._isDefaultSymbolDerived&&(t._isDefaultSymbolDerived=!0),t._set("portal",this.portal);const e=re(this.uniqueValueInfos),r=re(this.uniqueValueGroups);return this.styleOrigin&&(t._set("styleOrigin",Object.freeze(re(this.styleOrigin))),Object.freeze(e),Object.freeze(r)),t._set("uniqueValueInfos",e),t._updateValueInfoMap(),t._set("uniqueValueGroups",r),t._isInfosSource=this._isInfosSource,t._watchUniqueValueInfosAndGroups(),t}get arcadeRequired(){return this.arcadeRequiredForVisualVariables||!!this.valueExpression}async collectRequiredFields(t,e){const r=[this.collectVVRequiredFields(t,e),this.collectSymbolFields(t,e)];await Promise.all(r)}async collectSymbolFields(t,e){const r=[...this.getSymbols().map(i=>i.collectRequiredFields(t,e)),Ec(t,e,this.valueExpression)];gh(t,e,this.field),gh(t,e,this.field2),gh(t,e,this.field3),await Promise.all(r)}populateFromStyle(){return WK(this.styleOrigin,{portal:this.portal}).then(t=>{const e=[];return this._valueInfoMap={},t&&t.data&&Array.isArray(t.data.items)&&t.data.items.forEach(r=>{const i=new hS({styleUrl:t.styleUrl,styleName:t.styleName,portal:this.portal,name:r.name});this.defaultSymbol||r.name!==t.data.defaultItem||(this.defaultSymbol=i,this._isDefaultSymbolDerived=!0);const s=new HM({value:r.name,symbol:i});e.push(s),this._valueInfoMap[r.name]=s}),this._set("uniqueValueInfos",Object.freeze(e)),this._updateGroupsFromInfos(!0),this._isInfosSource=null,this._watchUniqueValueInfos(),!this.defaultSymbol&&this.uniqueValueInfos?.length&&(this.defaultSymbol=this.uniqueValueInfos[0].symbol,this._isDefaultSymbolDerived=!0),this})}_updateFieldDelimiter(){this.field&&this.field2&&!this.fieldDelimiter&&this._set("fieldDelimiter",BWe)}_updateUniqueValues(){this._isInfosSource!=null&&(this._isInfosSource?this._updateGroupsFromInfos():this._updateInfosFromGroups())}_updateValueInfoMap(){this._valueInfoMap={};const{uniqueValueInfos:t}=this;if(t)for(const e of t)this._valueInfoMap[e.value+""]=e}_watchUniqueValueInfosAndGroups(){this._watchUniqueValueInfos(),this._watchUniqueValueGroups()}_watchUniqueValueInfos(){this.removeHandles(gae);const{uniqueValueInfos:t}=this;if(t){const e=[];for(const r of t)e.push(Q(()=>({symbol:r.symbol,value:r.value,label:r.label,description:r.description}),(i,s)=>{i!==s&&(this._updateGroupsFromInfos(),this._isInfosSource=!0)},{sync:!0}));this.addHandles(e,gae)}}_watchUniqueValueGroups(){this.removeHandles(yae);const{uniqueValueGroups:t}=this;if(t){const e=[];for(const r of t){e.push(Q(()=>({classes:r.classes}),(i,s)=>{i!==s&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}));for(const i of r.classes??[])e.push(Q(()=>({symbol:i.symbol,values:i.values,label:i.label,description:i.description}),(s,n)=>{s!==n&&(this._updateInfosFromGroups(),this._isInfosSource=!1)},{sync:!0}))}this.addHandles(e,yae)}}_updateInfosFromGroups(){if(!this.uniqueValueGroups)return this._set("uniqueValueInfos",null),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const t=[],{field:e,field2:r,field3:i,fieldDelimiter:s,uniqueValueGroups:n,valueExpression:o}=this;if(!e&&!o)return this._set("uniqueValueInfos",t),this._updateValueInfoMap(),void this._watchUniqueValueInfos();const a=!(!e||!r);for(const l of n)for(const c of l.classes??[]){const{symbol:h,label:p,values:f,description:m}=c;for(const g of f??[]){const{value:_,value2:v,value3:b}=g,x=[_];r&&x.push(v),i&&x.push(b);const T=a?x.join(s||""):x[0];t.push(new HM({symbol:h,label:p,value:T,description:m}))}}this._set("uniqueValueInfos",t),this._updateValueInfoMap(),this._watchUniqueValueInfos()}_updateGroupsFromInfos(t=!1){if(!this.uniqueValueInfos)return this._set("uniqueValueGroups",null),void this._watchUniqueValueGroups();const{field:e,field2:r,valueExpression:i,fieldDelimiter:s,uniqueValueInfos:n}=this;if(!e&&!i||!n.length)return this._set("uniqueValueGroups",[]),void this._watchUniqueValueGroups();const o=!(!e||!r),a=n.map(c=>{const{symbol:h,label:p,value:f,description:m}=c,[g,_,v]=o?f?.toString()?.split(s||"")||[]:[f];return new hSe({symbol:h,label:p,description:m,values:[new AC({value:g,value2:_,value3:v})]})}),l=[new Fq({classes:a})];t&&Object.freeze(l),this._set("uniqueValueGroups",l),this._watchUniqueValueGroups()}_getUniqueValueInfo(t,e){return this.valueExpression?this._getUnqiueValueInfoForExpression(t,e):this._getUnqiueValueInfoForFields(t)}_getUnqiueValueInfoForExpression(t,e){const{viewingMode:r,scale:i,spatialReference:s,arcade:n}=e??{};let o=this._cache.compiledFunc;const a=n.arcadeUtils;if(!o){const c=a.createSyntaxTree(this.valueExpression);o=a.createFunction(c),this._cache.compiledFunc=o}const l=a.executeFunction(o,a.createExecContext(t,a.getViewInfo({viewingMode:r,scale:i,spatialReference:s})));return this._valueInfoMap[l+""]}_getUnqiueValueInfoForFields(t){const e=this.field,r=t.attributes;let i;if(typeof e!="function"&&this.field2){const s=this.field2,n=this.field3,o=[];e&&o.push(r[e]),s&&o.push(r[s]),n&&o.push(r[n]),i=o.join(this.fieldDelimiter||"")}else typeof e=="function"?i=e(t):e&&(i=r[e]);return this._valueInfoMap[i+""]}static fromPortalStyle(t,e){const r=new M3(e&&e.properties);r._set("styleOrigin",Object.freeze({styleName:t})),r._set("portal",e&&e.portal||ao.getDefault());const i=r.populateFromStyle();return i.catch(s=>{d_.error(`#fromPortalStyle('${t}'[, ...])`,"Failed to create unique value renderer from style name",s)}),i}static fromStyleUrl(t,e){const r=new M3(e&&e.properties);r._set("styleOrigin",Object.freeze({styleUrl:t}));const i=r.populateFromStyle();return i.catch(s=>{d_.error(`#fromStyleUrl('${t}'[, ...])`,"Failed to create unique value renderer from style URL",s)}),i}};u([d({readOnly:!0})],Ws.prototype,"_cache",null),u([nt({uniqueValue:"unique-value"})],Ws.prototype,"type",void 0),u([d(WTe)],Ws.prototype,"backgroundFillSymbol",void 0),u([d({value:null,json:{type:String,read:{source:"field1"},write:{target:"field1"}}})],Ws.prototype,"field",null),u([or("field")],Ws.prototype,"castField",null),u([Ve("field")],Ws.prototype,"writeField",null),u([d({type:String,value:null,json:{write:!0}})],Ws.prototype,"field2",null),u([d({type:String,value:null,json:{write:!0}})],Ws.prototype,"field3",null),u([d({type:Boolean,json:{name:"drawInClassOrder",default:!1,write:!0,origins:{"web-scene":{write:!1}}}})],Ws.prototype,"orderByClassesEnabled",void 0),u([d({type:String,value:null,json:{write:!0}})],Ws.prototype,"valueExpression",null),u([d({type:String,json:{write:!0}})],Ws.prototype,"valueExpressionTitle",void 0),u([d({type:CC,json:{write:!0}})],Ws.prototype,"legendOptions",void 0),u([d({type:String,json:{write:!0}})],Ws.prototype,"defaultLabel",void 0),u([d(Z0e({...fO},{json:{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}},origins:{"web-scene":{write:{overridePolicy(){return{enabled:!this._isDefaultSymbolDerived}}}}}}}))],Ws.prototype,"defaultSymbol",null),u([d({type:String,value:null,json:{write:!0}})],Ws.prototype,"fieldDelimiter",null),u([d({type:ao,readOnly:!0})],Ws.prototype,"portal",void 0),u([Ae("portal",["styleName"])],Ws.prototype,"readPortal",null),u([d({readOnly:!0,json:{write:{enabled:!1,overridePolicy:()=>({enabled:!0})}}})],Ws.prototype,"styleOrigin",void 0),u([Ae("styleOrigin",["styleName","styleUrl"])],Ws.prototype,"readStyleOrigin",null),u([Ve("styleOrigin",{styleName:{type:String},styleUrl:{type:String}})],Ws.prototype,"writeStyleOrigin",null),u([d({type:[Fq],json:{read:{source:["uniqueValueGroups","uniqueValueInfos"],reader:(t,e,r)=>(e.uniqueValueGroups||jWe(e)).map(i=>Fq.fromJSON(i,r))},write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Ws.prototype,"uniqueValueGroups",null),u([d({type:[HM],json:{read:!1,write:{overridePolicy(){return this.styleOrigin?{enabled:!1}:{enabled:!0}}}}})],Ws.prototype,"uniqueValueInfos",null),Ws=M3=u([R(fSe)],Ws);const XK=Ws,mV={key:"type",base:V0,typeMap:{heatmap:lSe,simple:fV,"unique-value":XK,"class-breaks":XTe,"dot-density":yWe,dictionary:mWe,"pie-chart":OWe},errorContext:"renderer"},mSe={key:"type",base:V0,typeMap:{simple:fV,"unique-value":XK,"class-breaks":XTe,heatmap:lSe},errorContext:"renderer"};function j5t(t,e){return KI(t,null,e)}const HWe=sO({types:mV});function KI(t,e,r){return t?t&&(t.styleName||t.styleUrl)&&t.type!=="uniqueValue"?(r&&r.messages&&r.messages.push(new Bd("renderer:unsupported","Only UniqueValueRenderer can be referenced from a web style, but found '"+t.type+"'",{definition:t,context:r})),null):HWe(t,e,r):null}let qWe=class gSe{constructor(){this._propertyOriginMap=new Map,this._originStores=new Array(Xj),this._values=new Map,this.multipleOriginsSupported=!0}clone(e){const r=new gSe,i=this._originStores[_r.DEFAULTS];i&&i.forEach((s,n)=>{r.set(n,re(s),_r.DEFAULTS)});for(let s=_r.SERVICE;s<Xj;s++){const n=this._originStores[s];n&&n.forEach((o,a)=>{e&&e.has(a)||r.set(a,re(o),s)})}return r}get(e,r){const i=r===void 0?this._values:this._originStores[r];return i?i.get(e):void 0}keys(e){const r=e==null?this._values:this._originStores[e];return r?[...r.keys()]:[]}set(e,r,i=_r.USER){let s=this._originStores[i];if(s||(s=new Map,this._originStores[i]=s),s.set(e,r),!this._values.has(e)||this._propertyOriginMap.get(e)<=i){const n=this._values.get(e);return this._values.set(e,r),this._propertyOriginMap.set(e,i),n!==r}return!1}delete(e,r=_r.USER){const i=this._originStores[r];if(!i)return;const s=i.get(e);if(i.delete(e),this._values.has(e)&&this._propertyOriginMap.get(e)===r){this._values.delete(e);for(let n=r-1;n>=0;n--){const o=this._originStores[n];if(o&&o.has(e)){this._values.set(e,o.get(e)),this._propertyOriginMap.set(e,n);break}}}return s}has(e,r){const i=r===void 0?this._values:this._originStores[r];return!!i&&i.has(e)}revert(e,r){for(;r>0&&!this.has(e,r);)--r;const i=this._originStores[r],s=i&&i.get(e),n=this._values.get(e);return this._values.set(e,s),this._propertyOriginMap.set(e,r),n!==s}originOf(e){return this._propertyOriginMap.get(e)||_r.DEFAULTS}forEach(e){this._values.forEach(e)}};const ySe=t=>{let e=class extends t{constructor(...r){super(...r);const i=tl(this),s=i.store,n=new qWe;i.store=n,g1e(i,s,n)}read(r,i){_1e(this,r,i)}getAtOrigin(r,i){const s=q9(this),n=t0(i);if(typeof r=="string")return s.get(r,n);const o={};return r.forEach(a=>{o[a]=s.get(a,n)}),o}originOf(r){return z5(this.originIdOf(r))}originIdOf(r){return q9(this).originOf(r)}revert(r,i){const s=q9(this),n=t0(i),o=tl(this);let a;a=typeof r=="string"?r==="*"?s.keys(n):[r]:r,a.forEach(l=>{o.invalidate(l),s.revert(l,n),o.commit(l)})}};return e=u([R("esri.core.ReadOnlyMultiOriginJSONSupport")],e),e};function q9(t){return tl(t).store}let _ae=class extends ySe(me){};_ae=u([R("esri.core.ReadOnlyMultiOriginJSONSupport")],_ae);const WWe=t=>{let e=class extends t{constructor(...r){super(...r)}clear(r,i="user"){return W9(this).delete(r,t0(i))}write(r,i){return b1e(this,r=r||{},i),r}setAtOrigin(r,i,s){tl(this).setAtOrigin(r,i,t0(s))}removeOrigin(r){const i=W9(this),s=t0(r),n=i.keys(s);for(const o of n)i.originOf(o)===s&&i.set(o,i.get(o,s),_r.USER)}updateOrigin(r,i){const s=W9(this),n=t0(i),o=this.get(r);for(let a=n+1;a<Xj;++a)s.delete(r,a);s.set(r,o,n)}toJSON(r){return this.write({},r)}};return e=u([R("esri.core.WriteableMultiOriginJSONSupport")],e),e.prototype.toJSON.isDefaultToJSON=!0,e};function W9(t){return tl(t).store}const YK=t=>{let e=class extends WWe(ySe(t)){constructor(...r){super(...r)}};return e=u([R("esri.core.MultiOriginJSONSupport")],e),e};let vae=class extends YK(me){};vae=u([R("esri.core.MultiOriginJSONSupport")],vae);async function ZWe(t,e){const{WhereClause:r}=await J(()=>import("./WhereClause-dc16111f.js").then(i=>i.W),[],import.meta.url);return r.create(t,e)}function XWe(t,e){return t!=null?e!=null?`(${t}) AND (${e})`:t:e}async function YWe(t){const e="portalItem"in t?t:{portalItem:t},{fromItem:r}=await J(()=>import("./portalLayers-a52f7a02.js"),["./portalLayers-a52f7a02.js","./lazyLayerLoader-8431db42.js","./layersLoader-4ff997b9.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url);try{return await r(e)}catch(i){const s=e&&e.portalItem,n=s&&s.id||"unset",o=s&&s.portal&&s.portal.url||qr.portalUrl;throw K.getLogger("esri.layers.support.fromPortalItem").error("#fromPortalItem()","Failed to create layer from portal item (portal: '"+o+"', id: '"+n+"')",i),i}}let JWe=0,Xo=class extends Xr.EventedMixin(aS(_g)){constructor(){super(...arguments),this.attributionDataUrl=null,this.fullExtent=new vr(-180,-90,180,90,qe.WGS84),this.id=Date.now().toString(16)+"-layer-"+JWe++,this.legendEnabled=!0,this.listMode="show",this.opacity=1,this.parent=null,this.popupEnabled=!0,this.attributionVisible=!0,this.spatialReference=qe.WGS84,this.title=null,this.type=null,this.url=null,this.visible=!0}static async fromArcGISServerUrl(e){const r=typeof e=="string"?{url:e}:e;return(await J(()=>import("./arcgisLayers-f6d73d5f.js"),["./arcgisLayers-f6d73d5f.js","./fetchService-90a5bdb0.js","./lazyLayerLoader-8431db42.js"],import.meta.url)).fromUrl(r)}static fromPortalItem(e){return YWe(e)}initialize(){this.when().catch(e=>{ws(e)||K.getLogger(this).error("#load()",`Failed to load layer (title: '${this.title??"no title"}', id: '${this.id??"no id"}')`,{error:e})})}destroy(){if(this.parent){const e=this,r=this.parent;"layers"in r&&r.layers.includes(e)?r.layers.remove(e):"tables"in r&&r.tables.includes(e)?r.tables.remove(e):"baseLayers"in r&&r.baseLayers.includes(e)?r.baseLayers.remove(e):"baseLayers"in r&&r.referenceLayers.includes(e)&&r.referenceLayers.remove(e)}}get hasAttributionData(){return this.attributionDataUrl!=null}get parsedUrl(){return Fn(this.url)}async fetchAttributionData(){const e=this.attributionDataUrl;if(this.hasAttributionData&&e)return(await Lt(e,{query:{f:"json"},responseType:"json"})).data;throw new D("layer:no-attribution-data","Layer does not have attribution data")}};u([d({type:String})],Xo.prototype,"attributionDataUrl",void 0),u([d({type:vr})],Xo.prototype,"fullExtent",void 0),u([d({readOnly:!0})],Xo.prototype,"hasAttributionData",null),u([d({type:String,clonable:!1})],Xo.prototype,"id",void 0),u([d({type:Boolean,nonNullable:!0})],Xo.prototype,"legendEnabled",void 0),u([d({type:["show","hide","hide-children"]})],Xo.prototype,"listMode",void 0),u([d({type:Number,range:{min:0,max:1},nonNullable:!0})],Xo.prototype,"opacity",void 0),u([d({clonable:!1})],Xo.prototype,"parent",void 0),u([d({readOnly:!0})],Xo.prototype,"parsedUrl",null),u([d({type:Boolean})],Xo.prototype,"popupEnabled",void 0),u([d({type:Boolean})],Xo.prototype,"attributionVisible",void 0),u([d({type:qe})],Xo.prototype,"spatialReference",void 0),u([d({type:String})],Xo.prototype,"title",void 0),u([d({readOnly:!0,json:{read:!1}})],Xo.prototype,"type",void 0),u([d()],Xo.prototype,"url",void 0),u([d({type:Boolean,nonNullable:!0})],Xo.prototype,"visible",void 0),Xo=u([R("esri.layers.Layer")],Xo);const gV=Xo;let Mk=class{constructor(e=r=>r.values().next().value){this._peeker=e,this._observable=new X6,this._items=new Set}get length(){return Jt(this._observable),this._items.size}clear(){this.length!==0&&(this._items.clear(),this._observable.notify())}last(){if(this.length===0)return;let e;for(e of this._items);return e}peek(){if(this.length!==0)return this._peeker(this._items)}push(e){this.contains(e)||(this._items.add(e),this._observable.notify())}contains(e){return Jt(this._observable),this._items.has(e)}pop(){if(this.length===0)return;const e=this.peek();return this._items.delete(e),this._observable.notify(),e}popLast(){if(this.length===0)return;const e=this.last();return this._items.delete(e),this._observable.notify(),e}remove(e){this.contains(e)&&(this._items.delete(e),this._observable.notify())}filter(e){const r=this.length;return this._items.forEach(i=>{e(i)||this._items.delete(i)}),r!==this._items.size&&this._observable.notify(),this}*[Symbol.iterator](){Jt(this._observable),yield*this._items}};const QWe={statsWorker:()=>J(()=>import("./statsWorker-9d7d0ada.js"),["./statsWorker-9d7d0ada.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js"],import.meta.url),geometryEngineWorker:()=>J(()=>import("./geometryEngineWorker-cea43f5b.js"),["./geometryEngineWorker-cea43f5b.js","./geometryEngineJSON-b77f7530.js","./geometryEngineBase-7a1f11c2.js","./json-48e3ea08.js"],import.meta.url),CSVSourceWorker:()=>J(()=>import("./CSVSourceWorker-2fba6895.js"),["./CSVSourceWorker-2fba6895.js","./json-48e3ea08.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./number-5a528621.js","./clientSideDefaults-b46e59ef.js"],import.meta.url),EdgeProcessingWorker:()=>J(()=>import("./EdgeProcessingWorker-10837baa.js"),[],import.meta.url),ElevationSamplerWorker:()=>J(()=>import("./ElevationSamplerWorker-66f029ca.js"),["./ElevationSamplerWorker-66f029ca.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./georeference-f88d775a.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./MeshTransform-24e5f7d8.js"],import.meta.url),FeatureServiceSnappingSourceWorker:()=>J(()=>import("./FeatureServiceSnappingSourceWorker-8ffeb890.js"),["./FeatureServiceSnappingSourceWorker-8ffeb890.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./symbologySnappingCandidates-5232552d.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./query-2f8589ea.js"],import.meta.url),GeoJSONSourceWorker:()=>J(()=>import("./GeoJSONSourceWorker-7326259a.js"),["./GeoJSONSourceWorker-7326259a.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./geojson-aee614d4.js","./clientSideDefaults-b46e59ef.js","./sourceUtils-88ca9e4a.js"],import.meta.url),LercWorker:()=>J(()=>import("./LercWorker-8226344f.js"),[],import.meta.url),MemorySourceWorker:()=>J(()=>import("./MemorySourceWorker-fab125a0.js"),["./MemorySourceWorker-fab125a0.js","./objectIdUtils-967fafff.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./clientSideDefaults-b46e59ef.js","./sourceUtils-88ca9e4a.js"],import.meta.url),PBFDecoderWorker:()=>J(()=>import("./PBFDecoderWorker-be5fa5c5.js"),["./PBFDecoderWorker-be5fa5c5.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js"],import.meta.url),Pipeline:()=>J(()=>import("./Pipeline-4c3a940f.js").then(t=>t.P),["./Pipeline-4c3a940f.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./StreamFeatureManager-ae5cd9d5.js","./quickselect-7692f5ca.js","./arcadeTimeUtils-b60b3eed.js","./centroid-3dcadaf5.js","./ogcFeatureUtils-0a93af2e.js","./geojson-aee614d4.js","./clientSideDefaults-b46e59ef.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./createConnection-532a08b9.js","./definitions-4b766362.js","./TileInfoView-8e05b841.js","./number-e491b09e.js","./geohashUtils-77d8429b.js"],import.meta.url),PointCloudWorker:()=>J(()=>import("./PointCloudWorker-028a517e.js"),["./PointCloudWorker-028a517e.js","./PointCloudWorkerUtil-b73389e5.js","./PointCloudUniqueValueRenderer-c626c65c.js"],import.meta.url),RasterWorker:()=>J(()=>import("./RasterWorker-9335fbf1.js"),["./RasterWorker-9335fbf1.js","./dataUtils-2db4dbf8.js","./pixelRangeUtils-04f58c28.js","./utils-0a64df7a.js","./rasterProjectionHelper-f92550de.js"],import.meta.url),SceneLayerSnappingSourceWorker:()=>J(()=>import("./SceneLayerSnappingSourceWorker-63cdac74.js"),[],import.meta.url),SceneLayerWorker:()=>J(()=>import("./SceneLayerWorker-00420594.js").then(t=>t.a),["./SceneLayerWorker-00420594.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./I3SNode-8310efaa.js"],import.meta.url),WFSSourceWorker:()=>J(()=>import("./WFSSourceWorker-d6f7cd00.js"),["./WFSSourceWorker-d6f7cd00.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./geojson-aee614d4.js","./sourceUtils-88ca9e4a.js","./wfsUtils-62a669a8.js","./xmlUtils-444cb4c0.js"],import.meta.url),WorkerTileHandler:()=>J(()=>import("./WorkerTileHandler-49828f3e.js"),["./WorkerTileHandler-49828f3e.js","./TileClipper-ae6eca9e.js","./StyleRepository-37fe00eb.js","./definitions-4b766362.js","./Rect-98da58d6.js","./pbf-10aa4b25.js","./TurboLine-412bb9c4.js","./BidiEngine-9a40f2f4.js"],import.meta.url)};var Ta;(function(t){t[t.HANDSHAKE=0]="HANDSHAKE",t[t.OPEN=1]="OPEN",t[t.OPENED=2]="OPENED",t[t.RESPONSE=3]="RESPONSE",t[t.INVOKE=4]="INVOKE",t[t.ABORT=5]="ABORT",t[t.CLOSE=6]="CLOSE",t[t.OPEN_PORT=7]="OPEN_PORT",t[t.ON=8]="ON"})(Ta||(Ta={}));let KWe=0;function _Se(){return KWe++}function eZe(t){return t&&typeof t=="object"&&("result"in t||"transferList"in t)}function eP(t){return t?typeof t=="string"?JSON.stringify({name:"message",message:t}):t.toJSON?JSON.stringify(t):JSON.stringify({name:t.name,message:t.message,details:t.details||{stack:t.stack}}):null}function JK(t,e,r,i){if(e.type===Ta.OPEN_PORT)return void t.postMessage(e,[e.port]);if(e.type!==Ta.INVOKE&&e.type!==Ta.RESPONSE)return void t.postMessage(e);let s;if(eZe(r)?(s=bae(r.transferList),e.data=r.result):(s=bae(i),e.data=r),s){if(le("ff")){for(const n of s)if("byteLength"in n&&n.byteLength>267386880){const o="Worker call with large ArrayBuffer would crash Firefox";switch(e.type){case Ta.INVOKE:throw o;case Ta.RESPONSE:return void JK(t,{type:Ta.RESPONSE,jobId:e.jobId,error:eP(o)})}}}t.postMessage(e,s)}else t.postMessage(e)}function tP(t){if(!t)return null;const e=t.data;return e?typeof e=="string"?JSON.parse(e):e:null}function bae(t){if(!t||!t.length)return null;if(le("esri-workers-arraybuffer-transfer"))return t;const e=t.filter(r=>!tZe(r));return e.length?e:null}function tZe(t){return t instanceof ArrayBuffer||t?.constructor?.name==="ArrayBuffer"}const{CLOSE:wae,ABORT:xae,INVOKE:Tae,RESPONSE:ZO,OPEN_PORT:Sae,ON:rZe}=Ta,iZe=2;let sZe=class{constructor(e){this._timer=null,this._cancelledJobIds=new Set,this._invokeMessages=[],this._invoke=e,this._timer=null,this._process=this._process.bind(this)}push(e){e.type===Ta.ABORT?this._cancelledJobIds.add(e.jobId):(this._invokeMessages.push(e),this._timer===null&&(this._timer=setTimeout(this._process,0)))}clear(){this._invokeMessages.length=0,this._cancelledJobIds.clear(),this._timer=null}_process(){this._timer=null;for(const e of this._invokeMessages)this._cancelledJobIds.has(e.jobId)||this._invoke(e);this._cancelledJobIds.clear(),this._invokeMessages.length=0}},G1=class nE{static connect(e){const r=new MessageChannel;let i;i=typeof e=="function"?new e:"default"in e&&typeof e.default=="function"?new e.default:e;const s=new nE(r.port1,{channel:r,client:i},()=>null);return typeof i=="object"&&"remoteClient"in i&&(i.remoteClient=s),nE.clients.set(s,i),r.port2}static loadWorker(e){const r=QWe[e];return r?r():Promise.resolve(null)}constructor(e,r,i){this._port=e,this._getNextJob=i,this._outJobs=new Map,this._inJobs=new Map,this._invokeQueue=new sZe(s=>this._onInvokeMessage(s)),this._client=r.client,this._onMessage=this._onMessage.bind(this),this._channel=r.channel,this._schedule=r.schedule,this._port.addEventListener("message",this._onMessage),this._port.start()}close(){this._post({type:wae}),this._close()}isBusy(){return this._outJobs.size>0}invoke(e,r,i){const s=i?.signal,n=i?.transferList;if(!this._port)return Promise.reject(new D("worker:port-closed",`Cannot call invoke('${e}'), port is closed`,{methodName:e,data:r}));const o=_Se();return new Promise((a,l)=>{if(dn(s))return this._processWork(),void l(Tr());const c=xn(s,()=>{const p=this._outJobs.get(o);p&&(this._outJobs.delete(o),this._processWork(),Pi(p.abortHandle),this._post({type:xae,jobId:o}),l(Tr()))}),h={resolve:a,reject:l,abortHandle:c,debugInfo:e};this._outJobs.set(o,h),this._post({type:Tae,jobId:o,methodName:e,abortable:s!=null},r,n)})}on(e,r){const i=new MessageChannel;function s(n){r(n.data)}return this._port.postMessage({type:Ta.ON,eventType:e,port:i.port2},[i.port2]),i.port1.addEventListener("message",s),i.port1.start(),{remove(){i.port1.postMessage({type:Ta.CLOSE}),i.port1.close(),i.port1.removeEventListener("message",s)}}}jobAdded(){this._processWork()}openPort(){const e=new MessageChannel;return this._post({type:Sae,port:e.port2}),e.port1}_processWork(){if(this._outJobs.size>=iZe)return;const e=this._getNextJob();if(!e)return;const{methodName:r,data:i,invokeOptions:s,resolver:n}=e;this.invoke(r,i,s).then(o=>n.resolve(o)).catch(o=>n.reject(o))}_close(){this._channel&&(this._channel=void 0),this._port.removeEventListener("message",this._onMessage),this._port.close(),this._outJobs.forEach(e=>{Pi(e.abortHandle),e.reject(Tr(`Worker closing, aborting job calling '${e.debugInfo}'`))}),this._inJobs.clear(),this._outJobs.clear(),this._invokeQueue.clear(),this._port=null,this._client=null,this._schedule=null}_onMessage(e){this._schedule!=null?this._schedule(()=>this._processMessage(e)):this._processMessage(e)}_processMessage(e){const r=tP(e);if(r)switch(r.type){case ZO:this._onResponseMessage(r);break;case Tae:this._invokeQueue.push(r);break;case xae:this._onAbortMessage(r);break;case wae:this._onCloseMessage();break;case Sae:this._onOpenPortMessage(r);break;case rZe:this._onOnMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);this._invokeQueue.push(e),s&&(s.controller&&s.controller.abort(),r.delete(i))}_onCloseMessage(){const e=this._client;this._close(),e&&"destroy"in e&&nE.clients.get(this)===e&&e.destroy(),nE.clients.delete(this),e?.remoteClient&&(e.remoteClient=null)}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs;let l,c=this._client,h=c[r];try{if(!h&&r&&r.includes(".")){const p=r.split(".");for(let f=0;f<p.length-1;f++)c=c[p[f]],h=c[p[f+1]]}if(typeof h!="function")throw new TypeError(`${r} is not a function`);l=h.call(c,s,{client:this,signal:o?o.signal:null})}catch(p){return void this._post({type:ZO,jobId:i,error:eP(p)})}Rh(l)?(a.set(i,{controller:o,promise:l}),l.then(p=>{a.has(i)&&(a.delete(i),this._post({type:ZO,jobId:i},p))},p=>{a.has(i)&&(a.delete(i),ws(p)||this._post({type:ZO,jobId:i,error:eP(p||{message:`Error encountered at method ${r}`})}))})):this._post({type:ZO,jobId:i},l)}_onOpenPortMessage(e){new nE(e.port,{client:this._client},()=>null)}_onOnMessage(e){const{port:r}=e,i=this._client.on(e.eventType,n=>{r.postMessage(n)}),s=w1(e.port,"message",n=>{tP(n)?.type===Ta.CLOSE&&(s.remove(),i.remove(),r.close())})}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs;if(!n.has(r))return;const o=n.get(r);n.delete(r),this._processWork(),Pi(o.abortHandle),i?o.reject(D.fromJSON(JSON.parse(i))):o.resolve(s)}_post(e,r,i){return JK(this._port,e,r,i)}};G1.kernelInfo={buildDate:bve,fullVersion:tQ,revision:wve},G1.clients=new Map;let nZe=class{constructor(){this._inUseClients=new Array,this._clients=new Array,this._clientPromises=new Array,this._ongoingJobsQueue=new Mk}destroy(){this.close()}get closed(){return!this._clients||!this._clients.length}open(e,r){return new Promise((i,s)=>{let n=!0;const o=a=>{Dt(r.signal),n&&(n=!1,a())};this._clients.length=e.length,this._clientPromises.length=e.length,this._inUseClients.length=e.length;for(let a=0;a<e.length;++a){const l=e[a];Rh(l)?this._clientPromises[a]=l.then(c=>(this._clients[a]=new G1(c,r,()=>this._ongoingJobsQueue.pop()??null),o(i),this._clients[a]),()=>(o(s),null)):(this._clients[a]=new G1(l,r,()=>this._ongoingJobsQueue.pop()??null),this._clientPromises[a]=Promise.resolve(this._clients[a]),o(i))}})}broadcast(e,r,i){const s=new Array(this._clientPromises.length);for(let n=0;n<this._clientPromises.length;++n){const o=this._clientPromises[n];s[n]=o.then(a=>a?.invoke(e,r,i))}return s}close(){let e;for(;e=this._ongoingJobsQueue.pop();)e.resolver.reject(Tr(`Worker closing, aborting job calling '${e.methodName}'`));for(const r of this._clientPromises)r.then(i=>i?.close());this._clients.length=0,this._clientPromises.length=0,this._inUseClients.length=0}invoke(e,r,i){let s;Array.isArray(i)?(K.getLogger("esri.core.workers.Connection").warn("invoke()","The transferList parameter is deprecated, use the options object instead"),s={transferList:i}):s=i;const n=nn();this._ongoingJobsQueue.push({methodName:e,data:r,invokeOptions:s,resolver:n});for(let o=0;o<this._clientPromises.length;o++){const a=this._clients[o];a?a.jobAdded():this._clientPromises[o].then(l=>l?.jobAdded())}return n.promise}on(e,r){return Promise.all(this._clientPromises).then(()=>Sc(this._clients.map(i=>i.on(e,r))))}openPorts(){return new Promise(e=>{const r=new Array(this._clientPromises.length);let i=r.length;for(let s=0;s<this._clientPromises.length;++s)this._clientPromises[s].then(n=>{n&&(r[s]=n.openPort()),--i==0&&e(r)})})}get test(){return{numClients:this._clients.length}}};const oZe={};function aZe(t){const e={async:t.async,isDebug:t.isDebug,locale:t.locale,baseUrl:t.baseUrl,has:{...t.has},map:{...t.map},packages:t.packages&&t.packages.concat()||[],paths:{...t.paths}};return t.hasOwnProperty("async")||(e.async=!0),t.hasOwnProperty("isDebug")||(e.isDebug=!1),t.baseUrl||(e.baseUrl=oZe.baseUrl),e}let lZe=class{constructor(){const e=document.createDocumentFragment();["addEventListener","dispatchEvent","removeEventListener"].forEach(r=>{this[r]=(...i)=>e[r](...i)})}},p4=class{constructor(){this._dispatcher=new lZe,this._workerPostMessage({type:Ta.HANDSHAKE})}terminate(){}get onmessage(){return this._onmessageHandler}set onmessage(e){this._onmessageHandler&&this.removeEventListener("message",this._onmessageHandler),this._onmessageHandler=e,e&&this.addEventListener("message",e)}get onmessageerror(){return this._onmessageerrorHandler}set onmessageerror(e){this._onmessageerrorHandler&&this.removeEventListener("messageerror",this._onmessageerrorHandler),this._onmessageerrorHandler=e,e&&this.addEventListener("messageerror",e)}get onerror(){return this._onerrorHandler}set onerror(e){this._onerrorHandler&&this.removeEventListener("error",this._onerrorHandler),this._onerrorHandler=e,e&&this.addEventListener("error",e)}postMessage(e){JC(()=>{this._workerMessageHandler(new MessageEvent("message",{data:e}))})}dispatchEvent(e){return this._dispatcher.dispatchEvent(e)}addEventListener(e,r,i){this._dispatcher.addEventListener(e,r,i)}removeEventListener(e,r,i){this._dispatcher.removeEventListener(e,r,i)}_workerPostMessage(e){JC(()=>{this.dispatchEvent(new MessageEvent("message",{data:e}))})}async _workerMessageHandler(e){const r=tP(e);if(r&&r.type===Ta.OPEN){const{modulePath:i,jobId:s}=r;let n=await G1.loadWorker(i);n||(n=await J(()=>import(i),[],import.meta.url));const o=G1.connect(n);this._workerPostMessage({type:Ta.OPENED,jobId:s,data:o})}}};const Uq=K.getLogger("esri.core.workers.workerFactory"),{HANDSHAKE:cZe}=Ta,uZe='let globalId=0;const outgoing=new Map,configuration=JSON.parse("{CONFIGURATION}");self.esriConfig=configuration.esriConfig;const workerPath=self.esriConfig.workers.workerPath,HANDSHAKE=0,OPEN=1,OPENED=2,RESPONSE=3,INVOKE=4,ABORT=5;function createAbortError(){const e=new Error("Aborted");return e.name="AbortError",e}function receiveMessage(e){return e&&e.data?"string"==typeof e.data?JSON.parse(e.data):e.data:null}function invokeStaticMessage(e,o,r){const t=r&&r.signal,n=globalId++;return new Promise(((r,s)=>{if(t){if(t.aborted)return s(createAbortError());t.addEventListener("abort",(()=>{outgoing.get(n)&&(outgoing.delete(n),self.postMessage({type:ABORT,jobId:n}),s(createAbortError()))}))}outgoing.set(n,{resolve:r,reject:s}),self.postMessage({type:INVOKE,jobId:n,methodName:e,abortable:null!=t,data:o})}))}let workerRevisionChecked=!1;function checkWorkerRevision(e){if(!workerRevisionChecked&&e.kernelInfo){workerRevisionChecked=!0;const{revision:o,fullVersion:r}=configuration.kernelInfo,{revision:t,fullVersion:n,version:s}=e.kernelInfo;esriConfig.assetsPath!==esriConfig.defaultAssetsPath&&o!==t&&console.warn(`Version mismatch detected between ArcGIS Maps SDK for JavaScript modules and assets. For more information visit https://bit.ly/3QnsuSo.\\nModules version: ${r}\\nAssets version: ${n??s}\\nAssets path: ${esriConfig.assetsPath}`)}}function messageHandler(e){const o=receiveMessage(e);if(!o)return;const r=o.jobId;switch(o.type){case OPEN:let n;function t(e){const o=n.connect(e);self.postMessage({type:OPENED,jobId:r,data:o},[o])}"function"==typeof define&&define.amd?require([workerPath],(e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||new Promise((e=>{require([o.modulePath],e)})))).then(t)})):"System"in self&&"function"==typeof System.import?System.import(workerPath).then((e=>(n=e.default,checkWorkerRevision(n),n.loadWorker(o.modulePath)))).then((e=>e||System.import(o.modulePath))).then(t):esriConfig.workers.useDynamicImport?import(workerPath).then((e=>{n=e.default||e,checkWorkerRevision(n),n.loadWorker(o.modulePath).then((e=>e||import(o.modulePath))).then(t)})):(self.RemoteClient||importScripts(workerPath),n=self.RemoteClient.default||self.RemoteClient,checkWorkerRevision(n),n.loadWorker(o.modulePath).then(t));break;case RESPONSE:if(outgoing.has(r)){const s=outgoing.get(r);outgoing.delete(r),o.error?s.reject(JSON.parse(o.error)):s.resolve(o.data)}}}self.dojoConfig=configuration.loaderConfig,esriConfig.workers.loaderUrl&&(self.importScripts(esriConfig.workers.loaderUrl),"function"==typeof require&&"function"==typeof require.config&&require.config(configuration.loaderConfig)),self.addEventListener("message",messageHandler),self.postMessage({type:0});';let CL,AL;const Eae="Failed to create Worker. Fallback to execute module in main thread";async function hZe(){if(!le("esri-workers")||(le("mozilla"),0))return Cae(new p4);if(!CL&&!AL)try{const e=uZe.split('"{CONFIGURATION}"').join(`'${dZe()}'`);CL=URL.createObjectURL(new Blob([e],{type:"text/javascript"}))}catch(e){AL=e||{}}let t;if(CL)try{t=new Worker(CL,{name:"esri-worker-"+pZe++})}catch{Uq.warn(Eae,AL),t=new p4}else Uq.warn(Eae,AL),t=new p4;return Cae(t)}async function Cae(t){return new Promise(e=>{function r(s){const n=tP(s);n&&n.type===cZe&&(t.removeEventListener("message",r),t.removeEventListener("error",i),e(t))}function i(s){s.preventDefault(),t.removeEventListener("message",r),t.removeEventListener("error",i),Uq.warn("Failed to create Worker. Fallback to execute module in main thread",s),(t=new p4).addEventListener("message",r),t.addEventListener("error",i)}t.addEventListener("message",r),t.addEventListener("error",i)})}function dZe(){let t;if(qr.default!=null){const s={...qr};delete s.default,t=JSON.parse(JSON.stringify(s))}else t=JSON.parse(JSON.stringify(qr));t.assetsPath=pc(t.assetsPath),t.defaultAssetsPath=t.defaultAssetsPath?pc(t.defaultAssetsPath):void 0,t.request.interceptors=[],t.log.interceptors=[],t.locale=Ld(),t.has={"esri-csp-restrictions":le("esri-csp-restrictions"),"esri-2d-debug":!1,"esri-2d-update-debug":le("esri-2d-update-debug"),"esri-2d-log-updating":le("esri-2d-log-updating"),"featurelayer-pbf":le("featurelayer-pbf"),"featurelayer-simplify-thresholds":le("featurelayer-simplify-thresholds"),"featurelayer-simplify-payload-size-factors":le("featurelayer-simplify-payload-size-factors"),"featurelayer-simplify-mobile-factor":le("featurelayer-simplify-mobile-factor"),"esri-atomics":le("esri-atomics"),"esri-shared-array-buffer":le("esri-shared-array-buffer"),"esri-tiles-debug":le("esri-tiles-debug"),"esri-workers-arraybuffer-transfer":le("esri-workers-arraybuffer-transfer"),"feature-polyline-generalization-factor":le("feature-polyline-generalization-factor"),"host-webworker":1,"polylabel-placement-enabled":le("polylabel-placement-enabled")},t.workers.loaderUrl&&(t.workers.loaderUrl=pc(t.workers.loaderUrl)),t.workers.workerPath?t.workers.workerPath=pc(t.workers.workerPath):t.workers.workerPath=pc(Dr("esri/core/workers/RemoteClient.js")),t.workers.useDynamicImport=!1;const e=qr.workers.loaderConfig,r=aZe({baseUrl:e?.baseUrl,locale:Ld(),has:{"csp-restrictions":1,"dojo-test-sniff":0,"host-webworker":1,...e?.has},map:{...e?.map},paths:{...e?.paths},packages:e?.packages||[]});return JSON.stringify({esriConfig:t,loaderConfig:r,kernelInfo:{buildDate:bve,fullVersion:tQ,revision:wve}})}let pZe=0;const{ABORT:Aae,INVOKE:fZe,OPEN:mZe,OPENED:gZe,RESPONSE:XO}=Ta;let yZe=class vSe{static async create(e){const r=await hZe();return new vSe(r,e)}constructor(e,r){this._outJobs=new Map,this._inJobs=new Map,this.worker=e,this.id=r,e.addEventListener("message",this._onMessage.bind(this)),e.addEventListener("error",i=>{i.preventDefault(),K.getLogger("esri.core.workers.WorkerOwner").error(i)})}terminate(){this.worker.terminate()}async open(e,r={}){const{signal:i}=r,s=_Se();return new Promise((n,o)=>{const a={resolve:n,reject:o,abortHandle:jJ(i,()=>{this._outJobs.delete(s),this._post({type:Aae,jobId:s})})};this._outJobs.set(s,a),this._post({type:mZe,jobId:s,modulePath:e})})}_onMessage(e){const r=tP(e);if(r)switch(r.type){case gZe:this._onOpenedMessage(r);break;case XO:this._onResponseMessage(r);break;case Aae:this._onAbortMessage(r);break;case fZe:this._onInvokeMessage(r)}}_onAbortMessage(e){const r=this._inJobs,i=e.jobId,s=r.get(i);s&&(s.controller&&s.controller.abort(),r.delete(i))}_onInvokeMessage(e){const{methodName:r,jobId:i,data:s,abortable:n}=e,o=n?new AbortController:null,a=this._inJobs,l=MUe[r];let c;try{if(typeof l!="function")throw new TypeError(`${r} is not a function`);c=l.call(null,s,{signal:o?o.signal:null})}catch(h){return void this._post({type:XO,jobId:i,error:eP(h)})}Rh(c)?(a.set(i,{controller:o,promise:c}),c.then(h=>{a.has(i)&&(a.delete(i),this._post({type:XO,jobId:i},h))},h=>{a.has(i)&&(a.delete(i),h||(h={message:"Error encountered at method"+r}),ws(h)||this._post({type:XO,jobId:i,error:eP(h||{message:`Error encountered at method ${r}`})}))})):this._post({type:XO,jobId:i},c)}_onOpenedMessage(e){const{jobId:r,data:i}=e,s=this._outJobs.get(r);s&&(this._outJobs.delete(r),Pi(s.abortHandle),s.resolve(i))}_onResponseMessage(e){const{jobId:r,error:i,data:s}=e,n=this._outJobs.get(r);n&&(this._outJobs.delete(r),Pi(n.abortHandle),i?n.reject(D.fromJSON(JSON.parse(i))):n.resolve(s))}_post(e,r,i){return JK(this.worker,e,r,i)}};const Oae=le("host-browser")?Math.min(navigator.hardwareConcurrency-1,le("workers-pool-size")):0;let zx=le("esri-mobile")?Math.min(Oae,3):Oae;zx||(zx=le("safari")&&le("mac")?7:2);let Rae=0;const f4=[];function _Ze(){wSe()}async function OL(t,e){const r=new nZe;return await r.open(t,e),r}async function bSe(t,e={}){if(typeof t!="string")throw new D("workers:undefined-module","modulePath is missing");let r=e.strategy||"distributed";if(le("host-webworker")&&!le("esri-workers")&&(r="local"),r==="local"){let i=await G1.loadWorker(t);i||(i=await J(()=>import(t),[],import.meta.url)),Dt(e.signal);const s=e.client||i;return OL([G1.connect(i)],{...e,client:s})}if(await wSe(),Dt(e.signal),r==="dedicated"){const i=Rae++%zx;return OL([await f4[i].open(t,e)],e)}if(e.maxNumWorkers&&e.maxNumWorkers>0){const i=Math.min(e.maxNumWorkers,zx);if(i<zx){const s=new Array(i);for(let n=0;n<i;++n){const o=Rae++%zx;s[n]=f4[o].open(t,e)}return OL(s,e)}}return OL(f4.map(i=>i.open(t,e)),e)}let RL=null;async function wSe(){if(RL)return RL;new AbortController;const t=[];for(let e=0;e<zx;e++){const r=yZe.create(e).then(i=>(f4[e]=i,i));t.push(r)}return RL=Promise.all(t),RL}function Mae(t,e,r){if(t.hasM==null||t.hasZ)for(const i of e)for(const s of i)s.length>2&&(s[2]*=r)}function vZe(t,e,r){if(!t&&!e||!r)return;const i=VI(r);Iae(t,r,i),Iae(e,r,i)}function Iae(t,e,r){if(t)for(const i of t)bZe(i.geometry,e,r)}function bZe(t,e,r){if(t==null||!t.spatialReference||Bn(t.spatialReference,e))return;const i=VI(t.spatialReference)/r;if(i!==1){if("x"in t)t.z!=null&&(t.z*=i);else if("rings"in t)Mae(t,t.rings,i);else if("paths"in t)Mae(t,t.paths,i);else if("points"in t&&(t.hasM==null||t.hasZ))for(const s of t.points)s.length>2&&(s[2]*=i)}}function xSe(t,e,r){if(e==null||r==null||r.vcsWkid||Bn(e,r))return null;const i=VI(e)/VI(r);if(i===1)return null;switch(t){case"point":case"esriGeometryPoint":return s=>wZe(s,i);case"polyline":case"esriGeometryPolyline":return s=>TZe(s,i);case"polygon":case"esriGeometryPolygon":return s=>xZe(s,i);case"multipoint":case"esriGeometryMultipoint":return s=>SZe(s,i);case"extent":case"esriGeometryEnvelope":return s=>EZe(s,i);default:return null}}function wZe(t,e){t&&t.z!=null&&(t.z*=e)}function xZe(t,e){if(t)for(const r of t.rings)for(const i of r)i.length>2&&(i[2]*=e)}function TZe(t,e){if(t)for(const r of t.paths)for(const i of r)i.length>2&&(i[2]*=e)}function SZe(t,e){if(t)for(const r of t.points)r.length>2&&(r[2]*=e)}function EZe(t,e){t&&t.zmin!=null&&t.zmax!=null&&(t.zmin*=e,t.zmax*=e)}function Pae(t,e,r){if(!r||!r.features||!r.hasZ)return;const i=xSe(r.geometryType,e,t.outSpatialReference);if(i!=null)for(const s of r.features)i(s.geometry)}const CZe=new kr({esriFieldTypeSmallInteger:"small-integer",esriFieldTypeInteger:"integer",esriFieldTypeSingle:"single",esriFieldTypeDouble:"double",esriFieldTypeLong:"long",esriFieldTypeString:"string",esriFieldTypeDate:"date",esriFieldTypeOID:"oid",esriFieldTypeGeometry:"geometry",esriFieldTypeBlob:"blob",esriFieldTypeRaster:"raster",esriFieldTypeGUID:"guid",esriFieldTypeGlobalID:"global-id",esriFieldTypeXML:"xml",esriFieldTypeBigInteger:"big-integer",esriFieldTypeDateOnly:"date-only",esriFieldTypeTimeOnly:"time-only",esriFieldTypeTimestampOffset:"timestamp-offset"});var Vq;const AZe=new kr({binary:"binary",coordinate:"coordinate",countOrAmount:"count-or-amount",dateAndTime:"date-and-time",description:"description",locationOrPlaceName:"location-or-place-name",measurement:"measurement",nameOrTitle:"name-or-title",none:"none",orderedOrRanked:"ordered-or-ranked",percentageOrRatio:"percentage-or-ratio",typeOrCategory:"type-or-category",uniqueIdentifier:"unique-identifier"});let vl=Vq=class extends he{constructor(t){super(t),this.alias=null,this.defaultValue=void 0,this.description=null,this.domain=null,this.editable=!0,this.length=-1,this.name=null,this.nullable=!0,this.type=null,this.valueType=null,this.visible=!0}readDescription(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return r?.value??null}readValueType(t,{description:e}){let r=null;try{r=e?JSON.parse(e):null}catch{}return r?AZe.fromJSON(r.fieldValueType):null}clone(){return new Vq({alias:this.alias,defaultValue:this.defaultValue,description:this.description,domain:this.domain&&this.domain.clone()||null,editable:this.editable,length:this.length,name:this.name,nullable:this.nullable,type:this.type,valueType:this.valueType,visible:this.visible})}};u([d({type:String,json:{write:!0}})],vl.prototype,"alias",void 0),u([d({type:[String,Number],json:{write:{allowNull:!0}}})],vl.prototype,"defaultValue",void 0),u([d()],vl.prototype,"description",void 0),u([Ae("description")],vl.prototype,"readDescription",null),u([d({types:uTe,json:{read:{reader:cV},write:!0}})],vl.prototype,"domain",void 0),u([d({type:Boolean,json:{write:!0}})],vl.prototype,"editable",void 0),u([d({type:Ki,json:{write:!0}})],vl.prototype,"length",void 0),u([d({type:String,json:{write:!0}})],vl.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0}})],vl.prototype,"nullable",void 0),u([nt(CZe)],vl.prototype,"type",void 0),u([d()],vl.prototype,"valueType",void 0),u([Ae("valueType",["description"])],vl.prototype,"readValueType",null),u([d({type:Boolean,json:{read:!1}})],vl.prototype,"visible",void 0),vl=Vq=u([R("esri.layers.support.Field")],vl);const yV=vl;var zq;const Bq=new kr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryEnvelope:"extent",mesh:"mesh","":null});let ma=zq=class extends he{constructor(t){super(t),this.displayFieldName=null,this.exceededTransferLimit=!1,this.features=[],this.fields=null,this.geometryType=null,this.hasM=!1,this.hasZ=!1,this.queryGeometry=null,this.spatialReference=null}readFeatures(t,e){const r=qe.fromJSON(e.spatialReference),i=[];for(let s=0;s<t.length;s++){const n=t[s],o=oa.fromJSON(n),a=n.geometry&&n.geometry.spatialReference;o.geometry==null||a||(o.geometry.spatialReference=r);const l=n.aggregateGeometries,c=o.aggregateGeometries;if(l&&c!=null)for(const h in c){const p=c[h],f=l[h],m=f?.spatialReference;p==null||m||(p.spatialReference=r)}i.push(o)}return i}writeGeometryType(t,e,r,i){if(t)return void Bq.write(t,e,r,i);const{features:s}=this;if(s){for(const n of s)if(n&&n.geometry!=null)return void Bq.write(n.geometry.type,e,r,i)}}readQueryGeometry(t,e){if(!t)return null;const r=!!t.spatialReference,i=N1(t);return i&&!r&&e.spatialReference&&(i.spatialReference=qe.fromJSON(e.spatialReference)),i}writeSpatialReference(t,e){if(t)return void(e.spatialReference=t.toJSON());const{features:r}=this;if(r){for(const i of r)if(i&&i.geometry!=null&&i.geometry.spatialReference)return void(e.spatialReference=i.geometry.spatialReference.toJSON())}}clone(){return new zq(this.cloneProperties())}cloneProperties(){return re({displayFieldName:this.displayFieldName,exceededTransferLimit:this.exceededTransferLimit,features:this.features,fields:this.fields,geometryType:this.geometryType,hasM:this.hasM,hasZ:this.hasZ,queryGeometry:this.queryGeometry,spatialReference:this.spatialReference,transform:this.transform})}toJSON(t){const e=this.write();if(e.features&&Array.isArray(t)&&t.length>0)for(let r=0;r<e.features.length;r++){const i=e.features[r];if(i.geometry){const s=t&&t[r];i.geometry=s&&s.toJSON()||i.geometry}}return e}quantize(t){const{scale:[e,r],translate:[i,s]}=t,n=c=>Math.round((c-i)/e),o=c=>Math.round((s-c)/r),a=this.features,l=this._getQuantizationFunction(this.geometryType,n,o);for(let c=0,h=a.length;c<h;c++)l?.(a[c].geometry)||(a.splice(c,1),c--,h--);return this.transform=t,this}unquantize(){const{geometryType:t,features:e,transform:r}=this;if(!r)return this;const{translate:[i,s],scale:[n,o]}=r,a=f=>f*n+i,l=f=>s-f*o;let c=null,h=null;if(this.hasZ&&r?.scale?.[2]!=null){const{translate:[,,f],scale:[,,m]}=r;c=g=>g*m+f}if(this.hasM&&r?.scale?.[3]!=null){const{translate:[,,,f],scale:[,,,m]}=r;h=g=>g==null?g:g*m+f}const p=this._getHydrationFunction(t,a,l,c,h);for(const{geometry:f}of e)f!=null&&p&&p(f);return this.transform=null,this}_quantizePoints(t,e,r){let i,s;const n=[];for(let o=0,a=t.length;o<a;o++){const l=t[o];if(o>0){const c=e(l[0]),h=r(l[1]);c===i&&h===s||(n.push([c-i,h-s]),i=c,s=h)}else i=e(l[0]),s=r(l[1]),n.push([i,s])}return n.length>0?n:null}_getQuantizationFunction(t,e,r){return t==="point"?i=>(i.x=e(i.x),i.y=r(i.y),i):t==="polyline"||t==="polygon"?i=>{const s=TC(i)?i.rings:i.paths,n=[];for(let o=0,a=s.length;o<a;o++){const l=s[o],c=this._quantizePoints(l,e,r);c&&n.push(c)}return n.length>0?(TC(i)?i.rings=n:i.paths=n,i):null}:t==="multipoint"?i=>{const s=this._quantizePoints(i.points,e,r);return s&&s.length>0?(i.points=s,i):null}:t==="extent"?i=>i:null}_getHydrationFunction(t,e,r,i,s){return t==="point"?n=>{n.x=e(n.x),n.y=r(n.y),i&&(n.z=i(n.z))}:t==="polyline"||t==="polygon"?n=>{const o=TC(n)?n.rings:n.paths;let a,l;for(let c=0,h=o.length;c<h;c++){const p=o[c];for(let f=0,m=p.length;f<m;f++){const g=p[f];f>0?(a+=g[0],l+=g[1]):(a=g[0],l=g[1]),g[0]=e(a),g[1]=r(l)}}if(i&&s)for(let c=0,h=o.length;c<h;c++){const p=o[c];for(let f=0,m=p.length;f<m;f++){const g=p[f];g[2]=i(g[2]),g[3]=s(g[3])}}else if(i)for(let c=0,h=o.length;c<h;c++){const p=o[c];for(let f=0,m=p.length;f<m;f++){const g=p[f];g[2]=i(g[2])}}else if(s)for(let c=0,h=o.length;c<h;c++){const p=o[c];for(let f=0,m=p.length;f<m;f++){const g=p[f];g[2]=s(g[2])}}}:t==="extent"?n=>{n.xmin=e(n.xmin),n.ymin=r(n.ymin),n.xmax=e(n.xmax),n.ymax=r(n.ymax),i&&n.zmax!=null&&n.zmin!=null&&(n.zmax=i(n.zmax),n.zmin=i(n.zmin)),s&&n.mmax!=null&&n.mmin!=null&&(n.mmax=s(n.mmax),n.mmin=s(n.mmin))}:t==="multipoint"?n=>{const o=n.points;let a,l;for(let c=0,h=o.length;c<h;c++){const p=o[c];c>0?(a+=p[0],l+=p[1]):(a=p[0],l=p[1]),p[0]=e(a),p[1]=r(l)}if(i&&s)for(let c=0,h=o.length;c<h;c++){const p=o[c];p[2]=i(p[2]),p[3]=s(p[3])}else if(i)for(let c=0,h=o.length;c<h;c++){const p=o[c];p[2]=i(p[2])}else if(s)for(let c=0,h=o.length;c<h;c++){const p=o[c];p[2]=s(p[2])}}:null}};u([d({type:String,json:{write:!0}})],ma.prototype,"displayFieldName",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ma.prototype,"exceededTransferLimit",void 0),u([d({type:[oa],json:{write:!0}})],ma.prototype,"features",void 0),u([Ae("features")],ma.prototype,"readFeatures",null),u([d({type:[yV],json:{write:!0}})],ma.prototype,"fields",void 0),u([d({type:["point","multipoint","polyline","polygon","extent","mesh"],json:{read:{reader:Bq.read}}})],ma.prototype,"geometryType",void 0),u([Ve("geometryType")],ma.prototype,"writeGeometryType",null),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ma.prototype,"hasM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ma.prototype,"hasZ",void 0),u([d({types:nS,json:{write:!0}})],ma.prototype,"queryGeometry",void 0),u([Ae("queryGeometry")],ma.prototype,"readQueryGeometry",null),u([d({type:qe,json:{write:!0}})],ma.prototype,"spatialReference",void 0),u([Ve("spatialReference")],ma.prototype,"writeSpatialReference",null),u([d({json:{write:!0}})],ma.prototype,"transform",void 0),ma=zq=u([R("esri.rest.support.FeatureSet")],ma),ma.prototype.toJSON.isDefaultToJSON=!0;const QK=ma;let OZe=0;const TSe="esri.layers.graphics.sources.MemorySource",Z9=K.getLogger(TSe);let Uy=class extends _g.LoadableMixin(e$(Oc(Ke))){constructor(e){super(e),this._idToClientGraphic=null,this.type="memory"}load(e){const r=e!=null?e.signal:null;return this.addResolvingPromise(this._startWorker(r)),Promise.resolve(this)}destroy(){this._connection?.close(),this._connection=null}get _workerGeometryType(){const e=this.layer?.geometryType;return e?this._geometryTypeRequiresClientGraphicMapping(e)?"polygon":e:null}applyEdits(e){return this.load().then(()=>this._applyEdits(e))}openPorts(){return this.load().then(()=>this._connection.openPorts())}async queryFeatures(e,r={}){await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);Pae(e,this.layer.spatialReference,i);const s=QK.fromJSON(i);if(!this._requiresClientGraphicMapping())return s;const n=this.layer.objectIdField;for(const o of s.features){const a=o.attributes[n],l=this._idToClientGraphic.get(a);l&&(o.geometry=l.geometry)}return s.geometryType=this.layer.geometryType,s}async queryFeaturesJSON(e,r={}){if(this._requiresClientGraphicMapping())throw new D("query-features-json:unsupported","Cannot query in JSON format for client only geometry types (mesh and extent)");await this.load(r);const i=await this._connection.invoke("queryFeatures",e?e.toJSON():null,r);return Pae(e,this.layer.spatialReference,i),i}queryFeatureCount(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryFeatureCount",e?e.toJSON():null,r))}queryObjectIds(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryObjectIds",e?e.toJSON():null,r))}queryExtent(e,r={}){return this.load(r).then(()=>this._connection.invoke("queryExtent",e?e.toJSON():null,r)).then(i=>({count:i.count,extent:vr.fromJSON(i.extent)}))}querySnapping(e,r={}){return this.load(r).then(()=>this._connection.invoke("querySnapping",e,r))}async _applyEdits(e){if(!this._connection)throw new D("feature-layer-source:edit-failure","Memory source not loaded");const r=this.layer.objectIdField;let i=null;const s=[],n=[];await Promise.all([this._prepareClientMapping(e.addFeatures,null),this._prepareClientMapping(e.updateFeatures,null)]);const o=h=>"objectId"in h&&h.objectId!=null?h.objectId:"attributes"in h&&h.attributes[r]!=null?h.attributes[r]:null;if(e.addFeatures&&(i=this._prepareAddFeatures(e.addFeatures)),e.deleteFeatures)for(const h of e.deleteFeatures){const p=o(h);p!=null&&s.push(p)}const a=e.updateFeatures&&this._idToClientGraphic?new Map:null;if(e.updateFeatures){for(const h of e.updateFeatures)if(n.push(this._serializeFeature(h)),a){const p=o(h);p!=null&&a.set(p,h)}}vZe(i?i.features:null,n,this.layer.spatialReference);const{fullExtent:l,featureEditResults:c}=await this._connection.invoke("applyEdits",{adds:i?i.features:[],updates:n,deletes:s});return this.fullExtent=l,i&&i.finish(c.uidToObjectId),this._updateClientGraphicIds(a,c),this._createEditsResult(c)}async _prepareClientMapping(e,r){if(this._layerOrSourceGeometryType!=="mesh"||e==null)return;const i=[];for(const{geometry:s}of e)s==null||s.type!=="mesh"||s.hasExtent||s.loaded||i.push(s.load({signal:r}));i.length&&await Promise.all(i)}_updateClientGraphicIds(e,r){if(this._idToClientGraphic){if(e)for(const i of r.updateResults){if(!i.success)continue;const s=e.get(i.objectId);s!=null&&this._addIdToClientGraphic(s)}for(const i of r.deleteResults)i.success&&this._idToClientGraphic.delete(i.objectId)}}_createEditsResult(e){return{addFeatureResults:e.addResults?e.addResults.map(this._createFeatureEditResult,this):[],updateFeatureResults:e.updateResults?e.updateResults.map(this._createFeatureEditResult,this):[],deleteFeatureResults:e.deleteResults?e.deleteResults.map(this._createFeatureEditResult,this):[],addAttachmentResults:[],updateAttachmentResults:[],deleteAttachmentResults:[]}}_createFeatureEditResult(e){const r=e.success===!0?null:e.error||{code:void 0,description:void 0};return{objectId:e.objectId,globalId:e.globalId,error:r?new D("feature-layer-source:edit-failure",r.description,{code:r.code}):null}}_prepareAddFeatures(e){const r=new Map,i=new Array(e.length);let s=null;for(let o=0;o<e.length;o++){const a=e[o],l=this._serializeFeature(a);s||a.geometry==null||(s=a.geometry.type),i[o]=l,r.set(`${l.uid}`,a)}const n=this;return{features:i,inferredGeometryType:s,finish(o){const a=n.sourceJSON.objectIdField;for(const l in o){const c=o[l],h=r.get(l);h&&(h.attributes||(h.attributes={}),c===-1?delete h.attributes[a]:h.attributes[a]=c,n._addIdToClientGraphic(h))}}}}_addIdToClientGraphic(e){if(!this._idToClientGraphic)return;const r=this.sourceJSON.objectIdField,i=e.attributes&&e.attributes[r];i!=null&&this._idToClientGraphic.set(i,e)}get _layerOrSourceGeometryType(){return this.layer?.geometryType??this.sourceJSON?.geometryType}_requiresClientGraphicMapping(){return this._geometryTypeRequiresClientGraphicMapping(this._layerOrSourceGeometryType)}_geometryRequiresClientGraphicMapping(e){return this._geometryTypeRequiresClientGraphicMapping(e.type)}_geometryTypeRequiresClientGraphicMapping(e){return e==="mesh"||e==="multipatch"||e==="extent"}_serializeFeature(e){const{attributes:r}=e,i=this._geometryForSerialization(e),s=(OZe++).toString();return i?{uid:s,geometry:i.toJSON(),attributes:r}:{uid:s,attributes:r}}_geometryForSerialization(e){const{geometry:r}=e;return r==null?null:this._geometryRequiresClientGraphicMapping(r)?r.extent?bc.fromExtent(r.extent):null:r}async _startWorker(e){this._connection=await bSe("MemorySourceWorker",{strategy:le("feature-layers-workers")?"dedicated":"local",signal:e});const{fields:r,spatialReference:i,objectIdField:s,hasM:n,hasZ:o,timeInfo:a}=this.layer,l=this.layer.originOf("spatialReference")==="defaults";await this._prepareClientMapping(this.items,e);const c=this._prepareAddFeatures(this.items);this.handles.add(this.on("before-changes",m=>{Z9.error("Source modifications will not propagate after layer has been loaded. Please use .applyEdits() instead"),m.preventDefault()}));const h={features:c.features,fields:r&&r.map(m=>m.toJSON()),geometryType:Cne.toJSON(this._workerGeometryType),hasM:this._layerOrSourceGeometryType!=="mesh"&&n,hasZ:this._layerOrSourceGeometryType==="mesh"||o,objectIdField:s,spatialReference:l?null:i&&i.toJSON(),timeInfo:a?a.toJSON():null},p=await this._connection.invoke("load",h,{signal:e});for(const m of p.warnings)Z9.warn(m.message,{layer:this.layer,warning:m});p.featureErrors.length&&Z9.warn(`Encountered ${p.featureErrors.length} validation errors while loading features`,p.featureErrors);const f=p.layerDefinition;this._geometryTypeRequiresClientGraphicMapping(c.inferredGeometryType)&&(f.geometryType=Cne.toJSON(c.inferredGeometryType)),this.sourceJSON=f,this._requiresClientGraphicMapping()&&(this._idToClientGraphic=new Map),c.finish(p.assignedObjectIds)}};u([oK({Type:oa,ensureType:Sn(oa)})],Uy.prototype,"itemType",void 0),u([d()],Uy.prototype,"type",void 0),u([d({constructOnly:!0})],Uy.prototype,"layer",void 0),u([d({readOnly:!0})],Uy.prototype,"_workerGeometryType",null),u([d()],Uy.prototype,"sourceJSON",void 0),Uy=u([R(TSe)],Uy);function RZe(t){return"portalItem"in t}const SSe=t=>{let e=class extends t{get apiKey(){return this._isOverridden("apiKey")?this._get("apiKey"):RZe(this)?this.portalItem?.apiKey:null}set apiKey(r){r!=null?this._override("apiKey",r):(this._clearOverride("apiKey"),this.clear("apiKey","user"))}};return u([d({type:String})],e.prototype,"apiKey",null),e=u([R("esri.layers.mixins.APIKeyMixin")],e),e},ESe=t=>{let e=class extends t{get title(){if(this._get("title")&&this.originOf("title")!=="defaults")return this._get("title");if(this.url){const r=sg(this.url);if(r!=null&&r.title)return r.title}return this._get("title")||""}set title(r){this._set("title",r)}set url(r){this._set("url",Cqe(r,K.getLogger(this)))}};return u([d()],e.prototype,"title",null),u([d({type:String})],e.prototype,"url",null),e=u([R("esri.layers.mixins.ArcGISService")],e),e};function _V(){const t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t}function MZe(t){const e=new Float32Array(16);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function IZe(t,e,r,i,s,n,o,a,l,c,h,p,f,m,g,_){const v=new Float32Array(16);return v[0]=t,v[1]=e,v[2]=r,v[3]=i,v[4]=s,v[5]=n,v[6]=o,v[7]=a,v[8]=l,v[9]=c,v[10]=h,v[11]=p,v[12]=f,v[13]=m,v[14]=g,v[15]=_,v}function PZe(t,e){return new Float32Array(t,e,16)}const $Ze=_V();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:$Ze,clone:MZe,create:_V,createView:PZe,fromValues:IZe},Symbol.toStringTag,{value:"Module"}));function an(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function Dg(t,e,r,i,s,n,o,a,l,c,h,p,f,m,g,_,v){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t[9]=h,t[10]=p,t[11]=f,t[12]=m,t[13]=g,t[14]=_,t[15]=v,t}function jd(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Ou(t,e){if(t===e){const r=e[1],i=e[2],s=e[3],n=e[6],o=e[7],a=e[11];t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=r,t[6]=e[9],t[7]=e[13],t[8]=i,t[9]=n,t[11]=e[14],t[12]=s,t[13]=o,t[14]=a}else t[0]=e[0],t[1]=e[4],t[2]=e[8],t[3]=e[12],t[4]=e[1],t[5]=e[5],t[6]=e[9],t[7]=e[13],t[8]=e[2],t[9]=e[6],t[10]=e[10],t[11]=e[14],t[12]=e[3],t[13]=e[7],t[14]=e[11],t[15]=e[15];return t}function mO(t,e){return so(t,e)||jd(t),t}function so(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],g=e[12],_=e[13],v=e[14],b=e[15],x=r*a-i*o,T=r*l-s*o,S=r*c-n*o,O=i*l-s*a,A=i*c-n*a,M=s*c-n*l,P=h*_-p*g,F=h*v-f*g,$=h*b-m*g,N=p*v-f*_,U=p*b-m*_,X=f*b-m*v;let Z=x*X-T*U+S*N+O*$-A*F+M*P;return Z?(Z=1/Z,t[0]=(a*X-l*U+c*N)*Z,t[1]=(s*U-i*X-n*N)*Z,t[2]=(_*M-v*A+b*O)*Z,t[3]=(f*A-p*M-m*O)*Z,t[4]=(l*$-o*X-c*F)*Z,t[5]=(r*X-s*$+n*F)*Z,t[6]=(v*S-g*M-b*T)*Z,t[7]=(h*M-f*S+m*T)*Z,t[8]=(o*U-a*$+c*P)*Z,t[9]=(i*$-r*U-n*P)*Z,t[10]=(g*A-_*S+b*x)*Z,t[11]=(p*S-h*A-m*x)*Z,t[12]=(a*F-o*N-l*P)*Z,t[13]=(r*N-i*F+s*P)*Z,t[14]=(_*T-g*O-v*x)*Z,t[15]=(h*O-p*T+f*x)*Z,t):null}function LZe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],g=e[12],_=e[13],v=e[14],b=e[15];return t[0]=a*(f*b-m*v)-p*(l*b-c*v)+_*(l*m-c*f),t[1]=-(i*(f*b-m*v)-p*(s*b-n*v)+_*(s*m-n*f)),t[2]=i*(l*b-c*v)-a*(s*b-n*v)+_*(s*c-n*l),t[3]=-(i*(l*m-c*f)-a*(s*m-n*f)+p*(s*c-n*l)),t[4]=-(o*(f*b-m*v)-h*(l*b-c*v)+g*(l*m-c*f)),t[5]=r*(f*b-m*v)-h*(s*b-n*v)+g*(s*m-n*f),t[6]=-(r*(l*b-c*v)-o*(s*b-n*v)+g*(s*c-n*l)),t[7]=r*(l*m-c*f)-o*(s*m-n*f)+h*(s*c-n*l),t[8]=o*(p*b-m*_)-h*(a*b-c*_)+g*(a*m-c*p),t[9]=-(r*(p*b-m*_)-h*(i*b-n*_)+g*(i*m-n*p)),t[10]=r*(a*b-c*_)-o*(i*b-n*_)+g*(i*c-n*a),t[11]=-(r*(a*m-c*p)-o*(i*m-n*p)+h*(i*c-n*a)),t[12]=-(o*(p*v-f*_)-h*(a*v-l*_)+g*(a*f-l*p)),t[13]=r*(p*v-f*_)-h*(i*v-s*_)+g*(i*f-s*p),t[14]=-(r*(a*v-l*_)-o*(i*v-s*_)+g*(i*l-s*a)),t[15]=r*(a*f-l*p)-o*(i*f-s*p)+h*(i*l-s*a),t}function DZe(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=t[9],p=t[10],f=t[11],m=t[12],g=t[13],_=t[14],v=t[15];return(e*o-r*n)*(p*v-f*_)-(e*a-i*n)*(h*v-f*g)+(e*l-s*n)*(h*_-p*g)+(r*a-i*o)*(c*v-f*m)-(r*l-s*o)*(c*_-p*m)+(i*l-s*a)*(c*g-h*m)}function yi(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=e[9],m=e[10],g=e[11],_=e[12],v=e[13],b=e[14],x=e[15];let T=r[0],S=r[1],O=r[2],A=r[3];return t[0]=T*i+S*a+O*p+A*_,t[1]=T*s+S*l+O*f+A*v,t[2]=T*n+S*c+O*m+A*b,t[3]=T*o+S*h+O*g+A*x,T=r[4],S=r[5],O=r[6],A=r[7],t[4]=T*i+S*a+O*p+A*_,t[5]=T*s+S*l+O*f+A*v,t[6]=T*n+S*c+O*m+A*b,t[7]=T*o+S*h+O*g+A*x,T=r[8],S=r[9],O=r[10],A=r[11],t[8]=T*i+S*a+O*p+A*_,t[9]=T*s+S*l+O*f+A*v,t[10]=T*n+S*c+O*m+A*b,t[11]=T*o+S*h+O*g+A*x,T=r[12],S=r[13],O=r[14],A=r[15],t[12]=T*i+S*a+O*p+A*_,t[13]=T*s+S*l+O*f+A*v,t[14]=T*n+S*c+O*m+A*b,t[15]=T*o+S*h+O*g+A*x,t}function Cc(t,e,r){const i=r[0],s=r[1],n=r[2];if(e===t)t[12]=e[0]*i+e[4]*s+e[8]*n+e[12],t[13]=e[1]*i+e[5]*s+e[9]*n+e[13],t[14]=e[2]*i+e[6]*s+e[10]*n+e[14],t[15]=e[3]*i+e[7]*s+e[11]*n+e[15];else{const o=e[0],a=e[1],l=e[2],c=e[3],h=e[4],p=e[5],f=e[6],m=e[7],g=e[8],_=e[9],v=e[10],b=e[11];t[0]=o,t[1]=a,t[2]=l,t[3]=c,t[4]=h,t[5]=p,t[6]=f,t[7]=m,t[8]=g,t[9]=_,t[10]=v,t[11]=b,t[12]=o*i+h*s+g*n+e[12],t[13]=a*i+p*s+_*n+e[13],t[14]=l*i+f*s+v*n+e[14],t[15]=c*i+m*s+b*n+e[15]}return t}function vV(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i,t[3]=e[3]*i,t[4]=e[4]*s,t[5]=e[5]*s,t[6]=e[6]*s,t[7]=e[7]*s,t[8]=e[8]*n,t[9]=e[9]*n,t[10]=e[10]*n,t[11]=e[11]*n,t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15],t}function _u(t,e,r,i){let s,n,o,a,l,c,h,p,f,m,g,_,v,b,x,T,S,O,A,M,P,F,$,N,U=i[0],X=i[1],Z=i[2],G=Math.sqrt(U*U+X*X+Z*Z);return G<sl()?null:(G=1/G,U*=G,X*=G,Z*=G,s=Math.sin(r),n=Math.cos(r),o=1-n,a=e[0],l=e[1],c=e[2],h=e[3],p=e[4],f=e[5],m=e[6],g=e[7],_=e[8],v=e[9],b=e[10],x=e[11],T=U*U*o+n,S=X*U*o+Z*s,O=Z*U*o-X*s,A=U*X*o-Z*s,M=X*X*o+n,P=Z*X*o+U*s,F=U*Z*o+X*s,$=X*Z*o-U*s,N=Z*Z*o+n,t[0]=a*T+p*S+_*O,t[1]=l*T+f*S+v*O,t[2]=c*T+m*S+b*O,t[3]=h*T+g*S+x*O,t[4]=a*A+p*M+_*P,t[5]=l*A+f*M+v*P,t[6]=c*A+m*M+b*P,t[7]=h*A+g*M+x*P,t[8]=a*F+p*$+_*N,t[9]=l*F+f*$+v*N,t[10]=c*F+m*$+b*N,t[11]=h*F+g*$+x*N,e!==t&&(t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t)}function dA(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[4],o=e[5],a=e[6],l=e[7],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[4]=n*s+c*i,t[5]=o*s+h*i,t[6]=a*s+p*i,t[7]=l*s+f*i,t[8]=c*s-n*i,t[9]=h*s-o*i,t[10]=p*s-a*i,t[11]=f*s-l*i,t}function bV(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[8],h=e[9],p=e[10],f=e[11];return e!==t&&(t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s-c*i,t[1]=o*s-h*i,t[2]=a*s-p*i,t[3]=l*s-f*i,t[8]=n*i+c*s,t[9]=o*i+h*s,t[10]=a*i+p*s,t[11]=l*i+f*s,t}function pA(t,e,r){const i=Math.sin(r),s=Math.cos(r),n=e[0],o=e[1],a=e[2],l=e[3],c=e[4],h=e[5],p=e[6],f=e[7];return e!==t&&(t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[12],t[13]=e[13],t[14]=e[14],t[15]=e[15]),t[0]=n*s+c*i,t[1]=o*s+h*i,t[2]=a*s+p*i,t[3]=l*s+f*i,t[4]=c*s-n*i,t[5]=h*s-o*i,t[6]=p*s-a*i,t[7]=f*s-l*i,t}function d$(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=e[0],t[13]=e[1],t[14]=e[2],t[15]=1,t}function NZe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=e[1],t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=e[2],t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function Th(t,e,r){if(e===0)return jd(t);let i,s,n,o=r[0],a=r[1],l=r[2],c=Math.sqrt(o*o+a*a+l*l);return c<sl()?null:(c=1/c,o*=c,a*=c,l*=c,i=Math.sin(e),s=Math.cos(e),n=1-s,t[0]=o*o*n+s,t[1]=a*o*n+l*i,t[2]=l*o*n-a*i,t[3]=0,t[4]=o*a*n-l*i,t[5]=a*a*n+s,t[6]=l*a*n+o*i,t[7]=0,t[8]=o*l*n+a*i,t[9]=a*l*n-o*i,t[10]=l*l*n+s,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t)}function CSe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=r,t[7]=0,t[8]=0,t[9]=-r,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function FZe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=0,t[2]=-r,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=r,t[9]=0,t[10]=i,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function ASe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=0,t[4]=-r,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function OSe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=i+i,l=s+s,c=n+n,h=i*a,p=i*l,f=i*c,m=s*l,g=s*c,_=n*c,v=o*a,b=o*l,x=o*c;return t[0]=1-(m+_),t[1]=p+x,t[2]=f-b,t[3]=0,t[4]=p-x,t[5]=1-(h+_),t[6]=g+v,t[7]=0,t[8]=f+b,t[9]=g-v,t[10]=1-(h+m),t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function kZe(t,e){const r=UZe,i=-e[0],s=-e[1],n=-e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=i*i+s*s+n*n+o*o;return p>0?(r[0]=2*(a*o+h*i+l*n-c*s)/p,r[1]=2*(l*o+h*s+c*i-a*n)/p,r[2]=2*(c*o+h*n+a*s-l*i)/p):(r[0]=2*(a*o+h*i+l*n-c*s),r[1]=2*(l*o+h*s+c*i-a*n),r[2]=2*(c*o+h*n+a*s-l*i)),OSe(t,e,r),t}const UZe=C();function Gq(t,e){return t[0]=e[12],t[1]=e[13],t[2]=e[14],t}function RSe(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10];return t[0]=Math.sqrt(r*r+i*i+s*s),t[1]=Math.sqrt(n*n+o*o+a*a),t[2]=Math.sqrt(l*l+c*c+h*h),t}function VZe(t,e){const r=e[0]+e[5]+e[10];let i=0;return r>0?(i=2*Math.sqrt(r+1),t[3]=.25*i,t[0]=(e[6]-e[9])/i,t[1]=(e[8]-e[2])/i,t[2]=(e[1]-e[4])/i):e[0]>e[5]&&e[0]>e[10]?(i=2*Math.sqrt(1+e[0]-e[5]-e[10]),t[3]=(e[6]-e[9])/i,t[0]=.25*i,t[1]=(e[1]+e[4])/i,t[2]=(e[8]+e[2])/i):e[5]>e[10]?(i=2*Math.sqrt(1+e[5]-e[0]-e[10]),t[3]=(e[8]-e[2])/i,t[0]=(e[1]+e[4])/i,t[1]=.25*i,t[2]=(e[6]+e[9])/i):(i=2*Math.sqrt(1+e[10]-e[0]-e[5]),t[3]=(e[1]-e[4])/i,t[0]=(e[8]+e[2])/i,t[1]=(e[6]+e[9])/i,t[2]=.25*i),t}function zZe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3],l=s+s,c=n+n,h=o+o,p=s*l,f=s*c,m=s*h,g=n*c,_=n*h,v=o*h,b=a*l,x=a*c,T=a*h,S=i[0],O=i[1],A=i[2];return t[0]=(1-(g+v))*S,t[1]=(f+T)*S,t[2]=(m-x)*S,t[3]=0,t[4]=(f-T)*O,t[5]=(1-(p+v))*O,t[6]=(_+b)*O,t[7]=0,t[8]=(m+x)*A,t[9]=(_-b)*A,t[10]=(1-(p+g))*A,t[11]=0,t[12]=r[0],t[13]=r[1],t[14]=r[2],t[15]=1,t}function BZe(t,e,r,i,s){const n=e[0],o=e[1],a=e[2],l=e[3],c=n+n,h=o+o,p=a+a,f=n*c,m=n*h,g=n*p,_=o*h,v=o*p,b=a*p,x=l*c,T=l*h,S=l*p,O=i[0],A=i[1],M=i[2],P=s[0],F=s[1],$=s[2],N=(1-(_+b))*O,U=(m+S)*O,X=(g-T)*O,Z=(m-S)*A,G=(1-(f+b))*A,ee=(v+x)*A,I=(g+T)*M,V=(v-x)*M,z=(1-(f+_))*M;return t[0]=N,t[1]=U,t[2]=X,t[3]=0,t[4]=Z,t[5]=G,t[6]=ee,t[7]=0,t[8]=I,t[9]=V,t[10]=z,t[11]=0,t[12]=r[0]+P-(N*P+Z*F+I*$),t[13]=r[1]+F-(U*P+G*F+V*$),t[14]=r[2]+$-(X*P+ee*F+z*$),t[15]=1,t}function GZe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,g=s*l,_=n*o,v=n*a,b=n*l;return t[0]=1-p-g,t[1]=h+b,t[2]=f-v,t[3]=0,t[4]=h-b,t[5]=1-c-g,t[6]=m+_,t[7]=0,t[8]=f+v,t[9]=m-_,t[10]=1-c-p,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}function MSe(t,e,r,i,s,n,o){const a=1/(r-e),l=1/(s-i),c=1/(n-o);return t[0]=2*n*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2*n*l,t[6]=0,t[7]=0,t[8]=(r+e)*a,t[9]=(s+i)*l,t[10]=(o+n)*c,t[11]=-1,t[12]=0,t[13]=0,t[14]=o*n*2*c,t[15]=0,t}function jZe(t,e,r,i,s){const n=1/Math.tan(e/2);let o;return t[0]=n/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=n,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,s!=null&&s!==1/0?(o=1/(i-s),t[10]=(s+i)*o,t[14]=2*s*i*o):(t[10]=-1,t[14]=-2*i),t}function HZe(t,e,r,i){const s=Math.tan(e.upDegrees*Math.PI/180),n=Math.tan(e.downDegrees*Math.PI/180),o=Math.tan(e.leftDegrees*Math.PI/180),a=Math.tan(e.rightDegrees*Math.PI/180),l=2/(o+a),c=2/(s+n);return t[0]=l,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=c,t[6]=0,t[7]=0,t[8]=-(o-a)*l*.5,t[9]=(s-n)*c*.5,t[10]=i/(r-i),t[11]=-1,t[12]=0,t[13]=0,t[14]=i*r/(r-i),t[15]=0,t}function ISe(t,e,r,i,s,n,o){const a=1/(e-r),l=1/(i-s),c=1/(n-o);return t[0]=-2*a,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=-2*l,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=2*c,t[11]=0,t[12]=(e+r)*a,t[13]=(s+i)*l,t[14]=(o+n)*c,t[15]=1,t}function wV(t,e,r,i){const s=e[0],n=e[1],o=e[2];let a=s-r[0],l=n-r[1],c=o-r[2];const h=sl();if(Math.abs(a)<h&&Math.abs(l)<h&&Math.abs(c)<h)return void jd(t);let p=1/Math.sqrt(a*a+l*l+c*c);a*=p,l*=p,c*=p;const f=i[0],m=i[1],g=i[2];let _=m*c-g*l,v=g*a-f*c,b=f*l-m*a;p=Math.sqrt(_*_+v*v+b*b),p?(p=1/p,_*=p,v*=p,b*=p):(_=0,v=0,b=0);let x=l*b-c*v,T=c*_-a*b,S=a*v-l*_;p=Math.sqrt(x*x+T*T+S*S),p?(p=1/p,x*=p,T*=p,S*=p):(x=0,T=0,S=0),t[0]=_,t[1]=x,t[2]=a,t[3]=0,t[4]=v,t[5]=T,t[6]=l,t[7]=0,t[8]=b,t[9]=S,t[10]=c,t[11]=0,t[12]=-(_*s+v*n+b*o),t[13]=-(x*s+T*n+S*o),t[14]=-(a*s+l*n+c*o),t[15]=1}function PSe(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=i[0],l=i[1],c=i[2];let h=s-r[0],p=n-r[1],f=o-r[2],m=h*h+p*p+f*f;m>0&&(m=1/Math.sqrt(m),h*=m,p*=m,f*=m);let g=l*f-c*p,_=c*h-a*f,v=a*p-l*h;return m=g*g+_*_+v*v,m>0&&(m=1/Math.sqrt(m),g*=m,_*=m,v*=m),t[0]=g,t[1]=_,t[2]=v,t[3]=0,t[4]=p*v-f*_,t[5]=f*g-h*v,t[6]=h*_-p*g,t[7]=0,t[8]=h,t[9]=p,t[10]=f,t[11]=0,t[12]=s,t[13]=n,t[14]=o,t[15]=1,t}function qZe(t){return"mat4("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+", "+t[9]+", "+t[10]+", "+t[11]+", "+t[12]+", "+t[13]+", "+t[14]+", "+t[15]+")"}function WZe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2+t[9]**2+t[10]**2+t[11]**2+t[12]**2+t[13]**2+t[14]**2+t[15]**2)}function ZZe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t[9]=e[9]+r[9],t[10]=e[10]+r[10],t[11]=e[11]+r[11],t[12]=e[12]+r[12],t[13]=e[13]+r[13],t[14]=e[14]+r[14],t[15]=e[15]+r[15],t}function $Se(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t[9]=e[9]-r[9],t[10]=e[10]-r[10],t[11]=e[11]-r[11],t[12]=e[12]-r[12],t[13]=e[13]-r[13],t[14]=e[14]-r[14],t[15]=e[15]-r[15],t}function XZe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t[9]=e[9]*r,t[10]=e[10]*r,t[11]=e[11]*r,t[12]=e[12]*r,t[13]=e[13]*r,t[14]=e[14]*r,t[15]=e[15]*r,t}function YZe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t[9]=e[9]+r[9]*i,t[10]=e[10]+r[10]*i,t[11]=e[11]+r[11]*i,t[12]=e[12]+r[12]*i,t[13]=e[13]+r[13]*i,t[14]=e[14]+r[14]*i,t[15]=e[15]+r[15]*i,t}function LSe(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]&&t[9]===e[9]&&t[10]===e[10]&&t[11]===e[11]&&t[12]===e[12]&&t[13]===e[13]&&t[14]===e[14]&&t[15]===e[15]}function KK(t,e){if(t===e)return!0;const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=t[9],f=t[10],m=t[11],g=t[12],_=t[13],v=t[14],b=t[15],x=e[0],T=e[1],S=e[2],O=e[3],A=e[4],M=e[5],P=e[6],F=e[7],$=e[8],N=e[9],U=e[10],X=e[11],Z=e[12],G=e[13],ee=e[14],I=e[15],V=sl();return Math.abs(r-x)<=V*Math.max(1,Math.abs(r),Math.abs(x))&&Math.abs(i-T)<=V*Math.max(1,Math.abs(i),Math.abs(T))&&Math.abs(s-S)<=V*Math.max(1,Math.abs(s),Math.abs(S))&&Math.abs(n-O)<=V*Math.max(1,Math.abs(n),Math.abs(O))&&Math.abs(o-A)<=V*Math.max(1,Math.abs(o),Math.abs(A))&&Math.abs(a-M)<=V*Math.max(1,Math.abs(a),Math.abs(M))&&Math.abs(l-P)<=V*Math.max(1,Math.abs(l),Math.abs(P))&&Math.abs(c-F)<=V*Math.max(1,Math.abs(c),Math.abs(F))&&Math.abs(h-$)<=V*Math.max(1,Math.abs(h),Math.abs($))&&Math.abs(p-N)<=V*Math.max(1,Math.abs(p),Math.abs(N))&&Math.abs(f-U)<=V*Math.max(1,Math.abs(f),Math.abs(U))&&Math.abs(m-X)<=V*Math.max(1,Math.abs(m),Math.abs(X))&&Math.abs(g-Z)<=V*Math.max(1,Math.abs(g),Math.abs(Z))&&Math.abs(_-G)<=V*Math.max(1,Math.abs(_),Math.abs(G))&&Math.abs(v-ee)<=V*Math.max(1,Math.abs(v),Math.abs(ee))&&Math.abs(b-I)<=V*Math.max(1,Math.abs(b),Math.abs(I))}function eee(t){const e=sl(),r=t[0],i=t[1],s=t[2],n=t[4],o=t[5],a=t[6],l=t[8],c=t[9],h=t[10];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}function xV(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[8]===0&&t[9]===0&&t[10]===1}const JZe=yi,QZe=$Se;Object.freeze(Object.defineProperty({__proto__:null,add:ZZe,adjoint:LZe,copy:an,determinant:DZe,equals:KK,exactEquals:LSe,frob:WZe,fromQuat:GZe,fromQuat2:kZe,fromRotation:Th,fromRotationTranslation:OSe,fromRotationTranslationScale:zZe,fromRotationTranslationScaleOrigin:BZe,fromScaling:NZe,fromTranslation:d$,fromXRotation:CSe,fromYRotation:FZe,fromZRotation:ASe,frustum:MSe,getRotation:VZe,getScaling:RSe,getTranslation:Gq,hasIdentityRotation:xV,identity:jd,invert:so,invertOrIdentity:mO,isOrthoNormal:eee,lookAt:wV,mul:JZe,multiply:yi,multiplyScalar:XZe,multiplyScalarAndAdd:YZe,ortho:ISe,perspective:jZe,perspectiveFromFieldOfView:HZe,rotate:_u,rotateX:dA,rotateY:bV,rotateZ:pA,scale:vV,set:Dg,str:qZe,sub:QZe,subtract:$Se,targetTo:PSe,translate:Cc,transpose:Ou},Symbol.toStringTag,{value:"Module"}));const KZe=(t,e)=>{const r=Dg(t,e,0,0,0,0,e,0,0,0,0,e,0,0,0,0,1);return Ou(r,r)},eXe=(t,e)=>{const r=Dg(t,e,0,0,.5-.5*e,0,e,0,.5-.5*e,0,0,e,.5-.5*e,0,0,0,1);return Ou(r,r)},tXe=(t,e)=>{const r=1-e,i=Dg(t,.2126+.7874*r,.7152-.7152*r,.0722-.0722*r,0,.2126-.2126*r,.7152+.2848*r,.0722-.0722*r,0,.2126-.2126*r,.7152-.7152*r,.0722+.9278*r,0,0,0,0,1);return Ou(i,i)},rXe=(t,e)=>{const r=Math.sin(e*Math.PI/180),i=Math.cos(e*Math.PI/180),s=Dg(t,.213+.787*i-.213*r,.715-.715*i-.715*r,.072-.072*i+.928*r,0,.213-.213*i+.143*r,.715+.285*i+.14*r,.072-.072*i-.283*r,0,.213-.213*i-.787*r,.715-.715*i+.715*r,.072+.928*i+.072*r,0,0,0,0,1);return Ou(s,s)},iXe=(t,e)=>{const r=1-2*e,i=Dg(t,r,0,0,e,0,r,0,e,0,0,r,e,0,0,0,1);return Ou(i,i)},sXe=(t,e)=>{const r=Dg(t,.213+.787*e,.715-.715*e,.072-.072*e,0,.213-.213*e,.715+.285*e,.072-.072*e,0,.213-.213*e,.715-.715*e,.072+.928*e,0,0,0,0,1);return Ou(r,r)},nXe=(t,e)=>{const r=1-e,i=Dg(t,.393+.607*r,.769-.769*r,.189-.189*r,0,.349-.349*r,.686+.314*r,.168-.168*r,0,.272-.272*r,.534-.534*r,.131+.869*r,0,0,0,0,1);return Ou(i,i)};let DSe=class NSe{constructor(e,r,i){this.strength=e,this.radius=r,this.threshold=i,this.type="bloom"}interpolate(e,r,i){this.strength=cu(e.strength,r.strength,i),this.radius=cu(e.radius,r.radius,i),this.threshold=cu(e.threshold,r.threshold,i)}clone(){return new NSe(this.strength,this.radius,this.threshold)}toJSON(){return{type:"bloom",radius:qM(this.radius),strength:this.strength,threshold:this.threshold}}},FSe=class kSe{constructor(e){this.radius=e,this.type="blur"}interpolate(e,r,i){this.radius=Math.round(cu(e.radius,r.radius,i))}clone(){return new kSe(this.radius)}toJSON(){return{type:"blur",radius:qM(this.radius)}}},jq=class USe{constructor(e,r){this.type=e,this.amount=r,this.type!=="invert"&&this.type!=="grayscale"&&this.type!=="sepia"||(this.amount=Math.min(this.amount,1))}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.amount=cu(e.amount,r.amount,i),this._updateMatrix()}clone(){return new USe(this.type,this.amount)}toJSON(){return{type:this.type,amount:this.amount}}_updateMatrix(){const e=this._colorMatrix||_V();switch(this.type){case"brightness":this._colorMatrix=KZe(e,this.amount);break;case"contrast":this._colorMatrix=eXe(e,this.amount);break;case"grayscale":this._colorMatrix=tXe(e,this.amount);break;case"invert":this._colorMatrix=iXe(e,this.amount);break;case"saturate":this._colorMatrix=sXe(e,this.amount);break;case"sepia":this._colorMatrix=nXe(e,this.amount)}}},VSe=class zSe{constructor(e,r,i,s){this.offsetX=e,this.offsetY=r,this.blurRadius=i,this.color=s,this.type="drop-shadow"}interpolate(e,r,i){this.offsetX=cu(e.offsetX,r.offsetX,i),this.offsetY=cu(e.offsetY,r.offsetY,i),this.blurRadius=cu(e.blurRadius,r.blurRadius,i),this.color[0]=Math.round(cu(e.color[0],r.color[0],i)),this.color[1]=Math.round(cu(e.color[1],r.color[1],i)),this.color[2]=Math.round(cu(e.color[2],r.color[2],i)),this.color[3]=cu(e.color[3],r.color[3],i)}clone(){return new zSe(this.offsetX,this.offsetY,this.blurRadius,[...this.color])}toJSON(){const e=[...this.color];return e[3]*=255,{type:"drop-shadow",xoffset:qM(this.offsetX),yoffset:qM(this.offsetY),blurRadius:qM(this.blurRadius),color:e}}},BSe=class GSe{constructor(e){this.angle=e,this.type="hue-rotate"}get colorMatrix(){return this._colorMatrix||this._updateMatrix(),this._colorMatrix}interpolate(e,r,i){this.angle=cu(e.angle,r.angle,i),this._updateMatrix()}clone(){return new GSe(this.angle)}toJSON(){return{type:"hue-rotate",angle:this.angle}}_updateMatrix(){const e=this._colorMatrix||_V();this._colorMatrix=rXe(e,this.angle)}},jSe=class HSe{constructor(e){this.amount=e,this.type="opacity",this.amount=Math.min(this.amount,1)}interpolate(e,r,i){this.amount=cu(e.amount,r.amount,i)}clone(){return new HSe(this.amount)}toJSON(){return{type:"opacity",amount:this.amount}}};function cu(t,e,r){return t+(e-t)*r}function qM(t){return Math.round(1e3*Fl(t))/1e3}function oXe(t){switch(t.type){case"grayscale":case"sepia":case"invert":return new jq(t.type,0);case"saturate":case"brightness":case"contrast":return new jq(t.type,1);case"opacity":return new jSe(1);case"hue-rotate":return new BSe(0);case"blur":return new FSe(0);case"drop-shadow":return new VSe(0,0,0,[...hK("transparent")]);case"bloom":return new DSe(0,0,1)}}var ekt=typeof globalThis<"u"?globalThis:typeof window<"u"?window:typeof global<"u"?global:typeof self<"u"?self:{};function p$(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}function aXe(t,e){const r=t.length>e.length?t:e;return(t.length>e.length?e:t).every((i,s)=>i.type===r[s].type)}function lXe(t,e){const r=t.length>e.length?t:e,i=t.length>e.length?e:t;for(let s=i.length;s<r.length;s++)i.push(oXe(r[s]))}function cXe(t){const e=t[0];return!!e&&"type"in e}var $ae,Lae,Hq={exports:{}};Hq.exports,Lae=function(){function t(s,n){function o(){this.constructor=s}o.prototype=n.prototype,s.prototype=new o}function e(s,n,o,a){var l=Error.call(this,s);return Object.setPrototypeOf&&Object.setPrototypeOf(l,e.prototype),l.expected=n,l.found=o,l.location=a,l.name="SyntaxError",l}function r(s,n,o){return o=o||" ",s.length>n?s:(n-=s.length,s+(o+=o.repeat(n)).slice(0,n))}function i(s,n){var o,a={},l=(n=n!==void 0?n:{}).grammarSource,c={start:Bg},h=Bg,p="none",f=")",m=",",g="(",_="%",v="px",b="cm",x="mm",T="in",S="pt",O="pc",A="deg",M="rad",P="grad",F="turn",$="#",N=".",U="e",X=/^[ \t\n\r]/,Z=/^[a-z\-]/,G=/^[0-9a-fA-F]/,ee=/^[+\-]/,I=/^[0-9]/,V=Bl("none"),z=uo("none",!1),H=uo(")",!1),Y=uo(",",!1),te=Bl("whitespace"),ne=_b([" ","	",`
`,"\r"],!1,!1),ve=Bl("function"),Fe=uo("(",!1),bt=Bl("identifier"),Pt=_b([["a","z"],"-"],!1,!1),dt=Bl("percentage"),wt=uo("%",!1),be=Bl("length"),Me=uo("px",!1),Ct=uo("cm",!1),we=uo("mm",!1),je=uo("in",!1),Ze=uo("pt",!1),yt=uo("pc",!1),pt=Bl("angle"),He=uo("deg",!1),Tt=uo("rad",!1),fr=uo("grad",!1),ar=uo("turn",!1),Li=Bl("number"),ot=Bl("color"),at=uo("#",!1),_t=_b([["0","9"],["a","f"],["A","F"]],!1,!1),er=_b(["+","-"],!1,!1),lr=_b([["0","9"]],!1,!1),Qr=uo(".",!1),Di=uo("e",!1),tr=function(){return[]},Ni=function(q,ge){return{type:"function",name:q,parameters:ge||[]}},is=function(q,ge){return ge.length>0?LO(q,ge,3):[q]},Yr=function(q){return{type:"quantity",value:q.value,unit:q.unit}},Ar=function(q){return{type:"color",colorType:q.type,value:q.value}},hs=function(q){return q},Hs=function(){return Ic()},Vr=function(q){return{value:q,unit:"%"}},hi=function(q){return{value:q,unit:"px"}},Kr=function(q){return{value:q,unit:"cm"}},br=function(q){return{value:q,unit:"mm"}},xi=function(q){return{value:q,unit:"in"}},gn=function(q){return{value:q,unit:"pt"}},Vo=function(q){return{value:q,unit:"pc"}},zo=function(q){return{value:q,unit:"deg"}},Hn=function(q){return{value:q,unit:"rad"}},qn=function(q){return{value:q,unit:"grad"}},ds=function(q){return{value:q,unit:"turn"}},Wn=function(q){return{value:q,unit:null}},ei=function(){return{type:"hex",value:Ic()}},lo=function(q){return{type:"function",value:q}},ha=function(){return{type:"named",value:Ic()}},ol=function(){return parseFloat(Ic())},ce=0,ji=0,sp=[{line:1,column:1}],co=0,np=[],tt=0;if("startRule"in n){if(!(n.startRule in c))throw new Error(`Can't start parsing from rule "`+n.startRule+'".');h=c[n.startRule]}function Ic(){return s.substring(ji,ce)}function uo(q,ge){return{type:"literal",text:q,ignoreCase:ge}}function _b(q,ge,Ce){return{type:"class",parts:q,inverted:ge,ignoreCase:Ce}}function vb(){return{type:"end"}}function Bl(q){return{type:"other",description:q}}function zg(q){var ge,Ce=sp[q];if(Ce)return Ce;for(ge=q-1;!sp[ge];)ge--;for(Ce={line:(Ce=sp[ge]).line,column:Ce.column};ge<q;)s.charCodeAt(ge)===10?(Ce.line++,Ce.column=1):Ce.column++,ge++;return sp[q]=Ce,Ce}function bb(q,ge,Ce){var mr=zg(q),yn=zg(ge),Fi={source:l,start:{offset:q,line:mr.line,column:mr.column},end:{offset:ge,line:yn.line,column:yn.column}};return Ce&&l&&typeof l.offset=="function"&&(Fi.start=l.offset(Fi.start),Fi.end=l.offset(Fi.end)),Fi}function rr(q){ce<co||(ce>co&&(co=ce,np=[]),np.push(q))}function e_(q,ge,Ce){return new e(e.buildMessage(q,ge),q,ge,Ce)}function Bg(){var q;return(q=t_())===a&&(q=al()),q}function t_(){var q,ge;return tt++,q=ce,xs(),s.substr(ce,4)===p?(ge=p,ce+=4):(ge=a,tt===0&&rr(z)),ge!==a?(xs(),ji=q,q=tr()):(ce=q,q=a),tt--,q===a&&tt===0&&rr(V),q}function al(){var q,ge;if(q=[],(ge=Pc())!==a)for(;ge!==a;)q.push(ge),ge=Pc();else q=a;return q}function Pc(){var q,ge,Ce,mr;return q=ce,xs(),(ge=r_())!==a?(xs(),(Ce=Hf())===a&&(Ce=null),xs(),s.charCodeAt(ce)===41?(mr=f,ce++):(mr=a,tt===0&&rr(H)),mr!==a?(xs(),ji=q,q=Ni(ge,Ce)):(ce=q,q=a)):(ce=q,q=a),q}function Hf(){var q,ge,Ce,mr,yn,Fi,ll,Sb;if(q=ce,(ge=ho())!==a){for(Ce=[],mr=ce,yn=xs(),s.charCodeAt(ce)===44?(Fi=m,ce++):(Fi=a,tt===0&&rr(Y)),Fi===a&&(Fi=null),ll=xs(),(Sb=ho())!==a?mr=yn=[yn,Fi,ll,Sb]:(ce=mr,mr=a);mr!==a;)Ce.push(mr),mr=ce,yn=xs(),s.charCodeAt(ce)===44?(Fi=m,ce++):(Fi=a,tt===0&&rr(Y)),Fi===a&&(Fi=null),ll=xs(),(Sb=ho())!==a?mr=yn=[yn,Fi,ll,Sb]:(ce=mr,mr=a);ji=q,q=is(ge,Ce)}else ce=q,q=a;return q}function ho(){var q,ge;return q=ce,(ge=xb())===a&&(ge=TS())===a&&(ge=Tb())===a&&(ge=i_()),ge!==a&&(ji=q,ge=Yr(ge)),(q=ge)===a&&(q=ce,(ge=W$())!==a&&(ji=q,ge=Ar(ge)),q=ge),q}function xs(){var q,ge;for(tt++,q=[],X.test(s.charAt(ce))?(ge=s.charAt(ce),ce++):(ge=a,tt===0&&rr(ne));ge!==a;)q.push(ge),X.test(s.charAt(ce))?(ge=s.charAt(ce),ce++):(ge=a,tt===0&&rr(ne));return tt--,ge=a,tt===0&&rr(te),q}function r_(){var q,ge,Ce;return tt++,q=ce,(ge=wb())!==a?(s.charCodeAt(ce)===40?(Ce=g,ce++):(Ce=a,tt===0&&rr(Fe)),Ce!==a?(ji=q,q=hs(ge)):(ce=q,q=a)):(ce=q,q=a),tt--,q===a&&(ge=a,tt===0&&rr(ve)),q}function wb(){var q,ge,Ce;if(tt++,q=ce,ge=[],Z.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,tt===0&&rr(Pt)),Ce!==a)for(;Ce!==a;)ge.push(Ce),Z.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,tt===0&&rr(Pt));else ge=a;return ge!==a&&(ji=q,ge=Hs()),tt--,(q=ge)===a&&(ge=a,tt===0&&rr(bt)),q}function xb(){var q,ge,Ce;return tt++,q=ce,xs(),(ge=Gl())!==a?(s.charCodeAt(ce)===37?(Ce=_,ce++):(Ce=a,tt===0&&rr(wt)),Ce!==a?(ji=q,q=Vr(ge)):(ce=q,q=a)):(ce=q,q=a),tt--,q===a&&tt===0&&rr(dt),q}function TS(){var q,ge,Ce;return tt++,q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===v?(Ce=v,ce+=2):(Ce=a,tt===0&&rr(Me)),Ce!==a?(ji=q,q=hi(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===b?(Ce=b,ce+=2):(Ce=a,tt===0&&rr(Ct)),Ce!==a?(ji=q,q=Kr(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===x?(Ce=x,ce+=2):(Ce=a,tt===0&&rr(we)),Ce!==a?(ji=q,q=br(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===T?(Ce=T,ce+=2):(Ce=a,tt===0&&rr(je)),Ce!==a?(ji=q,q=xi(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===S?(Ce=S,ce+=2):(Ce=a,tt===0&&rr(Ze)),Ce!==a?(ji=q,q=gn(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,xs(),(ge=Gl())!==a?(s.substr(ce,2)===O?(Ce=O,ce+=2):(Ce=a,tt===0&&rr(yt)),Ce!==a?(ji=q,q=Vo(ge)):(ce=q,q=a)):(ce=q,q=a)))))),tt--,q===a&&tt===0&&rr(be),q}function Tb(){var q,ge,Ce;return tt++,q=ce,(ge=Gl())!==a?(s.substr(ce,3)===A?(Ce=A,ce+=3):(Ce=a,tt===0&&rr(He)),Ce!==a?(ji=q,q=zo(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,(ge=Gl())!==a?(s.substr(ce,3)===M?(Ce=M,ce+=3):(Ce=a,tt===0&&rr(Tt)),Ce!==a?(ji=q,q=Hn(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,(ge=Gl())!==a?(s.substr(ce,4)===P?(Ce=P,ce+=4):(Ce=a,tt===0&&rr(fr)),Ce!==a?(ji=q,q=qn(ge)):(ce=q,q=a)):(ce=q,q=a),q===a&&(q=ce,(ge=Gl())!==a?(s.substr(ce,4)===F?(Ce=F,ce+=4):(Ce=a,tt===0&&rr(ar)),Ce!==a?(ji=q,q=ds(ge)):(ce=q,q=a)):(ce=q,q=a)))),tt--,q===a&&(ge=a,tt===0&&rr(pt)),q}function i_(){var q,ge;return tt++,q=ce,xs(),(ge=Gl())!==a?(ji=q,q=Wn(ge)):(ce=q,q=a),tt--,q===a&&tt===0&&rr(Li),q}function W$(){var q,ge,Ce,mr;if(tt++,q=ce,s.charCodeAt(ce)===35?(ge=$,ce++):(ge=a,tt===0&&rr(at)),ge!==a){if(Ce=[],G.test(s.charAt(ce))?(mr=s.charAt(ce),ce++):(mr=a,tt===0&&rr(_t)),mr!==a)for(;mr!==a;)Ce.push(mr),G.test(s.charAt(ce))?(mr=s.charAt(ce),ce++):(mr=a,tt===0&&rr(_t));else Ce=a;Ce!==a?(ji=q,q=ei()):(ce=q,q=a)}else ce=q,q=a;return q===a&&(q=ce,(ge=Pc())!==a&&(ji=q,ge=lo(ge)),(q=ge)===a&&(q=ce,(ge=wb())!==a&&(ji=q,ge=ha()),q=ge)),tt--,q===a&&(ge=a,tt===0&&rr(ot)),q}function Gl(){var q,ge,Ce,mr,yn,Fi,ll;for(q=ce,ee.test(s.charAt(ce))?(s.charAt(ce),ce++):tt===0&&rr(er),ge=ce,Ce=[],I.test(s.charAt(ce))?(mr=s.charAt(ce),ce++):(mr=a,tt===0&&rr(lr));mr!==a;)Ce.push(mr),I.test(s.charAt(ce))?(mr=s.charAt(ce),ce++):(mr=a,tt===0&&rr(lr));if(s.charCodeAt(ce)===46?(mr=N,ce++):(mr=a,tt===0&&rr(Qr)),mr!==a){if(yn=[],I.test(s.charAt(ce))?(Fi=s.charAt(ce),ce++):(Fi=a,tt===0&&rr(lr)),Fi!==a)for(;Fi!==a;)yn.push(Fi),I.test(s.charAt(ce))?(Fi=s.charAt(ce),ce++):(Fi=a,tt===0&&rr(lr));else yn=a;yn!==a?ge=Ce=[Ce,mr,yn]:(ce=ge,ge=a)}else ce=ge,ge=a;if(ge===a)if(ge=[],I.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,tt===0&&rr(lr)),Ce!==a)for(;Ce!==a;)ge.push(Ce),I.test(s.charAt(ce))?(Ce=s.charAt(ce),ce++):(Ce=a,tt===0&&rr(lr));else ge=a;if(ge!==a){if(Ce=ce,s.charCodeAt(ce)===101?(mr=U,ce++):(mr=a,tt===0&&rr(Di)),mr!==a){if(ee.test(s.charAt(ce))?(yn=s.charAt(ce),ce++):(yn=a,tt===0&&rr(er)),yn===a&&(yn=null),Fi=[],I.test(s.charAt(ce))?(ll=s.charAt(ce),ce++):(ll=a,tt===0&&rr(lr)),ll!==a)for(;ll!==a;)Fi.push(ll),I.test(s.charAt(ce))?(ll=s.charAt(ce),ce++):(ll=a,tt===0&&rr(lr));else Fi=a;Fi!==a?Ce=mr=[mr,yn,Fi]:(ce=Ce,Ce=a)}else ce=Ce,Ce=a;Ce===a&&(Ce=null),ji=q,q=ol()}else ce=q,q=a;return q}function $O(q,ge){return q.map(function(Ce){return Ce[ge]})}function LO(q,ge,Ce){return[q].concat($O(ge,Ce))}if((o=h())!==a&&ce===s.length)return o;throw o!==a&&ce<s.length&&rr(vb()),e_(np,co<s.length?s.charAt(co):null,co<s.length?bb(co,co+1):bb(co,co))}return t(e,Error),e.prototype.format=function(s){var n="Error: "+this.message;if(this.location){var o,a=null;for(o=0;o<s.length;o++)if(s[o].source===this.location.source){a=s[o].text.split(/\r\n|\n|\r/g);break}var l=this.location.start,c=this.location.source&&typeof this.location.source.offset=="function"?this.location.source.offset(l):l,h=this.location.source+":"+c.line+":"+c.column;if(a){var p=this.location.end,f=r("",c.line.toString().length," "),m=a[l.line-1],g=(l.line===p.line?p.column:m.length+1)-l.column||1;n+=`
 --> `+h+`
`+f+` |
`+c.line+" | "+m+`
`+f+" | "+r("",l.column-1," ")+r("",g,"^")}else n+=`
 at `+h}return n},e.buildMessage=function(s,n){var o={literal:function(m){return'"'+l(m.text)+'"'},class:function(m){var g=m.parts.map(function(_){return Array.isArray(_)?c(_[0])+"-"+c(_[1]):c(_)});return"["+(m.inverted?"^":"")+g.join("")+"]"},any:function(){return"any character"},end:function(){return"end of input"},other:function(m){return m.description}};function a(m){return m.charCodeAt(0).toString(16).toUpperCase()}function l(m){return m.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+a(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+a(g)})}function c(m){return m.replace(/\\/g,"\\\\").replace(/\]/g,"\\]").replace(/\^/g,"\\^").replace(/-/g,"\\-").replace(/\0/g,"\\0").replace(/\t/g,"\\t").replace(/\n/g,"\\n").replace(/\r/g,"\\r").replace(/[\x00-\x0F]/g,function(g){return"\\x0"+a(g)}).replace(/[\x10-\x1F\x7F-\x9F]/g,function(g){return"\\x"+a(g)})}function h(m){return o[m.type](m)}function p(m){var g,_,v=m.map(h);if(v.sort(),v.length>0){for(g=1,_=1;g<v.length;g++)v[g-1]!==v[g]&&(v[_]=v[g],_++);v.length=_}switch(v.length){case 1:return v[0];case 2:return v[0]+" or "+v[1];default:return v.slice(0,-1).join(", ")+", or "+v[v.length-1]}}function f(m){return m?'"'+l(m)+'"':"end of input"}return"Expected "+p(s)+" but "+f(n)+" found."},{SyntaxError:e,parse:i}},($ae=Hq).exports&&($ae.exports=Lae());var uXe=Hq.exports;function qSe(t){if(!t||t.length===0)return null;if(typeof t=="string"){const r=Dae(t);return r&&r.length!==0?r:null}const e=t.map(r=>{if(!Number.isFinite(r.scale)||r.scale<=0)throw new D("effect:invalid-scale","scale must be finite and greater than 0",{stop:r});return{scale:r.scale,effects:Dae(r.value)}});e.sort((r,i)=>i.effects.length-r.effects.length);for(let r=0;r<e.length-1;r++){if(!aXe(e[r].effects,e[r+1].effects))throw new D("effect:interpolation-impossible","Cannot interpolate by scale between 2 lists of mixed effects",{a:e[r].effects,b:e[r+1].effects});lXe(e[r].effects,e[r+1].effects)}return e.sort((r,i)=>i.scale-r.scale),e}function Dae(t){let e;if(!t)return[];try{e=uXe.parse(t)}catch(r){throw new D("effect:invalid-syntax","Invalid effect syntax",{value:t,error:r})}return e.map(r=>hXe(r))}function hXe(t){try{switch(t.name){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":return dXe(t);case"opacity":return pXe(t);case"hue-rotate":return fXe(t);case"blur":return mXe(t);case"drop-shadow":return gXe(t);case"bloom":return yXe(t)}}catch(e){throw e.details.filter=t,e}throw new D("effect:unknown-effect",`Effect '${t.name}' is not supported`,{effect:t})}function dXe(t){let e=1;return gO(t.parameters,1),t.parameters.length===1&&(e=Qp(t.parameters[0])),new jq(t.name,e)}function pXe(t){let e=1;return gO(t.parameters,1),t.parameters.length===1&&(e=Qp(t.parameters[0])),new jSe(e)}function fXe(t){let e=0;return gO(t.parameters,1),t.parameters.length===1&&(e=TXe(t.parameters[0])),new BSe(e)}function mXe(t){let e=0;return gO(t.parameters,1),t.parameters.length===1&&(e=iee(t.parameters[0]),f$(e,t.parameters[0])),new FSe(e)}function gXe(t){const e=[];let r=null;for(const i of t.parameters)if(i.type==="color"){if(e.length&&Object.freeze(e),r)throw new D("effect:type-error","Accepts only one color",{});r=SXe(i)}else{const s=iee(i);if(Object.isFrozen(e))throw new D("effect:type-error","<length> parameters not consecutive",{lengths:e});e.push(s),e.length===3&&f$(s,i)}if(e.length<2||e.length>3)throw new D("effect:type-error",`Expected <length>{2,3}, Actual: <length>{${e.length}}`,{lengths:e});return new VSe(e[0],e[1],e[2]||0,r||WSe("black"))}function yXe(t){let e=1,r=0,i=0;return gO(t.parameters,3),t.parameters[0]&&(e=Qp(t.parameters[0])),t.parameters[1]&&(r=iee(t.parameters[1]),f$(r,t.parameters[1])),t.parameters[2]&&(i=Qp(t.parameters[2])),new DSe(e,r,i)}function gO(t,e){if(t.length>e)throw new D("effect:type-error",`Function supports up to ${e} parameters, Actual: ${t.length}`,{parameters:t})}function TV(t){if(t.type==="color")return"<color>";if(t.unit){if(t.unit in ree)return"<length>";if(t.unit in tee)return"<angle>";if(t.unit==="%")return"<percentage>"}return"<double>"}function f$(t,e){if(t<0)throw new D("effect:type-error",`Negative values are not allowed, Actual: ${t}`,{term:e})}function _Xe(t){if(t.type!=="quantity"||t.unit!==null)throw new D("effect:type-error",`Expected <double>, Actual: ${TV(t)}`,{term:t})}function vXe(t){if(t.type!=="quantity"||t.unit!==null&&t.unit!=="%")throw new D("effect:type-error",`Expected <double> or <percentage>, Actual: ${TV(t)}`,{term:t})}const tee={deg:1,grad:.9,rad:180/Math.PI,turn:360};function bXe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&tee[t.unit]!=null))throw new D("effect:type-error",`Expected <angle>, Actual: ${TV(t)}`,{term:t})}const ree={px:1,cm:96/2.54,mm:96/2.54/10,in:96,pc:16,pt:96/72};function wXe(t){if(t.type!=="quantity"||!(t.value===0&&t.unit===null||t.unit&&ree[t.unit]!=null))throw new D("effect:type-error",`Expected <length>, Actual: ${TV(t)}`,{term:t})}function Qp(t){vXe(t);const e=t.value;return f$(e,t),t.unit==="%"?.01*e:e}function xXe(t){return _Xe(t),f$(t.value,t),t.value}function TXe(t){return bXe(t),t.value*tee[t.unit]||0}function iee(t){return wXe(t),t.value*ree[t.unit]||0}function SXe(t){switch(t.colorType){case"hex":return qje(t.value);case"named":return WSe(t.value);case"function":return AXe(t.value)}}function WSe(t){if(!Ywe(t))throw new D("effect:unknown-color",`color '${t}' isn't valid`,{namedColor:t});return Hje(t)}const EXe=/^rgba?/i,CXe=/^hsla?/i;function AXe(t){if(gO(t.parameters,4),EXe.test(t.name))return[Qp(t.parameters[0]),Qp(t.parameters[1]),Qp(t.parameters[2]),t.parameters[3]?Qp(t.parameters[3]):1];if(CXe.test(t.name))return Jwe(xXe(t.parameters[0]),Qp(t.parameters[1]),Qp(t.parameters[2]),t.parameters[3]?Qp(t.parameters[3]):1);throw new D("effect:syntax-error",`Invalid color function '${t.name}'`,{colorFunction:t})}function see(t,e,r){try{return RXe(t)}catch(i){r?.messages?.push(i)}return null}function nee(t,e,r,i){try{const s=OXe(t);Ul(r,s,e)}catch(s){i.messages&&i.messages.push(s)}}function OXe(t){const e=qSe(t);return e?cXe(e)?e.map(r=>r.toJSON()):e.map(({scale:r,effects:i})=>({scale:r,value:i.map(s=>s.toJSON())})):null}function RXe(t){if(!t||t.length===0)return null;if(MXe(t)){const e=[];for(const r of t)e.push({scale:r.scale,value:qq(r.value)});return e}return qq(t)}function MXe(t){const e=t[0];return!!e&&"scale"in e}function qq(t){if(!t||!t.length)return"";const e=[];for(const r of t){let i=[];switch(r.type){case"grayscale":case"sepia":case"saturate":case"invert":case"brightness":case"contrast":case"opacity":i=[Gg(r,"amount")];break;case"blur":i=[Gg(r,"radius","pt")];break;case"hue-rotate":i=[Gg(r,"angle","deg")];break;case"drop-shadow":i=[Gg(r,"xoffset","pt"),Gg(r,"yoffset","pt"),Gg(r,"blurRadius","pt"),IXe(r,"color")];break;case"bloom":i=[Gg(r,"strength"),Gg(r,"radius","pt"),Gg(r,"threshold")]}const s=`${r.type}(${i.filter(Boolean).join(" ")})`;qSe(s),e.push(s)}return e.join(" ")}function Gg(t,e,r){if(t[e]==null)throw new D("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});return r?t[e]+r:""+t[e]}function IXe(t,e){if(t[e]==null)throw new D("effect:missing-parameter",`Missing parameter '${e}' in ${t.type} effect`,{effect:t});const r=t[e];return`rgba(${r[0]||0}, ${r[1]||0}, ${r[2]||0}, ${r[3]/255||0})`}const Nae={read:{reader:see},write:{allowNull:!0,writer:nee}},ZSe=t=>{let e=class extends t{constructor(){super(...arguments),this.blendMode="normal",this.effect=null}};return u([d({type:["average","color-burn","color-dodge","color","darken","destination-atop","destination-in","destination-out","destination-over","difference","exclusion","hard-light","hue","invert","lighten","lighter","luminosity","minus","multiply","normal","overlay","plus","reflect","saturation","screen","soft-light","source-atop","source-in","source-out","vivid-light","xor"],nonNullable:!0,json:{read:!1,write:!1,origins:{"web-map":{read:!0,write:!0},"portal-item":{read:!0,write:!0}}}})],e.prototype,"blendMode",void 0),u([d({json:{read:!1,write:!1,origins:{"web-map":Nae,"portal-item":Nae}}})],e.prototype,"effect",void 0),e=u([R("esri.layers.mixins.BlendLayer")],e),e},PXe=t=>{let e=class extends t{constructor(){super(...arguments),this.customParameters=null}};return u([d({type:Object,json:{write:{overridePolicy:r=>({enabled:!!(r&&Object.keys(r).length>0)})}}})],e.prototype,"customParameters",void 0),e=u([R("esri.layers.mixins.CustomParametersMixin")],e),e},XSe=new Xr.EventEmitter;function tkt(t,e,r=!1){const i=nn();return r=e==null||r,XSe.emit("apply-edits",{serviceUrl:t,layerId:e,mayReceiveServiceEdits:r,result:i.promise}),i}const YSe="esri.layers.mixins.EditBusLayer",JSe=Symbol(YSe);function rkt(t){return t!=null&&typeof t=="object"&&JSe in t}const QSe=t=>{var e;let r=class extends t{constructor(...i){super(...i),this[e]=!0,this.when().then(()=>{this.own([XSe.on("apply-edits",s=>{const{serviceUrl:n,layerId:o,mayReceiveServiceEdits:a,result:l}=s,c=n===this.url,h=o!=null&&this.layerId!=null&&o===this.layerId;if(!c||!h&&!a)return;const p=l.then(f=>{if(h&&(f.addedFeatures.length||f.updatedFeatures.length||f.deletedFeatures.length||f.addedAttachments.length||f.updatedAttachments.length||f.deletedAttachments.length))return this.emit("edits",re(f)),f;const m=f.editedFeatures?.find(({layerId:g})=>g===this.layerId);if(m){const{adds:g,updates:_,deletes:v}=m.editedFeatures,b={edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:g?g.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],deletedFeatures:v?v.map(({attributes:x})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],updatedFeatures:_?_.map(({current:{attributes:x}})=>({objectId:this.objectIdField&&x[this.objectIdField],globalId:this.globalIdField&&x[this.globalIdField]})):[],editedFeatures:re(f.editedFeatures),exceededTransferLimit:!1};return this.emit("edits",b),b}return{edits:null,addedAttachments:[],deletedAttachments:[],updatedAttachments:[],addedFeatures:[],deletedFeatures:[],updatedFeatures:[],editedFeatures:re(f.editedFeatures),exceededTransferLimit:!1}});this.emit("apply-edits",{result:p})})])},()=>{})}};return e=JSe,r=u([R(YSe)],r),r},Fae={milliseconds:1,seconds:1e3,minutes:6e4,hours:36e5,days:864e5,weeks:6048e5,months:26784e5,years:31536e6,decades:31536e7,centuries:31536e8},$Xe={milliseconds:{getter:"getMilliseconds",setter:"setMilliseconds",multiplier:1},seconds:{getter:"getSeconds",setter:"setSeconds",multiplier:1},minutes:{getter:"getMinutes",setter:"setMinutes",multiplier:1},hours:{getter:"getHours",setter:"setHours",multiplier:1},days:{getter:"getDate",setter:"setDate",multiplier:1},weeks:{getter:"getDate",setter:"setDate",multiplier:7},months:{getter:"getMonth",setter:"setMonth",multiplier:1},years:{getter:"getFullYear",setter:"setFullYear",multiplier:1},decades:{getter:"getFullYear",setter:"setFullYear",multiplier:10},centuries:{getter:"getFullYear",setter:"setFullYear",multiplier:100}};function LXe(t,e){const r=new Date(t,e+1,1);return r.setDate(0),r.getDate()}function rT(t,e,r){const i=new Date(t.getTime());if(e&&r){const s=$Xe[r],{getter:n,setter:o,multiplier:a}=s;if(r==="months"){const l=LXe(i.getFullYear(),i.getMonth()+e);i.getDate()>l&&i.setDate(l)}i[o](i[n]()+e*a)}return i}function kae(t,e){switch(e){case"milliseconds":return new Date(t.getTime());case"seconds":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes(),t.getSeconds());case"minutes":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours(),t.getMinutes());case"hours":return new Date(t.getFullYear(),t.getMonth(),t.getDate(),t.getHours());case"days":return new Date(t.getFullYear(),t.getMonth(),t.getDate());case"weeks":return new Date(t.getFullYear(),t.getMonth(),t.getDate()-t.getDay());case"months":return new Date(t.getFullYear(),t.getMonth(),1);case"years":return new Date(t.getFullYear(),0,1);case"decades":return new Date(t.getFullYear()-t.getFullYear()%10,0,1);case"centuries":return new Date(t.getFullYear()-t.getFullYear()%100,0,1);default:return new Date}}function DXe(t,e,r){return t===0?0:t*Fae[e]/Fae[r]}var Ip;let Ku=Ip=class extends he{static get allTime(){return Uae}static get empty(){return NXe}constructor(t){super(t),this.end=null,this.start=null}readEnd(t,e){return e.end!=null?new Date(e.end):null}writeEnd(t,e){e.end=t?t.getTime():null}get isAllTime(){return this.equals(Ip.allTime)}get isEmpty(){return this.equals(Ip.empty)}readStart(t,e){return e.start!=null?new Date(e.start):null}writeStart(t,e){e.start=t?t.getTime():null}clone(){return new Ip({end:this.end,start:this.start})}equals(t){if(!t)return!1;const e=this.start!=null?this.start.getTime():this.start,r=this.end!=null?this.end.getTime():this.end,i=t.start!=null?t.start.getTime():t.start,s=t.end!=null?t.end.getTime():t.end;return e===i&&r===s}expandTo(t){if(this.isEmpty||this.isAllTime)return this.clone();const e=Dl(this.start,i=>kae(i,t)),r=Dl(this.end,i=>{const s=kae(i,t);return i.getTime()===s.getTime()?s:rT(s,1,t)});return new Ip({start:e,end:r})}intersection(t){if(!t)return this.clone();if(this.isEmpty||t.isEmpty)return Ip.empty;if(this.isAllTime)return t.clone();if(t.isAllTime)return this.clone();const e=this.start?.getTime()??-1/0,r=this.end?.getTime()??1/0,i=t.start?.getTime()??-1/0,s=t.end?.getTime()??1/0;let n,o;if(i>=e&&i<=r?n=i:e>=i&&e<=s&&(n=e),r>=i&&r<=s?o=r:s>=e&&s<=r&&(o=s),n!=null&&o!=null&&!isNaN(n)&&!isNaN(o)){const a=new Ip;return a.start=n===-1/0?null:new Date(n),a.end=o===1/0?null:new Date(o),a}return Ip.empty}offset(t,e){if(this.isEmpty||this.isAllTime)return this.clone();const r=new Ip,{start:i,end:s}=this;return i!=null&&(r.start=rT(i,t,e)),s!=null&&(r.end=rT(s,t,e)),r}union(t){if(!t||t.isEmpty)return this.clone();if(this.isEmpty)return t.clone();if(this.isAllTime||t.isAllTime)return Uae.clone();const e=this.start!=null&&t.start!=null?new Date(Math.min(this.start.getTime(),t.start.getTime())):null,r=this.end!=null&&t.end!=null?new Date(Math.max(this.end.getTime(),t.end.getTime())):null;return new Ip({start:e,end:r})}};u([d({type:Date,json:{write:{allowNull:!0}}})],Ku.prototype,"end",void 0),u([Ae("end")],Ku.prototype,"readEnd",null),u([Ve("end")],Ku.prototype,"writeEnd",null),u([d({readOnly:!0,json:{read:!1}})],Ku.prototype,"isAllTime",null),u([d({readOnly:!0,json:{read:!1}})],Ku.prototype,"isEmpty",null),u([d({type:Date,json:{write:{allowNull:!0}}})],Ku.prototype,"start",void 0),u([Ae("start")],Ku.prototype,"readStart",null),u([Ve("start")],Ku.prototype,"writeStart",null),Ku=Ip=u([R("esri.TimeExtent")],Ku);const Uae=new Ku,NXe=new Ku({start:void 0,end:void 0}),Ng=Ku;var Wq;let oE=Wq=class extends he{constructor(t){super(t),this.type="map-layer"}clone(){const{mapLayerId:t,gdbVersion:e}=this;return new Wq({mapLayerId:t,gdbVersion:e})}};u([nt({mapLayer:"map-layer"})],oE.prototype,"type",void 0),u([d({type:Ki,json:{write:!0}})],oE.prototype,"mapLayerId",void 0),u([d({type:String,json:{write:!0}})],oE.prototype,"gdbVersion",void 0),oE=Wq=u([R("esri.layers.support.source.MapLayerSource")],oE);var Zq;let by=Zq=class extends he{constructor(t){super(t),this.type="query-table"}clone(){const{workspaceId:t,query:e,oidFields:r,spatialReference:i,geometryType:s}=this,n={workspaceId:t,query:e,oidFields:r,spatialReference:i?.clone()??void 0,geometryType:s};return new Zq(n)}};u([nt({queryTable:"query-table"})],by.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],by.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],by.prototype,"query",void 0),u([d({type:String,json:{write:!0}})],by.prototype,"oidFields",void 0),u([d({type:qe,json:{write:!0}})],by.prototype,"spatialReference",void 0),u([nt(Sbe)],by.prototype,"geometryType",void 0),by=Zq=u([R("esri.layers.support.source.QueryTableDataSource")],by);var Xq;let aE=Xq=class extends he{constructor(t){super(t),this.type="raster"}clone(){const{workspaceId:t,dataSourceName:e}=this;return new Xq({workspaceId:t,dataSourceName:e})}};u([nt({raster:"raster"})],aE.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],aE.prototype,"dataSourceName",void 0),u([d({type:String,json:{write:!0}})],aE.prototype,"workspaceId",void 0),aE=Xq=u([R("esri.layers.support.source.RasterDataSource")],aE);var Yq;let Fw=Yq=class extends he{constructor(t){super(t),this.type="table"}clone(){const{workspaceId:t,gdbVersion:e,dataSourceName:r}=this;return new Yq({workspaceId:t,gdbVersion:e,dataSourceName:r})}};u([nt({table:"table"})],Fw.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Fw.prototype,"workspaceId",void 0),u([d({type:String,json:{write:!0}})],Fw.prototype,"gdbVersion",void 0),u([d({type:String,json:{write:!0}})],Fw.prototype,"dataSourceName",void 0),Fw=Yq=u([R("esri.layers.support.source.TableDataSource")],Fw);var Jq,Qq;const FXe=zl()({esriLeftInnerJoin:"left-inner-join",esriLeftOuterJoin:"left-outer-join"});let Hu=Jq=class extends he{constructor(t){super(t),this.type="join-table"}readLeftTableSource(t,e,r){return Vae()(t,e,r)}castLeftTableSource(t){return Rf(Kq(),t)}readRightTableSource(t,e,r){return Vae()(t,e,r)}castRightTableSource(t){return Rf(Kq(),t)}clone(){const{leftTableKey:t,rightTableKey:e,leftTableSource:r,rightTableSource:i,joinType:s}=this,n={leftTableKey:t,rightTableKey:e,leftTableSource:r?.clone()??void 0,rightTableSource:i?.clone()??void 0,joinType:s};return new Jq(n)}};u([nt({joinTable:"join-table"})],Hu.prototype,"type",void 0),u([d({type:String,json:{write:!0}})],Hu.prototype,"leftTableKey",void 0),u([d({type:String,json:{write:!0}})],Hu.prototype,"rightTableKey",void 0),u([d({json:{write:!0}})],Hu.prototype,"leftTableSource",void 0),u([Ae("leftTableSource")],Hu.prototype,"readLeftTableSource",null),u([or("leftTableSource")],Hu.prototype,"castLeftTableSource",null),u([d({json:{write:!0}})],Hu.prototype,"rightTableSource",void 0),u([Ae("rightTableSource")],Hu.prototype,"readRightTableSource",null),u([or("rightTableSource")],Hu.prototype,"castRightTableSource",null),u([nt(FXe)],Hu.prototype,"joinType",void 0),Hu=Jq=u([R("esri.layers.support.source.JoinTableDataSource")],Hu);let X9=null;function Vae(){return X9||(X9=sO({types:Kq()})),X9}let Y9=null;function Kq(){return Y9||(Y9={key:"type",base:null,typeMap:{"data-layer":Kp,"map-layer":oE}}),Y9}const kXe={key:"type",base:null,typeMap:{"join-table":Hu,"query-table":by,raster:aE,table:Fw}};let Kp=Qq=class extends he{constructor(t){super(t),this.type="data-layer"}clone(){const{fields:t,dataSource:e}=this;return new Qq({fields:t,dataSource:e})}};u([nt({dataLayer:"data-layer"})],Kp.prototype,"type",void 0),u([d({type:[yV],json:{write:!0}})],Kp.prototype,"fields",void 0),u([d({types:kXe,json:{write:!0}})],Kp.prototype,"dataSource",void 0),Kp=Qq=u([R("esri.layers.support.source.DataLayerSource")],Kp),Kp.from=Sn(Kp);let kw=class extends rs(he){constructor(e){super(e),this.onFields=null,this.operator=null,this.searchTerm=null,this.searchType=null}};u([d({type:[String],json:{write:{enabled:!0,overridePolicy(){return{enabled:this.onFields!=null&&this.onFields.length>0}}}}})],kw.prototype,"onFields",void 0),u([d({type:String,json:{write:!0}})],kw.prototype,"operator",void 0),u([d({type:String,json:{write:!0}})],kw.prototype,"searchTerm",void 0),u([d({type:String,json:{write:!0}})],kw.prototype,"searchType",void 0),kw=u([R("esri.rest.support.FullTextSearch")],kw);const UXe=kw;var eW;const zae=new kr({upperLeft:"upper-left",lowerLeft:"lower-left"});let Uw=eW=class extends he{constructor(t){super(t),this.extent=null,this.mode="view",this.originPosition="upper-left",this.tolerance=1}clone(){return new eW(re({extent:this.extent,mode:this.mode,originPosition:this.originPosition,tolerance:this.tolerance}))}};u([d({type:vr,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Uw.prototype,"extent",void 0),u([d({type:["view","edit"],json:{write:!0}})],Uw.prototype,"mode",void 0),u([d({type:String,json:{read:zae.read,write:zae.write}})],Uw.prototype,"originPosition",void 0),u([d({type:Number,json:{write:{overridePolicy(){return{enabled:this.mode==="view"}}}}})],Uw.prototype,"tolerance",void 0),Uw=eW=u([R("esri.rest.support.QuantizationParameters")],Uw);const VXe=Uw;var tW;const Bae=new kr({count:"count",sum:"sum",min:"min",max:"max",avg:"avg",stddev:"stddev",var:"var",exceedslimit:"exceedslimit",percentile_cont:"percentile-continuous",percentile_disc:"percentile-discrete",EnvelopeAggregate:"envelope-aggregate",CentroidAggregate:"centroid-aggregate",ConvexHullAggregate:"convex-hull-aggregate"});let Pp=tW=class extends he{constructor(t){super(t),this.maxPointCount=void 0,this.maxRecordCount=void 0,this.maxVertexCount=void 0,this.onStatisticField=null,this.outStatisticFieldName=null,this.statisticType=null,this.statisticParameters=null}writeStatisticParameters(t,e){this.statisticType!=="percentile-continuous"&&this.statisticType!=="percentile-discrete"||(e.statisticParameters=re(t))}clone(){return new tW({maxPointCount:this.maxPointCount,maxRecordCount:this.maxRecordCount,maxVertexCount:this.maxVertexCount,onStatisticField:this.onStatisticField,outStatisticFieldName:this.outStatisticFieldName,statisticType:this.statisticType,statisticParameters:re(this.statisticParameters)})}};u([d({type:Number,json:{write:!0}})],Pp.prototype,"maxPointCount",void 0),u([d({type:Number,json:{write:!0}})],Pp.prototype,"maxRecordCount",void 0),u([d({type:Number,json:{write:!0}})],Pp.prototype,"maxVertexCount",void 0),u([d({type:String,json:{write:!0}})],Pp.prototype,"onStatisticField",void 0),u([d({type:String,json:{write:!0}})],Pp.prototype,"outStatisticFieldName",void 0),u([d({type:String,json:{read:{source:"statisticType",reader:Bae.read},write:{target:"statisticType",writer:Bae.write}}})],Pp.prototype,"statisticType",void 0),u([d({type:Object})],Pp.prototype,"statisticParameters",void 0),u([Ve("statisticParameters")],Pp.prototype,"writeStatisticParameters",null),Pp=tW=u([R("esri.rest.support.StatisticDefinition")],Pp);const zXe=Pp;var OC;const BXe=new kr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),GXe=new kr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Nt=OC=class extends he{static from(t){return bT(OC,t)}constructor(t){super(t),this.aggregateIds=null,this.cacheHint=void 0,this.compactGeometryEnabled=!1,this.datumTransformation=null,this.defaultSpatialReferenceEnabled=!1,this.distance=void 0,this.dynamicDataSource=void 0,this.formatOf3DObjects=null,this.fullText=null,this.gdbVersion=null,this.geometry=null,this.geometryPrecision=void 0,this.groupByFieldsForStatistics=null,this.having=null,this.historicMoment=null,this.maxAllowableOffset=void 0,this.maxRecordCountFactor=1,this.multipatchOption=null,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.outStatistics=null,this.parameterValues=null,this.pixelSize=null,this.quantizationParameters=null,this.rangeValues=null,this.relationParameter=null,this.resultType=null,this.returnCentroid=!1,this.returnDistinctValues=!1,this.returnExceededLimitFeatures=!0,this.returnGeometry=!1,this.returnQueryGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.sourceSpatialReference=null,this.spatialRelationship="intersects",this.start=void 0,this.sqlFormat=null,this.text=null,this.timeExtent=null,this.timeReferenceUnknownClient=!1,this.units=null,this.where=null}castDatumTransformation(t){return typeof t=="number"||typeof t=="object"?t:null}writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeParameterValues(t,e){if(t){const r={};for(const i in t){const s=t[i];Array.isArray(s)?r[i]=s.map(n=>n instanceof Date?n.getTime():n):s instanceof Date?r[i]=s.getTime():r[i]=s}e.parameterValues=r}}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,e.where="1=1"}writeWhere(t,e){e.where=t||"1=1"}clone(){return new OC(re({aggregateIds:this.aggregateIds,cacheHint:this.cacheHint,compactGeometryEnabled:this.compactGeometryEnabled,datumTransformation:this.datumTransformation,defaultSpatialReferenceEnabled:this.defaultSpatialReferenceEnabled,distance:this.distance,fullText:this.fullText,formatOf3DObjects:this.formatOf3DObjects,gdbVersion:this.gdbVersion,geometry:this.geometry,geometryPrecision:this.geometryPrecision,groupByFieldsForStatistics:this.groupByFieldsForStatistics,having:this.having,historicMoment:this.historicMoment!=null?new Date(this.historicMoment.getTime()):null,maxAllowableOffset:this.maxAllowableOffset,maxRecordCountFactor:this.maxRecordCountFactor,multipatchOption:this.multipatchOption,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,outStatistics:this.outStatistics,parameterValues:this.parameterValues,pixelSize:this.pixelSize,quantizationParameters:this.quantizationParameters,rangeValues:this.rangeValues,relationParameter:this.relationParameter,resultType:this.resultType,returnDistinctValues:this.returnDistinctValues,returnGeometry:this.returnGeometry,returnCentroid:this.returnCentroid,returnExceededLimitFeatures:this.returnExceededLimitFeatures,returnQueryGeometry:this.returnQueryGeometry,returnM:this.returnM,returnZ:this.returnZ,dynamicDataSource:this.dynamicDataSource,sourceSpatialReference:this.sourceSpatialReference,spatialRelationship:this.spatialRelationship,start:this.start,sqlFormat:this.sqlFormat,text:this.text,timeExtent:this.timeExtent,timeReferenceUnknownClient:this.timeReferenceUnknownClient,units:this.units,where:this.where}))}};Nt.MAX_MAX_RECORD_COUNT_FACTOR=5,u([d({json:{write:!0}})],Nt.prototype,"aggregateIds",void 0),u([d({type:Boolean,json:{write:!0}})],Nt.prototype,"cacheHint",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"compactGeometryEnabled",void 0),u([d({json:{write:!0}})],Nt.prototype,"datumTransformation",void 0),u([or("datumTransformation")],Nt.prototype,"castDatumTransformation",null),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"defaultSpatialReferenceEnabled",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],Nt.prototype,"distance",void 0),u([d({type:Kp,json:{write:!0}})],Nt.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],Nt.prototype,"formatOf3DObjects",void 0),u([d({type:[UXe],json:{write:{enabled:!0,overridePolicy(){return{enabled:this.fullText!=null&&this.fullText.length>0}}}}})],Nt.prototype,"fullText",void 0),u([d({type:String,json:{write:!0}})],Nt.prototype,"gdbVersion",void 0),u([d({types:nS,json:{read:N1,write:!0}})],Nt.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Nt.prototype,"geometryPrecision",void 0),u([d({type:[String],json:{write:!0}})],Nt.prototype,"groupByFieldsForStatistics",void 0),u([d({type:String,json:{write:!0}})],Nt.prototype,"having",void 0),u([d({type:Date})],Nt.prototype,"historicMoment",void 0),u([Ve("historicMoment")],Nt.prototype,"writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],Nt.prototype,"maxAllowableOffset",void 0),u([d({type:Number,cast:t=>t<1?1:t>OC.MAX_MAX_RECORD_COUNT_FACTOR?OC.MAX_MAX_RECORD_COUNT_FACTOR:t,json:{write:{overridePolicy:t=>({enabled:t>1})}}})],Nt.prototype,"maxRecordCountFactor",void 0),u([d({type:["xyFootprint"],json:{write:!0}})],Nt.prototype,"multipatchOption",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Nt.prototype,"num",void 0),u([d({json:{write:!0}})],Nt.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Nt.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Nt.prototype,"outFields",void 0),u([d({type:qe,json:{name:"outSR",write:!0}})],Nt.prototype,"outSpatialReference",void 0),u([d({type:[zXe],json:{write:{enabled:!0,overridePolicy(){return{enabled:this.outStatistics!=null&&this.outStatistics.length>0}}}}})],Nt.prototype,"outStatistics",void 0),u([d({json:{write:!0}})],Nt.prototype,"parameterValues",void 0),u([Ve("parameterValues")],Nt.prototype,"writeParameterValues",null),u([d({type:ht,json:{write:!0}})],Nt.prototype,"pixelSize",void 0),u([d({type:VXe,json:{write:!0}})],Nt.prototype,"quantizationParameters",void 0),u([d({type:[Object],json:{write:!0}})],Nt.prototype,"rangeValues",void 0),u([d({type:String,json:{read:{source:"relationParam"},write:{target:"relationParam",overridePolicy(){return{enabled:this.spatialRelationship==="relation"}}}}})],Nt.prototype,"relationParameter",void 0),u([d({type:String,json:{write:!0}})],Nt.prototype,"resultType",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"returnCentroid",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"returnDistinctValues",void 0),u([d({type:Boolean,json:{default:!0,write:!0}})],Nt.prototype,"returnExceededLimitFeatures",void 0),u([d({type:Boolean,json:{write:!0}})],Nt.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"returnQueryGeometry",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Nt.prototype,"returnZ",void 0),u([d({type:qe,json:{write:!0}})],Nt.prototype,"sourceSpatialReference",void 0),u([nt(BXe,{ignoreUnknown:!1,name:"spatialRel"})],Nt.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Nt.prototype,"start",void 0),u([Ve("start"),Ve("num")],Nt.prototype,"writeStart",null),u([d({type:String,json:{write:!0}})],Nt.prototype,"sqlFormat",void 0),u([d({type:String,json:{write:!0}})],Nt.prototype,"text",void 0),u([d({type:Ng,json:{write:!0}})],Nt.prototype,"timeExtent",void 0),u([d({type:Boolean,json:{default:!1,write:!0}})],Nt.prototype,"timeReferenceUnknownClient",void 0),u([nt(GXe,{ignoreUnknown:!1}),d({json:{write:{overridePolicy(t){return{enabled:!!t&&this.distance!=null&&this.distance>0}}}}})],Nt.prototype,"units",void 0),u([d({type:String,json:{write:{overridePolicy(t){return{enabled:t!=null||this.start!=null&&this.start>0}}}}})],Nt.prototype,"where",void 0),u([Ve("where")],Nt.prototype,"writeWhere",null),Nt=OC=u([R("esri.rest.support.Query")],Nt);const cb=Nt;var rW;const J9=new kr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),Q9=new kr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Sm=rW=class extends he{constructor(t){super(t),this.where=null,this.geometry=null,this.spatialRelationship="intersects",this.distance=void 0,this.objectIds=null,this.units=null,this.timeExtent=null}createQuery(t={}){const{where:e,geometry:r,spatialRelationship:i,timeExtent:s,objectIds:n,units:o,distance:a}=this;return new cb({geometry:re(r),objectIds:re(n),spatialRelationship:i,timeExtent:re(s),where:e,units:o,distance:a,...t})}clone(){const{where:t,geometry:e,spatialRelationship:r,timeExtent:i,objectIds:s,units:n,distance:o}=this;return new rW({geometry:re(e),objectIds:re(s),spatialRelationship:r,timeExtent:re(i),where:t,units:n,distance:o})}};u([d({type:String,json:{write:!0}})],Sm.prototype,"where",void 0),u([d({types:nS,json:{write:!0}})],Sm.prototype,"geometry",void 0),u([d({type:J9.apiValues,json:{name:"spatialRel",read:{reader:J9.read},write:{allowNull:!1,writer:J9.write,overridePolicy(){return{enabled:this.geometry!=null}}}}})],Sm.prototype,"spatialRelationship",void 0),u([d({type:Number,json:{write:{overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],Sm.prototype,"distance",void 0),u([d({type:[Number],json:{write:!0}})],Sm.prototype,"objectIds",void 0),u([d({type:Q9.apiValues,json:{read:Q9.read,write:{writer:Q9.write,overridePolicy(t){return{enabled:t!=null&&this.geometry!=null}}}}})],Sm.prototype,"units",void 0),u([d({type:Ng,json:{write:!0}})],Sm.prototype,"timeExtent",void 0),Sm=rW=u([R("esri.layers.support.FeatureFilter")],Sm);const jXe=Sm;var iW;const Gae={read:{reader:see},write:{writer:nee,overridePolicy(){return{allowNull:this.excludedEffect!=null,isRequired:this.excludedEffect==null}}}},jae={read:{reader:see},write:{writer:nee,overridePolicy(){return{allowNull:this.includedEffect!=null,isRequired:this.includedEffect==null}}}},Hae={name:"showExcludedLabels",default:!0};let Vw=iW=class extends he{constructor(t){super(t),this.filter=null,this.includedEffect=null,this.excludedEffect=null,this.excludedLabelsVisible=!1}write(t,e){const r=super.write(t,e);if(e?.origin){if(r.filter){const i=Object.keys(r.filter);if(i.length>1||i[0]!=="where")return e.messages?.push(new D("web-document-write:unsupported-feature-effect","Invalid feature effect 'filter'. A filter can only contain a 'where' property",{layer:e.layer,effect:this})),null}if("showExcludedLabels"in r)return e.messages?.push(new D("web-document-write:unsupported-feature-effect","Invalid value for property 'excludedLabelsVisible' which should always be 'true'",{layer:e.layer,effect:this})),null}return r}clone(){return new iW({filter:this.filter!=null?this.filter.clone():null,includedEffect:this.includedEffect,excludedEffect:this.excludedEffect,excludedLabelsVisible:this.excludedLabelsVisible})}};u([d({type:jXe,json:{write:{allowNull:!0,writer(t,e,r,i){const s=t?.write({},i);s&&Object.keys(s).length!==0?Ul(r,s,e):Ul(r,null,e)}}}})],Vw.prototype,"filter",void 0),u([d({json:{write:!0,origins:{"web-map":Gae,"portal-item":Gae}}})],Vw.prototype,"includedEffect",void 0),u([d({json:{write:!0,origins:{"web-map":jae,"portal-item":jae}}})],Vw.prototype,"excludedEffect",void 0),u([d({type:Boolean,json:{write:!0,name:"showExcludedLabels",origins:{"web-map":Hae,"portal-item":Hae}}})],Vw.prototype,"excludedLabelsVisible",void 0),Vw=iW=u([R("esri.layers.support.FeatureEffect")],Vw);const HXe=Vw,qae={write:{allowNull:!0}},qXe=t=>{let e=class extends t{constructor(){super(...arguments),this.featureEffect=null}};return u([d({type:HXe,json:{origins:{"web-map":qae,"portal-item":qae}}})],e.prototype,"featureEffect",void 0),e=u([R("esri.layers.mixins.FeatureEffectLayer")],e),e};var I3;const Ik=zl()({orthometric:"gravity-related-height",gravity_related_height:"gravity-related-height",ellipsoidal:"ellipsoidal"}),KSe=Ik.jsonValues.slice();MI(KSe,"orthometric");const WM=zl()({meter:"meters",foot:"feet","us-foot":"us-feet","clarke-foot":"clarke-feet","clarke-yard":"clarke-yards","clarke-link":"clarke-links","sears-yard":"sears-yards","sears-foot":"sears-feet","sears-chain":"sears-chains","benoit-1895-b-chain":"benoit-1895-b-chains","indian-yard":"indian-yards","indian-1937-yard":"indian-1937-yards","gold-coast-foot":"gold-coast-feet","sears-1922-truncated-chain":"sears-1922-truncated-chains","50-kilometers":"50-kilometers","150-kilometers":"150-kilometers"});let $p=I3=class extends he{constructor(t){super(t),this.heightModel="gravity-related-height",this.heightUnit="meters",this.vertCRS=null}writeHeightModel(t,e,r){return Ik.write(t,e,r)}readHeightModel(t,e,r){return Ik.read(t)||(r&&r.messages&&r.messages.push(WXe(t,{context:r})),null)}readHeightUnit(t,e,r){return WM.read(t)||(r&&r.messages&&r.messages.push(Wae(t,{context:r})),null)}readHeightUnitService(t,e,r){return R1e(t)||WM.read(t)||(r&&r.messages&&r.messages.push(Wae(t,{context:r})),null)}readVertCRS(t,e){return e.vertCRS||e.ellipsoid||e.geoid}clone(){return new I3({heightModel:this.heightModel,heightUnit:this.heightUnit,vertCRS:this.vertCRS})}equals(t){return!!t&&(this===t||this.heightModel===t.heightModel&&this.heightUnit===t.heightUnit&&this.vertCRS===t.vertCRS)}static deriveUnitFromSR(t,e){const r=M1e(e);return new I3({heightModel:t.heightModel,heightUnit:r,vertCRS:t.vertCRS})}write(t,e){return e={origin:"web-scene",...e},super.write(t,e)}static fromJSON(t){if(!t)return null;const e=new I3;return e.read(t,{origin:"web-scene"}),e}};function Wae(t,e){return new Bd("height-unit:unsupported",`Height unit of value '${t}' is not supported`,e)}function WXe(t,e){return new Bd("height-model:unsupported",`Height model of value '${t}' is not supported`,e)}u([d({type:Ik.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:KSe,default:"ellipsoidal"}}}})],$p.prototype,"heightModel",void 0),u([Ve("web-scene","heightModel")],$p.prototype,"writeHeightModel",null),u([Ae(["web-scene","service"],"heightModel")],$p.prototype,"readHeightModel",null),u([d({type:WM.apiValues,constructOnly:!0,json:{origins:{"web-scene":{type:WM.jsonValues,write:WM.write}}}})],$p.prototype,"heightUnit",void 0),u([Ae("web-scene","heightUnit")],$p.prototype,"readHeightUnit",null),u([Ae("service","heightUnit")],$p.prototype,"readHeightUnitService",null),u([d({type:String,constructOnly:!0,json:{origins:{"web-scene":{write:!0}}}})],$p.prototype,"vertCRS",void 0),u([Ae("service","vertCRS",["vertCRS","ellipsoid","geoid"])],$p.prototype,"readVertCRS",null),$p=I3=u([R("esri.geometry.HeightModelInfo")],$p);const dS=$p;function ZXe(t){if(!t)return t;const{start:e,end:r}=t;return new Ng({start:e!=null?rT(e,-e.getTimezoneOffset(),"minutes"):e,end:r!=null?rT(r,-r.getTimezoneOffset(),"minutes"):r})}function XXe(t){if(!t)return t;const{start:e,end:r}=t;return new Ng({start:e!=null?rT(e,e.getTimezoneOffset(),"minutes"):e,end:r!=null?rT(r,r.getTimezoneOffset(),"minutes"):r})}var sW;let P3=sW=class extends he{constructor(t){super(t)}async collectRequiredFields(t,e){return Ec(t,e,this.expression)}clone(){return new sW({expression:this.expression,title:this.title})}equals(t){return this.expression===t.expression&&this.title===t.title}};u([d({type:String,json:{write:!0}})],P3.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],P3.prototype,"title",void 0),P3=sW=u([R("esri.layers.support.FeatureExpressionInfo")],P3);const Zae=P3;function YXe(t){return!!t&&LT[t]!=null}function e2e(t){return 1/(LT[t]||1)}function JXe(){const t=Object.keys(LT);return t.sort(),t}const QXe=JXe();var nW;const ML=zl()({onTheGround:"on-the-ground",relativeToGround:"relative-to-ground",relativeToScene:"relative-to-scene",absoluteHeight:"absolute-height"}),Xae=new kr({foot:"feet",kilometer:"kilometers",meter:"meters",mile:"miles","us-foot":"us-feet",yard:"yards"});let wy=nW=class extends he{constructor(t){super(t),this.offset=null}readFeatureExpressionInfo(t,e){return t??(e.featureExpression&&e.featureExpression.value===0?{expression:"0"}:void 0)}writeFeatureExpressionInfo(t,e,r,i){e[r]=t.write({},i),t.expression==="0"&&(e.featureExpression={value:0})}get mode(){const{offset:t,featureExpressionInfo:e}=this;return this._isOverridden("mode")?this._get("mode"):t!=null||e?"relative-to-ground":"on-the-ground"}set mode(t){this._override("mode",t)}set unit(t){this._set("unit",t)}write(t,e){return this.offset||this.mode||this.featureExpressionInfo||this.unit?super.write(t,e):null}clone(){return new nW({mode:this.mode,offset:this.offset,featureExpressionInfo:this.featureExpressionInfo?this.featureExpressionInfo.clone():void 0,unit:this.unit})}equals(t){return this.mode===t.mode&&this.offset===t.offset&&this.unit===t.unit&&kke(this.featureExpressionInfo,t.featureExpressionInfo)}};u([d({type:Zae,json:{write:!0}})],wy.prototype,"featureExpressionInfo",void 0),u([Ae("featureExpressionInfo",["featureExpressionInfo","featureExpression"])],wy.prototype,"readFeatureExpressionInfo",null),u([Ve("featureExpressionInfo",{featureExpressionInfo:{type:Zae},"featureExpression.value":{type:[0]}})],wy.prototype,"writeFeatureExpressionInfo",null),u([d({type:ML.apiValues,nonNullable:!0,json:{type:ML.jsonValues,read:ML.read,write:{writer:ML.write,isRequired:!0}}})],wy.prototype,"mode",null),u([d({type:Number,json:{write:!0}})],wy.prototype,"offset",void 0),u([d({type:QXe,json:{type:String,read:Xae.read,write:Xae.write}})],wy.prototype,"unit",null),wy=nW=u([R("esri.layers.support.ElevationInfo")],wy);const t2e=wy,r2e={type:Boolean,value:!0,json:{origins:{service:{read:!1,write:!1},"web-map":{read:!1,write:!1}},name:"screenSizePerspective",write:!0}},SV={type:Boolean,value:!0,json:{name:"disablePopup",read:{reader:(t,e)=>!e.disablePopup},write:{enabled:!0,writer(t,e,r){e[r]=!t}}}},EV={type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",write:!0}},i2e={type:String,json:{origins:{"portal-item":{write:!1}},write:{isRequired:!0,ignoreOrigin:!0,writer:U1}}},s2e={type:Boolean,value:!0,nonNullable:!0,json:{origins:{service:{read:{enabled:!1}}},name:"showLegend",write:!0}},n2e={value:null,type:t2e,json:{origins:{service:{name:"elevationInfo",write:!0}},name:"layerDefinition.elevationInfo",write:!0}};function skt(t){return{type:t,readOnly:!0,json:{origins:{service:{read:!0}},read:!1}}}const o2e={write:!0,read:!0},oW={type:Number,json:{origins:{"web-document":o2e,"portal-item":{write:!0}}}},KXe={...oW,json:{...oW.json,origins:{"web-document":{...o2e,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}}}},read:{source:["layerDefinition.drawingInfo.transparency","drawingInfo.transparency"],reader:(t,e,r)=>r&&r.origin!=="service"||!e.drawingInfo||e.drawingInfo.transparency===void 0?e.layerDefinition&&e.layerDefinition.drawingInfo&&e.layerDefinition.drawingInfo.transparency!==void 0?oA(e.layerDefinition.drawingInfo.transparency):void 0:oA(e.drawingInfo.transparency)}}},nkt={type:Ng,readOnly:!0,get(){if(!this.layer?.timeInfo)return null;const{datesInUnknownTimezone:t,timeOffset:e,useViewTime:r}=this.layer,i=this.view?.timeExtent;let s=this.layer.timeExtent;t&&(s=XXe(s));let n=r?i&&s?i.intersection(s):i||s:s;if(!n||n.isEmpty||n.isAllTime)return n;e&&(n=n.offset(-e.value,e.unit)),t&&(n=ZXe(n));const o=this._get("timeExtent");return n.equals(o)?o:n}},okt={type:vr,readOnly:!0,json:{origins:{service:{read:{source:["fullExtent","spatialReference"],reader:(t,e)=>{const r=vr.fromJSON(t);return e.spatialReference!=null&&typeof e.spatialReference=="object"&&(r.spatialReference=qe.fromJSON(e.spatialReference)),r}}}},read:!1}},a2e={type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}}}},eYe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.minScale"},write:{target:"layerDefinition.minScale"}}},tYe={type:Number,json:{origins:{service:{write:{enabled:!1}}},read:{source:"layerDefinition.maxScale"},write:{target:"layerDefinition.maxScale"}}},l2e={json:{write:{ignoreOrigin:!0},origins:{"web-map":{read:!1,write:!1}}}},Yae=new Map([["AUS Central Standard Time","Australia/Darwin"],["AUS Eastern Standard Time","Australia/Sydney"],["Afghanistan Standard Time","Asia/Kabul"],["Alaskan Standard Time","America/Anchorage"],["Aleutian Standard Time","America/Adak"],["Altai Standard Time","Asia/Barnaul"],["Arab Standard Time","Asia/Riyadh"],["Arabian Standard Time","Asia/Dubai"],["Arabic Standard Time","Asia/Baghdad"],["Argentina Standard Time","America/Buenos_Aires"],["Astrakhan Standard Time","Europe/Astrakhan"],["Atlantic Standard Time","America/Halifax"],["Aus Central W. Standard Time","Australia/Eucla"],["Azerbaijan Standard Time","Asia/Baku"],["Azores Standard Time","Atlantic/Azores"],["Bahia Standard Time","America/Bahia"],["Bangladesh Standard Time","Asia/Dhaka"],["Belarus Standard Time","Europe/Minsk"],["Bougainville Standard Time","Pacific/Bougainville"],["Canada Central Standard Time","America/Regina"],["Cape Verde Standard Time","Atlantic/Cape_Verde"],["Caucasus Standard Time","Asia/Yerevan"],["Cen. Australia Standard Time","Australia/Adelaide"],["Central America Standard Time","America/Guatemala"],["Central Asia Standard Time","Asia/Almaty"],["Central Brazilian Standard Time","America/Cuiaba"],["Central Europe Standard Time","Europe/Budapest"],["Central European Standard Time","Europe/Warsaw"],["Central Pacific Standard Time","Pacific/Guadalcanal"],["Central Standard Time","America/Chicago"],["Central Standard Time (Mexico)","America/Mexico_City"],["Chatham Islands Standard Time","Pacific/Chatham"],["China Standard Time","Asia/Shanghai"],["Cuba Standard Time","America/Havana"],["Dateline Standard Time","Etc/GMT+12"],["E. Africa Standard Time","Africa/Nairobi"],["E. Australia Standard Time","Australia/Brisbane"],["E. Europe Standard Time","Europe/Chisinau"],["E. South America Standard Time","America/Sao_Paulo"],["Easter Island Standard Time","Pacific/Easter"],["Eastern Standard Time","America/New_York"],["Eastern Standard Time (Mexico)","America/Cancun"],["Egypt Standard Time","Africa/Cairo"],["Ekaterinburg Standard Time","Asia/Yekaterinburg"],["FLE Standard Time","Europe/Kiev"],["Fiji Standard Time","Pacific/Fiji"],["GMT Standard Time","Europe/London"],["GTB Standard Time","Europe/Bucharest"],["Georgian Standard Time","Asia/Tbilisi"],["Greenland Standard Time","America/Godthab"],["Greenwich Standard Time","Atlantic/Reykjavik"],["Haiti Standard Time","America/Port-au-Prince"],["Hawaiian Standard Time","Pacific/Honolulu"],["India Standard Time","Asia/Calcutta"],["Iran Standard Time","Asia/Tehran"],["Israel Standard Time","Asia/Jerusalem"],["Jordan Standard Time","Asia/Amman"],["Kaliningrad Standard Time","Europe/Kaliningrad"],["Korea Standard Time","Asia/Seoul"],["Libya Standard Time","Africa/Tripoli"],["Line Islands Standard Time","Pacific/Kiritimati"],["Lord Howe Standard Time","Australia/Lord_Howe"],["Magadan Standard Time","Asia/Magadan"],["Magallanes Standard Time","America/Punta_Arenas"],["Marquesas Standard Time","Pacific/Marquesas"],["Mauritius Standard Time","Indian/Mauritius"],["Middle East Standard Time","Asia/Beirut"],["Montevideo Standard Time","America/Montevideo"],["Morocco Standard Time","Africa/Casablanca"],["Mountain Standard Time","America/Denver"],["Mountain Standard Time (Mexico)","America/Mazatlan"],["Myanmar Standard Time","Asia/Rangoon"],["N. Central Asia Standard Time","Asia/Novosibirsk"],["Namibia Standard Time","Africa/Windhoek"],["Nepal Standard Time","Asia/Katmandu"],["New Zealand Standard Time","Pacific/Auckland"],["Newfoundland Standard Time","America/St_Johns"],["Norfolk Standard Time","Pacific/Norfolk"],["North Asia East Standard Time","Asia/Irkutsk"],["North Asia Standard Time","Asia/Krasnoyarsk"],["North Korea Standard Time","Asia/Pyongyang"],["Omsk Standard Time","Asia/Omsk"],["Pacific SA Standard Time","America/Santiago"],["Pacific Standard Time","America/Los_Angeles"],["Pacific Standard Time (Mexico)","America/Tijuana"],["Pakistan Standard Time","Asia/Karachi"],["Paraguay Standard Time","America/Asuncion"],["Qyzylorda Standard Time","Asia/Qyzylorda"],["Romance Standard Time","Europe/Paris"],["Russia Time Zone 10","Asia/Srednekolymsk"],["Russia Time Zone 11","Asia/Kamchatka"],["Russia Time Zone 3","Europe/Samara"],["Russian Standard Time","Europe/Moscow"],["SA Eastern Standard Time","America/Cayenne"],["SA Pacific Standard Time","America/Bogota"],["SA Western Standard Time","America/La_Paz"],["SE Asia Standard Time","Asia/Bangkok"],["Saint Pierre Standard Time","America/Miquelon"],["Sakhalin Standard Time","Asia/Sakhalin"],["Samoa Standard Time","Pacific/Apia"],["Sao Tome Standard Time","Africa/Sao_Tome"],["Saratov Standard Time","Europe/Saratov"],["Singapore Standard Time","Asia/Singapore"],["South Africa Standard Time","Africa/Johannesburg"],["South Sudan Standard Time","Africa/Juba"],["Sri Lanka Standard Time","Asia/Colombo"],["Sudan Standard Time","Africa/Khartoum"],["Syria Standard Time","Asia/Damascus"],["Taipei Standard Time","Asia/Taipei"],["Tasmania Standard Time","Australia/Hobart"],["Tocantins Standard Time","America/Araguaina"],["Tokyo Standard Time","Asia/Tokyo"],["Tomsk Standard Time","Asia/Tomsk"],["Tonga Standard Time","Pacific/Tongatapu"],["Transbaikal Standard Time","Asia/Chita"],["Turkey Standard Time","Europe/Istanbul"],["Turks And Caicos Standard Time","America/Grand_Turk"],["US Eastern Standard Time","America/Indianapolis"],["US Mountain Standard Time","America/Phoenix"],["UTC","Etc/GMT"],["UTC+01","Etc/GMT-1"],["UTC+02","Etc/GMT-2"],["UTC+03","Etc/GMT-3"],["UTC+04","Etc/GMT-4"],["UTC+05","Etc/GMT-5"],["UTC+06","Etc/GMT-6"],["UTC+07","Etc/GMT-7"],["UTC+08","Etc/GMT-8"],["UTC+09","Etc/GMT-9"],["UTC+10","Etc/GMT-10"],["UTC+11","Etc/GMT-11"],["UTC+12","Etc/GMT-12"],["UTC+13","Etc/GMT-13"],["UTC+14","Etc/GMT-14"],["UTC-01","Etc/GMT+1"],["UTC-02","Etc/GMT+2"],["UTC-03","Etc/GMT+3"],["UTC-04","Etc/GMT+4"],["UTC-05","Etc/GMT+5"],["UTC-06","Etc/GMT+6"],["UTC-07","Etc/GMT+7"],["UTC-08","Etc/GMT+8"],["UTC-09","Etc/GMT+9"],["UTC-10","Etc/GMT+10"],["UTC-11","Etc/GMT+11"],["UTC-12","Etc/GMT+12"],["Ulaanbaatar Standard Time","Asia/Ulaanbaatar"],["Venezuela Standard Time","America/Caracas"],["Vladivostok Standard Time","Asia/Vladivostok"],["Volgograd Standard Time","Europe/Volgograd"],["W. Australia Standard Time","Australia/Perth"],["W. Central Africa Standard Time","Africa/Lagos"],["W. Europe Standard Time","Europe/Berlin"],["W. Mongolia Standard Time","Asia/Hovd"],["West Asia Standard Time","Asia/Tashkent"],["West Bank Standard Time","Asia/Hebron"],["West Pacific Standard Time","Pacific/Port_Moresby"],["Yakutsk Standard Time","Asia/Yakutsk"],["Yukon Standard Time","America/Whitehorse"]]);function rYe(t,e="system"){if(!t||!Yae.has(t.timeZone))return e;const r=Yae.get(t.timeZone);return sYe(t.timeZone)||t.respectsDaylightSaving?r:iYe(r)}function iYe(t){const e=kt.local().setZone(t),r=Math.min(e.set({month:1,day:1}).offset,e.set({month:5}).offset);return r===0?"Etc/UTC":`Etc/GMT${Ja.instance(-r).formatOffset(0,"narrow")}`}function sYe(t){return t.startsWith("UTC")}let iv=class extends rs(he){constructor(e){super(e),this.legacy=null,this.timeZone="system"}readLegacy(e,r){const{timeZone:i,respectsDaylightSaving:s}=r;return{timeZone:i,respectsDaylightSaving:s}}readTimeZone(e,r){return"timeZoneIANA"in r?r.timeZoneIANA:rYe(r)}writeTimeZone(e,r){r.timeZoneIANA=e}equals(e){return e!=null&&this.timeZone!=null&&e.timeZone!=null&&this.timeZone===e.timeZone}};u([d()],iv.prototype,"legacy",void 0),u([Ae("legacy",["timeZone"])],iv.prototype,"readLegacy",null),u([d({type:String,nonNullable:!0})],iv.prototype,"timeZone",void 0),u([Ae("timeZone",["timeZone","timeZoneIANA","respectsDaylightSaving"])],iv.prototype,"readTimeZone",null),u([Ve("timeZone")],iv.prototype,"writeTimeZone",null),iv=u([R("esri.time.TimeReference")],iv);const fA=iv;let xy=class extends rs(he){constructor(e){super(e),this.creatorField=null,this.creationDateField=null,this.editorField=null,this.editDateField=null,this.realm=null,this.dateFieldsTimeReference=null}};u([d()],xy.prototype,"creatorField",void 0),u([d()],xy.prototype,"creationDateField",void 0),u([d()],xy.prototype,"editorField",void 0),u([d()],xy.prototype,"editDateField",void 0),u([d()],xy.prototype,"realm",void 0),u([d({type:fA})],xy.prototype,"dateFieldsTimeReference",void 0),xy=u([R("esri.layers.support.EditFieldsInfo")],xy);const nYe=xy;let Vm=class extends rs(he){constructor(e){super(e)}};u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"name",void 0),u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"fields",void 0),u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"isAscending",void 0),u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"indexType",void 0),u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"isUnique",void 0),u([d({constructOnly:!0,json:{write:!0}})],Vm.prototype,"description",void 0),Vm=u([R("esri.layers.support.FeatureIndex")],Vm);var aW;let ln=aW=class extends he{constructor(t){super(t),this.cacheHint=void 0,this.dynamicDataSource=void 0,this.gdbVersion=null,this.geometryPrecision=void 0,this.historicMoment=null,this.maxAllowableOffset=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.relationshipId=void 0,this.start=void 0,this.num=void 0,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.where=null}_writeHistoricMoment(t,e){e.historicMoment=t&&t.getTime()}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10,this.start>0&&this.where==null&&(e.definitionExpression="1=1")}clone(){return new aW(re({cacheHint:this.cacheHint,dynamicDataSource:this.dynamicDataSource,gdbVersion:this.gdbVersion,geometryPrecision:this.geometryPrecision,historicMoment:this.historicMoment&&new Date(this.historicMoment.getTime()),maxAllowableOffset:this.maxAllowableOffset,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,relationshipId:this.relationshipId,start:this.start,num:this.num,returnGeometry:this.returnGeometry,where:this.where,returnZ:this.returnZ,returnM:this.returnM}))}};u([d({type:Boolean,json:{write:!0}})],ln.prototype,"cacheHint",void 0),u([d({type:Kp,json:{write:!0}})],ln.prototype,"dynamicDataSource",void 0),u([d({type:String,json:{write:!0}})],ln.prototype,"gdbVersion",void 0),u([d({type:Number,json:{write:!0}})],ln.prototype,"geometryPrecision",void 0),u([d({type:Date})],ln.prototype,"historicMoment",void 0),u([Ve("historicMoment")],ln.prototype,"_writeHistoricMoment",null),u([d({type:Number,json:{write:!0}})],ln.prototype,"maxAllowableOffset",void 0),u([d({type:[Number],json:{write:!0}})],ln.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],ln.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],ln.prototype,"outFields",void 0),u([d({type:qe,json:{read:{source:"outSR"},write:{target:"outSR"}}})],ln.prototype,"outSpatialReference",void 0),u([d({json:{write:!0}})],ln.prototype,"relationshipId",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],ln.prototype,"start",void 0),u([Ve("start"),Ve("num")],ln.prototype,"writeStart",null),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],ln.prototype,"num",void 0),u([d({json:{write:!0}})],ln.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ln.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],ln.prototype,"returnZ",void 0),u([d({type:String,json:{read:{source:"definitionExpression"},write:{target:"definitionExpression"}}})],ln.prototype,"where",void 0),ln=aW=u([R("esri.rest.support.RelationshipQuery")],ln),ln.from=Sn(ln);const rP=ln,ukt=Object.freeze(Object.defineProperty({__proto__:null,default:rP},Symbol.toStringTag,{value:"Module"})),lW=new kr({esriGeometryPoint:"point",esriGeometryMultipoint:"multipoint",esriGeometryPolyline:"polyline",esriGeometryPolygon:"polygon",esriGeometryMultiPatch:"multipatch"});async function oYe(t,e,r,i){const s=await ub(t);if(await oee(t,e,i),!s.addAttachment)throw new D(i,"Layer source does not support addAttachment capability");return s.addAttachment(e,r)}function oee(t,e,r){const{attributes:i}=e,{objectIdField:s}=t;return t.get("capabilities.data.supportsAttachment")?e?i?s&&i[s]?Promise.resolve():Promise.reject(new D(r,`feature is missing the identifying attribute ${s}`)):Promise.reject(new D(r,"'attributes' are required on a feature to query attachments")):Promise.reject(new D(r,"A feature is required to add/delete/update attachments")):Promise.reject(new D(r,"this layer doesn't support attachments"))}async function aYe(t,e,r,i,s){const n=await ub(t);if(await oee(t,e,s),!n.updateAttachment)throw new D(s,"Layer source does not support updateAttachment capability");return n.updateAttachment(e,r,i)}async function lYe(t,e,r){const{applyEdits:i}=await J(()=>import("./editingSupport-3a0009ce.js"),["./editingSupport-3a0009ce.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js"],import.meta.url),s=await t.load();return i(s,s.source,e,r)}async function cYe(t,e,r){const{uploadAssets:i}=await J(()=>import("./editingSupport-3a0009ce.js"),["./editingSupport-3a0009ce.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js"],import.meta.url),s=await t.load();return i(s,s.source,e,r)}async function uYe(t,e,r,i){const s=await ub(t);if(await oee(t,e,i),!s.deleteAttachments)throw new D(i,"Layer source does not support deleteAttachments capability");return s.deleteAttachments(e,r)}async function hYe(t,e,r){const i=(await t.load({signal:e?.signal})).source;if(!i.fetchRecomputedExtents)throw new D(r,"Layer source does not support fetchUpdates capability");return i.fetchRecomputedExtents(e)}async function dYe(t,e,r,i){e=BH.from(e),await t.load();const s=t.source,n=t.capabilities;if(!n?.data?.supportsAttachment)throw new D(i,"this layer doesn't support attachments");const{attachmentTypes:o,objectIds:a,globalIds:l,num:c,size:h,start:p,where:f}=e;if(!n?.operations?.supportsQueryAttachments&&(o?.length>0||l?.length>0||h?.length>0||c||p||f))throw new D(i,"when 'capabilities.operations.supportsQueryAttachments' is false, only objectIds is supported",e);if(!(a?.length||l?.length||f))throw new D(i,"'objectIds', 'globalIds', or 'where' are required to perform attachment query",e);if(!s.queryAttachments)throw new D(i,"Layer source does not support queryAttachments capability",e);return s.queryAttachments(e)}async function pYe(t,e,r,i){const s=await ub(t);if(!s.queryObjectIds)throw new D(i,"Layer source does not support queryObjectIds capability");return s.queryObjectIds(cb.from(e)??t.createQuery(),r)}async function fYe(t,e,r,i){const s=await ub(t);if(!s.queryFeatureCount)throw new D(i,"Layer source does not support queryFeatureCount capability");return s.queryFeatureCount(cb.from(e)??t.createQuery(),r)}async function mYe(t,e,r,i){const s=await ub(t);if(!s.queryExtent)throw new D(i,"Layer source does not support queryExtent capability");return s.queryExtent(cb.from(e)??t.createQuery(),r)}async function gYe(t,e,r,i){const s=await ub(t);if(!s.queryRelatedFeatures)throw new D(i,"Layer source does not support queryRelatedFeatures capability");return s.queryRelatedFeatures(rP.from(e),r)}async function yYe(t,e,r,i){const s=await ub(t);if(!s.queryRelatedFeaturesCount)throw new D(i,"Layer source does not support queryRelatedFeaturesCount capability");return s.queryRelatedFeaturesCount(rP.from(e),r)}async function _Ye(t){const e=t.source;if(e?.refresh)try{const{dataChanged:r,updates:i}=await e.refresh();if(i!=null&&(t.sourceJSON={...t.sourceJSON,...i},t.read(i,{origin:"service",url:t.parsedUrl})),r)return!0}catch{}if(t.definitionExpression)try{return(await ZWe(t.definitionExpression,t.fieldsIndex)).hasDateFunctions}catch{}return!1}function vYe(t){const e=new cb,r=t.get("capabilities.data"),i=t.get("capabilities.query");e.historicMoment=t.historicMoment,e.gdbVersion=t.gdbVersion,e.returnGeometry=!0,i&&(e.compactGeometryEnabled=i.supportsCompactGeometry,e.defaultSpatialReferenceEnabled=i.supportsDefaultSpatialReference),r&&(r.supportsZ&&t.returnZ!=null&&(e.returnZ=t.returnZ),r.supportsM&&t.returnM!=null&&(e.returnM=t.returnM)),e.outFields=["*"];const{timeOffset:s,timeExtent:n}=t;return e.timeExtent=s!=null&&n!=null?n.offset(-s.value,s.unit):n||null,e.multipatchOption=t.geometryType==="multipatch"?"xyFootprint":null,e}function c2e(t){const{globalIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeGlobalID")return i.name}}function u2e(t){const{objectIdField:e,fields:r}=t;if(e)return e;if(r){for(const i of r)if(i.type==="esriFieldTypeOID")return i.name}}function bYe(t){return t.currentVersion?t.currentVersion:t.hasOwnProperty("capabilities")||t.hasOwnProperty("drawingInfo")||t.hasOwnProperty("hasAttachments")||t.hasOwnProperty("htmlPopupType")||t.hasOwnProperty("relationships")||t.hasOwnProperty("timeInfo")||t.hasOwnProperty("typeIdField")||t.hasOwnProperty("types")?10:9.3}async function ub(t){return(await t.load()).source}async function wYe(t,e){if(!Gt||Gt.findCredential(t))return;let r;try{const i=await EK(t,e);i&&(r=await Gt.checkSignInStatus(`${i}/sharing`))}catch{}if(r)try{const i=e!=null?e.signal:null;await Gt.getCredential(t,{signal:i})}catch{}}async function xYe(t,e){const r=t.parsedUrl?.path;r&&TYe(t)&&await wYe(r,e)}function TYe(t){const e=t.editFieldsInfo;return!(!e?.creatorField&&!e?.editorField)||(t.userHasUpdateItemPrivileges?t.hasUpdateItemRestrictions:!!t.userHasFullEditingPrivileges&&t.hasFullEditingRestrictions)}function SYe(t){return!t.sourceJSON?.isMultiServicesView&&(t.userHasUpdateItemPrivileges||t.editingEnabled)}const K9=sO({types:Gxe});function aee(t,e){if(t.defaultSymbol)return t.types&&t.types.length?new XK({defaultSymbol:K9(t.defaultSymbol,t,e),field:t.typeIdField,uniqueValueInfos:t.types.map(r=>({id:r.id,symbol:K9(r.symbol,r,e)}))}):new fV({symbol:K9(t.defaultSymbol,t,e)})}let lE=class extends rs(he){constructor(e){super(e),this.shapeAreaField=null,this.shapeLengthField=null,this.units=null}};u([d({type:String,json:{read:{source:"shapeAreaFieldName"}}})],lE.prototype,"shapeAreaField",void 0),u([d({type:String,json:{read:{source:"shapeLengthFieldName"}}})],lE.prototype,"shapeLengthField",void 0),u([d({type:String,json:{read:t=>l8e.read(t)||c8e.read(t)}})],lE.prototype,"units",void 0),lE=u([R("esri.layers.support.GeometryFieldsInfo")],lE);const EYe=lE;var cW;let cE=cW=class extends he{constructor(t){super(t),this.floorField=null,this.viewAllMode=!1,this.viewAllLevelIds=new Ke}clone(){return new cW({floorField:this.floorField,viewAllMode:this.viewAllMode,viewAllLevelIds:this.viewAllLevelIds})}};u([d({type:String,json:{write:!0}})],cE.prototype,"floorField",void 0),u([d({json:{read:!1,write:!1}})],cE.prototype,"viewAllMode",void 0),u([d({json:{read:!1,write:!1}})],cE.prototype,"viewAllLevelIds",void 0),cE=cW=u([R("esri.layers.support.LayerFloorInfo")],cE);const h2e=cE,Jae=new kr({esriRelCardinalityOneToOne:"one-to-one",esriRelCardinalityOneToMany:"one-to-many",esriRelCardinalityManyToMany:"many-to-many"}),Qae=new kr({esriRelRoleOrigin:"origin",esriRelRoleDestination:"destination"});let Yh=class extends rs(he){constructor(e){super(e),this.cardinality=null,this.composite=null,this.id=null,this.keyField=null,this.keyFieldInRelationshipTable=null,this.name=null,this.relatedTableId=null,this.relationshipTableId=null,this.role=null}};u([d({json:{read:Jae.read,write:Jae.write}})],Yh.prototype,"cardinality",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"composite",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"id",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"keyField",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"keyFieldInRelationshipTable",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"name",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"relatedTableId",void 0),u([d({json:{read:!0,write:!0}})],Yh.prototype,"relationshipTableId",void 0),u([d({json:{read:Qae.read,write:Qae.write}})],Yh.prototype,"role",void 0),Yh=u([R("esri.layers.support.Relationship")],Yh);const CYe=Yh,AYe={name:"supportsName",size:"supportsSize",contentType:"supportsContentType",keywords:"supportsKeywords",exifInfo:"supportsExifInfo"};function Bt(t,e,r){return!!d2e(t,e,r)}function IL(t,e,r){return d2e(t,e,r)}function d2e(t,e,r){return t&&t.hasOwnProperty(e)?t[e]:r}function OYe(t){const e=t?.supportedSpatialAggregationStatistics?.map(r=>r.toLowerCase());return{envelope:!!e?.includes("envelopeaggregate"),centroid:!!e?.includes("centroidaggregate"),convexHull:!!e?.includes("convexhullaggregate")}}function m$(t,e){return!!t?.supportedOperationsWithCacheHint?.map(i=>i.toLowerCase())?.includes(e.toLowerCase())}function p2e(t,e){return{analytics:RYe(t),attachment:MYe(t),data:IYe(t),metadata:PYe(t),operations:$Ye(t.capabilities,t,e),query:LYe(t,e),queryRelated:DYe(t),queryTopFeatures:NYe(t),editing:FYe(t)}}function RYe(t){return{supportsCacheHint:m$(t.advancedQueryCapabilities,"queryAnalytics")}}function MYe(t){const e=t.attachmentProperties,r={supportsName:!1,supportsSize:!1,supportsContentType:!1,supportsKeywords:!1,supportsExifInfo:!1,supportsCacheHint:m$(t.advancedQueryCapabilities,"queryAttachments"),supportsResize:Bt(t,"supportsAttachmentsResizing",!1)};return e&&Array.isArray(e)&&e.forEach(i=>{const s=AYe[i.name];s&&(r[s]=!!i.isEnabled)}),r}function IYe(t){return{isVersioned:Bt(t,"isDataVersioned",!1),supportsAttachment:Bt(t,"hasAttachments",!1),supportsM:Bt(t,"hasM",!1),supportsZ:Bt(t,"hasZ",!1)}}function PYe(t){return{supportsAdvancedFieldProperties:Bt(t,"supportsFieldDescriptionProperty",!1)}}function $Ye(t,e,r){const i=t?t.toLowerCase().split(",").map(f=>f.trim()):[],s=r?sg(r):null,n=i.includes(s!=null&&s.serverType==="MapServer"?"data":"query"),o=i.includes("editing")&&!e.datesInUnknownTimezone;let a=o&&i.includes("create"),l=o&&i.includes("delete"),c=o&&i.includes("update");const h=i.includes("changetracking"),p=e.advancedQueryCapabilities;return o&&!(a||l||c)&&(a=l=c=!0),{supportsCalculate:Bt(e,"supportsCalculate",!1),supportsTruncate:Bt(e,"supportsTruncate",!1),supportsValidateSql:Bt(e,"supportsValidateSql",!1),supportsAdd:a,supportsDelete:l,supportsEditing:o,supportsChangeTracking:h,supportsQuery:n,supportsQueryAnalytics:Bt(p,"supportsQueryAnalytic",!1),supportsQueryAttachments:Bt(p,"supportsQueryAttachments",!1),supportsQueryTopFeatures:Bt(p,"supportsTopFeaturesQuery",!1),supportsResizeAttachments:Bt(e,"supportsAttachmentsResizing",!1),supportsSync:i.includes("sync"),supportsUpdate:c,supportsExceedsLimitStatistics:Bt(e,"supportsExceedsLimitStatistics",!1),supportsAsyncConvert3D:Bt(e,"supportsAsyncConvert3D",!1)}}function LYe(t,e){const r=t.advancedQueryCapabilities,i=t.ownershipBasedAccessControlForFeatures,s=t.archivingInfo,n=t.currentVersion,o=e?.includes("MapServer"),a=!o||n>=le("mapserver-pbf-version-support"),l=LK(e),c=new Set((t.supportedQueryFormats??"").split(",").map(h=>h.toLowerCase().trim()));return{supportsStatistics:Bt(r,"supportsStatistics",t.supportsStatistics),supportsPercentileStatistics:Bt(r,"supportsPercentileStatistics",!1),supportsSpatialAggregationStatistics:Bt(r,"supportsSpatialAggregationStatistics",!1),supportedSpatialAggregationStatistics:OYe(r),supportsCentroid:Bt(r,"supportsReturningGeometryCentroid",!1),supportsDistance:Bt(r,"supportsQueryWithDistance",!1),supportsDistinct:Bt(r,"supportsDistinct",t.supportsAdvancedQueries),supportsExtent:Bt(r,"supportsReturningQueryExtent",!1),supportsGeometryProperties:Bt(r,"supportsReturningGeometryProperties",!1),supportsHavingClause:Bt(r,"supportsHavingClause",!1),supportsOrderBy:Bt(r,"supportsOrderBy",t.supportsAdvancedQueries),supportsPagination:Bt(r,"supportsPagination",!1),supportsQuantization:Bt(t,"supportsCoordinatesQuantization",!1),supportsQuantizationEditMode:Bt(t,"supportsQuantizationEditMode",!1),supportsQueryGeometry:Bt(t,"supportsReturningQueryGeometry",!1),supportsResultType:Bt(r,"supportsQueryWithResultType",!1),supportsMaxRecordCountFactor:Bt(r,"supportsMaxRecordCountFactor",!1),supportsSqlExpression:Bt(r,"supportsSqlExpression",!1),supportsStandardizedQueriesOnly:Bt(t,"useStandardizedQueries",!1),supportsTopFeaturesQuery:Bt(r,"supportsTopFeaturesQuery",!1),supportsQueryByOthers:Bt(i,"allowOthersToQuery",!0),supportsHistoricMoment:Bt(s,"supportsQueryWithHistoricMoment",!1),supportsFormatPBF:a&&c.has("pbf"),supportsDisjointSpatialRelationship:Bt(r,"supportsDisjointSpatialRel",!1),supportsCacheHint:Bt(r,"supportsQueryWithCacheHint",!1)||m$(r,"query"),supportsDefaultSpatialReference:Bt(r,"supportsDefaultSR",!1),supportsCompactGeometry:l,supportsFullTextSearch:Bt(r,"supportsFullTextSearch",!1),maxRecordCountFactor:IL(t,"maxRecordCountFactor",void 0),maxRecordCount:IL(t,"maxRecordCount",void 0),standardMaxRecordCount:IL(t,"standardMaxRecordCount",void 0),tileMaxRecordCount:IL(t,"tileMaxRecordCount",void 0)}}function DYe(t){const e=t.advancedQueryCapabilities,r=Bt(e,"supportsAdvancedQueryRelated",!1);return{supportsPagination:Bt(e,"supportsQueryRelatedPagination",!1),supportsCount:r,supportsOrderBy:r,supportsCacheHint:m$(e,"queryRelated")}}function NYe(t){return{supportsCacheHint:m$(t.advancedQueryCapabilities,"queryTopFilter")}}function FYe(t){const e=t.ownershipBasedAccessControlForFeatures,r=t?t.advancedEditingCapabilities:void 0;return{supportsGeometryUpdate:Bt(t,"allowGeometryUpdates",!0),supportsGlobalId:Bt(t,"supportsApplyEditsWithGlobalIds",!1),supportsReturnServiceEditsInSourceSpatialReference:Bt(t,"supportsReturnServiceEditsInSourceSR",!1),supportsRollbackOnFailure:Bt(t,"supportsRollbackOnFailureParameter",!1),supportsUpdateWithoutM:Bt(t,"allowUpdateWithoutMValues",!1),supportsUploadWithItemId:Bt(t,"supportsAttachmentsByUploadId",!1),supportsDeleteByAnonymous:Bt(e,"allowAnonymousToDelete",!0),supportsDeleteByOthers:Bt(e,"allowOthersToDelete",!0),supportsUpdateByAnonymous:Bt(e,"allowAnonymousToUpdate",!0),supportsUpdateByOthers:Bt(e,"allowOthersToUpdate",!0),supportsAsyncApplyEdits:Bt(r,"supportsAsyncApplyEdits",!1)}}const kYe=t=>{let e=class extends t{constructor(){super(...arguments),this.capabilities=null,this.copyright=null,this.dateFieldsTimeReference=null,this.datesInUnknownTimezone=!1,this.displayField=null,this.definitionExpression=null,this.editFieldsInfo=null,this.editingInfo=null,this.elevationInfo=null,this.floorInfo=null,this.fullExtent=null,this.gdbVersion=null,this.geometryFieldsInfo=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.heightModelInfo=null,this.historicMoment=null,this.isTable=!1,this.layerId=void 0,this.minScale=0,this.maxScale=0,this.globalIdField=null,this.objectIdField=null,this.preferredTimeReference=null,this.relationships=null,this.sourceJSON=null,this.returnM=void 0,this.returnZ=void 0,this.serviceDefinitionExpression=null,this.serviceItemId=null,this.spatialReference=qe.WGS84,this.subtypeField=null,this.trackIdField=null,this.indexes=new(Ke.ofType(Vm)),this.version=void 0}readCapabilitiesFromService(r,i){return p2e(i,this.url)}get effectiveCapabilities(){const r=this.capabilities;if(!r)return null;const i=re(r),{operations:s,editing:n}=i;return this.sourceJSON?.isMultiServicesView?(this.userHasUpdateItemPrivileges&&(s.supportsQuery=!0),i):this.userHasUpdateItemPrivileges?(s.supportsAdd=s.supportsDelete=s.supportsEditing=s.supportsQuery=s.supportsUpdate=n.supportsDeleteByOthers=n.supportsGeometryUpdate=n.supportsUpdateByOthers=!0,i):(this.userHasFullEditingPrivileges&&s.supportsEditing&&(s.supportsAdd=s.supportsDelete=s.supportsUpdate=n.supportsGeometryUpdate=!0),i)}get hasFullEditingRestrictions(){const r=this.capabilities;if(!r||this.sourceJSON?.isMultiServicesView)return!1;const{operations:i,editing:s}=r;return i.supportsEditing&&!(i.supportsAdd&&i.supportsDelete&&i.supportsUpdate&&s.supportsGeometryUpdate)}get hasUpdateItemRestrictions(){const r=this.capabilities;if(!r)return!1;const{operations:i,editing:s}=r;return this.sourceJSON?.isMultiServicesView?!i.supportsQuery:!(i.supportsAdd&&i.supportsDelete&&i.supportsEditing&&i.supportsQuery&&i.supportsUpdate&&s.supportsDeleteByOthers&&s.supportsGeometryUpdate&&s.supportsUpdateByOthers)}readEditingInfo(r,i){const{editingInfo:s}=i;return s?{lastEditDate:s.lastEditDate!=null?new Date(s.lastEditDate):null}:null}readIsTableFromService(r,i){return i.type==="Table"}readMinScale(r,i){return i.effectiveMinScale||r||0}readMaxScale(r,i){return i.effectiveMaxScale||r||0}readGlobalIdFieldFromService(r,i){return c2e(i)}readObjectIdFieldFromService(r,i){return u2e(i)}readServiceDefinitionExpression(r,i){return i.definitionQuery||i.definitionExpression}set url(r){const i=wTe({layer:this,url:r,nonStandardUrlAllowed:!0,logger:K.getLogger(this)});this._set("url",i.url),i.layerId!=null&&this._set("layerId",i.layerId)}writeUrl(r,i,s,n){xTe(this,r,null,i,n)}readVersion(r,i){return bYe(i)}};return u([d({readOnly:!0,json:{read:!1,origins:{service:{read:{source:["advancedQueryCapabilities","allowGeometryUpdates","allowUpdateWithoutMValues","archivingInfo","capabilities","datesInUnknownTimezone","hasAttachments","hasM","hasZ","maxRecordCount","maxRecordCountFactor","ownershipBasedAccessControlForFeatures","standardMaxRecordCount","supportedQueryFormats","supportsAdvancedQueries","supportsApplyEditsWithGlobalIds","supportsAttachmentsByUploadId","supportsAttachmentsResizing","supportsCalculate","supportsCoordinatesQuantization","supportsExceedsLimitStatistics","supportsFieldDescriptionProperty","supportsQuantizationEditMode","supportsRollbackOnFailureParameter","supportsStatistics","supportsTruncate","supportsValidateSql","tileMaxRecordCount","useStandardizedQueries"]}}}}})],e.prototype,"capabilities",void 0),u([Ae("service","capabilities")],e.prototype,"readCapabilitiesFromService",null),u([d({readOnly:!0})],e.prototype,"effectiveCapabilities",null),u([d({readOnly:!0})],e.prototype,"hasFullEditingRestrictions",null),u([d({readOnly:!0})],e.prototype,"hasUpdateItemRestrictions",null),u([d({type:String,json:{origins:{service:{read:{source:"copyrightText"}}}}})],e.prototype,"copyright",void 0),u([d({type:fA})],e.prototype,"dateFieldsTimeReference",void 0),u([d({type:Boolean})],e.prototype,"datesInUnknownTimezone",void 0),u([d({type:String,json:{origins:{service:{read:{source:"displayField"}}}}})],e.prototype,"displayField",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],e.prototype,"definitionExpression",void 0),u([d({readOnly:!0,type:nYe})],e.prototype,"editFieldsInfo",void 0),u([d({readOnly:!0})],e.prototype,"editingInfo",void 0),u([Ae("editingInfo")],e.prototype,"readEditingInfo",null),u([d((()=>{const r=re(n2e),i=r.json.origins;return i["web-map"]={read:!1,write:!1},i["portal-item"]={read:!1,write:!1},r})())],e.prototype,"elevationInfo",void 0),u([d({type:h2e,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],e.prototype,"floorInfo",void 0),u([d({type:vr,json:{origins:{service:{read:{source:"extent"}}}}})],e.prototype,"fullExtent",void 0),u([d()],e.prototype,"gdbVersion",void 0),u([d({readOnly:!0,type:EYe,json:{read:{source:"geometryProperties"}}})],e.prototype,"geometryFieldsInfo",void 0),u([d({type:["point","polygon","polyline","multipoint","multipatch","mesh"],json:{origins:{service:{read:lW.read}}}})],e.prototype,"geometryType",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasM",void 0),u([d({type:Boolean,json:{origins:{service:{read:!0}}}})],e.prototype,"hasZ",void 0),u([d({readOnly:!0,type:dS})],e.prototype,"heightModelInfo",void 0),u([d({type:Date})],e.prototype,"historicMoment",void 0),u([d({readOnly:!0})],e.prototype,"isTable",void 0),u([Ae("service","isTable",["type"])],e.prototype,"readIsTableFromService",null),u([d({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{read:!1,write:{target:"id"}}},read:!1}})],e.prototype,"layerId",void 0),u([d(eYe)],e.prototype,"minScale",void 0),u([Ae("service","minScale",["minScale","effectiveMinScale"])],e.prototype,"readMinScale",null),u([d(tYe)],e.prototype,"maxScale",void 0),u([Ae("service","maxScale",["maxScale","effectiveMaxScale"])],e.prototype,"readMaxScale",null),u([d({type:String})],e.prototype,"globalIdField",void 0),u([Ae("service","globalIdField",["globalIdField","fields"])],e.prototype,"readGlobalIdFieldFromService",null),u([d({type:String})],e.prototype,"objectIdField",void 0),u([Ae("service","objectIdField",["objectIdField","fields"])],e.prototype,"readObjectIdFieldFromService",null),u([d({type:fA})],e.prototype,"preferredTimeReference",void 0),u([d({type:[CYe],readOnly:!0})],e.prototype,"relationships",void 0),u([d()],e.prototype,"sourceJSON",void 0),u([d({type:Boolean})],e.prototype,"returnM",void 0),u([d({type:Boolean})],e.prototype,"returnZ",void 0),u([d({readOnly:!0})],e.prototype,"serviceDefinitionExpression",void 0),u([Ae("service","serviceDefinitionExpression",["definitionQuery","definitionExpression"])],e.prototype,"readServiceDefinitionExpression",null),u([d({type:String,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],e.prototype,"serviceItemId",void 0),u([d({type:qe,json:{origins:{service:{read:{source:"extent.spatialReference"}}}}})],e.prototype,"spatialReference",void 0),u([d({type:String,readOnly:!0,json:{origins:{service:{read:!0}}}})],e.prototype,"subtypeField",void 0),u([d({type:String,json:{read:{source:"timeInfo.trackIdField"}}})],e.prototype,"trackIdField",void 0),u([d({readOnly:!0,json:{write:!1}})],e.prototype,"serverGens",void 0),u([d({type:Ke.ofType(Vm),readOnly:!0})],e.prototype,"indexes",void 0),u([d(i2e)],e.prototype,"url",null),u([Ve("url")],e.prototype,"writeUrl",null),u([d({json:{origins:{service:{read:!0}},read:!1}})],e.prototype,"version",void 0),u([Ae("service","version",["currentVersion","capabilities","drawingInfo","hasAttachments","htmlPopupType","relationships","timeInfo","typeIdField","types"])],e.prototype,"readVersion",null),e=u([R("esri.layers.mixins.FeatureLayerBase")],e),e};let uE=class extends rs(he){constructor(e){super(e),this.expression=null,this.title=null,this.returnType=null}};u([d({type:String,json:{write:!0}})],uE.prototype,"expression",void 0),u([d({type:String,json:{write:!0}})],uE.prototype,"title",void 0),u([d({type:String,json:{write:!0}})],uE.prototype,"returnType",void 0),uE=u([R("esri.layers.support.ExpressionInfo")],uE);const lee=uE;var uW;let Ty=uW=class extends he{constructor(t){super(t),this.isAutoGenerated=!1,this.name=null,this.alias=null,this.onStatisticField=null,this.onStatisticExpression=null,this.statisticType=null}clone(){return new uW({name:this.name,alias:this.alias,isAutoGenerated:this.isAutoGenerated,onStatisticExpression:re(this.onStatisticExpression),onStatisticField:this.onStatisticField,statisticType:this.statisticType})}};u([d({type:Boolean,json:{write:!0}})],Ty.prototype,"isAutoGenerated",void 0),u([d({type:String,json:{write:!0}})],Ty.prototype,"name",void 0),u([d({type:String,json:{write:!0}})],Ty.prototype,"alias",void 0),u([d({type:String,json:{write:!0}})],Ty.prototype,"onStatisticField",void 0),u([d({type:lee,json:{write:!0}})],Ty.prototype,"onStatisticExpression",void 0),u([d({type:String,json:{write:!0}})],Ty.prototype,"statisticType",void 0),Ty=uW=u([R("esri.layers.support.AggregateField")],Ty);const NT=Ty;let c0=class extends he{constructor(){super(...arguments),this.type=null}};u([d({type:["selection","cluster","binning"],readOnly:!0,json:{read:!1,write:!0}})],c0.prototype,"type",void 0),c0=u([R("esri.layers.support.FeatureReduction")],c0);const cee="__begin__",uee="__end__",UYe=new RegExp(cee,"ig"),VYe=new RegExp(uee,"ig"),Kae=new RegExp("^"+cee,"i"),ele=new RegExp(uee+"$","i"),Pk='"',zYe=Pk+" + ",BYe=" + "+Pk;function GYe(t){return t.replaceAll(new RegExp("\\[","g"),"{").replaceAll(new RegExp("\\]","g"),"}")}function jYe(t){return t.replaceAll(new RegExp("\\{","g"),"[").replaceAll(new RegExp("\\}","g"),"]")}function CV(t){const e={expression:"",type:"none"};return t.labelExpressionInfo?t.labelExpressionInfo.value?(e.expression=t.labelExpressionInfo.value,e.type="conventional"):t.labelExpressionInfo.expression&&(e.expression=t.labelExpressionInfo.expression,e.type="arcade"):t.labelExpression!=null&&(e.expression=GYe(t.labelExpression),e.type="conventional"),e}function HYe(t){const e=CV(t);if(!e)return null;switch(e.type){case"conventional":return hW(e.expression);case"arcade":return e.expression}return null}function qYe(t){const e=CV(t);if(!e)return null;switch(e.type){case"conventional":return ZYe(e.expression);case"arcade":return hee(e.expression)}return null}function hW(t){let e;return t?(e=fg(t,r=>cee+'$feature["'+r+'"]'+uee),e=Kae.test(e)?e.replace(Kae,""):Pk+e,e=ele.test(e)?e.replace(ele,""):e+Pk,e=e.replaceAll(UYe,zYe).replaceAll(VYe,BYe)):e='""',e}const WYe=/^\s*\{([^}]+)\}\s*$/i;function ZYe(t){const e=t?.match(WYe);return e&&e[1].trim()||null}const XYe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*$/i,YYe=/^\s*(?:(?:\$feature\.(\w+))|(?:\$feature\[(["'])([\w\s]+)(\2)\]));?\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])(\1|\3)(\5)\s*\));?\s*$/i,JYe=/^\s*(?:DomainName\(\s*\$feature\s*,\s*(["'])([\w\s]+)(\1)\s*\));?\s*$/i;function hee(t){if(!t)return null;let e=XYe.exec(t)||YYe.exec(t);return e?e[1]||e[3]:(e=JYe.exec(t),e?e[2]:null)}var dW;let sv=dW=class extends he{constructor(){super(...arguments),this.expression=null,this.title=null,this.value=null}readExpression(t,e){return e.value?hW(e.value):t}writeExpression(t,e,r){this.value!=null&&(t=hW(this.value)),t!=null&&(e[r]=t)}clone(){return new dW({expression:this.expression,title:this.title,value:this.value})}};u([d({type:String,json:{write:{writerEnsuresNonNull:!0}}})],sv.prototype,"expression",void 0),u([Ae("expression",["expression","value"])],sv.prototype,"readExpression",null),u([Ve("expression")],sv.prototype,"writeExpression",null),u([d({type:String,json:{write:!0,origins:{"web-scene":{write:!1}}}})],sv.prototype,"title",void 0),u([d({json:{read:!1,write:!1}})],sv.prototype,"value",void 0),sv=dW=u([R("esri.layers.support.LabelExpressionInfo")],sv);const f2e=sv,m2e=[252,146,31,255],mkt=[153,153,153,255],QYe={type:"esriSMS",style:"esriSMSCircle",size:6,color:m2e,outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[153,153,153,255]}},KYe={type:"esriSLS",style:"esriSLSSolid",width:.75,color:m2e},eJe={type:"esriSFS",style:"esriSFSSolid",color:[252,146,31,196],outline:{type:"esriSLS",style:"esriSLSSolid",width:.75,color:[255,255,255,191]}},tJe={type:"esriTS",color:[255,255,255,255],font:{family:"arial-unicode-ms",size:10,weight:"bold"},horizontalAlignment:"center",kerning:!0,haloColor:[0,0,0,255],haloSize:1,rotated:!1,text:"",xoffset:0,yoffset:0,angle:0},rJe={type:"esriSMS",style:"esriSMSCircle",color:[0,0,0,255],outline:null,size:10.5},iJe={type:"esriSLS",style:"esriSLSSolid",color:[0,0,0,255],width:1.5},sJe={type:"esriSFS",style:"esriSFSSolid",color:[0,0,0,255],outline:null},nJe=Pf.fromJSON(QYe),oJe=Iu.fromJSON(KYe),aJe=U0.fromJSON(eJe),lJe=hO.fromJSON(tJe);function gkt(t){if(t==null)return null;switch(t.type){case"mesh":return null;case"point":case"multipoint":return nJe;case"polyline":return oJe;case"polygon":case"extent":return aJe}return null}Pf.fromJSON(rJe);Iu.fromJSON(iJe);U0.fromJSON(sJe);var pW;const PL=new kr({esriServerPointLabelPlacementAboveCenter:"above-center",esriServerPointLabelPlacementAboveLeft:"above-left",esriServerPointLabelPlacementAboveRight:"above-right",esriServerPointLabelPlacementBelowCenter:"below-center",esriServerPointLabelPlacementBelowLeft:"below-left",esriServerPointLabelPlacementBelowRight:"below-right",esriServerPointLabelPlacementCenterCenter:"center-center",esriServerPointLabelPlacementCenterLeft:"center-left",esriServerPointLabelPlacementCenterRight:"center-right",esriServerLinePlacementAboveAfter:"above-after",esriServerLinePlacementAboveAlong:"above-along",esriServerLinePlacementAboveBefore:"above-before",esriServerLinePlacementAboveStart:"above-start",esriServerLinePlacementAboveEnd:"above-end",esriServerLinePlacementBelowAfter:"below-after",esriServerLinePlacementBelowAlong:"below-along",esriServerLinePlacementBelowBefore:"below-before",esriServerLinePlacementBelowStart:"below-start",esriServerLinePlacementBelowEnd:"below-end",esriServerLinePlacementCenterAfter:"center-after",esriServerLinePlacementCenterAlong:"center-along",esriServerLinePlacementCenterBefore:"center-before",esriServerLinePlacementCenterStart:"center-start",esriServerLinePlacementCenterEnd:"center-end",esriServerPolygonPlacementAlwaysHorizontal:"always-horizontal"},{ignoreUnknown:!0});function $L(t,e,r){return{enabled:!qxe(r?.layer)}}function g2e(t){return!t||t.origin!=="service"&&t.layer?.type!=="map-image"}function cJe(t){return t?.type==="map-image"}function y2e(t){return!!cJe(t)&&!!t.capabilities?.exportMap?.supportsArcadeExpressionForLabeling}function uJe(t){return g2e(t)||y2e(t?.layer)}let Cn=pW=class extends he{static evaluateWhere(t,e){const r=(i,s,n)=>{switch(s){case"=":return i==n;case"<>":return i!=n;case">":return i>n;case">=":return i>=n;case"<":return i<n;case"<=":return i<=n}return!1};try{if(t==null)return!0;const i=t.split(" ");if(i.length===3)return r(e[i[0]],i[1],i[2]);if(i.length===7){const s=r(e[i[0]],i[1],i[2]),n=i[3],o=r(e[i[4]],i[5],i[6]);switch(n){case"AND":return s&&o;case"OR":return s||o}}return!1}catch{console.log("Error.: can't parse = "+t)}}constructor(t){super(t),this.type="label",this.name=null,this.allowOverrun=!1,this.deconflictionStrategy="static",this.labelExpression=null,this.labelExpressionInfo=null,this.labelPlacement=null,this.labelPosition="curved",this.maxScale=0,this.minScale=0,this.repeatLabel=!0,this.repeatLabelDistance=null,this.symbol=lJe,this.useCodedValues=void 0,this.where=null}readLabelExpression(t,e){const r=e.labelExpressionInfo;if(!r||!r.value&&!r.expression)return t}writeLabelExpression(t,e,r){if(this.labelExpressionInfo){if(this.labelExpressionInfo.value!=null)t=jYe(this.labelExpressionInfo.value);else if(this.labelExpressionInfo.expression!=null){const i=hee(this.labelExpressionInfo.expression);i&&(t="["+i+"]")}}t!=null&&(e[r]=t)}writeLabelExpressionInfo(t,e,r,i){if(t==null&&this.labelExpression!=null&&g2e(i))t=new f2e({expression:this.getLabelExpressionArcade()});else if(!t)return;const s=t.toJSON(i);s.expression&&(e[r]=s)}writeMaxScale(t,e){(t||this.minScale)&&(e.maxScale=t)}writeMinScale(t,e){(t||this.maxScale)&&(e.minScale=t)}getLabelExpression(){return CV(this)}getLabelExpressionArcade(){return HYe(this)}getLabelExpressionSingleField(){return qYe(this)}hash(){return JSON.stringify(this)}clone(){return new pW({allowOverrun:this.allowOverrun,deconflictionStrategy:this.deconflictionStrategy,labelExpression:this.labelExpression,labelExpressionInfo:re(this.labelExpressionInfo),labelPosition:this.labelPosition,labelPlacement:this.labelPlacement,maxScale:this.maxScale,minScale:this.minScale,name:this.name,repeatLabel:this.repeatLabel,repeatLabelDistance:this.repeatLabelDistance,symbol:re(this.symbol),where:this.where,useCodedValues:this.useCodedValues})}};u([d({type:String,json:{write:!0}})],Cn.prototype,"name",void 0),u([d({type:Boolean,json:{write:!0,default:!1,origins:{"web-scene":{write:!1},"portal-item":{default:!1,write:{overridePolicy:$L}}}}})],Cn.prototype,"allowOverrun",void 0),u([d({type:String,json:{write:!0,default:"static",origins:{"web-scene":{write:!1},"portal-item":{default:"static",write:{overridePolicy:$L}}}}})],Cn.prototype,"deconflictionStrategy",void 0),u([d({type:String,json:{write:{overridePolicy(t,e,r){return this.labelExpressionInfo&&r?.origin==="service"&&y2e(r.layer)?{enabled:!1}:{allowNull:!0}}}}})],Cn.prototype,"labelExpression",void 0),u([Ae("labelExpression")],Cn.prototype,"readLabelExpression",null),u([Ve("labelExpression")],Cn.prototype,"writeLabelExpression",null),u([d({type:f2e,json:{write:{overridePolicy:(t,e,r)=>uJe(r)?{allowNull:!0}:{enabled:!1}}}})],Cn.prototype,"labelExpressionInfo",void 0),u([Ve("labelExpressionInfo")],Cn.prototype,"writeLabelExpressionInfo",null),u([d({type:PL.apiValues,json:{type:PL.jsonValues,read:PL.read,write:PL.write}})],Cn.prototype,"labelPlacement",void 0),u([d({type:["curved","parallel"],json:{write:!0,origins:{"web-map":{write:!1},"web-scene":{write:!1},"portal-item":{write:!1}}}})],Cn.prototype,"labelPosition",void 0),u([d({type:Number})],Cn.prototype,"maxScale",void 0),u([Ve("maxScale")],Cn.prototype,"writeMaxScale",null),u([d({type:Number})],Cn.prototype,"minScale",void 0),u([Ve("minScale")],Cn.prototype,"writeMinScale",null),u([d({type:Boolean,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:$L}}}}})],Cn.prototype,"repeatLabel",void 0),u([d({type:Number,cast:oi,json:{write:!0,origins:{"web-scene":{write:!1},"portal-item":{write:{overridePolicy:$L}}}}})],Cn.prototype,"repeatLabelDistance",void 0),u([d({types:eHe,json:{origins:{"web-scene":{types:tHe,write:nae,default:null}},write:nae,default:null}})],Cn.prototype,"symbol",void 0),u([d({type:Boolean,json:{write:!0}})],Cn.prototype,"useCodedValues",void 0),u([d({type:String,json:{write:!0}})],Cn.prototype,"where",void 0),Cn=pW=u([R("esri.layers.support.LabelClass")],Cn);const g$=Cn;var fW;const hJe="esri.layers.support.FeatureReductionBinning";let tc=fW=class extends c0{constructor(t){super(t),this.type="binning",this.binType="geohash",this.fixedBinLevel=3,this.labelingInfo=null,this.labelsVisible=!0,this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.fields=[],this.renderer=null}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());Ul(r,i,e)}readRenderer(t,e,r){const i=e.drawingInfo?.renderer;return i?KI(i,e,r)??void 0:aee(e,r)}clone(){return new fW({fields:re(this.fields),fixedBinLevel:this.fixedBinLevel,labelingInfo:re(this.labelingInfo),labelsVisible:this.labelsVisible,maxScale:this.maxScale,popupEnabled:this.popupEnabled,popupTemplate:re(this.popupTemplate),renderer:re(this.renderer)})}};u([nt({binning:"binning"})],tc.prototype,"type",void 0),u([nt({geohash:"geohash"})],tc.prototype,"binType",void 0),u([d({type:Number,range:{min:1,max:9},json:{write:!0}})],tc.prototype,"fixedBinLevel",void 0),u([d({type:[g$],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],tc.prototype,"labelingInfo",void 0),u([d(EV)],tc.prototype,"labelsVisible",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],tc.prototype,"maxScale",void 0),u([d(SV)],tc.prototype,"popupEnabled",void 0),u([d({type:aO,json:{name:"popupInfo",write:!0}})],tc.prototype,"popupTemplate",void 0),u([d({type:[NT],json:{write:!0}})],tc.prototype,"fields",void 0),u([Ve("fields")],tc.prototype,"writeFields",null),u([d({types:mV,json:{write:{target:"drawingInfo.renderer"}}})],tc.prototype,"renderer",void 0),u([Ae("renderer",["drawingInfo.renderer"])],tc.prototype,"readRenderer",null),tc=fW=u([R(hJe)],tc);const _2e=tc;var mW;const dJe="esri.layers.support.FeatureReductionCluster";function tle(t){return t.type==="simple"&&!t.visualVariables?.length}let _o=mW=class extends he{constructor(t){super(t),this.type="cluster",this.clusterRadius=oi("80px"),this.clusterMinSize=oi("12px"),this.clusterMaxSize=oi("50px"),this.maxScale=0,this.popupEnabled=!0,this.popupTemplate=null,this.renderer=null,this.symbol=null,this.labelingInfo=null,this.labelsVisible=!0,this.fields=null}readRenderer(t,e,r){const i=e.drawingInfo?.renderer;return i?.authoringInfo?.isAutoGenerated?null:i?tle(i)?null:KI(i,e,r)??void 0:aee(e,r)}readSymbol(t,e,r){const i=e.drawingInfo?.renderer;return i?.authoringInfo?.isAutoGenerated?null:i&&tle(i)?KI(i,e,r)?.symbol:null}writeSymbol(t,e,r,i){const s=this.renderer?.authoringInfo?.isAutoGenerated;if(!this.renderer||s){const n=new fV({symbol:t});e.drawingInfo={renderer:n.write({},i)}}}writeFields(t,e,r){const i=t.filter(s=>s.statisticType!=="avg_angle").map(s=>s.toJSON());Ul(r,i,e)}readFields(t,e,r){return t.filter(i=>!i.isAutoGenerated).map(i=>NT.fromJSON(i))}clone(){return new mW({clusterRadius:this.clusterRadius,clusterMinSize:this.clusterMinSize,clusterMaxSize:this.clusterMaxSize,labelingInfo:re(this.labelingInfo),labelsVisible:this.labelsVisible,fields:re(this.fields),maxScale:this.maxScale,renderer:re(this.renderer),symbol:re(this.symbol),popupEnabled:this.popupEnabled,popupTemplate:re(this.popupTemplate)})}};u([d({type:["cluster"],readOnly:!0,json:{write:!0}})],_o.prototype,"type",void 0),u([d({type:Number,cast:t=>t==="auto"?t:oi(t),json:{write:!0}})],_o.prototype,"clusterRadius",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],_o.prototype,"clusterMinSize",void 0),u([d({type:Number,cast:oi,json:{write:!0}})],_o.prototype,"clusterMaxSize",void 0),u([d({type:Number,json:{default:0,name:"visibilityInfo.maxScale"}})],_o.prototype,"maxScale",void 0),u([d(SV)],_o.prototype,"popupEnabled",void 0),u([d({type:aO,json:{read:{source:"popupInfo"},write:{target:"popupInfo"}}})],_o.prototype,"popupTemplate",void 0),u([d({types:mV,json:{write:{target:"drawingInfo.renderer"}}})],_o.prototype,"renderer",void 0),u([Ae("renderer",["drawingInfo.renderer"])],_o.prototype,"readRenderer",null),u([d({types:Q7e})],_o.prototype,"symbol",void 0),u([Ae("symbol",["drawingInfo.renderer"])],_o.prototype,"readSymbol",null),u([Ve("symbol")],_o.prototype,"writeSymbol",null),u([d({type:[g$],json:{read:{source:"drawingInfo.labelingInfo"},write:{target:"drawingInfo.labelingInfo"}}})],_o.prototype,"labelingInfo",void 0),u([d(EV)],_o.prototype,"labelsVisible",void 0),u([d({type:[NT],json:{write:!0}})],_o.prototype,"fields",void 0),u([Ve("fields")],_o.prototype,"writeFields",null),u([Ae("fields")],_o.prototype,"readFields",null),_o=mW=u([R(dJe)],_o);const v2e=_o;var gW;let m4=gW=class extends c0{constructor(t){super(t),this.type="selection"}clone(){return new gW}};u([d({type:["selection"]})],m4.prototype,"type",void 0),m4=gW=u([R("esri.layers.support.FeatureReductionSelection")],m4);const yW=m4,rle={key:"type",base:c0,typeMap:{cluster:v2e,binning:_2e}},pJe={types:{key:"type",base:c0,typeMap:{selection:yW,cluster:v2e,binning:_2e}},json:{name:"layerDefinition.featureReduction",write:{allowNull:!0},origins:{"web-map":{types:rle},"portal-item":{types:rle},"web-scene":{types:{key:"type",base:c0,typeMap:{selection:yW}}}}}},CS={Base64:0,Hex:1,String:2,Raw:3},RC=8,b2e=(1<<RC)-1;function h1(t,e){const r=(65535&t)+(65535&e);return(t>>16)+(e>>16)+(r>>16)<<16|65535&r}function fJe(t){const e=[];for(let r=0,i=t.length*RC;r<i;r+=RC)e[r>>5]|=(t.charCodeAt(r/RC)&b2e)<<r%32;return e}function mJe(t){const e=[];for(let r=0,i=32*t.length;r<i;r+=RC)e.push(String.fromCharCode(t[r>>5]>>>r%32&b2e));return e.join("")}function gJe(t){const e="0123456789abcdef",r=[];for(let i=0,s=4*t.length;i<s;i++)r.push(e.charAt(t[i>>2]>>i%4*8+4&15)+e.charAt(t[i>>2]>>i%4*8&15));return r.join("")}function yJe(t){const e="=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",i=[];for(let s=0,n=4*t.length;s<n;s+=3){const o=(t[s>>2]>>s%4*8&255)<<16|(t[s+1>>2]>>(s+1)%4*8&255)<<8|t[s+2>>2]>>(s+2)%4*8&255;for(let a=0;a<4;a++)8*s+6*a>32*t.length?i.push(e):i.push(r.charAt(o>>6*(3-a)&63))}return i.join("")}function _Je(t,e){return t<<e|t>>>32-e}function AV(t,e,r,i,s,n){return h1(_Je(h1(h1(e,t),h1(i,n)),s),r)}function cl(t,e,r,i,s,n,o){return AV(e&r|~e&i,t,e,s,n,o)}function ul(t,e,r,i,s,n,o){return AV(e&i|r&~i,t,e,s,n,o)}function hl(t,e,r,i,s,n,o){return AV(e^r^i,t,e,s,n,o)}function dl(t,e,r,i,s,n,o){return AV(r^(e|~i),t,e,s,n,o)}function vJe(t,e){t[e>>5]|=128<<e%32,t[14+(e+64>>>9<<4)]=e;let r=1732584193,i=-271733879,s=-1732584194,n=271733878;for(let o=0;o<t.length;o+=16){const a=r,l=i,c=s,h=n;r=cl(r,i,s,n,t[o],7,-680876936),n=cl(n,r,i,s,t[o+1],12,-389564586),s=cl(s,n,r,i,t[o+2],17,606105819),i=cl(i,s,n,r,t[o+3],22,-1044525330),r=cl(r,i,s,n,t[o+4],7,-176418897),n=cl(n,r,i,s,t[o+5],12,1200080426),s=cl(s,n,r,i,t[o+6],17,-1473231341),i=cl(i,s,n,r,t[o+7],22,-45705983),r=cl(r,i,s,n,t[o+8],7,1770035416),n=cl(n,r,i,s,t[o+9],12,-1958414417),s=cl(s,n,r,i,t[o+10],17,-42063),i=cl(i,s,n,r,t[o+11],22,-1990404162),r=cl(r,i,s,n,t[o+12],7,1804603682),n=cl(n,r,i,s,t[o+13],12,-40341101),s=cl(s,n,r,i,t[o+14],17,-1502002290),i=cl(i,s,n,r,t[o+15],22,1236535329),r=ul(r,i,s,n,t[o+1],5,-165796510),n=ul(n,r,i,s,t[o+6],9,-1069501632),s=ul(s,n,r,i,t[o+11],14,643717713),i=ul(i,s,n,r,t[o],20,-373897302),r=ul(r,i,s,n,t[o+5],5,-701558691),n=ul(n,r,i,s,t[o+10],9,38016083),s=ul(s,n,r,i,t[o+15],14,-660478335),i=ul(i,s,n,r,t[o+4],20,-405537848),r=ul(r,i,s,n,t[o+9],5,568446438),n=ul(n,r,i,s,t[o+14],9,-1019803690),s=ul(s,n,r,i,t[o+3],14,-187363961),i=ul(i,s,n,r,t[o+8],20,1163531501),r=ul(r,i,s,n,t[o+13],5,-1444681467),n=ul(n,r,i,s,t[o+2],9,-51403784),s=ul(s,n,r,i,t[o+7],14,1735328473),i=ul(i,s,n,r,t[o+12],20,-1926607734),r=hl(r,i,s,n,t[o+5],4,-378558),n=hl(n,r,i,s,t[o+8],11,-2022574463),s=hl(s,n,r,i,t[o+11],16,1839030562),i=hl(i,s,n,r,t[o+14],23,-35309556),r=hl(r,i,s,n,t[o+1],4,-1530992060),n=hl(n,r,i,s,t[o+4],11,1272893353),s=hl(s,n,r,i,t[o+7],16,-155497632),i=hl(i,s,n,r,t[o+10],23,-1094730640),r=hl(r,i,s,n,t[o+13],4,681279174),n=hl(n,r,i,s,t[o],11,-358537222),s=hl(s,n,r,i,t[o+3],16,-722521979),i=hl(i,s,n,r,t[o+6],23,76029189),r=hl(r,i,s,n,t[o+9],4,-640364487),n=hl(n,r,i,s,t[o+12],11,-421815835),s=hl(s,n,r,i,t[o+15],16,530742520),i=hl(i,s,n,r,t[o+2],23,-995338651),r=dl(r,i,s,n,t[o],6,-198630844),n=dl(n,r,i,s,t[o+7],10,1126891415),s=dl(s,n,r,i,t[o+14],15,-1416354905),i=dl(i,s,n,r,t[o+5],21,-57434055),r=dl(r,i,s,n,t[o+12],6,1700485571),n=dl(n,r,i,s,t[o+3],10,-1894986606),s=dl(s,n,r,i,t[o+10],15,-1051523),i=dl(i,s,n,r,t[o+1],21,-2054922799),r=dl(r,i,s,n,t[o+8],6,1873313359),n=dl(n,r,i,s,t[o+15],10,-30611744),s=dl(s,n,r,i,t[o+6],15,-1560198380),i=dl(i,s,n,r,t[o+13],21,1309151649),r=dl(r,i,s,n,t[o+4],6,-145523070),n=dl(n,r,i,s,t[o+11],10,-1120210379),s=dl(s,n,r,i,t[o+2],15,718787259),i=dl(i,s,n,r,t[o+9],21,-343485551),r=h1(r,a),i=h1(i,l),s=h1(s,c),n=h1(n,h)}return[r,i,s,n]}function w2e(t,e=CS.Hex){const r=e||CS.Base64,i=vJe(fJe(t),t.length*RC);switch(r){case CS.Raw:return i;case CS.Hex:return gJe(i);case CS.String:return mJe(i);case CS.Base64:return yJe(i)}}var _W;let $3=_W=class extends pV{writeLevels(t,e,r){for(const i in t){const s=this.levels[i];return void(e.stops=s)}}clone(){return new _W({axis:this.axis,field:this.field,valueExpression:this.valueExpression,valueExpressionTitle:this.valueExpressionTitle,maxDataValue:this.maxDataValue,maxSize:u1(this.maxSize)?this.maxSize.clone():this.maxSize,minDataValue:this.minDataValue,minSize:u1(this.minSize)?this.minSize.clone():this.minSize,normalizationField:this.normalizationField,stops:this.stops&&this.stops.map(t=>t.clone()),target:this.target,useSymbolValue:this.useSymbolValue,valueRepresentation:this.valueRepresentation,valueUnit:this.valueUnit,legendOptions:this.legendOptions&&this.legendOptions.clone(),levels:re(this.levels)})}};u([d()],$3.prototype,"levels",void 0),u([Ve("levels")],$3.prototype,"writeLevels",null),$3=_W=u([R("esri.views.2d.engine.LevelDependentSizeVariable")],$3);const bJe=K.getLogger("esri.views.2d.layers.support.clusterUtils");le.add("esri-cluster-arcade-enabled",!0);const wJe=le("esri-cluster-arcade-enabled"),xJe=(t,e,r,i,s)=>{const n=e.clone();if(!CJe(n))return n;if(n.authoringInfo||(n.authoringInfo=new kK),n.authoringInfo.isAutoGenerated=!0,"visualVariables"in n){const o=(n.visualVariables||[]).filter(l=>l.valueExpression!=="$view.scale"),a=TJe(o);o.forEach(l=>{l.type==="rotation"?l.field?l.field=Ob(t,l.field,"avg_angle","number"):l.valueExpression&&(l.field=YO(t,l.valueExpression,"avg_angle","number"),l.valueExpression=null):l.normalizationField?(l.field=Ob(t,l.field,"avg_norm","number",l.normalizationField),l.normalizationField=null):l.field?l.field=Ob(t,l.field,"avg","number"):l.valueExpression&&(l.field=YO(t,l.valueExpression,"avg","number"),l.valueExpression=null)}),a==null&&!SJe(o)&&s&&(o.push(EJe(r,i)),n.dynamicClusterSize=!0),n.visualVariables=o}switch(n.type){case"simple":break;case"pie-chart":for(const o of n.attributes)o.field?o.field=Ob(t,o.field,"sum","number"):o.valueExpression&&(o.field=YO(t,o.valueExpression,"sum","number"),o.valueExpression=null);break;case"unique-value":n.field?n.field=Ob(t,n.field,"mode","string"):n.valueExpression&&(n.field=YO(t,n.valueExpression,"mode","string"),n.valueExpression=null);break;case"class-breaks":n.normalizationField?(n.field=Ob(t,n.field,"avg_norm","number",n.normalizationField),n.normalizationField=null):n.field?n.field=Ob(t,n.field,"avg","number"):n.valueExpression&&(n.field=YO(t,n.valueExpression,"avg","number"),n.valueExpression=null)}return n},TJe=t=>{for(const e of t)if(e.type==="size")return e;return null},SJe=t=>{for(const e of t)if(e.field==="cluster_count")return!0;return!1},EJe=(t,e)=>{const r=[new rE({value:0,size:0}),new rE({value:1})];if(e==null)return new pV({field:"cluster_count",stops:[...r,new rE({value:2,size:0})]});const i=Object.keys(e).reduce((s,n)=>({...s,[n]:[...r,new rE({value:Math.max(2,e[n].minValue),size:t.clusterMinSize}),new rE({value:Math.max(3,e[n].maxValue),size:t.clusterMaxSize})]}),{});return new $3({field:"cluster_count",levels:i})},CJe=t=>{const e=r=>bJe.error(new D("Unsupported-renderer",r,{renderer:t}));if(!t)return!1;switch(t.type){case"unique-value":if(t.field2||t.field3)return e("FeatureReductionCluster does not support multi-field UniqueValueRenderers"),!1;break;case"class-breaks":if(t.normalizationField){const r=t.normalizationType;if(r!=="field")return e(`FeatureReductionCluster does not support a normalizationType of ${r}`),!1}break;case"simple":case"pie-chart":break;default:return e(`FeatureReductionCluster does not support renderers of type ${t.type}`),!1}if(!wJe){if("valueExpression"in t&&t.valueExpression)return e("FeatureReductionCluster does not currently support renderer.valueExpression. Support will be added in a future release"),!1;if(("visualVariables"in t&&t.visualVariables||[]).some(r=>!(!("valueExpression"in r)||!r.valueExpression)))return e("FeatureReductionCluster does not currently support visualVariables with a valueExpression. Support will be added in a future release"),!1}return!0};function AJe(t,e,r){switch(t){case"sum":return`cluster_sum_${e}`;case"avg":case"avg_angle":return`cluster_avg_${e}`;case"mode":return`cluster_type_${e}`;case"avg_norm":{const i=r,s="field",n=e.toLowerCase()+",norm:"+s+","+i.toLowerCase();return"cluster_avg_"+w2e(n)}}}function YO(t,e,r,i){const s=w2e(e),n=r==="mode"?`cluster_type_${s}`:r==="sum"?`cluster_sum_${s}`:`cluster_avg_${s}`;return t.some(o=>o.name===n)||t.push(new NT({name:n,isAutoGenerated:!0,onStatisticExpression:new lee({expression:e,returnType:i}),statisticType:r})),n}function Ob(t,e,r,i,s){if(e==="cluster_count"||t.some(o=>o.name===e))return e;const n=AJe(r,e,s);return t.some(o=>o.name===n)||(r==="avg_norm"?t.push(new NT({name:n,isAutoGenerated:!0,onStatisticExpression:new lee({expression:`$feature.${e} / $feature.${s}`,returnType:i}),statisticType:"avg"})):t.push(new NT({name:n,isAutoGenerated:!0,onStatisticField:e,statisticType:r}))),n}const OJe=t=>{let e=class extends t{constructor(...r){super(...r),this.own(this.watch("renderer",()=>{if(this.featureReduction){const i=this._normalizeFeatureReduction(this.featureReduction);this._set("featureReduction",i)}},!0))}set featureReduction(r){const i=this._normalizeFeatureReduction(r);this._set("featureReduction",i)}set renderer(r){}_normalizeFeatureReduction(r){if(r?.type!=="cluster")return r;const i=r.clone(),s=[new NT({name:"cluster_count",isAutoGenerated:!0,statisticType:"count"})],n=(i.fields??[]).filter(a=>!a.isAutoGenerated);if(r.renderer&&!r.renderer.authoringInfo?.isAutoGenerated)return i.fields=[...s,...n],i;if(r.symbol)return i.fields=[...s,...n],i.renderer=null,i;if(!this.renderer)return r;const o=xJe(s,this.renderer,r,null,!1);return i.fields=[...s,...n],i.renderer=o,i}};return u([d(pJe)],e.prototype,"featureReduction",null),e=u([R("esri.layers.mixins.FeatureReductionLayer")],e),e},ile={ArcGISAnnotationLayer:!0,ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISStreamLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BingMapsAerial:!0,BingMapsHybrid:!0,BingMapsRoad:!0,CSV:!0,GeoRSS:!0,GeoJSON:!0,GroupLayer:!0,KML:!0,MediaLayer:!0,OGCFeatureLayer:!0,OrientedImageryLayer:!0,SubtypeGroupLayer:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,WebTiledLayer:!0},sle={ArcGISImageServiceLayer:!0,ArcGISImageServiceVectorLayer:!0,ArcGISMapServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,WMS:!0,WebTiledLayer:!0,BingMapsAerial:!0,BingMapsRoad:!0,BingMapsHybrid:!0},nle={ArcGISFeatureLayer:!0},RJe={"web-scene/operational-layers":{ArcGISDimensionLayer:!0,ArcGISFeatureLayer:!0,ArcGISImageServiceLayer:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0,ArcGISTiledElevationServiceLayer:!0,ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,BuildingSceneLayer:!0,GroupLayer:!0,IntegratedMeshLayer:!0,OGCFeatureLayer:!0,PointCloudLayer:!0,WebTiledLayer:!0,CSV:!0,GeoJSON:!0,VectorTileLayer:!0,WFS:!0,WMS:!0,KML:!0,RasterDataLayer:!0,Voxel:!0,LineOfSightLayer:!0},"web-scene/basemap":{ArcGISTiledImageServiceLayer:!0,ArcGISTiledMapServiceLayer:!0,WebTiledLayer:!0,OpenStreetMap:!0,VectorTileLayer:!0,ArcGISImageServiceLayer:!0,WMS:!0,ArcGISMapServiceLayer:!0,ArcGISSceneServiceLayer:!0},"web-scene/ground":{ArcGISTiledElevationServiceLayer:!0,RasterDataElevationLayer:!0},"web-map/operational-layers":ile,"web-map/basemap":sle,"web-map/tables":nle,"link-chart/operational-layers":{...ile,LinkChartLayer:!0},"link-chart/basemap":sle,"link-chart/tables":nle,"portal-item/operational-layers":{ArcGISFeatureLayer:!0,ArcGISSceneServiceLayer:!0,PointCloudLayer:!0,BuildingSceneLayer:!0,IntegratedMeshLayer:!0,OrientedImageryLayer:!0}},x2e=t=>{let e=class extends t{constructor(){super(...arguments),this.title=null}writeListMode(r,i,s,n){(n&&n.layerContainerType==="ground"||r&&UVe(this,s,{},n))&&(i[s]=r)}writeOperationalLayerType(r,i,s,n){!r||n&&n.layerContainerType==="tables"||(i.layerType=r)}writeTitle(r,i){i.title=r??"Layer"}read(r,i){i&&(i.layer=this),NVe(this,r,s=>super.read(r,s),i)}write(r,i){if(i?.origin){const o=`${i.origin}/${i.layerContainerType||"operational-layers"}`;let l=!!RJe[o]?.[this.operationalLayerType];if(this.operationalLayerType==="ArcGISTiledElevationServiceLayer"&&o==="web-scene/operational-layers"&&(l=!1),this.operationalLayerType==="ArcGISDimensionLayer"&&o==="web-map/operational-layers"&&(l=!1),!l)return i.messages?.push(new D("layer:unsupported",`Layers (${this.title}, ${this.id}) of type '${this.declaredClass}' are not supported in the context of '${o}'`,{layer:this})),null}const s=super.write(r,{...i,layer:this}),n=!!i&&!!i.messages&&!!i.messages.filter(o=>o instanceof D&&o.name==="web-document-write:property-required").length;return $1(s?.url)?(i?.messages?.push(new D("layer:invalid-url",`Layer (${this.title}, ${this.id}) of type '${this.declaredClass}' using a Blob URL cannot be written to web scenes and web maps`,{layer:this})),null):!this.url&&n?null:s}beforeSave(){}};return u([d({type:String,json:{write:{ignoreOrigin:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0}},"portal-item":{write:!1}}}})],e.prototype,"id",void 0),u([d(l2e)],e.prototype,"listMode",void 0),u([Ve("listMode")],e.prototype,"writeListMode",null),u([d({type:String,readOnly:!0,json:{read:!1,write:{target:"layerType",ignoreOrigin:!0},origins:{"portal-item":{write:!1}}}})],e.prototype,"operationalLayerType",void 0),u([Ve("operationalLayerType")],e.prototype,"writeOperationalLayerType",null),u([d(oW)],e.prototype,"opacity",void 0),u([d({type:String,json:{write:{ignoreOrigin:!0,writerEnsuresNonNull:!0},origins:{"web-scene":{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}},"portal-item":{write:!1}}},value:"Layer"})],e.prototype,"title",void 0),u([Ve("title"),Ve(["web-scene"],"title")],e.prototype,"writeTitle",null),u([d({type:Boolean,json:{name:"visibility"}})],e.prototype,"visible",void 0),e=u([R("esri.layers.mixins.OperationalLayer")],e),e};var vW;const ez=new kr({asc:"ascending",desc:"descending"});let hE=vW=class extends he{constructor(t){super(t),this.field=null,this.valueExpression=null,this.order="ascending"}clone(){return new vW({field:this.field,valueExpression:this.valueExpression,order:this.order})}};u([d({type:String,json:{write:!0}})],hE.prototype,"field",void 0),u([d({type:String,json:{write:!0}})],hE.prototype,"valueExpression",void 0),u([d({type:ez.apiValues,json:{read:ez.read,write:ez.write}})],hE.prototype,"order",void 0),hE=vW=u([R("esri.layers.support.OrderByInfo")],hE);const T2e=hE;function MJe(t,e,r){if(!t)return null;const i=t.find(n=>!!n.field);if(!i)return null;const s=new T2e;return s.read(i,r),[s]}function IJe(t,e,r,i){const s=t.find(n=>!!n.field);s&&Ul(r,[s.toJSON()],e)}const PJe=t=>{let e=class extends t{constructor(){super(...arguments),this.orderBy=null}};return u([d({type:[T2e],json:{origins:{"web-scene":{write:!1,read:!1}},read:{source:"layerDefinition.orderBy",reader:MJe},write:{target:"layerDefinition.orderBy",writer:IJe}}})],e.prototype,"orderBy",void 0),e=u([R("esri.layers.mixins.OrderedLayer")],e),e};function OV(t,e,r){return Oh(t.map((i,s)=>e.apply(r,[i,s])))}async function $Je(t,e,r){return(await Oh(t.map((i,s)=>e.apply(r,[i,s])))).map(i=>i.value)}function dee(t){return{ok:!0,value:t}}function pee(t){return{ok:!1,error:t}}function LJe(t){return t!=null&&t.ok===!0?t.value:null}function DJe(t){return t!=null&&t.ok===!1?t.error:null}async function Sh(t){if(t==null)return{ok:!1,error:new Error("no promise provided")};try{return dee(await t)}catch(e){return pee(e)}}async function ykt(t){try{return dee(await t)}catch(e){return xa(e),pee(e)}}function _kt(t){if(t.ok===!0)return t.value;throw t.error}function hb(t,e){return new nv(t,e)}let nv=class extends me{get value(){return LJe(this._result)}get error(){return DJe(this._result)}get finished(){return this._result!=null}constructor(e,r){super({}),this._result=null,this._abortHandle=null,this.abort=()=>{this._abortController=Do(this._abortController)},this.remove=this.abort,this._abortController=new AbortController;const{signal:i}=this._abortController;this.promise=e(i),this.promise.then(s=>{this._result=dee(s),this._cleanup()},s=>{this._result=pee(s),this._cleanup()}),this._abortHandle=xn(r,this.abort)}normalizeCtorArgs(){return{}}destroy(){this.abort()}_cleanup(){this._abortHandle=Pi(this._abortHandle),this._abortController=null}};u([d()],nv.prototype,"value",null),u([d()],nv.prototype,"error",null),u([d()],nv.prototype,"finished",null),u([d()],nv.prototype,"promise",void 0),u([d()],nv.prototype,"_result",void 0),nv=u([R("esri.core.asyncUtils.ReactiveTask")],nv);let Sy=class extends me{constructor(e){super(e),this.portalItem=null}normalizeCtorArgs(e){return e&&e.portalItem&&e.path?{...e,path:this._normalizePath(e.path,e.portalItem)}:e}set path(e){e!=null&&wu(e)?K.getLogger(this).error("portalitemresource:invalid-path","A portal item resource path must be relative"):this._set("path",e)}_castPath(e){return this._normalizePath(e,this.portalItem)}get url(){return this.portalItem&&this.path?`${this.portalItem.itemUrl}/resources/${this.path}`:null}get cdnUrl(){return this.portalItem&&this.path?`${this.portalItem.itemCdnUrl}/resources/${this.path}`:null}get itemRelativeUrl(){return this.portalItem&&this.path?`./resources/${this.path}`:null}fetch(e="json",r){const i=this.cdnUrl;if(i==null)throw new D("portal-item-resource:fetch","Portal item resource does not refer to a valid item or path");return this.portalItem.portal.request(i,{responseType:e,query:{token:this.portalItem.apiKey},signal:r?.signal})}async update(e,r){const{addOrUpdateResource:i}=await J(()=>Promise.resolve().then(()=>j3),void 0,import.meta.url);return i(this,"update",e,r)}hasPath(){return this.path!=null}_normalizePath(e,r){return e==null?e:(e=e.replace(/^\/+/,""),r!=null&&wu(e)&&(e=XJ(e,r.itemUrl)),e?.replace(/^\/+/,"").replace(/^(\.\/)?resources\//,""))}};u([d()],Sy.prototype,"portalItem",void 0),u([d({type:String,value:null})],Sy.prototype,"path",null),u([or("path")],Sy.prototype,"_castPath",null),u([d({type:String,readOnly:!0})],Sy.prototype,"url",null),u([d({type:String,readOnly:!0})],Sy.prototype,"cdnUrl",null),u([d({type:String,readOnly:!0})],Sy.prototype,"itemRelativeUrl",null),Sy=u([R("esri.portal.PortalItemResource")],Sy);const NJe=Sy;let L3=class extends me{constructor(e){super(e),this.created=null,this.rating=null}};u([d()],L3.prototype,"created",void 0),u([d()],L3.prototype,"rating",void 0),L3=u([R("esri.portal.PortalRating")],L3);const tz=L3;var zw;const FJe=new Set(["Map Service","Feature Service","Feature Collection","Scene Service","Image Service","Stream Service","Vector Tile Service","GeoJson","CSV","KML","WFS","WMTS","WMS","Feed"]),kJe=new Set(["KML","GeoJson","CSV"]);let dr=zw=class extends iS(_g){static from(t){return bT(zw,t)}constructor(t){super(t),this.access=null,this.accessInformation=null,this.apiKey=null,this.applicationProxies=null,this.avgRating=null,this.categories=null,this.created=null,this.culture=null,this.description=null,this.extent=null,this.groupCategories=null,this.id=null,this.isOrgItem=!1,this.itemControl=null,this.licenseInfo=null,this.modified=null,this.name=null,this.numComments=null,this.numRatings=null,this.numViews=null,this.owner=null,this.ownerFolder=null,this.portal=null,this.screenshots=null,this.size=null,this.snippet=null,this.sourceJSON=null,this.sourceUrl=null,this.spatialReference=null,this.tags=null,this.title=null,this.type=null,this.typeKeywords=null,this.url=null}destroy(){this.portal=null}get displayName(){const t=this.type,e=this.typeKeywords||[];let r=t;return t==="Feature Service"||t==="Feature Collection"?r=e.includes("Table")?"Table":e.includes("Route Layer")?"Route Layer":e.includes("Markup")?"Markup":"Feature Layer":t==="Image Service"?r=e.includes("Elevation 3D Layer")?"Elevation Layer":e.includes("Tiled Imagery")?"Tiled Imagery Layer":"Imagery Layer":t==="Scene Service"?r="Scene Layer":t==="Video Service"?r="Video Layer":t==="Scene Package"?r="Scene Layer Package":t==="Stream Service"?r="Feature Layer":t==="Geoprocessing Service"?r=e.includes("Web Tool")?"Tool":"Geoprocessing Service":t==="Geocoding Service"?r="Locator":t==="Geoenrichment Service"?r="GeoEnrichment Service":t==="Microsoft Powerpoint"?r="Microsoft PowerPoint":t==="GeoJson"?r="GeoJSON":t==="Globe Service"?r="Globe Layer":t==="Vector Tile Service"?r="Tile Layer":t==="netCDF"?r="NetCDF":t==="Map Service"?r=e.includes("Spatiotemporal")||!e.includes("Hosted Service")&&!e.includes("Tiled")||e.includes("Relational")?"Map Image Layer":"Tile Layer":t&&t.toLowerCase().includes("add in")?r=t.replaceAll(/(add in)/gi,"Add-In"):t==="datastore catalog service"?r="Big Data File Share":t==="Compact Tile Package"?r="Tile Package (tpkx)":t==="OGCFeatureServer"?r="OGC Feature Layer":t==="web mapping application"&&e.includes("configurableApp")?r="Instant App":t==="Insights Page"?r="Insights Report":t==="Excalibur Imagery Project"&&(r="Excalibur Project"),r}readExtent(t){return t&&t.length?new vr(t[0][0],t[0][1],t[1][0],t[1][1]):null}get iconUrl(){const t=this.type&&this.type.toLowerCase()||"",e=this.typeKeywords||[],r="esri/images/portal/",i="16";let s,n=!1,o=!1,a=!1,l=!1,c=!1,h=!1;return t.indexOf("service")>0||t==="feature collection"||t==="kml"||t==="wms"||t==="wmts"||t==="wfs"?(n=e.includes("Hosted Service"),t==="feature service"||t==="feature collection"||t==="kml"||t==="wfs"?(o=e.includes("Table"),a=e.includes("Route Layer"),l=e.includes("Markup"),c=e.includes("Spatiotemporal"),h=e.includes("UtilityNetwork"),s=c&&o?"spatiotemporaltable":o?"table":a?"routelayer":l?"markup":c?"spatiotemporal":n?"featureshosted":h?"utilitynetwork":"features"):s=t==="map service"||t==="wms"||t==="wmts"?n||e.includes("Tiled")||t==="wmts"?"maptiles":"mapimages":t==="scene service"?e.includes("Line")?"sceneweblayerline":e.includes("3DObject")?"sceneweblayermultipatch":e.includes("Point")?"sceneweblayerpoint":e.includes("IntegratedMesh")?"sceneweblayermesh":e.includes("PointCloud")?"sceneweblayerpointcloud":e.includes("Polygon")?"sceneweblayerpolygon":e.includes("Building")?"sceneweblayerbuilding":e.includes("Voxel")?"sceneweblayervoxel":"sceneweblayer":t==="image service"?e.includes("Elevation 3D Layer")?"elevationlayer":e.includes("Tiled Imagery")?"tiledimagerylayer":"imagery":t==="stream service"?"streamlayer":t==="video service"?e.includes("Live Stream")?"livestreamvideolayer":"videolayer":t==="vector tile service"?"vectortile":t==="datastore catalog service"?"datastorecollection":t==="geocoding service"?"geocodeservice":t==="geoprocessing service"?e.includes("Web Tool")?"tool":"layers":t==="geodata service"?"geodataservice":"layers"):s=t==="web map"||t==="cityengine web scene"?"maps":t==="web scene"?e.includes("ViewingMode-Local")?"webscenelocal":"websceneglobal":t==="web mapping application"&&e.includes("configurableApp")?"instantapps":t==="web mapping application"||t==="mobile application"||t==="application"||t==="operation view"||t==="desktop application"?"apps":t==="map document"||t==="map package"||t==="published map"||t==="scene document"||t==="globe document"||t==="basemap package"||t==="mobile basemap package"||t==="mobile map package"||t==="project package"||t==="project template"||t==="pro map"||t==="layout"||t==="layer"&&e.includes("ArcGIS Pro")||t==="explorer map"&&e.indexOf("Explorer Document")?"mapsgray":t==="service definition"||t==="csv"||t==="shapefile"||t==="cad drawing"||t==="geojson"||t==="netcdf"||t==="administrative report"?"datafiles":t==="explorer add in"||t==="desktop add in"||t==="windows viewer add in"||t==="windows viewer configuration"?"appsgray":t==="360 vr experience"?"360vr":t==="arcgis pro add in"||t==="arcgis pro configuration"?"addindesktop":t==="rule package"||t==="file geodatabase"||t==="sqlite geodatabase"||t==="csv collection"||t==="kml collection"||t==="windows mobile package"||t==="map template"||t==="desktop application template"||t==="gml"||t==="arcpad package"||t==="code sample"||t==="form"||t==="document link"||t==="earth configuration"||t==="operations dashboard add in"||t==="rules package"||t==="image"||t==="workflow manager package"||t==="explorer map"&&e.includes("Explorer Mapping Application")||e.includes("Document")?"datafilesgray":t==="network analysis service"||t==="geoprocessing service"||t==="geodata service"||t==="geometry service"||t==="geoprocessing package"||t==="locator package"||t==="geoprocessing sample"||t==="workflow manager service"?"toolsgray":t==="layer"||t==="layer package"||t==="explorer layer"?"layersgray":t==="scene package"?"scenepackage":t==="mobile scene package"?"mobilescenepackage":t==="tile package"||t==="compact tile package"?"tilepackage":t==="task file"?"taskfile":t==="report template"?"report-template":t==="statistical data collection"?"statisticaldatacollection":t==="insights workbook"?"workbook":t==="insights model"?"insightsmodel":t==="insights page"?"insightspage":t==="insights theme"?"insightstheme":t==="hub initiative"?"hubinitiative":t==="hubpage"?"hubpage":t==="hub event"?"hubevent":t==="hub site application"?"hubsite":t==="hub project"?"hubproject":t==="relational database connection"?"relationaldatabaseconnection":t==="big data file share"?"datastorecollection":t==="image collection"?"imagecollection":t==="style"?"style":t==="desktop style"?"desktopstyle":t==="dashboard"?"dashboard":t==="raster function template"?"rasterprocessingtemplate":t==="vector tile package"?"vectortilepackage":t==="ortho mapping project"?"orthomappingproject":t==="ortho mapping template"?"orthomappingtemplate":t==="solution"?"solutions":t==="geopackage"?"geopackage":t==="deep learning package"?"deeplearningpackage":t==="real time analytic"?"realtimeanalytics":t==="big data analytic"?"bigdataanalytics":t==="feed"?"feed":t==="excalibur imagery project"?"excaliburimageryproject":t==="notebook"?"notebook":t==="storymap"?"storymap":t==="survey123 add in"?"survey123addin":t==="mission"?"mission":t==="mission report"?"missionreport":t==="quickcapture project"?"quickcaptureproject":t==="pro report"?"proreport":t==="pro report template"?"proreporttemplate":t==="urban model"?"urbanmodel":t==="web experience"?"experiencebuilder":t==="web experience template"?"webexperiencetemplate":t==="experience builder widget"?"experiencebuilderwidget":t==="experience builder widget package"?"experiencebuilderwidgetpackage":t==="workflow"?"workflow":t==="insights script"?"insightsscript":t==="kernel gateway connection"?"kernelgatewayconnection":t==="hub initiative template"?"hubinitiativetemplate":t==="storymap theme"?"storymaptheme":t==="knowledge graph"?"knowledgegraph":t==="native application"?"nativeapp":t==="native application installer"?"nativeappinstaller":t==="link chart"?"linkchart":t==="investigation"?"investigation":t==="ogcfeatureserver"?"features":t==="pro project"?"proproject":t==="insights workbook package"?"insightsworkbookpackage":t==="apache parquet"?"apacheparquet":t==="notebook code snippets"||t==="notebook code snippet library"?"notebookcodesnippets":t==="suitability model"?"suitabilitymodel":t==="esri classifier definition"?"classifierdefinition":t==="esri classification schema"?"classificationschema":t==="insights data engineering workbook"?"dataengineeringworkbook":t==="insights data engineering model"?"dataengineeringmodel":t==="deep learning studio project"?"deeplearningproject":t==="discussion"?"discussion":t==="allsource project"?"allsourceproject":t==="api key"?"apikey":t==="data pipeline"?"datapipelines":"maps",s?Dr(r+s+i+".png"):null}get isLayer(){return this.type!=null&&FJe.has(this.type)}get itemCdnUrl(){let t=this.itemUrl;return t&&Gt&&!Gt.findCredential(t)&&(t=Gt._normalizeAGOLorgDomain(t),t=t.replace(/^https?:\/\/www\.arcgis\.com/,"https://cdn.arcgis.com"),t=t.replace(/^https?:\/\/devext\.arcgis\.com/,"https://cdndev.arcgis.com"),t=t.replace(/^https?:\/\/qaext\.arcgis\.com/,"https://cdnqa.arcgis.com")),t}get itemPageUrl(){const t=this.portal?.itemPageUrl;return t&&this.id?`${t}?id=${this.id}`:null}get itemUrl(){const t=this.portal?.restUrl;return t&&this.id?`${t}/content/items/${this.id}`:null}get thumbnailUrl(){const t=this.itemUrl,e=this.thumbnail;return t&&e?this.portal?.normalizeUrl(`${t}/info/${e}?f=json`)??null:null}get userItemUrl(){const t=this.get("portal.restUrl");if(!t)return null;const e=this.owner||this.get("portal.user.username");return e?`${t}/content/users/${this.ownerFolder?`${e}/${this.ownerFolder}`:e}/items/${this.id}`:null}load(t){const e=this.portal??(this.portal=ao.getDefault()),r=e.load(t).then(()=>this.sourceJSON?this.sourceJSON:this.id&&this.itemUrl?e.request(this.itemUrl,{signal:t!=null?t.signal:null,query:{token:this.apiKey}}):{}).then(i=>{this.sourceJSON=i,this.read(i)});return this.addResolvingPromise(r),Promise.resolve(this)}async addRating(t){const e={method:"post",query:{}};return t instanceof tz&&(t=t.rating),t==null||isNaN(t)||typeof t!="number"||(e.query.rating=t),this.portal?(await this.portal.request(this.itemUrl+"/addRating",e),new tz({rating:t,created:new Date})):null}clone(){const t={access:this.access,accessInformation:this.accessInformation,applicationProxies:re(this.applicationProxies),avgRating:this.avgRating,categories:re(this.categories),created:re(this.created),culture:this.culture,description:this.description,extent:re(this.extent),groupCategories:re(this.groupCategories),id:this.id,itemControl:this.itemControl,licenseInfo:this.licenseInfo,modified:re(this.modified),name:this.name,numComments:this.numComments,numRatings:this.numRatings,numViews:this.numViews,owner:this.owner,ownerFolder:this.ownerFolder,portal:this.portal,screenshots:re(this.screenshots),size:this.size,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:re(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:re(this.typeKeywords),url:this.url};this.loaded&&(t.loadStatus="loaded");const e=new zw({sourceJSON:this.sourceJSON}).set(t);return e._set("isOrgItem",this.isOrgItem),e}createPostQuery(){const t=this.toJSON();for(const r of["tags","typeKeywords","categories"])t[r]=t[r]?.join(", ");const{extent:e}=t;return e&&(t.extent=JSON.stringify(e)),t}async deleteRating(){await Ha(this.portal).request(this.itemUrl+"/deleteRating",{method:"post"})}fetchData(t="json",e){return Ha(this.portal).request(this.itemUrl+"/data",{responseType:t,...e,query:{token:this.apiKey}})}async fetchRating(t){const e=await Ha(this.portal).request(this.itemUrl+"/rating",{query:{token:this.apiKey},...t});return e.rating!=null?(e.created=new Date(e.created),new tz(e)):null}fetchRelatedItems(t,e){return Ha(this.portal).requestToTypedArray(this.itemUrl+"/relatedItems",{query:{...t,token:this.apiKey},...e},zw)}getThumbnailUrl(t){let e=this.thumbnailUrl;return e&&t&&(e+=`&w=${t}`),e}reload(){return Ha(this.portal).request(this.itemUrl??"",{cacheBust:!0,query:{token:this.apiKey}}).then(t=>(this.sourceJSON=t,this.read(t),this))}update(t){return this.id?this.load().then(()=>Ha(this.portal).signIn()).then(()=>{const e=t&&t.data,r={method:"post"};r.query=this.createPostQuery();for(const i in r.query)r.query[i]===null&&(r.query[i]="");return r.query.clearEmptyFields=!0,e!=null&&(typeof e=="string"?r.query.text=e:typeof e=="object"&&(r.query.text=JSON.stringify(e))),this.portal.request(`${this.userItemUrl}/update`,r).then(()=>this.reload())}):Promise.reject(new D("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async copy(t){if(!this.id)throw new D("portal:item-does-not-exist","The item does not exist yet");await this.load();const{portal:e,itemUrl:r}=this;await Ha(e).signIn();const{copyResources:i,folder:s,tags:n,title:o}=t||{},a={method:"post",query:{copyPrivateResources:i==="all",folder:typeof s=="string"?s:s?.id,includeResources:!!i,tags:n?.join(","),title:o}},{itemId:l}=await e.request(`${r}/copy`,a);return new zw({id:l,portal:e})}updateThumbnail(t){return this.id?this.load().then(()=>this.portal.signIn()).then(()=>{const e=t.thumbnail,r=t.filename,i={method:"post"};if(typeof e=="string")Ig(e)?i.query={data:e}:i.query={url:pc(e)},r!=null&&(i.query.filename=r);else{const s=new FormData;r!=null?s.append("file",e,r):s.append("file",e),i.body=s}return this.portal.request(`${this.userItemUrl}/updateThumbnail`,i).then(()=>this.reload())}):Promise.reject(new D("portal:item-does-not-exist","The item does not exist yet and cannot be updated"))}async fetchResources(t={},e){const{fetchResources:r}=await J(()=>Promise.resolve().then(()=>j3),void 0,import.meta.url);return r(this,t,e)}async addResource(t,e,r){const{addOrUpdateResource:i}=await J(()=>Promise.resolve().then(()=>j3),void 0,import.meta.url);return t.portalItem=this,i(t,"add",e,r)}async removeResource(t,e){const{removeResource:r}=await J(()=>Promise.resolve().then(()=>j3),void 0,import.meta.url);if(t.portalItem&&t.portalItem.itemUrl!==this.itemUrl)throw new D("removeresource:portal-item-mismatch","The portal item associated with the provided resource does not match the item");return r(this,t,e)}async removeAllResources(t){const{removeAllResources:e}=await J(()=>Promise.resolve().then(()=>j3),void 0,import.meta.url);return e(this,t)}resourceFromPath(t){return new NJe({portalItem:this,path:t})}toJSON(){const t=this.extent,e={accessInformation:this.accessInformation,categories:re(this.categories),created:this.created&&this.created.getTime(),description:this.description,extent:t&&[[t.xmin,t.ymin],[t.xmax,t.ymax]],id:this.id,isOrgItem:this.isOrgItem,licenseInfo:this.licenseInfo,modified:this.modified&&this.modified.getTime(),name:this.name,owner:this.owner,ownerFolder:this.ownerFolder,snippet:this.snippet,sourceUrl:this.sourceUrl,spatialReference:this.spatialReference,tags:re(this.tags),thumbnail:this.thumbnail,title:this.title,type:this.type,typeKeywords:re(this.typeKeywords),url:this.url};return E6(e)}static fromJSON(t){if(!t)return null;if(t.declaredClass)throw new Error("JSON object is already hydrated");return new zw({sourceJSON:t})}_getPostQuery(){const t=this.toJSON();for(const e in t)e==="tags"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="typeKeywords"&&t[e]!==null&&(t[e]=t[e].join(", ")),e==="extent"&&t[e]&&(t[e]=JSON.stringify(t[e]));return t}};u([d({type:["private","shared","org","public"]})],dr.prototype,"access",void 0),u([d()],dr.prototype,"accessInformation",void 0),u([d({type:String})],dr.prototype,"apiKey",void 0),u([d({json:{read:{source:"appProxies"}}})],dr.prototype,"applicationProxies",void 0),u([d()],dr.prototype,"avgRating",void 0),u([d()],dr.prototype,"categories",void 0),u([d({type:Date})],dr.prototype,"created",void 0),u([d()],dr.prototype,"culture",void 0),u([d()],dr.prototype,"description",void 0),u([d({readOnly:!0})],dr.prototype,"displayName",null),u([d({type:vr})],dr.prototype,"extent",void 0),u([Ae("extent")],dr.prototype,"readExtent",null),u([d()],dr.prototype,"groupCategories",void 0),u([d({readOnly:!0})],dr.prototype,"iconUrl",null),u([d()],dr.prototype,"id",void 0),u([d({readOnly:!0})],dr.prototype,"isLayer",null),u([d({type:Boolean,readOnly:!0})],dr.prototype,"isOrgItem",void 0),u([d()],dr.prototype,"itemControl",void 0),u([d({readOnly:!0})],dr.prototype,"itemPageUrl",null),u([d({readOnly:!0})],dr.prototype,"itemUrl",null),u([d()],dr.prototype,"licenseInfo",void 0),u([d({type:Date})],dr.prototype,"modified",void 0),u([d()],dr.prototype,"name",void 0),u([d()],dr.prototype,"numComments",void 0),u([d()],dr.prototype,"numRatings",void 0),u([d()],dr.prototype,"numViews",void 0),u([d()],dr.prototype,"owner",void 0),u([d()],dr.prototype,"ownerFolder",void 0),u([d({type:ao})],dr.prototype,"portal",void 0),u([d()],dr.prototype,"screenshots",void 0),u([d()],dr.prototype,"size",void 0),u([d()],dr.prototype,"snippet",void 0),u([d()],dr.prototype,"sourceJSON",void 0),u([d({type:String})],dr.prototype,"sourceUrl",void 0),u([d({type:String})],dr.prototype,"spatialReference",void 0),u([d()],dr.prototype,"tags",void 0),u([d()],dr.prototype,"thumbnail",void 0),u([d({readOnly:!0})],dr.prototype,"thumbnailUrl",null),u([d()],dr.prototype,"title",void 0),u([d()],dr.prototype,"type",void 0),u([d()],dr.prototype,"typeKeywords",void 0),u([d({type:String,json:{read(t,e){if(kJe.has(e.type)){const r=this.portal?.restUrl;t||(t=r&&this.id?`${r}/content/items/${this.id}/data`:null)}return t}}})],dr.prototype,"url",void 0),u([d({readOnly:!0})],dr.prototype,"userItemUrl",null),dr=zw=u([R("esri.portal.PortalItem")],dr);const iT=dr,S2e=Object.freeze(Object.defineProperty({__proto__:null,default:iT},Symbol.toStringTag,{value:"Module"}));let rz,se=null;function E2e(){return!!se}function UJe(){return!!le("esri-wasm")}function C2e(){return rz||(rz=J(()=>import("./pe-wasm-d52675a6.js"),[],import.meta.url).then(t=>t.p).then(({default:t})=>t({locateFile:e=>Dr(`esri/geometry/support/${e}`)})).then(t=>{O2e(t)}),rz)}var bW,Js,wW;(function(t){function e(n,o,a){se.ensureCache.prepare();const l=xx(a),c=a===l,h=se.ensureFloat64(l),p=se._pe_geog_to_proj(se.getPointer(n),o,h);return p&&Wv(a,o,h,c),p}function r(n,o,a,l){switch(l){case Js.PE_TRANSFORM_P_TO_G:return i(n,o,a);case Js.PE_TRANSFORM_G_TO_P:return e(n,o,a)}return 0}function i(n,o,a){return s(n,o,a,0)}function s(n,o,a,l){se.ensureCache.prepare();const c=xx(a),h=a===c,p=se.ensureFloat64(c),f=se._pe_proj_to_geog_center(se.getPointer(n),o,p,l);return f&&Wv(a,o,p,h),f}t.geogToProj=e,t.projGeog=r,t.projToGeog=i,t.projToGeogCenter=s})(bW||(bW={})),function(t){function e(){t.PE_BUFFER_MAX=se.PeDefs.prototype.PE_BUFFER_MAX,t.PE_NAME_MAX=se.PeDefs.prototype.PE_NAME_MAX,t.PE_MGRS_MAX=se.PeDefs.prototype.PE_MGRS_MAX,t.PE_USNG_MAX=se.PeDefs.prototype.PE_USNG_MAX,t.PE_DD_MAX=se.PeDefs.prototype.PE_DD_MAX,t.PE_DDM_MAX=se.PeDefs.prototype.PE_DDM_MAX,t.PE_DMS_MAX=se.PeDefs.prototype.PE_DMS_MAX,t.PE_UTM_MAX=se.PeDefs.prototype.PE_UTM_MAX,t.PE_PARM_MAX=se.PeDefs.prototype.PE_PARM_MAX,t.PE_TYPE_NONE=se.PeDefs.prototype.PE_TYPE_NONE,t.PE_TYPE_GEOGCS=se.PeDefs.prototype.PE_TYPE_GEOGCS,t.PE_TYPE_PROJCS=se.PeDefs.prototype.PE_TYPE_PROJCS,t.PE_TYPE_GEOGTRAN=se.PeDefs.prototype.PE_TYPE_GEOGTRAN,t.PE_TYPE_COORDSYS=se.PeDefs.prototype.PE_TYPE_COORDSYS,t.PE_TYPE_UNIT=se.PeDefs.prototype.PE_TYPE_UNIT,t.PE_TYPE_LINUNIT=se.PeDefs.prototype.PE_TYPE_LINUNIT,t.PE_STR_OPTS_NONE=se.PeDefs.prototype.PE_STR_OPTS_NONE,t.PE_STR_AUTH_NONE=se.PeDefs.prototype.PE_STR_AUTH_NONE,t.PE_STR_AUTH_TOP=se.PeDefs.prototype.PE_STR_AUTH_TOP,t.PE_STR_NAME_CANON=se.PeDefs.prototype.PE_STR_NAME_CANON,t.PE_PARM_X0=se.PeDefs.prototype.PE_PARM_X0,t.PE_PARM_ND=se.PeDefs.prototype.PE_PARM_ND,t.PE_TRANSFORM_1_TO_2=se.PeDefs.prototype.PE_TRANSFORM_1_TO_2,t.PE_TRANSFORM_2_TO_1=se.PeDefs.prototype.PE_TRANSFORM_2_TO_1,t.PE_TRANSFORM_P_TO_G=se.PeDefs.prototype.PE_TRANSFORM_P_TO_G,t.PE_TRANSFORM_G_TO_P=se.PeDefs.prototype.PE_TRANSFORM_G_TO_P,t.PE_HORIZON_RECT=se.PeDefs.prototype.PE_HORIZON_RECT,t.PE_HORIZON_POLY=se.PeDefs.prototype.PE_HORIZON_POLY,t.PE_HORIZON_LINE=se.PeDefs.prototype.PE_HORIZON_LINE,t.PE_HORIZON_DELTA=se.PeDefs.prototype.PE_HORIZON_DELTA}t.init=e}(Js||(Js={})),function(t){const e={},r={},i=m=>{if(m){const g=m.getType();switch(g){case Js.PE_TYPE_GEOGCS:m=se.castObject(m,se.PeGeogcs);break;case Js.PE_TYPE_PROJCS:m=se.castObject(m,se.PeProjcs);break;case Js.PE_TYPE_GEOGTRAN:m=se.castObject(m,se.PeGeogtran);break;default:g&Js.PE_TYPE_UNIT&&(m=se.castObject(m,se.PeUnit))}}return m};function s(){se.PeFactory.prototype.initialize(null)}function n(m){return o(Js.PE_TYPE_COORDSYS,m)}function o(m,g){let _=null,v=e[m];if(v||(v={},e[m]=v),v.hasOwnProperty(String(g)))_=v[g];else{const b=se.PeFactory.prototype.factoryByType(m,g);se.compare(b,se.NULL)||(_=b,v[g]=_)}return _=i(_),_}function a(m,g){let _=null,v=r[m];if(v||(v={},r[m]=v),v.hasOwnProperty(g))_=v[g];else{const b=se.PeFactory.prototype.fromString(m,g);se.compare(b,se.NULL)||(_=b,v[g]=_)}return _=i(_),_}function l(m){return o(Js.PE_TYPE_GEOGCS,m)}function c(m){return o(Js.PE_TYPE_GEOGTRAN,m)}function h(m){return se.PeFactory.prototype.getCode(m)}function p(m){return o(Js.PE_TYPE_PROJCS,m)}function f(m){return o(Js.PE_TYPE_UNIT,m)}t.initialize=s,t.coordsys=n,t.factoryByType=o,t.fromString=a,t.geogcs=l,t.geogtran=c,t.getCode=h,t.projcs=p,t.unit=f}(wW||(wW={}));let A2e=null;var $k,xW,TW,SW,Lk,EW,Dk,Nk,CW;function O2e(t){function e(n,o,a){n[o]=a(n[o])}se=t,Js.init(),$k.init(),Lk.init(),Dk.init(),Nk.init(),A2e=class extends se.PeGCSExtent{destroy(){se.destroy(this)}};const r=[se.PeDatum,se.PeGeogcs,se.PeGeogtran,se.PeObject,se.PeParameter,se.PePrimem,se.PeProjcs,se.PeSpheroid,se.PeUnit];for(const n of r)e(n.prototype,"getName",o=>function(){return o.call(this,new Array(Js.PE_NAME_MAX))});for(const n of[se.PeGeogtran,se.PeProjcs])e(n.prototype,"getParameters",o=>function(){const a=new Array(Js.PE_PARM_MAX);let l=o.call(this);for(let c=0;c<a.length;c++){const h=se.getValue(l,"*");a[c]=h?se.wrapPointer(h,se.PeParameter):null,l+=Int32Array.BYTES_PER_ELEMENT}return a});e(se.PeHorizon.prototype,"getCoord",n=>function(){const o=this.getSize();if(!o)return null;const a=[];return Wv(a,o,n.call(this)),a}),e(se.PeGTlistExtendedEntry.prototype,"getEntries",n=>{const o=se._pe_getPeGTlistExtendedGTsSize();return function(){let a=null;const l=n.call(this);if(!se.compare(l,se.NULL)){a=[l];const c=this.getSteps();if(c>1){const h=se.getPointer(l);for(let p=1;p<c;p++)a.push(se.wrapPointer(h+o*p,se.PeGTlistExtendedGTs))}}return a}});const i=se._pe_getPeHorizonSize(),s=n=>function(){let o=this._cache;if(o||(o=new Map,this._cache=o),o.has(n))return o.get(n);let a=null;const l=n.call(this);if(!se.compare(l,se.NULL)){a=[l];const c=l.getNump();if(c>1){const h=se.getPointer(l);for(let p=1;p<c;p++)a.push(se.wrapPointer(h+i*p,se.PeHorizon))}}return o.set(n,a),a};e(se.PeProjcs.prototype,"horizonGcsGenerate",s),e(se.PeProjcs.prototype,"horizonPcsGenerate",s),se.PeObject.prototype.toString=function(n=Js.PE_STR_OPTS_NONE){se.ensureCache.prepare();const o=se.getPointer(this),a=se.ensureInt8(new Array(Js.PE_BUFFER_MAX));return se.UTF8ToString(se._pe_object_to_string_ext(o,n,a))}}function jg(t){if(!t)return;const e=se.getClass(t);if(!e)return;const r=se.getCache(e);if(!r)return;const i=se.getPointer(t);i&&delete r[i]}function LL(t,e){const r=[],i=new Array(e);for(let s=0;s<t;s++)r.push(se.ensureInt8(i));return r}function xx(t){let e;return Array.isArray(t[0])?(e=[],t.forEach(r=>{e.push(r[0],r[1])})):e=t,e}function Wv(t,e,r,i=!1){if(i)for(let s=0;s<2*e;s++)t[s]=se.getValue(r+s*Float64Array.BYTES_PER_ELEMENT,"double");else{const s=t.length===0;for(let n=0;n<e;n++)s&&(t[n]=new Array(2)),t[n][0]=se.getValue(r,"double"),t[n][1]=se.getValue(r+Float64Array.BYTES_PER_ELEMENT,"double"),r+=2*Float64Array.BYTES_PER_ELEMENT}}(function(t){let e;function r(){t.PE_GTLIST_OPTS_COMMON=se.PeGTlistExtended.prototype.PE_GTLIST_OPTS_COMMON,e=se._pe_getPeGTlistExtendedEntrySize()}function i(s,n,o,a,l,c){let h=null;const p=new se.PeInteger(c);try{const f=se.PeGTlistExtended.prototype.getGTlist(s,n,o,a,l,p);if((c=p.val)&&(h=[f],c>1)){const m=se.getPointer(f);for(let g=1;g<c;g++)h.push(se.wrapPointer(m+e*g,se.PeGTlistExtendedEntry))}}finally{se.destroy(p)}return h}t.init=r,t.getGTlist=i})($k||($k={})),function(t){function e(r){if(r&&r.length){for(const i of r)jg(i),i.getEntries().forEach(s=>{jg(s);const n=s.getGeogtran();jg(n),n.getParameters().forEach(jg),[n.getGeogcs1(),n.getGeogcs2()].forEach(o=>{jg(o);const a=o.getDatum();jg(a),jg(a.getSpheroid()),jg(o.getPrimem()),jg(o.getUnit())})});se.PeGTlistExtendedEntry.prototype.Delete(r[0])}}t.destroy=e}(xW||(xW={})),function(t){function e(r,i,s,n,o){se.ensureCache.prepare();const a=xx(s),l=s===a,c=se.ensureFloat64(a);let h=0;n&&(h=se.ensureFloat64(n));const p=se._pe_geog_to_geog(se.getPointer(r),i,c,h,o);return p&&Wv(s,i,c,l),p}t.geogToGeog=e}(TW||(TW={})),function(t){const e=(c,h,p,f,m,g)=>{let _,v;switch(se.ensureCache.prepare(),c){case"dd":_=se._pe_geog_to_dd,v=Js.PE_DD_MAX;break;case"ddm":_=se._pe_geog_to_ddm,v=Js.PE_DDM_MAX;break;case"dms":_=se._pe_geog_to_dms,v=Js.PE_DMS_MAX}let b=0;h&&(b=se.getPointer(h));const x=xx(f),T=se.ensureFloat64(x),S=LL(p,v),O=_(b,p,T,m,se.ensureInt32(S));if(O)for(let A=0;A<p;A++)g[A]=se.UTF8ToString(S[A]);return O},r=(c,h,p,f,m)=>{let g;switch(se.ensureCache.prepare(),c){case"dd":g=se._pe_dd_to_geog;break;case"ddm":g=se._pe_ddm_to_geog;break;case"dms":g=se._pe_dms_to_geog}let _=0;h&&(_=se.getPointer(h));const v=f.map(S=>se.ensureString(S)),b=se.ensureInt32(v),x=se.ensureFloat64(new Array(2*p)),T=g(_,p,b,x);return T&&Wv(m,p,x),T};function i(c,h,p,f,m){return e("dms",c,h,p,f,m)}function s(c,h,p,f){return r("dms",c,h,p,f)}function n(c,h,p,f,m){return e("ddm",c,h,p,f,m)}function o(c,h,p,f){return r("ddm",c,h,p,f)}function a(c,h,p,f,m){return e("dd",c,h,p,f,m)}function l(c,h,p,f){return r("dd",c,h,p,f)}t.geogToDms=i,t.dmsToGeog=s,t.geogToDdm=n,t.ddmToGeog=o,t.geogToDd=a,t.ddToGeog=l}(SW||(SW={})),function(t){function e(){t.PE_MGRS_STYLE_NEW=se.PeNotationMgrs.prototype.PE_MGRS_STYLE_NEW,t.PE_MGRS_STYLE_OLD=se.PeNotationMgrs.prototype.PE_MGRS_STYLE_OLD,t.PE_MGRS_STYLE_AUTO=se.PeNotationMgrs.prototype.PE_MGRS_STYLE_AUTO,t.PE_MGRS_180_ZONE_1_PLUS=se.PeNotationMgrs.prototype.PE_MGRS_180_ZONE_1_PLUS,t.PE_MGRS_ADD_SPACES=se.PeNotationMgrs.prototype.PE_MGRS_ADD_SPACES}function r(s,n,o,a,l,c,h){se.ensureCache.prepare();let p=0;s&&(p=se.getPointer(s));const f=xx(o),m=se.ensureFloat64(f),g=LL(n,Js.PE_MGRS_MAX),_=se.ensureInt32(g),v=se._pe_geog_to_mgrs_extended(p,n,m,a,l,c,_);if(v)for(let b=0;b<n;b++)h[b]=se.UTF8ToString(g[b]);return v}function i(s,n,o,a,l){se.ensureCache.prepare();let c=0;s&&(c=se.getPointer(s));const h=o.map(g=>se.ensureString(g)),p=se.ensureInt32(h),f=se.ensureFloat64(new Array(2*n)),m=se._pe_mgrs_to_geog_extended(c,n,p,a,f);return m&&Wv(l,n,f),m}t.init=e,t.geogToMgrsExtended=r,t.mgrsToGeogExtended=i}(Lk||(Lk={})),function(t){function e(i,s,n,o,a,l,c){se.ensureCache.prepare();let h=0;i&&(h=se.getPointer(i));const p=xx(n),f=se.ensureFloat64(p),m=LL(s,Js.PE_MGRS_MAX),g=se.ensureInt32(m),_=se._pe_geog_to_usng(h,s,f,o,a,l,g);if(_)for(let v=0;v<s;v++)c[v]=se.UTF8ToString(m[v]);return _}function r(i,s,n,o){se.ensureCache.prepare();let a=0;i&&(a=se.getPointer(i));const l=n.map(f=>se.ensureString(f)),c=se.ensureInt32(l),h=se.ensureFloat64(new Array(2*s)),p=se._pe_usng_to_geog(a,s,c,h);return p&&Wv(o,s,h),p}t.geogToUsng=e,t.usngToGeog=r}(EW||(EW={})),function(t){function e(){t.PE_UTM_OPTS_NONE=se.PeNotationUtm.prototype.PE_UTM_OPTS_NONE,t.PE_UTM_OPTS_ADD_SPACES=se.PeNotationUtm.prototype.PE_UTM_OPTS_ADD_SPACES,t.PE_UTM_OPTS_NS=se.PeNotationUtm.prototype.PE_UTM_OPTS_NS}function r(s,n,o,a,l){se.ensureCache.prepare();let c=0;s&&(c=se.getPointer(s));const h=xx(o),p=se.ensureFloat64(h),f=LL(n,Js.PE_UTM_MAX),m=se.ensureInt32(f),g=se._pe_geog_to_utm(c,n,p,a,m);if(g)for(let _=0;_<n;_++)l[_]=se.UTF8ToString(f[_]);return g}function i(s,n,o,a,l){se.ensureCache.prepare();let c=0;s&&(c=se.getPointer(s));const h=o.map(g=>se.ensureString(g)),p=se.ensureInt32(h),f=se.ensureFloat64(new Array(2*n)),m=se._pe_utm_to_geog(c,n,p,a,f);return m&&Wv(l,n,f),m}t.init=e,t.geogToUtm=r,t.utmToGeog=i}(Dk||(Dk={})),function(t){const e=new Map;function r(){t.PE_PCSINFO_OPTION_NONE=se.PePCSInfo.prototype.PE_PCSINFO_OPTION_NONE,t.PE_PCSINFO_OPTION_DOMAIN=se.PePCSInfo.prototype.PE_PCSINFO_OPTION_DOMAIN,t.PE_POLE_OUTSIDE_BOUNDARY=se.PePCSInfo.prototype.PE_POLE_OUTSIDE_BOUNDARY,t.PE_POLE_POINT=se.PePCSInfo.prototype.PE_POLE_POINT}function i(s,n=t.PE_PCSINFO_OPTION_DOMAIN){let o=null,a=null;return e.has(s)&&(a=e.get(s),a[n]&&(o=a[n])),o||(o=se.PePCSInfo.prototype.generate(s,n),a||(a=[],e.set(s,a)),a[n]=o),o}t.init=r,t.generate=i}(Nk||(Nk={})),function(t){function e(){return se.PeVersion.prototype.version_string()}t.versionString=e}(CW||(CW={}));const VJe=Object.freeze(Object.defineProperty({__proto__:null,get PeCSTransformations(){return bW},get PeDefs(){return Js},get PeFactory(){return wW},get PeGCSExtent(){return A2e},get PeGTTransformations(){return TW},get PeGTlistExtended(){return $k},get PeGTlistExtendedEntry(){return xW},get PeNotationDms(){return SW},get PeNotationMgrs(){return Lk},get PeNotationUsng(){return EW},get PeNotationUtm(){return Dk},get PePCSInfo(){return Nk},get PeVersion(){return CW},_init:O2e,get _pe(){return se},isLoaded:E2e,isSupported:UJe,load:C2e},Symbol.toStringTag,{value:"Module"})),uu=Math.PI/180,zJe=/SPHEROID\[([^\]]+)]/i,p_=ur.radius,hp=ur.eccentricitySquared,BJe={a1:p_*hp,a2:p_*hp*p_*hp,a3:p_*hp*hp/2,a4:p_*hp*p_*hp*2.5,a5:p_*hp+p_*hp*hp/2,a6:1-hp},GJe={4267:{a:63782064e-1,f:1/294.9786982},4269:{a:6378137,f:1/298.257222101},4326:{a:ur.radius,f:ur.flattening},104900:{a:2439700,f:0},104901:{a:6051e3,f:0},104902:{a:6051800,f:0},104903:{a:E0.radius,f:E0.flattening},104904:{a:3393400,f:1/192.0430107526882},104905:{a:ig.radius,f:ig.flattening},104906:{a:6200,f:0},104907:{a:11100,f:0},104908:{a:71492e3,f:.06487439154031222},104909:{a:8200,f:0},104910:{a:83500,f:0},104911:{a:1e4,f:0},104912:{a:2409300,f:0},104913:{a:15e3,f:0},104914:{a:4e4,f:0},104915:{a:1562090,f:0},104916:{a:2632345,f:0},104917:{a:85e3,f:0},104918:{a:1821460,f:0},104919:{a:5e3,f:0},104920:{a:12e3,f:0},104921:{a:3e4,f:3},104922:{a:18e3,f:0},104923:{a:14e3,f:0},104924:{a:49300,f:0},104925:{a:60268e3,f:1/10.2079945799458},104926:{a:16e3,f:0},104927:{a:9500,f:0},104928:{a:56e4,f:0},104929:{a:249400,f:0},104930:{a:59500,f:0},104931:{a:16e3,f:0},104932:{a:133e3,f:0},104933:{a:718e3,f:0},104934:{a:888e3,f:0},104935:{a:1986300,f:0},104936:{a:1e4,f:0},104937:{a:41900,f:0},104938:{a:11e4,f:0},104939:{a:50100,f:0},104940:{a:764e3,f:0},104941:{a:11e3,f:0},104942:{a:529800,f:0},104943:{a:2575e3,f:0},104944:{a:25559e3,f:1/43.61604095563141},104945:{a:578900,f:0},104946:{a:33e3,f:0},104947:{a:21e3,f:0},104948:{a:13e3,f:0},104949:{a:31e3,f:0},104950:{a:27e3,f:0},104951:{a:42e3,f:0},104952:{a:235800,f:0},104953:{a:761400,f:0},104954:{a:15e3,f:0},104955:{a:54e3,f:0},104956:{a:77e3,f:0},104957:{a:27e3,f:0},104958:{a:788900,f:0},104959:{a:584700,f:0},104960:{a:24764e3,f:.01708124697141011},104961:{a:74e3,f:0},104962:{a:79e3,f:0},104963:{a:104e3,f:.14423076923076922},104964:{a:29e3,f:0},104965:{a:17e4,f:0},104966:{a:208e3,f:0},104967:{a:4e4,f:0},104968:{a:1352600,f:0},104969:{a:1195e3,f:0},104970:{a:593e3,f:0},104971:{a:ig.radius,f:0},104972:{a:47e4,f:0},104973:{a:255e3,f:0},104974:{a:2439400,f:0}};let DL=0,iz=class AW{static fromGE(e){const r=new AW;return r._wkt=e.wkt,r._wkid=e.wkid,r._isInverse=e.isInverse,r}constructor(e){this.uid=DL++,e?(this._wkt=e.wkt!=null?e.wkt:null,this._wkid=e.wkid!=null?e.wkid:-1,this._isInverse=e.isInverse!=null&&e.isInverse===!0):(this._wkt=null,this._wkid=-1,this._isInverse=!1)}get wkt(){return this._wkt}set wkt(e){this._wkt=e,this.uid=DL++}get wkid(){return this._wkid}set wkid(e){this._wkid=e,this.uid=DL++}get isInverse(){return this._isInverse}set isInverse(e){this._isInverse=e,this.uid=DL++}getInverse(){const e=new AW;return e._wkt=this.wkt,e._wkid=this._wkid,e._isInverse=!this.isInverse,e}},Fk=class D3{static cacheKey(e,r){return[e.wkid!==void 0&&e.wkid!==null?e.wkid.toString():"-1",e.wkt!==void 0&&e.wkt!==null?e.wkt.toString():"",r.wkid!==void 0&&r.wkid!==null?r.wkid.toString():"-1",r.wkt!==void 0&&r.wkt!==null?r.wkt.toString():""].join(",")}static fromGE(e){const r=new D3;let i="";for(const s of e.steps){const n=iz.fromGE(s);r.steps.push(n),i+=n.uid.toString()+","}return r._cachedProjection={},r._gtlistentry=null,r._chain=i,r}constructor(e){if(this.steps=[],this._cachedProjection={},this._chain="",this._gtlistentry=null,e&&e.steps)for(const r of e.steps)r instanceof iz?this.steps.push(r):this.steps.push(new iz({wkid:r.wkid,wkt:r.wkt,isInverse:r.isInverse}))}getInverse(){const e=new D3;e.steps=[];for(let r=this.steps.length-1;r>=0;r--){const i=this.steps[r];e.steps.push(i.getInverse())}return e}getGTListEntry(){let e="";for(const r of this.steps)e+=r.uid.toString()+",";return e!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=e),this._gtlistentry}assignCachedGe(e,r,i){this._cachedProjection[D3.cacheKey(e,r)]=i}getCachedGeTransformation(e,r){let i="";for(const n of this.steps)i+=n.uid.toString()+",";i!==this._chain&&(this._gtlistentry=null,this._cachedProjection={},this._chain=i);const s=this._cachedProjection[D3.cacheKey(e,r)];return s===void 0?null:s}},wf=null,j1=null,ZM=null,g4={};const R2e=new X6;function y$(){return!!wf&&E2e()}function mA(t){return ZM==null&&(ZM=Promise.all([C2e(),J(()=>import("./geometryEngineBase-7a1f11c2.js"),[],import.meta.url).then(e=>e.g),J(()=>import("./hydrated-3d997481.js"),[],import.meta.url)])),ZM.then(([,e,{hydratedAdapter:r}])=>{Dt(t),j1=r,wf=e.default,wf._enableProjection(VJe),R2e.notify()})}function bg(t,e,r=null,i=null){return Array.isArray(t)?t.length===0?[]:OW(j1,t,t[0].spatialReference,e,r,i):OW(j1,[t],t.spatialReference,e,r,i)[0]}function OW(t,e,r,i,s=null,n=null){if(r==null||i==null)return e;if($f(r,i,s))return e.map(o=>mee(o,r,i));if(s==null){const o=Fk.cacheKey(r,i);g4[o]!==void 0?s=g4[o]:((s=I2e(r,i,void 0))==null&&(s=new Fk),g4[o]=s)}if(wf==null||t==null)throw new RV;return n!=null?wf._project(t,e,r,i,s,n):wf._project(t,e,r,i,s)}function jJe(t,e){const r=M2e([t],e);return r.pending!=null?{pending:r.pending,geometry:null}:r.geometries!=null?{pending:null,geometry:r.geometries[0]}:{pending:null,geometry:null}}function M2e(t,e){if(!y$()){for(const r of t)if(r!=null&&!Bn(r.spatialReference,e)&&Qa(r.spatialReference)&&Qa(e)&&!$f(r.spatialReference,e))return Jt(R2e),{pending:mA(),geometries:null}}return{pending:null,geometries:t.map(r=>r==null?null:Bn(r.spatialReference,e)?r:Qa(r.spatialReference)&&Qa(e)?P2e(r,e):null)}}function I2e(t,e,r=null){if(t==null||e==null)return null;if(wf==null||j1==null)throw new RV;const i=wf._getTransformation(j1,t,e,r,r?.spatialReference);return i!==null?Fk.fromGE(i):null}function HJe(t,e,r=null){if(wf==null||j1==null)throw new RV;const i=wf._getTransformationBySuitability(j1,t,e,r,r?.spatialReference);if(i!==null){const s=[];for(const n of i)s.push(Fk.fromGE(n));return s}return[]}class RV extends D{constructor(){super("projection:not-loaded","projection engine not fully loaded yet, please call load()")}}var W;function qJe(){wf=null,j1=null,ZM=null,g4={}}(function(t){t[t.UNKNOWN=0]="UNKNOWN",t[t.SPHERICAL_ECEF=1]="SPHERICAL_ECEF",t[t.WGS84=2]="WGS84",t[t.WEB_MERCATOR=3]="WEB_MERCATOR",t[t.WGS84_ECEF=4]="WGS84_ECEF",t[t.CGCS2000=5]="CGCS2000",t[t.WGS84_COMPARABLE_LON_LAT=6]="WGS84_COMPARABLE_LON_LAT",t[t.SPHERICAL_MARS_PCPF=7]="SPHERICAL_MARS_PCPF",t[t.GCSMARS2000=8]="GCSMARS2000",t[t.SPHERICAL_MOON_PCPF=9]="SPHERICAL_MOON_PCPF",t[t.GCSMOON2000=10]="GCSMOON2000",t[t.LON_LAT=11]="LON_LAT",t[t.PLATE_CARREE=12]="PLATE_CARREE"})(W||(W={}));const WJe={get loadPromise(){return ZM}};function P2e(t,e){try{const r=bg(t,e);if(r==null)return null;"xmin"in t&&"xmin"in r&&(r.zmin=t.zmin,r.zmax=t.zmax);const i=xSe(r.type,t.spatialReference,e);return i?.(r),r}catch(r){if(!(r instanceof RV))throw r;return null}}function $f(t,e,r){return!r&&(!!Bn(t,e)||Qa(t)&&Qa(e)&&!!vee(t,e,wee))}async function fee(t,e,r,i){if(y$())return $se(i);if(Array.isArray(t)){for(const{source:s,dest:n,geographicTransformation:o}of t)if(!$f(s,n,o))return mA(i)}else if(!$f(t,e,r))return mA(i);return $se(i)}function ZJe(t,e){switch(vee(t,e,wee)){case qi:return"copy3";case p1:return"wgs84ToSphericalECEF";case FT:return"wgs84ToWebMercator";case d1:return"wgs84ToPlateCarree";case m1:return"wgs84ToWGS84ECEF";case sT:return"webMercatorToWGS84";case j2e:return"webMercatorToSphericalECEF";case H2e:return"webMercatorToWGS84ECEF";case q2e:return"webMercatorToPlateCarree";case g1:return"wgs84ECEFToWGS84";case Y2e:return"wgs84ECEFToSphericalECEF";case J2e:return"wgs84ECEFToWebMercator";case f1:return"sphericalECEFToWGS84";case Z2e:return"sphericalECEFToWebMercator";case $W:return"sphericalMarsPCPFToMars2000";case PW:return"sphericalMoonPCPFToMoon2000";case X2e:return"sphericalECEFToWGS84ECEF";case IW:return"mars2000ToSphericalPCPF";case MW:return"moon2000ToSphericalPCPF";default:return null}}function mee(t,e,r){return t?"x"in t?L2e(t,e,new ht,r,0):"xmin"in t?U2e(t,e,new vr,r,0):"rings"in t?k2e(t,e,new bc,r,0):"paths"in t?N2e(t,e,new QP,r,0):"points"in t?D2e(t,e,new ZP,r,0):null:null}function $2e(t,e,r=e.spatialReference,i=0){return r!=null&&t.spatialReference!=null&&L2e(t,t.spatialReference,e,r,i)!=null}function L2e(t,e,r,i,s){Hr[0]=t.x,Hr[1]=t.y;const n=t.z;return Hr[2]=n!==void 0?n:s,wi(Hr,e,0,Hr,i,0,1)?(r.x=Hr[0],r.y=Hr[1],r.spatialReference=i,n===void 0?(r.z=void 0,r.hasZ=!1):(r.z=Hr[2],r.hasZ=!0),t.m===void 0?(r.m=void 0,r.hasM=!1):(r.m=t.m,r.hasM=!0),r):null}function XJe(t,e,r=e.spatialReference,i=0){return t.spatialReference!=null&&r!=null&&D2e(t,t.spatialReference,e,r,i)!=null}function D2e(t,e,r,i,s){const{points:n,hasZ:o,hasM:a}=t,l=[],c=n.length,h=[];for(const p of n)h.push(p[0],p[1],o?p[2]:s);if(!wi(h,e,0,h,i,0,c))return null;for(let p=0;p<c;++p){const f=3*p,m=h[f],g=h[f+1];o&&a?l.push([m,g,h[f+2],n[p][3]]):o?l.push([m,g,h[f+2]]):a?l.push([m,g,n[p][2]]):l.push([m,g])}return r.points=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r}function YJe(t,e,r=e.spatialReference,i=0){return t.spatialReference!=null&&r!=null&&N2e(t,t.spatialReference,e,r,i)!=null}function N2e(t,e,r,i,s){const{paths:n,hasZ:o,hasM:a}=t,l=[];return B2e(n,o??!1,a??!1,e,l,i,s)?(r.paths=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function JJe({hasZ:t,spatialReference:e,paths:r},i,s=0){const n=wg(e,yO),o=Pd[n][W.WGS84_COMPARABLE_LON_LAT];if(o==null)return!1;const a=t?l=>l:l=>ie(Hr,l[0],l[1],s);for(const l of r){const c=[];for(const h of l){const p=[0,0,s];o(a(h),0,p,0),c.push(p)}i.push(c)}return!0}function QJe({hasZ:t,spatialReference:e,rings:r},i,s=0){const n=wg(e,yO),o=Pd[n][W.WGS84_COMPARABLE_LON_LAT];if(o==null)return!1;const a=t?l=>l:l=>ie(Hr,l[0],l[1],s);for(const l of r){const c=[];for(const h of l){const p=[0,0,s];o(a(h),0,p,0),c.push(p)}i.push(c)}return!0}function F2e(t,e,r=e.spatialReference,i=0){return t.spatialReference!=null&&r!=null&&k2e(t,t.spatialReference,e,r,i)!=null}function k2e(t,e,r,i,s){const{rings:n,hasZ:o,hasM:a}=t,l=[];return B2e(n,o??!1,a??!1,e,l,i,s)?(r.rings=l,r.spatialReference=i,r.hasZ=o,r.hasM=a,r):null}function KJe(t,e,r=e.spatialReference,i=0){return t.spatialReference!=null&&r!=null&&U2e(t,t.spatialReference,e,r,i)!=null}function U2e(t,e,r,i,s){const{xmin:n,ymin:o,xmax:a,ymax:l,hasZ:c,hasM:h}=t;return RW(n,o,c?t.zmin:s,e,Hr,i)?(r.xmin=Hr[0],r.ymin=Hr[1],c&&(r.zmin=Hr[2]),RW(a,l,c?t.zmax:s,e,Hr,i)?(r.xmax=Hr[0],r.ymax=Hr[1],c&&(r.zmax=Hr[2]),h&&(r.mmin=t.mmin,r.mmax=t.mmax),r.spatialReference=i,r):null):null}function R0(t,e,r){if(e==null||r==null)return null;const i=new ht({spatialReference:r});return wi(t,e,0,Hr,r,0,1)?(i.x=Hr[0],i.y=Hr[1],i.z=Hr[2],i):null}function gee(t,e,r){return wi(t,e,0,Hr,r.spatialReference,0,1)?(r.x=Hr[0],r.y=Hr[1],r.z=Hr[2],r):null}function aa(t,e,r,i=0){Hr[0]=t.x,Hr[1]=t.y;const s=t.z;return Hr[2]=s!==void 0?s:i,wi(Hr,t.spatialReference,0,e,r,0,1)}function RW(t,e,r,i,s,n){return As[0]=t,As[1]=e,As[2]=r,wi(As,i,0,s,n,0,1)}function Tn(t,e,r,i){return!(e==null||i==null||t.length<2)&&(t.length===2&&(As[0]=t[0],As[1]=t[1],As[2]=0,t=As),wi(t,e,0,r,i,0,1))}function V2e(t,e){Hr[0]=t.x,Hr[1]=t.y;const r=t.z;return Hr[2]=r!==void 0?r:0,z2e(Hr,t.spatialReference,e)}function z2e(t,e,r){return eQe(t,e,r)}function eQe(t,e,r){if(e==null)return!1;const i=wg(e,yO),s=Pd[i][W.WGS84_COMPARABLE_LON_LAT];return s!=null&&(s(t,0,As,0),r!==As&&(r[0]=As[0],r[1]=As[1],r.length>2&&(r[2]=As[2])),!0)}function wi(t,e,r,i,s,n,o=1){const a=vee(e,s,wee);if(a==null)return!1;if(a===qi){if(t===i&&r===n)return!0;const c=r+3*o;for(let h=r,p=n;h<c;h++,p++)i[p]=t[h];return!0}const l=r+3*o;for(let c=r,h=n;c<l;c+=3,h+=3)a(t,c,i,h);return!0}function tQe(t,e,r,i,s){oe(Hr,t),ue(NL,t,e),Tn(Hr,r,Hr,s),Tn(NL,r,NL,s),pe(i,NL,Hr),_e(i,i)}function B2e(t,e,r,i,s,n,o=0){const a=new Array;for(const c of t)for(const h of c)a.push(h[0],h[1],e?h[2]:o);if(!wi(a,i,0,a,n,0,a.length/3))return!1;let l=0;s.length=0;for(const c of t){const h=new Array;for(const p of c)e&&r?h.push([a[l++],a[l++],a[l++],p[3]]):e?h.push([a[l++],a[l++],a[l++]]):r?(h.push([a[l++],a[l++],p[2]]),l++):(h.push([a[l++],a[l++]]),l++);s.push(h)}return!0}function rQe(t,e,r,i){if(e==null||i==null)return!1;const s=Q2e(e,i,uQe);if(s.projector===qi)return r[0]=t[0],r[1]=t[1],r[2]=t[2],r[3]=t[3],!0;if(s.projector==null)return!1;const{source:n,dest:o}=s;if(o.spatialReferenceId===W.WEB_MERCATOR){const a=Pd[n.spatialReferenceId][W.WGS84];return a!=null&&(a(t,0,Yp,0),FT(Yp,0,r,0),r[3]=ole(Yp[1],t[2],t[3],ur.radius),!0)}if(n.spatialReferenceId!==W.WGS84&&n.spatialReferenceId!==W.CGCS2000||o.spatialReferenceId!==W.PLATE_CARREE){s.projector(t,0,r,0);const a=n.metersPerUnit??1,l=o.metersPerUnit??1;r[3]=t[3]*a/l}else{const a=Pd[n.spatialReferenceId][W.SPHERICAL_ECEF],l=Pd[W.SPHERICAL_ECEF][W.PLATE_CARREE];let c=t[3];a!=null&&l!=null&&(c=ole(t[1],t[2],t[3],ur.radius)),s.projector(t,0,r,0),r[3]=c}return!0}function ole(t,e,r,i){const s=i+e;if(s<i/2||r>s)return Number.MAX_VALUE;const n=Math.abs(hf*t)+Math.asin(r/s);return n>=Math.PI/2?Number.MAX_VALUE:r/Math.cos(n)}function _$(t,e,r,i){return t!=null&&(Bn(e,i)?(C0(r,t),!0):(As[0]=t[0],As[1]=t[1],As[2]=0,!!wi(As,e,0,As,i,0,1)&&(r[0]=As[0],r[1]=As[1],As[0]=t[2],As[1]=t[3],As[2]=0,!!wi(As,e,0,As,i,0,1)&&(r[2]=As[0],r[3]=As[1],!0))))}function iQe(t,e,r,i){if(e==null||i==null)return!1;const s=wg(e,yO),n=wg(i,K2e);if(s===n&&s!==W.UNKNOWN||Bn(e,i))return r[0]=1,r[1]=1,r[2]=1,!0;if(s===W.SPHERICAL_ECEF){const o=Oe(t),a=o/Math.sqrt(t[0]*t[0]+t[1]*t[1]),l=o/ur.radius;if(n===W.WEB_MERCATOR)return r[0]=a*l,r[1]=a*l,r[2]=1,!0;if(n===W.WGS84||n===W.CGCS2000){const c=XM;return r[0]=c*a*l,r[1]=c*l,r[2]=1,!0}}else if(s===W.PLATE_CARREE){if(n===W.WGS84||n===W.CGCS2000)return r[0]=XM,r[1]=XM,r[2]=1,!0;if(n===W.WEB_MERCATOR){const o=t[1]/ur.radius;return r[0]=1,r[1]=1/Math.cos(o),r[2]=1,!0}}return!1}function wc(t,e,r,i){if(t==null||i==null)return!1;const s=wg(t,yO),n=wg(i,K2e);if(s===n&&!ale(n)&&(s!==W.UNKNOWN||Bn(t,i)))return d$(r,e),!0;if(ale(n)){const o=Pd[s][W.LON_LAT],a=Pd[W.LON_LAT][n];return o!=null&&a!=null&&(o(e,0,Yp,0),a(Yp,0,f_,0),yee(hf*Yp[0],hf*Yp[1],r),r[12]=f_[0],r[13]=f_[1],r[14]=f_[2],!0)}if((n===W.WEB_MERCATOR||n===W.PLATE_CARREE)&&(s===W.WGS84||s===W.CGCS2000&&n===W.PLATE_CARREE||s===W.SPHERICAL_ECEF||s===W.WEB_MERCATOR)){const o=Pd[s][W.LON_LAT],a=Pd[W.LON_LAT][n];return o!=null&&a!=null&&(o(e,0,Yp,0),a(Yp,0,f_,0),s===W.SPHERICAL_ECEF?G2e(hf*Yp[0],hf*Yp[1],r):jd(r),r[12]=f_[0],r[13]=f_[1],r[14]=f_[2],!0)}return!1}function ale(t){return t===W.SPHERICAL_ECEF||t===W.SPHERICAL_MARS_PCPF||t===W.SPHERICAL_MOON_PCPF}function yee(t,e,r){const i=Math.sin(t),s=Math.cos(t),n=Math.sin(e),o=Math.cos(e),a=r;return a[0]=-i,a[4]=-n*s,a[8]=o*s,a[12]=0,a[1]=s,a[5]=-n*i,a[9]=o*i,a[13]=0,a[2]=0,a[6]=o,a[10]=n,a[14]=0,a[3]=0,a[7]=0,a[11]=0,a[15]=1,a}function G2e(t,e,r){return yee(t,e,r),Ou(r,r),r}function wg(t,e){return t?e.spatialReference===t?e.spatialReferenceId:(e.spatialReference=t,"metersPerUnit"in e&&(e.metersPerUnit=Uo(t,1)),t.wkt===T1e.wkt?e.spatialReferenceId=W.SPHERICAL_ECEF:FI(t)?e.spatialReferenceId=W.WGS84:xT(t)?e.spatialReferenceId=W.WEB_MERCATOR:kI(t)?e.spatialReferenceId=W.PLATE_CARREE:t.wkt===S1e.wkt?e.spatialReferenceId=W.WGS84_ECEF:t.wkid===Ad.CGCS2000?e.spatialReferenceId=W.CGCS2000:t.wkt===_Q.wkt?e.spatialReferenceId=W.SPHERICAL_MARS_PCPF:t.wkt===vQ.wkt?e.spatialReferenceId=W.SPHERICAL_MOON_PCPF:Pg(t)?e.spatialReferenceId=W.GCSMARS2000:$g(t)?e.spatialReferenceId=W.GCSMOON2000:e.spatialReferenceId=W.UNKNOWN):W.UNKNOWN}function qi(t,e,r,i){t!==r&&(r[i++]=t[e++],r[i++]=t[e++],r[i]=t[e])}function sT(t,e,r,i){r[i++]=gA*(t[e++]/ur.radius),r[i++]=gA*(Math.PI/2-2*Math.atan(Math.exp(-t[e++]/ur.radius))),r[i]=t[e]}function j2e(t,e,r,i){sT(t,e,r,i),p1(r,i,r,i)}function H2e(t,e,r,i){sT(t,e,r,i),m1(r,i,r,i)}function MV(t,e,r,i,s){const n=.4999999*Math.PI,o=ye(hf*t[e+1],-n,n),a=Math.sin(o);r[i++]=hf*t[e]*s.radius,r[i++]=s.halfSemiMajorAxis*Math.log((1+a)/(1-a)),r[i]=t[e+2]}function FT(t,e,r,i){MV(t,e,r,i,ur)}const lle=ur.radius*Math.PI/180,XM=180/(ur.radius*Math.PI);function d1(t,e,r,i){r[i]=t[e]*lle,r[i+1]=t[e+1]*lle,r[i+2]=t[e+2]}function Bx(t,e,r,i){r[i]=t[e]*XM,r[i+1]=t[e+1]*XM,r[i+2]=t[e+2]}function q2e(t,e,r,i){sT(t,e,r,i),d1(r,i,r,i)}function sQe(t,e,r,i){g1(t,e,r,i),d1(r,i,r,i)}function nQe(t,e,r,i){f1(t,e,r,i),d1(r,i,r,i)}function oQe(t,e,r,i){Bx(t,e,r,i),p1(r,i,r,i)}function aQe(t,e,r,i){Bx(t,e,r,i),FT(r,i,r,i)}function lQe(t,e,r,i){Bx(t,e,r,i),m1(r,i,r,i)}function H1(t){if(t==null)return!1;const e=wg(t,yO);return!!Pd[e][W.WGS84_COMPARABLE_LON_LAT]}function W2e(t,e,r,i){const s=Math.cos(r);t[0]=Math.cos(e)*s*i,t[1]=Math.sin(e)*s*i,t[2]=Math.sin(r)*i}function _ee(t,e,r,i,s){const n=s+t[e+2],o=hf*t[e+1],a=hf*t[e],l=Math.cos(o);r[i++]=Math.cos(a)*l*n,r[i++]=Math.sin(a)*l*n,r[i]=Math.sin(o)*n}function MW(t,e,r,i){_ee(t,e,r,i,E0.radius)}function IW(t,e,r,i){_ee(t,e,r,i,ig.radius)}function p1(t,e,r,i){_ee(t,e,r,i,ur.radius)}function IV(t,e,r,i,s){const n=t[e],o=t[e+1],a=t[e+2],l=Math.sqrt(n*n+o*o+a*a),c=Gd(a/(l===0?1:l)),h=Math.atan2(o,n);r[i++]=gA*h,r[i++]=gA*c,r[i]=l-s}function PW(t,e,r,i){IV(t,e,r,i,E0.radius)}function $W(t,e,r,i){IV(t,e,r,i,ig.radius)}function f1(t,e,r,i){IV(t,e,r,i,ur.radius)}function Z2e(t,e,r,i){f1(t,e,r,i),FT(r,i,r,i)}function X2e(t,e,r,i){f1(t,e,r,i),m1(r,i,r,i)}function cQe(t,e,r,i,s){const n=hf*t[e],o=hf*t[e+1],a=t[e+2],l=Math.sin(o),c=Math.cos(o),h=s.radius/Math.sqrt(1-s.eccentricitySquared*l*l);r[i++]=(h+a)*c*Math.cos(n),r[i++]=(h+a)*c*Math.sin(n),r[i++]=(h*(1-s.eccentricitySquared)+a)*l}function m1(t,e,r,i){cQe(t,e,r,i,ur)}function g1(t,e,r,i){const s=BJe,n=t[e],o=t[e+1],a=t[e+2];let l,c,h,p,f,m,g,_,v,b,x,T,S,O,A,M,P,F,$,N,U;l=Math.abs(a),c=n*n+o*o,h=Math.sqrt(c),p=c+a*a,f=Math.sqrt(p),N=Math.atan2(o,n),m=a*a/p,g=c/p,O=s.a2/f,A=s.a3-s.a4/f,g>.3?(_=l/f*(1+g*(s.a1+O+m*A)/f),$=Math.asin(_),b=_*_,v=Math.sqrt(1-b)):(v=h/f*(1-m*(s.a5-O-g*A)/f),$=Math.acos(v),b=1-v*v,_=Math.sqrt(b)),x=1-ur.eccentricitySquared*b,T=ur.radius/Math.sqrt(x),S=s.a6*T,O=h-T*v,A=l-S*_,P=v*O+_*A,M=v*A-_*O,F=M/(S/x+P),$+=F,U=P+M*F/2,a<0&&($=-$),r[i++]=gA*N,r[i++]=gA*$,r[i]=U}function Y2e(t,e,r,i){g1(t,e,r,i),p1(r,i,r,i)}function J2e(t,e,r,i){g1(t,e,r,i),FT(r,i,r,i)}const Pd={[W.WGS84]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:qi,[W.SPHERICAL_ECEF]:p1,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:FT,[W.PLATE_CARREE]:d1,[W.WGS84]:qi,[W.WGS84_ECEF]:m1},[W.CGCS2000]:{[W.CGCS2000]:qi,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:qi,[W.SPHERICAL_ECEF]:p1,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:d1,[W.WGS84]:null,[W.WGS84_ECEF]:m1},[W.GCSMARS2000]:{[W.CGCS2000]:null,[W.GCSMARS2000]:qi,[W.GCSMOON2000]:null,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:null,[W.SPHERICAL_ECEF]:null,[W.SPHERICAL_MARS_PCPF]:IW,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:null,[W.WGS84]:null,[W.WGS84_ECEF]:null},[W.GCSMOON2000]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:qi,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:null,[W.SPHERICAL_ECEF]:null,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:MW,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:null,[W.WGS84]:null,[W.WGS84_ECEF]:null},[W.WEB_MERCATOR]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:sT,[W.WGS84_COMPARABLE_LON_LAT]:sT,[W.SPHERICAL_ECEF]:j2e,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:qi,[W.PLATE_CARREE]:q2e,[W.WGS84]:sT,[W.WGS84_ECEF]:H2e},[W.WGS84_ECEF]:{[W.CGCS2000]:g1,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:g1,[W.WGS84_COMPARABLE_LON_LAT]:g1,[W.SPHERICAL_ECEF]:Y2e,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:J2e,[W.PLATE_CARREE]:sQe,[W.WGS84]:g1,[W.WGS84_ECEF]:qi},[W.SPHERICAL_ECEF]:{[W.CGCS2000]:f1,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:f1,[W.WGS84_COMPARABLE_LON_LAT]:f1,[W.SPHERICAL_ECEF]:qi,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:Z2e,[W.PLATE_CARREE]:nQe,[W.WGS84]:f1,[W.WGS84_ECEF]:X2e},[W.SPHERICAL_MARS_PCPF]:{[W.CGCS2000]:null,[W.GCSMARS2000]:$W,[W.GCSMOON2000]:null,[W.LON_LAT]:$W,[W.WGS84_COMPARABLE_LON_LAT]:null,[W.SPHERICAL_ECEF]:null,[W.SPHERICAL_MARS_PCPF]:qi,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:null,[W.WGS84]:null,[W.WGS84_ECEF]:null},[W.SPHERICAL_MOON_PCPF]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:PW,[W.LON_LAT]:PW,[W.WGS84_COMPARABLE_LON_LAT]:null,[W.SPHERICAL_ECEF]:null,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:qi,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:null,[W.WGS84]:null,[W.WGS84_ECEF]:null},[W.UNKNOWN]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:null,[W.WGS84_COMPARABLE_LON_LAT]:null,[W.SPHERICAL_ECEF]:null,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:qi,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:null,[W.WGS84]:null,[W.WGS84_ECEF]:null},[W.LON_LAT]:{[W.CGCS2000]:qi,[W.GCSMARS2000]:qi,[W.GCSMOON2000]:qi,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:qi,[W.SPHERICAL_ECEF]:p1,[W.SPHERICAL_MARS_PCPF]:IW,[W.SPHERICAL_MOON_PCPF]:MW,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:FT,[W.PLATE_CARREE]:d1,[W.WGS84]:qi,[W.WGS84_ECEF]:m1},[W.WGS84_COMPARABLE_LON_LAT]:{[W.CGCS2000]:null,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:qi,[W.WGS84_COMPARABLE_LON_LAT]:qi,[W.SPHERICAL_ECEF]:p1,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:null,[W.PLATE_CARREE]:d1,[W.WGS84]:qi,[W.WGS84_ECEF]:m1},[W.PLATE_CARREE]:{[W.CGCS2000]:Bx,[W.GCSMARS2000]:null,[W.GCSMOON2000]:null,[W.LON_LAT]:Bx,[W.WGS84_COMPARABLE_LON_LAT]:Bx,[W.SPHERICAL_ECEF]:oQe,[W.SPHERICAL_MARS_PCPF]:null,[W.SPHERICAL_MOON_PCPF]:null,[W.UNKNOWN]:null,[W.WEB_MERCATOR]:aQe,[W.PLATE_CARREE]:qi,[W.WGS84]:Bx,[W.WGS84_ECEF]:lQe}};function vee(t,e,r=bee()){return t==null||e==null?null:Q2e(t,e,r).projector}function Q2e(t,e,r){if(t==null||e==null||r.source.spatialReference===t&&r.dest.spatialReference===e)return r;const i=wg(t,r.source),s=wg(e,r.dest);return i===W.UNKNOWN&&s===W.UNKNOWN?Bn(t,e)?r.projector=qi:r.projector=null:r.projector=Pd[i][s],r}function bee(){return{source:{spatialReference:null,spatialReferenceId:W.UNKNOWN,metersPerUnit:1},dest:{spatialReference:null,spatialReferenceId:W.UNKNOWN,metersPerUnit:1},projector:qi}}const yO={spatialReference:null,spatialReferenceId:W.UNKNOWN},K2e={spatialReference:null,spatialReferenceId:W.UNKNOWN},wee=bee(),uQe=bee(),hf=zt(1),gA=Vl(1),As=C(),Yp=C(),f_=C(),Hr=C(),NL=C(),xkt=Object.freeze(Object.defineProperty({__proto__:null,canProjectToWGS84ComparableLonLat:H1,canProjectWithoutEngine:$f,computeENUToSphericalPCPFLocalRotation:yee,computeSphericalPCPFToENULocalRotation:G2e,computeTranslationToOriginAndRotation:wc,getProjectorName:ZJe,getTransformation:I2e,getTransformations:HJe,initializeProjection:fee,isLoaded:y$,load:mA,localLinearScaleFactors:iQe,lonLatToSphericalPCPF:W2e,lonLatToWebMercatorComparable:MV,project:bg,projectBoundingRect:_$,projectBoundingSphere:rQe,projectBuffer:wi,projectDirection:tQe,projectExtent:KJe,projectMany:OW,projectMultipoint:XJe,projectOrLoad:jJe,projectOrLoadMany:M2e,projectPoint:$2e,projectPointToVector:aa,projectPointToWGS84ComparableLonLat:V2e,projectPolygon:F2e,projectPolygonToWGS84ComparableLonLat:QJe,projectPolyline:YJe,projectPolylineToWGS84ComparableLonLat:JJe,projectVectorToDehydratedPoint:gee,projectVectorToPoint:R0,projectVectorToVector:Tn,projectVectorToWGS84ComparableLonLat:z2e,projectWithoutEngine:mee,projectXYZToVector:RW,sphericalPCPFtoLonLatElevation:IV,test:WJe,tryProjectWithZConversion:P2e,unload:qJe},Symbol.toStringTag,{value:"Module"}));async function hQe(t){const e=t.spatialReference;if(e.isWGS84)return t.clone();if(e.isWebMercator)return jE(t);const r=qe.WGS84;return await fee(e,r),bg(t,r)}function Tkt(t,e){if(!eEe(t,e)){const r=t.typeKeywords;r?r.push(e):t.typeKeywords=[e]}}function eEe(t,e){return!!t.typeKeywords?.includes(e)}function Skt(t){return eEe(t,dQe.HOSTED_SERVICE)}function Ekt(t,e){const r=t.typeKeywords;if(r){const i=r.indexOf(e);i>-1&&r.splice(i,1)}}async function Ckt(t){const e=t.clone().normalize();let r;if(e.length>1)for(const i of e)r?i.width>r.width&&(r=i):r=i;else r=e[0];return hQe(r)}const dQe={DEVELOPER_BASEMAP:"DeveloperBasemap",JSAPI:"ArcGIS API for JavaScript",METADATA:"Metadata",MULTI_LAYER:"Multilayer",SINGLE_LAYER:"Singlelayer",TABLE:"Table",HOSTED_SERVICE:"Hosted Service"};function cle(t){const{portal:e,isOrgItem:r,itemControl:i}=t,s=e.user?.privileges;let n=!s||s.includes("features:user:edit"),o=!!r&&!!s?.includes("features:user:fullEdit");const a=i==="update"||i==="admin";return a?o=n=!0:o&&(n=!0),{features:{edit:n,fullEdit:o},content:{updateItem:a}}}const tEe=t=>{let e=class extends t{constructor(){super(...arguments),this.resourceReferences={portalItem:null,paths:[]},this.userHasEditingPrivileges=!0,this.userHasFullEditingPrivileges=!1,this.userHasUpdateItemPrivileges=!1}destroy(){this.portalItem=Re(this.portalItem),this.resourceReferences.portalItem=null,this.resourceReferences.paths.length=0}set portalItem(r){r!==this._get("portalItem")&&(this.removeOrigin("portal-item"),this._set("portalItem",r))}readPortalItem(r,i,s){if(i.itemId)return new iT({id:i.itemId,portal:s&&s.portal})}writePortalItem(r,i){r&&r.id&&(i.itemId=r.id)}async loadFromPortal(r,i){if(this.portalItem&&this.portalItem.id)try{const{load:s}=await J(()=>import("./layersLoader-4ff997b9.js"),["./layersLoader-4ff997b9.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url);return Dt(i),await s({instance:this,supportedTypes:r.supportedTypes,validateItem:r.validateItem,supportsData:r.supportsData,layerModuleTypeMap:r.layerModuleTypeMap},i)}catch(s){throw ws(s)||K.getLogger(this).warn(`Failed to load layer (${this.title}, ${this.id}) portal item (${this.portalItem.id})
  ${s}`),s}}async finishLoadEditablePortalLayer(r){this._set("userHasEditingPrivileges",await this._fetchUserHasEditingPrivileges(r).catch(i=>(xa(i),!0)))}async _setUserPrivileges(r,i){if(!qr.userPrivilegesApplied)return this.finishLoadEditablePortalLayer(i);if(this.url)try{const{features:{edit:s,fullEdit:n},content:{updateItem:o}}=await this._fetchUserPrivileges(r,i);this._set("userHasEditingPrivileges",s),this._set("userHasFullEditingPrivileges",n),this._set("userHasUpdateItemPrivileges",o)}catch(s){xa(s)}}async _fetchUserPrivileges(r,i){let s=this.portalItem;if(!r||!s||!s.loaded||s.sourceUrl)return this._fetchFallbackUserPrivileges(i);const n=r===s.id;if(n&&s.portal.user)return cle(s);let o,a;if(n)o=s.portal.url;else try{o=await EK(this.url,i)}catch(p){xa(p)}if(!o||!mUe(o,s.portal.url))return this._fetchFallbackUserPrivileges(i);try{const p=i!=null?i.signal:null;a=await Gt?.getCredential(`${o}/sharing`,{prompt:!1,signal:p})}catch(p){xa(p)}const l=!0,c=!1,h=!1;if(!a)return{features:{edit:l,fullEdit:c},content:{updateItem:h}};try{if(n?await s.reload():(s=new iT({id:r,portal:{url:o}}),await s.load(i)),s.portal.user)return cle(s)}catch(p){xa(p)}return{features:{edit:l,fullEdit:c},content:{updateItem:h}}}async _fetchFallbackUserPrivileges(r){let i=!0;try{i=await this._fetchUserHasEditingPrivileges(r)}catch(s){xa(s)}return{features:{edit:i,fullEdit:!1},content:{updateItem:!1}}}async _fetchUserHasEditingPrivileges(r){const i=this.url?Gt?.findCredential(this.url):null;if(!i)return!0;const s=FL.credential===i?FL.user:await this._fetchEditingUser(r);return FL.credential=i,FL.user=s,s==null||s.privileges==null||s.privileges.includes("features:user:edit")}async _fetchEditingUser(r){const i=this.portalItem?.portal?.user;if(i)return i;const s=Gt.findServerInfo(this.url??"");if(!s?.owningSystemUrl)return null;const n=`${s.owningSystemUrl}/sharing/rest`,o=ao.getDefault();if(o&&o.loaded&&Dd(o.restUrl)===Dd(n))return o.user;const a=`${n}/community/self`,l=r!=null?r.signal:null,c=await Sh(Lt(a,{authMode:"no-prompt",query:{f:"json"},signal:l}));return c.ok?_K.fromJSON(c.value.data):null}read(r,i){i&&(i.layer=this),super.read(r,i)}write(r,i){const s=i&&i.portal,n=this.portalItem&&this.portalItem.id&&(this.portalItem.portal||ao.getDefault());return s&&n&&!dve(n.restUrl,s.restUrl)?(i.messages&&i.messages.push(new D("layer:cross-portal",`The layer '${this.title} (${this.id})' cannot be persisted because it refers to an item on a different portal than the one being saved to. To save, set layer.portalItem to null or save to the same portal as the item associated with the layer`,{layer:this})),null):super.write(r,{...i,layer:this})}};return u([d({type:iT})],e.prototype,"portalItem",null),u([Ae("web-document","portalItem",["itemId"])],e.prototype,"readPortalItem",null),u([Ve("web-document","portalItem",{itemId:{type:String}})],e.prototype,"writePortalItem",null),u([d({clonable:!1})],e.prototype,"resourceReferences",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasFullEditingPrivileges",void 0),u([d({type:Boolean,readOnly:!0})],e.prototype,"userHasUpdateItemPrivileges",void 0),e=u([R("esri.layers.mixins.PortalLayer")],e),e},FL={credential:null,user:null};let N3=class extends me{constructor(){super(...arguments),this.updating=!1,this.status="unknown"}};u([d()],N3.prototype,"updating",void 0),u([d()],N3.prototype,"status",void 0),N3=u([R("esri.layers.support.PublishingInfo")],N3);const pQe=N3,rEe="esri.layers.mixins.PublishableLayer",fQe=Symbol(rEe),mQe=t=>{var e;let r=class extends t{constructor(){super(...arguments),this[e]=!0}get publishingInfo(){if(this.destroyed)return null;const i=this._get("publishingInfo");if(i)return i;const s=new pQe;return this._checkPublishingStatus(s),s}_checkPublishingStatus(i){let o=0;const a=async c=>{let h;i.updating=!0;try{h=await this.fetchPublishingStatus()}catch{h="unavailable"}h!=="published"&&h!=="unavailable"||(i.status==="publishing"&&this.refresh(),l.remove()),i.status=h,i.updating=!1,l.removed||(o=setTimeout(a,c,c+125))},l={removed:!1,remove(){this.removed=!0,clearTimeout(o)}};this.when().catch(()=>l.remove()),a(250),this.own(l)}};return e=fQe,u([d({readOnly:!0,clonable:!1})],r.prototype,"publishingInfo",null),r=u([R(rEe)],r),r},iP=new Ke,YM=new WeakMap;function gQe(t){iEe(t)&&iP.push(t)}function yQe(t){iEe(t)&&iP.includes(t)&&iP.remove(t)}function iEe(t){return t!=null&&typeof t=="object"&&"refreshInterval"in t&&"refresh"in t}function sEe(t,e){return Number.isFinite(t)&&Number.isFinite(e)?e<=0?t:sEe(e,t%e):0}let sz=0,kL=0;function _Qe(){const t=Date.now();for(const e of iP)e.refreshInterval&&t-(YM.get(e)??0)+5>=6e4*e.refreshInterval&&(YM.set(e,t),e.refresh(t))}qve(()=>{const t=Date.now();let e=0;for(const r of iP)e=sEe(Math.round(6e4*r.refreshInterval),e),r.refreshInterval?YM.get(r)||YM.set(r,t):YM.delete(r);if(e!==kL){if(kL=e,clearInterval(sz),kL===0)return void(sz=0);sz=setInterval(_Qe,kL)}});function vQe(t){return t!=null&&typeof t=="object"&&"refreshTimestamp"in t&&"refresh"in t}const bQe=t=>{let e=class extends t{constructor(...r){super(...r),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=x1(()=>this.hasDataChanged()),this.when().then(()=>{this.destroyed||gQe(this)},()=>{})}destroy(){yQe(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(r=Date.now()){gC(this._debounceHasDataChanged()).then(i=>{i&&this._set("refreshTimestamp",r),this.emit("refresh",{dataChanged:i})},i=>{K.getLogger(this).error(i),this.emit("refresh",{dataChanged:!1,error:i})})}async hasDataChanged(){return!0}};return u([d({type:Number,cast:r=>r>=.1?r:r<=0?0:.1,json:{write:!0}})],e.prototype,"refreshInterval",void 0),u([d({readOnly:!0})],e.prototype,"refreshTimestamp",void 0),u([d()],e.prototype,"refreshParameters",null),e=u([R("esri.layers.mixins.RefreshableLayer")],e),e},xee=t=>{let e=class extends t{constructor(){super(...arguments),this.minScale=0,this.maxScale=0}get effectiveScaleRange(){const r={minScale:this.minScale,maxScale:this.maxScale},i=this.parent;i&&"effectiveScaleRange"in i&&wQe(r,i.effectiveScaleRange);const s=this._get("effectiveScaleRange");return s&&s.minScale===r.minScale&&s.maxScale===r.maxScale?s:r}};return u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"minScale",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],e.prototype,"maxScale",void 0),u([d({readOnly:!0})],e.prototype,"effectiveScaleRange",null),e=u([R("esri.layers.mixins.ScaleRangeLayer")],e),e};function wQe(t,e){return t.minScale=t.minScale>0?e.minScale>0?Math.min(t.minScale,e.minScale):t.minScale:e.minScale,t.maxScale=t.maxScale>0?e.maxScale>0?Math.max(t.maxScale,e.maxScale):t.maxScale:e.maxScale,t}const nEe=zl()({esriTimeUnitsMilliseconds:"milliseconds",esriTimeUnitsSeconds:"seconds",esriTimeUnitsMinutes:"minutes",esriTimeUnitsHours:"hours",esriTimeUnitsDays:"days",esriTimeUnitsWeeks:"weeks",esriTimeUnitsMonths:"months",esriTimeUnitsYears:"years",esriTimeUnitsDecades:"decades",esriTimeUnitsCenturies:"centuries",esriTimeUnitsUnknown:void 0});let F3=class extends rs(he){constructor(e){super(e),this.unit="milliseconds",this.value=0}toMilliseconds(){return DXe(this.value,this.unit,"milliseconds")}};u([nt(nEe,{nonNullable:!0})],F3.prototype,"unit",void 0),u([d({type:Number,json:{write:!0},nonNullable:!0})],F3.prototype,"value",void 0),F3=u([R("esri.TimeInterval")],F3);const kk=F3;function ule(t,e){return kk.fromJSON({value:t,unit:e})}let bl=class extends rs(he){constructor(e){super(e),this.cumulative=!1,this.endField=null,this.fullTimeExtent=null,this.hasLiveData=!1,this.interval=null,this.startField=null,this.timeReference=null,this.trackIdField=null,this.useTime=!0}readFullTimeExtent(e,r){if(!r.timeExtent||!Array.isArray(r.timeExtent)||r.timeExtent.length!==2)return null;const i=new Date(r.timeExtent[0]),s=new Date(r.timeExtent[1]);return new Ng({start:i,end:s})}writeFullTimeExtent(e,r){e&&e.start!=null&&e.end!=null?r.timeExtent=[e.start.getTime(),e.end.getTime()]:r.timeExtent=null}readInterval(e,r){return r.timeInterval&&r.timeIntervalUnits?ule(r.timeInterval,r.timeIntervalUnits):r.defaultTimeInterval&&r.defaultTimeIntervalUnits?ule(r.defaultTimeInterval,r.defaultTimeIntervalUnits):null}writeInterval(e,r){r.timeInterval=e?.toJSON().value??null,r.timeIntervalUnits=e?.toJSON().unit??null}};u([d({type:Boolean,json:{name:"exportOptions.timeDataCumulative",write:!0}})],bl.prototype,"cumulative",void 0),u([d({type:String,json:{name:"endTimeField",write:{enabled:!0,allowNull:!0}}})],bl.prototype,"endField",void 0),u([d({type:Ng,json:{write:{enabled:!0,allowNull:!0}}})],bl.prototype,"fullTimeExtent",void 0),u([Ae("fullTimeExtent",["timeExtent"])],bl.prototype,"readFullTimeExtent",null),u([Ve("fullTimeExtent")],bl.prototype,"writeFullTimeExtent",null),u([d({type:Boolean,json:{write:!0}})],bl.prototype,"hasLiveData",void 0),u([d({type:kk,json:{write:{enabled:!0,allowNull:!0}}})],bl.prototype,"interval",void 0),u([Ae("interval",["timeInterval","timeIntervalUnits","defaultTimeInterval","defaultTimeIntervalUnits"])],bl.prototype,"readInterval",null),u([Ve("interval")],bl.prototype,"writeInterval",null),u([d({type:String,json:{name:"startTimeField",write:{enabled:!0,allowNull:!0}}})],bl.prototype,"startField",void 0),u([d({type:fA,json:{write:{enabled:!0,allowNull:!0}}})],bl.prototype,"timeReference",void 0),u([d({type:String,json:{write:{enabled:!0,allowNull:!0}}})],bl.prototype,"trackIdField",void 0),u([d({type:Boolean,json:{name:"exportOptions.useTime",write:!0}})],bl.prototype,"useTime",void 0),bl=u([R("esri.layers.support.TimeInfo")],bl);const oEe=bl,xQe=t=>{let e=class extends t{constructor(){super(...arguments),this.timeExtent=null,this.timeOffset=null,this.useViewTime=!0}readOffset(r,i){const s=i.timeInfo.exportOptions;if(!s)return null;const n=s.timeOffset,o=nEe.fromJSON(s.timeOffsetUnits);return n&&o?new kk({value:n,unit:o}):null}set timeInfo(r){Abe(r,this.fieldsIndex),this._set("timeInfo",r)}};return u([d({type:Ng,json:{write:!1}})],e.prototype,"timeExtent",void 0),u([d({type:kk})],e.prototype,"timeOffset",void 0),u([Ae("service","timeOffset",["timeInfo.exportOptions"])],e.prototype,"readOffset",null),u([d({value:null,type:oEe,json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],e.prototype,"timeInfo",null),u([d({type:Boolean,json:{read:{source:"timeAnimation"},write:{target:"timeAnimation"},origins:{"web-scene":{read:!1,write:!1}}}})],e.prototype,"useViewTime",void 0),e=u([R("esri.layers.mixins.TemporalLayer")],e),e},hle=new kr({esriFeatureEditToolAutoCompletePolygon:"auto-complete-polygon",esriFeatureEditToolCircle:"circle",esriFeatureEditToolEllipse:"ellipse",esriFeatureEditToolFreehand:"freehand",esriFeatureEditToolLine:"line",esriFeatureEditToolNone:"none",esriFeatureEditToolPoint:"point",esriFeatureEditToolPolygon:"polygon",esriFeatureEditToolRectangle:"rectangle",esriFeatureEditToolArrow:"arrow",esriFeatureEditToolTriangle:"triangle",esriFeatureEditToolLeftArrow:"left-arrow",esriFeatureEditToolRightArrow:"right-arrow",esriFeatureEditToolUpArrow:"up-arrow",esriFeatureEditToolDownArrow:"down-arrow"});let ov=class extends rs(he){constructor(e){super(e),this.name=null,this.description=null,this.drawingTool=null,this.prototype=null,this.thumbnail=null}};u([d({json:{write:!0}})],ov.prototype,"name",void 0),u([d({json:{write:!0}})],ov.prototype,"description",void 0),u([d({json:{read:hle.read,write:hle.write}})],ov.prototype,"drawingTool",void 0),u([d({json:{write:!0}})],ov.prototype,"prototype",void 0),u([d({json:{write:!0}})],ov.prototype,"thumbnail",void 0),ov=u([R("esri.layers.support.FeatureTemplate")],ov);const Tee=ov;let Ey=class extends rs(he){constructor(e){super(e),this.id=null,this.name=null,this.domains=null,this.templates=null}readDomains(e){const r={};for(const i of Object.keys(e))r[i]=cV(e[i]);return r}writeDomains(e,r){const i={};for(const s of Object.keys(e))e[s]&&(i[s]=e[s]?.toJSON());r.domains=i}};u([d({json:{write:!0}})],Ey.prototype,"id",void 0),u([d({json:{write:!0}})],Ey.prototype,"name",void 0),u([d({json:{write:!0}})],Ey.prototype,"domains",void 0),u([Ae("domains")],Ey.prototype,"readDomains",null),u([Ve("domains")],Ey.prototype,"writeDomains",null),u([d({type:[Tee],json:{write:!0}})],Ey.prototype,"templates",void 0),Ey=u([R("esri.layers.support.FeatureType")],Ey);const aEe=Ey;function lEe(){return{fields:{type:[yV],value:null},fieldsIndex:{readOnly:!0,get(){return new BK(this.fields||[])}},outFields:{type:[String],json:{read:!1},set:function(t){this._userOutFields=t,this.notifyChange("outFields")},get:function(){const t=this._userOutFields;if(!t||!t.length)return null;if(t.includes("*"))return["*"];if(!this.fields)return t;for(const e of t)this.fieldsIndex?.has(e)||K.getLogger("esri.layers.support.fieldProperties").error("field-attributes-layer:invalid-field",`Invalid field ${e} found in outFields`,{layer:this,outFields:t});return KP(this.fieldsIndex,t)}}}}const nz=K.getLogger("esri.layers.support.labelingInfo"),TQe=/\[([^\[\]]+)\]/gi;function Uk(t,e,r){return t?t.map(i=>{const s=new g$;if(s.read(i,r),s.labelExpression){const n=e.fields||e.layerDefinition&&e.layerDefinition.fields||this.fields;s.labelExpression=s.labelExpression.replaceAll(TQe,(o,a)=>`[${SQe(a,n)}]`)}return s}):null}function SQe(t,e){if(!e)return t;const r=t.toLowerCase();for(let i=0;i<e.length;i++){const s=e[i].name;if(s.toLowerCase()===r)return s}return t}const EQe={esriGeometryPoint:["above-right","above-center","above-left","center-center","center-left","center-right","below-center","below-left","below-right"],esriGeometryPolygon:["always-horizontal"],esriGeometryPolyline:["center-along"],esriGeometryMultipoint:null};function Pkt(t,e){const r=re(t);return r.some(i=>CQe(i,e))?[]:r}function CQe(t,e){const r=t.labelPlacement,i=EQe[e];if(!t.symbol)return nz.warn("No ILabelClass symbol specified."),!0;if(!i)return nz.error(new D("labeling:unsupported-geometry-type",`Unable to create labels for layer, geometry type '${e}' is not supported`)),!0;if(!i.includes(r)){const s=i[0];r&&nz.warn(`Found invalid label placement type ${r} for ${e}. Defaulting to ${s}`),t.labelPlacement=s}return!1}const Lp=[];function AQe(t,e){if(LK(t.url??""))return!0;const{wkid:r}=e;for(const i of Lp){if((t.version??0)>=i[0])return!0;if(typeof i[1]=="function"&&(i[1]=i[1]()),i[1].has(r))return!1}return!0}Lp.push([10.91,()=>{const t=new Set([9709,9716,9741,9761,9766]);for(let e=9712;e<=9713;e++)t.add(e);for(let e=9748;e<=9749;e++)t.add(e);for(let e=20904;e<=20932;e++)t.add(e);for(let e=21004;e<=21032;e++)t.add(e);for(let e=21207;e<=21264;e++)t.add(e);for(let e=21307;e<=21364;e++)t.add(e);for(let e=102759;e<=102760;e++)t.add(e);for(let e=102901;e<=102955;e++)t.add(e);return t}]),Lp.push([10.9,()=>{const t=new Set([9300,9354,9364,9367,9373,9377,9387,9456,9473,9498,9678,9680,29874,103599,103872,104028]);for(let e=9356;e<=9360;e++)t.add(e);for(let e=9404;e<=9407;e++)t.add(e);for(let e=9476;e<=9482;e++)t.add(e);for(let e=9487;e<=9494;e++)t.add(e);for(let e=9697;e<=9699;e++)t.add(e);return t}]),Lp.push([10.81,()=>{const t=new Set([9265,9333,103598,103699]);for(let e=9248;e<=9254;e++)t.add(e);for(let e=9271;e<=9273;e++)t.add(e);for(let e=9284;e<=9285;e++)t.add(e);for(let e=21453;e<=21463;e++)t.add(e);return t}]),Lp.push([10.8,()=>{const t=new Set([8088,8395,8428,8433,8531,8687,8692,8694,8699,8900,9003,9006,9009,9012,9017,9191]);for(let e=8035;e<=8036;e++)t.add(e);for(let e=8455;e<=8456;e++)t.add(e);for(let e=8518;e<=8529;e++)t.add(e);for(let e=8533;e<=8536;e++)t.add(e);for(let e=8538;e<=8540;e++)t.add(e);for(let e=8677;e<=8679;e++)t.add(e);for(let e=8902;e<=8903;e++)t.add(e);for(let e=8907;e<=8910;e++)t.add(e);for(let e=8949;e<=8951;e++)t.add(e);for(let e=8972;e<=8987;e++)t.add(e);for(let e=9039;e<=9040;e++)t.add(e);for(let e=9068;e<=9069;e++)t.add(e);for(let e=9140;e<=9141;e++)t.add(e);for(let e=9148;e<=9150;e++)t.add(e);for(let e=9153;e<=9159;e++)t.add(e);for(let e=9205;e<=9218;e++)t.add(e);for(let e=9221;e<=9222;e++)t.add(e);for(let e=54098;e<=54101;e++)t.add(e);return t}]),Lp.push([10.71,()=>{const t=new Set([6316]);for(let e=8351;e<=8353;e++)t.add(e);for(let e=9294;e<=9297;e++)t.add(e);for(let e=22619;e<=22621;e++)t.add(e);for(let e=103586;e<=103594;e++)t.add(e);return t}]),Lp.push([10.7,()=>{const t=new Set([8387,8391,8427,8545,8682,8685,8818,31370,104022,104024,104975]);for(let e=8065;e<=8068;e++)t.add(e);for(let e=8082;e<=8083;e++)t.add(e);for(let e=8379;e<=8385;e++)t.add(e);for(let e=8836;e<=8840;e++)t.add(e);for(let e=8857;e<=8860;e++)t.add(e);for(let e=53035;e<=53037;e++)t.add(e);for(let e=54090;e<=54091;e++)t.add(e);for(let e=102498;e<=102499;e++)t.add(e);return t}]),Lp.push([10.61,()=>new Set([102497])]),Lp.push([10.6,()=>{const t=new Set([7803,7805,7887,8086,8232,8237,8240,8246,8249,8252,8255,9019,9391]);for(let e=7755;e<=7787;e++)t.add(e);for(let e=7791;e<=7795;e++)t.add(e);for(let e=7799;e<=7801;e++)t.add(e);for(let e=7825;e<=7831;e++)t.add(e);for(let e=7877;e<=7878;e++)t.add(e);for(let e=7882;e<=7883;e++)t.add(e);for(let e=7991;e<=7992;e++)t.add(e);for(let e=8042;e<=8043;e++)t.add(e);for(let e=8058;e<=8059;e++)t.add(e);for(let e=8311;e<=8348;e++)t.add(e);for(let e=9060;e<=9067;e++)t.add(e);for(let e=102562;e<=102568;e++)t.add(e);for(let e=102799;e<=102900;e++)t.add(e);return t}]),Lp.push([10.51,()=>{const t=new Set([7683,7881,7886,7899,8888,9e3]);for(let e=8013;e<=8032;e++)t.add(e);for(let e=9053;e<=9057;e++)t.add(e);for(let e=104017;e<=104018;e++)t.add(e);for(let e=104971;e<=104974;e++)t.add(e);return t}]),Lp.push([10.5,()=>{const t=new Set([6962,7035,7037,7039,7041,7084,7086,7133,7798,102399]);for(let e=4087;e<=4088;e++)t.add(e);for(let e=5896;e<=5899;e++)t.add(e);for(let e=7005;e<=7007;e++)t.add(e);for(let e=7057;e<=7070;e++)t.add(e);for(let e=7073;e<=7082;e++)t.add(e);for(let e=7109;e<=7128;e++)t.add(e);for(let e=7844;e<=7859;e++)t.add(e);return t}]);async function cEe(t,e,r){const i=t&&t.getAtOrigin&&t.getAtOrigin("renderer",e.origin);if(i&&i.type==="unique-value"&&i.styleOrigin){const s=await Sh(i.populateFromStyle());if(Dt(r),s.ok===!1){const n=s.error;e&&e.messages&&e.messages.push(new Bd("renderer:style-reference",`Failed to create unique value renderer from style reference: ${n.message}`,{error:n,context:e})),t.clear("renderer",e?.origin)}}}var LW;let dE=LW=class extends he{constructor(t){super(t),this.groupByFields=void 0,this.topCount=void 0,this.orderByFields=void 0}clone(){return new LW({groupByFields:this.groupByFields,topCount:this.topCount,orderByFields:this.orderByFields})}};u([d({type:[String],json:{write:!0}})],dE.prototype,"groupByFields",void 0),u([d({type:Number,json:{write:!0}})],dE.prototype,"topCount",void 0),u([d({type:[String],json:{write:!0}})],dE.prototype,"orderByFields",void 0),dE=LW=u([R("esri.rest.support.TopFilter")],dE);const OQe=dE;var DW;const dle=new kr({esriSpatialRelIntersects:"intersects",esriSpatialRelContains:"contains",esriSpatialRelCrosses:"crosses",esriSpatialRelDisjoint:"disjoint",esriSpatialRelEnvelopeIntersects:"envelope-intersects",esriSpatialRelIndexIntersects:"index-intersects",esriSpatialRelOverlaps:"overlaps",esriSpatialRelTouches:"touches",esriSpatialRelWithin:"within",esriSpatialRelRelation:"relation"}),ple=new kr({esriSRUnit_Meter:"meters",esriSRUnit_Kilometer:"kilometers",esriSRUnit_Foot:"feet",esriSRUnit_StatuteMile:"miles",esriSRUnit_NauticalMile:"nautical-miles",esriSRUnit_USNauticalMile:"us-nautical-miles"});let Ls=DW=class extends he{constructor(t){super(t),this.cacheHint=void 0,this.distance=void 0,this.geometry=null,this.geometryPrecision=void 0,this.maxAllowableOffset=void 0,this.num=void 0,this.objectIds=null,this.orderByFields=null,this.outFields=null,this.outSpatialReference=null,this.resultType=null,this.returnGeometry=!1,this.returnM=void 0,this.returnZ=void 0,this.start=void 0,this.spatialRelationship="intersects",this.timeExtent=null,this.topFilter=void 0,this.units=null,this.where="1=1"}writeStart(t,e){e.resultOffset=this.start,e.resultRecordCount=this.num||10}clone(){return new DW(re({cacheHint:this.cacheHint,distance:this.distance,geometry:this.geometry,geometryPrecision:this.geometryPrecision,maxAllowableOffset:this.maxAllowableOffset,num:this.num,objectIds:this.objectIds,orderByFields:this.orderByFields,outFields:this.outFields,outSpatialReference:this.outSpatialReference,resultType:this.resultType,returnGeometry:this.returnGeometry,returnZ:this.returnZ,returnM:this.returnM,start:this.start,spatialRelationship:this.spatialRelationship,timeExtent:this.timeExtent,topFilter:this.topFilter,units:this.units,where:this.where}))}};u([d({type:Boolean,json:{write:!0}})],Ls.prototype,"cacheHint",void 0),u([d({type:Number,json:{write:{overridePolicy:t=>({enabled:t>0})}}})],Ls.prototype,"distance",void 0),u([d({types:nS,json:{read:N1,write:!0}})],Ls.prototype,"geometry",void 0),u([d({type:Number,json:{write:!0}})],Ls.prototype,"geometryPrecision",void 0),u([d({type:Number,json:{write:!0}})],Ls.prototype,"maxAllowableOffset",void 0),u([d({type:Number,json:{read:{source:"resultRecordCount"}}})],Ls.prototype,"num",void 0),u([d({json:{write:!0}})],Ls.prototype,"objectIds",void 0),u([d({type:[String],json:{write:!0}})],Ls.prototype,"orderByFields",void 0),u([d({type:[String],json:{write:!0}})],Ls.prototype,"outFields",void 0),u([d({type:qe,json:{read:{source:"outSR"},write:{target:"outSR"}}})],Ls.prototype,"outSpatialReference",void 0),u([d({type:String,json:{write:!0}})],Ls.prototype,"resultType",void 0),u([d({json:{write:!0}})],Ls.prototype,"returnGeometry",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Ls.prototype,"returnM",void 0),u([d({type:Boolean,json:{write:{overridePolicy:t=>({enabled:t})}}})],Ls.prototype,"returnZ",void 0),u([d({type:Number,json:{read:{source:"resultOffset"}}})],Ls.prototype,"start",void 0),u([Ve("start"),Ve("num")],Ls.prototype,"writeStart",null),u([d({type:String,json:{read:{source:"spatialRel",reader:dle.read},write:{target:"spatialRel",writer:dle.write}}})],Ls.prototype,"spatialRelationship",void 0),u([d({type:Ng,json:{write:!0}})],Ls.prototype,"timeExtent",void 0),u([d({type:OQe,json:{write:!0}})],Ls.prototype,"topFilter",void 0),u([d({type:String,json:{read:ple.read,write:{writer:ple.write,overridePolicy(t){return{enabled:t!=null&&this.distance!=null&&this.distance>0}}}}})],Ls.prototype,"units",void 0),u([d({type:String,json:{write:!0}})],Ls.prototype,"where",void 0),Ls=DW=u([R("esri.rest.support.TopFeaturesQuery")],Ls),Ls.from=Sn(Ls);const UL=Ls;function uEe({displayField:t,editFieldsInfo:e,fields:r,objectIdField:i,title:s},n){if(!r)return null;const o=PQe({editFieldsInfo:e,fields:r,objectIdField:i},n);if(!o.length)return null;const a=DQe({titleBase:s,fields:r,displayField:t}),l=LQe();return new aO({title:a,content:l,fieldInfos:o})}const RQe=(t,e)=>e.visibleFieldNames?e.visibleFieldNames.has(t.name):Mbe(t,e);function MQe(t,e){const r=t;return e&&(t=t.filter(i=>!e.includes(i.type))),t===r&&(t=t.slice()),t.sort(IQe),t}function IQe(t,e){return t.type==="oid"?-1:e.type==="oid"?1:fle(t)?-1:fle(e)?1:(t.alias||t.name).toLocaleLowerCase().localeCompare((e.alias||e.name).toLocaleLowerCase())}function PQe(t,e){const r=e?.visibleFieldNames;return MQe(t.fields??[],e?.ignoreFieldTypes||NQe).map(i=>new lK({fieldName:i.name,isEditable:uze(i,t),label:i.alias,format:$Qe(i),visible:RQe(i,{...t,visibleFieldNames:r})}))}function $Qe(t){switch(t.type){case"small-integer":case"integer":case"single":return new qE({digitSeparator:!0,places:0});case"double":return new qE({digitSeparator:!0,places:2});case"date":return new qE({dateFormat:"long-month-day-year"});default:return t.type==="string"&&x7(t.name)?new qE({digitSeparator:!0,places:0}):null}}function LQe(){return[new XI,new ZI]}function DQe(t){const e=HQ(t),{titleBase:r}=t;return e?`${r}: {${e.trim()}}`:r??""}function fle(t){return(t.name&&t.name.toLowerCase())==="name"?!0:(t.alias&&t.alias.toLowerCase())==="name"}const NQe=["geometry","blob","raster","guid","xml"],jl="FeatureLayer",hEe="esri.layers.FeatureLayer",FQe=K.getLogger(hEe);function VL(t,e){return new D("layer:unsupported",`Layer (${t.title}, ${t.id}) of type '${t.declaredClass}' ${e}`,{layer:t})}function mle(t){return t&&t instanceof Ke}const oz=lEe();function az(t,e,r){const i=!!r?.writeLayerSchema;return{enabled:i,ignoreOrigin:i}}let mt=class extends kYe(OJe(qXe(mQe(QSe(ZSe(PJe(xQe(xee(bQe(ESe(x2e(tEe(YK(PXe(SSe(rs(gV))))))))))))))))){constructor(...e){super(...e),this._handles=new li,this.charts=null,this.copyright=null,this.displayField=null,this.dynamicDataSource=null,this.fields=null,this.fieldsIndex=null,this.formTemplate=null,this.fullExtent=null,this.geometryType=null,this.hasM=void 0,this.hasZ=void 0,this.infoFor3D=null,this.isTable=!1,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.objectIdField=null,this.outFields=null,this.path=null,this.popupEnabled=!0,this.popupTemplate=null,this.screenSizePerspectiveEnabled=!0,this.spatialReference=qe.WGS84,this.subtypeCode=null,this.templates=null,this.timeInfo=null,this.title=null,this.sublayerTitleMode="item-title",this.type="feature",this.typeIdField=null,this.types=null,this.visible=!0}destroy(){this.source?.destroy(),this._handles=Re(this._handles)}normalizeCtorArgs(e,r){return typeof e=="string"?{url:e,...r}:e}load(e){const r=e!=null?e.signal:null;if(this.portalItem?.loaded&&this.source)return this.addResolvingPromise(this.createGraphicsSource(r).then(s=>this.initLayerProperties(s))),Promise.resolve(this);const i=this.loadFromPortal({supportedTypes:["Feature Service","Feature Collection"]},e).catch(xa).then(async()=>{if(this.url&&this.layerId==null&&/FeatureServer|MapServer\/*$/i.test(this.url)){const s=await this._fetchFirstLayerId(r);s!=null&&(this.layerId=s)}if(!this.url&&!this._hasMemorySource())throw new D("feature-layer:missing-url-or-source","Feature layer must be created with either a url or a source");return this.initLayerProperties(await this.createGraphicsSource(r))}).then(()=>this._setUserPrivileges(this.serviceItemId,e)).then(()=>xYe(this,e));return this.addResolvingPromise(i),Promise.resolve(this)}readCapabilities(e,r){return r=r.layerDefinition||r,p2e(r,this.url)}get createQueryVersion(){return this.commitProperty("definitionExpression"),this.commitProperty("dynamicDataSource"),this.commitProperty("timeExtent"),this.commitProperty("timeOffset"),this.commitProperty("geometryType"),this.commitProperty("gdbVersion"),this.commitProperty("historicMoment"),this.commitProperty("returnZ"),this.commitProperty("capabilities"),this.commitProperty("returnM"),(this._get("createQueryVersion")??0)+1}get editingEnabled(){return!(this.loaded&&!this.capabilities?.operations.supportsEditing)&&(this._isOverridden("editingEnabled")?this._get("editingEnabled"):this._hasMemorySource()||this.userHasEditingPrivileges)}set editingEnabled(e){this._overrideIfSome("editingEnabled",e)}readEditingEnabled(e,r){return this._readEditingEnabled(r,!1)}readEditingEnabledFromWebMap(e,r,i){return this._readEditingEnabled(r,!0,i)}writeEditingEnabled(e,r){this._writeEditingEnabled(e,r,!1)}writeEditingEnabledToWebMap(e,r,i,s){this._writeEditingEnabled(e,r,!0,s)}get effectiveEditingEnabled(){return SYe(this)}readIsTable(e,r){return(r=r?.layerDefinition??r).type==="Table"||!r.geometryType}writeIsTable(e,r,i,s){s?.writeLayerSchema&&Ul(i,e?"Table":"Feature Layer",r)}readGlobalIdField(e,r){return c2e(r.layerDefinition||r)}readObjectIdField(e,r){return u2e(r.layerDefinition||r)}get parsedUrl(){const e=Fn(this.url);return e!=null&&(this.dynamicDataSource!=null?e.path=Cu(e.path,"dynamicLayer"):this.layerId!=null&&(e.path=Cu(e.path,this.layerId.toString()))),e}get defaultPopupTemplate(){return this.createPopupTemplate()}set renderer(e){ak(e,this.fieldsIndex),this._set("renderer",e)}readRenderer(e,r,i){r=r.layerDefinition||r;const s=r.drawingInfo?.renderer;if(s){const n=KI(s,r,i)??void 0;return n||FQe.error("Failed to create renderer",{rendererDefinition:r.drawingInfo.renderer,layer:this,context:i}),n}return aee(r,i)}set source(e){const r=this._get("source");r!==e&&(mle(r)&&this._resetMemorySource(r),mle(e)&&this._initMemorySource(e),this._set("source",e))}castSource(e){return e?Array.isArray(e)||e instanceof Ke?new Uy({layer:this,items:e}):e:null}readSource(e,r){const i=QK.fromJSON(r.featureSet);return new Uy({layer:this,items:i?.features??[]})}readTemplates(e,r){const i=r.editFieldsInfo,s=i&&i.creatorField,n=i&&i.editorField;return e=e&&e.map(o=>Tee.fromJSON(o)),this._fixTemplates(e,s),this._fixTemplates(e,n),e}readTitle(e,r){const i=r.layerDefinition?.name??r.name,s=r.title||r.layerDefinition&&r.layerDefinition.title;if(i){const n=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return this.url?bTe(this.url,i):i;let o=i;if(!o&&this.url){const a=sg(this.url);a!=null&&(o=a.title)}return o?(this.sublayerTitleMode==="item-title-and-service-name"&&n&&n!==o&&(o=n+" - "+o),hV(o)):void 0}if(this.sublayerTitleMode==="item-title"&&s)return s}readTitleFromWebMap(e,r){return r.title||r.layerDefinition&&r.layerDefinition.name}readTypeIdField(e,r){let i=(r=r.layerDefinition||r).typeIdField;if(i&&r.fields){i=i.toLowerCase();const s=r.fields.find(n=>n.name.toLowerCase()===i);s&&(i=s.name)}return i}readTypes(e,r){e=(r=r.layerDefinition||r).types;const i=r.editFieldsInfo,s=i&&i.creatorField,n=i&&i.editorField;return e&&e.map(o=>(o=aEe.fromJSON(o),this._fixTemplates(o.templates,s),this._fixTemplates(o.templates,n),o))}readVisible(e,r){return r.layerDefinition&&r.layerDefinition.defaultVisibility!=null?!!r.layerDefinition.defaultVisibility:r.visibility!=null?!!r.visibility:void 0}async addAttachment(e,r){return oYe(this,e,r,jl)}async updateAttachment(e,r,i){return aYe(this,e,r,i,jl)}async applyEdits(e,r){return lYe(this,e,r)}async uploadAssets(e,r){return cYe(this,e,r)}on(e,r){return super.on(e,r)}createPopupTemplate(e){return uEe(this,e)}async createGraphicsSource(e){if(this._hasMemorySource()&&this.source)return this.source.load({signal:e});const{default:r}=await gT(J(()=>import("./FeatureLayerSource-1d48fd0a.js"),["./FeatureLayerSource-1d48fd0a.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./External-c5063428.js","./editingSupport-3a0009ce.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./clientSideDefaults-b46e59ef.js","./QueryEngineCapabilities-42e44ded.js","./QueryTask-a85d5ddb.js","./executeForIds-a998c013.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./executeQueryJSON-d846aaae.js","./executeQueryPBF-2d539c14.js"],import.meta.url),e);return new r({layer:this}).load({signal:e})}createQuery(){const e=vYe(this);e.dynamicDataSource=this.dynamicDataSource;const r=this.subtypeCode!=null?`${this.subtypeField} = ${this.subtypeCode}`:null,i=XWe(this.definitionExpression,r);return e.where=i||"1=1",e}async deleteAttachments(e,r){return uYe(this,e,r,jl)}async fetchRecomputedExtents(e){return hYe(this,e,jl)}getFeatureType(e){const{typeIdField:r,types:i}=this;if(!r||!e)return null;const s=e.attributes?e.attributes[r]:void 0;if(s==null)return null;let n=null;return i?.some(o=>{const{id:a}=o;return a!=null&&(a.toString()===s.toString()&&(n=o),!!n)}),n}getFieldDomain(e,r){const i=r?.feature,s=this.getFeatureType(i);if(s){const n=s.domains&&s.domains[e];if(n&&n.type!=="inherited")return n}return this._getLayerDomain(e)}getField(e){return this.fieldsIndex.get(e)}async queryAttachments(e,r){return dYe(this,e,r,jl)}async queryFeatures(e,r){const i=await this.load(),s=await i.source.queryFeatures(cb.from(e)??i.createQuery(),r);if(s?.features)for(const n of s.features)n.layer=n.sourceLayer=i;return s}async queryObjectIds(e,r){return pYe(this,e,r,jl)}async queryFeatureCount(e,r){return fYe(this,e,r,jl)}async queryExtent(e,r){return mYe(this,e,r,jl)}async queryRelatedFeatures(e,r){return gYe(this,e,r,jl)}async queryRelatedFeaturesCount(e,r){return yYe(this,e,r,jl)}async queryTopFeatures(e,r){const{source:i,capabilities:s}=await this.load();if(!i.queryTopFeatures||!s?.query?.supportsTopFeaturesQuery)throw new D(jl,"Layer source does not support queryTopFeatures capability");const n=await i.queryTopFeatures(UL.from(e),r);if(n?.features)for(const o of n.features)o.layer=o.sourceLayer=this;return n}async queryTopObjectIds(e,r){const{source:i,capabilities:s}=await this.load();if(!i.queryTopObjectIds||!s?.query.supportsTopFeaturesQuery)throw new D(jl,"Layer source does not support queryTopObjectIds capability");return i.queryTopObjectIds(UL.from(e),r)}async queryTopFeaturesExtent(e,r){const{source:i,capabilities:s}=await this.load();if(!i.queryTopExtents||!s?.query?.supportsTopFeaturesQuery)throw new D(jl,"Layer source does not support queryTopExtents capability");return i.queryTopExtents(UL.from(e),r)}async queryTopFeatureCount(e,r){const{source:i,capabilities:s}=await this.load();if(!i.queryTopCount||!s?.query?.supportsTopFeaturesQuery)throw new D(jl,"Layer source does not support queryFeatureCount capability");return i.queryTopCount(UL.from(e),r)}read(e,r){const i=e.featureCollection;if(i){const s=i.layers;s&&s.length===1&&(super.read(s[0],r),i.showLegend!=null&&super.read({showLegend:i.showLegend},r))}super.read(e,r),r&&r.origin==="service"&&(this.revert(["objectIdField","fields","timeInfo"],"service"),this.spatialReference||this.revert(["spatialReference"],"service"))}write(e,r){r={...r,origin:r?.origin??void 0,writeLayerSchema:r?.writeLayerSchema??this._hasMemorySource()};const{origin:i,layerContainerType:s,messages:n}=r;if(this.dynamicDataSource)return n?.push(VL(this,"using a dynamic data source cannot be written to web scenes, web maps and feature service items")),null;if(this.isTable){if(i==="web-scene"||i==="web-map"&&s!=="tables")return n?.push(VL(this,"using a table source cannot be written to web scenes and web maps")),null;if(this._hasMemorySource())return n?.push(VL(this,"using an in-memory table source cannot be written to web scenes and web maps")),null}else if(this.loaded&&i==="web-map"&&s==="tables")return n?.push(VL(this,"using a non-table source cannot be written to tables in web maps")),null;return super.write(e,r)}clone(){if(this._hasMemorySource())throw new D(jl,`FeatureLayer (title: ${this.title}, id: ${this.id}) created using in-memory source cannot be cloned`);return super.clone()}serviceSupportsSpatialReference(e){return!!this.loaded&&(this.source?.type==="memory"||AQe(this,e))}async save(e){const{save:r}=await J(()=>import("./featureLayerUtils-dc985c01.js"),["./featureLayerUtils-dc985c01.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url);return r(this,e)}async saveAs(e,r){const{saveAs:i}=await J(()=>import("./featureLayerUtils-dc985c01.js"),["./featureLayerUtils-dc985c01.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url);return i(this,e,r)}_readEditingEnabled(e,r,i){let s=e.layerDefinition?.capabilities;return s?this._hasEditingCapability(s):(s=e.capabilities,r&&i?.origin==="web-map"&&!this._hasMemorySource()&&s?this._hasEditingCapability(s):void 0)}_hasEditingCapability(e){return e.toLowerCase().split(",").map(r=>r.trim()).includes("editing")}_writeEditingEnabled(e,r,i,s){if(!e){const n=this.capabilities?.operations?.supportsSync?"Query,Sync":"Query";Ul("layerDefinition.capabilities",n,r),i&&!s?.writeLayerSchema&&(r.capabilities=n)}}_getLayerDomain(e){const r=this.fieldsIndex.get(e);return r?r.domain:null}_fetchFirstLayerId(e){return Lt(this.url,{query:{f:"json",...this.customParameters,token:this.apiKey},responseType:"json",signal:e}).then(r=>{const i=r.data;if(i)return Array.isArray(i.layers)&&i.layers.length>0?i.layers[0].id:Array.isArray(i.tables)&&i.tables.length>0?i.tables[0].id:void 0})}async initLayerProperties(e){return this._set("source",e),e.sourceJSON&&(this.sourceJSON=e.sourceJSON,this.read(e.sourceJSON,{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl})),this._verifySource(),this._verifyFields(),ak(this.renderer,this.fieldsIndex),Abe(this.timeInfo,this.fieldsIndex),cEe(this,{origin:"service"})}async hasDataChanged(){return _Ye(this)}async fetchPublishingStatus(){const e=this.source;return e?.fetchPublishingStatus?e.fetchPublishingStatus():"unavailable"}_verifyFields(){const e=this.parsedUrl?.path??"undefined";this.objectIdField||console.log("FeatureLayer: 'objectIdField' property is not defined (url: "+e+")"),this.isTable||this._hasMemorySource()||e.search(/\/FeatureServer\//i)!==-1||this.fields?.some(r=>r.type==="geometry")||console.log("FeatureLayer: unable to find field of type 'geometry' in the layer 'fields' list. If you are using a map service layer, features will not have geometry (url: "+e+")")}_fixTemplates(e,r){e&&e.forEach(i=>{const s=i.prototype&&i.prototype.attributes;s&&r&&delete s[r]})}_verifySource(){if(this._hasMemorySource()){if(this.url)throw new D("feature-layer:mixed-source-and-url","FeatureLayer cannot be created with both an in-memory source and a url")}else if(!this.url)throw new D("feature-layer:source-or-url-required","FeatureLayer requires either a url, a valid portal item or a source")}_initMemorySource(e){e.forEach(r=>{r.layer=this,r.sourceLayer=this}),this._handles.add([e.on("after-add",r=>{r.item.layer=this,r.item.sourceLayer=this}),e.on("after-remove",r=>{r.item.layer=null,r.item.sourceLayer=null})],"fl-source")}_resetMemorySource(e){e.forEach(r=>{r.layer=null,r.sourceLayer=null}),this._handles.remove("fl-source")}_hasMemorySource(){return!(this.url||!this.source)}};u([Ae("service","capabilities")],mt.prototype,"readCapabilities",null),u([d({json:{origins:{"portal-item":{write:!0},"web-map":{write:!0}}}})],mt.prototype,"charts",void 0),u([d({readOnly:!0})],mt.prototype,"createQueryVersion",null),u([d({json:{read:{source:"layerDefinition.copyrightText"}}})],mt.prototype,"copyright",void 0),u([d({json:{read:{source:"layerDefinition.displayField"}}})],mt.prototype,"displayField",void 0),u([d({types:uf,readOnly:!0})],mt.prototype,"defaultSymbol",void 0),u([d({type:Kp})],mt.prototype,"dynamicDataSource",void 0),u([d({type:Boolean})],mt.prototype,"editingEnabled",null),u([Ae(["portal-item","web-scene"],"editingEnabled",["layerDefinition.capabilities"])],mt.prototype,"readEditingEnabled",null),u([Ae("web-map","editingEnabled",["capabilities","layerDefinition.capabilities"])],mt.prototype,"readEditingEnabledFromWebMap",null),u([Ve(["portal-item","web-scene"],"editingEnabled",{"layerDefinition.capabilities":{type:String}})],mt.prototype,"writeEditingEnabled",null),u([Ve("web-map","editingEnabled",{capabilities:{type:String},"layerDefinition.capabilities":{type:String}})],mt.prototype,"writeEditingEnabledToWebMap",null),u([d({readOnly:!0})],mt.prototype,"effectiveEditingEnabled",null),u([d({...oz.fields,json:{read:{source:"layerDefinition.fields"},origins:{service:{name:"fields"},"web-map":{write:{target:"layerDefinition.fields",overridePolicy:az}}}}})],mt.prototype,"fields",void 0),u([d(oz.fieldsIndex)],mt.prototype,"fieldsIndex",void 0),u([d({type:gTe,json:{name:"formInfo",write:!0,origins:{"web-scene":{read:!1,write:!1}}}})],mt.prototype,"formTemplate",void 0),u([d({json:{read:{source:"layerDefinition.extent"}}})],mt.prototype,"fullExtent",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.geometryType",overridePolicy:az,writer(t,e,r){const i=t?lW.toJSON(t):null;i&&Ul(r,i,e)}}}},read:{source:"layerDefinition.geometryType",reader:lW.read}}})],mt.prototype,"geometryType",void 0),u([d({json:{read:{source:"layerDefinition.hasM"}}})],mt.prototype,"hasM",void 0),u([d({json:{read:{source:"layerDefinition.hasZ"}}})],mt.prototype,"hasZ",void 0),u([d(a2e)],mt.prototype,"id",void 0),u([d({readOnly:!0,json:{origins:{service:{read:!0}},read:!1}})],mt.prototype,"infoFor3D",void 0),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.type"}}}}})],mt.prototype,"isTable",void 0),u([Ae("service","isTable",["type","geometryType"]),Ae("isTable",["layerDefinition.type","layerDefinition.geometryType"])],mt.prototype,"readIsTable",null),u([Ve("web-map","isTable")],mt.prototype,"writeIsTable",null),u([d(EV)],mt.prototype,"labelsVisible",void 0),u([d({type:[g$],json:{origins:{service:{read:{source:"drawingInfo.labelingInfo",reader:Uk},write:{target:"drawingInfo.labelingInfo",enabled:!1}}},read:{source:"layerDefinition.drawingInfo.labelingInfo",reader:Uk},write:{target:"layerDefinition.drawingInfo.labelingInfo"}}})],mt.prototype,"labelingInfo",void 0),u([d((()=>{const t=re(KXe);return t.json.origins["portal-item"]={write:{target:"layerDefinition.drawingInfo.transparency",writer(e,r,i){Ul(i,Q6(e),r)}}},t})())],mt.prototype,"opacity",void 0),u([d(s2e)],mt.prototype,"legendEnabled",void 0),u([d({type:["show","hide"],json:(()=>{const t=re(l2e.json);return t.origins["portal-item"]={read:!1,write:!1},t})()})],mt.prototype,"listMode",void 0),u([Ae("globalIdField",["layerDefinition.globalIdField","layerDefinition.fields"])],mt.prototype,"readGlobalIdField",null),u([d({json:{origins:{"web-map":{write:{target:"layerDefinition.objectIdField",overridePolicy:az}}}}})],mt.prototype,"objectIdField",void 0),u([Ae("objectIdField",["layerDefinition.objectIdField","layerDefinition.fields"])],mt.prototype,"readObjectIdField",null),u([d({value:"ArcGISFeatureLayer",type:["ArcGISFeatureLayer"]})],mt.prototype,"operationalLayerType",void 0),u([d(oz.outFields)],mt.prototype,"outFields",void 0),u([d({readOnly:!0})],mt.prototype,"parsedUrl",null),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],mt.prototype,"path",void 0),u([d(SV)],mt.prototype,"popupEnabled",void 0),u([d({type:aO,json:{name:"popupInfo",write:!0}})],mt.prototype,"popupTemplate",void 0),u([d({readOnly:!0})],mt.prototype,"defaultPopupTemplate",null),u([d({types:mV,json:{origins:{service:{write:{target:"drawingInfo.renderer",enabled:!1}},"web-scene":{types:mSe,name:"layerDefinition.drawingInfo.renderer",write:{overridePolicy:(t,e,r)=>({ignoreOrigin:r?.writeLayerSchema})}}},write:{target:"layerDefinition.drawingInfo.renderer",overridePolicy:(t,e,r)=>({ignoreOrigin:r?.writeLayerSchema})}}})],mt.prototype,"renderer",null),u([Ae("service","renderer",["drawingInfo.renderer","defaultSymbol"]),Ae("renderer",["layerDefinition.drawingInfo.renderer","layerDefinition.defaultSymbol"])],mt.prototype,"readRenderer",null),u([d((()=>{const t=re(r2e);return t.json.origins["portal-item"]={read:!1,write:!1},t})())],mt.prototype,"screenSizePerspectiveEnabled",void 0),u([d({clonable:!1})],mt.prototype,"source",null),u([or("source")],mt.prototype,"castSource",null),u([Ae("portal-item","source",["featureSet"]),Ae("web-map","source",["featureSet"])],mt.prototype,"readSource",null),u([d({json:{read:{source:"layerDefinition.extent.spatialReference"}}})],mt.prototype,"spatialReference",void 0),u([d({type:Number})],mt.prototype,"subtypeCode",void 0),u([d({type:[Tee]})],mt.prototype,"templates",void 0),u([Ae("templates",["editFieldsInfo","creatorField","editorField","templates"])],mt.prototype,"readTemplates",null),u([d({type:oEe})],mt.prototype,"timeInfo",void 0),u([d()],mt.prototype,"title",void 0),u([Ae("service","title",["name"]),Ae("portal-item","title",["layerDefinition.title","layerDefinition.name","title"])],mt.prototype,"readTitle",null),u([Ae("web-map","title",["layerDefinition.name","title"])],mt.prototype,"readTitleFromWebMap",null),u([d({type:String})],mt.prototype,"sublayerTitleMode",void 0),u([d({json:{read:!1}})],mt.prototype,"type",void 0),u([d({type:String})],mt.prototype,"typeIdField",void 0),u([Ae("service","typeIdField"),Ae("typeIdField",["layerDefinition.typeIdField"])],mt.prototype,"readTypeIdField",null),u([d({type:[aEe]})],mt.prototype,"types",void 0),u([Ae("service","types",["types"]),Ae("types",["layerDefinition.types"])],mt.prototype,"readTypes",null),u([d({type:Boolean,json:{origins:{"portal-item":{write:{target:"layerDefinition.defaultVisibility"}}}}})],mt.prototype,"visible",void 0),u([Ae("portal-item","visible",["visibility","layerDefinition.defaultVisibility"])],mt.prototype,"readVisible",null),mt=u([R(hEe)],mt);const Vk=mt,Lkt=Object.freeze(Object.defineProperty({__proto__:null,default:Vk},Symbol.toStringTag,{value:"Module"}));let JM=null;function kQe(t,e,r,i={}){const s=e.elementType,n="value",o=s.type==="array"?[{name:n,type:s.type,elementType:s.elementType}]:s.type==="dictionary"?[{name:n,type:s.type,properties:s.properties}]:[{name:n,type:s.type}];return new Lqe(t.map(a=>{const l={};return See(l,o,{[n]:a},r,i),l[n]}))}function UQe(t,e,r={}){const i=t instanceof QK?new Vk({source:t.features,geometryType:t.geometryType,fields:t.fields,spatialReference:t.spatialReference}):t;return e.constructFeatureSet(i,r.spatialReference,null,!0,r.lruCache,r.interceptor)}function VQe(t,e,r={}){const{spatialReference:i,interceptor:s,lruCache:n}=r;return typeof t=="string"?e.createFeatureSetCollectionFromService(t,i,n,s):e.createFeatureSetCollectionFromMap(t,i,n,s)}function zQe(t,e,r,i={}){const s={};return See(s,e.properties,t,r,i),new JM.Dictionary(s)}function See(t,e,r,i,s={}){const n={};for(const o of Object.keys(r))n[o.toLowerCase()]=r[o];for(const o of e){const a=o.name.toLowerCase();if(s.variablesPreProcessed)t[a]=n[a];else switch(o.type){case"array":{const l=n[a];t[a]=kQe(l,o,i,s);break}case"feature":{const l=n[a];t[a]=l==null?null:JM.Feature.createFromGraphic(l,s?.timeReference);break}case"featureSet":{const l=n[a];t[a]=i?UQe(l,i,s):null;break}case"featureSetCollection":{const l=n[a];t[a]=i?VQe(l,i,s):null;break}case"dictionary":{const l=n[a];t[a]=zQe(l,o,i,s);break}case"date":{const l=n[a];t[a]=l?l instanceof B9?l:s?.timeReference?.timeZone?B9.dateJSAndZoneToArcadeDate(l,s?.timeReference?.timeZone):B9.dateJSToArcadeDate(l):null;break}case"geometry":case"boolean":case"text":case"number":t[a]=n[a]}}}function dEe(t,e){for(const r of t)e.push(r),r.type==="dictionary"&&dEe(r.properties,e);return e}function gle(t,e,r,i,s){const{spatialReference:n,interceptor:o,lruCache:a,console:l,abortSignal:c,timeReference:h,services:p={portal:ao.getDefault()}}=r,f={vars:{},spatialReference:n,interceptor:o,timeReference:h,lrucache:a,useAsync:s,services:p,console:l,abortSignal:c};return e&&See(f.vars,t.variables,e,i,r),f}function zk(t,e){switch(e.getArcadeType(t)){case"number":case"text":case"boolean":case"point":case"polygon":case"polyline":case"multipoint":case"extent":return t;case"date":return t.toJSDate();case"feature":{const r=(t.type,t),i="geometry"in r?r.geometry():null,s="readAttributes"in r?r.readAttributes():r.attributes;return new oa({geometry:i,attributes:s})}case"dictionary":{const r=t,i=r.attributes,s={};for(const n of Object.keys(i))s[n]=zk(r.field(n),e);return s}case"array":return("toArray"in t?t.toArray():t).map(r=>zk(r,e))}return t}const yle={variables:[{name:"$feature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"}]},_le={variables:[{name:"$feature",type:"feature"},{name:"$aggregatedFeatures",type:"featureSet"}]},vle=new Map([["form-constraint",{variables:[{name:"$feature",type:"feature"}]}],["feature-z",{variables:[{name:"$feature",type:"feature"}]}],["field-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$datastore",type:"featureSetCollection"}]}],["form-calculation",{variables:[{name:"$feature",type:"feature"},{name:"$originalFeature",type:"feature"},{name:"$layer",type:"featureSet"},{name:"$featureSet",type:"featureSet"},{name:"$datastore",type:"featureSetCollection"},{name:"$map",type:"featureSetCollection"},{name:"$editContext",type:"dictionary",properties:[{name:"editType",type:"text"}]}]}],["labeling",{variables:[{name:"$feature",type:"feature"}]}],["popup",yle],["popup-element",yle],["feature-reduction-popup",_le],["feature-reduction-popup-element",_le],["visualization",{variables:[{name:"$feature",type:"feature"},{name:"$view",type:"dictionary",properties:[{name:"scale",type:"number"}]}]}]]);function BQe(t){const e=vle.get(t);if(!e){const r=Array.from(vle.keys()).map(i=>`'${i}'`).join(", ");throw new D("createArcadeProfile:invalid-profile-name",`Invalid profile name '${t}'. You must specify one of the following values: ${r}`)}return re(e)}async function GQe(t,e,r={}){JM||(JM=await If());const{arcade:i,arcadeUtils:s}=JM,{loadScriptDependencies:n,referencesMember:o,scriptIsAsync:a}=i,l=dEe(e.variables,[]),c=l.filter(S=>S.type==="featureSet"||S.type==="featureSetCollection").map(S=>S.name.toLowerCase()),h=i.parseScript(t,c);if(!h)throw new D("arcade:invalid-script","Unable to create SyntaxTree");const p=s.extractFieldNames(h),f=i.scriptTouchesGeometry(h),m=l.map(S=>S.name.toLowerCase()).filter(S=>o(h,S)),g=a(h,c);await n(h,g,c);const _={vars:{},spatialReference:null,useAsync:g};for(const S of m)_.vars[S]="any";const{lruCache:v}=r,b=i.compileScript(h,_),x=i.featureSetUtils(),{services:T}=r;return{execute:(S,O={})=>{if(g)throw new D("arcade:invalid-execution-mode","Cannot execute the script in synchronous mode");const A=b(gle(e,S,{lruCache:v,...O},x,g));return O.rawOutput?A:zk(A,s)},executeAsync:async(S,O={})=>{const A=await b(gle(e,S,{lruCache:v,services:T,...O},x,g));return O.rawOutput?A:zk(A,s)},isAsync:g,variablesUsed:m,fieldsUsed:p,geometryUsed:f,syntaxTree:h}}var pEe;const jQe=Symbol("FormExpressionArcadeExecutor");let rc=class extends me{constructor(e){super(e),this[pEe]=!0,this._lastEvaluatedValue=null,this._abortController=new AbortController,this._stale=!1,this._updatingTracking=new vf,this._executeAsyncDebounced=x1(async(r,i,s)=>{const n=await this.executor.executeAsync(r,{...i,abortSignal:s});return s.aborted?this._lastEvaluatedValue:(this._lastEvaluatedValue=n,this._stale=!1,n)})}get isAsync(){return this.executor.isAsync}get fieldsUsed(){return this.executor.fieldsUsed}get syntaxTree(){return this.executor.syntaxTree}get updating(){return this._updatingTracking.updating}get stale(){return this._stale}get geometryUsed(){return this.executor.geometryUsed}get variablesUsed(){return this.executor.variablesUsed}get lastEvaluatedValue(){return this._lastEvaluatedValue}abort(){this._abortController.abort()}execute(e,r){this._abortController=new AbortController;const i=this.executor.execute(e,{...r,abortSignal:this._abortController.signal});return this._lastEvaluatedValue=i,i}async executeAsync(e,r){return this._abortController=new AbortController,this._updatingTracking.addPromise(this._executeAsyncDebounced(e,r??{},this._abortController.signal))}markStale(){this._stale=!0}reset(){this.abort(),this._lastEvaluatedValue=null,this._stale=!1}};pEe=jQe,u([d()],rc.prototype,"_lastEvaluatedValue",void 0),u([d()],rc.prototype,"_stale",void 0),u([d()],rc.prototype,"_updatingTracking",void 0),u([d({constructOnly:!0})],rc.prototype,"executor",void 0),u([d()],rc.prototype,"isAsync",null),u([d()],rc.prototype,"fieldsUsed",null),u([d()],rc.prototype,"syntaxTree",null),u([d()],rc.prototype,"updating",null),u([d()],rc.prototype,"stale",null),u([d()],rc.prototype,"geometryUsed",null),u([d()],rc.prototype,"variablesUsed",null),u([d()],rc.prototype,"lastEvaluatedValue",null),rc=u([R("esri.widgets.FeatureForm.FormExpressionArcadeExecutor")],rc);const HQe=async(t,e)=>{const r=BQe("form-calculation"),i=await GQe(t,r,{});return e?.fieldsIndex&&(i.fieldsUsed=KP(e.fieldsIndex,i.fieldsUsed)),new rc({executor:i})},lz="#JSAPI_FORM_EXPRESSIONS_MANAGER_GEOMETRY",qQe="esri.widgets.FeatureForm.FormExpressionsManager";let av=class extends me{constructor(e){super(e),this._fieldReferencesLookup=new Map,this._fieldsAffectedLookup=new Map,this._latestFieldValues={...e.feature.attributes}}initialize(){this._dependencyGraph=this._buildDependencyGraph()}get _baseContext(){const{editType:e,layer:r,map:i,originalFeature:s,spatialReference:n}=this.arcadeContextInfo,o=r?.type==="feature"?r:r?.type==="scene"&&r.associatedLayer!=null?r.associatedLayer:void 0;return[{$originalfeature:s,$editcontext:{editType:e},$layer:o,$featureset:o,$datastore:r?.url,$map:i},{spatialReference:n??void 0}]}set feature(e){this._latestFieldValues={...e?.attributes},this._set("feature",e)}evaluateAll(){return this._evaluate(this.executors)}evaluateExpressions(e){return this._evaluate(e)}evaluateInvalidated(e){const{_fieldReferencesLookup:r,_latestFieldValues:i,feature:s}=this,n=new Set;for(const o of e)if(i[o]=s.getAttribute(o),r.has(o))for(const a of r.get(o))n.add(a);return this._evaluate([...n])}async evaluateInvalidatedByGeometry(){if(this._fieldReferencesLookup.has(lz))return this._evaluate([...this._fieldReferencesLookup.get(lz)])}resetExecutors(){for(const e of this.executors)e.reset()}_buildDependencyGraph(){const{_fieldReferencesLookup:e,_fieldsAffectedLookup:r,executors:i}=this,s=new Map(this.fieldInputs.map(o=>[o.name,o])),n=new Map(i.map(o=>[o,new Array]));for(const o of i){for(const a of o.fieldsUsed){BE(e,a,()=>new Set).add(o);const l=s.get(a),c=l?.valueExpressionExecutor,h=l?.editableExpressionExecutor;c!=null&&c!==o&&(n.get(c).push(o),BE(r,c,()=>new Set).add(l)),h!=null&&h!==o&&(n.get(h).push(o),BE(r,h,()=>new Set).add(l))}o.geometryUsed&&BE(e,lz,()=>new Set).add(o)}return n}async _evaluate(e){const r=new Map,{_dependencyGraph:i,_fieldsAffectedLookup:s,_latestFieldValues:n}=this;for(const a of e)fEe(a,r,i);for(const[a,{resolver:l,dependencyPromises:c}]of r)Promise.all(c).then(async()=>{const[h,p]=this._makeContext(n);return a.executeAsync(h,p)}).then(()=>{if(s.has(a))for(const h of s.get(a))this._latestFieldValues[h.name]=h.value;l.resolve()},h=>{!h||ws(h)||ble(h)||a.markStale(),l.reject(h)});const o=(await Promise.allSettled(Array.from(r.values(),({resolver:a})=>a.promise))).filter(a=>a.status==="rejected"&&!(ws(a.reason)||ble(a.reason)));if(o.length>0)throw new AggregateError(o,"One or more expression executions failed")}_makeContext(e){const[r,i]=this._baseContext,s=this.feature.clone();return s.attributes=e,[{...r,$feature:s},i]}};u([d()],av.prototype,"_baseContext",null),u([d()],av.prototype,"feature",null),u([d()],av.prototype,"executors",void 0),u([d()],av.prototype,"fieldInputs",void 0),u([d()],av.prototype,"arcadeContextInfo",void 0),av=u([R(qQe)],av);const fEe=(t,e,r)=>{if(e.has(t))return;const i=nn();e.set(t,{resolver:i,dependencyPromises:[]}),t.abort();const s=r.get(t);for(const n of s)fEe(n,e,r),e.get(n).dependencyPromises.push(i.promise)},ble=t=>t&&typeof t=="object"&&"message"in t&&t.message==="Cancelled",mEe="esri.widgets.FeatureForm.GroupInput",wle=K.getLogger(mEe);let lv=class extends TTe{constructor(e){super(e),this._expressionTrackingHandles=new Map,this.type="group"}initialize(){this.addHandles([Q(()=>[this.visible,this.inputs],([e])=>{const{inputs:r}=this,i=!!e&&void 0;for(const s of r)qv(s)&&(s.required=i)},{initial:!0,equals:(e,r)=>r[0]===e[0]&&r[1]===e[1]})])}destroy(){for(const e of this._expressionTrackingHandles.values())e.remove()}set inputFields(e){z1(wle,"Property: GroupInput.inputFields",{replacement:"GroupInput.inputs",version:"4.27"}),this.inputs=e}get inputFields(){return z1(wle,"Property: GroupInput.inputFields",{replacement:"GroupInput.inputs",version:"4.27"}),this.inputs}get inputs(){return this._get("inputs")}set inputs(e){this.handles.removeAll(),e&&this.handles.add(e.map(r=>Q(()=>r.visible,()=>this._dirtyEvaluatedVisibilityExpression()))),this._set("inputs",e)}get label(){return this.element.label}set label(e){Dl(this.element,r=>{r.label=e})}get state(){return this.element.initialState||"expanded"}set state(e){this._overrideIfSome("state",e)}get visible(){return this.evaluatedVisibilityExpression!==!1&&this.inputs&&this.inputs.some(e=>e.visible)}_dirtyEvaluatedVisibilityExpression(){const{element:e}=this;e.visibilityExpression&&this.notifyChange("evaluatedVisibilityExpression")}};u([d()],lv.prototype,"inputs",null),u([d()],lv.prototype,"label",null),u([d()],lv.prototype,"state",null),u([d({readOnly:!0})],lv.prototype,"type",void 0),u([d()],lv.prototype,"visible",null),lv=u([R(mEe)],lv);const WQe=lv,cz=100;let Ti=class extends rs(aS(Oc(me))){constructor(e){super(e),this._loaded=!1,this._queryAbortController=null,this._queryPageAbortController=null,this._queryFeatureCountAbortController=null,this.featuresPerPage=10,this.description=null,this.graphic=null,this.layer=null,this.map=null,this.orderByFields=null,this.featureCount=0,this.relationshipId=null,this.showAllEnabled=!1,this.title=null,this._cancelQuery=()=>{const{_queryAbortController:r}=this;r&&r.abort(),this._queryAbortController=null},this._cancelQueryFeatureCount=()=>{const{_queryFeatureCountAbortController:r}=this;r&&r.abort(),this._queryFeatureCountAbortController=null},this._cancelQueryPage=()=>{const{_queryPageAbortController:r}=this;r&&r.abort(),this._queryPageAbortController=null},this._queryController=async()=>{this._cancelQuery();const r=new AbortController;this._queryAbortController=r,await gC(this._query()),this._queryAbortController===r&&(this._queryAbortController=null)},this._queryFeatureCountController=async()=>{this._loaded=!1,this._cancelQueryFeatureCount();const r=new AbortController;this._queryFeatureCountAbortController=r,await gC(this._queryFeatureCount()),this._queryFeatureCountAbortController===r&&(this._queryFeatureCountAbortController=null),this._loaded=!0},this._queryPageController=async()=>{const r=new AbortController;this._queryPageAbortController=r,await gC(this._queryPage()),this._queryPageAbortController===r&&(this._queryPageAbortController=null)},this._queryDebounced=x1(this._queryController,cz),this._queryFeatureCountDebounced=x1(this._queryFeatureCountController,cz),this._queryPageDebounced=x1(this._queryPageController,cz),this._query=async()=>{const{_queryAbortController:r,relatedFeatures:i}=this;this.featureCount&&(this._destroyRelatedFeatureViewModels(),this.featurePage=1,i.removeAll(),this.destroyed||i.addMany(this._sliceFeatures(await this._queryRelatedFeatures({signal:r?.signal}))))},this.handles.add([Q(()=>[this.displayCount,this.graphic,this.layer,this.layer?.loaded,this.map,this.orderByFields,this.relationshipId,this.featuresPerPage,this.showAllEnabled,this.canQuery,this.featureCount],()=>this._queryDebounced(),xt),Q(()=>[this.featurePage,this.showAllEnabled],()=>this._queryPageDebounced()),Q(()=>[this.layer,this.relationshipId,this.objectId,this.canQuery],()=>this._queryFeatureCountDebounced())])}destroy(){this._destroyRelatedFeatureViewModels(),this.relatedFeatures.removeAll(),this._cancelQuery(),this._cancelQueryFeatureCount(),this._cancelQueryPage()}set featurePage(e){const{featuresPerPage:r,featureCount:i}=this,s=1,n=Math.ceil(i/r)||1;this._set("featurePage",Math.min(Math.max(e,s),n))}get featurePage(){return this._get("featurePage")}get orderByFieldsFixedCasing(){const{orderByFields:e,relatedLayer:r}=this;return e&&r?.loaded?e.map(i=>{const s=i.clone();return s.field=CK(i.field,r),s}):e??[]}get supportsCacheHint(){return!!this.layer?.capabilities?.queryRelated?.supportsCacheHint}get canLoad(){return!!this.map&&typeof this.relationshipId=="number"&&typeof this.objectId=="number"}get canQuery(){const e=this.layer?.capabilities?.queryRelated;return!!(this.relatedLayer&&this.relationship&&typeof this.relationshipId=="number"&&typeof this.objectId=="number"&&e?.supportsCount&&e?.supportsPagination)}get itemDescriptionFieldName(){return this.orderByFieldsFixedCasing[0]?.field||null}set displayCount(e){this._set("displayCount",Math.min(Math.max(e,0),10))}get displayCount(){return this._get("displayCount")}get objectId(){return(this.objectIdField&&this.graphic?.attributes?.[this.objectIdField])??null}get objectIdField(){return this.layer?.objectIdField||null}get relatedFeatures(){return this._get("relatedFeatures")||new Ke}get relatedFeatureInfos(){const{itemDescriptionFieldName:e,relatedFeatures:r,relatedLayer:i}=this;if(!r.length||!i)return[];const s=i&&"formTemplate"in i&&i.formTemplate,n=s&&s?.title||void 0;return r.map(o=>{let a;if(e){const l=o.getAttribute(e),c=i.fieldsIndex.get(e);if(c){const h=oTe([l],[c])[e];h!=null&&(a=h.toString())}}return{feature:o,description:a,title:n?GH(n,o.attributes,i.fieldsIndex):void 0}}).toArray()}get relatedLayer(){const{layer:e,map:r,relationship:i}=this;return e?.loaded&&r&&i?GHe(r,e,i)??null:null}get relationship(){const{relationshipId:e,layer:r}=this;return typeof e=="number"?r?.relationships?.find(({id:i})=>i===e)??null:null}get relatedFeatureViewModels(){return this._get("relatedFeatureViewModels")||new Ke}get state(){const{_queryAbortController:e,_queryFeatureCountAbortController:r,_queryPageAbortController:i,canQuery:s,_loaded:n,canLoad:o}=this;return r||o&&!n?"loading":e||i?"querying":s?"ready":"disabled"}getRelatedFeatureByObjectId(e){return this.relatedFeatures.find(r=>r.getObjectId()===e)}_destroyRelatedFeatureViewModels(){this.relatedFeatureViewModels?.forEach(e=>!e.destroyed&&e.destroy()),this.relatedFeatureViewModels.removeAll()}async _queryFeatureCount(){const{layer:e,relatedLayer:r,relationshipId:i,objectId:s,_queryFeatureCountAbortController:n,canQuery:o,supportsCacheHint:a}=this;if(await e?.load(),await r?.load(),!o||!e||!r)return void this._set("featureCount",0);const l=r.createQuery(),c=new rP({cacheHint:a,relationshipId:i,returnGeometry:!1,objectIds:[s],where:l.where??void 0}),h=await e.queryRelatedFeaturesCount(c,{signal:n?.signal});this._set("featureCount",h[s]||0)}_sliceFeatures(e){const{showAllEnabled:r,displayCount:i}=this;return r?e:i?e.slice(0,i):[]}async _queryPage(){const{relatedFeatures:e,featurePage:r,showAllEnabled:i,_queryPageAbortController:s,featureCount:n}=this;!i||r<2||!n||e.addMany(await this._queryRelatedFeatures({signal:s?.signal}))}async _queryRelatedFeatures(e){const{orderByFieldsFixedCasing:r,showAllEnabled:i,featuresPerPage:s,displayCount:n,layer:o,relationshipId:a,featurePage:l,featureCount:c,relatedLayer:h,supportsCacheHint:p}=this,{canQuery:f,objectId:m}=this;if(!f||!o||!h)return[];const g=i?((l-1)*s+c)%c:0,_=i?s:n,v=h.objectIdField,b=[...r.map(M=>M.field),...rqe(h),v].filter(Ia),x=r.map(M=>`${M.field} ${M.order}`),T=h.createQuery(),S=new rP({orderByFields:x,start:g,num:_,outFields:b,cacheHint:p,relationshipId:a,returnGeometry:!1,objectIds:[m],where:T.where??void 0}),O=await o.queryRelatedFeatures(S,{signal:e?.signal}),A=O[m]?.features||[];return A.forEach(M=>{M.sourceLayer=h,M.layer=h}),A}};u([d()],Ti.prototype,"_loaded",void 0),u([d()],Ti.prototype,"_queryAbortController",void 0),u([d()],Ti.prototype,"_queryPageAbortController",void 0),u([d()],Ti.prototype,"_queryFeatureCountAbortController",void 0),u([d({value:1})],Ti.prototype,"featurePage",null),u([d()],Ti.prototype,"featuresPerPage",void 0),u([d({readOnly:!0})],Ti.prototype,"orderByFieldsFixedCasing",null),u([d({readOnly:!0})],Ti.prototype,"supportsCacheHint",null),u([d({readOnly:!0})],Ti.prototype,"canLoad",null),u([d({readOnly:!0})],Ti.prototype,"canQuery",null),u([d()],Ti.prototype,"description",void 0),u([d({readOnly:!0})],Ti.prototype,"itemDescriptionFieldName",null),u([d({value:3})],Ti.prototype,"displayCount",null),u([d({type:oa})],Ti.prototype,"graphic",void 0),u([d()],Ti.prototype,"layer",void 0),u([d()],Ti.prototype,"map",void 0),u([d({readOnly:!0})],Ti.prototype,"objectId",null),u([d({readOnly:!0})],Ti.prototype,"objectIdField",null),u([d()],Ti.prototype,"orderByFields",void 0),u([d({readOnly:!0})],Ti.prototype,"relatedFeatures",null),u([d({readOnly:!0})],Ti.prototype,"relatedFeatureInfos",null),u([d({readOnly:!0})],Ti.prototype,"relatedLayer",null),u([d({readOnly:!0})],Ti.prototype,"relationship",null),u([d()],Ti.prototype,"featureCount",void 0),u([d({readOnly:!0})],Ti.prototype,"relatedFeatureViewModels",null),u([d()],Ti.prototype,"relationshipId",void 0),u([d()],Ti.prototype,"showAllEnabled",void 0),u([d()],Ti.prototype,"state",null),u([d()],Ti.prototype,"title",void 0),u([d()],Ti.prototype,"getRelatedFeatureByObjectId",null),Ti=u([R("esri.widgets.Feature.FeatureRelationship.FeatureRelationshipViewModel")],Ti);const ZQe=Ti,XQe=3;let An=class extends STe{constructor(e){super(e),this._relationshipVM=null,this.group=null,this.type="relationship",this.handles.add([Q(()=>({feature:this.feature,element:this.element,layer:this.layer}),r=>this._createRelationshipVM(r),xt)])}destroy(){this._relationshipVM?.destroy()}get canAddRelatedFeature(){const{editable:e,featureCount:r,_relationshipVM:i}=this;if(!i?.relationship||!this.loaded||!this.relatedLayerAllowsAdds)return!1;const{cardinality:s,role:n}=i.relationship;return!(s==="one-to-one"&&r>0)&&s!=="many-to-many"&&!(s==="one-to-many"&&n==="destination"&&r>0)&&e}get displayCount(){return this.element.displayCount??XQe}get displayType(){return this.element.displayType}get editable(){return!!this.relatedLayerAllowsEdits&&(this.evaluatedEditableExpression??!1)}get featureCount(){return this._relationshipVM?.featureCount??0}get map(){return this._get("map")}set map(e){e&&this._relationshipVM?.set("map",e),this._set("map",e)}get orderByFields(){return this.element.orderByFields}get relationshipId(){return this.element.relationshipId}get relatedFeatureInfos(){return this._relationshipVM?.relatedFeatureInfos??[]}get relatedLayer(){return this._relationshipVM?.relatedLayer}get relatedLayerAllowsAdds(){const{relatedLayer:e}=this;return!e||!this.relatedLayerAllowsEdits?!1:!!vg(e)?.operations?.supportsAdd}get relatedLayerAllowsEdits(){const{relatedLayer:e}=this;return e?!!vg(e)?.operations?.supportsEditing:!1}get showAllEnabled(){return this._get("showAllEnabled")}set showAllEnabled(e){this._relationshipVM?.set("showAllEnabled",e),this._set("showAllEnabled",e)}get showAllActionVisible(){return!this.showAllEnabled&&this.featureCount>0&&this.featureCount>this.displayCount}get visible(){const{_relationshipVM:e,relatedLayer:r}=this;if(!e?.relationship)return!1;const{cardinality:i}=e.relationship;return i!=="many-to-many"&&!(r&&!uA(r))&&(this.evaluatedVisibilityExpression!=null?this.evaluatedVisibilityExpression:this.element!=null)}get updating(){return this._relationshipVM?.state==="loading"||this._relationshipVM?.state==="querying"}get loaded(){return this._relationshipVM?.state==="ready"}incrementPage(){this._relationshipVM&&this._relationshipVM.featurePage++}getRelatedFeatureByObjectId(e){return this._relationshipVM?.getRelatedFeatureByObjectId(e)}_createRelationshipVM(e){const{feature:r,element:i,layer:s}=e;if(this._relationshipVM?.destroy(),!r||!i||!s)return;const{displayCount:n,map:o,orderByFields:a,relationshipId:l,showAllEnabled:c}=this;aV(s)&&(this._relationshipVM=new ZQe({graphic:r,displayCount:n,layer:s,map:o,orderByFields:a,relationshipId:l,showAllEnabled:c}))}};u([d()],An.prototype,"canAddRelatedFeature",null),u([d()],An.prototype,"displayCount",null),u([d()],An.prototype,"displayType",null),u([d()],An.prototype,"editable",null),u([d()],An.prototype,"group",void 0),u([d()],An.prototype,"map",null),u([d()],An.prototype,"orderByFields",null),u([d()],An.prototype,"relationshipId",null),u([d()],An.prototype,"relatedFeatureInfos",null),u([d()],An.prototype,"relatedLayer",null),u([d()],An.prototype,"relatedLayerAllowsAdds",null),u([d()],An.prototype,"relatedLayerAllowsEdits",null),u([d()],An.prototype,"showAllEnabled",null),u([d()],An.prototype,"showAllActionVisible",null),u([d({readOnly:!0})],An.prototype,"type",void 0),u([d()],An.prototype,"visible",null),u([d()],An.prototype,"updating",null),u([d()],An.prototype,"incrementPage",null),u([d()],An.prototype,"getRelatedFeatureByObjectId",null),An=u([R("esri.widgets.FeatureForm.RelationshipInput")],An);const YQe=An,uz=new oa({attributes:{}}),JQe=["editableExpression","requiredExpression","valueExpression","visibilityExpression"],QQe=["visibilityExpression"],KQe=["editableExpression","visibilityExpression"],eKe="#JSAPI_CONTINGENT_VALUE_EMPTY_HASH",AS="#JSAPI_CONTINGENT_VALUE_ANY_HASH",tKe="#JSAPI_CONTINGENT_VALUE_NULL_HASH",Eee="esri.widgets.FeatureForm.FeatureFormViewModel",zL=K.getLogger(Eee);let di=class extends Oc(e$(Xr.EventedAccessor)){constructor(e){super(e),this._expressionExecutorLookup=new Map,this._expressionLookup=new Map,this._expressionsManager=null,this._contingentValuesCache=null,this._featureClone=uz.clone(),this._initialFeature=uz.clone(),this.arcadeEditType="NA",this.contingencyConstraintViolations=new Map,this.disabled=!1,this.inputs=[],this.map=null,this.relatedRecordCallbacks=null,this.strict=!1}initialize(){const e=Q(()=>[this.layer,!!this.layer?.loaded,this.formTemplate,this.feature,this.arcadeEditType],([s,n])=>{s!=null&&(n?this._updateInputs():s.load().catch(()=>K.getLogger(this).error("Failed to load layer",s.loadError)))},{equals:([s,n,o,a,l],[c,h,p,f,m])=>s===c&&n===h&&o===p&&a===f&&l===m,initial:!0}),r=Q(()=>this._arcadeContextInfo,s=>{this._expressionsManager!=null&&(this._expressionsManager.arcadeContextInfo=s)}),i=Q(()=>this.layer,s=>{const n=s?.type==="subtype-sublayer"?s.parent:s?.type==="feature"?s:null;n&&this.addResolvingPromise(Oqe.createLoadedLayerContingentValuesCache(n).then(o=>{this._contingentValuesCache=o,this.notifyChange("fieldsWithContingentValues")}))},{initial:!0});this.handles.add([e,r,i])}destroy(){this.feature=null,this.layer=null,this._contingentValuesCache=Re(this._contingentValuesCache)}get activeRelationshipInput(){return this.allRelationshipInputs.find(e=>e.relationshipId===this.relationshipId)}get _arcadeContextInfo(){const{_initialFeature:e,arcadeEditType:r,layer:i,map:s,spatialReference:n}=this;return{layer:uV(i)?i:null,originalFeature:e,editType:r,map:s,spatialReference:n}}get allFieldInputs(){return Moe(this.inputs)}get allRelationshipInputs(){return YHe(this.inputs)}get _layerFieldsByName(){return new Map(this.layer?.fields.map(e=>[e.name,e]))}get feature(){return this._get("feature")}set feature(e){this._featureClone=e?e.clone():uz.clone(),this._initialFeature=this._featureClone.clone(),e?(this._resetFieldInputValues(this._featureClone),this.allRelationshipInputs.forEach(r=>r.feature=e)):(this.inputs.forEach(r=>r.destroy()),this.inputs.length=0),this.contingencyConstraintViolations.clear(),this._expressionsManager!=null&&(this._expressionsManager.resetExecutors(),this._expressionsManager.feature=this._featureClone,this.updatingHandles.addPromise(this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated()))),this._set("feature",e)}get fieldsWithContingentValues(){if(this._contingentValuesCache==null)return new Set;const e=this._contingentValuesCache.fieldGroups.flatMap(r=>r.fields);return new Set(e)}get formTemplate(){return this.layer&&"formTemplate"in this.layer?this.layer.formTemplate:null}set formTemplate(e){e===void 0?this._clearOverride("formTemplate"):this._override("formTemplate",e)}get formDescription(){const{formTemplate:e,layer:r}=this;return e!=null&&e.description&&r?GH(e.description,this.getValues(),r.fieldsIndex):null}get formTitle(){const{formTemplate:e,layer:r}=this;return e!=null&&e.title&&r?GH(e.title,this.getValues(),r.fieldsIndex):null}formHeaderVisible(){const{activeRelationshipInput:e,formDescription:r,formTitle:i}=this;return!(e||!r&&!i)}set inputFields(e){Ka(zL,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs=e}get inputFields(){return Ka(zL,"inputFields",{replacement:"FeatureFormViewModel.inputs",version:"4.27"}),this.inputs}get joinedContingentValues(){return this._joinContingentValues()}get layer(){return this.feature?.sourceLayer&&"applyEdits"in this.feature.sourceLayer?this.feature.sourceLayer:null}set layer(e){this._override("layer",e)}get relationshipId(){return this._get("relationshipId")}set relationshipId(e){const r=this.allRelationshipInputs;if(e!=null&&e===this.relationshipId||r.forEach(i=>i.showAllEnabled=!1),e!=null){const i=r.find(s=>s.relationshipId===e);i&&(i.showAllEnabled=!0)}this._set("relationshipId",e)}get spatialReference(){return this.layer?.spatialReference??null}set spatialReference(e){this._override("spatialReference",e)}get state(){return this.get("layer.loaded")?"ready":"disabled"}get submittable(){return!!this.valid||this.allFieldInputs.filter(e=>!e.valid).every(({submittable:e})=>e)}get updating(){return this.updatingHandles.updating}get valid(){const e=this.allFieldInputs;return e.length>0&&e.every(({valid:r})=>r)}get view(){return Ka(zL,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._get("view")}set view(e){Ka(zL,"view",{replacement:"FeatureForm.map",version:"4.27"}),this._set("view",e),e?.map&&(this.map=e.map)}findField(e){return this.allFieldInputs.find(r=>r.name===e)}getValue(e){const{_featureClone:r,layer:i}=this,s=!!i?.getField(e);return r.getAttribute(e)??(s?null:void 0)}setValue(e,r){const{_featureClone:i,strict:s}=this,n=this.findField(e);r=r===""?null:r,n&&i.getAttribute(e)!==r&&(n.value=r,s&&!n.valid||(this._afterValueChange(n),this._expressionsManager!=null&&this.updatingHandles.addPromise(this._expressionsManager.evaluateInvalidated([n.name]).finally(()=>this._afterExpressionsEvaluated()))))}getValues(){return{...this._featureClone.attributes}}submit(){const e=this.allFieldInputs,r=new Set(e.filter(n=>n.valid).map(({name:n})=>n)),i=e.filter(n=>!n.valid).map(({name:n})=>n),s=this.getValues();if(this.validateContingencyConstraints(s,{includeIncompleteViolations:!0}).length>0)for(const[n,o]of this.contingencyConstraintViolations.entries())o.type==="error"&&(r.delete(n),i.push(n));this.emit("submit",{valid:[...r],invalid:i,values:s})}validateContingencyConstraints(e,r){const{_contingentValuesCache:i}=this,s=new Map;if(this.contingencyConstraintViolations=s,i==null)return[];const{invalid:n,incomplete:o}=i.validateContingencyConstraints(e),a=[...n,...r?.includeIncompleteViolations?o:[]];for(const l of a)for(const c of l.fieldGroup.fields)s.set(c,l);return a}notifyFeatureGeometryChanged(){const{_expressionsManager:e,feature:r,_featureClone:i}=this;i.geometry=r.geometry,e!=null&&this.updatingHandles.addPromise(e.evaluateInvalidatedByGeometry().finally(()=>this._afterExpressionsEvaluated()))}_emitChangeEvent({name:e,valid:r,value:i}){this.emit("value-change",{layer:this.layer,feature:this.feature,fieldName:e,value:i,valid:r})}_updateInputs(){const{_featureClone:e,_initialFeature:r,arcadeEditType:i,formTemplate:s,inputs:n,layer:o}=this;if(!o)return;const a={arcadeEditType:i,feature:e,initialFeature:r,layer:o},l=n.slice(),c=s!=null&&s.elements&&s.elements.length>0?this._updateInputsUsingFormElements(l,s.elements,a):this._updateInputsUsingLayerFields(l,o?.fields,a);this.inputs=c}_updateInputsUsingFormElements(e,r,i){const s=new Map;for(const a of e)if(C1(a)){s.set(a.element,a);for(const l of a.inputs)l.element&&s.set(l.element,l)}else a.element&&s.set(a.element,a);const n=new Map,o=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:s,updatedElements:r.filter(xle),sharedInitializationProperties:i,group:null,newExpressionExecutorPromises:n});this.updatingHandles.addPromise(Promise.all(Array.from(n.values())).then(()=>{const a=Array.from(this._expressionExecutorLookup.values()),l=Moe(o);return this._createExpressionsManager(a,l),this._expressionsManager.evaluateAll().finally(()=>this._afterExpressionsEvaluated())}));for(const[a,l]of s.entries())s.delete(a),l.destroy();return o}_updateInputsUsingFormElementsRecursive(e){const{existingInputsByElement:r,updatedElements:i,sharedInitializationProperties:s,group:n,newExpressionExecutorPromises:o}=e,a=[];for(const l of i){const c=r.has(l),h=c?r.get(l):U9(l)?this._makeGroupInputFromElement(l,s):iTe(l)?this._makeFieldInputFromElement(l,s,n):Roe(l)?this._makeRelationshipInputFromElement(l,s,n):null;if(h){if(a.push(h),c)if(r.delete(l),C1(h)){const{feature:p}=s;h.set({feature:p})}else if(EC(h)){const p=this.relationshipId===l.relationshipId;h.set(s),h.set({map:this.map,showAllEnabled:p})}else h.set(s);else this._assignExpressionExecutors(h,l,o);if(U9(l)){const p=l.elements.filter(f=>xle(f));h.inputs=this._updateInputsUsingFormElementsRecursive({existingInputsByElement:r,updatedElements:p,sharedInitializationProperties:s,group:h,newExpressionExecutorPromises:o})}}}return a}_updateInputsUsingLayerFields(e,r,i){if(!Array.isArray(r))return K.getLogger(this).warn(this.declaredClass,"No attribute fields found."),[];const s=new Map;for(const h of e)if(C1(h)){for(const p of h.inputs)p.destroy();h.inputs.length=0,h.destroy()}else EC(h)?h.destroy():qv(h)&&(h.element!==null?h.destroy():s.set(h.field,h));const n=[],{arcadeEditType:o,feature:a,initialFeature:l,layer:c}=i;for(const h of r){const p=s.get(h)??new Zoe({arcadeEditType:o,field:h,feature:a,initialFeature:l,layer:c,value:a?.getAttribute(h.name)??null});n.push(p),s.delete(h)}for(const[h,p]of s.entries())s.delete(h),p.destroy();return n}_resetFieldInputValues(e){for(const r of this.allFieldInputs)r.value=e.getAttribute(r.name)}_makeFieldInputFromElement(e,r,i){const{arcadeEditType:s,feature:n,initialFeature:o,layer:a}=r,{fieldName:l}=e,c=l&&this._layerFieldsByName.get(l);return c?new Zoe({arcadeEditType:s,element:e,field:c,value:n?.getAttribute(e.fieldName)??null,feature:n,initialFeature:o,layer:a,group:i}):null}_makeGroupInputFromElement(e,r){const{feature:i,layer:s}=r;return new WQe({element:e,inputs:[],feature:i,layer:s})}_makeRelationshipInputFromElement(e,r,i=null){const{map:s}=this,{feature:n,layer:o}=r;return new YQe({element:e,feature:n,group:i,layer:o,map:s})}_assignExpressionExecutors(e,r,i){const s=U9(r)?QQe:Roe(r)?KQe:JQe,n=[];for(const o of s){const a=r[o],{_expressionExecutorLookup:l}=this;if(a!=null&&a!==""){const c=`${o}Executor`,h=this._expressionLookup.get(a)??this._addToExpressionLookup(a);if(l.has(h))e[c]=l.get(h);else if(i.has(h)){const p=i.get(h).then(f=>(e[c]=f,f));i.set(h,p)}else{const p=HQe(h,this.layer).then(f=>(e[c]=f,l.set(h,f),f));i.set(h,p)}}}return n}_createExpressionsManager(e,r){const{_arcadeContextInfo:i,_featureClone:s}=this;this._expressionsManager=new av({executors:e,feature:s,arcadeContextInfo:i,fieldInputs:r})}_afterValueChange(e){const{name:r,value:i}=e,{_featureClone:s,formTemplate:n,layer:o}=this;if(!o)return;const a=s.getAttribute(r);s.setAttribute(r,i);const{typeFieldName:l,types:c}=jH(o);if(r===l&&i!==a){if(o.type==="subtype-sublayer"){const p=o.parent?.findSublayerForFeature(s);s.sourceLayer=this.feature.sourceLayer=p}const h=new Set;for(const p of c)if(p.domains&&typeof p.domains=="object")for(const f of Object.keys(p.domains))h.add(f);for(const p of h){const f=this.findField(p);f&&f.notifyChange("domain")}}if(n!=null){const{description:h,title:p}=n;p&&PI(p,r)&&this.notifyChange("formTitle"),h&&PI(h,r)&&this.notifyChange("formDescription")}this._emitChangeEvent(e)}_afterExpressionsEvaluated(){const{_featureClone:e}=this;for(const r of this.allFieldInputs)r.value!==e.getAttribute(r.name)&&this._afterValueChange(r)}_addToExpressionLookup(e){const{_expressionLookup:r,formTemplate:i}=this,s=i!=null&&i.expressionInfos!=null?Object.values(i.expressionInfos).find(o=>o.name===e):null,n=s?.expression??e;return r.set(e,n),e!==n&&r.set(n,n),n}_joinContingentValues(){const e=this._contingentValuesCache;if(e==null)return[];const{typeFieldName:r}=jH(this.layer),i=r?this.getValue(r):null,s=[];for(const a of e.fieldGroups){const{contingencies:l,fields:c,name:h}=a,p=[];for(const f of l)f.isRetired||f.subtype!=null&&f.subtype.code!==i||p.push({values:f.values});p.length>0&&s.push({name:h,fields:c,contingencies:p})}const[n,o]=this._generateJoinPlan(s);return[...n.flatMap(a=>this._joinFieldGroupContingencies(a)),...o.flatMap(a=>a.contingencies)]}_generateJoinPlan(e){const r=new Map,i=[],s=new Set;for(const c of e)for(const h of c.fields)if(r.has(h)){const p=r.get(h),f=c,m=[p.name,f.name].sort().join("|");if(s.has(m))continue;i.push([p,f]),s.add(m),r.set(h,f)}else r.set(h,c);const n=new Set(i.flat()),o=new Set(e);for(const c of n)o.delete(c);const a=new Map,l=new Map;for(const c of new Set(i.flat())){const h=Symbol(c.name);a.set(h,new Set([c])),l.set(c,h)}for(const[c,h]of i){const p=l.get(c),f=l.get(h);if(p===f)continue;const m=a.get(p),g=a.get(f);for(const _ of g)m.add(_),l.set(_,p);a.delete(f)}return[[...a.values()].map(c=>[...c]),[...o]]}_joinFieldGroupContingencies(e){const r=e.slice(),i=r.shift();let s=r.shift(),n=this._generateJoinKey(i.fields,s.fields),o=new Set([...i.fields,...s.fields]),a=new Map;for(const c of i.contingencies){const[h]=this._hashContingency(c,n.codedValueFields,!0);a.has(h)?a.get(h)?.push(c):a.set(h,[c])}for(;r.length>0;){const c=new Map,h=r.shift(),p=this._generateJoinKey(o,h.fields);for(const f of s.contingencies){const[m,g]=this._hashContingency(f,n.codedValueFields),_=g?this._findMatchingContingenciesWithAnyHashMask(a,m):a.get(m);if(a.has(AS)&&_?.push(...this._findMatchingContingenciesContainingAny(f,a.get(AS),n.codedValueFields)),_!=null)for(const v of _){const b=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(v,f,n.rangeFields):this._joinContingencies(v,f);if(b==null)break;const[x]=this._hashContingency(b,p.codedValueFields,!0);c.has(x)?c.get(x)?.push(b):c.set(x,[b])}}a=c,s=h,n=p,o=new Set([...o,...s.fields])}const l=[];for(const c of s.contingencies){const[h,p]=this._hashContingency(c,n.codedValueFields),f=p?this._findMatchingContingenciesWithAnyHashMask(a,h):a.get(h);if(a.has(AS)&&f.push(...this._findMatchingContingenciesContainingAny(c,a.get(AS),n.codedValueFields)),f!=null)for(const m of f){const g=n.rangeFields.length>0?this._joinContingenciesWithRangeDomains(m,c,n.rangeFields):this._joinContingencies(m,c);g!=null&&l.push(g)}}return l}_joinContingencies(e,r){const i={values:{...e.values,...r.values}};for(const[s,n]of Object.entries(i.values))n.objectType==="any"&&e.values[s]!=null&&(i.values[s]=e.values[s]);return i}_joinContingenciesWithRangeDomains(e,r,i){const s=this._joinContingencies(e,r);for(const n of i){const o=e.values[n],a=r.values[n],{leftIsNull:l,rightIsNull:c,bothAreNull:h,leftIsAny:p,rightIsAny:f,bothAreAny:m,leftIsRange:g,rightIsRange:_}=this._compareObjectTypes(o.objectType,a.objectType);if(h||m)continue;if(l&&f||c&&p){s.values[n]=new va({objectType:"null"});continue}if(l&&_||c&&g)return null;p?(o.minValue=-1/0,o.maxValue=1/0):f&&(a.minValue=-1/0,a.maxValue=1/0);const v=Math.max(o.minValue,a.minValue),b=Math.min(o.maxValue,a.maxValue);if(v>b)return null;s.values[n]=new va({objectType:"range",minValue:v,maxValue:b})}return s}_findMatchingContingenciesContainingAny(e,r,i){return r.filter(s=>i.every(n=>{const o=s.values[n],a=e.values[n];return o.objectType==="any"||a.objectType==="any"||o.codedValue?.code===a.codedValue?.code}))}_findMatchingContingenciesWithAnyHashMask(e,r){const i=RegExp(`${r}$`),s=[];for(const[n,o]of e){if(n===AS)break;i.test(n)&&s.push(...o)}return s}_generateJoinKey(e,r){const i=Array.isArray(e)?new Set(e):e,s=Array.isArray(r)?new Set(r):r,n=i.size<s.size?i:s,o=n===i?s:i,a=new Set,l=new Set;for(const c of n)if(o.has(c)){const h=this.layer?.getFieldDomain(c,{feature:this.feature});if(h==null)continue;switch(h.type){case"coded-value":a.add(c);break;case"range":l.add(c)}}return{codedValueFields:[...a],rangeFields:[...l]}}_hashContingency(e,r,i=!1){if(r.length<1)return[eKe,!1];const s=[];let n=!1;for(const o of r){const a=e.values[o];if(a.objectType==="any"){if(i)return[AS,!0];n=!0,s.push(`${o}:.*`)}else a.objectType==="null"?s.push(`${o}:${tKe}`):s.push(`${o}:${a.codedValue?.code}`)}return[s.sort().join("&"),n]}_compareObjectTypes(e,r){return{leftIsNull:e==="null",rightIsNull:r==="null",bothAreNull:e==="null"&&r==="null",leftIsAny:e==="any",rightIsAny:r==="any",bothAreAny:e==="any"&&r==="any",leftIsRange:e==="range",rightIsRange:r==="range"}}};function xle(t){return t.type==="field"||t.type==="group"||t.type==="relationship"||(K.getLogger(Eee).warn("form-info::unsupported-element-type","Only element types 'field', 'group' and 'relationship' are supported",`Element ${t.label} has unsupported type '${t.type}'`),!1)}u([d()],di.prototype,"_featureClone",void 0),u([d()],di.prototype,"activeRelationshipInput",null),u([d()],di.prototype,"_arcadeContextInfo",null),u([d({readOnly:!0})],di.prototype,"allFieldInputs",null),u([d()],di.prototype,"allRelationshipInputs",null),u([d()],di.prototype,"_layerFieldsByName",null),u([d()],di.prototype,"arcadeEditType",void 0),u([d()],di.prototype,"contingencyConstraintViolations",void 0),u([d()],di.prototype,"disabled",void 0),u([d()],di.prototype,"feature",null),u([d()],di.prototype,"fieldsWithContingentValues",null),u([d({type:gTe})],di.prototype,"formTemplate",null),u([d()],di.prototype,"formDescription",null),u([d()],di.prototype,"formTitle",null),u([d()],di.prototype,"formHeaderVisible",null),u([d()],di.prototype,"inputs",void 0),u([d()],di.prototype,"inputFields",null),u([d()],di.prototype,"joinedContingentValues",null),u([d()],di.prototype,"layer",null),u([d()],di.prototype,"map",void 0),u([d()],di.prototype,"relatedRecordCallbacks",void 0),u([d()],di.prototype,"relationshipId",null),u([d()],di.prototype,"spatialReference",null),u([d()],di.prototype,"state",null),u([d()],di.prototype,"strict",void 0),u([d()],di.prototype,"submittable",null),u([d()],di.prototype,"updating",null),u([d()],di.prototype,"valid",null),u([d()],di.prototype,"view",null),u([d()],di.prototype,"getValues",null),u([d()],di.prototype,"submit",null),di=u([R(Eee)],di);const gEe=di,rKe={heading:"esri-widget__heading"};function Gx({level:t,class:e,...r},i){const s=yEe(t);return j(`h${s}`,{...r,class:JQ(rKe.heading,e),role:"heading","aria-level":String(s)},i)}function yEe(t){return ye(Math.ceil(t),1,6)}function k3(t,e=1){return yEe(t+e)}function Cee(t){return e=>{e.hasOwnProperty("_delegatedEventNames")||(e._delegatedEventNames=e._delegatedEventNames?e._delegatedEventNames.slice():[]);const r=e._delegatedEventNames,i=Array.isArray(t)?t:iKe(t);r.push(...i)}}function iKe(t){return t.split(",").map(e=>e.trim())}const Tle="TT",JO="data-field-name",Sle="latn",Ele=t=>"valueAsDate"in t,_Ee="esri.widgets.FeatureForm",Cle=K.getLogger(_Ee);let vn=class extends Rc{constructor(e,r){super(e,r),this._dateFieldInputMap=new Map,this._activeInputName="",this._activeNumberFieldEdit=null,this._fieldFocusNeeded=!1,this._fieldToInitialIncompatibleDomainValue=new Map,this._switchFieldsWithInitialIncompatibleValue=new Set,this._userUpdatedFieldInputNames=new Set,this._listObserverNode=null,this._listObserver=new IntersectionObserver(i=>{i.length&&i[0].isIntersecting&&this._incrementRelatedRecordPage()},{root:window.document}),this.groupDisplay="all",this.headingLevel=2,this.messages=null,this.messagesCommon=null,this.messagesFeature=null,this.messagesTemplates=null,this.viewModel=new gEe,this._onShowAllRelatedRecordsClick=i=>{const{feature:s,relatedRecordCallbacks:n}=this;s&&n?.showAllRelatedRecords&&n.showAllRelatedRecords({parentFeature:s,relationshipId:i})},this._onAddRelatedRecordsClick=(i,s)=>{const{feature:n,relatedRecordCallbacks:o}=this;n&&o?.addRelatedRecord&&o.addRelatedRecord({parentFeature:n,relatedLayer:s,relationshipId:i})},this._handleInputInput=i=>{this._commitInputValue(i.currentTarget)},this._handleFormKeyDown=this._handleFormKeyDown.bind(this),this._handleInputBlur=this._handleInputBlur.bind(this),this._handleInputFocus=this._handleInputFocus.bind(this),this._handleNumberInputMouseDown=this._handleNumberInputMouseDown.bind(this),this._handleInputKeyDown=this._handleInputKeyDown.bind(this),this._handleOptionChange=this._handleOptionChange.bind(this),this._handleGroupClick=this._handleGroupClick.bind(this),this._handleSubmit=this._handleSubmit.bind(this),this._afterInputCreateOrUpdate=this._afterInputCreateOrUpdate.bind(this),this._afterDateInputCreateOrUpdate=this._afterDateInputCreateOrUpdate.bind(this)}initialize(){this.addHandles([Q(()=>this.feature,()=>{const e=this._getFocusableInput("forward");this._activeInputName=e?.name||"",this._userUpdatedFieldInputNames.clear(),this._fieldToInitialIncompatibleDomainValue.clear(),this._switchFieldsWithInitialIncompatibleValue.clear(),this._dateFieldInputMap.clear(),this._fieldFocusNeeded=!0}),this.on("submit",e=>{if(e.invalid.length>0){const[r]=e.invalid;e.invalid.forEach(i=>this._userUpdatedFieldInputNames.add(i)),this._activeInputName=r,this._fieldFocusNeeded=!0,this.scheduleRender()}}),Q(()=>[this.viewModel.activeRelationshipInput,this._listObserverNode],()=>this._onObserverChange())])}loadDependencies(){return oO({button:()=>J(()=>import("./calcite-button-b1570436.js"),["./calcite-button-b1570436.js","./form-c843c929.js","./interactive-1607c36d.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url),combobox:()=>J(()=>import("./calcite-combobox-ad89454e.js"),["./calcite-combobox-ad89454e.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./openCloseComponent-6668f48b.js","./form-c843c929.js","./guid-4f97587b.js","./interactive-1607c36d.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./utils2-b93e21bb.js","./conditionalSlot-e5b503f9.js","./icon-6c56dd6f.js"],import.meta.url),"combobox-item":()=>J(()=>import("./calcite-combobox-item-10278607.js"),["./calcite-combobox-item-10278607.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./guid-4f97587b.js","./interactive-1607c36d.js","./utils2-b93e21bb.js","./icon-6c56dd6f.js"],import.meta.url),"combobox-item-group":()=>J(()=>import("./calcite-combobox-item-group-172c509c.js"),["./calcite-combobox-item-group-172c509c.js","./guid-4f97587b.js","./utils2-b93e21bb.js"],import.meta.url),icon:()=>J(()=>import("./calcite-icon-94f83e8a.js"),["./calcite-icon-94f83e8a.js","./icon-6c56dd6f.js","./observers-333b9ff3.js"],import.meta.url),"input-date-picker":()=>J(()=>import("./calcite-input-date-picker-b8d7b55a.js"),["./calcite-input-date-picker-b8d7b55a.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./form-c843c929.js","./interactive-1607c36d.js","./label2-6ed53214.js","./loadable-7d140904.js","./focusTrapComponent-08ab2cd6.js","./icon-6c56dd6f.js","./guid-4f97587b.js","./input-88645e50.js","./progress-a90520b9.js"],import.meta.url),"input-message":()=>J(()=>import("./calcite-input-message-1d8a3060.js"),["./calcite-input-message-1d8a3060.js","./icon-6c56dd6f.js","./observers-333b9ff3.js"],import.meta.url),"input-time-picker":()=>J(()=>import("./calcite-input-time-picker-31d08010.js"),["./calcite-input-time-picker-31d08010.js","./form-c843c929.js","./guid-4f97587b.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./observers-333b9ff3.js","./focusTrapComponent-08ab2cd6.js","./icon-6c56dd6f.js","./action-e3f08495.js","./loader-cabefae3.js","./input-88645e50.js","./progress-a90520b9.js","./popover-1095e00b.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./FloatingArrow-b345edcc.js"],import.meta.url),list:()=>J(()=>import("./calcite-list-f85ba3b9.js"),["./calcite-list-f85ba3b9.js","./interactive-1607c36d.js","./observers-333b9ff3.js","./utils3-48a6cb5c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js","./input-88645e50.js","./form-c843c929.js","./label2-6ed53214.js","./progress-a90520b9.js","./loader-cabefae3.js","./guid-4f97587b.js","./scrim-2cacfa4b.js"],import.meta.url),"list-item":()=>J(()=>import("./calcite-list-item-3e21bb8f.js"),["./calcite-list-item-3e21bb8f.js","./interactive-1607c36d.js","./utils3-48a6cb5c.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./loadable-7d140904.js","./action-e3f08495.js","./guid-4f97587b.js","./icon-6c56dd6f.js","./loader-cabefae3.js"],import.meta.url),loader:()=>J(()=>import("./calcite-loader-c2c6c73b.js"),["./calcite-loader-c2c6c73b.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url),notice:()=>J(()=>import("./calcite-notice-61fe6537.js"),["./calcite-notice-61fe6537.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js"],import.meta.url),progress:()=>J(()=>import("./calcite-progress-fb1c60c2.js"),["./calcite-progress-fb1c60c2.js","./progress-a90520b9.js"],import.meta.url),switch:()=>J(()=>import("./calcite-switch-0ac15e4a.js"),["./calcite-switch-0ac15e4a.js","./form-c843c929.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js"],import.meta.url)})}destroy(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode)}get _relatedRecordsEnabled(){const e=this.relatedRecordCallbacks;return!(!e||!(e.addRelatedRecord||e.editRelatedRecord||e.showAllRelatedRecords))}get disabled(){return this.viewModel.disabled}set disabled(e){this.viewModel.disabled=e}get feature(){return this.viewModel.feature}set feature(e){this.viewModel.feature=e}get formTemplate(){return this.viewModel.formTemplate}set formTemplate(e){this.viewModel.formTemplate=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layer(){return this.viewModel.layer}set layer(e){this.viewModel.layer=e}get map(){return this.viewModel.map}set map(e){this.viewModel.map=e}get relatedRecordCallbacks(){return this.viewModel.relatedRecordCallbacks}set relatedRecordCallbacks(e){this.viewModel.relatedRecordCallbacks=e}get relationshipId(){return this.viewModel.relationshipId}set relationshipId(e){this.viewModel.relationshipId=e}get spatialReference(){return this.viewModel.spatialReference}set spatialReference(e){this.viewModel.spatialReference=e}get strict(){return this.viewModel.strict}set strict(e){this.viewModel.strict=e}get view(){return Ka(Cle,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view}set view(e){Ka(Cle,"view",{replacement:"Use FeatureForm.map instead.",version:"4.27"}),this.viewModel.view=e}getValues(){return this.viewModel.getValues()}submit(){return this.viewModel.submit()}render(){const{state:e}=this.viewModel;return j("div",{class:this.classes(wr.base,wr.widget,wr.panel)},e==="ready"?this._renderForm():null)}_renderForm(){return j("form",{class:wr.form,novalidate:!0,onsubmit:this._handleSubmit,onkeydown:this._handleFormKeyDown},this._renderHeader(),this._renderInputs())}_renderHeader(){const e=this.viewModel;if(!e.formHeaderVisible)return;const r=e.formTitle!=null&&j(Gx,{key:"title",level:this.headingLevel},e.formTitle),i=e.formDescription!=null&&j("p",{class:wr.description,key:"description"},e.formDescription);return j("div",{class:wr.formHeader},r,i)}_renderInputs(){const{viewModel:e}=this;return e.activeRelationshipInput?this._renderActiveRelationshipInput(e.activeRelationshipInput):e.inputs.filter(Ia).filter(r=>r.visible).map((r,i)=>C1(r)?this._renderGroup(r,i):qv(r)?this._renderLabeledField(r):EC(r)?this._renderRelationshipInput(r):void 0)}_renderActiveRelationshipInput(e){return this._renderRelationshipInput(e)}_renderDescriptionOrEmpty(e,r){return e==null?null:j("div",{class:this.classes(wr.description),id:r},e)}_renderGroup(e,r){const{formTemplate:i,disabled:s}=this,{description:n,inputs:o,label:a,state:l}=e,c=o.filter(T=>T.visible),h=this.viewModel.findField(this._activeInputName),p=!(!h||h.group!==e),f=`${this.id}_group_${r}`,m=`${this.id}_group-label_${r}`,g=`${this.id}_group-description_${r}`,_=this._renderDescriptionOrEmpty(n,g),v=this.groupDisplay==="sequential",b=v?p:l==="expanded",x=b?wr.collapseIcon:wr.expandIcon;return j("fieldset",{"aria-expanded":b.toString(),"aria-labelledby":m,"aria-describedby":n?g:"",class:this.classes(wr.group,v?wr.groupSequential:null,b?null:wr.groupCollapsed,p?wr.groupActive:null,s?wr.inputDisabled:null),disabled:s,"data-group":e,id:f,key:r,onclick:this._handleGroupClick},j("button",{role:v?"presentation":void 0,class:wr.groupHeader,type:"button",tabIndex:v?-1:0},j("div",{class:wr.groupTitle},j(Gx,{class:wr.groupLabel,id:m,level:i!=null&&i.title?k3(this.headingLevel):this.headingLevel},a),_),v?null:j("span",{class:this.classes(x,wr.groupToggleIcon)})),c.map(T=>qv(T)?this._renderLabeledField(T):EC(T)?this._renderRelationshipInput(T):void 0))}_getFocusableInput(e,r){const i=this.viewModel.allFieldInputs,s=e==="forward"?i:i.slice().reverse();let n;if(!r||EC(r))n=0;else if(C1(r)){const o=r.inputs.find(qv);n=o?s.indexOf(o):0}else{let o;if(k9(r)&&r.group.state==="collapsed"){const a=r.group.inputs.filter(qv);o=e==="forward"?a[a.length-1]:a[0]}else o=r;n=s.indexOf(o)+1}for(let o=n;o<s.length;o++){const a=s[o];if(a.visible&&qv(a))return a}return null}_renderLabeledField(e){const{dataType:r,feature:i,label:s,layer:n}=e;return j("label",{key:`${n.id}-${i.uid}-${e.name}`,class:wr.label},[s,r!=="unsupported"?this._renderFieldInput(e):this._renderUnsupportedField(e),this._renderAuxiliaryText(e)])}_renderFieldInput(e){const{dataType:r,domain:i,name:s,updating:n,value:o}=e,a=this.getCommonInputProps(e);if(i?.type==="coded-value"){if(bx(e.element,"switch")){const{element:c}=e;if(!(this._switchFieldsWithInitialIncompatibleValue.has(s)||o==null||c.input.onValue!==o&&c.input.offValue!==o))return this._renderSwitchFieldInput(e,a);this._switchFieldsWithInitialIncompatibleValue.add(s)}return e.inputType==="radio-buttons"?this._renderRadioButtonsFieldInput(e,i.codedValues.map(({code:c,name:h})=>({value:c,name:h})),a):this._renderSelectFieldInput(e,this._getFieldValueOptions(s,i),a)}if(e.inputType==="datetime-picker"||r==="date")return this._renderDateFieldInput(e,a);const l=r==="number"?j("input",{type:"number",...a,value:this._activeNumberFieldEdit!=null&&this._activeNumberFieldEdit.fieldName===e.name?this._activeNumberFieldEdit.value:`${a.value}`}):e.inputType==="text-area"?j("textarea",{...a}):j("input",{type:"text",...a});return n?j("div",{key:`${a.key}-input-updating-wrapper`,class:wr.fieldInputWrapper},l,j("div",{class:wr.fieldInputLoader},j("calcite-progress",{type:"indeterminate"}))):l}_renderDateFieldInput(e,r){const{dateDataType:i,includeTime:s,label:n,name:o,valid:a,value:l}=e,{readOnly:c,required:h}=r;if(i==="string")return this._renderUnsupportedField(e,aTe(e.field,r.value));const{date:p,time:f}=this._formatValueForDateInputs(l),m=r.max!=null?this._formatValueForDateInputs(r.max):void 0,g=r.min!=null?this._formatValueForDateInputs(r.min):void 0,_=m?.date??void 0,v=g?.date??void 0,b={afterCreate:this._afterDateInputCreate,afterUpdate:this._afterDateInputCreateOrUpdate,"aria-invalid":!a,label:n,numberingSystem:Sle,overlayPositioning:"fixed",readOnly:c,required:h,tabIndex:0,[JO]:o};return j("div",{key:`${r.key}-date-time-container`,class:wr.dateInputContainer},j("calcite-input-date-picker",{bind:this,...b,class:this.classes(r.class,wr.inputDate),"data-date-part":"date",key:`${r.key}-date-input`,valueAsDate:p??void 0,maxAsDate:_,minAsDate:v,onCalciteInputDatePickerChange:x=>this._commitDateChanges(x.target),onblur:x=>this._commitDateChanges(x.target,!0)}),s?j("calcite-input-time-picker",{bind:this,...b,class:this.classes(r.class,wr.inputTime),"data-date-part":"time",key:`${r.key}-time-input`,value:f??void 0,step:1,onCalciteInputTimePickerChange:x=>this._commitDateChanges(x.target),onfocus:x=>{x.target.calciteTimePickerEl&&(x.target.calciteTimePickerEl.showSecond=!0)},onblur:x=>this._commitDateChanges(x.target,!0)}):null)}_renderUnsupportedField(e,r){const i=this.getCommonInputProps(e);return j("input",{afterCreate:i.afterCreate,afterUpdate:i.afterUpdate,class:this.classes(wr.input,wr.fieldInput,wr.inputDisabled),onfocus:i.onfocus,readOnly:!0,tabIndex:i.tabIndex,type:"text",value:r!=null?`${r}`:i.value,[JO]:i[JO]})}_renderSelectFieldInput(e,r,i){const{element:s,required:n,value:o}=e,{messages:a,messagesTemplates:l}=this,c=r.map(v=>v.map(b=>j("calcite-combobox-item",{value:`${b.value}`,textLabel:b.name,key:`#${b.value}`,selected:o===b.value}))),[h,p]=c;this._registerIncompatibleValue(o,r.flat(),e,v=>{p.unshift(j("calcite-combobox-item",{value:`${v}`,textLabel:`${v}`,key:"incompatible-option",readOnly:!0}))});const f=p.length>0?[j("calcite-combobox-item-group",{key:"recommended",label:a.recommended},h),j("calcite-combobox-item-group",{key:"other",label:l.other},p)]:h,m=s==null,g=bx(s,"combo-box"),_=m||g&&s.input?.showNoValueOption;if(!n&&_){const v="",b=g&&s.input.noValueOptionLabel||a.empty;f.unshift(j("calcite-combobox-item",{value:v,textLabel:a.empty,key:"empty-option"},b))}return j("calcite-combobox",{...i,selectionMode:"single",disabled:i.readOnly,allowCustomValues:!1,clearDisabled:!0,onCalciteComboboxChange:v=>this._handleOptionChange(v.target)},f)}_registerIncompatibleValue(e,r,i,s){const n=this._fieldToInitialIncompatibleDomainValue,o=n.has(i.name);(o||e!=null&&e!==""&&!r.some(a=>a.value===e))&&(o||n.set(i.name,e),s?.(e))}_renderRadioButtonsFieldInput(e,r,i){const{element:s,name:n,required:o,value:a}=e,l=r.map(f=>this._renderRadioButton({key:f.name,label:f.name,name:n,value:f.value,selected:f.value===a,props:i}));this._registerIncompatibleValue(a,r,e);const c=s==null,h=bx(s,"radio-buttons"),p=c||h&&s.input?.showNoValueOption;if(!o&&p){const f="",m=h&&s.input.noValueOptionLabel||this.messages.empty,g=a===f||a===null;l.unshift(this._renderRadioButton({key:"empty-option",label:m,name:n,value:f,selected:g,props:i}))}return j("div",{key:`${i.key}-radio`,class:wr.inputRadioGroup},l)}_renderSwitchFieldInput(e,r){const{value:i}=e,s=!!bx(e.element,"switch")&&i===e.element.input.onValue;return j("calcite-switch",{...r,class:wr.inputSwitch,onCalciteSwitchChange:n=>this._commitInputValue(n.target),checked:s,disabled:r.readOnly})}_renderRadioButton({key:e,name:r,value:i,selected:s,label:n,props:o}){return j("label",{key:e,class:wr.inputRadioLabel},j("input",{...o,class:wr.inputRadio,name:r,type:"radio",value:i,checked:s,disabled:o.readOnly,onchange:a=>this._commitInputValue(a.target)}),n)}_renderAuxiliaryText(e){const r=this._userUpdatedFieldInputNames.has(e.name)&&!e.valid?eqe(e,this.messages):this.viewModel.contingencyConstraintViolations.get(e.name)!=null?this.messages.validationErrors.valuesIncompatible:e.valueExpressionExecutor!=null&&e.valueExpressionExecutor.stale?this.messages.valueExpressionError:null;return r!=null?j("calcite-input-message",{status:"invalid",icon:!0},r):this._renderDescriptionOrEmpty(e.description)}_renderShowAllRelatedRecordsListItem(e){const{featureCount:r,relationshipId:i,showAllActionVisible:s}=e,{relatedRecordCallbacks:n}=this;if(!s||!n?.showAllRelatedRecords)return;const o=this.messages;return j("calcite-list-item",{description:s1(o.totalCount,{count:r}),label:o.showAll,value:!0,onCalciteListItemSelect:()=>this._onShowAllRelatedRecordsClick(i)},j("calcite-icon",{slot:"content-end",scale:"s",icon:"list"}))}_renderAddRelatedRecordButton(e){const{canAddRelatedFeature:r,relationshipId:i,relatedLayer:s}=e,{relatedRecordCallbacks:n}=this;if(r&&n?.addRelatedRecord&&s)return j("calcite-button",{alignment:"center",appearance:"outline-fill",class:wr.centeredButton,disabled:e.updating,iconStart:"plus",key:`${i}-add-button`,round:!0,scale:"s",width:"half",onclick:()=>this._onAddRelatedRecordsClick(i,s)},this.messages.addRecord)}_renderRelatedRecordListItem(e,r){const{feature:i,description:s,title:n}=e,{feature:o,relatedRecordCallbacks:a}=this,l=()=>{a?.editRelatedRecord&&o&&a.editRelatedRecord({parentFeature:o,relationshipId:r,relatedFeature:i})};return j("calcite-list-item",{bind:this,description:s,label:n,key:`${r}-${i.uid}`,value:n,onclick:l},j("calcite-icon",{slot:"content-start",scale:"m",icon:tqe(i)}),j("calcite-icon",{slot:"content-end",scale:"s",icon:"chevron-right"}))}_renderRelationshipInput(e){if(!this._relatedRecordsEnabled||!e.editable)return;const{featureCount:r,relationshipId:i,showAllEnabled:s}=e,n=s?null:this._renderDescriptionOrEmpty(e.description),o=r>0?this._renderRelatedRecordsList(e):e.loaded?this._renderNoRelatedRecordsNotice():void 0;return j("label",{class:this.classes(wr.label,wr.relationshipLabel),key:`relationship-${i}-container`},j("div",null,this._renderRelatedRecordsHeaderContainer(e),n,o),this._renderAddRelatedRecordButton(e))}_renderRelatedRecordsHeaderContainer(e){const r=e.updating||!e.loaded;return j("div",{class:wr.relatedRecordsHeader,key:`relationship-${e.relationshipId}-header`},j("span",null,e.label),r?j("calcite-loader",{label:this.messagesCommon?.loading,inline:!0,key:"loader",scale:"s",type:"indeterminate"}):void 0)}_renderRelatedRecordsList(e){const{relationshipId:r}=e;return j("calcite-list",{class:wr.relatedRecordsList},e.relatedFeatureInfos.map(i=>this._renderRelatedRecordListItem(i,r)),this._renderShowAllRelatedRecordsListItem(e),this._renderObserverNode())}_renderNoRelatedRecordsNotice(){return j("calcite-notice",{open:!0,scale:"s",kind:"brand",icon:"information",width:"full"},j("div",{slot:"message"},this.messagesFeature.noRelatedFeatures))}_renderObserverNode(){if(this.viewModel.activeRelationshipInput?.showAllEnabled)return j("div",{key:"feature-observer",class:wr.listObserver,bind:this,afterCreate:this._afterListObserverCreated,afterRemoved:this._afterListObserverRemoved})}getCommonInputProps(e){const{disabled:r,groupDisplay:i}=this,{dataType:s,editable:n,group:o,hint:a,label:l,maxLength:c,minLength:h,name:p,required:f,valid:m,value:g}=e,_=this._userUpdatedFieldInputNames.has(p),v=!n||r,b=i==="all"&&o!=null&&o.state==="collapsed";return{afterCreate:this._afterInputCreateOrUpdate,afterUpdate:this._afterInputCreateOrUpdate,"aria-invalid":m?"false":"true",class:this.classes(wr.input,wr.fieldInput,v?wr.inputDisabled:null,_&&!m?wr.inputInvalid:null),key:p,label:l,minlength:h>-1?`${h}`:"",maxlength:c>-1?`${c}`:"",...e.range,readOnly:v,value:g==null?"":`${g}`,[JO]:p,onfocus:this._handleInputFocus,oninput:this._handleInputInput,onblur:this._handleInputBlur,onkeydown:this._handleInputKeyDown,onmousedown:s==="number"?this._handleNumberInputMouseDown:void 0,placeholder:s==="number"||s==="text"?a??void 0:"",required:f,tabIndex:b?-1:0}}_handleNumberInputMouseDown({target:e}){e.focus(),this.scheduleRender()}_getFieldValueOptions(e,r){const i=r.codedValues.map(({code:n,name:o})=>({value:n,name:o})),s=this.viewModel.fieldsWithContingentValues.has(e)?this._getContingentValueOptions(e):[];if(s.length>0){const n=new Set(s.map(o=>o.value));return[s,i.filter(o=>!n.has(o.value))]}return[i,[]]}_getContingentValueOptions(e){const r={};for(const n of this.viewModel.allFieldInputs){const{name:o,value:a}=n;a!=null&&o!==e&&this.viewModel.fieldsWithContingentValues.has(o)&&(r[o]=a)}const i=this.viewModel.joinedContingentValues.slice(),s=new Map;for(const n of i){const o=n.values[e];if(o==null||o.objectType!=="code"&&o.objectType!=="null")continue;const{code:a,name:l}=o.codedValue&&o.objectType!=="null"?o.codedValue:{code:"",name:this.messages.empty};s.has(a)||Object.entries(r).every(([c,h])=>!n.values.hasOwnProperty(c)||this._valueIsValidContingentValue(h,n.values[c]))&&s.set(a,{name:l,value:a})}return[...s.values()]}_getFieldInputFromHTMLElement(e){return this.viewModel.findField(e.getAttribute(JO))}async _afterDateInputCreate(e){this._afterDateInputCreateOrUpdate(e)}_afterDateInputCreateOrUpdate(e){const{name:r}=this._getFieldInputFromHTMLElement(e),i=this._dateFieldInputMap.get(r),s=Ele(e);i!=null?s?i.date=e:i.time=e:this._dateFieldInputMap.set(r,{[s?"date":"time"]:e}),this._afterInputCreateOrUpdate(e)}_afterInputCreateOrUpdate(e){const{viewModel:r}=this,i=this._getFieldInputFromHTMLElement(e),s=r.findField(this._activeInputName),n=this._fieldToInitialIncompatibleDomainValue.get(i.name)===i.value;this._fieldFocusNeeded&&s===i&&(i.inputType!=="radio-buttons"||n||e.checked)&&(this._fieldFocusNeeded=!1,k9(i)&&(i.group.state="expanded"),e.focus())}_handleInputFocus(e){const r=e.target,i=this._getFieldInputFromHTMLElement(r);this._activeInputName=i.name,Poe(i)&&(this._activeNumberFieldEdit={fieldName:i.name,input:r,value:r.value})}_handleInputBlur(e){const r=e.target,i=this._getFieldInputFromHTMLElement(r);i.dataType==="number"&&this._activeNumberFieldEdit!=null&&(this._activeNumberFieldEdit.input.value=`${i.value}`,this._activeNumberFieldEdit=null),this._commitInputValue(r),this.scheduleRender()}_commitDateChanges(e,r=!1){const{name:i}=this._getFieldInputFromHTMLElement(e);if(!this._dateFieldInputMap.has(i))return;const s=this._dateFieldInputMap.get(i);if(!s||!s.date)return;const n=this._getFieldValueFromDateInput(e),o=this._getFieldValueFromDateInputs(s.date,s.time);this.viewModel.getValue(i)!==o&&(n!==null&&o!==null?this._updateFieldValue(i,o):r&&this._updateFieldValue(i,null))}_commitInputValue(e){const r=this._getFieldInputFromHTMLElement(e);this._activeNumberFieldEdit!=null&&Poe(r)&&(this._activeNumberFieldEdit.value=e.value),this._updateFieldValue(r.name,this._parseValue(e))}_handleInputKeyDown(e){const{key:r,altKey:i,ctrlKey:s,metaKey:n}=e,o=this._getFieldInputFromHTMLElement(e.target);if(r==="Enter")k9(o)&&o.group.state==="collapsed"&&(o.group.state="expanded");else{const{type:a}=o.field,l=a==="single"||a==="double";if((a==="integer"||a==="small-integer"||l)&&!i&&!s&&!n&&r.length===1){const c=Number(r),h=["-","+"],p=["e","."],f=l?[...h,...p]:h;isNaN(c)&&!f.includes(r)&&e.preventDefault()}}}_updateFieldValue(e,r){if(this.viewModel.setValue(e,r),this._userUpdatedFieldInputNames.add(e),this.viewModel.fieldsWithContingentValues.has(e)){const i=Object.fromEntries(Object.entries(this.getValues()).filter(([s,n])=>n!=null));this.viewModel.validateContingencyConstraints(i)}}_parseValue(e){const r=this._getFieldInputFromHTMLElement(e),i=e.value;if(bx(r.element,"switch")&&e.tagName!=="CALCITE-COMBOBOX")return e.checked?r.element.input.onValue:r.element.input.offValue;if(r.inputType==="radio-buttons"&&e.type==="radio"&&!e.checked)return r.value;const{dataType:s}=r;return s==="number"?i?parseFloat(i):null:i}_handleOptionChange(e){this._commitInputValue(e),this.scheduleRender()}_handleGroupClick(e){const r=e.currentTarget["data-group"],i=r.state==="expanded",s=this.groupDisplay==="sequential",n=`.${wr.groupHeader}`;if(!(i&&!e.target.closest(n))){if(this._activeInputName=this._getFocusableInput("forward",r)?.name||"",s){const o=e.target.closest(n);if(i&&!o)return;this.viewModel.inputs.forEach(a=>{C1(a)&&a!==r&&(a.state="collapsed")})}r.state=i?"collapsed":"expanded",this._fieldFocusNeeded=s,this.scheduleRender()}}_handleSubmit(e){e.preventDefault()}_handleFormKeyDown(e){e.key==="Enter"&&this.viewModel.submit()}_getDefaultLocaleOptions(){return{locale:Ld(),numberingSystem:Sle}}_getFieldValueFromDateInputs(e,r){const i=this._getDateTimeFromInput(e),s=this._getDateTimeFromInput(r);if(!i&&!s)return null;const n=this._getFieldInputFromHTMLElement(e).range,o=Date.now(),a=n.max!=null&&n.max<o?n.max:o,l=kt.fromMillis(a,this._getDefaultLocaleOptions()),c=i||l,{year:h,month:p,day:f}=c,{hour:m,minute:g,second:_}=s||l,v=c.set({year:h,month:p,day:f,hour:m,minute:g,second:_});return v.isValid?v.toMillis():null}_getDateTimeFromInput(e){if(!e)return null;let r=null;if(Ele(e)){const i=e.valueAsDate;if(!i||Array.isArray(i))return null;r=kt.fromJSDate(i)}else{if(!e.value)return null;r=kt.fromFormat(e.value,Tle,this._getDefaultLocaleOptions())}return r??null}_getFieldValueFromDateInput(e){return this._dateTimeToFieldValue(this._getDateTimeFromInput(e))}_dateTimeToFieldValue(e){return e?.isValid?e.toMillis():null}_dateTimeFromFieldValue(e){return e===null?null:kt.fromMillis(e,this._getDefaultLocaleOptions())}_formatValueForDateInputs(e){if(e==null||isNaN(e))return{date:null,time:null};const r=this._dateTimeFromFieldValue(e);return r?{date:r.toJSDate(),time:r.toFormat(Tle,this._getDefaultLocaleOptions())}:{date:null,time:null}}_valueIsValidContingentValue(e,r){switch(r.objectType){case"any":return!0;case"null":return e==null;case"code":return e===r.codedValue?.code;case"range":return e!=null&&r.minValue!=null&&r.maxValue!=null&&+e>=r.minValue&&+e<=r.maxValue;default:return r.objectType,!1}}_afterListObserverCreated(e){this.viewModel.activeRelationshipInput&&(this._listObserverNode=e)}_afterListObserverRemoved(){this._listObserverNode=null}async _onObserverChange(){this._listObserverNode&&this._listObserver.unobserve(this._listObserverNode);const e=this.viewModel.activeRelationshipInput;if(!e)return;const{showAllEnabled:r,updating:i}=e;this._listObserverNode&&!i&&r&&this._listObserver.observe(this._listObserverNode)}_incrementRelatedRecordPage(){this.viewModel.activeRelationshipInput?.incrementPage()}};u([d()],vn.prototype,"_listObserverNode",void 0),u([d()],vn.prototype,"_relatedRecordsEnabled",null),u([d()],vn.prototype,"disabled",null),u([d()],vn.prototype,"feature",null),u([d()],vn.prototype,"formTemplate",null),u([d()],vn.prototype,"groupDisplay",void 0),u([d()],vn.prototype,"headingLevel",void 0),u([d()],vn.prototype,"label",null),u([d()],vn.prototype,"layer",null),u([d()],vn.prototype,"map",null),u([d(),Aa("esri/widgets/FeatureForm/t9n/FeatureForm")],vn.prototype,"messages",void 0),u([d(),Aa("esri/t9n/common")],vn.prototype,"messagesCommon",void 0),u([d(),Aa("esri/widgets/Feature/t9n/Feature")],vn.prototype,"messagesFeature",void 0),u([d(),Aa("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],vn.prototype,"messagesTemplates",void 0),u([d()],vn.prototype,"relatedRecordCallbacks",null),u([d()],vn.prototype,"relationshipId",null),u([d()],vn.prototype,"spatialReference",null),u([d()],vn.prototype,"strict",null),u([d()],vn.prototype,"view",null),u([d(),Cee(["value-change","submit"])],vn.prototype,"viewModel",void 0),vn=u([R(_Ee)],vn);const sKe=vn;function nKe(t){return typeof t=="function"}function Bkt(t,e,r,i){return nKe(t)?t(e,r,i):t}function Gkt(t){return[t.r,t.g,t.b,t.a]}const oKe=` /-,
`;function Ale(t){let e=t.length;for(;e--;)if(!oKe.includes(t.charAt(e)))return!1;return!0}function aKe(t,e){const r=[];let i=0,s=-1;do if(s=t.indexOf("[",i),s>=i){if(s>i){const n=t.substr(i,s-i);r.push([n,null,Ale(n)])}if(i=s+1,s=t.indexOf("]",i),s>=i){if(s>i){const n=e[t.substr(i,s-i)];n&&r.push([null,n,!1])}i=s+1}}while(s!==-1);if(i<t.length-1){const n=t.substr(i);r.push([n,null,Ale(n)])}return r}function lKe(t,e,r){let i="",s=null;for(const n of e){const[o,a,l]=n;if(o)l?s=o:(s&&(i+=s,s=null),i+=o);else{const c=t.attributes[a];c&&(s&&(i+=s,s=null),i+=c)}}return cKe(i,r)}function jkt(t,e,r){const i=aKe(e,t);return s=>lKe(s,i,r)}function cKe(t,e){switch(typeof t!="string"&&(t=String(t)),e){case"LowerCase":return t.toLowerCase();case"Allcaps":return t.toUpperCase();default:return t}}function Hkt(t,e,r,i,s,n,o=!0){const a=e/s,l=r/n,c=Math.ceil(a/2),h=Math.ceil(l/2);for(let p=0;p<n;p++)for(let f=0;f<s;f++){const m=4*(f+(o?n-p-1:p)*s);let g=0,_=0,v=0,b=0,x=0,T=0,S=0;const O=(p+.5)*l;for(let A=Math.floor(p*l);A<(p+1)*l;A++){const M=Math.abs(O-(A+.5))/h,P=(f+.5)*a,F=M*M;for(let $=Math.floor(f*a);$<(f+1)*a;$++){let N=Math.abs(P-($+.5))/c;const U=Math.sqrt(F+N*N);U>=-1&&U<=1&&(g=2*U*U*U-3*U*U+1,g>0&&(N=4*($+A*e),S+=g*t[N+3],v+=g,t[N+3]<255&&(g=g*t[N+3]/250),b+=g*t[N],x+=g*t[N+1],T+=g*t[N+2],_+=g))}}i[m]=b/_,i[m+1]=x/_,i[m+2]=T/_,i[m+3]=S/v}}function vEe(t){return t?{r:t[0],g:t[1],b:t[2],a:t[3]/255}:{r:0,g:0,b:0,a:0}}function bEe(t){return t.data?.symbol??null}function NW(t){return t.type==="CIMVectorMarker"||t.type==="CIMPictureMarker"||t.type==="CIMBarChartMarker"||t.type==="CIMCharacterMarker"||t.type==="CIMPieChartMarker"||t.type==="CIMStackedBarChartMarker"}function FW(t){return t.type==="CIMGradientStroke"||t.type==="CIMPictureStroke"||t.type==="CIMSolidStroke"}function uKe(t){return t!=null&&(t.type==="CIMGradientFill"||t.type==="CIMHatchFill"||t.type==="CIMPictureFill"||t.type==="CIMSolidFill"||t.type==="CIMWaterFill")}function Bk(t){return t!=null&&(t.type==="CIMMarkerPlacementAlongLineRandomSize"||t.type==="CIMMarkerPlacementAlongLineSameSize"||t.type==="CIMMarkerPlacementAlongLineVariableSize"||t.type==="CIMMarkerPlacementAtExtremities"||t.type==="CIMMarkerPlacementAtMeasuredUnits"||t.type==="CIMMarkerPlacementAtRatioPositions"||t.type==="CIMMarkerPlacementOnLine"||t.type==="CIMMarkerPlacementOnVertices")}const qkt=(t,e=0)=>t==null||isNaN(t)?e:t,Wkt=t=>t.tintColor?vEe(t.tintColor):{r:255,g:255,b:255,a:1},Zkt=t=>{if(!t)return!1;for(const e of t)switch(e.type){case"CIMGeometricEffectBuffer":case"CIMGeometricEffectOffset":case"CIMGeometricEffectDonut":return!0}return!1};function Xkt(){return J(()=>import("./geometryEngineJSON-71004d22.js"),["./geometryEngineJSON-71004d22.js","./geometryEngineBase-7a1f11c2.js","./geometryEngineJSON-b77f7530.js","./json-48e3ea08.js"],import.meta.url)}function Ykt(t){if(!t)return"normal";switch(t.toLowerCase()){case"italic":return"italic";case"oblique":return"oblique";default:return"normal"}}function Jkt(t){if(!t)return"normal";switch(t.toLowerCase()){case"bold":return"bold";case"bolder":return"bolder";case"lighter":return"lighter";default:return"normal"}}function Qkt(t){let e="normal",r="normal";if(t){const i=t.toLowerCase();i.includes("italic")?e="italic":i.includes("oblique")&&(e="oblique"),i.includes("bold")?r="bold":i.includes("light")&&(r="lighter")}return{style:e,weight:r}}function Kkt(t){return t.underline?"underline":t.strikethrough?"line-through":"none"}function Ole(t){if(!t)return null;switch(t.type){case"CIMPolygonSymbol":if(t.symbolLayers)for(const e of t.symbolLayers){const r=Ole(e);if(r!=null)return r}break;case"CIMTextSymbol":return Ole(t.symbol);case"CIMSolidFill":return t.color}}function Rle(t){if(t)switch(t.type){case"CIMPolygonSymbol":case"CIMLineSymbol":{const e=t.symbolLayers;if(e)for(const r of e){const i=Rle(r);if(i!=null)return i}break}case"CIMTextSymbol":return Rle(t.symbol);case"CIMSolidStroke":return t.color}}function Mle(t){if(t)switch(t.type){case"CIMPolygonSymbol":case"CIMLineSymbol":if(t.symbolLayers)for(const e of t.symbolLayers){const r=Mle(e);if(r!==void 0)return r}break;case"CIMTextSymbol":return Mle(t.symbol);case"CIMSolidStroke":case"CIMGradientStroke":case"CIMPictureStroke":return t.width}}function eUt(t){switch(t){case"Left":default:return"left";case"Right":return"right";case"Center":case"Justify":return"center"}}function tUt(t){switch(t){case"Top":default:return"top";case"Center":return"middle";case"Baseline":return"baseline";case"Bottom":return"bottom"}}function rUt(t){return(t?Object.keys(t):[]).map(e=>({name:e,alias:e,type:typeof t[e]=="string"?"esriFieldTypeString":"esriFieldTypeDouble"}))}const iUt=t=>t.includes("data:image/svg+xml");function sUt(t){if(!t)return null;switch(t.type){case"CIMPointSymbol":case"CIMTextSymbol":return"esriGeometryPoint";case"CIMLineSymbol":return"esriGeometryPolyline";case"CIMPolygonSymbol":return"esriGeometryPolygon";default:return null}}function wEe(t,e,r,i){if(t)if(t.type!=="CIMTextSymbol"){if(r&&t.effects)for(const s of t.effects)pKe(s,e);if(t.symbolLayers)for(const s of t.symbolLayers)switch(s.type){case"CIMPictureMarker":case"CIMVectorMarker":hKe(s,e,i);break;case"CIMPictureStroke":case"CIMSolidStroke":!i?.preserveOutlineWidth&&s.width&&(s.width*=e);break;case"CIMPictureFill":s.height&&(s.height*=e),s.offsetX&&(s.offsetX*=e),s.offsetY&&(s.offsetY*=e);break;case"CIMHatchFill":wEe(s.lineSymbol,e,!0,{...i,preserveOutlineWidth:!1}),s.offsetX&&(s.offsetX*=e),s.offsetY&&(s.offsetY*=e),s.separation&&(s.separation*=e)}}else t.height!=null&&(t.height*=e)}function hKe(t,e,r){if(t&&(t.markerPlacement&&dKe(t.markerPlacement,e),t.offsetX&&(t.offsetX*=e),t.offsetY&&(t.offsetY*=e),t.anchorPoint&&t.anchorPointUnits==="Absolute"&&(t.anchorPoint={x:t.anchorPoint.x*e,y:t.anchorPoint.y*e}),t.size=t.size!=null?t.size*e:0,t.type==="CIMVectorMarker"&&t.markerGraphics))for(const i of t.markerGraphics)t.scaleSymbolsProportionally||wEe(i.symbol,e,!0,r)}function dKe(t,e){switch(Bk(t)&&t.offset&&(t.offset*=e),t.type){case"CIMMarkerPlacementAlongLineRandomSize":case"CIMMarkerPlacementAlongLineSameSize":if(t.customEndingOffset&&(t.customEndingOffset*=e),t.offsetAlongLine&&(t.offsetAlongLine*=e),t.placementTemplate&&t.placementTemplate.length){const r=t.placementTemplate.map(i=>i*e);t.placementTemplate=r}break;case"CIMMarkerPlacementAlongLineVariableSize":if(t.maxRandomOffset&&(t.maxRandomOffset*=e),t.placementTemplate&&t.placementTemplate.length){const r=t.placementTemplate.map(i=>i*e);t.placementTemplate=r}break;case"CIMMarkerPlacementOnLine":t.startPointOffset&&(t.startPointOffset*=e);break;case"CIMMarkerPlacementAtExtremities":t.offsetAlongLine&&(t.offsetAlongLine*=e);break;case"CIMMarkerPlacementAtMeasuredUnits":case"CIMMarkerPlacementOnVertices":break;case"CIMMarkerPlacementAtRatioPositions":t.beginPosition&&(t.beginPosition*=e),t.endPosition&&(t.endPosition*=e);break;case"CIMMarkerPlacementPolygonCenter":t.offsetX&&(t.offsetX*=e),t.offsetY&&(t.offsetY*=e);break;case"CIMMarkerPlacementInsidePolygon":t.offsetX&&(t.offsetX*=e),t.offsetY&&(t.offsetY*=e),t.stepX&&(t.stepX*=e),t.stepY&&(t.stepY*=e)}}function pKe(t,e){switch(t.type){case"CIMGeometricEffectArrow":case"CIMGeometricEffectDonut":t.width&&(t.width*=e);break;case"CIMGeometricEffectBuffer":t.size&&(t.size*=e);break;case"CIMGeometricEffectCut":t.beginCut&&(t.beginCut*=e),t.endCut&&(t.endCut*=e),t.middleCut&&(t.middleCut*=e);break;case"CIMGeometricEffectDashes":if(t.customEndingOffset&&(t.customEndingOffset*=e),t.offsetAlongLine&&(t.offsetAlongLine*=e),t.dashTemplate&&t.dashTemplate.length){const r=t.dashTemplate.map(i=>i*e);t.dashTemplate=r}break;case"CIMGeometricEffectExtension":case"CIMGeometricEffectJog":case"CIMGeometricEffectRadial":t.length&&(t.length*=e);break;case"CIMGeometricEffectMove":t.offsetX&&(t.offsetX*=e),t.offsetY&&(t.offsetY*=e);break;case"CIMGeometricEffectOffset":case"CIMGeometricEffectOffsetTangent":t.offset&&(t.offset*=e);break;case"CIMGeometricEffectRegularPolygon":t.radius&&(t.radius*=e);break;case"CIMGeometricEffectTaperedPolygon":t.fromWidth&&(t.fromWidth*=e),t.length&&(t.length*=e),t.toWidth&&(t.toWidth*=e);break;case"CIMGeometricEffectWave":t.amplitude&&(t.amplitude*=e),t.period&&(t.period*=e)}}function xEe(t){const e=[];return kW(bEe(t),e),e.length?new Le(vEe(e[0])):null}function kW(t,e){if(!t)return;let r;r=t.type==="CIMTextSymbol"?t.symbol:t;const i=t.type==="CIMPolygonSymbol";if(r?.symbolLayers){for(const s of r.symbolLayers)if(!(s.colorLocked||i&&(FW(s)||NW(s)&&s.markerPlacement&&Bk(s.markerPlacement))))switch(s.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":s.tintColor&&Ile(e,s.tintColor);break;case"CIMVectorMarker":s.markerGraphics?.forEach(n=>{kW(n.symbol,e)});break;case"CIMSolidStroke":case"CIMSolidFill":Ile(e,s.color);break;case"CIMHatchFill":kW(s.lineSymbol,e)}}}function Ile(t,e){for(const r of t)if(r.join(".")===e.join("."))return;t.push(e)}function nUt(t,e,r){e instanceof Le||(e=new Le(e));const i=bEe(t);i&&UW(i,e,r)}function UW(t,e,r){if(!t)return;let i;i=t.type==="CIMTextSymbol"?t.symbol:t;const s=i?.type==="CIMPolygonSymbol";if(i?.symbolLayers)for(const n of i.symbolLayers){if(n.colorLocked)continue;if(s){if(r){const{layersToColor:a}=r;if((FW(n)||NW(n)&&n.markerPlacement&&Bk(n.markerPlacement))&&a==="fill"||uKe(n)&&a==="outline")continue}else if(FW(n)||NW(n)&&n.markerPlacement&&Bk(n.markerPlacement))continue}const o=e.toArray();switch(n.type){case"CIMPictureMarker":case"CIMPictureStroke":case"CIMPictureFill":n.tintColor=o;break;case"CIMVectorMarker":n.markerGraphics?.forEach(a=>{UW(a.symbol,e,r)});break;case"CIMSolidStroke":case"CIMSolidFill":n.color=o;break;case"CIMHatchFill":UW(n.lineSymbol,e,r)}}}const TEe="picture-fill",SEe="simple-fill",fKe="simple-line",EEe="simple-marker",mKe="text",gKe="cim",hz=new JTe(1e3);function oUt(t){const e=t.style;let r=null;if(t)switch(t.type){case EEe:e!=="cross"&&e!=="x"&&(r=t.color);break;case SEe:e==="solid"?r=t.color:e!=="none"&&(r={type:"pattern",x:0,y:0,src:Dr(`esri/symbols/patterns/${e}.png`),width:5,height:5});break;case TEe:r={type:"pattern",src:t.url,width:vi(t.width)*t.xscale,height:vi(t.height)*t.yscale,x:vi(t.xoffset),y:vi(t.yoffset)};break;case mKe:r=t.color;break;case gKe:r=xEe(t)}return r}function yKe(t,e){const r=t+"-"+e;return hz.get(r)!==void 0?Promise.resolve(hz.get(r)):Lt(t,{responseType:"image"}).then(i=>{const s=i.data,n=s.naturalWidth,o=s.naturalHeight,a=document.createElement("canvas");a.width=n,a.height=o;const l=a.getContext("2d");l.fillStyle=e,l.fillRect(0,0,n,o),l.globalCompositeOperation="destination-in",l.drawImage(s,0,0);const c=a.toDataURL();return hz.put(r,c),c})}function Aee(t){if(!t)return null;let e=null;switch(t.type){case SEe:case TEe:case EEe:e=Aee(t.outline);break;case fKe:{const r=vi(t.width);t.style!=null&&t.style!=="none"&&r!==0&&(e={color:t.color,style:Oee(t.style),width:r,cap:t.cap,join:t.join==="miter"?vi(t.miterLimit):t.join});break}default:e=null}return e}const Oee=(()=>{const t={};return e=>{if(t[e])return t[e];const r=e.replaceAll("-","");return t[e]=r,r}})(),_Ke=new Le([128,128,128]);var la;(function(t){t[t.size=22]="size",t[t.lineWidth=50]="lineWidth",t[t.maxSize=120]="maxSize",t[t.maxOutlineSize=80]="maxOutlineSize",t[t.tallSymbolWidth=20]="tallSymbolWidth"})(la||(la={}));const VW={fill:[{type:"path",path:"M -10,-10 L 10,0 L 10,10 L -10,10 L -10,-10 Z"}],squareFill:[{type:"path",path:"M -10,-10 L 10,-10 L 10,10 L -10,10 L -10,-10 Z"}],pathSymbol3DLayer:[{type:"path",path:"M 3,12 L 12,0 L 11,-2 L -4,5 L -1,5 L 1,7 L 3,10 L 3,12 Z"},{type:"circle",cx:-2,cy:10,r:5}],extrudeSymbol3DLayer:[{type:"path",path:"M -7,-5 L -2,0 L -2,7 L -7,3 L -7,-5 Z"},{type:"path",path:"M -2,0 L -2,7 L 10,-3 L 10,-10 L -2,0 Z"},{type:"path",path:"M -7,-5 L -2,0 L 10,-10 L -2,-10 L -7,-5 Z"}],cone:[{type:"path",path:"M 0,-10 L -8,5 L -4,6.5 L 0,7 L 4,6.5 L 8,5 Z"}],tallCone:[{type:"path",path:"M 0,-9 L -3.5,7 L -1.5,7.8 L 0,8 L 1.5,7.8 L 3.5,7 L 0,-9 Z"}],invertedCone:[{type:"path",path:"M 0,7 L -8,-8 L 8,-8 Z"},{type:"path",path:"M -8,-8 L -4,-9.5 L 0,-10 L 4,-9.5 L 8,-8 L 4,-6.5 L 0,-6 L -4,-6.5 Z"}],cube:[{type:"path",path:"M -10,-7 L 0,-12 L 10,-7 L 0,-2 L -10,-7 Z"},{type:"path",path:"M -10,-7 L 0,-2 L 0,12 L -10,7 L -10,-7 Z"},{type:"path",path:"M 0,-2 L 10,-7 L 10,7 L 0,12 L 0,-2 Z"}],tallCube:[{type:"path",path:"M -3.5,-8.5 L 0,-9.5 L 3.5,-8.5 L 0,-7.5 L -3.5,-8.5 Z"},{type:"path",path:"M -3.5,-8.5 L 0,-7.5 L 0,9 L -3.5,8 L -3.5,-8.5 Z"},{type:"path",path:"M 0,-7.5 L 3.5,-8.5 L 3.5,8 L 0,9 L 0,-7.5 Z"}],cylinder:[{type:"path",path:"M -8,-9 L -8,7 L -4,8.5 L 0,9 L 4,8.5 L 8,7 L 8,-9 Z"},{type:"ellipse",cx:0,cy:-9,rx:8,ry:2}],tallCylinder:[{type:"path",path:"M -3.5,-9 L -3.5,7 L -1.5,7.8 L 0,8 L 1.5,7.8 L 3.5,7 L 3.5,-9 Z"},{type:"ellipse",cx:0,cy:-9,rx:3.5,ry:1}],diamond:[{type:"path",path:"M 0,-10 L 10,-1 L -1,1 L 0,-10 Z"},{type:"path",path:"M 0,-10 L -1,1 L -8,-1 L 0,-10 Z"},{type:"path",path:"M -1,1 L 0,10 L -8,-1 L -1,1 Z"},{type:"path",path:"M -1,0 L 0,10 L 10,-1 L -1,1 Z"}],tetrahedron:[{type:"path",path:"M 0,-10 L 10,7 L 0,0 L 0,-10 Z"},{type:"path",path:"M 0,-10 L 0,0 L -8,7 L 0,-10 Z"},{type:"path",path:"M 10,7 L 0,0 L -8,7 L 10,7 Z"}]};function vKe(t,e,r){const i=la.size;let s=i,n=i;t<1?s*=.75:t>1&&(n*=1.25);const o=0,a=0;let l=i,c=i;return e&&r&&(s=n=l=c=0),[{type:"path",path:[{command:"M",values:[l,o]},{command:"L",values:[r?l:.875*l,o]},{command:"L",values:[r?s-.5*l:a,n-.5*c]},{command:"L",values:[s-.5*l,n-.5*c]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[l,o]},{command:"L",values:[l,e?o:.125*c]},{command:"L",values:[s-.5*l,e?n-.5*c:c]},{command:"L",values:[s-.5*l,n-.5*c]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[s-.5*l,n-.5*c]},{command:"L",values:[r?s-.5*l:a,n-.5*c]},{command:"L",values:[r?s-.5*l:a,e?n-.5*c:c]},{command:"L",values:[s-.5*l,e?n-.5*c:c]},{command:"Z",values:[]}]}]}function bKe(t){const e=la.size,r=.5*t,i=0,s=0;return[{type:"path",path:[{command:"M",values:[s,.7*e*.5]},{command:"L",values:[.3*e,.7*e]},{command:"L",values:[.3*e,.7*e+r]},{command:"L",values:[s,.7*e+r-.7*e*.5]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.3*e,.7*e]},{command:"L",values:[.3*e,.7*e+r]},{command:"L",values:[e,r]},{command:"L",values:[e,i]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.3*e,i]},{command:"L",values:[e,i]},{command:"L",values:[.3*e,.7*e]},{command:"L",values:[s,.7*e*.5]},{command:"Z",values:[]}]}]}function wKe(){return[{type:"path",path:"M80,80.2v-27c-1.5,0.7-2.8,1.6-3.9,2.8c-1.8,2.1-4.4,3.3-7.1,3.5c-2.7-0.1-5.3-1.4-7.1-3.4c-2.2-2.3-4.7-3.6-7.4-3.6s-5.1,1.3-7.3,3.6c-1.8,2.1-4.4,3.3-7.2,3.4c-2.7-0.1-5.3-1.4-7.1-3.4c-2.2-2.3-4.7-3.6-7.4-3.6s-5.1,1.3-7.4,3.6c-1.8,2.1-4.4,3.3-7.2,3.4C8.3,59.3,5.7,58,3.9,56c-1.1-1.2-2.4-2.1-3.9-2.8v27"},{type:"path",path:"M11,59.4c2.7-0.1,5.3-1.4,7.1-3.4c2.2-2.3,4.7-3.6,7.4-3.6s5.1,1.3,7.4,3.6c1.8,2,4.4,3.3,7.2,3.4c2.7-0.1,5.3-1.4,7.1-3.4c2.2-2.3,4.7-3.6,7.3-3.6s5.1,1.3,7.4,3.6c1.8,2.1,4.4,3.3,7.2,3.4c2.7-0.1,5.3-1.4,7.1-3.4c1.1-1.2,2.4-2.1,3.9-2.8v-24c-1.5,0.7-2.8,1.6-3.9,2.8c-1.8,2.1-4.4,3.3-7.1,3.5c-2.7-0.1-5.3-1.4-7.1-3.4c-2.2-2.3-4.7-3.6-7.4-3.6s-5.1,1.3-7.3,3.6c-1.8,2.1-4.4,3.3-7.2,3.4c-2.7-0.1-5.3-1.4-7.1-3.4c-2.2-2.3-4.7-3.6-7.4-3.6s-5.1,1.3-7.4,3.6c-1.8,2.1-4.4,3.3-7.2,3.4c-2.7-0.1-5.3-1.4-7.1-3.4c-1.1-1.2-2.4-2.1-3.9-2.8v24c1.5,0.7,2.8,1.6,3.9,2.8C5.7,58,8.3,59.3,11,59.4z"},{type:"path",path:"M11,35.4c2.7-0.1,5.3-1.4,7.1-3.4c2.2-2.3,4.7-3.6,7.4-3.6s5.1,1.3,7.4,3.6c1.8,2,4.4,3.3,7.2,3.4c2.7-0.1,5.3-1.4,7.1-3.4c2.2-2.3,4.7-3.6,7.3-3.6s5.1,1.3,7.4,3.6c1.8,2.1,4.4,3.3,7.2,3.4c2.7-0.1,5.3-1.4,7.1-3.4c1.1-1.2,2.4-2.1,3.9-2.8V3.6c-1.5,0.7-2.8,1.6-3.9,2.8c-2.2,2.1-4.6,3.4-7.1,3.4s-5-1.3-7.1-3.4s-4.7-3.6-7.4-3.6s-5.1,1.3-7.3,3.6S42.5,9.9,40,9.9s-5-1.3-7.1-3.4s-4.7-3.6-7.4-3.6s-5.1,1.3-7.3,3.6c-1.8,2.1-4.4,3.3-7.2,3.4c-2.5,0-5-1.3-7.1-3.4C2.8,5.3,1.4,4.3,0,3.6v25.6c1.5,0.7,2.8,1.6,3.9,2.8C5.7,34.1,8.3,35.3,11,35.4z"}]}function xKe(t,e){let r=e?la.tallSymbolWidth:t;const i=t,s=e?4:6;r<=la.size?r-=.5*s:r-=s;const n=0,o=0,a=e?.35*r:.5*r;return[{type:"path",path:[{command:"M",values:[.5*r,n]},{command:"L",values:[r,.5*a]},{command:"L",values:[.5*r,a]},{command:"L",values:[o,.5*a]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[n,.5*a]},{command:"L",values:[.5*r,a]},{command:"L",values:[.5*r,i]},{command:"L",values:[o,i-.5*a]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.5*r,a]},{command:"L",values:[.5*r,i]},{command:"L",values:[r,i-.5*a]},{command:"L",values:[r,.5*a]},{command:"Z",values:[]}]}]}function TKe(t,e){let r=e?la.tallSymbolWidth:t;const i=t,s=e?4:6;r<=la.size?r-=.5*s:r-=s;const n=.5*r,o=.15*r,a=0,l=i-o;return[{type:"ellipse",cx:.5*r,cy:l,rx:n,ry:o},{type:"path",path:[{command:"M",values:[a,o]},{command:"L",values:[a,l]},{command:"L",values:[r,l]},{command:"L",values:[r,o]},{command:"Z",values:[]}]},{type:"ellipse",cx:.5*r,cy:o,rx:n,ry:o}]}function SKe(t,e){let r=e?la.tallSymbolWidth:t;const i=t,s=e?4:6;r<=la.size?r-=.5*s:r-=s;const n=.15*r,o=i-n;return[{type:"ellipse",cx:.5*r,cy:o,rx:.5*r,ry:n},{type:"path",path:[{command:"M",values:[.5*r,0]},{command:"L",values:[r,o]},{command:"L",values:[0,o]},{command:"Z",values:[]}]}]}function EKe(t){let e=t;const r=t,i=6;e<la.size?e-=.5*i:e-=i;const s=.15*e,n=0;return[{type:"path",path:[{command:"M",values:[0,n]},{command:"L",values:[e,n]},{command:"L",values:[.5*e,r-s]},{command:"Z",values:[]}]},{type:"ellipse",cx:.5*e,cy:n,rx:.5*e,ry:s}]}function CKe(t){let e=t;const r=t,i=4;e<la.size?e-=.5*i:e-=i;const s=0,n=0,o=e,a=r,l=Math.floor(t/10)-1||1;return[{type:"path",path:[{command:"M",values:[.45*o,s]},{command:"L",values:[o,.5*a-l]},{command:"L",values:[.45*o-l,.5*a+l]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.45*o,s]},{command:"L",values:[.45*o-l,.5*a+l]},{command:"L",values:[n,.5*a-l]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[n,.5*a-l]},{command:"L",values:[.45*o-l,.5*a+l]},{command:"L",values:[.45*o,r]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.45*o,r]},{command:"L",values:[o,.5*a-l]},{command:"L",values:[.45*o-l,.5*a+l]},{command:"Z",values:[]}]}]}function AKe(t){const e=t,r=2;let i=t;i<la.size?i-=.5*r:i-=r;const s=0,n=0;return[{type:"path",path:[{command:"M",values:[.45*e,s]},{command:"L",values:[e,i]},{command:"L",values:[.45*e,.6*i]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[.45*e,s]},{command:"L",values:[.45*e,.6*i]},{command:"L",values:[n,i]},{command:"Z",values:[]}]},{type:"path",path:[{command:"M",values:[n,i]},{command:"L",values:[.45*e,.6*i]},{command:"L",values:[e,i]},{command:"Z",values:[]}]}]}function A1(t,e){return Math.round(Math.min(Math.max(t+255*e*.75,0),255))}function aUt(t,e){if(t==null)return new Le;if("type"in t&&(t.type==="linear"||t.type==="pattern"))return t;const r=new Le(t);return new Le([A1(r.r,e),A1(r.g,e),A1(r.b,e),r.a])}function OKe(t){return"r"in t&&"g"in t&&"b"in t}function CEe(t){return"h"in t&&"s"in t&&"v"in t}function AEe(t){return"l"in t&&"a"in t&&"b"in t}function OEe(t){return"l"in t&&"c"in t&&"h"in t}function RKe(t){return"x"in t&&"y"in t&&"z"in t}const MKe=[[.4124,.3576,.1805],[.2126,.7152,.0722],[.0193,.1192,.9505]],IKe=[[3.2406,-1.5372,-.4986],[-.9689,1.8758,.0415],[.0557,-.204,1.057]];function REe(t,e){const r=[];let i,s;if(t[0].length!==e.length)throw new Error("dimensions do not match");const n=t.length,o=t[0].length;let a=0;for(i=0;i<n;i++){for(a=0,s=0;s<o;s++)a+=t[i][s]*e[s];r.push(a)}return r}function MEe(t){const e=[t.r/255,t.g/255,t.b/255].map(i=>i<=.04045?i/12.92:((i+.055)/1.055)**2.4),r=REe(MKe,e);return{x:100*r[0],y:100*r[1],z:100*r[2]}}function Ree(t){const e=REe(IKe,[t.x/100,t.y/100,t.z/100]).map(r=>{const i=r<=.0031308?12.92*r:1.055*r**.4166666666666667-.055;return Math.min(1,Math.max(i,0))});return{r:Math.round(255*e[0]),g:Math.round(255*e[1]),b:Math.round(255*e[2])}}function IEe(t){const e=[t.x/95.047,t.y/100,t.z/108.883].map(r=>r>.008856451679035631?r**.3333333333333333:7.787037037037035*r+.13793103448275862);return{l:116*e[1]-16,a:500*(e[0]-e[1]),b:200*(e[1]-e[2])}}function PEe(t){const e=t.l,r=[(e+16)/116+t.a/500,(e+16)/116,(e+16)/116-t.b/200].map(i=>i>6/29?i**3:3*(6/29)**2*(i-4/29));return{x:95.047*r[0],y:100*r[1],z:108.883*r[2]}}function PKe(t){const e=t.l,r=t.a,i=t.b,s=Math.sqrt(r*r+i*i);let n=Math.atan2(i,r);return n=n>0?n:n+2*Math.PI,{l:e,c:s,h:n}}function $Ke(t){const e=t.l,r=t.c,i=t.h;return{l:e,a:r*Math.cos(i),b:r*Math.sin(i)}}function LKe(t){return IEe(MEe(t))}function DKe(t){return Ree(PEe(t))}function NKe(t){return PKe(IEe(MEe(t)))}function FKe(t){return Ree(PEe($Ke(t)))}function kKe(t){const e=t.r,r=t.g,i=t.b,s=Math.max(e,r,i),n=s-Math.min(e,r,i);let o=s,a=n===0?0:s===e?(r-i)/n%6:s===r?(i-e)/n+2:(e-r)/n+4,l=n===0?0:n/o;return a<0&&(a+=6),a*=60,l*=100,o*=100/255,{h:a,s:l,v:o}}function UKe(t){const e=(t.h+360)%360/60,r=t.s/100,i=t.v/100*255,s=i*r,n=s*(1-Math.abs(e%2-1));let o;switch(Math.floor(e)){case 0:o={r:s,g:n,b:0};break;case 1:o={r:n,g:s,b:0};break;case 2:o={r:0,g:s,b:n};break;case 3:o={r:0,g:n,b:s};break;case 4:o={r:n,g:0,b:s};break;case 5:case 6:o={r:s,g:0,b:n};break;default:o={r:0,g:0,b:0}}return o.r=Math.round(o.r+i-s),o.g=Math.round(o.g+i-s),o.b=Math.round(o.b+i-s),o}function v$(t){return OKe(t)?t:OEe(t)?FKe(t):AEe(t)?DKe(t):RKe(t)?Ree(t):CEe(t)?UKe(t):t}function Mee(t){return CEe(t)?t:kKe(v$(t))}function lUt(t){return AEe(t)?t:LKe(v$(t))}function cUt(t){return OEe(t)?t:NKe(v$(t))}function Gk(){const t=new Float32Array(6);return t[0]=1,t[3]=1,t}function VKe(t){const e=new Float32Array(6);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e}function zKe(t,e,r,i,s,n){const o=new Float32Array(6);return o[0]=t,o[1]=e,o[2]=r,o[3]=i,o[4]=s,o[5]=n,o}function BKe(t,e){return new Float32Array(t,e,6)}function $Ee(t,e,r,i){const s=e[i],n=e[i+1];t[i]=r[0]*s+r[2]*n+r[4],t[i+1]=r[1]*s+r[3]*n+r[5]}function GKe(t,e,r,i=0,s=0,n=2){const o=s||e.length/n;for(let a=i;a<o;a++)$Ee(t,e,r,a*n)}Object.freeze(Object.defineProperty({__proto__:null,clone:VKe,create:Gk,createView:BKe,fromValues:zKe,transform:$Ee,transformMany:GKe},Symbol.toStringTag,{value:"Module"}));function jKe(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t}function PV(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=0,t[5]=0,t}function HKe(t,e,r,i,s,n,o){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t}function LEe(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5];let l=r*n-i*s;return l?(l=1/l,t[0]=n*l,t[1]=-i*l,t[2]=-s*l,t[3]=r*l,t[4]=(s*a-n*o)*l,t[5]=(i*o-r*a)*l,t):null}function qKe(t){return t[0]*t[3]-t[1]*t[2]}function Tx(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1],p=r[2],f=r[3],m=r[4],g=r[5];return t[0]=i*c+n*h,t[1]=s*c+o*h,t[2]=i*p+n*f,t[3]=s*p+o*f,t[4]=i*m+n*g+a,t[5]=s*m+o*g+l,t}function $V(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=Math.sin(r),h=Math.cos(r);return t[0]=i*h+n*c,t[1]=s*h+o*c,t[2]=i*-c+n*h,t[3]=s*-c+o*h,t[4]=a,t[5]=l,t}function Iee(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i*c,t[1]=s*c,t[2]=n*h,t[3]=o*h,t[4]=a,t[5]=l,t}function LV(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=r[0],h=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=i*c+n*h+a,t[5]=s*c+o*h+l,t}function WKe(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t[4]=0,t[5]=0,t}function ZKe(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t[4]=0,t[5]=0,t}function Pee(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t[4]=e[0],t[5]=e[1],t}function XKe(t){return"mat2d("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+")"}function YKe(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+1)}function JKe(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t}function DEe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t}function QKe(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t}function KKe(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t}function eet(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]}function tet(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=e[0],c=e[1],h=e[2],p=e[3],f=e[4],m=e[5],g=sl();return Math.abs(r-l)<=g*Math.max(1,Math.abs(r),Math.abs(l))&&Math.abs(i-c)<=g*Math.max(1,Math.abs(i),Math.abs(c))&&Math.abs(s-h)<=g*Math.max(1,Math.abs(s),Math.abs(h))&&Math.abs(n-p)<=g*Math.max(1,Math.abs(n),Math.abs(p))&&Math.abs(o-f)<=g*Math.max(1,Math.abs(o),Math.abs(f))&&Math.abs(a-m)<=g*Math.max(1,Math.abs(a),Math.abs(m))}const ret=Tx,iet=DEe;Object.freeze(Object.defineProperty({__proto__:null,add:JKe,copy:jKe,determinant:qKe,equals:tet,exactEquals:eet,frob:YKe,fromRotation:WKe,fromScaling:ZKe,fromTranslation:Pee,identity:PV,invert:LEe,mul:ret,multiply:Tx,multiplyScalar:QKe,multiplyScalarAndAdd:KKe,rotate:$V,scale:Iee,set:HKe,str:XKe,sub:iet,subtract:DEe,translate:LV},Symbol.toStringTag,{value:"Module"}));const set="http://www.w3.org/2000/svg";let net=0,oet=0;const Ple=le("android"),aet=le("chrome")||Ple&&Ple>=4?"auto":"optimizeLegibility",cet={m:2,l:2,h:1,v:1,c:6,s:4,q:4,t:2,a:7,z:0},uet=/([A-DF-Za-df-z])|([-+]?\d*[.]?\d+(?:[eE][-+]?\d+)?)/g;let un={},Ui={};const $le={solid:"none",shortdash:[4,1],shortdot:[1,1],shortdashdot:[4,1,1,1],shortdashdotdot:[4,1,1,1,1,1],dot:[1,3],dash:[4,3],longdash:[8,3],dashdot:[4,3,1,3],longdashdot:[8,3,1,3],longdashdotdot:[8,3,1,3,1,3]},het=Math.PI;let det=1;function YE(t,e){const r=t*(het/180);return Math.abs(e*Math.sin(r))+Math.abs(e*Math.cos(r))}function NEe(t){return t.map(e=>`${e.command} ${e.values.join(" ")}`).join(" ").trim()}function FEe(t,e,r,i){if(t){if(t.type==="circle")return j("circle",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-dashoffset":r.dashOffset,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,r:t.r});if(t.type==="ellipse")return j("ellipse",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",cx:t.cx,cy:t.cy,rx:t.rx,ry:t.ry});if(t.type==="rect")return j("rect",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",x:t.x,y:t.y,width:t.width,height:t.height});if(t.type==="image")return j("image",{href:t.src,x:t.x,y:t.y,width:t.width,height:t.height,preserveAspectRatio:"none"});if(t.type==="path"){const s=typeof t.path!="string"?NEe(t.path):t.path;return j("path",{fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4",d:s})}if(t.type==="text")return rS(i),j("text",{"dominant-baseline":i.dominantBaseline,fill:e,"fill-rule":"evenodd",stroke:r.color,"stroke-width":r.width,"stroke-linecap":r.cap,"stroke-linejoin":r.join,"stroke-dasharray":r.dashArray,"stroke-miterlimit":"4","text-anchor":i.align,"text-decoration":i.decoration,kerning:i.kerning,rotate:i.rotate,"text-rendering":aet,"font-style":i.font.style,"font-variant":i.font.variant,"font-weight":i.font.weight,"font-size":i.font.size,"font-family":i.font.family,x:t.x,y:t.y},t.text)}return null}function kEe(t){const e={fill:"none",pattern:null,linearGradient:null};if(t){if("type"in t&&t.type==="pattern"){const r="patternId-"+ ++net;e.fill=`url(#${r})`,e.pattern={id:r,x:t.x,y:t.y,width:t.width,height:t.height,image:{x:0,y:0,width:t.width,height:t.height,href:t.src}}}else if("type"in t&&t.type==="linear"){const r="linearGradientId-"+ ++oet;e.fill=`url(#${r})`,e.linearGradient={id:r,x1:t.x1,y1:t.y1,x2:t.x2,y2:t.y2,stops:t.colors.map(i=>({offset:i.offset,color:i.color&&new Le(i.color).toString()}))}}else if(t){const r=new Le(t);e.fill=r.toString()}}return e}function UEe(t){const e={color:"none",width:1,cap:"butt",join:"4",dashArray:"none",dashOffset:"0"};if(t&&(t.width!=null&&(e.width=t.width),t.cap&&(e.cap=t.cap),t.join&&(e.join=t.join.toString()),t.color&&(e.color=new Le(t.color).toString()),t.dashArray&&(e.dashArray=t.dashArray),t.dashArray&&(e.dashOffset=t.dashoffset),t.style)){let r=null;if(t.style in $le&&(r=$le[t.style]),Array.isArray(r)){r=r.slice(0);const i=t.width??0;for(let s=0;s<r.length;++s)r[s]*=i;if(t.cap!=="butt"){for(let s=0;s<r.length;s+=2)r[s]-=i,r[s]<1&&(r[s]=1);for(let s=1;s<r.length;s+=2)r[s]+=i}r=r.join(",")}e.dashArray=r}return e}function VEe(t,e){const r={align:null,decoration:null,kerning:null,rotate:null,font:{style:null,variant:null,weight:null,size:null,family:null}};if(t){const i=t.alignBaseline,s=i==="baseline"?"auto":i==="top"?"text-top":i==="bottom"?"hanging":i;r.align=t.align,r.dominantBaseline=s,r.decoration=t.decoration,r.kerning=t.kerning?"auto":"0",r.rotate=t.rotated?"90":"0",rS(e),r.font.style=e.style||"normal",r.font.variant=e.variant||"normal",r.font.weight=e.weight||"normal",r.font.size=e.size&&e.size.toString()||"10pt",r.font.family=e.family||"serif"}return r}function pet(t){const{pattern:e,linearGradient:r}=t;if(e)return j("pattern",{id:e.id,patternUnits:"userSpaceOnUse",x:e.x,y:e.y,width:e.width,height:e.height},j("image",{x:e.image.x,y:e.image.y,width:e.image.width,height:e.image.height,href:e.image.href}));if(r){const i=r.stops.map((s,n)=>j("stop",{key:`${n}-stop`,offset:s.offset,"stop-color":s.color}));return j("linearGradient",{id:r.id,gradientUnits:"userSpaceOnUse",x1:r.x1,y1:r.y1,x2:r.x2,y2:r.y2},i)}return null}function fet(t,e){if(!t||t.length===0)return null;const r=[];for(const i of t){const{shape:s,fill:n,stroke:o,font:a}=i,l=kEe(n),c=UEe(o),h=s.type==="text"?VEe(s,a):null,p=FEe(s,l.fill,c,h);p&&r.push(p)}return j("mask",{id:e,maskUnits:"userSpaceOnUse"},j("g",null,r))}function Lle(t,e,r){return LV(t,PV(t),[e,r])}function Dle(t,e,r,i,s){return Iee(t,PV(t),[e,r]),t[4]=t[4]*e-i*e+i,t[5]=t[5]*r-s*r+s,t}function met(t,e,r,i){const s=e%360*Math.PI/180;$V(t,PV(t),s);const n=Math.cos(s),o=Math.sin(s),a=t[4],l=t[5];return t[4]=a*n-l*o+i*o-r*n+r,t[5]=l*n+a*o-r*o-i*n+i,t}function Hl(t,e){un&&"left"in un?(un.left!=null&&un.left>t&&(un.left=t),(un.right==null||un.right<t)&&(un.right=t),(un.top==null||un.top>e)&&(un.top=e),(un.bottom==null||un.bottom<e)&&(un.bottom=e)):un={left:t,bottom:e,right:t,top:e}}function Nle(t){const e=t.args,r=e.length;let i;switch(t.action){case"M":case"L":case"C":case"S":case"Q":case"T":for(i=0;i<r;i+=2)Hl(e[i],e[i+1]);Ui.x=e[r-2],Ui.y=e[r-1];break;case"H":for(i=0;i<r;++i)Hl(e[i],Ui.y);Ui.x=e[r-1];break;case"V":for(i=0;i<r;++i)Hl(Ui.x,e[i]);Ui.y=e[r-1];break;case"m":{let s=0;for(("x"in Ui)||(Hl(Ui.x=e[0],Ui.y=e[1]),s=2),i=s;i<r;i+=2)Hl(Ui.x+=e[i],Ui.y+=e[i+1]);break}case"l":case"t":for(i=0;i<r;i+=2)Hl(Ui.x+=e[i],Ui.y+=e[i+1]);break;case"h":for(i=0;i<r;++i)Hl(Ui.x+=e[i],Ui.y);break;case"v":for(i=0;i<r;++i)Hl(Ui.x,Ui.y+=e[i]);break;case"c":for(i=0;i<r;i+=6)Hl(Ui.x+e[i],Ui.y+e[i+1]),Hl(Ui.x+e[i+2],Ui.y+e[i+3]),Hl(Ui.x+=e[i+4],Ui.y+=e[i+5]);break;case"s":case"q":for(i=0;i<r;i+=4)Hl(Ui.x+e[i],Ui.y+e[i+1]),Hl(Ui.x+=e[i+2],Ui.y+=e[i+3]);break;case"A":for(i=0;i<r;i+=7)Hl(e[i+5],e[i+6]);Ui.x=e[r-2],Ui.y=e[r-1];break;case"a":for(i=0;i<r;i+=7)Hl(Ui.x+=e[i+5],Ui.y+=e[i+6])}}function Fle(t,e,r){const i=cet[t.toLowerCase()];let s;typeof i=="number"&&(i?e.length>=i&&(s={action:t,args:e.slice(0,e.length-e.length%i)},r.push(s),Nle(s)):(s={action:t,args:[]},r.push(s),Nle(s)))}function get(t){const e=(typeof t.path!="string"?NEe(t.path):t.path).match(uet),r=[];if(un={},Ui={},!e)return null;let i="",s=[];const n=e.length;for(let a=0;a<n;++a){const l=e[a],c=parseFloat(l);isNaN(c)?(i&&Fle(i,s,r),s=[],i=l):s.push(c)}Fle(i,s,r);const o={x:0,y:0,width:0,height:0};return un&&"left"in un&&(o.x=un.left,o.y=un.top,o.width=un.right-un.left,o.height=un.bottom-un.top),o}function yet(t){const e={x:0,y:0,width:0,height:0};if(t.type==="circle")e.x=t.cx-t.r,e.y=t.cy-t.r,e.width=2*t.r,e.height=2*t.r;else if(t.type==="ellipse")e.x=t.cx-t.rx,e.y=t.cy-t.ry,e.width=2*t.rx,e.height=2*t.ry;else if(t.type==="image"||t.type==="rect")e.x=t.x,e.y=t.y,e.width=t.width,e.height=t.height;else if(t.type==="path"){const r=Ha(get(t));e.x=r.x,e.y=r.y,e.width=r.width,e.height=r.height}return e}function _et(t){const e={x:0,y:0,width:0,height:0};let r=null,i=Number.NEGATIVE_INFINITY,s=Number.NEGATIVE_INFINITY;for(const n of t)r?(r.x=Math.min(r.x,n.x),r.y=Math.min(r.y,n.y),i=Math.max(i,n.x+n.width),s=Math.max(s,n.y+n.height)):(r=e,r.x=n.x,r.y=n.y,i=n.x+n.width,s=n.y+n.height);return r&&(r.width=i-r.x,r.height=s-r.y),r}function vet(t,e,r,i,s,n,o,a,l){let c=(o&&n?YE(n,e):e)/2,h=(o&&n?YE(n,r):r)/2;if(l){const x=l[0],T=l[1];c=(o&&n?YE(n,x):x)/2,h=(o&&n?YE(n,T):T)/2}const p=t.width+i,f=t.height+i,m=Gk(),g=Gk();let _=!1;if(s&&p!==0&&f!==0){const x=e!==r?e/r:p/f,T=e>r?e:r;let S=1,O=1;isNaN(T)||(x>1?(S=T/p,O=T/x/f):(O=T/f,S=T*x/p)),Tx(g,g,Dle(m,S,O,c,h)),_=!0}const v=t.x+(p-i)/2,b=t.y+(f-i)/2;if(Tx(g,g,Lle(m,c-v,h-b)),!_&&(p>e||f>r)){const x=p/e>f/r,T=(x?e:r)/(x?p:f);Tx(g,g,Dle(m,T,T,v,b))}return n&&Tx(g,g,met(m,n,v,b)),a&&Tx(g,g,Lle(m,a[0],a[1])),`matrix(${g[0]},${g[1]},${g[2]},${g[3]},${g[4]},${g[5]})`}function bet(t,e,r){const i=t?.effects.find(c=>c.type==="bloom");if(!i)return null;const{strength:s,radius:n}=i,o=s>0?n:0,a=(s+o)*e,l=4*s+1;return j("filter",{id:`bloom${r}`,x:"-100%",y:"-100%",width:"300%",height:"300%",filterUnits:"userSpaceOnUse"},j("feMorphology",{operator:"dilate",radius:(s+.5*o)*(5**(e/100)*(.4+e/100)),in:"SourceGraphic",result:"dilate"}),j("feGaussianBlur",{in:"dilate",stdDeviation:a/25,result:"blur"}),j("feGaussianBlur",{in:"blur",stdDeviation:a/50,result:"intensityBlur"}),j("feComponentTransfer",{in:"SourceGraphic",result:"intensityBrightness"},j("feFuncR",{type:"linear",slope:l}),j("feFuncG",{type:"linear",slope:l}),j("feFuncB",{type:"linear",slope:l})),j("feMerge",null,j("feMergeNode",{in:"intensityBlur"}),j("feMergeNode",{in:"intensityBrightness"}),j("feGaussianBlur",{stdDeviation:s/10})))}function wet(t,e,r,i={}){const s=[],n=[],o=++det,a=bet(i.effectView,e,o);let l=null;if(a){const c=i.effectView?.effects.find(m=>m.type==="bloom"),h=(c.strength?c.strength+c.radius/2:0)/3,p=e+e*h,f=r+r*h;l=[Math.max(p,10),Math.max(f,10)]}for(let c=0;c<t.length;c++){const h=t[c],p=[],f=[];let m=0,g=0,_=0;for(const x of h){const{shape:T,fill:S,stroke:O,font:A,offset:M}=x;i.ignoreStrokeWidth||T.type==="text"||(m+=O&&O.width||0);const P=kEe(S),F=UEe(O),$=T.type==="text"?VEe(T,A):null;s.push(pet(P)),p.push(FEe(T,P.fill,F,$)),f.push(yet(T)),M&&(g+=M[0],_+=M[1])}const v=vet(Ha(_et(f)),e,r,m,i.scale??!1,i.rotation,i.useRotationSize??!1,[g,_],l);let b=null;if(i.masking){const x=`mask-${c}`,T=i.masking[c];s.push(fet(T,x)),b=`url(#${x})`}n.push(b?j("g",{mask:b},j("g",{transform:v},p)):j("g",{transform:v},p))}return i.useRotationSize&&i.rotation&&(e=YE(i.rotation,e),r=YE(i.rotation,r)),a&&(rS(l),e=l[0],r=l[1]),j("svg",{xmlns:set,width:e,height:r,style:"display: block;","aria-labelledby":i.ariaLabel,role:"img",focusable:!1},a,j("defs",null,s),a?j("g",{filter:`url(#bloom${o})`},n):n)}const xet=new Le("white");function Tet(t){const e=t.symbolLayers?.at(-1);if(e&&"outline"in e)return e?.outline?.size}function uUt(t){if(!t)return 0;if(V1(t)){const e=Tet(t);return e??0}return Fl(Aee(t)?.width)}function Eet(t){if(t==null||!("symbolLayers"in t)||t.symbolLayers==null)return!1;switch(t.type){case"point-3d":return t.symbolLayers.some(e=>e.type==="object");case"line-3d":return t.symbolLayers.some(e=>e.type==="path");case"polygon-3d":return t.symbolLayers.some(e=>e.type==="object"||e.type==="extrude");default:return!1}}function zEe(t){return Ha(t.resource).href}function hUt(t,e){if(!t)return null;let r=null;return V1(t)?r=Cet(t):nV(t)&&(r=t.type==="cim"?xEe(t):t.color?new Le(t.color):null),r?sP(r,e):null}function Cet(t){const e=t.symbolLayers;if(!e)return null;let r=null;return e.forEach(i=>{i.type==="object"&&i.resource?.href||(r=i.type==="water"?i.color:i.material?i.material.color:null)}),r?new Le(r):null}function sP(t,e){if(e==null||t==null)return t;const r=t.toRgba();return r[3]=r[3]*e,new Le(r)}function Aet(t,e,r){const i=t.symbolLayers;if(!i)return;const s=n=>sP(e=e??n??(r!=null?xet:null),r);i.forEach(n=>{if(n.type!=="object"||!n.resource?.href||e)if(n.type==="water")n.color=s(n.color);else{const o=n.material!=null?n.material.color:null,a=s(o);n.material==null?n.material=new yh({color:a}):n.material.color=a,r!=null&&"outline"in n&&n.outline!=null&&n.outline.color!=null&&(n.outline.color=sP(n.outline.color,r))}})}function Oet(t,e,r){(e=e??t.color)&&(t.color=sP(e,r)),r!=null&&"outline"in t&&t.outline&&t.outline.color&&(t.outline.color=sP(t.outline.color,r))}function dz(t,e,r){t&&(e||r!=null)&&(e&&(e=new Le(e)),V1(t)?Aet(t,e,r):nV(t)&&Oet(t,e,r))}async function Ret(t,e){const r=t.symbolLayers;r&&await OV(r,async i=>Met(i,e))}async function Met(t,e){switch(t.type){case"extrude":Pet(t,e);break;case"icon":case"line":case"text":Iet(t,e);break;case"path":Let(t,e);break;case"object":await $et(t,e)}}function Iet(t,e){const r=BEe(e);r!=null&&(t.size=r)}function BEe(t){for(const e of t)if(typeof e=="number")return e;return null}function Pet(t,e){t.size=typeof e[2]=="number"?e[2]:0}async function $et(t,e){const{resourceSize:r,symbolSize:i}=await Det(t),s=GEe(e,r,i);t.width=QM(e[0],i[0],r[0],s),t.depth=QM(e[1],i[1],r[1],s),t.height=QM(e[2],i[2],r[2],s)}function Let(t,e){const r=GEe(e,i0,[t.width,void 0,t.height]);t.width=QM(e[0],t.width,1,r),t.height=QM(e[2],t.height,1,r)}function GEe(t,e,r){for(let i=0;i<3;i++){const s=t[i];switch(s){case"symbol-value":{const n=r[i];return n!=null?n/e[i]:1}case"proportional":break;default:if(s&&e[i])return s/e[i]}}return 1}async function Det(t){const{computeObjectLayerResourceSize:e}=await J(()=>import("./symbolLayerUtils-af32dc81.js"),[],import.meta.url),r=await e(t,10),{width:i,height:s,depth:n}=t,o=[i,n,s];let a=1;for(let l=0;l<3;l++){const c=o[l];if(c!=null){a=c/r[l];break}}for(let l=0;l<3;l++)o[l]==null&&(o[l]=r[l]*a);return{resourceSize:r,symbolSize:o}}function QM(t,e,r,i){switch(t){case"proportional":return r*i;case"symbol-value":return e??r;default:return t}}function Net(t,e){const r=BEe(e);if(r!=null)switch(t.type){case"simple-marker":t.size=r;break;case"picture-marker":{const i=t.width/t.height;i>1?(t.width=r,t.height=r*i):(t.width=r*i,t.height=r);break}case"simple-line":t.width=r;break;case"text":t.font.size=r}}async function Fet(t,e){if(t&&e)return V1(t)?Ret(t,e):void(nV(t)&&Net(t,e))}function ket(t,e,r){if(t&&e!=null)if(V1(t)){const i=t.symbolLayers;i&&i.forEach(s=>{if(s&&s.type==="object")switch(r){case"tilt":s.tilt=e;break;case"roll":s.roll=e;break;default:s.heading=e}})}else nV(t)&&(t.type!=="simple-marker"&&t.type!=="picture-marker"&&t.type!=="text"||(t.angle=e))}function jEe(t){if(!t)return null;const e=t.effects.filter(r=>r.type!=="bloom").map(r=>r.toJSON());return qq(e)}function dUt(t){return t!=null&&t.type==="polygon-3d"&&t.symbolLayers.some(e=>e.type==="extrude")}async function Uet(t,e){return await t.fetchSymbol(e)||t.fetchCIMSymbol(e)}const kle=A7();function Vet(t,e){kle.append(t,e),kle.detach(e)}function DV(t,e,r){const i=Math.ceil(e[0]),s=Math.ceil(e[1]);if(!t.some(o=>!!o.length))return null;const n=r&&r.node||document.createElement("div");return r.opacity!=null&&(n.style.opacity=r.opacity.toString()),r.effectView!=null&&(n.style.filter=jEe(r.effectView)),Vet(n,()=>wet(t,i,s,r)),n}function zet(t,e){t=Math.ceil(t),e=Math.ceil(e);const r=document.createElement("canvas");r.width=t,r.height=e,r.style.width=t+"px",r.style.height=e+"px";const i=r.getContext("2d");return i.clearRect(0,0,t,e),i}function Bet(t,e,r){return t?Lt(t,{responseType:"image"}).then(i=>{const s=i.data,n=s.width,o=s.height,a=n/o;let l=e;if(r){const c=Math.max(n,o);l=Math.min(l,c)}return{image:s,width:a<=1?Math.ceil(l*a):l,height:a<=1?l:Math.ceil(l/a)}}):Promise.reject(new D("renderUtils: imageDataSize","href not provided."))}function Get(t,e){return!(!t||e==="ignore")&&(e!=="multiply"||t.r!==255||t.g!==255||t.b!==255||t.a!==1)}function jet(t,e,r,i,s){switch(s){case"multiply":t[e]*=r[0],t[e+1]*=r[1],t[e+2]*=r[2],t[e+3]*=r[3];break;default:{const n=Mee({r:t[e],g:t[e+1],b:t[e+2]});n.h=i.h,n.s=i.s,n.v=n.v/100*i.v;const o=v$(n);t[e]=o.r,t[e+1]=o.g,t[e+2]=o.b,t[e+3]*=r[3];break}}}function Het(t,e,r,i,s){return Bet(t,e,s).then(n=>{const o=n.width??e,a=n.height??e;if(n.image&&Get(r,i)){let l=n.image.width,c=n.image.height;le("edge")&&/\.svg$/i.test(t)&&(l-=1,c-=1);const h=zet(o,a);h.drawImage(n.image,0,0,l,c,0,0,o,a);const p=h.getImageData(0,0,o,a),f=[r.r/255,r.g/255,r.b/255,r.a],m=Mee(r);for(let g=0;g<p.data.length;g+=4)jet(p.data,g,f,m,i);h.putImageData(p,0,0),t=h.canvas.toDataURL("image/png")}else{const l=Gt&&Gt.findCredential(t);if(l&&l.token){const c=t.includes("?")?"&":"?";t=`${t}${c}token=${l.token}`}}return{url:t,width:o,height:a}}).catch(()=>({url:t,width:e,height:e}))}function qet(t){return t=t||globalThis.location.hostname,Wet.some(e=>t?.match(e)!=null)}function zW(t,e){return t&&(e=e||globalThis.location.hostname)?e.match(HEe)!=null||e.match(WEe)!=null?t.replace("static.arcgis.com","staticdev.arcgis.com"):e.match(qEe)!=null||e.match(ZEe)!=null?t.replace("static.arcgis.com","staticqa.arcgis.com"):t:t}const HEe=/^devext.arcgis.com$/,qEe=/^qaext.arcgis.com$/,WEe=/^[\w-]*\.mapsdevext.arcgis.com$/,ZEe=/^[\w-]*\.mapsqa.arcgis.com$/,Wet=[/^([\w-]*\.)?[\w-]*\.zrh-dev-local.esri.com$/,HEe,qEe,/^jsapps.esri.com$/,WEe,ZEe];function XEe(t,e,r,i){const s=t.name;return s==null?Promise.reject(new D("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference")):t.styleName&&t.styleName==="Esri2DPointSymbolsStyle"?Zet(s,e,i):WK(t,e,i).then(n=>Lee(Ha(n),s,e,r,pSe,i))}function $ee(t,e){return e.items.find(r=>r.name===t)}function Lee(t,e,r,i,s,n){const o=r&&r.portal!=null?r.portal:ao.getDefault(),a={portal:o,url:Fn(t.baseUrl),origin:"portal-item"},l=$ee(e,t.data);if(!l){const m=`The symbol name '${e}' could not be found`;return Promise.reject(new D("symbolstyleutils:symbol-name-not-found",m,{symbolName:e}))}let c=A0(s(l,i),a),h=l.thumbnail?.href??null;const p=l.thumbnail&&l.thumbnail.imageData;qet()&&(c=zW(c)??"",h=zW(h));const f={portal:o,url:Fn(KJ(c)),origin:"portal-item"};return ZK(c,n).then(m=>{const g=i==="cimRef"?dSe(m.data):m.data,_=qTe(g,f);if(_&&V1(_)){if(h){const v=A0(h,a);_.thumbnail=new tT({url:v})}else p&&(_.thumbnail=new tT({url:`data:image/png;base64,${p}`}));t.styleUrl?_.styleOrigin=new YI({portal:r.portal,styleUrl:t.styleUrl,name:e}):t.styleName&&(_.styleOrigin=new YI({portal:r.portal,styleName:t.styleName,name:e}))}return _})}function Zet(t,e,r){const i=zWe.replaceAll(/\{SymbolName\}/gi,t),s=e.portal!=null?e.portal:ao.getDefault();return ZK(i,r).then(n=>{const o=dSe(n.data);return qTe(o,{portal:s,url:Fn(KJ(i)),origin:"portal-item"})})}const Xet=Object.freeze(Object.defineProperty({__proto__:null,fetchSymbolFromStyle:Lee,getStyleItemFromStyle:$ee,resolveWebStyleSymbol:XEe},Symbol.toStringTag,{value:"Module"})),Sx=la.size,y4=la.maxSize,Dee=la.maxOutlineSize,Ule=la.lineWidth,BW=la.tallSymbolWidth;function JE(t){const e=t.outline,r=t.material!=null?t.material.color:null,i=r!=null?r.toHex():null;if(e==null||"pattern"in e&&e.pattern!=null&&e.pattern.type==="style"&&e.pattern.style==="none")return t.type==="fill"&&i==="#ffffff"?{color:"#bdc3c7",width:.75}:null;const s=vi(e.size)||0;return{color:"rgba("+(e.color!=null?e.color.toRgba():"255,255,255,1")+")",width:Math.min(s,Dee),style:"pattern"in e&&e.pattern!=null&&e.pattern.type==="style"?Oee(e.pattern.style):null,join:"butt",cap:"patternCap"in e?e.patternCap:"butt"}}async function Yet(t,e){if(t.thumbnail?.url)return t.thumbnail.url;if(e.type==="icon"&&e?.resource?.href)return zEe(e);const r=Dr("esri/images/Legend/legend3dsymboldefault.png");if(t.styleOrigin&&(t.styleOrigin.styleName||t.styleOrigin.styleUrl)){const i=await XEe(t.styleOrigin,{portal:t.styleOrigin.portal},"webRef").catch(()=>null);if(i&&"thumbnail"in i&&i.thumbnail?.url)return i.thumbnail.url}return r}function pz(t,e=1){const r=t.a,i=Mee(t),s=i.h,n=i.s/e,o=100-(100-i.v)/e,{r:a,g:l,b:c}=v$({h:s,s:n,v:o});return[a,l,c,r]}function jk(t){return t.type==="water"?t.color==null?null:t.color:t.material==null||t.material.color==null?null:t.material.color}function os(t,e=0){const r=jk(t);if(!r){if(t.type==="fill")return null;const s=_Ke.r,n=A1(s,e);return[n,n,n,100]}const i=r.toRgba();for(let s=0;s<3;s++)i[s]=A1(i[s],e);return i}async function YEe(t,e){const r=t.style;return r==="none"?null:{type:"pattern",x:0,y:0,src:await yKe(Dr(`esri/symbols/patterns/${r}.png`),e.toCss(!0)),width:5,height:5}}function Vle(t){return t.outline?JE(t):{color:"rgba(0, 0, 0, 1)",width:1.5}}function JEe(t,e){const r=jk(t);if(!r)return null;let i="rgba(";return i+=A1(r.r,e)+",",i+=A1(r.g,e)+",",i+=A1(r.b,e)+",",i+r.a+");"}function GW(t,e){const r=JEe(t,e);return r?"pattern"in t&&t.pattern!=null&&t.pattern.type==="style"&&t.pattern.style==="none"?null:{color:r,width:Math.min(t.size?vi(t.size):.75,Dee),style:"pattern"in t&&t.pattern!=null&&t.pattern.type==="style"?Oee(t.pattern.style):null,cap:"cap"in t?t.cap:null,join:"join"in t?t.join==="miter"?vi(2):t.join:null}:{}}function BL(t,e,r){const i=r!=null?.75*r:0;return{type:"linear",x1:i?.25*i:0,y1:i?.5*i:0,x2:i||4,y2:i?.5*i:4,colors:[{color:t,offset:0},{color:e,offset:1}]}}function Jet(t){const e=t.depth,r=t.height,i=t.width;return i!==0&&e!==0&&r!==0&&i===e&&i!=null&&r!=null&&i<r}function Qet(t,e,r){const i=[];if(!t)return i;switch(t.type){case"icon":{const o=e,a=e;switch(t.resource&&t.resource.primitive||wxe){case"circle":i.push({shape:{type:"circle",cx:0,cy:0,r:.5*e},fill:os(t,0),stroke:JE(t)});break;case"square":i.push({shape:{type:"path",path:[{command:"M",values:[0,a]},{command:"L",values:[0,0]},{command:"L",values:[o,0]},{command:"L",values:[o,a]},{command:"Z",values:[]}]},fill:os(t,0),stroke:JE(t)});break;case"triangle":i.push({shape:{type:"path",path:[{command:"M",values:[0,a]},{command:"L",values:[.5*o,0]},{command:"L",values:[o,a]},{command:"Z",values:[]}]},fill:os(t,0),stroke:JE(t)});break;case"cross":i.push({shape:{type:"path",path:[{command:"M",values:[.5*o,0]},{command:"L",values:[.5*o,a]},{command:"M",values:[0,.5*a]},{command:"L",values:[o,.5*a]}]},stroke:Vle(t)});break;case"x":i.push({shape:{type:"path",path:[{command:"M",values:[0,0]},{command:"L",values:[o,a]},{command:"M",values:[o,0]},{command:"L",values:[0,a]}]},stroke:Vle(t)});break;case"kite":i.push({shape:{type:"path",path:[{command:"M",values:[0,.5*a]},{command:"L",values:[.5*o,0]},{command:"L",values:[o,.5*a]},{command:"L",values:[.5*o,a]},{command:"Z",values:[]}]},fill:os(t,0),stroke:JE(t)})}break}case"object":switch(t.resource&&t.resource.primitive||vK){case"cone":{const s=BL(os(t,0),os(t,-.6),r?BW:e),n=SKe(e,r);i.push({shape:n[0],fill:s}),i.push({shape:n[1],fill:s});break}case"inverted-cone":{const s=os(t,0),n=BL(s,os(t,-.6),e),o=EKe(e);i.push({shape:o[0],fill:n}),i.push({shape:o[1],fill:s});break}case"cube":{const s=xKe(e,r);i.push({shape:s[0],fill:os(t,0)}),i.push({shape:s[1],fill:os(t,-.3)}),i.push({shape:s[2],fill:os(t,-.5)});break}case"cylinder":{const s=BL(os(t,0),os(t,-.6),r?BW:e),n=TKe(e,r);i.push({shape:n[0],fill:s}),i.push({shape:n[1],fill:s}),i.push({shape:n[2],fill:os(t,0)});break}case"diamond":{const s=CKe(e);i.push({shape:s[0],fill:os(t,-.3)}),i.push({shape:s[1],fill:os(t,0)}),i.push({shape:s[2],fill:os(t,-.3)}),i.push({shape:s[3],fill:os(t,-.7)});break}case"sphere":{const s=BL(os(t,0),os(t,-.6));s.x1=0,s.y1=0,s.x2=.25*e,s.y2=.25*e,i.push({shape:{type:"circle",cx:0,cy:0,r:.5*e},fill:s});break}case"tetrahedron":{const s=AKe(e);i.push({shape:s[0],fill:os(t,-.3)}),i.push({shape:s[1],fill:os(t,0)}),i.push({shape:s[2],fill:os(t,-.6)});break}}break}return i}function NV(t){const e=typeof t?.size=="number"?t?.size:null;return e?vi(e):null}function Ket(t){return t.type==="icon"?"multiply":"tint"}function ett(t,e){const r=NV(e),i=e?.maxSize?vi(e.maxSize):null,s=e?.disableUpsampling??!1,n=t.symbolLayers,o=[];let a=0,l=0;const c=n.at(-1);let h;return c&&c.type==="icon"&&(h=c.size&&vi(c.size)),n.forEach(p=>{if(p.type!=="icon"&&p.type!=="object")return;const f=p.type==="icon"?p.size&&vi(p.size):0,m=r||f?Math.ceil(Math.min(r||f,i||y4)):Sx;if(p&&p.resource&&p.resource.href){const g=Yet(t,p).then(_=>{const v=p.get("material.color"),b=Ket(p);return Het(_,m,v,b,s)}).then(_=>{const v=_.width,b=_.height;return a=Math.max(a,v),l=Math.max(l,b),[{shape:{type:"image",x:0,y:0,width:v,height:b,src:_.url},fill:null,stroke:null}]});o.push(g)}else{let g=m;p.type==="icon"&&h&&r&&(g=m*(f/h));const _=e?.symbolConfig==="tall"||e?.symbolConfig?.isTall||p.type==="object"&&Jet(p);a=Math.max(a,_?BW:g),l=Math.max(l,g),o.push(Promise.resolve(Qet(p,g,_)))}}),Oh(o).then(p=>{const f=[];return p.forEach(m=>{m.value?f.push(m.value):m.error&&K.getLogger("esri.symbols.support.previewSymbol3D").warn("error while building swatchInfo!",m.error)}),DV(f,[a,l],{node:e&&e.node,scale:!1,opacity:e&&e.opacity,ariaLabel:e?.ariaLabel})})}function ttt(t,e){const r=t.symbolLayers,i=[],s=Eet(t),n=NV(e),o=(e&&e.maxSize?vi(e.maxSize):null)||Dee;let a,l=0,c=0;return r.forEach((h,p)=>{if(!h||h.type!=="line"&&h.type!=="path")return;const f=[];switch(h.type){case"line":{const m=GW(h,0);if(m==null)break;const g=m&&m.width||0;p===0&&(a=g);const _=Math.min(n||g,o),v=p===0?_:n?_*(g/a):_,b=v>Ule/2?2*v:Ule;c=Math.max(c,v),l=Math.max(l,b),m.width=v,f.push({shape:{type:"path",path:[{command:"M",values:[0,.5*c]},{command:"L",values:[l,.5*c]}]},stroke:m});break}case"path":{const m=Math.min(n||Sx,o),g=os(h,0),_=os(h,-.2),v=JEe(h,-.4),b=v?{color:v,width:1}:{};if(h.profile==="quad"){const x=h.width,T=h.height,S=vKe(x&&T?x/T:1,T===0,x===0),O={...b,join:"bevel"};f.push({shape:S[0],fill:_,stroke:O}),f.push({shape:S[1],fill:_,stroke:O}),f.push({shape:S[2],fill:g,stroke:O})}else f.push({shape:VW.pathSymbol3DLayer[0],fill:_,stroke:b}),f.push({shape:VW.pathSymbol3DLayer[1],fill:g,stroke:b});c=Math.max(c,m),l=c}}i.push(f)}),Promise.resolve(DV(i,[l,c],{node:e&&e.node,scale:s,opacity:e&&e.opacity,ariaLabel:e?.ariaLabel}))}async function rtt(t,e){const r=t.type==="mesh-3d",i=t.symbolLayers,s=NV(e),n=e&&e.maxSize?vi(e.maxSize):null,o=s||Sx,a=[];let l=0,c=0,h=!1;for(let p=0;p<i.length;p++){const f=i.at(p),m=[];if(r&&f.type!=="fill")continue;const g=VW.fill[0];switch(f.type){case"fill":{const _=JE(f),v=Math.min(o,n||y4);l=Math.max(l,v),c=Math.max(c,v),h=!0;let b=os(f,0);const x="pattern"in f?f.pattern:null,T=jk(f);!r&&x!=null&&x.type==="style"&&x.style!=="solid"&&T&&(b=await YEe(x,T)),m.push({shape:g,fill:b,stroke:_});break}case"line":{const _=GW(f,0);if(_==null)break;const v={stroke:_,shape:g};l=Math.max(l,Sx),c=Math.max(c,Sx),m.push(v);break}case"extrude":{const _={join:"round",width:1,...GW(f,-.4)},v=os(f,0),b=os(f,-.2),x=Math.min(o,n||y4),T=bKe(x);_.width=1,m.push({shape:T[0],fill:b,stroke:_}),m.push({shape:T[1],fill:b,stroke:_}),m.push({shape:T[2],fill:v,stroke:_});const S=Sx,O=.7*Sx+.5*x;l=Math.max(l,S),c=Math.max(c,O);break}case"water":{const _=Ha(jk(f)),v=pz(_),b=pz(_,2),x=pz(_,3),T=wKe();h=!0,m.push({shape:T[0],fill:v}),m.push({shape:T[1],fill:b}),m.push({shape:T[2],fill:x});const S=Math.min(o,n||y4);l=Math.max(l,S),c=Math.max(c,S);break}}a.push(m)}return DV(a,[l,c],{node:e&&e.node,scale:h,opacity:e&&e.opacity,ariaLabel:e?.ariaLabel})}function itt(t,e){if(t.symbolLayers.length===0)return Promise.reject(new D("symbolPreview: renderPreviewHTML3D","No symbolLayers in the symbol."));switch(t.type){case"point-3d":return ett(t,e);case"line-3d":return ttt(t,e);case"polygon-3d":case"mesh-3d":return rtt(t,e)}return Promise.reject(new D("symbolPreview: swatchInfo3D","symbol not supported."))}const stt=Object.freeze(Object.defineProperty({__proto__:null,getPatternDescriptor:YEe,getSizeFromOptions:NV,getSymbolLayerFill:os,previewSymbol3D:itt},Symbol.toStringTag,{value:"Module"}));let OS=null;const zle=[255,255,255];function Ble(t,e){return Math.floor(Math.random()*(e-t+1)+t)}function pUt(t,e,r){const{backgroundColor:i,outline:s,dotSize:n}=t,o=r&&r.swatchSize||la.size,a=.8,l=Math.round(o*o/n**2*a),c=window.devicePixelRatio,h=document.createElement("canvas"),p=o*c;h.width=p,h.height=p,h.style.width=h.width/c+"px",h.style.height=h.height/c+"px";const f=h.getContext("2d");if(i&&(f.fillStyle=i.toCss(!0),f.fillRect(0,0,p,p),f.fill()),f.fillStyle=e?.toCss(!0)??"",OS&&OS.length/2===l)for(let g=0;g<2*l;g+=2){const _=OS[g],v=OS[g+1];f.fillRect(_,v,n*c,n*c),f.fill()}else{OS=[];for(let g=0;g<2*l;g+=2){const _=Ble(0,p),v=Ble(0,p);OS.push(_,v),f.fillRect(_,v,n*c,n*c),f.fill()}}s&&(s.color&&(f.strokeStyle=s.color.toCss(!0)),f.lineWidth=s.width,f.strokeRect(0,0,p,p));const m=new Image(o,o);return m.src=h.toDataURL(),m.ariaLabel=r?.ariaLabel??null,m.alt=r?.ariaLabel??"",m}function fUt(t,e={}){const r=e.radius||40,i=2*Math.PI*r,s=t.length,n=i/s,o=[],a=Aee(e.outline);a?.width!=null&&(a.width*=2),(a||e.backgroundColor)&&o.push({shape:{type:"circle",cx:r,cy:r,r},fill:e.backgroundColor,stroke:a,offset:[0,0]});const l=e.values,c=l&&l.length===s&&l.reduce((g,_)=>g+_,0)===100,h=[0];for(let g=0;g<s;g++){let _=null;c&&(_=l[g]*i/100,h.push(_+h[g])),o.push({shape:{type:"circle",cx:r,cy:r,r:r/2},fill:[0,0,0,0],stroke:{width:r,dashArray:`${(_??n)/2} ${i}`,dashoffset:"-"+(c?h[g]/2:g*(n/2)),color:t[g]},offset:[0,0]})}let p=null;const f=2*r+(a?.width||0),m=e.holePercentage;if(m){a&&o.push({shape:{type:"circle",cx:r,cy:r,r:r*m},fill:null,stroke:a,offset:[0,0]});const g=f/2;p=[[{shape:{type:"circle",cx:g,cy:g,r:g},fill:zle,stroke:a?{...a,color:zle}:null,offset:[0,0]},{shape:{type:"circle",cx:g,cy:g,r:r*m},fill:[0,0,0],stroke:null,offset:[0,0]}]]}return DV([o],[f,f],{effectView:e.effectList,ignoreStrokeWidth:!0,masking:p,rotation:-90,ariaLabel:e.ariaLabel})}function mUt(t,e={}){const s=e.align==="horizontal",n=s?75:24,o=s?24:75,a=e.width??n,l=e.height??o,c=e.gradient??!0,h=window.devicePixelRatio,p=a*h,f=l*h,m=document.createElement("canvas");m.width=p,m.height=f,m.ariaLabel=e.ariaLabel??null,m.style.width=`${a}px`,m.style.height=`${l}px`;const g=m.getContext("2d"),_=s?p:0,v=s?0:f;if(c){const x=g.createLinearGradient(0,0,_,v),T=t.length,S=T===1?0:1/(T-1);t.forEach((O,A)=>x.addColorStop(A*S,O.toString())),g.fillStyle=x,g.fillRect(0,0,p,f)}else{const x=s?p/t.length:p,T=s?f:f/t.length;let S=0,O=0;for(const A of t)g.fillStyle=A.toString(),g.fillRect(S,O,x,T),S=s?S+x:0,O=s?0:O+T}const b=document.createElement("div");return b.style.width=`${a}px`,b.style.height=`${l}px`,ntt(b,e?.effectList),b.appendChild(m),b}function ntt(t,e){if(!e)return;t.style.filter=jEe(e);const r=e.effects;if(r){for(const i of r)if(i?.type==="drop-shadow"){i.offsetX<0?t.style.marginLeft=`${Math.abs(i.offsetX)}px`:t.style.marginRight=`${i.offsetX}px`;break}}}async function QEe(t,e){switch(t.type){case"web-style":{const{previewWebStyleSymbol:r}=await J(()=>import("./previewWebStyleSymbol-daec180c.js"),[],import.meta.url);return r(t,QEe,e)}case"label-3d":case"line-3d":case"mesh-3d":case"point-3d":case"polygon-3d":{const{previewSymbol3D:r}=await J(()=>Promise.resolve().then(()=>stt),void 0,import.meta.url);return r(t,e)}case"simple-marker":case"simple-line":case"simple-fill":case"picture-marker":case"picture-fill":case"text":{const{previewSymbol2D:r}=await J(()=>import("./previewSymbol2D-b9ecf768.js"),["./previewSymbol2D-b9ecf768.js","./colorUtils-c9a97827.js"],import.meta.url);return r(t,e)}case"cim":{const{previewCIMSymbol:r}=await J(()=>import("./previewCIMSymbol-12120e22.js"),["./previewCIMSymbol-12120e22.js","./cimAnalyzer-cb622717.js","./TileClipper-ae6eca9e.js","./definitions-4b766362.js","./number-e491b09e.js","./BidiEngine-9a40f2f4.js","./CIMSymbolRasterizer-8b630ece.js","./imageutils-ec034daf.js","./rasterizingUtils-0eaad164.js"],import.meta.url);return r(t,e)}default:return}}function KEe(t){return t&&"opacity"in t?t.opacity*KEe(t.parent):1}async function jW(t,e){if(!t)return;const r=t.sourceLayer,i=(e!=null&&e.useSourceLayer?r:t.layer)??r,s=KEe(i);if(t.symbol!=null&&(e==null||e.ignoreGraphicSymbol!==!0)){const T=t.symbol.type==="web-style"?await Uet(t.symbol,{...e,cache:e!=null?e.webStyleCache:null}):t.symbol.clone();return dz(T,null,s),T}const n=(e!=null?e.renderer:null)??(i&&"renderer"in i?i.renderer:null);let o=n&&"getSymbolAsync"in n?await n.getSymbolAsync(t,e):null;if(!o)return;if(o=o.type==="web-style"?await o.fetchSymbol({...e,cache:e!=null?e.webStyleCache:null}):o.clone(),!(n&&"visualVariables"in n&&n.visualVariables&&n.visualVariables.length))return dz(o,null,s),o;if("arcadeRequiredForVisualVariables"in n&&n.arcadeRequiredForVisualVariables&&(e==null||e.arcade==null)){const T={...e};T.arcade=await If(),e=T}const{getColor:a,getOpacity:l,getAllSizes:c,getRotationAngle:h}=await J(()=>Promise.resolve().then(()=>rWe),void 0,import.meta.url),p=[],f=[],m=[],g=[];for(const T of n.visualVariables)switch(T.type){case"color":p.push(T);break;case"opacity":f.push(T);break;case"rotation":g.push(T);break;case"size":T.target||m.push(T)}const _=!!p.length&&p[p.length-1],v=_?a(_,t,e):null,b=!!f.length&&f[f.length-1];let x=b?l(b,t,e):null;if(s!=null&&(x=x!=null?x*s:s),dz(o,v,x),m.length){const T=c(m,t,e);await Fet(o,T)}for(const T of g)ket(o,h(T,t,e),T.axis);return o}var HW;const ott="esri.widgets.FeatureTemplates.TemplateItem";let Em=HW=class extends me{constructor(t){super(t),this._activeFetchInfo={id:null,request:null},this.layer=null,this.template=null,this.thumbnail=null}initialize(){this.addHandles(Q(()=>{const{layer:t}=this;return[t&&"renderer"in t?t.renderer:null,this.template]},()=>{this._activeFetchInfo.id=null,this._activeFetchInfo.request=null,this._set("thumbnail",null)},xt))}get description(){return this.template?.description}set description(t){this.template&&(this.template.description=t)}get label(){return this.template?.name}set label(t){this.template&&(this.template.name=t)}get id(){return`${this.label??""}–${this.layer?.id}`}get supportsUpload(){return this.layer.type==="scene"}clone(){const t=this.thumbnail!=null?this.thumbnail.cloneNode(!0):null,e=new HW({layer:this.layer,template:this.template});return e._set("thumbnail",t),e}static async fetchThumbnail(t,e){const r=await att(t,e);if(r==null)return null;const i={maxSize:36};return t.renderer?.type==="dictionary"&&(i.fieldMap=t.renderer.fieldMap??void 0,i.feature={attributes:e.prototype.attributes??{}}),await QEe(r,i)}};async function att(t,e){const{renderer:r}=t;if(r){const i=new oa({attributes:e.prototype.attributes}),s=await r.getSymbolAsync(i);if(s)return s}return ltt(t)}async function ltt(t){const{geometryType:e}=t,r=e==="point"||e==="multipoint"?await J(()=>Promise.resolve().then(()=>J7e),void 0,import.meta.url):e==="polyline"?await J(()=>Promise.resolve().then(()=>i7e),void 0,import.meta.url):e==="polygon"||e==="mesh"||e==="multipatch"?await J(()=>Promise.resolve().then(()=>Y7e),void 0,import.meta.url):null;return r?new r.default:null}u([d()],Em.prototype,"description",null),u([d()],Em.prototype,"label",null),u([d()],Em.prototype,"layer",void 0),u([d()],Em.prototype,"template",void 0),u([d({readOnly:!0})],Em.prototype,"thumbnail",void 0),u([d()],Em.prototype,"id",null),u([d()],Em.prototype,"supportsUpload",null),Em=HW=u([R(ott)],Em);const qW=Em;let pE=class extends aS(me){constructor(e){super(e),this.items=null,this.label=null}get id(){return this.label}findByTemplate(e){return this.items.find(r=>r.template===e)}};u([d()],pE.prototype,"items",void 0),u([d()],pE.prototype,"label",void 0),u([d()],pE.prototype,"id",null),pE=u([R("esri.widgets.FeatureTemplates.TemplateItemGroup")],pE);const ctt=pE;var U3;const utt=({layer:t})=>({key:t,label:t.title??""}),htt=({layer:t})=>({key:t.geometryType,label:t.geometryType??""});let Zc=U3=class extends Oc(Xr.EventedAccessor){constructor(t){super(t),this._itemPool=new $o(qW),this._groupPool=new $o(ctt),this.filterFunction=null,this.selectedItem=null}initialize(){this._get("groupBy")||(this.groupBy="layer")}set groupBy(t){if(this._set("groupBy",t),typeof t!="function")switch(t){case"layer":this._groupByFunction=utt;break;case"geometry":this._groupByFunction=htt;break;default:this._groupByFunction=null}else this._groupByFunction=e=>this._ensureGroupByObject(t(e))}set layers(t){const e="layers";if(this.handles.remove(e),t){const r=()=>this.notifyChange("state");this.handles.add(t.map(i=>No(()=>i.loadStatus,r)),e)}this._set("layers",t)}get layers(){return this._get("layers")}get state(){const{layers:t}=this;return t&&t.length!==0?t.some(e=>e.loadStatus==="loading"||e.loadStatus==="not-loaded")?"loading":"ready":"disabled"}get _featureTemplatesByLayer(){if(!this.layers)return new Map;const t=[];for(const e of this.layers)if(e.type==="subtype-group")for(const r of e.sublayers){const i=Gle(r);t.push([r,i])}else uA(e)||t.push([e,Gle(e)]);return new Map(t)}get numberOfFeatureTemplates(){return Array.from(this._featureTemplatesByLayer.values()).reduce((t,e)=>t+e.length,0)}get items(){if(this.numberOfFeatureTemplates===0)return this._releasePreviousItems(),[];const t=this._featureTemplatesByLayer,e=[],r=this.filterFunction!=null?this.filterFunction:U3._nullFilterFunction;for(const[n,o]of t)if(n.loaded||n.type==="subtype-sublayer"&&n.parent?.loaded){const a=vg(n)?.operations;if(a?.supportsEditing&&a?.supportsAdd)for(const l of o)e.push({layer:n,template:l,matchesFilter:r({label:l.name})})}if(this._groupByFunction==null){const n=e.filter(({matchesFilter:o})=>o).map(({template:o,layer:a})=>this._createItem(o,a));return this._releasePreviousItems(),n}const i=new Map;for(const n of e){const{template:o,layer:a}=n,l=this._groupByFunction({template:o,layer:a}),{key:c,label:h}=l.key!=null?l:U3.nullGroupBy;i.has(c)||i.set(c,{label:h,templateItemInfos:[]}),i.get(c)?.templateItemInfos.push(n)}const s=[];for(const n of i.values()){const{label:o,templateItemInfos:a}=n,l=a.filter(({matchesFilter:h})=>h),c=r({label:o})?a:a.length>0?l:[];if(c.length>0){const h=c.map(({template:p,layer:f})=>this._createItem(p,f));s.push(this._createGroup(o,h))}}return s.length===1&&s[0].label===U3.nullGroupBy.label?(this._releasePreviousItems(),s[0].items):(this._releasePreviousItems(),s)}refresh(){this.notifyChange("items")}select(t,{emit:e=!0}={}){const r=this.selectedItem,i=t?.clone()||null;this._set("selectedItem",i),e&&this.emit("select",{item:i,oldItem:r,template:i?.template??null})}_createItem(t,e){const r=this._itemPool.acquire();return r.set({template:t,layer:e}),r}_createGroup(t,e){const r=this._groupPool.acquire();return r.set("label",t),r.items=e,r}_releasePreviousItems(){this._destroyItems(this._get("items"))}_destroyItems(t){t&&(t[0]instanceof qW?t.forEach(e=>this._destroyItem(e)):t.forEach(e=>this._destroyGroup(e)))}_destroyGroup(t){t.items.forEach(e=>this._destroyItem(e)),t.items.length=0,this._groupPool.release(t)}_destroyItem(t){t.layer=null,t.template=null,this._itemPool.release(t)}_ensureGroupByObject(t){return typeof t=="string"?{key:t,label:t}:t}};Zc.nullGroupBy={key:Symbol(),label:"Other​"},Zc._nullFilterFunction=t=>!0,u([d()],Zc.prototype,"_groupByFunction",void 0),u([d()],Zc.prototype,"filterFunction",void 0),u([d()],Zc.prototype,"groupBy",null),u([d()],Zc.prototype,"layers",null),u([d()],Zc.prototype,"state",null),u([d({readOnly:!0})],Zc.prototype,"_featureTemplatesByLayer",null),u([d({readOnly:!0})],Zc.prototype,"numberOfFeatureTemplates",null),u([d({readOnly:!0})],Zc.prototype,"items",null),u([d({readOnly:!0})],Zc.prototype,"selectedItem",void 0),Zc=U3=u([R("esri.widgets.FeatureTemplates.FeatureTemplatesViewModel")],Zc);const Gle=t=>[..."templates"in t&&Array.isArray(t.templates)?t.templates:[],..."types"in t&&Array.isArray(t.types)?t.types.flatMap(e=>e.templates):[]],WW=Zc,Zf="esri-item-list",u0={base:Zf,group:`${Zf}__group`,scroller:`${Zf}__scroller`,scrollerEnabled:`${Zf}__scroller--enabled`,groupHeader:`${Zf}__group__header`,item:`${Zf}__list-item`,itemIcon:`${Zf}__list-item-icon`,itemContentEnd:`${Zf}__list-item-content-end`,noMatchesMessage:`${Zf}__no-matches-message`,filterContainerSticky:`${Zf}__filter-container--sticky`},dtt=4;function eCe(t){const{filterText:e="",id:r,messages:i,onFilterChange:s,...n}=t;return j("div",{key:r},t.filterEnabled??1?mtt({filterText:e,id:r,messages:i,onFilterChange:s}):null,ftt({...n,enableListScroll:t.enableListScroll??!0,filterText:e,messages:i}))}function ptt(t){return!!t.items}function ftt(t){const{headingLevel:e,items:r,...i}=t;return r.length===0?j("div",{class:u0.noMatchesMessage,key:"no-matches"},t.messages.noMatches):j("div",{class:JQ({[u0.scroller]:!0,[u0.scrollerEnabled]:!!t.enableListScroll}),key:"item-container"},r.map(s=>ptt(s)?gtt({...i,group:s,headingLevel:e}):Nee({...i,grouped:!0,item:s})))}function mtt(t){const{messages:e,filterText:r,enableListScroll:i}=t;return j("div",{key:"filter",class:i?void 0:u0.filterContainerSticky},j("calcite-input",{onCalciteInputInput:s=>{const n=s.currentTarget;t.onFilterChange&&t.onFilterChange(n.value)},placeholder:e.filterPlaceholder,value:r,type:"search"}))}function Nee(t){const{grouped:e,identify:r,item:i,onItemMouseEnter:s,onItemMouseLeave:n,onItemSelect:o,renderIcon:a,renderCustomItem:l,renderItemContent:c,renderItemContentEnd:h,renderItemLabel:p,renderItemDescription:f,selectedItem:m}=t,g=jle(i,r),_=g===jle(m,r),v=l?.(t);if(v)return v;const b=c?.(i),x=h?.(i);return j("calcite-list-item",{"aria-level":e?"2":"",class:u0.item,"data-item":i,key:g,label:b?void 0:p?.(i)??i.label??void 0,description:b?void 0:f?.(i)??void 0,selected:_,tabIndex:0,afterUpdate:T=>{T.selected=_},onCalciteListItemSelect:T=>{T.preventDefault(),o?.(fz(T))},onmouseenter:T=>s?.(fz(T)),onmouseleave:T=>n?.(fz(T))},j("div",{key:"content-start",class:u0.itemIcon,slot:"content-start"},a?.(i)),b?j("div",{key:"content",slot:"content"},b):null,x?j("div",{key:"content-end",class:u0.itemContentEnd,slot:"content-end"},x):null)}function jle(t,e){return t?`${e?.(t)||t.id}__${t.label}`:""}function fz(t){return t.currentTarget["data-item"]}function gtt(t){const{group:e,headingLevel:r=dtt,selectionMode:i="none",renderCustomGroupContent:s,...n}=t,o=s?.(t);return j("div",{class:u0.group,key:e.label??void 0},j(Gx,{level:r,class:u0.groupHeader},e.label),o||j("calcite-list",{selectionMode:i,selectionAppearance:"border"},e.items.map(a=>Nee({...n,item:a,grouped:!0}))))}const Hle="esri-feature-templates",mz={base:Hle,loader:`${Hle}__loader`,widget:"esri-widget"};function ytt(t){return t.length>0&&nTe(t[0])}function _tt(t){return t.id}const qle={filter:!0};let Xn=class extends Oc(Rc){constructor(e,r){super(e,r),this.enableListScroll=!0,this.filterText="",this.headingLevel=4,this.messages=null,this.viewModel=new WW,this.visibleElements={...qle},this.renderCustomItem=i=>null,this.renderCustomGroupContent=i=>null,this.renderItemLabel=()=>null,this.renderItemDescription=()=>null,this.renderItemContent=i=>null,this.renderItemContentEnd=i=>null,this._iconIntersectionObserver=new IntersectionObserver((i,s)=>{i.forEach(async n=>{if(n.isIntersecting){const o=n.target;if(btt(o))return void s.unobserve(o);const a=vtt(o),{layer:l,template:c}=a;Wle(o,!0);const h=await qW.fetchThumbnail(l,c).catch(()=>(Wle(o,!1),null));if(h==null)return;o.appendChild(h)}})}),this.renderItemIcon=i=>j("span",{key:"icon",afterCreate:this._afterItemCreateOrUpdate,afterUpdate:this._afterItemCreateOrUpdate,afterRemoved:this._afterItemRemoved,"data-item":i,"data-has-icon":!1}),this._afterItemCreateOrUpdate=i=>{this._iconIntersectionObserver?.observe(i)},this._afterItemRemoved=i=>{this._iconIntersectionObserver?.unobserve(i)}}initialize(){const e=({label:r})=>!this.filterText||!!r?.toLowerCase().includes(this.filterText.toLowerCase());this.addHandles(Q(()=>this.viewModel,(r,i)=>{r&&!r.filterFunction&&(this.filterFunction=e),i&&i!==r&&i.filterFunction===e&&(i.filterFunction=null)},xt))}destroy(){this._iconIntersectionObserver?.disconnect(),this._iconIntersectionObserver=null}loadDependencies(){return oO({input:()=>J(()=>import("./calcite-input-a5929ac8.js"),["./calcite-input-a5929ac8.js","./input-88645e50.js","./form-c843c929.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./progress-a90520b9.js"],import.meta.url),"list-item":()=>J(()=>import("./calcite-list-item-3e21bb8f.js"),["./calcite-list-item-3e21bb8f.js","./interactive-1607c36d.js","./utils3-48a6cb5c.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./loadable-7d140904.js","./action-e3f08495.js","./guid-4f97587b.js","./icon-6c56dd6f.js","./loader-cabefae3.js"],import.meta.url),notice:()=>J(()=>import("./calcite-notice-61fe6537.js"),["./calcite-notice-61fe6537.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js"],import.meta.url)})}get filterFunction(){return this.viewModel.filterFunction}set filterFunction(e){this.viewModel.filterFunction=e}get groupBy(){return this.viewModel.groupBy}set groupBy(e){this.viewModel.groupBy=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get layers(){return this.viewModel.layers}set layers(e){this.viewModel.layers=e}get selectedItem(){return this.viewModel.selectedItem}castVisibleElements(e){return{...qle,...e}}select(e,r){return this.viewModel.select(e,r)}render(){const{enableListScroll:e,filterText:r,headingLevel:i,messages:s,viewModel:{items:n,numberOfFeatureTemplates:o,selectedItem:a,state:l}}=this,c=this.visibleElements.filter&&o>1;if(ytt(n)){const h=n.find(p=>p.label===WW.nullGroupBy.label);h&&(h.label=s.other)}return j("div",{class:this.classes(mz.base,mz.widget),"aria-label":s.widgetLabel},l==="loading"?this.renderLoader():l==="ready"?j(eCe,{enableListScroll:e,filterEnabled:c,filterText:r,headingLevel:i,id:this.id,identify:_tt,items:n,messages:{filterPlaceholder:s.filterPlaceholder,noItems:s.noItems,noMatches:s.noMatches},renderIcon:this.renderItemIcon,renderCustomItem:this.renderCustomItem,renderCustomGroupContent:this.renderCustomGroupContent,renderItemContent:this.renderItemContent,renderItemContentEnd:this.renderItemContentEnd,renderItemDescription:this.renderItemDescription,renderItemLabel:this.renderItemLabel,selectedItem:a??void 0,selectionMode:"single",onItemSelect:h=>!nTe(h)&&this.viewModel.select(h),onFilterChange:h=>{this.filterText=h,this.viewModel.refresh()}}):null)}renderLoader(){return j("div",{class:mz.loader,key:"loader"})}};function vtt(t){return t?.["data-item"]}function btt(t){return!!t?.["data-has-icon"]}function Wle(t,e){t&&(t["data-has-icon"]=e)}u([d()],Xn.prototype,"enableListScroll",void 0),u([d()],Xn.prototype,"filterFunction",null),u([d()],Xn.prototype,"filterText",void 0),u([d()],Xn.prototype,"groupBy",null),u([d()],Xn.prototype,"headingLevel",void 0),u([d()],Xn.prototype,"label",null),u([d()],Xn.prototype,"layers",null),u([d(),Aa("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],Xn.prototype,"messages",void 0),u([d({readOnly:!0})],Xn.prototype,"selectedItem",null),u([d(),Cee("select")],Xn.prototype,"viewModel",void 0),u([d()],Xn.prototype,"visibleElements",void 0),u([or("visibleElements")],Xn.prototype,"castVisibleElements",null),u([d()],Xn.prototype,"renderCustomItem",void 0),u([d()],Xn.prototype,"renderCustomGroupContent",void 0),u([d()],Xn.prototype,"renderItemLabel",void 0),u([d()],Xn.prototype,"renderItemDescription",void 0),u([d()],Xn.prototype,"renderItemContent",void 0),u([d()],Xn.prototype,"renderItemContentEnd",void 0),Xn=u([R("esri.widgets.FeatureTemplates")],Xn);const wtt=Xn;var tCe;const _4=Symbol("anchorHandles");let Bw=class extends Xr.EventedAccessor{constructor(e){super(e),this[tCe]=new li,this.location=null,this.screenLocationEnabled=!1,this.view=null,this[_4].add([No(()=>Dl(this.screenLocationEnabled?this.view:null,r=>[r.size,r.type==="3d"?r.camera:r.viewpoint]),()=>this.notifyChange("screenLocation")),Q(()=>this.screenLocation,(r,i)=>{r!=null&&i!=null&&this.emit("view-change")})])}destroy(){this.view=null,this[_4]=Re(this[_4])}get screenLocation(){const{location:e,view:r,screenLocationEnabled:i}=this;return i&&e!=null&&r!=null&&r.ready?r.toScreen?.(e):null}};tCe=_4,u([d()],Bw.prototype,"location",void 0),u([d()],Bw.prototype,"screenLocation",null),u([d()],Bw.prototype,"screenLocationEnabled",void 0),u([d()],Bw.prototype,"view",void 0),Bw=u([R("esri.widgets.support.AnchorElementViewModel")],Bw);const xtt=Bw,Ttt="esri.widgets.CompassViewModel";let v4=class extends xtt{constructor(e){super(e),this.visible=!1}};u([d()],v4.prototype,"visible",void 0),v4=u([R(Ttt)],v4);const Fee=v4,gz="esri-spinner",yz={base:gz,spinnerStart:`${gz}--start`,spinnerFinish:`${gz}--finish`};let Gw=class extends Rc{constructor(e,r){super(e,r),this._animationDelay=500,this._animationPromise=null,this.viewModel=new Fee}initialize(){this.addHandles(Q(()=>this.visible,e=>this._visibleChange(e)))}destroy(){this._animationPromise=null}get location(){return this.viewModel.location}set location(e){this.viewModel.location=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}get visible(){return this.viewModel.visible}set visible(e){this.viewModel.visible=e}show(e){const{location:r,promise:i}=e??{};r&&(this.viewModel.location=r),this.visible=!0;const s=()=>this.hide();i&&i.catch(()=>{}).then(s)}hide(){this.visible=!1}render(){const{visible:e}=this,{screenLocation:r}=this.viewModel,i=!!r,s=e&&i,n=!e&&i,o={[yz.spinnerStart]:s,[yz.spinnerFinish]:n},a=this._getPositionStyles();return j("div",{class:this.classes(yz.base,o),styles:a})}_visibleChange(e){if(e)return void(this.viewModel.screenLocationEnabled=!0);const r=YC(this._animationDelay);this._animationPromise=r,r.catch(()=>{}).then(()=>{this._animationPromise===r&&(this.viewModel.screenLocationEnabled=!1,this._animationPromise=null)})}_getPositionStyles(){const{screenLocation:e,view:r}=this.viewModel;if(r==null||e==null)return{};const{padding:i}=r;return{left:e.x-i.left+"px",top:e.y-i.top+"px"}}};u([d()],Gw.prototype,"location",null),u([d()],Gw.prototype,"view",null),u([d({type:Fee})],Gw.prototype,"viewModel",void 0),u([d()],Gw.prototype,"visible",null),Gw=u([R("esri.widgets.Spinner")],Gw);const Stt=Gw;function MC(t,e,r=void 0){z1(t,"`"+e+"` is deprecated, because it instantiates the deprecated class 'esri.widgets.Editor.CreateWorkflow'",{replacement:r,version:"4.23",see:"https://developers.arcgis.com/javascript/latest/api-reference/esri-widgets-Editor-CreateFeaturesWorkflow.html"})}let KM=class extends Oc(Ke){constructor(e){super(e),this.handles.add([this.on("before-add",r=>{r.item==null&&r.preventDefault()}),this.on("after-add",r=>this._own(r.item)),this.on("after-remove",r=>this._release(r.item))])}get owner(){return this._get("owner")}set owner(e){e!==this._get("owner")&&(this._releaseAll(),this._set("owner",e),this._ownAll())}_ownAll(){for(const e of this.items)this._own(e)}_releaseAll(){for(const e of this.items)this._release(e)}_createNewInstance(e){return this.itemType?new(Ke.ofType(this.itemType.Type))(e):new Ke(e)}};function Hk(t,e){return{type:t,cast:Txe,set(r){const i=$T(r,this._get(e),t);i.owner=this,this._set(e,i)}}}u([d()],KM.prototype,"owner",null),KM=u([R("esri.core.support.OwningCollection")],KM);let nT=class extends KM{_own(e){e.layer&&"remove"in e.layer&&e.layer!==this.owner&&e.layer.remove(e),e.layer=this.owner}_release(e){e.layer===this.owner&&(e.layer=null)}};u([oK({Type:oa,ensureType:Sn(oa)})],nT.prototype,"itemType",void 0),nT=u([R("esri.support.GraphicsCollection")],nT);let Cy=class extends ZSe(xee(gV)){constructor(e){super(e),this.elevationInfo=null,this.graphics=new nT,this.screenSizePerspectiveEnabled=!0,this.type="graphics",this.internal=!1}destroy(){this.removeAll(),this.graphics.destroy()}add(e){return this.graphics.add(e),this}addMany(e){return this.graphics.addMany(e),this}removeAll(){return this.graphics.removeAll(),this}remove(e){this.graphics.remove(e)}removeMany(e){this.graphics.removeMany(e)}on(e,r){return super.on(e,r)}graphicChanged(e){this.emit("graphic-update",e)}};u([d({type:t2e})],Cy.prototype,"elevationInfo",void 0),u([d(Hk(nT,"graphics"))],Cy.prototype,"graphics",void 0),u([d({type:["show","hide"]})],Cy.prototype,"listMode",void 0),u([d()],Cy.prototype,"screenSizePerspectiveEnabled",void 0),u([d({readOnly:!0})],Cy.prototype,"type",void 0),u([d({constructOnly:!0})],Cy.prototype,"internal",void 0),Cy=u([R("esri.layers.GraphicsLayer")],Cy);const rCe=Cy;function SUt(t,e,r){return Math.sqrt((t[0]-e[0])**2+(t[1]-e[1])**2+(t[2]!==void 0&&e[2]!==void 0?(t[2]*r-e[2]*r)**2:0))}const V3=[];for(const t of[[9002,56146130,6131,6132,8050,8051,8228],[9003,5702,6358,6359,6360,8052,8053],[9095,5754]]){const e=t[0];for(let r=1;r<t.length;r++)V3[t[r]]=e}const eI=[];function Ett(t){return t.vcsWkid&&V3[t.vcsWkid]!==void 0?eI[V3[t.vcsWkid]]:t.latestVcsWkid&&V3[t.latestVcsWkid]!==void 0?eI[V3[t.latestVcsWkid]]:1}function Zle(t,e,r){const i={x:0,y:0};e&&(i.z=0),r&&(i.m=0);let s=0,n=t[0];for(let o=0;o<t.length;o++){const a=t[o];if(Ott(a,n)===!1){const l=iCe(n,a,e),c=Ctt(n,a,e,r);c.x*=l,c.y*=l,i.x+=c.x,i.y+=c.y,e&&(c.z*=l,i.z+=c.z),r&&(c.m*=l,i.m+=c.m),s+=l,n=a}}return s>0?(i.x/=s,i.y/=s,e&&(i.z/=s),r&&(i.m/=s)):(i.x=t[0][0],i.y=t[0][1],e&&(i.z=t[0][2]),r&&e?i.m=t[0][3]:r&&(i.m=t[0][2])),i}function Ctt(t,e,r,i){const s={x:(t[0]+e[0])/2,y:(t[1]+e[1])/2};return r&&(s.z=(t[2]+e[2])/2),r&&i?s.m=(t[3]+e[3])/2:i&&(s.m=(t[2]+e[2])/2),s}function Att(t,e){if(t.length<=1)return 0;let r=0;for(let i=1;i<t.length;i++)r+=iCe(t[i-1],t[i],e);return r}function iCe(t,e,r){const i=e[0]-t[0],s=e[1]-t[1];if(r){const n=e[2]-e[2];return Math.sqrt(i*i+s*s+n*n)}return Math.sqrt(i*i+s*s)}function Ott(t,e){if(t.length!==e.length)return!1;for(let r=0;r<t.length;r++)if(t[r]!==e[r])return!1;return!0}function EUt(t){const e={x:0,y:0,spatialReference:t.spatialReference.toJSON()},r={x:0,y:0,spatialReference:t.spatialReference.toJSON()};let i=0,s=0;for(let n=0;n<t.paths.length;n++){if(t.paths[n].length===0)continue;const o=Att(t.paths[n],t.hasZ===!0);if(o===0){const a=Zle(t.paths[n],t.hasZ===!0,t.hasM===!0);e.x+=a.x,e.y+=a.y,t.hasZ===!0&&(e.z+=a.z),t.hasM===!0&&(e.m+=a.m),++i}else{const a=Zle(t.paths[n],t.hasZ===!0,t.hasM===!0);r.x+=a.x*o,r.y+=a.y*o,t.hasZ===!0&&(r.z+=a.z*o),t.hasM===!0&&(r.m+=a.m*o),s+=o}}return s>0?(r.x/=s,r.y/=s,t.hasZ===!0&&(r.z/=s),t.hasM===!0&&(r.m/=s),new ht(r)):i>0?(e.x/=i,e.y/=i,t.hasZ===!0&&(r.z/=i),t.hasM===!0&&(e.m/=i),new ht(e)):null}function CUt(t){if(t.points.length===0)return null;let e=0,r=0,i=0,s=0;for(let o=0;o<t.points.length;o++){const a=t.getPoint(o);a.hasZ===!0&&(i+=a.z),a.hasM===!0&&(s+=a.m),e+=a.x,r+=a.y,s+=a.m}const n={x:e/t.points.length,y:r/t.points.length,spatialReference:null};return n.spatialReference=t.spatialReference.toJSON(),t.hasZ===!0&&(n.z=i/t.points.length),t.hasM===!0&&(n.m=s/t.points.length),new ht(n)}function Rtt(t,e){return t.x*e.x+t.y*e.y}function Mtt(t,e){return t.x*e.y-e.x*t.y}function FV(t,e,r=0){for(;t<r;)t+=e;const i=r+e;for(;t>=i;)t-=e;return t}function sCe(t,e){return Math.atan2(e.y-t.y,e.x-t.x)}function AUt(t,e){return FV(sCe(t,e),2*Math.PI)*(180/Math.PI)}function OUt(t,e){return FV(Math.PI/2-sCe(t,e),2*Math.PI)*(180/Math.PI)}function nCe(t,e,r){const i={x:t.x-e.x,y:t.y-e.y},s={x:r.x-e.x,y:r.y-e.y};return Math.atan2(Mtt(i,s),Rtt(i,s))}function RUt(t,e,r){return FV(nCe(t,e,r),2*Math.PI)*(180/Math.PI)}function MUt(t,e,r){return FV(-1*nCe(t,e,r),2*Math.PI)*(180/Math.PI)}eI[9002]=.3048,eI[9003]=.3048006096012192,eI[9095]=.3048007491;const pa=[0,0];function IUt(t){for(let e=0;e<t.length;e++){const r=t[e];for(let s=0;s<r.length-1;s++){const n=r[s],o=r[s+1];for(let a=e+1;a<t.length;a++)for(let l=0;l<t[a].length-1;l++){const c=t[a][l],h=t[a][l+1];if(zI(n,o,c,h,pa)&&!(pa[0]===n[0]&&pa[1]===n[1]||pa[0]===c[0]&&pa[1]===c[1]||pa[0]===o[0]&&pa[1]===o[1]||pa[0]===h[0]&&pa[1]===h[1]))return!0}}const i=r.length;if(!(i<3))for(let s=0;s<=i-2;s++){const n=r[s],o=r[s+1];for(let a=s+2;a<=i-2;a++){const l=r[a],c=r[a+1];if(zI(n,o,l,c,pa)&&!(pa[0]===n[0]&&pa[1]===n[1]||pa[0]===l[0]&&pa[1]===l[1]||pa[0]===o[0]&&pa[1]===o[1]||pa[0]===c[0]&&pa[1]===c[1]))return!0}}}return!1}function oCe(t,e,r){switch(t){case"point":case"multipoint":return"point";case"polyline":return(e!=null&&e.type==="polyline"&&e.paths.length?e.paths[0].length:0)<2?"polylineZeroVertices":"polylineOneVertex";case"polygon":{const i=e!=null&&e.type==="polygon"&&e.rings.length?e.rings[0].length:0;return i<3?"polylineZeroVertices":i<4?"polygonOneVertex":"polygonTwoVertices"}case"mesh":return Itt(e,r);default:return}}function Itt(t,e){if(t?.type!=="mesh"||e?.type!=="3d")return;const{renderCoordsHelper:r}=e,{camera:i}=e.state,{width:s,height:n,zmin:o,zmax:a,center:l,spatialReference:c}=t.extent,h=(a??0)-(o??0),p=Uo(c),f=Ett(c),m=Uo(r.spatialReference),g=Math.max(s*p,n*p,h*f)/m;ie(GL,l.x,l.y,l.z??0),r.toRenderCoords(GL,c,GL);const _=g/i.computeScreenPixelSizeAt(GL);return _>i.width*$tt?"meshTooClose":_<Ptt?"meshTooFar":"mesh"}const Ptt=20,$tt=1,GL=C();let jw=class extends me{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};u([d({constructOnly:!0})],jw.prototype,"layer",void 0),u([d()],jw.prototype,"enabled",void 0),u([d()],jw.prototype,"updating",void 0),u([d()],jw.prototype,"availability",void 0),jw=u([R("esri.views.interactive.snapping.FeatureSnappingLayerSource")],jw);const kee=jw;let fE=class extends me{constructor(e){super(e),this.creationInfo=null,this.pendingFeatures=new Ke,this.viewModel=null,this.upload=null}};u([d()],fE.prototype,"creationInfo",void 0),u([d()],fE.prototype,"viewModel",void 0),u([d()],fE.prototype,"upload",void 0),fE=u([R("esri.widgets.Editor.CreateFeaturesWorkflowData")],fE);function _z(t,e){return e?"xoffset"in e&&e.xoffset?Math.max(t,Math.abs(e.xoffset)):"yoffset"in e&&e.yoffset?Math.max(t,Math.abs(e.yoffset||0)):t:t}function Ltt(t){let e=0,r=0;for(let i=0;i<t.length;i++){const s=t[i].size;typeof s=="number"&&(e+=s,r++)}return e/r}function Xle(t,e){return typeof t=="number"?t:t&&t.stops&&t.stops.length?Ltt(t.stops):e}function Dtt(t,e){if(!e)return t;const r=e.filter(o=>o.type==="size").map(o=>{const{maxSize:a,minSize:l}=o;return(Xle(a,t)+Xle(l,t))/2});let i=0;const s=r.length;if(s===0)return t;for(let o=0;o<s;o++)i+=r[o];const n=Math.floor(i/s);return Math.max(n,t)}function aCe(t){const e=t&&t.renderer,r=(t&&t.event&&t.event.pointerType)==="touch"?9:6;if(!e)return r;const i="visualVariables"in e?Dtt(r,e.visualVariables):r;if(e.type==="simple")return _z(i,e.symbol);if(e.type==="unique-value"){let s=i;return e.uniqueValueInfos?.forEach(n=>{s=_z(s,n.symbol)}),s}if(e.type==="class-breaks"){let s=i;return e.classBreakInfos.forEach(n=>{s=_z(s,n.symbol)}),s}return e.type==="dot-density"||e.type,i}let kv=class extends Xr.EventedAccessor{constructor(e){super(e),this.tracking=!1,this.displaying=!1,this.isDraped=!1}};u([d({constructOnly:!0})],kv.prototype,"graphic",void 0),u([d()],kv.prototype,"tracking",void 0),u([d()],kv.prototype,"displaying",void 0),u([d()],kv.prototype,"isDraped",void 0),kv=u([R("esri.views.3d.layers.graphics.GraphicState")],kv);function lCe(t,e,r,i=new vr){let s=0;if(r.type==="2d")s=e*(r.resolution??0);else if(r.type==="3d"){const h=r.overlayPixelSizeInMapUnits(t),p=r.basemapSpatialReference;s=p==null||p.equals(r.spatialReference)?e*h:Uo(p)/Uo(r.spatialReference)}const n=t.x-s,o=t.y-s,a=t.x+s,l=t.y+s,{spatialReference:c}=r;return i.xmin=Math.min(n,a),i.ymin=Math.min(o,l),i.xmax=Math.max(n,a),i.ymax=Math.max(o,l),i.spatialReference=c,i}function DUt(t,e,r){const i=r.toMap(t);return i==null?!1:lCe(i,aCe(),r,Ntt).intersects(e)}const Ntt=new vr;async function cCe(t,e){if(t.type==="2d")return t.hitTest(e);const r=await t.hitTest(e);if(r.results.length===0)return r;const i=(r.results[0].distance??0)*(1+Ftt),s=r.results.findIndex(n=>(n.distance??0)>i);return s!==-1&&(r.results=r.results.slice(0,s)),r}const Ftt=.05;function uCe(t){return t?.type==="graphic"}function ktt(t){return t.find(uCe)??null}function hCe(t){return t.filter(uCe)}function kV(t){const e=t.sourceLayer;if(!e||e.type!=="feature"||!Gtt(e.renderer))return{rotation:null,size:null};let r=null,i=null;const s=e.renderer.getVisualVariablesForType("rotation").filter(o=>(!o.axis||o.axis==="heading")&&o.field&&!o.valueExpression&&UK(o,t)!=null);s.length===1&&(r=Utt(s[0],e));const n=e.renderer.getVisualVariablesForType("size").filter(o=>o.field&&!o.useSymbolValue&&!o.valueExpression&&kTe(o)===Ro.RealWorldSize&&u$(o,t)!=null);return n.length===1&&(i=Btt(n[0],e)),{rotation:r,size:i}}function Utt(t,e){const r=(t.axis||"heading")==="heading"&&t.rotationType==="arithmetic"?-1:1,i=t.field,s=e.fields&&e.fields.filter(a=>a.name===i),n=s&&s.length===1?s[0].type:"double",o={initial:0,current:0};return{field:i,fieldType:n,getDefault:()=>Promise.resolve(0),getValue:a=>(o.current=o.initial-r*a,ZW((o.current+360)%360,n)),initValue:a=>{o.initial=a??o.current,o.current=0},isUpdatingInteractively:!1,rotationType:t.rotationType??"geographic"}}function Vtt(t,e){switch(e){case"width":return t[0];case"depth":return t[1];case"height":return t[2];default:return t[2]||t[1]||t[0]}}async function ztt(t,e,r){if(e==null)return 0;const{symbol:i}=jTe(e);if(i==null||i.type==="web-style"||i.type==="cim")return 0;const s=i.symbolLayers.at(0);if(!s)return 0;switch(s.type){case"icon":{const{computeIconLayerResourceSize:n}=await J(()=>import("./symbolLayerUtils-af32dc81.js"),[],import.meta.url);return s.size||Math.min(m_.icon,(await n(s,m_.icon))[0])||m_.icon}case"text":return s.size||m_.text;case"line":return s.size||m_.line;case"object":{const{computeObjectLayerResourceSize:n}=await J(()=>import("./symbolLayerUtils-af32dc81.js"),[],import.meta.url);return Vtt(await n(s,t.scale/m_.viewScaleSizeFactor),r)}case"path":return(s.width!=null?s.width:s.height)||t.scale/m_.viewScaleSizeFactor;case"extrude":return s.size||t.scale/m_.viewScaleSizeFactor;default:return 0}}function Btt(t,e){const r=t.field,i=t.axis,s=e.fields&&e.fields.filter(c=>c.name===r),n=s&&s.length===1?s[0].type:"double",o={updating:!1,initial:0,current:0},a=LT[t.valueUnit]??1;let l;return l=t.valueRepresentation==="area"?c=>(c*a/2)**2*Math.PI:t.valueRepresentation==="radius"||t.valueRepresentation==="distance"?c=>c*a/2:c=>c*a,{field:r,fieldType:n,getDefault:async(c,h)=>ZW(l(await ztt(h,c,i)),n),getValue:(c,h)=>(o.initial||(o.initial=h.pixelSizeAt(h.center)),o.current=o.initial*c,ZW(o.current,n)),initValue:c=>{o.initial=c??o.current,o.current=0},isUpdatingInteractively:!1,displayUnit:srt(t.valueUnit),axis:t.axis}}function ZW(t,e){switch(e){case"small-integer":case"integer":case"long":return Math.round(t);case"double":case"single":return t;default:return 0}}function Gtt(t){switch(t?.type){case"class-breaks":case"simple":case"unique-value":case"dot-density":case"dictionary":case"pie-chart":return!0;default:return!1}}async function q1(t,e){const r=await jW(t,{useSourceLayer:!0,ignoreGraphicSymbol:!0,webStyleCache:e});uSe(t.symbol,r)!=null&&(t.symbol=r)}function jtt(t){if(!t)throw new Error("no geometry type");return t==="multipatch"?"mesh":t}async function Htt(t,e,r,i){await XW(t,e,i);const s=t.on("create",async n=>{if(n.state==="cancel")return XW(t,e,i);if(n.state==="complete"){const o=n.graphic;o.sourceLayer||(o.sourceLayer=e.layer),o.attributes||(o.attributes={...e.template?.prototype.attributes}),await q1(o,i),r(o)}});return Sc([s,Zr(()=>t.cancel())])}async function XW(t,e,r){const i=e.layer,s={...e.template?.prototype.attributes};await qtt(t,i,s,r),t.layer.elevationInfo=i.elevationInfo,await t.create(jtt(i.geometryType),{graphicProperties:{attributes:s,sourceLayer:i},hasZ:i.capabilities.data.supportsZ,geometryToPlace:e.geometryToPlace??void 0})}async function qtt(t,e,r,i){const s=new oa({sourceLayer:e,attributes:r}),{rotation:n,size:o}=kV(s);let a=await jW(s,{useSourceLayer:!0,webStyleCache:i}),l=!1;for(const c of[o,n])c!=null&&r[c.field]==null&&(r[c.field]=await c.getDefault(a,t.view),l=!0);switch(l&&(a=await jW(s,{useSourceLayer:!0,webStyleCache:i})),a?.type){case"simple-fill":case"polygon-3d":t.polygonSymbol=a;break;case"simple-line":case"line-3d":t.polylineSymbol=a;break;case"simple-marker":case"picture-marker":case"point-3d":case"cim":t.pointSymbol=a}dCe(t.tooltipOptions,o,n)}function dCe(t,e,r){t.visualVariables=e!=null||r!=null?{size:e!=null?{unit:e.displayUnit,axis:e.axis,valueType:e.fieldType}:null,rotation:r!=null?{valueType:r.fieldType,rotationType:r.rotationType??"geographic"}:null}:null}function Uee(t,e){return t?t.find(r=>r.layer===e):void 0}async function Wtt(t,e,r,i){if(t.length===0)return[];const{updatable:s,graphicsByLayer:n}=await r.async(async()=>{const{results:o}=await gT(cCe(e,r),i),a=new Map,l=h=>{const p=h.layer,f=a.get(p);if(!f){const m=new Array;return a.set(p,m),m}return f};hCe(o).forEach(({graphic:h})=>l(h).push(h));const c=t.filter(({supports:h,layer:p})=>h.includes("update")&&a.has(p));return c.length!==0&&r.stopPropagation(),{updatable:c,graphicsByLayer:a}});return gT(Oh(s.map(async({layer:o})=>{const{objectIdField:a}=o,l="displayField"in o?o.displayField:null,c=[a];l!=null&&o.fieldsIndex.has(l)&&c.push(l);const h=n.get(o);if(h.some(p=>c.some(f=>!(f in p.attributes)))){const p=o.createQuery();return p.outFields=c,p.returnGeometry=!1,p.objectIds=h.map(f=>f.getObjectId()),o.queryFeatures(p,{signal:i}).then(({features:f})=>f)}return h})),i)}async function Ztt(t,e,r,i){if(t.length===0)return[];let s=null;const n=await r.async(async()=>{const{results:o}=await gT(e.hitTest(r),i);if(o.length===0)return[];const a=new Set;s=hCe(o),s.forEach(({graphic:c})=>c&&a.add(c.layer));const l=t.items.filter(({layer:c,supports:h,attachmentsOnUpdateEnabled:p})=>a.has(c)&&(h.includes("update")||h.includes("delete")||p));return l.length>0&&r.stopPropagation(),l});return gT(Oh(n.map(({layer:o})=>{const a=o.objectIdField,l="displayField"in o?o.displayField:null,c=HQ({displayField:l,fields:o.fields}),h=[a];c!=null&&o.fieldsIndex.has(c)&&h.push(c);const p=o.createQuery();p.outFields=h,p.returnGeometry=!1;const f="renderer"in o?aCe({renderer:o.renderer,event:r}):0;return p.geometry=lCe(r.mapPoint,f,e),p.outSpatialReference=e.spatialReference,o.queryFeatures(p,{signal:i}).then(({features:m})=>(s?.forEach(({graphic:g})=>{g.layer!==o||m.some(_=>_.getObjectId()===g.getObjectId())||m.push(g)}),m))})),i)}async function Xtt(t,e,r,i){switch(e.type){case"3d":return Wtt(t,e,r,i);case"2d":return Ztt(t,e,r,i)}}async function Ytt(t,e,r){const{sourceLayer:i}=t,s=i.createQuery();s.objectIds=[t.getAttribute(i.objectIdField)],s.outFields=["*"],s.outSpatialReference=e,s.returnM=i.capabilities.data.supportsM,s.returnZ=i.capabilities.data.supportsZ,QI()&&qK()&&i.type==="scene"&&i.infoFor3D!=null&&(s.returnGeometry=!0,s.formatOf3DObjects="3D_glb");const n=await i.queryFeatures(s,{signal:r});return Dt(r),n.features[0]}async function nP(t){const{graphic:e,sketchViewModel:r,sourceLayer:i,visualVariables:s,webStyleCache:n}=t;let o=!1;const{rotation:a,size:l}=s;[a,l].forEach(async h=>{if(h==null)return;const p=e.getAttribute(h.field);if(p!=null)h.initValue(p);else{const f=await h.getDefault(e.symbol,r.view);h.initValue(f),e.setAttribute(h.field,f),o=!0}}),o&&await q1(e,n);const c={multipleSelectionEnabled:!1};return i.geometryType==="point"&&(c.enableRotation=a!=null,c.enableScaling=l!=null),dCe(r.tooltipOptions,l,a),r.layer.elevationInfo=i.elevationInfo,r.update(e,c)}function Jtt(t){return t==null||t.type!=="rotate-start"&&t.type!=="rotate"&&t.type!=="rotate-stop"?null:t}function Qtt(t){return t==null||t.type!=="scale-start"&&t.type!=="scale"&&t.type!=="scale-stop"?null:t}async function Vee(t,e,r,i,s){if(e.geometry==null||e.geometry?.type!=="point")return;const n=i.rotation,o=Jtt(r.toolEventInfo);if(n!=null&&o!=null)if(o.type==="rotate-stop")n.isUpdatingInteractively=!1,n.initValue();else{n.isUpdatingInteractively=!0;const{field:c,getValue:h}=n;e.setAttribute(c,h(o.angle,t))}const a=i.size,l=Qtt(r.toolEventInfo);if(a!=null&&l!=null)if(l.type==="scale-stop")a.isUpdatingInteractively=!1,a.initValue();else{a.isUpdatingInteractively=!0;const{field:c,getValue:h}=a;e.setAttribute(c,h(l.xScale,t))}await q1(e,s)}async function Ktt(t,e,r,i,s,n){const o=vz(t);await q1(o,n),i.map.add(r.layer),r.layer.add(o);const a=t.sourceLayer,l=oP(i,a);await rrt(i,o),await nP({graphic:o,sketchViewModel:r,sourceLayer:a,visualVariables:e,webStyleCache:n});const c=ert(r,t,o);let h=null;l.then(b=>h=b).catch(()=>{});const p=e.size,f=e.rotation,m=Q(()=>t.attributes,async b=>{let x=!1;for(const T in b){const S=b[T];S!==o.getAttribute(T)&&(o.setAttribute(T,S),p==null||p.isUpdatingInteractively||p.field!==T||p.initValue(S),f==null||f.isUpdatingInteractively||f.field!==T||f.initValue(S),(h==null||h.requiredFields.includes(T))&&(x=!0))}x&&await q1(o,n)}),g=r.on("update",async b=>{const x=b.graphics[0];if(b.state==="complete")return nP({graphic:x,sketchViewModel:r,sourceLayer:a,visualVariables:e,webStyleCache:n});await Vee(i,x,b,e,n),s(vz(x),b)}),_=r.on(["undo","redo"],async b=>{s(vz(b.graphics[0]),b)}),v=r.updateOnGraphicClick;return{visual:Sc([c,Zr(()=>{r.updateOnGraphicClick=v})]),interactive:Sc([_,g,Zr(()=>r.cancel()),m,Zr(()=>{r.updateOnGraphicClick=!1})])}}function ert(t,e,r){const i=t.view,s=e.sourceLayer,n=e.layer,o=e.getAttribute(n.objectIdField);let a=null;function l(c){a?.abort(),a=hb(async h=>{const p=await oP(i,s);Dt(h),p.setVisibility?.(o,c)})}return l(!1),Sc([trt(i,r,c=>l(!c)),Zr(async()=>{l(!0);const c=await oP(i,s);await Pn(()=>!c.updating),t.layer.remove(r)})])}function trt(t,e,r){if(t.type==="3d"){const i=new kv({graphic:e});return Sc([t.trackGraphicState(i),Q(()=>i.displaying,r)])}return Q(()=>e.visible,r)}async function rrt(t,e){if(t.type==="3d"){const r=new kv({graphic:e}),i=t.trackGraphicState(r);await Pn(()=>r.displaying),i.remove()}else await Pn(()=>e.visible)}const m_={icon:Fl(24),text:Fl(12),line:Fl(1),viewScaleSizeFactor:100};function zee(t,e,r){let i=!1;return t.filter(s=>!!i||(i=s===e,i)).map(s=>r[s]())}function irt(t){if(t.length!==1)return null;const e=t[0];if("items"in e){const r=e;return r.items.length===1?r.items[0]:null}return e}function pCe(t,e){if(t.viewModel.refreshCreationTemplates(),e[0].id==="awaiting-feature-creation-info"){const r=irt(t.viewModel.featureTemplatesViewModel.items);r==null||r.supportsUpload||(t.creationInfo=r,e.shift())}return e}function srt(t){switch(t){case"unknown":case"decimal-degrees":return null;default:return t}}function fCe(t){t.filesEnabled=!0,t.mode="view",t.capabilities={editing:!0,operations:{add:!0,update:!0,delete:!0}}}function mCe(t){const{creationInfo:e,viewModel:r}=t;if(!e)return!1;const{layer:i}=e,s=r.editableItems.find(a=>a.layer===i);if(s)return s.attachmentsOnCreateEnabled;const n=i.capabilities?.data,o=r.layerInfos?.find(a=>a.layer===i);return!(!(n&&"supportsAttachment"in n&&n.supportsAttachment)||o&&(o.allowAttachments===!1||o.attachmentsOnUpdateEnabled===!1))}const gCe=t=>/-stop/.test(t)||/vertex-/.test(t),oP=(t,e)=>{const r=e.type==="subtype-sublayer"?e.parent:e;return t.whenLayerView(r)};function nrt(t){return"createInteractiveEditSession"in t}function vz(t){const e=t.geometry;if(e?.type==="mesh"){const r=t.cloneShallow();return r.attributes=re(t.attributes),r.geometry=e.cloneShallow(),r.geometry.transform=e.transform?.clone()??null,r}return t.clone()}function YW(t){const e=t.cursor;return t.cursor="progress",Zr(()=>t.cursor=e)}async function ort({view:t,data:e,signal:r,next:i,cancel:s}){const{creationInfo:n}=e;if(!n||!qk(n))return;const{layer:o}=n,a=n.geometryToPlace!=null;if(n.geometryToPlace=null,a)return void s();const l=(await J(()=>import("./Upload-9d145b13.js"),[],import.meta.url)).Upload;Dt(r);const c=new l;e.upload=c;const h=YW(t),p=Sc([h,Q(()=>c.state,f=>{switch(f){case"success":n.maxFeatures=1,n.geometryToPlace=c.result,i();break;case"error":h.remove();break;case"canceled":s()}}),Zr(()=>{e.upload=Re(e.upload)})]);return c.uploadTo(o),p}function qk(t){return t?.layer?.type==="scene"}let Yo=class extends Oc(Xr.EventedAccessor){constructor(e){super(e),this._indexHistory=[],this._lastStepIndex=-1,this._stepIndex=-1,this._setupAbortController=null,this._handleKeys={afterCommit:"after-commit",beforeCommit:"before-commit"},this.data=void 0,this.started=!1,this.steps=[],this.type=null}get hasNextStep(){const{steps:e}=this;return!!(e&&this._stepIndex<e.filter(r=>!r.parent).length-1)}get hasPreviousStep(){return this._stepIndex>0}get reliesOnOwnerAdminPrivileges(){return!1}get hasInvalidFormTemplate(){return!1}get hasUnsupportedFields(){return!1}get shouldShowAttachments(){return!1}get shouldAllowAttachmentEditing(){return!1}get stepId(){const{steps:e}=this,r=e&&e[this._stepIndex];return r&&r.id}get helpMessage(){}get hasPendingEdits(){return!1}get keyboardCancellationEnabled(){return!0}async back(e=()=>Promise.resolve(!0)){this.hasPendingEdits&&!await e()||(this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0}))}async cancel(e={force:!0}){return e.force!==!1?this._cancel(e):new Promise((r,i)=>{this.emit("cancel-request",{controller:{allow:()=>{this._cancel({...e,force:!0}).then(r)},deny:()=>i(new D("workflow:cancel-denied","Request to cancel workflow was denied."))}})})}async commit(){this.handles.remove(this._handleKeys.beforeCommit),await this.onCommit?.(this.data),this.handles.remove(this._handleKeys.afterCommit),this.emit("commit")}async go(e){const{steps:r}=this,i=r.findIndex(s=>s.id===e);this._indexHistory.push(this._stepIndex),await this._go(i)}async next(){this._indexHistory.push(this._stepIndex),await this._go(this._stepIndex+1)}async previous(e={cancelCurrentStep:!1}){await this._go(this._indexHistory.pop(),e.cancelCurrentStep)}async reset(){await this._cancel({notify:!1}),await this.start()}async save(){await this.commit(),await this.reset()}async start(){this._set("started",!0);const e=this._stepIndex===-1?0:this._stepIndex;await this._go(e)}async _cancel({notify:e=!0,error:r}={}){this.started&&(this._set("started",!1),await this.steps[this._stepIndex].tearDown({canceled:!0})),this.handles.remove([this._handleKeys.afterCommit,this._handleKeys.beforeCommit]),this._resetIndexing(e),e&&this.emit("cancel",{error:r})}async _go(e=-1,r=!1){const{steps:i}=this;if(e<=-1||e>=i.length)return;if(!this.started)return this._stepIndex=e,void this._notifyStepProps();this._lastStepIndex>-1&&(this._setupAbortController=Do(this._setupAbortController),await i[this._lastStepIndex].tearDown({canceled:r})),this._setupAbortController=new AbortController;const s=this._setupAbortController.signal;try{await i[e].setUp(s)}catch(n){Uj(n)}this._setupAbortController.signal===s&&(this._setupAbortController=null),s.aborted||(this._lastStepIndex=e,this._stepIndex=e,this._notifyStepProps())}_resetIndexing(e=!0){this._stepIndex=-1,this._lastStepIndex=-1,this._indexHistory.length=0,e&&this._notifyStepProps()}_notifyStepProps(){this.notifyChange("stepId"),this.notifyChange("hasPreviousStep"),this.notifyChange("hasNextStep")}};u([d()],Yo.prototype,"data",void 0),u([d()],Yo.prototype,"hasNextStep",null),u([d()],Yo.prototype,"hasPreviousStep",null),u([d()],Yo.prototype,"onCommit",void 0),u([d()],Yo.prototype,"reliesOnOwnerAdminPrivileges",null),u([d()],Yo.prototype,"hasInvalidFormTemplate",null),u([d()],Yo.prototype,"hasUnsupportedFields",null),u([d()],Yo.prototype,"shouldShowAttachments",null),u([d()],Yo.prototype,"shouldAllowAttachmentEditing",null),u([d()],Yo.prototype,"started",void 0),u([d({readOnly:!0})],Yo.prototype,"stepId",null),u([d()],Yo.prototype,"steps",void 0),u([d({readOnly:!0})],Yo.prototype,"type",void 0),u([d()],Yo.prototype,"helpMessage",null),u([d()],Yo.prototype,"hasPendingEdits",null),u([d()],Yo.prototype,"keyboardCancellationEnabled",null),Yo=u([R("esri.widgets.Editor.Workflow")],Yo);const UV=Yo;var b4;const bz=Symbol(),Yle=Symbol();let Cm=b4=class extends UV{constructor(t){super(t),this.type="create-features",this.createFeatureState="create-new",this._featureFormHandle=null,this._visualVariableAttributes={rotation:null,size:null},this._attachmentFileInfos=new Map,this._highlightHandles=new Map,this._preventDefaultActionOnCancel=!1,this._lastActiveGraphics=[]}get hasPendingEdits(){if(this.numPendingFeatures)return!0;const{data:t}=this,{upload:e}=t;return!(!e||e.error)||!!t.creationInfo?.geometryToPlace}get helpMessage(){const{creationInfo:t,viewModel:e}=this.data;if(this.stepId!=="creating-features"||!t)return;const r=t.layer.geometryType,i=e.sketchViewModel.createGraphic?.geometry;return oCe(r,i,e.view)}get numPendingFeatures(){return this.pendingFeatures.length}get pendingFeatures(){return this.data.pendingFeatures}get keyboardCancellationEnabled(){return this.numPendingFeatures===0}get reliesOnOwnerAdminPrivileges(){const{creationInfo:t}=this.data;if(!t)return!1;const{layer:e}=t,r=e.capabilities?.operations.supportsAdd,i=vg(e)?.operations.supportsAdd;return oV(e)&&!e.editingEnabled||!!i&&!r}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&mCe(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get updating(){return this.updatingHandles.updating}get test(){return{addAttachment:(t,e)=>{this._attachmentFileInfos.set(t,e)}}}async enter(){const{featureFormViewModel:t}=this.data.viewModel,e=t.relatedRecordCallbacks;t.relatedRecordCallbacks=null,this.addHandles(Zr(()=>{t.relatedRecordCallbacks=e}),Yle)}exit(){this.removeHandles(Yle)}async updatePendingFeature(t,e){return this._preventDefaultActionOnCancel=!0,this.data.viewModel.sketchViewModel.cancel(),II(this._lastActiveGraphics,t),this._startUpdating(t,e)}static create(t){const{addAttachmentsCallback:e,applyEditsCallback:r,creationInfo:i,startAt:s,viewModel:n}=t,o=new b4({data:new fE({creationInfo:i,viewModel:n}),onCommit:async a=>{const{creationInfo:l}=a;if(!l)return;l.geometryToPlace&&(a.creationInfo=null);const c=a.pendingFeatures.toArray(),{layer:h}=l,p=h.capabilities?.editing.supportsGlobalId&&"globalIdField"in h,f=o._attachmentFileInfos;if(p){const g=crt(c,h,f);return void await r(h,g,{globalIdUsed:!0})}const m=await r(h,{addFeatures:c});if(f.size>0){const g=m?.addFeatureResults??[];await e(h,lrt(c,g,h,f))}}});return o._set("steps",this._createWorkflowSteps(o,s)),o}_fadeExistingFeatures(t){if("effect"in t){const r=t.effect;return t.effect="saturate(0.6) opacity(0.8)",Zr(()=>t.effect=r)}const e=t.opacity;return t.opacity=.7,Zr(()=>t.opacity=e)}_highlight(t){const e=this.data.viewModel.view;e?.type==="3d"&&this._highlightHandles.set(t,e.highlight(t))}_removeHighlight(t){Pi(this._highlightHandles.get(t)),this._highlightHandles.delete(t)}async _startCreating(t){const{data:e}=this,{creationInfo:r}=e;if(r)return this.createFeatureState="create-new",XW(e.viewModel.sketchViewModel,r,t)}async _startUpdating(t,e){const{pendingFeatures:r}=this;r.includes(t)||r.add(t);const{creationInfo:i,viewModel:s}=this.data,{featureFormViewModel:n,layerInfos:o,sketchViewModel:a,view:l}=s;if(!l||!i)return;const c=i.layer,h=Uee(o,c),p=h?.formTemplate,f=l.spatialReference;return n.set({arcadeEditType:"INSERT",feature:t,formTemplate:p,spatialReference:f,map:l.map}),this._removeHighlight(t),await q1(t,e),Pi(this._featureFormHandle),this._featureFormHandle=Sc([n.on("value-change",async()=>{t.attributes=n.getValues(),await q1(t,e)}),a.on(["update","undo","redo"],m=>{(m.type==="undo"||m.type==="redo"||m.type==="update"&&m.toolEventInfo!=null&&gCe(m.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()})]),this.createFeatureState="update-pending",this._visualVariableAttributes=kV(t),uA(c)?void 0:nP({graphic:t,sketchViewModel:a,sourceLayer:c,visualVariables:this._visualVariableAttributes,webStyleCache:e})}static _createWorkflowSteps(t,e="awaiting-feature-creation-info"){const{data:r,handles:i}=t,s=zee(["awaiting-feature-creation-info","creating-features","adding-attachment","editing-attachment"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(n){const{creationInfo:o,viewModel:a}=r,{view:l}=a;if(l)if(qk(o)){const c=await ort({view:l,data:r,signal:n,next:()=>t.next(),cancel:()=>a.cancelWorkflow()});Dt(n),i.add(c,this.id)}else r.creationInfo=null,i.add(a.featureTemplatesViewModel.on("select",({item:c})=>{c&&(r.creationInfo=c,a.activeWorkflow?.next())}),this.id)},async tearDown(){i.remove(this.id)}}),"creating-features":()=>({id:"creating-features",async setUp(){if(i.has(this.id))return;const{viewModel:n}=r,{view:o}=n;if(!o)return;const a=new Map,l=[],c=[];t._lastActiveGraphics=[],t._featureFormHandle=Pi(t._featureFormHandle),t._visualVariableAttributes={rotation:null,size:null},fCe(n.attachmentsViewModel),l.push(Q(()=>n.attachmentsViewModel.mode,f=>{switch(f){case"add":t.go("adding-attachment");break;case"edit":t.go("editing-attachment")}}));const h=YW(o);l.push(h);const p=uA(t.data.creationInfo?.layer);try{if(!p){const m=b4._configureSketchViewModel(t,a);l.push(m.beforeCommit),c.push(m.afterCommit)}const f=r.creationInfo?.initialFeature;f?(p||n.sketchViewModel.layer.add(f),await t._startUpdating(f,a)):await t._startCreating(a)}finally{h.remove()}l.push(t._featureFormHandle),i.add(l,t._handleKeys.beforeCommit),i.add([...l,...c],this.id)},async tearDown(n){const{viewModel:o}=r;if(n.canceled){const{pendingFeatures:a}=t;a.drain(l=>o.sketchViewModel.layer.remove(l)),i.remove([this.id,bz]),o.attachmentsViewModel.fileInfos.removeAll(),t._attachmentFileInfos.clear()}}}),"adding-attachment":()=>({id:"adding-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:n}=r.viewModel,{graphic:o,fileInfos:a}=n;t._attachmentFileInfos.set(o,a.toArray()),n.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"creating-features",async setUp(){},async tearDown(){const{attachmentsViewModel:n}=r.viewModel,{graphic:o,fileInfos:a}=n;t._attachmentFileInfos.set(o,a.toArray()),n.mode="view"}})});return pCe(r,s)}static _configureSketchViewModel(t,e){const{data:r,handles:i}=t,{viewModel:s}=r,{view:n}=s,o=s.sketchViewModel;let a=null;const l=[];if(!n)return{beforeCommit:Zr(),afterCommit:Zr()};const c=o.updateOnGraphicClick;return o.updateOnGraphicClick=!1,n.type==="2d"&&r.creationInfo&&l.push(t._fadeExistingFeatures(r.creationInfo.layer)),l.push(o.on("create",async h=>{if(h.state==="cancel"){if(t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);if(t._lastActiveGraphics.length<1)return t._startCreating(e);const p=t._lastActiveGraphics.pop();return t._startUpdating(p,e)}if(h.state==="complete"&&h.graphic)return t._startUpdating(h.graphic,e)}),o.on("update",async h=>{const{viewModel:p}=r,{attachmentsViewModel:f,featureFormViewModel:m}=p,g=h.graphics[0];if(h.state==="complete"){if(g!==a&&(t._lastActiveGraphics.push(g),t._highlight(g)),a=null,t.numPendingFeatures===r.creationInfo?.maxFeatures){const T=t._lastActiveGraphics.pop();return t._startUpdating(T,e)}if(f.mode!=="add"&&f.mode!=="edit"||p.activeWorkflow?.previous(),h.aborted&&t._preventDefaultActionOnCancel)return void(t._preventDefaultActionOnCancel=!1);i.add([YW(n),n.on("click",T=>T.preventDefault())],bz),await Pn(()=>!m.updating),i.remove(bz),t._startCreating(e)}h.state==="start"&&(t._removeHighlight(g),f.mode!=="add"&&f.mode!=="edit"||p.activeWorkflow?.previous(),f.fileInfos.removeAll(),f.graphic=g,f.mode="view",(t._attachmentFileInfos.get(g)||[]).forEach(({file:T,form:S})=>f.addFile(T,S)));const _=t._visualVariableAttributes;await Vee(n,g,h,_,e);const v=g.attributes,{rotation:b,size:x}=_;if(b!=null){const{field:T}=b;m.setValue(T,v[T])}if(x!=null){const{field:T}=x;m.setValue(T,v[T])}}),o.on("delete",async h=>{const p=h.graphics[0];t.pendingFeatures.remove(p),II(t._lastActiveGraphics,p),a=p}),n.on("immediate-click",async h=>{if(qk(r.creationInfo))return;const{results:p}=await n.hitTest(h,{include:o.layer}),f=p.find(g=>g.type==="graphic");if(!f)return;const m=f.graphic;if(o.activeTool==="transform"||o.activeTool==="reshape"){if(o.updateGraphics.at(0)===m)return;await t.updatePendingFeature(m,e)}}),Zr(()=>o.cancel()),art(o,r)),{beforeCommit:Sc(l),afterCommit:Zr(()=>{o.updateOnGraphicClick=c})}}};function art(t,e){let r=null;const i=()=>t.snappingOptions.featureSources,s=()=>(r=new kee({layer:t.layer}),i().add(r),r),n=()=>{r!=null&&(i().remove(r),r=Re(r))};return Sc([Q(()=>{const o=e.creationInfo?.layer,a=i().find(l=>l.layer===o);return{hasFeatureLayerSource:!!a,enabled:a?.enabled??!1}},({hasFeatureLayerSource:o,enabled:a})=>{if(!o)return n();r??(r=s()),r.enabled=a},Ri),Zr(n)])}function lrt(t,e,r,i){const s=[];return e.forEach((n,o)=>{if(!n.error){const a=t[o],l=i.get(a)||[];a.attributes[r.objectIdField]=n.objectId,l.forEach(({form:c})=>s.push({feature:a,attachment:c}))}}),s}function crt(t,e,r){const i=[],s=e.globalIdField;return t.forEach((n,o)=>{var a;(a=t[o].attributes)[s]??(a[s]=$ne()),(r?.get(n)||[]).forEach(({file:l})=>i.push({feature:n,attachment:{globalId:$ne(),data:l}}))}),i.length?{addFeatures:t,addAttachments:i}:{addFeatures:t}}u([d()],Cm.prototype,"hasPendingEdits",null),u([d()],Cm.prototype,"helpMessage",null),u([d()],Cm.prototype,"keyboardCancellationEnabled",null),u([d()],Cm.prototype,"reliesOnOwnerAdminPrivileges",null),u([d()],Cm.prototype,"shouldShowAttachments",null),u([d()],Cm.prototype,"shouldAllowAttachmentEditing",null),u([d()],Cm.prototype,"updating",null),Cm=b4=u([R("esri.widgets.Editor.CreateFeaturesWorkflow")],Cm);const yCe=Cm;let mE=class extends me{constructor(e){super(e),this.creationInfo=null,this.edits=null,this.viewModel=null}};u([d()],mE.prototype,"creationInfo",void 0),u([d()],mE.prototype,"edits",void 0),u([d()],mE.prototype,"viewModel",void 0),mE=u([R("esri.widgets.Editor.CreateWorkflowData")],mE);const urt=mE;function Jle(t){return t==null?null:JSON.stringify(t)}let Vy=class extends Oc(me){constructor(e){super(e),this._baselineAttributesJSON=null,this._baselineGeometryJSON=null,this._stagedForDelete=!1,this.feature=null}get attributesModified(){const e=this.feature?.attributes;return e!=null&&this._baselineAttributesJSON!==this._stringifyAttributes(e)}get geometryModified(){const e=this.feature?.geometry;return e!=null&&this._baselineGeometryJSON!==this._stringifyGeometry(e)}get stagedForDelete(){return this._stagedForDelete}get modified(){return this.attributesModified||this.geometryModified||this._stagedForDelete}stageDelete(){this._stagedForDelete=!0}unstageDelete(){this._stagedForDelete=!1}trackChanges(){const{feature:e}=this;if(!e)return;const{attributes:r,geometry:i}=e;this._baselineAttributesJSON=this._stringifyAttributes(r),this._baselineGeometryJSON=this._stringifyGeometry(i),this.notifyChange("attributesModified"),this.notifyChange("geometryModified")}updateAttributes(e){const{feature:r}=this;r&&(r.attributes=e,this.notifyChange("attributesModified"))}updateGeometry(e){const{feature:r}=this;r&&(r.geometry=e,this.notifyChange("geometryModified"))}_stringifyAttributes(e){return Jle(e)}_stringifyGeometry(e){return Jle(e?.type==="mesh"?{transform:e.transform,vertexSpace:e.vertexSpace}:e)}};u([d()],Vy.prototype,"_stagedForDelete",void 0),u([d()],Vy.prototype,"attributesModified",null),u([d()],Vy.prototype,"feature",void 0),u([d()],Vy.prototype,"geometryModified",null),u([d()],Vy.prototype,"modified",null),Vy=u([R("esri.widgets.Editor.Edits")],Vy);var JW;let cv=JW=class extends UV{constructor(t){super(t),this.type="create"}get shouldShowAttachments(){return!!(this.data&&this.data.creationInfo&&this.data.viewModel)&&mCe(this.data)}get shouldAllowAttachmentEditing(){return this.shouldShowAttachments}get hasPendingEdits(){return!0}get helpMessage(){if(this.stepId!=="editing-new-feature")return;const{creationInfo:t,viewModel:e}=this.data,r=e.sketchViewModel.createGraphic?.geometry,i=t.layer.geometryType;return oCe(i,r,e.view)}get reliesOnOwnerAdminPrivileges(){const{layer:t}=this.data.creationInfo,e=t.capabilities?.operations.supportsAdd,r=vg(t)?.operations.supportsAdd;return oV(t)&&!t.editingEnabled||!!r&&!e}static create(t,e,r){const i=new JW({data:new urt({edits:new Vy,viewModel:t}),onCommit:async s=>{await r(s.creationInfo.layer,{addFeatures:[s.edits.feature]})}});return i._set("steps",this._createWorkflowSteps(i,e)),i}static _createWorkflowSteps(t,e="awaiting-feature-creation-info"){const{data:r,handles:i}=t,s=new Map,n=zee(["awaiting-feature-creation-info","awaiting-feature-to-create","editing-new-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-creation-info":()=>({id:"awaiting-feature-creation-info",async setUp(){r.creationInfo=null,r.edits.feature=null,r.viewModel.featureTemplatesViewModel.select(null),i.add(r.viewModel.featureTemplatesViewModel.on("select",({item:o})=>{o&&(r.creationInfo=o,r.viewModel.activeWorkflow?.next())}),this.id)},async tearDown(){i.remove(this.id)}}),"awaiting-feature-to-create":()=>({id:"awaiting-feature-to-create",async setUp(){i.add(await Htt(r.viewModel.sketchViewModel,r.creationInfo,o=>{r.edits.feature=o,r.viewModel.activeWorkflow?.next()},s),this.id)},async tearDown(){i.remove(this.id)}}),"editing-new-feature":()=>({id:"editing-new-feature",async setUp(){const o=r.edits.feature,a=o.sourceLayer,l=r.viewModel,c=l.sketchViewModel,h=Uee(l.layerInfos,a),p=h?.formTemplate,{spatialReference:f}=l.view;l.featureFormViewModel.set({arcadeEditType:"INSERT",feature:o,formTemplate:p,spatialReference:f}),c.allowDeleteKey=!1,fCe(l.attachmentsViewModel);const m=kV(o);await nP({graphic:o,sketchViewModel:c,sourceLayer:a,visualVariables:m,webStyleCache:s});const g=c.on("update",async _=>{const v=_.graphics[0];if(_.state==="complete")return nP({graphic:v,sketchViewModel:c,sourceLayer:a,visualVariables:m,webStyleCache:s});await Vee(c.view,v,_,m,s);const b=v.attributes;if(m.rotation!=null){const{field:x}=m.rotation;l.featureFormViewModel.setValue(x,b[x])}if(m.size!=null){const{field:x}=m.size;l.featureFormViewModel.setValue(x,b[x])}});i.add([r.viewModel.featureFormViewModel.on("value-change",async()=>{r.edits.updateAttributes(r.viewModel.featureFormViewModel.getValues()),o.attributes=r.edits.feature.attributes,c.view.type==="3d"&&await q1(o,s)}),g,Q(()=>r.viewModel.attachmentsViewModel.mode,_=>{_==="add"&&r.viewModel.activeWorkflow.go("adding-attachment"),_==="edit"&&r.viewModel.activeWorkflow.go("editing-attachment")})],this.id)},async tearDown(o){o.canceled&&r.viewModel.sketchViewModel.layer.removeAll(),i.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-new-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}})});return pCe(r,n)}};u([d()],cv.prototype,"shouldShowAttachments",null),u([d()],cv.prototype,"shouldAllowAttachmentEditing",null),u([d()],cv.prototype,"hasPendingEdits",null),u([d()],cv.prototype,"helpMessage",null),u([d()],cv.prototype,"reliesOnOwnerAdminPrivileges",null),cv=JW=u([R("esri.widgets.Editor.CreateWorkflow")],cv);const hrt=cv;function _Ce(t){return t&&typeof t.highlight=="function"}function drt(t){return t&&typeof t.maskOccludee=="function"}function UUt(t,e,r){return t==null||t>r&&(e===0||t<e)}function VUt(t,e){return t!=null&&t>0||e!=null&&e>0}function zUt(t){const e=t.effectiveScaleRange;return{minScale:e?.minScale??0,maxScale:e?.maxScale??0}}var w4;let uv=w4=class extends me{constructor(t){super(t),this.attachmentsCapabilities=null,this.editableItem=null,this.edits=null,this.formTemplate=null,this.viewModel=null}static async create(t){const e=w4._makeConstructorProps(t);return new w4(e)}static _makeConstructorProps(t){const{feature:e,viewModel:r}=t,i=r.editableItems.find(l=>l.layer===e.layer);if(!i)throw new D("no-editableItem-found","The EditorViewModel provided did not have an EditableItem associated with the specified Graphic's layer");const s=Uee(r.layerInfos,e.sourceLayer),n=i.supports,o=n.includes("create"),a=n.includes("update");return{attachmentsCapabilities:{editing:!0,operations:{add:o||a,update:a,delete:a}},editableItem:i,edits:new Vy({feature:e}),formTemplate:s?.formTemplate,viewModel:r}}};u([d()],uv.prototype,"attachmentsCapabilities",void 0),u([d()],uv.prototype,"editableItem",void 0),u([d()],uv.prototype,"edits",void 0),u([d()],uv.prototype,"formTemplate",void 0),u([d()],uv.prototype,"viewModel",void 0),uv=w4=u([R("esri.widgets.Editor.UpdateRecordWorkflowData")],uv);const vCe=uv;var x4;let T4=x4=class extends vCe{constructor(t){super(t)}static async create(t){const{feature:e,viewModel:r}=t,{view:i}=r;if(!i)throw new D("editor:cannot-create-workflow-data","The provided EditorViewModel does not have an associated view");const s=await oP(i,e.layer);return new x4({...x4._makeConstructorProps(t),layerView:s})}};u([d()],T4.prototype,"layerView",void 0),T4=x4=u([R("esri.widgets.Editor.UpdateFeatureWorkflowData")],T4);const prt=T4;var QW;const S4={exit:Symbol()},frt="esri.widgets.Editor.UpdateRecordWorkflow";let ad=QW=class extends UV{constructor(t){super(t),this.fullFeature=null,this.type="update-table-record"}async initialize(){const{data:t}=this,{edits:e}=t,r=e.feature,i=new AbortController;this.addHandles(e6e(i)),this.updatingHandles.addPromise(Ytt(r,t.viewModel.view.spatialReference,i.signal).then(s=>{dn(i)||this._onFullFeatureLoaded(s)},s=>this.cancel({force:!0,error:new D("editor:failed-to-fetch-full-feature","Failed to retrieve all information for this feature. The update cannot proceed.",{detail:{error:s}})})))}get editableItem(){return this.data.editableItem}get hasPendingEdits(){return this.data.edits.modified}get shouldShowAttachments(){return this.editableItem.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return this.editableItem.supports.includes("update")}get updating(){return this.updatingHandles.updating}get reliesOnOwnerAdminPrivileges(){const{layer:t}=this.editableItem,e=t.capabilities?.operations.supportsUpdate,r=vg(t)?.operations.supportsUpdate;return oV(t)&&!t.editingEnabled||!!r&&!e}async deleteAndCommit(){return this.data.edits.stageDelete(),this.commit()}async enter(){this._configureAttachmentsViewModel(),this._configureFeatureFormViewModel()}exit(t){this.removeHandles(S4.exit)}_configureAttachmentsViewModel(){const{data:t,fullFeature:e}=this,{attachmentsCapabilities:r,viewModel:i}=t,{attachmentsViewModel:s}=i;s.set({capabilities:r,graphic:e,filesEnabled:!1,mode:"view"}),this.addHandles(Q(()=>s.mode,n=>{switch(n){case"add":this.go("adding-attachment");break;case"edit":this.go("editing-attachment")}}),S4.exit)}_configureFeatureFormViewModel(){const{edits:t,formTemplate:e,viewModel:{featureFormViewModel:r,view:i}}=this.data;r.set({arcadeEditType:"UPDATE",feature:this.fullFeature,formTemplate:e,map:i?.map,spatialReference:i.spatialReference}),this.addHandles(r.on("value-change",()=>{t.updateAttributes(r.getValues()),this.fullFeature.attributes=t.feature.attributes}),S4.exit)}_onFullFeatureLoaded(t){this.fullFeature=t;const{edits:e}=this.data;e.updateAttributes(t.attributes),e.trackChanges()}static async create(t){const e=new QW({data:await vCe.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}static _createWorkflowSteps(t){const{attachmentsViewModel:e}=t.data.viewModel;return[{id:"editing-attributes",async setUp(){},async tearDown(){}},{id:"adding-attachment",async setUp(){},async tearDown(){e.mode="view"}},{id:"editing-attachment",async setUp(){},async tearDown(){e.mode="view"}}]}};ad._onCommitFactory=t=>async e=>{const{edits:r}=e,{feature:i}=r;if(!i)return;const s=i.sourceLayer,n=i.clone();if(!r.attributesModified||r.stagedForDelete){const a=s.objectIdField;if(n.attributes={[a]:i.getAttribute(a)},QI()&&qK()&&s.type==="scene"&&s.infoFor3D!=null){const l=s.associatedLayer?.globalIdField;l!=null&&n.setAttribute(l,i.getAttribute(l))}}r.geometryModified&&!r.stagedForDelete||(n.geometry=null);const o=r.stagedForDelete?"deleteFeatures":"updateFeatures";await t(s,{[o]:[n]})},u([d()],ad.prototype,"editableItem",null),u([d()],ad.prototype,"fullFeature",void 0),u([d()],ad.prototype,"hasPendingEdits",null),u([d()],ad.prototype,"shouldShowAttachments",null),u([d()],ad.prototype,"shouldAllowAttachmentEditing",null),u([d()],ad.prototype,"updating",null),u([d()],ad.prototype,"reliesOnOwnerAdminPrivileges",null),ad=QW=u([R(frt)],ad);var KW;const Xf={...S4,highlights:Symbol(),interactiveGraphics:Symbol(),geometryGraphics:Symbol()};let E4=KW=class extends ad{constructor(t){super(t),this.type="update-feature",this._layerViewEditSession=null,this._webStyleCache=new Map}async initialize(){const{edits:{feature:t},layerView:e}=this.data;nrt(e)&&(this._layerViewEditSession=e.createInteractiveEditSession(t))}destroy(){this._layerViewEditSession?.rollback()}async commit(){this.removeHandles(Xf.interactiveGraphics);try{const t=this.data.edits.stagedForDelete;await super.commit(),this.removeHandles(Xf.geometryGraphics);const e=this._layerViewEditSession;t?e?.rollback():e?.commit()}catch(t){throw this.removeHandles(Xf.geometryGraphics),await this._configureSketchViewModel(),new D("editor-workflow:failed-to-commit","An error occurred when sending the updates to the service",{error:t})}}async enter(){await super.enter(),this.data.editableItem.geometryUpdatesEnabled?this.hasHandles(Xf.interactiveGraphics)||await this._configureSketchViewModel():this._configureHighlight()}exit(t={removeSketchHandles:!0}){super.exit(t),t.removeSketchHandles&&this.removeHandles([Xf.geometryGraphics,Xf.interactiveGraphics])}_configureFeatureFormViewModel(){super._configureFeatureFormViewModel();const{_layerViewEditSession:t}=this,{viewModel:e}=this.data;this.addHandles(e.featureFormViewModel.on("value-change",r=>{t?.setAttribute(r.fieldName,r.value)}),Xf.exit)}_configureHighlight(){const{edits:t,layerView:e}=this.data;_Ce(e)&&this.addHandles(e.highlight(t.feature),Xf.highlights)}async _configureSketchViewModel(){const{data:t,_layerViewEditSession:e}=this,{edits:r,viewModel:i}=t,s=r.feature,{featureFormViewModel:n,sketchViewModel:o,view:a}=i;o.allowDeleteKey=!1;const l=kV(s),{interactive:c,visual:h}=await Ktt(s,l,o,a,({geometry:p,attributes:f},m)=>{if(r.updateAttributes(f),r.updateGeometry(p),n.feature.geometry=p,l.rotation!=null){const{field:_}=l.rotation;n.setValue(_,f[_])}if(l.size!=null){const{field:_}=l.size;n.setValue(_,f[_])}const{sourceLayer:g}=s;g!=null&&g.type==="scene"&&g.infoFor3D!=null&&QI()&&qK()&&e&&p!=null&&p.type==="mesh"&&e.setGeometry(p),(m.type==="undo"||m.type==="redo"||m.type==="update"&&m.toolEventInfo!=null&&gCe(m.toolEventInfo.type))&&n.notifyFeatureGeometryChanged()},this._webStyleCache);this.addHandles(c,Xf.interactiveGraphics),this.addHandles(h,Xf.geometryGraphics)}_onFullFeatureLoaded(t){super._onFullFeatureLoaded(t);const{edits:e}=this.data;e.updateGeometry(t.geometry),e.trackChanges()}static async create(t){const e=new KW({data:await prt.create(t),onCommit:this._onCommitFactory(t.applyEdits)});return e._set("steps",this._createWorkflowSteps(e)),e}};u([d()],E4.prototype,"_layerViewEditSession",void 0),E4=KW=u([R("esri.widgets.Editor.UpdateFeatureWorkflow")],E4);let hv=class extends me{constructor(e){super(e),this.addAttachmentsCallback=null,this.applyEditsCallback=null,this.candidates=null,this.rootFeature=null,this.viewModel=null}};u([d()],hv.prototype,"addAttachmentsCallback",void 0),u([d()],hv.prototype,"applyEditsCallback",void 0),u([d()],hv.prototype,"candidates",void 0),u([d()],hv.prototype,"rootFeature",void 0),u([d()],hv.prototype,"viewModel",void 0),hv=u([R("esri.widgets.Editor.UpdateWorkflowData")],hv);const mrt=hv;var eZ;const Qle="candidate-highlight",bCe="esri.widgets.Editor.UpdateWorkflow",grt=K.getLogger(bCe);let Xc=eZ=class extends UV{constructor(t){super(t),this._workflowStack=new Mk(e=>{let r;for(r of e);return r}),this.type="update"}get activeEditableItem(){const{activeWorkflow:t}=this;return Kle(t)?t.data.editableItem:void 0}get activeWorkflow(){return this._workflowStack.last()}get nestedWorkflowCount(){return this._workflowStack.length}get shouldShowAttachments(){return!!this.activeEditableItem?.attachmentsOnUpdateEnabled}get shouldAllowAttachmentEditing(){return!!this.activeEditableItem?.supports.includes("update")}get hasPendingEdits(){return Array.from(this._workflowStack).some(t=>t.hasPendingEdits)}get helpMessage(){return this.stepId==="awaiting-feature-to-update"?"select":void 0}get reliesOnOwnerAdminPrivileges(){return this.activeWorkflow?.reliesOnOwnerAdminPrivileges??!1}get hasInvalidFormTemplate(){return!!this.activeEditableItem?.hasInvalidFormTemplate}get hasUnsupportedFields(){return!!this.activeEditableItem?.hasUnsupportedFields}get updating(){return this.updatingHandles.updating}async back(t=()=>Promise.resolve(!0)){const{featureFormViewModel:e}=this.data.viewModel;if(e.relationshipId==null)if(this.activeWorkflow){if(this.activeWorkflow.hasPendingEdits&&!await t())return;this.activeWorkflow.hasPreviousStep?await this.activeWorkflow.previous({cancelCurrentStep:!0}):await this.cancelActiveWorkflow({force:!0})}else this.hasPreviousStep?await this.previous({cancelCurrentStep:!0}):await this.cancel({force:!0});else e.relationshipId=null}async cancelActiveWorkflow(t){await this.activeWorkflow?.cancel(t),await this._popWorkflow()}async commit(){await this._drainWorkflowStack(t=>t.commit()),await super.commit()}static create(t,e,r){const i=new eZ({data:new mrt({applyEditsCallback:r,viewModel:t}),onCommit:async()=>{}});return i._set("steps",this._createWorkflowSteps(i,e)),i}async save(){this.nestedWorkflowCount>1?(await this.activeWorkflow?.commit(),await this._popWorkflow()):await this.commit()}async startCreatingRelatedRecord(t){try{const e=await this._createNestedCreateFeaturesWorkflow(t);await this._pushWorkflow(e)}catch(e){throw new D("editor:unable-to-start-creating","Could not begin updating the provided feature or table record.",{error:e})}}async startUpdating(t){try{const e=await this._createNestedUpdateWorkflow(t);await this._pushWorkflow(e)}catch(e){throw new D("editor:unable-to-start-updating","Could not begin updating the provided feature or table record.",{error:e})}}async deleteActiveFeature(){const{activeWorkflow:t}=this;if(!t)throw new D("editor:nothing-to-delete","There is no feature to delete");Kle(t)?await t.deleteAndCommit():await t.cancel(),this.nestedWorkflowCount===1?await this.reset():await this._popWorkflow()}async cancelAll(){await this._drainWorkflowStack(t=>t.cancel({force:!0}))}async _createNestedCreateFeaturesWorkflow(t){const{relatedLayer:e}=t,{addAttachmentsCallback:r,applyEditsCallback:i,viewModel:s}=this.data;if(!uV(e))throw new D("editor:unsupported-layer","Editing is not supported on the provided layer");const n=new oa({sourceLayer:e,attributes:this._makeRelatedRecordAttributes(t)});return yCe.create({addAttachmentsCallback:r,applyEditsCallback:i,creationInfo:{layer:e,initialFeature:n,maxFeatures:1},startAt:"creating-features",viewModel:s})}async _createNestedUpdateWorkflow(t){const e=uA(t.sourceLayer)?ad:E4,{applyEditsCallback:r,viewModel:i}=this.data,s=await e.create({feature:t,viewModel:i,applyEdits:r});return await Pn(()=>!s.updating),s}async _drainWorkflowStack(t){const e=this._workflowStack,r=[];for(;e.length>0;){const i=e.pop(),s=t(i).then(()=>i.destroy());this.updatingHandles.addPromise(s),r.push(s)}await Promise.all(r)}_highlight(t){this._removeHighlight();const e=this.data.viewModel.view;if(!e||!t)return;const r=t&&e.allLayerViews.items.find(({layer:i})=>i===t.layer||t.layer?.type==="subtype-sublayer"&&t.layer?.parent===i);_Ce(r)&&this.handles.add(r.highlight(t),Qle)}_makeRelatedRecordAttributes(t){const{parentFeature:e,relatedLayer:r,relationshipId:i}=t;if(!LHe(e))return;const s=r.relationships?.find(l=>l.id===i);if(!s)return void QO("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the destination layer.");if(s.role==="origin")return void QO("unsupported-role","Creating new related records in the 'origin' table of a relationship is not yet supported");const n=e.sourceLayer;s.relatedTableId!==n.layerId&&QO("invalid-argument-combination","The given parent feature does not belong to the relationship designated by the given relationship ID.");const o=n.relationships?.find(l=>l.id===i);if(!o)return void QO("relationship-not-found","Could not begin creating a related record because the relationship specified could not be found on the origin layer.");const a=e.getAttribute(o.keyField);return a||QO("no-key-on-origin-feature","The given parent feature does not have a value for the relationship's origin primary key field."),{[s.keyField]:a}}async _popWorkflow(){this._workflowStack.pop()?.destroy();const t=await this._reconcileWorkflowStack();if(t.failureCount>0)throw new D("editor:next-workflow-failed","Popped the top workflow, but the next workflow in the stack failed to activate",t)}async _pushWorkflow(t){const e=this._workflowRequiresSketchViewModel(t);this.activeWorkflow?.exit({removeSketchHandles:e}),await t.start(),this._workflowStack.push(t);const r=await this._reconcileWorkflowStack();if(r.failureCount>0)throw new D("editor:failed-to-start-updating-feature","Failed to enter the provided workflow.",r)}async _reconcileWorkflowStack(){const t=this._workflowStack;try{const e=t.peek();return await e?.enter(),{activeWorkflow:e,failureCount:0}}catch{t.pop().destroy();const{activeWorkflow:r,failureCount:i}=await this._reconcileWorkflowStack();return{activeWorkflow:r,failureCount:i+1}}}_removeHighlight(){this.handles.remove(Qle)}_workflowRequiresSketchViewModel(t){const{type:e}=t;return e==="update-features"||e==="create-features"&&!uA(t.data.creationInfo?.layer)}static _createWorkflowSteps(t,e="awaiting-feature-to-update"){const{data:r,handles:i}=t;return zee(["awaiting-feature-to-update","awaiting-update-feature-candidate","editing-existing-feature","adding-attachment","editing-attachment"],e,{"awaiting-feature-to-update":()=>({id:"awaiting-feature-to-update",async setUp(){const{spinnerViewModel:s}=r.viewModel,n=r.viewModel.view;let o=null;i.add(Zr(()=>{o=Do(o)}),this.id),r.rootFeature=null,r.candidates=[];const a=n.on("immediate-click",async l=>{s.location=l.mapPoint,s.visible=!0,o?.abort();const{editableItems:c}=r.viewModel;o=new AbortController;const h=await new Promise((p,f)=>{xn(o?.signal,()=>f(Tr())),p(Xtt(c,n,l,o?.signal))});Dt(o),r.candidates=h.reduce((p,f)=>f.error?p:[...p,...f.value],[]),s.visible=r.candidates.length===1,r.candidates.length!==0&&(r.candidates.length===1?(r.rootFeature=r.candidates[0],t.go("editing-existing-feature").catch(()=>{}).then(()=>s.visible=!1)):t.next())});n.focus(),i.add(a,this.id)},async tearDown(){i.remove(this.id)}}),"awaiting-update-feature-candidate":()=>({id:"awaiting-update-feature-candidate",async setUp(){r.rootFeature=null,i.add([Q(()=>r.rootFeature,s=>t._highlight(s),Rr),Zr(()=>t._removeHighlight())],this.id)},async tearDown(){i.remove(this.id)}}),"editing-existing-feature":()=>({id:"editing-existing-feature",async setUp(){const{rootFeature:s,viewModel:n}=t.data;if(!s)throw new D("editor:no-feature-specified","Cannot setup the 'updating-existing-feature' step until the root feature is defined");await t.startUpdating(s),n.spinnerViewModel.visible=!1;const o=x1(async()=>{await Pn(()=>!t.updating),t.previous()}),{featureFormViewModel:a}=r.viewModel,l=a.relatedRecordCallbacks;a.relatedRecordCallbacks={addRelatedRecord:async c=>{await t.startCreatingRelatedRecord(c),a.relationshipId=null},editRelatedRecord:async({relatedFeature:c})=>{await t.startUpdating(c),a.relationshipId=null},showAllRelatedRecords:c=>a.relationshipId=c.relationshipId},i.add([Zr(()=>a.relatedRecordCallbacks=l),Q(()=>t.nestedWorkflowCount,(c,h)=>{c===0&&h!==0&&o()},Rr)],this.id)},async tearDown(){await t.cancelAll(),i.remove(this.id)}}),"adding-attachment":()=>({id:"adding-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}}),"editing-attachment":()=>({id:"editing-attachment",parent:"editing-existing-feature",async setUp(){},async tearDown(){r.viewModel.attachmentsViewModel.mode="view"}})})}};u([d()],Xc.prototype,"activeEditableItem",null),u([d()],Xc.prototype,"activeWorkflow",null),u([d()],Xc.prototype,"nestedWorkflowCount",null),u([d()],Xc.prototype,"shouldShowAttachments",null),u([d()],Xc.prototype,"shouldAllowAttachmentEditing",null),u([d()],Xc.prototype,"hasPendingEdits",null),u([d()],Xc.prototype,"helpMessage",null),u([d()],Xc.prototype,"reliesOnOwnerAdminPrivileges",null),u([d()],Xc.prototype,"hasInvalidFormTemplate",null),u([d()],Xc.prototype,"hasUnsupportedFields",null),u([d()],Xc.prototype,"updating",null),Xc=eZ=u([R(bCe)],Xc);const QO=(t,e)=>grt.warn(`editor:${t}`,e,"The create operation will be allowed to proceed, but the resulting feature may not be related to the given parent feature."),Kle=t=>!!t&&/update-/.test(t.type),yrt=Xc;function wz(t){switch(t){case Zi.SUPPORTED:break;case Zi.GRAPHICS_LAYER_MISSING:return"not owned by a graphics layer";case Zi.GEOMETRY_MISSING:return"no geometry";case Zi.GEOMETRY_TYPE_UNSUPPORTED:return"the geometry type is not supported";case Zi.ELEVATION_MODE_UNSUPPORTED:return"the elevation mode is not supported";case Zi.SYMBOL_TYPE_UNSUPPORTED:return"the symbol type is not supported"}return""}var Zi;(function(t){t[t.SUPPORTED=0]="SUPPORTED",t[t.GRAPHICS_LAYER_MISSING=1]="GRAPHICS_LAYER_MISSING",t[t.GEOMETRY_MISSING=2]="GEOMETRY_MISSING",t[t.GEOMETRY_TYPE_UNSUPPORTED=3]="GEOMETRY_TYPE_UNSUPPORTED",t[t.ELEVATION_MODE_UNSUPPORTED=4]="ELEVATION_MODE_UNSUPPORTED",t[t.SYMBOL_TYPE_UNSUPPORTED=5]="SYMBOL_TYPE_UNSUPPORTED"})(Zi||(Zi={}));function wCe(t){return t?no:Trt}function _rt(t,e){return e!=null&&e.mode?e.mode:wCe(t).mode}function vrt(t,e){return e??wCe(t)}function xCe(t,e){return _rt(t!=null&&t.hasZ,e)}function GUt(t,e){return vrt(t!=null&&!!t.hasZ,e)}function VV(t){const e=Gee(t);return xCe(t.geometry,e)}function jUt(t){const e=Gee(t),r=xCe(t.geometry,e);return{mode:r,offset:e!=null&&r!=="on-the-ground"?(e.offset??0)*e2e(e.unit??"meters"):0}}function Bee(t){if(VV(t)==="on-the-ground")return!1;const e=Gee(t),r=e!=null&&e.featureExpressionInfo?e.featureExpressionInfo.expression:null;return!(!r||r==="0")}function Gee(t){return t.layer&&"elevationInfo"in t.layer?t.layer.elevationInfo:null}function HUt(t,e,r){if(r==null||!r.mode)return;const i=t.hasZ?t.z:0,s=r.offset!=null?r.offset:0;switch(r.mode){case"absolute-height":return i-s;case"on-the-ground":return 0;case"relative-to-ground":return i-((e.elevationProvider.getElevation(t.x,t.y,i,t.spatialReference,"ground")??0)+s);case"relative-to-scene":return i-((e.elevationProvider.getElevation(t.x,t.y,i,t.spatialReference,"scene")??0)+s)}}function brt(t,e,r,i=null){return SCe(t,e.x,e.y,e.hasZ?e.z:0,e.spatialReference,r,i)}function TCe(t,e,r,i,s=null){return SCe(t,e[0],e[1],e.length>2?e[2]:0,r,i,s)}function SCe(t,e,r,i,s,n,o=null){if(n==null)return;const a=o!=null?o.mode:"absolute-height";if(a==="on-the-ground")return 0;const{absoluteZ:l}=wrt(e,r,i,s,t,n);return xrt(l,e,r,i,s,t,o,a)}function wrt(t,e,r,i,s,n){const o=n.offset!=null?n.offset:0;switch(n.mode){case"absolute-height":return{absoluteZ:r+o,elevation:0};case"on-the-ground":{const a=s.elevationProvider.getElevation(t,e,0,i,"ground")??0;return{absoluteZ:a,elevation:a}}case"relative-to-ground":{const a=s.elevationProvider.getElevation(t,e,r,i,"ground")??0;return{absoluteZ:r+a+o,elevation:a}}case"relative-to-scene":{const a=s.elevationProvider.getElevation(t,e,r,i,"scene")??0;return{absoluteZ:r+a+o,elevation:a}}}}function xrt(t,e,r,i,s,n,o,a){const l=o!=null&&o.offset!=null?o.offset:0;switch(a){case"absolute-height":return t-l;case"relative-to-ground":return t-((n.elevationProvider.getElevation(e,r,i,s,"ground")??0)+l);case"relative-to-scene":return t-((n.elevationProvider.getElevation(e,r,i,s,"scene")??0)+l)}}function qUt(t,e){if(e==null)return!1;const{mode:r}=e;return r!=null&&(t==="scene"&&r==="relative-to-scene"||t==="ground"&&r!=="absolute-height")}const no={mode:"absolute-height",offset:0},Trt={mode:"on-the-ground",offset:null};function Srt(t){if(t.layer?.type!=="graphics")return Zi.GRAPHICS_LAYER_MISSING;if(t.geometry==null)return Zi.GEOMETRY_MISSING;switch(t.geometry.type){case"polygon":case"point":case"polyline":case"mesh":break;default:return Zi.GEOMETRY_TYPE_UNSUPPORTED}return VV(t)!=="on-the-ground"&&Bee(t)?Zi.ELEVATION_MODE_UNSUPPORTED:Zi.SUPPORTED}function ECe(t){if(!t)return null;if(fQ(t)&&t.wkid){const e=GJe[t.wkid];if(e)return e}if(t.wkt){const e=Ert(t.wkt);if(e)return e}return null}function Ert(t){const e=zJe.exec(t);if(!e||e.length!==2)return null;const r=e[1].split(",");if(!r||r.length<3)return null;const i=parseFloat(r[1]),s=parseFloat(r[2]);return isNaN(i)||isNaN(s)?null:{a:i,f:s===0?0:1/s}}function zV(t){const e=ECe(t??qe.WGS84);if(Crt(e))return e;const r=e.a*(1-e.f);return Object.assign(e,{b:r,eSq:1-(r/e.a)**2,radius:(2*e.a+r)/3,densificationRatio:1e4/((2*e.a+r)/3)})}function Crt(t){return t!=null&&"b"in t&&"eSq"in t&&"radius"in t}function jL(t,e,r){const{a:i,eSq:s}=zV(r),n=Math.sqrt(s),o=Math.sin(e[1]*uu),a=i*e[0]*uu;let l;return s>0?l=i*((1-s)*(o/(1-s*(o*o))-1/(2*n)*Math.log((1-n*o)/(1+n*o))))*.5:l=i*o,t[0]=a,t[1]=l,t}function jee(t){return ECe(t)!==null}function WUt(t,e="square-meters"){if(t.some(o=>!jee(o.spatialReference)))throw new D("geodesic-areas:invalid-spatial-reference","the input geometries spatial reference is not supported");const r=[];for(let o=0;o<t.length;o++){const a=t[o],l=a.spatialReference,{radius:c,densificationRatio:h}=zV(l),p=c*h;r.push(Art(a,p))}const i=[],s=[0,0],n=[0,0];for(let o=0;o<r.length;o++){const{rings:a,spatialReference:l}=r[o];let c=0;for(let h=0;h<a.length;h++){const p=a[h];jL(s,p[0],l),jL(n,p[p.length-1],l);let f=n[0]*s[1]-s[0]*n[1];for(let m=0;m<p.length-1;m++)jL(s,p[m+1],l),jL(n,p[m],l),f+=n[0]*s[1]-s[0]*n[1];c+=f}c=Ci(c,"square-meters",e),i.push(c/-2)}return i}function ZUt(t,e="meters"){if(!t)throw new D("geodesic-lengths:invalid-geometries","the input geometries type is not supported");if(t.some(i=>!jee(i.spatialReference)))throw new D("geodesic-lengths:invalid-spatial-reference","the input geometries spatial reference is not supported");const r=[];for(let i=0;i<t.length;i++){const s=t[i],{spatialReference:n}=s,o=s.type==="polyline"?s.paths:s.rings;let a=0;for(let l=0;l<o.length;l++){const c=o[l];let h=0;for(let p=1;p<c.length;p++){const f=c[p-1][0],m=c[p][0],g=c[p-1][1],_=c[p][1];if(g!==_||f!==m){const v=new CCe;ACe(v,[f,g],[m,_],n),h+=v.distance}}a+=h}a=Ci(a,"meters",e),r.push(a)}return r}function Art(t,e){if(t.type!=="polyline"&&t.type!=="polygon")throw new D("geodesic-densify:invalid-geometry","the input geometry is neither polyline nor polygon");const{spatialReference:r}=t;if(!jee(r))throw new D("geodesic-densify:invalid-spatial-reference","the input geometry spatial reference is not supported");const i=t.type==="polyline"?t.paths:t.rings,s=[],n=[0,0],o=new CCe;for(const a of i){const l=[];s.push(l),l.push([a[0][0],a[0][1]]);let c,h,p=a[0][0],f=a[0][1];for(let m=0;m<a.length-1;m++){if(c=a[m+1][0],h=a[m+1][1],p===c&&f===h)continue;const g=[p,f];ACe(o,[p,f],[c,h],r);const{azimuth:_,distance:v}=o,b=v/e;if(b>1){for(let x=1;x<=b-1;x++)C4(n,g,_,x*e,r),l.push(n.slice(0));C4(n,g,_,(v+Math.floor(b-1)*e)/2,r),l.push(n.slice(0))}C4(n,g,_,v,r),l.push(n.slice(0)),p=n[0],f=n[1]}}return t.type==="polyline"?new QP({paths:s,spatialReference:r}):new bc({rings:s,spatialReference:r})}let CCe=class{constructor(e=0,r=void 0,i=void 0){this.distance=e,this.azimuth=r,this.reverseAzimuth=i}};function C4(t,e,r,i,s){const n=e[0],o=e[1],a=n*uu,l=o*uu,c=(r??0)*uu,{a:h,b:p,f}=zV(s),m=Math.sin(c),g=Math.cos(c),_=(1-f)*Math.tan(l),v=1/Math.sqrt(1+_*_),b=_*v,x=Math.atan2(_,g),T=v*m,S=T*T,O=1-S,A=O*(h*h-p*p)/(p*p),M=1+A/16384*(4096+A*(A*(320-175*A)-768)),P=A/1024*(256+A*(A*(74-47*A)-128));let F,$,N,U,X=i/(p*M),Z=2*Math.PI;for(;Math.abs(X-Z)>1e-12;)N=Math.cos(2*x+X),F=Math.sin(X),$=Math.cos(X),U=P*F*(N+P/4*($*(2*N*N-1)-P/6*N*(4*F*F-3)*(4*N*N-3))),Z=X,X=i/(p*M)+U;const G=b*F-v*$*g,ee=Math.atan2(b*$+v*F*g,(1-f)*Math.sqrt(S+G*G)),I=Math.atan2(F*m,v*$-b*F*g),V=f/16*O*(4+f*(4-3*O)),z=ee/uu,H=(a+(I-(1-V)*f*T*(X+V*F*(N+V*$*(2*N*N-1)))))/uu;return t[0]=H,t[1]=z,t}function ACe(t,e,r,i){const s=e[0]*uu,n=e[1]*uu,o=r[0]*uu,a=r[1]*uu,{a:l,b:c,f:h,radius:p}=zV(i),f=o-s,m=Math.atan((1-h)*Math.tan(n)),g=Math.atan((1-h)*Math.tan(a)),_=Math.sin(m),v=Math.cos(m),b=Math.sin(g),x=Math.cos(g);let T,S,O,A,M,P,F,$,N,U,X=1e3,Z=f;do{if(F=Math.sin(Z),$=Math.cos(Z),O=Math.sqrt(x*F*(x*F)+(v*b-_*x*$)*(v*b-_*x*$)),O===0)return t.distance=0,t.azimuth=void 0,t.reverseAzimuth=void 0,t;M=_*b+v*x*$,P=Math.atan2(O,M),N=v*x*F/O,S=1-N*N,A=M-2*_*b/S,isNaN(A)&&(A=0),U=h/16*S*(4+h*(4-3*S)),T=Z,Z=f+(1-U)*h*N*(P+U*O*(A+U*M*(2*A*A-1)))}while(Math.abs(Z-T)>1e-12&&--X>0);if(X===0){const H=p,Y=Math.acos(Math.sin(n)*Math.sin(a)+Math.cos(n)*Math.cos(a)*Math.cos(o-s))*H,te=o-s,ne=Math.sin(te)*Math.cos(a),ve=Math.cos(n)*Math.sin(a)-Math.sin(n)*Math.cos(a)*Math.cos(te),Fe=Math.atan2(ne,ve);return t.azimuth=Fe/uu,t.distance=Y,t.reverseAzimuth=void 0,t}const G=S*(l*l-c*c)/(c*c),ee=G/1024*(256+G*(G*(74-47*G)-128)),I=c*(1+G/16384*(4096+G*(G*(320-175*G)-768)))*(P-ee*O*(A+ee/4*(M*(2*A*A-1)-ee/6*A*(4*O*O-3)*(4*A*A-3)))),V=Math.atan2(x*Math.sin(Z),v*b-_*x*Math.cos(Z)),z=Math.atan2(v*Math.sin(Z),v*b*Math.cos(Z)-_*x);return t.azimuth=V/uu,t.distance=I,t.reverseAzimuth=z/uu,t}var tZ;let dv=tZ=class extends bc{constructor(...t){super(...t),this.center=null,this.geodesic=!1,this.numberOfPoints=60,this.radius=1e3,this.radiusUnit="meters"}normalizeCtorArgs(t,e){let r;if(t&&t.center)r=t;else{if(t&&t.rings)return super.normalizeCtorArgs(t,e);r={center:t}}return{...super.normalizeCtorArgs(),...r,...e}}initialize(){const t=this.center,e=this.numberOfPoints;if(this.hasZ=t?.hasZ??!1,this.rings.length!==0||!t)return;const r=Ci(this.radius,this.radiusUnit,"meters"),i=t.spatialReference;let s,n="geographic";if(i.isWebMercator?n="webMercator":((i.wkid&&L[i.wkid])!=null||i.wkt&&i.wkt.indexOf("PROJCS")===0)&&(n="projected"),this.geodesic){let o;switch(n){case"webMercator":o=jE(t);break;case"projected":console.error("Creating a geodesic circle requires the center to be specified in web mercator or geographic coordinate system");break;case"geographic":o=t}s=this._createGeodesicCircle(o,r,e),n==="webMercator"&&(s=bC(s))}else{let o;n==="webMercator"||n==="projected"?o=r/this._convert2Meters(1,t.spatialReference):n==="geographic"&&(o=O1e(r,"meters",Ir(t.spatialReference).radius)),s=this._createPlanarCircle(t,o,e)}this.spatialReference=s.spatialReference,this.addRing(s.rings[0])}clone(){const{center:t,numberOfPoints:e,radius:r,radiusUnit:i,geodesic:s}=this;return new tZ({center:t?.clone(),numberOfPoints:e,radius:r,radiusUnit:i,geodesic:s})}_createGeodesicCircle(t,e,r){let i=0;const s=[];for(;i<360;){const n=[0,0],o=[t.x,t.y];C4(n,o,i,e),this.hasZ&&n.push(t.z),s.push(n),i+=360/r}return s.push(s[0]),new bc(s)}_createPlanarCircle(t,e,r){const i=[],s=2*Math.PI/r;for(let n=0;n<r;++n){const o=s*n,a=[t.x+Math.cos(-o)*e,t.y+Math.sin(-o)*e];this.hasZ&&a.push(t.z),i.push(a)}return i.push(i[0]),new bc({spatialReference:t.spatialReference,rings:[i]})}_convert2Meters(t,e){let r;if(e.wkid&&L[e.wkid]!=null)r=L.values[L[e.wkid]];else{const i=e.wkt,s=i.lastIndexOf(",")+1,n=i.lastIndexOf("]]");r=parseFloat(i.substring(s,n))}return t*r}};u([d({type:ht})],dv.prototype,"center",void 0),u([d()],dv.prototype,"geodesic",void 0),u([d()],dv.prototype,"numberOfPoints",void 0),u([d()],dv.prototype,"radius",void 0),u([d()],dv.prototype,"radiusUnit",void 0),dv=tZ=u([R("esri.geometry.Circle")],dv);const Ort=dv;function HL(t){return OCe(t).result}function YUt(t){return OCe(t).geometry}function OCe(t){if(t.layer?.type!=="graphics")return{result:Zi.GRAPHICS_LAYER_MISSING,geometry:null};const{geometry:e}=t;if(e==null)return{result:Zi.GEOMETRY_MISSING,geometry:null};if(VV(t)!=="on-the-ground"&&Bee(t))return{result:Zi.ELEVATION_MODE_UNSUPPORTED,geometry:null};const r=e.type;return r!=="point"&&r!=="mesh"&&r!=="polyline"&&(r!=="polygon"||t.geometry instanceof Ort)?{result:Zi.GEOMETRY_TYPE_UNSUPPORTED,geometry:null}:{result:Zi.SUPPORTED,geometry:e}}function Rrt(t){if(t.layer?.type!=="graphics")return Zi.GRAPHICS_LAYER_MISSING;if(t.geometry==null)return Zi.GEOMETRY_MISSING;switch(t.geometry.type){case"point":break;case"polygon":case"polyline":case"multipoint":case"extent":case"mesh":return Zi.SUPPORTED;default:return Zi.GEOMETRY_TYPE_UNSUPPORTED}const e=t.symbol!=null&&t.symbol.type==="point-3d"&&t.symbol.symbolLayers;return e&&e.length>0&&e.some(r=>r.type==="object")?VV(t)!=="on-the-ground"&&Bee(t)?Zi.ELEVATION_MODE_UNSUPPORTED:Zi.SUPPORTED:Zi.SYMBOL_TYPE_UNSUPPORTED}function ece(t,e,r){if(!e||!t||!t.map)return;const{map:i}=t,s=i.layers.find(n=>n===e);s||i.add(e,r),s&&r!=null&&i.layers.reorder(s,r)}function JUt(t,e){return t.allLayerViews.find(r=>{const i=r.layer;return i===e||"sublayers"in i&&i.sublayers!=null&&i.sublayers.includes(e)})}let M0=class{constructor(e,r){this._owner=r,this._properties={},this._afterDispatchHandle=null;for(const i in e){const s=e[i],n=new Uve(s,void 0,void 0,2,2);this._properties[i]={pool:n,acquired:[]}}this._afterDispatchHandle=Xve(()=>this._release())}destroy(){this._afterDispatchHandle&&(this._afterDispatchHandle.remove(),this._afterDispatchHandle=null);for(const e in this._properties){const r=this._properties[e];for(const i of r.acquired)ene(i)||r.pool.release(i);r.pool.destroy(),r.pool=null,r.acquired=null}this._properties=null,this._owner=null}get(e){const r=this._owner._get(e),i=this._properties[e];let s=i.pool.acquire();for(i.acquired.push(s);s===r;)i.acquired.push(s),s=i.pool.acquire();return s}_release(){for(const e in this._properties){const r=this._properties[e];let i=0;for(const s of r.acquired)ene(s)?r.acquired[i++]=s:r.pool.release(s);r.acquired.length=i}}};const Mrt=le("mac")?"Meta":"Ctrl",BV={8:"Backspace",9:"Tab",13:"Enter",27:"Escape",33:"PageUp",34:"PageDown",35:"End",36:"Home",37:"ArrowLeft",38:"ArrowUp",39:"ArrowRight",40:"ArrowDown",45:"Insert",46:"Delete"};for(let t=48;t<58;t++)BV[t]=String.fromCharCode(t);for(let t=1;t<25;t++)BV[111+t]=`F${t}`;for(let t=65;t<91;t++)BV[t]=[String.fromCharCode(t+32),String.fromCharCode(t)];function Irt(t){if(t.key!==void 0)return Zke(t);const e=BV[t.keyCode];return Array.isArray(e)?t.shiftKey?e[1]:e[0]:e}function Prt(t){switch(t){case"Ctrl":case"Alt":case"Shift":case"Meta":case"Primary":return!0}return!1}let $rt=class{constructor(e,r=[]){this.eventType=e,this.keyModifiers=r}matches(e){if(e.type!==this.eventType)return!1;if(this.keyModifiers.length===0)return!0;const r=e.modifiers;for(const i of this.keyModifiers)if(!r.has(i))return!1;return!0}};const tce=K.getLogger("esri.views.input.InputHandler");let ua=class{constructor(e){this._manager=null,this._incoming={},this._outgoing={},this._incomingEventMatches=null,this._incomingEventTypes=null,this._outgoingEventTypes=null,this._hasSideEffects=e}get incomingEventMatches(){if(!this._incomingEventMatches){this._incomingEventMatches=[];for(const e in this._incoming){const r=this._incoming[e];for(const i of r)this._incomingEventMatches.push(i.match)}}return this._incomingEventMatches}get incomingEventTypes(){return this._incomingEventTypes||(this._incomingEventTypes=this.incomingEventMatches.map(e=>e.eventType)),this._incomingEventTypes}get outgoingEventTypes(){return this._outgoingEventTypes||(this._outgoingEventTypes=Object.keys(this._outgoing)),this._outgoingEventTypes}get hasSideEffects(){return this._hasSideEffects}get hasPendingInputs(){return!1}onInstall(e){this._manager?tce.error("This InputHandler has already been registered with an InputManager"):(e.setEventCallback(r=>this._handleEvent(r)),e.setUninstallCallback(()=>this._onUninstall()),this._manager=e)}onUninstall(){}registerIncoming(e,r,i){let s;typeof r=="function"?(i=r,s=[]):s=r||[];const n=typeof e=="string"?new $rt(e,s):e,o=()=>{this._incomingEventTypes=null,this._incomingEventMatches=null},a=h=>{const p=this._incoming[h.match.eventType];if(p){const f=p.indexOf(h);p.splice(f,1),o(),this._manager&&this._manager.updateDependencies()}},l=new Lrt(n,i,{onPause:a,onRemove:a,onResume:h=>{const p=this._incoming[h.match.eventType];p&&!p.includes(h)&&(p.push(h),o(),this._manager&&this._manager.updateDependencies())}});let c=this._incoming[n.eventType];return c||(c=[],this._incoming[n.eventType]=c),c.push(l),o(),this._manager&&this._manager.updateDependencies(),l}registerOutgoing(e){if(this._outgoing[e])throw new Error("There is already a callback registered for this outgoing InputEvent: "+e);const r=new Drt(e,{onEmit:(i,s,n,o)=>{this._manager?.emit(i.eventType,s,n,o)},onRemove:i=>{delete this._outgoing[i.eventType],this._manager?.updateDependencies()}});return this._outgoing[e]=r,this._outgoingEventTypes=null,this._manager&&this._manager.updateDependencies(),r}startCapturingPointer(e){this._manager?.setPointerCapture(e,!0)}stopCapturingPointer(e){this._manager?.setPointerCapture(e,!1)}refreshHasPendingInputs(){this._manager?.refreshHasPendingInputs()}_onUninstall(){this._manager?(this.onUninstall(),this._manager=null):tce.error("This InputHandler is not registered with an InputManager")}_handleEvent(e){const r=this._incoming[e.type];if(r){for(const i of r)if(i.match.matches(e)&&(i.callback?.(e),e.shouldStopPropagation()))break}}},Lrt=class{constructor(e,r,i){this.match=e,this._callback=r,this._handler=i}pause(){this._handler.onPause(this)}resume(){this._handler.onResume(this)}remove(){this._handler.onRemove(this)}get callback(){return this._callback}},Drt=class{constructor(e,r){this.eventType=e,this._removed=!1,this._handler=r}emit(e,r,i){this._removed||this._handler.onEmit(this,e,r,i)}remove(){this._removed=!0,this._handler.onRemove(this)}},Nrt=class extends ua{constructor(e){super(!0),this._onChange=e,this._value="mouse",this._x=null,this._y=null,this.registerIncoming("pointer-move",r=>{this._update(r.data)})}_update(e){const r=e.native.pointerType==="touch"?"touch":"mouse",{x:i,y:s}=e;r===this._value&&this._x===i&&this._y===s||(this._value=r,this._x=i,this._y=s,this._onChange(r,i,s))}},Frt=class{constructor(e,r){this._observable=new X6,this._value=e,this._equalityFunction=r}get value(){return Jt(this._observable),this._value}set value(e){this._equalityFunction(e,this._value)||(this._value=e,this._observable.notify())}mutate(e){e(this._value),this._observable.notify()}};function aP(t,e=W0e){return new Frt(t,e)}let krt=class extends ua{get multiTouchActive(){return this._multiTouchActive.value}constructor(){super(!0),this._activeTouchPointerIds=new Set,this._multiTouchActive=aP(!1),this._onPointerAdd=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.add(e.native.pointerId),this._update())},this._onPointerRemove=({data:e})=>{e.pointerType==="touch"&&(this._activeTouchPointerIds.delete(e.native.pointerId),this._update())},this.registerIncoming("pointer-down",this._onPointerAdd),this.registerIncoming("pointer-up",this._onPointerRemove),this.registerIncoming("pointer-capture-lost",this._onPointerRemove),this.registerIncoming("pointer-cancel",this._onPointerRemove)}_update(){this._multiTouchActive.value=this._activeTouchPointerIds.size>1}},Jh=class extends me{constructor(e){super(e),this._pointerCaptures=new Map,this._nameToGroup={},this._handlers=[],this._handlersPriority=[],this._currentPropagation=null,this._updateDependenciesAfterPropagation=!1,this._sourceEvents=new Set,this._keyModifiers=new Set,this._activeKeyModifiers=new Set,this._stoppedPropagationEventIds=new Set,this.primaryKey=Mrt,this._latestPointerType="mouse",this._propertiesPool=new M0({latestPointerLocation:zrt},this),this.latestPointerLocation=null,this._paused=!1,this.test={timestamp:void 0,hasCurrentPropagation:()=>!!this._currentPropagation}}initialize(){this.eventSource.onEventReceived=this._onEventReceived.bind(this),this._installRecognizers()}destroy(){const e=Object.keys(this._nameToGroup);for(const r of e)this.uninstallHandlers(r);this.eventSource.destroy(),this._currentPropagation=null,this._propertiesPool.destroy()}get hasPendingInputs(){return this._handlers.some(e=>e.handler.hasPendingInputs)}get latestPointerType(){return this._latestPointerType}get multiTouchActive(){return this._multiTouchHandler.multiTouchActive}get updating(){return this.hasPendingInputs||this._paused}installHandlers(e,r,i=fs.INTERNAL){if(this._nameToGroup[e])return void K.getLogger(this).error("There is already an InputHandler group registered under the name `"+e+"`");if(r.length===0)return void K.getLogger(this).error("Can't register a group of zero handlers");const s={name:e,handlers:r.map(n=>({handler:n,active:!0,removed:!1,priorityIndex:0,groupPriority:i,eventCallback:null,uninstallCallback:null}))};this._nameToGroup[e]=s;for(let n=s.handlers.length-1;n>=0;n--){const o=s.handlers[n];this._handlers.push(o),o.handler.onInstall({updateDependencies:()=>{this.updateDependencies()},emit:(a,l,c,h,p)=>{this._emitInputEvent(o.priorityIndex+1,a,l,c,p,h)},setPointerCapture:(a,l)=>{this._setPointerCapture(s,o,a,l)},setEventCallback:a=>{o.eventCallback=a},setUninstallCallback:a=>{o.uninstallCallback=a},refreshHasPendingInputs:()=>{this.notifyChange("hasPendingInputs")}})}this.updateDependencies()}uninstallHandlers(e){const r=this._nameToGroup[e];r?(r.handlers.forEach(i=>{i.removed=!0,i.uninstallCallback?.()}),delete this._nameToGroup[e],this._currentPropagation?this._currentPropagation.needsHandlerGarbageCollect=!0:this._garbageCollectRemovedHandlers()):K.getLogger(this).error("There is no InputHandler group registered under the name `"+e+"`")}hasHandlers(e){return this._nameToGroup[e]!==void 0}updateDependencies(){if(this._currentPropagation)return void(this._updateDependenciesAfterPropagation=!0);this._updateDependenciesAfterPropagation=!1;const e=new Set,r=new Set;this._handlersPriority=[];for(let i=this._handlers.length-1;i>=0;i--){const s=this._handlers[i];s.priorityIndex=i,this._handlersPriority.push(s)}this._handlersPriority=this._sortHandlersPriority(this._handlersPriority);for(let i=this._handlersPriority.length-1;i>=0;i--){const s=this._handlersPriority[i];s.priorityIndex=i;let n=s.handler.hasSideEffects;if(!n){for(const o of s.handler.outgoingEventTypes)if(e.has(o)){n=!0;break}}if(n)for(const o of s.handler.incomingEventMatches){e.add(o.eventType);for(const a of o.keyModifiers)Prt(a)||r.add(a)}s.active=n}this._sourceEvents=e,this._keyModifiers=r,this._pointerCaptures.size>0&&this._sourceEvents.add("pointer-capture-lost"),this._keyModifiers.size>0&&(this._sourceEvents.add("key-down"),this._sourceEvents.add("key-up")),this.eventSource&&(this.eventSource.activeEvents=this._sourceEvents)}_setLatestPointer(e,r,i){this._latestPointerType=e;const s=this._get("latestPointerLocation");if(s==null||s.x!==r||s.y!==i){const n=this._propertiesPool.get("latestPointerLocation");n.x=r,n.y=i,this._set("latestPointerLocation",n)}}_onEventReceived(e,r){if(e==="pointer-capture-lost"){const n=r;this._pointerCaptures.delete(n.native.pointerId)}this._updateKeyModifiers(e,r);const i=this.test.timestamp!=null?this.test.timestamp:r.native?r.native.timestamp:void 0,s=r.native?r.native.cancelable:void 0;this._emitInputEventFromSource(e,r,i,s)}_updateKeyModifiers(e,r){if(!r)return;let i=!1;const s=()=>{if(!i){const a=new Set;this._activeKeyModifiers.forEach(l=>{a.add(l)}),this._activeKeyModifiers=a,i=!0}},n=(a,l)=>{l&&!this._activeKeyModifiers.has(a)?(s(),this._activeKeyModifiers.add(a)):!l&&this._activeKeyModifiers.has(a)&&(s(),this._activeKeyModifiers.delete(a))};if(e==="key-down"||e==="key-up"){const a=r.key;this._keyModifiers.has(a)&&n(a,e==="key-down")}const o=r.native;n("Alt",!(!o||!o.altKey)),n("Ctrl",!(!o||!o.ctrlKey)),n("Shift",!(!o||!o.shiftKey)),n("Meta",!(!o||!o.metaKey)),n("Primary",this._activeKeyModifiers.has(this.primaryKey))}_installRecognizers(){this._latestPointerHandler=new Nrt((e,r,i)=>this._setLatestPointer(e,r,i)),this._multiTouchHandler=new krt,this.installHandlers("input-manager-logic",[this._latestPointerHandler,this._multiTouchHandler],fs.ALWAYS),this.recognizers.length>0&&this.installHandlers("default",this.recognizers,fs.INTERNAL)}_setPointerCapture(e,r,i,s){const n=e.name+"-"+r.priorityIndex,o=this._pointerCaptures.get(i.pointerId)||new Set;this._pointerCaptures.set(i.pointerId,o),s?(o.add(n),o.size===1&&this.eventSource&&this.eventSource.setPointerCapture(i,!0)):o.has(n)&&(o.delete(n),o.size===0&&(this._pointerCaptures.delete(i.pointerId),this.eventSource&&this.eventSource.setPointerCapture(i,!1)))}_garbageCollectRemovedHandlers(){this._handlers=this._handlers.filter(e=>!e.removed),this.updateDependencies()}_emitInputEventFromSource(e,r,i,s){this._emitInputEvent(0,e,r,i,s)}_emitInputEvent(e,r,i,s,n,o){const a=s!==void 0?s:this._currentPropagation?this._currentPropagation.timestamp:performance.now(),l=n!==void 0&&n,c={event:new Urt(r,i,a,o||this._activeKeyModifiers,l),priorityIndex:e};this._currentPropagation?this._currentPropagation.events.push(c):this._doNewPropagation(c)}_doNewPropagation(e){this._currentPropagation={events:new Mk,currentHandler:null,needsHandlerGarbageCollect:!1,timestamp:e.event.timestamp},this._currentPropagation.events.push(e),this._continuePropagation()}_continuePropagation(){this._paused=!1;const e=this._currentPropagation;if(e){for(;e.events.length>0;){const{event:r,priorityIndex:i}=e.events.pop(),s=r.data&&r.data.eventId;if(!(s!=null&&this._stoppedPropagationEventIds.has(s)))for(e.currentHandler=this._handlersPriority[i];e.currentHandler;){if(e.currentHandler.removed)e.needsHandlerGarbageCollect=!0;else{if(e.currentHandler.active&&!r.shouldStopPropagation()&&e.currentHandler.eventCallback?.(r),r.shouldStopPropagation()){s!=null&&this._stoppedPropagationEventIds.add(s);break}if(r.shouldPausePropagation(()=>this._continuePropagation()))return void this._pausePropagation({event:r,priorityIndex:e.currentHandler.priorityIndex+1})}e.currentHandler=this._handlersPriority[e.currentHandler.priorityIndex+1]}}e.needsHandlerGarbageCollect&&this._garbageCollectRemovedHandlers(),this.hasPendingInputs||this._stoppedPropagationEventIds.clear(),this._currentPropagation=null,this._updateDependenciesAfterPropagation&&this.updateDependencies()}}_pausePropagation(e){const r=new Mk;r.push(e);const i=this._currentPropagation;if(i){for(;i.events.length;)r.push(i.events.pop());i.events=r,i.currentHandler=null,this._paused=!0}}_compareHandlerPriority(e,r){if(e.handler.hasSideEffects!==r.handler.hasSideEffects)return e.handler.hasSideEffects?1:-1;if(e.groupPriority!==r.groupPriority)return e.groupPriority>r.groupPriority?-1:1;for(const i of e.handler.incomingEventMatches)for(const s of r.handler.incomingEventMatches){if(i.eventType!==s.eventType)continue;const n=i.keyModifiers.filter(o=>s.keyModifiers.includes(o));if(n.length===i.keyModifiers.length!=(n.length===s.keyModifiers.length))return i.keyModifiers.length>s.keyModifiers.length?-1:1}return e.priorityIndex>r.priorityIndex?-1:1}_sortHandlersPriority(e){const r=[];for(const i of e){let s=0;for(;s<r.length&&this._compareHandlerPriority(i,r[s])>=0;)s++;r.splice(s,0,i)}return r}get debug(){const e=r=>{const i=this._setPointerCapture;this._setPointerCapture=()=>{},r(),this._setPointerCapture=i};return{injectEvent:(r,i)=>{e(()=>{this._onEventReceived(r,i)})},disablePointerCapture:e}}};u([d({readOnly:!0})],Jh.prototype,"hasPendingInputs",null),u([d({constructOnly:!0})],Jh.prototype,"eventSource",void 0),u([d({constructOnly:!0})],Jh.prototype,"recognizers",void 0),u([d()],Jh.prototype,"_latestPointerType",void 0),u([d()],Jh.prototype,"latestPointerType",null),u([d()],Jh.prototype,"multiTouchActive",null),u([d({readOnly:!0})],Jh.prototype,"latestPointerLocation",void 0),u([d()],Jh.prototype,"_paused",void 0),u([d({readOnly:!0})],Jh.prototype,"updating",null),Jh=u([R("esri.views.input.InputManager")],Jh);let Urt=class{constructor(e,r,i,s,n){this.type=e,this.data=r,this.timestamp=i,this.modifiers=s,this.cancelable=n,this._propagationState=Uv.NONE,this._resumeCallback=null}stopPropagation(){this._propagationState|=Uv.STOPPED}shouldStopPropagation(){return(this._propagationState&Uv.STOPPED)!=0}async(e){this._propagationState|=Uv.PAUSED;const r=(i,s)=>{this._propagationState&=~Uv.PAUSED;const n=this._resumeCallback;if(this._resumeCallback=null,n&&n(),s)throw i;return i};return(typeof e=="function"?e():e).then(i=>r(i,!1),i=>r(i,!0))}shouldPausePropagation(e){return!!(this._propagationState&Uv.PAUSED)&&(this._resumeCallback=e,!0)}preventDefault(){this.data.native.preventDefault()}};var Uv;(function(t){t[t.NONE=0]="NONE",t[t.STOPPED=1]="STOPPED",t[t.PAUSED=2]="PAUSED"})(Uv||(Uv={}));const fs={ALWAYS:1,DEFAULT:0,TOOL:-1,WIDGET:-2,INTERNAL:-3};let Vrt=class{};const zrt=Vrt,po={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},rce={toggle:"Control"};let A4=class extends me{constructor(e){super(e),this.enabled=!1}};u([d({type:Boolean,nonNullable:!0})],A4.prototype,"enabled",void 0),A4=u([R("esri.views.interactive.sketch.SketchLabelOptions")],A4);const RCe=A4;let tI=class extends me{constructor(e){super(e),this.mode="absolute-height"}toJSON(){return{mode:this.mode}}};u([d({type:String,nonNullable:!0})],tI.prototype,"mode",void 0),tI=u([R("esri.widgets.Sketch.SketchTooltipOptions.ElevationOptions")],tI);let Kc=class extends me{constructor(){super(...arguments),this.distance=!0,this.elevation=!0,this.size=!0,this.scale=!0,this.rotation=!0,this.orientation=!0,this.totalLength=!0,this.area=!0,this.radius=!0,this.helpMessage=!1}toJSON(){return{distance:this.distance,size:this.size,scale:this.scale,rotation:this.rotation,orientation:this.orientation,totalLength:this.totalLength,area:this.area,radius:this.radius}}};u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"distance",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"elevation",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"size",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"scale",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"rotation",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"orientation",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"totalLength",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"area",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"radius",void 0),u([d({type:Boolean,nonNullable:!0})],Kc.prototype,"helpMessage",void 0),Kc=u([R("esri.widgets.Sketch.SketchTooltipOptions.VisibleElements")],Kc);let Hw=class extends me{constructor(e){super(e),this.enabled=!1,this.elevation=new tI,this.visibleElements=new Kc,this.visualVariables=null}toJSON(){return{enabled:this.enabled,elevation:this.elevation,visibleElements:this.visibleElements}}};u([d({type:Boolean,nonNullable:!0})],Hw.prototype,"enabled",void 0),u([d({type:tI,nonNullable:!0})],Hw.prototype,"elevation",void 0),u([d({type:Kc,nonNullable:!0})],Hw.prototype,"visibleElements",void 0),u([d()],Hw.prototype,"visualVariables",void 0),Hw=u([R("esri.widgets.Sketch.SketchTooltipOptions")],Hw);const MCe=Hw;let df=class extends he{constructor(){super(...arguments),this.enabled=!0}};u([d({type:Boolean})],df.prototype,"enabled",void 0),df=u([R("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],df);let Ds=class extends he{constructor(e){super(e),this.lineSnapper=new df,this.parallelLineSnapper=new df,this.rightAngleSnapper=new df,this.rightAngleTriangleSnapper=new df,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new Le([255,127,0]),this.orangeTransparent=new Le([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};u([d({type:df,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Ds.prototype,"lineSnapper",void 0),u([d({type:df,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Ds.prototype,"parallelLineSnapper",void 0),u([d({type:df,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Ds.prototype,"rightAngleSnapper",void 0),u([d({type:df,constructOnly:!0,nonNullable:!0,json:{write:!0}})],Ds.prototype,"rightAngleTriangleSnapper",void 0),u([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],Ds.prototype,"shortLineThreshold",void 0),u([d({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],Ds.prototype,"distance",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Ds.prototype,"pointThreshold",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Ds.prototype,"intersectionParallelLineThreshold",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Ds.prototype,"parallelLineThreshold",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ds.prototype,"verticalLineThreshold",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Ds.prototype,"touchSensitivityMultiplier",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],Ds.prototype,"pointOnLineThreshold",void 0),u([d({type:Le,nonNullable:!0})],Ds.prototype,"orange",void 0),u([d({type:Le,nonNullable:!0})],Ds.prototype,"orangeTransparent",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Ds.prototype,"lineHintWidthReference",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Ds.prototype,"lineHintWidthTarget",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],Ds.prototype,"lineHintFadedExtensions",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],Ds.prototype,"parallelLineHintWidth",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],Ds.prototype,"parallelLineHintLength",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],Ds.prototype,"parallelLineHintOffset",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],Ds.prototype,"rightAngleHintSize",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],Ds.prototype,"rightAngleHintOutlineSize",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],Ds.prototype,"satisfiesConstraintScreenThreshold",void 0),Ds=u([R("esri.views.interactive.snapping.Settings.Defaults")],Ds);const h0=new Ds;var Oa;(function(t){t[t.FEATURE=1]="FEATURE",t[t.SELF=2]="SELF",t[t.ALL=3]="ALL"})(Oa||(Oa={}));function jn(t,e){return t[0]=e[0],t[1]=e[1],t}function hr(t,e,r){return t[0]=e,t[1]=r,t}function _d(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t}function zs(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t}function Hee(t,e,r){return t[0]=e[0]*r[0],t[1]=e[1]*r[1],t}function ICe(t,e,r){return t[0]=e[0]/r[0],t[1]=e[1]/r[1],t}function Brt(t,e){return t[0]=Math.ceil(e[0]),t[1]=Math.ceil(e[1]),t}function Grt(t,e){return t[0]=Math.floor(e[0]),t[1]=Math.floor(e[1]),t}function jrt(t,e,r){return t[0]=Math.min(e[0],r[0]),t[1]=Math.min(e[1],r[1]),t}function Hrt(t,e,r){return t[0]=Math.max(e[0],r[0]),t[1]=Math.max(e[1],r[1]),t}function qrt(t,e){return t[0]=Math.round(e[0]),t[1]=Math.round(e[1]),t}function fc(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t}function d0(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t}function I0(t,e){const r=e[0]-t[0],i=e[1]-t[1];return Math.sqrt(r*r+i*i)}function Lf(t,e){const r=e[0]-t[0],i=e[1]-t[1];return r*r+i*i}function b$(t){const e=t[0],r=t[1];return Math.sqrt(e*e+r*r)}function W1(t){const e=t[0],r=t[1];return e*e+r*r}function qee(t,e){return t[0]=-e[0],t[1]=-e[1],t}function PCe(t,e){return t[0]=1/e[0],t[1]=1/e[1],t}function yA(t,e){const r=e[0],i=e[1];let s=r*r+i*i;return s>0&&(s=1/Math.sqrt(s),t[0]=e[0]*s,t[1]=e[1]*s),t}function ms(t,e){return t[0]*e[0]+t[1]*e[1]}function Wrt(t,e,r){const i=e[0]*r[1]-e[1]*r[0];return t[0]=t[1]=0,t[2]=i,t}function ah(t,e,r,i){const s=e[0],n=e[1];return t[0]=s+i*(r[0]-s),t[1]=n+i*(r[1]-n),t}function Zrt(t,e){e=e||1;const r=2*XP()*Math.PI;return t[0]=Math.cos(r)*e,t[1]=Math.sin(r)*e,t}function $Ce(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s,t[1]=r[1]*i+r[3]*s,t}function qw(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[2]*s+r[4],t[1]=r[1]*i+r[3]*s+r[5],t}function Xrt(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[3]*s+r[6],t[1]=r[1]*i+r[4]*s+r[7],t}function Yrt(t,e,r){const i=e[0],s=e[1];return t[0]=r[0]*i+r[4]*s+r[12],t[1]=r[1]*i+r[5]*s+r[13],t}function Jrt(t,e,r,i){const s=e[0]-r[0],n=e[1]-r[1],o=Math.sin(i),a=Math.cos(i);return t[0]=s*a-n*o+r[0],t[1]=s*o+n*a+r[1],t}function Qrt(t,e){const r=t[0],i=t[1],s=e[0],n=e[1];let o=r*r+i*i;o>0&&(o=1/Math.sqrt(o));let a=s*s+n*n;a>0&&(a=1/Math.sqrt(a));const l=(r*s+i*n)*o*a;return l>1?0:l<-1?Math.PI:Math.acos(l)}function Krt(t){return"vec2("+t[0]+", "+t[1]+")"}function LCe(t,e){return t[0]===e[0]&&t[1]===e[1]}function DCe(t,e){const r=t[0],i=t[1],s=e[0],n=e[1],o=sl();return Math.abs(r-s)<=o*Math.max(1,Math.abs(r),Math.abs(s))&&Math.abs(i-n)<=o*Math.max(1,Math.abs(i),Math.abs(n))}function eit(t,e,r,i,s){let n=e[0]-r[0],o=e[1]-r[1];const a=(i[0]*n+i[1]*o)*(s-1);return n=i[0]*a,o=i[1]*a,t[0]=e[0]+n,t[1]=e[1]+o,t}const tit=b$,Wee=zs,rit=Hee,iit=ICe,NCe=I0,sit=Lf,nit=W1;Object.freeze(Object.defineProperty({__proto__:null,add:_d,angle:Qrt,ceil:Brt,copy:jn,cross:Wrt,dist:NCe,distance:I0,div:iit,divide:ICe,dot:ms,equals:DCe,exactEquals:LCe,floor:Grt,inverse:PCe,len:tit,length:b$,lerp:ah,max:Hrt,min:jrt,mul:rit,multiply:Hee,negate:qee,normalize:yA,projectAndScale:eit,random:Zrt,rotate:Jrt,round:qrt,scale:fc,scaleAndAdd:d0,set:hr,sqrDist:sit,sqrLen:nit,squaredDistance:Lf,squaredLength:W1,str:Krt,sub:Wee,subtract:zs,transformMat2:$Ce,transformMat2d:qw,transformMat3:Xrt,transformMat4:Yrt},Symbol.toStringTag,{value:"Module"}));function Pe(){return[0,0]}function QE(t){return[t[0],t[1]]}function yr(t,e){return[t,e]}function FCe(t){const e=Pe(),r=Math.min(2,t.length);for(let i=0;i<r;++i)e[i]=t[i];return e}function kCe(t,e){return new Float64Array(t,e,2)}function UCe(){return Pe()}function VCe(){return yr(1,1)}function zCe(){return yr(1,0)}function BCe(){return yr(0,1)}const Df=UCe(),oit=VCe(),GCe=zCe(),ait=BCe();Object.freeze(Object.defineProperty({__proto__:null,ONES:oit,UNIT_X:GCe,UNIT_Y:ait,ZEROS:Df,clone:QE,create:Pe,createView:kCe,fromArray:FCe,fromValues:yr,ones:VCe,unitX:zCe,unitY:BCe,zeros:UCe},Symbol.toStringTag,{value:"Module"}));function jCe(t){return 32+t.length}function HCe(t){return 16}function qCe(t){if(!t)return 0;let e=XCe;for(const r in t)if(t.hasOwnProperty(r)){const i=t[r];switch(typeof i){case"string":e+=jCe(i);break;case"number":e+=HCe();break;case"boolean":e+=4}}return e}function WCe(t){if(!t)return 0;if(Array.isArray(t))return lit(t);let e=XCe;for(const r in t)t.hasOwnProperty(r)&&(e+=ZCe(t[r]));return e}function lit(t){const e=t.length;if(e===0||typeof t[0]=="number")return 32+8*e;let r=YCe;for(let i=0;i<e;i++)r+=ZCe(t[i]);return r}function ZCe(t){switch(typeof t){case"object":return WCe(t);case"string":return jCe(t);case"number":return HCe();case"boolean":return 4;default:return 8}}function m6t(t,e){return YCe+t.length*e}const XCe=32,YCe=32,Zee=(t,e,r)=>[e,r],_A=(t,e,r)=>[e,r,t[2]],Xee=(t,e,r)=>[e,r,t[2],t[3]];function g6t(t){return t?{originPosition:t.originPosition==="upper-left"?"upperLeft":t.originPosition==="lower-left"?"lowerLeft":t.originPosition,scale:t.tolerance?[t.tolerance,t.tolerance]:[1,1],translate:t.extent!=null?[t.extent.xmin,t.extent.ymax]:[0,0]}:null}function cit({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function uit({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function JCe({scale:t,translate:e},r){return r*t[0]+e[0]}function QCe({scale:t,translate:e},r){return e[1]-r*t[1]}function KCe(t,e,r){const i=new Array(r.length);if(!r.length)return i;const[s,n]=t.scale;let o=JCe(t,r[0][0]),a=QCe(t,r[0][1]);i[0]=e(r[0],o,a);for(let l=1;l<r.length;l++){const c=r[l];o+=c[0]*s,a-=c[1]*n,i[l]=e(c,o,a)}return i}function eAe(t,e,r){const i=new Array(r.length);for(let s=0;s<r.length;s++)i[s]=KCe(t,e,r[s]);return i}function hit(t,e,r,i){return KCe(t,r?i?Xee:_A:i?_A:Zee,e)}function dit(t,e,r,i){return eAe(t,r?i?Xee:_A:i?_A:Zee,e)}function pit(t,e,r,i){return eAe(t,r?i?Xee:_A:i?_A:Zee,e)}function y6t(t,e,r,i,s){return e.x=cit(t,r.x),e.y=uit(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m)),e}function tAe(t,e,r,i,s){return r!=null&&(e.points=hit(t,r.points,i,s)),e}function rAe(t,e,r,i,s){return r==null||(e.x=JCe(t,r.x),e.y=QCe(t,r.y),e!==r&&(i&&(e.z=r.z),s&&(e.m=r.m))),e}function iAe(t,e,r,i,s){return r!=null&&(e.rings=pit(t,r.rings,i,s)),e}function sAe(t,e,r,i,s){return r!=null&&(e.paths=dit(t,r.paths,i,s)),e}let _6t=class{constructor(e,r,i){this.uid=e,this.geometry=r,this.attributes=i,this.visible=!0,this.objectId=null,this.centroid=null}};function b6t(t){return t.geometry!=null}let w6t=class{constructor(){this.exceededTransferLimit=!1,this.features=[],this.fields=[],this.hasM=!1,this.hasZ=!1,this.geometryType=null,this.objectIdFieldName=null,this.globalIdFieldName=null,this.geometryProperties=null,this.geohashFieldName=null,this.spatialReference=null,this.transform=null}};function T6t(t){const e=Sbe.fromJSON(t.geometryType),r=qe.fromJSON(t.spatialReference),i=t.transform,s=t.features.map(n=>{const o=fit(n,e,r,t.objectIdFieldName),a=o.geometry;if(a!=null&&i)switch(a.type){case"point":o.geometry=rAe(i,a,a,a.hasZ,a.hasM);break;case"multipoint":o.geometry=tAe(i,a,a,!!a.hasZ,!!a.hasM);break;case"polygon":o.geometry=iAe(i,a,a,!!a.hasZ,!!a.hasM);break;case"polyline":o.geometry=sAe(i,a,a,!!a.hasZ,!!a.hasM);break;case"extent":case"mesh":o.geometry=a}return o});return{geometryType:e,features:s,spatialReference:r,fields:t.fields?.map(n=>yV.fromJSON(n))??[],objectIdFieldName:t.objectIdFieldName,globalIdFieldName:t.globalIdFieldName,geohashFieldName:t.geohashFieldName,geometryProperties:t.geometryProperties,hasZ:t.hasZ,hasM:t.hasM,exceededTransferLimit:t.exceededTransferLimit,transform:null}}function fit(t,e,r,i){return{uid:vc(),objectId:i&&t.attributes?t.attributes[i]:null,attributes:t.attributes,geometry:mit(t.geometry,e,r),visible:!0}}function mit(t,e,r){if(t==null)return null;switch(e){case"point":{const i=t;return{x:i.x,y:i.y,z:i.z,m:i.m,hasZ:i.z!=null,hasM:i.m!=null,type:"point",spatialReference:r}}case"polyline":{const i=t;return{paths:i.paths,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polyline",spatialReference:r}}case"polygon":{const i=t;return{rings:i.rings,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"polygon",spatialReference:r}}case"multipoint":{const i=t;return{points:i.points,hasZ:!!i.hasZ,hasM:!!i.hasM,type:"multipoint",spatialReference:r}}}}function Su(t,e,r,i){return{x:t,y:e,z:r,hasZ:r!=null,hasM:!1,spatialReference:i,type:"point"}}function git(t){if(t==null)return 0;let e=32;switch(t.type){case"point":e+=42;break;case"polyline":case"polygon":{let r=0;const i=2+(t.hasZ?1:0)+(t.hasM?1:0),s=t.type==="polyline"?t.paths:t.rings;for(const n of s)r+=n.length;e+=8*r*i+64,e+=128*r,e+=34,e+=32*(s.length+1);break}case"multipoint":{const r=2+(t.hasZ?1:0)+(t.hasM?1:0),i=t.points.length;e+=8*i*r+64,e+=128*i,e+=34,e+=32;break}case"extent":e+=98,t.hasM&&(e+=32),t.hasZ&&(e+=32);break;case"mesh":e+=i1(t.vertexAttributes.position),e+=i1(t.vertexAttributes.normal),e+=i1(t.vertexAttributes.uv),e+=i1(t.vertexAttributes.tangent)}return e}function S6t(t){let e=32;return e+=qCe(t.attributes),e+=3,e+=8+git(t.geometry),e}function yit(t){if(t==null)return 0;switch(t.type){case"point":return 1;case"polyline":{let e=0;for(const r of t.paths)e+=r.length;return e}case"polygon":{let e=0;for(const r of t.rings)e+=r.length;return e}case"multipoint":return t.points.length;case"extent":return 2;case"mesh":{const e=t.vertexAttributes&&t.vertexAttributes.position;return e?e.length/3:0}default:return}}function E6t(t){if(t==null)return!1;switch(t.type){case"extent":case"point":return!0;case"polyline":for(const e of t.paths)if(e.length>0)return!0;return!1;case"polygon":for(const e of t.rings)if(e.length>0)return!0;return!1;case"multipoint":return t.points.length>0;case"mesh":return!t.loaded||t.vertexAttributes.position.length>0}}function C6t(t,e){switch(Gi(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[3]=t.x,e[1]=e[4]=t.y,t.hasZ&&(e[2]=e[5]=t.z);break;case"polyline":for(let r=0;r<t.paths.length;r++)$9(e,t.paths[r],!!t.hasZ);break;case"polygon":for(let r=0;r<t.rings.length;r++)$9(e,t.rings[r],!!t.hasZ);break;case"multipoint":$9(e,t.points,!!t.hasZ);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[3]=t.xmax,e[4]=t.ymax,t.zmin!=null&&(e[2]=t.zmin),t.zmax!=null&&(e[5]=t.zmax)}}function _it(t,e){switch(Au(e),t.type==="mesh"&&(t=t.extent),t.type){case"point":e[0]=e[2]=t.x,e[1]=e[3]=t.y;break;case"polyline":for(let r=0;r<t.paths.length;r++)w9(e,t.paths[r]);break;case"polygon":for(let r=0;r<t.rings.length;r++)w9(e,t.rings[r]);break;case"multipoint":w9(e,t.points);break;case"extent":e[0]=t.xmin,e[1]=t.ymin,e[2]=t.xmax,e[3]=t.ymax}}function A6t(t,e){return t.objectId!=null?t.objectId:t.attributes&&e?t.attributes[e]:null}function O6t(t){return t}function nAe(t){return $i(t)}function R6t(t,e,r){return Ee(t,e,r)}function ks(t,e,r){return t==null?null:z3(r.coordinateHelper.vectorToDehydratedPoint(t,vit),e,r)}function z3(t,e,r){if(t==null)return null;if(e==null)return Ee(t.x,t.y,t.z??0);if(e.type==="2d")return Ee(t.x,t.y,0);const{elevationInfo:i}=r,s=brt(e,t,i,no)??0;return Ee(t.x,t.y,s)}function ice(t,e,{z:r,m:i,spatialReference:s,elevationInfo:n}){if(r==null&&i==null){const l=Su(t[0],t[1],void 0,s);return i!=null&&(l.m=i,l.hasM=!0),l}if(e==null||e.type==="2d"){const l=Su(t[0],t[1],r,s);return i!=null&&(l.m=i,l.hasM=!0),l}const o=TCe(e,t,s,no,n)??0,a=Su(t[0],t[1],o,s);return i!=null&&(a.m=i,a.hasM=!0),a}function M6t(t,e){return Su(t[0],t[1],t[2],e)}const vit=Su(0,0,0,null);function xz(t,e){return t[0]*e[1]-t[1]*e[0]}function bit(t,e,r){const i=ms(r,e)/W1(r);return fc(t,r,i)}function Tz(t,e,r,i,s=r){return zs(IC,i,r),zs(rZ,e,s),bit(Wk,rZ,IC),_d(t,s,Wk)}function wit(t,e,r,i){zs(IC,e,r);const s=i/b$(IC);return d0(t,r,IC,s)}function I6t(t,e){const r=t.start,i=t.end,s=e.start,n=e.end,o=zs(IC,i,r),a=zs(Tit,n,s),l=xz(o,a);if(Math.abs(l)<=xit)return[];const c=zs(rZ,r,s),h=xz(a,c)/l,p=xz(o,c)/l;if(h>=0){if(p>=0||e.type===Fo.LINE)return[d0(Wk,r,o,h)]}else if(t.type===Fo.LINE&&(p>=0||e.type===Fo.LINE))return[d0(Wk,r,o,h)];return[]}var Fo;(function(t){t[t.RAY=0]="RAY",t[t.LINE=1]="LINE"})(Fo||(Fo={}));const xit=1e-6,IC=Pe(),Tit=Pe(),rZ=Pe(),Wk=Pe();function iZ({start:t,end:e,type:r},i,s){const n=[],o=zs(pS,e,t),a=zs(_O,t,i),l=W1(o),c=2*ms(o,a),h=c*c-4*l*(W1(a)-s*s);if(h===0){const p=-c/(2*l);(r===xf.PLANE||p>=0)&&n.push(d0(Pe(),t,o,p))}else if(h>0){const p=Math.sqrt(h),f=(-c+p)/(2*l);(r===xf.PLANE||f>=0)&&n.push(d0(Pe(),t,o,f));const m=(-c-p)/(2*l);(r===xf.PLANE||m>=0)&&n.push(d0(Pe(),t,o,m))}return n}function sZ(t,e){const r=t.start,i=t.end,s=zs(pS,i,r),n=ie(_O,-s[1],s[0],0),o=e.start,a=e.end,l=Mi(Jee,a,o),c=de(l,n),h=ie(cAe,r[0],r[1],0),p=Mi(uAe,h,o),f=de(p,n);if(Math.abs(c)<pf)return[];const m=gu(hAe,o,l,f/c);if(e.type===Fo.RAY){const g=Mi(Xk,m,o);if(de(g,l)<-pf)return[]}if(t.type===xf.HALF_PLANE){const g=Wee(Xk,m,r);if(ms(g,s)<-pf)return[]}return[$i(m)]}function nZ(t,e){return oZ(Zk(Qee,e[2],t),e)}function oAe(t,e){const i=lAe(Zk(Qee,0,t),Zk(Cit,0,e)),s=[];for(const n of i)s.push(QE(n));return s}function aAe(t,e){return Yee(t,Zk(Qee,t[2],e))}function Sit(t,e,r){const i=zs(pS,t,e),s=r/b$(i),n=d0(C(),e,i,s);return n[2]=t[2],n}function Yee(t,{start:e,end:r,type:i}){const s=Mi(pS,t,e),n=Mi(_O,r,e),o=de(s,n)/de(n,n);return gu(C(),e,n,i===Fo.RAY?Math.max(o,0):o)}function sce({start:t,end:e,type:r},i,s){const n=[],o=pe(pS,e,t),a=zs(_O,t,i),l=W1(o),c=2*ms(o,a),h=c*c-4*l*(W1(a)-s*s);if(h===0){const p=-c/(2*l);(r===Fo.LINE||p>=0)&&n.push(gu(C(),t,o,p))}else if(h>0){const p=Math.sqrt(h),f=(-c+p)/(2*l);(r===Fo.LINE||f>=0)&&n.push(gu(C(),t,o,f));const m=(-c-p)/(2*l);(r===Fo.LINE||m>=0)&&n.push(gu(C(),t,o,m))}return n}function lAe(t,e){const r=t.start,i=t.end,s=e.start,n=e.end,o=Mi(pS,i,r),a=Mi(_O,n,s),l=Mi(Jee,s,r),c=st(cAe,o,a),h=de(l,c);if(!a0(h,0,pf))return[];const p=tA(c);if(a0(p,0,pf))return[];const f=st(uAe,l,a),m=de(f,c)/p,g=gu(hAe,r,o,m);if(t.type===Fo.RAY){const _=Mi(Xk,g,r);if(de(o,_)<-pf)return[]}if(e.type===Fo.RAY){const _=Mi(Xk,g,s);if(de(a,_)<-pf)return[]}return[$i(g)]}function oZ({start:t,end:e,type:r},i){const s=Mi(pS,i,t),n=Mi(_O,e,t),o=st(Jee,n,s);if(tA(o)/tA(n)<pf)switch(r){case Fo.LINE:return[$i(i)];case Fo.RAY:return de(n,s)<-pf?[]:[$i(i)]}return[]}function nce(t,e,r){return a0(Lf(r,t),e*e,pf)?[$i(r)]:[]}function Zk(t,e,{start:r,end:i,type:s}){return ie(t.start,r[0],r[1],e),ie(t.end,i[0],i[1],e),t.type=Eit[s],t}var xf;(function(t){t[t.PLANE=0]="PLANE",t[t.HALF_PLANE=1]="HALF_PLANE"})(xf||(xf={}));const Eit={[xf.PLANE]:Fo.LINE,[xf.HALF_PLANE]:Fo.RAY},pf=1e-6,pS=C(),_O=C(),Jee=C(),cAe=C(),uAe=C(),hAe=C(),Xk=C(),Qee={start:C(),end:C(),type:Fo.LINE},Cit={start:C(),end:C(),type:Fo.LINE};let fS=class{intersect(e){return Mit(this,e)}},Ait=class extends fS{constructor(e){super(),this.point=e}equals(e){return KE(e)&&Jr(this.point,e.point)}closestTo(){return nAe(this.point)}},dAe=class extends fS{constructor(e,r,i){super(),this.start=e,this.end=r,this.type=i,this.lineLike={start:this.start,end:this.end,type:this.type}}equals(e){return Ex(e)&&this.type===e.type&&Jr(this.start,e.start)&&Jr(this.end,e.end)}closestTo(e){const r=Yee(e,this.lineLike);return r}},Oit=class extends dAe{constructor(e,r){super(e,r,Fo.LINE)}},pAe=class fAe extends fS{constructor(e,r,i){super(),this.intersection=e,this.first=r,this.second=i}equals(e){return e instanceof fAe&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(){return nAe(this.intersection)}},Sz=class mAe extends fS{constructor(e,r,i){super(),this.basePoint=e,this.first=r,this.second=i}equals(e){return e instanceof mAe&&this.first.equals(e.first)&&this.second.equals(e.second)}closestTo(e){const r=this.basePoint;return Ee(r[0],r[1],e[2])}},gAe=class extends fS{constructor(e,r){super(),this.center=e,this.radius=r}equals(e){return eC(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const r=Sit(e,this.center,this.radius);return r}},Kee=class extends fS{constructor(e,r,i){super(),this.start=e,this.end=r,this.type=i,this.planeLike={start:e,end:r,type:i}}equals(e){return Cx(e)&&this.type===e.type&&Jr(this.start,e.start)&&Jr(this.end,e.end)}closestTo(e){return aAe(e,this.planeLike)}closestEndTo(e){const{start:r,end:i}=this;return Math.sign(ms(zs(Pit,i,r),zs($it,e,r)))>0?i:r}},yAe=class extends Kee{constructor(e,r){super(e,r,xf.HALF_PLANE)}},_Ae=class extends Kee{constructor(e,r){super(e,r,xf.PLANE)}},vAe=class extends fS{constructor(e,r,i){super(),this.start=e,this.end=r,this.getZ=i,this.planeLike={start:e,end:r,type:xf.PLANE}}equals(e){return Ax(e)&&Jr(this.start,e.start)&&Jr(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Rit(this,e)}addIfOnTheGround(e,r){for(const i of r){const s=this.getZ(i[0],i[1],i[2])??0;Math.abs(i[2]-s)<pf&&(i[2]=s,e.push(i))}}};function Rit(t,e){const r=aAe(e,t.planeLike);return r[2]=t.getZ(e[0],e[1],e[2])??bAe,r}function Mit(t,e){let r=[];if(KE(t)){const{point:i}=t;Ex(e)?r=oZ(e.lineLike,i):eC(e)?r=nce(e.center,e.radius,i):Cx(e)?r=nZ(e.planeLike,i):Ax(e)&&(r=KO(e,t))}else if(Ex(t)){const{lineLike:i}=t;KE(e)?r=oZ(i,e.point):Ex(e)?r=lAe(i,e.lineLike):eC(e)?r=sce(i,e.center,e.radius):Cx(e)?r=sZ(e.planeLike,i):Ax(e)&&(r=KO(e,t))}else if(eC(t)){const{center:i,radius:s}=t;if(Ex(e))r=sce(e.lineLike,i,s);else if(KE(e))r=nce(i,s,e.point);else{if(Cx(e))return iZ(e.planeLike,i,s).map(n=>new Sz(n,t,e));Ax(e)&&(r=KO(e,t))}}else if(Cx(t)){const{planeLike:i}=t;if(Cx(e))return oAe(i,e.planeLike).map(s=>new Sz(s,t,e));if(KE(e))r=nZ(i,e.point);else if(Ex(e))r=sZ(i,e.lineLike);else{if(eC(e))return iZ(i,e.center,e.radius).map(s=>new Sz(s,t,e));Ax(e)&&(r=KO(e,t))}}else Ax(t)&&(r=KO(t,e));return Iit(r,t,e)}function KO(t,e){const{planeLike:r,getZ:i}=t,s=[];if(KE(e))t.addIfOnTheGround(s,nZ(r,e.point));else if(Ex(e))t.addIfOnTheGround(s,sZ(r,e.lineLike));else if(eC(e))for(const[n,o]of iZ(r,e.center,e.radius)){const a=i(n,o,0);a!=null&&s.push(Ee(n,o,a))}else if(Cx(e)||Ax(e))for(const[n,o]of oAe(r,e.planeLike)){const a=i(n,o,0)??bAe;s.push(Ee(n,o,a))}return s}function Iit(t,e,r){return t.map(i=>new pAe(i,e,r))}function KE(t){return t instanceof Ait}function Ex(t){return t instanceof dAe}function eC(t){return t instanceof gAe}function Cx(t){return t instanceof Kee}function Ax(t){return t instanceof vAe}const Pit=Pe(),$it=Pe(),bAe=0;function mS(t,e){const r=t.x-e.x,i=t.y-e.y;return r*r+i*i}function Lit(t,e){return Math.sqrt(mS(t,e))}function ete(t,e){e.sort((r,i)=>kn(r.targetPoint,t)-kn(i.targetPoint,t))}var Hd;function z6t({point:t,distance:e,returnEdge:r,returnVertex:i,coordinateHelper:{spatialReference:s}},n,o){return{point:Su(t[0],t[1],t[2],s.toJSON()),mode:n,distance:e,returnEdge:r,returnVertex:i,query:o!=null?o.toJSON():{where:"1=1"}}}function Yk(t,e,r){return{left:ks(t.leftVertex.pos,e,r),right:ks(t.rightVertex.pos,e,r)}}function B6t(t){return t.createQuery()}function Dit(t,e=()=>{}){const r=Q(()=>({view:t.view,snappingOptions:t.snappingOptions}),({view:i,snappingOptions:s})=>{const n="snapping-toggle",o=fs.TOOL;if(t.removeHandles(n),i&&s!=null){const a=[i.on("key-down",l=>{l.key!==rce.toggle||l.repeat||(s.enabledToggled=!0,e())},o),i.on("key-up",l=>{l.key===rce.toggle&&(s.enabledToggled=!1,e())},o),i.on("pointer-move",l=>{const c=l.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},o)];t.addHandles(a,n)}},Ri);t.addHandles(r)}(function(t){t[t.TARGET=0]="TARGET",t[t.REFERENCE=1]="REFERENCE",t[t.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(Hd||(Hd={}));let vO=class{constructor(e,r,i,s){this.targetPoint=e,this.constraint=r,this.isDraped=i,this.domain=s}},tte=class extends vO{constructor({targetPoint:e,objectId:r,constraint:i,isDraped:s}){super(e,i,s,Oa.FEATURE),this.objectId=r}},GV=class{constructor(e,r){this.isDraped=e,this.domain=r}},xg=class wAe extends GV{constructor(e,r,i,s,n=Oa.ALL,o=!0,a=!0){super(s,n),this.type=e,this.lineStart=r,this.lineEnd=i,this.fadeLeft=o,this.fadeRight=a}equals(e){return e instanceof wAe&&this.type===e.type&&Jr(this.lineStart,e.lineStart)&&Jr(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return _i(this.lineStart,this.lineEnd)}},Nit=class extends tte{constructor(e){super({...e,isDraped:!0,constraint:new vAe(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new xg(Hd.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Fit=class extends tte{constructor(e){super({...e,constraint:new Oit(e.edgeStart,e.edgeEnd)})}get hints(){return[new xg(Hd.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},xAe=class TAe extends GV{constructor(e,r,i,s,n=Oa.ALL){super(s,n),this.previousVertex=e,this.centerVertex=r,this.nextVertex=i}equals(e){return e instanceof TAe&&Jr(this.previousVertex,e.previousVertex)&&Jr(this.centerVertex,e.centerVertex)&&Jr(this.nextVertex,e.nextVertex)}},SAe=class extends vO{constructor({targetPoint:e,constraint:r,previousVertex:i,otherVertex:s,otherVertexType:n,objectId:o,isDraped:a}){super(e,r,a,Oa.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=n,this.objectId=o}get hints(){const e=this.previousVertex,r=this.otherVertexType===vA.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===vA.CENTER?this.targetPoint:this.otherVertex;return[new xg(Hd.TARGET,r,i,this.isDraped,this.domain),new xg(Hd.REFERENCE,e,r,this.isDraped,this.domain),new xAe(this.previousVertex,r,i,this.isDraped,this.domain)]}};var vA;(function(t){t[t.NEXT=0]="NEXT",t[t.CENTER=1]="CENTER"})(vA||(vA={}));function X6t(t,e,r,i){r.projectToRenderScreen(t,oce),r.projectToRenderScreen(e,ace),zs(i,ace,oce),yA(i,i)}function kit(t,e,r,i,s=C()){const n=oe(aZ,t);return n[2]=TCe(i,n,e,r)||0,i.renderCoordsHelper.toRenderCoords(n,e,s),s}function kl(t,e,r,i){return i.type==="2d"?(qL.x=t[0],qL.y=t[1],qL.spatialReference=e,i.toScreen(qL)):(kit(t,e,r,i,aZ),i.state.camera.projectToScreen(aZ,Ez),xh(Ez[0],Ez[1]))}const qL=Su(0,0,0,null),aZ=C(),oce=Lo(),ace=Lo(),Ez=cs();let pv=class extends wT{get updating(){return ra(this.snappingSources,({snappingSource:e})=>e.updating)||this.updatingHandles.updating}get snappingSources(){const e=this._get("snappingSources")||new Map,r=new Map;if(this.options!=null&&this.options.featureSources!=null)for(const i of this.options.featureSources.items){const s=i.layer.uid,n=e.get(s);if(n){e.delete(s),r.set(s,n);continue}if(!i.layer.loaded){this.updatingHandles.addPromise(i.layer.load());continue}const o=this._createSourceInfo(i);o!=null&&r.set(s,o)}for(const[,i]of e)i.destroy();return r}constructor(e){super(e),this.options=null,this._domain=Oa.FEATURE,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){this.updatingHandles.add(()=>this.snappingSources,()=>this.notifyChange("updating"),Rr),this.view!=null&&this.handles.add([this.view.on("layerview-create",e=>this._updateLayerView(e.layer,e.layerView)),this.view.on("layerview-destroy",e=>this._updateLayerView(e.layer,null))])}_updateLayerView(e,r){for(const[,i]of this.snappingSources)i.snappingSource.layerSource.layer===e&&(i.layerView=r)}destroy(){this._set("options",null);for(const[,e]of this.snappingSources)e.destroy()}async fetchCandidates(e,r,i,s){if(!(r&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const n=[],o=this._computeScreenSizeDistanceParameters(e,i),a={distance:o,mode:this.view?.type??"2d",point:e,coordinateHelper:i.coordinateHelper,...this._types};for(const[,{snappingSource:c,layerView:h}]of this.snappingSources)!c.layerSource.enabled||h!=null&&h.suspended||n.push(c.fetchCandidates(a,s).then(p=>p.filter(f=>!this._candidateIsExcluded(c,f,i.excludeFeature))));const l=(await L5(n)).flat();return this._addRightAngleCandidates(l,e,o,i),Dt(s),ete(e,l),l}_addRightAngleCandidates(e,r,i,s){const n=s.vertexHandle!=null?s.vertexHandle.rightEdge?.rightVertex?.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?s.editGeometryOperations.data.components[0]?.getFirstVertex()?.pos:null,o=s.vertexHandle!=null?s.vertexHandle.leftEdge?.leftVertex?.pos:s.editGeometryOperations!=null?s.editGeometryOperations.data.components[0]?.getLastVertex()?.pos:null,{view:a}=this,l=ks(n,a,s),c=ks(o,a,s),h=e.length;for(let p=0;p<h;p++)this._addRightAngleCandidate(e[p],c,r,i,e),this._addRightAngleCandidate(e[p],l,r,i,e)}_addRightAngleCandidate(e,r,i,s,n){if(r==null||!Vit(e))return;const o=e.constraint.closestTo(r),a=(o[0]-i[0])/s.x,l=(o[1]-i[1])/s.y,{start:c,end:h}=e.constraint;if(a*a+l*l<=1){const p=new SAe({targetPoint:o,otherVertex:r,otherVertexType:vA.NEXT,previousVertex:Lf(o,c)>Lf(o,h)?c:h,constraint:new yAe(r,o),objectId:e.objectId,isDraped:e.isDraped});n.push(p)}}_computeScreenSizeDistanceParameters(e,r){let i=this.options!=null?this.options.distance*(r.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,r)}_computeScreenSizeDistanceParameters3D(e,r,i,s){const{spatialReference:n}=s;i.renderCoordsHelper.toRenderCoords(e,n,lce);const o=i.state.camera.computeScreenPixelSizeAt(lce),a=o*i.renderCoordsHelper.unitInMeters/i.mapCoordsHelper.unitInMeters,l=r*a,c=kl(e,n,no,i),h=c?Cz(c,e,a,0,0,i,s):0,p=c?Cz(c,e,0,a,0,i,s):0,f=c?Cz(c,e,0,0,a,i,s):0;return{x:h===0?0:l/h,y:p===0?0:l/p,z:f===0?0:l/f,distance:o*r}}get _types(){return{returnEdge:!0,returnVertex:!0}}_candidateIsExcluded(e,r,i){if(i==null)return!1;const s=this._getCandidateObjectId(r);if(s==null)return!1;const n=e.layerSource.layer;return n.type==="graphics"?i.uid===s:i.sourceLayer===n&&!(!i.attributes||!("objectIdField"in n))&&i.attributes[n.objectIdField]===s}_getCandidateObjectId(e){return e instanceof tte?e.objectId:null}_createSourceInfo(e){const r=this._createFeatureSnappingSourceType(e);if(r==null)return null;if("loading"in r)return this.updatingHandles.addPromise(r.loading.then(()=>{this.destroyed||this.notifyChange("snappingSources")})),null;const i=this.view!=null?this.view.allLayerViews.find(s=>s.layer===e.layer):null;return new Uit(r.source,i)}_createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}_createFeatureSnappingSourceSceneLayer(e){const{view:r}=this;if(r==null||r.type!=="3d")return null;const i=this._getSourceModule("scene");return i.module!=null?{source:new i.module.SceneLayerSnappingSource({layerSource:e,view:r})}:{loading:i.loader}}_createFeatureSnappingSourceFeatureLayer(e){switch(e.layer.source?.type){case"feature-layer":case"oriented-imagery":{const r=this._getSourceModule("featureService");return r.module!=null?{source:new r.module.FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:r.loader}}case"memory":case"csv":case"geojson":case"wfs":{if(e.layer.geometryType==="mesh")return null;const r=this._getSourceModule("featureCollection");return r.module!=null?{source:new r.module.FeatureCollectionSnappingSource({layerSource:e,view:this.view})}:{loading:r.loader}}}return null}_createFeatureSnappingSourceGraphicsLayer(e){const r=this._getSourceModule("graphics");return r.module!=null?{source:new r.module.GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:r.loader}}_createFeatureSnappingSourceMapNotesLayer(e){const r=this._getSourceModule("notes");return r.module!=null?{source:new r.module.GraphicsSnappingSource({getGraphicsLayers:()=>e.layer.sublayers!=null?e.layer.sublayers.toArray():[],spatialReference:this.spatialReference,view:this.view,layerSource:e})}:{loading:r.loader}}_getSourceModule(e){const r=this._sourceModules[e];if(r.loader==null){const i=this._loadSourceModule(e).then(s=>{r.module=s});return r.loader=i,{module:r.module,loader:i}}return{module:r.module,loader:r.loader}}_loadSourceModule(e){const r=this.updatingHandles;switch(e){case"featureService":return r.addPromise(J(()=>import("./FeatureServiceSnappingSource-ef8c9fcd.js"),["./FeatureServiceSnappingSource-ef8c9fcd.js","./queryEngineUtils-55f7991f.js","./VertexSnappingCandidate-cc15b3c5.js","./PointSnappingHint-512a7cc6.js","./TileTreeDebugger-2812c7df.js"],import.meta.url));case"featureCollection":return r.addPromise(J(()=>import("./FeatureCollectionSnappingSource-792e9933.js"),["./FeatureCollectionSnappingSource-792e9933.js","./queryEngineUtils-55f7991f.js","./VertexSnappingCandidate-cc15b3c5.js","./PointSnappingHint-512a7cc6.js","./symbologySnappingCandidates-5232552d.js"],import.meta.url));case"graphics":case"notes":return r.addPromise(J(()=>import("./GraphicsSnappingSource-8fbc8e1c.js"),["./GraphicsSnappingSource-8fbc8e1c.js","./normalizeUtilsSync-cd43bd7f.js","./normalizeUtilsCommon-24f79564.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./queryEngineUtils-55f7991f.js","./VertexSnappingCandidate-cc15b3c5.js","./PointSnappingHint-512a7cc6.js","./symbologySnappingCandidates-5232552d.js"],import.meta.url));case"scene":return r.addPromise(J(()=>import("./SceneLayerSnappingSource-489cf563.js"),["./SceneLayerSnappingSource-489cf563.js","./VertexSnappingCandidate-cc15b3c5.js","./PointSnappingHint-512a7cc6.js"],import.meta.url))}}};u([d({constructOnly:!0})],pv.prototype,"spatialReference",void 0),u([d({constructOnly:!0})],pv.prototype,"view",void 0),u([d()],pv.prototype,"options",void 0),u([d({readOnly:!0})],pv.prototype,"updating",null),u([d({readOnly:!0})],pv.prototype,"snappingSources",null),pv=u([R("esri.views.interactive.snapping.FeatureSnappingEngine")],pv);let Uit=class{constructor(e,r){this.snappingSource=e,this.layerView=r,this.handles=new li;const i=this.snappingSource.layerSource.layer;if("refresh"in i){const s=i;this.handles.add(s.on("refresh",()=>e.refresh()))}this.handles.add([Q(()=>e.updating,s=>e.layerSource.updating=s,Ri),Q(()=>e.availability,s=>e.layerSource.availability=s,Ri)])}destroy(){this.snappingSource.destroy(),this.handles.destroy()}};function Vit(t){return(t instanceof Fit||t instanceof Nit)&&!zit(t)}function zit({constraint:{start:t,end:e}}){const r=kn(t,e),i=Lf(t,e);return r<sl()||i/r<Git}function Cz(t,e,r,i,s,n,{spatialReference:o}){const a=oe(Bit,e);a[0]+=r,a[1]+=i,a[2]+=s;const l=kl(a,o,no,n);return l?Lit(l,t):1/0}const lce=C(),Bit=C(),Git=1e-4;let jV=class{constructor(e,r){this.view=e,this.options=r,this.squaredShortLineThreshold=h0.shortLineThreshold*h0.shortLineThreshold}snap(e,r){return r.vertexHandle!=null?r.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,r):this.snapNewVertex(e,r)}edgeExceedsShortLineThreshold(e,r){return this.exceedsShortLineThreshold(ks(e.leftVertex.pos,this.view,r),ks(e.rightVertex.pos,this.view,r),r)}exceedsShortLineThreshold(e,r,{spatialReference:i}){return this.squaredShortLineThreshold===0||mS(kl(r,i,no,this.view),kl(e,i,no,this.view))>this.squaredShortLineThreshold}isVertical(e,r){return Lf(e,r)<h0.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:r}=this.options,i=e*r;return i*i}},jit=class extends vO{constructor({lineStart:e,lineEnd:r,targetPoint:i,isDraped:s}){super(i,new _Ae(e,r),s,Oa.SELF),this._referenceLineHint=new xg(Hd.REFERENCE_EXTENSION,e,r,s,this.domain)}get hints(){return[this._referenceLineHint,new xg(Hd.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},Hit=class extends jV{snapNewVertex(e,r){const i=r.editGeometryOperations.data.components[0],s=i.edges.length,n=[];if(s<1)return n;const{spatialReference:o}=r,a=kl(e,o,no,this.view),{view:l}=this,c=i.edges[s-1];let h=c;do{if(this.edgeExceedsShortLineThreshold(h,r)){const p=Yk(h,l,r);this._processCandidateProposal(p.left,p.right,e,a,r,n)}h=h.leftVertex.leftEdge}while(h&&h!==c);return n}snapExistingVertex(e,r){const i=[],s=r.vertexHandle,n=s.component;if(n.edges.length<2)return i;const{view:o}=this,{spatialReference:a}=r,l=kl(e,a,no,o),c=s.leftEdge,h=s.rightEdge;c&&h&&this.edgeExceedsShortLineThreshold(c,r)&&this.edgeExceedsShortLineThreshold(h,r)&&this._processCandidateProposal(ks(c.leftVertex.pos,o,r),ks(h.rightVertex.pos,o,r),e,l,r,i);const p=n.edges[0];let f=p;do{if(f!==s.leftEdge&&f!==s.rightEdge&&this.edgeExceedsShortLineThreshold(f,r)){const m=Yk(f,o,r);this._processCandidateProposal(m.left,m.right,e,l,r,i)}f=f.rightVertex.rightEdge}while(f&&f!==p);return i}_processCandidateProposal(e,r,i,s,n,o){const{spatialReference:a,pointer:l}=n,c=Yee(i,{start:e,end:r,type:Fo.LINE});mS(s,kl(c,a,no,this.view))<this.squaredProximityThreshold(l)&&o.push(new jit({lineStart:e,lineEnd:r,targetPoint:c,isDraped:n.elevationInfo?.mode==="on-the-ground"}))}},qit=class EAe extends GV{constructor(e,r,i,s=Oa.ALL){super(i,s),this.lineStart=e,this.lineEnd=r}equals(e){return e instanceof EAe&&Jr(this.lineStart,e.lineStart)&&Jr(this.lineEnd,e.lineEnd)}},Wit=class extends vO{constructor({referenceLine:e,lineStart:r,targetPoint:i,isDraped:s}){const n=$i(r),{left:o,right:a}=e;pe(n,ue(n,n,a),o),super(i,new _Ae(r,n),s,Oa.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new xg(Hd.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new qit(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new xg(Hd.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const r={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{Jr(e.right,i.edge.left)&&(i.fadeLeft=!1,r.fadeRight=!1),Jr(e.right,i.edge.right)&&(i.fadeRight=!1,r.fadeRight=!1),Jr(e.left,i.edge.right)&&(i.fadeRight=!1,r.fadeLeft=!1),Jr(e.left,i.edge.left)&&(i.fadeLeft=!1,r.fadeLeft=!1)}),this._referenceLines.push(r)}},Zit=class extends jV{snapNewVertex(e,r){const i=r.editGeometryOperations.data.components[0],s=i.edges.length,n=i.vertices.length,o=[];if(s<2)return o;const{view:a}=this,l=kl(e,r.spatialReference,no,a),c=ks(i.vertices[n-1].pos,a,r),h=ks(i.vertices[0].pos,a,r),p=i.edges[s-1];let f=p;do{if(this.edgeExceedsShortLineThreshold(f,r)){const m=Yk(f,a,r);this._checkEdgeForParallelLines(m,c,e,l,r,o),this._checkEdgeForParallelLines(m,h,e,l,r,o)}f=f.leftVertex.leftEdge}while(f&&f!==p);return o}snapExistingVertex(e,r){const i=[],s=r.vertexHandle,n=s.component;if(n.edges.length<3)return i;const{view:o}=this,a=kl(e,r.spatialReference,no,o),l=s.leftEdge,c=s.rightEdge,h=n.vertices[0],p=ks(h.pos,o,r),f=n.vertices.length,m=n.vertices[f-1],g=ks(m.pos,o,r),_=n.edges[0];let v=_;do{if(v!==l&&v!==c&&this.edgeExceedsShortLineThreshold(v,r)){const b=Yk(v,o,r);l&&this._checkEdgeForParallelLines(b,ks(l.leftVertex.pos,o,r),e,a,r,i),c&&this._checkEdgeForParallelLines(b,ks(c.rightVertex.pos,o,r),e,a,r,i),s===h?this._checkEdgeForParallelLines(b,g,e,a,r,i):s===m&&this._checkEdgeForParallelLines(b,p,e,a,r,i)}v=v.rightVertex.rightEdge}while(v&&v!==_);return i}_checkEdgeForParallelLines(e,r,i,s,n,o){const a=e.left,l=e.right;if(Tz(Rb,r,a,l),Lf(Rb,r)<h0.parallelLineThreshold)return;Tz(Rb,i,a,l,r);const{spatialReference:c,pointer:h}=n,p=Ee(Rb[0],Rb[1],i[2]);if(mS(s,kl(p,c,no,this.view))<this.squaredProximityThreshold(h)){if(this.isVertical(p,r)||this.isVertical(a,l)||this._parallelToPreviousCandidate(e,o))return;o.push(new Wit({referenceLine:e,lineStart:r,targetPoint:p,isDraped:n.elevationInfo?.mode==="on-the-ground"}))}}_parallelToPreviousCandidate(e,r){const i=e.left,s=e.right;for(const n of r)if(Tz(Rb,s,n.constraint.start,n.constraint.end,i),Lf(Rb,s)<h0.parallelLineThreshold)return n.addReferenceLine(e),!0;return!1}};const Rb=Pe();let Xit=class extends jV{snapNewVertex(e,r){const i=r.editGeometryOperations.data.components[0],s=i.vertices.length,n=[];if(s<2)return n;const{view:o}=this,a=kl(e,r.spatialReference,no,o),l=i.vertices[s-1];if(this.edgeExceedsShortLineThreshold(l.leftEdge,r)){const h=ks(l.pos,o,r),p=ks(l.leftEdge.leftVertex.pos,o,r);this._checkForSnappingCandidate(n,p,h,e,a,r)}const c=i.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,r)){const h=ks(c.pos,o,r),p=ks(c.rightEdge.rightVertex.pos,o,r);this._checkForSnappingCandidate(n,p,h,e,a,r)}return n}snapExistingVertex(e,r){const i=[],s=r.vertexHandle;if(s.component.vertices.length<3)return i;const{view:n}=this,o=kl(e,r.spatialReference,no,n),a=s.leftEdge,l=s.rightEdge;if(a&&a.leftVertex.leftEdge){const c=a.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,r)){const h=ks(c.rightVertex.pos,n,r),p=ks(c.leftVertex.pos,n,r);this._checkForSnappingCandidate(i,p,h,e,o,r)}}if(l&&l.rightVertex.rightEdge){const c=l.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,r)){const h=ks(c.leftVertex.pos,n,r),p=ks(c.rightVertex.pos,n,r);this._checkForSnappingCandidate(i,p,h,e,o,r)}}return i}_checkForSnappingCandidate(e,r,i,s,n,o){const{spatialReference:a,pointer:l}=o;zs(WL,i,r);const c=ie(Yit,WL[1],-WL[0],0),h=ms(c,zs(WL,s,i))/W1(c),p=d0($i(s),i,c,h);if(mS(n,kl(p,a,no,this.view))<this.squaredProximityThreshold(l)){if(this.isVertical(p,i)||this.isVertical(i,r))return;const f=gu(C(),i,c,Math.sign(h));e.push(new SAe({targetPoint:p,constraint:new yAe(i,f),previousVertex:r,otherVertex:i,otherVertexType:vA.CENTER,isDraped:o.elevationInfo?.mode==="on-the-ground"}))}}};const WL=Pe(),Yit=C();let Jit=class extends vO{constructor({targetPoint:e,point1:r,point2:i,isDraped:s}){super(e,new gAe(Wr(C(),r,i,.5),.5*I0(r,i)),s,Oa.SELF),this._p1=r,this._p2=i}get hints(){return[new xg(Hd.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new xg(Hd.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new xAe(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},Qit=class extends jV{snapNewVertex(e,r){const i=r.editGeometryOperations.data.components[0],s=[],n=i.vertices.length;if(r.editGeometryOperations.data.type!=="polygon"||n<2)return s;const{view:o}=this,a=i.vertices[0],l=i.vertices[n-1],c=ks(a.pos,o,r),h=ks(l.pos,o,r);return this._processCandidateProposal(c,h,e,r,s),s}snapExistingVertex(e,r){const i=[],s=r.vertexHandle,n=s.component;if(n.edges.length<2||r.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===n.vertices.length-1))return i;const{view:o}=this,a=ks(s.leftEdge.leftVertex.pos,o,r),l=ks(s.rightEdge.rightVertex.pos,o,r);return this._processCandidateProposal(a,l,e,r,i),i}_processCandidateProposal(e,r,i,s,n){if(!this.exceedsShortLineThreshold(e,r,s))return;const o=ah(Kit,e,r,.5),a=.5*I0(e,r),l=C();wit(l,i,o,a),l[2]=i[2];const c=l,{spatialReference:h,pointer:p}=s,f=kl(i,h,no,this.view);if(mS(f,kl(c,h,no,this.view))<this.squaredProximityThreshold(p)){if(this.isVertical(e,c)||this.isVertical(c,r))return;n.push(new Jit({targetPoint:c,point1:e,point2:r,isDraped:s.elevationInfo?.mode==="on-the-ground"}))}}};const Kit=Pe();let gE=class extends me{constructor(e){super(e),this.updating=!1,this._snappers=new Ke,this._domain=Oa.SELF}initialize(){this._snappers.push(new Zit(this.view,this.options),new Hit(this.view,this.options),new Xit(this.view,this.options),new Qit(this.view,this.options))}set options(e){this._set("options",e);for(const r of this._snappers)r.options=e}async fetchCandidates(e,r,i){if(!(r&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const n of this._snappers.items)for(const o of n.snap(e,i))s.push(o);return ete(e,s),s}};u([d({readOnly:!0})],gE.prototype,"updating",void 0),u([d({constructOnly:!0})],gE.prototype,"view",void 0),u([d()],gE.prototype,"options",null),gE=u([R("esri.views.interactive.snapping.SelfSnappingEngine")],gE);function est(t,e){return[new gE({view:t,options:e}),new pv({view:t,options:e,spatialReference:t.spatialReference})]}let qu=class extends me{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Ke,this.distance=h0.distance,this.touchSensitivityMultiplier=h0.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};u([d()],qu.prototype,"enabled",void 0),u([d()],qu.prototype,"enabledToggled",void 0),u([d()],qu.prototype,"selfEnabled",void 0),u([d()],qu.prototype,"featureEnabled",void 0),u([d({type:Ke.ofType(kee)})],qu.prototype,"featureSources",void 0),u([d()],qu.prototype,"distance",void 0),u([d()],qu.prototype,"touchSensitivityMultiplier",void 0),u([d({readOnly:!0})],qu.prototype,"effectiveEnabled",null),u([d({readOnly:!0})],qu.prototype,"effectiveSelfEnabled",null),u([d({readOnly:!0})],qu.prototype,"effectiveFeatureEnabled",null),qu=u([R("esri.views.interactive.snapping.SnappingOptions")],qu);const rte=qu;let tst=class CAe extends GV{constructor(e,r,i=Oa.ALL){super(r,i),this.intersectionPoint=e}equals(e){return e instanceof CAe&&Jr(this.intersectionPoint,e.intersectionPoint)}},ZL=class extends vO{constructor(e,r,i,s){super(e,new pAe(e,r.constraint,i.constraint),s,Oa.ALL),this.first=r,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new tst(this.targetPoint,this.isDraped,this.domain)]}},Dp=class extends Xr.EventedMixin(wT){constructor(e){super(e),this.options=new rte,this.snappingEnginesFactory=est,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=zy.MAIN}initialize(){this.handles.add([Q(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:r,touchSensitivityMultiplier:i,distance:s}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:r,touchSensitivityMultiplier:i,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},Rr),Q(()=>this.options,e=>{for(const r of this._engines)r.options=e},Rr),Q(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:e,snappingEnginesFactory:r})=>this._recreateEngines(e,r),Ri)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)}_recreateEngines(e,r){if(this._destroyEngines(),!e)return;const{view:i,options:s}=this;this._engines=r(i,s)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:r}=this.options,i=e*r;return i*i}get _squaredSatisfiesConstraintThreshold(){return h0.satisfiesConstraintScreenThreshold*h0.satisfiesConstraintScreenThreshold}async snap(e){return rst(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:r,context:i}=e;this._removeVisualization();const s=this._currentMainCandidate;if(s==null)return r;const n=this._selectUpdateInput(e);if(n==null)return r;const{spatialReference:o}=i,a=bg(n,o);if(a==null)return r;const{view:l}=this,{elevationInfo:c,visualizer:h}=i,p=[],f=z3(a,l,i),m=s.constraint.closestTo(f);if(!this._arePointsWithinScreenThreshold(f,m,i))return this._resetSnappingState(),r;s.targetPoint=m,p.push(...s.hints);for(const g of this._currentOtherActiveCandidates)g.targetPoint=m,p.push(...g.hints);return h!=null&&this.handles.add(h.draw(p,{spatialReference:o,elevationInfo:ist(i),view:l,selfSnappingZ:i.selfSnappingZ}),XL),ice(m,l,{z:r.z,m:r.m,spatialReference:r.spatialReference,elevationInfo:c})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:r}){switch(this._currentSnappedType){case zy.MAIN:return e;case zy.SCENE:return r}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=zy.MAIN}_removeVisualization(){this.handles.remove(XL)}async _snapSinglePoint({point:e,context:r,signal:i}){const{view:s}=this,n=z3(e,s,r),o=await this._fetchCandidates(n,Oa.ALL,r,i);return this._createSnapResult(n,zy.MAIN,o,s,r,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:r.elevationInfo},i)}async _snapMultiPoint({point:e,scenePoint:r,context:i,signal:s}){const{view:n}=this,{coordinateHelper:o,spatialReference:a}=i;await fee(r.spatialReference,a);const l=bg(r,a),c=z3(l,n,i),h=await this._fetchCandidates(c,Oa.FEATURE,i,s);if(h.length>0){const m=await this._fetchCandidates(c,Oa.SELF,i,s);return this._createSnapResult(c,zy.SCENE,[...h,...m],n,i,{z:l.z,m:l.m,spatialReference:l.spatialReference,elevationInfo:i.elevationInfo},s)}const p=z3(e,n,i),f=await this._fetchCandidates(p,Oa.SELF,i,s);return this._createSnapResult(p,zy.MAIN,f,n,i,{z:o.hasZ()&&e.hasZ?e.z??0:void 0,m:o.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:i.elevationInfo},s)}async _fetchCandidates(e,r,i,s){return(await Promise.all(this._engines.map(n=>n.fetchCandidates(e,r,i,s)))).flat()}_createSnapResult(e,r,i,s,n,o,a){return{get valid(){return!dn(a)},apply:()=>{const{spatialReference:l}=n,{snappedPoint:c,hints:h}=this._processCandidates(e,r,i,n);return this._removeVisualization(),n.visualizer!=null&&this.handles.add(n.visualizer.draw(h,{spatialReference:l,elevationInfo:no,view:s,selfSnappingZ:n.selfSnappingZ}),XL),ice(c,s,o)}}}_processCandidates(e,r,i,s){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==r&&this._resetSnappingState(),ete(e,i);const n=this._currentMainCandidate;if(n!=null){const o=this._findOldConstraintInNewCandidates(n,i);if(o>=0){if(!(i[o]instanceof ZL))return this._intersectWithOtherCandidates(o,i,e,r,s);if(this._arePointsWithinScreenThreshold(e,n.targetPoint,s))return this._updateSnappingCandidate(n,r,i,s)}}return this._intersectWithOtherCandidates(0,i,e,r,s)}_findOldConstraintInNewCandidates(e,r){return e instanceof ZL?this._findOldCandidateIndex(r,e.first)>=0&&this._findOldCandidateIndex(r,e.second)>=0?0:-1:this._findOldCandidateIndex(r,e)}_intersectWithOtherCandidates(e,r,i,s,n){const{coordinateHelper:o}=n,a=r[e],l=[];for(let c=0;c<r.length;++c){if(c===e)continue;const h=r[c];for(const p of a.constraint.intersect(h.constraint)){const f=p.closestTo(a.targetPoint);l.push([new ZL(f,a,h,h.isDraped),this._squaredScreenDistance(i,f,o)])}}return l.length>0&&(l.sort((c,h)=>c[1]-h[1]),l[0][1]<this._squaredPointProximityThreshold(n.pointer))?this._updateSnappingCandidate(l[0][0],s,r,n):this._updateSnappingCandidate(a,s,r,n)}_updateSnappingCandidate(e,r,i,s){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=r;const n=this._currentMainCandidate.targetPoint,o=[];o.push(...e.hints);for(const a of i){if(e instanceof ZL){if(a.constraint.equals(e.first.constraint)||a.constraint.equals(e.second.constraint))continue}else if(a.constraint.equals(e.constraint))continue;const l=a.constraint.closestTo(n);this._squaredScreenDistance(l,n,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(a.targetPoint=n,this._currentOtherActiveCandidates.push(a),o.push(...a.hints))}return{snappedPoint:n,hints:o}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,r,i){return this._squaredScreenDistance(e,r,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,r,i){return mS(this._toScreen(e,i),this._toScreen(r,i))}_toScreen(e,r){return kl(e,r.spatialReference,no,this.view)}_findOldCandidateIndex(e,r){let i=-1;for(let s=0;s<e.length;++s)if(r.constraint.equals(e[s].constraint)){i=s;break}return i}get test(){return{visualizationsActive:this.handles.has(XL),engines:this._engines}}};var zy;u([d({constructOnly:!0})],Dp.prototype,"view",void 0),u([d()],Dp.prototype,"options",void 0),u([d({readOnly:!0})],Dp.prototype,"updating",null),u([d()],Dp.prototype,"snappingEnginesFactory",void 0),u([d()],Dp.prototype,"_engines",void 0),u([d()],Dp.prototype,"_squaredMouseProximityTreshold",null),u([d()],Dp.prototype,"_squaredTouchProximityThreshold",null),u([d()],Dp.prototype,"_squaredSatisfiesConstraintThreshold",null),Dp=u([R("esri.views.interactive.snapping.SnappingManager")],Dp),function(t){t[t.MAIN=0]="MAIN",t[t.SCENE=1]="SCENE"}(zy||(zy={}));const XL="visualization-handle";function rst(t){return t.scenePoint!=null}function ist({coordinateHelper:t,elevationInfo:e}){return t.hasZ()?no:e}function hd(t){return xh(t.x,t.y)}function uVt(t){return cs(t.x,t.y)}function AAe(t,e){const r=(t instanceof HTMLElement?t:t.surface)?.getBoundingClientRect();return r?xh(e.clientX-r.left,e.clientY-r.top):xh(0,0)}function cce(t,e){return e instanceof Event?AAe(t,e):hd(e)}function uce(t){if(t instanceof Event)return!0;if(typeof t=="object"&&"type"in t)switch(t.type){case"click":case"double-click":case"pointer-down":case"pointer-drag":case"pointer-enter":case"pointer-leave":case"pointer-up":case"pointer-move":case"immediate-click":case"immediate-double-click":case"hold":case"drag":case"mouse-wheel":return!0;default:return!1}return!1}let za=class extends Xr.EventedAccessor{constructor(e){super(e),this.cancelled=!1,this.history={undo:[],redo:[]},this.type=null}get tool(){if(!this.activeComponent)return null;switch(this.activeComponent.type){case"graphic-mover":case"move-3d":return"move";case"box":case"transform-3d":return"transform";case"reshape":case"reshape-3d":return"reshape";case"draw-2d":case"draw-3d":return this.activeComponent.geometryType;default:this.activeComponent}return null}addToHistory(e){this.history.redo=[],this.history.undo.push(e)}resetHistory(){this.history.redo=[],this.history.undo=[]}canUndo(){return this.history.undo.length>0}canRedo(){return this.history.redo.length>0}complete(){this._reset(),this.onEnd(),this.emit("complete")}cancel(){this.cancelled=!0,this.complete()}_reset(){this.activeComponent?.reset()}refreshComponent(){const e=this.activeComponent;e&&(e.type!=="box"&&e.type!=="reshape"&&e.type!=="graphic-mover"||e.refresh())}set undo(e){this._set("undo",()=>{this.canUndo()&&e()})}set redo(e){this._set("redo",()=>{this.canRedo()&&e()})}};u([d()],za.prototype,"activeComponent",void 0),u([d()],za.prototype,"cancelled",void 0),u([d()],za.prototype,"history",void 0),u([d()],za.prototype,"tool",null),u([d()],za.prototype,"type",void 0),u([d()],za.prototype,"canUndo",null),u([d()],za.prototype,"canRedo",null),u([d()],za.prototype,"onEnd",void 0),u([d()],za.prototype,"undo",null),u([d()],za.prototype,"redo",null),u([d()],za.prototype,"toggleTool",void 0),u([d()],za.prototype,"addToSelection",void 0),u([d()],za.prototype,"removeFromSelection",void 0),za=u([R("esri.widgets.Sketch.support.OperationHandle")],za);let O4=class extends za{};u([d()],O4.prototype,"activeComponent",void 0),O4=u([R("esri.widgets.Sketch.support.CreateOperationHandle")],O4);let Zy=class extends za{};u([d()],Zy.prototype,"activeComponent",void 0),Zy=u([R("esri.widgets.Sketch.support.UpdateOperationHandle")],Zy);const hce={defaultZ:0},eR={reshapeOptions:{edgeOperation:"split",shapeOperation:"move",vertexOperation:"move"},enableMoveAllGraphics:!0,enableRotation:!0,enableScaling:!0,multipleSelectionEnabled:!0,preserveAspectRatio:!1,toggleToolOnClick:!0,enableZ:!0,highlightOptions:{enabled:!0},tool:"transform"};let Ts=class extends Xr.EventedAccessor{constructor(e){super(e),this._numUpdating=0,this._handles=new li,this._internalGraphicsLayer=new rCe({listMode:"hide",internal:!0,title:"SVM Internal"}),this._operationHandle=null,this._viewHandles=new li,this.activeFillSymbol=null,this.activeLineSymbol=null,this.activeVertexSymbol=null,this.allowDeleteKey=!0,this.labelOptions=new RCe,this.layer=null,this.pointSymbol=new Pf({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this.polygonSymbol=new U0({color:[150,150,150,.2],outline:{color:[50,50,50],width:2}}),this.polylineSymbol=new Iu({color:[130,130,130,1],width:2}),this.meshSymbol=new o$({symbolLayers:[new cO]}),this._snappingManager=null,this.tooltipOptions=new MCe,this.updateGraphics=new Ke,this.updateOnGraphicClick=!0,this.vertexSymbol=new Pf({style:"circle",size:6,color:[255,255,255],outline:{color:[50,50,50],width:1}}),this._moduleLoaderAbortController=null,this._viewReadyAbortController=null,this._originalPopupEnabled=null,this.defaultCreateOptions=hce,this.defaultUpdateOptions=eR,this.snappingOptions=new rte}initialize(){this._handles.add([Vs(()=>this.view?.map?.layers,"change",e=>{e.removed.includes(this.layer)&&this.cancel()}),Vs(()=>this.layer?.graphics,"change",e=>{if(this._operationHandle!=null)for(const r of e.removed)this.updateGraphics.includes(r)&&(this.updateGraphics.length>1?this._operationHandle.removeFromSelection(r):this._operationHandle.cancel())}),Q(()=>this.layer?.elevationInfo??null,e=>{e!==this._internalGraphicsLayer.elevationInfo&&(this.cancel(),this._internalGraphicsLayer.elevationInfo=e)},Ri),Q(()=>this.view,e=>{Re(this._snappingManager),e&&(this._snappingManager=new Dp({view:e,options:this.snappingOptions}),e.type==="2d"?J(()=>import("./editingTools-ca6c8004.js"),["./editingTools-ca6c8004.js","./SnappingVisualizer2D-0ec85274.js","./settings-a95b40f5.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./editPlaneUtils-792f9cea.js","./getDefaultUnitForView-399249e8.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./GraphicManipulator-bb63ffee.js"],import.meta.url):e.type==="3d"&&(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url),J(()=>import("./GraphicsLayerView3D-a4a16c28.js"),["./GraphicsLayerView3D-a4a16c28.js","./LayerView3D-b22e015d.js","./queryForSymbologySnapping-fd994e68.js","./GraphicsProcessor-5c167a1f.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./projectExtentUtils-2b7f21f8.js","./LayerView-200784d6.js"],import.meta.url)))},Ri),Q(()=>this.view?.spatialReference,(e,r)=>{e&&r&&!e.equals(r)&&this.cancel()})]),Dit(this)}destroy(){this.cancel(),this._handles=Re(this._handles),this._viewHandles=Re(this._viewHandles),this._removeDefaultLayer(),this._snappingManager=Re(this._snappingManager),this._set("view",null),this.emit("destroy")}get _defaultUpdateTool(){return this.view?.type==="3d"?"move":"transform"}get updating(){return this._numUpdating>0||this._snappingManager!=null&&this._snappingManager.updating}get activeTool(){return this._operationHandle?.tool??null}get activeComponent(){return this._operationHandle?.activeComponent??null}get createGraphic(){return this.activeComponent==null||this.activeComponent.type!=="draw-3d"&&this.activeComponent.type!=="draw-2d"?this._get("createGraphic"):this.activeComponent.graphic}get defaultCreateOptions(){return this._get("defaultCreateOptions")}set defaultCreateOptions(e){this._set("defaultCreateOptions",{...hce,...e})}get defaultUpdateOptions(){return this._get("defaultUpdateOptions")}set defaultUpdateOptions(e){this._set("defaultUpdateOptions",{...eR,...e,reshapeOptions:{...eR.reshapeOptions,...e?.reshapeOptions},highlightOptions:{...eR.highlightOptions,...e?.highlightOptions}})}set snappingOptions(e){this._snappingManager!=null&&(this._snappingManager.options=e),this._set("snappingOptions",e)}get state(){const e=!(!this.view?.ready||!this.layer),r=this._operationHandle;return e&&r?"active":e?"ready":"disabled"}get view(){return this._get("view")}set view(e){const r=this._get("view");if(r){const{container:s,map:n}=r;s&&(r.cursor=null),n&&n.remove(this._internalGraphicsLayer),this._viewHandles.removeAll(),this.cancel()}const i="view-ready";this._handles.remove(i),e&&this._handles.add(No(()=>e.ready,s=>{this._viewHandles.removeAll(),s&&this._viewHandles.add(this._generateViewHandles(e))},Ri),i),this._set("view",e)}cancel(){this._moduleLoaderAbortController=Do(this._moduleLoaderAbortController),this._viewReadyAbortController=Do(this._viewReadyAbortController),this._operationHandle&&this._operationHandle.cancel()}complete(){this._operationHandle&&this._operationHandle.complete()}delete(){const{state:e,updateGraphics:r}=this;if(e==="active"&&r.length){const{activeTool:i,layer:s}=this,n=r.toArray();s.removeMany(n),this.cancel(),this._emitDeleteEvent({graphics:n,tool:i})}}duplicate(){if(this.state==="active"&&this.updateGraphics.length){const e=this.updateGraphics.map(r=>r.clone()).toArray();return this.layer.addMany(e),this.emit("duplicate",{graphics:e,type:"duplicate"}),e}return[]}async create(e,r){this.cancel(),await this._waitViewReady();const{view:i,layer:s}=this;if(!i||this.state==="disabled")throw s||this._logMissingLayer(),Tr();if(i.activeTool!=null&&(i.activeTool=null),!e)return void this._logError("sketch:missing-parameter","Missing parameter 'tool'.");ece(i,this._internalGraphicsLayer);const n=await this._setupCreateOperation(e,r);if(n==null||this.destroyed)return void i.map.remove(this._internalGraphicsLayer);const o=()=>{if(n===this._operationHandle){const a=this.createGraphic,l=this._operationHandle.cancelled;this._operationHandle.destroy(),this._operationHandle=null,this._set("createGraphic",null),this.view&&this.view.map&&this.view.map.remove(this._internalGraphicsLayer),n.cancelled||a==null||s.add(a),this.emit("create",{graphic:a,state:l?"cancel":"complete",tool:e,toolEventInfo:null,type:"create"})}};n.on("complete",o),this._operationHandle=n,i.ready&&i.focus()}async update(e,r){this.cancel(),await this._waitViewReady();const{layer:i,view:s,state:n}=this;if(!s||n==="disabled")throw i||this._logMissingLayer(),Tr();s.activeTool!=null&&(s.activeTool=null);const o=Array.isArray(e)?e:[e];if(e==null||!o||!o.length)return void this._logError("sketch:missing-parameter","Missing parameter 'graphics'.");if(o.some(l=>l.layer!==i?(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics missing from the supplied GraphicsLayer."),!0):l.geometry==null&&(this._logError("sketch:invalid-parameter","Parameter 'graphics' contains one or more graphics with an unsupported geometry."),!0)))return;const a=await this._setupUpdateOperation(o,r);this.destroyed||a==null||fo(a)||(ece(s,this._internalGraphicsLayer),this._setUpdateOperationHandle(a,r),this.emit("update",{graphics:o,state:"start",aborted:!1,tool:a.tool,toolEventInfo:null,type:"update"}))}async _updateSpatialReference(e){const r=this.view;if(r){this._beginAsyncOperation(),e=Array.isArray(e)?e:[e];for(const i of e)i.geometry==null||i.geometry.type==="mesh"||Bn(i.geometry.spatialReference,r.spatialReference)||($f(i.geometry.spatialReference,r.spatialReference)||y$()||await mA(),i.geometry=bg(i.geometry,r.spatialReference));this._endAsyncOperation()}else this._logMissingView()}undo(){this.canUndo()&&this._operationHandle?.undo()}redo(){this.canRedo()&&this._operationHandle?.redo()}canUndo(){return!(!this._operationHandle||!this._operationHandle.canUndo())}canRedo(){return!(!this._operationHandle||!this._operationHandle.canRedo())}toggleUpdateTool(){this._operationHandle&&this._operationHandle.toggleTool&&this._operationHandle.toggleTool()}async _getFirstHit(e){const r=this.view;if(!r)return this._logMissingView(),null;if(r.type==="2d"){const n=[];r.map.allLayers.forEach(a=>{a.type!=="vector-tile"&&a.type!=="imagery"||n.push(a)});const o=await r.hitTest(e,{exclude:n});return ktt(o.results)}const i=[r.map.ground];r.map.allLayers.forEach(n=>{n.type==="integrated-mesh"&&i.push(n)});const s=await r.hitTest(e,{exclude:i});if(s.results.length>0){const n=s.results[0];if(n!=null&&n.type==="graphic"&&n.graphic&&(!s.ground.mapPoint||r.map.ground.opacity<1||s.ground.distance-(n.distance??0)>-Math.min(3*s.ground.distance,r.viewingMode==="global"?Ir(r.renderCoordsHelper.spatialReference).radius/r.renderCoordsHelper.unitInMeters:Number.POSITIVE_INFINITY)))return n}return null}_generateViewHandles(e){return[e.on("immediate-click",async r=>{const i=this.state==="active"&&this._operationHandle?.type==="create";if(this.state==="disabled"||i||!this.updateOnGraphicClick)return;this._beginAsyncOperation();const s=await r.async(()=>this._getFirstHit(hd(r)));let n=null;if(s!=null){const o=s.graphic;this.updateGraphics.includes(o)||o.layer===this.layer?(r.stopPropagation(),n=o):e.type!=="2d"||this._isComponentGraphic(o)||this.state!=="active"||this.cancel()}else this.state==="active"&&this.cancel();n==null||this.updateGraphics.includes(n)||await this.update([n],{...this.defaultUpdateOptions,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions}}),this._endAsyncOperation()},fs.WIDGET)]}async _setupCreateOperation(e,r){const i=this.view;if(!i)return this._logMissingView(),null;const s={hasZ:i.type==="3d",...this.defaultCreateOptions,...r},n=await this._setupDrawGraphicTool(e,i,s);return n==null?null:(i.tools.add(n),i.activeTool=n,this._setupCreateOperationHandle(n))}async _setupDrawGraphicTool(e,r,i){if(e==="multipoint"&&r.type==="3d")return this._logError("sketch:create","Multipoint geometries are not supported in SceneView."),null;if(!r)return this._logMissingView(),null;const s=e!=="rectangle",n=e!=="rectangle",o={view:r,mode:e==="rectangle"||e==="circle"?"hybrid":"click",...i,snapToScene:!1,geometryType:e,graphicSymbol:this._getGraphicSymbolFromTool(e),snappingManager:this._snappingManager,forceUniformSize:n,centered:s};return r.type==="2d"?this._makeDrawGraphicTool2D(o):this._makeDrawGraphicTool3D(o)}async _makeDrawGraphicTool2D(e){const r=await this._requireModule(J(()=>import("./editingTools-ca6c8004.js"),["./editingTools-ca6c8004.js","./SnappingVisualizer2D-0ec85274.js","./settings-a95b40f5.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./editPlaneUtils-792f9cea.js","./getDefaultUnitForView-399249e8.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./GraphicManipulator-bb63ffee.js"],import.meta.url));return fo(r)||this.destroyed?null:new r.module.DrawGraphicTool2D({...e,activeVertexSymbol:this.activeVertexSymbol,regularVerticesSymbol:this.vertexSymbol,activeLineSymbol:this.activeLineSymbol,activeFillSymbol:nst(e.geometryType)?this.activeFillSymbol:null,tooltipOptions:this.tooltipOptions})}async _makeDrawGraphicTool3D(e){const r=await this._requireModule(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url));if(fo(r)||this.destroyed)return null;const{elevationInfo:i}=this.layer;return new r.module.DrawGraphicTool3D({...e,elevationInfo:i,snapToScene:i==null||i.mode==="absolute-height",labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions})}_setupCreateOperationHandle(e){const r=this.view;if(!r)return this._logMissingView(),null;let i=null;const s=e.forceUniformSize,n=e.centered,o=[r.on("key-down",l=>{if(l.key===po.pan)l.stopPropagation(),l.repeat||(e.enabled=!1);else if(l.key===po.complete)l.stopPropagation(),e.completeCreateOperation();else if(l.key!==po.vertexAdd||l.repeat)l.key===po.undo?(l.stopPropagation(),a.undo()):l.key===po.redo?(l.stopPropagation(),a.redo()):l.key!==po.constraint||e.geometryType!=="rectangle"&&e.geometryType!=="circle"||l.repeat?l.key===po.center&&(l.repeat||(e.centered=!n,l.stopPropagation())):(e.forceUniformSize=!s,l.stopPropagation());else{const c=e.drawOperation.geometryType;c!=="polyline"&&c!=="polygon"&&c!=="multipoint"||(l.stopPropagation(),e.drawOperation.commitStagedVertex())}},fs.WIDGET),r.on("key-up",l=>{l.key===po.pan?e.enabled=!0:l.key!==po.constraint||e.geometryType!=="rectangle"&&e.geometryType!=="circle"?l.key===po.center&&(e.centered=n,l.stopPropagation()):(e.forceUniformSize=s,l.stopPropagation())},fs.WIDGET),e.on("vertex-add",l=>{switch(i=i==null?"start":"active",l.operation){case"apply":this.emit("create",{graphic:e.graphic,state:i,tool:this.activeTool,toolEventInfo:l,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[e.graphic],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[e.graphic],tool:e.geometryType})}}),e.on("cursor-update",l=>{e.drawOperation.numCommittedVertices>0&&this.emit("create",{graphic:e.graphic,state:"active",tool:this.activeTool,toolEventInfo:{coordinates:l.vertices[0].coordinates,type:"cursor-update"},type:"create"})}),e.on("vertex-remove",l=>{switch(l.operation){case"apply":this.emit("create",{graphic:e.graphic,state:"active",tool:this.activeTool,toolEventInfo:l,type:"create"});break;case"undo":this._emitUndoEvent({graphics:[e.graphic],tool:e.geometryType});break;case"redo":this._emitRedoEvent({graphics:[e.graphic],tool:e.geometryType})}}),e.on("complete",l=>{this._set("createGraphic",l.graphic),i="complete",l.aborted?a&&a.cancel():a&&a.complete()}),Q(()=>this._getGraphicSymbolFromTool(e.geometryType),l=>{e.graphicSymbol=l})],a=new O4({activeComponent:e,tool:e.geometryType,type:"create",onEnd:()=>{o.forEach(l=>l.remove()),o.length=0,r.tools?.remove(e)},undo:()=>{e.canUndo&&e.undo()},redo:()=>{e.canRedo&&e.redo()},canUndo:()=>e.canUndo,canRedo:()=>e.canRedo});return a}_getGraphicSymbolFromTool(e){switch(e){case"point":case"multipoint":return this.pointSymbol;case"polyline":return this.polylineSymbol;case"circle":case"rectangle":case"polygon":return this.polygonSymbol;case"mesh":return this.meshSymbol}}async _setupUpdateOperation(e,r){const{layer:i,view:s}=this;if(!s)return this._logMissingView(),null;const n={tool:this._defaultUpdateTool,...this.defaultUpdateOptions,...r,reshapeOptions:{...this.defaultUpdateOptions.reshapeOptions,...r?.reshapeOptions},highlightOptions:{...this.defaultUpdateOptions.highlightOptions,...r?.highlightOptions}};let o=n.tool;for(const a of e)i.remove(a),i.add(a);if(s.type==="3d"){if(e.length===0)return null;switch(o){case"move":return this._setupMove3DOperation(e,n,s,o);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const a=HL(e[0]);return a===Zi.SUPPORTED?this._setupReshape3DOperation(e[0],n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${wz(a)}).`),null)}case"transform":return this._setupGraphicTransform3DOperation(e,n,s)}}switch(o){case"move":return this._setupMove2DOperation(e,n,s);case"reshape":{if(e.length>1)return this._logError("sketch:reshape-multiple","Reshape operation does not support multiple graphics."),null;const a=HL(e[0]);return a===Zi.SUPPORTED?this._setupTransformOrReshape2DOperation(e,o,n,s):(this._logError("sketch:reshape",`Reshape operation not supported for provided graphic(s) (${wz(a)}).`),null)}case"transform":if(e.length===1){const a=e[0].geometry?.type;a!=="point"&&a!=="multipoint"||(o="reshape")}return this._setupTransformOrReshape2DOperation(e,o,n,s)}}async _setupMove3DOperation(e,r,i,s,n=!1){for(const h of e){const p=Srt(h);if(p!==Zi.SUPPORTED)return this._logError("sketch:move",`Move operation not supported for provided graphic(s) (${wz(p)}).`),null}const o=await this._requireModule(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url));if(fo(o))return o;const a=new o.module.GraphicMoveTool({view:i,enableZ:r.enableZ,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});i.tools.add(a),a.graphics.addMany(e),n||this.updateGraphics.addMany(e);const l=[],c=new Zy({activeComponent:a,tool:s,type:"update",onEnd:()=>{l.forEach(h=>h.remove()),l.length=0,i.tools?.remove(a),a.destroyed||a.destroy()},undo:()=>{YL(c,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},redo:()=>{JL(c,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:h=>{this.updateGraphics.push(h),a.graphics.push(h),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[h],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:h=>{const p=this.updateGraphics.indexOf(h);c.history.undo.forEach(f=>f.updates.splice(p,1)),c.history.redo.forEach(f=>f.updates.splice(p,1)),this.updateGraphics.remove(h),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[h],type:"selection-change"},type:"update"}),this.updateGraphics.length!==0?a.graphics.remove(h):c.complete()},toggleTool:async()=>{if(this.updateGraphics.length!==1||r.toggleToolOnClick===!1||s!=="transform")return;const h=this.updateGraphics.at(0);if(HL(h)!==Zi.SUPPORTED)return;c.onEnd(),c.destroy();const p=await this._setupReshape3DOperation(h,r,i,!0);fo(p)||this._setUpdateOperationHandle(p,r)}});return l.push(...this._getHandlesForComponent(c,r),i.on("immediate-click",h=>this._getCommonUpdateOperationClickHandlers(c,h,r),fs.WIDGET),i.on("key-down",h=>{this._getCommonUpdateOperationKeyDownHandlers(c,h)},fs.WIDGET)),c}_setupGraphicTransform3DOperation(e,r,i,s=!1){if(e.length===1&&Rrt(e[0])===Zi.SUPPORTED){const n=e[0],o=n.geometry;if(o!=null&&(o.type==="point"||o.type==="mesh"))return this._setupPointTransform3DOperation(n,r,i);if(o!=null&&(o.type==="polygon"||o.type==="polyline"))return this._setupPolyTransform3DOperation(n,r,i,s)}return this._setupMove3DOperation(e,r,i,"transform",s)}async _setupPointTransform3DOperation(e,r,i){const s="transform",{enableRotation:n,enableScaling:o,enableZ:a}=r,l=await this._requireModule(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url));if(fo(l))return l;const c=new l.module.GraphicTransformTool({graphic:e,view:i,enableRotation:n,enableScaling:o,enableZ:a,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions});i.tools.add(c),this.updateGraphics.add(e);const h=[],p=new Zy({activeComponent:c,tool:s,type:"update",onEnd:()=>{h.forEach(f=>f.remove()),h.length=0,i.tools?.remove(c),c.destroyed||c.destroy()},undo:()=>{YL(p,this.updateGraphics.toArray()),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:s})},redo:()=>{JL(p,this.updateGraphics.toArray()),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:s})},addToSelection:async f=>{this.updateGraphics.add(f),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[f],removed:[],type:"selection-change"},type:"update"}),p.onEnd(),p.destroy();const m=await this._setupMove3DOperation(this.updateGraphics.toArray(),r,i,"transform",!0);fo(m)||this._setUpdateOperationHandle(m,r)},removeFromSelection:f=>{this.updateGraphics.remove(f),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[f],type:"selection-change"},type:"update"}),p.complete()},toggleTool:()=>{}});return h.push(...this._getHandlesForComponent(p,r),i.on("immediate-click",f=>this._getCommonUpdateOperationClickHandlers(p,f,r),fs.WIDGET),i.on("key-down",f=>{this._getCommonUpdateOperationKeyDownHandlers(p,f)},fs.WIDGET)),p}async _setupPolyTransform3DOperation(e,r,i,s=!1){const n="transform",{enableRotation:o,enableScaling:a,enableZ:l,preserveAspectRatio:c}=r,h=await this._requireModule(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url));if(fo(h))return h;const p=new h.module.ExtentTransformTool({graphic:e,view:i,enableRotation:o,enableScaling:a,enableZ:l,preserveAspectRatio:c,tooltipOptions:this.tooltipOptions});i.tools.add(p),s||this.updateGraphics.add(e);const f=[],m=new Zy({activeComponent:p,tool:n,type:"update",onEnd:()=>{f.forEach(g=>g.remove()),f.length=0,i.tools?.remove(p),p.destroyed||p.destroy()},canUndo:()=>p.canUndo,undo:()=>{p.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},canRedo:()=>p.canRedo,redo:()=>{p.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async g=>{this.updateGraphics.add(g),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[g],removed:[],type:"selection-change"},type:"update"}),m.onEnd(),m.destroy();const _=await this._setupMove3DOperation(this.updateGraphics.toArray(),r,i,"transform",!0);fo(_)||this._setUpdateOperationHandle(_,r)},removeFromSelection:g=>{this.updateGraphics.remove(g),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[g],type:"selection-change"},type:"update"}),m.complete()},toggleTool:async()=>{if(this.updateGraphics.length!==1||r.toggleToolOnClick===!1)return;const g=this.updateGraphics.at(0);if(HL(g)!==Zi.SUPPORTED)return;m.onEnd(),m.destroy();const _=await this._setupReshape3DOperation(g,r,i,!0);fo(_)||this._setUpdateOperationHandle(_,r)}});return f.push(...this._getHandlesForComponent(m,r),i.on("immediate-click",g=>this._getCommonUpdateOperationClickHandlers(m,g,r),fs.WIDGET),i.on("key-down",g=>this._getCommonUpdateOperationKeyDownHandlers(m,g),fs.WIDGET),i.on("key-down",g=>{g.key!==po.constraint||g.repeat||(p.preserveAspectRatio=!p.preserveAspectRatio,g.stopPropagation())},fs.WIDGET),i.on("key-up",g=>{g.key===po.constraint&&(p.preserveAspectRatio=!p.preserveAspectRatio,g.stopPropagation())},fs.WIDGET)),m}async _setupMove2DOperation(e,r,i){const s="move";this.updateGraphics.addMany(e),await this._updateSpatialReference(e);const n=await this._getGraphicMover(e,r,i);if(fo(n))return n;const o=new Zy({activeComponent:n,tool:s,type:"update",onEnd:()=>{this._displayDefaultCursor(),c.forEach(h=>h.remove()),l.forEach(h=>h.remove()),c=[],l=[],n.destroy(),this._internalGraphicsLayer?.removeMany([...this.updateGraphics.toArray()])},undo:()=>{const h=this.updateGraphics.toArray();YL(o,h),o.refreshComponent(),this._emitUndoEvent({graphics:h,tool:s})},redo:()=>{const h=this.updateGraphics.toArray();JL(o,h),o.refreshComponent(),this._emitRedoEvent({graphics:h,tool:s})},addToSelection:async h=>{await this._updateSpatialReference(h),this.updateGraphics.push(h),n.graphics=this.updateGraphics.toArray(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[h],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:h=>{const p=this.updateGraphics.indexOf(h);o.history.undo.forEach(m=>m.updates.splice(p,1)),o.history.redo.forEach(m=>m.updates.splice(p,1)),this.updateGraphics.remove(h);const f=this.updateGraphics.toArray();this.emit("update",{graphics:f,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[h],type:"selection-change"},type:"update"}),this.updateGraphics.length!==0?n.graphics=f:o.complete()}});let a=!1,l=[i.on("immediate-click",h=>this._getCommonUpdateOperationClickHandlers(o,h,r),fs.WIDGET),i.on("key-down",h=>{this._getCommonUpdateOperationKeyDownHandlers(o,h),h.key!==po.constraint||h.repeat||(a=!0,n.enableMoveAllGraphics=!n.enableMoveAllGraphics)},fs.WIDGET),i.on("key-up",h=>{h.key===po.constraint&&a&&(a=!1,n.enableMoveAllGraphics=!n.enableMoveAllGraphics)},fs.WIDGET)],c=this._getHandlesForComponent(o,r);return o}async _setupReshape3DOperation(e,r,i,s=!1){const n="reshape",o=await this._requireModule(J(()=>import("./editingTools-2225b3d0.js"),["./editingTools-2225b3d0.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./getDefaultUnitForView-399249e8.js","./TextOverlayItem-7000102f.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./LineVisualElement-b4960232.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./editPlaneUtils-792f9cea.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js","./dehydratedFeatureComparison-860c6b48.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./manipulatorUtils-27852ca8.js","./Factory-1fcb5e33.js","./GraphicManipulator-bb63ffee.js","./TranslateTooltipInfos-640d1a44.js","./MeshTransform-24e5f7d8.js","./sliceToolUtils-b07a6204.js","./ExtentTooltipInfos-55f12ed9.js"],import.meta.url));if(fo(o))return o;const a=r.reshapeOptions,l=new o.module.GraphicReshapeTool({view:i,graphic:e,enableZVertex:r.enableZ&&a?.vertexOperation==="move",enableZShape:r.enableZ&&a?.shapeOperation==="move",enableMoveGraphic:a?.shapeOperation==="move"||a?.shapeOperation==="move-xy",enableMidpoints:a?.edgeOperation==="split",enableEdgeOffset:a?.edgeOperation==="offset",snappingManager:this._snappingManager,labelOptions:this.labelOptions,tooltipOptions:this.tooltipOptions});i.tools.add(l),s||this.updateGraphics.add(e);const c=[],h=new Zy({activeComponent:l,tool:n,type:"update",onEnd:()=>{c.forEach(p=>p.remove()),c.length=0,i.tools?.remove(l),l.destroyed||l.destroy()},canUndo:()=>l.canUndo,undo:()=>{l.undo(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:n})},canRedo:()=>l.canRedo,redo:()=>{l.redo(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:n})},addToSelection:async p=>{this.updateGraphics.add(p),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[p],removed:[],type:"selection-change"},type:"update"}),h.onEnd(),h.destroy();const f=await this._setupMove3DOperation(this.updateGraphics.toArray(),r,i,"transform",!0);fo(f)||this._setUpdateOperationHandle(f,r)},removeFromSelection:p=>{this.updateGraphics.remove(p),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[p],type:"selection-change"},type:"update"}),h.complete()},toggleTool:async()=>{if(r.toggleToolOnClick===!1)return;h.onEnd(),h.destroy();const p=await this._setupGraphicTransform3DOperation(this.updateGraphics.toArray(),r,i,!0);fo(p)||this._setUpdateOperationHandle(p,r)}});return c.push(...this._getHandlesForComponent(h,r),i.on("immediate-click",p=>this._getCommonUpdateOperationClickHandlers(h,p,r),fs.WIDGET),i.on("key-down",p=>{this._getCommonUpdateOperationKeyDownHandlers(h,p)},fs.WIDGET)),h}async _setupTransformOrReshape2DOperation(e,r,i,s){this.updateGraphics.addMany(e),await this._updateSpatialReference(e);const n=r==="transform"?await this._getBox(e,i,s):await this._getReshape(e,i,s);if(fo(n))return n;const o=new Zy({activeComponent:n,type:"update",onEnd:()=>{l.forEach(c=>c.remove()),a.forEach(c=>c.remove()),l=[],a=[],o.activeComponent&&!o.activeComponent.destroyed&&o.activeComponent.destroy(),this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray())},undo:()=>{YL(o,this.updateGraphics.toArray()),o.refreshComponent(),this._emitUndoEvent({graphics:this.updateGraphics.toArray(),tool:o.tool})},redo:()=>{JL(o,this.updateGraphics.toArray()),o.refreshComponent(),this._emitRedoEvent({graphics:this.updateGraphics.toArray(),tool:o.tool})},addToSelection:async c=>{let h=o.activeComponent;if(h?.type==="reshape"){const p=[...this.updateGraphics,c];this.updateGraphics.removeAll(),o.onEnd(),o.destroy();const f=await this._setupMove2DOperation(p,i,s);if(fo(f))return;this._setUpdateOperationHandle(f,i)}else this.updateGraphics.add(c),h.graphics=this.updateGraphics.toArray(),h.refresh(),o.resetHistory();this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[c],removed:[],type:"selection-change"},type:"update"})},removeFromSelection:async c=>{const h=this.updateGraphics.indexOf(c);o.history.undo.forEach(f=>f.updates.splice(h,1)),o.history.redo.forEach(f=>f.updates.splice(h,1)),this.updateGraphics.remove(c);const p=this.updateGraphics.toArray();if(p.length===0)o.complete();else{const f=p[0].geometry;p.length!==1||f==null||f.type!=="point"&&f.type!=="multipoint"?o.activeComponent.graphics=p:o.toggleTool()}this.emit("update",{graphics:p,state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:[],removed:[c],type:"selection-change"},type:"update"})},toggleTool:async()=>{if(this.updateGraphics.length>1)return;const c=this.updateGraphics.at(0),h=c.geometry;if(h!=null&&(o.tool==="reshape"&&(h.type==="point"||h.type==="multipoint")||o.tool==="transform"&&h.type==="extent"))return;let p=null;o.tool==="transform"?p=await this._getReshape([c],i,s):o.tool==="reshape"&&(p=await this._getBox([c],i,s)),fo(p)||(o.activeComponent?.destroy(),o.activeComponent=p,o.activeComponent&&(l.forEach(f=>f.remove()),l=this._getHandlesForComponent(o,i)))}});let a=[s.on("immediate-click",c=>this._getCommonUpdateOperationClickHandlers(o,c,i),fs.WIDGET),s.on("key-down",c=>{if(this._getCommonUpdateOperationKeyDownHandlers(o,c),c.key===po.constraint&&!c.repeat&&o){const h=o.activeComponent;h&&h.type==="box"&&(h.preserveAspectRatio=!h.preserveAspectRatio)}},fs.WIDGET),s.on("key-up",c=>{if(c.key===po.constraint&&o){const h=o.activeComponent;h&&h.type==="box"&&(h.preserveAspectRatio=!h.preserveAspectRatio)}},fs.WIDGET)],l=this._getHandlesForComponent(o,i);return o}async _getGraphicMover(e,r,i){const{enableMoveAllGraphics:s,highlightOptions:n}=r,o=await this._requireModule(J(()=>import("./GraphicMover-508210c4.js").then(a=>a.G),["./GraphicMover-508210c4.js","./drawUtils-3b7b83b9.js","./GraphicManipulator-bb63ffee.js"],import.meta.url));return fo(o)?o:new o.module.default({enableMoveAllGraphics:s,highlightsEnabled:!!n?.enabled,indicatorsEnabled:!1,graphics:e,view:i,callbacks:{onGraphicMoveStart:({dx:a,dy:l,graphic:c})=>{this._displayGrabbingCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:a,dy:l,mover:c,type:"move-start"},type:"update"})},onGraphicMove:({dx:a,dy:l,graphic:c})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:a,dy:l,mover:c,type:"move"},type:"update"}),onGraphicMoveStop:({dx:a,dy:l,graphic:c})=>{this._displayPointerCursor(),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:a,dy:l,mover:c,type:"move-stop"},type:"update"})},onGraphicPointerOver:()=>this._displayPointerCursor(),onGraphicPointerOut:()=>this._displayDefaultCursor()}})}async _getBox(e,r,i){const{enableRotation:s,enableScaling:n,highlightOptions:o,preserveAspectRatio:a}=r,l=await this._requireModule(J(()=>import("./Box-3a45b7fd.js"),["./Box-3a45b7fd.js","./getDefaultUnitForView-399249e8.js","./drawUtils-3b7b83b9.js","./GraphicMover-508210c4.js","./GraphicManipulator-bb63ffee.js","./settings-a95b40f5.js","./ExtentTooltipInfos-55f12ed9.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./TranslateTooltipInfos-640d1a44.js"],import.meta.url));return fo(l)?l:new l.module.default({graphics:e,enableRotation:s,enableScaling:n,highlightsEnabled:!!o?.enabled,preserveAspectRatio:a,layer:this._internalGraphicsLayer,view:i,tooltipOptions:this.tooltipOptions,callbacks:{onMoveStart:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onMove:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onMoveStop:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onScaleStart:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onScale:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onScaleStop:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onRotateStart:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onRotate:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"}),onRotateStop:c=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...c},type:"update"})}})}async _getReshape(e,r,i){const s=r.reshapeOptions?.edgeOperation==="split",n=r.reshapeOptions?.shapeOperation==="move",o=!!r.highlightOptions?.enabled,a=await this._requireModule(J(()=>import("./Reshape-789d4484.js"),["./Reshape-789d4484.js","./getDefaultUnitForView-399249e8.js","./SnappingVisualizer2D-0ec85274.js","./settings-a95b40f5.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./drawUtils-3b7b83b9.js","./GraphicMover-508210c4.js","./GraphicManipulator-bb63ffee.js","./EditGeometryOperations-36bcef90.js","./automaticLengthMeasurementUtils-caefc58e.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./TranslateTooltipInfos-640d1a44.js","./automaticAreaMeasurementUtils-6d9b4370.js","./euclideanAreaMeasurementUtils-c18253b7.js"],import.meta.url));return fo(a)?a:new a.module.default({enableMidpoints:s,enableMovement:n,graphic:e[0],highlightsEnabled:o,layer:this._internalGraphicsLayer,snappingManager:this._snappingManager,tooltipOptions:this.tooltipOptions,view:i,callbacks:{onReshapeStart:l=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...l},type:"update"}),onReshape:l=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{...l},type:"update"}),onReshapeStop:({mover:l,type:c})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:l,type:c},type:"update"}),onMoveStart:({dx:l,dy:c,mover:h,type:p})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:l,dy:c,mover:h,type:p},type:"update"}),onMove:({dx:l,dy:c,mover:h,type:p})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:l,dy:c,mover:h,type:p},type:"update"}),onMoveStop:({dx:l,dy:c,mover:h,type:p})=>this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:l,dy:c,mover:h,type:p},type:"update"}),onVertexAdd:({added:l,type:c,vertices:h})=>{const p=l.map(f=>vne(f.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{added:p,vertices:h,type:c},type:"update"})},onVertexRemove:({removed:l,type:c,vertices:h})=>{const p=l.map(f=>vne(f.geometry));this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{removed:p,vertices:h,type:c},type:"update"})}}})}_getHandlesForComponent(e,r){const i=e.activeComponent;if(!i)return[];switch(i.type){case"graphic-mover":return[i.on("graphic-click",({graphic:s,viewEvent:n})=>{n.native?.shiftKey&&(n.stopPropagation(),e.removeFromSelection(s))}),i.on("graphic-move-start",s=>e.addToHistory(Hg(s.allGraphics)))];case"box":return[i.on("graphic-click",s=>this._onTransformOrReshape2DGraphicClick(e,r,s)),i.on("move-start",s=>e.addToHistory(Hg(s.graphics))),i.on("rotate-start",s=>e.addToHistory(Hg(s.graphics))),i.on("scale-start",s=>e.addToHistory(Hg(s.graphics)))];case"reshape":return[i.on("graphic-click",s=>this._onTransformOrReshape2DGraphicClick(e,r,s)),i.on("move-start",s=>e.addToHistory(Hg([s.mover]))),i.on("reshape-start",s=>e.addToHistory(Hg([s.graphic]))),i.on("vertex-add",s=>e.addToHistory(Hg([s.oldGraphic]))),i.on("vertex-remove",s=>e.addToHistory(Hg([s.oldGraphic])))];case"move-3d":return[i.on("graphic-move-start",s=>{e.addToHistory(Hg(s.allGraphics)),this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:s.allGraphics.length>0?s.allGraphics[0]:null,type:"move-start"},type:"update"})}),i.on("graphic-move",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:s.dx,dy:s.dy,mover:s.allGraphics.length>0?s.allGraphics[0]:null,type:"move"},type:"update"})}),i.on("graphic-move-stop",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{dx:0,dy:0,mover:s.allGraphics.length>0?s.allGraphics[0]:null,type:"move-stop"},type:"update"})}),i.on("immediate-click",s=>{s.shiftKey?this._toggleSelection([s.graphic],e,r):e.toggleTool()})];case"transform-3d":return[i.on("record-undo",({record:s})=>{e.addToHistory({updates:[s]})}),i.on("graphic-translate-start",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,dx:s.dxScreen,dy:s.dyScreen,type:"move-start"},type:"update"})}),i.on("graphic-translate-stop",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,dx:s.dxScreen,dy:s.dyScreen,type:"move-stop"},type:"update"})}),i.on("graphic-rotate-start",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,angle:s.angle,type:"rotate-start"},type:"update"})}),i.on("graphic-rotate-stop",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,angle:s.angle,type:"rotate-stop"},type:"update"})}),i.on("graphic-scale-start",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,xScale:s.xScale,yScale:s.yScale,type:"scale-start"},type:"update"})}),i.on("graphic-scale-stop",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,xScale:s.xScale,yScale:s.yScale,type:"scale-stop"},type:"update"})}),i.on("graphic-translate",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,dx:s.dxScreen,dy:s.dyScreen,type:"move"},type:"update"})}),i.on("graphic-rotate",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,angle:s.angle,type:"rotate"},type:"update"})}),i.on("graphic-scale",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:{mover:s.graphic,xScale:s.xScale,yScale:s.yScale,type:"scale"},type:"update"})}),i.on("immediate-click",s=>{s.shiftKey?this._toggleSelection([s.graphic],e,r):e.toggleTool()})];case"reshape-3d":return[i.on("reshape",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:s,type:"update"})}),i.on("move",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:s,type:"update"})}),i.on("vertex-add",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:s,type:"update"})}),i.on("vertex-remove",s=>{this.emit("update",{graphics:this.updateGraphics.toArray(),state:"active",aborted:!1,tool:this.activeTool,toolEventInfo:s,type:"update"})}),i.on("immediate-click",s=>{s.shiftKey?this._toggleSelection([s.graphic],e,r):e.toggleTool()})]}}_onTransformOrReshape2DGraphicClick(e,r,i){const{graphic:s,viewEvent:n}=i;return n.native?.shiftKey&&s.layer===this.layer?(n.stopPropagation(),e.removeFromSelection(s)):r.toggleToolOnClick?(n.stopPropagation(),e.toggleTool()):void 0}_setUpdateOperationHandle(e,r){this._operationHandle=e;const i=this.view?.map;this._disablePopup(r);const s=()=>{if(e===this._operationHandle){const n=this.updateGraphics.toArray(),o=this._operationHandle.tool;this._operationHandle.destroy(),this._operationHandle=null,this._internalGraphicsLayer.removeMany(this.updateGraphics.toArray()),this.updateGraphics.removeAll(),i&&i.remove(this._internalGraphicsLayer),this._restorePopup(r),this.emit("update",{graphics:n,state:"complete",aborted:e.cancelled,tool:o,toolEventInfo:null,type:"update"})}};e.on("complete",s)}async _getCommonUpdateOperationClickHandlers(e,r,i){const s=hd(r),n=await r.async(()=>this._getFirstHit(s));if(n==null)return void e.complete();if(r.native.shiftKey&&this._toggleSelection([n.graphic],e,i))return void r.stopPropagation();this.updateGraphics.includes(n.graphic)?r.stopPropagation():e.complete()}_toggleSelection(e,r,i){const s=!!i.multipleSelectionEnabled;return e.some(n=>n!=null&&!(!s||n.layer!==this.layer)&&(this.updateGraphics.includes(n)?r.removeFromSelection(n):r.addToSelection(n),!0))}_getCommonUpdateOperationKeyDownHandlers(e,r){if(!e)return;const i=r.key;i===po.undo&&e.canUndo()?(r.stopPropagation(),e.undo()):i===po.redo&&e.canRedo()?(r.stopPropagation(),e.redo()):i===po.cancel?(r.stopPropagation(),e.cancel()):this.allowDeleteKey&&po.delete.includes(i)&&this._onDeleteKey(r)}_onDeleteKey(e){if(!this._operationHandle||this._operationHandle.type!=="update")return;const r=this.activeComponent,i=this.updateGraphics.toArray();r!=null&&r.type!=="reshape-3d"&&(r.type!=="reshape"||i.length===1&&i[0].geometry?.type==="point")&&(e.stopPropagation(),this.delete())}_removeDefaultLayer(){this._internalGraphicsLayer&&(this.view?.map?.remove(this._internalGraphicsLayer),this._internalGraphicsLayer=Re(this._internalGraphicsLayer))}_isComponentGraphic(e){const{activeComponent:r}=this;return!(!e||r==null)&&(e.attributes&&e.attributes.esriSketchTool||r.type==="draw-2d"&&r.graphic===e||(r.type==="box"||r.type==="reshape")&&r.isUIGraphic(e))}_displayPointerCursor(){this.view&&this.view.container&&this.view.cursor!=="pointer"&&(this.view.cursor="pointer")}_displayGrabbingCursor(){this.view&&this.view.container&&this.view.cursor!=="grabbing"&&(this.view.cursor="grabbing")}_displayDefaultCursor(){this.view&&this.view.container&&this.view.cursor!==null&&(this.view.cursor=null)}_logError(e,r,i){K.getLogger(this).error(new D(e,r,i))}async _requireModule(e){const r=new AbortController;this._moduleLoaderAbortController=r;const i=await e;return this._moduleLoaderAbortController!==r||r.signal.aborted?{requireError:"aborted"}:{module:i}}_emitUndoEvent(e){this.emit("undo",{...e,type:"undo"})}_emitRedoEvent(e){this.emit("redo",{...e,type:"redo"})}_emitDeleteEvent(e){this.emit("delete",{...e,type:"delete"})}get test(){return{operationHandle:this._operationHandle,defaultUpdateOptions:eR}}wait(){return Pn(()=>!this.updating)}_beginAsyncOperation(){this._numUpdating+=1,this.notifyChange("updating")}_endAsyncOperation(){this._numUpdating-=1,this.notifyChange("updating")}_disablePopupEnabled(e){return this.view?.type!=="3d"||this.updateOnGraphicClick||(e?.toggleToolOnClick??!1)}_disablePopup(e){this._disablePopupEnabled(e)&&this.view&&this._originalPopupEnabled==null&&(this._originalPopupEnabled=this.view.popupEnabled,this.view.popupEnabled=!1)}_restorePopup(e){this._disablePopupEnabled(e)&&this.view&&this._originalPopupEnabled!=null&&(this.view.popupEnabled=this._originalPopupEnabled,this._originalPopupEnabled=null)}async _waitViewReady(){const e=this.view;e?(Do(this._viewReadyAbortController),this._viewReadyAbortController=new AbortController,await gT(Pn(()=>e?.ready),this._viewReadyAbortController.signal)):this._logMissingView()}_logMissingView(){this._logError("sketch:missing-property",dce("view"))}_logMissingLayer(){this._logError(sst,dce("layer"))}};u([d()],Ts.prototype,"updating",null),u([d()],Ts.prototype,"_operationHandle",void 0),u([d({readOnly:!0})],Ts.prototype,"activeTool",null),u([d()],Ts.prototype,"activeFillSymbol",void 0),u([d()],Ts.prototype,"activeLineSymbol",void 0),u([d()],Ts.prototype,"activeVertexSymbol",void 0),u([d()],Ts.prototype,"allowDeleteKey",void 0),u([d({readOnly:!0})],Ts.prototype,"createGraphic",null),u([d()],Ts.prototype,"defaultCreateOptions",null),u([d()],Ts.prototype,"defaultUpdateOptions",null),u([d({type:RCe,nonNullable:!0})],Ts.prototype,"labelOptions",void 0),u([d()],Ts.prototype,"layer",void 0),u([d({types:uf})],Ts.prototype,"pointSymbol",void 0),u([d({types:uf})],Ts.prototype,"polygonSymbol",void 0),u([d({types:uf})],Ts.prototype,"polylineSymbol",void 0),u([d()],Ts.prototype,"meshSymbol",void 0),u([d({type:rte,nonNullable:!0})],Ts.prototype,"snappingOptions",null),u([d()],Ts.prototype,"_snappingManager",void 0),u([d({readOnly:!0})],Ts.prototype,"state",null),u([d({type:MCe,nonNullable:!0})],Ts.prototype,"tooltipOptions",void 0),u([d({readOnly:!0})],Ts.prototype,"updateGraphics",void 0),u([d()],Ts.prototype,"updateOnGraphicClick",void 0),u([d({types:uf})],Ts.prototype,"vertexSymbol",void 0),u([d({value:null})],Ts.prototype,"view",null),Ts=u([R("esri.widgets.Sketch.SketchViewModel")],Ts);const sst="sketch:missing-property",dce=t=>`Property '${t}' is missing on SketchViewModel.`;function nst(t){return t==="polygon"||t==="rectangle"||t==="circle"}function YL(t,e){OAe("undo",t.history.undo,t.history.redo,e)}function JL(t,e){OAe("redo",t.history.redo,t.history.undo,e)}function OAe(t,e,r,i){const s=e.pop();if(!s)return;const n=s.updates,o=[];i.forEach((a,l)=>{const c=n[l];c!=null&&("geometry"in c&&c.geometry!=null&&(o.push({geometry:a.geometry}),a.geometry=c.geometry),"symbol"in c&&c.symbol!=null&&(o.push({symbol:a.symbol}),a.symbol=c.symbol),"undo"in c&&(o.push(c),c[t](a)))}),r.push({updates:o})}function Hg(t){return{updates:t.map(e=>({geometry:e.geometry}))}}function fo(t){return"requireError"in t&&t.requireError==="aborted"}const ost=Ts,RAe="esri.widgets.Editor.EditorViewModel",B3=K.getLogger(RAe),MAe=["create","create-features","update"];function qg(t,e,r){B3.error(new D(t,e,r))}function ast(t,e){return t?t.find(r=>r.layer===e):void 0}let pi=class extends Oc(Xr.EventedAccessor){constructor(e){super(e),this._editableItems=new Ke,this._sketchGraphicsLayer=new rCe({listMode:"hide",internal:!0}),this._updateEditableItemsTask=null,this.activeWorkflow=null,this._activityQueue=[],this.failures=[],this.attachmentsViewModel=new OK({capabilities:{editing:!0}}),this.featureFormViewModel=new gEe,this.featureTemplatesViewModel=new WW,this.sketchViewModel=new ost({layer:this._sketchGraphicsLayer}),this.spinnerViewModel=new Fee,this.pageStack=[],this.showDiscardEditsPrompt=()=>Promise.resolve(!0),this._candidateCommitted=!1,this.useDeprecatedCreateWorkflow=!1,this.back=async()=>{this.canGoBack&&(this.activeWorkflow?.hasPreviousStep?await this.activeWorkflow.back(this.showDiscardEditsPrompt):await this._cancelWorkflow({force:!this.hasPendingEdits}))},this.saveWorkflow=async()=>{const{featureFormViewModel:r}=this;if(r.submit(),!r.submittable)return;const i=r.getValues();r.validateContingencyConstraints(i,{includeIncompleteViolations:!0}).length>0||await this.activeWorkflow?.save()},this.selectFeature=(r,i=!1)=>{const s=this.activeWorkflow;this._candidateCommitted||s?.type!=="update"||(s.data.rootFeature=r,i&&(s.next(),this._candidateCommitted=!0))}}initialize(){this.addHandles([Q(()=>{const e=this.view?.map?.editableLayers.filter(({parent:s,visible:n})=>s&&"visible"in s?n&&s.visible:n),r=this.view?.allLayerViews,i=r?.filter(s=>!!e?.includes(s.layer)&&!s.suspended);return[e,i,this.layerInfos,this.allowedWorkflows]},()=>this._updateEditableItems(),xt),Vs(()=>this.activeWorkflow,"cancel",()=>this.emit("workflow-cancel")),Vs(()=>this.activeWorkflow,"commit",()=>this.emit("workflow-commit")),Vs(()=>this.activeWorkflow,"complete",()=>{this.emit("workflow-commit"),this._set("activeWorkflow",null)}),No(()=>this.view?.map,e=>e.add(this._sketchGraphicsLayer),xt),Q(()=>this._editableItems.toArray(),()=>{const{activeWorkflow:e}=this;if(this.refreshCreationTemplates(),!e)return;const{stepId:r}=e;e.type!=="create"?e.type==="update"&&(r==="awaiting-feature-to-update"&&!this.canUpdate||r==="awaiting-update-feature-candidate"&&!e.data.candidates.some(i=>{const s=this._editableItems.find(n=>n.layer===i.layer);return s&&s.supports.includes("update")}))&&this._cancelWorkflow():r!=="awaiting-feature-creation-info"||this.canCreate||this._cancelWorkflow()}),Q(()=>this.page,(e,r)=>{const i=this.pageStack.slice(),s=i.indexOf(e);s===-1&&r?i.push(r):i.splice(s),this.pageStack=i}),No(()=>this.state==="awaiting-update-feature-candidate",()=>this._candidateCommitted=!1),Vs(()=>this.featureTemplatesViewModel,"select",async({item:e,oldItem:r})=>{const{activeWorkflow:i}=this,s=!!e&&e.id===r?.id,n=i?.type==="create-features"&&i.data.upload?.error;if(i)try{await this.cancelWorkflow({force:!this.hasPendingEdits})}catch{return this.featureTemplatesViewModel.select(r,{emit:!1})}if(!e||s&&!n)return;const o={layer:e.layer,template:e.template};if(e.supportsUpload)return this.startCreateFeaturesWorkflow(o);this.useDeprecatedCreateWorkflow?this.startCreateWorkflowAtFeatureCreation(o):this.startCreateFeaturesWorkflowAtFeatureCreation(o)}),Vs(()=>this.view,"key-down",e=>{e.key==="Escape"&&this.activeWorkflow?.keyboardCancellationEnabled&&this.back()})])}destroy(){this._cancelWorkflow().then(()=>{this.view?.map&&this.view.map.remove(this._sketchGraphicsLayer),this.view=null}),this._updateEditableItemsTask=Do(this._updateEditableItemsTask)}get allowedWorkflows(){return this._get("allowedWorkflows")}set allowedWorkflows(e){e&&e.length!==0||(e=[...MAe]),this._set("allowedWorkflows",e)}get canCreate(){return this._editableItems.some(e=>e.supports.includes("create"))}get canUpdate(){return this._editableItems.some(({attachmentsOnUpdateEnabled:e,layer:r,supports:i})=>{const s=i.includes("update")||i.includes("delete")||e,n=r.parent,o=!(n&&"visible"in n)||!!n.visible;return r.visible&&o&&s})}get editableItems(){return this._editableItems}get labelOptions(){return this.sketchViewModel.labelOptions}set labelOptions(e){this.sketchViewModel.labelOptions=e}set layerInfos(e){e?.some(r=>("allowAttachments"in r&&z1(B3,"Property: layerInfo.allowAttachments",{replacement:"layerInfo.attachmentsOnCreateEnabled or layerInfo.attachmentsOnUpdateEnabled",version:"4.26"}),!0)),this._set("layerInfos",e)}get snappingOptions(){return this.sketchViewModel.snappingOptions}set snappingOptions(e){this.sketchViewModel.snappingOptions=e}get state(){if(!this.get("view.ready")||this._editableItems.length===0)return"disabled";const e=this.attachmentsViewModel.mode;if(e==="add")return"adding-attachment";if(e==="edit")return"editing-attachment";const{activeWorkflow:r}=this;return r?r.stepId:"ready"}get syncing(){return this._activityQueue.length>0}get updating(){return this.updatingHandles.updating}get tooltipOptions(){return this.sketchViewModel.tooltipOptions}set tooltipOptions(e){this.sketchViewModel.tooltipOptions=e}set view(e){this.sketchViewModel.view=e,this.spinnerViewModel.view=e,this._set("view",e)}get page(){const{activeWorkflow:e,state:r}=this;return r==="awaiting-feature-to-update"||r==="awaiting-feature-to-create"||e?.type==="create-features"&&e.numPendingFeatures===0?"ready":r??"disabled"}get selectedTemplateItem(){const{activeWorkflow:e}=this;if(e?.type==="create-features"&&e.numPendingFeatures===0){const r=e.data.creationInfo?.template;if(!r)return;for(const i of this.featureTemplatesViewModel.items)if("findByTemplate"in i){const s=i.findByTemplate(r);if(s)return s}else if(i.template===r)return i}}get featureFormDisabled(){const{activeWorkflow:e}=this;return e?.type==="update"&&e.activeEditableItem?.attributeUpdatesEnabled===!1}get canGoBack(){return this.activeWorkflow!=null&&!this.syncing}get shouldShowDeleteButton(){const{activeWorkflow:e}=this;return!!e&&e.type==="update"&&!!e.activeEditableItem?.supports.includes("delete")}get hasPendingEdits(){return this.activeWorkflow?.hasPendingEdits??!1}async startCreateWorkflowAtFeatureTypeSelection(){if(MC(B3,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),await Pn(()=>!this.updating),!this.canCreate)return void qg("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createCreateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.startCreateFeaturesWorkflow()}async startCreateWorkflowAtFeatureCreation(e){if(MC(B3,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),await Pn(()=>!this.updating),!this.canCreate)return void qg("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const r=this._createCreateWorkflow("awaiting-feature-to-create");r.data.creationInfo=e,await r.start(),this._set("activeWorkflow",r)}async startCreateFeaturesWorkflowAtFeatureCreation(e){return this.startCreateFeaturesWorkflow(e,"creating-features")}async startCreateFeaturesWorkflow(e,r="awaiting-feature-creation-info"){if(await Pn(()=>!this.updating),!this.canCreate)throw new D("editing:unsupported-workflow","Creating features is unsupported or disabled.");await this._cancelWorkflow();const i=this._createCreateFeaturesWorkflow(e,r);await i.start(),this._set("activeWorkflow",i)}async startCreateWorkflowAtFeatureEdit(e){if(MC(B3,"startCreateWorkflowAtFeatureEdit"),await Pn(()=>!this.updating),!this.canCreate)return void qg("editing:unsupported-workflow","Create workflow is unsupported or disabled.");await this._cancelWorkflow();const r=this._createCreateWorkflow("editing-new-feature");r.data.edits.feature=e,await r.start(),this._set("activeWorkflow",r)}async startUpdateWorkflowAtFeatureSelection(){if(await Pn(()=>!this.updating),!this.canUpdate)return void qg("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const e=this._createUpdateWorkflow();await e.start(),this._set("activeWorkflow",e)}async startUpdateWorkflowAtMultipleFeatureSelection(e){if(await Pn(()=>!this.updating),!this.canUpdate)return void qg("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const r=this._createUpdateWorkflow("awaiting-update-feature-candidate");r.data.candidates=e,await r.start(),this._set("activeWorkflow",r)}async startUpdateWorkflowAtFeatureEdit(e){if(await Pn(()=>!this.updating),!this.canUpdate)return void qg("editing:unsupported-workflow","Update workflow is unsupported or disabled.");await this._cancelWorkflow();const r=this._createUpdateWorkflow("editing-existing-feature");r.data.rootFeature=e,await r.start(),this._set("activeWorkflow",r)}async deleteFeatureFromWorkflow(){const{activeWorkflow:e}=this;e&&e.type==="update"?await e.deleteActiveFeature():qg("editing:unsupported-workflow","Deleting requires an active update workflow.")}async cancelWorkflow(e){return this._cancelWorkflow({warn:!0,...e})}findEditableItemForLayer(e){const r=e.type==="subtype-sublayer"?e.parent:e;return this._editableItems.find(i=>i.layer===r)}itemHasInvalidFormTemplate(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasInvalidFormTemplate??!1)}itemHasUnsupportedFields(e){return!!e&&(this.findEditableItemForLayer(e.layer)?.hasUnsupportedFields??!1)}refreshCreationTemplates(){const e=[];for(const{layer:r,supports:i}of this._editableItems)r.loaded&&i.includes("create")&&e.push(r);this.featureTemplatesViewModel.layers=e}async toggleUpdateWorkflow(){this.canUpdate&&(this.hasPendingEdits&&!await this.showDiscardEditsPrompt()||(this.activeWorkflow&&this.state==="awaiting-feature-to-update"?await this.cancelWorkflow({force:!0}):await this.startUpdateWorkflowAtFeatureSelection()))}async _updateEditableItems(){Do(this._updateEditableItemsTask);const e=hb(async r=>{const i=this.view?.allLayerViews,s=this.view?.map,n=s?.editableLayers.toArray()??[],o=s?.allTables.toArray().filter(Hxe)??[];await Promise.all(o.map(f=>f.load()));const a=o.filter(f=>uV(f)),l=[...n.reverse(),...a.reverse()].filter(f=>f.geometryType!=="mesh"||this.view?.type==="3d");if(!i||!n)return;const c=[],h=[];for(const f of l){const m=i.find(_=>_.layer===f),g=m?c:h;if(f.type==="subtype-group"){await f.loadAll(),Dt(r);for(let _=f.sublayers.length-1;_>=0;--_)g.push(this._makeEditableItemForLayer(f.sublayers.at(_),!!m?.suspended))}else g.push(this._makeEditableItemForLayer(f,!!m?.suspended))}if(r.aborted)return;const p=this._editableItems;this._editableItems=new Ke(c.concat(h)),p.destroy()});this.updatingHandles.addPromise(e.promise),this._updateEditableItemsTask=e}async _cancelWorkflow(e){const r=this.activeWorkflow;if(!r)return void(e&&e.warn&&qg("editing:no-active-workflow","There is no active workflow to cancel."));if(!e||e.force!==!1)return this.emit("workflow-cancel"),this._set("activeWorkflow",null),void await r.cancel(e);await r.cancel(e),this._set("activeWorkflow",null)}_createCreateFeaturesWorkflow(e,r){return yCe.create({viewModel:this,creationInfo:e,startAt:r,applyEditsCallback:(i,s,n)=>this._applyEdits(i,s,n),addAttachmentsCallback:(i,s)=>this._addAttachments(i,s)})}_createCreateWorkflow(e){return hrt.create(this,e,(r,i,s)=>this._applyEdits(r,i,s))}_createUpdateWorkflow(e){return yrt.create(this,e,(r,i)=>this._applyEdits(r,i))}_addAttachments(e,r){const i=r.map(s=>this._addAttachment(e,s.feature,s.attachment))??[];return Promise.all(i)}async _addAttachment(e,r,i){let s=null;if(e.type==="geojson"||e.type==="scene"||e.type==="oriented-imagery")throw new D("editor:attachments-not-supported","Adding attachments is not supported for this layer type");return await this._queueOperation(async()=>(s=await e.addAttachment?.(r,i).catch(n=>{throw n?.error||n})??null,s)),s}async _applyEdits(e,r,i){let s=null;const n=e.url?await EK(e.url):null,o={returnServiceEditsOption:(!n||!zj(n))&&!RegExp("/hosted/","i").test(e.url)?"original-and-current-features":void 0,...i};return await this._queueOperation(async()=>{const a=await oP(this.view,e).catch(()=>null);return s=await e.applyEdits(r,o),a&&await Pn(()=>!a.updating),s}),s}_queueOperation(e){this._activityQueue.push(e),this.notifyChange("syncing");const r=(i,s)=>{const n=s.indexOf(i);n>-1&&s.splice(n,1)};return e().then(i=>{if("error"in i&&i.error)throw i.error;if("addFeatureResults"in i){const{addFeatureResults:s,deleteFeatureResults:n,updateFeatureResults:o}=i,a=s.find(l=>!!l.error)||o.find(l=>!!l.error)||n.find(l=>!!l.error);if(a)throw a.error}return i}).catch(i=>{qg("editing:operation-error","An error occurred.",{error:i});const s={error:i,retry:()=>(r(s,this.failures),this._queueOperation(e)),cancel:()=>{r(s,this.failures)}};this._set("failures",[...this.failures,s])}).then(()=>{r(e,this._activityQueue),this.notifyChange("syncing")})}_makeEditableItemForLayer(e,r=!0){const i=vg(e),s=i?.operations,n=ast(this.layerInfos,e),o=iqe(e),a=e.fields.some(({type:S})=>JHe.has(S)),l=o||a,{allowedWorkflows:c}=this,h=c.includes("create")||c.includes("create-features"),p=c.includes("update"),f=S=>!n||n.enabled!==!1&&n[S]!==!1,m=h&&!!s?.supportsAdd&&f("addEnabled"),g=p&&!!s?.supportsUpdate&&f("updateEnabled"),_=!l&&p&&!!s?.supportsDelete&&f("deleteEnabled"),v=[];r||(m&&v.push("create"),g&&v.push("update"),_&&v.push("delete"));const b=g&&!l&&(!n||n.attributeUpdatesEnabled!==!1),x=g&&!l&&!!i?.editing?.supportsGeometryUpdate&&(!n||n.geometryUpdatesEnabled!==!1),T=!(!i?.data?.supportsAttachment||n&&n.allowAttachments===!1);return{layer:e,supports:v,attributeUpdatesEnabled:b,geometryUpdatesEnabled:x,hasAttachments:T,attachmentsOnCreateEnabled:T&&h&&(!n||n.attachmentsOnCreateEnabled!==!1),attachmentsOnUpdateEnabled:!l&&T&&(!n||n.attachmentsOnUpdateEnabled!==!1),hasInvalidFormTemplate:o,hasUnsupportedFields:a}}};u([d()],pi.prototype,"_editableItems",void 0),u([d({readOnly:!0})],pi.prototype,"activeWorkflow",void 0),u([d({readOnly:!0})],pi.prototype,"_activityQueue",void 0),u([d({value:[...MAe]})],pi.prototype,"allowedWorkflows",null),u([d({readOnly:!0})],pi.prototype,"canCreate",null),u([d({readOnly:!0})],pi.prototype,"canUpdate",null),u([d()],pi.prototype,"editableItems",null),u([d({readOnly:!0})],pi.prototype,"failures",void 0),u([d()],pi.prototype,"attachmentsViewModel",void 0),u([d()],pi.prototype,"featureFormViewModel",void 0),u([d()],pi.prototype,"featureTemplatesViewModel",void 0),u([d()],pi.prototype,"labelOptions",null),u([d()],pi.prototype,"layerInfos",null),u([d()],pi.prototype,"sketchViewModel",void 0),u([d()],pi.prototype,"snappingOptions",null),u([d()],pi.prototype,"spinnerViewModel",void 0),u([d()],pi.prototype,"state",null),u([d({readOnly:!0})],pi.prototype,"syncing",null),u([d()],pi.prototype,"updating",null),u([d()],pi.prototype,"tooltipOptions",null),u([d()],pi.prototype,"view",null),u([d()],pi.prototype,"pageStack",void 0),u([d()],pi.prototype,"showDiscardEditsPrompt",void 0),u([d()],pi.prototype,"_candidateCommitted",void 0),u([d()],pi.prototype,"page",null),u([d()],pi.prototype,"selectedTemplateItem",null),u([d()],pi.prototype,"featureFormDisabled",null),u([d()],pi.prototype,"canGoBack",null),u([d()],pi.prototype,"shouldShowDeleteButton",null),u([d()],pi.prototype,"hasPendingEdits",null),u([d()],pi.prototype,"useDeprecatedCreateWorkflow",void 0),pi=u([R(RAe)],pi);const lst=pi,IAe={hide:"hide",hideChildren:"hide-children"};function Jk(t){if(t)return t.listMode!=null?t.listMode:void 0}function cst(t){if(t)return t.minScale!=null?t.minScale:void 0}function ust(t){if(t)return t.maxScale!=null?t.maxScale:void 0}function hst(t){if(!t)return"inherited";const e=t.get("layer.capabilities.exportMap.supportsSublayerVisibility");if(typeof e=="boolean")return e?"independent":"inherited";const r=t.get("capabilities.exportMap.supportsSublayerVisibility");return typeof r=="boolean"?r?"independent":"inherited":t.visibilityMode!=null?t.visibilityMode:"independent"}function PAe(t){if(t&&(!("type"in t)||t.type!=="wmts")&&t.listMode!==IAe.hideChildren)return"sublayers"in t?"sublayers":"layers"in t?"layers":void 0}function ite(t){return Jk(t)!==IAe.hide}function dst(t,e){if(!t||isNaN(e))return!1;const r=cst(t),i=ust(t),s=r!=null&&!isNaN(r)&&r>0&&e>r,n=i!=null&&!isNaN(i)&&i>0&&e<i;return s||n}function pce(t){const e=t?.layer;return e&&"layers"in e?e.layers:null}function pst(t){const e=fst(t)?t:null,r=t?.parent,i=r?.type==="map-image"?e?.source:null,s="";return i&&r?{layer:r,title:s,sublayerIds:[i.mapLayerId]}:{layer:t,title:s}}function fst(t){return!!t?.layer}var lZ;let fv=lZ=class extends s${constructor(t){super(t),this.displayValueEnabled=!1,this.max=1,this.min=0,this.step=.1,this.type="slider",this.value=null}clone(){return new lZ({active:this.active,className:this.className,disabled:this.disabled,id:this.id,indicator:this.indicator,title:this.title,visible:this.visible,displayValueEnabled:this.displayValueEnabled,max:this.max,min:this.min,step:this.step,value:this.value})}};u([d()],fv.prototype,"displayValueEnabled",void 0),u([d()],fv.prototype,"max",void 0),u([d()],fv.prototype,"min",void 0),u([d()],fv.prototype,"step",void 0),u([d()],fv.prototype,"value",void 0),fv=lZ=u([R("esri.support.Action.ActionSlider")],fv);const mst=fv;function Hm(){return function(t,e){if(!t[e])throw new TypeError(`Cannot auto bind undefined function '${String(e)}'`);return{value:yst(t[e])}}}function gst(t){const e=t?.type;return t instanceof KeyboardEvent||e==="keyup"||e==="keydown"||e==="keypress"}function yst(t){return function(e,...r){gst(e)?kBe(e.key)&&(e.preventDefault(),e.stopPropagation(),e.target.click()):t.call(this,e,...r)}}const $Ae="calcite-mode-";function _st(){return getComputedStyle(document.body).getPropertyValue("--esri-calcite-mode-name").replaceAll(/\s|'|"/g,"")}function vst(){return _st().startsWith("dark")}function bst(){return`${$Ae}${vst()?"dark":"light"}`}function wst(t){xst(t),t.classList.add(bst())}function xst(t){Array.from(t.classList).forEach(e=>{e.startsWith($Ae)&&t.classList.remove(e)})}function cZ(t){return t&&typeof t.render=="function"}function gVt(t){return t&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}const LAe="esri-layer-list-panel",tR=`${LAe}__content`,Wg={base:LAe,content:tR,contentLegend:`${tR}--legend`,contentString:`${tR}--string`,contentElement:`${tR}--html-element`,contentWidget:`${tR}--widget`},Tst="legends";let Qh=class extends aS(Rc){constructor(e,r){super(e,r),this._legend=null,this.content=null,this.image=null,this.listItem=null,this.open=!1,this.visible=!0}initialize(){this.addHandles(Q(()=>this.content,e=>this._createLegend(e),xt))}destroy(){this._legend=Re(this._legend)}get className(){const{image:e}=this,r=this._getFirstWidget();return this._get("className")||(!e&&r?r.iconClass??"":"")}set className(e){this._override("className",e)}get disabled(){const{listItem:e,_legend:r,content:i}=this;return!e||!(Array.isArray(i)&&i.length>1)&&!!r&&(!r.activeLayerInfos?.length||!e.visibleAtCurrentScale||!e.visible)}set disabled(e){this._overrideIfSome("disabled",e)}get title(){const e=this._getFirstWidget();return this._get("title")||(e?.label??"")}set title(e){this._override("title",e)}render(){return j("div",{class:Wg.base},this._renderContents())}_renderContent(e){const{_legend:r,disabled:i}=this;return!e||i?null:e==="legend"&&r?j("div",{class:this.classes(Wg.content,Wg.contentLegend),key:r},r.render()):typeof e=="string"?j("div",{class:this.classes(Wg.content,Wg.contentString),key:e,innerHTML:e}):cZ(e)?j("div",{class:this.classes(Wg.content,Wg.contentWidget),key:e},e.render()):e instanceof HTMLElement?j("div",{class:this.classes(Wg.content,Wg.contentElement),key:e,bind:e,afterCreate:this._attachToNode}):null}_renderContents(){const{content:e}=this;return Array.isArray(e)?e.map(r=>this._renderContent(r)):this._renderContent(e)}_getLegendOptions(){const{listItem:e}=this;if(!e)return{};const{layer:r,view:i}=e;return r&&i?{view:i,layerInfos:[pst(r)]}:{}}async _createLegend(e){if(!this._hasLegend(e)||this._legend)return;const{default:r}=await J(()=>import("./Legend-9a3c2e19.js"),["./Legend-9a3c2e19.js","./ExportImageParameters-68b39ab3.js","./floorFilterUtils-73949d2d.js","./sublayerUtils-0d3cd1fc.js","./pixelRangeUtils-04f58c28.js","./rendererConversion-fa3e158c.js","./utils-57c6a919.js"],import.meta.url),{listItem:i}=this,s=new r(this._getLegendOptions());this._legend=s,this.notifyChange("className"),this.notifyChange("title");const n=Q(()=>[i?.view,i?.layer,i?.layer?.source,i?.layer?.parent],()=>this._updateLegend(s),xt);this.addHandles(n,Tst),this.scheduleRender()}_hasLegend(e){const r="legend";return e===r||e!=null&&!!Array.isArray(e)&&e.includes(r)}_attachToNode(e){e.appendChild(this)}_updateLegend(e){e.set(this._getLegendOptions()),this.scheduleRender()}_getWidget(e){return e==="legend"?this._legend:cZ(e)?e:null}_getFirstWidget(){const{content:e}=this;if(Array.isArray(e)){let r=null;return e.some(i=>{const s=this._getWidget(i);return s&&(r=s),!!s}),r}return this._getWidget(e)}};u([d()],Qh.prototype,"_legend",void 0),u([d()],Qh.prototype,"className",null),u([d()],Qh.prototype,"content",void 0),u([d()],Qh.prototype,"disabled",null),u([d()],Qh.prototype,"image",void 0),u([d()],Qh.prototype,"listItem",void 0),u([d()],Qh.prototype,"title",null),u([d()],Qh.prototype,"open",void 0),u([d()],Qh.prototype,"visible",void 0),Qh=u([R("esri.widgets.LayerList.ListItemPanel")],Qh);const DAe=Qh;var G3;const Sst=Ke.ofType({key:"type",defaultKeyValue:"button",base:s$,typeMap:{button:Zwe,toggle:Xwe,slider:mst}}),NAe=Ke.ofType(Sst),QL="layer",Az="child-list-mode",Est="hide",Cst="esri.widgets.LayerList.ListItem";let Ss=G3=class extends aS(Oc(me)){constructor(t){super(t),this.actionsSections=new NAe,this.actionsOpen=!1,this.checkPublishStatusEnabled=!1,this.children=new(Ke.ofType(G3)),this.childrenSortable=!0,this.hidden=!1,this.layer=null,this.layerView=null,this.listItemCreatedFunction=null,this.open=!1,this.panel=null,this.parent=null,this.sortable=!0,this.view=null}initialize(){if(this.handles.add([Q(()=>this.layer,t=>this._watchLayerProperties(t),xt),Q(()=>this.checkPublishStatusEnabled,t=>this._updateChildrenPublishing(t),xt),Q(()=>this.view,t=>this._updateChildrenView(t),xt),Q(()=>this.panel,t=>this._setListItemOnPanel(t),xt),Q(()=>[this.layer,this.view],()=>this._getLayerView(),xt)]),typeof this.listItemCreatedFunction=="function"){const t={item:this};this.listItemCreatedFunction.call(null,t)}}destroy(){this.view=null}get connectionStatus(){const{layerView:t,publishing:e}=this;if(!e&&t&&"connectionStatus"in t)return t.connectionStatus}get error(){return this.layer?.loadError}get incompatible(){const{layerView:t}=this;return!(!t||!("spatialReferenceSupported"in t))&&!t.spatialReferenceSupported}castPanel(t){return this.get("panel.open")&&!t.hasOwnProperty("open")&&(t.open=!0),t?new DAe(t):null}get title(){const t=this.get("layer.layer");return(!t||t&&this.get("layer.layer.loaded"))&&this.get("layer.title")||this.get("layer.attributes.title")||""}set title(t){this._override("title",t)}get publishing(){const{layer:t,checkPublishStatusEnabled:e}=this;return e&&t&&"publishingInfo"in t&&t.publishingInfo?.status==="publishing"}get updating(){const{layerView:t,connectionStatus:e,layer:r,publishing:i}=this;return!i&&!e&&(t?t.updating:r?.loadStatus==="loading"||!1)}get visible(){return this.layer?.visible}set visible(t){const e=this.layer;e&&(e.visible=t)}get visibleAtCurrentScale(){return!dst(this.layer,this.get("view.scale"))}get visibilityMode(){return hst(this.layer)}clone(){return new G3({actionsSections:this.actionsSections.clone(),actionsOpen:this.actionsOpen,checkPublishStatusEnabled:this.checkPublishStatusEnabled,children:this.children.clone(),layer:this.layer,listItemCreatedFunction:this.listItemCreatedFunction,open:this.open,panel:this.panel,title:this.title,view:this.view,visible:this.visible})}_setListItemOnPanel(t){t&&(t.listItem=this)}_updateChildrenPublishing(t){const e=this.children;e&&e.forEach(r=>r.checkPublishStatusEnabled=t)}_updateChildrenView(t){const e=this.children;e&&e.forEach(r=>r.view=t)}_addChildren(t){if(this.handles.remove(Az),this.children.removeAll(),!t)return;t.forEach(r=>{this.handles.add(Q(()=>r.listMode,()=>this._addChildren(t)),Az)});const e=t.filter(r=>Jk(r)!==Est);this.children.addMany(this._makeChildren(e))}_watchSublayerChanges(t){t&&this.handles.add(t.on("change",()=>{this._addChildren(t)}),QL)}_initializeChildLayers(t){this._addChildren(t),this._watchSublayerChanges(t)}_makeChildren(t){return t.map(e=>ite(e)?new G3({layer:e,checkPublishStatusEnabled:this.checkPublishStatusEnabled,listItemCreatedFunction:this.listItemCreatedFunction,parent:this,view:this.view}):null).filter(Ia).reverse()}_watchLayerProperties(t){if(!this.handles||(this.handles.remove(QL),this.handles.remove(Az),!t))return;if(this.handles.add(Q(()=>t.listMode,()=>this._watchLayerProperties(t)),QL),Jk(t)==="hide-children")return void this.children.removeAll();const e=PAe(t);e&&this.handles.add(Q(()=>t[e],r=>{t.hasOwnProperty(e)&&this._initializeChildLayers(r)},xt),QL)}async _getLayerView(){const{layer:t,view:e}=this;if(t&&e)try{const r=await e.whenLayerView(t);if(r.layer!==this.layer)return;this._set("layerView",r)}catch{}}};u([d({type:NAe})],Ss.prototype,"actionsSections",void 0),u([d()],Ss.prototype,"actionsOpen",void 0),u([d()],Ss.prototype,"checkPublishStatusEnabled",void 0),u([d({type:Ke})],Ss.prototype,"children",void 0),u([d()],Ss.prototype,"childrenSortable",void 0),u([d({readOnly:!0})],Ss.prototype,"connectionStatus",null),u([d({readOnly:!0})],Ss.prototype,"error",null),u([d()],Ss.prototype,"hidden",void 0),u([d({readOnly:!0})],Ss.prototype,"incompatible",null),u([d()],Ss.prototype,"layer",void 0),u([d({readOnly:!0})],Ss.prototype,"layerView",void 0),u([d()],Ss.prototype,"listItemCreatedFunction",void 0),u([d()],Ss.prototype,"open",void 0),u([d({type:DAe})],Ss.prototype,"panel",void 0),u([or("panel")],Ss.prototype,"castPanel",null),u([d()],Ss.prototype,"parent",void 0),u([d()],Ss.prototype,"sortable",void 0),u([d()],Ss.prototype,"title",null),u([d({readOnly:!0})],Ss.prototype,"publishing",null),u([d({readOnly:!0})],Ss.prototype,"updating",null),u([d()],Ss.prototype,"view",void 0),u([d()],Ss.prototype,"visible",null),u([d({readOnly:!0})],Ss.prototype,"visibleAtCurrentScale",null),u([d({readOnly:!0})],Ss.prototype,"visibilityMode",null),Ss=G3=u([R(Cst)],Ss);const ste=Ss,dp={view:"view",viewLayers:"view-layers",mapLayers:"map-layers",layerViews:"layer-views",layerListMode:"layer-list-mode"},Ast="hide",FAe=Ke.ofType(ste);let mv=class extends Xr.EventedAccessor{constructor(e){super(e),this.checkPublishStatusEnabled=!1,this.listItemCreatedFunction=null,this.operationalItems=new FAe,this.view=null}initialize(){this.addHandles([Q(()=>[this.view,this.view?.ready],()=>this._viewHandles(),xt),Q(()=>[this.listItemCreatedFunction,this.checkPublishStatusEnabled],()=>this._recompileList())],dp.view)}destroy(){this.removeAllHandles(),this.view=null,this.operationalItems.removeAll()}get state(){const e=this.get("view");return this.get("view.ready")?"ready":e?"loading":"disabled"}triggerAction(e,r){e&&!e.disabled&&this.emit("trigger-action",{action:e,item:r})}moveListItem(e,r,i,s){const n=e?.layer;if(!n)return;const o=this.view?.map?.layers,a=r?pce(r):o,l=i?pce(i):o;if(!a||!l)return;const{operationalItems:c}=this,h=r?.children||c,p=i?.children||c,f=l.length-s;e.parent=i||null,h.includes(e)&&h.remove(e),a.includes(n)&&a.remove(n),p.includes(e)||p.add(e,f),l.includes(n)||l.add(n,f)}_createLayerViewHandles(e){this.removeHandles(dp.layerViews),this._compileList(),e&&this.addHandles(e.on("change",()=>this._compileList()),dp.layerViews)}_createMapLayerHandles(e){this.removeHandles(dp.mapLayers),this._compileList(),e&&this.addHandles(e.on("change",()=>this._compileList()),dp.mapLayers)}_createListItem(e){const{view:r,listItemCreatedFunction:i,checkPublishStatusEnabled:s}=this;return new ste({checkPublishStatusEnabled:s,layer:e,listItemCreatedFunction:i,view:r})}_removeAllItems(){this.operationalItems.removeAll()}_getViewableLayers(e){if(e)return e.filter(r=>Jk(r)!==Ast)}_watchLayersListMode(e){this.removeHandles(dp.layerListMode),e&&e.forEach(r=>{"listMode"in r&&this.addHandles(Q(()=>r.listMode,()=>this._compileList()),dp.layerListMode)})}_compileList(){const e=this.get("view.map.layers");this._watchLayersListMode(e);const r=this._getViewableLayers(e);r&&r.length?(this._createNewItems(r),this._removeItems(r),this._sortItems(r)):this._removeAllItems()}_createNewItems(e){const{operationalItems:r}=this;e.forEach(i=>{r.find(s=>s.layer===i)||r.add(this._createListItem(i))})}_removeItems(e){const{operationalItems:r}=this,i=[];r.forEach(s=>{s&&e&&e.includes(s.layer)||i.push(s)}),r.removeMany(i)}_sortItems(e){const{operationalItems:r}=this;r.sort((i,s)=>{const n=e.indexOf(i.layer),o=e.indexOf(s.layer);return n>o?-1:n<o?1:0})}_recompileList(){this._removeAllItems(),this._compileList()}_viewHandles(){const{view:e}=this;this.removeHandles([dp.mapLayers,dp.layerViews,dp.viewLayers]),this._recompileList(),e&&e.ready&&this.addHandles([Q(()=>this.view?.map?.allLayers,r=>this._createMapLayerHandles(r),xt),Q(()=>this.view?.allLayerViews,r=>this._createLayerViewHandles(r),xt)],dp.viewLayers)}};u([d()],mv.prototype,"checkPublishStatusEnabled",void 0),u([d()],mv.prototype,"listItemCreatedFunction",void 0),u([d({type:FAe})],mv.prototype,"operationalItems",void 0),u([d({readOnly:!0})],mv.prototype,"state",null),u([d()],mv.prototype,"view",void 0),mv=u([R("esri.widgets.LayerList.LayerListViewModel")],mv);const Ost=mv,nte=t=>Rst(t)||Mst(t),Rst=t=>{if(!("type"in t))return!1;switch(t.type){case"feature":case"geojson":case"csv":case"graphics":case"wfs":case"map-notes":case"oriented-imagery":case"scene":case"building-scene":return!0;default:return!1}},Mst=t=>{const e=PAe(t);if(e!=null&&t.hasOwnProperty(e)&&t[e]!=null){for(const r of t[e])if(nte(r))return!0}return!1};var uZ;let Np=uZ=class extends ste{constructor(t){super(t),this.children=new Ke,this.parent=null}get allChildrenEnabled(){return this.children.every(t=>t.enabled)??!1}get childLayerIds(){return this.children.map(t=>t.layer.id).toArray()}get enabled(){return this.featureSource!=null&&this.featureSource.enabled}get featureSource(){const{layer:t,getFeatureSnappingSources:e}=this;return e().find(r=>r.layer===t)}get hasChildrenEnabled(){return this.children.some(t=>t.enabled)}_initializeChildLayers(t){if(!t)return;const e=t.filter(nte);super._initializeChildLayers(e)}_makeChildren(t){return t.map(e=>ite(e)?new uZ({layer:e,parent:this,view:this.view,getFeatureSnappingSources:this.getFeatureSnappingSources}):null).filter(Ia).reverse()}};u([d()],Np.prototype,"allChildrenEnabled",null),u([d()],Np.prototype,"children",void 0),u([d()],Np.prototype,"childLayerIds",null),u([d()],Np.prototype,"enabled",null),u([d()],Np.prototype,"featureSource",null),u([d({constructOnly:!0})],Np.prototype,"getFeatureSnappingSources",void 0),u([d()],Np.prototype,"hasChildrenEnabled",null),u([d()],Np.prototype,"parent",void 0),Np=uZ=u([R("esri.widgets.support.SnappingControls.SnappingListItem")],Np);let Ww=class extends Ost{constructor(){super(...arguments),this.featureSnappingSources=new Ke}get operationalItemsFlat(){return this.operationalItems.flatten(e=>e.children)}get selectableItems(){return this.operationalItemsFlat.filter(e=>!e.children?.length)}_compileList(){const e=this.get("view.map.layers");if(!e)return;const r=e.filter(nte);this._watchLayersListMode(r);const i=this._getViewableLayers(r);i&&i.length?(this._createNewItems(i),this._removeItems(i),this._sortItems(i)):this._removeAllItems()}_createListItem(e){return new Np({layer:e,view:this.view,getFeatureSnappingSources:()=>this.featureSnappingSources})}};u([d()],Ww.prototype,"featureSnappingSources",void 0),u([d()],Ww.prototype,"operationalItems",void 0),u([d()],Ww.prototype,"operationalItemsFlat",null),u([d()],Ww.prototype,"selectableItems",null),Ww=u([R("esri.widgets.support.SnappingControls.SnappingLayerListViewModel")],Ww);const Ist="esri.widgets.support.SnappingControls.SnappingControlsViewModel";let Am=class extends Oc(me){constructor(e){super(e),this.layerListViewModel=new Ww,this.snappingOptions=null,this.view=null}initialize(){this.handles.add([Q(()=>({viewModel:this.layerListViewModel,view:this.view}),({viewModel:e,view:r})=>{e.view=r},xt),Q(()=>({viewModel:this.layerListViewModel,sources:this.snappingOptions?.featureSources}),({viewModel:e,sources:r})=>{e.featureSnappingSources=r},xt)])}get allLayersEnabled(){return(this.layerListViewModel?.selectableItems??[]).every(e=>e.enabled)}get allLayersDisabled(){return(this.layerListViewModel?.selectableItems??[]).every(e=>!e.enabled)}get layersEnabledCount(){return this.layerListViewModel?.selectableItems?.filter(e=>e.enabled).length??0}get state(){return this.get("snappingOptions")?"ready":"disabled"}toggleSnappingForLayers(e,r){e?.forEach(i=>r?this.enableSnappingForLayer(i):this.disableSnappingForLayer(i))}toggleSnappingForAllLayers(e){this.layerListViewModel.selectableItems.forEach(({layer:{id:r}})=>{e?this.enableSnappingForLayer(r):this.disableSnappingForLayer(r)})}enableSnappingForLayer(e){(this._findSnappingSourceForLayer(e)??this._makeSnappingSourceForLayer(e)).enabled=!0}disableSnappingForLayer(e){const r=this._findSnappingSourceForLayer(e);r&&(r.enabled=!1)}updateEnabledFeatureSources(e){for(const r of this.snappingOptions.featureSources)ite(r.layer)&&(r.enabled=e.includes(r.layer.id))}_findSnappingSourceForLayer(e){return this.snappingOptions.featureSources.find(r=>r.layer.id===e)}_makeSnappingSourceForLayer(e){const r=this.layerListViewModel.operationalItemsFlat.find(s=>s.layer.id===e)?.layer;if(!r)throw new D("snapping-controls:layer-not-found",`cannot enable snapping for layer with id ${e} because no such layer was found in the view`);const i=new kee({layer:r});return this.snappingOptions.featureSources.add(i),i}};u([d()],Am.prototype,"allLayersEnabled",null),u([d()],Am.prototype,"allLayersDisabled",null),u([d({constructOnly:!0})],Am.prototype,"layerListViewModel",void 0),u([d()],Am.prototype,"layersEnabledCount",null),u([d()],Am.prototype,"snappingOptions",void 0),u([d()],Am.prototype,"state",null),u([d()],Am.prototype,"view",void 0),Am=u([R(Ist)],Am);const Pst=Am,fce={header:!0,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0,layerListToggleLayersButton:!0},Ph="esri-snapping-controls",$c={base:Ph,container:`${Ph}__container`,panel:`${Ph}__panel`,item:`${Ph}__item`,toggleBlock:`${Ph}__toggle-block`,layerListBlock:`${Ph}__layer-list-block`,layerList:`${Ph}__layer-list`,layerListFilter:`${Ph}__layer-list__filter`,layerListButton:`${Ph}__layer-list__button`,layerListItem:`${Ph}__layer-list__item`,layerListGroup:`${Ph}__layer-list__group`,nestedContainer:`${Ph}__nested-container`,disabled:"esri-disabled",esriWidget:"esri-widget",widgetIcon:"esri-icon-vertex-gps"},rR={checked:"check-square-f",unchecked:"square",indeterminate:"minus-square"};let ic=class extends Rc{constructor(e,r){super((()=>{const{view:i,viewModel:s,snappingOptions:n,...o}=e;return o})(),r),this._defaultViewModel=null,this._layerListFilter=null,this.iconClass=$c.widgetIcon,this.icon=null,this.layerListOpen=!0,this.messages=null,this.visibleElements={...fce},this._onToggleLayersButtonClick=i=>{this.viewModel.toggleSnappingForAllLayers(!this.viewModel.allLayersEnabled),requestAnimationFrame(()=>i.target.setFocus())},e?.viewModel?this.viewModel=e.viewModel:(this._defaultViewModel=new Pst({snappingOptions:e.snappingOptions,view:e.view}),this.viewModel=this._defaultViewModel)}destroy(){this._defaultViewModel=Re(this._defaultViewModel)}loadDependencies(){return oO({accordion:()=>J(()=>import("./calcite-accordion-74882a79.js"),[],import.meta.url),"accordion-item":()=>J(()=>import("./calcite-accordion-item-837322dc.js"),["./calcite-accordion-item-837322dc.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./icon-6c56dd6f.js"],import.meta.url),action:()=>J(()=>import("./calcite-action-87eb6a8d.js"),["./calcite-action-87eb6a8d.js","./action-e3f08495.js","./guid-4f97587b.js","./interactive-1607c36d.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./loader-cabefae3.js"],import.meta.url),block:()=>J(()=>import("./calcite-block-062b1cba.js"),["./calcite-block-062b1cba.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./guid-4f97587b.js","./interactive-1607c36d.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./focusTrapComponent-08ab2cd6.js","./action-e3f08495.js","./loadable-7d140904.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./action-menu-556ccc16.js","./popover-1095e00b.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./FloatingArrow-b345edcc.js","./scrim-2cacfa4b.js"],import.meta.url),button:()=>J(()=>import("./calcite-button-b1570436.js"),["./calcite-button-b1570436.js","./form-c843c929.js","./interactive-1607c36d.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url),icon:()=>J(()=>import("./calcite-icon-94f83e8a.js"),["./calcite-icon-94f83e8a.js","./icon-6c56dd6f.js","./observers-333b9ff3.js"],import.meta.url),input:()=>J(()=>import("./calcite-input-a5929ac8.js"),["./calcite-input-a5929ac8.js","./input-88645e50.js","./form-c843c929.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./progress-a90520b9.js"],import.meta.url),label:()=>J(()=>import("./calcite-label-147381cb.js"),["./calcite-label-147381cb.js","./label2-6ed53214.js"],import.meta.url),list:()=>J(()=>import("./calcite-list-f85ba3b9.js"),["./calcite-list-f85ba3b9.js","./interactive-1607c36d.js","./observers-333b9ff3.js","./utils3-48a6cb5c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js","./input-88645e50.js","./form-c843c929.js","./label2-6ed53214.js","./progress-a90520b9.js","./loader-cabefae3.js","./guid-4f97587b.js","./scrim-2cacfa4b.js"],import.meta.url),"list-item":()=>J(()=>import("./calcite-list-item-3e21bb8f.js"),["./calcite-list-item-3e21bb8f.js","./interactive-1607c36d.js","./utils3-48a6cb5c.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./loadable-7d140904.js","./action-e3f08495.js","./guid-4f97587b.js","./icon-6c56dd6f.js","./loader-cabefae3.js"],import.meta.url),panel:()=>J(()=>import("./calcite-panel-58fef79d.js"),["./calcite-panel-58fef79d.js","./panel-297a3a38.js","./interactive-1607c36d.js","./loadable-7d140904.js","./observers-333b9ff3.js","./action-menu-556ccc16.js","./guid-4f97587b.js","./key-89f6acdc.js","./action-e3f08495.js","./t9n-2d2f005c.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./popover-1095e00b.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./focusTrapComponent-08ab2cd6.js","./FloatingArrow-b345edcc.js","./scrim-2cacfa4b.js"],import.meta.url),switch:()=>J(()=>import("./calcite-switch-0ac15e4a.js"),["./calcite-switch-0ac15e4a.js","./form-c843c929.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js"],import.meta.url)})}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}set viewModel(e){e!==this._get("viewModel")&&(this._defaultViewModel!=null&&this._defaultViewModel===e||(this._defaultViewModel=Re(this._defaultViewModel)),this._set("viewModel",e))}castVisibleElements(e){return{...fce,...e}}render(){const{label:e,visibleElements:{header:r}}=this;return j("div",{"aria-label":e,class:this.classes($c.base,$c.esriWidget)},j("div",{class:$c.container},r?this._renderHeaderView():this._renderContent()))}_renderHeaderView(){return j("calcite-panel",{heading:this.label,class:$c.panel},this._renderContent())}_renderContent(){return[this._renderToggles(),this._renderLayerList()]}_renderToggles(){const{visibleElements:{enabledToggle:e,selfEnabledToggle:r,featureEnabledToggle:i}}=this;return e||r||i?j("calcite-block",{class:$c.toggleBlock,key:"toggle-block",heading:"",open:!0},this._renderEnabledToggle(),j("div",{class:$c.nestedContainer},this._renderSelfEnabledToggle(),this._renderFeatureEnabledToggle())):null}_renderEnabledToggle(){if(!this.visibleElements.enabledToggle)return null;const{messages:{enableSnapping:e},viewModel:{snappingOptions:{enabled:r,enabledToggled:i}}}=this;return j("calcite-label",{layout:"inline-space-between"},e,j("calcite-switch",{checked:r,disabled:i,bind:this,onCalciteSwitchChange:this._enableSnappingSwitchChange}))}_renderSelfEnabledToggle(){if(!this.visibleElements.selfEnabledToggle)return null;const{messages:{geometryGuides:e},viewModel:{snappingOptions:{enabled:r,selfEnabled:i,enabledToggled:s}}}=this;return j("calcite-label",{layout:"inline-space-between",key:"self-enabled-toggle"},e,j("calcite-switch",{checked:i,disabled:s||!r,bind:this,onCalciteSwitchChange:this._selfEnabledSwitchChange}))}_renderFeatureEnabledToggle(){if(!this.visibleElements.featureEnabledToggle)return null;const{messages:{featureToFeature:e},viewModel:{snappingOptions:{enabled:r,featureEnabled:i,enabledToggled:s}}}=this;return j("calcite-label",{layout:"inline-space-between",key:"feature-enabled-toggle"},e,j("calcite-switch",{checked:i,disabled:s||!r,bind:this,onCalciteSwitchChange:this._featureEnabledSwitchChange}))}_renderLayerList(){if(!this.visibleElements.layerList)return null;const{messages:e,viewModel:r}=this,{snappingOptions:{enabled:i,enabledToggled:s}}=r,n=({target:{value:c}})=>this._layerListFilter=c===""?null:new RegExp(c,"i"),o=r.layerListViewModel.operationalItems.length>9?j("calcite-input",{class:$c.layerListFilter,clearable:!0,placeholder:e?.searchLayers,onCalciteInputInput:n}):null,a=s||!i,l=this.layerListOpen&&!a;return j("calcite-block",{key:"list-block",heading:e.snappingLayers,disabled:a,class:$c.layerListBlock,collapsible:!0,open:l,onCalciteBlockToggle:c=>this.layerListOpen=c.target.open},o,this._renderToggleLayersButton(),j("calcite-list",{class:$c.layerList},this._renderLayerListItemCollection(r.layerListViewModel.operationalItems,this._layerListFilter)))}_renderLayerListItemCollection(e,r){return e.map(i=>{if(!r||this._itemTitleMatchesFilter(i,r))return i.children.length>0?this._renderLayerListItemGroup(i):this._renderLayerListItem(i);const s=i.children.filter(n=>this._itemTitleMatchesFilter(n,r));return s.length>0?this._renderLayerListItemGroup(i,s):null}).toArray().filter(Ia)}_renderToggleLayersButton(){if(!this.visibleElements.layerListToggleLayersButton)return null;const{viewModel:{allLayersEnabled:e},messages:r}=this,i=e?r.disableAllLayers:r.enableAllLayers;return j("calcite-button",{appearance:"transparent",class:$c.layerListButton,label:i,name:"layer-toggle",scale:"m",onclick:this._onToggleLayersButtonClick},i)}_renderLayerListItem(e){const{messages:{untitledLayer:r}}=this,i=e.title||r,s=e.enabled,n=()=>{this._handleLayerListItemChange({checked:!s,value:e.layer.id})};return j("calcite-list-item",{class:$c.layerListItem,label:i,key:`${this.id}-list-item-${e.uid}`,onCalciteListItemSelect:n},j("calcite-icon",{icon:s?rR.checked:rR.unchecked,slot:"content-start",scale:"s"}))}_renderLayerListItemGroup(e,r){const{allChildrenEnabled:i,children:s,hasChildrenEnabled:n,title:o}=e,a=this.messages,l=o||a.untitledLayer,c=o&&o!==""?o:vc(),h=!!r,p=r??s,f=i?rR.checked:n?rR.indeterminate:rR.unchecked,m=i?a.disableAllLayers:a.enableAllLayers,g=()=>{this.viewModel.toggleSnappingForLayers(e.childLayerIds,!i)};return j("calcite-list-item",{class:$c.layerListItem,key:c},j("calcite-accordion",{class:$c.layerListGroup,appearance:"transparent"},j("calcite-accordion-item",{expanded:h,heading:l,key:e.uid},j("calcite-action",{scale:"m",slot:"actions-start",text:m,textEnabled:!1,onclick:g},j("calcite-icon",{icon:f,scale:"s"})),j("calcite-list",null,[...this._renderLayerListItemCollection(p)]))))}_enableSnappingSwitchChange(e){this.snappingOptions.enabled=e.target.checked}_featureEnabledSwitchChange(e){this.snappingOptions.featureEnabled=e.target.checked}_itemTitleMatchesFilter(e,r){return r!=null&&r.test(e.title)}_selfEnabledSwitchChange(e){this.snappingOptions.selfEnabled=e.target.checked}async _handleLayerListItemChange(e){e.checked?this.viewModel.enableSnappingForLayer(e.value):this.viewModel.disableSnappingForLayer(e.value)}};u([d()],ic.prototype,"_defaultViewModel",void 0),u([d()],ic.prototype,"_layerListFilter",void 0),u([d()],ic.prototype,"iconClass",void 0),u([d()],ic.prototype,"icon",void 0),u([d()],ic.prototype,"label",null),u([d()],ic.prototype,"layerListOpen",void 0),u([d(),Aa("esri/widgets/support/SnappingControls/t9n/SnappingControls")],ic.prototype,"messages",void 0),u([d()],ic.prototype,"snappingOptions",null),u([d()],ic.prototype,"view",null),u([d()],ic.prototype,"viewModel",null),u([d()],ic.prototype,"visibleElements",void 0),u([or("visibleElements")],ic.prototype,"castVisibleElements",null),ic=u([R("esri.widgets.support.SnappingControls")],ic);const $st=ic,mce={base:"esri-sketch-tooltip-controls",esriWidget:"esri-widget",widgetIcon:"esri-icon-gear"};let Ay=class extends Rc{constructor(e){super(e),this.viewModel=null,this.iconClass=mce.widgetIcon,this.icon=null,this._onEnabledChange=r=>{const i=r.target;this.tooltipOptions.enabled=i.checked}}loadDependencies(){return oO({block:()=>J(()=>import("./calcite-block-062b1cba.js"),["./calcite-block-062b1cba.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./guid-4f97587b.js","./interactive-1607c36d.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./focusTrapComponent-08ab2cd6.js","./action-e3f08495.js","./loadable-7d140904.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./action-menu-556ccc16.js","./popover-1095e00b.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./FloatingArrow-b345edcc.js","./scrim-2cacfa4b.js"],import.meta.url),label:()=>J(()=>import("./calcite-label-147381cb.js"),["./calcite-label-147381cb.js","./label2-6ed53214.js"],import.meta.url),switch:()=>J(()=>import("./calcite-switch-0ac15e4a.js"),["./calcite-switch-0ac15e4a.js","./form-c843c929.js","./interactive-1607c36d.js","./key-89f6acdc.js","./label2-6ed53214.js","./loadable-7d140904.js"],import.meta.url)})}render(){return j("div",{class:mce.base},j("calcite-block",{heading:"",open:!0},j("calcite-label",{layout:"inline-space-between"},this.messages?.enabledToggle,j("calcite-switch",{checked:this.tooltipOptions.enabled,onCalciteSwitchChange:this._onEnabledChange}))))}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}};u([d()],Ay.prototype,"viewModel",void 0),u([d()],Ay.prototype,"iconClass",void 0),u([d()],Ay.prototype,"icon",void 0),u([d()],Ay.prototype,"label",null),u([d(),Aa("esri/widgets/support/SketchTooltipControls/t9n/SketchTooltipControls")],Ay.prototype,"messages",void 0),u([d()],Ay.prototype,"tooltipOptions",void 0),Ay=u([R("esri.widgets.Editor.components.SketchTooltipControls")],Ay);const ld="esri-editor",RS=`${ld}__panel`,MS=`${ld}__prompt`,ri={base:`${ld} esri-widget esri-widget--panel`,actions:`${ld}__actions`,helpMessage:`${ld}__help-message`,panelToolbar:`${RS}-toolbar`,panelContent:`${RS}-content`,panelContentMessage:`${RS}-content__message`,panelContentSection:`${RS}-content__section`,panelContentSectionGroup:`${RS}-content__section__group`,panelContentScrimContainer:`${RS}-content__scrim-container`,settingsContainer:`${ld}__settings`,featureTemplatesContainer:`${ld}__feature-templates-container`,notice:`${ld}__notice`,templateItemContentEnd:`${ld}__template-item-content-end`,templateItemContentEndSuccess:`${ld}__template-item-content-end--success`,templateItemContentEndError:`${ld}__template-item-content-end--error`,templateItemLoader:`${ld}__template-item-loader`,promptContainer:MS,promptHeader:`${MS}__header`,promptHeading:`${MS}__header__heading`,promptMessage:`${MS}__message`,promptDivider:`${MS}__divider`,promptActions:`${MS}__actions`,widgetIcon:"esri-icon-edit"},Oz={undoRedoButtons:!1,snappingControls:!0,snappingControlsElements:{header:!1,enabledToggle:!0,selfEnabledToggle:!0,featureEnabledToggle:!0,layerList:!0},sketchTooltipControls:!0};function Lst(t){requestAnimationFrame(()=>t.setFocus())}const KL="exclamation-mark-triangle",kAe="esri.widgets.Editor",Rz=K.getLogger(kAe);let fi=class extends Oc(Rc){constructor(e,r){super(e,r),this._featureForm=new sKe,this._attachments=new WHe({visibleElements:{addSubmitButton:!1,cancelAddButton:!1,cancelUpdateButton:!1,deleteButton:!1,errorMessage:!1,progressBar:!1,updateButton:!1}}),this._featureTemplates=new wtt({enableListScroll:!1,renderItemContentEnd:i=>this._renderTemplateContentEnd(i),renderItemDescription:i=>this._renderTemplateDescription(i),renderItemLabel:i=>this._renderTemplateLabel(i),renderCustomGroupContent:i=>this._renderCustomTemplateGroupContent(i)}),this._filterText="",this._prompt=null,this._spinner=new Stt,this.headingLevel=4,this.iconClass=ri.widgetIcon,this.messages=null,this.messagesCommon=null,this.messagesTemplates=null,this.supportingWidgetDefaults=null,this.viewModel=new lst,this.visibleElements={...Oz},this._renderSelectIcon=()=>j("calcite-icon",{icon:"cursor",slot:"content-start"}),this.EditorPanel=({handleBack:i,heading:s,headingLevel:n,key:o},...a)=>{const{messagesCommon:l,viewModel:c,visibleElements:h}=this,p=c.sketchViewModel,f=c.syncing||this._attachments.submitting;return j("calcite-flow-item",{closable:!1,heading:s,headingLevel:n,key:o,loading:f,onCalciteFlowItemBack:i??void 0},j("div",{key:"panel-toolbar",class:ri.panelToolbar},this._renderSettings(),h.undoRedoButtons&&[j("calcite-button",{key:"undo-button",label:l.undo,appearance:"transparent",kind:"neutral",alignment:"center",iconStart:"undo",scale:"l",disabled:!p.canUndo(),onclick:p.undo.bind(p)},l.undo),j("calcite-button",{key:"redo-button",label:l.redo,appearance:"transparent",kind:"neutral",alignment:"center",iconStart:"redo",scale:"l",disabled:!p.canRedo(),onclick:p.redo.bind(p)},l.redo)]),...a)},this._showDiscardEditsPrompt=()=>{const{messages:i,activeWorkflow:s}=this;if(s?.type==="create-features"&&qk(s.data.creationInfo))return this._showPrompt({title:i.cancelUploadTitle,message:i.cancelUploadWarningMessage,yesLabel:i.discardUpload,noLabel:i.continueUpload});const n=s?.type==="create";return this._showPrompt({title:i[n?"cancelAddTitle":"cancelEditTitle"],message:i[n?"cancelAddWarningMessage":"cancelEditWarningMessage"],yesLabel:i[n?"discardFeature":"discardEdits"],noLabel:i[n?"continueAdding":"continueEditing"]})},this._showGenericCancelPrompt=()=>{const{messages:i,messagesCommon:s}=this;return this._showPrompt({title:i.cancelRequestTitle,message:i.cancelRequestWarningMessage,yesLabel:s.form.yes,noLabel:s.form.no})},this._onToggleUpdateWorkflow=()=>this.viewModel.toggleUpdateWorkflow(),this._onAttachmentDeleteConfirm=async()=>{const i=this._attachments,{activeWorkflow:s}=this.viewModel;s&&(s.type==="create-features"?i.deleteFile():(await i.deleteAttachment(i.viewModel.activeAttachmentInfo),this._clearPrompt()),await s.back(),this._clearPrompt())},this._onAttachmentsError=i=>{this._prompt={title:this.messages.errorWarningTitle,message:i.message,context:"warning",actions:{primary:{label:this.messagesCommon.form.ok,action:this._clearPrompt}}}},this._clearPrompt=()=>{this._prompt=null},this._onBack=this._onBack.bind(this),this._onSave=this._onSave.bind(this),this._onDelete=this._onDelete.bind(this),this._onToggleUpdateWorkflow=this._onToggleUpdateWorkflow.bind(this),this._onAttachmentAdd=this._onAttachmentAdd.bind(this),this._onAttachmentUpdate=this._onAttachmentUpdate.bind(this),this._onAttachmentDelete=this._onAttachmentDelete.bind(this)}initialize(){this.addHandles([Q(()=>k3(this.headingLevel),e=>{this._featureForm.headingLevel=e,this._featureTemplates.headingLevel=e},xt),Q(()=>this.viewModel.selectedTemplateItem,e=>this._featureTemplates.select(e,{emit:!1})),Vs(()=>this.viewModel.activeWorkflow,"cancel-request",({controller:e})=>{(this.viewModel.hasPendingEdits?this._showDiscardEditsPrompt():this._showGenericCancelPrompt()).then(r=>r?e.allow():e.deny())}),Q(()=>this.viewModel,e=>{this._featureForm.viewModel=e?.featureFormViewModel??null,this._attachments.viewModel=e?.attachmentsViewModel??null,this._featureTemplates.viewModel=e?.featureTemplatesViewModel??null,this._spinner.viewModel=e?.spinnerViewModel??null,e.showDiscardEditsPrompt=this._showDiscardEditsPrompt},xt),Q(()=>this.view,(e,r)=>{const i=`editor-${this.id}-spinner`;r?.ui.remove(this._spinner,i),e?.ui.add(this._spinner,{key:i,position:"manual"})},xt),No(()=>this.supportingWidgetDefaults,e=>{this._featureForm.set(e.featureForm),this._attachments.set(e.attachments),this._featureTemplates.set(e.featureTemplates),this.viewModel.sketchViewModel.set(e.sketch)},xt),No(()=>this._attachments?.error,e=>this._onAttachmentsError(e)),No(()=>this.viewModel?.failures,e=>{const{messages:r}=this,[{error:i,retry:s,cancel:n}]=e;this._prompt={title:r.errorWarningTitle,message:s1(r.errorWarningMessageTemplate,{errorMessage:i.message}),context:"warning",actions:{primary:{label:r.retry,action:()=>{s(),this._clearPrompt()}},secondary:{label:r.ignore,action:()=>{n(),this._clearPrompt()}}}}}),Q(()=>this.viewModel?.state,e=>{switch(e){case"awaiting-feature-to-update":case"ready":case"disabled":this._filterText="",this._featureTemplates.filterText=""}}),Q(()=>this.viewModel.featureFormDisabled,e=>this._featureForm.disabled=e)])}destroy(){this._attachments.destroy(),this._featureForm.destroy(),this._featureTemplates.destroy()}loadDependencies(){return oO({accordion:()=>J(()=>import("./calcite-accordion-74882a79.js"),[],import.meta.url),"accordion-item":()=>J(()=>import("./calcite-accordion-item-837322dc.js"),["./calcite-accordion-item-837322dc.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./icon-6c56dd6f.js"],import.meta.url),button:()=>J(()=>import("./calcite-button-b1570436.js"),["./calcite-button-b1570436.js","./form-c843c929.js","./interactive-1607c36d.js","./label2-6ed53214.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url),"flow-item":()=>J(()=>import("./calcite-flow-item-4010f776.js"),["./calcite-flow-item-4010f776.js","./interactive-1607c36d.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./panel-297a3a38.js","./action-menu-556ccc16.js","./guid-4f97587b.js","./action-e3f08495.js","./icon-6c56dd6f.js","./loader-cabefae3.js","./popover-1095e00b.js","./openCloseComponent-6668f48b.js","./debounce-c198f28b.js","./focusTrapComponent-08ab2cd6.js","./FloatingArrow-b345edcc.js","./scrim-2cacfa4b.js","./tooltip-68b9372f.js"],import.meta.url),flow:()=>J(()=>import("./calcite-flow-89b1a76e.js"),["./calcite-flow-89b1a76e.js","./observers-333b9ff3.js"],import.meta.url),icon:()=>J(()=>import("./calcite-icon-94f83e8a.js"),["./calcite-icon-94f83e8a.js","./icon-6c56dd6f.js","./observers-333b9ff3.js"],import.meta.url),list:()=>J(()=>import("./calcite-list-f85ba3b9.js"),["./calcite-list-f85ba3b9.js","./interactive-1607c36d.js","./observers-333b9ff3.js","./utils3-48a6cb5c.js","./loadable-7d140904.js","./filter2-db8c040b.js","./debounce-c198f28b.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js","./input-88645e50.js","./form-c843c929.js","./label2-6ed53214.js","./progress-a90520b9.js","./loader-cabefae3.js","./guid-4f97587b.js","./scrim-2cacfa4b.js"],import.meta.url),loader:()=>J(()=>import("./calcite-loader-c2c6c73b.js"),["./calcite-loader-c2c6c73b.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url),notice:()=>J(()=>import("./calcite-notice-61fe6537.js"),["./calcite-notice-61fe6537.js","./conditionalSlot-e5b503f9.js","./observers-333b9ff3.js","./loadable-7d140904.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./icon-6c56dd6f.js"],import.meta.url),scrim:()=>J(()=>import("./calcite-scrim-e1797dba.js"),["./calcite-scrim-e1797dba.js","./scrim-2cacfa4b.js","./t9n-2d2f005c.js","./key-89f6acdc.js","./observers-333b9ff3.js","./loader-cabefae3.js","./guid-4f97587b.js"],import.meta.url)})}get _deleteButtonCommonInfo(){return{appearance:"outline",kind:"danger",type:"primary"}}get activeWorkflow(){return this.viewModel.activeWorkflow}get allowedWorkflows(){return this.viewModel.allowedWorkflows}set allowedWorkflows(e){this.viewModel.allowedWorkflows=e}get useDeprecatedCreateWorkflow(){return this.viewModel.useDeprecatedCreateWorkflow}set useDeprecatedCreateWorkflow(e){this.viewModel.useDeprecatedCreateWorkflow=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get labelOptions(){return this.viewModel.labelOptions}set labelOptions(e){this.viewModel.labelOptions=e}get layerInfos(){return this.viewModel.layerInfos}set layerInfos(e){this.viewModel.layerInfos=e}get snappingOptions(){return this.viewModel.snappingOptions}set snappingOptions(e){this.viewModel.snappingOptions=e}get tooltipOptions(){return this.viewModel.tooltipOptions}set tooltipOptions(e){this.viewModel.tooltipOptions=e}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}castVisibleElements(e){return{...Oz,...e,snappingControlsElements:{...Oz.snappingControlsElements,...e?.snappingControlsElements}}}startCreateWorkflowAtFeatureTypeSelection(){return MC(Rz,"startCreateWorkflowAtFeatureTypeSelection","startCreateFeaturesWorkflowAtFeatureTypeSelection"),this.viewModel.startCreateWorkflowAtFeatureTypeSelection()}startCreateFeaturesWorkflowAtFeatureTypeSelection(){return this.viewModel.startCreateFeaturesWorkflowAtFeatureTypeSelection()}startCreateWorkflowAtFeatureCreation(e){return MC(Rz,"startCreateWorkflowAtFeatureCreation","startCreateFeaturesWorkflowAtFeatureCreation"),this.viewModel.startCreateWorkflowAtFeatureCreation(e)}startCreateFeaturesWorkflowAtFeatureCreation(e){return this.viewModel.startCreateFeaturesWorkflowAtFeatureCreation(e)}startCreateWorkflowAtFeatureEdit(e){return MC(Rz,"startCreateWorkflowAtFeatureEdit"),this.viewModel.startCreateWorkflowAtFeatureEdit(e)}startUpdateWorkflowAtFeatureSelection(){return this.viewModel.startUpdateWorkflowAtFeatureSelection()}startUpdateWorkflowAtMultipleFeatureSelection(e){return this.viewModel.startUpdateWorkflowAtMultipleFeatureSelection(e)}startUpdateWorkflowAtFeatureEdit(e){return this.viewModel.startUpdateWorkflowAtFeatureEdit(e)}deleteFeatureFromWorkflow(){return this.viewModel.deleteFeatureFromWorkflow()}cancelWorkflow(e){return this.viewModel.cancelWorkflow(e)}render(){const{viewModel:e}=this;if(!e)return j("div",{key:"empty",class:ri.base});const{state:r}=e;return j("div",{key:"base",class:ri.base},j("calcite-flow",{key:"flow"},e.pageStack.map(i=>this._renderPage(i,r)),this._renderPage(e.page,r)),this._renderPrompt())}_renderPage(e,r){switch(e){case"disabled":break;case"ready":return this._renderLanding(r);case"awaiting-feature-creation-info":return this._renderTemplates(r);case"creating-features":case"editing-new-feature":case"editing-existing-feature":return this._renderAttributeEditing(r);case"awaiting-update-feature-candidate":return this._renderFeatureList(r);case"adding-attachment":return this._renderAttachmentAdding(r);case"editing-attachment":return this._renderAttachmentEditing(r)}return j("div",null)}_renderTemplates(e){const{EditorPanel:r,headingLevel:i,messages:s,_onBack:n}=this;return j(r,{active:this._isPanelActive(e),key:"templates-panel",handleBack:n,heading:s.selectTemplate,headingLevel:i},j("div",{key:"feature-templates",class:ri.panelContent},this._featureTemplates.render()))}_renderAttributeEditing(e){const{activeWorkflow:r,EditorPanel:i,messages:s,messagesCommon:n,headingLevel:o,_onBack:a,viewModel:l}=this;if(!r)return null;const c=r.type,h="activeWorkflow"in r&&r.activeWorkflow,p=h?h.type:null,f=l.featureFormViewModel,m=h&&!h.hasPendingEdits||c==="update"&&!r.hasPendingEdits||l.syncing||f.updating,g=c==="update"?s.editFeature:s.createFeatures,_=c==="update"&&p!=="create-features"?n.update:n.create,v=c==="create-features"&&r.createFeatureState==="create-new",b=c==="create-features"?r.numPendingFeatures:0,x=b>1?s1(s.createFeaturesTemplate,{numFeatures:b}):_,T=r.shouldShowAttachments&&!l.featureFormViewModel.activeRelationshipInput,S=f.inputs.every(O=>!O.visible)&&!T?this._renderMessage(s1(s.clickToFinishTemplate,{button:_})):j("div",{key:"panel-content-section",class:ri.panelContentSection},this._renderNotices(r),j("div",{class:ri.panelContentSectionGroup},this._featureForm.render(),T&&j("div",{key:"attachments"},j(Gx,{level:k3(o)},s.attachments),this._attachments.render())));return j(i,{active:this._isPanelActive(e),key:"attribute-editing-panel",heading:g,headingLevel:o,handleBack:a},j("div",{key:"panel-content",class:this.classes(ri.panelContent,{[ri.panelContentScrimContainer]:v})},S,v&&j("calcite-scrim",null)),this._renderFooterActions([{clickHandler:this._onSave,disabled:m,label:x,type:"primary"},l.shouldShowDeleteButton?{...this._deleteButtonCommonInfo,clickHandler:this._onDelete,disabled:l.syncing,label:n.delete}:null]))}_renderNotices(e){return[this._renderOwnerAdminNotice(e),this._renderInvalidFormTemplateNotice(e),this._renderInvalidDateFieldNotice(e)]}_renderOwnerAdminNotice(e){return e?.reliesOnOwnerAdminPrivileges&&this._renderNotice(this.messages.ownerAdminNotice)}_renderInvalidFormTemplateNotice(e){return e?.hasInvalidFormTemplate&&this._renderNotice(this.messages.formFieldUpdateError,{icon:KL})}_renderInvalidDateFieldNotice(e){return e?.hasUnsupportedFields&&this._renderNotice(this.messages.formFieldUnsupportedUpdateError,{icon:KL})}_renderNotice(e,r){return j("calcite-notice",{open:!0,scale:"s",class:ri.notice,...r},j("div",{slot:"message"},e))}_renderCustomTemplateGroupContent(e){const{messages:r,viewModel:i}=this;let s=null;return e.group.items.some(n=>(i.itemHasUnsupportedFields(n)?s=r.formFieldUnsupportedCreateError:i.itemHasInvalidFormTemplate(n)&&(s=r.formFieldCreateError),s)),s?this._renderNotice(s,{icon:KL}):null}_renderAttachmentAdding(e){const{_attachments:r,EditorPanel:i,_onBack:s,headingLevel:n,messages:o,messagesCommon:a}=this;return j(i,{active:this._isPanelActive(e),key:"attachment-adding-panel",heading:o.addAttachment,headingLevel:n,handleBack:s},j("div",{key:"attachments",class:ri.panelContent},r.render()),this._renderFooterActions([{label:r.submitting?a.cancel:a.add,disabled:r.submitting||!r.selectedFile,type:"primary",clickHandler:this._onAttachmentAdd}]))}_renderAttachmentEditing(e){const{_attachments:r,EditorPanel:i,_onBack:s,activeWorkflow:n,headingLevel:o,messages:a,messagesCommon:l}=this;return n?j(i,{active:this._isPanelActive(e),key:"attachment-editing-panel",heading:a.editAttachment,headingLevel:o,handleBack:s},j("div",{key:"attachments",class:ri.panelContent},r.render()),n.shouldAllowAttachmentEditing?this._renderFooterActions([{label:l.update,disabled:r.submitting||!r.selectedFile,type:"primary",clickHandler:this._onAttachmentUpdate},{...this._deleteButtonCommonInfo,clickHandler:this._onAttachmentDelete,disabled:r.submitting,label:l.delete}]):void 0):null}_renderMessage(e){return j("div",{key:"panel-content-message",class:ri.panelContentMessage},e)}_renderFooterActions(e){return j("div",{key:"footer-actions",slot:"footer",class:ri.actions},e.filter(Ia).map(({type:r,disabled:i,class:s,clickHandler:n,label:o,...a},l)=>j("calcite-button",{key:`action-${l}`,slot:"footer-actions",class:s,disabled:i??!1,onclick:n,width:"full",...a},o)))}_renderPrompt(){const e=this._prompt;if(!e)return null;const{title:r,message:i,context:s,actions:n}=e,o=n.secondary;let a;switch(s){case"danger":a="danger";break;case"info":a="brand";break;default:a="neutral"}const l=j("calcite-button",{afterCreate:Lst,appearance:"solid",key:"prompt-primary-button",kind:a,onclick:n.primary.action,scale:"m",width:o?"half":"full"},n.primary.label),c=o&&j("calcite-button",{appearance:"outline",key:"prompt-secondary-button",kind:a,onclick:o.action,scale:"m",width:"half"},o.label);return j("calcite-scrim",{key:"prompt"},j("div",{class:`${ri.promptContainer}--${s}`},j("div",{class:ri.promptHeader},j("calcite-icon",{icon:KL}),j(Gx,{class:ri.promptHeading,level:this.headingLevel},r)),j("div",{class:ri.promptMessage},i),j("div",{class:ri.promptDivider}),j("div",{class:ri.promptActions},c,l)))}_renderLanding(e){const{EditorPanel:r,headingLevel:i,messages:s,viewModel:n}=this,{canUpdate:o}=n,a=this._featureTemplates.viewModel.numberOfFeatureTemplates,l=!o&&a===0;return j(r,{active:this._isPanelActive(e),key:"landing-panel",heading:s.widgetLabel,headingLevel:i},j("div",{key:"landing-content",class:ri.panelContent},o&&j("div",{key:"edit-actions",class:ri.panelContentSection},this._renderUpdateActions(e)),a>0&&j("div",{key:"create-actions",class:ri.panelContentSection},this._renderCreateActions()),l&&j("div",{key:"no-content",class:ri.panelContentMessage},s.noEditableLayers)),this._renderFooterHelpMessages())}_renderFooterHelpMessages(){const{activeWorkflow:e,messages:r,view:i}=this,s=e?.helpMessage,n=s?r[i?.type==="3d"?"helpMessages3d":"helpMessages2d"]?.[s]:null;return n?j("div",{key:"footer-actions",slot:"footer",class:ri.helpMessage},n):null}_renderUpdateActions(e){const{messages:r,messagesCommon:i}=this,s={id:"select",label:i.select};return j("div",{key:"update-actions"},j(Gx,{level:k3(this.headingLevel)},r.editFeatures),j("calcite-list",{selectionMode:"single",selectionAppearance:"border"},Nee({grouped:!1,item:s,selectedItem:e==="awaiting-feature-to-update"?s:void 0,renderIcon:this._renderSelectIcon,onItemSelect:this._onToggleUpdateWorkflow})))}_renderCreateActions(){const{_featureTemplates:e,headingLevel:r,messages:i}=this;return j("div",{key:"create-actions"},j(Gx,{level:k3(r)},i.createFeatures),j("div",{key:"templates",class:ri.featureTemplatesContainer},e.render()))}_renderTemplateLabel(e){return e.label}_renderTemplateDescription(e){const r=this._getUploadForTemplateItem(e);if(!r)return null;const{messages:i}=this;switch(r.state){case"pending":return i?.uploadPending;case"error":return i?.uploadError;default:return null}}_renderTemplateContentEnd(e){const r=this._getUploadForTemplateItem(e),i=j("calcite-icon",{key:"upload-icon",class:ri.templateItemContentEnd,icon:"upload-to"});if(!r)return e.supportsUpload?i:null;switch(r.state){case"success":return j("calcite-icon",{key:"success-icon",class:this.classes(ri.templateItemContentEnd,ri.templateItemContentEndSuccess),icon:"check"});case"error":return j("calcite-icon",{key:"error-icon",class:this.classes(ri.templateItemContentEnd,ri.templateItemContentEndError),icon:"exclamation-mark-circle-f"});case"pending":return j("calcite-loader",{class:ri.templateItemLoader,inline:!0,key:"loader",label:"",scale:"s",type:"indeterminate"});case"canceled":case"default":return i}}_getUploadForTemplateItem(e){const r=this.activeWorkflow;if(r?.type!=="create-features")return null;const{data:i}=r,{creationInfo:s,upload:n}=i;return s?.template===e.template&&s?.layer===e.layer?n:null}_renderFeatureList(e){const{EditorPanel:r,_onBack:i,headingLevel:s,messages:n,messagesTemplates:o,viewModel:{activeWorkflow:a,editableItems:l}}=this;if(a?.type!=="update")return null;const c=a.data.candidates,h=s1(n.multipleFeaturesTemplate,{total:c.length}),p=new Map;let f=0;c.map(_=>({label:this._getLabel(_),id:_.attributes[_.layer.objectIdField],data:_})).filter(_=>{const{label:v,data:b}=_,x=this._filterText.toLowerCase(),{title:T}=b.layer,S=l.find(M=>M.layer===b.layer);if(!S)return null;const{attachmentsOnUpdateEnabled:O,supports:A}=S;return(A.includes("update")||A.includes("delete")||O)&&(!x||v?.toLowerCase().includes(x)||T?.toLowerCase().includes(x))}).filter(Ia).forEach(_=>{f++;const v=_.data.layer;p.has(v)?p.get(v)?.items.push(_):p.set(v,{id:`${v.id}`,label:v.title??"",items:[_]})});const m=l.toArray().map(({layer:_})=>p.get(_)).filter(Ia),g=f>10||this._filterText.length>0;return j(r,{active:this._isPanelActive(e),key:"feature-list",heading:h,headingLevel:s,handleBack:i},j("div",{key:"feature-list",class:ri.panelContent},j("div",{class:ri.panelContentSection},eCe({enableListScroll:!1,filterEnabled:g,filterText:this._filterText,id:this.id,items:m,messages:{filterPlaceholder:o.filterPlaceholder,noItems:o.noItems,noMatches:o.noMatches},onFilterChange:_=>this._filterText=_,onItemMouseEnter:_=>this.viewModel.selectFeature(_.data),onItemMouseLeave:()=>this.viewModel.selectFeature(null),onItemSelect:_=>this.viewModel.selectFeature(_.data,!0)}))))}_isPanelActive(e){return this.viewModel.state===e}_renderSettings(){const e=this.visibleElements,r=e.snappingControls,i=e.sketchTooltipControls;return r||i?j("calcite-accordion",{key:"settings",class:ri.settingsContainer,appearance:"transparent"},j("calcite-accordion-item",{heading:this.messagesCommon?.settings,iconStart:"gear"},i&&j(Ay,{tooltipOptions:this.tooltipOptions}),r&&j($st,{snappingOptions:this.snappingOptions,view:this.view,visibleElements:e.snappingControlsElements,afterCreate:s=>s.layerListOpen=!1}))):null}_getLabel(e){const r=e.layer;if(!r)return null;const i=r.fieldsIndex.get(r.objectIdField),s=i.alias||i.name,{attributes:n}=e,o=HQ(r);return o&&n[o]&&`${n[o]}`||`${s}: ${n[i.name]}`}_showPrompt({title:e,message:r,yesLabel:i,noLabel:s}){const n=nn(),{view:o}=this,a=o?.focused;return this._prompt={title:e,message:r,context:"danger",actions:{primary:{label:i,action:()=>n.resolve(!0)},secondary:{label:s,action:()=>n.resolve(!1)}}},n.promise.finally(()=>{this._clearPrompt(),a&&o?.focus()})}_onSave(){this.viewModel.saveWorkflow()}_onDelete(){const{messages:e,messagesCommon:r}=this;this._prompt={title:e.deleteWarningTitle,message:e.deleteWarningMessage,context:"danger",actions:{primary:{label:r.delete,action:()=>{this.deleteFeatureFromWorkflow(),this._clearPrompt()}},secondary:{label:e.keepFeature,action:this._clearPrompt}}}}async _onBack(e){return e?.stopPropagation(),this.viewModel.back()}_onAttachmentAdd(){const{activeWorkflow:e}=this.viewModel;e&&(e.type==="create-features"?(this._attachments.addFile(),e.back()):this._attachments.addAttachment().then(()=>e.back()))}_onAttachmentUpdate(){const{activeWorkflow:e}=this.viewModel;e&&(e.type==="create-features"?(this._attachments.updateFile(),e.back()):this._attachments.updateAttachment().then(()=>e.back()))}_onAttachmentDelete(){const{messages:e,messagesCommon:r}=this;this._prompt={title:e.deleteAttachmentWarningTitle,message:e.deleteAttachmentWarningMessage,context:"danger",actions:{primary:{label:r.delete,action:this._onAttachmentDeleteConfirm},secondary:{label:e.keepAttachment,action:this._clearPrompt}}}}};u([d()],fi.prototype,"_featureForm",void 0),u([d()],fi.prototype,"_attachments",void 0),u([d()],fi.prototype,"_featureTemplates",void 0),u([d()],fi.prototype,"_filterText",void 0),u([d()],fi.prototype,"_prompt",void 0),u([d()],fi.prototype,"_spinner",void 0),u([d()],fi.prototype,"_deleteButtonCommonInfo",null),u([d({readOnly:!0})],fi.prototype,"activeWorkflow",null),u([d()],fi.prototype,"allowedWorkflows",null),u([d()],fi.prototype,"useDeprecatedCreateWorkflow",null),u([d()],fi.prototype,"headingLevel",void 0),u([d()],fi.prototype,"iconClass",void 0),u([d()],fi.prototype,"label",null),u([d()],fi.prototype,"labelOptions",null),u([d()],fi.prototype,"layerInfos",null),u([d(),Aa("esri/widgets/Editor/t9n/Editor")],fi.prototype,"messages",void 0),u([d(),Aa("esri/t9n/common")],fi.prototype,"messagesCommon",void 0),u([d(),Aa("esri/widgets/FeatureTemplates/t9n/FeatureTemplates")],fi.prototype,"messagesTemplates",void 0),u([d()],fi.prototype,"snappingOptions",null),u([d()],fi.prototype,"tooltipOptions",null),u([d()],fi.prototype,"supportingWidgetDefaults",void 0),u([d()],fi.prototype,"view",null),u([d(),Cee(["workflow-cancel","workflow-commit"])],fi.prototype,"viewModel",void 0),u([d()],fi.prototype,"visibleElements",void 0),u([or("visibleElements")],fi.prototype,"castVisibleElements",null),u([Hm()],fi.prototype,"_onSave",null),u([Hm()],fi.prototype,"_onDelete",null),u([Hm()],fi.prototype,"_onBack",null),u([Hm()],fi.prototype,"_onAttachmentAdd",null),u([Hm()],fi.prototype,"_onAttachmentUpdate",null),u([Hm()],fi.prototype,"_onAttachmentDelete",null),fi=u([R(kAe)],fi);const Dst=fi;async function UAe(t,e){return await t.load(),Nst(t,e)}async function Nst(t,e){const r=[],i=(...n)=>{for(const o of n)o!=null&&(Array.isArray(o)?i(...o):Ke.isCollection(o)?o.forEach(a=>i(a)):_g.isLoadable(o)&&r.push(o))};e(i);let s=null;if(await $Je(r,async n=>{const o=await Sh(Fst(n)?n.loadAll():n.load());o.ok!==!1||s||(s=o)}),s)throw s.error;return t}function Fst(t){return"loadAll"in t&&typeof t.loadAll=="function"}async function kst(t){if(!t)return;const e=t.includes("-vector")?t.slice(0,t.indexOf("-vector")):t,r=await ove("esri/t9n/basemaps");return r[t]||r[e]}const hZ={streets:{id:"streets",classic:!0,deprecated:!0,get thumbnailUrl(){return Dr("esri/images/basemap/streets.jpg")},baseMapLayers:[{id:"streets-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Street Map",showLegend:!1,visibility:!0,opacity:1}]},satellite:{id:"satellite",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/satellite.jpg")},baseMapLayers:[{id:"satellite-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1}]},hybrid:{id:"hybrid",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/hybrid.jpg")},baseMapLayers:[{id:"hybrid-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Imagery",showLegend:!1,visibility:!0,opacity:1},{id:"hybrid-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/30d6b8271e1849cd9c3042060001f425/resources/styles/root.json",layerType:"VectorTileLayer",title:"Hybrid Reference Layer",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},terrain:{id:"terrain",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/terrain.jpg")},baseMapLayers:[{id:"terrain-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Terrain_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Terrain Base",showLegend:!1,visibility:!0,opacity:1},{id:"terrain-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Reference_Overlay/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Reference Overlay",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},topo:{id:"topo",classic:!0,deprecated:!0,get thumbnailUrl(){return Dr("esri/images/basemap/topo.jpg")},baseMapLayers:[{id:"topo-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Topo Map",showLegend:!1,visibility:!0,opacity:1}]},gray:{id:"gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Dr("esri/images/basemap/gray.jpg")},baseMapLayers:[{id:"gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Light_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Light Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"dark-gray":{id:"dark-gray",classic:!0,deprecated:!0,get thumbnailUrl(){return Dr("esri/images/basemap/dark-gray.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Base",showLegend:!1,visibility:!0,opacity:1},{id:"dark-gray-reference-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/Canvas/World_Dark_Gray_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Dark Gray Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},oceans:{id:"oceans",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/oceans.jpg")},baseMapLayers:[{id:"oceans-base-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Base",showLegend:!1,visibility:!0,opacity:1},{id:"oceans-reference-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Ocean/World_Ocean_Reference/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Ocean Reference",isReference:!0,showLegend:!1,visibility:!0,opacity:1}]},"national-geographic":{id:"national-geographic",classic:!0,deprecated:!0,get thumbnailUrl(){return Dr("esri/images/basemap/national-geographic.jpg")},baseMapLayers:[{id:"national-geographic-base-layer",url:"//services.arcgisonline.com/ArcGIS/rest/services/NatGeo_World_Map/MapServer",title:"NatGeo World Map",showLegend:!1,layerType:"ArcGISTiledMapServiceLayer",visibility:!0,opacity:1}]},osm:{id:"osm",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/osm.jpg")},baseMapLayers:[{id:"osm-base-layer",layerType:"OpenStreetMap",title:"Open Street Map",showLegend:!1,visibility:!0,opacity:1}]},"dark-gray-vector":{id:"dark-gray-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/dark-gray-vector.jpg")},baseMapLayers:[{id:"dark-gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/5e9b3685f4c24d8781073dd928ebda50/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Base",visibility:!0,opacity:1},{id:"dark-gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/747cb7a5329c478cbe6981076cc879c5/resources/styles/root.json",layerType:"VectorTileLayer",title:"Dark Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"gray-vector":{id:"gray-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/gray-vector.jpg")},baseMapLayers:[{id:"gray-base-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/291da5eab3a0412593b66d384379f89f/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Base",visibility:!0,opacity:1},{id:"gray-reference-layer",styleUrl:"https://cdn.arcgis.com/sharing/rest/content/items/1768e8369a214dfab4e2167d5c5f2454/resources/styles/root.json",layerType:"VectorTileLayer",title:"Light Gray Reference",isReference:!0,visibility:!0,opacity:1}]},"streets-vector":{id:"streets-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/streets-vector.jpg")},baseMapLayers:[{id:"streets-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/de26a3cf4cc9451298ea173c4b324736/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets",visibility:!0,opacity:1}]},"topo-vector":{id:"topo-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/topo-vector.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"topo-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/7dc6cea0b1764a1f9af2e679f642f0f5/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Topo",visibility:!0,opacity:1}]},"streets-night-vector":{id:"streets-night-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/streets-night.jpg")},baseMapLayers:[{id:"streets-night-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/86f556a2d1fd468181855a35e344567f/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Night",visibility:!0,opacity:1}]},"streets-relief-vector":{id:"streets-relief-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/streets-relief.jpg")},baseMapLayers:[{id:"world-hillshade-layer",url:"//services.arcgisonline.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer",layerType:"ArcGISTiledMapServiceLayer",title:"World Hillshade",showLegend:!1,visibility:!0,opacity:1},{id:"streets-relief-vector-base-layer",styleUrl:"//www.arcgis.com/sharing/rest/content/items/b266e6d17fc345b498345613930fbd76/resources/styles/root.json",title:"World Streets Relief",layerType:"VectorTileLayer",visibility:!0,opacity:1}]},"streets-navigation-vector":{id:"streets-navigation-vector",classic:!0,get thumbnailUrl(){return Dr("esri/images/basemap/streets-navigation.jpg")},baseMapLayers:[{id:"streets-navigation-vector-base-layer",styleUrl:"//cdn.arcgis.com/sharing/rest/content/items/63c47b7177f946b49902c24129b87252/resources/styles/root.json",layerType:"VectorTileLayer",title:"World Streets Navigation",visibility:!0,opacity:1}]},"arcgis-imagery":{get thumbnailUrl(){return Dr("esri/images/basemap/hybrid.jpg")},title:"Imagery Hybrid",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-imagery-standard":{get thumbnailUrl(){return Dr("esri/images/basemap/satellite.jpg")},title:"Imagery",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Imagery",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/World_Imagery/MapServer"}]},"arcgis-imagery-labels":{title:"Hybrid [Reference]",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Imagery:Labels",title:"Hybrid Reference Layer",isReference:!0}]},"arcgis-light-gray":{get thumbnailUrl(){return Dr("esri/images/basemap/gray-vector.jpg")},title:"Light Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Base",title:"Light Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:LightGray:Labels",title:"Light Gray Canvas Labels",isReference:!0}]},"arcgis-dark-gray":{get thumbnailUrl(){return Dr("esri/images/basemap/dark-gray.jpg")},title:"Dark Gray Canvas",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Base",title:"Dark Gray Canvas Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:DarkGray:Labels",title:"Dark Gray Canvas Labels",isReference:!0}]},"arcgis-navigation":{get thumbnailUrl(){return Dr("esri/images/basemap/streets-navigation.jpg")},title:"Navigation",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Navigation",title:"World Navigation Map"}]},"arcgis-navigation-night":{title:"Navigation (Dark Mode)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:NavigationNight",title:"World Navigation Map (Dark Mode)"}]},"arcgis-streets":{get thumbnailUrl(){return Dr("esri/images/basemap/streets-vector.jpg")},title:"Streets",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Streets",title:"World Street Map"}]},"arcgis-streets-night":{get thumbnailUrl(){return Dr("esri/images/basemap/streets-night.jpg")},title:"Streets (Night)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsNight",title:"World Street Map (Night)"}]},"arcgis-streets-relief":{get thumbnailUrl(){return Dr("esri/images/basemap/streets-relief.jpg")},title:"Streets (with Relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:StreetsRelief:Base",title:"World Street Map (with Relief)"}]},"arcgis-topographic":{get thumbnailUrl(){return Dr("esri/images/basemap/topo.jpg")},title:"Topographic",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Topographic:Base",title:"World Topographic Map"}]},"arcgis-oceans":{get thumbnailUrl(){return Dr("esri/images/basemap/oceans.jpg")},title:"Oceans",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Ocean Base",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Ocean/World_Ocean_Base/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Oceans:Labels",title:"World Ocean Reference",isReference:!0}]},"osm-standard":{title:"OpenStreetMap",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Standard",title:"OpenStreetMap"}]},"osm-standard-relief":{title:"OpenStreetMap (with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StandardRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-streets":{title:"OpenStreetMap (Streets)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:Streets",title:"OpenStreetMap (Streets)"}]},"osm-streets-relief":{title:"OpenStreetMap (Streets with relief)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:StreetsRelief:Base",layerType:"VectorTileLayer",title:"OpenStreetMap Relief Base"}]},"osm-light-gray":{title:"OpenStreetMap (Light Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Base",title:"OSM (Light Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:LightGray:Labels",title:"OSM (Light Gray Reference)",isReference:!0}]},"osm-dark-gray":{title:"OpenStreetMap (Dark Gray Canvas)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Base",title:"OSM (Dark Gray Base)"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/OSM:DarkGray:Labels",title:"OSM (Dark Gray Reference)",isReference:!0}]},"arcgis-terrain":{title:"Terrain with Labels",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Base",title:"World Terrain Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Terrain:Detail",title:"World Terrain Reference",isReference:!0}]},"arcgis-community":{title:"Community",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Community",title:"Community"}]},"arcgis-charted-territory":{title:"Charted Territory",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ChartedTerritory:Base",title:"Charted Territory"}]},"arcgis-colored-pencil":{title:"Colored Pencil",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ColoredPencil",title:"Colored Pencil"}]},"arcgis-nova":{title:"Nova",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Nova",title:"Nova"}]},"arcgis-modern-antique":{title:"Modern Antique",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:ModernAntique:Base",title:"Modern Antique"}]},"arcgis-midcentury":{title:"Mid-Century",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Midcentury",title:"Mid-Century"}]},"arcgis-newspaper":{title:"Newspaper",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:Newspaper",title:"Newspaper"}]},"arcgis-hillshade-light":{title:"Hillshade",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade/MapServer"}]},"arcgis-hillshade-dark":{title:"Hillshade (Dark)",baseMapLayers:[{layerType:"ArcGISTiledMapServiceLayer",showLegend:!1,title:"World Hillshade (Dark)",url:"https://ibasemaps-api.arcgis.com/arcgis/rest/services/Elevation/World_Hillshade_Dark/MapServer"}]},"arcgis-human-geography":{title:"Human Geography",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Base",title:"Human Geography Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Detail",title:"Human Geography Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeography:Label",title:"Human Geography Label",isReference:!0}]},"arcgis-human-geography-dark":{title:"Human Geography (Dark)",baseMapLayers:[{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Base",title:"Human Geography Dark Base"},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Detail",title:"Human Geography Dark Detail",isReference:!0},{layerType:"VectorTileLayer",styleUrl:"https://basemaps-api.arcgis.com/arcgis/rest/services/styles/ArcGIS:HumanGeographyDark:Label",title:"Human Geography Dark Label",isReference:!0}]}},Ust=new Set(["bing-maps","imagery","imagery-tile","map-image","open-street-map","tile","unknown","unsupported","vector-tile","web-tile","wms","wmts"]),Vst=new Set(["csv","feature","geo-rss","geojson","group","imagery","imagery-tile","kml","map-image","map-notes","media","ogc-feature","route","stream","subtype-group","tile","unknown","unsupported","vector-tile","web-tile","wfs","wms","wmts"]);function zst(t){return t.layerContainerType==="basemap"?Ust:t.layerContainerType==="operational-layers"?Vst:null}function Bst(t,e){if(e.restrictedWebMapWriting){const r=zst(e);return r==null||r.has(t.type)&&!SK(t)}return!0}function Gst(t,e){if(e)if(SK(t)){const r=Ky("featureCollection.layers",e),i=r&&r[0]&&r[0].layerDefinition;i&&gce(t,i)}else t.type!=="group"&&gce(t,e)}function gce(t,e){"maxScale"in t&&(e.maxScale=Q5(t.maxScale)??void 0),"minScale"in t&&(e.minScale=Q5(t.minScale)??void 0)}function jst(t,e){if(Gst(t,e),e&&("blendMode"in t&&(e.blendMode=t.blendMode,e.blendMode==="normal"&&delete e.blendMode),e.opacity=Q5(t.opacity)??void 0,e.title=t.title||"Layer",e.visibility=t.visible,"legendEnabled"in t&&t.type!=="wmts"))if(SK(t)){const r=e.featureCollection;r&&(r.showLegend=t.legendEnabled)}else e.showLegend=t.legendEnabled}function yce(t,e,r){if(!("write"in t)||!t.write)return r&&r.messages&&r.messages.push(new D("layer:unsupported",`Layers (${t.title}, ${t.id}) of type '${t.declaredClass}' cannot be persisted`,{layer:t})),null;if(Bst(t,r)){const i={};return t.write(i,r)?i:null}return e!=null&&jst(t,e=re(e)),e}var R4;let Hst=0;const VAe="esri.Basemap";let Kh=R4=class extends iS(_g){constructor(t){super(t),this.id=null,this.portalItem=null,this.spatialReference=null,this.thumbnailUrl=null,this.title="Basemap",this.id=Date.now().toString(16)+"-basemap-"+Hst++,this.baseLayers=new Ke,this.referenceLayers=new Ke;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type==="elevation"&&K.getLogger(this).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a basemap layer and will therefore be ignored.`)},r=i=>{i.parent=null};this.addHandles([this.baseLayers.on("after-add",i=>e(i.item)),this.referenceLayers.on("after-add",i=>e(i.item)),this.baseLayers.on("after-remove",i=>r(i.item)),this.referenceLayers.on("after-remove",i=>r(i.item))])}initialize(){this.when().catch(t=>{K.getLogger(this).error("#load()",`Failed to load basemap (title: '${this.title}', id: '${this.id}')`,t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const t=this.baseLayers.removeAll();for(const r of t)r.destroy();const e=this.referenceLayers.removeAll();for(const r of e)r.destroy();this.baseLayers.destroy(),this.referenceLayers.destroy(),this.portalItem?.destroy(),this.portalItem=null}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set baseLayers(t){this._set("baseLayers",$T(t,this._get("baseLayers")))}_writeBaseLayers(t,e,r){const i=[];t&&(r={...r,layerContainerType:"basemap"},this.baseLayers.forEach(s=>{const n=yce(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);n!=null&&i.push(n)}),this.referenceLayers.forEach(s=>{const n=yce(s,r.webmap?r.webmap.getLayerJSONFromResourceInfo(s):null,r);n!=null&&(s.type!=="scene"&&(n.isReference=!0),i.push(n))})),e.baseMapLayers=i}set referenceLayers(t){this._set("referenceLayers",$T(t,this._get("referenceLayers")))}writeTitle(t,e){e.title=t||"Basemap"}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return UAe(this,t=>{t(this.baseLayers,this.referenceLayers)})}clone(){const t={id:this.id,title:this.title,portalItem:this.portalItem,baseLayers:this.baseLayers.map(e=>R5(e)?e.clone():e),referenceLayers:this.referenceLayers.map(e=>R5(e)?e.clone():e)};return this.loaded&&(t.loadStatus="loaded"),new R4({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}write(t,e){return t=t||{},e&&e.origin||(e={origin:"web-map",...e}),super.write(t,e),!this.loaded&&this.resourceInfo&&this.resourceInfo.data.baseMapLayers&&(t.baseMapLayers=this.resourceInfo.data.baseMapLayers.map(r=>{const i=re(r);return i.url&&mg(i.url)&&(i.url=`https:${i.url}`),i.templateUrl&&mg(i.templateUrl)&&(i.templateUrl=`https:${i.templateUrl}`),i})),t}async _loadFromSource(t){const{resourceInfo:e,portalItem:r}=this;Dt(t);const i=[];if(e){const s=e.context?e.context.url:null;if(i.push(this._loadLayersFromJSON(e.data,s,t)),e.data.id&&!e.data.title){const n=e.data.id;i.push(kst(n).then(o=>{o&&this.read({title:o},e.context)}))}}else r&&i.push(this._loadFromItem(r,t));await Promise.all(i)}async _loadLayersFromJSON(t,e,r){const i=this.resourceInfo&&this.resourceInfo.context,s=this.portalItem&&this.portalItem.portal||i&&i.portal||null,n=Wst[i?.origin||""]??"web-map",{populateOperationalLayers:o}=await J(()=>import("./layersCreator-0aeae026.js"),["./layersCreator-0aeae026.js","./lazyLayerLoader-8431db42.js","./portalLayers-a52f7a02.js","./layersLoader-4ff997b9.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url),a=[];if(Dt(r),t.baseMapLayers&&Array.isArray(t.baseMapLayers)){const l={context:{origin:n,url:e,portal:s,layerContainerType:"basemap"},defaultLayerType:"DefaultTileLayer"},c=f=>n==="web-scene"&&f.layerType==="ArcGISSceneServiceLayer"||f.isReference,h=o(this.baseLayers,t.baseMapLayers.filter(f=>!c(f)),l);a.push(h);const p=o(this.referenceLayers,t.baseMapLayers.filter(c),l);a.push(p)}await Oh(a)}async _loadFromItem(t,e){const r=await t.load(e),i=await r.fetchData("json",e),s=Fn(t.itemUrl??"");return this._set("resourceInfo",{data:i.baseMap??{},context:{origin:qst[t.type||""]??"web-map",portal:t.portal||ao.getDefault(),url:s}}),this.read(this.resourceInfo.data,this.resourceInfo.context),this.read({spatialReference:i.spatialReference},this.resourceInfo.context),this.read({title:t.title,thumbnailUrl:t.thumbnailUrl},{origin:"portal-item",portal:t.portal||ao.getDefault(),url:s}),this._loadLayersFromJSON(this.resourceInfo.data,s,e)}static fromId(t){const e=hZ[t];if(!e)return null;if(e.deprecated){let r=null;t==="dark-gray"?r="dark-gray-vector":t==="gray"?r="gray-vector":t==="streets"?r="streets-vector":t==="topo"&&(r="topo-vector"),z1(K.getLogger(VAe),`The ${t} basemap has entered mature support and is no longer being updated.`,{replacement:r,see:"https://arcg.is/1iq8aD",warnOnce:!0})}return R4.fromJSON(e)}};u([d({json:{write:{ignoreOrigin:!0,target:"baseMapLayers",writer(t,e,r,i){this._writeBaseLayers(t,e,i)}},origins:{"web-scene":{write:{ignoreOrigin:!0,target:{baseMapLayers:{type:Ke}},writer(t,e,r,i){this._writeBaseLayers(t,e,i)}}}}}})],Kh.prototype,"baseLayers",null),u([d({type:String,json:{origins:{"web-scene":{write:!0}}}})],Kh.prototype,"id",void 0),u([d({type:iT})],Kh.prototype,"portalItem",void 0),u([d()],Kh.prototype,"referenceLayers",null),u([d({readOnly:!0})],Kh.prototype,"resourceInfo",void 0),u([d({type:qe})],Kh.prototype,"spatialReference",void 0),u([d()],Kh.prototype,"thumbnailUrl",void 0),u([d({type:String,json:{origins:{"web-scene":{write:{isRequired:!0}}}}})],Kh.prototype,"title",void 0),u([Ve("title")],Kh.prototype,"writeTitle",null),Kh=R4=u([R(VAe)],Kh);const qst={"Web Scene":"web-scene","Web Map":"web-map","Link Chart":"link-chart"},Wst={"web-scene":"web-scene","web-map":"web-map","link-chart":"link-chart"},Qk=Kh,Zst=Object.freeze(Object.defineProperty({__proto__:null,default:Qk},Symbol.toStringTag,{value:"Module"}));var dZ;let M4=dZ=class extends he{constructor(t){super(t),this.type="none"}clone(){return new dZ({type:this.type})}};u([nt({none:"none",stayAbove:"stay-above"})],M4.prototype,"type",void 0),M4=dZ=u([R("esri.ground.NavigationConstraint")],M4);var pZ;let Oy=pZ=class extends iS(_g){constructor(t){super(t),this.opacity=1,this.surfaceColor=null,this.navigationConstraint=null,this.layers=new Ke;const e=i=>{i.parent&&i.parent!==this&&"remove"in i.parent&&i.parent.remove(i),i.parent=this,i.type!=="elevation"&&i.type!=="base-elevation"&&K.getLogger(this).error(`Layer '${i.title}, id:${i.id}' of type '${i.type}' is not supported as a ground layer and will therefore be ignored. Only layers of type 'elevation' are supported.`)},r=i=>{i.parent=null};this.addHandles([this.layers.on("after-add",i=>e(i.item)),this.layers.on("after-remove",i=>r(i.item))])}initialize(){this.when().catch(t=>{ws(t)||K.getLogger(this).error("#load()","Failed to load ground",t)}),this.resourceInfo&&this.read(this.resourceInfo.data,this.resourceInfo.context)}destroy(){const t=this.layers.removeAll();for(const e of t)e.destroy();this.layers.destroy()}normalizeCtorArgs(t){return t&&"resourceInfo"in t&&(this._set("resourceInfo",t.resourceInfo),delete(t={...t}).resourceInfo),t}set layers(t){this._set("layers",$T(t,this._get("layers")))}writeLayers(t,e,r,i){const s=[];t&&(i={...i,layerContainerType:"ground"},t.forEach(n=>{if("write"in n){const o={};ZHe(n)().write(o,i)&&s.push(o)}else i&&i.messages&&i.messages.push(new D("layer:unsupported",`Layers (${n.title}, ${n.id}) of type '${n.declaredClass}' cannot be persisted in the ground`,{layer:n}))})),e.layers=s}load(t){return this.addResolvingPromise(this._loadFromSource(t)),Promise.resolve(this)}loadAll(){return UAe(this,t=>{t(this.layers)})}async queryElevation(t,e){await this.load({signal:e?.signal});const{ElevationQuery:r}=await J(()=>import("./ElevationQuery-3d7c9fde.js"),[],import.meta.url);Dt(e);const i=new r,s=this.layers.filter(_ce).toArray();return i.queryAll(s,t,e)}async createElevationSampler(t,e){await this.load({signal:e?.signal});const{ElevationQuery:r}=await J(()=>import("./ElevationQuery-3d7c9fde.js"),[],import.meta.url);Dt(e);const i=new r,s=this.layers.filter(_ce).toArray();return i.createSamplerAll(s,t,e)}clone(){const t={opacity:this.opacity,surfaceColor:re(this.surfaceColor),navigationConstraint:re(this.navigationConstraint),layers:this.layers.slice()};return this.loaded&&(t.loadStatus="loaded"),new pZ({resourceInfo:this.resourceInfo}).set(t)}read(t,e){this.resourceInfo||this._set("resourceInfo",{data:t,context:e}),super.read(t,e)}_loadFromSource(t){const e=this.resourceInfo;return e?this._loadLayersFromJSON(e.data,e.context,t):Promise.resolve()}_loadLayersFromJSON(t,e,r){const i=e&&e.origin||"web-scene",s=e&&e.portal||null,n=e&&e.url||null;return J(()=>import("./layersCreator-0aeae026.js"),["./layersCreator-0aeae026.js","./lazyLayerLoader-8431db42.js","./portalLayers-a52f7a02.js","./layersLoader-4ff997b9.js","./fetchService-90a5bdb0.js","./jsonContext-56732455.js"],import.meta.url).then(({populateOperationalLayers:o})=>{Dt(r);const a=[];if(t.layers&&Array.isArray(t.layers)){const l={context:{origin:i,url:n,portal:s,layerContainerType:"ground"},defaultLayerType:"ArcGISTiledElevationServiceLayer"};a.push(o(this.layers,t.layers,l))}return Oh(a)}).then(()=>{})}};function Xst(t){return t&&"createElevationSampler"in t}function _ce(t){return t.type==="elevation"||Xst(t)}u([d({json:{read:!1}})],Oy.prototype,"layers",null),u([Ve("layers")],Oy.prototype,"writeLayers",null),u([d({readOnly:!0})],Oy.prototype,"resourceInfo",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{type:Ki,read:{reader:oA,source:"transparency"},write:{writer:(t,e)=>{e.transparency=Q6(t)},target:"transparency"}}})],Oy.prototype,"opacity",void 0),u([d({type:Le,json:{type:[Ki],write:(t,e)=>{e.surfaceColor=t.toJSON().slice(0,3)}}})],Oy.prototype,"surfaceColor",void 0),u([d({type:M4,json:{write:!0}})],Oy.prototype,"navigationConstraint",void 0),Oy=pZ=u([R("esri.Ground")],Oy);const Kk=Oy;let yE=class extends Ke{constructor(e){super(e),this.getCollections=null}initialize(){this.own(qve(()=>this._refresh()))}destroy(){this.getCollections=null}_refresh(){const e=this.getCollections!=null?this.getCollections():null;if(e==null)return void this.removeAll();let r=0;for(const i of e)i!=null&&(r=this._processCollection(r,i));this.splice(r,this.length)}_createNewInstance(e){return new Ke(e)}_processCollection(e,r){if(!r)return e;const i=this.itemFilterFunction??(s=>!!s);for(const s of r)if(s){if(i(s)){const n=this.indexOf(s,e);n>=0?n!==e&&this.reorder(s,e):this.add(s,e),++e}if(this.getChildrenFunction){const n=this.getChildrenFunction(s);if(Array.isArray(n))for(const o of n)e=this._processCollection(e,o);else e=this._processCollection(e,n)}}return e}};u([d()],yE.prototype,"getCollections",void 0),u([d()],yE.prototype,"getChildrenFunction",void 0),u([d()],yE.prototype,"itemFilterFunction",void 0),yE=u([R("esri.core.CollectionFlattener")],yE);const lP=yE,vce=K.getLogger("esri.support.basemapUtils");function Yst(){return{}}function Jst(t){for(const e in t){const r=t[e];r?.destroyed===!1&&r.destroy(),delete t[e]}}function Qst(t,e){let r;if(typeof t=="string"){if(!(t in hZ)){const i=Object.entries(hZ).filter(([s,n])=>qr.apiKey&&!n.classic||!qr.apiKey&&n.classic&&!n.deprecated).map(([s])=>`"${s}"`).join(", ");return vce.warn(`Unable to find basemap definition for: ${t}. Try one of these: ${i}`),null}e&&(r=e[t]),r||(r=Qk.fromId(t),e&&(e[t]=r))}else r=Sn(Qk,t);return r?.destroyed&&(vce.warn("The provided basemap is already destroyed",{basemap:r}),r=null),r}function Kst(t){return new lP({getCollections:()=>[t.tables,t.layers],getChildrenFunction:e=>{const r=[];return"tables"in e&&r.push(e.tables),"layers"in e&&r.push(e.layers),r},itemFilterFunction:e=>{const r=e.parent;return!!r&&"tables"in r&&r.tables.includes(e)}})}function Mz(t){for(const e of t.values())e?.destroy();t.clear()}const bce={"world-elevation":{id:"worldElevation",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/Terrain3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"},"world-topobathymetry":{id:"worldTopoBathymetry",url:"//elevation3d.arcgis.com/arcgis/rest/services/WorldElevation3D/TopoBathy3D/ImageServer",layerType:"ArcGISTiledElevationServiceLayer"}};function ent(t){let e=null;if(typeof t=="string")if(t in bce){const r=bce[t];e=new Kk({resourceInfo:{data:{layers:[r]}}})}else K.getLogger("esri.support.groundUtils").warn(`Unable to find ground definition for: ${t}. Try "world-elevation"`);else e=Sn(Kk,t);return e}function fZ(t,e,r){let i,s;if(t)for(let n=0,o=t.length;n<o;n++){if(i=t.at(n),i?.[e]===r)return i;if(i?.type==="group"&&(s=fZ(i.layers,e,r),s))return s}}const tnt=t=>{let e=class extends t{constructor(...r){super(...r),this.layers=new Ke;const i=o=>{o.parent&&"remove"in o.parent&&o.parent.remove(o)},s=o=>{o.parent=this,this.layerAdded(o),o.type!=="elevation"&&o.type!=="base-elevation"||K.getLogger(this).error(`Layer 'title:${o.title}, id:${o.id}' of type '${o.type}' is not supported as an operational layer and will therefore be ignored.`)},n=o=>{o.parent=null,this.layerRemoved(o)};this.addHandles([this.layers.on("before-add",o=>i(o.item)),this.layers.on("after-add",o=>s(o.item)),this.layers.on("after-remove",o=>n(o.item))])}destroy(){const r=this.layers.toArray();for(const i of r)i.destroy();this.layers.destroy()}set layers(r){this._set("layers",$T(r,this._get("layers")))}add(r,i){const s=this.layers;if(i=s.getNextIndex(i),r instanceof gV){const n=r;n.parent===this?this.reorder(n,i):s.add(n,i)}else Rh(r)?r.then(n=>{this.destroyed||this.add(n,i)}):K.getLogger(this).error("#add()","The item being added is not a Layer or a Promise that resolves to a Layer.")}addMany(r,i){const s=this.layers;let n=s.getNextIndex(i);r.slice().forEach(o=>{o.parent!==this?(s.add(o,n),n+=1):this.reorder(o,n)})}findLayerById(r){return fZ(this.layers,"id",r)}findLayerByUid(r){return fZ(this.layers,"uid",r)}remove(r){return this.layers.remove(r)}removeMany(r){return this.layers.removeMany(r)}removeAll(){return this.layers.removeAll()}reorder(r,i){return this.layers.reorder(r,i)}layerAdded(r){}layerRemoved(r){}};return u([d()],e.prototype,"layers",null),e=u([R("esri.support.LayersMixin")],e),e};function mZ(t,e,r){if(t)for(let i=0,s=t.length;i<s;i++){const n=t.at(i);if(n[e]===r)return n;if(n?.type==="group"){const o=mZ(n.tables,e,r);if(o)return o}}}const rnt=t=>{let e=class extends t{constructor(...r){super(...r),this.tables=new Ke,this.addHandles([this.tables.on("after-add",i=>{const s=i.item;s.parent&&s.parent!==this&&"tables"in s.parent&&s.parent.tables.remove(s),s.parent=this,s.type!=="feature"&&K.getLogger(this).error(`Layer 'title:${s.title}, id:${s.id}' of type '${s.type}' is not supported as a table and will therefore be ignored.`)}),this.tables.on("after-remove",i=>{i.item.parent=null})])}destroy(){const r=this.tables.removeAll();for(const i of r)i.destroy();this.tables.destroy()}set tables(r){this._set("tables",$T(r,this._get("tables")))}findTableById(r){return mZ(this.tables,"id",r)}findTableByUid(r){return mZ(this.tables,"uid",r)}};return u([d()],e.prototype,"tables",null),e=u([R("esri.support.TablesMixin")],e),e};let Om=class extends rnt(tnt(Xr.EventedMixin(me))){constructor(e){super(e),this.allLayers=new lP({getCollections:()=>[this.basemap?.baseLayers,this.ground?.layers,this.layers,this.basemap?.referenceLayers],getChildrenFunction:r=>"layers"in r?r.layers:null}),this.allTables=Kst(this),this.basemap=null,this.editableLayers=new lP({getCollections:()=>[this.allLayers],itemFilterFunction:uV}),this.ground=new Kk,this._basemapCache=Yst()}destroy(){this.allLayers.destroy(),this.allTables.destroy(),this.editableLayers.destroy(),this.ground?.destroy(),this.basemap?.destroy(),Jst(this._basemapCache),this._basemapCache=null}castBasemap(e){return Qst(e,this._basemapCache)}castGround(e){return ent(e)??this._get("ground")}findLayerById(e){return this.allLayers.find(r=>r.id===e)}findTableById(e){return this.allTables.find(r=>r.id===e)}};u([d({readOnly:!0,dependsOn:[]})],Om.prototype,"allLayers",void 0),u([d({readOnly:!0})],Om.prototype,"allTables",void 0),u([d({type:Qk})],Om.prototype,"basemap",void 0),u([or("basemap")],Om.prototype,"castBasemap",null),u([d({readOnly:!0})],Om.prototype,"editableLayers",void 0),u([d({type:Kk,nonNullable:!0})],Om.prototype,"ground",void 0),u([or("ground")],Om.prototype,"castGround",null),Om=u([R("esri.Map")],Om);const zAe=Om,eD="esri-identity-form",Lu={base:eD,group:`${eD}__group`,label:`${eD}__label`,footer:`${eD}__footer`,esriInput:"esri-input",esriButton:"esri-button",esriButtonSecondary:"esri-button--secondary"},int="ArcGIS Online";let Ry=class extends Rc{constructor(e,r){super(e,r),this._usernameInputNode=null,this._passwordInputNode=null,this.signingIn=!1,this.server=null,this.resource=null,this.error=null,this.oAuthPrompt=!1}render(){const{error:e,server:r,resource:i,signingIn:s,oAuthPrompt:n,messages:o}=this,a=j("div",{class:Lu.group},s1(n?o.oAuthInfo:o.info,{server:r&&/\.arcgis\.com/i.test(r)?int:r,resource:`(${i||o.lblItem})`})),l=n?null:j("div",{class:Lu.group,key:"username"},j("label",{class:Lu.label},o.lblUser,j("input",{value:"",required:!0,autocomplete:"off",spellcheck:!1,type:"text",bind:this,afterCreate:uk,"data-node-ref":"_usernameInputNode",class:Lu.esriInput}))),c=n?null:j("div",{class:Lu.group,key:"password"},j("label",{class:Lu.label},o.lblPwd,j("input",{value:"",required:!0,type:"password",bind:this,afterCreate:uk,"data-node-ref":"_passwordInputNode",class:Lu.esriInput}))),h=j("div",{class:this.classes(Lu.group,Lu.footer)},j("input",{type:"submit",disabled:!!s,value:s?o.lblSigning:o.lblOk,class:Lu.esriButton}),j("input",{type:"button",value:o.lblCancel,bind:this,onclick:this._cancel,class:this.classes(Lu.esriButton,Lu.esriButtonSecondary)})),p=e?j("div",null,e.details&&e.details.httpStatus?o.invalidUser:o.noAuthService):null;return j("form",{class:Lu.base,bind:this,onsubmit:this._submit},a,p,l,c,h)}_cancel(){this._set("signingIn",!1),this._usernameInputNode&&(this._usernameInputNode.value=""),this._passwordInputNode&&(this._passwordInputNode.value=""),this.emit("cancel")}_submit(e){e.preventDefault(),this._set("signingIn",!0);const r=this.oAuthPrompt?{}:{username:this._usernameInputNode&&this._usernameInputNode.value,password:this._passwordInputNode&&this._passwordInputNode.value};this.emit("submit",r)}};u([d(),Aa("esri/identity/t9n/identity")],Ry.prototype,"messages",void 0),u([d()],Ry.prototype,"signingIn",void 0),u([d()],Ry.prototype,"server",void 0),u([d()],Ry.prototype,"resource",void 0),u([d()],Ry.prototype,"error",void 0),u([d()],Ry.prototype,"oAuthPrompt",void 0),Ry=u([R("esri.identity.IdentityForm")],Ry);const snt=Ry;/*!
* tabbable 6.1.2
* @license MIT, https://github.com/focus-trap/tabbable/blob/master/LICENSE
*/var BAe=["input:not([inert])","select:not([inert])","textarea:not([inert])","a[href]:not([inert])","button:not([inert])","[tabindex]:not(slot):not([inert])","audio[controls]:not([inert])","video[controls]:not([inert])",'[contenteditable]:not([contenteditable="false"]):not([inert])',"details>summary:first-of-type:not([inert])","details:not([inert])"],eU=BAe.join(","),GAe=typeof Element>"u",kT=GAe?function(){}:Element.prototype.matches||Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector,tU=!GAe&&Element.prototype.getRootNode?function(t){var e;return t==null||(e=t.getRootNode)===null||e===void 0?void 0:e.call(t)}:function(t){return t?.ownerDocument},rU=function t(e,r){var i;r===void 0&&(r=!0);var s=e==null||(i=e.getAttribute)===null||i===void 0?void 0:i.call(e,"inert"),n=s===""||s==="true",o=n||r&&e&&t(e.parentNode);return o},nnt=function(e){var r,i=e==null||(r=e.getAttribute)===null||r===void 0?void 0:r.call(e,"contenteditable");return i===""||i==="true"},jAe=function(e,r,i){if(rU(e))return[];var s=Array.prototype.slice.apply(e.querySelectorAll(eU));return r&&kT.call(e,eU)&&s.unshift(e),s=s.filter(i),s},HAe=function t(e,r,i){for(var s=[],n=Array.from(e);n.length;){var o=n.shift();if(!rU(o,!1))if(o.tagName==="SLOT"){var a=o.assignedElements(),l=a.length?a:o.children,c=t(l,!0,i);i.flatten?s.push.apply(s,c):s.push({scopeParent:o,candidates:c})}else{var h=kT.call(o,eU);h&&i.filter(o)&&(r||!e.includes(o))&&s.push(o);var p=o.shadowRoot||typeof i.getShadowRoot=="function"&&i.getShadowRoot(o),f=!rU(p,!1)&&(!i.shadowRootFilter||i.shadowRootFilter(o));if(p&&f){var m=t(p===!0?o.children:p.children,!0,i);i.flatten?s.push.apply(s,m):s.push({scopeParent:o,candidates:m})}else n.unshift.apply(n,o.children)}}return s},qAe=function(e,r){return e.tabIndex<0&&(r||/^(AUDIO|VIDEO|DETAILS)$/.test(e.tagName)||nnt(e))&&isNaN(parseInt(e.getAttribute("tabindex"),10))?0:e.tabIndex},ont=function(e,r){return e.tabIndex===r.tabIndex?e.documentOrder-r.documentOrder:e.tabIndex-r.tabIndex},WAe=function(e){return e.tagName==="INPUT"},ant=function(e){return WAe(e)&&e.type==="hidden"},lnt=function(e){var r=e.tagName==="DETAILS"&&Array.prototype.slice.apply(e.children).some(function(i){return i.tagName==="SUMMARY"});return r},cnt=function(e,r){for(var i=0;i<e.length;i++)if(e[i].checked&&e[i].form===r)return e[i]},unt=function(e){if(!e.name)return!0;var r=e.form||tU(e),i=function(a){return r.querySelectorAll('input[type="radio"][name="'+a+'"]')},s;if(typeof window<"u"&&typeof window.CSS<"u"&&typeof window.CSS.escape=="function")s=i(window.CSS.escape(e.name));else try{s=i(e.name)}catch(o){return console.error("Looks like you have a radio button with a name attribute containing invalid CSS selector characters and need the CSS.escape polyfill: %s",o.message),!1}var n=cnt(s,e.form);return!n||n===e},hnt=function(e){return WAe(e)&&e.type==="radio"},dnt=function(e){return hnt(e)&&!unt(e)},pnt=function(e){var r,i=e&&tU(e),s=(r=i)===null||r===void 0?void 0:r.host,n=!1;if(i&&i!==e){var o,a,l;for(n=!!((o=s)!==null&&o!==void 0&&(a=o.ownerDocument)!==null&&a!==void 0&&a.contains(s)||e!=null&&(l=e.ownerDocument)!==null&&l!==void 0&&l.contains(e));!n&&s;){var c,h,p;i=tU(s),s=(c=i)===null||c===void 0?void 0:c.host,n=!!((h=s)!==null&&h!==void 0&&(p=h.ownerDocument)!==null&&p!==void 0&&p.contains(s))}}return n},wce=function(e){var r=e.getBoundingClientRect(),i=r.width,s=r.height;return i===0&&s===0},fnt=function(e,r){var i=r.displayCheck,s=r.getShadowRoot;if(getComputedStyle(e).visibility==="hidden")return!0;var n=kT.call(e,"details>summary:first-of-type"),o=n?e.parentElement:e;if(kT.call(o,"details:not([open]) *"))return!0;if(!i||i==="full"||i==="legacy-full"){if(typeof s=="function"){for(var a=e;e;){var l=e.parentElement,c=tU(e);if(l&&!l.shadowRoot&&s(l)===!0)return wce(e);e.assignedSlot?e=e.assignedSlot:!l&&c!==e.ownerDocument?e=c.host:e=l}e=a}if(pnt(e))return!e.getClientRects().length;if(i!=="legacy-full")return!0}else if(i==="non-zero-area")return wce(e);return!1},mnt=function(e){if(/^(INPUT|BUTTON|SELECT|TEXTAREA)$/.test(e.tagName))for(var r=e.parentElement;r;){if(r.tagName==="FIELDSET"&&r.disabled){for(var i=0;i<r.children.length;i++){var s=r.children.item(i);if(s.tagName==="LEGEND")return kT.call(r,"fieldset[disabled] *")?!0:!s.contains(e)}return!0}r=r.parentElement}return!1},iU=function(e,r){return!(r.disabled||rU(r)||ant(r)||fnt(r,e)||lnt(r)||mnt(r))},gZ=function(e,r){return!(dnt(r)||qAe(r)<0||!iU(e,r))},gnt=function(e){var r=parseInt(e.getAttribute("tabindex"),10);return!!(isNaN(r)||r>=0)},ynt=function t(e){var r=[],i=[];return e.forEach(function(s,n){var o=!!s.scopeParent,a=o?s.scopeParent:s,l=qAe(a,o),c=o?t(s.candidates):a;l===0?o?r.push.apply(r,c):r.push(a):i.push({documentOrder:n,tabIndex:l,item:s,isScope:o,content:c})}),i.sort(ont).reduce(function(s,n){return n.isScope?s.push.apply(s,n.content):s.push(n.content),s},[]).concat(r)},_nt=function(e,r){r=r||{};var i;return r.getShadowRoot?i=HAe([e],r.includeContainer,{filter:gZ.bind(null,r),flatten:!1,getShadowRoot:r.getShadowRoot,shadowRootFilter:gnt}):i=jAe(e,r.includeContainer,gZ.bind(null,r)),ynt(i)},vnt=function(e,r){r=r||{};var i;return r.getShadowRoot?i=HAe([e],r.includeContainer,{filter:iU.bind(null,r),flatten:!0,getShadowRoot:r.getShadowRoot}):i=jAe(e,r.includeContainer,iU.bind(null,r)),i},tD=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return kT.call(e,eU)===!1?!1:gZ(r,e)},bnt=BAe.concat("iframe").join(","),Iz=function(e,r){if(r=r||{},!e)throw new Error("No node provided");return kT.call(e,bnt)===!1?!1:iU(r,e)};/*!
* focus-trap 7.4.3
* @license MIT, https://github.com/focus-trap/focus-trap/blob/master/LICENSE
*/function xce(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter(function(s){return Object.getOwnPropertyDescriptor(t,s).enumerable})),r.push.apply(r,i)}return r}function Tce(t){for(var e=1;e<arguments.length;e++){var r=arguments[e]!=null?arguments[e]:{};e%2?xce(Object(r),!0).forEach(function(i){wnt(t,i,r[i])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):xce(Object(r)).forEach(function(i){Object.defineProperty(t,i,Object.getOwnPropertyDescriptor(r,i))})}return t}function wnt(t,e,r){return e=Tnt(e),e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}function xnt(t,e){if(typeof t!="object"||t===null)return t;var r=t[Symbol.toPrimitive];if(r!==void 0){var i=r.call(t,e||"default");if(typeof i!="object")return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return(e==="string"?String:Number)(t)}function Tnt(t){var e=xnt(t,"string");return typeof e=="symbol"?e:String(e)}var Sce={activateTrap:function(e,r){if(e.length>0){var i=e[e.length-1];i!==r&&i.pause()}var s=e.indexOf(r);s===-1||e.splice(s,1),e.push(r)},deactivateTrap:function(e,r){var i=e.indexOf(r);i!==-1&&e.splice(i,1),e.length>0&&e[e.length-1].unpause()}},Snt=function(e){return e.tagName&&e.tagName.toLowerCase()==="input"&&typeof e.select=="function"},Ent=function(e){return e.key==="Escape"||e.key==="Esc"||e.keyCode===27},rI=function(e){return e.key==="Tab"||e.keyCode===9},Cnt=function(e){return rI(e)&&!e.shiftKey},Ant=function(e){return rI(e)&&e.shiftKey},Ece=function(e){return setTimeout(e,0)},Cce=function(e,r){var i=-1;return e.every(function(s,n){return r(s)?(i=n,!1):!0}),i},iR=function(e){for(var r=arguments.length,i=new Array(r>1?r-1:0),s=1;s<r;s++)i[s-1]=arguments[s];return typeof e=="function"?e.apply(void 0,i):e},rD=function(e){return e.target.shadowRoot&&typeof e.composedPath=="function"?e.composedPath()[0]:e.target},Ont=[],Rnt=function(e,r){var i=r?.document||document,s=r?.trapStack||Ont,n=Tce({returnFocusOnDeactivate:!0,escapeDeactivates:!0,delayInitialFocus:!0,isKeyForward:Cnt,isKeyBackward:Ant},r),o={containers:[],containerGroups:[],tabbableGroups:[],nodeFocusedBeforeActivation:null,mostRecentlyFocusedNode:null,active:!1,paused:!1,delayInitialFocusTimer:void 0},a,l=function($,N,U){return $&&$[N]!==void 0?$[N]:n[U||N]},c=function($,N){var U=typeof N?.composedPath=="function"?N.composedPath():void 0;return o.containerGroups.findIndex(function(X){var Z=X.container,G=X.tabbableNodes;return Z.contains($)||U?.includes(Z)||G.find(function(ee){return ee===$})})},h=function($){var N=n[$];if(typeof N=="function"){for(var U=arguments.length,X=new Array(U>1?U-1:0),Z=1;Z<U;Z++)X[Z-1]=arguments[Z];N=N.apply(void 0,X)}if(N===!0&&(N=void 0),!N){if(N===void 0||N===!1)return N;throw new Error("`".concat($,"` was specified but was not a node, or did not return a node"))}var G=N;if(typeof N=="string"&&(G=i.querySelector(N),!G))throw new Error("`".concat($,"` as selector refers to no known node"));return G},p=function(){var $=h("initialFocus");if($===!1)return!1;if($===void 0||!Iz($,n.tabbableOptions))if(c(i.activeElement)>=0)$=i.activeElement;else{var N=o.tabbableGroups[0],U=N&&N.firstTabbableNode;$=U||h("fallbackFocus")}if(!$)throw new Error("Your focus-trap needs to have at least one focusable element");return $},f=function(){if(o.containerGroups=o.containers.map(function($){var N=_nt($,n.tabbableOptions),U=vnt($,n.tabbableOptions);return{container:$,tabbableNodes:N,focusableNodes:U,firstTabbableNode:N.length>0?N[0]:null,lastTabbableNode:N.length>0?N[N.length-1]:null,nextTabbableNode:function(Z){var G=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!0,ee=U.findIndex(function(I){return I===Z});if(!(ee<0))return G?U.slice(ee+1).find(function(I){return tD(I,n.tabbableOptions)}):U.slice(0,ee).reverse().find(function(I){return tD(I,n.tabbableOptions)})}}}),o.tabbableGroups=o.containerGroups.filter(function($){return $.tabbableNodes.length>0}),o.tabbableGroups.length<=0&&!h("fallbackFocus"))throw new Error("Your focus-trap must have at least one container with at least one tabbable node in it at all times")},m=function F($){if($!==!1&&$!==i.activeElement){if(!$||!$.focus){F(p());return}$.focus({preventScroll:!!n.preventScroll}),o.mostRecentlyFocusedNode=$,Snt($)&&$.select()}},g=function($){var N=h("setReturnFocus",$);return N||(N===!1?!1:$)},_=function($){var N=rD($);if(!(c(N,$)>=0)){if(iR(n.clickOutsideDeactivates,$)){a.deactivate({returnFocus:n.returnFocusOnDeactivate});return}iR(n.allowOutsideClick,$)||$.preventDefault()}},v=function($){var N=rD($),U=c(N,$)>=0;U||N instanceof Document?U&&(o.mostRecentlyFocusedNode=N):($.stopImmediatePropagation(),m(o.mostRecentlyFocusedNode||p()))},b=function($){var N=arguments.length>1&&arguments[1]!==void 0?arguments[1]:!1,U=rD($);f();var X=null;if(o.tabbableGroups.length>0){var Z=c(U,$),G=Z>=0?o.containerGroups[Z]:void 0;if(Z<0)N?X=o.tabbableGroups[o.tabbableGroups.length-1].lastTabbableNode:X=o.tabbableGroups[0].firstTabbableNode;else if(N){var ee=Cce(o.tabbableGroups,function(te){var ne=te.firstTabbableNode;return U===ne});if(ee<0&&(G.container===U||Iz(U,n.tabbableOptions)&&!tD(U,n.tabbableOptions)&&!G.nextTabbableNode(U,!1))&&(ee=Z),ee>=0){var I=ee===0?o.tabbableGroups.length-1:ee-1,V=o.tabbableGroups[I];X=V.lastTabbableNode}else rI($)||(X=G.nextTabbableNode(U,!1))}else{var z=Cce(o.tabbableGroups,function(te){var ne=te.lastTabbableNode;return U===ne});if(z<0&&(G.container===U||Iz(U,n.tabbableOptions)&&!tD(U,n.tabbableOptions)&&!G.nextTabbableNode(U))&&(z=Z),z>=0){var H=z===o.tabbableGroups.length-1?0:z+1,Y=o.tabbableGroups[H];X=Y.firstTabbableNode}else rI($)||(X=G.nextTabbableNode(U))}}else X=h("fallbackFocus");X&&(rI($)&&$.preventDefault(),m(X))},x=function($){if(Ent($)&&iR(n.escapeDeactivates,$)!==!1){$.preventDefault(),a.deactivate();return}(n.isKeyForward($)||n.isKeyBackward($))&&b($,n.isKeyBackward($))},T=function($){var N=rD($);c(N,$)>=0||iR(n.clickOutsideDeactivates,$)||iR(n.allowOutsideClick,$)||($.preventDefault(),$.stopImmediatePropagation())},S=function(){if(o.active)return Sce.activateTrap(s,a),o.delayInitialFocusTimer=n.delayInitialFocus?Ece(function(){m(p())}):m(p()),i.addEventListener("focusin",v,!0),i.addEventListener("mousedown",_,{capture:!0,passive:!1}),i.addEventListener("touchstart",_,{capture:!0,passive:!1}),i.addEventListener("click",T,{capture:!0,passive:!1}),i.addEventListener("keydown",x,{capture:!0,passive:!1}),a},O=function(){if(o.active)return i.removeEventListener("focusin",v,!0),i.removeEventListener("mousedown",_,!0),i.removeEventListener("touchstart",_,!0),i.removeEventListener("click",T,!0),i.removeEventListener("keydown",x,!0),a},A=function($){var N=$.some(function(U){var X=Array.from(U.removedNodes);return X.some(function(Z){return Z===o.mostRecentlyFocusedNode})});N&&m(p())},M=typeof window<"u"&&"MutationObserver"in window?new MutationObserver(A):void 0,P=function(){M&&(M.disconnect(),o.active&&!o.paused&&o.containers.map(function($){M.observe($,{subtree:!0,childList:!0})}))};return a={get active(){return o.active},get paused(){return o.paused},activate:function($){if(o.active)return this;var N=l($,"onActivate"),U=l($,"onPostActivate"),X=l($,"checkCanFocusTrap");X||f(),o.active=!0,o.paused=!1,o.nodeFocusedBeforeActivation=i.activeElement,N?.();var Z=function(){X&&f(),S(),P(),U?.()};return X?(X(o.containers.concat()).then(Z,Z),this):(Z(),this)},deactivate:function($){if(!o.active)return this;var N=Tce({onDeactivate:n.onDeactivate,onPostDeactivate:n.onPostDeactivate,checkCanReturnFocus:n.checkCanReturnFocus},$);clearTimeout(o.delayInitialFocusTimer),o.delayInitialFocusTimer=void 0,O(),o.active=!1,o.paused=!1,P(),Sce.deactivateTrap(s,a);var U=l(N,"onDeactivate"),X=l(N,"onPostDeactivate"),Z=l(N,"checkCanReturnFocus"),G=l(N,"returnFocus","returnFocusOnDeactivate");U?.();var ee=function(){Ece(function(){G&&m(g(o.nodeFocusedBeforeActivation)),X?.()})};return G&&Z?(Z(g(o.nodeFocusedBeforeActivation)).then(ee,ee),this):(ee(),this)},pause:function($){if(o.paused||!o.active)return this;var N=l($,"onPause"),U=l($,"onPostPause");return o.paused=!0,N?.(),O(),P(),U?.(),this},unpause:function($){if(!o.paused||!o.active)return this;var N=l($,"onUnpause"),U=l($,"onPostUnpause");return o.paused=!1,N?.(),f(),S(),P(),U?.(),this},updateContainerElements:function($){var N=[].concat($).filter(Boolean);return o.containers=N.map(function(U){return typeof U=="string"?i.querySelector(U):U}),o.active&&f(),P(),this}},a.updateContainerElements(e),a};const Mb="esri-identity-modal",Yf={base:Mb,open:`${Mb}--open`,closed:`${Mb}--closed`,title:`${Mb}__title`,dialog:`${Mb}__dialog`,content:`${Mb}__content`,closeButton:`${Mb}__close-button`,iconClose:"esri-icon-close"};let gv=class extends Rc{constructor(e,r){super(e,r),this.container=document.createElement("div"),this.content=null,this.open=!1,this._focusTrap=null,this._close=()=>{this.open=!1},document.body.appendChild(this.container),this.addHandles(Q(()=>this.open,()=>this._toggleFocusTrap()))}destroy(){this._destroyFocusTrap()}get title(){return this.messages?.auth.signIn}render(){const e=this.id,{open:r,content:i,title:s,messages:n}=this,o=r&&!!i,a={[Yf.open]:o,[Yf.closed]:!o},l=j("button",{class:Yf.closeButton,"aria-label":n.close,title:n.close,bind:this,onclick:this._close,type:"button"},j("span",{"aria-hidden":"true",class:Yf.iconClose})),c=`${e}_title`,h=`${e}_content`,p=s?j("h1",{id:c,class:Yf.title},s):null,f=o?j("div",{bind:this,class:Yf.dialog,role:"dialog","aria-labelledby":c,"aria-describedby":h,afterCreate:this._createFocusTrap},l,p,this._renderContent(h)):null;return j("div",{tabIndex:-1,class:this.classes(Yf.base,a)},f)}_destroyFocusTrap(){this._focusTrap?.deactivate({onDeactivate:()=>{}}),this._focusTrap=null}_toggleFocusTrap(){const{_focusTrap:e,open:r}=this;e&&(r?e.activate():e.deactivate())}_createFocusTrap(e){this._destroyFocusTrap();const r=requestAnimationFrame(()=>{this._focusTrap=Rnt(e,{initialFocus:"input",onDeactivate:this._close}),this._toggleFocusTrap()});this.addHandles(Zr(()=>cancelAnimationFrame(r)))}_renderContent(e){const r=this.content;return typeof r=="string"?j("div",{class:Yf.content,id:e,innerHTML:r}):cZ(r)?j("div",{class:Yf.content,id:e},r.render()):r instanceof HTMLElement?j("div",{class:Yf.content,id:e,bind:r,afterCreate:this._attachToNode}):null}_attachToNode(e){const r=this;e.appendChild(r)}};u([d({readOnly:!0})],gv.prototype,"container",void 0),u([d()],gv.prototype,"content",void 0),u([d()],gv.prototype,"open",void 0),u([d(),Aa("esri/t9n/common")],gv.prototype,"messages",void 0),u([d()],gv.prototype,"title",null),gv=u([R("esri.identity.IdentityModal")],gv);const Ace=gv,Pz="esriJSAPIOAuth";let yZ=class{constructor(e,r){this.oAuthInfo=null,this.storage=null,this.appId=null,this.codeVerifier=null,this.expires=null,this.refreshToken=null,this.ssl=null,this.stateUID=null,this.token=null,this.userId=null,this.oAuthInfo=e,this.storage=r,this._init()}isValid(){let e=!1;if(this.oAuthInfo&&this.userId&&(this.refreshToken||this.token)){if(this.expires==null&&this.refreshToken)e=!0;else if(this.expires){const r=Date.now();this.expires>r&&(this.expires-r)/1e3>60*this.oAuthInfo.minTimeUntilExpiration&&(e=!0)}}return e}save(){if(!this.storage)return!1;const e=this._load(),r=this.oAuthInfo;if(r&&r.authNamespace&&r.portalUrl){let i=e[r.authNamespace];i||(i=e[r.authNamespace]={}),this.appId||(this.appId=r.appId),i[r.portalUrl]={appId:this.appId,codeVerifier:this.codeVerifier,expires:this.expires,refreshToken:this.refreshToken,ssl:this.ssl,stateUID:this.stateUID,token:this.token,userId:this.userId};try{this.storage.setItem(Pz,JSON.stringify(e))}catch(s){return console.warn(s),!1}return!0}return!1}destroy(){const e=this._load(),r=this.oAuthInfo;if(r&&r.appId&&r.portalUrl&&(this.expires==null||this.expires>Date.now())&&(this.refreshToken||this.token)){const i=r.portalUrl.replace(/^http:/i,"https:")+"/sharing/rest/oauth2/revokeToken",s=new FormData;if(s.append("f","json"),s.append("auth_token",this.refreshToken||this.token),s.append("client_id",r.appId),s.append("token_type_hint",this.refreshToken?"refresh_token":"access_token"),typeof navigator.sendBeacon=="function")navigator.sendBeacon(i,s);else{const n=new XMLHttpRequest;n.open("POST",i),n.send(s)}}if(r&&r.authNamespace&&r.portalUrl&&this.storage){const i=e[r.authNamespace];if(i){delete i[r.portalUrl];try{this.storage.setItem(Pz,JSON.stringify(e))}catch(s){console.log(s)}}}r&&(r._oAuthCred=null,this.oAuthInfo=null)}_init(){const e=this._load(),r=this.oAuthInfo;if(r&&r.authNamespace&&r.portalUrl){let i=e[r.authNamespace];i&&(i=i[r.portalUrl],i&&(this.appId=i.appId,this.codeVerifier=i.codeVerifier,this.expires=i.expires,this.refreshToken=i.refreshToken,this.ssl=i.ssl,this.stateUID=i.stateUID,this.token=i.token,this.userId=i.userId))}}_load(){let e={};if(this.storage){const r=this.storage.getItem(Pz);if(r)try{e=JSON.parse(r)}catch(i){console.warn(i)}}return e}};yZ.prototype.declaredClass="esri.identity.OAuthCredential";var _Z;let Ua=_Z=class extends he{constructor(t){super(t),this._oAuthCred=null,this.appId=null,this.authNamespace="/",this.expiration=20160,this.flowType="auto",this.forceLogin=!1,this.forceUserId=!1,this.locale=null,this.minTimeUntilExpiration=30,this.popup=!1,this.popupCallbackUrl="oauth-callback.html",this.popupWindowFeatures="height=490,width=800,resizable,scrollbars,status",this.portalUrl="https://www.arcgis.com",this.preserveUrlHash=!1,this.userId=null}clone(){return _Z.fromJSON(this.toJSON())}};u([d({json:{write:!0}})],Ua.prototype,"appId",void 0),u([d({json:{write:!0}})],Ua.prototype,"authNamespace",void 0),u([d({json:{write:!0}})],Ua.prototype,"expiration",void 0),u([d({json:{write:!0}})],Ua.prototype,"flowType",void 0),u([d({json:{write:!0}})],Ua.prototype,"forceLogin",void 0),u([d({json:{write:!0}})],Ua.prototype,"forceUserId",void 0),u([d({json:{write:!0}})],Ua.prototype,"locale",void 0),u([d({json:{write:!0}})],Ua.prototype,"minTimeUntilExpiration",void 0),u([d({json:{write:!0}})],Ua.prototype,"popup",void 0),u([d({json:{write:!0}})],Ua.prototype,"popupCallbackUrl",void 0),u([d({json:{write:!0}})],Ua.prototype,"popupWindowFeatures",void 0),u([d({json:{write:!0}})],Ua.prototype,"portalUrl",void 0),u([d({json:{write:!0}})],Ua.prototype,"preserveUrlHash",void 0),u([d({json:{write:!0}})],Ua.prototype,"userId",void 0),Ua=_Z=u([R("esri.identity.OAuthInfo")],Ua);const vZ=Ua;let Wu=class extends he{constructor(e){super(e),this.adminTokenServiceUrl=null,this.currentVersion=null,this.hasPortal=null,this.hasServer=null,this.owningSystemUrl=null,this.owningTenant=null,this.server=null,this.shortLivedTokenValidity=null,this.tokenServiceUrl=null,this.webTierAuth=null}};u([d({json:{write:!0}})],Wu.prototype,"adminTokenServiceUrl",void 0),u([d({json:{write:!0}})],Wu.prototype,"currentVersion",void 0),u([d({json:{write:!0}})],Wu.prototype,"hasPortal",void 0),u([d({json:{write:!0}})],Wu.prototype,"hasServer",void 0),u([d({json:{write:!0}})],Wu.prototype,"owningSystemUrl",void 0),u([d({json:{write:!0}})],Wu.prototype,"owningTenant",void 0),u([d({json:{write:!0}})],Wu.prototype,"server",void 0),u([d({json:{write:!0}})],Wu.prototype,"shortLivedTokenValidity",void 0),u([d({json:{write:!0}})],Wu.prototype,"tokenServiceUrl",void 0),u([d({json:{write:!0}})],Wu.prototype,"webTierAuth",void 0),Wu=u([R("esri.identity.ServerInfo")],Wu);const $z=Wu,I4={},ZAe=t=>{const e=new uh(t.owningSystemUrl).host,r=new uh(t.server).host,i=/.+\.arcgis\.com$/i;return i.test(e)&&i.test(r)},bZ=(t,e)=>!!(ZAe(t)&&e&&e.some(r=>r.test(t.server)));let P4=null,$4=null;try{P4=window.localStorage,$4=window.sessionStorage}catch{}let XAe=class extends Xr{constructor(){super(),this._portalConfig=globalThis.esriGeowConfig,this.serverInfos=[],this.oAuthInfos=[],this.credentials=[],this._soReqs=[],this._xoReqs=[],this._portals=[],this._defaultOAuthInfo=null,this._defaultTokenValidity=60,this.dialog=null,this.formConstructor=snt,this.tokenValidity=null,this.normalizeWebTierAuth=!1,this._appOrigin=window.origin!=="null"?window.origin:window.location.origin,this._appUrlObj=Fn(window.location.href),this._busy=null,this._rejectOnPersistedPageShow=!1,this._oAuthLocationParams=null,this._gwTokenUrl="/sharing/rest/generateToken",this._agsRest="/rest/services",this._agsPortal=/\/sharing(\/|$)/i,this._agsAdmin=/(https?:\/\/[^\/]+\/[^\/]+)\/admin\/?(\/.*)?$/i,this._adminSvcs=/\/rest\/admin\/services(\/|$)/i,this._gwDomains=[{regex:/^https?:\/\/www\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:dev|[a-z\d-]+\.mapsdev)\.arcgis\.com/i,customBaseUrl:"mapsdev.arcgis.com",tokenServiceUrl:"https://dev.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:devext|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,customBaseUrl:"mapsdevext.arcgis.com",tokenServiceUrl:"https://devext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/(?:qaext|[a-z\d-]+\.mapsqa)\.arcgis\.com/i,customBaseUrl:"mapsqa.arcgis.com",tokenServiceUrl:"https://qaext.arcgis.com/sharing/rest/generateToken"},{regex:/^https?:\/\/[a-z\d-]+\.maps\.arcgis\.com/i,customBaseUrl:"maps.arcgis.com",tokenServiceUrl:"https://www.arcgis.com/sharing/rest/generateToken"}],this._legacyFed=[],this._regexSDirUrl=/http.+\/rest\/services\/?/gi,this._regexServerType=/(\/(FeatureServer|GPServer|GeoDataServer|GeocodeServer|GeoenrichmentServer|GeometryServer|GlobeServer|ImageServer|KnowledgeGraphServer|MapServer|MissionServer|MobileServer|NAServer|NetworkDiagramServer|OGCFeatureServer|ParcelFabricServer|RelationalCatalogServer|SceneServer|StreamServer|UtilityNetworkServer|ValidationServer|VectorTileServer|VersionManagementServer|VideoServer)).*/gi,this._gwUser=/http.+\/users\/([^\/]+)\/?.*/i,this._gwItem=/http.+\/items\/([^\/]+)\/?.*/i,this._gwGroup=/http.+\/groups\/([^\/]+)\/?.*/i,this._rePortalTokenSvc=/\/sharing(\/rest)?\/generatetoken/i,this._createDefaultOAuthInfo=!0,this._hasTestedIfAppIsOnPortal=!1,this._getOAuthLocationParams(),window.addEventListener("pageshow",e=>{this._pageShowHandler(e)})}registerServers(e){const r=this.serverInfos;r?(e=e.filter(i=>!this.findServerInfo(i.server)),this.serverInfos=r.concat(e)):this.serverInfos=e,e.forEach(i=>{i.owningSystemUrl&&this._portals.push(i.owningSystemUrl),i.hasPortal&&this._portals.push(i.server)})}registerOAuthInfos(e){const r=this.oAuthInfos;if(r){for(const i of e){const s=this.findOAuthInfo(i.portalUrl);s&&r.splice(r.indexOf(s),1)}this.oAuthInfos=r.concat(e)}else this.oAuthInfos=e}registerToken(e){e={...e};const r=this._sanitizeUrl(e.server),i=this._isServerRsrc(r);let s,n=this.findServerInfo(r),o=!0;n||(n=new $z,n.server=this._getServerInstanceRoot(r),i?n.hasServer=!0:(n.tokenServiceUrl=this._getTokenSvcUrl(r),n.hasPortal=!0),this.registerServers([n])),s=this._findCredential(r),s?(delete e.server,Object.assign(s,e),o=!1):(s=new Ys({userId:e.userId,server:n.server,token:e.token,expires:e.expires,ssl:e.ssl,scope:i?"server":"portal"}),s.resources=[r],this.credentials.push(s)),s.emitTokenChange(!1),o||s.refreshServerTokens()}toJSON(){return E6({serverInfos:this.serverInfos.map(e=>e.toJSON()),oAuthInfos:this.oAuthInfos.map(e=>e.toJSON()),credentials:this.credentials.map(e=>e.toJSON())})}initialize(e){if(!e)return;typeof e=="string"&&(e=JSON.parse(e));const r=e.serverInfos,i=e.oAuthInfos,s=e.credentials;if(r){const n=[];r.forEach(o=>{o.server&&o.tokenServiceUrl&&n.push(o.declaredClass?o:new $z(o))}),n.length&&this.registerServers(n)}if(i){const n=[];i.forEach(o=>{o.appId&&n.push(o.declaredClass?o:new vZ(o))}),n.length&&this.registerOAuthInfos(n)}s&&s.forEach(n=>{n.server&&n.token&&n.expires&&n.expires>Date.now()&&((n=n.declaredClass?n:new Ys(n)).emitTokenChange(),this.credentials.push(n))})}findServerInfo(e){let r;e=this._sanitizeUrl(e);for(const i of this.serverInfos)if(this._hasSameServerInstance(i.server,e)){r=i;break}return r}findOAuthInfo(e){let r;e=this._sanitizeUrl(e);for(const i of this.oAuthInfos)if(this._hasSameServerInstance(i.portalUrl,e)){r=i;break}return r}findCredential(e,r){if(!e)return;let i;e=this._sanitizeUrl(e);const s=this._isServerRsrc(e)?"server":"portal";if(r){for(const n of this.credentials)if(this._hasSameServerInstance(n.server,e)&&r===n.userId&&n.scope===s){i=n;break}}else for(const n of this.credentials)if(this._hasSameServerInstance(n.server,e)&&this._getIdenticalSvcIdx(e,n)!==-1&&n.scope===s){i=n;break}return i}getCredential(e,r){let i,s,n=!0;r&&(i=!!r.token,s=r.error,n=r.prompt!==!1),r={...r},e=this._sanitizeUrl(e);const o=new AbortController,a=nn();if(r.signal&&xn(r.signal,()=>{o.abort()}),xn(o,()=>{a.reject(new D("identity-manager:user-aborted","ABORTED"))}),dn(o))return a.promise;r.signal=o.signal;const l=this._isAdminResource(e),c=i?this.findCredential(e):null;let h;if(c&&s&&s.details&&s.details.httpStatus===498)c.destroy();else if(c)return h=new D("identity-manager:not-authorized","You are currently signed in as: '"+c.userId+"'. You do not have access to this resource: "+e,{error:s}),a.reject(h),a.promise;const p=this._findCredential(e,r);if(p)return a.resolve(p),a.promise;let f=this.findServerInfo(e);if(f)!f.hasServer&&this._isServerRsrc(e)&&(f._restInfoPms=this._getTokenSvcUrl(e),f.hasServer=!0);else{const m=this._getTokenSvcUrl(e);if(!m)return h=new D("identity-manager:unknown-resource","Unknown resource - could not find token service endpoint."),a.reject(h),a.promise;f=new $z,f.server=this._getServerInstanceRoot(e),typeof m=="string"?(f.tokenServiceUrl=m,f.hasPortal=!0):(f._restInfoPms=m,f.hasServer=!0),this.registerServers([f])}return f.hasPortal&&f._selfReq===void 0&&(n||nu(f.tokenServiceUrl,this._appOrigin)||this._gwDomains.some(m=>m.tokenServiceUrl===f.tokenServiceUrl))&&(f._selfReq={owningTenant:r&&r.owningTenant,selfDfd:this._getPortalSelf(f.tokenServiceUrl.replace(this._rePortalTokenSvc,"/sharing/rest/portals/self"),e)}),this._enqueue(e,f,r,a,l)}getResourceName(e){return this._isRESTService(e)?e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"")||"":this._gwUser.test(e)&&e.replace(this._gwUser,"$1")||this._gwItem.test(e)&&e.replace(this._gwItem,"$1")||this._gwGroup.test(e)&&e.replace(this._gwGroup,"$1")||""}generateToken(e,r,i){const s=this._rePortalTokenSvc.test(e.tokenServiceUrl),n=new uh(this._appOrigin),o=e.shortLivedTokenValidity;let a,l,c,h,p,f,m,g;r&&(g=this.tokenValidity||o||this._defaultTokenValidity,g>o&&o>0&&(g=o)),i&&(a=i.isAdmin,l=i.serverUrl,c=i.token,f=i.signal,m=i.ssl,e.customParameters=i.customParameters),a?h=e.adminTokenServiceUrl:(h=e.tokenServiceUrl,p=new uh(h.toLowerCase()),e.webTierAuth&&i?.serverUrl&&!m&&n.scheme==="http"&&(nu(n.uri,h,!0)||p.scheme==="https"&&n.host===p.host&&n.port==="7080"&&p.port==="7443")&&(h=h.replace(/^https:/i,"http:").replace(/:7443/i,":7080")));const _={query:{request:"getToken",username:r?.username,password:r?.password,serverUrl:l,token:c,expiration:g,referer:a||s?this._appOrigin:null,client:a?"referer":null,f:"json",...e.customParameters},method:"post",authMode:"anonymous",useProxy:this._useProxy(e,i),signal:f,...i?.ioArgs};return s||(_.withCredentials=!1),Lt(h,_).then(v=>{const b=v.data;if(!b||!b.token)return new D("identity-manager:authentication-failed","Unable to generate token");const x=e.server;return I4[x]||(I4[x]={}),r&&(I4[x][r.username]=r.password),b.validity=g,b})}isBusy(){return!!this._busy}checkSignInStatus(e){return this.checkAppAccess(e,"").then(r=>r.credential)}checkAppAccess(e,r,i){let s=!1;return this.getCredential(e,{prompt:!1}).then(n=>{let o;const a={f:"json"};if(n.scope==="portal")if(r&&(this._doPortalSignIn(e)||i&&i.force))o=n.server+"/sharing/rest/oauth2/validateAppAccess",a.client_id=r;else{if(!n.token)return{credential:n};o=n.server+"/sharing/rest"}else{if(!n.token)return{credential:n};o=n.server+"/rest/services"}return n.token&&(a.token=n.token),Lt(o,{query:a,authMode:"anonymous"}).then(l=>{if(l.data.valid===!1)throw new D("identity-manager:not-authorized",`You are currently signed in as: '${n.userId}'.`,l.data);return s=!!l.data.viewOnlyUserTypeApp,{credential:n}}).catch(l=>{if(l.name==="identity-manager:not-authorized")throw l;const c=l.details&&l.details.httpStatus;if(c===498)throw n.destroy(),new D("identity-manager:not-authenticated","User is not signed in.");if(c===400)throw new D("identity-manager:invalid-request");return{credential:n}})}).then(n=>({credential:n.credential,viewOnly:s}))}setOAuthResponseHash(e){e&&(e.charAt(0)==="#"&&(e=e.substring(1)),this._processOAuthPopupParams(Vx(e)))}setOAuthRedirectionHandler(e){this._oAuthRedirectFunc=e}setProtocolErrorHandler(e){this._protocolFunc=e}signIn(e,r,i={}){const s=nn(),n=()=>{l?.remove(),c?.remove(),h?.remove(),a?.destroy(),this.dialog?.destroy(),this.dialog=a=l=c=h=null},o=()=>{n(),this._oAuthDfd=null,s.reject(new D("identity-manager:user-aborted","ABORTED"))};i.signal&&xn(i.signal,()=>{o()});let a=new this.formConstructor;a.resource=this.getResourceName(e),a.server=r.server,this.dialog=new Ace,this.dialog.content=a,this.dialog.open=!0,this.emit("dialog-create");let l=a.on("cancel",o),c=Q(()=>this.dialog.open,o),h=a.on("submit",p=>{this.generateToken(r,p,{isAdmin:i.isAdmin,signal:i.signal}).then(f=>{n();const m=new Ys({userId:p.username,server:r.server,token:f.token,expires:f.expires!=null?Number(f.expires):null,ssl:!!f.ssl,isAdmin:i.isAdmin,validity:f.validity});s.resolve(m)}).catch(f=>{a.error=f,a.signingIn=!1})});return s.promise}oAuthSignIn(e,r,i,s){this._oAuthDfd=nn();const n=this._oAuthDfd;let o;s?.signal&&xn(s.signal,()=>{const g=this._oAuthDfd&&this._oAuthDfd.oAuthWin_;g&&!g.closed?g.close():this.dialog&&f()}),n.resUrl_=e,n.sinfo_=r,n.oinfo_=i;const a=i._oAuthCred;if(a.storage&&(i.flowType==="authorization-code"||i.flowType==="auto"&&!i.popup&&r.currentVersion>=8.4)){let g=crypto.getRandomValues(new Uint8Array(32));o=f9(g),a.codeVerifier=o,g=crypto.getRandomValues(new Uint8Array(32)),a.stateUID=f9(g),a.save()||(a.codeVerifier=o=null)}else a.codeVerifier=null;let l,c,h,p;this._getCodeChallenge(o).then(g=>{const _=!s||s.oAuthPopupConfirmation!==!1;i.popup&&_?(l=new this.formConstructor,l.oAuthPrompt=!0,l.server=r.server,this.dialog=new Ace,this.dialog.content=l,this.dialog.open=!0,this.emit("dialog-create"),c=l.on("cancel",f),h=Q(()=>this.dialog.open,f),p=l.on("submit",()=>{m(),this._doOAuthSignIn(e,r,i,g)})):this._doOAuthSignIn(e,r,i,g)});const f=()=>{m(),this._oAuthDfd=null,n.reject(new D("identity-manager:user-aborted","ABORTED"))},m=()=>{c?.remove(),h?.remove(),p?.remove(),l?.destroy(),this.dialog?.destroy(),this.dialog=null};return n.promise}destroyCredentials(){this.credentials&&this.credentials.slice().forEach(e=>{e.destroy()}),this.emit("credentials-destroy")}enablePostMessageAuth(e="https://www.arcgis.com/sharing/rest"){this._postMessageAuthHandle&&this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=w1(window,"message",r=>{if((r.origin===this._appOrigin||r.origin.endsWith(".arcgis.com"))&&r.data?.type==="arcgis:auth:requestCredential"){const i=r.source;this.getCredential(e).then(s=>{i.postMessage({type:"arcgis:auth:credential",credential:{expires:s.expires,server:s.server,ssl:s.ssl,token:s.token,userId:s.userId}},r.origin)}).catch(s=>{i.postMessage({type:"arcgis:auth:error",error:{name:s.name,message:s.message}},r.origin)})}})}disablePostMessageAuth(){this._postMessageAuthHandle&&(this._postMessageAuthHandle.remove(),this._postMessageAuthHandle=null)}_getOAuthLocationParams(){let e=window.location.hash;if(e){e.charAt(0)==="#"&&(e=e.substring(1));const i=Vx(e);let s=!1;if(i.access_token&&i.expires_in&&i.state&&i.hasOwnProperty("username"))try{i.state=JSON.parse(i.state),i.state.portalUrl&&(this._oAuthLocationParams=i,s=!0)}catch{}else if(i.error&&i.error_description&&(console.log("IdentityManager OAuth Error: ",i.error," - ",i.error_description),i.error==="access_denied"&&(s=!0,i.state)))try{i.state=JSON.parse(i.state)}catch{}s&&(window.location.hash=i.state?.hash||"")}let r=window.location.search;if(r){r.charAt(0)==="?"&&(r=r.substring(1));const i=Vx(r);let s=!1;if(i.code&&i.state)try{i.state=JSON.parse(i.state),i.state.portalUrl&&i.state.uid&&(this._oAuthLocationParams=i,s=!0)}catch{}else if(i.error&&i.error_description&&(console.log("IdentityManager OAuth Error: ",i.error," - ",i.error_description),i.error==="access_denied"&&(s=!0,i.state)))try{i.state=JSON.parse(i.state)}catch{}if(s){const n={...i};["code","error","error_description","message_code","persist","state"].forEach(l=>{delete n[l]});const o=yT(n),a=window.location.pathname+(o?`?${o}`:"")+(i.state?.hash||"");window.history.replaceState(window.history.state,"",a)}}}_getOAuthToken(e,r,i,s,n){return e=e.replace(/^http:/i,"https:"),Lt(`${e}/sharing/rest/oauth2/token`,{authMode:"anonymous",method:"post",query:s&&n?{grant_type:"authorization_code",code:r,redirect_uri:s,client_id:i,code_verifier:n}:{grant_type:"refresh_token",refresh_token:r,client_id:i}}).then(o=>o.data)}_getCodeChallenge(e){if(e&&globalThis.isSecureContext){const r=new TextEncoder().encode(e);return crypto.subtle.digest("SHA-256",r).then(i=>f9(new Uint8Array(i)))}return Promise.resolve(null)}_pageShowHandler(e){if(e.persisted&&this.isBusy()&&this._rejectOnPersistedPageShow){const r=new D("identity-manager:user-aborted","ABORTED");this._errbackFunc(r)}}_findCredential(e,r){let i,s,n,o,a=-1;const l=r&&r.token,c=r&&r.resource,h=this._isServerRsrc(e)?"server":"portal",p=this.credentials.filter(f=>this._hasSameServerInstance(f.server,e)&&f.scope===h);if(e=c||e,p.length)if(p.length===1){if(i=p[0],n=this.findServerInfo(i.server),s=n&&n.owningSystemUrl,o=s?this.findCredential(s,i.userId):void 0,a=this._getIdenticalSvcIdx(e,i),!l)return a===-1&&i.resources.push(e),this._addResource(e,o),i;a!==-1&&(i.resources.splice(a,1),this._removeResource(e,o))}else{let f,m;if(p.some(g=>(m=this._getIdenticalSvcIdx(e,g),m!==-1&&(f=g,n=this.findServerInfo(f.server),s=n&&n.owningSystemUrl,o=s?this.findCredential(s,f.userId):void 0,a=m,!0))),l)f&&(f.resources.splice(a,1),this._removeResource(e,o));else if(f)return this._addResource(e,o),f}}_findOAuthInfo(e){let r=this.findOAuthInfo(e);if(!r){for(const i of this.oAuthInfos)if(this._isIdProvider(i.portalUrl,e)){r=i;break}}return r}_addResource(e,r){r&&this._getIdenticalSvcIdx(e,r)===-1&&r.resources.push(e)}_removeResource(e,r){let i=-1;r&&(i=this._getIdenticalSvcIdx(e,r),i>-1&&r.resources.splice(i,1))}_useProxy(e,r){return r&&r.isAdmin&&!nu(e.adminTokenServiceUrl,this._appOrigin)||!this._isPortalDomain(e.tokenServiceUrl)&&String(e.currentVersion)==="10.1"&&!nu(e.tokenServiceUrl,this._appOrigin)}_getOrigin(e){const r=new uh(e);return r.scheme+"://"+r.host+(r.port!=null?":"+r.port:"")}_getServerInstanceRoot(e){const r=e.toLowerCase();let i=r.indexOf(this._agsRest);return i===-1&&this._isAdminResource(e)&&(i=this._agsAdmin.test(e)?e.replace(this._agsAdmin,"$1").length:e.search(this._adminSvcs)),i!==-1||lve(r)||(i=r.indexOf("/sharing")),i===-1&&r.substr(-1)==="/"&&(i=r.length-1),i>-1?e.substring(0,i):e}_hasSameServerInstance(e,r){return e.substr(-1)==="/"&&(e=e.slice(0,-1)),e=e.toLowerCase(),r=this._getServerInstanceRoot(r).toLowerCase(),e=this._normalizeAGOLorgDomain(e),r=this._normalizeAGOLorgDomain(r),(e=e.substr(e.indexOf(":")))===(r=r.substr(r.indexOf(":")))}_normalizeAGOLorgDomain(e){const r=/^https?:\/\/(?:cdn|[a-z\d-]+\.maps)\.arcgis\.com/i,i=/^https?:\/\/(?:cdndev|[a-z\d-]+\.mapsdevext)\.arcgis\.com/i,s=/^https?:\/\/(?:cdnqa|[a-z\d-]+\.mapsqa)\.arcgis\.com/i;return r.test(e)?e=e.replace(r,"https://www.arcgis.com"):i.test(e)?e=e.replace(i,"https://devext.arcgis.com"):s.test(e)&&(e=e.replace(s,"https://qaext.arcgis.com")),e}_sanitizeUrl(e){const r=(qr.request.proxyUrl||"").toLowerCase(),i=r?e.toLowerCase().indexOf(r+"?"):-1;return i!==-1&&(e=e.substring(i+r.length+1)),e=Dd(e),Fn(e).path}_isRESTService(e){return e.includes(this._agsRest)}_isAdminResource(e){return this._agsAdmin.test(e)||this._adminSvcs.test(e)}_isServerRsrc(e){return this._isRESTService(e)||this._isAdminResource(e)}_isIdenticalService(e,r){let i=!1;if(this._isRESTService(e)&&this._isRESTService(r)){const s=this._getSuffix(e).toLowerCase(),n=this._getSuffix(r).toLowerCase();if(i=s===n,!i){const o=/(.*)\/(MapServer|FeatureServer|UtilityNetworkServer).*/gi;i=s.replaceAll(o,"$1")===n.replaceAll(o,"$1")}}else this._isAdminResource(e)&&this._isAdminResource(r)?i=!0:this._isServerRsrc(e)||this._isServerRsrc(r)||!this._isPortalDomain(e)||(i=!0);return i}_isPortalDomain(e){const r=new uh(e.toLowerCase()),i=this._portalConfig;let s=this._gwDomains.some(n=>n.regex.test(r.uri));return!s&&i&&(s=this._hasSameServerInstance(this._getServerInstanceRoot(i.restBaseUrl),r.uri)),s||qr.portalUrl&&(s=nu(r,qr.portalUrl,!0)),s||(s=this._portals.some(n=>this._hasSameServerInstance(n,r.uri))),s=s||this._agsPortal.test(r.path),s}_isIdProvider(e,r){let i=-1,s=-1;this._gwDomains.forEach((o,a)=>{i===-1&&o.regex.test(e)&&(i=a),s===-1&&o.regex.test(r)&&(s=a)});let n=!1;if(i>-1&&s>-1&&(i===0||i===4?s!==0&&s!==4||(n=!0):i===1?s!==1&&s!==2||(n=!0):i===2?s===2&&(n=!0):i===3&&s===3&&(n=!0)),!n){const o=this.findServerInfo(r),a=o&&o.owningSystemUrl;a&&ZAe(o)&&this._isPortalDomain(a)&&this._isIdProvider(e,a)&&(n=!0)}return n}_getIdenticalSvcIdx(e,r){let i=-1;for(let s=0;s<r.resources.length;s++){const n=r.resources[s];if(this._isIdenticalService(e,n)){i=s;break}}return i}_getSuffix(e){return e.replace(this._regexSDirUrl,"").replace(this._regexServerType,"$1")}_getTokenSvcUrl(e){let r,i,s;if(this._isRESTService(e)||this._isAdminResource(e)){const n=this._getServerInstanceRoot(e);return r=n+"/admin/generateToken",i=Lt(e=n+"/rest/info",{query:{f:"json"}}).then(o=>o.data),{adminUrl:r,promise:i}}if(this._isPortalDomain(e)){let n="";if(this._gwDomains.some(o=>(o.regex.test(e)&&(n=o.tokenServiceUrl),!!n)),n||this._portals.some(o=>(this._hasSameServerInstance(o,e)&&(n=o+this._gwTokenUrl),!!n)),n||(s=e.toLowerCase().indexOf("/sharing"),s!==-1&&(n=e.substring(0,s)+this._gwTokenUrl)),n||(n=this._getOrigin(e)+this._gwTokenUrl),n){const o=new uh(e).port;/^http:\/\//i.test(e)&&o==="7080"&&(n=n.replace(/:7080/i,":7443")),n=n.replace(/http:/i,"https:")}return n}if(e.toLowerCase().includes("premium.arcgisonline.com"))return"https://premium.arcgisonline.com/server/tokens"}_processOAuthResponseParams(e,r,i){const s=r._oAuthCred;if(e.code){const o=s.codeVerifier;return s.codeVerifier=null,s.stateUID=null,s.save(),this._getOAuthToken(i.server,e.code,r.appId,this._getRedirectURI(r,!0),o).then(a=>{const l=new Ys({userId:a.username,server:i.server,token:a.access_token,expires:Date.now()+1e3*a.expires_in,ssl:a.ssl,oAuthState:e.state,_oAuthCred:s});return r.userId=l.userId,s.storage=a.persist?P4:$4,s.refreshToken=a.refresh_token,s.token=null,s.expires=a.refresh_token_expires_in?Date.now()+1e3*a.refresh_token_expires_in:null,s.userId=l.userId,s.ssl=l.ssl,s.save(),l})}const n=new Ys({userId:e.username,server:i.server,token:e.access_token,expires:Date.now()+1e3*Number(e.expires_in),ssl:e.ssl==="true",oAuthState:e.state,_oAuthCred:s});return r.userId=n.userId,s.storage=e.persist?P4:$4,s.refreshToken=null,s.token=n.token,s.expires=n.expires,s.userId=n.userId,s.ssl=n.ssl,s.save(),Promise.resolve(n)}_processOAuthPopupParams(e){const r=this._oAuthDfd;if(this._oAuthDfd=null,r)if(clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle?.remove(),e.error){const i=e.error==="access_denied",s=new D(i?"identity-manager:user-aborted":"identity-manager:authentication-failed",i?"ABORTED":"OAuth: "+e.error+" - "+e.error_description);r.reject(s)}else this._processOAuthResponseParams(e,r.oinfo_,r.sinfo_).then(i=>{r.resolve(i)}).catch(i=>{r.reject(i)})}_setOAuthResponseQueryString(e){e&&(e.charAt(0)==="?"&&(e=e.substring(1)),this._processOAuthPopupParams(Vx(e)))}_exchangeToken(e,r,i){return Lt(`${e}/sharing/rest/oauth2/exchangeToken`,{authMode:"anonymous",method:"post",query:{f:"json",client_id:r,token:i}}).then(s=>s.data.token)}_getPlatformSelf(e,r){return e=e.replace(/^http:/i,"https:"),Lt(`${e}/sharing/rest/oauth2/platformSelf`,{authMode:"anonymous",headers:{"X-Esri-Auth-Client-Id":r,"X-Esri-Auth-Redirect-Uri":window.location.href.replace(/#.*$/,"")},method:"post",query:{f:"json",expiration:30},withCredentials:!0}).then(i=>i.data)}_getPortalSelf(e,r){let i;return this._gwDomains.some(s=>(s.regex.test(e)&&(i=s.customBaseUrl),!!i)),i?Promise.resolve({allSSL:!0,currentVersion:"8.4",customBaseUrl:i,portalMode:"multitenant",supportsOAuth:!0}):(this._appOrigin.startsWith("https:")?e=e.replace(/^http:/i,"https:").replace(/:7080/i,":7443"):/^http:/i.test(r)&&(e=e.replace(/^https:/i,"http:").replace(/:7443/i,":7080")),Lt(e,{query:{f:"json"},authMode:"anonymous",withCredentials:!0}).then(s=>s.data))}_doPortalSignIn(e){const r=this._portalConfig,i=window.location.href,s=this.findServerInfo(e);return!(!r&&!this._isPortalDomain(i)||!(s?s.hasPortal||s.owningSystemUrl&&this._isPortalDomain(s.owningSystemUrl):this._isPortalDomain(e))||!(this._isIdProvider(i,e)||r&&(this._hasSameServerInstance(this._getServerInstanceRoot(r.restBaseUrl),e)||this._isIdProvider(r.restBaseUrl,e))||nu(i,e,!0)))}_checkProtocol(e,r,i,s){let n=!0;const o=s?r.adminTokenServiceUrl:r.tokenServiceUrl;return o.trim().toLowerCase().startsWith("https:")&&!this._appOrigin.startsWith("https:")&&BP(o)&&(n=!!this._protocolFunc&&!!this._protocolFunc({resourceUrl:e,serverInfo:r}),!n)&&i(new D("identity-manager:aborted","Aborted the Sign-In process to avoid sending password over insecure connection.")),n}_enqueue(e,r,i,s,n,o){return s||(s=nn()),s.resUrl_=e,s.sinfo_=r,s.options_=i,s.admin_=n,s.refresh_=o,this._busy?this._hasSameServerInstance(this._getServerInstanceRoot(e),this._busy.resUrl_)?(this._oAuthDfd&&this._oAuthDfd.oAuthWin_&&this._oAuthDfd.oAuthWin_.focus(),this._soReqs.push(s)):this._xoReqs.push(s):this._doSignIn(s),s.promise}_doSignIn(e){this._busy=e,this._rejectOnPersistedPageShow=!1;const r=c=>{const h=e.options_&&e.options_.resource,p=e.resUrl_,f=e.refresh_;let m=!1;this.credentials.includes(c)||(f&&this.credentials.includes(f)?(f.userId=c.userId,f.token=c.token,f.expires=c.expires,f.validity=c.validity,f.ssl=c.ssl,f.creationTime=c.creationTime,m=!0,c=f):this.credentials.push(c)),c.resources||(c.resources=[]),c.resources.includes(h||p)||c.resources.push(h||p),c.scope=this._isServerRsrc(p)?"server":"portal",c.emitTokenChange();const g=this._soReqs,_={};this._soReqs=[],g.forEach(v=>{if(!this._isIdenticalService(p,v.resUrl_)){const b=this._getSuffix(v.resUrl_);_[b]||(_[b]=!0,c.resources.push(v.resUrl_))}}),e.resolve(c),g.forEach(v=>{this._hasSameServerInstance(this._getServerInstanceRoot(p),v.resUrl_)?v.resolve(c):this._soReqs.push(v)}),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,m||this.emit("credential-create",{credential:c}),this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},i=c=>{e.reject(c),this._busy=e.resUrl_=e.sinfo_=e.refresh_=null,this._soReqs.length?this._doSignIn(this._soReqs.shift()):this._xoReqs.length&&this._doSignIn(this._xoReqs.shift())},s=(c,h,p,f)=>{const m=e.sinfo_,g=!e.options_||e.options_.prompt!==!1,_=m.hasPortal&&this._findOAuthInfo(e.resUrl_);let v,b;if(c)r(new Ys({userId:c,server:m.server,token:p||null,expires:f!=null?Number(f):null,ssl:!!h}));else if(window!==window.parent&&this._appUrlObj.query?.["arcgis-auth-origin"]&&this._appUrlObj.query?.["arcgis-auth-portal"]&&this._hasSameServerInstance(this._getServerInstanceRoot(this._appUrlObj.query["arcgis-auth-portal"]),e.resUrl_)){window.parent.postMessage({type:"arcgis:auth:requestCredential"},this._appUrlObj.query["arcgis-auth-origin"]);const x=w1(window,"message",T=>{T.source===window.parent&&T.data&&(T.data.type==="arcgis:auth:credential"?(x.remove(),T.data.credential.expires<Date.now()?i(new D("identity-manager:credential-request-failed","Parent application's token has expired.")):r(new Ys(T.data.credential))):T.data.type==="arcgis:auth:error"&&(x.remove(),T.data.error.name==="tokenExpiredError"?i(new D("identity-manager:credential-request-failed","Parent application's token has expired.")):i(D.fromJSON(T.data.error))))});xn(e.options_?.signal,()=>{x.remove()})}else if(_){let x=_._oAuthCred;if(!x){const T=new yZ(_,P4),S=new yZ(_,$4);T.isValid()&&S.isValid()?T.expires>S.expires?(x=T,S.destroy()):(x=S,T.destroy()):x=T.isValid()?T:S,_._oAuthCred=x}if(x.isValid()){v=new Ys({userId:x.userId,server:m.server,token:x.token,expires:x.expires,ssl:x.ssl,_oAuthCred:x});const T=_.appId!==x.appId&&this._doPortalSignIn(e.resUrl_);T||x.refreshToken?(e._pendingDfd=x.refreshToken?this._getOAuthToken(m.server,x.refreshToken,x.appId).then(S=>(v.expires=Date.now()+1e3*S.expires_in,v.token=S.access_token,v)):Promise.resolve(v),e._pendingDfd.then(S=>T?this._exchangeToken(S.server,_.appId,S.token).then(O=>(S.token=O,S)).catch(()=>S):S).then(S=>{r(S)}).catch(()=>{x?.destroy(),s()})):r(v)}else if(this._oAuthLocationParams&&this._hasSameServerInstance(_.portalUrl,this._oAuthLocationParams.state.portalUrl)&&(this._oAuthLocationParams.access_token||this._oAuthLocationParams.code&&this._oAuthLocationParams.state.uid===x.stateUID&&x.codeVerifier)){const T=this._oAuthLocationParams;this._oAuthLocationParams=null,e._pendingDfd=this._processOAuthResponseParams(T,_,m).then(S=>{r(S)}).catch(i)}else{const T=()=>{g?e._pendingDfd=this.oAuthSignIn(e.resUrl_,m,_,e.options_).then(r,i):(b=new D("identity-manager:not-authenticated","User is not signed in."),i(b))};this._doPortalSignIn(e.resUrl_)?e._pendingDfd=this._getPlatformSelf(m.server,_.appId).then(S=>{nu(S.portalUrl,this._appOrigin,!0)?(v=new Ys({userId:S.username,server:m.server,expires:Date.now()+1e3*S.expires_in,token:S.token}),r(v)):T()}).catch(T):T()}}else if(g){if(this._checkProtocol(e.resUrl_,m,i,e.admin_)){let x=e.options_;e.admin_&&(x=x||{},x.isAdmin=!0),e._pendingDfd=this.signIn(e.resUrl_,m,x).then(r,i)}}else b=new D("identity-manager:not-authenticated","User is not signed in."),i(b)},n=()=>{const c=e.sinfo_,h=c.owningSystemUrl,p=e.options_;let f,m,g,_;if(p&&(f=p.token,m=p.error,g=p.prompt),_=this._findCredential(h,{token:f,resource:e.resUrl_}),!_){for(const v of this.credentials)if(this._isIdProvider(h,v.server)){_=v;break}}if(_){const v=this.findCredential(e.resUrl_,_.userId);if(v)r(v);else if(bZ(c,this._legacyFed)){const b=_.toJSON();b.server=c.server,b.resources=null,r(new Ys(b))}else(e._pendingDfd=this.generateToken(this.findServerInfo(_.server),null,{serverUrl:e.resUrl_,token:_.token,signal:e.options_.signal,ssl:_.ssl})).then(b=>{r(new Ys({userId:_?.userId,server:c.server,token:b.token,expires:b.expires!=null?Number(b.expires):null,ssl:!!b.ssl,isAdmin:e.admin_,validity:b.validity}))},i)}else this._busy=null,f&&(e.options_.token=null),(e._pendingDfd=this.getCredential(h.replace(/\/?$/,"/sharing"),{resource:e.resUrl_,owningTenant:c.owningTenant,signal:e.options_.signal,token:f,error:m,prompt:g})).then(()=>{this._enqueue(e.resUrl_,e.sinfo_,e.options_,e,e.admin_)},v=>{e.resUrl_=e.sinfo_=e.refresh_=null,e.reject(v)})};this._errbackFunc=i;const o=e.sinfo_.owningSystemUrl,a=this._isServerRsrc(e.resUrl_),l=e.sinfo_._restInfoPms;l?l.promise.then(c=>{const h=e.sinfo_;if(h._restInfoPms){h.adminTokenServiceUrl=h._restInfoPms.adminUrl,h._restInfoPms=null,h.tokenServiceUrl=(Ky("authInfo.tokenServicesUrl",c)||Ky("authInfo.tokenServiceUrl",c)||Ky("tokenServiceUrl",c))??null,h.shortLivedTokenValidity=Ky("authInfo.shortLivedTokenValidity",c)??null,h.currentVersion=c.currentVersion,h.owningTenant=c.owningTenant;const p=h.owningSystemUrl=c.owningSystemUrl;p&&this._portals.push(p)}a&&h.owningSystemUrl?n():s()},()=>{e.sinfo_._restInfoPms=null;const c=new D("identity-manager:server-identification-failed","Unknown resource - could not find token service endpoint.");i(c)}):a&&o?n():e.sinfo_._selfReq?e.sinfo_._selfReq.selfDfd.then(c=>{const h={};let p,f,m,g;return c&&(p=c.user&&c.user.username,h.username=p,h.allSSL=c.allSSL,f=c.supportsOAuth,g=parseFloat(c.currentVersion),c.portalMode==="multitenant"&&(m=c.customBaseUrl),e.sinfo_.currentVersion=g),e.sinfo_.webTierAuth=!!p,p&&this.normalizeWebTierAuth?this.generateToken(e.sinfo_,null,{ssl:h.allSSL}).catch(()=>null).then(_=>(h.portalToken=_&&_.token,h.tokenExpiration=_&&_.expires,h)):!p&&f&&g>=4.4&&!this._findOAuthInfo(e.resUrl_)?this._generateOAuthInfo({portalUrl:e.sinfo_.server,customBaseUrl:m,owningTenant:e.sinfo_._selfReq.owningTenant}).catch(()=>null).then(()=>h):h}).catch(()=>null).then(c=>{e.sinfo_._selfReq=null,c?s(c.username,c.allSSL,c.portalToken,c.tokenExpiration):s()}):s()}_generateOAuthInfo(e){let r,i=null,s=e.portalUrl;const n=e.customBaseUrl,o=e.owningTenant,a=!this._defaultOAuthInfo&&this._createDefaultOAuthInfo&&!this._hasTestedIfAppIsOnPortal;if(a){i=window.location.href;let l=i.indexOf("?");l>-1&&(i=i.slice(0,l)),l=i.search(/\/(apps|home)\//),i=l>-1?i.slice(0,l):null}return a&&i?(this._hasTestedIfAppIsOnPortal=!0,r=Lt(i+"/sharing/rest",{query:{f:"json"}}).then(()=>{this._defaultOAuthInfo=new vZ({appId:"arcgisonline",popupCallbackUrl:i+"/home/oauth-callback.html"})})):r=Promise.resolve(),r.then(()=>{if(this._defaultOAuthInfo)return s=s.replace(/^http:/i,"https:"),Lt(s+"/sharing/rest/oauth2/validateRedirectUri",{query:{accountId:o,client_id:this._defaultOAuthInfo.appId,redirect_uri:pc(this._defaultOAuthInfo.popupCallbackUrl),f:"json"}}).then(l=>{if(l.data.valid){const c=this._defaultOAuthInfo.clone();l.data.urlKey&&n?c.portalUrl="https://"+l.data.urlKey.toLowerCase()+"."+n:c.portalUrl=s,c.popup=window!==window.top||!(nu(s,this._appOrigin)||this._gwDomains.some(h=>h.regex.test(s)&&h.regex.test(this._appOrigin))),this.oAuthInfos.push(c)}})})}_doOAuthSignIn(e,r,i,s){const n=i._oAuthCred,o={portalUrl:i.portalUrl};!i.popup&&i.preserveUrlHash&&window.location.hash&&(o.hash=window.location.hash),n.stateUID&&(o.uid=n.stateUID);const a={client_id:i.appId,response_type:n.codeVerifier?"code":"token",state:JSON.stringify(o),expiration:i.expiration,locale:i.locale,redirect_uri:this._getRedirectURI(i,!!n.codeVerifier)};i.forceLogin&&(a.force_login=!0),i.forceUserId&&i.userId&&(a.prepopulatedusername=i.userId),!i.popup&&this._doPortalSignIn(e)&&(a.redirectToUserOrgUrl=!0),n.codeVerifier&&(a.code_challenge=s||n.codeVerifier,a.code_challenge_method=s?"S256":"plain");const l=i.portalUrl.replace(/^http:/i,"https:")+"/sharing/oauth2/authorize",c=l+"?"+yT(a);if(i.popup){const h=window.open(c,"esriJSAPIOAuth",i.popupWindowFeatures);if(h)h.focus(),this._oAuthDfd.oAuthWin_=h,this._oAuthIntervalId=setInterval(()=>{if(h.closed){clearInterval(this._oAuthIntervalId),this._oAuthOnPopupHandle.remove();const p=this._oAuthDfd;if(p){const f=new D("identity-manager:user-aborted","ABORTED");p.reject(f)}}},500),this._oAuthOnPopupHandle=w1(window,["arcgis:auth:hash","arcgis:auth:location:search"],p=>{p.type==="arcgis:auth:hash"?this.setOAuthResponseHash(p.detail):this._setOAuthResponseQueryString(p.detail)});else{const p=new D("identity-manager:popup-blocked","ABORTED");this._oAuthDfd.reject(p)}}else this._rejectOnPersistedPageShow=!0,this._oAuthRedirectFunc?this._oAuthRedirectFunc({authorizeParams:a,authorizeUrl:l,resourceUrl:e,serverInfo:r,oAuthInfo:i}):window.location.href=c}_getRedirectURI(e,r){const i=window.location.href.replace(/#.*$/,"");if(e.popup)return pc(e.popupCallbackUrl);if(r){const s=Fn(i);return s.query&&["code","error","error_description","message_code","persist","state"].forEach(n=>{delete s.query[n]}),bF(s.path,s.query)}return i}};XAe.prototype.declaredClass="esri.identity.IdentityManagerBase";let Ys=class extends Xr.EventedAccessor{constructor(e){super(e),this._oAuthCred=null,this.tokenRefreshBuffer=2,e&&e._oAuthCred&&(this._oAuthCred=e._oAuthCred)}initialize(){this.resources=this.resources||[],this.creationTime==null&&(this.creationTime=Date.now())}refreshToken(){const e=Gt.findServerInfo(this.server),r=e&&e.owningSystemUrl,i=!!r&&this.scope==="server",s=i&&bZ(e,Gt._legacyFed),n=e.webTierAuth,o=n&&Gt.normalizeWebTierAuth,a=I4[this.server],l=a&&a[this.userId];let c,h=this.resources&&this.resources[0],p=i?Gt.findServerInfo(r):null,f={username:this.userId,password:l};if(n&&!o)return;i&&!p&&Gt.serverInfos.some(g=>(Gt._isIdProvider(r,g.server)&&(p=g),!!p));const m=p?Gt.findCredential(p.server,this.userId):null;if(!i||m){if(!s){if(i)c={serverUrl:h,token:m&&m.token,ssl:m&&m.ssl};else if(o)f=null,c={ssl:this.ssl};else{if(!l){let g;return h&&(h=Gt._sanitizeUrl(h),this._enqueued=1,g=Gt._enqueue(h,e,null,null,this.isAdmin,this),g.then(()=>{this._enqueued=0,this.refreshServerTokens()}).catch(()=>{this._enqueued=0})),g}this.isAdmin&&(c={isAdmin:!0})}return Gt.generateToken(i?p:e,i?null:f,c).then(g=>{this.token=g.token,this.expires=g.expires!=null?Number(g.expires):null,this.creationTime=Date.now(),this.validity=g.validity,this.emitTokenChange(),this.refreshServerTokens()}).catch(()=>{})}m?.refreshToken()}}refreshServerTokens(){this.scope==="portal"&&Gt.credentials.forEach(e=>{const r=Gt.findServerInfo(e.server),i=r&&r.owningSystemUrl;e!==this&&e.userId===this.userId&&i&&e.scope==="server"&&(Gt._hasSameServerInstance(this.server,i)||Gt._isIdProvider(i,this.server))&&(bZ(r,Gt._legacyFed)?(e.token=this.token,e.expires=this.expires,e.creationTime=this.creationTime,e.validity=this.validity,e.emitTokenChange()):e.refreshToken())})}emitTokenChange(e){clearTimeout(this._refreshTimer);const r=this.server&&Gt.findServerInfo(this.server),i=r&&r.owningSystemUrl,s=i&&Gt.findServerInfo(i);e===!1||i&&this.scope!=="portal"&&(!s||!s.webTierAuth||Gt.normalizeWebTierAuth)||this.expires==null&&this.validity==null||this._startRefreshTimer(),this.emit("token-change")}destroy(){this.userId=this.server=this.token=this.expires=this.validity=this.resources=this.creationTime=null,this._oAuthCred&&(this._oAuthCred.destroy(),this._oAuthCred=null);const e=Gt.credentials.indexOf(this);e>-1&&Gt.credentials.splice(e,1),this.emitTokenChange(),this.emit("destroy")}toJSON(){const e=E6({userId:this.userId,server:this.server,token:this.token,expires:this.expires,validity:this.validity,ssl:this.ssl,isAdmin:this.isAdmin,creationTime:this.creationTime,scope:this.scope}),r=this.resources;return r&&r.length>0&&(e.resources=r.slice()),e}_startRefreshTimer(){clearTimeout(this._refreshTimer);const e=6e4*this.tokenRefreshBuffer,r=2**31-1;let i=(this.validity?this.creationTime+6e4*this.validity:this.expires)-Date.now();i<0?i=0:i>r&&(i=r),this._refreshTimer=setTimeout(this.refreshToken.bind(this),i>e?i-e:i)}};u([d()],Ys.prototype,"creationTime",void 0),u([d()],Ys.prototype,"expires",void 0),u([d()],Ys.prototype,"isAdmin",void 0),u([d()],Ys.prototype,"oAuthState",void 0),u([d()],Ys.prototype,"resources",void 0),u([d()],Ys.prototype,"scope",void 0),u([d()],Ys.prototype,"server",void 0),u([d()],Ys.prototype,"ssl",void 0),u([d()],Ys.prototype,"token",void 0),u([d()],Ys.prototype,"tokenRefreshBuffer",void 0),u([d()],Ys.prototype,"userId",void 0),u([d()],Ys.prototype,"validity",void 0),Ys=u([R("esri.identity.Credential")],Ys);let YAe=class extends XAe{};YAe.prototype.declaredClass="esri.identity.IdentityManager";const HV=new YAe;IUe(HV);const Mnt=Object.freeze(Object.defineProperty({__proto__:null,default:HV},Symbol.toStringTag,{value:"Module"}));function JAe(t){return t&&"getAtOrigin"in t&&"originOf"in t}function Oce(t){t&&t.writtenProperties&&t.writtenProperties.forEach(({target:e,propName:r,newOrigin:i})=>{JAe(e)&&i&&e.originOf(r)!==i&&e.updateOrigin(r,i)})}async function Int(t,e,r,i,s,n){let o=null;if(r!=null){const c=`${t}/nodepages/`,h=c+Math.floor(r.rootIndex/r.nodesPerPage);try{return{type:"page",rootPage:(await Lt(h,{query:{f:"json",token:i},responseType:"json",signal:n})).data,rootIndex:r.rootIndex,pageSize:r.nodesPerPage,lodMetric:r.lodSelectionMetricType,urlPrefix:c}}catch(p){s?.warn("#fetchIndexInfo()","Failed to load root node page. Falling back to node documents.",h,p),o=p}}if(!e)return null;const a=`${t}/nodes/`,l=a+(e&&e.split("/").pop());try{return{type:"node",rootNode:(await Lt(l,{query:{f:"json",token:i},responseType:"json",signal:n})).data,urlPrefix:a}}catch(c){throw new D("sceneservice:root-node-missing","Root node missing.",{pageError:o,nodeError:c,url:l})}}let Pnt=null;function $nt(){return Pnt}async function Lnt(t,e={},r){await t.load(r);const i=Cu(t.itemUrl,"resources"),{start:s=1,num:n=10,sortOrder:o="asc",sortField:a="created"}=e,l={query:{start:s,num:n,sortOrder:o,sortField:a,token:t.apiKey},signal:r?.signal},c=await t.portal.request(i,l);return{total:c.total,nextStart:c.nextStart,resources:c.resources.map(({created:h,size:p,resource:f})=>({created:new Date(h),size:p,resource:t.resourceFromPath(f)}))}}async function Dnt(t,e,r,i){if(!t.hasPath())throw new D(`portal-item-resource-${e}:invalid-path`,"Resource does not have a valid path");const s=t.portalItem;await s.load(i);const n=Cu(s.userItemUrl,e==="add"?"addResources":"updateResources"),[o,a]=QAe(t.path),l=await KAe(r),c=new FormData;return o&&o!=="."&&c.append("resourcesPrefix",o),i!=null&&i.compress&&c.append("compress","true"),c.append("fileName",a),c.append("file",l,a),c.append("f","json"),i!=null&&i.access&&c.append("access",i.access),await s.portal.request(n,{method:"post",body:c,signal:i?.signal}),t}async function Nnt(t,e,r){if(!e.hasPath())throw new D("portal-item-resources-remove:invalid-path","Resource does not have a valid path");await t.load(r);const i=Cu(t.userItemUrl,"removeResources");await t.portal.request(i,{method:"post",query:{resource:e.path},signal:r?.signal}),e.portalItem=null}async function Fnt(t,e){await t.load(e);const r=Cu(t.userItemUrl,"removeResources");return t.portal.request(r,{method:"post",query:{deleteAll:!0},signal:e?.signal})}function QAe(t){const e=t.lastIndexOf("/");return e===-1?[".",t]:[t.slice(0,e),t.slice(e+1)]}function ote(t){const[e,r]=knt(t),[i,s]=QAe(e);return[i,s,r]}function knt(t){const e=eQ(t);return e==null?[t,""]:[t.slice(0,t.length-e.length-1),`.${e}`]}async function KAe(t){return t instanceof Blob?t:(await Lt(t.url,{responseType:"blob"})).data}function Unt(t,e){if(!t.hasPath())return null;const[r,,i]=ote(t.path);return t.portalItem.resourceFromPath(Cu(r,e+i))}function eOe(t,e){if(!t.hasPath())return null;const[r,,i]=ote(t.path);return t.portalItem.resourceFromPath(Cu(r,e+i))}const j3=Object.freeze(Object.defineProperty({__proto__:null,addOrUpdateResource:Dnt,contentToBlob:KAe,fetchResources:Lnt,getSiblingOfSameType:Unt,getSiblingOfSameTypeI:eOe,removeAllResources:Fnt,removeResource:Nnt,splitPrefixFileNameAndExtension:ote},Symbol.toStringTag,{value:"Module"}));async function Rce(t,e,r){if(!e||!e.resources)return;const i=e.portalItem===t.portalItem?new Set(t.paths):new Set;t.paths.length=0,t.portalItem=e.portalItem;const s=new Set(e.resources.toKeep.map(c=>c.resource.path)),n=new Set,o=[];s.forEach(c=>{i.delete(c),t.paths.push(c)});for(const c of e.resources.toUpdate)if(i.delete(c.resource.path),s.has(c.resource.path)||n.has(c.resource.path)){const{resource:h,content:p,finish:f,error:m}=c,g=eOe(h,j6());t.paths.push(g.path),o.push(Mce({resource:g,content:p,compress:c.compress,finish:f,error:m},r))}else t.paths.push(c.resource.path),o.push(Vnt(c,r)),n.add(c.resource.path);for(const c of e.resources.toAdd)o.push(Mce(c,r)),t.paths.push(c.resource.path);if(i.forEach(c=>{if(e.portalItem){const h=e.portalItem.resourceFromPath(c);o.push(h.portalItem.removeResource(h).catch(()=>{}))}}),o.length===0)return;const a=await Oh(o);Dt(r);const l=a.filter(c=>"error"in c).map(c=>c.error);if(l.length>0)throw new D("save:resources","Failed to save one or more resources",{errors:l})}async function Mce(t,e){const r={...e??{},compress:t.compress},i=await Sh(t.resource.portalItem.addResource(t.resource,t.content,r));if(i.ok!==!0)throw t.error?.(i.error),i.error;t.finish?.(t.resource)}async function Vnt(t,e){const r=await Sh(t.resource.update(t.content,e));if(r.ok!==!0)throw t.error?.(r.error),r.error;t.finish?.(t.resource)}const tOe="esri.layers.mixins.SceneService",IS=K.getLogger(tOe),znt=t=>{let e=class extends t{constructor(){super(...arguments),this.spatialReference=null,this.fullExtent=null,this.heightModelInfo=null,this.minScale=0,this.maxScale=0,this.version={major:Number.NaN,minor:Number.NaN,versionString:""},this.copyright=null,this.sublayerTitleMode="item-title",this.title=null,this.layerId=null,this.indexInfo=null,this._debouncedSaveOperations=x1(async(r,i,s)=>{switch(r){case bA.SAVE:return this._save(i);case bA.SAVE_AS:return this._saveAs(s,i)}})}readSpatialReference(r,i){return this._readSpatialReference(i)}_readSpatialReference(r){if(r.spatialReference!=null)return qe.fromJSON(r.spatialReference);{const i=r.store,s=i.indexCRS||i.geographicCRS,n=s&&parseInt(s.substring(s.lastIndexOf("/")+1,s.length),10);return n!=null?new qe(n):null}}readFullExtent(r,i,s){if(r!=null&&typeof r=="object"){const a=r.spatialReference==null?{...r,spatialReference:this._readSpatialReference(i)}:r;return vr.fromJSON(a,s)}const n=i.store,o=this._readSpatialReference(i);return o==null||n==null||n.extent==null||!Array.isArray(n.extent)||n.extent.some(a=>a<Lz)?null:new vr({xmin:n.extent[0],ymin:n.extent[1],xmax:n.extent[2],ymax:n.extent[3],spatialReference:o})}parseVersionString(r){const i={major:Number.NaN,minor:Number.NaN,versionString:r},s=r.split(".");return s.length>=2&&(i.major=parseInt(s[0],10),i.minor=parseInt(s[1],10)),i}readVersion(r,i){const s=i.store,n=s.version!=null?s.version.toString():"";return this.parseVersionString(n)}readTitlePortalItem(r){return this.sublayerTitleMode!=="item-title"?void 0:r}readTitleService(r,i){const s=this.portalItem&&this.portalItem.title;if(this.sublayerTitleMode==="item-title")return bTe(this.url,i.name);let n=i.name;if(!n&&this.url){const o=sg(this.url);o!=null&&(n=o.title)}return this.sublayerTitleMode==="item-title-and-service-name"&&s&&(n=s+" - "+n),hV(n)}set url(r){const i=wTe({layer:this,url:r,nonStandardUrlAllowed:!1,logger:IS});this._set("url",i.url),i.layerId!=null&&this._set("layerId",i.layerId)}writeUrl(r,i,s,n){xTe(this,r,"layers",i,n)}get parsedUrl(){const r=this._get("url"),i=Fn(r);return this.layerId!=null&&(i.path=`${i.path}/layers/${this.layerId}`),i}async _fetchIndexAndUpdateExtent(r,i){this.indexInfo=Int(this.parsedUrl.path,this.rootNode,r,this.apiKey,IS,i),this.fullExtent==null||this.fullExtent.hasZ||this._updateExtent(await this.indexInfo)}_updateExtent(r){if(r?.type==="page"){const i=r.rootIndex%r.pageSize,s=r.rootPage?.nodes?.[i];if(s==null||s.obb==null||s.obb.center==null||s.obb.halfSize==null)throw new D("sceneservice:invalid-node-page","Invalid node page.");if(s.obb.center[0]<Lz||this.fullExtent==null||this.fullExtent.hasZ)return;const n=s.obb.halfSize,o=s.obb.center[2],a=Math.sqrt(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]);this.fullExtent.zmin=o-a,this.fullExtent.zmax=o+a}else if(r?.type==="node"){const i=r.rootNode?.mbs;if(!Array.isArray(i)||i.length!==4||i[0]<Lz)return;const s=i[2],n=i[3],{fullExtent:o}=this;o&&(o.zmin=s-n,o.zmax=s+n)}}async _fetchService(r){if(this.url==null)throw new D("sceneservice:url-not-set","Scene service can not be loaded without valid portal item or url");if(this.layerId==null&&/SceneServer\/*$/i.test(this.url)){const i=await this._fetchFirstLayerId(r);i!=null&&(this.layerId=i)}return this._fetchServiceLayer(r)}async _fetchFirstLayerId(r){const i=await Lt(this.url,{query:{f:"json",token:this.apiKey},responseType:"json",signal:r});if(i.data&&Array.isArray(i.data.layers)&&i.data.layers.length>0)return i.data.layers[0].id}async _fetchServiceLayer(r){const i=await Lt(this.parsedUrl?.path??"",{query:{f:"json",token:this.apiKey},responseType:"json",signal:r});i.ssl&&(this.url=this.url.replace(/^http:/i,"https:"));let s=!1;if(i.data.layerType&&i.data.layerType==="Voxel"&&(s=!0),s)return this._fetchVoxelServiceLayer();const n=i.data;this.read(n,this._getServiceContext()),this.validateLayer(n)}async _fetchVoxelServiceLayer(r){const i=(await Lt(this.parsedUrl?.path+"/layer",{query:{f:"json",token:this.apiKey},responseType:"json",signal:r})).data;this.read(i,this._getServiceContext()),this.validateLayer(i)}_getServiceContext(){return{origin:"service",portalItem:this.portalItem,portal:this.portalItem?.portal,url:this.parsedUrl}}async _ensureLoadBeforeSave(){await this.load(),"beforeSave"in this&&typeof this.beforeSave=="function"&&await this.beforeSave()}validateLayer(r){}_updateTypeKeywords(r,i,s){r.typeKeywords||(r.typeKeywords=[]);const n=i.getTypeKeywords();for(const o of n)r.typeKeywords.push(o);r.typeKeywords&&(r.typeKeywords=r.typeKeywords.filter((o,a,l)=>l.indexOf(o)===a),s===iI.newItem&&(r.typeKeywords=r.typeKeywords.filter(o=>o!=="Hosted Service")))}async _saveAs(r,i){const s={...Ice,...i};let n=iT.from(r);n||(IS.error("_saveAs(): requires a portal item parameter"),await Promise.reject(new D("sceneservice:portal-item-required","_saveAs() requires a portal item to save to"))),n.id&&(n=n.clone(),n.id=null);const o=n.portal||ao.getDefault();await this._ensureLoadBeforeSave(),n.type=iD,n.portal=o;const a={origin:"portal-item",url:null,messages:[],portal:o,portalItem:n,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},l={layers:[this.write({},a)]};return await Promise.all(a.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(l,a,s),n.url=this.url,n.title||(n.title=this.title),this._updateTypeKeywords(n,s,iI.newItem),await o.signIn(),await o.user?.addItem({item:n,folder:s&&s.folder,data:l}),await Rce(this.resourceReferences,a,null),this.portalItem=n,Oce(a),a.portalItem=n,n}async _save(r){const i={...Ice,...r};if(!this.portalItem)throw IS.error("_save(): requires the .portalItem property to be set"),new D("sceneservice:portal-item-not-set","Portal item to save to has not been set on this SceneService");if(this.portalItem.type!==iD)throw IS.error("_save(): Non-matching portal item type. Got "+this.portalItem.type+", expected "+iD),new D("sceneservice:portal-item-wrong-type",`Portal item needs to have type "${iD}"`);await this._ensureLoadBeforeSave();const s={origin:"portal-item",url:this.portalItem.itemUrl&&Fn(this.portalItem.itemUrl),messages:[],portal:this.portalItem.portal||ao.getDefault(),portalItem:this.portalItem,writtenProperties:[],blockedRelativeUrls:[],resources:{toAdd:[],toUpdate:[],toKeep:[],pendingOperations:[]}},n={layers:[this.write({},s)]};return await Promise.all(s.resources.pendingOperations??[]),await this._validateAgainstJSONSchema(n,s,i),this.portalItem.url=this.url,this.portalItem.title||(this.portalItem.title=this.title),this._updateTypeKeywords(this.portalItem,i,iI.existingItem),await this.portalItem.update({data:n}),await Rce(this.resourceReferences,s,null),Oce(s),this.portalItem}async _validateAgainstJSONSchema(r,i,s){let n=i.messages?.filter(c=>c.type==="error").map(c=>new D(c.name,c.message,c.details))??[];s?.validationOptions?.ignoreUnsupported&&(n=n.filter(c=>c.name!=="layer:unsupported"&&c.name!=="symbol:unsupported"&&c.name!=="symbol-layer:unsupported"&&c.name!=="property:unsupported"&&c.name!=="url:unsupported"&&c.name!=="scenemodification:unsupported"));const o=s?.validationOptions,a=o?.enabled,l=$nt();if(a&&l){const c=(await l()).validate(r,s.portalItemLayerType);if(c.length>0){const h=`Layer item did not validate:
${c.join(`
`)}`;if(IS.error(`_validateAgainstJSONSchema(): ${h}`),o.failPolicy==="throw"){const p=c.map(f=>new D("sceneservice:schema-validation",f)).concat(n);throw new D("sceneservice-validate:error","Failed to save layer item due to schema validation, see `details.errors`.",{combined:p})}}}if(n.length>0)throw new D("sceneservice:save","Failed to save SceneService due to unsupported or invalid content. See 'details.errors' for more detailed information",{errors:n})}};return u([d(a2e)],e.prototype,"id",void 0),u([d({type:qe})],e.prototype,"spatialReference",void 0),u([Ae("spatialReference",["spatialReference","store.indexCRS","store.geographicCRS"])],e.prototype,"readSpatialReference",null),u([d({type:vr})],e.prototype,"fullExtent",void 0),u([Ae("fullExtent",["fullExtent","store.extent","spatialReference","store.indexCRS","store.geographicCRS"])],e.prototype,"readFullExtent",null),u([d({readOnly:!0,type:dS})],e.prototype,"heightModelInfo",void 0),u([d({type:Number,json:{name:"layerDefinition.minScale",write:!0,origins:{service:{read:{source:"minScale"},write:!1}}}})],e.prototype,"minScale",void 0),u([d({type:Number,json:{name:"layerDefinition.maxScale",write:!0,origins:{service:{read:{source:"maxScale"},write:!1}}}})],e.prototype,"maxScale",void 0),u([d({readOnly:!0})],e.prototype,"version",void 0),u([Ae("version",["store.version"])],e.prototype,"readVersion",null),u([d({type:String,json:{read:{source:"copyrightText"}}})],e.prototype,"copyright",void 0),u([d({type:String,json:{read:!1}})],e.prototype,"sublayerTitleMode",void 0),u([d({type:String})],e.prototype,"title",void 0),u([Ae("portal-item","title")],e.prototype,"readTitlePortalItem",null),u([Ae("service","title",["name"])],e.prototype,"readTitleService",null),u([d({type:Number,json:{origins:{service:{read:{source:"id"}},"portal-item":{write:{target:"id",isRequired:!0,ignoreOrigin:!0},read:!1}}}})],e.prototype,"layerId",void 0),u([d(i2e)],e.prototype,"url",null),u([Ve("url")],e.prototype,"writeUrl",null),u([d()],e.prototype,"parsedUrl",null),u([d({readOnly:!0})],e.prototype,"store",void 0),u([d({type:String,readOnly:!0,json:{read:{source:"store.rootNode"}}})],e.prototype,"rootNode",void 0),e=u([R(tOe)],e),e},Lz=-1e38;var iI;(function(t){t[t.existingItem=0]="existingItem",t[t.newItem=1]="newItem"})(iI||(iI={}));const iD="Scene Service",Ice={getTypeKeywords:()=>[],portalItemLayerType:"unknown",validationOptions:{enabled:!0,ignoreUnsupported:!1,failPolicy:"throw"}};var bA;(function(t){t[t.SAVE=0]="SAVE",t[t.SAVE_AS=1]="SAVE_AS"})(bA||(bA={}));const Bnt={analytics:{supportsCacheHint:!1},attachment:{supportsContentType:!1,supportsExifInfo:!1,supportsKeywords:!1,supportsName:!1,supportsSize:!1,supportsCacheHint:!1,supportsResize:!1},data:{isVersioned:!1,supportsAttachment:!1,supportsM:!1,supportsZ:!1},editing:{supportsDeleteByAnonymous:!1,supportsDeleteByOthers:!1,supportsGeometryUpdate:!1,supportsGlobalId:!1,supportsReturnServiceEditsInSourceSpatialReference:!1,supportsRollbackOnFailure:!1,supportsUpdateByAnonymous:!1,supportsUpdateByOthers:!1,supportsUpdateWithoutM:!1,supportsUploadWithItemId:!1,supportsAsyncApplyEdits:!1},metadata:{supportsAdvancedFieldProperties:!1},operations:{supportsCalculate:!1,supportsTruncate:!1,supportsValidateSql:!1,supportsAdd:!1,supportsDelete:!1,supportsEditing:!1,supportsChangeTracking:!1,supportsQuery:!1,supportsQueryAnalytics:!1,supportsQueryAttachments:!1,supportsQueryTopFeatures:!1,supportsResizeAttachments:!1,supportsSync:!1,supportsUpdate:!1,supportsExceedsLimitStatistics:!1,supportsAsyncConvert3D:!1},queryRelated:{supportsCount:!1,supportsOrderBy:!1,supportsPagination:!1,supportsCacheHint:!1},queryTopFeatures:{supportsCacheHint:!1},query:{maxRecordCount:0,maxRecordCountFactor:0,standardMaxRecordCount:0,supportsCacheHint:!1,supportsCentroid:!1,supportsCompactGeometry:!1,supportsDefaultSpatialReference:!1,supportsFullTextSearch:!1,supportsDisjointSpatialRelationship:!1,supportsDistance:!1,supportsDistinct:!1,supportsExtent:!1,supportsFormatPBF:!1,supportsGeometryProperties:!1,supportsHavingClause:!1,supportsHistoricMoment:!1,supportsMaxRecordCountFactor:!1,supportsOrderBy:!1,supportsPagination:!1,supportsPercentileStatistics:!1,supportsQuantization:!1,supportsQuantizationEditMode:!1,supportsQueryByOthers:!1,supportsQueryGeometry:!1,supportsResultType:!1,supportsSqlExpression:!1,supportsStandardizedQueriesOnly:!1,supportsTopFeaturesQuery:!1,supportsSpatialAggregationStatistics:!1,supportedSpatialAggregationStatistics:{envelope:!1,centroid:!1,convexHull:!1},supportsStatistics:!1,tileMaxRecordCount:0}};let Gnt=class{constructor(e,r,i,s){this._parsedUrl=e,this._portalItem=r,this._apiKey=i,this.signal=s,this._rootDocument=null;const n=this._parsedUrl?.path.match(/^(.*)\/SceneServer\/layers\/([\d]*)\/?$/i);n&&(this._urlParts={root:n[1],layerId:parseInt(n[2],10)})}async fetch(){if(!this._urlParts)return null;const e=this._portalItem??await this._portalItemFromServiceItemId();if(e==null)return this._loadFromUrl();const r=await this._findAndLoadRelatedPortalItem(e);return r==null?null:this._loadFeatureLayerFromPortalItem(r)}async fetchPortalItem(){if(!this._urlParts)return null;const e=this._portalItem??await this._portalItemFromServiceItemId();return e==null?null:this._findAndLoadRelatedPortalItem(e)}async _fetchRootDocument(){if(this._rootDocument!=null)return this._rootDocument;if(this._urlParts==null)return this._rootDocument={},{};const e={query:{f:"json",token:this._apiKey},responseType:"json",signal:this.signal},r=`${this._urlParts.root}/SceneServer`;try{const i=await Lt(r,e);this._rootDocument=i.data}catch{this._rootDocument={}}return this._rootDocument}async _fetchServiceOwningPortalUrl(){const e=this._parsedUrl?.path,r=e?Gt?.findServerInfo(e):null;if(r?.owningSystemUrl)return r.owningSystemUrl;const i=e?e.replace(/(.*\/rest)\/.*/i,"$1")+"/info":null;try{const s=(await Lt(i,{query:{f:"json"},responseType:"json",signal:this.signal})).data.owningSystemUrl;if(s)return s}catch(s){xa(s)}return null}async _findAndLoadRelatedPortalItem(e){try{return(await e.fetchRelatedItems({relationshipType:"Service2Service",direction:"reverse"},{signal:this.signal})).find(r=>r.type==="Feature Service")||null}catch(r){return xa(r),null}}async _loadFeatureLayerFromPortalItem(e){await e.load({signal:this.signal});const r=await this._findMatchingAssociatedSublayerUrl(e.url??"");return new Vk({url:r,portalItem:e}).load({signal:this.signal})}async _loadFromUrl(){const e=await this._findMatchingAssociatedSublayerUrl(`${this._urlParts?.root}/FeatureServer`);return new Vk({url:e}).load({signal:this.signal})}async _findMatchingAssociatedSublayerUrl(e){const r=e.replace(/^(.*FeatureServer)(\/[\d]*\/?)?$/i,"$1"),i=this._urlParts?.layerId,s=this._fetchRootDocument(),n=p=>{const f={query:{f:"json"},responseType:"json",authMode:p,signal:this.signal};return Lt(r,f)},o=n("anonymous").catch(()=>n("no-prompt")),[a,l]=await Promise.all([o,s]),c=l&&l.layers,h=a.data&&a.data.layers;if(!Array.isArray(h))throw new Error("expected layers array");if(Array.isArray(c)){for(let p=0;p<Math.min(c.length,h.length);p++)if(c[p].id===i)return`${r}/${h[p].id}`}else if(i!=null&&i<h.length)return`${r}/${h[i].id}`;throw new Error("could not find matching associated sublayer")}async _portalItemFromServiceItemId(){const e=(await this._fetchRootDocument()).serviceItemId;if(!e)return null;const r=new iT({id:e,apiKey:this._apiKey}),i=await this._fetchServiceOwningPortalUrl();i!=null&&(r.portal=new ao({url:i}));try{return r.load({signal:this.signal})}catch(s){return xa(s),null}}},Ox=class extends he{constructor(){super(...arguments),this.nodesPerPage=null,this.rootIndex=0,this.lodSelectionMetricType=null}};u([d({type:Number})],Ox.prototype,"nodesPerPage",void 0),u([d({type:Number})],Ox.prototype,"rootIndex",void 0),u([d({type:String})],Ox.prototype,"lodSelectionMetricType",void 0),Ox=u([R("esri.layer.support.I3SNodePageDefinition")],Ox);let s0=class extends he{constructor(){super(...arguments),this.factor=1}};u([d({type:Number,json:{read:{source:"textureSetDefinitionId"}}})],s0.prototype,"id",void 0),u([d({type:Number})],s0.prototype,"factor",void 0),s0=u([R("esri.layer.support.I3SMaterialTexture")],s0);let yv=class extends he{constructor(){super(...arguments),this.baseColorFactor=[1,1,1,1],this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.metallicFactor=1,this.roughnessFactor=1}};u([d({type:[Number]})],yv.prototype,"baseColorFactor",void 0),u([d({type:s0})],yv.prototype,"baseColorTexture",void 0),u([d({type:s0})],yv.prototype,"metallicRoughnessTexture",void 0),u([d({type:Number})],yv.prototype,"metallicFactor",void 0),u([d({type:Number})],yv.prototype,"roughnessFactor",void 0),yv=u([R("esri.layer.support.I3SMaterialPBRMetallicRoughness")],yv);let ed=class extends he{constructor(){super(...arguments),this.alphaMode="opaque",this.alphaCutoff=.25,this.doubleSided=!1,this.cullFace="none",this.normalTexture=null,this.occlusionTexture=null,this.emissiveTexture=null,this.emissiveFactor=null,this.pbrMetallicRoughness=null}};u([nt({opaque:"opaque",mask:"mask",blend:"blend"})],ed.prototype,"alphaMode",void 0),u([d({type:Number})],ed.prototype,"alphaCutoff",void 0),u([d({type:Boolean})],ed.prototype,"doubleSided",void 0),u([nt({none:"none",back:"back",front:"front"})],ed.prototype,"cullFace",void 0),u([d({type:s0})],ed.prototype,"normalTexture",void 0),u([d({type:s0})],ed.prototype,"occlusionTexture",void 0),u([d({type:s0})],ed.prototype,"emissiveTexture",void 0),u([d({type:[Number]})],ed.prototype,"emissiveFactor",void 0),u([d({type:yv})],ed.prototype,"pbrMetallicRoughness",void 0),ed=u([R("esri.layer.support.I3SMaterialDefinition")],ed);let H3=class extends he{};u([d({type:String,json:{read:{source:["name","index"],reader:(t,e)=>t??`${e.index}`}}})],H3.prototype,"name",void 0),u([nt({jpg:"jpg",png:"png",dds:"dds","ktx-etc2":"ktx-etc2",ktx2:"ktx2",basis:"basis"})],H3.prototype,"format",void 0),H3=u([R("esri.layer.support.I3STextureFormat")],H3);let q3=class extends he{constructor(){super(...arguments),this.atlas=!1}};u([d({type:[H3]})],q3.prototype,"formats",void 0),u([d({type:Boolean})],q3.prototype,"atlas",void 0),q3=u([R("esri.layer.support.I3STextureSetDefinition")],q3);let ef=class extends he{};u([nt({Float32:"Float32",UInt64:"UInt64",UInt32:"UInt32",UInt16:"UInt16",UInt8:"UInt8"})],ef.prototype,"type",void 0),u([d({type:Number})],ef.prototype,"component",void 0),ef=u([R("esri.layer.support.I3SGeometryAttribute")],ef);let W3=class extends he{};u([nt({draco:"draco"})],W3.prototype,"encoding",void 0),u([d({type:[String]})],W3.prototype,"attributes",void 0),W3=u([R("esri.layer.support.I3SGeometryCompressedAttributes")],W3);let pp=class extends he{constructor(){super(...arguments),this.offset=0}};u([d({type:Number})],pp.prototype,"offset",void 0),u([d({type:ef})],pp.prototype,"position",void 0),u([d({type:ef})],pp.prototype,"normal",void 0),u([d({type:ef})],pp.prototype,"uv0",void 0),u([d({type:ef})],pp.prototype,"color",void 0),u([d({type:ef})],pp.prototype,"uvRegion",void 0),u([d({type:ef})],pp.prototype,"featureId",void 0),u([d({type:ef})],pp.prototype,"faceRange",void 0),u([d({type:W3})],pp.prototype,"compressedAttributes",void 0),pp=u([R("esri.layer.support.I3SGeometryBuffer")],pp);let Z3=class extends he{};u([nt({triangle:"triangle"})],Z3.prototype,"topology",void 0),u([d()],Z3.prototype,"geometryBuffers",void 0),Z3=u([R("esri.layer.support.I3SGeometryDefinition")],Z3);let _v=class extends he{constructor(){super(...arguments),this.name=null,this.field=null,this.currentRangeExtent=null,this.fullRangeExtent=null,this.type="rangeInfo"}};u([d({type:String,json:{read:!0,write:!0}})],_v.prototype,"name",void 0),u([d({type:String,json:{read:!0,write:!0}})],_v.prototype,"field",void 0),u([d({type:[Number],json:{read:!0,write:!0}})],_v.prototype,"currentRangeExtent",void 0),u([d({type:[Number],json:{read:!0,write:!0}})],_v.prototype,"fullRangeExtent",void 0),u([d({type:["rangeInfo"],readOnly:!0,json:{read:!1,write:!0}})],_v.prototype,"type",void 0),_v=u([R("esri.layers.support.RangeInfo")],_v);function wZ(t){return ate[jnt(t)]||qnt}function jnt(t){return t instanceof Blob?t.type:Hnt(t.url)}function Hnt(t){const e=eQ(t);return xZ[e]||rOe}const ate={},rOe="text/plain",qnt=ate[rOe],xZ={png:"image/png",jpeg:"image/jpeg",jpg:"image/jpg",bmp:"image/bmp",gif:"image/gif",json:"application/json",txt:"text/plain",xml:"application/xml",svg:"image/svg+xml",zip:"application/zip",pbf:"application/vnd.mapbox-vector-tile",gz:"application/gzip","bin.gz":"application/octet-stream"};for(const t in xZ)ate[xZ[t]]=t;function Wnt(t){const e=t?.origins??[void 0];return(r,i)=>{const s=Znt(t,r,i);for(const n of e){const o=aQ(r,n,i);for(const a in s)o[a]=s[a]}}}function Znt(t,e,r){if(t?.type==="resource")return Xnt(t,e,r);switch(t?.type??"other"){case"other":return{read:!0,write:!0};case"url":{const{read:i,write:s}=A7e;return{read:i,write:s}}}}function Xnt(t,e,r){const i=HP(e,r);return{type:String,read:(s,n,o)=>{const a=tV(s,n,o);return i.type===String?a:typeof i.type=="function"?new i.type({url:a}):void 0},write:{writer(s,n,o,a){if(!a||!a.resources)return typeof s=="string"?void(n[o]=O0(s,a)):void(n[o]=s.write({},a));const l=Knt(s),c=O0(l,{...a,verifyItemRelativeUrls:a&&a.verifyItemRelativeUrls?{writtenUrls:a.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},lA.NO),h=i.type!==String&&(!JAe(this)||a&&a.origin&&this.originIdOf(r)>t0(a.origin)),p={object:this,propertyName:r,value:s,targetUrl:c,dest:n,targetPropertyName:o,context:a,params:t};a&&a.portalItem&&c&&!wu(c)?h?Ynt(p):Jnt(p):a&&a.portalItem&&(c==null||_xe(c)!=null||$1(c)||h)?iOe(p):n[o]=c}}}}function iOe(t){const{targetUrl:e,params:r,value:i,context:s,dest:n,targetPropertyName:o}=t;if(!s.portalItem)return;const a=vxe(e),l=a?.filename??j6(),c=r?.prefix??a?.prefix,h=nOe(i,e,s),p=Cu(c,l),f=`${p}.${wZ(h)}`,m=s.portalItem.resourceFromPath(f);$1(e)&&s.resources&&s.resources.pendingOperations.push(Qnt(e).then(_=>{m.path=`${p}.${wZ(_)}`,n[o]=m.itemRelativeUrl}).catch(()=>{}));const g=r?.compress??!1;s.resources&&sOe({...t,resource:m,content:h,compress:g,updates:s.resources.toAdd}),n[o]=m.itemRelativeUrl}function Ynt(t){const{context:e,targetUrl:r,params:i,value:s,dest:n,targetPropertyName:o}=t;if(!e.portalItem)return;const a=e.portalItem.resourceFromPath(r),l=nOe(s,r,e),c=wZ(l),h=eQ(a.path),p=i?.compress??!1;c===h?(e.resources&&sOe({...t,resource:a,content:l,compress:p,updates:e.resources.toUpdate}),n[o]=r):iOe(t)}function Jnt({context:t,targetUrl:e,dest:r,targetPropertyName:i}){t.portalItem&&t.resources&&(t.resources.toKeep.push({resource:t.portalItem.resourceFromPath(e),compress:!1}),r[i]=e)}function sOe({object:t,propertyName:e,updates:r,resource:i,content:s,compress:n}){r.push({resource:i,content:s,compress:n,finish:o=>{eot(t,e,o)}})}function nOe(t,e,r){return typeof t=="string"?{url:e}:new Blob([JSON.stringify(t.toJSON(r))],{type:"application/json"})}async function Qnt(t){const e=(await J(()=>Promise.resolve().then(()=>Ave),void 0,import.meta.url)).default,{data:r}=await e(t,{responseType:"blob"});return r}function Knt(t){return t==null?null:typeof t=="string"?t:t.url}function eot(t,e,r){typeof t[e]=="string"?t[e]=r.url:t[e].url=r.url}var L4;let TZ=L4=class extends iS(Ke.ofType(bc)){constructor(t){super(t)}clone(){return new L4(this.items.map(t=>t.clone()))}write(t,e){return this.toJSON(e)}toJSON(t){const e=t?.layer?.spatialReference;return e?this.toArray().map(r=>{if(!e.equals(r.spatialReference)){if(!$f(r.spatialReference,e))return t&&t.messages&&t.messages.push(new Bd("scenefilter:unsupported","Scene filters with incompatible spatial references are not supported",{modification:this,spatialReference:t.layer.spatialReference,context:t})),null;const s=new bc;F2e(r,s,e),r=s}const i=r.toJSON(t);return delete i.spatialReference,i}).filter(r=>r!=null):(t?.messages&&t.messages.push(new Bd("scenefilter:unsupported","Writing Scene filters without context layer is not supported",{modification:this,spatialReference:t.layer.spatialReference,context:t})),this.toArray().map(r=>r.toJSON(t)))}static fromJSON(t,e){const r=new L4;return t.forEach(i=>r.add(bc.fromJSON(i,e))),r}};TZ=L4=u([R("esri.layers.support.PolygonCollection")],TZ);const D4=TZ;var SZ;let _E=SZ=class extends he{constructor(t){super(t),this.spatialRelationship="disjoint",this.geometries=new D4,this._geometriesSource=null,this._handles=new li}initialize(){this._handles.add(Vs(()=>this.geometries,"after-changes",()=>this.geometries=this.geometries,Rr))}destroy(){this._handles.destroy()}readGeometries(t,e,r){Array.isArray(t)?this.geometries=D4.fromJSON(t,r):this._geometriesSource={url:A0(t,r),context:r}}async loadGeometries(t,e){if(this._geometriesSource==null)return;const{url:r,context:i}=this._geometriesSource,s=await Lt(r,{responseType:"json",signal:e?.signal}),n=t.toJSON(),o=s.data.map(a=>({...a,spatialReference:n}));this.geometries=D4.fromJSON(o,i),this._geometriesSource=null}clone(){const t=new SZ({geometries:re(this.geometries),spatialRelationship:this.spatialRelationship});return t._geometriesSource=this._geometriesSource,t}};u([d({type:["disjoint","contains"],nonNullable:!0,json:{write:!0}})],_E.prototype,"spatialRelationship",void 0),u([d({type:D4,nonNullable:!0,json:{write:!0}}),Wnt({origins:["web-scene","portal-item"],type:"resource",prefix:"geometries"})],_E.prototype,"geometries",void 0),u([Ae(["web-scene","portal-item"],"geometries")],_E.prototype,"readGeometries",null),_E=SZ=u([R("esri.layers.support.SceneFilter")],_E);const tot=_E;function qd(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[4],t[4]=e[5],t[5]=e[6],t[6]=e[8],t[7]=e[9],t[8]=e[10],t}function rot(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t}function lte(t,e,r,i,s,n,o,a,l,c){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t[4]=n,t[5]=o,t[6]=a,t[7]=l,t[8]=c,t}function cte(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function Wd(t,e){if(t===e){const r=e[1],i=e[2],s=e[5];t[1]=e[3],t[2]=e[6],t[3]=r,t[5]=e[7],t[6]=i,t[7]=s}else t[0]=e[0],t[1]=e[3],t[2]=e[6],t[3]=e[1],t[4]=e[4],t[5]=e[7],t[6]=e[2],t[7]=e[5],t[8]=e[8];return t}function gS(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l;let g=r*p+i*f+s*m;return g?(g=1/g,t[0]=p*g,t[1]=(-h*i+s*c)*g,t[2]=(a*i-s*o)*g,t[3]=f*g,t[4]=(h*r-s*l)*g,t[5]=(-a*r+s*n)*g,t[6]=m*g,t[7]=(-c*r+i*l)*g,t[8]=(o*r-i*n)*g,t):null}function iot(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8];return t[0]=o*h-a*c,t[1]=s*c-i*h,t[2]=i*a-s*o,t[3]=a*l-n*h,t[4]=r*h-s*l,t[5]=s*n-r*a,t[6]=n*c-o*l,t[7]=i*l-r*c,t[8]=r*o-i*n,t}function sot(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8];return e*(c*n-o*l)+r*(-c*s+o*a)+i*(l*s-n*a)}function wA(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1],g=r[2],_=r[3],v=r[4],b=r[5],x=r[6],T=r[7],S=r[8];return t[0]=f*i+m*o+g*c,t[1]=f*s+m*a+g*h,t[2]=f*n+m*l+g*p,t[3]=_*i+v*o+b*c,t[4]=_*s+v*a+b*h,t[5]=_*n+v*l+b*p,t[6]=x*i+T*o+S*c,t[7]=x*s+T*a+S*h,t[8]=x*n+T*l+S*p,t}function sU(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=r[0],m=r[1];return t[0]=i,t[1]=s,t[2]=n,t[3]=o,t[4]=a,t[5]=l,t[6]=f*i+m*o+c,t[7]=f*s+m*a+h,t[8]=f*n+m*l+p,t}function ute(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=e[4],l=e[5],c=e[6],h=e[7],p=e[8],f=Math.sin(r),m=Math.cos(r);return t[0]=m*i+f*o,t[1]=m*s+f*a,t[2]=m*n+f*l,t[3]=m*o-f*i,t[4]=m*a-f*s,t[5]=m*l-f*n,t[6]=c,t[7]=h,t[8]=p,t}function hte(t,e,r){const i=r[0],s=r[1],n=r[2];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t[6]=n*e[6],t[7]=n*e[7],t[8]=n*e[8],t}function not(t,e,r){const i=r[0],s=r[1];return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=s*e[3],t[4]=s*e[4],t[5]=s*e[5],t}function oot(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=1,t[5]=0,t[6]=e[0],t[7]=e[1],t[8]=1,t}function aot(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=0,t[3]=-r,t[4]=i,t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function lot(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=0,t[4]=e[1],t[5]=0,t[6]=0,t[7]=0,t[8]=1,t}function cot(t,e){return t[0]=e[0],t[1]=e[1],t[2]=0,t[3]=e[2],t[4]=e[3],t[5]=0,t[6]=e[4],t[7]=e[5],t[8]=1,t}function qV(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r+r,a=i+i,l=s+s,c=r*o,h=i*o,p=i*a,f=s*o,m=s*a,g=s*l,_=n*o,v=n*a,b=n*l;return t[0]=1-p-g,t[3]=h-b,t[6]=f+v,t[1]=h+b,t[4]=1-c-g,t[7]=m-_,t[2]=f-v,t[5]=m+_,t[8]=1-c-p,t}function oOe(t,e){const r=e[0],i=e[1],s=e[2],n=e[4],o=e[5],a=e[6],l=e[8],c=e[9],h=e[10],p=h*o-a*c,f=-h*n+a*l,m=c*n-o*l,g=r*p+i*f+s*m;if(!g)return null;const _=1/g;return t[0]=p*_,t[1]=(-h*i+s*c)*_,t[2]=(a*i-s*o)*_,t[3]=f*_,t[4]=(h*r-s*l)*_,t[5]=(-a*r+s*n)*_,t[6]=m*_,t[7]=(-c*r+i*l)*_,t[8]=(o*r-i*n)*_,t}function Z1(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=e[4],a=e[5],l=e[6],c=e[7],h=e[8],p=e[9],f=e[10],m=e[11],g=e[12],_=e[13],v=e[14],b=e[15],x=r*a-i*o,T=r*l-s*o,S=r*c-n*o,O=i*l-s*a,A=i*c-n*a,M=s*c-n*l,P=h*_-p*g,F=h*v-f*g,$=h*b-m*g,N=p*v-f*_,U=p*b-m*_,X=f*b-m*v;let Z=x*X-T*U+S*N+O*$-A*F+M*P;return Z?(Z=1/Z,t[0]=(a*X-l*U+c*N)*Z,t[1]=(l*$-o*X-c*F)*Z,t[2]=(o*U-a*$+c*P)*Z,t[3]=(s*U-i*X-n*N)*Z,t[4]=(r*X-s*$+n*F)*Z,t[5]=(i*$-r*U-n*P)*Z,t[6]=(_*M-v*A+b*O)*Z,t[7]=(v*S-g*M-b*T)*Z,t[8]=(g*A-_*S+b*x)*Z,t):null}function uot(t,e,r){return t[0]=2/e,t[1]=0,t[2]=0,t[3]=0,t[4]=-2/r,t[5]=0,t[6]=-1,t[7]=1,t[8]=1,t}function hot(t){return"mat3("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+", "+t[4]+", "+t[5]+", "+t[6]+", "+t[7]+", "+t[8]+")"}function dot(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2+t[4]**2+t[5]**2+t[6]**2+t[7]**2+t[8]**2)}function pot(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t[4]=e[4]+r[4],t[5]=e[5]+r[5],t[6]=e[6]+r[6],t[7]=e[7]+r[7],t[8]=e[8]+r[8],t}function aOe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t[4]=e[4]-r[4],t[5]=e[5]-r[5],t[6]=e[6]-r[6],t[7]=e[7]-r[7],t[8]=e[8]-r[8],t}function fot(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t[4]=e[4]*r,t[5]=e[5]*r,t[6]=e[6]*r,t[7]=e[7]*r,t[8]=e[8]*r,t}function mot(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t[4]=e[4]+r[4]*i,t[5]=e[5]+r[5]*i,t[6]=e[6]+r[6]*i,t[7]=e[7]+r[7]*i,t[8]=e[8]+r[8]*i,t}function got(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]&&t[4]===e[4]&&t[5]===e[5]&&t[6]===e[6]&&t[7]===e[7]&&t[8]===e[8]}function yot(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8],p=e[0],f=e[1],m=e[2],g=e[3],_=e[4],v=e[5],b=e[6],x=e[7],T=e[8],S=sl();return Math.abs(r-p)<=S*Math.max(1,Math.abs(r),Math.abs(p))&&Math.abs(i-f)<=S*Math.max(1,Math.abs(i),Math.abs(f))&&Math.abs(s-m)<=S*Math.max(1,Math.abs(s),Math.abs(m))&&Math.abs(n-g)<=S*Math.max(1,Math.abs(n),Math.abs(g))&&Math.abs(o-_)<=S*Math.max(1,Math.abs(o),Math.abs(_))&&Math.abs(a-v)<=S*Math.max(1,Math.abs(a),Math.abs(v))&&Math.abs(l-b)<=S*Math.max(1,Math.abs(l),Math.abs(b))&&Math.abs(c-x)<=S*Math.max(1,Math.abs(c),Math.abs(x))&&Math.abs(h-T)<=S*Math.max(1,Math.abs(h),Math.abs(T))}function dte(t){const e=sl(),r=t[0],i=t[1],s=t[2],n=t[3],o=t[4],a=t[5],l=t[6],c=t[7],h=t[8];return Math.abs(1-(r*r+n*n+l*l))<=e&&Math.abs(1-(i*i+o*o+c*c))<=e&&Math.abs(1-(s*s+a*a+h*h))<=e}const _ot=wA,vot=aOe;Object.freeze(Object.defineProperty({__proto__:null,add:pot,adjoint:iot,copy:rot,determinant:sot,equals:yot,exactEquals:got,frob:dot,fromMat2d:cot,fromMat4:qd,fromQuat:qV,fromRotation:aot,fromScaling:lot,fromTranslation:oot,identity:cte,invert:gS,isOrthoNormal:dte,mul:_ot,multiply:wA,multiplyScalar:fot,multiplyScalarAndAdd:mot,normalFromMat4:Z1,normalFromMat4Legacy:oOe,projection:uot,rotate:ute,scale:hte,scaleByVec2:not,set:lte,str:hot,sub:vot,subtract:aOe,translate:sU,transpose:Wd},Symbol.toStringTag,{value:"Module"}));function ts(){return[1,0,0,0,1,0,0,0,1]}function lOe(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8]]}function bot(t,e,r,i,s,n,o,a,l){return[t,e,r,i,s,n,o,a,l]}function cOe(t,e){return new Float64Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:lOe,create:ts,createView:cOe,fromValues:bot},Symbol.toStringTag,{value:"Module"}));function xe(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function xA(t){return[t[0],t[1],t[2],t[3],t[4],t[5],t[6],t[7],t[8],t[9],t[10],t[11],t[12],t[13],t[14],t[15]]}function pte(t,e,r,i,s,n,o,a,l,c,h,p,f,m,g,_){return[t,e,r,i,s,n,o,a,l,c,h,p,f,m,g,_]}function uOe(t,e){return new Float64Array(t,e,16)}const Un=xe();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Un,clone:xA,create:xe,createView:uOe,fromValues:pte},Symbol.toStringTag,{value:"Module"}));function Kd(){return[0,0,0,1]}function wot(t){return[t[0],t[1],t[2],t[3]]}function xot(t,e,r,i){return[t,e,r,i]}function hOe(t,e){return new Float64Array(t,e,4)}const Tot=Kd();Object.freeze(Object.defineProperty({__proto__:null,IDENTITY:Tot,clone:wot,create:Kd,createView:hOe,fromValues:xot},Symbol.toStringTag,{value:"Module"}));function Sot(t){return t[0]=0,t[1]=0,t[2]=0,t[3]=1,t}function nU(t,e,r){r*=.5;const i=Math.sin(r);return t[0]=i*e[0],t[1]=i*e[1],t[2]=i*e[2],t[3]=Math.cos(r),t}function fte(t,e){const r=2*Math.acos(e[3]),i=Math.sin(r/2);return i>sl()?(t[0]=e[0]/i,t[1]=e[1]/i,t[2]=e[2]/i):(t[0]=1,t[1]=0,t[2]=0),r}function WV(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*h+o*a+s*c-n*l,t[1]=s*h+o*l+n*a-i*c,t[2]=n*h+o*c+i*l-s*a,t[3]=o*h-i*a-s*l-n*c,t}function Eot(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+o*a,t[1]=s*l+n*a,t[2]=n*l-s*a,t[3]=o*l-i*a,t}function Cot(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l-n*a,t[1]=s*l+o*a,t[2]=n*l+i*a,t[3]=o*l-s*a,t}function Aot(t,e,r){r*=.5;const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+s*a,t[1]=s*l-i*a,t[2]=n*l+o*a,t[3]=o*l-n*a,t}function Oot(t,e){const r=e[0],i=e[1],s=e[2];return t[0]=r,t[1]=i,t[2]=s,t[3]=Math.sqrt(Math.abs(1-r*r-i*i-s*s)),t}function N4(t,e,r,i){const s=e[0],n=e[1],o=e[2],a=e[3];let l,c,h,p,f,m=r[0],g=r[1],_=r[2],v=r[3];return c=s*m+n*g+o*_+a*v,c<0&&(c=-c,m=-m,g=-g,_=-_,v=-v),1-c>sl()?(l=Math.acos(c),h=Math.sin(l),p=Math.sin((1-i)*l)/h,f=Math.sin(i*l)/h):(p=1-i,f=i),t[0]=p*s+f*m,t[1]=p*n+f*g,t[2]=p*o+f*_,t[3]=p*a+f*v,t}function Rot(t){const e=XP,r=e(),i=e(),s=e(),n=Math.sqrt(1-r),o=Math.sqrt(r);return t[0]=n*Math.sin(2*Math.PI*i),t[1]=n*Math.cos(2*Math.PI*i),t[2]=o*Math.sin(2*Math.PI*s),t[3]=o*Math.cos(2*Math.PI*s),t}function Mot(t,e){const r=e[0],i=e[1],s=e[2],n=e[3],o=r*r+i*i+s*s+n*n,a=o?1/o:0;return t[0]=-r*a,t[1]=-i*a,t[2]=-s*a,t[3]=n*a,t}function Tg(t,e){return t[0]=-e[0],t[1]=-e[1],t[2]=-e[2],t[3]=e[3],t}function dOe(t,e){const r=e[0]+e[4]+e[8];let i;if(r>0)i=Math.sqrt(r+1),t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i;else{let s=0;e[4]>e[0]&&(s=1),e[8]>e[3*s+s]&&(s=2);const n=(s+1)%3,o=(s+2)%3;i=Math.sqrt(e[3*s+s]-e[3*n+n]-e[3*o+o]+1),t[s]=.5*i,i=.5/i,t[3]=(e[3*n+o]-e[3*o+n])*i,t[n]=(e[3*n+s]+e[3*s+n])*i,t[o]=(e[3*o+s]+e[3*s+o])*i}return t}function Iot(t,e,r,i){const s=.5*Math.PI/180;e*=s,r*=s,i*=s;const n=Math.sin(e),o=Math.cos(e),a=Math.sin(r),l=Math.cos(r),c=Math.sin(i),h=Math.cos(i);return t[0]=n*l*h-o*a*c,t[1]=o*a*h+n*l*c,t[2]=o*l*c-n*a*h,t[3]=o*l*h+n*a*c,t}function Pot(t){return"quat("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}const w$=Id,$ot=zi,Lot=PQ,Dot=WV,Not=AT,Fot=sbe,kot=k6,pOe=$Q,Uot=pOe,fOe=LQ,Vot=fOe,mte=ibe,zot=wC,Bot=sk;function Got(t,e,r){const i=de(e,r);return i<-.999999?(st(Jf,jot,e),ou(Jf)<1e-6&&st(Jf,Hot,e),_e(Jf,Jf),nU(t,Jf,Math.PI),t):i>.999999?(t[0]=0,t[1]=0,t[2]=0,t[3]=1,t):(st(Jf,e,r),t[0]=Jf[0],t[1]=Jf[1],t[2]=Jf[2],t[3]=1+i,mte(t,t))}const Jf=C(),jot=Ee(1,0,0),Hot=Ee(0,1,0);function qot(t,e,r,i,s,n){return N4(Pce,e,s,n),N4($ce,r,i,n),N4(t,Pce,$ce,2*n*(1-n)),t}const Pce=Kd(),$ce=Kd();function Wot(t,e,r,i){const s=Zot;return s[0]=r[0],s[3]=r[1],s[6]=r[2],s[1]=i[0],s[4]=i[1],s[7]=i[2],s[2]=-e[0],s[5]=-e[1],s[8]=-e[2],mte(t,dOe(t,s))}const Zot=ts();Object.freeze(Object.defineProperty({__proto__:null,add:Lot,calculateW:Oot,conjugate:Tg,copy:w$,dot:Fot,equals:Bot,exactEquals:zot,fromEuler:Iot,fromMat3:dOe,getAxisAngle:fte,identity:Sot,invert:Mot,len:Uot,length:pOe,lerp:kot,mul:Dot,multiply:WV,normalize:mte,random:Rot,rotateX:Eot,rotateY:Cot,rotateZ:Aot,rotationTo:Got,scale:Not,set:$ot,setAxes:Wot,setAxisAngle:nU,slerp:N4,sqlerp:qot,sqrLen:Vot,squaredLength:fOe,str:Pot},Symbol.toStringTag,{value:"Module"}));function mOe(){const t=new Float32Array(4);return t[3]=1,t}function gOe(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Xot(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function yOe(t,e){return new Float32Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:gOe,create:mOe,createView:yOe,fromValues:Xot},Symbol.toStringTag,{value:"Module"}));const Yot=new qe(T1e),Lce=new qe(_Q),Dce=new qe(vQ),HVt=new qe(S1e);function Sg(t){return t&&(Pg(t)||Bn(t,Lce))?Lce:t&&($g(t)||Bn(t,Dce))?Dce:Yot}const Qs=!0,jx={identifierOffset:0,identifierLength:10,versionOffset:10,checksumOffset:12,byteCount:16};function gte(t,e,r){return{identifier:String.fromCharCode.apply(null,new Uint8Array(t,r+jx.identifierOffset,jx.identifierLength)),version:e.getUint16(r+jx.versionOffset,Qs),checksum:e.getUint32(r+jx.checksumOffset,Qs)}}const Yc={sizeLo:0,sizeHi:4,minX:8,minY:16,minZ:24,maxX:32,maxY:40,maxZ:48,errorX:56,errorY:64,errorZ:72,count:80,reserved:84,byteCount:88};function Jot(t,e){return{sizeLo:t.getUint32(e+Yc.sizeLo,Qs),sizeHi:t.getUint32(e+Yc.sizeHi,Qs),minX:t.getFloat64(e+Yc.minX,Qs),minY:t.getFloat64(e+Yc.minY,Qs),minZ:t.getFloat64(e+Yc.minZ,Qs),maxX:t.getFloat64(e+Yc.maxX,Qs),maxY:t.getFloat64(e+Yc.maxY,Qs),maxZ:t.getFloat64(e+Yc.maxZ,Qs),errorX:t.getFloat64(e+Yc.errorX,Qs),errorY:t.getFloat64(e+Yc.errorY,Qs),errorZ:t.getFloat64(e+Yc.errorZ,Qs),count:t.getUint32(e+Yc.count,Qs),reserved:t.getUint32(e+Yc.reserved,Qs)}}function qVt(t){const e=new DataView(t,0);let r=0;const{identifier:i,version:s}=gte(t,e,r);if(r+=jx.byteCount,i!=="LEPCC     ")throw new D("lepcc-decode-error","Bad identifier");if(s>1)throw new D("lepcc-decode-error","Unknown version");const n=Jot(e,r);if(r+=Yc.byteCount,n.sizeHi*2**32+n.sizeLo!==t.byteLength)throw new D("lepcc-decode-error","Bad size");const o=new Float64Array(3*n.count),a=[],l=[],c=[],h=[];if(r=sD(t,r,a),r=sD(t,r,l),r=sD(t,r,c),r=sD(t,r,h),r!==t.byteLength)throw new D("lepcc-decode-error","Bad length");let p=0,f=0;for(let m=0;m<a.length;m++){f+=a[m];let g=0;for(let _=0;_<l[m];_++){g+=c[p];const v=h[p];o[3*p]=Math.min(n.maxX,n.minX+2*n.errorX*g),o[3*p+1]=Math.min(n.maxY,n.minY+2*n.errorY*f),o[3*p+2]=Math.min(n.maxZ,n.minZ+2*n.errorZ*v),p++}}return{errorX:n.errorX,errorY:n.errorY,errorZ:n.errorZ,result:o}}function sD(t,e,r){const i=[];e=EZ(t,e,i);const s=[];for(let n=0;n<i.length;n++){s.length=0,e=EZ(t,e,s);for(let o=0;o<s.length;o++)r.push(s[o]+i[n])}return e}function EZ(t,e,r){const i=new DataView(t,e),s=i.getUint8(0),n=31&s,o=!!(32&s),a=(192&s)>>6;let l=0;if(a===0)l=i.getUint32(1,Qs),e+=5;else if(a===1)l=i.getUint16(1,Qs),e+=3;else{if(a!==2)throw new D("lepcc-decode-error","Bad count type");l=i.getUint8(1),e+=2}if(o)throw new D("lepcc-decode-error","LUT not implemented");const c=Math.ceil(l*n/8),h=new Uint8Array(t,e,c);let p=0,f=0,m=0;const g=-1>>>32-n;for(let _=0;_<l;_++){for(;f<n;)p|=h[m]<<f,f+=8,m+=1;r[_]=p&g,p>>>=n,f-=n,f+n>32&&(p|=h[m-1]>>8-f)}return e+m}const Zw={sizeLo:0,sizeHi:4,count:8,colorMapCount:12,lookupMethod:14,compressionMethod:15,byteCount:16};function Qot(t,e){return{sizeLo:t.getUint32(e+Zw.sizeLo,Qs),sizeHi:t.getUint32(e+Zw.sizeHi,Qs),count:t.getUint32(e+Zw.count,Qs),colorMapCount:t.getUint16(e+Zw.colorMapCount,Qs),lookupMethod:t.getUint8(e+Zw.lookupMethod),compressionMethod:t.getUint8(e+Zw.compressionMethod)}}function Kot(t){const e=new DataView(t,0);let r=0;const{identifier:i,version:s}=gte(t,e,r);if(r+=jx.byteCount,i!=="ClusterRGB")throw new D("lepcc-decode-error","Bad identifier");if(s>1)throw new D("lepcc-decode-error","Unknown version");const n=Qot(e,r);if(r+=Zw.byteCount,n.sizeHi*2**32+n.sizeLo!==t.byteLength)throw new D("lepcc-decode-error","Bad size");if((n.lookupMethod===2||n.lookupMethod===1)&&n.compressionMethod===0){if(3*n.colorMapCount+n.count+r!==t.byteLength||n.colorMapCount>256)throw new D("lepcc-decode-error","Bad count");const o=new Uint8Array(t,r,3*n.colorMapCount),a=new Uint8Array(t,r+3*n.colorMapCount,n.count),l=new Uint8Array(3*n.count);for(let c=0;c<n.count;c++){const h=a[c];l[3*c]=o[3*h],l[3*c+1]=o[3*h+1],l[3*c+2]=o[3*h+2]}return l}if(n.lookupMethod===0&&n.compressionMethod===0){if(3*n.count+r!==t.byteLength||n.colorMapCount!==0)throw new D("lepcc-decode-error","Bad count");return new Uint8Array(t,r).slice()}if(n.lookupMethod<=2&&n.compressionMethod===1){if(r+3!==t.byteLength||n.colorMapCount!==1)throw new D("lepcc-decode-error","Bad count");const o=e.getUint8(r),a=e.getUint8(r+1),l=e.getUint8(r+2),c=new Uint8Array(3*n.count);for(let h=0;h<n.count;h++)c[3*h]=o,c[3*h+1]=a,c[3*h+2]=l;return c}throw new D("lepcc-decode-error","Bad method "+n.lookupMethod+","+n.compressionMethod)}const Xw={sizeLo:0,sizeHi:4,count:8,scaleFactor:12,bitsPerPoint:14,reserved:15,byteCount:16};function eat(t,e){return{sizeLo:t.getUint32(e+Xw.sizeLo,Qs),sizeHi:t.getUint32(e+Xw.sizeHi,Qs),count:t.getUint32(e+Xw.count,Qs),scaleFactor:t.getUint16(e+Xw.scaleFactor,Qs),bitsPerPoint:t.getUint8(e+Xw.bitsPerPoint),reserved:t.getUint8(e+Xw.reserved)}}function tat(t){const e=new DataView(t,0);let r=0;const{identifier:i,version:s}=gte(t,e,r);if(r+=jx.byteCount,i!=="Intensity ")throw new D("lepcc-decode-error","Bad identifier");if(s>1)throw new D("lepcc-decode-error","Unknown version");const n=eat(e,r);if(r+=Xw.byteCount,n.sizeHi*2**32+n.sizeLo!==t.byteLength)throw new D("lepcc-decode-error","Bad size");const o=new Uint16Array(n.count);if(n.bitsPerPoint===8){if(n.count+r!==t.byteLength)throw new D("lepcc-decode-error","Bad size");const a=new Uint8Array(t,r,n.count);for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}else if(n.bitsPerPoint===16){if(2*n.count+r!==t.byteLength)throw new D("lepcc-decode-error","Bad size");const a=new Uint16Array(t,r,n.count);for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}else{const a=[];if(EZ(t,r,a)!==t.byteLength)throw new D("lepcc-decode-error","Bad size");for(let l=0;l<n.count;l++)o[l]=a[l]*n.scaleFactor}return o}var E;(function(t){t.POSITION="position",t.NORMAL="normal",t.NORMALCOMPRESSED="normalCompressed",t.UV0="uv0",t.AUXPOS1="auxpos1",t.AUXPOS2="auxpos2",t.COLOR="color",t.SYMBOLCOLOR="symbolColor",t.SIZE="size",t.TANGENT="tangent",t.OFFSET="offset",t.SUBDIVISIONFACTOR="subdivisionFactor",t.COLORFEATUREATTRIBUTE="colorFeatureAttribute",t.SIZEFEATUREATTRIBUTE="sizeFeatureAttribute",t.OPACITYFEATUREATTRIBUTE="opacityFeatureAttribute",t.DISTANCETOSTART="distanceToStart",t.UVMAPSPACE="uvMapSpace",t.BOUNDINGRECT="boundingRect",t.UVREGION="uvRegion",t.PROFILERIGHT="profileRight",t.PROFILEUP="profileUp",t.PROFILEVERTEXANDNORMAL="profileVertexAndNormal",t.FEATUREVALUE="featureValue",t.MODELORIGINHI="modelOriginHi",t.MODELORIGINLO="modelOriginLo",t.MODEL="model",t.MODELNORMAL="modelNormal",t.INSTANCECOLOR="instanceColor",t.INSTANCEFEATUREATTRIBUTE="instanceFeatureAttribute",t.LOCALTRANSFORM="localTransform",t.GLOBALTRANSFORM="globalTransform",t.BOUNDINGSPHERE="boundingSphere",t.MODELORIGIN="modelOrigin",t.MODELSCALEFACTORS="modelScaleFactors",t.FEATUREATTRIBUTE="featureAttribute",t.STATE="state",t.LODLEVEL="lodLevel",t.POSITION0="position0",t.POSITION1="position1",t.NORMALA="normalA",t.NORMALB="normalB",t.COMPONENTINDEX="componentIndex",t.VARIANTOFFSET="variantOffset",t.VARIANTSTROKE="variantStroke",t.VARIANTEXTENSION="variantExtension",t.U8PADDING="u8padding",t.U16PADDING="u16padding",t.SIDENESS="sideness",t.START="start",t.END="end",t.UP="up",t.EXTRUDE="extrude",t.OBJECTANDLAYERIDCOLOR="objectAndLayerIdColor",t.INSTANCEOBJECTANDLAYERIDCOLOR="instanceObjectAndLayerIdColor"})(E||(E={}));const CZ=K.getLogger("esri.views.3d.layers.i3s.I3SBinaryReader");function rat(t,e,r){let i="",s=0;for(;s<r;){const n=t[e+s];if(n<128)i+=String.fromCharCode(n),s++;else if(n>=192&&n<224){if(s+1>=r)throw new D("utf8-decode-error","UTF-8 Decode failed. Two byte character was truncated.");const o=(31&n)<<6|63&t[e+s+1];i+=String.fromCharCode(o),s+=2}else if(n>=224&&n<240){if(s+2>=r)throw new D("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(15&n)<<12|(63&t[e+s+1])<<6|63&t[e+s+2];i+=String.fromCharCode(o),s+=3}else{if(!(n>=240&&n<248))throw new D("utf8-decode-error","UTF-8 Decode failed. Invalid multi byte sequence.");{if(s+3>=r)throw new D("utf8-decode-error","UTF-8 Decode failed. Multi byte character was truncated.");const o=(7&n)<<18|(63&t[e+s+1])<<12|(63&t[e+s+2])<<6|63&t[e+s+3];if(o>=65536){const a=55296+(o-65536>>10),l=56320+(1023&o);i+=String.fromCharCode(a,l)}else i+=String.fromCharCode(o);s+=4}}}return i}function _Oe(t,e){const r={byteOffset:0,byteCount:0,fields:Object.create(null)};let i=0;for(let s=0;s<e.length;s++){const n=e[s],o=n.valueType||n.type,a=hat[o];r.fields[n.property]=a(t,i),i+=ZV[o].BYTES_PER_ELEMENT}return r.byteCount=i,r}function iat(t,e,r){return vOe(t,e,r).map(i=>{const s=i?Date.parse(i):null;return s&&!Number.isNaN(s)?s:null})}function vOe(t,e,r){const i=[];let s,n,o=0;for(n=0;n<t;n+=1){if(s=e[n],s>0){if(i.push(rat(r,o,s-1)),r[o+s-1]!==0)throw new D("string-array-error","Invalid string array: missing null termination.")}else i.push(null);o+=s}return i}function Nce(t,e){return new ZV[e.valueType](t,e.byteOffset,e.count*e.valuesPerElement)}function sat(t,e){return new Uint8Array(t,e.byteOffset,e.byteCount)}function nat(t,e,r){const i=e.header!=null?_Oe(t,e.header):{byteOffset:0,byteCount:0,fields:{count:r}},s={header:i,byteOffset:i.byteCount,byteCount:0,entries:Object.create(null)};let n=i.byteCount;for(let o=0;o<e.ordering.length;o++){const a=e.ordering[o],l=re(e[a]);if(l.count=i.fields.count??0,l.valueType==="String"){if(l.byteOffset=n,l.byteCount=i.fields[a+"ByteCount"],l.encoding!=="UTF-8")throw new D("unsupported-encoding","Unsupported String encoding.",{encoding:l.encoding});if(l.timeEncoding&&l.timeEncoding!=="ECMA_ISO8601")throw new D("unsupported-time-encoding","Unsupported time encoding.",{timeEncoding:l.timeEncoding})}else{if(!wOe(l.valueType))throw new D("unsupported-value-type","Unsupported binary valueType",{valueType:l.valueType});{const c=F4(l.valueType);n+=n%c!=0?c-n%c:0,l.byteOffset=n,l.byteCount=c*l.valuesPerElement*l.count}}n+=l.byteCount??0,s.entries[a]=l}return s.byteCount=n-s.byteOffset,s}function bOe(t,e,r){if(e!==t&&CZ.error(`Invalid ${r} buffer size
 expected: ${t}, actual: ${e})`),e<t)throw new D("buffer-too-small","Binary buffer is too small",{expectedSize:t,actualSize:e})}function oat(t){return{isDraco:!1,isLegacy:!1,color:t.color!=null,normal:t.normal!=null,uv0:t.uv0!=null,uvRegion:t.uvRegion!=null,featureIndex:t.faceRange!=null&&t.featureId!=null}}function WVt(t,e){const r=_Oe(t,e&&e.header);let i=r.byteCount;const s={isDraco:!1,header:r,byteOffset:r.byteCount,byteCount:0,vertexAttributes:{}},n=r.fields,o=n.vertexCount!=null?n.vertexCount:n.count;for(const c of e.ordering){if(!e.vertexAttributes[c])continue;const h={...e.vertexAttributes[c],byteOffset:i,count:o},p=cat[c]||"_"+c;s.vertexAttributes[p]=h,i+=F4(h.valueType)*h.valuesPerElement*o}const a=n.faceCount;if(e.faces&&a){s.faces={};for(const c of e.ordering){if(!e.faces[c])continue;const h={...e.faces[c],byteOffset:i,count:a};s.faces[c]=h,i+=F4(h.valueType)*h.valuesPerElement*a}}const l=n.featureCount;if(e.featureAttributes&&e.featureAttributeOrder&&l){s.featureAttributes={};for(const c of e.featureAttributeOrder){if(!e.featureAttributes[c])continue;const h={...e.featureAttributes[c],byteOffset:i,count:l};s.featureAttributes[c]=h,i+=(h.valueType==="UInt64"?8:F4(h.valueType))*h.valuesPerElement*l}}return bOe(i,t.byteLength,"geometry"),s.byteCount=i-s.byteOffset,s}function ZVt(t,e){return!t||!t.compressedAttributes||t.compressedAttributes.encoding!=="draco"?t?oat(t):aat(e):lat(t.compressedAttributes.attributes)}function aat(t){const e={isDraco:!1,isLegacy:!0,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of t.ordering)if(t.vertexAttributes[r])switch(r){case"position":break;case"normal":e.normal=!0;break;case"color":e.color=!0;break;case"uv0":e.uv0=!0;break;case"region":e.uvRegion=!0}return t.featureAttributes&&t.featureAttributeOrder&&(e.featureIndex=!0),e}function lat(t){const e={isDraco:!0,isLegacy:!1,color:!1,normal:!1,uv0:!1,uvRegion:!1,featureIndex:!1};for(const r of t)switch(r){case"position":break;case"normal":e.normal=!0;break;case"uv0":e.uv0=!0;break;case"color":e.color=!0;break;case"uv-region":e.uvRegion=!0;break;case"feature-index":e.featureIndex=!0}return e}const cat={position:E.POSITION,normal:E.NORMAL,color:E.COLOR,uv0:E.UV0,region:E.UVREGION};function uat(t,e,r){if(t.encoding==="lepcc-rgb")return Kot(e);if(t.encoding==="lepcc-intensity")return tat(e);if(t.encoding!=null&&t.encoding!=="")throw new D("unknown-attribute-storage-info-encoding","Unknown Attribute Storage Info Encoding");t["attributeByteCounts "]&&!t.attributeByteCounts&&(CZ.warn("Warning: Trailing space in 'attributeByteCounts '."),t.attributeByteCounts=t["attributeByteCounts "]),t.ordering[0]==="ObjectIds"&&t.hasOwnProperty("objectIds")&&(CZ.warn("Warning: Case error in objectIds"),t.ordering[0]="objectIds");const i=nat(e,t,r);bOe(i.byteOffset+i.byteCount,e.byteLength,"attribute");const s=i.entries.attributeValues||i.entries.objectIds;if(s){if(s.valueType==="String"){const n=i.entries.attributeByteCounts,o=Nce(e,n),a=sat(e,s);return s.timeEncoding?iat(n.count,o,a):vOe(n.count,o,a)}return Nce(e,s)}throw new D("bad-attribute-storage-info","Bad attributeStorageInfo specification.")}const ZV={Float32:Float32Array,Float64:Float64Array,UInt8:Uint8Array,Int8:Int8Array,UInt16:Uint16Array,Int16:Int16Array,UInt32:Uint32Array,Int32:Int32Array},hat={Float32:(t,e)=>new DataView(t,0).getFloat32(e,!0),Float64:(t,e)=>new DataView(t,0).getFloat64(e,!0),UInt8:(t,e)=>new DataView(t,0).getUint8(e),Int8:(t,e)=>new DataView(t,0).getInt8(e),UInt16:(t,e)=>new DataView(t,0).getUint16(e,!0),Int16:(t,e)=>new DataView(t,0).getInt16(e,!0),UInt32:(t,e)=>new DataView(t,0).getUint32(e,!0),Int32:(t,e)=>new DataView(t,0).getInt32(e,!0)};function wOe(t){return ZV.hasOwnProperty(t)}function F4(t){return wOe(t)?ZV[t].BYTES_PER_ELEMENT:0}function dat(t,e,r,i){const s=pat(t,e,r),n=xe();return wc(r,s,n,i),n}const xOe=1,Fce=5-xOe;function pat(t,e,r){const i=C(),s=t[3],n=2**(Math.ceil(Math.log(s)*Math.LOG2E/Fce)*Fce+xOe);if(r.isGeographic){const l=n/Ir(r).radius*180/Math.PI,c=Math.round(t[1]/l),h=Math.max(-90,Math.min(90,c*l)),p=l/Math.cos((Math.abs(h)-l/2)/180*Math.PI),f=Math.round(t[0]/p)*p;i[0]=f,i[1]=h}else{const l=Math.round(t[0]/n),c=Math.round(t[1]/n);i[0]=l*n,i[1]=c*n}const o=t[2]+e,a=Math.round(o/n);return i[2]=a*n,i}function fat(t){return t.type==="fill"}function mat(t){return t.type==="extrude"}var Xt;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.TRANSPARENT=1]="TRANSPARENT",t[t.OPAQUE=2]="OPAQUE"})(Xt||(Xt={}));function gat(t){return t&&t.enabled&&(mat(t)||fat(t))&&t.edges!=null}function yat(t){return t&&t.enabled&&t.edges||null}function TOe(t,e){return SOe(yat(t),e)}function SOe(t,e){if(t==null)return null;const r=t.color!=null?jK(Le.toUnitRGBA(t.color)):Vt(0,0,0,0),i=vi(t.size),s=vi(t.extensionLength);switch(t.type){case"solid":return EOe({color:r,size:i,extensionLength:s,...e});case"sketch":return _at({color:r,size:i,extensionLength:s,...e});default:return}}function EOe(t){return{...vat,...t,type:"solid"}}function _at(t){return{...bat,...t,type:"sketch"}}const vat={color:Vt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Xt.OPAQUE,hasSlicePlane:!1},bat={color:Vt(0,0,0,.2),size:1,extensionLength:0,opacity:1,objectTransparency:Xt.OPAQUE,hasSlicePlane:!1};var pn;function COe(t){switch(t){case"multiply":default:return pn.Multiply;case"ignore":return pn.Ignore;case"replace":return pn.Replace;case"tint":return pn.Tint}}function AOe(t,e,r){if(t==null||e===pn.Ignore)return r[0]=255,r[1]=255,r[2]=255,void(r[3]=255);const i=ye(Math.round(t[3]*oU),0,oU),s=i===0||e===pn.Tint?0:e===pn.Replace?wat:xat;r[0]=ye(Math.round(t[0]*PS),0,PS),r[1]=ye(Math.round(t[1]*PS),0,PS),r[2]=ye(Math.round(t[2]*PS),0,PS),r[3]=i+s}(function(t){t[t.Multiply=1]="Multiply",t[t.Ignore=2]="Ignore",t[t.Replace=3]="Replace",t[t.Tint=4]="Tint"})(pn||(pn={}));const PS=255,oU=85,wat=oU,xat=2*oU;function gs(){return new Float32Array(3)}function aU(t){const e=new Float32Array(3);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e}function si(t,e,r){const i=new Float32Array(3);return i[0]=t,i[1]=e,i[2]=r,i}function OOe(t,e){return new Float32Array(t,e,3)}function yte(){return gs()}function ROe(){return si(1,1,1)}function MOe(){return si(1,0,0)}function IOe(){return si(0,1,0)}function POe(){return si(0,0,1)}const Tat=yte(),Sat=ROe(),Eat=MOe(),Cat=IOe(),Aat=POe();Object.freeze(Object.defineProperty({__proto__:null,ONES:Sat,UNIT_X:Eat,UNIT_Y:Cat,UNIT_Z:Aat,ZEROS:Tat,clone:aU,create:gs,createView:OOe,fromValues:si,ones:ROe,unitX:MOe,unitY:IOe,unitZ:POe,zeros:yte},Symbol.toStringTag,{value:"Module"}));var vu;(function(t){t[t.X=0]="X",t[t.Y=1]="Y",t[t.Z=2]="Z"})(vu||(vu={}));let z0=class{constructor(e){this._allocator=e,this._items=[],this._itemsPtr=0,this._grow()}get(){return this._itemsPtr===0&&JC(()=>this._reset()),this._itemsPtr===this._items.length&&this._grow(),this._items[this._itemsPtr++]}_reset(){const e=Math.min(3*Math.max(8,this._itemsPtr),this._itemsPtr+3*kce);this._items.length=Math.min(e,this._items.length),this._itemsPtr=0}_grow(){for(let e=0;e<Math.max(8,Math.min(this._items.length,kce));e++)this._items.push(this._allocator())}};const kce=1024;let bO=class Yw{constructor(e,r,i){this._itemByteSize=e,this._itemCreate=r,this._buffers=new Array,this._items=new Array,this._itemsPtr=0,this._itemsPerBuffer=Math.ceil(i/this._itemByteSize)}get(){this._itemsPtr===0&&JC(()=>this._reset());const e=Math.floor(this._itemsPtr/this._itemsPerBuffer);for(;this._buffers.length<=e;){const r=new ArrayBuffer(this._itemsPerBuffer*this._itemByteSize);for(let i=0;i<this._itemsPerBuffer;++i)this._items.push(this._itemCreate(r,i*this._itemByteSize));this._buffers.push(r)}return this._items[this._itemsPtr++]}_reset(){const e=2*(Math.floor(this._itemsPtr/this._itemsPerBuffer)+1);for(;this._buffers.length>e;)this._buffers.pop(),this._items.length=this._buffers.length*this._itemsPerBuffer;this._itemsPtr=0}static createVec2f64(e=$S){return new Yw(16,kCe,e)}static createVec3f64(e=$S){return new Yw(24,AQ,e)}static createVec4f64(e=$S){return new Yw(32,eSe,e)}static createMat3f64(e=$S){return new Yw(72,cOe,e)}static createMat4f64(e=$S){return new Yw(128,uOe,e)}static createQuatf64(e=$S){return new Yw(32,hOe,e)}get test(){return{size:this._buffers.length*this._itemsPerBuffer*this._itemByteSize}}};const $S=4*sA.KILOBYTES,YVt=bO.createVec2f64(),ke=bO.createVec3f64(),_te=bO.createVec4f64();bO.createMat3f64();const vte=bO.createMat4f64(),JVt=bO.createQuatf64();function Io(t){return t?Uce($i(t.origin),$i(t.direction)):Uce(C(),C())}function Uce(t,e){return{origin:t,direction:e}}function QVt(t,e){return T0(t.origin,e.origin)&&T0(t.direction,e.direction)}function Eh(t,e){const r=Iat.get();return r.origin=t,r.direction=e,r}function lU(t,e=Io()){return $Oe(t.origin,t.direction,e)}function Oat(t,e,r=Io()){return oe(r.origin,t),pe(r.direction,e,t),r}function $Oe(t,e,r=Io()){return oe(r.origin,t),oe(r.direction,e),r}function Rat(t,e){const r=st(ke.get(),_e(ke.get(),t.direction),pe(ke.get(),e,t.origin));return de(r,r)}function Mat(t,e,r){const i=de(t.direction,pe(r,e,t.origin));return ue(r,t.origin,ae(r,t.direction,i)),r}const Iat=new z0(()=>Io());function KVt(t,e,r){const i=de(t,e)/de(t,t);return ae(r,t,i)}function O1(t,e){return de(t,e)/Oe(t)}function XV(t,e){const r=de(t,e)/(Oe(t)*Oe(e));return-oo(r)}function LOe(t,e,r){_e(nD,t),_e(Dz,e);const i=de(nD,Dz),s=oo(i),n=st(nD,nD,Dz);return de(n,r)<0?2*Math.PI-s:s}const nD=C(),Dz=C(),DOe=js();function js(){return Qt()}function TA(t,e=js()){return Id(e,t)}function NOe(t,e){return Vt(t[0],t[1],t[2],e)}function Pat(t){return t}function $at(t){t[0]=t[1]=t[2]=t[3]=0}function YV(t,e){return t[0]=t[1]=t[2]=0,t[3]=e,t}function p0(t){return t[3]}function Lat(t){return t}function FOe(t,e,r,i){return Vt(t,e,r,i)}function Dat(t,e,r){return t!==r&&oe(r,t),r[3]=t[3]+e,r}function Nat(t,e,r){return K.getLogger("esri.geometry.support.sphere").error("sphere.setExtent is not yet supported"),t===r?r:TA(t,r)}function db(t,e,r){if(e==null)return!1;const{origin:i,direction:s}=e,n=Fat;n[0]=i[0]-t[0],n[1]=i[1]-t[1],n[2]=i[2]-t[2];const o=s[0]*s[0]+s[1]*s[1]+s[2]*s[2];if(o===0)return!1;const a=2*(s[0]*n[0]+s[1]*n[1]+s[2]*n[2]),l=a*a-4*o*(n[0]*n[0]+n[1]*n[1]+n[2]*n[2]-t[3]*t[3]);if(l<0)return!1;const c=Math.sqrt(l);let h=(-a-c)/(2*o);const p=(-a+c)/(2*o);return(h<0||p<h&&p>0)&&(h=p),!(h<0)&&(r&&(r[0]=i[0]+s[0]*h,r[1]=i[1]+s[1]*h,r[2]=i[2]+s[2]*h),!0)}const Fat=C();function AZ(t,e){return db(t,e,null)}function kat(t,e,r){if(db(t,e,r))return r;const i=wO(t,e,ke.get());return ue(r,e.origin,ae(ke.get(),e.direction,_i(e.origin,i)/Oe(e.direction))),r}function wO(t,e,r){const i=ke.get(),s=vte.get();st(i,e.origin,e.direction);const n=p0(t);st(r,i,e.origin),ae(r,r,1/Oe(r)*n);const o=VOe(t,e.origin),a=XV(e.origin,r);return Th(s,a+o,i),Ne(r,r,s),r}function Uat(t,e,r){return db(t,e,r)?r:(Mat(e,t,r),kOe(t,r,r))}function kOe(t,e,r){const i=pe(ke.get(),e,t),s=ae(ke.get(),i,t[3]/Oe(i));return ue(r,s,t)}function UOe(t,e){const r=pe(ke.get(),e,t),i=Xa(r),s=t[3]*t[3];return Math.sqrt(Math.abs(i-s))}function VOe(t,e){const r=pe(ke.get(),e,t),i=Oe(r),s=p0(t),n=s+Math.abs(s-i);return oo(s/n)}const Nz=C();function zOe(t,e,r,i){const s=pe(Nz,e,t);switch(r){case vu.X:{const n=xne(s,Nz)[2];return ie(i,-Math.sin(n),Math.cos(n),0)}case vu.Y:{const n=xne(s,Nz),o=n[1],a=n[2],l=Math.sin(o);return ie(i,-l*Math.cos(a),-l*Math.sin(a),Math.cos(o))}case vu.Z:return _e(i,s);default:return}}function BOe(t,e){const r=pe(OZ,e,t);return Oe(r)-t[3]}function Vat(t,e,r,i){const s=BOe(t,e),n=zOe(t,e,vu.Z,OZ),o=ae(OZ,n,r-s);return ue(i,e,o)}function zat(t,e){const r=kn(t,e),i=p0(t);return r<=i*i}function Bat(t,e,r=js()){const i=_i(t,e),s=t[3],n=e[3];return i+n<s?(Id(r,t),r):i+s<n?(Id(r,e),r):(Wr(r,t,e,(i+n-s)/(2*i)),r[3]=(i+s+n)/2,r)}const OZ=C(),JV=js(),Gat=Object.freeze(Object.defineProperty({__proto__:null,NullSphere:DOe,altitudeAt:BOe,angleToSilhouette:VOe,axisAt:zOe,clear:$at,closestPoint:Uat,closestPointOnSilhouette:wO,containsPoint:zat,copy:TA,create:js,distanceToSilhouette:UOe,elevate:Dat,fromCenterAndRadius:NOe,fromRadius:YV,fromValues:FOe,getCenter:Lat,getRadius:p0,intersectRay:db,intersectRayClosestSilhouette:kat,intersectsRay:AZ,projectPoint:kOe,setAltitudeAt:Vat,setExtent:Nat,tmpSphere:JV,union:Bat,wrap:Pat},Symbol.toStringTag,{value:"Module"}));function SA(t){const e=t[0]*t[0]+t[4]*t[4]+t[8]*t[8],r=t[1]*t[1]+t[5]*t[5]+t[9]*t[9],i=t[2]*t[2]+t[6]*t[6]+t[10]*t[10];return Math.sqrt(Math.max(e,r,i))}function jat(t,e){const r=Math.sqrt(e[0]*e[0]+e[4]*e[4]+e[8]*e[8]),i=Math.sqrt(e[1]*e[1]+e[5]*e[5]+e[9]*e[9]),s=Math.sqrt(e[2]*e[2]+e[6]*e[6]+e[10]*e[10]);return ie(t,r,i,s),t}function e8t(t,e,r){r=r||t;const i=de(t,e);ie(r,t[0]-i*e[0],t[1]-i*e[1],t[2]-i*e[2]),_e(r,r)}function Hat(t,e,r){Math.abs(t[0])>Math.abs(t[1])?ie(e,0,1,0):ie(e,1,0,0),st(r,t,e),_e(e,e),st(e,r,t),_e(r,r)}function oD(t,e,r,i,s,n){const o=t+(e-t)*s;return o+(r+(i-r)*s-o)*n}function qat(t,e,r,i=C()){const s=Oe(t),n=Oe(e),o=de(t,e)/(s*n);if(o<.9999999999999999){const a=Math.acos(o),l=((1-r)*s+r*n)/Math.sin(a),c=l/s*Math.sin((1-r)*a),h=l/n*Math.sin(r*a);return ae(Hx,t,c),ae(qx,e,h),ue(i,Hx,qx)}return Wr(i,t,e,r)}function t8t(t,e,r,i=C(),s=C()){const n=Oe(t),o=Oe(e),a=de(t,e)/(n*o);if(a<.9999999999999999){const l=Math.acos(a),c=Math.sin(l),h=Math.sin(r*l),p=Math.sin((1-r)*l),f=(1-r)*n+r*o;{const m=f/c,g=m/o*h;ae(Hx,t,m/n*p),ae(qx,e,g),ue(i,Hx,qx)}{const m=1/n*(-Math.cos((1-r)*l)*l*f+p*(-n+o));ae(Hx,t,m);const g=1/o*(Math.cos(r*l)*l*f+h*(-n+o));ae(qx,e,g),ue(s,Hx,qx),ae(s,s,1/c)}return s}return Wr(i,t,e,r),pe(s,e,t),_e(s,s),s}function k4(t,e,r){t=_e(Hx,t),e=_e(qx,e);const i=oo(de(t,e));if(r){const s=st(Wat,t,e);if(de(s,r)<0)return-i}return i}function U4(t){const e=t.length;return r=>{if(r<=t[0][0])return t[0][1];if(r>=t[e-1][0])return t[e-1][1];let i=1;for(;r>t[i][0];)i++;const s=t[i-1][0],n=t[i][0],o=(n-r)/(n-s);return o*t[i-1][1]+(1-o)*t[i][1]}}function r8t(t,e,r,i){pe(Vce,e,t),pe(zce,r,t),st(i,Vce,zce),_e(i,i),i[3]=-de(t,i)}const Vce=C(),zce=C(),Wat=C(),Hx=C(),qx=C();function zr(t=X3){return[t[0],t[1],t[2],t[3]]}function Zat(t=X3[0],e=X3[1],r=X3[2],i=X3[3]){return bte(t,e,r,i,_te.get())}function QV(t,e){return bte(e[0],e[1],e[2],e[3],t)}function bte(t,e,r,i,s=zr()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function GOe(t,e,r){return oe(r,t),r[3]=e,r}function x$(t,e,r){const i=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],s=Math.abs(i-1)>1e-5&&i>1e-12?1/Math.sqrt(i):1;return r[0]=e[0]*s,r[1]=e[1]*s,r[2]=e[2]*s,r[3]=-(r[0]*t[0]+r[1]*t[1]+r[2]*t[2]),r}function Wa(t,e,r,i=zr()){const s=r[0]-e[0],n=r[1]-e[1],o=r[2]-e[2],a=t[0]-e[0],l=t[1]-e[1],c=t[2]-e[2],h=n*c-o*l,p=o*a-s*c,f=s*l-n*a,m=h*h+p*p+f*f,g=Math.abs(m-1)>1e-5&&m>1e-12?1/Math.sqrt(m):1;return i[0]=h*g,i[1]=p*g,i[2]=f*g,i[3]=-(i[0]*t[0]+i[1]*t[1]+i[2]*t[2]),i}function jOe(t,e,r,i,s){const n=t.length/3;if(n<3)return!1;ie(sR,t[3*r],t[3*r+1],t[3*r+2]);let o=i,a=!1;for(;o<n-1&&!a;){const l=3*o;ie(LS,t[l],t[l+1],t[l+2]),o++,a=!Jr(sR,LS)}if(!a)return!1;for(o=Math.max(o,s),a=!1;o<n&&!a;){const l=3*o;ie(Rx,t[l],t[l+1],t[l+2]),o++,pe(aD,sR,LS),_e(aD,aD),pe(lD,LS,Rx),_e(lD,lD),a=!Jr(sR,Rx)&&!Jr(LS,Rx)&&Math.abs(de(aD,lD))<Xat}return a?(Wa(sR,LS,Rx,e),!0):(r!==0||i!==1||s!==2)&&jOe(t,e,0,1,2)}const Xat=.99619469809,sR=C(),LS=C(),Rx=C(),aD=C(),lD=C();function RZ(t,e,r){return e!==t&&QV(t,e),t[3]=-de(t,r),t}function MZ(t,e){return e[0]=-t[0],e[1]=-t[1],e[2]=-t[2],e[3]=-t[3],e}function cP(t,e,r,i){return st(Rx,e,t),x$(r,Rx,i)}function i8t(t,e,r,i){return KV(t,e,pe(ke.get(),r,e),tlt,i)}function yS(t,e,r){return e!=null&&KV(t,e.origin,e.direction,rlt,r)}function Yat(t,e,r){return KV(t,e.origin,e.vector,og.NONE,r)}function Jat(t,e,r){return KV(t,e.origin,e.vector,og.CLAMP,r)}function HOe(t,e){return Oi(t,e)>=0}function Qat(t,e){const r=de(t,e.ray.direction),i=-Oi(t,e.ray.origin);if(i<0&&r>=0)return!1;if(r>-1e-6&&r<1e-6)return i>0;if((i<0||r<0)&&!(i<0&&r<0))return!0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function Kat(t,e){const r=de(t,e.ray.direction),i=-Oi(t,e.ray.origin);if(r>-1e-6&&r<1e-6)return i>0;const s=i/r;return r>0?s<e.c1&&(e.c1=s):s>e.c0&&(e.c0=s),e.c0<=e.c1}function elt(t,e,r){const i=ae(ke.get(),t,-t[3]),s=IZ(t,pe(ke.get(),e,i),ke.get());return ue(r,s,i),r}function s8t(t,e,r,i){const s=t,n=ke.get(),o=ke.get();Hat(s,n,o);const a=pe(ke.get(),r,e),l=O1(n,a),c=O1(o,a),h=O1(s,a);return ie(i,l,c,h)}function IZ(t,e,r){const i=ae(ke.get(),t,de(t,e));return pe(r,e,i),r}function Oi(t,e){return de(t,e)+t[3]}function KV(t,e,r,i,s){const n=de(t,r);if(n===0)return!1;let o=-(de(t,e)+t[3])/n;return i&og.CLAMP&&(o=ye(o,0,1)),!(!(i&og.INFINITE_MIN)&&o<0||!(i&og.INFINITE_MAX)&&o>1)&&(ue(s,e,ae(s,r,o)),!0)}function n8t(t){return t}const X3=[0,0,1,0];var og;(function(t){t[t.NONE=0]="NONE",t[t.CLAMP=1]="CLAMP",t[t.INFINITE_MIN=4]="INFINITE_MIN",t[t.INFINITE_MAX=8]="INFINITE_MAX"})(og||(og={}));const tlt=og.INFINITE_MIN|og.INFINITE_MAX,rlt=og.INFINITE_MAX;var Ue;function Bce(t){return t==="global"?Ue.Global:Ue.Local}function Fz(t){return t===Ue.Global?"global":"local"}(function(t){t[t.Global=1]="Global",t[t.Local=2]="Local"})(Ue||(Ue={}));let Ge=class{constructor(e,r,i=!1,s=r){this.data=e,this.size=r,this.exclusive=i,this.stride=s}};const EA=1e-6,nR=[0,0,0],cD=[0,0,0];function ilt(t,e){const{data:r,size:i}=t,s=r.length/i;if(s<=0)return;const n=new dlt(t);V4(nR,n.minProj,n.maxProj),Mx(nR,nR,.5),xd(cD,n.maxProj,n.minProj);const o=PZ(cD),a=new plt;a.quality=o,s<14&&(t=new Ge(new Float64Array(n.buffer,112,42),3));const l=[0,0,0],c=[0,0,0],h=[0,0,0],p=[0,0,0],f=[0,0,0],m=[0,0,0],g=[0,0,0];switch(slt(n,t,g,l,c,h,p,f,m,a)){case 1:return void qce(nR,cD,e);case 2:return void hlt(t,p,e)}nlt(t,g,l,c,h,p,f,m,a),qOe(t,a.b0,a.b1,a.b2,$C,LC);const _=[0,0,0];xd(_,LC,$C),a.quality=PZ(_),a.quality<o?WOe(a.b0,a.b1,a.b2,$C,LC,_,e):qce(nR,cD,e)}function slt(t,e,r,i,s,n,o,a,l,c){return olt(t,i,s),$Z(i,s)<EA?1:(xd(o,i,s),ba(o,o),alt(e,i,o,n)<EA?2:(xd(a,s,n),ba(a,a),xd(l,n,i),ba(l,l),Td(r,a,o),ba(r,r),Jw(e,r,o,a,l,c),0))}const oR=[0,0,0],aR=[0,0,0],$h=[0,0,0],Lh=[0,0,0],Dh=[0,0,0],g_=[0,0,0],y_=[0,0,0],__=[0,0,0];function nlt(t,e,r,i,s,n,o,a,l){llt(t,e,r,oR,aR),oR[0]!==void 0&&(xd($h,oR,r),ba($h,$h),xd(Lh,oR,i),ba(Lh,Lh),xd(Dh,oR,s),ba(Dh,Dh),Td(g_,Lh,n),ba(g_,g_),Td(y_,Dh,o),ba(y_,y_),Td(__,$h,a),ba(__,__),Jw(t,g_,n,Lh,$h,l),Jw(t,y_,o,Dh,Lh,l),Jw(t,__,a,$h,Dh,l)),aR[0]!==void 0&&(xd($h,aR,r),ba($h,$h),xd(Lh,aR,i),ba(Lh,Lh),xd(Dh,aR,s),ba(Dh,Dh),Td(g_,Lh,n),ba(g_,g_),Td(y_,Dh,o),ba(y_,y_),Td(__,$h,a),ba(__,__),Jw(t,g_,n,Lh,$h,l),Jw(t,y_,o,Dh,Lh,l),Jw(t,__,a,$h,Dh,l))}function olt(t,e,r){let i=$Z(t.maxVert[0],t.minVert[0]),s=0;for(let n=1;n<7;++n){const o=$Z(t.maxVert[n],t.minVert[n]);o>i&&(i=o,s=n)}bu(e,t.minVert[s]),bu(r,t.maxVert[s])}const Nh=[0,0,0];function alt(t,e,r,i){const{data:s,size:n}=t;let o=Number.NEGATIVE_INFINITY,a=0;for(let l=0;l<s.length;l+=n){Nh[0]=s[l]-e[0],Nh[1]=s[l+1]-e[1],Nh[2]=s[l+2]-e[2];const c=r[0]*Nh[0]+r[1]*Nh[1]+r[2]*Nh[2],h=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],p=Nh[0]*Nh[0]+Nh[1]*Nh[1]+Nh[2]*Nh[2]-c*c/h;p>o&&(o=p,a=l)}return bu(i,s,a),o}const Kn=[0,0];function llt(t,e,r,i,s){ult(t,e,Kn,s,i);const n=XOe(r,e);Kn[1]-EA<=n&&(i[0]=void 0),Kn[0]+EA>=n&&(s[0]=void 0)}const Gce=[0,0,0],jce=[0,0,0],Hce=[0,0,0],DS=[0,0,0],NS=[0,0,0],uD=[0,0,0];function Jw(t,e,r,i,s,n){if(ZOe(e)<EA)return;Td(Gce,r,e),Td(jce,i,e),Td(Hce,s,e),PC(t,e,Kn),NS[1]=Kn[0],DS[1]=Kn[1],uD[1]=DS[1]-NS[1];const o=[r,i,s],a=[Gce,jce,Hce];for(let l=0;l<3;++l){PC(t,o[l],Kn),NS[0]=Kn[0],DS[0]=Kn[1],PC(t,a[l],Kn),NS[2]=Kn[0],DS[2]=Kn[1],uD[0]=DS[0]-NS[0],uD[2]=DS[2]-NS[2];const c=PZ(uD);c<n.quality&&(bu(n.b0,o[l]),bu(n.b1,e),bu(n.b2,a[l]),n.quality=c)}}const clt=[0,0,0];function PC(t,e,r){const{data:i,size:s}=t;r[0]=Number.POSITIVE_INFINITY,r[1]=Number.NEGATIVE_INFINITY;for(let n=0;n<i.length;n+=s){const o=i[n]*e[0]+i[n+1]*e[1]+i[n+2]*e[2];r[0]=Math.min(r[0],o),r[1]=Math.max(r[1],o)}}function ult(t,e,r,i,s){const{data:n,size:o}=t;bu(i,n),bu(s,i),r[0]=XOe(clt,e),r[1]=r[0];for(let a=o;a<n.length;a+=o){const l=n[a]*e[0]+n[a+1]*e[1]+n[a+2]*e[2];l<r[0]&&(r[0]=l,bu(i,n,a)),l>r[1]&&(r[1]=l,bu(s,n,a))}}function qce(t,e,r){bu(r.center,t),Mx(r.halfSize,e,.5),r.quaternion[0]=0,r.quaternion[1]=0,r.quaternion[2]=0,r.quaternion[3]=1}const Zg=[0,0,0],FS=[0,0,0],lR=[0,0,0],$C=[0,0,0],LC=[0,0,0],Wce=[0,0,0];function hlt(t,e,r){bu(Zg,e),Math.abs(e[0])>Math.abs(e[1])&&Math.abs(e[0])>Math.abs(e[2])?Zg[0]=0:Math.abs(e[1])>Math.abs(e[2])?Zg[1]=0:Zg[2]=0,ZOe(Zg)<EA&&(Zg[0]=Zg[1]=Zg[2]=1),Td(FS,e,Zg),ba(FS,FS),Td(lR,e,FS),ba(lR,lR),qOe(t,e,FS,lR,$C,LC),xd(Wce,LC,$C),WOe(e,FS,lR,$C,LC,Wce,r)}function qOe(t,e,r,i,s,n){PC(t,e,Kn),s[0]=Kn[0],n[0]=Kn[1],PC(t,r,Kn),s[1]=Kn[0],n[1]=Kn[1],PC(t,i,Kn),s[2]=Kn[0],n[2]=Kn[1]}const hD=[0,0,0],Qf=[1,0,0,0,1,0,0,0,1],kS=[0,0,0];function WOe(t,e,r,i,s,n,o){Qf[0]=t[0],Qf[1]=t[1],Qf[2]=t[2],Qf[3]=e[0],Qf[4]=e[1],Qf[5]=e[2],Qf[6]=r[0],Qf[7]=r[1],Qf[8]=r[2],flt(o.quaternion,Qf),V4(kS,i,s),Mx(kS,kS,.5),Mx(o.center,t,kS[0]),Mx(hD,e,kS[1]),V4(o.center,o.center,hD),Mx(hD,r,kS[2]),V4(o.center,o.center,hD),Mx(o.halfSize,n,.5)}const Du=7;let dlt=class{constructor(e){this.minVert=new Array(Du),this.maxVert=new Array(Du);const r=64*Du;this.buffer=new ArrayBuffer(r);let i=0;this.minProj=new Float64Array(this.buffer,i,Du),i+=8*Du,this.maxProj=new Float64Array(this.buffer,i,Du),i+=8*Du;for(let l=0;l<Du;++l)this.minVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<Du;++l)this.maxVert[l]=new Float64Array(this.buffer,i,3),i+=24;for(let l=0;l<Du;++l)this.minProj[l]=Number.POSITIVE_INFINITY,this.maxProj[l]=Number.NEGATIVE_INFINITY;const s=new Array(Du),n=new Array(Du),{data:o,size:a}=e;for(let l=0;l<o.length;l+=a){let c=o[l];c<this.minProj[0]&&(this.minProj[0]=c,s[0]=l),c>this.maxProj[0]&&(this.maxProj[0]=c,n[0]=l),c=o[l+1],c<this.minProj[1]&&(this.minProj[1]=c,s[1]=l),c>this.maxProj[1]&&(this.maxProj[1]=c,n[1]=l),c=o[l+2],c<this.minProj[2]&&(this.minProj[2]=c,s[2]=l),c>this.maxProj[2]&&(this.maxProj[2]=c,n[2]=l),c=o[l]+o[l+1]+o[l+2],c<this.minProj[3]&&(this.minProj[3]=c,s[3]=l),c>this.maxProj[3]&&(this.maxProj[3]=c,n[3]=l),c=o[l]+o[l+1]-o[l+2],c<this.minProj[4]&&(this.minProj[4]=c,s[4]=l),c>this.maxProj[4]&&(this.maxProj[4]=c,n[4]=l),c=o[l]-o[l+1]+o[l+2],c<this.minProj[5]&&(this.minProj[5]=c,s[5]=l),c>this.maxProj[5]&&(this.maxProj[5]=c,n[5]=l),c=o[l]-o[l+1]-o[l+2],c<this.minProj[6]&&(this.minProj[6]=c,s[6]=l),c>this.maxProj[6]&&(this.maxProj[6]=c,n[6]=l)}for(let l=0;l<Du;++l){let c=s[l];bu(this.minVert[l],o,c),c=n[l],bu(this.maxVert[l],o,c)}}},plt=class{constructor(){this.b0=[1,0,0],this.b1=[0,1,0],this.b2=[0,0,1],this.quality=0}};function PZ(t){return t[0]*t[1]+t[0]*t[2]+t[1]*t[2]}function V4(t,e,r){t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2]}function xd(t,e,r){t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2]}function Mx(t,e,r){t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r}function bu(t,e,r=0){t[0]=e[r],t[1]=e[r+1],t[2]=e[r+2]}function Td(t,e,r){const i=e[0],s=e[1],n=e[2],o=r[0],a=r[1],l=r[2];t[0]=s*l-n*a,t[1]=n*o-i*l,t[2]=i*a-s*o}function ba(t,e){const r=e[0]*e[0]+e[1]*e[1]+e[2]*e[2];if(r>0){const i=1/Math.sqrt(r);t[0]=e[0]*i,t[1]=e[1]*i,t[2]=e[2]*i}}function ZOe(t){return t[0]*t[0]+t[1]*t[1]+t[2]*t[2]}function $Z(t,e){const r=e[0]-t[0],i=e[1]-t[1],s=e[2]-t[2];return r*r+i*i+s*s}function XOe(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]}function flt(t,e){const r=e[0]+e[4]+e[8];if(r>0){let i=Math.sqrt(r+1);t[3]=.5*i,i=.5/i,t[0]=(e[5]-e[7])*i,t[1]=(e[6]-e[2])*i,t[2]=(e[1]-e[3])*i}else{let i=0;e[4]>e[0]&&(i=1),e[8]>e[3*i+i]&&(i=2);const s=(i+1)%3,n=(i+2)%3;let o=Math.sqrt(e[3*i+i]-e[3*s+s]-e[3*n+n]+1);t[i]=.5*o,o=.5/o,t[3]=(e[3*s+n]-e[3*n+s])*o,t[s]=(e[3*s+i]+e[3*i+s])*o,t[n]=(e[3*n+i]+e[3*i+n])*o}}const oT=Kd(),Al=C(),LZ=C(),mlt=ts();let c8t=class{constructor(e){const o=e*56;this.buffer=new ArrayBuffer(o),this.obbs=new Array(e);for(let a=0;a<e;a++)this.obbs[a]={center:AQ(this.buffer,56*a+0),halfSize:OOe(this.buffer,56*a+24),quaternion:yOe(this.buffer,56*a+36)}}};function wte(t=[0,0,0],e=[-1,-1,-1],r=Kd()){return{center:$i(t),halfSize:aU(e),quaternion:gOe(r)}}function Zce(t){return wte(t.center,t.halfSize,t.quaternion)}function h8t(t,e){oe(e.center,t.center),oe(e.halfSize,t.halfSize),w$(e.quaternion,t.quaternion)}function YOe(t,e){return e=e||wte(),ilt(t,e),e}function Qw(t,e){const r=Oi(e,t.center),i=e8(t,e);return r>i?1:r<-i?-1:0}function d8t(t,e){return Al[0]=t.center[0]-e[0],Al[1]=t.center[1]-e[1],Al[2]=t.center[2]-e[2],Tg(oT,t.quaternion),xu(Al,Al,oT),rk(Al,Al),IQ(LZ,Al,t.halfSize),F6(LZ,Al)<e[3]*e[3]}function p8t(t,e){e||(e=Gn());const r=qV(mlt,t.quaternion),i=t.halfSize[0]*Math.abs(r[0])+t.halfSize[1]*Math.abs(r[3])+t.halfSize[2]*Math.abs(r[6]),s=t.halfSize[0]*Math.abs(r[1])+t.halfSize[1]*Math.abs(r[4])+t.halfSize[2]*Math.abs(r[7]),n=t.halfSize[0]*Math.abs(r[2])+t.halfSize[1]*Math.abs(r[5])+t.halfSize[2]*Math.abs(r[8]);return e[0]=t.center[0]-i,e[1]=t.center[1]-s,e[2]=t.center[2]-n,e[3]=t.center[0]+i,e[4]=t.center[1]+s,e[5]=t.center[2]+n,e}function f8t(t,e){return Oi(e,t.center)-e8(t,e)}function m8t(t,e){return Oi(e,t.center)+e8(t,e)}function g8t(t,e){return Qw(t,e[0])<=0&&Qw(t,e[1])<=0&&Qw(t,e[2])<=0&&Qw(t,e[3])<=0&&Qw(t,e[4])<=0&&Qw(t,e[5])<=0}function y8t(t,e,r,i=0){Tg(oT,t.quaternion),pe(Al,e,t.center);const s=xu(Al,Al,oT),n=xu(LZ,r,oT);let o=-1/0,a=1/0;for(let l=0;l<3;l++)if(Math.abs(n[l])>1e-6){const c=(i+t.halfSize[l]-s[l])/n[l],h=(-i-t.halfSize[l]-s[l])/n[l];o=Math.max(o,Math.min(c,h)),a=Math.min(a,Math.max(c,h))}else if(s[l]>t.halfSize[l]+i||s[l]<-t.halfSize[l]-i)return!1;return o<=a}(()=>{const t=new Int8Array(162);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=6};return r([6,2,3,1,5,4]),r([0,2,3,1,5,4]),r([0,2,3,7,5,4]),r([0,1,3,2,6,4]),r([0,1,3,2,0,0]),r([0,1,5,7,3,2]),r([0,1,3,7,6,4]),r([0,1,3,7,6,2]),r([0,1,5,7,6,2]),r([0,1,5,4,6,2]),r([0,1,5,4,0,0]),r([0,1,3,7,5,4]),r([0,2,6,4,0,0]),r([0,0,0,0,0,0]),r([1,3,7,5,0,0]),r([2,3,7,6,4,0]),r([2,3,7,6,0,0]),r([2,3,1,5,7,6]),r([0,1,5,7,6,2]),r([0,1,5,7,6,4]),r([0,1,3,7,6,4]),r([4,5,7,6,2,0]),r([4,5,7,6,0,0]),r([4,5,1,3,7,6]),r([0,2,3,7,5,4]),r([6,2,3,7,5,4]),r([6,2,3,1,5,4]),t})();function e8(t,e){Tg(oT,t.quaternion),xu(Al,e,oT);const r=t.halfSize;return Math.abs(Al[0]*r[0])+Math.abs(Al[1]*r[1])+Math.abs(Al[2]*r[2])}function JOe(t,e){for(let r=0;r<8;++r){const i=e[r];i[0]=1&r?-t.halfSize[0]:t.halfSize[0],i[1]=2&r?-t.halfSize[1]:t.halfSize[1],i[2]=4&r?-t.halfSize[2]:t.halfSize[2],xu(i,i,t.quaternion),ue(i,i,t.center)}}function glt(t){return ou(t.halfSize)}function ylt(t,e,r,i,s){if(w$(s.quaternion,t.quaternion),i===Ue.Global){Tg(dD,t.quaternion),xu(v_,t.center,dD),rk(US,v_),IQ(VS,US,t.halfSize),Mi(VS,US,VS);const n=Oe(VS);ue(VS,US,t.halfSize);const o=Oe(VS);if(n<r)oe(s.center,t.center),ie(v_,r,r,r),ue(s.halfSize,t.halfSize,v_);else{const a=o>0?1+e/o:1,l=n>0?1+r/n:1,c=(l+a)/2,h=(l-a)/2;ae(s.halfSize,US,h),gu(s.halfSize,s.halfSize,t.halfSize,c),ae(s.center,US,c),gu(s.center,s.center,t.halfSize,h),J1e(v_,v_),N6(s.center,s.center,v_),xu(s.center,s.center,s.quaternion)}}else{const n=ie(v_,0,0,1);gu(s.center,t.center,n,(r+e)/2),Tg(dD,t.quaternion),xu(n,n,dD),rk(n,n),gu(s.halfSize,t.halfSize,n,(r-e)/2)}return s}const v_=C(),US=C(),VS=C(),dD=Kd();function QOe(t){return t?parseInt(t.substring(t.lastIndexOf("/")+1,t.length),10):void 0}function _8t(t){if(le("disable-feature:i3s-draco")||!t)return!1;for(const e of t)for(const r of e.geometryBuffers)if(r.compressedAttributes?.encoding==="draco")return!0;return!1}function v8t(t,e,r,i){r.traverse(e,s=>{const n=s.mbs;return(n!=null&&_lt(t,n))!==Wx.OUTSIDE&&(i(s),!0)})}function b8t(t,e,r){let i=0,s=0;for(let n=0;n<e.length&&i<t.length;n++)t[i]===e[n]&&(r(n)&&(t[s]=t[i],s++),i++);t.length=s}function w8t(t,e,r){let i=0,s=0;for(;i<r.length;)U0e(t,r[i])>=0===e&&(r[s]=r[i],s++),i++;r.length=s}const cR=Ht();function x8t(t,e){if(e.rotationScale[1]===0&&e.rotationScale[2]===0&&e.rotationScale[3]===0&&e.rotationScale[5]===0&&e.rotationScale[6]===0&&e.rotationScale[7]===0)return cR[0]=(t[0]-e.position[0])/e.rotationScale[0],cR[1]=(t[1]-e.position[1])/e.rotationScale[4],cR[2]=(t[2]-e.position[0])/e.rotationScale[0],cR[3]=(t[3]-e.position[1])/e.rotationScale[4],cR}var Wx;function _lt(t,e){const r=e[0],i=e[1],s=e[3],n=t[0]-r,o=r-t[2],a=t[1]-i,l=i-t[3],c=Math.max(n,o,0),h=Math.max(a,l,0),p=c*c+h*h;return p>s*s?Wx.OUTSIDE:p>0?Wx.INTERSECTS_CENTER_OUTSIDE:-Math.max(n,o,a,l)>s?Wx.INSIDE:Wx.INTERSECTS_CENTER_INSIDE}function vlt(t,e,r){const i=[],s=r&&r.missingFields,n=r&&r.originalFields;for(const o of t){const a=o.toLowerCase();let l=!1;for(const c of e)if(a===c.name.toLowerCase()){i.push(c.name),l=!0,n&&n.push(o);break}!l&&s&&s.push(o)}return i}async function T8t(t,e,r,i,s){if(e.length===0)return[];const n=t.attributeStorageInfo;if(t.associatedLayer!=null)try{return await wlt(t.associatedLayer,e,r,i)}catch(o){if(t.associatedLayer.loaded)throw o}if(n){const o=blt(e,r,s);if(o==null)throw new D("scenelayer:features-not-loaded","Tried to query attributes for unloaded features");const a=t.parsedUrl.path;return(await Promise.all(o.map(l=>xlt(a,n,l.node,l.indices,i).then(c=>{for(let h=0;h<l.graphics.length;h++){const p=l.graphics[h],f=c[h];if(p.attributes)for(const m in p.attributes)m in f||(f[m]=p.attributes[m]);p.attributes=f}return l.graphics})))).flat()}throw new D("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function blt(t,e,r){const i=new Map,s=[],n=r();for(const o of t){const a=o.attributes[e];for(let l=0;l<n.length;l++){const c=n[l],h=c.featureIds.indexOf(a);if(h>=0){let p=i.get(c.node);p||(p={node:c.node,indices:[],graphics:[]},s.push(p),i.set(c.node,p)),p.indices.push(h),p.graphics.push(o);for(let f=l;f>0;f--)n[f]=n[f-1];n[0]=c;break}}}return s}async function wlt(t,e,r,i){e.sort((l,c)=>l.attributes[r]-c.attributes[r]);const s=e.map(l=>l.attributes[r]),n=[],o=vlt(i,t.fields,{originalFields:n}),a=await KOe(t,s,o);for(let l=0;l<e.length;l++){const c=e[l],h=a[l],p={};if(c.attributes)for(const f in c.attributes)p[f]=c.attributes[f];for(let f=0;f<n.length;f++)p[n[f]]=h[o[f]];c.attributes=p}return e}function KOe(t,e,r){const i=t.capabilities.query.maxRecordCount;if(i!=null&&e.length>i){const n=v4e(e,i);return Promise.all(n.map(o=>KOe(t,o,r))).then(o=>o.flat())}const s=new cb({objectIds:e,outFields:r,orderByFields:[t.objectIdField]});return t.queryFeatures(s).then(n=>{if(n&&n.features&&n.features.length===e.length)return n.features.map(o=>o.attributes);throw new D("scenelayer:feature-not-in-associated-layer","Feature not found in associated feature layer")})}function xlt(t,e,r,i,s){return eRe(t,e,r.resources.attributes,i,s)}function eRe(t,e,r,i,s){const n=[];for(const o of e)if(o&&s.includes(o.name)){const a=`${t}/nodes/${r}/attributes/${o.key}/0`;n.push({url:a,storageInfo:o})}return Oh(n.map(o=>Lt(o.url,{responseType:"array-buffer"}).then(a=>uat(o.storageInfo,a.data)))).then(o=>{const a=[];for(const l of i){const c={};for(let h=0;h<o.length;h++){const p=o[h].value;p!=null&&(c[n[h].storageInfo.name]=Elt(p,l))}a.push(c)}return a})}(function(t){t[t.OUTSIDE=0]="OUTSIDE",t[t.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",t[t.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",t[t.INSIDE=3]="INSIDE"})(Wx||(Wx={}));const Tlt=-32768,Slt=-(2**31);function Elt(t,e){if(!t)return null;const r=t[e];return w6(t)?r===Tlt?null:r:T6(t)?r===Slt?null:r:r!=r?null:r}function Clt(t){const e=t.store,r=e.indexCRS||e.geographicCRS,i=r===void 0?e.indexWKT:void 0;if(i){if(!t.spatialReference)throw new D("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indeWKT in the scene layer store but no layer spatial reference",{});if(i!==t.spatialReference.wkt)throw new D("layerview:store-spatial-reference-wkt-index-incompatible","The indeWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=r?new qe(QOe(r)):t.spatialReference;return s.equals(t.spatialReference)?t.spatialReference:s}function Alt(t){const e=t.store,r=e.vertexCRS||e.projectedCRS,i=r===void 0?e.vertexWKT:void 0;if(i){if(!t.spatialReference)throw new D("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(i!==t.spatialReference.wkt)throw new D("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const s=r?new qe(QOe(r)):t.spatialReference;return s.equals(t.spatialReference)?t.spatialReference:s}function S8t(t,e){return e==null?"@null":e===Sg(e)?"@ECEF":t.equals(e)?"":e.wkid!=null?"@"+e.wkid:null}function DZ(t,e,r){if(!$f(t,e))throw new D("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{});if(r==="local"&&!Olt(t,e))throw new D("layerview:spatial-reference-incompatible","The spatial reference of this scene layer is incompatible with the spatial reference of the view",{})}function E8t(t,e,r){if(t.serviceUpdateTimeStamp?.lastUpdate!==e.serviceUpdateTimeStamp?.lastUpdate||!r.isEmpty||Dl(t.associatedLayer,i=>i.url)!==Dl(e.associatedLayer,i=>i.url))throw new D("layerview:recycle-failed")}function Olt(t,e){return t.equals(e)||t.isWGS84&&e.isWebMercator||t.isWebMercator&&e.isWGS84}function Rlt(t,e,r){const i=Clt(t),s=Alt(t);DZ(i,e,r),DZ(s,e,r)}function Mlt(t){return(t.geometryType==null||t.geometryType==="triangles")&&(t.topology==null||t.topology==="PerAttributeArray")&&t.vertexAttributes!=null&&t.vertexAttributes.position!=null}function C8t(t){if(t.store==null||t.store.defaultGeometrySchema==null||!Mlt(t.store.defaultGeometrySchema))throw new D("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:t.parsedUrl.path})}function A8t(t,e){Rlt(t,e.spatialReference,e.viewingMode)}function Ilt(t){return t.geometryType!=null&&t.geometryType==="points"&&(t.topology==null||t.topology==="PerAttributeArray")&&(t.encoding==null||t.encoding===""||t.encoding==="lepcc-xyz")&&t.vertexAttributes!=null&&t.vertexAttributes.position!=null}function O8t(t){if(t.store==null||t.store.defaultGeometrySchema==null||!Ilt(t.store.defaultGeometrySchema))throw new D("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function R8t(t,e){DZ(t.spatialReference,e.spatialReference,e.viewingMode)}function Plt(t){return t.type==="simple"||t.type==="class-breaks"||t.type==="unique-value"}function $lt(t){return t.type==="mesh-3d"}function M8t(t){if(t==null||!Plt(t)||(t.type==="unique-value"||t.type==="class-breaks")&&t.defaultSymbol==null)return!0;const e=t.getSymbols();if(e.length===0)return!0;for(const r of e){if(!$lt(r)||r.symbolLayers.length===0)return!0;for(const i of r.symbolLayers.items)if(i.type!=="fill"||i.material==null||i.material.color==null||i.material.colorMixMode!=="replace")return!0}return!1}const I8t=EOe({color:[0,0,0,0],opacity:0});class Llt{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function P8t(t){const e=new Llt;let r=!1,i=!1;for(const s of t.symbolLayers.items)if(s.type==="fill"&&s.enabled){const n=s.material,o=s.edges;if(n!=null&&!r){const a=n.color,l=COe(n.colorMixMode);e.material=a!=null?{color:[a.r/255,a.g/255,a.b/255],alpha:a.a,colorMixMode:l}:{color:[1,1,1],alpha:1,colorMixMode:pn.Multiply},e.castShadows=s.castShadows,r=!0}o==null||i||(e.edgeMaterial=SOe(o,{}),i=!0)}return e.material||(e.material={color:[1,1,1],alpha:1,colorMixMode:pn.Multiply}),e}function $8t(t,e){return(0|t)+(0|e)|0}function Dlt(t,e,r,i,s=0){i===Sg(i)?e.isGeographic?zlt(t,r,e,s):Vlt(t,r,e,s):e.isWGS84&&(i.isWebMercator||kI(i))?Nlt(e,t,i,r,s):e.isWebMercator&&kI(i)?Ult(e,t,i,r,s):t===r?(r.center[2]+=s,wi(r.center,e,0,r.center,i,0,1)):(ie(r.center,t.center[0],t.center[1],t.center[2]+s),wi(r.center,e,0,r.center,i,0,1),w$(r.quaternion,t.quaternion),oe(r.halfSize,t.halfSize))}function Nlt(t,e,r,i,s){oe(Zv,e.center),Zv[2]+=s;const n=Sg(r);wi(Zv,t,0,Zv,n,0,1),tRe(n,e,Zv,r,i)}const z4=new Array(24),Flt=new Ge(z4,3,!0),Xce=C(),Zv=C(),klt=ts();function Ult(t,e,r,i,s){oe(Zv,e.center),Zv[2]+=s,tRe(t,e,Zv,r,i)}function tRe(t,e,r,i,s){const n=qV(klt,e.quaternion);for(let o=0;o<8;++o){for(let a=0;a<3;++a)Xce[a]=e.halfSize[a]*(o&1<<a?-1:1);for(let a=0;a<3;++a){let l=r[a];for(let c=0;c<3;++c)l+=Xce[c]*n[3*c+a];z4[3*o+a]=l}}wi(z4,t,0,z4,i,0,8),YOe(Flt,s)}function Vlt(t,e,r,i){JOe(t,NZ),ie(e.center,t.center[0],t.center[1],t.center[2]+i),wc(r,e.center,Nu,Sg(r)),ie(e.center,Nu[12],Nu[13],Nu[14]);const s=2*Math.sqrt(1+Nu[0]+Nu[5]+Nu[10]);By[0]=(Nu[6]-Nu[9])/s,By[1]=(Nu[8]-Nu[2])/s,By[2]=(Nu[1]-Nu[4])/s,By[3]=.25*s,WV(e.quaternion,By,t.quaternion),Tg(By,e.quaternion);let n=0,o=0,a=0;for(const l of NZ)l[2]+=i,wi(l,r,0,l,Sg(r),0,1),Mi(Nr,l,e.center),xu(Nr,Nr,By),n=Math.max(n,Math.abs(Nr[0])),o=Math.max(o,Math.abs(Nr[1])),a=Math.max(a,Math.abs(Nr[2]));ie(e.halfSize,n,o,a)}function zlt(t,e,r,i){const s=Ir(r),n=1+Math.max(0,i)/(s.radius+t.center[2]);ie(e.center,t.center[0],t.center[1],t.center[2]+i),wi(e.center,r,0,e.center,Sg(r),0,1),w$(e.quaternion,t.quaternion),Tg(By,t.quaternion),ie(Nr,0,0,1),xu(Nr,Nr,By),ie(Nr,t.halfSize[0]*Math.abs(Nr[0]),t.halfSize[1]*Math.abs(Nr[1]),t.halfSize[2]*Math.abs(Nr[2])),ae(Nr,Nr,s.inverseFlattening),ue(e.halfSize,t.halfSize,Nr),ae(e.halfSize,e.halfSize,n)}function L8t(t,e,r,i,s,n){if(!n||n.length===0||e==null||!t.mbs)return null;const o=dat(t.mbs,s,r,e);so(fD,o);let a=null;const l=()=>{if(!a)if(a=NZ,Au(pD),t.serviceObb!=null){Dlt(t.serviceObb,r,Yce,e,s),JOe(Yce,a);for(const m of a)Ne(m,m,fD),xC(pD,m)}else{const m=t.mbs;if(!m)return;const g=m[3];Tn(m,r,Nr,e),Ne(Nr,Nr,fD),Nr[2]+=s;for(let _=0;_<8;++_){const v=1&_?g:-g,b=2&_?g:-g,x=4&_?g:-g,T=a[_];oe(T,[Nr[0]+v,Nr[1]+b,Nr[2]+x]),xC(pD,T)}}};let c=1/0,h=-1/0;const p=m=>{if(m.type!=="replace")return;const g=m.geometry;if(!g?.hasZ)return;Au(kz);const _=g.spatialReference||i,v=g.rings.reduce((b,x)=>x.reduce((T,S)=>(Tn(S,_,Nr,e),Ne(Nr,Nr,fD),xC(kz,Nr),Math.min(Nr[2],T)),b),1/0);l(),JP(pD,kz)&&(c=Math.min(c,v),h=Math.max(h,v))};if(n.forEach(m=>p(m)),c===1/0)return null;const f=(m,g,_)=>{Ne(Nr,_,o),m[g]=Nr[0],m[g+1]=Nr[1],m[g+2]=Nr[2],g+=24,_[2]=c,Ne(Nr,_,o),m[g]=Nr[0],m[g+1]=Nr[1],m[g+2]=Nr[2],g+=24,_[2]=h,Ne(Nr,_,o),m[g]=Nr[0],m[g+1]=Nr[1],m[g+2]=Nr[2]};for(let m=0;m<8;++m)f(Jce.data,3*m,a[m]);return YOe(Jce)}function D8t(t){return t!=null&&t.halfSize[0]>=0}function N8t(t){return t[3]>=0}function F8t(t){t!=null&&(t.halfSize[0]=-1)}function k8t(t){t!=null&&(t[3]=-1)}const Nu=xe(),By=mOe(),NZ=[[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0],[0,0,0]],kz=Ht(),pD=Ht(),Yce=wte(),Nr=C(),Jce={data:new Array(72),size:3,exclusive:!0,stride:3},fD=xe();async function Blt(t,e=t.popupTemplate){if(e==null)return[];const r=await e.getRequiredFields(t.fieldsIndex),{lastEditInfoEnabled:i}=e,{objectIdField:s,typeIdField:n,globalIdField:o,relationships:a}=t;if(r.includes("*"))return["*"];const l=i?await sze(t):[],c=KP(t.fieldsIndex,[...r,...l]);return n&&c.push(n),c&&s&&t.fieldsIndex?.has(s)&&!c.includes(s)&&c.push(s),c&&o&&t.fieldsIndex?.has(o)&&!c.includes(o)&&c.push(o),a&&a.forEach(h=>{const{keyField:p}=h;c&&p&&t.fieldsIndex?.has(p)&&!c.includes(p)&&c.push(p)}),c}function rRe(t,e){return t.popupTemplate?t.popupTemplate:e!=null&&e.defaultPopupTemplateEnabled&&t.defaultPopupTemplate!=null?t.defaultPopupTemplate:null}function U8t(t,e){return rRe(t,{defaultPopupTemplateEnabled:e})!=null}const Glt=["3DObject","Point"],Qce=lEe();let Ft=class extends QSe(znt(ESe(x2e(tEe(xee(YK(SSe(rs(gV))))))))){constructor(...e){super(...e),this.featureReduction=null,this.rangeInfos=null,this.operationalLayerType="ArcGISSceneServiceLayer",this.type="scene",this.fields=null,this.floorInfo=null,this.outFields=null,this.nodePages=null,this.materialDefinitions=null,this.textureSetDefinitions=null,this.geometryDefinitions=null,this.serviceUpdateTimeStamp=null,this.excludeObjectIds=new Ke,this.definitionExpression=null,this.filter=null,this.path=null,this.labelsVisible=!0,this.labelingInfo=null,this.legendEnabled=!0,this.priority=null,this.semantic=null,this.cachedDrawingInfo={color:!1},this.popupEnabled=!0,this.popupTemplate=null,this.objectIdField=null,this.globalIdField=null,this._fieldUsageInfo={},this.screenSizePerspectiveEnabled=!0}normalizeCtorArgs(e,r){return typeof e=="string"?{url:e,...r}:e}destroy(){this._set("renderer",null)}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,r){const i=this.getFeatureType(r?.feature)?.domains?.[e];return i&&i.type!=="inherited"?i:this.getField(e)?.domain??null}getFeatureType(e){return e&&this.associatedLayer?this.associatedLayer.getFeatureType(e):null}get types(){return this.associatedLayer?.types??[]}get typeIdField(){return this.associatedLayer?.typeIdField??null}get templates(){return this.associatedLayer?.templates??null}get formTemplate(){return this.associatedLayer?.formTemplate??null}get fieldsIndex(){return new BK(this.fields)}readNodePages(e,r,i){return r.layerType==="Point"&&(e=r.pointNodePages),e==null||typeof e!="object"?null:Ox.fromJSON(e,i)}set elevationInfo(e){this._set("elevationInfo",e),this.loaded&&this._validateElevationInfo()}get geometryType(){return jlt[this.profile]||"mesh"}set renderer(e){ak(e,this.fieldsIndex),this._set("renderer",e)}readCachedDrawingInfo(e){return e!=null&&typeof e=="object"||(e={}),e.color==null&&(e.color=!1),e}get capabilities(){const e=this.associatedLayer?.capabilities??Bnt,{query:r,editing:{supportsGlobalId:i,supportsRollbackOnFailure:s,supportsUploadWithItemId:n,supportsGeometryUpdate:o,supportsReturnServiceEditsInSourceSpatialReference:a},data:{supportsZ:l,supportsM:c,isVersioned:h,supportsAttachment:p},operations:{supportsEditing:f,supportsAdd:m,supportsUpdate:g,supportsDelete:_,supportsQuery:v,supportsQueryAttachments:b,supportsAsyncConvert3D:x}}=e,T=e.operations.supportsChangeTracking,S=!!this.associatedLayer?.infoFor3D&&QI();return{query:r,editing:{supportsGlobalId:i,supportsReturnServiceEditsInSourceSpatialReference:a,supportsRollbackOnFailure:s,supportsGeometryUpdate:S&&o,supportsUploadWithItemId:n},data:{supportsAttachment:p,supportsZ:l,supportsM:c,isVersioned:h},operations:{supportsQuery:v,supportsQueryAttachments:b,supportsEditing:f&&T,supportsAdd:S&&m&&T,supportsDelete:S&&_&&T,supportsUpdate:g&&T,supportsAsyncConvert3D:x}}}get editingEnabled(){return this._isOverridden("editingEnabled")?this._get("editingEnabled"):this.userHasEditingPrivileges}set editingEnabled(e){this._overrideIfSome("editingEnabled",e)}get infoFor3D(){return this.associatedLayer?.infoFor3D??null}get defaultPopupTemplate(){return this.associatedLayer||this.attributeStorageInfo?this.createPopupTemplate():null}readObjectIdField(e,r){return!e&&r.fields&&r.fields.some(i=>(i.type==="esriFieldTypeOID"&&(e=i.name),!!e)),e||void 0}readGlobalIdField(e,r){return!e&&r.fields&&r.fields.some(i=>(i.type==="esriFieldTypeGlobalID"&&(e=i.name),!!e)),e||void 0}get displayField(){return this.associatedLayer?.displayField??null}readProfile(e,r){const i=r.store.profile;return i!=null&&Kce[i]?Kce[i]:(K.getLogger(this).error("Unknown or missing profile",{profile:i,layer:this}),"mesh-pyramids")}load(e){const r=e!=null?e.signal:null,i=this.loadFromPortal({supportedTypes:["Scene Service"]},e).catch(xa).then(()=>this._fetchService(r)).then(()=>Promise.all([this._fetchIndexAndUpdateExtent(this.nodePages,r),this._setAssociatedFeatureLayer(r),this._loadFilterGeometries()])).then(()=>this._validateElevationInfo()).then(()=>this._applyAssociatedLayerOverrides()).then(()=>this._populateFieldUsageInfo()).then(()=>cEe(this,{origin:"service"},r)).then(()=>ak(this.renderer,this.fieldsIndex)).then(()=>this.finishLoadEditablePortalLayer(e));return this.addResolvingPromise(i),Promise.resolve(this)}async beforeSave(){this.filter!=null&&(this.filter=this.filter.clone(),await this.load())}async _loadFilterGeometries(){if(this.filter)try{await this.filter.loadGeometries(this.spatialReference)}catch(e){K.getLogger(this).error("#_loadFilterGeometries()",this,"Failed to load filter geometries. Geometry filter will not be applied for this layer.",{error:e}),this.filter=null}}createQuery(){const e=new cb;return this.geometryType!=="mesh"&&(e.returnGeometry=!0,e.returnZ=!0),e.where=this.definitionExpression||"1=1",e.sqlFormat="standard",e.outFields=["*"],e}queryExtent(e,r){return this._getAssociatedLayerForQuery().then(i=>i.queryExtent(e||this.createQuery(),r))}queryFeatureCount(e,r){return this._getAssociatedLayerForQuery().then(i=>i.queryFeatureCount(e||this.createQuery(),r))}queryFeatures(e,r){return this._getAssociatedLayerForQuery().then(i=>i.queryFeatures(e||this.createQuery(),r)).then(i=>{if(i?.features)for(const s of i.features)s.layer=this,s.sourceLayer=this;return i})}async queryCachedAttributes(e,r){const i=K9e(this.fieldsIndex,await Blt(this,rRe(this)));return eRe(this.parsedUrl.path,this.attributeStorageInfo??[],e,r,i)}async queryCachedFeature(e,r){const i=await this.queryCachedAttributes(e,[r]);if(!i||i.length===0)throw new D("scenelayer:feature-not-in-cached-data","Feature not found in cached data");const s=new oa;return s.attributes=i[0],s.layer=this,s.sourceLayer=this,s}queryObjectIds(e,r){return this._getAssociatedLayerForQuery().then(i=>i.queryObjectIds(e||this.createQuery(),r))}queryAttachments(e,r){return this._getAssociatedLayerForQuery().then(i=>i.queryAttachments(e,r))}getFieldUsageInfo(e){const r={supportsLabelingInfo:!1,supportsRenderer:!1,supportsPopupTemplate:!1,supportsLayerQuery:!1};return this.loaded?this._fieldUsageInfo[e]||r:(K.getLogger(this).error("#getFieldUsageInfo()","Unavailable until layer is loaded"),r)}createPopupTemplate(e){return uEe(this,e)}_getAssociatedLayerForQuery(){const e=this.associatedLayer;return e?.loaded?Promise.resolve(e):this._loadAssociatedLayerForQuery()}async _loadAssociatedLayerForQuery(){if(await this.load(),!this.associatedLayer)throw new D("scenelayer:query-not-available","SceneLayer queries are not available without an associated feature layer",{layer:this});try{await this.associatedLayer.load()}catch(e){throw new D("scenelayer:query-not-available","SceneLayer associated feature layer could not be loaded",{layer:this,error:e})}return this.associatedLayer}hasCachedStatistics(e){return this.statisticsInfo!=null&&this.statisticsInfo.some(r=>r.name===e)}async queryCachedStatistics(e,r){if(await this.load(r),!this.statisticsInfo)throw new D("scenelayer:no-cached-statistics","Cached statistics are not available for this layer");const i=this.fieldsIndex.get(e);if(!i)throw new D("scenelayer:field-unexisting",`Field '${e}' does not exist on the layer`);for(const s of this.statisticsInfo)if(s.name===i.name){const n=Cu(this.parsedUrl.path,s.href);return Lt(n,{query:{f:"json",token:this.apiKey},responseType:"json",signal:r?r.signal:null}).then(o=>o.data)}throw new D("scenelayer:no-cached-statistics","Cached statistics for this attribute are not available")}async saveAs(e,r){return this._debouncedSaveOperations(bA.SAVE_AS,{...r,getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"},e)}async save(){const e={getTypeKeywords:()=>this._getTypeKeywords(),portalItemLayerType:"scene"};return this._debouncedSaveOperations(bA.SAVE,e)}async applyEdits(e,r){const{applyEdits:i}=await J(()=>import("./editingSupport-3a0009ce.js"),["./editingSupport-3a0009ce.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js"],import.meta.url);if(await this.load(),!this.associatedLayer)throw new D(`${this.type}-layer:not-editable`,"Service is not editable");return await this.associatedLayer.load(),i(this,this.associatedLayer.source,e,r)}async uploadAssets(e,r){if(await this.load(),this.associatedLayer==null)throw new D(`${this.type}-layer:not-editable`,"Service is not editable");return await this.associatedLayer.load(),this.associatedLayer.uploadAssets(e,r)}on(e,r){return super.on(e,r)}validateLayer(e){if(e.layerType&&!Glt.includes(e.layerType))throw new D("scenelayer:layer-type-not-supported","SceneLayer does not support this layer type",{layerType:e.layerType});if(isNaN(this.version.major)||isNaN(this.version.minor))throw new D("layer:service-version-not-supported","Service version is not supported.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});if(this.version.major>2)throw new D("layer:service-version-too-new","Service version is too new.",{serviceVersion:this.version.versionString,supportedVersions:"1.x, 2.x"});function r(i,s){let n=!1,o=!1;if(i==null)n=!0,o=!0;else{const a=s&&s.isGeographic;switch(i){case"east-north-up":case"earth-centered":n=!0,o=a;break;case"vertex-reference-frame":n=!0,o=!a;break;default:n=!1}}if(!n)throw new D("scenelayer:unsupported-normal-reference-frame","Normal reference frame is invalid.");if(!o)throw new D("scenelayer:incompatible-normal-reference-frame","Normal reference frame is incompatible with layer spatial reference.")}r(this.normalReferenceFrame,this.spatialReference)}_getTypeKeywords(){const e=[];if(this.profile==="points")e.push("Point");else{if(this.profile!=="mesh-pyramids")throw new D("scenelayer:unknown-profile","SceneLayer:save() encountered an unknown SceneLayer profile: "+this.profile);e.push("3DObject")}return e}_populateFieldUsageInfo(){if(this._fieldUsageInfo={},this.fields)for(const e of this.fields){const r=!(!this.attributeStorageInfo||!this.attributeStorageInfo.some(n=>n.name===e.name)),i=!!this.associatedLayer?.fields?.some(n=>n&&e.name===n.name),s={supportsLabelingInfo:r,supportsRenderer:r,supportsPopupTemplate:r||i,supportsLayerQuery:i};this._fieldUsageInfo[e.name]=s}}_applyAssociatedLayerOverrides(){this._applyAssociatedLayerFieldsOverrides(),this._applyAssociatedLayerPopupOverrides(),this._applyAssociatedLayerExtentOverride()}_applyAssociatedLayerFieldsOverrides(){if(!this.associatedLayer?.fields)return;let e=null;for(const r of this.associatedLayer.fields){const i=this.getField(r.name);i?(!i.domain&&r.domain&&(i.domain=r.domain.clone()),i.editable=r.editable,i.nullable=r.nullable,i.length=r.length):(e||(e=this.fields?this.fields.slice():[]),e.push(r.clone()))}e&&this._set("fields",e)}_applyAssociatedLayerPopupOverrides(){if(!this.associatedLayer)return;const e=["popupTemplate","popupEnabled"],r=tl(this);for(let i=0;i<e.length;i++){const s=e[i],n=this.originIdOf(s),o=this.associatedLayer.originIdOf(s);n<o&&(o===_r.SERVICE||o===_r.PORTAL_ITEM)&&r.setAtOrigin(s,this.associatedLayer[s],o)}}_applyAssociatedLayerExtentOverride(){const e=this.associatedLayer?.editingInfo?.lastEditDate,r=this.associatedLayer?.serverGens,i=this.associatedLayer?.getAtOrigin("fullExtent","service");!QI()||this.associatedLayer?.infoFor3D==null||!i||!LK(this.associatedLayer?.url)||!e||this.serviceUpdateTimeStamp?.lastUpdate===e.getTime()||!this.serviceUpdateTimeStamp&&r?.minServerGen===r?.serverGen||tl(this).setAtOrigin("fullExtent",i.clone(),_r.SERVICE)}async _setAssociatedFeatureLayer(e){if(!["mesh-pyramids","points"].includes(this.profile))return;const r=new Gnt(this.parsedUrl,this.portalItem,this.apiKey,e);try{this.associatedLayer=await r.fetch()}catch(i){ws(i)||this._logWarningOnPopupEnabled()}}async _logWarningOnPopupEnabled(){await Pn(()=>this.popupEnabled&&this.popupTemplate!=null);const e=`this SceneLayer: ${this.title}`;this.attributeStorageInfo==null?K.getLogger(this).warn(`Associated FeatureLayer could not be loaded and no binary attributes found. Popups will not work on ${e}`):K.getLogger(this).info(`Associated FeatureLayer could not be loaded. Falling back to binary attributes for Popups on ${e}`)}_validateElevationInfo(){const e=this.elevationInfo;e&&(this.profile==="mesh-pyramids"&&e.mode==="relative-to-scene"&&K.getLogger(this).warn(".elevationInfo=","Mesh scene layers don't support relative-to-scene elevation mode"),e.featureExpressionInfo&&e.featureExpressionInfo.expression!=="0"&&K.getLogger(this).warn(".elevationInfo=","Scene layers do not support featureExpressionInfo"))}};u([d({types:{key:"type",base:c0,typeMap:{selection:yW}},json:{origins:{"web-scene":{name:"layerDefinition.featureReduction",write:!0},"portal-item":{name:"layerDefinition.featureReduction",write:!0}}}})],Ft.prototype,"featureReduction",void 0),u([d({type:[_v],json:{read:!1,origins:{"web-scene":{name:"layerDefinition.rangeInfos",write:!0},"portal-item":{name:"layerDefinition.rangeInfos",write:!0}}}})],Ft.prototype,"rangeInfos",void 0),u([d({json:{read:!1}})],Ft.prototype,"associatedLayer",void 0),u([d({type:["show","hide"]})],Ft.prototype,"listMode",void 0),u([d({type:["ArcGISSceneServiceLayer"]})],Ft.prototype,"operationalLayerType",void 0),u([d({json:{read:!1},readOnly:!0})],Ft.prototype,"type",void 0),u([d({...Qce.fields,readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],Ft.prototype,"fields",void 0),u([d()],Ft.prototype,"types",null),u([d()],Ft.prototype,"typeIdField",null),u([d()],Ft.prototype,"templates",null),u([d()],Ft.prototype,"formTemplate",null),u([d({readOnly:!0})],Ft.prototype,"fieldsIndex",null),u([d({type:h2e,json:{read:{source:"layerDefinition.floorInfo"},write:{target:"layerDefinition.floorInfo"}}})],Ft.prototype,"floorInfo",void 0),u([d(Qce.outFields)],Ft.prototype,"outFields",void 0),u([d({type:Ox,readOnly:!0,json:{read:!1}})],Ft.prototype,"nodePages",void 0),u([Ae("service","nodePages",["nodePages","pointNodePages"])],Ft.prototype,"readNodePages",null),u([d({type:[ed],readOnly:!0})],Ft.prototype,"materialDefinitions",void 0),u([d({type:[q3],readOnly:!0})],Ft.prototype,"textureSetDefinitions",void 0),u([d({type:[Z3],readOnly:!0})],Ft.prototype,"geometryDefinitions",void 0),u([d({readOnly:!0})],Ft.prototype,"serviceUpdateTimeStamp",void 0),u([d({readOnly:!0})],Ft.prototype,"attributeStorageInfo",void 0),u([d({readOnly:!0})],Ft.prototype,"statisticsInfo",void 0),u([d({type:Ke.ofType(Number),nonNullable:!0,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.excludeObjectIds",write:{enabled:!0}}})],Ft.prototype,"excludeObjectIds",void 0),u([d({type:String,json:{origins:{service:{read:!1,write:!1}},name:"layerDefinition.definitionExpression",write:{enabled:!0,allowNull:!0}}})],Ft.prototype,"definitionExpression",void 0),u([d({type:tot,json:{name:"layerDefinition.polygonFilter",write:{enabled:!0,allowNull:!0},origins:{service:{read:!1,write:!1}}}})],Ft.prototype,"filter",void 0),u([d({type:String,json:{origins:{"web-scene":{read:!0,write:!0}},read:!1}})],Ft.prototype,"path",void 0),u([d(n2e)],Ft.prototype,"elevationInfo",null),u([d({type:String})],Ft.prototype,"geometryType",null),u([d(EV)],Ft.prototype,"labelsVisible",void 0),u([d({type:[g$],json:{origins:{service:{name:"drawingInfo.labelingInfo",read:{reader:Uk},write:!1}},name:"layerDefinition.drawingInfo.labelingInfo",read:{reader:Uk},write:!0}})],Ft.prototype,"labelingInfo",void 0),u([d(s2e)],Ft.prototype,"legendEnabled",void 0),u([d({type:Number,json:{origins:{"web-document":{default:1,write:{enabled:!0,target:{opacity:{type:Number},"layerDefinition.drawingInfo.transparency":{type:Number}}},read:{source:["opacity","layerDefinition.drawingInfo.transparency"],reader(t,e){if(typeof t=="number"&&t>=0&&t<=1)return t;const r=e.layerDefinition?.drawingInfo?.transparency;return r!==void 0?oA(r):void 0}}},"portal-item":{write:!0},service:{read:!1}}}})],Ft.prototype,"opacity",void 0),u([d({type:["Low","High"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],Ft.prototype,"priority",void 0),u([d({type:["Labels"],readOnly:!0,json:{read:!1,origins:{service:{read:!0}}}})],Ft.prototype,"semantic",void 0),u([d({types:mSe,json:{origins:{service:{read:{source:"drawingInfo.renderer"}}},name:"layerDefinition.drawingInfo.renderer",write:!0},value:null})],Ft.prototype,"renderer",null),u([d({json:{read:!1}})],Ft.prototype,"cachedDrawingInfo",void 0),u([Ae("service","cachedDrawingInfo")],Ft.prototype,"readCachedDrawingInfo",null),u([d({readOnly:!0,json:{read:!1}})],Ft.prototype,"capabilities",null),u([d({type:Boolean,json:{read:!1}})],Ft.prototype,"editingEnabled",null),u([d({readOnly:!0,json:{write:!1,read:!1}})],Ft.prototype,"infoFor3D",null),u([d(SV)],Ft.prototype,"popupEnabled",void 0),u([d({type:aO,json:{name:"popupInfo",write:!0}})],Ft.prototype,"popupTemplate",void 0),u([d({readOnly:!0,json:{read:!1}})],Ft.prototype,"defaultPopupTemplate",null),u([d({type:String,json:{read:!1}})],Ft.prototype,"objectIdField",void 0),u([Ae("service","objectIdField",["objectIdField","fields"])],Ft.prototype,"readObjectIdField",null),u([d({type:String,json:{read:!1}})],Ft.prototype,"globalIdField",void 0),u([Ae("service","globalIdField",["globalIdField","fields"])],Ft.prototype,"readGlobalIdField",null),u([d({readOnly:!0,type:String,json:{read:!1}})],Ft.prototype,"displayField",null),u([d({type:String,json:{read:!1}})],Ft.prototype,"profile",void 0),u([Ae("service","profile",["store.profile"])],Ft.prototype,"readProfile",null),u([d({readOnly:!0,type:String,json:{origins:{service:{read:{source:"store.normalReferenceFrame"}}},read:!1}})],Ft.prototype,"normalReferenceFrame",void 0),u([d(r2e)],Ft.prototype,"screenSizePerspectiveEnabled",void 0),Ft=u([R("esri.layers.SceneLayer")],Ft);const Kce={"mesh-pyramids":"mesh-pyramids",meshpyramids:"mesh-pyramids","features-meshes":"mesh-pyramids",points:"points","features-points":"points",lines:"lines","features-lines":"lines",polygons:"polygons","features-polygons":"polygons"},jlt={"mesh-pyramids":"mesh",points:"point",lines:"polyline",polygons:"polygon"},iRe=Ft,z8t=Object.freeze(Object.defineProperty({__proto__:null,default:iRe},Symbol.toStringTag,{value:"Module"}));let My=class extends rs(he){constructor(...e){super(...e),this.position=new ht([0,0,0]),this.heading=0,this.tilt=0,this.fov=55}normalizeCtorArgs(e,r,i,s){if(e&&typeof e=="object"&&("x"in e||Array.isArray(e))){const n={position:e};return r!=null&&(n.heading=r),i!=null&&(n.tilt=i),s!=null&&(n.fov=s),n}return e}writePosition(e,r,i,s){const n=e.clone();n.x=wd(e.x||0),n.y=wd(e.y||0),n.z=e.hasZ?wd(e.z||0):e.z,r[i]=n.write({},s)}readPosition(e,r){const i=new ht;return i.read(e,r),i.x=wd(i.x||0),i.y=wd(i.y||0),i.z=i.hasZ?wd(i.z||0):i.z,i}equals(e){return e!=null&&this.tilt===e.tilt&&this.heading===e.heading&&this.fov===e.fov&&this.position.equals(e.position)}};u([d({type:ht,json:{write:{isRequired:!0}}})],My.prototype,"position",void 0),u([Ve("position")],My.prototype,"writePosition",null),u([Ae("position")],My.prototype,"readPosition",null),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),or(t=>z6.normalize(wd(t)))],My.prototype,"heading",void 0),u([d({type:Number,nonNullable:!0,json:{write:{isRequired:!0}}}),or(t=>ye(wd(t),-180,180))],My.prototype,"tilt",void 0),u([d({type:Number,nonNullable:!0,json:{read:!1,write:!1}})],My.prototype,"fov",void 0),My=u([R("esri.Camera")],My);const Zd=My;var FZ;let vv=FZ=class extends he{constructor(t){super(t),this.rotation=0,this.scale=0,this.targetGeometry=null,this.camera=null}castRotation(t){return(t%=360)<0&&(t+=360),t}clone(){return new FZ({rotation:this.rotation,scale:this.scale,targetGeometry:this.targetGeometry!=null?this.targetGeometry.clone():null,camera:this.camera!=null?this.camera.clone():null})}};function Uz(){return{enabled:!this.camera}}u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:Uz}}}}})],vv.prototype,"rotation",void 0),u([or("rotation")],vv.prototype,"castRotation",null),u([d({type:Number,json:{write:!0,origins:{"web-map":{default:0,write:!0},"web-scene":{write:{overridePolicy:Uz}}}}})],vv.prototype,"scale",void 0),u([d({types:nS,json:{read:N1,write:!0,origins:{"web-scene":{read:N1,write:{overridePolicy:Uz}}}}})],vv.prototype,"targetGeometry",void 0),u([d({type:Zd,json:{write:!0}})],vv.prototype,"camera",void 0),vv=FZ=u([R("esri.Viewpoint")],vv);const Nf=vv;function Vf(t){return t?{origin:$i(t.origin),vector:$i(t.vector)}:{origin:C(),vector:C()}}function Hlt(t,e){const r=Wlt.get();return r.origin=t,r.vector=e,r}function G8t(t,e=Vf()){return qlt(t.origin,t.vector,e)}function qlt(t,e,r=Vf()){return oe(r.origin,t),oe(r.vector,e),r}function aT(t,e,r=Vf()){return oe(r.origin,t),pe(r.vector,e,t),r}function xte(t,e){const r=pe(ke.get(),e,t.origin),i=de(t.vector,r),s=de(t.vector,t.vector),n=ye(i/s,0,1),o=pe(ke.get(),ae(ke.get(),t.vector,n),r);return de(o,o)}function j8t(t,e,r){return kZ(t,e,0,1,r)}function H8t(t,e,r){return ue(r,t.origin,ae(r,t.vector,e))}function kZ(t,e,r,i,s){const{vector:n,origin:o}=t,a=pe(ke.get(),e,o),l=de(n,a)/Xa(n);return ae(s,n,ye(l,r,i)),ue(s,s,t.origin)}function q8t(t,e){if(nRe(t,Hlt(e.origin,e.direction),!1,cU)){const{tA:r,pB:i,distance2:s}=cU;if(r>=0&&r<=1)return s;if(r<0)return kn(t.origin,i);if(r>1)return kn(ue(ke.get(),t.origin,t.vector),i)}return null}function sRe(t,e,r){return!!nRe(t,e,!0,cU)&&(oe(r,cU.pA),!0)}function nRe(t,e,r,i){const n=t.origin,o=ue(ke.get(),n,t.vector),a=e.origin,l=ue(ke.get(),a,e.vector),c=ke.get(),h=ke.get();if(c[0]=n[0]-a[0],c[1]=n[1]-a[1],c[2]=n[2]-a[2],h[0]=l[0]-a[0],h[1]=l[1]-a[1],h[2]=l[2]-a[2],Math.abs(h[0])<1e-6&&Math.abs(h[1])<1e-6&&Math.abs(h[2])<1e-6)return!1;const p=ke.get();if(p[0]=o[0]-n[0],p[1]=o[1]-n[1],p[2]=o[2]-n[2],Math.abs(p[0])<1e-6&&Math.abs(p[1])<1e-6&&Math.abs(p[2])<1e-6)return!1;const f=c[0]*h[0]+c[1]*h[1]+c[2]*h[2],m=h[0]*p[0]+h[1]*p[1]+h[2]*p[2],g=c[0]*p[0]+c[1]*p[1]+c[2]*p[2],_=h[0]*h[0]+h[1]*h[1]+h[2]*h[2],v=(p[0]*p[0]+p[1]*p[1]+p[2]*p[2])*_-m*m;if(Math.abs(v)<1e-6)return!1;let b=(f*m-g*_)/v,x=(f+m*b)/_;r&&(b=ye(b,0,1),x=ye(x,0,1));const T=ke.get(),S=ke.get();return T[0]=n[0]+b*p[0],T[1]=n[1]+b*p[1],T[2]=n[2]+b*p[2],S[0]=a[0]+x*h[0],S[1]=a[1]+x*h[1],S[2]=a[2]+x*h[2],i.tA=b,i.tB=x,i.pA=T,i.pB=S,i.distance2=kn(T,S),!0}const cU={tA:0,tB:0,pA:C(),pB:C(),distance2:0},Wlt=new z0(()=>Vf()),Vz=K.getLogger("esri.views.3d.support.geometryUtils.boundedPlane");let Zlt=class{constructor(){this.plane=zr(),this.origin=C(),this.basis1=C(),this.basis2=C()}};const oRe=Zlt;function B0(t=yRe){return{plane:zr(t.plane),origin:$i(t.origin),basis1:$i(t.basis1),basis2:$i(t.basis2)}}function Xlt(t,e,r){const i=act.get();return i.origin=t,i.basis1=e,i.basis2=r,i.plane=Zat(0,0,0,0),t8(i),i}function _S(t,e=B0()){return Tte(t.origin,t.basis1,t.basis2,e)}function Ylt(t,e){oe(e.origin,t.origin),oe(e.basis1,t.basis1),oe(e.basis2,t.basis2),QV(e.plane,t.plane)}function Tte(t,e,r,i=B0()){return oe(i.origin,t),oe(i.basis1,e),oe(i.basis2,r),t8(i),nct(i,"fromValues()"),i}function t8(t){cP(t.basis2,t.basis1,t.origin,t.plane)}function aRe(t,e,r){t!==r&&_S(t,r);const i=ae(ke.get(),P0(t),e);return ue(r.origin,r.origin,i),r.plane[3]-=e,r}function Jlt(t,e,r){return lRe(e,r),aRe(r,Ate(t,t.origin),r),r}function lRe(t,e=B0()){const r=(t[2]-t[0])/2,i=(t[3]-t[1])/2;return ie(e.origin,t[0]+r,t[1]+i,0),ie(e.basis1,r,0,0),ie(e.basis2,0,i,0),bte(0,0,1,0,e.plane),e}function Ste(t,e,r){return!!yS(t.plane,e,r)&&mRe(t,r)}function Qlt(t,e,r){if(Ste(t,e,r))return r;const i=cRe(t,e,ke.get());return ue(r,e.origin,ae(ke.get(),e.direction,_i(e.origin,i)/Oe(e.direction))),r}function cRe(t,e,r){const i=uU.get();gRe(t,e,i,uU.get());let s=Number.POSITIVE_INFINITY;for(const n of Rte){const o=Ote(t,n,r8.get()),a=ke.get();if(Yat(i,o,a)){const l=F0(ke.get(),e.origin,a),c=Math.abs(oo(de(e.direction,l)));c<s&&(s=c,oe(r,a))}}return s===Number.POSITIVE_INFINITY?uRe(t,e,r):r}function uRe(t,e,r){if(Ste(t,e,r))return r;const i=uU.get(),s=uU.get();gRe(t,e,i,s);let n=Number.POSITIVE_INFINITY;for(const o of Rte){const a=Ote(t,o,r8.get()),l=ke.get();if(Jat(i,a,l)){const c=Rat(e,l);if(!HOe(s,l))continue;c<n&&(n=c,oe(r,l))}}return Ete(t,e.origin)<n&&hRe(t,e.origin,r),r}function hRe(t,e,r){const i=elt(t.plane,e,ke.get()),s=kZ(eue(t,t.basis1),i,-1,1,ke.get()),n=kZ(eue(t,t.basis2),i,-1,1,ke.get());return pe(r,ue(ke.get(),s,n),t.origin),r}function dRe(t,e,r){const{origin:i,basis1:s,basis2:n}=t,o=pe(ke.get(),e,i),a=O1(s,o),l=O1(n,o),c=O1(P0(t),o);return ie(r,a,l,c)}function Ete(t,e){const r=dRe(t,e,ke.get()),{basis1:i,basis2:s}=t,n=Oe(i),o=Oe(s),a=Math.max(Math.abs(r[0])-n,0),l=Math.max(Math.abs(r[1])-o,0),c=r[2];return a*a+l*l+c*c}function Klt(t,e){return Math.sqrt(Ete(t,e))}function ect(t,e){let r=Number.NEGATIVE_INFINITY;for(const i of Rte){const s=Ote(t,i,r8.get()),n=xte(s,e);n>r&&(r=n)}return Math.sqrt(r)}function Cte(t,e){return HOe(t.plane,e)&&mRe(t,e)}function tct(t,e,r,i){return sct(t,r,i)}function Ate(t,e){const r=-t.plane[3];return O1(P0(t),e)-r}function rct(t,e,r,i){const s=Ate(t,e),n=ae(oct,P0(t),r-s);return ue(i,e,n),i}function pRe(t,e){return Jr(t.basis1,e.basis1)&&Jr(t.basis2,e.basis2)&&Jr(t.origin,e.origin)}function fRe(t,e,r){return t!==r&&_S(t,r),so(zS,e),Ou(zS,zS),Ne(r.basis1,t.basis1,zS),Ne(r.basis2,t.basis2,zS),Ne(r.plane,t.plane,zS),Ne(r.origin,t.origin,e),RZ(r.plane,r.plane,r.origin),r}function ict(t,e,r,i){return t!==i&&_S(t,i),Th(zz,e,r),Ne(i.basis1,t.basis1,zz),Ne(i.basis2,t.basis2,zz),t8(i),i}function P0(t){return t.plane}function sct(t,e,r){switch(e){case vu.X:oe(r,t.basis1),_e(r,r);break;case vu.Y:oe(r,t.basis2),_e(r,r);break;case vu.Z:oe(r,P0(t))}return r}function mRe(t,e){const r=pe(ke.get(),e,t.origin),i=Xa(t.basis1),s=Xa(t.basis2),n=de(t.basis1,r),o=de(t.basis2,r);return-n-i<0&&n-i<0&&-o-s<0&&o-s<0}function eue(t,e){const r=r8.get();return oe(r.origin,t.origin),oe(r.vector,e),r}function Ote(t,e,r){const{basis1:i,basis2:s,origin:n}=t,o=ae(ke.get(),i,e.origin[0]),a=ae(ke.get(),s,e.origin[1]);ue(r.origin,o,a),ue(r.origin,r.origin,n);const l=ae(ke.get(),i,e.direction[0]),c=ae(ke.get(),s,e.direction[1]);return ae(r.vector,ue(l,l,c),2),r}function nct(t,e){Math.abs(de(t.basis1,t.basis2)/(Oe(t.basis1)*Oe(t.basis2)))>1e-6&&Vz.warn(e,"Provided basis vectors are not perpendicular"),Math.abs(de(t.basis1,P0(t)))>1e-6&&Vz.warn(e,"Basis vectors and plane normal are not perpendicular"),Math.abs(-de(P0(t),t.origin)-t.plane[3])>1e-6&&Vz.warn(e,"Plane offset is not consistent with plane origin")}function gRe(t,e,r,i){const s=P0(t);cP(s,e.direction,e.origin,r),cP(r,s,e.origin,i)}const yRe={plane:zr(),origin:Ee(0,0,0),basis1:Ee(1,0,0),basis2:Ee(0,1,0)},uU=new z0(zr),r8=new z0(Vf),oct=C(),act=new z0(()=>B0()),Rte=[{origin:[-1,-1],direction:[1,0]},{origin:[1,-1],direction:[0,1]},{origin:[1,1],direction:[-1,0]},{origin:[-1,1],direction:[0,-1]}],zS=xe(),zz=xe(),lct=Object.freeze(Object.defineProperty({__proto__:null,BoundedPlaneClass:oRe,UP:yRe,altitudeAt:Ate,axisAt:tct,closestPoint:uRe,closestPointOnSilhouette:cRe,copy:_S,copyWithoutVerify:Ylt,create:B0,distance:Klt,distance2:Ete,distanceToSilhouette:ect,elevate:aRe,equals:pRe,extrusionContainsPoint:Cte,fromAABoundingRect:lRe,fromValues:Tte,intersectRay:Ste,intersectRayClosestSilhouette:Qlt,normal:P0,projectPoint:hRe,projectPointLocal:dRe,rotate:ict,setAltitudeAt:rct,setExtent:Jlt,transform:fRe,updateUnboundedPlane:t8,wrap:Xlt},Symbol.toStringTag,{value:"Module"}));function cct(t){const{value:e,operations:r}=t;return{operations:r,value:r.create(e)}}function uct(t,e,r){return t.operations.setExtent(t.value,e,r.value),r}function hct(t){return{operations:t,value:t.create()}}function _Re(t,e,r=hct(t)){return r.operations=t,t.copy(e,r.value),r}function dct(t){return _Re(Gat,FOe(0,0,0,Ir(t).radius))}const tue=2**50;function pct(){return _Re(lct,Tte([0,0,0],[tue,0,0],[0,tue,0]))}function fct(t,e,r){return t.operations.axisAt(t.value,e,vu.Z,r)}function mct(t,e,r,i){return t.operations.axisAt(t.value,e,r,i)}function gct(t,e,r){return t.operations.intersectRay(t.value,e,r)}function yct(t,e,r){return t.operations.intersectRayClosestSilhouette(t.value,e,r)}function _ct(t,e){return t.operations.altitudeAt(t.value,e)}function vRe(t,e,r,i){return t.operations.setAltitudeAt(t.value,e,r,i)}function vct(t,e,r,i){return e!==i&&an(i,e),ie(BS,i[12],i[13],i[14]),vRe(t,BS,r,BS),i[12]=BS[0],i[13]=BS[1],i[14]=BS[2],i}function Bz(t,e,r){return t.operations.elevate(t.value,e,r.value)}const BS=C();function rue(t,e,r,i,s){return s[0]=de(t,e),s[1]=de(t,r),s[2]=de(t,i),s}function UZ(t,e,r,i,s){oe(r,t),oe(mD,e),_e(mD,mD),st(i,mD,r),st(s,i,r)}function bct(t,e){return t?Sg(e):e.isGeographic?qe.PlateCarree:e}const mD=C(),Mte=96;function Z8t(t,e){const r=e||t.extent,i=t.width,s=Uo(r&&r.spatialReference);return r&&i?r.width/i*s*bQ*Mte:0}function wct(t,e){return t/(Uo(e)*bQ*Mte)}function xct(t){return t/(bQ*Mte)}const Tct="OBJECTID";let CA=class extends KM{constructor(e){super(e),this.handles.add(this.on("before-add",r=>{r.item!=null&&r.item.parent===this.owner&&(K.getLogger(this).warn("Analysis inside the collection must be unique. Not adding this element again."),r.preventDefault())}))}_own(e){e.parent=this.owner}_release(e){e.parent=null}};CA=u([R("esri.support.AnalysesCollection")],CA);const B4={widthBreakpoint:{getValue(t){const e=t.viewSize[0],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-width-xsmall esri-view-width-less-than-small esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",small:"esri-view-width-small esri-view-width-greater-than-xsmall esri-view-width-less-than-medium esri-view-width-less-than-large esri-view-width-less-than-xlarge",medium:"esri-view-width-medium esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-less-than-large esri-view-width-less-than-xlarge",large:"esri-view-width-large esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-less-than-xlarge",xlarge:"esri-view-width-xlarge esri-view-width-greater-than-xsmall esri-view-width-greater-than-small esri-view-width-greater-than-medium esri-view-width-greater-than-large"}},heightBreakpoint:{getValue(t){const e=t.viewSize[1],r=t.breakpoints,i=this.values;return e<=r.xsmall?i.xsmall:e<=r.small?i.small:e<=r.medium?i.medium:e<=r.large?i.large:i.xlarge},values:{xsmall:"xsmall",small:"small",medium:"medium",large:"large",xlarge:"xlarge"},valueToClassName:{xsmall:"esri-view-height-xsmall esri-view-height-less-than-small esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",small:"esri-view-height-small esri-view-height-greater-than-xsmall esri-view-height-less-than-medium esri-view-height-less-than-large esri-view-height-less-than-xlarge",medium:"esri-view-height-medium esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-less-than-large esri-view-height-less-than-xlarge",large:"esri-view-height-large esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-less-than-xlarge",xlarge:"esri-view-height-xlarge esri-view-height-greater-than-xsmall esri-view-height-greater-than-small esri-view-height-greater-than-medium esri-view-height-greater-than-large"}},orientation:{getValue(t){const e=t.viewSize,r=e[0],i=e[1],s=this.values;return i>=r?s.portrait:s.landscape},values:{portrait:"portrait",landscape:"landscape"},valueToClassName:{portrait:"esri-view-orientation-portrait",landscape:"esri-view-orientation-landscape"}}},Gz={xsmall:544,small:768,medium:992,large:1200};function Sct(t){const e=t;return e&&e.xsmall<e.small&&e.small<e.medium&&e.medium<e.large}function jz(t,e){return e?B4[t].valueToClassName[e].split(" "):[]}const Ect=t=>{let e=class extends t{constructor(...r){super(...r),this._breakpointsHandles=new li,this.orientation=null,this.widthBreakpoint=null,this.heightBreakpoint=null,this.breakpoints=Gz}initialize(){this._breakpointsHandles.add(Q(()=>[this.breakpoints,this.size],()=>this._updateClassNames(),xt))}destroy(){this.destroyed||(this._removeActiveClassNames(),this._breakpointsHandles=Re(this._breakpointsHandles))}set breakpoints(r){if(r===this._get("breakpoints"))return;const i=Sct(r);if(!i){const s=JSON.stringify(Gz,null,2);console.warn("provided breakpoints are not valid, using defaults:"+s)}r=i?r:Gz,this._set("breakpoints",{...r})}_updateClassNames(){if(!this.container)return;const r=pu.acquire(),i=pu.acquire();let s,n=!1;for(s in B4){const o=this[s],a=B4[s].getValue({viewSize:this.size,breakpoints:this.breakpoints});o!==a&&(n=!0,this[s]=a,jz(s,o).forEach(l=>i.push(l)),jz(s,a).forEach(l=>r.push(l)))}n&&(this._applyClassNameChanges(r,i),pu.release(r),pu.release(i))}_applyClassNameChanges(r,i){const s=this.container;s&&(i.forEach(n=>s.classList.remove(n)),r.forEach(n=>s.classList.add(n)))}_removeActiveClassNames(){const r=this.container;if(!r)return;let i;for(i in B4)jz(i,this[i]).forEach(s=>r.classList.remove(s))}};return u([d()],e.prototype,"breakpoints",null),u([d()],e.prototype,"orientation",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),u([d()],e.prototype,"heightBreakpoint",void 0),e=u([R("esri.views.BreakpointsOwner")],e),e};let bv=class extends me{constructor(){super(...arguments),this.items=new Ke,this._watchUpdatingTracking=new vf,this._callbacks=new Map,this._projector=A7(),this._hiddenProjector=A7()}get needsRender(){return this.items.length>0}get updating(){return this._watchUpdatingTracking?.updating??!1}initialize(){const e=document.createElement("div");e.className="esri-overlay-surface",this._set("surface",e),this._hiddenSurface=document.createElement("div"),this._hiddenSurface.setAttribute("style","visibility: hidden;"),e.appendChild(this._hiddenSurface),this._watchUpdatingTracking.addOnCollectionChange(()=>this.items,r=>{for(const i of r.added){const s=()=>i.render();this._callbacks.set(i,s),this._projector.append(this.surface,s)}for(const i of r.removed){const s=this._projector.detach(this._callbacks.get(i));this.surface.removeChild(s.domNode),this._callbacks.delete(i)}})}addItem(e){this.items.add(e)}removeItem(e){this.items.remove(e)}destroy(){this.items.removeAll(),this._callbacks.forEach(e=>this._projector.detach(e)),this._callbacks=null,this._projector=null,this._watchUpdatingTracking.destroy()}render(){this._projector.renderNow()}computeBoundingRect(e){const r=this._hiddenSurface,i=this._hiddenProjector;let s;const n=()=>(s=e.render(),s);i.append(r,n),i.renderNow();const o={left:0,top:0,right:0,bottom:0};if(s&&s.domNode){const a=s.domNode.getBoundingClientRect();o.left=a.left,o.top=a.top,o.right=a.right,o.bottom=a.bottom}for(i.detach(n);r.firstChild;)r.removeChild(r.firstChild);return o}overlaps(e,r){const i=this.computeBoundingRect(e),s=this.computeBoundingRect(r);return Math.max(i.left,s.left)<=Math.min(i.right,s.right)&&Math.max(i.top,s.top)<=Math.min(i.bottom,s.bottom)}get hasVisibleItems(){return this.items.some(e=>e.visible)}async prepare(){await document.fonts.load(this._fontString()).catch(()=>{})}renderCanvas(e){if(!this.items.some(i=>i.visible))return;const r=e.getContext("2d");r.save(),r.font=this._fontString(),this.items.forEach(i=>{r.save(),i.renderCanvas(r),r.restore()}),r.restore()}_fontString(){return`10px ${getComputedStyle(this.surface).fontFamily}`}};u([d({readOnly:!0})],bv.prototype,"surface",void 0),u([d({readOnly:!0})],bv.prototype,"items",void 0),u([d({readOnly:!0})],bv.prototype,"needsRender",null),u([d({readOnly:!0})],bv.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],bv.prototype,"updating",null),bv=u([R("esri.views.overlay.ViewOverlay")],bv);const iue=bv,Hz=[0,0];function Cct(t){const e=(t.ownerDocument||window.document).defaultView,r=t.getBoundingClientRect();return Hz[0]=r.left+(e?.pageXOffset??0),Hz[1]=r.top+(e?.pageYOffset??0),Hz}function sue(t){t&&(Fbe(t),t.parentNode&&t.parentNode.removeChild(t))}function Act(t){const e=document.createElement("div");return t.appendChild(e),e}const uR=16,gD=750,Oct=512,Rct=2,Mct=t=>{let e=class extends t{constructor(...r){super(...r),this._freqInfo={freq:uR,time:gD},this._overlayRenderTaskHandle=null,this.height=0,this.overlay=null,this.position=null,this.resizing=!1,this.root=null,this.surface=null,this.suspended=!0,this.ui=null,this.userContent=null,this.width=0,this.widthBreakpoint=null,this.addHandles([Q(()=>this.cursor,i=>{const{surface:s}=this;s&&s.setAttribute("data-cursor",i)}),Q(()=>this.navigating,i=>{const{surface:s}=this;s&&s.setAttribute("data-navigating",i.toString())})])}initialize(){this.addHandles([Q(()=>this.ui,(r,i)=>this._handleUIChange(r,i),xt),this.on("focus",()=>this.notifyChange("focused")),this.on("blur",()=>this.notifyChange("focused"))])}destroy(){this.destroyed||(this.ui=Re(this.ui),this.container=null)}get container(){return this._get("container")??null}set container(r){const i=this._get("container"),s=G6(r);if(s||typeof r!="string"||K.getLogger(this).error("#container",`element with id '${r}' not found`),i===s)return;if(this._stopMeasuring(),i&&(i.classList.remove("esri-view"),this._overlayRenderTaskHandle&&(this._overlayRenderTaskHandle.remove(),this._overlayRenderTaskHandle=null),this.overlay&&(this.overlay.destroy(),this._set("overlay",null)),this.root&&(sue(this.root),this._set("root",null)),this.userContent&&(Pne(this.userContent,i),sue(this.userContent),this._set("userContent",null))),!s)return this._set("width",0),this._set("height",0),this._set("position",null),this._set("suspended",!0),this._set("surface",null),void this._set("container",null);s.classList.add("esri-view");const n=document.createElement("div");n.className="esri-view-user-storage",Pne(s,n),s.appendChild(n),this._set("userContent",n);const o=document.createElement("div");o.className="esri-view-root",s.insertBefore(o,s.firstChild),this._set("root",o);const a=document.createElement("div");a.className="esri-view-surface",a.setAttribute("role","application"),a.tabIndex=0,o.appendChild(a),this._set("surface",a);const l=new iue;o.appendChild(l.surface),this._set("overlay",l),this.addHandles(Q(()=>l.needsRender,c=>{c&&!this._overlayRenderTaskHandle?this._overlayRenderTaskHandle=QC({render:()=>this.overlay?.render()}):this._overlayRenderTaskHandle=Pi(this._overlayRenderTaskHandle)})),this.forceDOMReadyCycle(),this._set("container",s),this._startMeasuring()}get focused(){const r=document.activeElement===this.surface;return document.hasFocus()&&r}get size(){return[this.width,this.height]}blur(){this.surface?.blur()}focus(){this.surface?.focus()}pageToContainer(r,i,s){const n=this.position;return r-=n?n[0]:0,i-=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}containerToPage(r,i,s){const n=this.position;return r+=n?n[0]:0,i+=n?n[1]:0,s?(s[0]=r,s[1]=i):s=[r,i],s}_handleUIChange(r,i){this.removeHandles("ui"),i&&i!==r&&i.destroy(),r&&(r.view=this,this.addHandles(Q(()=>this.root,s=>{r.container=s?Act(s):null},xt),"ui")),this._set("ui",r)}_stopMeasuring(){this.removeHandles("measuring"),this._get("resizing")&&this._set("resizing",!1)}_startMeasuring(){const r=this._freqInfo;r.freq=uR,r.time=gD,this.addHandles([(()=>{const i=()=>{r.freq=uR,r.time=gD};return window.addEventListener("resize",i),{remove(){window.removeEventListener("resize",i)}}})(),QC({prepare:i=>{const s=this._measure(),n=this._freqInfo;if(n.time+=i.deltaTime,s&&(n.freq=uR,this._get("resizing")||this._set("resizing",!0)),n.time<n.freq)return;n.time=0;const o=this._position();n.freq=o||s?uR:Math.min(gD,n.freq*Rct),!s&&n.freq>=Oct&&this._get("resizing")&&this._set("resizing",!1)}})],"measuring"),this._measure(),this._position()}_measure(){const r=this.container,i=r?r.clientWidth:0,s=r?r.clientHeight:0;if(i===0||s===0)return this.suspended||this._set("suspended",!0),!1;const n=this.width,o=this.height;return i===n&&s===o?(this.suspended&&this._set("suspended",!1),!1):(this._set("width",i),this._set("height",s),this.suspended&&this._set("suspended",!1),this.emit("resize",{oldWidth:n,oldHeight:o,width:i,height:s}),!0)}_position(){const r=this.container,i=this.position,s=r&&Cct(r);return!!s&&(!i||s[0]!==i[0]||s[1]!==i[1])&&(this._set("position",[s[0],s[1]]),!0)}forceDOMReadyCycle(){}};return u([d()],e.prototype,"container",null),u([d({readOnly:!0})],e.prototype,"focused",null),u([d({readOnly:!0})],e.prototype,"height",void 0),u([d({type:iue})],e.prototype,"overlay",void 0),u([d({readOnly:!0})],e.prototype,"position",void 0),u([d({readOnly:!0})],e.prototype,"resizing",void 0),u([d({readOnly:!0})],e.prototype,"root",void 0),u([d({value:null,readOnly:!0})],e.prototype,"size",null),u([d({readOnly:!0})],e.prototype,"surface",void 0),u([d({readOnly:!0})],e.prototype,"suspended",void 0),u([d()],e.prototype,"ui",void 0),u([d({readOnly:!0})],e.prototype,"userContent",void 0),u([d({readOnly:!0})],e.prototype,"width",void 0),u([d()],e.prototype,"widthBreakpoint",void 0),e=u([R("esri.views.DOMContainer")],e),e},Ite=K.getLogger("esri.layers.support.ElevationSampler");let bRe=class{queryElevation(e){return wRe(e.clone(),this)}on(){return Dct}projectIfRequired(e,r){return xRe(e,r)}},Ict=class extends bRe{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){super(),this.tile=e,this.noDataValue=i;const s=e.tile.extent;this.extent=U6(s,r.spatialReference),this.extent.zmin=e.zmin,this.extent.zmax=e.zmax,this._aaExtent=s;const n=Uo(r.spatialReference),o=r.lodAt(e.tile.level).resolution*n;this.demResolution={min:o,max:o}}contains(e){const r=this.projectIfRequired(e,this.spatialReference);return r!=null&&this.containsAt(r.x,r.y)}containsAt(e,r){return V6(this._aaExtent,e,r)}elevationAt(e,r){if(!this.containsAt(e,r)){const i=this.extent,s=`${i.xmin}, ${i.ymin}, ${i.xmax}, ${i.ymax}`;return Ite.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${s})`),this.noDataValue}return this.tile.sample(e,r)??this.noDataValue}},K8t=class extends bRe{get spatialReference(){return this.extent.spatialReference}constructor(e,r,i){let s;super(),typeof r=="number"?(this.noDataValue=r,s=null):(s=r,this.noDataValue=i),this.samplers=s?e.map(o=>new Ict(o,s,this.noDataValue)):e;const n=this.samplers[0];if(n){this.extent=n.extent.clone();const{min:o,max:a}=n.demResolution;this.demResolution={min:o,max:a};for(let l=1;l<this.samplers.length;l++){const c=this.samplers[l];this.extent.union(c.extent),this.demResolution.min=Math.min(this.demResolution.min,c.demResolution.min),this.demResolution.max=Math.max(this.demResolution.max,c.demResolution.max)}}else this.extent=U6(Ht(),s.spatialReference),this.demResolution={min:0,max:0}}elevationAt(e,r){for(const i of this.samplers)if(i.containsAt(e,r))return i.elevationAt(e,r);return Ite.warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler`),this.noDataValue}};function wRe(t,e){const r=xRe(t,e.spatialReference);if(!r)return null;switch(t.type){case"point":Pct(t,r,e);break;case"polyline":$ct(t,r,e);break;case"multipoint":Lct(t,r,e)}return t}function xRe(t,e){if(t==null)return null;const r=t.spatialReference;if(r.equals(e))return t;const i=sS(t,e);return i||Ite.error(`Cannot project geometry spatial reference (wkid:${r.wkid}) to elevation sampler spatial reference (wkid:${e.wkid})`),i}function Pct(t,e,r){t.z=r.elevationAt(e.x,e.y)}function $ct(t,e,r){Zm.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s],o=e.paths[s];for(let a=0;a<n.length;a++){const l=n[a],c=o[a];Zm.x=c[0],Zm.y=c[1],i&&(l[3]=l[2]),l[2]=r.elevationAt(Zm.x,Zm.y)}}t.hasZ=!0}function Lct(t,e,r){Zm.spatialReference=e.spatialReference;const i=t.hasM&&!t.hasZ;for(let s=0;s<t.points.length;s++){const n=t.points[s],o=e.points[s];Zm.x=o[0],Zm.y=o[1],i&&(n[3]=n[2]),n[2]=r.elevationAt(Zm.x,Zm.y)}t.hasZ=!0}const Zm=new ht,Dct={remove(){}};var VZ;let Rm=VZ=class extends he{constructor(t){super(t),this.cols=null,this.level=0,this.levelValue=null,this.origin=null,this.resolution=0,this.rows=null,this.scale=0}clone(){return new VZ({cols:this.cols,level:this.level,levelValue:this.levelValue,resolution:this.resolution,rows:this.rows,scale:this.scale})}};u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Rm.prototype,"cols",void 0),u([d({type:Ki,json:{write:!0}})],Rm.prototype,"level",void 0),u([d({type:String,json:{write:!0}})],Rm.prototype,"levelValue",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Rm.prototype,"origin",void 0),u([d({type:Number,json:{write:!0}})],Rm.prototype,"resolution",void 0),u([d({json:{write:!0,origins:{"web-document":{read:!1,write:!1},"portal-item":{read:!1,write:!1}}}})],Rm.prototype,"rows",void 0),u([d({type:Number,json:{write:!0}})],Rm.prototype,"scale",void 0),Rm=VZ=u([R("esri.layers.support.LOD")],Rm);const sf=Rm;let Nct=class{constructor(e,r,i,s,n=void 0){this.id=e,this.level=r,this.row=i,this.col=s,this.extent=n}};var wv;const nue=new kr({PNG:"png",PNG8:"png8",PNG24:"png24",PNG32:"png32",JPEG:"jpg",JPG:"jpg",DIB:"dib",TIFF:"tiff",EMF:"emf",PS:"ps",PDF:"pdf",GIF:"gif",SVG:"svg",SVGZ:"svgz",Mixed:"mixed",MIXED:"mixed",LERC:"lerc",LERC2D:"lerc2d",RAW:"raw",pbf:"pbf"});let Va=wv=class extends he{static create(t={}){const{resolutionFactor:e=1,scales:r,size:i=256,spatialReference:s=qe.WebMercator,numLODs:n=24}=t;if(!Qa(s)){const p=[];if(r)for(let f=0;f<r.length;f++){const m=r[f];p.push(new sf({level:f,scale:m,resolution:m}))}else{let f=5e-4;for(let m=n-1;m>=0;m--)p.unshift(new sf({level:m,scale:f,resolution:f})),f*=2}return new wv({dpi:96,lods:p,origin:new ht(0,0,s),size:[i,i],spatialReference:s})}const o=T1(s),a=t.origin?new ht({x:t.origin.x,y:t.origin.y,spatialReference:s}):new ht(o?{x:o.origin[0],y:o.origin[1],spatialReference:s}:{x:0,y:0,spatialReference:s}),l=96,c=1/(Uo(s)*39.37*l),h=[];if(r)for(let p=0;p<r.length;p++){const f=r[p],m=f*c;h.push(new sf({level:p,scale:f,resolution:m}))}else{let p=fQ(s)?512/i*5916575275917094e-7:256/i*591657527591555e-6;const f=Math.ceil(n/e);h.push(new sf({level:0,scale:p,resolution:p*c}));for(let m=1;m<f;m++){const g=p/2**e,_=g*c;h.push(new sf({level:m,scale:g,resolution:_})),p=g}}return new wv({dpi:l,lods:h,origin:a,size:[i,i],spatialReference:s})}constructor(t){super(t),this.dpi=96,this.format=null,this.origin=null,this.size=null,this.spatialReference=null}get isWrappable(){const{spatialReference:t,origin:e}=this;if(t&&e){const r=T1(t);return t.isWrappable&&!!r&&Math.abs(r.origin[0]-e.x)<=r.dx}return!1}readOrigin(t,e){return ht.fromJSON({spatialReference:e.spatialReference,...t})}set lods(t){let e=0,r=0;const i=[],s=this._levelToLOD={};t&&(e=-1/0,r=1/0,t.forEach(n=>{i.push(n.scale),e=n.scale>e?n.scale:e,r=n.scale<r?n.scale:r,s[n.level]=n})),this._set("scales",i),this._set("lods",t),this._initializeUpsampleLevels()}readSize(t,e){return[e.cols,e.rows]}writeSize(t,e){e.cols=t[0],e.rows=t[1]}zoomToScale(t){const e=this.scales;if(t<=0)return e[0];if(t>=e.length-1)return e[e.length-1];const r=Math.floor(t),i=r+1;return e[r]/(e[r]/e[i])**(t-r)}scaleToZoom(t){const e=this.scales,r=e.length-1;let i=0;for(;i<r;i++){const s=e[i],n=e[i+1];if(s<=t)return i;if(n===t)return i+1;if(s>t&&n<t)return i+Math.log(s/t)/Math.log(s/n)}return i}snapScale(t,e=.95){const r=this.scaleToZoom(t);return r%Math.floor(r)>=e?this.zoomToScale(Math.ceil(r)):this.zoomToScale(Math.floor(r))}tileAt(t,e,r,i){const s=this.lodAt(t);if(!s)return null;let n,o;if(typeof e=="number")n=e,o=r;else if(Bn(e.spatialReference,this.spatialReference))n=e.x,o=e.y,i=r;else{const c=sS(e,this.spatialReference);if(c==null)return null;n=c.x,o=c.y,i=r}const a=s.resolution*this.size[0],l=s.resolution*this.size[1];return i||(i=new Nct(null,0,0,0,Ht())),i.level=t,i.row=Math.floor((this.origin.y-o)/l+.001),i.col=Math.floor((n-this.origin.x)/a+.001),this.updateTileInfo(i),i}updateTileInfo(t,e=wv.ExtrapolateOptions.NONE){let r=this.lodAt(t.level);if(!r&&e===wv.ExtrapolateOptions.POWER_OF_TWO){const o=this.lods[this.lods.length-1];o.level<t.level&&(r=o)}if(!r)return;const i=t.level-r.level,s=r.resolution*this.size[0]/2**i,n=r.resolution*this.size[1]/2**i;t.id=`${t.level}/${t.row}/${t.col}`,t.extent||(t.extent=Ht()),t.extent[0]=this.origin.x+t.col*s,t.extent[1]=this.origin.y-(t.row+1)*n,t.extent[2]=t.extent[0]+s,t.extent[3]=t.extent[1]+n}upsampleTile(t){const e=this._upsampleLevels[t.level];return!(!e||e.parentLevel===-1)&&(t.level=e.parentLevel,t.row=Math.floor(t.row/e.factor+.001),t.col=Math.floor(t.col/e.factor+.001),this.updateTileInfo(t),!0)}getTileBounds(t,e){const r=this.lodAt(e.level);if(r==null)return null;const{resolution:i}=r,s=i*this.size[0],n=i*this.size[1];return t[0]=this.origin.x+e.col*s,t[1]=this.origin.y-(e.row+1)*n,t[2]=t[0]+s,t[3]=t[1]+n,t}lodAt(t){return this._levelToLOD?.[t]??null}clone(){return wv.fromJSON(this.write({}))}getOrCreateCompatible(t,e){if(this.size[0]===256&&this.size[1]===256)return t===256?this:null;const r=[],i=this.lods.length;for(let s=0;s<i;s++){const n=this.lods[s],o=n.resolution*e;r.push(new sf({level:n.level,scale:n.scale,resolution:o}))}return new wv({size:[t,t],dpi:this.dpi,format:this.format,compressionQuality:this.compressionQuality,origin:this.origin,spatialReference:this.spatialReference,lods:r})}_initializeUpsampleLevels(){const t=this.lods;this._upsampleLevels=[];let e=null;for(let r=0;r<t.length;r++){const i=t[r];this._upsampleLevels[i.level]={parentLevel:e?e.level:-1,factor:e?e.resolution/i.resolution:0},e=i}}};u([d({type:Number,json:{write:!0}})],Va.prototype,"compressionQuality",void 0),u([d({type:Number,json:{write:!0}})],Va.prototype,"dpi",void 0),u([d({type:String,json:{read:nue.read,write:nue.write,origins:{"web-scene":{read:!1,write:!1}}}})],Va.prototype,"format",void 0),u([d({readOnly:!0})],Va.prototype,"isWrappable",null),u([d({type:ht,json:{write:!0}})],Va.prototype,"origin",void 0),u([Ae("origin")],Va.prototype,"readOrigin",null),u([d({type:[sf],value:null,json:{write:!0}})],Va.prototype,"lods",null),u([d({readOnly:!0})],Va.prototype,"scales",void 0),u([d({cast:t=>Array.isArray(t)?t:typeof t=="number"?[t,t]:[256,256]})],Va.prototype,"size",void 0),u([Ae("size",["rows","cols"])],Va.prototype,"readSize",null),u([Ve("size",{cols:{type:Ki},rows:{type:Ki}})],Va.prototype,"writeSize",null),u([d({type:qe,json:{write:!0}})],Va.prototype,"spatialReference",void 0),Va=wv=u([R("esri.layers.support.TileInfo")],Va),function(t){var e;(e=t.ExtrapolateOptions||(t.ExtrapolateOptions={}))[e.NONE=0]="NONE",e[e.POWER_OF_TWO=1]="POWER_OF_TWO"}(Va||(Va={}));const G4=Va,Fct=12;let fu=class sc{constructor(e){const r=sc.checkUnsupported(e);if(r!=null)throw r;const i=e;this.spatialReference=i.spatialReference,this._isWebMercator=this.spatialReference.isWebMercator,this._isGCS=H1(this.spatialReference)||Pg(this.spatialReference)||$g(this.spatialReference),this.origin=[i.origin.x,i.origin.y],this.pixelSize=i.size[0],this.dpi=i.dpi;const s=i.lods.reduce((c,h,p)=>(h.level<c.min&&(c.min=h.level,c.minIndex=p),c.max=Math.max(c.max,h.level),c),{min:1/0,minIndex:0,max:-1/0}),n=i.lods[s.minIndex],o=2**n.level;let a=n.resolution*o,l=n.scale*o;this.levels=new Array(s.max+1);for(let c=0;c<this.levels.length;c++)this.levels[c]={resolution:a,scale:l,tileSize:[a*i.size[0],a*i.size[1]]},a/=2,l/=2}clone(){return new sc(this.toTileInfo())}toTileInfo(){return new G4({dpi:this.dpi,origin:new ht({x:this.origin[0],y:this.origin[1],spatialReference:this.spatialReference}),size:[this.pixelSize,this.pixelSize],spatialReference:this.spatialReference,lods:this.levels.map((e,r)=>new sf({level:r,scale:e.scale,resolution:e.resolution}))})}getExtent(e,r,i,s){const n=this.levels[e],o=n.tileSize[0],a=n.tileSize[1];s[0]=this.origin[0]+i*o,s[2]=this.origin[0]+(i+1)*o,s[3]=this.origin[1]-r*a,s[1]=this.origin[1]-(r+1)*a}convertExtentToRadians(e,r){this._isWebMercator?(r[0]=mne(e[0]),r[1]=K5(e[1]),r[2]=mne(e[2]),r[3]=K5(e[3])):this._isGCS&&(r[0]=zt(e[0]),r[1]=zt(e[1]),r[2]=zt(e[2]),r[3]=zt(e[3]))}getExtentGeometry(e,r,i,s=new vr){return this.getExtent(e,r,i,Kf),s.spatialReference=this.spatialReference,s.xmin=Kf[0],s.ymin=Kf[1],s.xmax=Kf[2],s.ymax=Kf[3],s.zmin=void 0,s.zmax=void 0,s}ensureMaxLod(e){if(e==null)return!1;let r=!1;for(;this.levels.length<=e;){const i=this.levels[this.levels.length-1],s=i.resolution/2;this.levels.push({resolution:s,scale:i.scale/2,tileSize:[s*this.pixelSize,s*this.pixelSize]}),r=!0}return r}capMaxLod(e){this.levels.length>e+1&&(this.levels.length=e+1)}getMaxLod(){return this.levels.length-1}scaleAtLevel(e){return this.levels[0].scale/2**e}levelAtScale(e){const r=this.levels[0].scale;return e>=r?0:Math.log(r/e)*Math.LOG2E}resolutionAtLevel(e){return this.levels[0].resolution/2**e}compatibleWith(e){if(!(e instanceof sc)){if(sc.checkUnsupported(e))return!1;e=new sc(e)}if(!e.spatialReference.equals(this.spatialReference)||e.pixelSize!==this.pixelSize)return!1;const r=Math.min(this.levels.length,e.levels.length)-1,i=this.levels[r].resolution;let s=.5*i;return!a0(e.origin[0],this.origin[0],s)||!a0(e.origin[1],this.origin[1],s)?!1:(s=.5*i/2**r/this.pixelSize*Fct,a0(i,e.levels[r].resolution,s))}rootTilesInExtent(e,r=null,i=1/0){const s=new Array,n=this.levels[0].tileSize;if(e==null||n[0]===0||n[1]===0)return s;sc.computeRowColExtent(e,n,this.origin,Kf);let o=Kf[1],a=Kf[3],l=Kf[0],c=Kf[2];const h=c-l,p=a-o;if(h*p>i){const f=Math.floor(Math.sqrt(i));p>f&&(o=o+Math.floor(.5*p)-Math.floor(.5*f),a=o+f),h>f&&(l=l+Math.floor(.5*h)-Math.floor(.5*f),c=l+f)}for(let f=o;f<a;f++)for(let m=l;m<c;m++)s.push([0,f,m]);return r!=null&&(r[0]=this.origin[0]+l*n[0],r[1]=this.origin[1]-a*n[1],r[2]=this.origin[0]+c*n[0],r[3]=this.origin[1]-o*n[1]),s}static computeRowColExtent(e,r,i,s){const n=.001*(e[2]-e[0]+(e[3]-e[1]));s[0]=Math.max(0,Math.floor((e[0]+n-i[0])/r[0])),s[2]=Math.max(0,Math.ceil((e[2]-n-i[0])/r[0])),s[1]=Math.max(0,Math.floor((i[1]-e[3]+n)/r[1])),s[3]=Math.max(0,Math.ceil((i[1]-e[1]-n)/r[1]))}static isPowerOfTwo(e){const r=e.lods,i=r[0].resolution*2**r[0].level;return!r.some(s=>!A9e(s.resolution,i/2**s.level))}static hasGapInLevels(e){const r=e.lods.map(i=>i.level);r.sort((i,s)=>i-s);for(let i=1;i<r.length;i++)if(r[i]!==r[0]+i)return!0;return!1}static tileSizeSupported(e){const r=e.size[1];return r===e.size[0]&&(r&r-1)==0&&r>=128&&r<=512}static hasOriginPerLODs(e){const r=e.origin;return e.lods.some(i=>i.origin!=null&&(i.origin[0]!==r.x||i.origin[1]!==r.y))}static getMissingTileInfoError(){return new D("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}static checkUnsupported(e){return e==null?Pte():e.lods.length<1?new D("tilingscheme:generic","Tiling scheme must have at least one level"):sc.isPowerOfTwo(e)?sc.hasGapInLevels(e)?new D("tilingscheme:gaps","Tiling scheme levels must not have gaps between min and max level"):sc.tileSizeSupported(e)?sc.hasOriginPerLODs(e)?new D("tilingscheme:multiple-origin","Tiling scheme levels must not have their own origin"):null:new D("tilingscheme:tile-size","Tiles must be square and size must be one of [128, 256, 512]"):new D("tilingscheme:power-of-two","Tiling scheme must be power of two")}static fromExtent(e,r){const i=e[2]-e[0],s=e[3]-e[1],n=Uo(r),o=1.2*Math.max(i,s),a=256,l=96,c=.0254,h=new sc(new G4({size:[a,a],origin:new ht({x:e[0]-.5*(o-i),y:e[3]+.5*(o-s)}),lods:[new sf({level:0,resolution:o/a,scale:1/(a/l*c/(o*n))})],spatialReference:r}));return h.ensureMaxLod(20),h}static makeWebMercatorAuxiliarySphere(e){const r=new sc(sc.WebMercatorAuxiliarySphereTileInfo);return r.ensureMaxLod(e),r}static makeGCSWithTileSize(e,r=256,i=16){const s=256/r,n=new sc(new G4({size:[r,r],origin:new ht({x:-180,y:90,spatialReference:e}),spatialReference:e,lods:[new sf({level:0,resolution:.703125*s,scale:295497598570834e-6*s})]}));return n.ensureMaxLod(i),n}get test(){return{isWebMercator:this._isWebMercator,isGCS:this._isGCS}}};function Pte(){return new D("tilingscheme:tile-info-missing","Tiling scheme must have tiling information")}fu.WebMercatorAuxiliarySphereTileInfo=new G4({size:[256,256],origin:new ht({x:-20037508342787e-6,y:20037508342787e-6,spatialReference:qe.WebMercator}),spatialReference:qe.WebMercator,lods:[new sf({level:0,resolution:156543.03392800014,scale:591657527591555e-6})]}),fu.WebMercatorAuxiliarySphere=fu.makeWebMercatorAuxiliarySphere(19);const Kf=Ht(),tC=64,Y3=512,kct=2.5,uP=O9e(m7/10),TRe=2,SRe=Ht();fu.WebMercatorAuxiliarySphere.getExtent(0,0,0,SRe);const Uct=Ht([-180,-90,180,90]),Vct="Cannot extend surface to encompass all layers because it would result in too many root tiles.",zct="Surface extent is too large for tile resolution at level 0.",Bct=3;let Gct=Bct;function zZ(t){return t<4?3:Gct}let xv=class extends Xr.EventedAccessor{constructor(e){super(e),this.demResolution={min:-1,max:-1},this.noDataValue=uP}initialize(){this.view.basemapTerrain.on("elevation-change",()=>this.emit("changed",{}))}get extent(){const e=this.view.basemapTerrain;if(e==null||e.extent==null||e.spatialReference==null)return null;const r=U6(e.extent,e.spatialReference);return r.zmin=e.visibleElevationBounds.min,r.zmax=e.visibleElevationBounds.max,r}get spatialReference(){return this.view.basemapTerrain?.spatialReference??qe.WGS84}elevationAt(e,r){if(this.extent==null||!Cl(this.extent,e,r)){const i=this.extent!=null?`${this.extent.xmin}, ${this.extent.ymin}, ${this.extent.xmax}, ${this.extent.ymax}`:null;return K.getLogger(this).warn("#elevationAt()",`Point used to sample elevation (${e}, ${r}) is outside of the sampler extent (${i})`),this.noDataValue}return this.view.elevationProvider?.getElevation(e,r,0,this.spatialReference,"ground")??this.noDataValue}queryElevation(e){return wRe(e.clone(),this)}};u([d({readOnly:!0})],xv.prototype,"demResolution",void 0),u([d({readOnly:!0})],xv.prototype,"extent",null),u([d({readOnly:!0})],xv.prototype,"noDataValue",void 0),u([d()],xv.prototype,"spatialReference",null),u([d({constructOnly:!0})],xv.prototype,"view",void 0),xv=u([R("esri.views.support.GroundViewElevationSampler")],xv);const jct=xv;let Tv=class extends me{constructor(e){super(e),this.view=null,this.layerViews=new Ke}initialize(){this.addHandles(No(()=>this.view?.map?.ground,e=>e.load())),this.addHandles(this.layerViews.on("after-changes",()=>this._layerViewsAfterChangesHandler()))}destroy(){this.removeAllHandles(),this._set("view",null);for(const e of this.layerViews)e.destroy();this.layerViews.length=0}get elevationSampler(){return this.view?this.view.type==="2d"?null:this.view.ready&&this.view.basemapTerrain&&this.view.basemapTerrain.ready?new jct({view:this.view}):null:null}get updating(){return!this.suspended&&this.layerViews.some(e=>e.updating)}get suspended(){return!this.view||this.view.suspended}_layerViewsAfterChangesHandler(){this.removeHandles("updating"),this.addHandles(this.layerViews.map(e=>Q(()=>e.updating,()=>this._updateUpdating(),Rr)).toArray(),"updating"),this._updateUpdating()}_updateUpdating(){this.notifyChange("updating")}};u([d({readOnly:!0})],Tv.prototype,"elevationSampler",null),u([d({type:Boolean,readOnly:!0})],Tv.prototype,"updating",null),u([d({constructOnly:!0})],Tv.prototype,"view",void 0),u([d({type:Ke,readOnly:!0})],Tv.prototype,"layerViews",void 0),u([d({readOnly:!0})],Tv.prototype,"suspended",null),Tv=u([R("esri.views.GroundView")],Tv);const Hct=Tv;function em(t){return t!=null&&"open"in t&&"declaredClass"in t}function oue(t){return t!=null&&"declaredClass"in t&&"dockOptions"in t}const qct=t=>{let e=class extends t{constructor(){super(...arguments),this._popupSetupTask=null,this.popup={},this.popupEnabled=!0}initialize(){this.addHandles([Q(()=>[this.ui,this.popup],([r,i],s)=>{const n="popup",o="manual";if(s){const[a,l]=s;a&&em(l)&&(l.view=null,oue(l)&&a.remove(l,n))}r&&em(i)&&(i.view=this,oue(i)&&r.add(i,{key:n,position:o,internal:!0}))},xt),this.on("click",r=>{this.popup&&this.popupEnabled&&(r.pointerType!=="mouse"||r.button===0)&&(!em(this.popup)&&"autoOpenEnabled"in this.popup&&this.popup.autoOpenEnabled===!1||(em(this.popup)?this.popup.viewModel.handleViewClick(r):r.async(async()=>{await this.setupPopup(),em(this.popup)&&!this.destroyed&&this.ready&&this.popupEnabled&&this.popup.viewModel.handleViewClick(r)})))},fs.WIDGET)]),Pn(()=>this.ready&&this.popupEnabled&&!this.updating).then(()=>{J(()=>import("./Popup-1554bc86.js").then(r=>r.a0),["./Popup-1554bc86.js","./utils-57c6a919.js","./executeQueryJSON-d846aaae.js","./query-2f8589ea.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js"],import.meta.url)})}destroy(){this.destroyed||this.closePopup()}async openPopup(r){em(this.popup)&&this.popup.open(r);try{if(await this.setupPopup(),!this.popup)return void K.getLogger(this).error(new D("view:null-popup","Popup is null and can't be opened"));this.popup.open(r)}catch{}}closePopup(){this._popupSetupTask?.abort(),em(this.popup)&&this.popup.close()}async fetchPopupFeatures(r,i){await this.when();const{location:s,queryArea:n,layerViewsAndGraphics:o,clientOnlyGraphics:a}=await this._prepareFetchPopupFeatures(r,i),l=Promise.resolve(a),c=this._queryLayerPopupFeatures(n,o,i),h=c.map(p=>p.promise);return{location:s,clientOnlyGraphics:a,allGraphicsPromise:L5([l,...h]).then(p=>Array.from(new Set(p.flat()))),promisesPerLayerView:c}}async setupPopup(){if(this._popupSetupTask?.abort(),this.popup&&!em(this.popup))return this._popupSetupTask=hb(async r=>{const{default:i}=await J(()=>import("./Popup-1554bc86.js").then(n=>n.a0),["./Popup-1554bc86.js","./utils-57c6a919.js","./executeQueryJSON-d846aaae.js","./query-2f8589ea.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js"],import.meta.url);if(Dt(r),!this.popup||em(this.popup))return;const s=this.popup;delete s.open,delete s.close,this.popup=new i(s)}),this._popupSetupTask.promise}_queryLayerPopupFeatures(r,i,s){return i.map(({layerView:n,graphics:o})=>{const a={clientGraphics:o,event:s?.event,signal:s?.signal,defaultPopupTemplateEnabled:s!=null&&!!s.defaultPopupTemplateEnabled},l=n.fetchPopupFeatures(r,a);return{layerView:n,promise:l}})}_isValidPopupGraphic(r,i){return r&&!!r.getEffectivePopupTemplate(i!=null&&i.defaultPopupTemplateEnabled)}async _prepareFetchPopupFeatures(r,i){const{clientGraphics:s,queryArea:n,location:o}=await this._popupHitTestGraphics(r,i),a=this._getFetchPopupLayerViews(),{layerViewsAndGraphics:l,clientOnlyGraphics:c}=this._graphicsPerFetchPopupLayerView(s,a);return{clientOnlyGraphics:c,layerViewsAndGraphics:l,queryArea:n,location:o}}async _popupHitTestGraphics(r,i){const s=await this.popupHitTest(r),n=s.results,o=s.mapPoint,a=n.filter(c=>c.type==="graphic"&&this._isValidPopupGraphic(c.graphic,i)),l=a.length?a[0].mapPoint:null;return{clientGraphics:a.map(c=>c.graphic),queryArea:o,location:o||l}}_getFetchPopupLayerViews(){const r=[];return this.allLayerViews.forEach(i=>{this._isValidPopupLayerView(i)&&r.push(i)}),this.graphicsView!=null&&this._isValidPopupLayerView(this.graphicsView)&&r.push(this.graphicsView),r.reverse()}_isValidPopupLayerView(r){return r!=null&&(!("layer"in r)||!r.suspended)&&"fetchPopupFeatures"in r}_graphicsPerFetchPopupLayerView(r,i){const s=[],n=new Map,o=i.map(a=>{const l=[];return"layer"in a?n.set(a.layer,l):n.set(a.graphics,l),{layerView:a,graphics:l}});for(const a of r){const l=n.get(a.layer)||n.get(a.sourceLayer)||null;l?l.push(a):s.push(a)}return{layerViewsAndGraphics:o,clientOnlyGraphics:s}}};return u([d({cast(r){return!r||em(r)||typeof r=="object"&&(r.open=i=>(z1(K.getLogger(this),"view.popup is no longer created by default. view.popup.open() will stop working when the popup isn't created",{replacement:"Use view.openPopup() instead.",version:"4.27"}),this.openPopup(i)),r.close=()=>(z1(K.getLogger(this),"view.popup is no longer created by default. view.popup.close() will stop working when the popup isn't created",{replacement:"Use view.closePopup() instead.",version:"4.27"}),this.closePopup())),r}})],e.prototype,"popup",void 0),u([d()],e.prototype,"popupEnabled",void 0),e=u([R("esri.views.PopupView")],e),e};let Sv=class extends me{constructor(e){super(e),this.view=null,this.baseLayerViews=new Ke,this.referenceLayerViews=new Ke,this._loadingHandle=Q(()=>this.view?.map?.basemap,r=>{r&&r.load().catch(()=>{})},xt)}destroy(){this._set("view",null),this._loadingHandle&&(this._loadingHandle.remove(),this._loadingHandle=null);for(const e of this.baseLayerViews)e.destroy();this.baseLayerViews.length=0;for(const e of this.referenceLayerViews)e.destroy();this.referenceLayerViews.length=0}get suspended(){return!this.view||this.view.suspended}get updating(){if(this.view&&this.view.suspended)return!1;const e=this.view?.map?.basemap;return!!e&&!!e.loaded&&(this.baseLayerViews.some(r=>r.updating)||this.referenceLayerViews.some(r=>r.updating))}};u([d({constructOnly:!0})],Sv.prototype,"view",void 0),u([d({readOnly:!0})],Sv.prototype,"baseLayerViews",void 0),u([d({readOnly:!0})],Sv.prototype,"referenceLayerViews",void 0),u([d({readOnly:!0})],Sv.prototype,"suspended",null),u([d({type:Boolean,readOnly:!0})],Sv.prototype,"updating",null),Sv=u([R("esri.views.BasemapView")],Sv);function Wct(t){return"tryRecycleWith"in t}let Zct=class{constructor(e,r,i){this.layer=e,this.view=r,this.layerViewImporter=i,this._controller=new AbortController,this._deferred=nn(),this._started=!1,this.done=!1,this.promise=this._deferred.promise,xn(this._controller.signal,()=>{const s=new D("cancelled:layerview-create","layerview creation cancelled",{layer:e});this._deferred.reject(s)})}tryRecycle(e){if(!this.done||!this.layerView||!Wct(this.layerView))return null;const r=this.layer.type,i=this._controller.signal;for(let s=0;s<e.length;s++){const n=e[s];if(n.type!==r)continue;const o=this.layerView.tryRecycleWith(n,{signal:i});if(o){e.splice(s,1),this.layer=n;const a=this.layerView,l=a.view;return this.promise=Promise.race([o.then(()=>(Dt(this._controller.signal),n.emit("layerview-destroy",{view:l,layerView:a}),l.emit("layerview-destroy",{view:l,layerView:a}),n.emit("layerview-create",{view:l,layerView:a}),l.emit("layerview-create",{view:l,layerView:a}),a)),new Promise((c,h)=>xn(this._controller.signal,()=>h(Tr())))]),this.promise}}return null}destroy(){this._controller.abort();const{layerView:e}=this;if(e){const{layer:r,view:i}=this;r.emit("layerview-destroy",{view:i,layerView:e}),i.emit("layerview-destroy",{layer:r,layerView:e})}this.done=!0,this.layer=null,this.layerView=null,this.view=null,this.layerViewImporter=null,this._map=null}async start(){if(this._started)return;this._started=!0;const{_controller:{signal:e},layer:r,view:i}=this;this._map=i.map;try{let s,n;if(await r.load({signal:e}),"prefetchResources"in r&&await r.prefetchResources?.({signal:e}),Yct(r))s=await r.createLayerView(i,{signal:e});else{if(!this.layerViewImporter.hasLayerViewModule(r))throw new D("layer:view-not-supported","No layerview implementation was found");const l=await this.layerViewImporter.importLayerView(r);Dt(e),s="default"in l?new l.default({layer:r,view:i}):new l({layer:r,view:i})}const o=()=>{n=Pi(n),s.destroyed||s.destroy(),s.layer=null,s.parent=null,s.view=null,this.done=!0};n=xn(e,o),Dt(e);try{await s.when()}catch(l){throw o(),l}if(!this._map?.allLayers?.includes(r))return o(),void this._deferred.reject(new D("view:no-layerview-for-layer","The layer has been removed from the map",{layer:r}));this.layerView=s,r.emit("layerview-create",{view:i,layerView:s}),i.emit("layerview-create",{layer:r,layerView:s}),this.done=!0,this._deferred.resolve(s)}catch(s){r.emit("layerview-create-error",{view:i,error:s}),i.emit("layerview-create-error",{layer:r,error:s}),this.done=!0,this._deferred.reject(new D("layerview:create-error","layerview creation failed",{layer:r,error:s}))}}},td=class extends me{constructor(e){super(e),this._layerLayerViewInfoMap=new Map,this._recyclingInfoMap=new Map,this._watchUpdatingTracking=new vf,this.supportsGround=!0,this._preloadLayerViewModules=()=>{const r=this.view.map?.allLayers;if(r)for(const i of r)this.layerViewImporter.hasLayerViewModule(i)&&this.layerViewImporter.importLayerView(i)},this._reschedule=()=>this.destroyed?Promise.reject():(this._workPromise==null&&(this._workPromise=nn(),this._workPromise.promise.catch(()=>{})),this.removeHandles("reschedule"),this.addHandles(iO(this._doWork),"reschedule"),this._workPromise.promise),this._doWork=()=>{if(this.destroyed)return;const r=this.view.map;if(this._map!==r&&(this.clear(),this._map=r),this._workPromise==null)return void this.notifyChange("updating");this.removeHandles("reschedule"),this.removeHandles("collection-change");const i=new Set,s=[],n=this.view.ready,o=l=>{if(l!=null){for(const c of l)if(c){i.add(c);const h=this._layerLayerViewInfoMap.get(c);h&&n?h.start():h||this._recyclingInfoMap.has(c)||s.push(c),"layers"in c&&c.layers&&o(c.layers)}}};for(const l of this._rootCollectionNames)o(this.get(l));for(const[l,c]of this._layerLayerViewInfoMap)if(!i.has(l)){this._layerLayerViewInfoMap.delete(c.layer);const h=c.tryRecycle(s);h?(this.notifyChange("updating"),this._recyclingInfoMap.set(c.layer,c),h.then(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(c.layer),this._layerLayerViewInfoMap.set(c.layer,c),this._reschedule()}).catch(()=>{this.notifyChange("updating"),this._recyclingInfoMap.delete(c.layer),c.destroy(),this._reschedule()})):c.destroy()}for(const[l,c]of this._recyclingInfoMap)i.has(l)||(this.notifyChange("updating"),this._recyclingInfoMap.delete(c.layer),c.destroy());for(const l of s)this._createLayerView(l);this._refreshCollections();const a=[r?.ground?.layers,r?.basemap?.baseLayers,r?.basemap?.referenceLayers,r?.layers].filter(l=>!!l);i.forEach(l=>"layers"in l&&a.push(l.layers)),this.addHandles(a.map(l=>this._watchUpdatingTracking.addOnCollectionChange(()=>l,this._reschedule)),"collection-change"),this._workPromise.resolve(),this._workPromise=null}}initialize(){this.own([Vs(()=>this.view?.map?.allLayers,"change",this._preloadLayerViewModules,{onListenerAdd:this._preloadLayerViewModules}),Q(()=>{const e=this.view,r=e?.map;return[r?.basemap,r?.ground,r?.layers,e?.ready]},()=>this._reschedule(),Ri)]),this._preloadLayerViewModules(),this._reschedule()}destroy(){this.clear(),Mz(this._recyclingInfoMap),Mz(this._layerLayerViewInfoMap),this._watchUpdatingTracking.destroy(),this._map=null,this._workPromise!=null&&(this._workPromise.reject(Tr()),this._workPromise=null)}get _layersToLayerViews(){const e=[["view.map.basemap.baseLayers","view.basemapView.baseLayerViews"],["view.map.layers","view.layerViews"],["view.map.basemap.referenceLayers","view.basemapView.referenceLayerViews"]];return this.supportsGround&&e.push(["view.map.ground.layers","view.groundView.layerViews"]),new Map(e)}get _rootCollectionNames(){return Array.from(this._layersToLayerViews.keys())}get updating(){return this._workPromise!=null||this._watchUpdatingTracking.updating||ra(this._layerLayerViewInfoMap,e=>!e.done)||this._recyclingInfoMap.size>0}get updatingRemaining(){let e=0;for(const r of this._layerLayerViewInfoMap.values())r.done||++e;return e}clear(){this.destroyed||(Mz(this._layerLayerViewInfoMap),this._refreshCollections())}async whenLayerView(e){if(await this._reschedule(),!this._layerLayerViewInfoMap.has(e)){if(this._recyclingInfoMap.has(e))return this._recyclingInfoMap.get(e).promise;throw new D("view:no-layerview-for-layer","No layerview has been found for the layer",{layer:e})}return this._layerLayerViewInfoMap.get(e).promise}_refreshCollections(){for(const[e,r]of this._layersToLayerViews)this._populateLayerViewsOwners(this.get(e),this.get(r),this.view);this.notifyChange("updating"),this.notifyChange("updatingRemaining")}_populateLayerViewsOwners(e,r,i){if(!e||!r)return void(r&&r.removeAll());let s=0;for(const n of e){const o=this._layerLayerViewInfoMap.get(n);if(!o||!o.layerView)continue;const a=o.layerView;a.layer=n,a.parent=i,r.at(s)!==a&&r.splice(s,0,a),n.layers&&this._populateLayerViewsOwners(n.layers,a.layerViews,a),s+=1}s<r.length&&r.splice(s,r.length)}_createLayerView(e){e.load().catch(()=>{}),this.layerViewImporter.hasLayerViewModule(e)&&this.layerViewImporter.importLayerView(e);const r=new Zct(e,this.view,this.layerViewImporter);r.promise.then(()=>this._refreshCollections(),i=>{i&&(ws(i)||i.name==="cancelled:layerview-create")||K.getLogger(this).error(`Failed to create layerview for layer title:'${e.title??"no title"}', id:'${e.id??"no id"}' of type '${e.type}'.`,{layer:e,error:i}),this._refreshCollections()}),this._layerLayerViewInfoMap.set(e,r),this.view.ready&&r.start(),this.notifyChange("updating"),this.notifyChange("updatingRemaining")}};u([d()],td.prototype,"_workPromise",void 0),u([d({readOnly:!0})],td.prototype,"_watchUpdatingTracking",void 0),u([d({readOnly:!0})],td.prototype,"_layersToLayerViews",null),u([d({readOnly:!0})],td.prototype,"_rootCollectionNames",null),u([d()],td.prototype,"layerViewImporter",void 0),u([d()],td.prototype,"supportsGround",void 0),u([d({readOnly:!0})],td.prototype,"updating",null),u([d({readOnly:!0})],td.prototype,"updatingRemaining",null),u([d({constructOnly:!0})],td.prototype,"view",void 0),td=u([R("esri.views.LayerViewManager")],td);const Xct=td;function Yct(t){return"createLayerView"in t&&t.createLayerView!=null}let Zu=class extends me{constructor(e){super(e),this.factor=1.5,this.offset=xh(0,0),this.position=null,this.size=120,this.maskUrl=null,this.maskEnabled=!0,this.overlayUrl=null,this.overlayEnabled=!0,this.visible=!0}get version(){return this.commitProperty("factor"),this.commitProperty("offset"),this.commitProperty("position"),this.commitProperty("visible"),this.commitProperty("size"),this.commitProperty("maskUrl"),this.commitProperty("maskEnabled"),this.commitProperty("overlayUrl"),this.commitProperty("overlayEnabled"),(this._get("version")||0)+1}};u([d({type:Number})],Zu.prototype,"factor",void 0),u([d({nonNullable:!0})],Zu.prototype,"offset",void 0),u([d()],Zu.prototype,"position",void 0),u([d({type:Number,range:{min:0}})],Zu.prototype,"size",void 0),u([d()],Zu.prototype,"maskUrl",void 0),u([d()],Zu.prototype,"maskEnabled",void 0),u([d()],Zu.prototype,"overlayUrl",void 0),u([d()],Zu.prototype,"overlayEnabled",void 0),u([d({readOnly:!0})],Zu.prototype,"version",null),u([d({type:Boolean})],Zu.prototype,"visible",void 0),Zu=u([R("esri.views.Magnifier")],Zu);const ERe=Zu;let Jct=class{constructor(){this._tasks=new Array,this._running=aP(!1)}get length(){return this._tasks.length}get running(){return this._running.value}destroy(){this.cancelAll()}runTask(e){for(;!e.done&&this._process(e);)e.madeProgress()}push(e,r,i){return this._running.value=!0,new Promise((s,n)=>this._tasks.push(new aue(s,n,e,r,i)))}unshift(e,r,i){return this._running.value=!0,new Promise((s,n)=>this._tasks.unshift(new aue(s,n,e,r,i)))}_process(e){if(this._tasks.length===0)return!1;const r=this._tasks.shift();try{const i=dn(r.signal);if(i&&!r.abortCallback)r.reject(Tr());else{const s=i?r.abortCallback?.(Tr()):r.callback(e);Rh(s)?s.then(r.resolve,r.reject):r.resolve(s)}}catch(i){r.reject(i)}return this._running.value=this._tasks.length>0,!0}cancelAll(){const e=Tr();for(const r of this._tasks)if(r.abortCallback){const i=r.abortCallback(e);r.resolve(i)}else r.reject(e);this._tasks.length=0,this._running.value=!1}},aue=class{constructor(e,r,i,s=void 0,n=void 0){this.resolve=e,this.reject=r,this.callback=i,this.signal=s,this.abortCallback=n}},J3=class extends me{constructor(){super(...arguments),this.SCHEDULER_LOG_SLOW_TASKS=!1,this.FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES=!1}};u([d()],J3.prototype,"SCHEDULER_LOG_SLOW_TASKS",void 0),u([d()],J3.prototype,"FEATURE_SERVICE_SNAPPING_SOURCE_TILE_TREE_SHOW_TILES",void 0),J3=u([R("esri.views.support.DebugFlags")],J3);const Qct=new J3;var Br;(function(t){t[t.ANIMATING=0]="ANIMATING",t[t.INTERACTING=1]="INTERACTING",t[t.IDLE=2]="IDLE"})(Br||(Br={}));function Kct(){return new hU.Scheduler}var Pa,gt;(function(t){t[t.YIELD=1]="YIELD"})(Pa||(Pa={})),function(t){t.RESOURCE_CONTROLLER_IMMEDIATE="immediate",t.RESOURCE_CONTROLLER="schedule",t.SLIDE="slide",t.STREAM_DATA_LOADER="stream loader",t.ELEVATION_QUERY="elevation query",t.TERRAIN_SURFACE="terrain",t.SURFACE_GEOMETRY_UPDATES="surface geometry updates",t.LOD_RENDERER="LoD renderer",t.GRAPHICS_CORE="Graphics3D",t.I3S_CONTROLLER="I3S",t.POINT_CLOUD_LAYER="point cloud",t.FEATURE_TILE_FETCHER="feature fetcher",t.OVERLAY="overlay",t.STAGE="stage",t.GRAPHICS_DECONFLICTOR="graphics deconflictor",t.FILTER_VISIBILITY="Graphics3D filter visibility",t.SCALE_VISIBILITY="Graphics3D scale visibility",t.FRUSTUM_VISIBILITY="Graphics3D frustum visibility",t.POINT_OF_INTEREST_FREQUENT="POI frequent",t.POINT_OF_INTEREST_INFREQUENT="POI infrequent",t.LABELER="labeler",t.FEATURE_QUERY_ENGINE="feature query",t.FEATURE_TILE_TREE="feature tile tree",t.FEATURE_TILE_TREE_ACTIVE="fast feature tile tree",t.ELEVATION_ALIGNMENT="elevation alignment",t.TEXT_TEXTURE_ATLAS="text texture atlas",t.TEXTURE_UNLOAD="texture unload",t.LINE_OF_SIGHT_TOOL="line of sight tool",t.LINE_OF_SIGHT_TOOL_INTERACTIVE="interactive line of sight tool",t.ELEVATION_PROFILE="elevation profile",t.SNAPPING="snapping",t.SHADOW_ACCUMULATOR="shadow accumulator",t.CLOUDS_GENERATOR="clouds generator",t[t.NONE=0]="NONE",t[t.TEST_PRIO=1]="TEST_PRIO"}(gt||(gt={}));const Bm=0,lue=new Map([[gt.RESOURCE_CONTROLLER_IMMEDIATE,Bm],[gt.RESOURCE_CONTROLLER,4],[gt.SLIDE,Bm],[gt.STREAM_DATA_LOADER,Bm],[gt.ELEVATION_QUERY,Bm],[gt.TERRAIN_SURFACE,1],[gt.SURFACE_GEOMETRY_UPDATES,1],[gt.LOD_RENDERER,2],[gt.GRAPHICS_CORE,2],[gt.I3S_CONTROLLER,2],[gt.POINT_CLOUD_LAYER,2],[gt.FEATURE_TILE_FETCHER,2],[gt.OVERLAY,4],[gt.STAGE,4],[gt.GRAPHICS_DECONFLICTOR,4],[gt.FILTER_VISIBILITY,4],[gt.SCALE_VISIBILITY,4],[gt.FRUSTUM_VISIBILITY,4],[gt.CLOUDS_GENERATOR,4],[gt.POINT_OF_INTEREST_FREQUENT,6],[gt.POINT_OF_INTEREST_INFREQUENT,30],[gt.LABELER,8],[gt.FEATURE_QUERY_ENGINE,8],[gt.FEATURE_TILE_TREE,16],[gt.FEATURE_TILE_TREE_ACTIVE,Bm],[gt.ELEVATION_ALIGNMENT,12],[gt.TEXT_TEXTURE_ATLAS,12],[gt.TEXTURE_UNLOAD,12],[gt.LINE_OF_SIGHT_TOOL,16],[gt.LINE_OF_SIGHT_TOOL_INTERACTIVE,Bm],[gt.SNAPPING,Bm],[gt.SHADOW_ACCUMULATOR,30]]);function cue(t){return lue.has(t)?lue.get(t):typeof t=="number"?t:1}const uue=6.5,hue=1,eut=30,due=1e3/30,pue=100,fue=.9;var hU,Ib;(function(t){class e{get updating(){return this._updating.value}_updatingChanged(){this._updating.value=this._tasks.some(n=>n.needsUpdate)}constructor(){this._updating=aP(!0),this._microTaskQueued=!1,this._frameNumber=0,this.performanceInfo={total:new r0("total"),tasks:new Map},this._frameTaskTimes=new Map,this._budget=new i,this._state=Br.INTERACTING,this._tasks=new qt,this._runQueue=new qt,this._load=0,this._idleStateCallbacks=new qt,this._idleUpdatesStartFired=!1,this._forceTask=!1,this._debug=!1,this._debugHandle=Q(()=>Qct.SCHEDULER_LOG_SLOW_TASKS,o=>this._debug=o,xt);for(const o of Object.keys(gt))this.performanceInfo.tasks.set(gt[o],new r0(gt[o]));const n=this;this._test={FRAME_SAFETY_BUDGET:uue,INTERACTING_BUDGET:due,IDLE_BUDGET:pue,get availableBudget(){return n._budget.budget},usedBudget:0,getBudget:()=>n._budget,setBudget:o=>n._budget=o,updateTask:o=>this._updateTask(o),getState:o=>this._getState(o),getRuntime:o=>this._getRuntime(o),frameTaskTimes:this._frameTaskTimes,resetRuntimes:()=>this._resetRuntimes(),getRunning:()=>this._getRunning()}}destroy(){this._tasks.toArray().forEach(n=>n.remove()),this._tasks.clear(),Pi(this._debugHandle),this._microTaskQueued=!1,this._updatingChanged()}taskRunningChanged(n){this._updatingChanged(),n&&this._budget.remaining>0&&!this._microTaskQueued&&(this._microTaskQueued=!0,queueMicrotask(()=>{this._microTaskQueued&&(this._microTaskQueued=!1,this._budget.remaining>0&&this._schedule()&&this.frame())}))}registerTask(n,o){const a=cue(n),l=new r(this,n,o,a);return this._tasks.push(l),this._updatingChanged(),this.performanceInfo.tasks.has(n)||this.performanceInfo.tasks.set(n,new r0(n)),l}registerIdleStateCallbacks(n,o){const a={idleBegin:n,idleEnd:o};this._idleStateCallbacks.push(a),this.state===Br.IDLE&&this._idleUpdatesStartFired&&a.idleBegin();const l=this;return{remove:()=>this._removeIdleStateCallbacks(a),set idleBegin(c){l._idleUpdatesStartFired&&(a.idleEnd(),l._state===Br.IDLE&&c()),a.idleBegin=c},set idleEnd(c){a.idleEnd=c}}}get load(){return this._load}set state(n){this._state!==n&&(this._state=n,this.state!==Br.IDLE&&this._idleUpdatesStartFired&&(this._idleUpdatesStartFired=!1,this._idleStateCallbacks.forAll(o=>o.idleEnd())))}get state(){return this._state}updateBudget(n){this._test.usedBudget=0,++this._frameNumber;let o=uue,a=n.frameDuration,l=hue;switch(this.state){case Br.IDLE:o=0,a=Math.max(pue,n.frameDuration),l=eut;break;case Br.INTERACTING:a=Math.max(due,n.frameDuration);case Br.ANIMATING:}return a=a-n.elapsedFrameTime-o,this.state!==Br.IDLE&&a<hue&&!this._forceTask?(this._forceTask=!0,!1):(a=Math.max(a,l),this._budget.reset(a,this.state),this._updateLoad(),this._schedule())}frame(){switch(this._forceTask=!1,this._microTaskQueued=!1,this.state){case Br.IDLE:this._idleUpdatesStartFired||(this._idleUpdatesStartFired=!0,this._idleStateCallbacks.forAll(n=>n.idleBegin())),this._runIdle();break;case Br.INTERACTING:this._runInteracting();break;default:this._runAnimating()}this._test.usedBudget=this._budget.elapsed}stopFrame(){this._budget.reset(0,this._state),this._budget.madeProgress()}_removeIdleStateCallbacks(n){this._idleUpdatesStartFired&&n.idleEnd(),this._idleStateCallbacks.removeUnordered(n)}removeTask(n){this._tasks.removeUnordered(n),this._runQueue.removeUnordered(n),this._updatingChanged()}_updateTask(n){this._tasks.forAll(o=>{o.name===n&&o.setPriority(n)})}_getState(n){if(this._runQueue.some(a=>a.name===n))return Ib.SCHEDULED;let o=Ib.IDLE;return this._tasks.forAll(a=>{a.name===n&&a.needsUpdate&&(a.schedulePriority<=1?o=Ib.READY:o!==Ib.READY&&(o=Ib.WAITING))}),o}_getRuntime(n){let o=0;return this._tasks.forAll(a=>{a.name===n&&(o+=a.runtime)}),o}_resetRuntimes(){this._tasks.forAll(n=>n.runtime=0)}_getRunning(){const n=new Map;if(this._tasks.forAll(a=>{a.needsUpdate&&n.set(a.name,(n.get(a.name)||0)+1)}),n.size===0)return null;let o="";return n.forEach((a,l)=>{o+=a>1?` ${a}x ${l}`:` ${l}`}),o}_runIdle(){this._run()}_runInteracting(){this._run()}_runAnimating(){this._run()}_updateLoad(){const n=this._tasks.reduce((o,a)=>a.needsUpdate?++o:o,0);this._load=this._load*fue+n*(1-fue)}_schedule(){for(this._runQueue.filterInPlace(n=>!!n.needsUpdate||(n.schedulePriority=n.basePriority,!1)),this._tasks.forAll(n=>{n.basePriority===Bm&&n.needsUpdate&&!this._runQueue.includes(n)&&n.blockFrame!==this._frameNumber&&this._runQueue.unshift(n)});this._runQueue.length===0;){let n=!1,o=0;if(this._tasks.forAll(a=>{a.needsUpdate&&a.schedulePriority!==0&&a.basePriority!==Bm&&a.blockFrame!==this._frameNumber&&(n=!0,o=Math.max(o,a.basePriority),a.schedulePriority===1?(a.schedulePriority=0,this._runQueue.push(a)):--a.schedulePriority)}),!n)return this._updatingChanged(),!1}return this._updatingChanged(),!0}_run(){const n=this._budget.now();this._startFrameTaskTimes();do for(;this._runQueue.length>0;){const o=this._budget.now(),a=this._runQueue.pop();this._budget.resetProgress();try{a.task.runTask(this._budget)===Pa.YIELD&&(a.blockFrame=this._frameNumber)}catch(c){K.getLogger("esri.views.support.Scheduler").error(`Exception in task "${a.name}"`,c)}!this._budget.hasProgressed&&a.blockFrame!==this._frameNumber&&a.needsUpdate&&(a.name,gt.I3S_CONTROLLER,a.blockFrame=this._frameNumber),a.schedulePriority=a.basePriority;const l=this._budget.now()-o;if(a.runtime+=l,this._frameTaskTimes.set(a.priority,this._frameTaskTimes.get(a.priority)+l),this._debug&&l>2*this._budget.budget&&console.log("Task",a.name,"used",l,"of max",this._budget.budget,"ms"),this._budget.remaining<=0)return this._updatingChanged(),void this._recordFrameTaskTimes(this._budget.now()-n)}while(this._schedule());this._updatingChanged(),this._recordFrameTaskTimes(this._budget.now()-n)}_startFrameTaskTimes(){for(const n of Object.keys(gt))this._frameTaskTimes.set(gt[n],0)}_recordFrameTaskTimes(n){this._frameTaskTimes.forEach((o,a)=>this.performanceInfo.tasks.get(a).record(o)),this.performanceInfo.total.record(n)}get test(){return this._test}}t.Scheduler=e;class r{get task(){return this._task.value}get updating(){return this._queue.running}constructor(n,o,a,l){this._scheduler=n,this.name=o,this._basePriority=l,this.blockFrame=0,this.runtime=0,this._queue=new Jct,this._handles=new li,this.schedulePriority=this._basePriority,this._task=aP(a??this._queue),this._handles.add(No(()=>this.task.running,c=>n.taskRunningChanged(c)))}remove(){this.processQueue(Ll),this._scheduler.removeTask(this),this.schedule=AA.schedule,this.reschedule=AA.reschedule,this._handles.destroy()}get basePriority(){return this._basePriority}setPriority(n){this.name=n;const o=cue(n);this._basePriority!==Bm&&this.schedulePriority===0||(this.schedulePriority=o),this._basePriority=o}get priority(){return this.name}set priority(n){this.setPriority(n)}get needsUpdate(){return this.updating||this.task.running}schedule(n,o,a){return this._queue.push(n,o,a)}reschedule(n,o,a){return this._queue.unshift(n,o,a)}processQueue(n){this._queue.runTask(n)}}class i{constructor(){this._begin=typeof performance<"u"?performance.now():0,this._budget=0,this._state=Br.IDLE,this._done=!1,this._progressed=!1,this._enabled=!0}run(n){return!this.done&&(n()===!0&&this.madeProgress(),!0)}get done(){return this._done}get budget(){return this._budget}madeProgress(){return this._progressed=!0,this._done=this.elapsed>=this._budget&&this._enabled,this._done}get state(){return this._state}get enabled(){return this._enabled}set enabled(n){this._enabled=n}reset(n,o){this._begin=this.now(),this._budget=n,this._state=o,this.resetProgress()}get remaining(){return Math.max(this._budget-this.elapsed,0)}now(){return performance.now()}get elapsed(){return performance.now()-this._begin}resetProgress(){this._progressed=!1,this._done=!1}get hasProgressed(){return this._progressed}}t.Budget=i})(hU||(hU={})),function(t){t.SCHEDULED="s",t.READY="r",t.WAITING="w",t.IDLE="i"}(Ib||(Ib={}));const Ll=(()=>{const t=new hU.Budget;return t.enabled=!1,t})();let tut=class{remove(){}processQueue(){}schedule(e,r,i){try{if(dn(r)){const s=Tr();return i?Promise.resolve(i(s)):Promise.reject(s)}return Vj(e(Ll))}catch(s){return Promise.reject(s)}}reschedule(e,r,i){return this.schedule(e,r,i)}};const AA=new tut;let rC=class extends me{constructor(e,r){super({}),this._stage=e,this._textureRequests=new Map,this._frameTask=r?.registerTask(gt.TEXTURE_UNLOAD)??AA}normalizeCtorArgs(){return{}}destroy(){super.destroy(),this._frameTask?.remove(),this._textureRequests?.forEach(e=>this._releaseTextureRequest(e)),this._textureRequests?.clear()}get updating(){return this._frameTask.updating}fromData(e,r,i){const s=this.makeUid(e);let n=this._textureRequests.get(s);if(!n){const o=new CRe(i);o.texture=r(),this._stage?.add(o.texture),this._stage?.loadImmediate(o.texture),this._textureRequests.set(s,o),n=o}return n.referenceCount++,{uid:s,texture:n.texture,release:()=>this._release(s)}}_release(e){const r=this._textureRequests.get(e);r?(r.referenceCount<1&&console.warn("TextureCollection: reference count is < 1 for "+e),r.referenceCount--,r.referenceCount<1&&this._frameTask.schedule(()=>this._releaseNow(e))):console.warn(`TextureCollection: texture doesn't exist: '${e}'`)}get test(){return{textureRequests:this._textureRequests}}_releaseNow(e){if(!this._textureRequests)return;const r=this._textureRequests.get(e);!r||r.referenceCount>0||(this._releaseTextureRequest(r),this._textureRequests.delete(e))}_releaseTextureRequest(e){e.onRemove&&e.onRemove(),e.texture?this._stage?.remove(e.texture):e.abortController&&(e.abortController.abort(),e.abortController=null)}makeUid(e,r=null){return r!=null?`${e}.${r}px`:e}};u([d()],rC.prototype,"_frameTask",void 0),u([d()],rC.prototype,"updating",null),rC=u([R("esri.views.3d.support.TextureCollection")],rC);let CRe=class{constructor(e){this.onRemove=e,this.referenceCount=0}};var mue;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right"})(mue||(mue={}));const ARe=["click","double-click","immediate-click","immediate-double-click","hold","drag","key-down","key-up","pointer-down","pointer-move","pointer-up","pointer-drag","mouse-wheel","pointer-enter","pointer-leave","gamepad","focus","blur"],ORe={};function RRe(t){return!!ORe[t]}function rut(t){for(const e of t)if(!RRe(e))return!1;return!0}ARe.forEach(t=>{ORe[t]=!0});let iut=class{constructor(e){this._handlers=new Map,this._counter=0,this._handlerCounts=new Map,this.view=e,this.inputManager=null}connect(e){e&&this.disconnect(),this.inputManager=e,this._handlers.forEach(({handler:r,priority:i},s)=>this.inputManager?.installHandlers(s,[r],i))}disconnect(){this.inputManager&&this._handlers.forEach((e,r)=>this.inputManager?.uninstallHandlers(r)),this.inputManager=null}destroy(){this.disconnect(),this._handlers.clear(),this.view=null}on(e,r,i,s){const n=Array.isArray(e)?e:e.split(",");if(!rut(n))return n.some(RRe)&&console.error("Error: registering input events and other events on the view at the same time is not supported."),null;let o,a;Array.isArray(r)?a=r:(o=r,a=[]),typeof i=="function"?o=i:s=i,s=s??fs.DEFAULT;const l=this._createUniqueGroupName(),c=new sut(this.view,n,a,o);this._handlers.set(l,{handler:c,priority:s});for(const h of n){const p=this._handlerCounts.get(h)||0;this._handlerCounts.set(h,p+1)}return this.inputManager&&this.inputManager.installHandlers(l,[c],s),{remove:()=>this._removeHandler(l,n)}}hasHandler(e){return!!this._handlerCounts.get(e)}_removeHandler(e,r){if(this._handlers.has(e)){this._handlers.delete(e);for(const i of r){const s=this._handlerCounts.get(i);s===void 0?console.error("Trying to remove handler for event that has no handlers registered: ",i):s===1?this._handlerCounts.delete(i):this._handlerCounts.set(i,s-1)}}this.inputManager&&this.inputManager.uninstallHandlers(e)}_createUniqueGroupName(){return this._counter+=1,`viewEvents_${this._counter}`}},sut=class extends ua{constructor(e,r,i,s){super(!0),this._latestDragStart=void 0,this.view=e;for(const n of r)switch(n){case"click":this.registerIncoming("click",i,o=>s(this._wrapClick(o)));break;case"double-click":this.registerIncoming("double-click",i,o=>s(this._wrapDoubleClick(o)));break;case"immediate-click":this.registerIncoming("immediate-click",i,o=>s(this._wrapImmediateClick(o)));break;case"immediate-double-click":this.registerIncoming("immediate-double-click",i,o=>s(this._wrapImmediateDoubleClick(o)));break;case"hold":this.registerIncoming("hold",i,o=>s(this._wrapHold(o)));break;case"drag":this.registerIncoming("drag",i,o=>{const a=this._wrapDrag(o);a&&s(a)});break;case"key-down":this.registerIncoming("key-down",i,o=>s(this._wrapKeyDown(o)));break;case"key-up":this.registerIncoming("key-up",i,o=>s(this._wrapKeyUp(o)));break;case"pointer-down":this.registerIncoming("pointer-down",i,o=>s(this._wrapPointer(o,"pointer-down")));break;case"pointer-move":this.registerIncoming("pointer-move",i,o=>s(this._wrapPointer(o,"pointer-move")));break;case"pointer-up":this.registerIncoming("pointer-up",i,o=>s(this._wrapPointer(o,"pointer-up")));break;case"pointer-drag":this.registerIncoming("pointer-drag",i,o=>s(this._wrapPointerDrag(o)));break;case"mouse-wheel":this.registerIncoming("mouse-wheel",i,o=>s(this._wrapMouseWheel(o)));break;case"pointer-enter":this.registerIncoming("pointer-enter",i,o=>s(this._wrapPointer(o,"pointer-enter")));break;case"pointer-leave":this.registerIncoming("pointer-leave",i,o=>s(this._wrapPointer(o,"pointer-leave")));break;case"gamepad":this.registerIncoming("gamepad",i,o=>{s(this._wrapGamepad(o))});break;case"focus":this.registerIncoming("focus",i,o=>{s(this._wrapFocus(o))});break;case"blur":this.registerIncoming("blur",i,o=>{s(this._wrapBlur(o))})}}_wrapFocus(e){return{type:"focus",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapBlur(e){return{type:"blur",timestamp:e.timestamp,native:e.data.native,cancelable:e.cancelable,stopPropagation:()=>e.stopPropagation(),async:r=>e.async(r),preventDefault:()=>e.preventDefault()}}_wrapClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,screenPoint:xh(n,o),mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,{cancelable:c,timestamp:h}=e;return{type:"double-click",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:h,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:c,stopPropagation:()=>e.stopPropagation(),async:p=>e.async(p),preventDefault:()=>e.preventDefault()}}_wrapImmediateClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapImmediateDoubleClick(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a,eventId:l}=e.data,c=a.pointerId,{cancelable:h,timestamp:p}=e;return{type:"immediate-double-click",pointerId:c,pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:p,mapPoint:this._getMapPoint(n,o),eventId:l,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:f=>e.async(f),preventDefault:()=>e.preventDefault()}}_wrapHold(e){const{pointerType:r,button:i,buttons:s,x:n,y:o,native:a}=e.data,{cancelable:l,timestamp:c}=e;return{type:"hold",pointerType:r,button:i,buttons:s,x:n,y:o,native:a,timestamp:c,mapPoint:this._getMapPoint(n,o),cancelable:l,stopPropagation:()=>e.stopPropagation(),async:h=>e.async(h),preventDefault:()=>e.preventDefault()}}_getMapPoint(e,r){return this.view.toMap(xh(e,r),{exclude:[]})}_wrapDrag(e){const r=e.data,{x:i,y:s}=r.center,{action:n,pointerType:o,button:a}=r;if(n==="start"&&(this._latestDragStart=r),!this._latestDragStart)return;const l=r.pointer.native,c=r.buttons,{cancelable:h,timestamp:p}=e,f={x:this._latestDragStart.center.x,y:this._latestDragStart.center.y};return n==="end"&&(this._latestDragStart=void 0),{type:"drag",action:n,x:i,y:s,origin:f,pointerType:o,button:a,buttons:c,radius:r.radius,angle:Vl(r.angle),native:l,timestamp:p,cancelable:h,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapKeyDown(e){const{key:r,repeat:i,native:s}=e.data,{cancelable:n,timestamp:o}=e;return{type:"key-down",key:r,repeat:i,native:s,timestamp:o,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:a=>e.async(a),preventDefault:()=>e.preventDefault()}}_wrapKeyUp(e){const{key:r,native:i}=e.data,{cancelable:s,timestamp:n}=e;return{type:"key-up",key:r,native:i,timestamp:n,cancelable:s,stopPropagation:()=>e.stopPropagation(),async:o=>e.async(o),preventDefault:()=>e.preventDefault()}}_wrapPointer(e,r){const{x:i,y:s,button:n,buttons:o,native:a,eventId:l}=e.data,c=a.pointerId,h=a.pointerType,{cancelable:p,timestamp:f}=e;return{type:r,x:i,y:s,pointerId:c,pointerType:h,button:n,buttons:o,native:a,timestamp:f,eventId:l,cancelable:p,stopPropagation:()=>e.stopPropagation(),async:m=>e.async(m),preventDefault:()=>e.preventDefault()}}_wrapPointerDrag(e){const{x:r,y:i,buttons:s,native:n,eventId:o}=e.data.currentEvent,{button:a}=e.data.startEvent,l=e.data.startEvent.native.pointerId,c=e.data.startEvent.native.pointerType,h=e.data.action,p={x:e.data.startEvent.x,y:e.data.startEvent.y},{cancelable:f,timestamp:m}=e;return{type:"pointer-drag",x:r,y:i,pointerId:l,pointerType:c,button:a,buttons:s,action:h,origin:p,native:n,timestamp:m,eventId:o,cancelable:f,stopPropagation:()=>e.stopPropagation(),async:g=>e.async(g),preventDefault:()=>e.preventDefault()}}_wrapMouseWheel(e){const{cancelable:r,data:i,timestamp:s}=e,{x:n,y:o,deltaY:a,native:l}=i;return{type:"mouse-wheel",x:n,y:o,deltaY:a,native:l,timestamp:s,cancelable:r,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}_wrapGamepad(e){const{action:r,state:i,device:s}=e.data,{cancelable:n,timestamp:o}=e,{buttons:a,axes:l}=i;return{type:"gamepad",device:s,timestamp:o,action:r,buttons:a,axes:l,cancelable:n,stopPropagation:()=>e.stopPropagation(),async:c=>e.async(c),preventDefault:()=>e.preventDefault()}}};var hP,gue,yue;(function(t){t[t.USER=0]="USER",t[t.MANAGER=1]="MANAGER"})(hP||(hP={})),function(t){t[t.None=0]="None",t[t.Unfocused=1]="Unfocused",t[t.Focused=2]="Focused",t[t.Unselected=4]="Unselected",t[t.Selected=8]="Selected",t[t.All=15]="All"}(gue||(gue={})),function(t){t[t.None=0]="None",t[t.Custom1=16]="Custom1",t[t.Custom2=32]="Custom2",t[t.Custom3=64]="Custom3",t[t.Custom4=128]="Custom4",t[t.Custom5=256]="Custom5",t[t.Custom6=512]="Custom6",t[t.Custom7=1024]="Custom7",t[t.Custom8=2048]="Custom8",t[t.Custom9=4096]="Custom9",t[t.Custom10=8192]="Custom10",t[t.Custom11=16384]="Custom11",t[t.Custom12=32768]="Custom12",t[t.All=65520]="All"}(yue||(yue={}));function nut(t){return[t.on("before-add",e=>{const r=e.item;if(r==null||t.includes(r))return K.getLogger("esri.views.interactive.interactiveToolUtils").warn("Tool is either already in the list of tools or tool is `null`. Not adding tool."),void e.preventDefault();r.onAdd()}),t.on("after-remove",e=>{const r=e.item;r.active&&(r.view.activeTool=null),r.destroy()})]}function BZ(t){return t.visible&&t.getEditableFlag!=null&&t.getEditableFlag(hP.USER)&&t.getEditableFlag(hP.MANAGER)}let out=class{constructor(){this._pointerLocations=new Map,this._hoveredManipulators=new Map,this._grabbedManipulators=new Map,this._draggedManipulators=new Map,this._stopDrag=!1,this._revertToNullActiveTool=!1,this._cursor=null}get cursor(){return this._cursor}hasFocusedManipulators(){return this._grabbedManipulators.size>0||this._draggedManipulators.size>0}handleInputEvent(e,r){const i=()=>e.stopPropagation();switch(e.type){case"pointer-move":_ue(e.pointerType)&&this._pointerLocations.set(e.pointerId,{x:e.x,y:e.y,pointerType:e.pointerType});break;case"drag":this._grabbedManipulators.size>0&&(this._stopDrag=!0),this._stopDrag&&(i(),e.action==="end"&&(this._stopDrag=!1));break;case"pointer-down":{if(!vue(e))break;const s=hd(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(n==null)break;const o=n.manipulator,a=n.tool;o==null||a==null||!o.interactive||o.grabbable&&o.grabbableForEvent(e)||!o.grabbing||o.dragging||this._ungrabManipulatorBeforeDragging(o,e,r),o!=null&&a!=null&&o.interactive&&o.grabbable&&o.grabbableForEvent(e)&&!o.grabbing&&(this._grabbedManipulators.set(e.pointerId,{manipulator:o,tool:a,start:s,pointerType:e.pointerType}),this._grabbedManipulators.size===1&&r.activeTool==null&&(this._revertToNullActiveTool=!0,r.setActiveTool(n.tool)),o.grabbing=!0,o.events.emit("grab-changed",{action:"start",pointerType:e.pointerType,screenPoint:s}),i());break}case"pointer-up":this._draggedManipulators.has(e.pointerId)||this._handlePointerEnd(e,r);break;case"pointer-drag":{if(!vue(e))break;const s=this._grabbedManipulators.get(e.pointerId),n=Dl(s,({manipulator:h})=>h),o=Dl(s,({tool:h})=>h);if(n==null||o==null)break;const a=hd(e);a.x=ye(a.x,0,r.view.width),a.y=ye(a.y,0,r.view.height);const l=s.start,c=this._draggedManipulators.get(e.pointerId);switch(e.action){case"start":case"update":e.action!=="update"&&this._grabbedManipulators.size!==1||(n.dragging=!0,c?n.events.emit("drag",{action:"update",start:l,screenPoint:a}):n.events.emit("drag",{action:"start",start:l,screenPoint:a,pointerType:e.pointerType}),this._draggedManipulators.set(e.pointerId,{tool:o,manipulator:n,start:l}));break;case"end":n.dragging=!1,c&&n.events.emit("drag",{action:"end",start:l,screenPoint:a}),this._draggedManipulators.delete(e.pointerId),this._handlePointerEnd(e,r)}i();break}case"immediate-click":{const s=hd(e),n=this._intersect(s,e.pointerType,r.forEachTool);if(aut(e)||r.forEachTool(c=>{if((n==null||n.tool!==c||c.automaticManipulatorSelection)&&c.manipulators){let h=!1;c.manipulators.forEach(({manipulator:p})=>{p.selected&&(p.selected=!1,h=!0)}),h&&c.onManipulatorSelectionChanged&&c.onManipulatorSelectionChanged()}}),n==null)break;const{manipulator:o,tool:a}=n;if(!o.interactive)break;o.selectable&&a.automaticManipulatorSelection&&(o.selected=!o.selected,a.onManipulatorSelectionChanged&&a.onManipulatorSelectionChanged());const l=e.native.shiftKey;o.events.emit("immediate-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:l,stopPropagation:i});break}case"click":{const s=hd(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=n!=null?n.manipulator:null;if(o==null||!o.interactive)break;const a=e.native.shiftKey;o.events.emit(e.type,{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a}),i();break}case"double-click":{const s=hd(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=n!=null?n.manipulator:null;if(o==null||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}case"immediate-double-click":{const s=hd(e),n=this._intersect(s,e.pointerType,r.forEachTool),o=n!=null?n.manipulator:null;if(o==null||!o.interactive)break;const a=e.native.shiftKey;o.events.emit("immediate-double-click",{screenPoint:s,button:e.button,pointerType:e.pointerType,shiftKey:a,stopPropagation:i});break}}this._onFocusChange(r.forEachTool)}_ungrabManipulatorBeforeDragging(e,r,i){e.grabbing=!1,e.events.emit("grab-changed",{action:"end",pointerType:r.pointerType,screenPoint:hd(r)}),this._grabbedManipulators.forEach(({manipulator:s},n)=>{s===e&&this._grabbedManipulators.delete(n)}),this._afterManipulatorUngrab(i.setActiveTool)}_handlePointerEnd(e,r){const i=Dl(this._grabbedManipulators.get(e.pointerId),({manipulator:s})=>s);i!=null&&i.grabbing&&(i.grabbing=!1,i.events.emit("grab-changed",{action:"end",pointerType:e.pointerType,screenPoint:hd(e)}),this._grabbedManipulators.delete(e.pointerId),this._afterManipulatorUngrab(r.setActiveTool))}_cursorFromMap(e){let r=null;return ra(e,({manipulator:i})=>!(i==null||!i.interactive)&&(i.grabbing&&i.grabCursor?(r=i.grabCursor,!0):!!i.cursor&&(r=i.cursor,!0))),r}_onFocusChange(e){this._updateCursor(),this._updateFocusedManipulatorTools(e)}_updateCursor(){this._grabbedManipulators.size>0?this._cursor=this._cursorFromMap(this._grabbedManipulators)||"grabbing":this._hoveredManipulators.size>0?this._cursor=this._cursorFromMap(this._hoveredManipulators)||"pointer":this._cursor=null}_updateFocusedManipulatorTools(e){const r=new Set,i=new Set;this._grabbedManipulators.forEach(({tool:s})=>{r.add(s)}),this._hoveredManipulators.forEach(({tool:s})=>{i.add(s)}),e(s=>{s.hasGrabbedManipulators=r.has(s),s.hasHoveredManipulators=i.has(s);const n=this._grabbedManipulators.values(),o=KUe(n,({tool:a})=>a===s);s.firstGrabbedManipulator=o!=null?o.manipulator:null})}clearPointers(e,{forEachTool:r,setActiveTool:i},s=!0,n){const o=(a,l)=>a===e&&(n==null||n===l);this._grabbedManipulators.forEach(({tool:a,manipulator:l,pointerType:c},h)=>{o(a,l)&&(this._grabbedManipulators.delete(h),l.grabbing=!1,l.events.emit("grab-changed",{action:"end",screenPoint:null,pointerType:c}))}),this._draggedManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._draggedManipulators.delete(c),l.dragging=!1,l.events.emit("drag",{action:"cancel"}))}),s&&this._hoveredManipulators.forEach(({tool:a,manipulator:l},c)=>{o(a,l)&&(this._hoveredManipulators.delete(c),l.hovering=!1)}),this._afterManipulatorUngrab(i),this._onFocusChange(r)}_intersect(e,r,i){let s=null;return i(n=>{if(n.manipulators==null||!BZ(n))return!1;const o=n.manipulators.intersect(e,r);return o!=null&&(s={tool:n,manipulator:o},!0)}),s}updateHoveredStateFromKnownPointers(e){this._pointerLocations.forEach((r,i)=>{this._updateHoveredStateForPointerAtScreenPosition(xh(r.x,r.y),i,r.pointerType,e)})}handleHoverEvent(e,r){e.type!=="pointer-up"&&e.type!=="immediate-click"&&e.type!=="pointer-move"||!_ue(e.pointerType)||this._updateHoveredStateForPointerAtScreenPosition(hd(e),e.pointerId,e.pointerType,r)}_updateHoveredStateForPointerAtScreenPosition(e,r,i,s){let n=this._intersect(e,i,s);const o=Dl(this._hoveredManipulators.get(r),({manipulator:a})=>a);n==null||n.manipulator.interactive||(n=null),n!=null&&o===n.manipulator||(o!=null&&(o.hovering=!1),n!=null?(n.manipulator.hovering=!0,this._hoveredManipulators.set(r,n)):this._hoveredManipulators.delete(r),this._onFocusChange(s))}_afterManipulatorUngrab(e){this._grabbedManipulators.size===0&&this._revertToNullActiveTool&&(e(null),this._revertToNullActiveTool=!1)}};function _ue(t){return t==="mouse"}function vue(t){return t.pointerType!=="mouse"||t.button===0}function aut(t){return!!t.native.shiftKey}const bue="attached",qz="tools",lut=1e3;let Fp=class extends wT{constructor(e){super(e),this._clock=zP,this._manipulatorState=new out,this.tools=new Ke,this.cursor=null,this._interacting=!1,this._interactingTimeout=null,this._forEachTool=r=>{for(const i of this.tools.items)if(r(i))return}}initialize(){this.handles.add([this.view.on(ARe,e=>{this._handleInputEvent(e)},fs.TOOL),...nut(this.tools),this.tools.on("before-add",({item:e})=>{this._updateToolEditableFlag(e)}),this.tools.on("before-remove",({item:e})=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()}),this.tools.on("change",()=>{this._refreshToolWatchers()})])}destroy(){this.detach(),this.handles.removeAll()}get _manipulatorStateEventArgs(){return{forEachTool:this._forEachTool,activeTool:this.activeTool,setActiveTool:e=>{this.activeTool=e},view:this.view}}set activeTool(e){if(e!=null&&!this.view.ready)return void K.getLogger(this).error("Cannot set active tool while view is not ready.");if(e===this.activeTool)return;const r=this.activeTool;this._set("activeTool",e),r?.deactivate(),e?.activate(),this._removeIncompleteTools(e);for(const i of this.tools){this._updateToolEditableFlag(i);const s=BZ(i);this.activeTool!=null&&s||this._manipulatorState.clearPointers(i,this._manipulatorStateEventArgs,!s)}this._updateCursor()}get updating(){return this.updatingHandles.updating||this.tools.some(e=>e.updating)||(this.textures?.updating??!1)}get interacting(){return this._interacting}_clearInteractingTimeout(){this._interactingTimeout=Pi(this._interactingTimeout)}_startInteractingTimeout(){this._clearInteractingTimeout(),this._interactingTimeout=this._clock.setTimeout(()=>this._interacting=!1,lut)}attach(){this.view.type==="3d"?(this._set("textures",new rC(this.view._stage,this.view.resourceController.scheduler)),this.handles.add([Q(()=>{const{state:e}=this.view;return"camera"in e&&e.camera},()=>this._forEachManipulator(e=>e.onViewChange())),this.view.elevationProvider?.on("elevation-change",e=>this._forEachManipulator(r=>r.onElevationChange(e))),Zr(()=>this._set("textures",Re(this.textures)))],bue)):this.handles.add(Q(()=>this.view.extent,()=>this._forEachManipulator(e=>e.onViewChange())))}detach(){this.activeTool=null,this.tools.removeAll(),this.handles.remove(bue),this._clearInteractingTimeout(),this._interacting=!1}_forEachManipulator(e){this._forEachTool(r=>{r.manipulators&&r.manipulators.forEach(({manipulator:i})=>e(i,r))})}_handleInputEvent(e){let r=!1;const i={...e,stopPropagation:()=>{r=!0,e.stopPropagation()}};this.activeTool!=null?this.activeTool.handleInputEvent&&this.activeTool.handleInputEvent(i):this._forEachTool(s=>{!r&&s.visible&&s.handleInputEvent(i)}),!r&&e.type==="key-down"&&e.key==="Escape"&&this.activeTool&&(e.stopPropagation(),this.activeTool=null),this._manipulatorState.handleInputEvent(i,this._manipulatorStateEventArgs),r||this.activeTool==null||this.activeTool.handleInputEventAfter(i),this._manipulatorState.handleHoverEvent(i,this._forEachTool),this._updateCursor(),e.type==="pointer-move"&&(this._manipulatorState.hasFocusedManipulators()||this.activeTool)&&(this._interacting=!0,this._startInteractingTimeout())}_refreshToolWatchers(){this.handles.remove(qz),this._forEachTool(e=>{if(e instanceof me){const r=Q(()=>[e.cursor,e.visible,e.editable],()=>{BZ(e)||this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs),this._updateCursor()});this.handles.add(r,qz)}e.manipulators&&this.handles.add([e.manipulators.on("after-remove",r=>{this._manipulatorState.clearPointers(e,this._manipulatorStateEventArgs,!0,r.item.manipulator)}),e.manipulators.on("change",()=>{this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()})],qz)}),this._manipulatorState.updateHoveredStateFromKnownPointers(this._forEachTool),this._updateCursor()}_updateToolEditableFlag(e){e.setEditableFlag?.(hP.MANAGER,this.activeTool==null||e===this.activeTool)}_updateCursor(){let e=this._manipulatorState.cursor;e==null&&this._forEachTool(r=>!(r.cursor==null||!r.visible)&&(e=r.cursor,!0)),this._get("cursor")!==e&&this._set("cursor",e)}_removeIncompleteTools(e){this.tools.filter(r=>(e==null||r!==e)&&!r.created&&r.removeIncompleteOnCancel).forEach(r=>{this.tools.remove(r)})}get test(){return{setClock:e=>this._clock=e}}};u([d({constructOnly:!0,nonNullable:!0})],Fp.prototype,"view",void 0),u([d({readOnly:!0,nonNullable:!0})],Fp.prototype,"textures",void 0),u([d({value:null})],Fp.prototype,"activeTool",null),u([d({readOnly:!0,type:Ke})],Fp.prototype,"tools",void 0),u([d({readOnly:!0})],Fp.prototype,"cursor",void 0),u([d({readOnly:!0})],Fp.prototype,"updating",null),u([d()],Fp.prototype,"_interacting",void 0),u([d({readOnly:!0})],Fp.prototype,"interacting",null),Fp=u([R("esri.views.ToolViewManager")],Fp);let vE=class extends me{constructor(e){super(),this.nativeIndex=null,this._detectedDeviceType="unknown",e.mapping==="standard"?this._detectedDeviceType="standard":cut.test(e.id)?this._detectedDeviceType="spacemouse":this._detectedDeviceType="unknown",this.nativeIndex=e.index}get native(){const e=navigator.getGamepads?navigator.getGamepads():[];return this.nativeIndex!=null&&this.nativeIndex<e.length?e[this.nativeIndex]:null}get deviceType(){return this._detectedDeviceType}get axisThreshold(){return uut[this.deviceType]}};u([d({nonNullable:!0,readOnly:!0})],vE.prototype,"nativeIndex",void 0),u([d({type:String,readOnly:!0})],vE.prototype,"deviceType",null),u([d({type:Number,readOnly:!0})],vE.prototype,"axisThreshold",null),vE=u([R("esri.views.input.gamepad.GamepadInputDevice")],vE);const cut=new RegExp("^(3dconnexion|space(mouse|navigator|pilot|explorer))","i"),uut={standard:.15,spacemouse:.025,unknown:0},$te=vE;let Q3=class extends me{constructor(...e){super(...e),this.devices=new Ke,this.enabledFocusMode="document"}};u([d({type:Ke.ofType($te),readOnly:!0})],Q3.prototype,"devices",void 0),u([d({type:["document","view","none"]})],Q3.prototype,"enabledFocusMode",void 0),Q3=u([R("esri.views.input.gamepad.GamepadSettings")],Q3);const hut=Q3;let j4=class extends me{constructor(){super(...arguments),this.gamepad=new hut}};u([d({readOnly:!0})],j4.prototype,"gamepad",void 0),j4=u([R("esri.views.input.Input")],j4);const dut=j4;let Ev=class extends me{constructor(e){super(e),this.enabled=!0,this.device=null,this.mode="pan",this.tiltDirection="forward-down",this.velocityFactor=1}};u([d({type:Boolean,nonNullable:!0})],Ev.prototype,"enabled",void 0),u([d({type:$te})],Ev.prototype,"device",void 0),u([d({type:["pan","zoom"],nonNullable:!0})],Ev.prototype,"mode",void 0),u([d({type:["forward-down","forward-up"],nonNullable:!0})],Ev.prototype,"tiltDirection",void 0),u([d({type:Number,nonNullable:!0})],Ev.prototype,"velocityFactor",void 0),Ev=u([R("esri.views.navigation.gamepad.GamepadSettings")],Ev);const MRe=Ev;let Kw=class extends me{constructor(e){super(e),this.browserTouchPanEnabled=!0,this.gamepad=new MRe,this.momentumEnabled=!0,this.mouseWheelZoomEnabled=!0}};u([d({type:Boolean})],Kw.prototype,"browserTouchPanEnabled",void 0),u([d({type:MRe,nonNullable:!0})],Kw.prototype,"gamepad",void 0),u([d({type:Boolean})],Kw.prototype,"momentumEnabled",void 0),u([d({type:Boolean})],Kw.prototype,"mouseWheelZoomEnabled",void 0),Kw=u([R("esri.views.navigation.Navigation")],Kw);const IRe=Kw;function T9t(t,e,r){const i=PRe(t),s=e,n=put(i,s,r);if(i){const o=dS.deriveUnitFromSR(i,t.spatialReference).heightUnit;if(!r&&o!==i.heightUnit){const a=new D("layerview:unmatched-height-unit",`The vertical units of the layer must match the horizontal units (${o})`,{horizontalUnit:o});return new D("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i,error:a})}}if(!fut(t)||n===au.Unsupported)return new D("layerview:unsupported-height-model-info","The vertical coordinate system of the layer is not supported",{heightModelInfo:i});switch(n){case au.Units:{const o=i?.heightUnit||"unknown",a=s?.heightUnit||"unknown",l=new D("layerview:incompatible-height-unit",`The vertical units of the layer (${o}) must match the vertical units of the scene (${a})`,{layerUnit:o,sceneUnit:a});return new D("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case au.HeightModel:{const o=i?.heightModel||"unknown",a=s?.heightModel||"unknown",l=new D("layerview:incompatible-height-model",`The height model of the layer (${o}) must match the height model of the scene (${a})`,{layerHeightModel:o,sceneHeightModel:a});return new D("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}case au.CRS:{const o=i?.vertCRS||"unknown",a=s?.vertCRS||"unknown",l=new D("layerview:incompatible-vertical-datum",`The vertical datum of the layer (${o}) must match the vertical datum of the scene (${a})`,{layerDatum:o,sceneDatum:a});return new D("layerview:incompatible-height-model-info","The vertical coordinate system of the layer is incompatible with the scene",{layerHeightModelInfo:i,sceneHeightModelInfo:s,error:l})}}return null}function put(t,e,r){if(!wue(t)||!wue(e))return au.Unsupported;if(t==null||e==null)return au.Ok;if(!r&&t.heightUnit!==e.heightUnit)return au.Units;if(t.heightModel!==e.heightModel)return au.HeightModel;switch(t.heightModel){case"gravity-related-height":return au.Ok;case"ellipsoidal":return t.vertCRS===e.vertCRS?au.Ok:au.CRS;default:return au.Unsupported}}var au;function wue(t){return t==null||t.heightModel!=null&&t.heightUnit!=null}function fut(t){return"heightModelInfo"in t&&t.heightModelInfo!=null||t.spatialReference!=null||!DRe(t)}function PRe(t){const e=t.url?sg(t.url):void 0;return!(t.spatialReference?.vcsWkid==null&&e!=null&&e.serverType==="ImageServer")&&$Re(t)&&t.heightModelInfo?t.heightModelInfo:DRe(t)?dS.deriveUnitFromSR(gut,t.spatialReference):null}function $Re(t){return"heightModelInfo"in t}function LRe(t){if(t.type==="unknown"||!("capabilities"in t))return!1;switch(t.type){case"csv":case"feature":case"geojson":case"subtype-group":case"ogc-feature":case"oriented-imagery":case"wfs":case"knowledge-graph-sublayer":return!0;default:return!1}}function DRe(t){return LRe(t)?!!(t.capabilities&&t.capabilities.data&&t.capabilities.data.supportsZ):NRe(t)}function mut(t){return t.layers!=null||NRe(t)||LRe(t)||$Re(t)}function NRe(t){switch(t.type){case"building-scene":case"elevation":case"integrated-mesh":case"point-cloud":case"scene":case"voxel":return!0;case"base-dynamic":case"base-elevation":case"base-tile":case"bing-maps":case"csv":case"dimension":case"geojson":case"feature":case"subtype-group":case"geo-rss":case"graphics":case"group":case"imagery":case"imagery-tile":case"kml":case"knowledge-graph":case"link-chart":case"knowledge-graph-sublayer":case"line-of-sight":case"map-image":case"map-notes":case"media":case"ogc-feature":case"open-street-map":case"oriented-imagery":case"route":case"stream":case"tile":case"unknown":case"unsupported":case"vector-tile":case"video":case"wcs":case"web-tile":case"wfs":case"wms":case"wmts":case null:return!1}return!1}(function(t){t[t.Ok=0]="Ok",t[t.Units=1]="Units",t[t.HeightModel=2]="HeightModel",t[t.CRS=3]="CRS",t[t.Unsupported=4]="Unsupported"})(au||(au={}));const gut=new dS({heightModel:"gravity-related-height"});let GZ,Wz=null;async function yut(t){Wz||(Wz=J(()=>Promise.resolve().then(()=>oAt),void 0,import.meta.url).then(e=>GZ=e)),await Wz,Dt(t)}async function FRe(t,e,r,i){if(!t)return null;const s=t.spatialReference;return y$()||$f(s,e)?bg(t,e):GZ?GZ.projectGeometry(t,e,r,i):(await Promise.race([yut(i),mA(i)]),FRe(t,e,r,i))}let ss=class extends me{constructor(e){super(e),this.required={tileInfo:!1,heightModelInfo:!1,extent:!1},this.defaultSpatialReference=null,this.userSpatialReference=null,this.sourcePreloadCount=10,this.priorityCollection=null,this.requiresExtentInSpatialReference=!0,this.suspended=!1,this._projectExtentTask={task:null,input:null,output:null,spatialReference:null}}destroy(){this._projectExtentTask.task&&(this._projectExtentTask.task=Do(this._projectExtentTask.task)),this._set("map",null)}get ready(){return!this._spatialReferenceTask.updating&&!this._tileInfoTask.updating&&!this._extentTask.updating}get heightModelInfoReady(){return!this._heightModelInfoTask.updating}get spatialReference(){return this.userSpatialReference!=null?this.userSpatialReference:this._spatialReferenceTask.spatialReference}get extent(){return this._extentTask.extent}get heightModelInfo(){return this._heightModelInfoTask.heightModelInfo}get vcsWkid(){return this._heightModelInfoTask.vcsWkid}get latestVcsWkid(){return this._heightModelInfoTask.latestVcsWkid}get viewingMode(){return this.userSpatialReference==null||this.userSpatialReference.equals(this._spatialReferenceTask.spatialReference)?this._spatialReferenceTask.viewingMode:null}get tileInfo(){return this._tileInfoTask.tileInfo}get mapCollections(){const e=this.map?.(),r=[];return this.priorityCollection!=null&&r.push(this.priorityCollection),r.push({parent:e?.basemap,layers:e?.basemap?.baseLayers},{layers:e?.layers},{parent:e?.ground,layers:e?.ground?.layers},{parent:e?.basemap,layers:e?.basemap?.referenceLayers}),r}get _allLayers(){return this._collectLayers(this.mapCollections)}get _spatialReferenceTask(){if(this.suspended)return this._get("_spatialReferenceTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;let i=null;for(const n of e){const o=this._getSupportedSpatialReferences(n);if(o.length>0){const a=this._narrowDownSpatialReferenceCandidates(i,o);a!=null&&(i=a)}if(i!=null&&i.length===1)break}if(r&&(i==null||i.length!==1))return{updating:!0};const s=this._pickSpatialReferenceCandidate(i);return{spatialReference:s!=null?s.spatialReference:null,viewingMode:s!=null?s.viewingMode:null,updating:!1}}get _tileInfoTask(){if(!this.required.tileInfo)return this._get("_tileInfoTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const{layers:e,updating:r}=this._collectLayers([{parent:this.map?.()?.basemap,layers:this.map?.()?.basemap?.baseLayers},{layers:this.map?.()?.layers}]);if(e&&e.length>0&&"tileInfo"in e[0]){const i=e[0].tileInfo;return{tileInfo:i&&i.spatialReference.equals(this.spatialReference)?i:null,updating:!1}}return{updating:r}}get _heightModelInfoTask(){if(!this.required.heightModelInfo||this.suspended&&this._get("_heightModelInfoTask")?.heightModelInfo)return this._get("_heightModelInfoTask")??{updating:!1};const{layers:e,updating:r}=this._allLayers;for(const i of e)if(mut(i)){const s=PRe(i);if(s)return{heightModelInfo:s,vcsWkid:i.spatialReference?.vcsWkid,latestVcsWkid:i.spatialReference?.latestVcsWkid,updating:!1}}return{updating:r}}get _extentCandidatesTask(){if(this.suspended||!this.required.extent)return this._get("_extentCandidatesTask")??{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const e=this._allLayers,r=e.updating,i=[];for(const s of e.layers){const n="fullExtents"in s&&s.fullExtents||(s.fullExtent!=null?[s.fullExtent]:[]),o=this.requiresExtentInSpatialReference?null:n[0],a=n.find(l=>l.spatialReference.equals(this.spatialReference))??o;if(a)return{candidates:[{extent:a,layer:s}],updating:!1};if(this._getSupportedSpatialReferences(s).length>0)for(const l of n)i.push({extent:l,layer:s})}return{candidates:i,updating:r}}get _extentTask(){const{candidates:e,updating:r}=this._extentCandidatesTask;if(r)return{updating:r};if(e==null||e.length===0)return{updating:!1};if(!this.spatialReference)return{updating:this._spatialReferenceTask.updating};const i=this._pickExtentCandidate(e),s=this.spatialReference;return i.extent.equals(this._projectExtentTask.input)&&s.equals(this._projectExtentTask.spatialReference)?{extent:this._projectExtentTask.output,updating:this._projectExtentTask.task!=null&&!this._projectExtentTask.task.finished}:(this._projectExtentTask.task!=null&&(this._projectExtentTask.task=Do(this._projectExtentTask.task)),this._projectExtentTask={input:i.extent.clone(),output:null,spatialReference:s.clone(),task:hb(async n=>{try{const o=await FRe(i.extent,s,"portalItem"in i.layer?i.layer.portalItem:void 0,n);this._projectExtentTask={...this._projectExtentTask,task:null,output:o}}catch{if(dn(n))return;this._projectExtentTask={...this._projectExtentTask,task:null}}})},{updating:!0})}_narrowDownSpatialReferenceCandidates(e,r){if(e==null)return r;const i=[],s=(n,o)=>n!=null?o!=null?n===o&&n:n:o;for(const n of e)for(const o of r){if(!n.spatialReference.equals(o.spatialReference))continue;const a=s(n.viewingMode,o.viewingMode);if(a!==!1){i.push({spatialReference:n.spatialReference,viewingMode:a});break}}return i.length>0?i:null}_pickSpatialReferenceCandidate(e){const r=this.defaultSpatialReference;return e==null||e.length<1?r!=null?{spatialReference:r,viewingMode:null}:null:(r!=null&&e.length>1&&e.some(({spatialReference:i})=>i.equals(r))&&(e=e.filter(({spatialReference:i})=>i.equals(r))),e.length>1&&e.some(({viewingMode:i})=>i!==Ue.Local)&&(e=e.filter(({viewingMode:i})=>i!==Ue.Local)),e[0])}_getSupportedSpatialReferences(e){const r="supportedSpatialReferences"in e&&e.supportedSpatialReferences||(e.spatialReference?[e.spatialReference]:[]);if(r.length===0)return[];const i=[];for(const s of r){const n=this.getSpatialReferenceSupport({spatialReference:s,layer:e});if(n!=null){const o=n.constraints!=null?n.constraints:[{spatialReference:s,viewingMode:null}];for(const{spatialReference:a,viewingMode:l}of o)this.requiresExtentInSpatialReference&&this.userSpatialReference!=null&&!a.equals(this.userSpatialReference)||i.push({spatialReference:a,viewingMode:l})}}return i}_pickExtentCandidate(e){const r=this.spatialReference;return e.find(({extent:i})=>r.equals(i.spatialReference))||e[0]}_collectLayers(e){if(this._loadMaybe(this.map?.())!=="loaded")return{layers:[],updating:!0};const r=new _ut;for(const i of e)if(this._collectCollection(i,r),r.preloading===this.sourcePreloadCount)break;return{layers:r.layers,updating:r.updating}}_collectCollection(e,r){if(e.layers){switch(this._loadMaybe(e.parent)){case"loading":return r.updating=!0,void++r.preloading;case"failed":return}for(const i of e.layers){switch(this._loadMaybe(i)){case"failed":continue;case"loading":r.updating=!0,++r.preloading;break;case"loaded":r.updating||r.layers.push(i),"layers"in i&&this._collectCollection({layers:i.layers},r)}if(r.preloading===this.sourcePreloadCount)break}}}_loadMaybe(e){return e&&"loadStatus"in e&&e.loadStatus!=null?e.loadStatus==="not-loaded"?(e.load().catch(r=>{ws(r)||console.log(r)}),"loading"):e.loadStatus:"loaded"}};u([d()],ss.prototype,"required",void 0),u([d({constructOnly:!0})],ss.prototype,"map",void 0),u([d({constructOnly:!0})],ss.prototype,"getSpatialReferenceSupport",void 0),u([d()],ss.prototype,"defaultSpatialReference",void 0),u([d()],ss.prototype,"userSpatialReference",void 0),u([d()],ss.prototype,"sourcePreloadCount",void 0),u([d()],ss.prototype,"priorityCollection",void 0),u([d()],ss.prototype,"requiresExtentInSpatialReference",void 0),u([d()],ss.prototype,"suspended",void 0),u([d({readOnly:!0})],ss.prototype,"ready",null),u([d({readOnly:!0})],ss.prototype,"heightModelInfoReady",null),u([d({readOnly:!0})],ss.prototype,"spatialReference",null),u([d({readOnly:!0})],ss.prototype,"extent",null),u([d({readOnly:!0})],ss.prototype,"heightModelInfo",null),u([d({readOnly:!0})],ss.prototype,"vcsWkid",null),u([d({readOnly:!0})],ss.prototype,"latestVcsWkid",null),u([d({readOnly:!0})],ss.prototype,"viewingMode",null),u([d({readOnly:!0})],ss.prototype,"tileInfo",null),u([d({readOnly:!0})],ss.prototype,"mapCollections",null),u([d({readOnly:!0})],ss.prototype,"_allLayers",null),u([d({readOnly:!0})],ss.prototype,"_spatialReferenceTask",null),u([d({readOnly:!0})],ss.prototype,"_tileInfoTask",null),u([d({readOnly:!0})],ss.prototype,"_heightModelInfoTask",null),u([d({readOnly:!0})],ss.prototype,"_extentCandidatesTask",null),u([d()],ss.prototype,"_extentTask",null),u([d()],ss.prototype,"_projectExtentTask",void 0),ss=u([R("esri.views.support.DefaultsFromMap")],ss);let _ut=class{constructor(){this.layers=new Array,this.preloading=-1,this.updating=!1}};var K3;let $t=K3=class extends Oc(Xr.EventedMixin(e$(me))){constructor(t){super(t),this._userSpatialReference=null,this._cursor=null,this.allLayerViews=new lP({getCollections:()=>[this.basemapView?.baseLayerViews,this.groundView?.layerViews,this.layerViews,this.basemapView?.referenceLayerViews],getChildrenFunction:but}),this.groundView=null,this.basemapView=null,this.fatalError=null,this.graphics=new nT,this.analyses=new CA,this.typeSpecificPreconditionsReady=!0,this.layerViews=new Ke,this.magnifier=new ERe,this.padding={left:0,top:0,right:0,bottom:0},this.ready=!1,this.spatialReferenceWarningDelay=1e3,this.supportsGround=!0,this.timeExtent=null,this.timeReference=new fA,this.type=null,this.scale=null,this.updating=!1,this.initialExtentRequired=!0,this.input=new dut,this.navigation=new IRe,this.layerViewManager=null,this.analysisViewManager=null,this.isHeightModelInfoRequired=!1,this.width=null,this.height=null,this.resizing=!1,this.suspended=!1,this.viewEvents=new iut(this),this.persistableViewModels=new Ke,this._isValid=!1,this._readyCycleForced=!1,this._currentSpatialReference=null,this.handles.add(Q(()=>this.preconditionsReady,e=>{e?(this._currentSpatialReference=this.spatialReference,K3.views.add(this)):(this._currentSpatialReference=null,K3.views.remove(this)),this.notifyChange("spatialReference"),!e&&this.ready?(this.toolViewManager?.detach(),this.analysisViewManager!=null&&this.analysisViewManager.detach(),this.layerViewManager?.clear(),this._teardown()):e&&!this.ready&&(this._startup(),this.analysisViewManager!=null&&this.analysisViewManager.attach(),this.toolViewManager.attach())},Rr))}initialize(){this.addResolvingPromise(this.validate().then(()=>(this._isValid=!0,Pn(()=>this.ready)))),this.basemapView=new Sv({view:this}),this.layerViewManager=new Xct({view:this,layerViewImporter:{importLayerView:t=>this.importLayerView(t),hasLayerViewModule:t=>this.hasLayerViewModule(t)},supportsGround:this.supportsGround}),this.toolViewManager=new Fp({view:this}),this._setupSpatialReferenceLogger(),this.handles.add([Q(()=>this.initialExtentRequired,t=>this.defaultsFromMap.required={...this.defaultsFromMap.required,extent:t},{sync:!0,initial:!0}),Q(()=>this.ready,t=>{this.defaultsFromMap&&(this.defaultsFromMap.suspended=t,this.defaultsFromMap.userSpatialReference=t?this.spatialReference:this._userSpatialReference)},{sync:!0}),Q(()=>this._userSpatialReference,t=>{this.defaultsFromMap&&(this.defaultsFromMap.userSpatialReference=t)},{sync:!0,initial:!0})])}_setupSpatialReferenceLogger(){let t=null;this.handles.add([Q(()=>this.defaultsFromMap?.ready,e=>{const r=this.map?.allLayers.length>0;if(e&&!this.spatialReference&&r){if(t!=null)return;const i=Zr(()=>t=Do(t));t=hb(async s=>{try{await YC(this.spatialReferenceWarningDelay,null,s)}catch{return}finally{t=null}K.getLogger(this).warn("#spatialReference","no spatial reference could be derived from the currently added map layers")}),this.handles.add(i,"spatial-reference-logger-task")}else this.handles.remove("spatial-reference-logger-task")},{sync:!0})])}destroy(){this.destroyed||(K3.views.remove(this),this.viewEvents.destroy(),this.allLayerViews.destroy(),this.navigation&&(this.navigation.destroy(),this._set("navigation",null)),this.graphics=Re(this.graphics),this.analyses=Re(this.analyses),this.handles.remove("defaultsFromMap"),this.defaultsFromMap.destroy(),this._set("defaultsFromMap",null),Re(this.analysisViewManager),this.toolViewManager=Re(this.toolViewManager),this.layerViewManager=Re(this.layerViewManager),this.basemapView=Re(this.basemapView),this.groundView?.destroy(),this.layerViews?.forEach(t=>t.destroy()),this.layerViews.length=0,this.invalidate(),this._emitter.clear(),this.handles.removeAll(),this.map=Re(this.map))}_startup(){this._set("ready",!0)}_teardown(){this._set("ready",!1)}whenReady(){return Promise.resolve(this)}toMap(){return K.getLogger(this).error("#toMap()","Not implemented on this instance of View"),null}get activeTool(){return this.toolViewManager?.activeTool}set activeTool(t){this.toolViewManager&&(this.toolViewManager.activeTool=t)}get animation(){return this._get("animation")}set animation(t){this._set("animation",t)}get center(){return null}get _defaultsFromMapSettings(){return{}}get defaultsFromMap(){return new ss({required:{tileInfo:!1,heightModelInfo:!1,extent:!1},map:()=>this.map,getSpatialReferenceSupport:t=>this.getSpatialReferenceSupport(t),...this._defaultsFromMapSettings})}get extent(){return this._get("extent")}set extent(t){this._set("extent",t)}get heightModelInfo(){return this.getDefaultHeightModelInfo()}get interacting(){return this.navigating}get navigating(){return!1}get preconditionsReady(){return!(this.fatalError||!this._isValid||this._readyCycleForced||!this.map||_g.isLoadable(this.map)&&!this.map.loaded||this.width===0||this.height===0||!this.spatialReference||!this._validateSpatialReference(this.spatialReference)||!this._currentSpatialReference&&!this.defaultsFromMap?.ready||!this.typeSpecificPreconditionsReady)}get resolution(){return 0}set map(t){t!==this._get("map")&&(t?.destroyed&&(K.getLogger(this).warn("#map","The provided map is already destroyed",{map:t}),t=null),_g.isLoadable(t)&&t.load().catch(()=>{}),this.constructed&&!this.destroyed&&(this.forceReadyCycle(),this._currentSpatialReference=null),this._set("map",t))}get spatialReference(){let t=this._userSpatialReference||this._currentSpatialReference||this.getDefaultSpatialReference()||null;return t&&this.defaultsFromMap?.required?.heightModelInfo&&(t=t.clone(),t.vcsWkid=this.defaultsFromMap.vcsWkid,t.latestVcsWkid=this.defaultsFromMap.latestVcsWkid),t}set spatialReference(t){const e=!Bn(t,this._get("spatialReference"));this._set("_userSpatialReference",t),e&&(this._set("spatialReference",t),this._spatialReferenceChanged(t))}_spatialReferenceChanged(t){}get stationary(){return!this.animation&&!this.navigating&&!this.resizing}get tools(){return this.toolViewManager?.tools}get initialExtent(){return this.defaultsFromMap?.extent}get cursor(){const t=this.toolViewManager?this.toolViewManager.cursor:null;return t??(this._cursor||"default")}set cursor(t){this._cursor=t,this.notifyChange("cursor")}get size(){return[this.width,this.height]}whenLayerView(t){return this.layerViewManager?.whenLayerView(t)??Promise.reject()}getDefaultSpatialReference(){return this.defaultsFromMap?.spatialReference}getDefaultHeightModelInfo(){return(this.map&&"heightModelInfo"in this.map?this.map.heightModelInfo:void 0)??this.defaultsFromMap?.heightModelInfo??null}importLayerView(t){throw new D("importLayerView() not implemented")}hasLayerViewModule(t){return!1}async validate(){}invalidate(){this._isValid=!1}getSpatialReferenceSupport(){return{constraints:null}}_validateSpatialReference(t){return this.getSpatialReferenceSupport({spatialReference:t})!=null}when(t,e){return this.isResolved()&&!this.ready&&K.getLogger(this).warn("#when()","Calling view.when() while the view is no longer ready but was already resolved once will resolve immediately. Use reactiveUtils.whenOnce(() => view.ready).then(...) instead."),super.when(t,e)}forceReadyCycle(){this.ready&&(No(()=>this.destroyed||this.preconditionsReady===!1,()=>this._readyCycleForced=!1,{once:!0}),this._readyCycleForced=!0)}addAndActivateTool(t){this.toolViewManager.tools.add(t),this.activeTool=t}tryFatalErrorRecovery(){this.fatalError=null}};$t.views=new Ke,u([d()],$t.prototype,"_userSpatialReference",void 0),u([d()],$t.prototype,"activeTool",null),u([d({readOnly:!0})],$t.prototype,"allLayerViews",void 0),u([d()],$t.prototype,"groundView",void 0),u([d()],$t.prototype,"animation",null),u([d()],$t.prototype,"basemapView",void 0),u([d()],$t.prototype,"center",null),u([d({readOnly:!0})],$t.prototype,"_defaultsFromMapSettings",null),u([d()],$t.prototype,"defaultsFromMap",null),u([d()],$t.prototype,"fatalError",void 0),u([d({type:vr})],$t.prototype,"extent",null),u([d(Hk(nT,"graphics"))],$t.prototype,"graphics",void 0),u([d(Hk(CA,"analyses"))],$t.prototype,"analyses",void 0),u([d({readOnly:!0,type:dS})],$t.prototype,"heightModelInfo",null),u([d({readOnly:!0})],$t.prototype,"interacting",null),u([d({readOnly:!0})],$t.prototype,"navigating",null),u([d({readOnly:!0,dependsOn:["fatalError","_isValid","_readyCycleForced","map","map.loaded?","width","height","spatialReference","_currentSpatialReference","defaultsFromMap.ready","typeSpecificPreconditionsReady"]})],$t.prototype,"preconditionsReady",null),u([d({readOnly:!0})],$t.prototype,"typeSpecificPreconditionsReady",void 0),u([d({type:Ke,readOnly:!0})],$t.prototype,"layerViews",void 0),u([d()],$t.prototype,"resolution",null),u([d({type:ERe})],$t.prototype,"magnifier",void 0),u([d({value:null,type:zAe})],$t.prototype,"map",null),u([d()],$t.prototype,"padding",void 0),u([d({readOnly:!0})],$t.prototype,"ready",void 0),u([d({type:qe})],$t.prototype,"spatialReference",null),u([d()],$t.prototype,"spatialReferenceWarningDelay",void 0),u([d()],$t.prototype,"stationary",null),u([d({readOnly:!0})],$t.prototype,"supportsGround",void 0),u([d({type:Ng})],$t.prototype,"timeExtent",void 0),u([d({type:fA,nonNullable:!0})],$t.prototype,"timeReference",void 0),u([d()],$t.prototype,"tools",null),u([d()],$t.prototype,"toolViewManager",void 0),u([d({readOnly:!0})],$t.prototype,"type",void 0),u([d({type:Number})],$t.prototype,"scale",void 0),u([d({readOnly:!0})],$t.prototype,"updating",void 0),u([d({readOnly:!0})],$t.prototype,"initialExtentRequired",void 0),u([d({readOnly:!0})],$t.prototype,"initialExtent",null),u([d()],$t.prototype,"cursor",null),u([d({readOnly:!0})],$t.prototype,"input",void 0),u([d({type:IRe,nonNullable:!0})],$t.prototype,"navigation",void 0),u([d()],$t.prototype,"layerViewManager",void 0),u([d()],$t.prototype,"analysisViewManager",void 0),u([d()],$t.prototype,"width",void 0),u([d()],$t.prototype,"height",void 0),u([d({readOnly:!0})],$t.prototype,"resizing",void 0),u([d({value:null,readOnly:!0})],$t.prototype,"size",null),u([d({readOnly:!0})],$t.prototype,"suspended",void 0),u([d({readOnly:!0})],$t.prototype,"viewEvents",void 0),u([d({readOnly:!0})],$t.prototype,"persistableViewModels",void 0),u([d()],$t.prototype,"_isValid",void 0),u([d()],$t.prototype,"_readyCycleForced",void 0),u([d()],$t.prototype,"_currentSpatialReference",void 0),$t=K3=u([R("esri.views.View")],$t);const vut=$t;function but(t){return t.layerViews}let Cv=class extends lk{constructor(e){super(e),this.state="running",this.target=null,this._resolver=null}initialize(){this._resolver=nn(),this.addResolvingPromise(this._resolver.promise)}get done(){return this.state==="finished"||this.state==="stopped"}stop(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","stopped"),this._resolver?.reject(new D("ViewAnimation stopped")))}finish(){this.state!=="stopped"&&this.state!=="finished"&&(this._set("state","finished"),this._resolver?.resolve())}update(e,r){r||(r=Rh(e)?"waiting-for-target":"running"),this._set("target",e),this._set("state",r)}};u([d({readOnly:!0})],Cv.prototype,"done",null),u([d({readOnly:!0,type:String})],Cv.prototype,"state",void 0),u([d()],Cv.prototype,"target",void 0),Cv=u([R("esri.views.ViewAnimation")],Cv),function(t){t.State={RUNNING:"running",STOPPED:"stopped",FINISHED:"finished",WAITING_FOR_TARGET:"waiting-for-target"}}(Cv||(Cv={}));const OA=Cv,hR=()=>J(()=>import("./TileLayerView3D-08a97061.js"),["./TileLayerView3D-08a97061.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./MapServiceLayerViewHelper-79a3128a.js","./floorFilterUtils-73949d2d.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./sublayerUtils-0d3cd1fc.js"],import.meta.url),xue=()=>J(()=>import("./ElevationLayerView3D-451b091a.js"),["./ElevationLayerView3D-451b091a.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./LayerView-200784d6.js"],import.meta.url),Tue={"base-dynamic":()=>J(()=>import("./BaseDynamicLayerView3D-e49468b3.js"),["./BaseDynamicLayerView3D-e49468b3.js","./DynamicLayerView3D-3f27827b.js","./LayerView3D-b22e015d.js","./projectExtentUtils-2b7f21f8.js","./ImageMaterial-0a3c66dc.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"base-elevation":xue,"base-tile":hR,"bing-maps":hR,"building-scene":()=>J(()=>import("./BuildingSceneLayerView3D-8c5749e9.js"),["./BuildingSceneLayerView3D-8c5749e9.js","./BuildingGroupSublayer-5a24c8ea.js","./BuildingComponentSublayer-cc905911.js","./WhereClause-dc16111f.js","./I3SMeshView3D-418a4136.js","./I3SOverrides-72e2b294.js","./I3SNode-8310efaa.js","./meshFeatureSet-89a4fc28.js","./Mesh-5e599da2.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./MeshTransform-24e5f7d8.js","./georeference-f88d775a.js","./External-c5063428.js","./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./SceneModification-d0332e21.js","./SceneLayerWorker-00420594.js","./I3SQueryFeatureStore-9807b9d8.js","./DefinitionExpressionSceneLayerView-4651abc1.js"],import.meta.url),csv:()=>J(()=>import("./CSVLayerView3D-0a99fd80.js"),["./CSVLayerView3D-0a99fd80.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),dimension:()=>J(()=>import("./DimensionLayerView3D-5730bc49.js"),["./DimensionLayerView3D-5730bc49.js","./LayerView3D-b22e015d.js","./LayerView-200784d6.js"],import.meta.url),elevation:xue,feature:()=>J(()=>import("./FeatureLayerView3D-a432d75a.js"),["./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),geojson:()=>J(()=>import("./GeoJSONLayerView3D-7542721d.js"),["./GeoJSONLayerView3D-7542721d.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),graphics:()=>J(()=>import("./GraphicsLayerView3D-a4a16c28.js"),["./GraphicsLayerView3D-a4a16c28.js","./LayerView3D-b22e015d.js","./queryForSymbologySnapping-fd994e68.js","./GraphicsProcessor-5c167a1f.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./projectExtentUtils-2b7f21f8.js","./LayerView-200784d6.js"],import.meta.url),group:()=>J(()=>import("./GroupLayerView-b71f59a3.js"),["./GroupLayerView-b71f59a3.js","./LayerView-200784d6.js"],import.meta.url),imagery:()=>J(()=>import("./ImageryLayerView3D-7768d341.js"),["./ImageryLayerView3D-7768d341.js","./DynamicLayerView3D-3f27827b.js","./LayerView3D-b22e015d.js","./projectExtentUtils-2b7f21f8.js","./ImageMaterial-0a3c66dc.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"integrated-mesh":()=>J(()=>import("./IntegratedMeshLayerView3D-c9dac2ce.js"),["./IntegratedMeshLayerView3D-c9dac2ce.js","./I3SMeshView3D-418a4136.js","./I3SOverrides-72e2b294.js","./I3SNode-8310efaa.js","./meshFeatureSet-89a4fc28.js","./Mesh-5e599da2.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./MeshTransform-24e5f7d8.js","./georeference-f88d775a.js","./External-c5063428.js","./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./SceneModification-d0332e21.js","./SceneLayerWorker-00420594.js"],import.meta.url),"line-of-sight":()=>J(()=>import("./LineOfSightLayerView3D-d421467c.js"),["./LineOfSightLayerView3D-d421467c.js","./LayerView3D-b22e015d.js","./LayerView-200784d6.js"],import.meta.url),"map-image":()=>J(()=>import("./MapImageLayerView3D-f87d0f95.js"),["./MapImageLayerView3D-f87d0f95.js","./DynamicLayerView3D-3f27827b.js","./LayerView3D-b22e015d.js","./projectExtentUtils-2b7f21f8.js","./ImageMaterial-0a3c66dc.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./ExportImageParameters-68b39ab3.js","./floorFilterUtils-73949d2d.js","./sublayerUtils-0d3cd1fc.js","./MapServiceLayerViewHelper-79a3128a.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js"],import.meta.url),media:()=>J(()=>import("./MediaLayerView3D-ebfdab53.js"),["./MediaLayerView3D-ebfdab53.js","./MediaElementView-659f07c2.js","./normalizeUtilsSync-cd43bd7f.js","./normalizeUtilsCommon-24f79564.js","./LayerView3D-b22e015d.js","./ImageMaterial-0a3c66dc.js","./LayerView-200784d6.js"],import.meta.url),"ogc-feature":()=>J(()=>import("./OGCFeatureLayerView3D-38d9ab5d.js"),["./OGCFeatureLayerView3D-38d9ab5d.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"open-street-map":hR,"oriented-imagery":()=>J(()=>import("./FeatureLayerView3D-a432d75a.js"),["./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"point-cloud":()=>J(()=>import("./PointCloudLayerView3D-c16d78b3.js").then(t=>t.P),["./PointCloudLayerView3D-c16d78b3.js","./LayerView3D-b22e015d.js","./PointCloudWorkerUtil-b73389e5.js","./PointCloudUniqueValueRenderer-c626c65c.js","./PopupSceneLayerView-e8802a4f.js","./LayerView-200784d6.js"],import.meta.url),voxel:()=>J(()=>import("./VoxelLayerView3D-4eefdf20.js"),["./VoxelLayerView3D-4eefdf20.js","./LayerView3D-b22e015d.js","./PopupSceneLayerView-e8802a4f.js","./LayerView-200784d6.js"],import.meta.url),route:()=>J(()=>import("./RouteLayerView3D-a0d253a0.js"),["./RouteLayerView3D-a0d253a0.js","./Stop-17f6d71a.js","./LayerView3D-b22e015d.js","./GraphicsProcessor-5c167a1f.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./projectExtentUtils-2b7f21f8.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js"],import.meta.url),scene:t=>t.profile==null||t.profile==="mesh-pyramids"?J(()=>import("./SceneLayerView3D-32ed9226.js"),["./SceneLayerView3D-32ed9226.js","./I3SOverrides-72e2b294.js","./I3SNode-8310efaa.js","./meshFeatureSet-89a4fc28.js","./Mesh-5e599da2.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./MeshTransform-24e5f7d8.js","./georeference-f88d775a.js","./External-c5063428.js","./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./I3SMeshView3D-418a4136.js","./SceneModification-d0332e21.js","./SceneLayerWorker-00420594.js","./SceneLayerView-046ec554.js","./DefinitionExpressionSceneLayerView-4651abc1.js","./I3SQueryFeatureStore-9807b9d8.js","./PopupSceneLayerView-e8802a4f.js"],import.meta.url):J(()=>import("./SceneLayerGraphicsView3D-8bcae97a.js"),["./SceneLayerGraphicsView3D-8bcae97a.js","./I3SOverrides-72e2b294.js","./I3SNode-8310efaa.js","./meshFeatureSet-89a4fc28.js","./Mesh-5e599da2.js","./MeshGeoreferencedRelativeVertexSpace-78553062.js","./MeshLocalVertexSpace-7526bf91.js","./MeshTransform-24e5f7d8.js","./georeference-f88d775a.js","./External-c5063428.js","./FeatureLayerView3D-a432d75a.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./SceneLayerView-046ec554.js","./DefinitionExpressionSceneLayerView-4651abc1.js","./PopupSceneLayerView-e8802a4f.js"],import.meta.url),stream:()=>J(()=>import("./StreamLayerView3D-aaba473b.js"),["./StreamLayerView3D-aaba473b.js","./StreamFeatureManager-ae5cd9d5.js","./createConnection-532a08b9.js","./query-2f8589ea.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./LayerView-200784d6.js"],import.meta.url),tile:hR,"imagery-tile":()=>J(()=>import("./ImageryTileLayerView3D-34a2870e.js"),["./ImageryTileLayerView3D-34a2870e.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./rasterProjectionHelper-f92550de.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"vector-tile":()=>J(()=>import("./VectorTileLayerView3D-a82c9779.js"),["./VectorTileLayerView3D-a82c9779.js","./Rect-98da58d6.js","./pbf-10aa4b25.js","./rasterizingUtils-0eaad164.js","./TileInfoView-8e05b841.js","./definitions-4b766362.js","./number-e491b09e.js","./GeometryUtils-0258f920.js","./StyleRepository-37fe00eb.js","./TileClipper-ae6eca9e.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./LayerView-200784d6.js"],import.meta.url),wcs:()=>J(()=>import("./ImageryTileLayerView3D-34a2870e.js"),["./ImageryTileLayerView3D-34a2870e.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./rasterProjectionHelper-f92550de.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"web-tile":hR,wfs:()=>J(()=>import("./WFSLayerView3D-76c79dbe.js"),["./WFSLayerView3D-76c79dbe.js","./FeatureLayerViewBase3D-f187104a.js","./FeatureLikeLayerView3D-5042cb26.js","./dehydratedFeatureComparison-860c6b48.js","./queryForSymbologySnapping-fd994e68.js","./hash-6f442295.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js","./floorFilterUtils-73949d2d.js","./QueryEngine-27d6735e.js","./normalizeUtils-a5d2b0fe.js","./normalizeUtilsCommon-24f79564.js","./WhereClause-dc16111f.js","./json-48e3ea08.js","./QueryEngineCapabilities-42e44ded.js","./utils-044ce772.js","./generateRendererUtils-6b5398d1.js","./FeatureStore-b0a4d6f3.js","./BoundsStore-a4d619df.js","./projectExtentUtils-2b7f21f8.js","./LayerView3D-b22e015d.js","./query-2f8589ea.js","./pbfQueryUtils-0dd7c50f.js","./pbf-10aa4b25.js","./EventedSet-a956fe62.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),wms:()=>J(()=>import("./WMSLayerView3D-e3a7c63c.js"),["./WMSLayerView3D-e3a7c63c.js","./DynamicLayerView3D-3f27827b.js","./LayerView3D-b22e015d.js","./projectExtentUtils-2b7f21f8.js","./ImageMaterial-0a3c66dc.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js","./ExportWMSImageParameters-d87e4534.js"],import.meta.url),wmts:()=>J(()=>import("./WMTSLayerView3D-23c3f781.js"),["./WMTSLayerView3D-23c3f781.js","./LayerView3D-b22e015d.js","./TiledLayerView3D-b8b98410.js","./LayerView-200784d6.js","./RefreshableLayerView-eb18be25.js"],import.meta.url),"geo-rss":null,kml:null,"knowledge-graph":null,"link-chart":null,"knowledge-graph-sublayer":null,"map-notes":null,"subtype-group":null,unknown:null,unsupported:null,video:null};function wut(t){const e=t.declaredClass?t.declaredClass.slice(t.declaredClass.lastIndexOf(".")+1):"Unknown",r=e.replaceAll(/([a-z])([A-Z])/g,"$1-$2").toLowerCase();return new D(`${r}:view-not-supported`,`${e} is not supported in 3D`)}const Sue={hasLayerViewModule:t=>Tue[t.type]!=null,importLayerView:t=>{const e=Tue[t.type];if(e==null)throw wut(t);return e(t)}},Eue="analyses-owner-handles";var iC,Ix;(function(t){t[t.PENDING=0]="PENDING",t[t.CREATED=1]="CREATED"})(iC||(iC={})),function(t){t[t.ADDED=0]="ADDED",t[t.REMOVED=1]="REMOVED"}(Ix||(Ix={}));let ex=class extends wT{constructor(e){super(e),this._allAnalysisViews=new Ke,this._creatingViewCount=0,this._items=new Map,this._scheduledUpdateHandle=null,this._attachedToViewResolver=Cue(),this._analysisModules={"area-measurement":{module:null},dimension:{module:null},"direct-line-measurement":{module:null},"line-of-sight":{module:null},slice:{module:null}}}destroy(){this._disconnectOwners(),this._attachedToViewResolver.reject(Tr("AnalysisViewManager was destroyed"))}attach(){this._connectOwners(),this._attachedToViewResolver.resolve()}detach(){this._disconnectOwners(),this._attachedToViewResolver.reject(Tr()),this._attachedToViewResolver=Cue()}get updating(){return!this.view.ready||this._creatingViewCount!==0||this._allAnalysisViews.some(e=>e.updating)}get testInfo(){return{allAnalysisViews:this._allAnalysisViews}}async whenAnalysisView(e){await this._attachedToViewResolver.promise;const r=this._items.get(e);if(r==null||r.state.list===Ix.REMOVED)throw new D("AnalysisViewManager:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:e});return r.createAnalysisViewTask.promise}_connectOwners(){this.handles.add(this._connectAnalysesCollection(this.view.analyses),Eue)}_disconnectOwners(){this.handles.remove(Eue),this._update(),this._creatingViewCount=0}_connectAnalysesCollection(e){for(const s of e)this._addAnalysis(s);const r=e.on("after-add",s=>this._addAnalysis(s.item)),i=e.on("after-remove",s=>this._removeAnalysis(s.item));return{remove:()=>{r.remove(),i.remove();for(const s of e)this._removeAnalysis(s)}}}_addAnalysis(e){const r=this._items.get(e);if(r==null){const i={state:{view:iC.PENDING,list:Ix.ADDED},analysis:e,view:null,createAnalysisViewTask:null};this._items.set(e,i),i.createAnalysisViewTask=hb(s=>this._createAnalysisViewPromise(i,s))}else r.state.list=Ix.ADDED}_removeAnalysis(e){const r=this._items.get(e);r!=null?(r.state.list=Ix.REMOVED,this._scheduleUpdate()):K.getLogger(this).error("Trying to remove analysis which was not added")}_scheduleUpdate(){this._scheduledUpdateHandle==null&&(this._scheduledUpdateHandle=iO(()=>this._update()))}_update(){this._scheduledUpdateHandle=Pi(this._scheduledUpdateHandle),this._items.forEach(e=>{if(e.state.list===Ix.REMOVED)switch(this._items.delete(e.analysis),e.state.view){case iC.PENDING:e.createAnalysisViewTask=Do(e.createAnalysisViewTask);break;case iC.CREATED:e.view!=null&&(this._allAnalysisViews.remove(e.view),e.view=Re(e.view),e.createAnalysisViewTask=null)}})}async _createAnalysisViewPromise(e,r){const i=e.analysis,s=i.type,n=this._analysisModules[s];if(this._creatingViewCount+=1,n.module==null)try{n.module=await this._loadAnalysisModule(s)}catch(a){throw this._creatingViewCount-=1,a}if(dn(r))throw this._creatingViewCount-=1,Tr("AnalysisView creation aborted");const o=new n.module.default({analysis:i,view:this.view});try{await o.when()}catch(a){throw this._creatingViewCount-=1,a}if(dn(r))throw this._creatingViewCount-=1,o.destroy(),Tr("AnalysisView creation aborted");return e.view=o,e.state.view=iC.CREATED,this._allAnalysisViews.add(o),this._creatingViewCount-=1,o}_loadAnalysisModule(e){switch(e){case"area-measurement":return J(()=>import("./AreaMeasurementAnalysisView3D-9c51a0ec.js").then(r=>r.A),["./AreaMeasurementAnalysisView3D-9c51a0ec.js","./UnitNormalizer-5903d798.js","./getDefaultUnitForView-399249e8.js","./AnalysisView3D-cfac887c.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./euclideanAreaMeasurementUtils-c18253b7.js","./measurementUtils-6d7e5fc6.js","./LineVisualElement-b4960232.js","./EditGeometryOperations-36bcef90.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./Segment-71ac8f09.js","./TextOverlayItem-7000102f.js"],import.meta.url);case"dimension":return J(()=>import("./DimensionAnalysisView3D-7ce84e69.js"),["./DimensionAnalysisView3D-7ce84e69.js","./AnalysisView3D-cfac887c.js","./LengthDimension-43edc737.js","./getDefaultUnitForView-399249e8.js","./Segment-71ac8f09.js","./LineVisualElement-b4960232.js","./TextOverlayItem-7000102f.js","./euclideanLengthMeasurementUtils-37e24abd.js","./measurementUtils-6d7e5fc6.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./Factory-1fcb5e33.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./VerticesVisualElement-39765817.js","./RightAngleQuadVisualElement-54788f2a.js","./VisualElementResources-b7d29b2e.js","./PointVisualElement-d90294de.js","./SnappingContext-c96cf417.js","./PointSnappingHint-512a7cc6.js","./EditGeometryOperations-36bcef90.js","./SnappingOperation-3825d76a.js","./dehydratedFeatureComparison-860c6b48.js","./analysisViewUtils-fe82c30d.js"],import.meta.url);case"direct-line-measurement":return J(()=>import("./DirectLineMeasurementAnalysisView3D-e985bf47.js").then(r=>r.D),["./DirectLineMeasurementAnalysisView3D-e985bf47.js","./UnitNormalizer-5903d798.js","./getDefaultUnitForView-399249e8.js","./AnalysisView3D-cfac887c.js","./geometryEngine-56bd014d.js","./geometryEngineBase-7a1f11c2.js","./hydrated-3d997481.js","./LineVisualElement-b4960232.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./Segment-71ac8f09.js","./TextOverlayItem-7000102f.js","./RightAngleQuadVisualElement-54788f2a.js","./VisualElementResources-b7d29b2e.js"],import.meta.url);case"line-of-sight":return J(()=>import("./LineOfSightAnalysisView3D-62ed2a3f.js"),["./LineOfSightAnalysisView3D-62ed2a3f.js","./AnalysisView3D-cfac887c.js","./LineOfSightAnalysisTarget-440ae029.js","./LineVisualElement-b4960232.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./manipulatorUtils-27852ca8.js","./PointVisualElement-d90294de.js","./VisualElementResources-b7d29b2e.js","./analysisViewUtils-fe82c30d.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js"],import.meta.url);case"slice":return J(()=>import("./SliceAnalysisView3D-c46791b8.js"),["./SliceAnalysisView3D-c46791b8.js","./AnalysisView3D-cfac887c.js","./sliceToolUtils-b07a6204.js","./analysisThemeUtils-8c8dee01.js","./colorUtils-c9a97827.js","./LineVisualElement-b4960232.js","./manipulatorUtils-adaad8cc.js","./ImageMaterial-0a3c66dc.js","./BuildingComponentSublayer-cc905911.js","./Factory-1fcb5e33.js","./dragEventPipeline-4a965366.js","./drawUtils-3b7b83b9.js","./analysisViewUtils-fe82c30d.js"],import.meta.url)}}};function Cue(){const t=nn();return t.promise.catch(()=>{}),t}u([d()],ex.prototype,"updating",null),u([d({constructOnly:!0})],ex.prototype,"view",void 0),u([d()],ex.prototype,"_allAnalysisViews",void 0),u([d()],ex.prototype,"_creatingViewCount",void 0),ex=u([R("esri.views.3d.analysis.AnalysisViewManager3D")],ex);const xut=ex;let Iy=class extends me{constructor(e){super(e),this.collision=new eM,this.distance=1/0,this.minimumPoiDistance=4,this.tilt=null}get altitude(){return this.mode===Ue.Local?null:this._get("altitude")||null}set altitude(e){this.mode!==Ue.Local?this._set("altitude",e):K.getLogger(this).warn("Altitude constraint is ignored in local scenes")}clampAltitude(e){return this.altitude?ye(e,this.altitude.min,this.altitude.max):e}clampTilt(e,r){if(!this.tilt)return r;const i=this.tilt(e);return ye(r,i.min,i.max)}clampDistance(e){return Math.min(e,this.distance)}createDefaultTilt(){return this.mode===Ue.Local?this._createDefaultTiltLocal():this._createDefaultTiltGlobal()}createConstantMaxTilt(e){return(r,i=Zz)=>(i.min=wa.min,i.max=e,i)}_createDefaultTiltLocal(){const e=this.collision.enabled?U4([[4e3,wa.max],[1e4,zt(88)],[6e6,zt(88)]]):()=>wa.max;return(r,i=Zz)=>(i.min=wa.min,i.max=e(r),i)}_createDefaultTiltGlobal(){const e=this.collision.enabled?U4([[4e3,wa.max],[5e4,zt(88)],[6e6,zt(88)],[2e7,wa.min]]):U4([[3e5,wa.max],[3e6,zt(88)],[6e6,zt(88)],[2e7,wa.min]]);return(r,i=Zz)=>(i.min=wa.min,i.max=e(r),i)}};function Tut(t){return{min:-2e5,max:4*t.radius}}u([d()],Iy.prototype,"altitude",null),u([d({readOnly:!0})],Iy.prototype,"collision",void 0),u([d()],Iy.prototype,"distance",void 0),u([d({readOnly:!0})],Iy.prototype,"minimumPoiDistance",void 0),u([d()],Iy.prototype,"tilt",void 0),u([d({constructOnly:!0})],Iy.prototype,"mode",void 0),Iy=u([R("esri.views.3d.state.Constraints")],Iy);const Aue=Tut(ur),wa={min:zt(.5),max:zt(179.5)},Zz={min:0,max:0};let eM=class extends me{constructor(){super(...arguments),this.enabled=!0,this.elevationMargin=5}};u([d({type:Boolean})],eM.prototype,"enabled",void 0),u([d({type:Number})],eM.prototype,"elevationMargin",void 0),eM=u([R("esri.views.3d.state.Constraints.CollisionConstraint")],eM);let sC=class extends me{constructor(){super(...arguments),this.min=Aue.min,this.max=Aue.max}};u([d({type:Number})],sC.prototype,"min",void 0),u([d({type:Number})],sC.prototype,"max",void 0),sC=u([R("esri.views.3d.constraints.AltitudeConstraint")],sC);let Gy=class extends me{constructor(){super(...arguments),this.mode="auto"}get near(){return this._get("near")}set near(e){this._set("near",e),e>=this._get("far")&&(this.far=e+1e-9),this.mode="manual"}castNear(e){return Math.max(1e-8,e)}get far(){return this._get("far")}set far(e){this._set("far",e),e<=this._get("near")&&(this.near=e-1e-9),this.mode="manual"}castFar(e){return Math.max(1e-8,e)}autoUpdate(e,r){this.mode==="auto"&&(this._get("near")!==e&&this._set("near",e),this._get("far")!==r&&this._set("far",r))}};u([d({type:Number,value:1e-8})],Gy.prototype,"near",null),u([or("near")],Gy.prototype,"castNear",null),u([d({type:Number,value:1e-8})],Gy.prototype,"far",null),u([or("far")],Gy.prototype,"castFar",null),u([d({type:["auto","manual"]})],Gy.prototype,"mode",void 0),Gy=u([R("esri.views.3d.constraints.ClipDistanceConstraint")],Gy);const jZ={min:Vl(wa.min),max:Vl(wa.max)};let Px=class extends me{constructor(){super(...arguments),this.mode="auto"}get max(){return this._get("max")}set max(e){this._set("max",e),this.mode="manual"}castMax(e){return ye(e,jZ.min,jZ.max)}autoUpdate(e){this.mode==="auto"&&this._get("max")!==e&&this._set("max",e)}};u([d({type:["auto","manual"]})],Px.prototype,"mode",void 0),u([d({type:Number,value:jZ.max})],Px.prototype,"max",null),u([or("max")],Px.prototype,"castMax",null),Px=u([R("esri.views.3d.constraints.TiltConstraint")],Px);let $x=class extends me{constructor(){super(...arguments),this.tilt=new Px,this.altitude=new sC,this.clipDistance=new Gy}};u([d({type:Px})],$x.prototype,"tilt",void 0),u([d({type:sC})],$x.prototype,"altitude",void 0),u([d({type:Gy})],$x.prototype,"clipDistance",void 0),$x=u([R("esri.views.3d.constraints.Constraints")],$x);var HZ;let rd=HZ=class extends he{constructor(t){super(t),this.type="sun",this.date=null,this.directShadowsEnabled=!1,this.displayUTCOffset=null}readDate(t,e){return e.datetime!=null&&new Date(e.datetime)||null}writeDate(t,e,r){e[r]=t.getTime()}readDirectShadowsEnabled(t,e){return!!e.directShadows}writedirectShadowsEnabled(t,e,r){t&&(e[r]=t)}writeDisplayUTCOffset(t,e){t!=null&&(e.displayUTCOffset=t)}clone(){return new HZ(this.cloneConstructProperties())}cloneConstructProperties(){const t={directShadowsEnabled:this.directShadowsEnabled,displayUTCOffset:this.displayUTCOffset!=null?this.displayUTCOffset:null};return this.date!=null&&(t.date=new Date(this.date.getTime())),t}};u([d({readOnly:!0,type:["sun"],json:{write:!0}})],rd.prototype,"type",void 0),u([d({type:Date,json:{type:Number,write:{target:"datetime"}}})],rd.prototype,"date",void 0),u([Ae("date",["datetime"])],rd.prototype,"readDate",null),u([Ve("date")],rd.prototype,"writeDate",null),u([d({type:Boolean,json:{default:!1,write:{target:"directShadows"}}})],rd.prototype,"directShadowsEnabled",void 0),u([Ae("directShadowsEnabled",["directShadows"])],rd.prototype,"readDirectShadowsEnabled",null),u([Ve("directShadowsEnabled")],rd.prototype,"writedirectShadowsEnabled",null),u([d({type:Number,json:{write:!0}})],rd.prototype,"displayUTCOffset",void 0),u([Ve("displayUTCOffset")],rd.prototype,"writeDisplayUTCOffset",null),rd=HZ=u([R("esri.webscene.SunLighting")],rd);const dP=rd;var bE;const kRe="esri.views.3d.environment.SunLighting",yD=K.getLogger(kRe);let Mm=bE=class extends Xr.EventedMixin(dP){constructor(t){super(t),this.cameraTrackingEnabled=!0,this.positionTimezoneInfo={hours:0,minutes:0,seconds:0,autoUpdated:!0};const e=new Date().getFullYear(),r=new Date("March 15, "+e+" 12:00:00 UTC");this._set("defaultDate",r),this._set("date",r)}get ambientOcclusionEnabled(){return Ka(yD,"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._get("ambientOcclusionEnabled")??!1}set ambientOcclusionEnabled(t){Ka(yD,"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",t)}get waterReflectionEnabled(){return Ka(yD,"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),this._get("waterReflectionEnabled")??!1}set waterReflectionEnabled(t){Ka(yD,"waterReflectionEnabled",{replacement:"reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",t)}get defaultDate(){return new Date(this._get("defaultDate").getTime())}static fromWebsceneLighting(t){return new bE(t.cloneConstructProperties())}set defaultDate(t){const e=this._get("date")===this._get("defaultDate");t=new Date(t.getTime()),this._set("defaultDate",t),e&&this._set("date",t)}set date(t){t!=null&&(this.positionTimezoneInfo.autoUpdated=!1,this._set("date",new Date(t.getTime())))}autoUpdate(t,e){const r=bE.calculateTimezoneOffset(this.positionTimezoneInfo);this.positionTimezoneInfo.hours=e.hours,this.positionTimezoneInfo.minutes=e.minutes,this.positionTimezoneInfo.seconds=e.seconds;let i=null;t!=null&&(this.positionTimezoneInfo.autoUpdated=!0,isNaN(t.getTime())?(i=this.defaultDate.getTime(),this._set("date",this.defaultDate)):(i=this.date&&this.date.getTime(),this._set("date",new Date(t.getTime()))));const s=bE.calculateTimezoneOffset(this.positionTimezoneInfo);if(r!==s&&(_D.target=this,_D.timezoneOffset=s,this.emit("timezone-will-change",_D),_D.target=null),t!=null)return isNaN(t.getTime())||i!==t.getTime()}clone(){const t=this._get("date")===this._get("defaultDate"),e=new bE({...this.cloneConstructProperties(),defaultDate:this.defaultDate,cameraTrackingEnabled:this.cameraTrackingEnabled});return t&&e._set("date",e._get("defaultDate")),e.positionTimezoneInfo.autoUpdated=this.positionTimezoneInfo.autoUpdated,e.positionTimezoneInfo.hours=this.positionTimezoneInfo.hours,e.positionTimezoneInfo.minutes=this.positionTimezoneInfo.minutes,e.positionTimezoneInfo.seconds=this.positionTimezoneInfo.seconds,e}cloneWithWebsceneLighting(t){const e=this.clone();return t.date!=null&&(e.date=t.date),e.directShadowsEnabled=t.directShadowsEnabled,e.displayUTCOffset=t.displayUTCOffset,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],Mm.prototype,"cameraTrackingEnabled",void 0),u([d({type:Boolean})],Mm.prototype,"ambientOcclusionEnabled",null),u([d({type:Boolean})],Mm.prototype,"waterReflectionEnabled",null),u([d({type:Date})],Mm.prototype,"defaultDate",null),u([d({type:Date})],Mm.prototype,"date",null),Mm=bE=u([R(kRe)],Mm),function(t){function e({hours:r,minutes:i,seconds:s}){return Math.round(r+i/60+s/3600)}t.calculateTimezoneOffset=e}(Mm||(Mm={}));const _D={target:null,timezoneOffset:0},Av=Mm;var qZ;let tM=qZ=class extends he{constructor(t){super(t),this.type="virtual",this.directShadowsEnabled=!1}clone(){return new qZ(this.cloneConstructProperties())}cloneConstructProperties(){return{directShadowsEnabled:this.directShadowsEnabled}}};u([d({readOnly:!0,type:["virtual"],json:{write:!0}})],tM.prototype,"type",void 0),u([d({type:Boolean,json:{default:!1,name:"directShadows",write:!0}})],tM.prototype,"directShadowsEnabled",void 0),tM=qZ=u([R("esri.webscene.VirtualLighting")],tM);const i8=tM;var H4;const URe="esri.views.3d.environment.VirtualLighting",vD=K.getLogger(URe);let wE=H4=class extends Xr.EventedMixin(i8){constructor(t){super(t),this.cameraTrackingEnabled=!0}get ambientOcclusionEnabled(){return Ka(vD,"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._get("ambientOcclusionEnabled")??!1}set ambientOcclusionEnabled(t){Ka(vD,"ambientOcclusionEnabled",{replacement:"ambient occlusion is automatically shown and this property has no effect",version:"4.27"}),this._set("ambientOcclusionEnabled",t)}get waterReflectionEnabled(){return Ka(vD,"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),this._get("waterReflectionEnabled")??!1}set waterReflectionEnabled(t){Ka(vD,"waterReflectionEnabled",{replacement:"water reflections are automatically shown and this property has no effect",version:"4.27"}),this._set("waterReflectionEnabled",t)}clone(){return new H4({...this.cloneConstructProperties(),cameraTrackingEnabled:this.cameraTrackingEnabled})}static fromWebsceneLighting(t){return new H4(t.cloneConstructProperties())}cloneWithWebsceneLighting(t){const e=this.clone();return e.directShadowsEnabled=t.directShadowsEnabled,e}cloneNonPersistentConstructProperties(){return{cameraTrackingEnabled:this.cameraTrackingEnabled}}};u([d({type:Boolean})],wE.prototype,"ambientOcclusionEnabled",null),u([d({type:Boolean})],wE.prototype,"waterReflectionEnabled",null),u([d({type:Boolean})],wE.prototype,"cameraTrackingEnabled",void 0),wE=H4=u([R(URe)],wE);const rM=wE,Sut={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:Av,virtual:rM}};var WZ;let sI=WZ=class extends me{set quality(t){["low","high"].includes(t)&&this._set("quality",t)}clone(){return new WZ({quality:this.quality})}};u([d({type:["low","high"],value:"low"})],sI.prototype,"quality",null),sI=WZ=u([R("esri.views.3d.environment.SceneViewAtmosphere")],sI);var ZZ;let iM=ZZ=class extends he{constructor(t){super(t),this.type="sunny",this.cloudCover=.5}clone(){return new ZZ({cloudCover:this.cloudCover})}};u([nt({sunny:"sunny"})],iM.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],iM.prototype,"cloudCover",void 0),iM=ZZ=u([R("esri.views.3d.environment.SunnyWeather")],iM);const XZ=iM;var YZ;let sM=YZ=class extends he{constructor(t){super(t),this.type="cloudy",this.cloudCover=.5}clone(){return new YZ({cloudCover:this.cloudCover})}};u([nt({cloudy:"cloudy"})],sM.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],sM.prototype,"cloudCover",void 0),sM=YZ=u([R("esri.views.3d.environment.CloudyWeather")],sM);const Eut=sM;var JZ;let nM=JZ=class extends he{constructor(t){super(t),this.type="foggy",this.fogStrength=.5}clone(){return new JZ({fogStrength:this.fogStrength})}};u([nt({foggy:"foggy"})],nM.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],nM.prototype,"fogStrength",void 0),nM=JZ=u([R("esri.views.3d.environment.FoggyWeather")],nM);const Cut=nM;var QZ;let xE=QZ=class extends he{constructor(t){super(t),this.type="rainy",this.cloudCover=.5,this.precipitation=.5}clone(){return new QZ({cloudCover:this.cloudCover,precipitation:this.precipitation})}};u([nt({rainy:"rainy"})],xE.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],xE.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],xE.prototype,"precipitation",void 0),xE=QZ=u([R("esri.views.3d.environment.RainyWeather")],xE);const Aut=xE;var KZ;let tx=KZ=class extends he{constructor(t){super(t),this.type="snowy",this.cloudCover=.5,this.precipitation=.5,this.snowCover="disabled"}clone(){return new KZ({cloudCover:this.cloudCover,precipitation:this.precipitation,snowCover:this.snowCover})}};u([nt({snowy:"snowy"})],tx.prototype,"type",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],tx.prototype,"cloudCover",void 0),u([d({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],tx.prototype,"precipitation",void 0),u([d({type:["enabled","disabled"],nonNullable:!0,json:{write:!0}})],tx.prototype,"snowCover",void 0),tx=KZ=u([R("esri.views.3d.environment.SnowyWeather")],tx);const Out=tx,VRe={key:"type",base:XZ,typeMap:{sunny:XZ,cloudy:Eut,rainy:Aut,snowy:Out,foggy:Cut}},Rut=Object.keys(VRe.typeMap);function Mut(t,e){return!!Rut.includes(t)||(e.error(`"${t}" is not a valid weather type`),!1)}const Gm=1e4,Iut={key:"type",defaultKeyValue:"sun",base:null,typeMap:{sun:dP,virtual:i8}};let q4=class extends he{constructor(e){super(e)}clone(){}};u([d({readOnly:!0,json:{read:!1}})],q4.prototype,"type",void 0),q4=u([R("esri.webscene.background.Background")],q4);const zRe=q4;var eX;const Put={...k0,nonNullable:!0};let oM=eX=class extends zRe{constructor(t){super(t),this.type="color",this.color=new Le([0,0,0,1])}clone(){return new eX(this.cloneProperties())}cloneProperties(){return{color:this.color.clone()}}};u([nt({color:"color"},{readOnly:!0})],oM.prototype,"type",void 0),u([d(Put)],oM.prototype,"color",void 0),oM=eX=u([R("esri.webscene.background.ColorBackground")],oM);const BRe=oM,Oue={base:zRe,key:"type",typeMap:{color:BRe}};function $ut(t){return(e,r,i)=>{if(!e)return e;for(const s in t.typeMap)if(e.type===s){const n=new t.typeMap[s];return n.read(e,i),n}}}const Lut={types:Oue,json:{read:$ut(Oue),write:{overridePolicy:(t,e,r)=>({enabled:!r||!r.isPresentation})}}};var tX;const GRe="esri.webscene.Environment",Dut=K.getLogger(GRe),Rue=(t,e,r)=>({enabled:!r||!r.isPresentation});let Ov=tX=class extends he{constructor(t){super(t),this.lighting=new dP,this.background=null,this.atmosphereEnabled=!0,this.starsEnabled=!0}set weather(t){Mut(t?.type,Dut)&&this._set("weather",t)}clone(){return new tX(this.cloneConstructProperties())}cloneConstructProperties(){return{lighting:this.lighting&&this.lighting.type==="virtual"?i8.prototype.clone.call(this.lighting):dP.prototype.clone.call(this.lighting),background:re(this.background),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,weather:this.weather.clone()}}};u([d({types:Iut,nonNullable:!0,json:{write:!0}})],Ov.prototype,"lighting",void 0),u([d(Lut)],Ov.prototype,"background",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Rue}}})],Ov.prototype,"atmosphereEnabled",void 0),u([d({type:Boolean,nonNullable:!0,json:{write:{overridePolicy:Rue}}})],Ov.prototype,"starsEnabled",void 0),u([d({types:VRe,nonNullable:!0,json:{write:!0},value:new XZ})],Ov.prototype,"weather",null),Ov=tX=u([R(GRe)],Ov);const jRe=Ov;var aM;let TE=aM=class extends jRe{constructor(t){super(t),this.atmosphere=new sI,this.lighting=new Av,this.cachedCameraTrackingEnabled=null}static fromWebsceneEnvironment(t){const e=t.cloneConstructProperties();return new aM({...e,lighting:e.lighting?e.lighting.type==="virtual"?rM.fromWebsceneLighting(e.lighting):Av.fromWebsceneLighting(e.lighting):void 0})}castLighting(t){return this._convertLighting(t)}applyLighting(t){this.lighting=this._convertLighting(t)}_convertLighting(t){return t?t instanceof Av||t instanceof rM?t:t instanceof dP?this.lighting&&this.lighting.type!=="virtual"?this.lighting.cloneWithWebsceneLighting(t):new Av({...t.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):t instanceof i8?this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t):new rM({...t.cloneConstructProperties(),...this.lighting?.cloneNonPersistentConstructProperties()}):Rf(Sut,t):new Av}clone(){return new aM({lighting:this.lighting.clone(),atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:re(this.background)})}cloneWithWebsceneEnvironment(t){return new aM({atmosphere:this.atmosphere.clone(),weather:this.weather.clone(),atmosphereEnabled:this.atmosphereEnabled,starsEnabled:this.starsEnabled,background:re(this.background),...t.cloneConstructProperties(),lighting:this._getLighting(t)})}_getLighting(t){switch(t.lighting.type){case"sun":return this.lighting&&this.lighting.type==="sun"?this.lighting.cloneWithWebsceneLighting(t.lighting):Av.fromWebsceneLighting(t.lighting);case"virtual":return this.lighting&&this.lighting.type==="virtual"?this.lighting.cloneWithWebsceneLighting(t.lighting):rM.fromWebsceneLighting(t.lighting);default:return t.lighting,Av.fromWebsceneLighting(t.lighting)}}};u([d({type:sI,json:{read:!1},nonNullable:!0})],TE.prototype,"atmosphere",void 0),u([d({nonNullable:!0})],TE.prototype,"lighting",void 0),u([or("lighting")],TE.prototype,"castLighting",null),TE=aM=u([R("esri.views.3d.environment.SceneViewEnvironment")],TE);const SE=TE;var Ga;(function(t){t[t.Realistic=0]="Realistic",t[t.Local=1]="Local",t[t.Mars=2]="Mars",t[t.None=3]="None"})(Ga||(Ga={}));function Lte(t){return ye((t-1e5)/(1e6-1e5),0,1)}const rX=1e4,Nut=.085,Vv=1e5;let Fut=class{};const ui=Fut;function w(t,...e){let r="";for(let i=0;i<e.length;i++)r+=t[i]+e[i];return r+=t[t.length-1],r}(function(t){function e(i){return Math.round(i).toString()}function r(i){return i.toPrecision(8)}t.int=e,t.float=r})(w||(w={}));var sn;function ag(t,e){switch(e.textureCoordinateType){case sn.Default:return t.attributes.add(E.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
}`);case sn.Compressed:return t.attributes.add(E.UV0,"vec2"),t.varyings.add("vuv0","vec2"),void t.vertex.code.add(w`vec2 getUV0() {
return uv0 / 16384.0;
}
void forwardTextureCoordinates() {
vuv0 = getUV0();
}`);case sn.Atlas:return t.attributes.add(E.UV0,"vec2"),t.varyings.add("vuv0","vec2"),t.attributes.add(E.UVREGION,"vec4"),t.varyings.add("vuvRegion","vec4"),void t.vertex.code.add(w`void forwardTextureCoordinates() {
vuv0 = uv0;
vuvRegion = uvRegion;
}`);default:e.textureCoordinateType;case sn.None:return void t.vertex.code.add(w`void forwardTextureCoordinates() {}`);case sn.COUNT:return}}(function(t){t[t.None=0]="None",t[t.Default=1]="Default",t[t.Atlas=2]="Atlas",t[t.Compressed=3]="Compressed",t[t.COUNT=4]="COUNT"})(sn||(sn={}));function Pu(t){t.code.add(w`const float MAX_RGBA_FLOAT =
255.0 / 256.0 +
255.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 +
255.0 / 256.0 / 256.0 / 256.0 / 256.0;
const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);
vec4 float2rgba(const float value) {
float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);
vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);
const float toU8AsFloat = 1.0 / 255.0;
return fixedPointU8 * toU8AsFloat;
}
const vec4 RGBA_2_FLOAT_FACTORS = vec4(
255.0 / (256.0),
255.0 / (256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0),
255.0 / (256.0 * 256.0 * 256.0 * 256.0)
);
float rgba2float(vec4 rgba) {
return dot(rgba, RGBA_2_FLOAT_FACTORS);
}`)}function Ch(t){t.include(Pu),t.code.add(w`float linearDepthFromFloat(float depth, vec2 nearFar) {
return -(depth * (nearFar[1] - nearFar[0]) + nearFar[0]);
}
float linearDepthFromTexture(sampler2D depthTex, vec2 uv, vec2 nearFar) {
return linearDepthFromFloat(rgba2float(texture(depthTex, uv)), nearFar);
}`)}function s8(t){t.fragment.code.add(w`const float GAMMA = 2.2;
const float INV_GAMMA = 0.4545454545;
vec4 delinearizeGamma(vec4 color) {
return vec4(pow(color.rgb, vec3(INV_GAMMA)), color.w);
}
vec3 linearizeGamma(vec3 color) {
return pow(color, vec3(GAMMA));
}`)}var ai;(function(t){t[t.Pass=0]="Pass",t[t.Draw=1]="Draw"})(ai||(ai={}));let Ps=class{constructor(e,r,i,s,n=null){this.name=e,this.type=r,this.arraySize=n,this.bind={[ai.Pass]:null,[ai.Draw]:null},i!=null&&s!=null&&(this.bind[i]=s)}equals(e){return this.type===e.type&&this.name===e.name&&this.arraySize===e.arraySize}},jt=class extends Ps{constructor(e,r){super(e,"vec3",ai.Pass,(i,s,n)=>i.setUniform3fv(e,r(s,n)))}};function G0(t){t.uniforms.add(new jt("mainLightDirection",(e,r)=>r.lighting.mainLight.direction))}function Fg(t){t.uniforms.add(new jt("mainLightIntensity",(e,r)=>r.lighting.mainLight.intensity))}function dU(t){G0(t.fragment),Fg(t.fragment),t.fragment.code.add(w`vec3 evaluateMainLighting(vec3 normal_global, float shadowing) {
float dotVal = clamp(dot(normal_global, mainLightDirection), 0.0, 1.0);
return mainLightIntensity * ((1.0 - shadowing) * dotVal);
}`)}let Pr=class extends Ps{constructor(e,r){super(e,"vec2",ai.Pass,(i,s,n)=>i.setUniform2fv(e,r(s,n)))}},cr=class extends Ps{constructor(e,r){super(e,"vec4",ai.Pass,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}},Ie=class extends Ps{constructor(e,r){super(e,"float",ai.Pass,(i,s,n)=>i.setUniform1f(e,r(s,n)))}},es=class extends Ps{constructor(e,r){super(e,"mat4",ai.Pass,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};const pl=Qt();let kut=class{constructor(e){this.message=e}toString(){return`AssertException: ${this.message}`}};function it(t,e){if(!t){e=e||"Assertion";const r=new Error(e).stack;throw new kut(`${e} at ${r}`)}}function GS(t,e){t||(e=e||"",console.warn("Verify failed: "+e+`
`+new Error("verify").stack))}function Mue(t,e,r,i){let s,n=(r[0]-t[0])/e[0],o=(i[0]-t[0])/e[0];n>o&&(s=n,n=o,o=s);let a=(r[1]-t[1])/e[1],l=(i[1]-t[1])/e[1];if(a>l&&(s=a,a=l,l=s),n>l||a>o)return!1;a>n&&(n=a),l<o&&(o=l);let c=(r[2]-t[2])/e[2],h=(i[2]-t[2])/e[2];return c>h&&(s=c,c=h,h=s),!(n>h||c>o)&&(h<o&&(o=h),!(o<0))}function bD(t,e,r,i,s,n=Pe()){const o=(i[s]-r[s])*(e[0]-t[0])-(i[0]-r[0])*(e[s]-t[s]),a=(i[0]-r[0])*(t[s]-r[s])-(i[s]-r[s])*(t[0]-r[0]);if(o===0)return!1;const l=a/o;return n[0]=t[0]+l*(e[0]-t[0]),n[1]=t[s]+l*(e[s]-t[s]),!0}function Iue(t,e,r,i,s){pl[0]=t[0],pl[1]=t[1],pl[2]=t[2],pl[3]=1,ph(pl,pl,e),s.length>2&&(s[2]=-pl[2]),ph(pl,pl,r),it(pl[3]!==0),s[0]=pl[0]/pl[3],s[1]=pl[1]/pl[3],s[2]=pl[2]/pl[3],s[0]=(.5*s[0]+.5)*i[2]+i[0],s[1]=(.5*s[1]+.5)*i[3]+i[1]}function Uut(t,e){return Math.log(t)/Math.log(e)}function Vut(t,e,r,i){t[12]=e,t[13]=r,t[14]=i}function HRe(t){return t[0]===1&&t[1]===0&&t[2]===0&&t[3]===0&&t[4]===0&&t[5]===1&&t[6]===0&&t[7]===0&&t[8]===0&&t[9]===0&&t[10]===1&&t[11]===0&&t[15]===1}const qRe=K.getLogger("esri.views.3d.webgl-engine.core.shaderModules.shaderBuilder");let WRe=class{constructor(){this._includedModules=new Map}include(e,r){if(this._includedModules.has(e)){const i=this._includedModules.get(e);if(i!==r){qRe.error("Trying to include shader module multiple times with different sets of options.");const s=new Set;for(const n of Object.keys(i))i[n]!==e[n]&&s.add(n);for(const n of Object.keys(e))i[n]!==e[n]&&s.add(n);s.forEach(n=>console.error(`  ${n}: current ${i[n]} new ${e[n]}`))}}else this._includedModules.set(e,r),e(this.builder,r)}},Cr=class extends WRe{constructor(){super(...arguments),this.vertex=new Pue,this.fragment=new Pue,this.attributes=new Gut,this.varyings=new jut,this.extensions=new iX,this.constants=new ZRe}get fragmentUniforms(){return this.fragment.uniforms.entries}get builder(){return this}generate(e){const r=this.extensions.generateSource(e),i=this.attributes.generateSource(e),s=this.varyings.generateSource(e),n=e==="vertex"?this.vertex:this.fragment,o=n.uniforms.generateSource(),a=n.code.generateSource(),l=e==="vertex"?qut:Hut,c=this.constants.generateSource().concat(n.constants.generateSource());return`#version 300 es
${r.join(`
`)}

${l}

${c.join(`
`)}

${o.join(`
`)}

${i.join(`
`)}

${s.join(`
`)}

${a.join(`
`)}`}generateBind(e,r){const i=new Map;this.vertex.uniforms.entries.forEach(o=>{const a=o.bind[e];a!=null&&i.set(o.name,a)}),this.fragment.uniforms.entries.forEach(o=>{const a=o.bind[e];a!=null&&i.set(o.name,a)});const s=Array.from(i.values()),n=s.length;return(o,a,l)=>{for(let c=0;c<n;++c)s[c](r,o,a,l)}}},zut=class{constructor(){this._entries=new Map}add(...e){for(const r of e)this._add(r)}get(e){return this._entries.get(e)}_add(e){if(e!=null){if(this._entries.has(e.name)&&!this._entries.get(e.name).equals(e))throw new D(`Duplicate uniform name ${e.name} for different uniform type`);this._entries.set(e.name,e)}else qRe.error(`Trying to add null Uniform from ${new Error().stack}.`)}generateSource(){return Array.from(this._entries.values()).map(e=>e.arraySize!=null?`uniform ${e.type} ${e.name}[${e.arraySize}];`:`uniform ${e.type} ${e.name};`)}get entries(){return Array.from(this._entries.values())}},But=class{constructor(){this._entries=new Array}add(e){this._entries.push(e)}generateSource(){return this._entries}},Pue=class extends WRe{constructor(){super(...arguments),this.uniforms=new zut,this.code=new But,this.constants=new ZRe}get builder(){return this}},Gut=class{constructor(){this._entries=new Array}add(e,r){this._entries.push([e,r])}generateSource(e){return e==="fragment"?[]:this._entries.map(r=>`in ${r[1]} ${r[0]};`)}},jut=class{constructor(){this._entries=new Map}add(e,r){this._entries.has(e)&&it(this._entries.get(e)===r),this._entries.set(e,r)}generateSource(e){const r=new Array;return this._entries.forEach((i,s)=>r.push(e==="vertex"?`out ${i} ${s};`:`in ${i} ${s};`)),r}},iX=class sX{constructor(){this._entries=new Set}add(e){this._entries.add(e)}generateSource(e){const r=e==="vertex"?sX.ALLOWLIST_VERTEX:sX.ALLOWLIST_FRAGMENT;return Array.from(this._entries).filter(i=>r.includes(i)).map(i=>`#extension ${i} : enable`)}};iX.ALLOWLIST_FRAGMENT=["GL_EXT_shader_texture_lod","GL_OES_standard_derivatives"],iX.ALLOWLIST_VERTEX=[];let ZRe=class On{constructor(){this._entries=new Set}add(e,r,i){let s="ERROR_CONSTRUCTOR_STRING";switch(r){case"float":s=On._numberToFloatStr(i);break;case"int":s=On._numberToIntStr(i);break;case"bool":s=i.toString();break;case"vec2":s=`vec2(${On._numberToFloatStr(i[0])},                            ${On._numberToFloatStr(i[1])})`;break;case"vec3":s=`vec3(${On._numberToFloatStr(i[0])},                            ${On._numberToFloatStr(i[1])},                            ${On._numberToFloatStr(i[2])})`;break;case"vec4":s=`vec4(${On._numberToFloatStr(i[0])},                            ${On._numberToFloatStr(i[1])},                            ${On._numberToFloatStr(i[2])},                            ${On._numberToFloatStr(i[3])})`;break;case"ivec2":s=`ivec2(${On._numberToIntStr(i[0])},                             ${On._numberToIntStr(i[1])})`;break;case"ivec3":s=`ivec3(${On._numberToIntStr(i[0])},                             ${On._numberToIntStr(i[1])},                             ${On._numberToIntStr(i[2])})`;break;case"ivec4":s=`ivec4(${On._numberToIntStr(i[0])},                             ${On._numberToIntStr(i[1])},                             ${On._numberToIntStr(i[2])},                             ${On._numberToIntStr(i[3])})`;break;case"mat2":case"mat3":case"mat4":s=`${r}(${Array.prototype.map.call(i,n=>On._numberToFloatStr(n)).join(", ")})`}return this._entries.add(`const ${r} ${e} = ${s};`),this}static _numberToIntStr(e){return e.toFixed(0)}static _numberToFloatStr(e){return Number.isInteger(e)?e.toFixed(1):e.toString()}generateSource(){return Array.from(this._entries)}};const Hut=`#ifdef GL_FRAGMENT_PRECISION_HIGH
  precision highp float;
  precision highp sampler2D;
#else
  precision mediump float;
  precision mediump sampler2D;
#endif

out vec4 fragColor;`,qut=`precision highp float;
precision highp sampler2D;`;let et=class extends Ps{constructor(e,r){super(e,"sampler2D",ai.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};const nI=Ee(parseFloat(5802e-9.toFixed(6)),parseFloat(13558e-9.toFixed(6)),parseFloat(331e-7.toFixed(6))),Xz=3,Yz=Ee(Xz*parseFloat(65e-8.toFixed(6)),Xz*parseFloat(1881e-9.toFixed(6)),Xz*parseFloat(85e-9.toFixed(6))),Wut=3996e-9,Zut=Ee(parseFloat(Number(nI[0]+Yz[0]).toFixed(6)),parseFloat(Number(nI[1]+Yz[1]).toFixed(6)),parseFloat(Number(nI[2]+Yz[2]).toFixed(6)));function Xut(t){const e=new Cr;e.attributes.add(E.POSITION,"vec2"),e.include(ag,{textureCoordinateType:sn.Default}),e.varyings.add("worldRay","vec3"),e.varyings.add("eyeDir","vec3");const{vertex:r,fragment:i}=e;return r.uniforms.add(new es("inverseProjectionMatrix",(s,n)=>n.camera.inverseProjectionMatrix),new es("inverseViewMatrix",(s,n)=>mO(Yut,n.camera.viewMatrix))),r.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),i.uniforms.add(new jt("backgroundColor",s=>s.backgroundColor),new Pr("radii",s=>s.radii),new jt("cameraPosition",(s,n)=>n.camera.eye),new cr("heightParameters",s=>s.heightParameters),new Ie("innerFadeDistance",s=>s.innerFadeDistance),new Ie("altitudeFade",s=>s.altitudeFade),new et("depthTexture",s=>s.depthTexture),new Ie("hazeStrength",s=>s.hazeStrength)),i.constants.add("betaRayleigh","vec3",nI),i.constants.add("betaCombined","vec3",Zut),i.constants.add("betaMie","float",Wut),i.constants.add("scaleHeight","float",Nut*Vv),G0(i),e.include(s8),t.haze&&(i.include(Ch),i.uniforms.add(new Pr("nearFar",(s,n)=>n.camera.nearFar))),i.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir, float radius, bool planet) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = planet ? heightParameters[1] - radius * radius : heightParameters[2];
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),i.code.add(w`float chapmanApproximation(float X, float h, float cosZenith) {
float c = sqrt(X + h);
float cExpH = c * exp(-h);
if (cosZenith >= 0.0) {
return cExpH / (c * cosZenith + 1.0);
} else {
float x0 = sqrt(1.0 - cosZenith * cosZenith) * (X + h);
float c0 = sqrt(x0);
return 2.0 * c0 * exp(X - x0) - cExpH / (1.0 - c * cosZenith);
}
}`),i.code.add(w`float getOpticalDepth(vec3 position, vec3 dir, float h) {
return scaleHeight * chapmanApproximation(radii[0] / scaleHeight, h, dot(normalize(position), dir));
}`),i.code.add(w`
    const int STEPS = 6;

    vec3 getAtmosphereColour(vec3 cameraPos, vec3 rayDir, vec3 lightDir, float terrainDepth) {
      float reducedPlanetRadius = radii[0] - 20000.0;
      vec2 rayPlanetIntersect = sphereIntersect(cameraPos, rayDir, reducedPlanetRadius, true);
      vec2 rayAtmosphereIntersect = sphereIntersect(cameraPos, rayDir, radii[1], false);
      bool hitsAtmosphere = (rayAtmosphereIntersect.x <= rayAtmosphereIntersect.y) && rayAtmosphereIntersect.x > 0.0;
      bool insideAtmosphere = heightParameters[0] < radii[1];

      if (!(hitsAtmosphere || insideAtmosphere)) {
        return vec3(0);
      }

      bool hitsPlanet = (rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.x > 0.0;

      float start = insideAtmosphere ? 0.0 : rayAtmosphereIntersect.x;

      if (heightParameters[0] < reducedPlanetRadius) {
        // Long light rays from the night side of the planet lead to numerical instability
        // Do not render the atmosphere in such cases
        if (dot(rayDir, normalize(cameraPos)) < -0.025) {
          return vec3(0);
        }
        start = rayPlanetIntersect.y;
      }

      float end = hitsPlanet ? rayPlanetIntersect.x : rayAtmosphereIntersect.y;
      float maxEnd = end;

      ${t.haze?w`if (terrainDepth != -1.0) { end = terrainDepth; }`:""}

      vec3 samplePoint = cameraPos + rayDir * end;
      float multiplier = hitsPlanet ? -1.0 : 1.0;

      vec3 scattering = vec3(0);
      float scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
      float lastOpticalDepth = getOpticalDepth(samplePoint, rayDir, scaleFract);
      float stepSize = (end - start) / float(STEPS);
      for (int i = 0; i < STEPS; i++) {
        samplePoint -= stepSize * rayDir;
        scaleFract = (length(samplePoint) - radii[0]) / scaleHeight;
        float opticalDepth = multiplier * getOpticalDepth(samplePoint, rayDir * multiplier, scaleFract);

        if (i > 0) {
          scattering *= ${t.haze?"":w`mix(2.5, 1.0, clamp((length(cameraPos) - radii[0]) / 50e3, 0.0, 1.0)) * `} exp(-(mix(betaCombined, betaRayleigh, 0.5) + betaMie) * max(0.0, (opticalDepth - lastOpticalDepth)));
        }

        if (dot(normalize(samplePoint), lightDir) > -0.3) {

          float scale = exp(-scaleFract);
          float lightDepth = getOpticalDepth(samplePoint, lightDir, scaleFract);

          scattering += scale * exp(-(betaCombined + betaMie) * lightDepth);
          ${t.haze?"":w`scattering += scale * exp(-(0.25 * betaCombined ) * lightDepth);`}
        }

        lastOpticalDepth = opticalDepth;

      }

      float mu = dot(rayDir, lightDir);
      float mumu = 1.0 + mu * mu;

      float phaseRayleigh = 0.0596831 * mumu;

      ${t.haze?w`return 3.0 * scattering * stepSize * phaseRayleigh * betaRayleigh;`:w`
            const float g = 0.8;
            const float gg = g * g;
            float phaseMie = end == maxEnd ? 0.1193662 * ((1.0 - gg) * mumu) / (pow(1.0 + gg - 2.0 * mu * g, 1.5) * (2.0 + gg)) : 0.0;
            phaseMie = clamp(phaseMie, 0.0, 128.0);
            return 3.0 * scattering * stepSize * (phaseRayleigh * betaRayleigh + 0.025 * phaseMie * betaMie);`}
    }

    ${t.haze?"":w`
            vec4 applyUndergroundAtmosphere(vec3 rayDir, vec3 lightDirection, vec4 fragColor) {
              vec2 rayPlanetIntersect = sphereIntersect(cameraPosition, rayDir, radii[0], true);
              if (!((rayPlanetIntersect.x <= rayPlanetIntersect.y) && rayPlanetIntersect.y > 0.0)) {
                return fragColor;
              }

              float lightAngle = dot(lightDirection, normalize(cameraPosition + rayDir * max(0.0, rayPlanetIntersect.x)));
              vec4 surfaceColor = vec4(vec3(max(0.0, (smoothstep(-1.0, 0.8, 2.0 * lightAngle)))), 1.0 - altitudeFade);
              float relDist = (rayPlanetIntersect.y - max(0.0, rayPlanetIntersect.x)) / innerFadeDistance;
              if (relDist > 1.0) {
                return surfaceColor;
              }

              return mix(fragColor, surfaceColor, smoothstep(0.0, 1.0, relDist * relDist));
            }

            float getGlow(float dist, float radius, float intensity) {
              return pow(radius / max(dist, 1e-6), intensity);
            }

            vec3 getSun(vec3 cameraPos, vec3 rayDir, vec3 lightDir){

              // Get the amount of atmosphere between camera and the Sun along the view ray
              float scaleFract = (length(cameraPos) - radii[0]) / scaleHeight;
              float sunOpticalDepth = getOpticalDepth(cameraPos, rayDir, scaleFract);

              // Find the amount of light that remains after travelling through the atmosphere from the Sun along the view ray
              // This will make the colour of the Sun reddish on the horizon and white from space
              vec3 sunTransmittance = exp(-(mix(betaCombined, betaRayleigh, 0.5)) * max(0.0, sunOpticalDepth));

              // Alignment of light direction and view ray
              float mu = dot(rayDir, lightDir);
              // Draw the Sun as a bright disc
              float sunDisc = 256.0 * smoothstep(0.0, 128.0, clamp(getGlow(1.0 - mu, 3e-5, 3.0), 0.0, 128.0));

              return normalize(sunTransmittance) * sunDisc;
            }`}

    ${t.haze&&t.reduced?w`
        float getDepth(vec2 uv){
          return linearDepthFromTexture(depthTexture, uv, nearFar);
        }

        float textureBilinear(vec2 uv) {
          // Information about the high-resolution depth texture
          vec2 depthTextureSize = vec2(textureSize(depthTexture, 0));
          vec2 texelSize = 1.0 / depthTextureSize;

          // The uv inside the upper right pixel - of the tile of 4 pixels -
          // that the atmosphere uv maps to in the depth texture
          vec2 depthUV = (uv * depthTextureSize) - vec2(0.5);

          // Relative distance of the uv coordinates inside the depth texture pixel
          vec2 f = fract(depthUV);

          // Snap to the centre of the depth texture pixel
          vec2 snapUV = (floor(depthUV) + vec2(0.5)) / depthTextureSize;

          // Read the depth texture pixel and its three neighbours
          float d0 = getDepth(snapUV);
          float d1 = getDepth(snapUV + vec2(texelSize.x, 0.0));
          float d2 = getDepth(snapUV + vec2(0.0, texelSize.y));
          float d3 = getDepth(snapUV + texelSize);

          // Return the bilinearly interpolated value of the neighbouring pixels based
          // on the sample position in the depth texture pixel
          return mix(mix(d0, d1, f.x), mix(d2, d3, f.x), f.y);
        }
        `:""}

    vec3 tonemapACES(vec3 x) {
      return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
    }

    void main() {
      vec3 rayDir = normalize(worldRay);
      float terrainDepth = -1.0;
      ${t.haze?w`
          vec4 depthSample = texture(depthTexture, vuv0).rgba;
          if (depthSample != vec4(0)) {
            vec3 cameraSpaceRay = normalize(eyeDir);
            cameraSpaceRay /= cameraSpaceRay.z;

              ${t.reduced?w`cameraSpaceRay *= -textureBilinear(vuv0);`:w`cameraSpaceRay *= -linearDepthFromTexture(depthTexture, vuv0, nearFar);`}

            terrainDepth = max(0.0, length(cameraSpaceRay));
          }else{
            discard;
          }
          `:w`${t.reduced?"":w`
                float depthSample = texture(depthTexture, vuv0).r;
                if (depthSample != 1.0) {
                  fragColor = vec4(0);
                  return;
                }`}`}

      ${t.haze?w`
            vec3 col = vec3(0);
            float fadeOut = smoothstep(-10000.0, -15000.0, heightParameters[0] - radii[0]);
            if(depthSample != vec4(0)){
              col = (1.0 - fadeOut) * hazeStrength * getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            }
            // Alpha is ignored for haze blending
            float alpha = 1.0;
            `:w`
            vec3 col = linearizeGamma(backgroundColor);
            col += getAtmosphereColour(cameraPosition, rayDir, mainLightDirection, terrainDepth);
            col += getSun(cameraPosition, rayDir, mainLightDirection);
            float alpha = smoothstep(0.0, mix(0.15, 0.01, heightParameters[3]), length(col));`}

      col = tonemapACES(col);
      fragColor = delinearizeGamma(vec4(col, alpha));
      ${t.haze?"":w`fragColor = applyUndergroundAtmosphere(rayDir, mainLightDirection, fragColor);`}
    }
  `),e}const Yut=xe(),Jut=Object.freeze(Object.defineProperty({__proto__:null,betaRayleigh:nI,build:Xut},Symbol.toStringTag,{value:"Module"}));let $r=class{constructor(e,r){this._module=e,this._loadModule=r}get(){return this._module}async reload(){return this._module=await this._loadModule(),this._module}};var Bi,Ot,Te,Eg,St,ff,RA,rt,ci,Gs,Mt,Ut,Rs,At,Je,fn,bn,Mr,lh,ea;(function(t){t[t.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",t[t.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",t[t.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT"})(Bi||(Bi={})),function(t){t[t.POINTS=0]="POINTS",t[t.LINES=1]="LINES",t[t.LINE_LOOP=2]="LINE_LOOP",t[t.LINE_STRIP=3]="LINE_STRIP",t[t.TRIANGLES=4]="TRIANGLES",t[t.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",t[t.TRIANGLE_FAN=6]="TRIANGLE_FAN"}(Ot||(Ot={})),function(t){t[t.ZERO=0]="ZERO",t[t.ONE=1]="ONE",t[t.SRC_COLOR=768]="SRC_COLOR",t[t.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",t[t.SRC_ALPHA=770]="SRC_ALPHA",t[t.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",t[t.DST_ALPHA=772]="DST_ALPHA",t[t.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",t[t.DST_COLOR=774]="DST_COLOR",t[t.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",t[t.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",t[t.CONSTANT_COLOR=32769]="CONSTANT_COLOR",t[t.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",t[t.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",t[t.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA"}(Te||(Te={})),function(t){t[t.ADD=32774]="ADD",t[t.MIN=32775]="MIN",t[t.MAX=32776]="MAX",t[t.SUBTRACT=32778]="SUBTRACT",t[t.REVERSE_SUBTRACT=32779]="REVERSE_SUBTRACT"}(Eg||(Eg={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",t[t.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",t[t.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",t[t.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",t[t.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",t[t.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER"}(St||(St={})),function(t){t[t.FRONT=1028]="FRONT",t[t.BACK=1029]="BACK",t[t.FRONT_AND_BACK=1032]="FRONT_AND_BACK"}(ff||(ff={})),function(t){t[t.CW=2304]="CW",t[t.CCW=2305]="CCW"}(RA||(RA={})),function(t){t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.INT=5124]="INT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.FLOAT=5126]="FLOAT"}(rt||(rt={})),function(t){t[t.NEVER=512]="NEVER",t[t.LESS=513]="LESS",t[t.EQUAL=514]="EQUAL",t[t.LEQUAL=515]="LEQUAL",t[t.GREATER=516]="GREATER",t[t.NOTEQUAL=517]="NOTEQUAL",t[t.GEQUAL=518]="GEQUAL",t[t.ALWAYS=519]="ALWAYS"}(ci||(ci={})),function(t){t[t.ZERO=0]="ZERO",t[t.KEEP=7680]="KEEP",t[t.REPLACE=7681]="REPLACE",t[t.INCR=7682]="INCR",t[t.DECR=7683]="DECR",t[t.INVERT=5386]="INVERT",t[t.INCR_WRAP=34055]="INCR_WRAP",t[t.DECR_WRAP=34056]="DECR_WRAP"}(Gs||(Gs={})),function(t){t[t.NEAREST=9728]="NEAREST",t[t.LINEAR=9729]="LINEAR",t[t.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",t[t.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",t[t.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",t[t.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR"}(Mt||(Mt={})),function(t){t[t.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",t[t.REPEAT=10497]="REPEAT",t[t.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT"}(Ut||(Ut={})),function(t){t[t.TEXTURE_2D=3553]="TEXTURE_2D",t[t.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",t[t.TEXTURE_3D=32879]="TEXTURE_3D",t[t.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",t[t.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",t[t.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",t[t.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",t[t.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",t[t.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY"}(Rs||(Rs={})),function(t){t[t.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.ALPHA=6406]="ALPHA",t[t.RGB=6407]="RGB",t[t.RGBA=6408]="RGBA",t[t.LUMINANCE=6409]="LUMINANCE",t[t.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",t[t.RED=6403]="RED",t[t.RG=33319]="RG",t[t.RED_INTEGER=36244]="RED_INTEGER",t[t.RG_INTEGER=33320]="RG_INTEGER",t[t.RGB_INTEGER=36248]="RGB_INTEGER",t[t.RGBA_INTEGER=36249]="RGBA_INTEGER"}(At||(At={})),function(t){t[t.RGBA4=32854]="RGBA4",t[t.R16F=33325]="R16F",t[t.RG16F=33327]="RG16F",t[t.RGB32F=34837]="RGB32F",t[t.RGBA16F=34842]="RGBA16F",t[t.R32F=33326]="R32F",t[t.RG32F=33328]="RG32F",t[t.RGBA32F=34836]="RGBA32F",t[t.R11F_G11F_B10F=35898]="R11F_G11F_B10F",t[t.RGB8=32849]="RGB8",t[t.RGBA8=32856]="RGBA8",t[t.RGB5_A1=32855]="RGB5_A1",t[t.R8=33321]="R8",t[t.RG8=33323]="RG8",t[t.R8I=33329]="R8I",t[t.R8UI=33330]="R8UI",t[t.R16I=33331]="R16I",t[t.R16UI=33332]="R16UI",t[t.R32I=33333]="R32I",t[t.R32UI=33334]="R32UI",t[t.RG8I=33335]="RG8I",t[t.RG8UI=33336]="RG8UI",t[t.RG16I=33337]="RG16I",t[t.RG16UI=33338]="RG16UI",t[t.RG32I=33339]="RG32I",t[t.RG32UI=33340]="RG32UI",t[t.RGB16F=34843]="RGB16F",t[t.RGB9_E5=35901]="RGB9_E5",t[t.SRGB8=35905]="SRGB8",t[t.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",t[t.RGB565=36194]="RGB565",t[t.RGBA32UI=36208]="RGBA32UI",t[t.RGB32UI=36209]="RGB32UI",t[t.RGBA16UI=36214]="RGBA16UI",t[t.RGB16UI=36215]="RGB16UI",t[t.RGBA8UI=36220]="RGBA8UI",t[t.RGB8UI=36221]="RGB8UI",t[t.RGBA32I=36226]="RGBA32I",t[t.RGB32I=36227]="RGB32I",t[t.RGBA16I=36232]="RGBA16I",t[t.RGB16I=36233]="RGB16I",t[t.RGBA8I=36238]="RGBA8I",t[t.RGB8I=36239]="RGB8I",t[t.R8_SNORM=36756]="R8_SNORM",t[t.RG8_SNORM=36757]="RG8_SNORM",t[t.RGB8_SNORM=36758]="RGB8_SNORM",t[t.RGBA8_SNORM=36759]="RGBA8_SNORM",t[t.RGB10_A2=32857]="RGB10_A2",t[t.RGB10_A2UI=36975]="RGB10_A2UI"}(Je||(Je={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",t[t.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",t[t.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",t[t.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",t[t.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",t[t.BYTE=5120]="BYTE",t[t.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",t[t.SHORT=5122]="SHORT",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.INT=5124]="INT",t[t.HALF_FLOAT=5131]="HALF_FLOAT",t[t.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",t[t.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",t[t.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",t[t.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV"}(fn||(fn={})),function(t){t[t.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",t[t.STENCIL_INDEX8=36168]="STENCIL_INDEX8",t[t.DEPTH_STENCIL=34041]="DEPTH_STENCIL",t[t.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",t[t.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",t[t.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",t[t.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8"}(bn||(bn={})),function(t){t[t.STATIC_DRAW=35044]="STATIC_DRAW",t[t.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",t[t.STREAM_DRAW=35040]="STREAM_DRAW",t[t.STATIC_READ=35045]="STATIC_READ",t[t.DYNAMIC_READ=35049]="DYNAMIC_READ",t[t.STREAM_READ=35041]="STREAM_READ",t[t.STATIC_COPY=35046]="STATIC_COPY",t[t.DYNAMIC_COPY=35050]="DYNAMIC_COPY",t[t.STREAM_COPY=35042]="STREAM_COPY"}(Mr||(Mr={})),function(t){t[t.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",t[t.VERTEX_SHADER=35633]="VERTEX_SHADER"}(lh||(lh={})),function(t){t[t.FRAMEBUFFER=36160]="FRAMEBUFFER",t[t.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",t[t.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER"}(ea||(ea={}));const Jz=33984;var io,eh;(function(t){t[t.Texture=0]="Texture",t[t.BufferObject=1]="BufferObject",t[t.VertexArrayObject=2]="VertexArrayObject",t[t.Shader=3]="Shader",t[t.Program=4]="Program",t[t.FramebufferObject=5]="FramebufferObject",t[t.Renderbuffer=6]="Renderbuffer",t[t.Sync=7]="Sync",t[t.COUNT=8]="COUNT"})(io||(io={})),function(t){t[t.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",t[t.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",t[t.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",t[t.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",t[t.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",t[t.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",t[t.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",t[t.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",t[t.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",t[t.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",t[t.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",t[t.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",t[t.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",t[t.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",t[t.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",t[t.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15"}(eh||(eh={}));const $ue=33306;var Ns,Lue,Due,Nue,pU,nX,Fue;(function(t){t[t.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",t[t.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",t[t.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",t[t.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",t[t.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",t[t.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",t[t.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",t[t.COMPRESSED_SRGB8_ETC2=37493]="COMPRESSED_SRGB8_ETC2",t[t.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37494]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37495]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",t[t.COMPRESSED_RGBA8_ETC2_EAC=37496]="COMPRESSED_RGBA8_ETC2_EAC",t[t.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37497]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC"})(Ns||(Ns={})),function(t){t[t.FLOAT=5126]="FLOAT",t[t.FLOAT_VEC2=35664]="FLOAT_VEC2",t[t.FLOAT_VEC3=35665]="FLOAT_VEC3",t[t.FLOAT_VEC4=35666]="FLOAT_VEC4",t[t.INT=5124]="INT",t[t.INT_VEC2=35667]="INT_VEC2",t[t.INT_VEC3=35668]="INT_VEC3",t[t.INT_VEC4=35669]="INT_VEC4",t[t.BOOL=35670]="BOOL",t[t.BOOL_VEC2=35671]="BOOL_VEC2",t[t.BOOL_VEC3=35672]="BOOL_VEC3",t[t.BOOL_VEC4=35673]="BOOL_VEC4",t[t.FLOAT_MAT2=35674]="FLOAT_MAT2",t[t.FLOAT_MAT3=35675]="FLOAT_MAT3",t[t.FLOAT_MAT4=35676]="FLOAT_MAT4",t[t.SAMPLER_2D=35678]="SAMPLER_2D",t[t.SAMPLER_CUBE=35680]="SAMPLER_CUBE",t[t.UNSIGNED_INT=5125]="UNSIGNED_INT",t[t.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",t[t.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",t[t.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",t[t.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",t[t.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",t[t.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",t[t.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",t[t.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",t[t.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",t[t.SAMPLER_3D=35679]="SAMPLER_3D",t[t.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",t[t.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",t[t.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",t[t.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",t[t.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",t[t.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",t[t.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",t[t.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",t[t.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",t[t.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",t[t.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",t[t.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY"}(Lue||(Lue={})),function(t){t[t.OBJECT_TYPE=37138]="OBJECT_TYPE",t[t.SYNC_CONDITION=37139]="SYNC_CONDITION",t[t.SYNC_STATUS=37140]="SYNC_STATUS",t[t.SYNC_FLAGS=37141]="SYNC_FLAGS"}(Due||(Due={})),function(t){t[t.UNSIGNALED=37144]="UNSIGNALED",t[t.SIGNALED=37145]="SIGNALED"}(Nue||(Nue={})),function(t){t[t.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",t[t.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",t[t.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",t[t.WAIT_FAILED=37149]="WAIT_FAILED"}(pU||(pU={})),function(t){t[t.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE"}(nX||(nX={})),function(t){t[t.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT"}(Fue||(Fue={}));let Ur=class{constructor(e,r,i){this.release=i,this.initializeConfiguration(e,r),this._configuration=r.snapshot(),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}destroy(){this._program=ze(this._program),this._pipeline=this._configuration=null}reload(e){ze(this._program),this._program=this.initializeProgram(e),this._pipeline=this.initializePipeline(e.rctx.capabilities)}get program(){return this._program}get compiled(){return this.program.compiled}get key(){return this._configuration.key}get configuration(){return this._configuration}bindPipelineState(e,r=null,i){e.setPipelineState(this.getPipelineState(r,i))}ensureAttributeLocations(e){this.program.assertCompatibleVertexAttributeLocations(e)}get primitiveType(){return Ot.TRIANGLES}getPipelineState(e,r){return this._pipeline}initializeConfiguration(e,r){}};const Er=new Map([[E.POSITION,0],[E.NORMAL,1],[E.NORMALCOMPRESSED,1],[E.UV0,2],[E.COLOR,3],[E.COLORFEATUREATTRIBUTE,3],[E.SIZE,4],[E.TANGENT,4],[E.AUXPOS1,5],[E.SYMBOLCOLOR,5],[E.AUXPOS2,6],[E.FEATUREATTRIBUTE,6],[E.INSTANCEFEATUREATTRIBUTE,6],[E.INSTANCECOLOR,7],[E.OBJECTANDLAYERIDCOLOR,7],[E.INSTANCEOBJECTANDLAYERIDCOLOR,7],[E.MODEL,8],[E.MODELNORMAL,12],[E.MODELORIGINHI,11],[E.MODELORIGINLO,15]]),Qut=K.getLogger("esri.views.webgl.checkWebGLError");function Kut(t,e){switch(e){case t.INVALID_ENUM:return"Invalid Enum. An unacceptable value has been specified for an enumerated argument.";case t.INVALID_VALUE:return"Invalid Value. A numeric argument is out of range.";case t.INVALID_OPERATION:return"Invalid Operation. The specified command is not allowed for the current state.";case t.INVALID_FRAMEBUFFER_OPERATION:return"Invalid Framebuffer operation. The currently bound framebuffer is not framebuffer complete when trying to render to or to read from it.";case t.OUT_OF_MEMORY:return"Out of memory. Not enough memory is left to execute the command.";case t.CONTEXT_LOST_WEBGL:return"WebGL context has been lost";default:return"Unknown error"}}const XRe=!!le("enable-feature:webgl-debug");function fd(){return XRe}function oX(){return XRe}function Xv(t){if(fd()){const e=t.getError();if(e){const r=Kut(t,e),i=new Error().stack;Qut.error(new D("webgl-error","WebGL error occured",{message:r,stack:i}))}}}let Lr=class{constructor(e,r,i){this._context=e,this._locations=i,this._textures=new Map,this._freeTextureUnits=new qt({deallocator:null}),this._glProgram=e.programCache.acquire(r.generate("vertex"),r.generate("fragment"),i),this._glProgram.stop=()=>{throw new Error("Wrapped _glProgram used directly")},this.bindPass=r.generateBind(ai.Pass,this),this.bindDraw=r.generateBind(ai.Draw,this),this._fragmentUniforms=fd()?r.fragmentUniforms:null}dispose(){this._glProgram.dispose()}get glName(){return this._glProgram.glName}get compiled(){return this._glProgram.compiled}setUniform1b(e,r){this._glProgram.setUniform1i(e,r?1:0)}setUniform1i(e,r){this._glProgram.setUniform1i(e,r)}setUniform1f(e,r){this._glProgram.setUniform1f(e,r)}setUniform2fv(e,r){this._glProgram.setUniform2fv(e,r)}setUniform3fv(e,r){this._glProgram.setUniform3fv(e,r)}setUniform4fv(e,r){this._glProgram.setUniform4fv(e,r)}setUniformMatrix3fv(e,r){this._glProgram.setUniformMatrix3fv(e,r)}setUniformMatrix4fv(e,r){this._glProgram.setUniformMatrix4fv(e,r)}setUniform1fv(e,r){this._glProgram.setUniform1fv(e,r)}setUniform1iv(e,r){this._glProgram.setUniform1iv(e,r)}setUniform2iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform3iv(e,r){this._glProgram.setUniform3iv(e,r)}setUniform4iv(e,r){this._glProgram.setUniform4iv(e,r)}assertCompatibleVertexAttributeLocations(e){e.locations!==this._locations&&console.error("VertexAttributeLocations are incompatible")}stop(){this._textures.clear(),this._freeTextureUnits.clear()}bindTexture(e,r){if(r==null||r.glName==null){const s=this._textures.get(e);return s&&(this._context.bindTexture(null,s.unit),this._freeTextureUnit(s),this._textures.delete(e)),null}let i=this._textures.get(e);return i==null?(i=this._allocTextureUnit(r),this._textures.set(e,i)):i.texture=r,this._context.useProgram(this),this.setUniform1i(e,i.unit),this._context.bindTexture(r,i.unit),i.unit}rebindTextures(){this._context.useProgram(this),this._textures.forEach((e,r)=>{this._context.bindTexture(e.texture,e.unit),this.setUniform1i(r,e.unit)}),this._fragmentUniforms!=null&&this._fragmentUniforms.forEach(e=>{e.type!=="sampler2D"&&e.type!=="samplerCube"||this._textures.has(e.name)||console.error(`Texture sampler ${e.name} has no bound texture`)})}_allocTextureUnit(e){return{texture:e,unit:this._freeTextureUnits.length===0?this._textures.size:this._freeTextureUnits.pop()}}_freeTextureUnit(e){this._freeTextureUnits.push(e.unit)}};var Ii,UT,Us,f0,xc,$0,MA,ni,VT,m0;(function(t){t[t.None=0]="None",t[t.Front=1]="Front",t[t.Back=2]="Back",t[t.COUNT=3]="COUNT"})(Ii||(Ii={})),function(t){t[t.Less=0]="Less",t[t.Lequal=1]="Lequal",t[t.COUNT=2]="COUNT"}(UT||(UT={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.UPDATE=1]="UPDATE"}(Us||(Us={})),function(t){t[t.NOT_LOADED=0]="NOT_LOADED",t[t.LOADING=1]="LOADING",t[t.LOADED=2]="LOADED"}(f0||(f0={})),function(t){t[t.IntegratedMeshMaskExcluded=1]="IntegratedMeshMaskExcluded",t[t.OutlineVisualElementMask=2]="OutlineVisualElementMask"}(xc||(xc={})),function(t){t[t.Highlight=0]="Highlight",t[t.MaskOccludee=1]="MaskOccludee",t[t.COUNT=2]="COUNT"}($0||($0={})),function(t){t[t.CHANGED=0]="CHANGED",t[t.UNCHANGED=1]="UNCHANGED"}(MA||(MA={})),function(t){t[t.Blend=0]="Blend",t[t.Opaque=1]="Opaque",t[t.Mask=2]="Mask",t[t.MaskBlend=3]="MaskBlend",t[t.COUNT=4]="COUNT"}(ni||(ni={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(VT||(VT={})),function(t){t.DDS_ENCODING="image/vnd-ms.dds",t.KTX2_ENCODING="image/ktx2",t.BASIS_ENCODING="image/x.basis"}(m0||(m0={}));function Ru(t,e,r=Eg.ADD,i=[0,0,0,0]){return{srcRgb:t,srcAlpha:t,dstRgb:e,dstAlpha:e,opRgb:r,opAlpha:r,color:{r:i[0],g:i[1],b:i[2],a:i[3]}}}function ca(t,e,r,i,s=Eg.ADD,n=Eg.ADD,o=[0,0,0,0]){return{srcRgb:t,srcAlpha:e,dstRgb:r,dstAlpha:i,opRgb:s,opAlpha:n,color:{r:o[0],g:o[1],b:o[2],a:o[3]}}}const Dte={face:ff.BACK,mode:RA.CCW},YRe={face:ff.FRONT,mode:RA.CCW},n8=t=>t===Ii.Back?Dte:t===Ii.Front?YRe:null,Ac={zNear:0,zFar:1},Wt={r:!0,g:!0,b:!0,a:!0};function eht(t){return lht.intern(t)}function tht(t){return cht.intern(t)}function rht(t){return uht.intern(t)}function iht(t){return hht.intern(t)}function sht(t){return dht.intern(t)}function nht(t){return pht.intern(t)}function oht(t){return fht.intern(t)}function aht(t){return mht.intern(t)}function It(t){return ght.intern(t)}let j0=class{constructor(e,r){this._makeKey=e,this._makeRef=r,this._interns=new Map}intern(e){if(!e)return null;const r=this._makeKey(e),i=this._interns;return i.has(r)||i.set(r,this._makeRef(e)),i.get(r)??null}};function H0(t){return"["+t.join(",")+"]"}const lht=new j0(JRe,t=>({__tag:"Blending",...t}));function JRe(t){return t?H0([t.srcRgb,t.srcAlpha,t.dstRgb,t.dstAlpha,t.opRgb,t.opAlpha,t.color.r,t.color.g,t.color.b,t.color.a]):null}const cht=new j0(QRe,t=>({__tag:"Culling",...t}));function QRe(t){return t?H0([t.face,t.mode]):null}const uht=new j0(KRe,t=>({__tag:"PolygonOffset",...t}));function KRe(t){return t?H0([t.factor,t.units]):null}const hht=new j0(e3e,t=>({__tag:"DepthTest",...t}));function e3e(t){return t?H0([t.func]):null}const dht=new j0(t3e,t=>({__tag:"StencilTest",...t}));function t3e(t){return t?H0([t.function.func,t.function.ref,t.function.mask,t.operation.fail,t.operation.zFail,t.operation.zPass]):null}const pht=new j0(r3e,t=>({__tag:"DepthWrite",...t}));function r3e(t){return t?H0([t.zNear,t.zFar]):null}const fht=new j0(i3e,t=>({__tag:"ColorWrite",...t}));function i3e(t){return t?H0([t.r,t.g,t.b,t.a]):null}const mht=new j0(s3e,t=>({__tag:"StencilWrite",...t}));function s3e(t){return t?H0([t.mask]):null}const ght=new j0(yht,t=>({blending:eht(t.blending),culling:tht(t.culling),polygonOffset:rht(t.polygonOffset),depthTest:iht(t.depthTest),stencilTest:sht(t.stencilTest),depthWrite:nht(t.depthWrite),colorWrite:oht(t.colorWrite),stencilWrite:aht(t.stencilWrite)}));function yht(t){return t?H0([JRe(t.blending),QRe(t.culling),KRe(t.polygonOffset),e3e(t.depthTest),t3e(t.stencilTest),r3e(t.depthWrite),i3e(t.colorWrite),s3e(t.stencilWrite)]):null}let _ht=class{constructor(e){this._pipelineInvalid=!0,this._blendingInvalid=!0,this._cullingInvalid=!0,this._polygonOffsetInvalid=!0,this._depthTestInvalid=!0,this._stencilTestInvalid=!0,this._depthWriteInvalid=!0,this._colorWriteInvalid=!0,this._stencilWriteInvalid=!0,this._stateSetters=e}setPipeline(e){(this._pipelineInvalid||e!==this._pipeline)&&(this._setBlending(e.blending),this._setCulling(e.culling),this._setPolygonOffset(e.polygonOffset),this._setDepthTest(e.depthTest),this._setStencilTest(e.stencilTest),this._setDepthWrite(e.depthWrite),this._setColorWrite(e.colorWrite),this._setStencilWrite(e.stencilWrite),this._pipeline=e),this._pipelineInvalid=!1}invalidateBlending(){this._blendingInvalid=!0,this._pipelineInvalid=!0}invalidateCulling(){this._cullingInvalid=!0,this._pipelineInvalid=!0}invalidatePolygonOffset(){this._polygonOffsetInvalid=!0,this._pipelineInvalid=!0}invalidateDepthTest(){this._depthTestInvalid=!0,this._pipelineInvalid=!0}invalidateStencilTest(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}invalidateDepthWrite(){this._depthWriteInvalid=!0,this._pipelineInvalid=!0}invalidateColorWrite(){this._colorWriteInvalid=!0,this._pipelineInvalid=!0}invalidateStencilWrite(){this._stencilTestInvalid=!0,this._pipelineInvalid=!0}_setBlending(e){this._blending=this._setSubState(e,this._blending,this._blendingInvalid,this._stateSetters.setBlending),this._blendingInvalid=!1}_setCulling(e){this._culling=this._setSubState(e,this._culling,this._cullingInvalid,this._stateSetters.setCulling),this._cullingInvalid=!1}_setPolygonOffset(e){this._polygonOffset=this._setSubState(e,this._polygonOffset,this._polygonOffsetInvalid,this._stateSetters.setPolygonOffset),this._polygonOffsetInvalid=!1}_setDepthTest(e){this._depthTest=this._setSubState(e,this._depthTest,this._depthTestInvalid,this._stateSetters.setDepthTest),this._depthTestInvalid=!1}_setStencilTest(e){this._stencilTest=this._setSubState(e,this._stencilTest,this._stencilTestInvalid,this._stateSetters.setStencilTest),this._stencilTestInvalid=!1}_setDepthWrite(e){this._depthWrite=this._setSubState(e,this._depthWrite,this._depthWriteInvalid,this._stateSetters.setDepthWrite),this._depthWriteInvalid=!1}_setColorWrite(e){this._colorWrite=this._setSubState(e,this._colorWrite,this._colorWriteInvalid,this._stateSetters.setColorWrite),this._colorWriteInvalid=!1}_setStencilWrite(e){this._stencilWrite=this._setSubState(e,this._stencilWrite,this._stencilWriteInvalid,this._stateSetters.setStencilWrite),this._stencilTestInvalid=!1}_setSubState(e,r,i,s){return(i||e!==r)&&(s(e),this._pipelineInvalid=!0),e}},vht=class extends ui{constructor(){super(...arguments),this.heightParameters=Qt(),this.radii=Pe(),this.innerFadeDistance=0,this.altitudeFade=0,this.hazeStrength=1,this.renderScale=Pe(),this.backgroundColor=C()}},lM=class n3e extends Ur{initializeProgram(e){return new Lr(e.rctx,n3e.shader.get().build(this.configuration),Er)}initializePipeline(){return this.configuration.reduced?It({blending:Ru(Te.ONE,Te.ZERO),depthTest:{func:ci.ALWAYS},colorWrite:Wt}):this.configuration.haze?It({blending:ca(Te.ONE,Te.ZERO,Te.ONE_MINUS_SRC_COLOR,Te.ONE),colorWrite:Wt}):It({blending:Ru(Te.SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};lM.shader=new $r(Jut,()=>J(()=>import("./ChapmanAtmosphere.glsl-1f384add.js"),[],import.meta.url));let nl=class extends ui{constructor(){super(),this._key="",this._keyDirty=!1,this._parameterBits=this._parameterBits?this._parameterBits.map(()=>0):[],this._parameterNames||(this._parameterNames=[])}get key(){return this._keyDirty&&(this._keyDirty=!1,this._key=String.fromCharCode.apply(String,this._parameterBits)),this._key}snapshot(){const e=this._parameterNames,r={key:this.key};for(const i of e)r[i]=this[i];return r}};function B(t={}){return(e,r)=>{if(e._parameterNames=e._parameterNames??[],e._parameterNames.push(r),t.constValue!=null)Object.defineProperty(e,r,{get:()=>t.constValue});else{const i=e._parameterNames.length-1,s=t.count||2,n=Math.ceil(Math.log2(s)),o=e._parameterBits??[0];let a=0;for(;o[a]+n>16;)a++,a>=o.length&&o.push(0);e._parameterBits=o;const l=o[a],c=(1<<n)-1<<l;o[a]+=n,Object.defineProperty(e,r,{get(){return this[i]},set(h){if(this[i]!==h&&(this[i]=h,this._keyDirty=!0,this._parameterBits[a]=this._parameterBits[a]&~c|+h<<l&c,typeof h!="number"&&typeof h!="boolean"))throw new Error("Configuration value for "+r+" must be boolean or number, got "+typeof h)}})}}}let fU=class extends nl{constructor(){super(...arguments),this.haze=!1,this.reduced=!1}};u([B()],fU.prototype,"haze",void 0),u([B()],fU.prototype,"reduced",void 0);let sa=class{constructor(e,r,i,s,n,o=!1,a=0){this.name=e,this.count=r,this.type=i,this.offset=s,this.stride=n,this.normalized=o,this.divisor=a}};new sa(E.POSITION,3,rt.FLOAT,0,12);new sa(E.POSITION,3,rt.FLOAT,0,20),new sa(E.UV0,2,rt.FLOAT,12,20);new sa(E.POSITION,3,rt.FLOAT,0,32),new sa(E.NORMAL,3,rt.FLOAT,12,32),new sa(E.UV0,2,rt.FLOAT,24,32);new sa(E.POSITION,3,rt.FLOAT,0,16),new sa(E.COLOR,4,rt.UNSIGNED_BYTE,12,16);const Nte=[new sa(E.POSITION,2,rt.FLOAT,0,8)],T$=[new sa(E.POSITION,2,rt.FLOAT,0,16),new sa(E.UV0,2,rt.FLOAT,8,16)];function kue(t){const e=t.gl;switch(e.getError()){case e.NO_ERROR:return null;case e.INVALID_ENUM:return"An unacceptable value has been specified for an enumerated argument";case e.INVALID_VALUE:return"An unacceptable value has been specified for an argument";case e.INVALID_OPERATION:return"The specified command is not allowed for the current state";case e.INVALID_FRAMEBUFFER_OPERATION:return"The currently bound framebuffer is not framebuffer complete";case e.OUT_OF_MEMORY:return"Not enough memory is left to execute the command";case e.CONTEXT_LOST_WEBGL:return"WebGL context is lost"}return"Unknown error"}function Sa(t,e){return t.vertexBuffers[e].byteLength/bht(t.layout[e])}function bht(t){return t[0].stride}function Fte(t,e,r,i,s=0){const n=t.gl,o=t.capabilities.instancing;t.bindBuffer(r);for(const a of i){const l=e.get(a.name);l===void 0&&console.error(`There is no location for vertex attribute '${a.name}' defined.`);const c=s*a.stride;if(a.count<=4)n.vertexAttribPointer(l,a.count,a.type,a.normalized,a.stride,a.offset+c),n.enableVertexAttribArray(l),a.divisor>0&&o&&o.vertexAttribDivisor(l,a.divisor);else if(a.count===9)for(let h=0;h<3;h++)n.vertexAttribPointer(l+h,3,a.type,a.normalized,a.stride,a.offset+12*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else if(a.count===16)for(let h=0;h<4;h++)n.vertexAttribPointer(l+h,4,a.type,a.normalized,a.stride,a.offset+16*h+c),n.enableVertexAttribArray(l+h),a.divisor>0&&o&&o.vertexAttribDivisor(l+h,a.divisor);else console.error("Unsupported vertex attribute element count: "+a.count)}}function kte(t,e,r,i){const s=t.gl,n=t.capabilities.instancing;t.bindBuffer(r);for(const o of i){const a=e.get(o.name);if(o.count<=4)s.disableVertexAttribArray(a),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a,0);else if(o.count===9)for(let l=0;l<3;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else if(o.count===16)for(let l=0;l<4;l++)s.disableVertexAttribArray(a+l),o.divisor&&o.divisor>0&&n&&n.vertexAttribDivisor(a+l,0);else console.error("Unsupported vertex attribute element count: "+o.count)}t.unbindBuffer(St.ARRAY_BUFFER)}function Ute(t){switch(t){case At.ALPHA:case At.LUMINANCE:case At.RED:case At.RED_INTEGER:case Je.R8:case Je.R8I:case Je.R8UI:case Je.R8_SNORM:case bn.STENCIL_INDEX8:return 1;case At.LUMINANCE_ALPHA:case At.RG:case At.RG_INTEGER:case Je.RGBA4:case Je.R16F:case Je.R16I:case Je.R16UI:case Je.RG8:case Je.RG8I:case Je.RG8UI:case Je.RG8_SNORM:case Je.RGB565:case Je.RGB5_A1:case bn.DEPTH_COMPONENT16:return 2;case At.DEPTH_COMPONENT:case At.RGB:case At.RGB_INTEGER:case Je.RGB8:case Je.RGB8I:case Je.RGB8UI:case Je.RGB8_SNORM:case Je.SRGB8:case bn.DEPTH_COMPONENT24:return 3;case At.DEPTH_STENCIL:case At.DEPTH24_STENCIL8:case At.RGBA:case At.RGBA_INTEGER:case Je.RGBA8:case Je.R32F:case Je.R11F_G11F_B10F:case Je.RG16F:case Je.R32I:case Je.R32UI:case Je.RG16I:case Je.RG16UI:case Je.RGBA8I:case Je.RGBA8UI:case Je.RGBA8_SNORM:case Je.SRGB8_ALPHA8:case Je.RGB9_E5:case Je.RGB10_A2UI:case Je.RGB10_A2:case bn.DEPTH_STENCIL:case bn.DEPTH_COMPONENT32F:case bn.DEPTH24_STENCIL8:return 4;case bn.DEPTH32F_STENCIL8:return 5;case Je.RGB16F:case Je.RGB16I:case Je.RGB16UI:return 6;case Je.RG32F:case Je.RG32I:case Je.RG32UI:case Je.RGBA16F:case Je.RGBA16I:case Je.RGBA16UI:return 8;case Je.RGB32F:case Je.RGB32I:case Je.RGB32UI:return 12;case Je.RGBA32F:case Je.RGBA32I:case Je.RGBA32UI:return 16;case Ns.COMPRESSED_RGB_S3TC_DXT1_EXT:case Ns.COMPRESSED_RGBA_S3TC_DXT1_EXT:return .5;case Ns.COMPRESSED_RGBA_S3TC_DXT3_EXT:case Ns.COMPRESSED_RGBA_S3TC_DXT5_EXT:return 1;case Ns.COMPRESSED_R11_EAC:case Ns.COMPRESSED_SIGNED_R11_EAC:case Ns.COMPRESSED_RGB8_ETC2:case Ns.COMPRESSED_SRGB8_ETC2:case Ns.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:case Ns.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:return .5;case Ns.COMPRESSED_RG11_EAC:case Ns.COMPRESSED_SIGNED_RG11_EAC:case Ns.COMPRESSED_RGBA8_ETC2_EAC:case Ns.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:return 1}return 0}const jS=K.getLogger("esri.views.webgl.VertexArrayObject");let Xd=class{constructor(e,r,i,s,n=null){this._context=e,this._locations=r,this._layout=i,this._buffers=s,this._indexBuffer=n,this._glName=null,this._initialized=!1,e.instanceCounter.increment(io.VertexArrayObject,this)}get glName(){return this._glName}get context(){return this._context}get vertexBuffers(){return this._buffers}get indexBuffer(){return this._indexBuffer}get byteSize(){return Object.keys(this._buffers).reduce((e,r)=>e+this._buffers[r].byteLength,this._indexBuffer!=null?this._indexBuffer.byteLength:0)}get layout(){return this._layout}get locations(){return this._locations}get memoryEstimate(){return this.byteSize+(Object.keys(this._buffers).length+(this._indexBuffer?1:0))*G0e}dispose(){if(this._context){this._context.getBoundVAO()===this&&this._context.bindVAO(null);for(const e in this._buffers)this._buffers[e]?.dispose(),delete this._buffers[e];this._indexBuffer=ze(this._indexBuffer),this.disposeVAOOnly()}else(this._glName||Object.getOwnPropertyNames(this._buffers).length>0)&&jS.warn("Leaked WebGL VAO")}disposeVAOOnly(){this._glName&&((this._context?.capabilities?.vao).deleteVertexArray(this._glName),this._glName=null),this._context.instanceCounter.decrement(io.VertexArrayObject,this),this._context=tO(this._context)}initialize(){if(this._initialized)return;const e=this._context.capabilities.vao;if(e){const r=e.createVertexArray();e.bindVertexArray(r),this._bindLayout(),e.bindVertexArray(null),this._glName=r}this._initialized=!0}bind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(this.glName):(this._context.bindVAO(null),this._bindLayout())}_bindLayout(){const{_buffers:e,_layout:r,_indexBuffer:i}=this;e||jS.error("Vertex buffer dictionary is empty!");const s=this._context.gl;for(const n in e){const o=e[n];o||jS.error("Vertex buffer is uninitialized!");const a=r[n];a||jS.error("Vertex element descriptor is empty!"),Fte(this._context,this._locations,o,a)}i!=null&&(this._context.capabilities.vao?s.bindBuffer(s.ELEMENT_ARRAY_BUFFER,i.glName):this._context.bindBuffer(i))}unbind(){this.initialize();const e=this._context.capabilities.vao;e?e.bindVertexArray(null):this._unbindLayout()}_unbindLayout(){const{_buffers:e,_layout:r}=this;e||jS.error("Vertex buffer dictionary is empty!");for(const i in e){const s=e[i];s||jS.error("Vertex buffer is uninitialized!");const n=r[i];kte(this._context,this._locations,s,n)}this._indexBuffer!=null&&this._context.unbindBuffer(this._indexBuffer.bufferType)}},zf=class extends Xd{};var pr;function aX(t,e,r={}){const i=e===pr.WEBGL1?["webgl","experimental-webgl","webkit-3d","moz-webgl"]:["webgl2"];for(const s of i){const n=t.getContext(s,r);if(n)return n}return null}function wht(t,e,r={}){const i=o3e(t);for(const s of i){const n=aX(e,s,r);if(n)return n}return null}function o3e(t){if(t==="3d")return[pr.WEBGL2];const e=le("esri-force-webgl");return e===pr.WEBGL1||e===pr.WEBGL2?[e]:le("mac")&&le("chrome")?[pr.WEBGL1,pr.WEBGL2]:[pr.WEBGL2,pr.WEBGL1]}(function(t){t[t.WEBGL1=1]="WEBGL1",t[t.WEBGL2=2]="WEBGL2"})(pr||(pr={}));const tm=K.getLogger("esri.views.webgl.BufferObject");let Gr=class EE{static createIndex(e,r,i){return new EE(e,St.ELEMENT_ARRAY_BUFFER,r,i)}static createVertex(e,r,i){return new EE(e,St.ARRAY_BUFFER,r,i)}static createUniform(e,r,i){if(e.type!==pr.WEBGL2)throw new Error("Uniform buffers are supported in WebGL2 only!");return new EE(e,St.UNIFORM_BUFFER,r,i)}static createPixelPack(e,r=Mr.STREAM_READ,i){if(e.type!==pr.WEBGL2)throw new Error("Pixel pack buffers are supported in WebGL2 only!");const s=new EE(e,St.PIXEL_PACK_BUFFER,r);return i&&s.setSize(i),s}static createPixelUnpack(e,r=Mr.STREAM_DRAW,i){if(e.type!==pr.WEBGL2)throw new Error("Pixel unpack buffers are supported in WebGL2 only!");return new EE(e,St.PIXEL_UNPACK_BUFFER,r,i)}constructor(e,r,i,s){this._context=e,this.bufferType=r,this.usage=i,this._glName=null,this._size=-1,this._indexType=void 0,e.instanceCounter.increment(io.BufferObject,this),this._glName=this._context.gl.createBuffer(),Xv(this._context.gl),s&&this.setData(s)}get glName(){return this._glName}get size(){return this._size}get indexType(){return this._indexType}get byteLength(){return this.bufferType===St.ELEMENT_ARRAY_BUFFER?this._indexType===rt.UNSIGNED_INT?4*this._size:2*this._size:this._size}get _isVAOAware(){return this.bufferType===St.ELEMENT_ARRAY_BUFFER||this.bufferType===St.ARRAY_BUFFER}dispose(){this._context?.gl?(this._glName&&(this._context.gl.deleteBuffer(this._glName),this._glName=null),this._context.instanceCounter.decrement(io.BufferObject,this),this._context=tO(this._context)):this._glName&&tm.warn("Leaked WebGL buffer object")}setSize(e,r=null){if(e<=0&&tm.error("Buffer size needs to be positive!"),this.bufferType===St.ELEMENT_ARRAY_BUFFER&&r!=null)switch(this._indexType=r,r){case rt.UNSIGNED_SHORT:e*=2;break;case rt.UNSIGNED_INT:e*=4}this._setBufferData(e)}setData(e){if(!e)return;let r=e.byteLength;this.bufferType===St.ELEMENT_ARRAY_BUFFER&&(x6(e)&&(r/=2,this._indexType=rt.UNSIGNED_SHORT),S6(e)&&(r/=4,this._indexType=rt.UNSIGNED_INT)),this._setBufferData(r,e)}_setBufferData(e,r=null){this._size=e;const i=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const s=this._context.gl;r!=null?s.bufferData(this.bufferType,r,this.usage):s.bufferData(this.bufferType,e,this.usage),Xv(s),this._isVAOAware&&this._context.bindVAO(i)}setSubData(e,r,i,s){if(!e)return;(r<0||r*e.BYTES_PER_ELEMENT>=this.byteLength)&&tm.error("offset is out of range!"),i>=s&&tm.error("end must be bigger than start!"),(r+(s-i))*e.BYTES_PER_ELEMENT>this.byteLength&&tm.error("An attempt to write beyond the end of the buffer!");const n=this._context.getBoundVAO();this._isVAOAware&&this._context.bindVAO(null),this._context.bindBuffer(this);const o=this._context.gl;if(this._context.type===pr.WEBGL2)o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,e,i,s-i);else{const a=i===0&&s===e.length?e:e.subarray(i,s);o.bufferSubData(this.bufferType,r*e.BYTES_PER_ELEMENT,a)}Xv(o),this._isVAOAware&&this._context.bindVAO(n)}getSubData(e,r=0,i,s){if(this._context.type!==pr.WEBGL2)return void tm.error("Get buffer subdata is supported in WebGL2 only!");if(i<0||s<0)return void tm.error("Problem getting subdata: offset and length were less than zero!");const n=xht(e)?e.BYTES_PER_ELEMENT:1;if(n*((i??0)+(s??0))>e.byteLength)return void tm.error("Problem getting subdata: offset and length exceeded destination size!");r+n*(s??0)>this.byteLength&&tm.warn("Potential problem getting subdata: requested data exceeds buffer size!");const o=this._context.gl;this._context.bindBuffer(this,St.COPY_READ_BUFFER),o.getBufferSubData(St.COPY_READ_BUFFER,r,e,i,s),this._context.unbindBuffer(St.COPY_READ_BUFFER)}async getSubDataAsync(e,r=0,i,s){this._context.type===pr.WEBGL2?(await this._context.clientWaitAsync(),this.getSubData(e,r,i,s)):tm.error("Get buffer subdata is supported in WebGL2 only!")}};function xht(t){return _4e(t)}var X1;(function(t){t[t.Texture=0]="Texture",t[t.RenderBuffer=1]="RenderBuffer"})(X1||(X1={}));let Sr=class{constructor(e=0,r=e){this.width=e,this.height=r,this.target=Rs.TEXTURE_2D,this.pixelFormat=At.RGBA,this.dataType=fn.UNSIGNED_BYTE,this.samplingMode=Mt.LINEAR,this.wrapMode=Ut.REPEAT,this.maxAnisotropy=1,this.flipped=!1,this.hasMipmap=!1,this.isOpaque=!1,this.unpackAlignment=4,this.preMultiplyAlpha=!1,this.depth=1,this.isImmutable=!1}};function Tht(t){return t.width<=0||t.height<=0||t.internalFormat==null?0:t.width*t.height*(t.hasMipmap?4/3:1)*Ute(t.internalFormat)}let Sht=class a3e extends Sr{constructor(e,r){switch(super(),this.context=e,Object.assign(this,r),this.internalFormat){case Je.R16F:case Je.R16I:case Je.R16UI:case Je.R32F:case Je.R32I:case Je.R32UI:case Je.R8_SNORM:case Je.R8:case Je.R8I:case Je.R8UI:this.pixelFormat=At.RED}}static validate(e,r){return new a3e(e,r)}};const Uue=4;let Rt=class{constructor(e,r=null,i=null){if(this.type=X1.Texture,this._glName=null,this._samplingModeDirty=!1,this._wrapModeDirty=!1,this._wasImmutablyAllocated=!1,"context"in e)this._descriptor=e,i=r;else{const s=Sht.validate(e,r);if(!s)throw new D("Texture descriptor invalid");this._descriptor=s}if(this._descriptor.context.instanceCounter.increment(io.Texture,this),this._descriptor.context.type!==pr.WEBGL2&&(this._descriptor.isImmutable&&(this._descriptor.isImmutable=!1),rx(this._descriptor.target)))throw new D("3D and array textures are not supported in WebGL1");this._descriptor.target===Rs.TEXTURE_CUBE_MAP?this._setDataCubeMap(i):this.setData(i)}get glName(){return this._glName}get descriptor(){return this._descriptor}get gpuMemoryUsage(){return Rht.delete(this),Tht(this._descriptor)}get isDirty(){return this._samplingModeDirty||this._wrapModeDirty}dispose(){this._descriptor.context.gl&&this._glName&&(this._descriptor.context.unbindTexture(this),this._descriptor.context.gl.deleteTexture(this._glName),this._glName=null,this._descriptor.context.instanceCounter.decrement(io.Texture,this))}release(){this.dispose()}resize(e,r){const i=this._descriptor;if(i.width!==e||i.height!==r){if(this._wasImmutablyAllocated)throw new D("Immutable textures can't be resized!");i.width=e,i.height=r,this._descriptor.target===Rs.TEXTURE_CUBE_MAP?this._setDataCubeMap(null):this.setData(null)}}_setDataCubeMap(e=null){for(let r=Rs.TEXTURE_CUBE_MAP_POSITIVE_X;r<=Rs.TEXTURE_CUBE_MAP_NEGATIVE_Z;r++)this._setData(e,r)}setData(e){this._setData(e)}_setData(e,r){if(!this._descriptor.context||!this._descriptor.context.gl)return;const i=this._descriptor.context.gl;Xv(i),this._glName||(this._glName=i.createTexture()),e===void 0&&(e=null);const s=this._descriptor,n=r??s.target,o=rx(n);e===null&&(s.width=s.width||Uue,s.height=s.height||Uue,o&&(s.depth=s.depth??1));const a=this._descriptor.context.bindTexture(this,Rt.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(Rt.TEXTURE_UNIT_FOR_UPDATES),Qz(this._descriptor.context,s),this._configurePixelStorage(),Xv(i);const l=this._deriveInternalFormat();if(Kz(e)){let c=e.width,h=e.height;const p=1;e instanceof HTMLVideoElement&&(c=e.videoWidth,h=e.videoHeight),s.width&&s.height,o&&s.depth,s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,l,s.hasMipmap,c,h,p),this._texImage(n,0,l,c,h,p,e),Xv(i),s.hasMipmap&&this.generateMipmap(),s.width||(s.width=c),s.height||(s.height=h),o&&!s.depth&&(s.depth=p)}else{const{width:c,height:h,depth:p}=s;if(c==null||h==null)throw new D("Width and height must be specified!");if(o&&p==null)throw new D("Depth must be specified!");if(s.isImmutable&&!this._wasImmutablyAllocated&&this._texStorage(n,l,s.hasMipmap,c,h,p),W4(e)){const f=e.levels,m=Bue(n,c,h,p),g=Math.min(m-1,f.length-1);this._descriptor.context.gl2!=null?i.texParameteri(s.target,this._descriptor.context.gl2.TEXTURE_MAX_LEVEL,g):s.hasMipmap=s.hasMipmap&&m===f.length;const _=l;if(!Aht(_))throw new D("Attempting to use compressed data with an uncompressed format!");this._forEachMipmapLevel((v,b,x,T)=>{const S=f[Math.min(v,f.length-1)];this._compressedTexImage(n,v,_,b,x,T,S)},g)}else this._texImage(n,0,l,c,h,p,e),Xv(i),s.hasMipmap&&this.generateMipmap()}Vue(i,this._descriptor),zue(i,this._descriptor),Eht(this._descriptor.context,this._descriptor),Xv(i),this._descriptor.context.bindTexture(a,Rt.TEXTURE_UNIT_FOR_UPDATES)}updateData(e,r,i,s,n,o,a=0){o||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const l=this._descriptor.context.gl,c=this._descriptor.context.gl2,h=this._descriptor,p=this._deriveInternalFormat(),{pixelFormat:f,dataType:m,target:g,isImmutable:_}=h;if(_&&!this._wasImmutablyAllocated)throw new D("Cannot update immutable texture before allocation!");const v=this._descriptor.context.bindTexture(this,Rt.TEXTURE_UNIT_FOR_UPDATES,!0);if((r<0||i<0||s>h.width||n>h.height||r+s>h.width||i+n>h.height)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),a){if(!c)return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(c.UNPACK_SKIP_ROWS,a)}if(Kz(o)?c?c.texSubImage2D(g,e,r,i,s,n,f,m,o):l.texSubImage2D(g,e,r,i,f,m,o):W4(o)?l.compressedTexSubImage2D(g,e,r,i,s,n,p,o.levels[e]):l.texSubImage2D(g,e,r,i,s,n,f,m,o),a){if(!c)return void console.error("Webgl2 must be enabled to use dataRowOffset!");l.pixelStorei(c.UNPACK_SKIP_ROWS,0)}this._descriptor.context.bindTexture(v,Rt.TEXTURE_UNIT_FOR_UPDATES)}updateData3D(e,r,i,s,n,o,a,l){l||console.error("An attempt to use uninitialized data!"),this._glName||console.error("An attempt to update uninitialized texture!");const c=this._descriptor.context.gl2;if(c==null)throw new D("3D textures are not supported in WebGL1");const h=this._descriptor,p=this._deriveInternalFormat(),{pixelFormat:f,dataType:m,isImmutable:g,target:_}=h;if(g&&!this._wasImmutablyAllocated)throw new D("Cannot update immutable texture before allocation!");rx(_)||console.warn("Attempting to set 3D texture data on a non-3D texture");const v=this._descriptor.context.bindTexture(this,Rt.TEXTURE_UNIT_FOR_UPDATES);if(this._descriptor.context.setActiveTexture(Rt.TEXTURE_UNIT_FOR_UPDATES),(r<0||i<0||s<0||n>h.width||o>h.height||a>h.depth||r+n>h.width||i+o>h.height||s+a>h.depth)&&console.error("An attempt to update out of bounds of the texture!"),this._configurePixelStorage(),W4(l))l=l.levels[e],c.compressedTexSubImage3D(_,e,r,i,s,n,o,a,p,l);else{const b=l;c.texSubImage3D(_,e,r,i,s,n,o,a,f,m,b)}this._descriptor.context.bindTexture(v,Rt.TEXTURE_UNIT_FOR_UPDATES)}generateMipmap(){const e=this._descriptor;if(!e.hasMipmap){if(this._wasImmutablyAllocated)throw new D("Cannot add mipmaps to immutable texture after allocation");e.hasMipmap=!0,this._samplingModeDirty=!0,Qz(this._descriptor.context,e)}e.samplingMode===Mt.LINEAR?(this._samplingModeDirty=!0,e.samplingMode=Mt.LINEAR_MIPMAP_NEAREST):e.samplingMode===Mt.NEAREST&&(this._samplingModeDirty=!0,e.samplingMode=Mt.NEAREST_MIPMAP_NEAREST);const r=this._descriptor.context.bindTexture(this,Rt.TEXTURE_UNIT_FOR_UPDATES);this._descriptor.context.setActiveTexture(Rt.TEXTURE_UNIT_FOR_UPDATES),this._descriptor.context.gl.generateMipmap(e.target),this._descriptor.context.bindTexture(r,Rt.TEXTURE_UNIT_FOR_UPDATES)}setSamplingMode(e){e!==this._descriptor.samplingMode&&(this._descriptor.samplingMode=e,this._samplingModeDirty=!0)}setWrapMode(e){e!==this._descriptor.wrapMode&&(this._descriptor.wrapMode=e,Qz(this._descriptor.context,this._descriptor),this._wrapModeDirty=!0)}applyChanges(){const e=this._descriptor.context.gl,r=this._descriptor;this._samplingModeDirty&&(Vue(e,r),this._samplingModeDirty=!1),this._wrapModeDirty&&(zue(e,r),this._wrapModeDirty=!1)}_deriveInternalFormat(){if(this._descriptor.context.type===pr.WEBGL1)return this._descriptor.internalFormat=this._descriptor.pixelFormat;if(this._descriptor.internalFormat!=null)return this._descriptor.internalFormat===At.DEPTH_STENCIL&&(this._descriptor.internalFormat=At.DEPTH24_STENCIL8),this._descriptor.internalFormat;switch(this._descriptor.dataType){case fn.FLOAT:switch(this._descriptor.pixelFormat){case At.RGBA:return this._descriptor.internalFormat=Je.RGBA32F;case At.RGB:return this._descriptor.internalFormat=Je.RGB32F;default:throw new D("Unable to derive format")}case fn.UNSIGNED_BYTE:switch(this._descriptor.pixelFormat){case At.RGBA:return this._descriptor.internalFormat=Je.RGBA8;case At.RGB:return this._descriptor.internalFormat=Je.RGB8}}return this._descriptor.internalFormat=this._descriptor.pixelFormat===At.DEPTH_STENCIL?At.DEPTH24_STENCIL8:this._descriptor.pixelFormat}_configurePixelStorage(){const e=this._descriptor.context.gl,{unpackAlignment:r,flipped:i,preMultiplyAlpha:s}=this._descriptor;e.pixelStorei(e.UNPACK_ALIGNMENT,r),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,i?1:0),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,s?1:0)}_texStorage(e,r,i,s,n,o){const a=this._descriptor.context.gl2;if(a==null)throw new D("Immutable textures are not supported in WebGL1");if(!Cht(r))throw new D("Immutable textures must have a sized internal format");if(!this._descriptor.isImmutable)return;const l=i?Bue(e,s,n,o):1;if(rx(e)){if(o==null)throw new D("Missing depth dimension for 3D texture upload");a.texStorage3D(e,l,r,s,n,o)}else a.texStorage2D(e,l,r,s,n);this._wasImmutablyAllocated=!0}_texImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl,c=rx(e),{isImmutable:h,pixelFormat:p,dataType:f}=this._descriptor,m=this._descriptor.context.type===pr.WEBGL2,g=m?l:null;if(m||!Kz(a))if(h){if(a!=null){const _=a;if(c){if(o==null)throw new D("Missing depth dimension for 3D texture upload");g.texSubImage3D(e,r,0,0,0,s,n,o,p,f,_)}else l.texSubImage2D(e,r,0,0,s,n,p,f,_)}}else{const _=a;if(c){if(o==null)throw new D("Missing depth dimension for 3D texture upload");g.texImage3D(e,r,i,s,n,o,0,p,f,_)}else l.texImage2D(e,r,i,s,n,0,p,f,_)}else l.texImage2D(e,0,i,p,f,a)}_compressedTexImage(e,r,i,s,n,o,a){const l=this._descriptor.context.gl;let c=null;const h=rx(e),p=this._descriptor.isImmutable;if(h){if(this._descriptor.context.type!==pr.WEBGL2)throw new D("3D textures are not supported in WebGL1");c=l}if(p){if(a!=null)if(h){if(o==null)throw new D("Missing depth dimension for 3D texture upload");c.compressedTexSubImage3D(e,r,0,0,0,s,n,o,i,a)}else l.compressedTexSubImage2D(e,r,0,0,s,n,i,a)}else if(h){if(o==null)throw new D("Missing depth dimension for 3D texture upload");c.compressedTexImage3D(e,r,i,s,n,o,0,a)}else l.compressedTexImage2D(e,r,i,s,n,0,a)}_forEachMipmapLevel(e,r=1/0){let{width:i,height:s,depth:n,hasMipmap:o,target:a}=this._descriptor;const l=a===Rs.TEXTURE_3D;if(i==null||s==null||l&&n==null)throw new D("Missing texture dimensions for mipmap calculation");for(let c=0;e(c,i,s,n),o&&(i!==1||s!==1||l&&n!==1)&&!(c>=r);++c)i=Math.max(1,i>>1),s=Math.max(1,s>>1),l&&(n=Math.max(1,n>>1))}};function Qz(t,e){(e.width!=null&&e.width<0||e.height!=null&&e.height<0||e.depth!=null&&e.depth<0)&&console.error("Negative dimension parameters are not allowed!");const r=t.type===pr.WEBGL2;r||!e.isImmutable&&!rx(e.target)||console.error("Immutable and 3D-like textures are not supported in WebGL1!"),!r&&(e.width!=null&&OT(e.width)&&e.height!=null&&OT(e.height)||(typeof e.wrapMode=="number"?e.wrapMode!==Ut.CLAMP_TO_EDGE&&console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"):e.wrapMode.s===Ut.CLAMP_TO_EDGE&&e.wrapMode.t===Ut.CLAMP_TO_EDGE||console.error("Non-power-of-two textures must have a wrap mode of CLAMP_TO_EDGE!"),e.hasMipmap&&console.error("Mipmapping requires power-of-two textures!")))}function Vue(t,e){let r=e.samplingMode,i=e.samplingMode;r===Mt.LINEAR_MIPMAP_NEAREST||r===Mt.LINEAR_MIPMAP_LINEAR?(r=Mt.LINEAR,e.hasMipmap||(i=Mt.LINEAR)):r!==Mt.NEAREST_MIPMAP_NEAREST&&r!==Mt.NEAREST_MIPMAP_LINEAR||(r=Mt.NEAREST,e.hasMipmap||(i=Mt.NEAREST)),t.texParameteri(e.target,t.TEXTURE_MAG_FILTER,r),t.texParameteri(e.target,t.TEXTURE_MIN_FILTER,i)}function zue(t,e){typeof e.wrapMode=="number"?(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode)):(t.texParameteri(e.target,t.TEXTURE_WRAP_S,e.wrapMode.s),t.texParameteri(e.target,t.TEXTURE_WRAP_T,e.wrapMode.t))}function Eht(t,e){const r=t.capabilities.textureFilterAnisotropic;r&&t.gl.texParameterf(e.target,r.TEXTURE_MAX_ANISOTROPY,e.maxAnisotropy??1)}function Cht(t){return t in Je}function Aht(t){return t in Ns}function W4(t){return t!=null&&"type"in t&&t.type==="compressed"}function Oht(t){return t!=null&&"byteLength"in t}function Kz(t){return t!=null&&!W4(t)&&!Oht(t)}function rx(t){return t===Rs.TEXTURE_3D||t===Rs.TEXTURE_2D_ARRAY}function Bue(t,e,r,i=1){let s=Math.max(e,r);return t===Rs.TEXTURE_3D&&(s=Math.max(s,i)),Math.round(Math.log(s)/Math.LN2)+1}Rt.TEXTURE_UNIT_FOR_UPDATES=0;const Rht=new Map;function Mc(t,e=Nte,r=Er,i=-1,s=1){let n=null;return e===T$?n=new Float32Array([i,i,0,0,s,i,1,0,i,s,0,1,s,s,1,1]):n=new Float32Array([i,i,s,i,i,s,s,s]),new zf(t,r,{geometry:e},{geometry:Gr.createVertex(t,Mr.STATIC_DRAW,n)})}function Mht(t,e=Nte,r=Er){const i=new Float32Array([-1,-1,3,-1,-1,3]);return new zf(t,r,{geometry:e},{geometry:Gr.createVertex(t,Mr.STATIC_DRAW,i)})}const l3e=4;function c3e(t,e=l3e){const r=new Sr;return r.samplingMode=Mt.NEAREST,r.width=r.height=e,new Rt(t,r)}function Iht(t,e,r=l3e){const i=new Uint8Array(r*r*4);for(let n=0;n<i.length;n+=4)i[n]=255*e[0],i[n+1]=255*e[1],i[n+2]=255*e[2],i[n+3]=255*e[3];const s=new Sr;return s.samplingMode=Mt.NEAREST,s.width=s.height=r,new Rt(t,s,i)}function u3e(t){const e=new Sr;return e.samplingMode=Mt.NEAREST,e.width=e.height=1,new Rt(t,e,new Uint8Array([255,255,255,255]))}let Gue=class{constructor(e,r){this._view=e,this.type=Ga.Realistic,this._handles=new li,this._passParameters=new vht,this._rootTileElevationMin=NaN,this._lowerBoundEarthRadius=ur.radius,this._fadeHaze=0,this._tmpScale=Pe(),this._updateRadius(ur.radius);const i=r.renderContext.rctx;this._updateRootTileElevationBounds(),this._handles.add([Q(()=>this._view?.basemapTerrain?.rootTileElevationBounds,()=>this._view?.basemapTerrain?this._updateRootTileElevationBounds():null),Q(()=>this._view?.basemapTerrain?.visibleElevationBounds,()=>this._view?.basemapTerrain?this._updateVisibleElevationBounds():null)]);const s=new fU;s.haze=!1,this._atmosphereTechnique=r.techniqueRepository.acquire(lM,s),s.haze=!0,this._atmosphereHazeTechnique=r.techniqueRepository.acquire(lM,s),s.reduced=!0,s.haze=!1,this._atmosphereReducedTechnique=r.techniqueRepository.acquire(lM,s),s.haze=!0,this._atmosphereHazeReducedTechnique=r.techniqueRepository.acquire(lM,s),this._vao=Mc(i,T$)}destroy(){this._handles.destroy(),this._atmosphereTechnique.release(),this._atmosphereHazeTechnique.release(),this._atmosphereReducedTechnique.release(),this._atmosphereHazeReducedTechnique.release(),this._vao.dispose()}render(e,r){this._render(e,r?this._atmosphereTechnique:this._atmosphereReducedTechnique,e.offscreenRenderingHelper.depthTexture,r,!1)}renderHaze(e,r,i){this._fadeHaze=r,this._render(e,i?this._atmosphereHazeTechnique:this._atmosphereHazeReducedTechnique,e.offscreenRenderingHelper.linearDepthTexture,i,!0)}_render(e,r,i,s,n){if(i==null)return;const o=e.offscreenRenderingHelper;this._update(e.bindParameters.camera),this._passParameters.depthTexture=i;const a=o.background.color;ie(this._passParameters.backgroundColor,a[0]*a[3],a[1]*a[3],a[2]*a[3]);const l=e.rctx.bindTechnique(r,this._passParameters,e.bindParameters);if(s)o.renderDepthDetached(()=>this._renderCommon(l,e));else{const c=e.rctx.getViewport(),h=Oe(e.bindParameters.camera.eye)-ur.radius;let p;if(h<Vv){const g=Math.min(1,Math.max(0,h/Vv));p=n?Et(.4,.5,g):Et(.2,.3,g)}else{const g=Math.min(1,Math.max(0,(h-Vv)/(15*Vv)));p=n?Et(.5,1,g):Et(.3,.6,g)}const f=Math.floor(p*e.bindParameters.camera.fullViewport[2]),m=Math.floor(p*e.bindParameters.camera.fullViewport[3]);e.rctx.setViewport(0,0,f,m),o.renderToTargets(()=>this._renderCommon(l,e),o.tmpColor,o.tmpDepth,[0,0,0,1],!1,!1),e.rctx.setViewport(c.x,c.y,c.width,c.height),hr(this._tmpScale,f/e.bindParameters.camera.fullViewport[2],m/e.bindParameters.camera.fullViewport[3]),o.compositeAtmosphereToMain(e.bindParameters,n,i,this._tmpScale)}}_renderCommon(e,r){this._vao!=null&&(r.rctx.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),r.rctx.drawArrays(Ot.TRIANGLE_STRIP,0,4))}_adjustRadiusForTesselation(e){return e*Math.cos(Math.PI/16/16)}_updateRootTileElevationBounds(){const e=this._view.basemapTerrain.rootTileElevationBounds.min;e!==this._rootTileElevationMin&&(this._rootTileElevationMin=e,this._lowerBoundEarthRadius=ur.radius,this._updateVisibleElevationBounds())}_updateVisibleElevationBounds(){const e=this._adjustRadiusForTesselation(ur.radius+this._view.basemapTerrain.visibleElevationBounds.min);e<this._lowerBoundEarthRadius&&this._updateRadius(e)}_updateRadius(e){this._lowerBoundEarthRadius=e,hr(this._passParameters.radii,e,e+Vv),this._passParameters.innerFadeDistance=2*Math.sqrt((2*e-rX)*rX)}_update(e){if(!e)return;const r=Xa(e.eye),i=Math.sqrt(r),s=r-this._passParameters.radii[1]*this._passParameters.radii[1],n=ye((i-this._passParameters.radii[0])/Vv,0,1);zi(this._passParameters.heightParameters,i,r,s,n),this._passParameters.altitudeFade=Lte(i-this._lowerBoundEarthRadius),this._passParameters.hazeStrength=Et(Et(.6,1,BI(9500,10500,i-ur.radius)),1,this._fadeHaze)}static isSupported(e){return e.renderContext.rctx.capabilities.depthTexture}};function h3e(t){t.fragment.code.add(w`vec4 textureAtlasLookup(sampler2D tex, vec2 textureCoordinates, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(textureCoordinates) * atlasScale + atlasRegion.xy;
float maxdUV = 0.125;
vec2 dUVdx = clamp(dFdx(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
vec2 dUVdy = clamp(dFdy(textureCoordinates), -maxdUV, maxdUV) * atlasScale;
return textureGrad(tex, uvAtlas, dUVdx, dUVdy);
}`)}function Vte(t,e){switch(t.include(ag,e),e.textureCoordinateType){case sn.Default:case sn.Compressed:return void t.fragment.code.add(w`vec4 textureLookup(sampler2D tex, vec2 uv) {
return texture(tex, uv);
}`);case sn.Atlas:return t.include(h3e),void t.fragment.code.add(w`vec4 textureLookup(sampler2D tex, vec2 uv) {
return textureAtlasLookup(tex, uv, vuvRegion);
}`);default:e.textureCoordinateType;case sn.None:case sn.COUNT:return}}let _h=class extends Ps{constructor(e,r){super(e,"vec3",ai.Draw,(i,s,n,o)=>i.setUniform3fv(e,r(s,n,o)))}},Nd=class extends Ps{constructor(e,r){super(e,"sampler2D",ai.Draw,(i,s,n)=>i.bindTexture(e,r(s,n)))}},pb=class{constructor(e){this._material=e.material,this._techniqueRepository=e.techniqueRep,this._output=e.output}dispose(){this._techniqueRepository.release(this._technique)}get technique(){return this._technique}get _stippleTextureRepository(){return this._techniqueRepository.constructionContext.stippleTextureRepository}get _markerTextureRepository(){return this._techniqueRepository.constructionContext.markerTextureRepository}ensureTechnique(e,r){return this._technique=this._techniqueRepository.releaseAndAcquire(e,this._material.getConfiguration(this._output,r),this._technique),this._technique}ensureResources(e){return f0.LOADED}},zte=class extends pb{constructor(e){super(e),this._numLoading=0,this._disposed=!1,this._textureRepository=e.textureRep,this._textureId=e.textureId,this._acquire(e.textureId,r=>this._texture=r),this._acquire(e.normalTextureId,r=>this._textureNormal=r),this._acquire(e.emissiveTextureId,r=>this._textureEmissive=r),this._acquire(e.occlusionTextureId,r=>this._textureOcclusion=r),this._acquire(e.metallicRoughnessTextureId,r=>this._textureMetallicRoughness=r)}dispose(){this._texture=as(this._texture),this._textureNormal=as(this._textureNormal),this._textureEmissive=as(this._textureEmissive),this._textureOcclusion=as(this._textureOcclusion),this._textureMetallicRoughness=as(this._textureMetallicRoughness),this._disposed=!0}ensureResources(e){return this._numLoading===0?f0.LOADED:f0.LOADING}get textureBindParameters(){return new d3e(this._texture!=null?this._texture.glTexture:null,this._textureNormal!=null?this._textureNormal.glTexture:null,this._textureEmissive!=null?this._textureEmissive.glTexture:null,this._textureOcclusion!=null?this._textureOcclusion.glTexture:null,this._textureMetallicRoughness!=null?this._textureMetallicRoughness.glTexture:null)}updateTexture(e){this._texture!=null&&e===this._texture.id||(this._texture=as(this._texture),this._textureId=e,this._acquire(this._textureId,r=>this._texture=r))}_acquire(e,r){if(e==null)return void r(null);const i=this._textureRepository.acquire(e);if(Rh(i))return++this._numLoading,void i.then(s=>{if(this._disposed)return as(s),void r(null);r(s)}).finally(()=>--this._numLoading);r(i)}},d3e=class extends ui{constructor(e=null,r=null,i=null,s=null,n=null){super(),this.texture=e,this.textureNormal=r,this.textureEmissive=i,this.textureOcclusion=s,this.textureMetallicRoughness=n}};var lt;(function(t){t[t.Disabled=0]="Disabled",t[t.Normal=1]="Normal",t[t.Schematic=2]="Schematic",t[t.Water=3]="Water",t[t.WaterOnIntegratedMesh=4]="WaterOnIntegratedMesh",t[t.Terrain=5]="Terrain",t[t.TerrainWithWater=6]="TerrainWithWater",t[t.COUNT=7]="COUNT"})(lt||(lt={}));function Bte(t,e){const r=t.fragment,i=e.hasMetallicRoughnessTexture||e.hasEmissionTexture||e.hasOcclusionTexture;if(e.pbrMode===lt.Normal&&i&&t.include(Vte,e),e.pbrMode!==lt.Schematic)if(e.pbrMode!==lt.Disabled){if(e.pbrMode===lt.Normal){r.code.add(w`vec3 mrr;
vec3 emission;
float occlusion;`);const s=e.pbrTextureBindType;e.hasMetallicRoughnessTexture&&(r.uniforms.add(s===ai.Pass?new et("texMetallicRoughness",n=>n.textureMetallicRoughness):new Nd("texMetallicRoughness",n=>n.textureMetallicRoughness)),r.code.add(w`void applyMetallnessAndRoughness(vec2 uv) {
vec3 metallicRoughness = textureLookup(texMetallicRoughness, uv).rgb;
mrr[0] *= metallicRoughness.b;
mrr[1] *= metallicRoughness.g;
}`)),e.hasEmissionTexture&&(r.uniforms.add(s===ai.Pass?new et("texEmission",n=>n.textureEmissive):new Nd("texEmission",n=>n.textureEmissive)),r.code.add(w`void applyEmission(vec2 uv) {
emission *= textureLookup(texEmission, uv).rgb;
}`)),e.hasOcclusionTexture?(r.uniforms.add(s===ai.Pass?new et("texOcclusion",n=>n.textureOcclusion):new Nd("texOcclusion",n=>n.textureOcclusion)),r.code.add(w`void applyOcclusion(vec2 uv) {
occlusion *= textureLookup(texOcclusion, uv).r;
}
float getBakedOcclusion() {
return occlusion;
}`)):r.code.add(w`float getBakedOcclusion() { return 1.0; }`),s===ai.Pass?r.uniforms.add(new jt("emissionFactor",n=>n.emissiveFactor),new jt("mrrFactors",n=>n.mrrFactors)):r.uniforms.add(new _h("emissionFactor",n=>n.emissiveFactor),new _h("mrrFactors",n=>n.mrrFactors)),r.code.add(w`
    void applyPBRFactors() {
      mrr = mrrFactors;
      emission = emissionFactor;
      occlusion = 1.0;

      ${e.hasMetallicRoughnessTexture?w`applyMetallnessAndRoughness(${e.hasMetallicRoughnessTextureTransform?w`metallicRoughnessUV`:"vuv0"});`:""}

      ${e.hasEmissionTexture?w`applyEmission(${e.hasEmissiveTextureTransform?w`emissiveUV`:"vuv0"});`:""}

      ${e.hasOcclusionTexture?w`applyOcclusion(${e.hasOcclusionTextureTransform?w`occlusionUV`:"vuv0"});`:""}
    }
  `)}}else r.code.add(w`float getBakedOcclusion() { return 1.0; }`);else r.code.add(w`vec3 mrr = vec3(0.0, 0.6, 0.2);
vec3 emission = vec3(0.0);
float occlusion = 1.0;
void applyPBRFactors() {}
float getBakedOcclusion() { return 1.0; }`)}function Gte(t,e){const r=t.fragment,i=e.lightingSphericalHarmonicsOrder!==void 0?e.lightingSphericalHarmonicsOrder:2;i===0?(r.uniforms.add(new jt("lightingAmbientSH0",(s,n)=>ie(jue,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0]))),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===1?(r.uniforms.add(new cr("lightingAmbientSH_R",(s,n)=>zi(Xg,n.lighting.sh.r[0],n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3])),new cr("lightingAmbientSH_G",(s,n)=>zi(Xg,n.lighting.sh.g[0],n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3])),new cr("lightingAmbientSH_B",(s,n)=>zi(Xg,n.lighting.sh.b[0],n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3]))),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec4 sh0 = vec4(
0.282095,
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y
);
vec3 ambientLight = vec3(
dot(lightingAmbientSH_R, sh0),
dot(lightingAmbientSH_G, sh0),
dot(lightingAmbientSH_B, sh0)
);
return ambientLight * (1.0 - ambientOcclusion);
}`)):i===2&&(r.uniforms.add(new jt("lightingAmbientSH0",(s,n)=>ie(jue,n.lighting.sh.r[0],n.lighting.sh.g[0],n.lighting.sh.b[0])),new cr("lightingAmbientSH_R1",(s,n)=>zi(Xg,n.lighting.sh.r[1],n.lighting.sh.r[2],n.lighting.sh.r[3],n.lighting.sh.r[4])),new cr("lightingAmbientSH_G1",(s,n)=>zi(Xg,n.lighting.sh.g[1],n.lighting.sh.g[2],n.lighting.sh.g[3],n.lighting.sh.g[4])),new cr("lightingAmbientSH_B1",(s,n)=>zi(Xg,n.lighting.sh.b[1],n.lighting.sh.b[2],n.lighting.sh.b[3],n.lighting.sh.b[4])),new cr("lightingAmbientSH_R2",(s,n)=>zi(Xg,n.lighting.sh.r[5],n.lighting.sh.r[6],n.lighting.sh.r[7],n.lighting.sh.r[8])),new cr("lightingAmbientSH_G2",(s,n)=>zi(Xg,n.lighting.sh.g[5],n.lighting.sh.g[6],n.lighting.sh.g[7],n.lighting.sh.g[8])),new cr("lightingAmbientSH_B2",(s,n)=>zi(Xg,n.lighting.sh.b[5],n.lighting.sh.b[6],n.lighting.sh.b[7],n.lighting.sh.b[8]))),r.code.add(w`vec3 calculateAmbientIrradiance(vec3 normal, float ambientOcclusion) {
vec3 ambientLight = 0.282095 * lightingAmbientSH0;
vec4 sh1 = vec4(
0.488603 * normal.x,
0.488603 * normal.z,
0.488603 * normal.y,
1.092548 * normal.x * normal.y
);
vec4 sh2 = vec4(
1.092548 * normal.y * normal.z,
0.315392 * (3.0 * normal.z * normal.z - 1.0),
1.092548 * normal.x * normal.z,
0.546274 * (normal.x * normal.x - normal.y * normal.y)
);
ambientLight += vec3(
dot(lightingAmbientSH_R1, sh1),
dot(lightingAmbientSH_G1, sh1),
dot(lightingAmbientSH_B1, sh1)
);
ambientLight += vec3(
dot(lightingAmbientSH_R2, sh2),
dot(lightingAmbientSH_G2, sh2),
dot(lightingAmbientSH_B2, sh2)
);
return ambientLight * (1.0 - ambientOcclusion);
}`),e.pbrMode!==lt.Normal&&e.pbrMode!==lt.Schematic||r.code.add(w`const vec3 skyTransmittance = vec3(0.9, 0.9, 1.0);
vec3 calculateAmbientRadiance(float ambientOcclusion)
{
vec3 ambientLight = 1.2 * (0.282095 * lightingAmbientSH0) - 0.2;
return ambientLight *= (1.0 - ambientOcclusion) * skyTransmittance;
}`))}const jue=C(),Xg=Qt();function S$(t){t.vertex.code.add(w`const float PI = 3.141592653589793;`),t.fragment.code.add(w`const float PI = 3.141592653589793;
const float LIGHT_NORMALIZATION = 1.0 / PI;
const float INV_PI = 0.3183098861837907;
const float HALF_PI = 1.570796326794897;`)}var tn,zT;function Pht(t){return t?.cubeMap!=null}function jte(t){return t!=null&&!t.running}(function(t){t[t.RENDERING=0]="RENDERING",t[t.FINISHED_RENDERING=1]="FINISHED_RENDERING",t[t.FADING_TEXTURE_CHANNELS=2]="FADING_TEXTURE_CHANNELS",t[t.SWITCH_CHANNELS=3]="SWITCH_CHANNELS",t[t.FINISHED=4]="FINISHED"})(tn||(tn={})),function(t){t[t.RG=0]="RG",t[t.BA=1]="BA"}(zT||(zT={}));let $ht=class{constructor(){this.readChannels=zT.RG,this.renderingStage=tn.FINISHED,this.startTime=0,this.startTimeHeightFade=0,this.cameraPositionLastFrame=C(),this.isCameraPositionFinal=!0,this.parallax=new Hue,this.parallaxNew=new Hue,this.crossFade={enabled:!1,factor:1,distanceThresholdFactor:.3},this.fadeInOut={stage:Jn.FINISHED,factor:1,distanceThresholdFactor:.6},this.fadeIn={stage:hu.FINISHED,factor:1,distanceThresholdFactor:2},this.fadeInOutHeight={stage:Y1.FINISHED,factor:-1}}get isFading(){return this.fadeInOut.stage===Jn.FADE_OUT||this.fadeInOut.stage===Jn.FADE_IN||this.fadeIn.stage===hu.FADE_IN||this.fadeInOutHeight.stage!==Y1.FINISHED||this.renderingStage===tn.FADING_TEXTURE_CHANNELS}};var hu,Jn,Y1;(function(t){t[t.FINISHED=0]="FINISHED",t[t.CHANGE_ANCHOR=1]="CHANGE_ANCHOR",t[t.FADE_IN=2]="FADE_IN"})(hu||(hu={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.FADE_OUT=1]="FADE_OUT",t[t.SWITCH=2]="SWITCH",t[t.FADE_IN=3]="FADE_IN"}(Jn||(Jn={})),function(t){t[t.FINISHED=0]="FINISHED",t[t.HEIGHT_FADE=1]="HEIGHT_FADE"}(Y1||(Y1={}));let Hue=class{constructor(){this.anchorPointClouds=C(),this.cloudsHeight=1e5,this.radiusCurvatureCorrectionFactor=0,this.transform=xe()}},lg=class extends Ps{constructor(e,r){super(e,"bool",ai.Pass,(i,s,n)=>i.setUniform1b(e,r(s,n)))}},Lht=class extends Ps{constructor(e,r){super(e,"samplerCube",ai.Pass,(i,s,n)=>i.bindTexture(e,r(s,n)))}};function p3e(t){const e=t.fragment;e.uniforms.add(new es("rotationMatrixClouds",(r,i)=>i.cloudsFade.parallax.transform),new es("rotationMatrixCloudsCrossFade",(r,i)=>i.cloudsFade.parallaxNew.transform),new jt("anchorPosition",(r,i)=>i.cloudsFade.parallax.anchorPointClouds),new jt("anchorPositionCrossFade",(r,i)=>i.cloudsFade.parallaxNew.anchorPointClouds),new Ie("cloudsHeight",(r,i)=>i.cloudsFade.parallax.cloudsHeight),new Ie("radiusCurvatureCorrectionFactor",(r,i)=>i.cloudsFade.parallax.radiusCurvatureCorrectionFactor),new Ie("totalFadeInOut",(r,i)=>i.cloudsFade.fadeInOut.stage===Jn.FINISHED?i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeIn.factor:i.cloudsFade.fadeInOutHeight.factor+1-i.cloudsFade.fadeInOut.factor),new Ie("crossFadeAnchorFactor",(r,i)=>ye(i.cloudsFade.crossFade.factor,0,1)),new Lht("cubeMap",(r,i)=>i.cloudsFade.data?.cubeMap?i.cloudsFade.data.cubeMap.colorTexture:null),new lg("crossFade",(r,i)=>i.cloudsFade.crossFade.enabled),new lg("readChannelsRG",(r,i)=>i.cloudsFade.readChannels===zT.RG),new lg("fadeTextureChannels",(r,i)=>i.cloudsFade.renderingStage===tn.FADING_TEXTURE_CHANNELS)),e.constants.add("planetRadius","float",ur.radius),e.code.add(w`vec3 intersectWithCloudLayer(vec3 dir, vec3 cameraPosition, vec3 spherePos)
{
float radiusClouds = planetRadius + cloudsHeight;
float B = 2.0 * dot(cameraPosition, dir);
float C = dot(cameraPosition, cameraPosition) - radiusClouds * radiusClouds;
float det = B * B - 4.0 * C;
float pointIntDist = max(0.0, 0.5 *(-B + sqrt(det)));
vec3 intersectionPont = cameraPosition + dir * pointIntDist;
intersectionPont =  intersectionPont - spherePos;
return intersectionPont;
}`),e.code.add(w`vec3 correctForPlanetCurvature(vec3 dir)
{
dir.z = dir.z*(1.-radiusCurvatureCorrectionFactor) + radiusCurvatureCorrectionFactor;
return dir;
}`),e.code.add(w`vec3 rotateDirectionToAnchorPoint(mat4 rotMat, vec3 inVec)
{
return (rotMat * vec4(inVec, 0.0)).xyz;
}`),G0(e),Fg(e),e.code.add(w`const float SUNSET_TRANSITION_FACTOR = 0.3;
const vec3 RIM_COLOR = vec3(0.28, 0.175, 0.035);
const float RIM_SCATTERING_FACTOR = 140.0;
const float BACKLIGHT_FACTOR = 0.2;
const float BACKLIGHT_SCATTERING_FACTOR = 10.0;
const float BACKLIGHT_TRANSITION_FACTOR = 0.3;
vec3 calculateCloudColor(vec3 cameraPosition, vec3 worldSpaceRay, vec4 clouds)
{
float upDotLight = dot(normalize(cameraPosition), normalize(mainLightDirection));
float dirDotLight = max(dot(normalize(-worldSpaceRay), normalize(mainLightDirection)), 0.0);
float sunsetTransition = clamp(pow(max(upDotLight, 0.0), SUNSET_TRANSITION_FACTOR), 0.0, 1.0);
vec3 ambientLight = calculateAmbientIrradiance(normalize(cameraPosition),  0.0);
vec3 mainLight = evaluateMainLighting(normalize(cameraPosition),  0.0);
vec3 combinedLight = clamp((mainLightIntensity + ambientLight )/PI, vec3(0.0), vec3(1.0));
vec3 baseCloudColor = pow(combinedLight * pow(clouds.xyz, vec3(GAMMA)), vec3(INV_GAMMA));
float scatteringMod = max(clouds.a < 0.5 ? clouds.a / 0.5 : - clouds.a / 0.5 + 2.0, 0.0);
float rimLightIntensity = 0.5 + 0.5 *pow(max(upDotLight, 0.0), 0.35);
vec3 directSunScattering = RIM_COLOR * rimLightIntensity * (pow(dirDotLight, RIM_SCATTERING_FACTOR)) * scatteringMod;
float additionalLight = BACKLIGHT_FACTOR * pow(dirDotLight, BACKLIGHT_SCATTERING_FACTOR) * (1. - pow(sunsetTransition, BACKLIGHT_TRANSITION_FACTOR)) ;
return vec3(baseCloudColor * (1. + additionalLight) + directSunScattering);
}`),e.code.add(w`vec4 getCloudData(vec3 rayDir, bool readOtherChannel)
{
vec4 cloudData = texture(cubeMap, rayDir);
float mu = dot(rayDir, vec3(0, 0, 1));
bool readChannels = readChannelsRG ^^ readOtherChannel;
if (readChannels) {
cloudData = vec4(vec3(cloudData.r), cloudData.g);
} else {
cloudData = vec4(vec3(cloudData.b), cloudData.a);
}
if (length(cloudData) == 0.0) {
return vec4(cloudData.rgb, 1.0);
}
return cloudData;
}`),e.code.add(w`vec4 renderCloudsNoFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
float totalTransmittance = clamp(cloudData.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudData.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), totalTransmittance);
}`),e.code.add(w`vec4 renderCloudsCrossFade(vec3 worldRay, vec3 cameraPosition)
{
vec3 intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPosition);
vec3 worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixClouds, normalize(intersectionPoint));
vec3 worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
vec4 cloudData = getCloudData(worldRayRotatedCorrected, false);
vec4 cloudColor = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
intersectionPoint = intersectWithCloudLayer(normalize(worldRay), cameraPosition, anchorPositionCrossFade);
worldRayRotated = rotateDirectionToAnchorPoint(rotationMatrixCloudsCrossFade, normalize(intersectionPoint));
worldRayRotatedCorrected = correctForPlanetCurvature(worldRayRotated);
cloudData = getCloudData(worldRayRotatedCorrected, fadeTextureChannels);
vec4 cloudColorCrossFade = vec4(calculateCloudColor(cameraPosition, normalize(-worldRay), cloudData), cloudData.a);
cloudColor = mix(cloudColor, cloudColorCrossFade, crossFadeAnchorFactor);
float totalTransmittance = clamp(cloudColor.a * (1.0 - totalFadeInOut) + totalFadeInOut, 0.0 , 1.0);
if (length(cloudColor.rgb) == 0.0) {
totalTransmittance = 1.0;
}
return vec4(cloudColor.rgb, totalTransmittance);
}`),e.code.add(w`vec4 renderClouds(vec3 worldRay, vec3 cameraPosition)
{
return crossFade ? renderCloudsCrossFade(worldRay, cameraPosition) : renderCloudsNoFade(worldRay, cameraPosition);
}`)}function kg(t){t.code.add(w`vec4 premultiplyAlpha(vec4 v) {
return vec4(v.rgb * v.a, v.a);
}
vec3 rgb2hsv(vec3 c) {
vec4 K = vec4(0.0, -1.0 / 3.0, 2.0 / 3.0, -1.0);
vec4 p = c.g < c.b ? vec4(c.bg, K.wz) : vec4(c.gb, K.xy);
vec4 q = c.r < p.x ? vec4(p.xyw, c.r) : vec4(c.r, p.yzx);
float d = q.x - min(q.w, q.y);
float e = 1.0e-10;
return vec3(abs(q.z + (q.w - q.y) / (6.0 * d + e)), min(d / (q.x + e), 1.0), q.x);
}
vec3 hsv2rgb(vec3 c) {
vec4 K = vec4(1.0, 2.0 / 3.0, 1.0 / 3.0, 3.0);
vec3 p = abs(fract(c.xxx + K.xyz) * 6.0 - K.www);
return c.z * mix(K.xxx, clamp(p - K.xxx, 0.0, 1.0), c.y);
}
float rgb2v(vec3 c) {
return max(c.x, max(c.y, c.z));
}`)}function Dht(){const t=new Cr;t.attributes.add(E.POSITION,"vec2"),t.varyings.add("worldRay","vec3");const{vertex:e,fragment:r}=t;return e.uniforms.add(new es("inverseProjectionMatrix",(i,s)=>s.camera.inverseProjectionMatrix),new es("inverseViewMatrix",(i,s)=>mO(Nht,s.camera.viewMatrix))),e.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1.0, 1.0)).xyz;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0.0)).xyz;
gl_Position = vec4(position, 1.0, 1.0);
}`),r.include(kg),r.include(Pu),t.include(Gte,{pbrMode:lt.Disabled,lightingSphericalHarmonicsOrder:2}),t.include(S$),t.include(s8),t.include(dU),t.include(p3e,{instancedDoublePrecision:!1}),r.uniforms.add(new jt("cameraPosition",(i,s)=>s.camera.eye)),r.code.add(w`void main() {
vec4 cloudsColor = renderClouds(normalize(worldRay), cameraPosition);
fragColor = vec4((1.0 - totalFadeInOut) * cloudsColor.rgb, cloudsColor.a);
}`),t}const Nht=xe(),Fht=Object.freeze(Object.defineProperty({__proto__:null,build:Dht},Symbol.toStringTag,{value:"Module"}));let f3e=class m3e extends Ur{constructor(e){super(e,new nl,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,m3e.shader.get().build(),Er)}initializePipeline(){return It({blending:ca(Te.ONE,Te.ZERO,Te.SRC_ALPHA,Te.ONE),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};f3e.shader=new $r(Fht,()=>J(()=>import("./CloudsComposition.glsl-51b8f95b.js"),[],import.meta.url));let ix=class extends me{constructor(e){super(e),this._technique=new f3e(e),this._vao=Mc(e.rctx)}destroy(){this._technique=as(this._technique),this._vao=ze(this._vao)}render(e){const r=e.bindParameters.cloudsFade;if(this._vao==null||r.data==null)return;if(!this._technique.compiled)return void this.requestRender();const i=e.rctx.bindTechnique(this._technique,kht,e.bindParameters);e.rctx.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),e.rctx.drawArrays(Ot.TRIANGLE_STRIP,0,4)}};u([d({constructOnly:!0})],ix.prototype,"rctx",void 0),u([d({constructOnly:!0})],ix.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],ix.prototype,"planetRadius",void 0),u([d({constructOnly:!0})],ix.prototype,"requestRender",void 0),ix=u([R("esri.views.3d.environment.CloudsComposition")],ix);const kht=new ui;var yc;(function(t){t[t.SIXTEEN=0]="SIXTEEN",t[t.HUNDRED=1]="HUNDRED",t[t.TWOHUNDRED=2]="TWOHUNDRED",t[t.COUNT=3]="COUNT"})(yc||(yc={}));let Z4=class extends nl{constructor(){super(...arguments),this.steps=yc.SIXTEEN,this.writeTextureChannels=zT.RG}};u([B({count:yc.COUNT})],Z4.prototype,"steps",void 0),u([B({constValue:le("esri-mobile")?1024:2048})],Z4.prototype,"cubeMapSize",void 0),u([B()],Z4.prototype,"writeTextureChannels",void 0);let cM=class{constructor(e,r,i,s,n,o,a,l,c=.5){this.coverage=e,this.density=r,this.absorption=i,this.cloudSize=s,this.detailSize=n,this.smoothness=o,this.cloudHeight=a,this.raymarchingSteps=l,this.median=c}};const que=new cM([0,.6],[.03,.03],[0,0],[.9,.9],[.8,.8],[.7,.7],[.05,.05],yc.SIXTEEN),Ba={sunny:que,cloudy:new cM([.3,.65],[.2,.4],[0,0],[.85,.85],[.75,.75],[.3,.4],[1,1],yc.TWOHUNDRED,.6),rainy:new cM([.6,.8],[.5,.8],[.1,.5],[.9,.9],[.75,.75],[.5,.5],[1,1],yc.TWOHUNDRED,.4),snowy:new cM([.25,.75],[.3,.3],[0,0],[.95,.95],[.7,.7],[.69,.75],[.3,1],yc.HUNDRED,.65),foggy:new cM([.8,.8],[.5,.5],[0,0],[.95,.95],[.9,.9],[.55,.55],[.3,.3],yc.SIXTEEN),default:que},vd=le("esri-mobile")?64:128,Uht=vd/128,Wp=Math.ceil(Math.sqrt(vd)),R1=(vd+2)*Wp,Vht=1e5,eB=128,zht=R1/1560;function ep(t,e=!0){t.attributes.add(E.POSITION,"vec2"),e&&t.varyings.add("uv","vec2"),t.vertex.code.add(w`
    void main(void) {
      gl_Position = vec4(position, 0.0, 1.0);
      ${e?w`uv = position * 0.5 + vec2(0.5);`:""}
    }
  `)}let pP=class extends Ps{constructor(e,r){super(e,"mat3",ai.Draw,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}},g3e=class extends ui{constructor(){super(...arguments),this.cloudRadius=0,this.cloudSize=0,this.detailSize=0,this.absorption=0,this.density=0,this.smoothness=0,this.cloudHeight=0,this.coverage=0,this.raymarchingSteps=Ba.default.raymarchingSteps,this.weatherTile=Pe()}},y3e=class extends ui{constructor(){super(...arguments),this.viewMatrix=ts()}};function Bht(t){const e=new Cr;e.include(ep,!1);const r=e.fragment;return r.uniforms.add(new Ie("cloudRadius",i=>i.cloudRadius),new Ie("power",i=>Et(35,120,i.absorption)),new Ie("sigmaE",i=>1+i.absorption),new Ie("density",i=>Et(0,.3,i.density)),new Ie("cloudSize",i=>Et(0,.02,Math.max(.01,1-i.cloudSize))),new Ie("detailSize",i=>Et(0,.2,Math.max(.01,1-i.detailSize))),new Ie("smoothness",i=>Et(0,.5,1-i.smoothness)),new Ie("cloudHeight",i=>Et(0,1500,i.cloudHeight)),new Ie("coverage",i=>i.coverage),new pP("view",i=>i.viewMatrix),new et("cloudShapeTexture",i=>i.noiseTexture!=null?i.noiseTexture.textureAtlas:null),new Pr("cloudVariables",i=>hr(Ght,i.coverage,i.absorption))),r.constants.add("halfCubeMapSize","float",.5*t.cubeMapSize),r.code.add(w`
    const int STEPS = ${t.steps===yc.SIXTEEN?w`16`:t.steps===yc.HUNDRED?w`100`:w`200`};
    const int STEPS_LIGHT = 6;
    const float stepL = 300.0 / float(STEPS_LIGHT);
    const float cloudStart = 1500.0;

    vec3 rayDirection(vec2 fragCoord) {
      vec2 xy = fragCoord - halfCubeMapSize;
      return normalize(vec3(-xy, -halfCubeMapSize));
    }

    float remap(float x, float low1, float high1, float low2, float high2) {
      return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
    }

    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }`),r.code.add(w`
    float getCloudShape(vec3 pos, float pOffset) {
      const float textureWidth = ${w.float(R1)};
      const float dataWidth = ${w.float(R1)};
      const float tileRows = ${w.float(Wp)};
      const vec3 atlasDimensions = vec3(${w.float(vd)}, ${w.float(vd)}, tileRows * tileRows);

      //Change from Y being height to Z being height
      vec3 p = float(${w.float(Uht)}) * pos.xzy;

      //Pixel coordinates of point in the 3D data
      vec3 coord = vec3(mod(p - pOffset * atlasDimensions, atlasDimensions));
      float f = fract(coord.z);
      float level = floor(coord.z);
      float tileY = floor(level / tileRows);
      float tileX = level - tileY * tileRows;

      //The data coordinates are offset by the x and y tile, the two boundary cells between each tile pair and the initial boundary cell on the first row/column
      vec2 offset = atlasDimensions.x * vec2(tileX, tileY) + 2.0 * vec2(tileX, tileY) + 1.0;
      vec2 pixel = coord.xy + offset;
      vec2 data = texture(cloudShapeTexture, mod(pixel, dataWidth) / textureWidth).xy;

      return 1.0 - mix(data.x, data.y, f);
    }

    float getCloudMap(vec2 p){
      // Shift the texture center to origin to avoid seam artifacts
      vec2 uv = (${w.float(zht)} * p) / ${w.float(R1)} + 0.5;

      return texture(cloudShapeTexture, uv).a;
    }
    `),r.code.add(w`float clouds(vec3 p) {
float cloud = saturate(0.5 * mix(0.0, 1.0, min(2.0 * coverage, 1.0)));
if (cloud <= 0.0) {
return 0.0;
}
float cloudMap = getCloudMap(cloudSize * p.xy);
cloud = mix(cloud, min(2.0 * (coverage), 1.0) * cloudMap, min(2.0 * (1.0 - coverage), 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float shape = getCloudShape(8.0 * cloudSize * p, 0.0);
cloud = saturate(remap(cloud, smoothness * shape, 1.0, 0.0, 1.0));
if (cloud <= 0.0) {
return 0.0;
}
float heightFraction = saturate((length(p) - cloudRadius - cloudStart) / cloudHeight);
cloud *= saturate(remap(heightFraction, 0.0, 0.25, 0.0, 1.0)) * smoothstep(1.0, 0.25, heightFraction);
if (cloud <= 0.0) {
return 0.0;
}
return density * saturate(remap(cloud, 0.35 * smoothness * getCloudShape(detailSize * p, 0.0), 1.0, 0.0, 1.0));
}`),r.code.add(w`vec2 sphereIntersections(vec3 start, vec3 dir, float radius) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float c = dot(start, start) - (radius * radius);
float d = (b * b) - 4.0 * a * c;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}
float HenyeyGreenstein(float g, float costh) {
return (1.0 / (4.0 * 3.1415))  * ((1.0 - g * g) / pow(1.0 + g * g - 2.0 * g * costh, 1.5));
}`),r.code.add(`
    float multipleOctaves(float extinction, float mu, float stepL) {
      float attenuation = 1.0;
      float contribution = 1.0;
      float phaseAttenuation = 1.0;
      float luminance = 0.0;

      for (int i = 0; i < 4; i++) {
        float phase = mix(HenyeyGreenstein(0.0, mu), HenyeyGreenstein(0.3 * phaseAttenuation, mu), 0.7);
        luminance += contribution * phase * exp(-stepL * extinction * sigmaE * attenuation);
        attenuation *= 0.2;
        contribution *= 0.6;
        phaseAttenuation *= 0.5;
      }

      return luminance;
    }`),r.code.add(w`float lightRay(vec3 org, vec3 p, float phaseFunction, float mu, vec3 sunDirection) {
float lightRayDensity = clouds(p);
lightRayDensity += clouds(p + sunDirection * 1.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 2.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 3.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 4.0 * stepL);
lightRayDensity += clouds(p + sunDirection * 5.0 * stepL);
float beersLaw = multipleOctaves(lightRayDensity, mu, stepL);
return mix(beersLaw * 2.0 * (1.0 - (exp(-stepL * lightRayDensity * 2.0 * sigmaE ))), beersLaw, 0.5 + 0.5 * mu);
}`),r.code.add(w`float mainRay(vec3 org, vec3 dir, vec3 sunDirection, float distToStart, float totalDistance, out float totalTransmittance) {
if (dir.z < 0.0) {
return 0.0;
}
totalTransmittance = 1.0;
float stepS = totalDistance / float(STEPS);
float cameraHeight = length(org);
float mu = 0.5 + 0.5 * dot(sunDirection, dir);
float phaseFunction = mix(HenyeyGreenstein(-0.3, mu), HenyeyGreenstein(0.3, mu), 0.7);
vec3 p = org + distToStart  * dir;
float dist = distToStart;
float shading = 0.0;
for (int i = 0; i < STEPS; i++) {
float sampleDensity = clouds(p);
float sampleSigmaE = sampleDensity * sigmaE;
if (sampleDensity > 0.0 ) {
float ambient = mix((1.2), (1.6), saturate((length(p) - cloudRadius - cloudStart) / cloudHeight));
float luminance = sampleDensity * (ambient + power * phaseFunction * lightRay(org, p, phaseFunction, mu, sunDirection));
float transmittance = exp(-sampleSigmaE * stepS);
shading += totalTransmittance * (luminance - luminance * transmittance) / sampleSigmaE;
totalTransmittance *= transmittance;
if (totalTransmittance <= 0.001) {
totalTransmittance = 0.0;
break;
}
}
dist += stepS;
p = org + dir * dist;
}
return shading;
}`),r.code.add(w`void main() {
if (coverage ==  0.0) {
fragColor = vec4(0.0, 1.0, 0.0, 1.0);
return;
}
vec3 rayDir = rayDirection(gl_FragCoord.xy);
rayDir = normalize(view * rayDir);
vec3 viewPos = vec3(0, 0, cloudRadius + 1.0);
bool hitsPlanet = rayDir.z < 0.0;
float hazeFactor = smoothstep(-0.01, mix(0.0, 0.075, cloudVariables.x), abs(dot(rayDir, vec3(0, 0, 1))));
float totalTransmittance = 1.0;
float shading = 0.0;
if (hitsPlanet) {
shading = clamp(1.0 - cloudVariables.y, 0.6, 1.0) * (1.0 - hazeFactor);
totalTransmittance = hazeFactor;
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
return;
}
vec2 rayStartIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart);
vec2 rayEndIntersect = sphereIntersections(viewPos, rayDir, cloudRadius + cloudStart + cloudHeight);
float distToStart = rayStartIntersect.y;
float totalDistance = rayEndIntersect.y - distToStart;
vec3 sunDirection = normalize(vec3(0, 0, 1));
shading = 0.5 * mainRay(viewPos, rayDir, sunDirection, distToStart, totalDistance, totalTransmittance);
shading = mix(clamp(1.0 - cloudVariables.y, 0.6, 1.0), shading, hazeFactor);
totalTransmittance = mix(0.0, totalTransmittance, hazeFactor);
fragColor = vec4(shading, totalTransmittance, shading, totalTransmittance);
}`),e}const Ght=Pe(),jht=Object.freeze(Object.defineProperty({__proto__:null,CloudsDrawParameters:y3e,CloudsPassParameters:g3e,build:Bht},Symbol.toStringTag,{value:"Module"}));let _3e=class v3e extends Ur{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,v3e.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:Ru(Te.CONSTANT_COLOR,Te.ONE_MINUS_CONSTANT_COLOR,Eg.ADD,this.configuration.writeTextureChannels===zT.RG?[1,1,0,0]:[0,0,1,1]),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};_3e.shader=new $r(jht,()=>J(()=>import("./Clouds.glsl-b4374cd6.js"),[],import.meta.url));var dh;(function(t){t[t.Full=0]="Full",t[t.WeatherMap=1]="WeatherMap",t[t.COUNT=2]="COUNT"})(dh||(dh={}));let lX=class extends nl{constructor(){super(...arguments),this.mode=dh.Full}};u([B({count:dh.COUNT})],lX.prototype,"mode",void 0);let b3e=class extends ui{constructor(){super(...arguments),this.weatherTile=yr(0,0)}};function Hht(t){const e=new Cr;return e.include(ep,!1),e.fragment.code.add(w`float remap(float x, float low1, float high1, float low2, float high2) {
return low2 + (x - low1) * (high2 - low2) / (high1 - low1);
}`),t.mode===dh.Full&&e.fragment.code.add(w`
    float saturate(float x) {
      return clamp(x, 0.0, 1.0);
    }

    // Safer modulo for positive and negative values
    vec3 modulo(vec3 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec3 hash(vec3 p3, float frequency){
      p3 = modulo(p3, frequency);
      p3 = fract(p3 * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yxz + 33.33);
      return -1.0 + 2.0 * fract((p3.xxy + p3.yxx) * p3.zyx);
    }

    // 5th order polynomial interpolation
    vec3 fade(vec3 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec3 p, float frequency){
      // Cell point is in
      vec3 i = floor(p);

      // Position in the cell in [0, 1]
      vec3 f = fract(p);

      // Interpolation value for gradient mixing
      vec3 u = fade(f);

      // Trilinear interpolation of gradients at cube vertices around point
      return mix( mix( mix( dot( hash( i + vec3(0.0,0.0,0.0), frequency), f - vec3(0.0,0.0,0.0) ),
                            dot( hash( i + vec3(1.0,0.0,0.0), frequency), f - vec3(1.0,0.0,0.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,0.0), frequency), f - vec3(0.0,1.0,0.0) ),
                            dot( hash( i + vec3(1.0,1.0,0.0), frequency), f - vec3(1.0,1.0,0.0) ), u.x), u.y),
                  mix( mix( dot( hash( i + vec3(0.0,0.0,1.0), frequency), f - vec3(0.0,0.0,1.0) ),
                            dot( hash( i + vec3(1.0,0.0,1.0), frequency), f - vec3(1.0,0.0,1.0) ), u.x),
                       mix( dot( hash( i + vec3(0.0,1.0,1.0), frequency), f - vec3(0.0,1.0,1.0) ),
                            dot( hash( i + vec3(1.0,1.0,1.0), frequency), f - vec3(1.0,1.0,1.0) ), u.x), u.y), u.z );
    }

    float getPerlinNoise(vec3 pos, float frequency) {
      float octaveFrequencyFactor = 2.0;
      float sum = 0.0;
      float weightSum = 0.0;
      float weight = 1.0;

      for (int oct = 0; oct < 3; oct++) {
        vec3 p = pos * frequency;
        float val = 0.5 + 0.5 * gradientNoise(p, frequency);
        sum += val * weight;
        weightSum += weight;
        weight *= 0.5;
        frequency *= octaveFrequencyFactor;
      }

      float noise = (sum / weightSum);
      noise = saturate(noise);
      return noise;
    }

    float worley(vec3 pos, float numCells) {
      vec3 p = pos * numCells;
      float d = 1.0e10;

      for (int x = -1; x <= 1; x++) {
        for (int y = -1; y <= 1; y++) {
          for (int z = -1; z <= 1; z++) {
            vec3 tp = floor(p) + vec3(x, y, z);
            tp = p - tp - (hash(tp, numCells) * 0.5 + 0.5);
            d = min(d, dot(tp, tp));
          }
        }
      }

      return 1.0 - clamp(d, 0.0, 1.0);
    }

    vec3 get3Dfrom2D(vec2 uv) {
      vec2 tile = floor(uv);
      float z = floor(${w.float(Wp)} * tile.y + tile.x);
      return vec3(fract(uv), z);
    }

    float getTextureForPointPerlinWorley(vec3 p) {
      float perlinNoise = getPerlinNoise(p, ${w.float(8)});

      float worley0 = worley(p, ${w.float(2)} * 2.0);
      float worley1 = worley(p, ${w.float(2)} * 8.0);
      float worley2 = worley(p, ${w.float(2)} * 14.0);

      float worleyFBM = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      return remap(perlinNoise, 0.0, 1.0, worleyFBM, 1.0);
    }

    float getTextureForPointWorley(vec3 p) {
      float worley0 = worley(p, ${w.float(2)});
      float worley1 = worley(p, ${w.float(2)} * 2.0);
      float worley2 = worley(p, ${w.float(2)} * 4.0);
      float worley3 = worley(p, ${w.float(2)} * 8.0);

      float FBM0 = worley0 * 0.625 + worley1 * 0.25 + worley2 * 0.125;
      float FBM1 = worley1 * 0.625 + worley2 * 0.25 + worley3 * 0.125;
      float FBM2 = worley2 * 0.75 + worley3 * 0.25;

      return FBM0 * 0.625 + FBM1 * 0.25 + FBM2 * 0.125;
    }
  `),e.fragment.uniforms.add(new Pr("weatherTile",r=>r.weatherTile)),e.fragment.code.add(w`
    vec2 modulo(vec2 m, float n){
      return mod(mod(m, n) + n, n);
    }

    vec2 hash(vec2 p){
      // Get position of p in weather tile
      p = modulo(p, ${w.float(eB)});

      // Get global coordinates of p
      p += weatherTile * ${w.float(eB)};

      // Limit position to avoid numerical instability
      p = modulo(p, ${w.float(Vht)});

      vec3 p3 = fract(vec3(p.xyx) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return 2.0 * fract((p3.xx + p3.yz) * p3.zy) - 1.0;
    }

    vec2 fade(vec2 t){
      return (t * t * t) * (t * (t * 6.0 - 15.0) + 10.0);
    }

    float gradientNoise(vec2 p){
      vec2 i = floor( p );
      vec2 f = fract( p );

      vec2 u = fade(f);

      // Bilinear interpolation of gradients at cell vertices around point
      return  mix(
                mix(dot( hash( i + vec2(0.0,0.0) ), f - vec2(0.0,0.0) ),
                    dot( hash( i + vec2(1.0,0.0) ), f - vec2(1.0,0.0) ), u.x),
                mix(dot( hash( i + vec2(0.0,1.0) ), f - vec2(0.0,1.0) ),
                    dot( hash( i + vec2(1.0,1.0) ), f - vec2(1.0,1.0) ), u.x),
                u.y);
    }

    float worley(vec2 p){
      float d = 1.0e10;
      for (int x = -1; x <= 1; x++){
        for (int y = -1; y <= 1; y++){
                vec2 tp = floor(p) + vec2(x, y);
                tp = p - tp - (0.5 + 0.5 * hash(tp));
                d = min(d, dot(tp, tp));
            }
        }
      return 1.0 - clamp(d, 0.0, 1.0);
    }
  `),e.fragment.code.add(w`void main() {`),t.mode===dh.Full&&e.fragment.code.add(w`
        float padWidth = 1.0;
        float paddedSize = ${w.float(vd)} + 2.0 * padWidth;
        float tileCount = ${w.float(Wp)} * ${w.float(Wp)};
        vec2 tile = floor((gl_FragCoord.xy - 0.5) / paddedSize);

        bool padCell = false;
        if (mod(gl_FragCoord.x, paddedSize) == 0.5 || mod(gl_FragCoord.x, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        if (mod(gl_FragCoord.y, paddedSize) == 0.5 || mod(gl_FragCoord.y, paddedSize) == paddedSize - 0.5) {
          padCell = true;
        }

        bool startPadX = false;
        bool startPadY = false;
        bool endPadX = false;
        bool endPadY = false;

        if (gl_FragCoord.x == tile.x * paddedSize + 0.5) {
          startPadX = true;
        }

        if (gl_FragCoord.y == tile.y * paddedSize + 0.5) {
          startPadY = true;
        }

        if (gl_FragCoord.x == (tile.x + 1.0) * paddedSize - 0.5) {
          endPadX = true;
        }

        if (gl_FragCoord.y == (tile.y + 1.0) * paddedSize - 0.5) {
          endPadY = true;
        }

        vec2 padding = vec2(2.0 * padWidth) * tile;
        vec2 uv;

        if (padCell) {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;

          if (startPadX) {
            pixel.x += ${w.float(vd)};
          }

          if (startPadY) {
            pixel.y += ${w.float(vd)};
          }

          if (endPadX) {
            pixel.x -= ${w.float(vd)};
          }

          if (endPadY) {
            pixel.y -= ${w.float(vd)};
          }

          uv = vec2(pixel.xy / ${w.float(vd)});
        } else {
          vec2 pixel = gl_FragCoord.xy - padWidth - padding;
          uv = vec2(pixel.xy / ${w.float(vd)});
        }

        vec3 p_ = get3Dfrom2D(uv);
        vec3 p = p_;
        p.z /= (${w.float(Wp)} * ${w.float(Wp)});

        float worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        float worleyNoise = getTextureForPointWorley(p);

        fragColor.r = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));

        p_ = mod(p_ + 1.0, ${w.float(Wp)} * ${w.float(Wp)});
        p = p_;
        p.z /= (${w.float(Wp)} * ${w.float(Wp)});

        worleyPerlinNoise = getTextureForPointPerlinWorley(p);
        worleyNoise = getTextureForPointWorley(p);

        fragColor.g = saturate(remap(worleyPerlinNoise, worleyNoise, 1.0, 0.0, 1.0));
      `),e.fragment.code.add(w`
      vec2 mapUV = ${w.float(eB)} * (gl_FragCoord.xy / ${w.float(R1)});
      float map = abs(gradientNoise(mapUV));
      map = remap(map, 0.25 * (1.0 - worley(8.0 * mapUV)), 1.0, 0.0, 1.0);

      ${t.mode===dh.Full?w`fragColor.ba = vec2(0.0, map);`:w`fragColor = vec4(map);`};
    }
  `),e}const qht=Object.freeze(Object.defineProperty({__proto__:null,NoiseTextureAtlasPassParameters:b3e,build:Hht},Symbol.toStringTag,{value:"Module"}));let cX=class w3e extends Ur{initializeProgram(e){return new Lr(e.rctx,w3e.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:this.configuration.mode===dh.Full?Ru(Te.ONE,Te.ZERO):ca(Te.ZERO,Te.ONE,Te.ONE,Te.ZERO),depthTest:{func:ci.ALWAYS},colorWrite:Wt})}};cX.shader=new $r(qht,()=>J(()=>import("./NoiseTextureAtlas.glsl-9bd3acba.js"),[],import.meta.url));let mU=class{constructor(e,r,i=r){this.internalFormat=e,this.width=r,this.height=i,this.multisampled=!1,this.samples=1}};function Wht(t){return t.width<=0||t.height<=0||t.internalFormat==null?0:t.width*t.height*Ute(t.internalFormat)}let Zht=class{constructor(e,r){this._context=e,this._descriptor=r,this.type=X1.RenderBuffer,this._context.instanceCounter.increment(io.Renderbuffer,this);const i=this._context.gl;this.glName=i.createRenderbuffer(),this._context.bindRenderbuffer(this);const{width:s,height:n,internalFormat:o,multisampled:a}=r;if(a){if(this._context.type!==pr.WEBGL2)throw new Error("Multisampled renderbuffers are not supported in WebGL1!");i.renderbufferStorageMultisample(i.RENDERBUFFER,this.samples,o,s,n)}else i.renderbufferStorage(i.RENDERBUFFER,o,s,n)}get descriptor(){return this._descriptor}get samples(){const e=this._descriptor.samples,r=this._context.parameters.maxSamples;return e?Math.min(e,r):r}get gpuMemoryUsage(){return Wht(this._descriptor)}resize(e,r){const i=this._descriptor;if(i.width===e&&i.height===r)return;i.width=e,i.height=r;const s=this._context.gl;this._context.bindRenderbuffer(this),i.multisampled?s.renderbufferStorageMultisample(s.RENDERBUFFER,this.samples,i.internalFormat,i.width,i.height):s.renderbufferStorage(s.RENDERBUFFER,i.internalFormat,i.width,i.height)}dispose(){this._context&&(this._context.gl.deleteRenderbuffer(this.glName),this._context.instanceCounter.decrement(io.Renderbuffer,this),this._context=tO(this._context))}};const Xht=K.getLogger("esri.views.webgl.FramebufferObject");let Vn=class CE{constructor(e,r,i=null){this._context=e,this._glName=null,this._colorAttachments=new Map,this._depthBuffer=null,this._stencilBuffer=null,this._depthStencilTexture=null,this._initialized=!1,e.instanceCounter.increment(io.FramebufferObject,this);const s=X4(r)?r:new Rt(this._context,r);if(this._colorAttachments.set(eh.COLOR_ATTACHMENT0,s),this._validateTextureDescriptor(s.descriptor),this._validateColorAttachmentPoint(eh.COLOR_ATTACHMENT0),i!=null)if(Jht(i))this._context.capabilities.depthTexture||console.error("Setting the depth/stencil texture as an attachment requires WEBGL_depth_texture or WebGL2"),this._depthStencilTexture=X4(i)?i:new Rt(this._context,i),this._validateTextureDescriptor(this._depthStencilTexture.descriptor);else{const n=Yht(i)?i:new Zht(this._context,i),o=n.descriptor;o.internalFormat===bn.STENCIL_INDEX8?this._stencilBuffer=n:this._depthBuffer=n,this._validateRenderBufferDescriptor(o)}}dispose(){if(this._colorAttachments.size===0&&!this._glName)return;const e=this._context.getBoundFramebufferObject();this._colorAttachments.forEach((r,i)=>this.detachColorTexture(i)?.dispose()),this.detachDepthStencilBuffer()?.dispose(),this.detachDepthStencilTexture()?.dispose(),this._glName&&(this._context.gl.deleteFramebuffer(this._glName),this._glName=null),this._context.bindFramebuffer(e),this._context.instanceCounter.decrement(io.FramebufferObject,this)}get glName(){return this._glName}get colorTexture(){return this._colorAttachments.get(eh.COLOR_ATTACHMENT0)}get depthStencilAttachment(){return this._depthStencilTexture||this._depthBuffer||this._stencilBuffer}get depthStencilTexture(){return this._depthStencilTexture}get width(){return this._colorAttachments.get(eh.COLOR_ATTACHMENT0)?.descriptor?.width??0}get height(){return this._colorAttachments.get(eh.COLOR_ATTACHMENT0)?.descriptor?.height??0}get gpuMemoryUsage(){return[...this._colorAttachments].reduce((e,[r,i])=>e+i.gpuMemoryUsage,this.depthStencilAttachment?.gpuMemoryUsage??0)}getColorTexture(e){const r=this._colorAttachments.get(e);return r&&X4(r)?r:null}attachColorTexture(e,r=eh.COLOR_ATTACHMENT0){if(!e)return;this._validateColorAttachmentPoint(r);const i=e.descriptor;this._validateTextureDescriptor(i),this.detachColorTexture(r)?.dispose(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,r)),this._colorAttachments.set(r,e)}detachColorTexture(e=eh.COLOR_ATTACHMENT0){const r=this._colorAttachments.get(e);if(r)return this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e)),this._colorAttachments.delete(e),r}setColorTextureTarget(e,r=eh.COLOR_ATTACHMENT0){const i=this._colorAttachments.get(r);i&&this._framebufferTexture2D(i.glName,r,e)}attachDepthStencil(e){if(e)switch(e.type){case X1.Texture:return this._attachDepthStencilTexture(e);case X1.RenderBuffer:return this._attachDepthStencilBuffer(e)}}_attachDepthStencilTexture(e){if(e==null)return;const r=e.descriptor;r.pixelFormat!==At.DEPTH_STENCIL&&r.pixelFormat!==At.DEPTH24_STENCIL8&&console.error("Depth/Stencil texture must have a pixel type of DEPTH_STENCIL!"),r.dataType!==fn.UNSIGNED_INT_24_8&&console.error("Depth/Stencil texture must have data type of UNSIGNED_INT_24_8!"),this._context.capabilities.depthTexture||console.error("Extension WEBGL_depth_texture isn't supported therefore it is no possible to set the depth/stencil texture!"),this._validateTextureDescriptor(r),this._disposeDepthStencilAttachments(),this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(e.glName,$ue)),this._depthStencilTexture?.dispose(),this._depthStencilTexture=e}detachDepthStencilTexture(){const e=this._depthStencilTexture;return e&&this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,$ue)),this._depthStencilTexture=null,e}_attachDepthStencilBuffer(e){if(e==null)return;const r=e.descriptor;if(r.internalFormat!==bn.DEPTH_STENCIL&&r.internalFormat!==bn.DEPTH_COMPONENT16&&console.error("Depth/Stencil buffer must have correct internalFormat"),this._validateRenderBufferDescriptor(r),this._disposeDepthStencilAttachments(),this._initialized){this._context.bindFramebuffer(this);const i=this._context.gl,s=this._getGLAttachmentPoint(r);i.framebufferRenderbuffer(ea.FRAMEBUFFER,s,i.RENDERBUFFER,e.glName)}this._depthBuffer?.dispose(),this._depthBuffer=e}detachDepthStencilBuffer(){const e=this._depthBuffer;if(e&&this._initialized){this._context.bindFramebuffer(this);const r=this._context.gl,i=this._getGLAttachmentPoint(e.descriptor);r.framebufferRenderbuffer(ea.FRAMEBUFFER,i,r.RENDERBUFFER,null),e.dispose()}return this._depthBuffer=null,e}copyToTexture(e,r,i,s,n,o,a){(e<0||r<0||n<0||o<0)&&console.error("Offsets cannot be negative!"),(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!");const l=a.descriptor;a.descriptor.target!==Rs.TEXTURE_2D&&console.error("Texture target must be TEXTURE_2D!"),(l?.width==null||l?.height==null||e+i>this.width||r+s>this.height||n+i>l.width||o+s>l.height)&&console.error("Bad dimensions, the current input values will attempt to read or copy out of bounds!");const c=this._context,h=c.bindTexture(a,Rt.TEXTURE_UNIT_FOR_UPDATES);c.setActiveTexture(Rt.TEXTURE_UNIT_FOR_UPDATES),c.bindFramebuffer(this),c.gl.copyTexSubImage2D(Rs.TEXTURE_2D,0,n,o,e,r,i,s),c.bindTexture(h,Rt.TEXTURE_UNIT_FOR_UPDATES)}readPixels(e,r,i,s,n,o,a){(i<=0||s<=0)&&console.error("Copy width and height must be greater than zero!"),a||console.error("Target memory is not initialized!"),this._context.bindFramebuffer(this),this._context.gl.readPixels(e,r,i,s,n,o,a)}async readPixelsAsync(e,r,i,s,n,o,a){if(this._context.type!==pr.WEBGL2)return fd()&&console.warn("Attempting to read pixels using pixel buffer object without WebGL2"),void this.readPixels(e,r,i,s,n,o,a);const l=this._context.gl,c=Gr.createPixelPack(this._context,Mr.STREAM_READ,a.byteLength);this._context.bindBuffer(c),this._context.bindFramebuffer(this),l.readPixels(e,r,i,s,n,o,0),this._context.unbindBuffer(St.PIXEL_PACK_BUFFER),await c.getSubDataAsync(a),c.dispose()}resize(e,r){if(this.width===e&&this.height===r)return;const i={width:e,height:r};Zx(i,this._context.parameters.maxTextureSize),this._colorAttachments.forEach(s=>s.resize(i.width,i.height)),this._depthStencilTexture?.resize(i.width,i.height),this._initialized&&(Zx(i,this._context.parameters.maxRenderbufferSize),this._depthBuffer?.resize(i.width,i.height),this._stencilBuffer?.resize(i.width,i.height),this._context.getBoundFramebufferObject()===this&&this._context.bindFramebuffer(null),this._initialized=!1)}initializeAndBind(e=ea.FRAMEBUFFER){const r=this._context.gl;if(this._initialized)return void r.bindFramebuffer(e,this.glName);this._glName&&r.deleteFramebuffer(this._glName);const i=r.createFramebuffer();r.bindFramebuffer(e,i),this._colorAttachments.forEach((n,o)=>this._framebufferTexture2D(n.glName,o,Wue(n),e));const s=this._depthBuffer||this._stencilBuffer;if(s){const n=this._getGLAttachmentPoint(s.descriptor);r.framebufferRenderbuffer(e,n,r.RENDERBUFFER,s.glName)}else this._depthStencilTexture&&this._framebufferTexture2D(this._depthStencilTexture.glName,r.DEPTH_STENCIL_ATTACHMENT,Wue(this._depthStencilTexture),e);fd()&&r.checkFramebufferStatus(e)!==r.FRAMEBUFFER_COMPLETE&&console.error("Framebuffer is incomplete!"),this._glName=i,this._initialized=!0}_framebufferTexture2D(e,r=eh.COLOR_ATTACHMENT0,i=Rs.TEXTURE_2D,s=ea.FRAMEBUFFER,n=0){this._context.gl.framebufferTexture2D(s,r,i,e,n)}_disposeDepthStencilAttachments(){const e=this._context.gl;if(this._depthBuffer){if(this._initialized){this._context.bindFramebuffer(this);const r=this._getGLAttachmentPoint(this._depthBuffer.descriptor);e.framebufferRenderbuffer(ea.FRAMEBUFFER,r,e.RENDERBUFFER,null)}this._depthBuffer=ze(this._depthBuffer)}this._stencilBuffer&&(this._initialized&&(this._context.bindFramebuffer(this),e.framebufferRenderbuffer(ea.FRAMEBUFFER,e.STENCIL_ATTACHMENT,e.RENDERBUFFER,null)),this._stencilBuffer=ze(this._stencilBuffer)),this._depthStencilTexture&&(this._initialized&&(this._context.bindFramebuffer(this),this._framebufferTexture2D(null,e.DEPTH_STENCIL_ATTACHMENT)),this._depthStencilTexture=ze(this._depthStencilTexture))}_validateTextureDescriptor(e){e.target!==Rs.TEXTURE_2D&&e.target!==Rs.TEXTURE_CUBE_MAP&&console.error("Texture type must be TEXTURE_2D or TEXTURE_CUBE_MAP!"),Zx(e,this._context.parameters.maxTextureSize),this._validateBufferDimensions(e)}_validateRenderBufferDescriptor(e){Zx(e,this._context.parameters.maxRenderbufferSize),this._validateBufferDimensions(e)}_validateBufferDimensions(e){e.width<=0&&(e.width=this.width),e.height<=0&&(e.height=this.height),this.width>0&&this.height>0&&(this.width===e.width&&this.height===e.height||console.error("Attachment size must match framebuffer size!"))}_getGLAttachmentPoint(e){switch(e.internalFormat){case bn.DEPTH_COMPONENT16:case bn.DEPTH_COMPONENT24:case bn.DEPTH_COMPONENT32F:return this._context.gl.DEPTH_ATTACHMENT;case bn.DEPTH24_STENCIL8:case bn.DEPTH32F_STENCIL8:case bn.DEPTH_STENCIL:return this._context.gl.DEPTH_STENCIL_ATTACHMENT;case bn.STENCIL_INDEX8:return this._context.gl.STENCIL_ATTACHMENT}}_validateColorAttachmentPoint(e){if(CE._MAX_COLOR_ATTACHMENTS===-1){const i=this._context.capabilities.drawBuffers;if(i){const s=this._context.gl;CE._MAX_COLOR_ATTACHMENTS=s.getParameter(i.MAX_COLOR_ATTACHMENTS)}else CE._MAX_COLOR_ATTACHMENTS=1}const r=e-eh.COLOR_ATTACHMENT0;r+1>CE._MAX_COLOR_ATTACHMENTS&&K.getLogger("esri.views.webgl.FrameBufferObject").error("esri.FrameBufferObject",`illegal attachment point for color attachment: ${r+1}. Implementation supports up to ${CE._MAX_COLOR_ATTACHMENTS} color attachments`)}};function X4(t){return t!=null&&"type"in t&&t.type===X1.Texture}function Yht(t){return t!=null&&"type"in t&&t.type===X1.RenderBuffer}function Jht(t){return X4(t)||t!=null&&"pixelFormat"in t}function Zx(t,e){const r=Math.max(t.width,t.height);if(r>e){Xht.warn(`Resizing FBO attachment size ${t.width}x${t.height} to device limit ${e}`);const i=e/r;return t.width=Math.round(t.width*i),t.height=Math.round(t.height*i),!1}return!0}function Wue(t){return t.descriptor.target===Rs.TEXTURE_CUBE_MAP?Rs.TEXTURE_CUBE_MAP_POSITIVE_X:Rs.TEXTURE_2D}Vn._MAX_COLOR_ATTACHMENTS=-1;let uM=class extends me{constructor(e){super(e),this._needsRender=!0,this._passParameters=new b3e,this._frameBuffer=new Vn(e.context.renderContext.rctx,new Sr(R1)),this._vao=Mc(e.context.renderContext.rctx)}get _techniqueRepository(){return this.context.techniqueRepository}get textureAtlas(){return this._texture!=null?this._weatherMapTechnique!=null&&this._weatherMapTechnique.compiled&&this._needsRender&&(this._texture=this._render(dh.WeatherMap)):this._fullTechnique!=null&&this._fullTechnique.compiled&&(this._texture=this._render(dh.Full)),this._texture}_setDirty(){this._needsRender=!0}updateWeatherMap(e){this._passParameters.weatherTile[0]===e[0]&&this._passParameters.weatherTile[1]===e[1]||(jn(this._passParameters.weatherTile,e),this._setDirty())}destroy(){this._fullTechniqueCached=as(this._fullTechniqueCached),this._weatherMapTechniqueCached=as(this._weatherMapTechniqueCached),this._frameBuffer=ze(this._frameBuffer),this._vao=ze(this._vao)}get _fullTechnique(){if(this._fullTechniqueCached==null){const e=new lX;e.mode=dh.Full,this._fullTechniqueCached=this._techniqueRepository.acquire(cX,e)}return this._fullTechniqueCached}get _weatherMapTechnique(){if(this._weatherMapTechniqueCached==null){const e=new lX;e.mode=dh.WeatherMap,this._weatherMapTechniqueCached=this._techniqueRepository.acquire(cX,e)}return this._weatherMapTechniqueCached}_render(e){if(this._vao==null||this._frameBuffer==null)return null;const r=e===dh.Full?this._fullTechnique:this._weatherMapTechnique,i=this.context.renderContext.rctx,s=i.getViewport();i.setViewport(0,0,R1,R1),i.bindFramebuffer(this._frameBuffer);const n=i.bindTechnique(r,this._passParameters,null);return i.bindVAO(this._vao),n.assertCompatibleVertexAttributeLocations(this._vao),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.setViewport(s.x,s.y,s.width,s.height),this._needsRender=!1,this._frameBuffer.colorTexture}};u([d({constructOnly:!0})],uM.prototype,"context",void 0),u([d({readOnly:!0})],uM.prototype,"_techniqueRepository",null),uM=u([R("esri.views.3d.environment.NoiseTextureAtlas")],uM);function x3e(t){t.include(Ch),t.uniforms.add(new et("geometryDepthTexture",(e,r)=>r.multipassGeometry.linearDepthTexture),new Pr("nearFar",(e,r)=>r.camera.nearFar)),t.code.add(w`bool geometryDepthTest(vec2 pos, float elementDepth) {
float geometryDepth = linearDepthFromTexture(geometryDepthTexture, pos, nearFar);
return (elementDepth < (geometryDepth - 1.0));
}`)}let Qht=class{constructor(){this.enabled=!1}};function Ah(t,e){e.hasMultipassTerrain&&(t.fragment.include(Ch),t.fragment.uniforms.add(new et("terrainDepthTexture",(r,i)=>i.multipassTerrain.linearDepthTexture)),t.fragment.uniforms.add(new Pr("nearFar",(r,i)=>i.camera.nearFar)),t.fragment.uniforms.add(new Pr("inverseViewport",(r,i)=>i.inverseViewport)),t.fragment.code.add(w`
    void terrainDepthTest(vec4 fragCoord, float fragmentDepth){
      float terrainDepth = linearDepthFromTexture(terrainDepthTexture, fragCoord.xy * inverseViewport, nearFar);
      if(fragmentDepth ${e.cullAboveGround?">":"<="} terrainDepth){
        discard;
      }
    }
  `))}let Kht=class{constructor(){this.enabled=!1,this.cullAboveGround=!1}};function edt(t,e){const r=t.fragment;r.include(Ch),r.uniforms.add(new Pr("nearFar",(i,s)=>s.camera.nearFar)),r.uniforms.add(new et("depthMap",(i,s)=>s.linearDepthTexture)),r.uniforms.add(new es("proj",(i,s)=>s.ssr.camera.projectionMatrix)),r.uniforms.add(new Ie("invResolutionHeight",(i,s)=>1/s.ssr.camera.height)),r.uniforms.add(new es("reprojectionMatrix",(i,s)=>s.ssr.reprojectionMatrix)),r.code.add(w`
  vec2 reprojectionCoordinate(vec3 projectionCoordinate)
  {
    vec4 zw = proj * vec4(0.0, 0.0, -projectionCoordinate.z, 1.0);
    vec4 reprojectedCoord = reprojectionMatrix * vec4(zw.w * (projectionCoordinate.xy * 2.0 - 1.0), zw.z, zw.w);
    reprojectedCoord.xy /= reprojectedCoord.w;
    return reprojectedCoord.xy * 0.5 + 0.5;
  }

  const int maxSteps = ${e.highStepCount?"150":"75"};

  vec4 applyProjectionMat(mat4 projectionMat, vec3 x)
  {
    vec4 projectedCoord =  projectionMat * vec4(x, 1.0);
    projectedCoord.xy /= projectedCoord.w;
    projectedCoord.xy = projectedCoord.xy*0.5 + 0.5;
    return projectedCoord;
  }

  vec3 screenSpaceIntersection(vec3 dir, vec3 startPosition, vec3 viewDir, vec3 normal)
  {
    vec3 viewPos = startPosition;
    vec3 viewPosEnd = startPosition;

    // Project the start position to the screen
    vec4 projectedCoordStart = applyProjectionMat(proj, viewPos);
    vec3  Q0 = viewPos / projectedCoordStart.w; // homogeneous camera space
    float k0 = 1.0/ projectedCoordStart.w;

    // advance the position in the direction of the reflection
    viewPos += dir;

    vec4 projectedCoordVanishingPoint = applyProjectionMat(proj, dir);

    // Project the advanced position to the screen
    vec4 projectedCoordEnd = applyProjectionMat(proj, viewPos);
    vec3  Q1 = viewPos / projectedCoordEnd.w; // homogeneous camera space
    float k1 = 1.0/ projectedCoordEnd.w;

    // calculate the reflection direction in the screen space
    vec2 projectedCoordDir = (projectedCoordEnd.xy - projectedCoordStart.xy);
    vec2 projectedCoordDistVanishingPoint = (projectedCoordVanishingPoint.xy - projectedCoordStart.xy);

    float yMod = min(abs(projectedCoordDistVanishingPoint.y), 1.0);

    float projectedCoordDirLength = length(projectedCoordDir);
    float maxSt = float(maxSteps);

    // normalize the projection direction depending on maximum steps
    // this determines how blocky the reflection looks
    vec2 dP = yMod * (projectedCoordDir)/(maxSt * projectedCoordDirLength);

    // Normalize the homogeneous camera space coordinates
    vec3  dQ = yMod * (Q1 - Q0)/(maxSt * projectedCoordDirLength);
    float dk = yMod * (k1 - k0)/(maxSt * projectedCoordDirLength);

    // initialize the variables for ray marching
    vec2 P = projectedCoordStart.xy;
    vec3 Q = Q0;
    float k = k0;
    float rayStartZ = -startPosition.z; // estimated ray start depth value
    float rayEndZ = -startPosition.z;   // estimated ray end depth value
    float prevEstimateZ = -startPosition.z;
    float rayDiffZ = 0.0;
    float dDepth;
    float depth;
    float rayDiffZOld = 0.0;

    // early outs
    if (dot(normal, dir) < 0.0 || dot(-viewDir, normal) < 0.0)
      return vec3(P, 0.0);

    for(int i = 0; i < maxSteps-1; i++)
    {
      depth = -linearDepthFromTexture(depthMap, P, nearFar); // get linear depth from the depth buffer

      // estimate depth of the marching ray
      rayStartZ = prevEstimateZ;
      dDepth = -rayStartZ - depth;
      rayEndZ = (dQ.z * 0.5 + Q.z)/ ((dk * 0.5 + k));
      rayDiffZ = rayEndZ- rayStartZ;
      prevEstimateZ = rayEndZ;

      if(-rayEndZ > nearFar[1] || -rayEndZ < nearFar[0] || P.y < 0.0  || P.y > 1.0 )
      {
        return vec3(P, 0.);
      }

      // If we detect a hit - return the intersection point, two conditions:
      //  - dDepth > 0.0 - sampled point depth is in front of estimated depth
      //  - if difference between dDepth and rayDiffZOld is not too large
      //  - if difference between dDepth and 0.025/abs(k) is not too large
      //  - if the sampled depth is not behind far plane or in front of near plane

      if((dDepth) < 0.025/abs(k) + abs(rayDiffZ) && dDepth > 0.0 && depth > nearFar[0] && depth < nearFar[1] && abs(P.y - projectedCoordStart.y) > invResolutionHeight)
      {
        return vec3(P, depth);
      }

      // continue with ray marching
      P += dP;
      Q.z += dQ.z;
      k += dk;
      rayDiffZOld = rayDiffZ;
    }
    return vec3(P, 0.0);
  }
  `)}let tdt=class{constructor(){this.enabled=!1,this.fadeFactor=1,this.reprojectionMatrix=xe()}};function o8(t){return t?{ray:Io(t.ray),c0:t.c0,c1:t.c1}:{ray:Io(),c0:0,c1:Number.MAX_VALUE}}function rdt(t,e=o8()){return lU(t,e.ray),e.c0=0,e.c1=Number.MAX_VALUE,e}function idt(t,e,r=o8()){const i=Oe(t.vector);return $Oe(t.origin,e,r.ray),r.c0=0,r.c1=i,r}function Lzt(t,e){return T3e(t,t.c0,e)}function Dzt(t,e){return T3e(t,t.c1,e)}function T3e(t,e,r){return ue(r,t.ray.origin,ae(r,t.ray.direction,e))}new z0(()=>o8());function fP(t){return t?[zr(t[0]),zr(t[1]),zr(t[2]),zr(t[3]),zr(t[4]),zr(t[5])]:[zr(),zr(),zr(),zr(),zr(),zr()]}function S3e(){return[C(),C(),C(),C(),C(),C(),C(),C()]}function gU(t,e){for(let r=0;r<xO;r++)QV(t[r],e[r])}function E3e(t,e,r,i=cdt){const s=yi(vte.get(),e,t);so(s,s);for(let n=0;n<adt;++n){const o=ph(_te.get(),ldt[n],s);ie(i[n],o[0]/o[3],o[1]/o[3],o[2]/o[3])}C3e(r,i)}function C3e(t,e){Wa(e[Qe.FAR_BOTTOM_LEFT],e[Qe.NEAR_BOTTOM_LEFT],e[Qe.NEAR_TOP_LEFT],t[Ai.LEFT]),Wa(e[Qe.NEAR_BOTTOM_RIGHT],e[Qe.FAR_BOTTOM_RIGHT],e[Qe.FAR_TOP_RIGHT],t[Ai.RIGHT]),Wa(e[Qe.FAR_BOTTOM_LEFT],e[Qe.FAR_BOTTOM_RIGHT],e[Qe.NEAR_BOTTOM_RIGHT],t[Ai.BOTTOM]),Wa(e[Qe.NEAR_TOP_LEFT],e[Qe.NEAR_TOP_RIGHT],e[Qe.FAR_TOP_RIGHT],t[Ai.TOP]),Wa(e[Qe.NEAR_BOTTOM_LEFT],e[Qe.NEAR_BOTTOM_RIGHT],e[Qe.NEAR_TOP_RIGHT],t[Ai.NEAR]),Wa(e[Qe.FAR_BOTTOM_RIGHT],e[Qe.FAR_BOTTOM_LEFT],e[Qe.FAR_TOP_LEFT],t[Ai.FAR])}function y1(t,e){for(let r=0;r<xO;r++){const i=t[r];if(i[0]*e[0]+i[1]*e[1]+i[2]*e[2]+i[3]>=e[3])return!1}return!0}function sdt(t,e){return O3e(t,rdt(e,R3e.get()))}function Nzt(t,e){for(let r=0;r<xO;r++){const i=t[r];if(!Kat(i,e))return!1}return!0}function ndt(t,e,r){return O3e(t,idt(e,r,R3e.get()))}function A3e(t,e){for(let r=0;r<xO;r++)if(Oi(t[r],e)>0)return!1;return!0}function O3e(t,e){for(let r=0;r<xO;r++)if(!Qat(t[r],e))return!1;return!0}var Ai,Qe;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.TOP=3]="TOP",t[t.NEAR=4]="NEAR",t[t.FAR=5]="FAR"})(Ai||(Ai={})),function(t){t[t.NEAR_BOTTOM_LEFT=0]="NEAR_BOTTOM_LEFT",t[t.NEAR_BOTTOM_RIGHT=1]="NEAR_BOTTOM_RIGHT",t[t.NEAR_TOP_RIGHT=2]="NEAR_TOP_RIGHT",t[t.NEAR_TOP_LEFT=3]="NEAR_TOP_LEFT",t[t.FAR_BOTTOM_LEFT=4]="FAR_BOTTOM_LEFT",t[t.FAR_BOTTOM_RIGHT=5]="FAR_BOTTOM_RIGHT",t[t.FAR_TOP_RIGHT=6]="FAR_TOP_RIGHT",t[t.FAR_TOP_LEFT=7]="FAR_TOP_LEFT"}(Qe||(Qe={}));const odt={bottom:[Qe.FAR_BOTTOM_RIGHT,Qe.NEAR_BOTTOM_RIGHT,Qe.NEAR_BOTTOM_LEFT,Qe.FAR_BOTTOM_LEFT],near:[Qe.NEAR_BOTTOM_LEFT,Qe.NEAR_BOTTOM_RIGHT,Qe.NEAR_TOP_RIGHT,Qe.NEAR_TOP_LEFT],far:[Qe.FAR_BOTTOM_RIGHT,Qe.FAR_BOTTOM_LEFT,Qe.FAR_TOP_LEFT,Qe.FAR_TOP_RIGHT],right:[Qe.NEAR_BOTTOM_RIGHT,Qe.FAR_BOTTOM_RIGHT,Qe.FAR_TOP_RIGHT,Qe.NEAR_TOP_RIGHT],left:[Qe.FAR_BOTTOM_LEFT,Qe.NEAR_BOTTOM_LEFT,Qe.NEAR_TOP_LEFT,Qe.FAR_TOP_LEFT],top:[Qe.FAR_TOP_LEFT,Qe.NEAR_TOP_LEFT,Qe.NEAR_TOP_RIGHT,Qe.FAR_TOP_RIGHT]},xO=6,adt=8,ldt=[Vt(-1,-1,-1,1),Vt(1,-1,-1,1),Vt(1,1,-1,1),Vt(-1,1,-1,1),Vt(-1,-1,1,1),Vt(1,-1,1,1),Vt(1,1,1,1),Vt(-1,1,1,1)],R3e=new z0(o8),cdt=S3e();function udt(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/e)}function hdt(t,e,r){return 2*Math.atan(Math.sqrt(e*e+r*r)*Math.tan(.5*t)/r)}function ddt(t,e,r){return 2*Math.atan(e*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}function pdt(t,e,r){return 2*Math.atan(r*Math.tan(.5*t)/Math.sqrt(e*e+r*r))}var uX;let ft=uX=class extends me{constructor(t={}){super(t),this._center=C(),this._up=C(),this._viewUp=C(),this._viewForward=C(),this._viewRight=C(),this._ray=Io(),this._viewport=Vt(0,0,1,1),this._padding=Vt(0,0,0,0),this._fov=55/180*Math.PI,this._nearFar=yr(1,1e3),this._viewDirty=!0,this._viewMatrix=xe(),this._viewProjectionDirty=!0,this._viewProjectionMatrix=xe(),this._viewInverseTransposeMatrixDirty=!0,this._viewInverseTransposeMatrix=xe(),this._frustumDirty=!0,this._frustum=fP(),this._fullViewport=Qt(),this._pixelRatio=1,this.relativeElevation=0}get pixelRatio(){return this._pixelRatio}set pixelRatio(t){this._pixelRatio=t>0?t:1}get eye(){return this._ray.origin}set eye(t){this._compareAndSetView(t,this._ray.origin)}get center(){return this._center}set center(t){this._compareAndSetView(t,this._center,"_center")}get ray(){return pe(this._ray.direction,this.center,this.eye),this._ray}get up(){return this._up}set up(t){this._compareAndSetView(t,this._up,"_up")}get viewMatrix(){return this._ensureViewClean(),this._viewMatrix}set viewMatrix(t){an(this._viewMatrix,t),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0,this._viewProjectionDirty=!0,this._frustumDirty=!0}get viewForward(){return this._ensureViewClean(),this._viewForward}get viewUp(){return this._ensureViewClean(),this._viewUp}get viewRight(){return this._ensureViewClean(),this._viewRight}get nearFar(){return this._nearFar}get near(){return this._nearFar[0]}set near(t){this._nearFar[0]!==t&&(this._nearFar[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get far(){return this._nearFar[1]}set far(t){this._nearFar[1]!==t&&(this._nearFar[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_nearFar"))}get viewport(){return this._viewport}set viewport(t){this.x=t[0],this.y=t[1],this.width=t[2],this.height=t[3]}get screenViewport(){if(this.pixelRatio===1)return this._viewport;const t=AT(Qt(),this._viewport,1/this.pixelRatio),e=this._get("screenViewport");return e&&sk(t,e)?e:t}get screenPadding(){if(this.pixelRatio===1)return this._padding;const t=AT(Qt(),this._padding,1/this.pixelRatio),e=this._get("screenPadding");return e&&sk(t,e)?e:t}get x(){return this._viewport[0]}set x(t){t+=this._padding[sr.LEFT],this._viewport[0]!==t&&(this._viewport[0]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get y(){return this._viewport[1]}set y(t){t+=this._padding[sr.BOTTOM],this._viewport[1]!==t&&(this._viewport[1]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get width(){return this._viewport[2]}set width(t){this._viewport[2]!==t&&(this._viewport[2]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get height(){return this._viewport[3]}set height(t){this._viewport[3]!==t&&(this._viewport[3]=t,this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_viewport"))}get fullWidth(){return this._viewport[2]+this._padding[sr.RIGHT]+this._padding[sr.LEFT]}set fullWidth(t){this.width=t-(this._padding[sr.RIGHT]+this._padding[sr.LEFT])}get fullHeight(){return this._viewport[3]+this._padding[sr.TOP]+this._padding[sr.BOTTOM]}set fullHeight(t){this.height=t-(this._padding[sr.TOP]+this._padding[sr.BOTTOM])}get fullViewport(){return this._fullViewport[0]=this._viewport[0]-this._padding[sr.LEFT],this._fullViewport[1]=this._viewport[1]-this._padding[sr.BOTTOM],this._fullViewport[2]=this.fullWidth,this._fullViewport[3]=this.fullHeight,this._fullViewport}get _aspect(){return this.width/this.height}get padding(){return this._padding}set padding(t){wC(this._padding,t)||(this._viewport[0]+=t[sr.LEFT]-this._padding[sr.LEFT],this._viewport[1]+=t[sr.BOTTOM]-this._padding[sr.BOTTOM],this._viewport[2]-=t[sr.RIGHT]+t[sr.LEFT]-(this._padding[sr.RIGHT]+this._padding[sr.LEFT]),this._viewport[3]-=t[sr.TOP]+t[sr.BOTTOM]-(this._padding[sr.TOP]+this._padding[sr.BOTTOM]),Id(this._padding,t),this._viewProjectionDirty=!0,this._frustumDirty=!0,this.notifyChange("_padding"),this.notifyChange("_viewport"))}get viewProjectionMatrix(){return this._viewProjectionDirty&&(yi(this._viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),this._viewProjectionDirty=!1),this._viewProjectionMatrix}get projectionMatrix(){const t=this.width,e=this.height,r=this.near*Math.tan(this.fovY/2),i=r*this._aspect,s=MSe(xe(),-i*(1+2*this._padding[sr.LEFT]/t),i*(1+2*this._padding[sr.RIGHT]/t),-r*(1+2*this._padding[sr.BOTTOM]/e),r*(1+2*this._padding[sr.TOP]/e),this.near,this.far),n=this._get("projectionMatrix");return n&&KK(n,s)?n:s}get inverseProjectionMatrix(){return so(xe(),this.projectionMatrix)||this._get("inverseProjectionMatrix")||xe()}get fov(){return this._fov}set fov(t){this._fov=t,this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovX(){return ddt(this._fov,this.width,this.height)}set fovX(t){this._fov=udt(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get fovY(){return pdt(this._fov,this.width,this.height)}set fovY(t){this._fov=hdt(t,this.width,this.height),this._viewProjectionDirty=!0,this._frustumDirty=!0}get distance(){return _i(this.center,this.eye)}get frustum(){return this._recomputeFrustum(),this._frustum}get viewInverseTransposeMatrix(){return(this._viewInverseTransposeMatrixDirty||this._viewDirty)&&(so(this._viewInverseTransposeMatrix,this.viewMatrix),Ou(this._viewInverseTransposeMatrix,this._viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),this._viewInverseTransposeMatrix}depthNDCToWorld(t){const e=2*t-1;return 2*this.near*this.far/(this.far+this.near-e*(this.far-this.near))}get perRenderPixelRatio(){return Math.tan(this.fovX/2)/(this.width/2)}get perScreenPixelRatio(){return this.perRenderPixelRatio*this.pixelRatio}get aboveGround(){return this.relativeElevation!=null&&this.relativeElevation>=0}copyFrom(t){oe(this._ray.origin,t.eye),this.center=t.center,this.up=t.up,Id(this._viewport,t.viewport),this.notifyChange("_viewport"),Id(this._padding,t.padding),this.notifyChange("_padding"),jn(this._nearFar,t.nearFar),this.notifyChange("_nearFar"),this._fov=t.fov,this.relativeElevation=t.relativeElevation;const e=t;return this._viewDirty=e._viewDirty,this._viewDirty||(an(this._viewMatrix,t.viewMatrix),oe(this._viewRight,t.viewRight),oe(this._viewUp,t.viewUp),oe(this._viewForward,t.viewForward)),this._viewProjectionDirty=!0,this._frustumDirty=e._frustumDirty,this._frustumDirty||(gU(this._frustum,t.frustum),this._frustumDirty=!1),e._viewInverseTransposeMatrixDirty?this._viewInverseTransposeMatrixDirty=!0:(an(this._viewInverseTransposeMatrix,t.viewInverseTransposeMatrix),this._viewInverseTransposeMatrixDirty=!1),Id(this._fullViewport,t.fullViewport),this.pixelRatio=t.pixelRatio,this}copyViewFrom(t){this.eye=t.eye,this.center=t.center,this.up=t.up}clone(){return new uX().copyFrom(this)}equals(t){return Jr(this.eye,t.eye)&&Jr(this.center,t.center)&&Jr(this.up,t.up)&&wC(this._viewport,t.viewport)&&wC(this._padding,t.padding)&&LCe(this.nearFar,t.nearFar)&&this._fov===t.fov&&this.pixelRatio===t.pixelRatio&&this.relativeElevation===t.relativeElevation}almostEquals(t){if(Math.abs(t.fov-this._fov)>=.001||ik(t.screenPadding,this.screenPadding)>=1||ik(this.screenViewport,t.screenViewport)>=1)return!1;Mi(La,t.eye,t.center),Mi(tB,this.eye,this.center);const e=de(La,tB),r=tA(La),i=tA(tB),s=5e-4;return e*e>=(1-1e-10)*r*i&&F6(t.eye,this.eye)<Math.max(r,i)*s*s}computeRenderPixelSizeAt(t){return this.computeRenderPixelSizeAtDist(this._viewDirectionDistance(t))}computeRenderPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeScreenPixelSizeAt(t){return this.computeScreenPixelSizeAtDist(this._viewDirectionDistance(t))}_viewDirectionDistance(t){return Math.abs(O1(this.viewForward,pe(La,t,this.eye)))}computeScreenPixelSizeAtDist(t){return t*this.perScreenPixelRatio}computeDistanceFromRadius(t,e){return t/Math.tan(Math.min(this.fovX,this.fovY)/(2*(e||1)))}getScreenCenter(t=cs()){return t[0]=(this.padding[sr.LEFT]+this.width/2)/this.pixelRatio,t[1]=(this.padding[sr.TOP]+this.height/2)/this.pixelRatio,t}getRenderCenter(t,e=.5,r=.5){return t[0]=this.padding[sr.LEFT]+this.width*e,t[1]=this.padding[sr.BOTTOM]+this.height*r,t[2]=.5,t}setGLViewport(t){const e=this.viewport,r=this.padding;t.setViewport(e[0]-r[3],e[1]-r[2],e[2]+r[1]+r[3],e[3]+r[0]+r[2])}applyProjection(t,e){t!==ir&&oe(ir,t),ir[3]=1,ph(ir,ir,this.projectionMatrix);const r=Math.abs(ir[3]);ae(ir,ir,1/r);const i=this.fullViewport;e[0]=Et(0,i[0]+i[2],.5+.5*ir[0]),e[1]=Et(0,i[1]+i[3],.5+.5*ir[1]),e[2]=.5*(ir[2]+1),e[3]=r}unapplyProjection(t,e){const r=this.fullViewport;ir[0]=(t[0]/(r[0]+r[2])*2-1)*t[3],ir[1]=(t[1]/(r[1]+r[3])*2-1)*t[3],ir[2]=(2*t[2]-1)*t[3],ir[3]=t[3],this.inverseProjectionMatrix!=null&&(ph(ir,ir,this.inverseProjectionMatrix),e[0]=ir[0],e[1]=ir[1],e[2]=ir[2])}projectToScreen(t,e){return this.projectToRenderScreen(t,rB),this.renderToScreen(rB,e),e}projectToRenderScreen(t,e){if(ir[0]=t[0],ir[1]=t[1],ir[2]=t[2],ir[3]=1,ph(ir,ir,this.viewProjectionMatrix),ir[3]===0)return null;ae(ir,ir,1/Math.abs(ir[3]));const r=this.fullViewport;return"x"in e?(e.x=Et(0,r[0]+r[2],.5+.5*ir[0]),e.y=Et(0,r[1]+r[3],.5+.5*ir[1])):(e[0]=Et(0,r[0]+r[2],.5+.5*ir[0]),e[1]=Et(0,r[1]+r[3],.5+.5*ir[1]),e.length>2&&(e[2]=.5*(ir[2]+1))),e}unprojectFromScreen(t,e){return this.unprojectFromRenderScreen(this.screenToRender(t,rB),e)}unprojectFromRenderScreen(t,e){if(yi(wD,this.projectionMatrix,this.viewMatrix),!so(wD,wD))return null;const r=this.fullViewport;return ir[0]=2*(t[0]-r[0])/r[2]-1,ir[1]=2*(t[1]-r[1])/r[3]-1,ir[2]=2*t[2]-1,ir[3]=1,ph(ir,ir,wD),ir[3]===0?null:(e[0]=ir[0]/ir[3],e[1]=ir[1]/ir[3],e[2]=ir[2]/ir[3],e)}constrainWindowSize(t,e,r,i){const s=t*this.pixelRatio,n=e*this.pixelRatio,o=Math.max(s-r/2,0),a=Math.max(this.fullHeight-n-i/2,0),l=-Math.min(s-r/2,0),c=-Math.min(this.fullHeight-n-i/2,0);return[o,a,r-l- -Math.min(this.fullWidth-s-r/2,0),i-c- -Math.min(n-i/2,0)]}computeUp(t){t===Ue.Global?this._computeUpGlobal():this._computeUpLocal()}screenToRender(t,e){const r=t[0]*this.pixelRatio,i=this.fullHeight-t[1]*this.pixelRatio;return e[0]=r,e[1]=i,e}renderToScreen(t,e){const r=t[0]/this.pixelRatio,i=(this.fullHeight-t[1])/this.pixelRatio;e[0]=r,e[1]=i}_computeUpGlobal(){pe(La,this.center,this.eye);const t=Oe(this.center);t<1?(ie(this._up,0,0,1),this._markViewDirty(),this.notifyChange("_up")):Math.abs(de(La,this.center))>.9999*Oe(La)*t||(st(this._up,La,this.center),st(this._up,this._up,La),_e(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_computeUpLocal(){F0(La,this.eye,this.center),Math.abs(La[2])<=.9999&&(ae(La,La,La[2]),ie(this._up,-La[0],-La[1],1-La[2]),_e(this._up,this._up),this.notifyChange("_up"),this._markViewDirty())}_compareAndSetView(t,e,r=""){typeof t[0]=="number"&&isFinite(t[0])&&typeof t[1]=="number"&&isFinite(t[1])&&typeof t[2]=="number"&&isFinite(t[2])?Jr(t,e)||(oe(e,t),this._markViewDirty(),r.length&&this.notifyChange(r)):K.getLogger("esri.views.3d.webgl-engine.lib.Camera").warn("Camera vector contains invalid number, ignoring value")}_markViewDirty(){this._viewDirty=!0,this._frustumDirty=!0,this._viewProjectionDirty=!0}_recomputeFrustum(){this._frustumDirty&&(E3e(this.viewMatrix,this.projectionMatrix,this._frustum),this._frustumDirty=!1)}_ensureViewClean(){this._viewDirty&&(wV(this._viewMatrix,this.eye,this.center,this.up),ie(this._viewForward,-this._viewMatrix[2],-this._viewMatrix[6],-this._viewMatrix[10]),ie(this._viewUp,this._viewMatrix[1],this._viewMatrix[5],this._viewMatrix[9]),ie(this._viewRight,this._viewMatrix[0],this._viewMatrix[4],this._viewMatrix[8]),this._viewDirty=!1,this._viewInverseTransposeMatrixDirty=!0)}};u([d()],ft.prototype,"_center",void 0),u([d()],ft.prototype,"_up",void 0),u([d()],ft.prototype,"_viewport",void 0),u([d()],ft.prototype,"_padding",void 0),u([d()],ft.prototype,"_fov",void 0),u([d()],ft.prototype,"_nearFar",void 0),u([d()],ft.prototype,"_pixelRatio",void 0),u([d()],ft.prototype,"pixelRatio",null),u([d()],ft.prototype,"eye",null),u([d()],ft.prototype,"center",null),u([d()],ft.prototype,"up",null),u([d({readOnly:!0})],ft.prototype,"nearFar",null),u([d()],ft.prototype,"near",null),u([d()],ft.prototype,"far",null),u([d()],ft.prototype,"viewport",null),u([d({readOnly:!0})],ft.prototype,"screenViewport",null),u([d({readOnly:!0})],ft.prototype,"screenPadding",null),u([d()],ft.prototype,"x",null),u([d()],ft.prototype,"y",null),u([d()],ft.prototype,"width",null),u([d()],ft.prototype,"height",null),u([d()],ft.prototype,"fullWidth",null),u([d()],ft.prototype,"fullHeight",null),u([d({readOnly:!0})],ft.prototype,"_aspect",null),u([d()],ft.prototype,"padding",null),u([d({readOnly:!0})],ft.prototype,"projectionMatrix",null),u([d({readOnly:!0})],ft.prototype,"inverseProjectionMatrix",null),u([d()],ft.prototype,"fov",null),u([d()],ft.prototype,"fovX",null),u([d()],ft.prototype,"fovY",null),ft=uX=u([R("esri.views.3d.webgl-engine.lib.Camera")],ft);const ir=Qt(),wD=xe(),La=C(),tB=C(),rB=Lo();var sr;(function(t){t[t.TOP=0]="TOP",t[t.RIGHT=1]="RIGHT",t[t.BOTTOM=2]="BOTTOM",t[t.LEFT=3]="LEFT"})(sr||(sr={}));var fe;(function(t){t[t.INTEGRATED_MESH=0]="INTEGRATED_MESH",t[t.OPAQUE_TERRAIN=1]="OPAQUE_TERRAIN",t[t.OPAQUE_MATERIAL=2]="OPAQUE_MATERIAL",t[t.TRANSPARENT_MATERIAL=3]="TRANSPARENT_MATERIAL",t[t.TRANSPARENT_TERRAIN=4]="TRANSPARENT_TERRAIN",t[t.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL=5]="TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL",t[t.OCCLUDED_TERRAIN=6]="OCCLUDED_TERRAIN",t[t.OCCLUDER_MATERIAL=7]="OCCLUDER_MATERIAL",t[t.TRANSPARENT_OCCLUDER_MATERIAL=8]="TRANSPARENT_OCCLUDER_MATERIAL",t[t.OCCLUSION_PIXELS=9]="OCCLUSION_PIXELS",t[t.POSTPROCESSING_ENVIRONMENT_OPAQUE=10]="POSTPROCESSING_ENVIRONMENT_OPAQUE",t[t.POSTPROCESSING_ENVIRONMENT_TRANSPARENT=11]="POSTPROCESSING_ENVIRONMENT_TRANSPARENT",t[t.LASERLINES=12]="LASERLINES",t[t.LASERLINES_CONTRAST_CONTROL=13]="LASERLINES_CONTRAST_CONTROL",t[t.HUD_MATERIAL=14]="HUD_MATERIAL",t[t.LABEL_MATERIAL=15]="LABEL_MATERIAL",t[t.LINE_CALLOUTS=16]="LINE_CALLOUTS",t[t.LINE_CALLOUTS_HUD_DEPTH=17]="LINE_CALLOUTS_HUD_DEPTH",t[t.DRAPED_MATERIAL=18]="DRAPED_MATERIAL",t[t.DRAPED_WATER=19]="DRAPED_WATER",t[t.VOXEL=20]="VOXEL",t[t.MAX_SLOTS=21]="MAX_SLOTS"})(fe||(fe={}));var ut;(function(t){t[t.Color=0]="Color",t[t.Alpha=1]="Alpha",t[t.FrontFace=2]="FrontFace",t[t.NONE=3]="NONE",t[t.COUNT=4]="COUNT"})(ut||(ut={}));let Hte=class{constructor(e=C()){this.intensity=e}},M3e=class{constructor(e=C(),r=Ee(.57735,.57735,.57735)){this.intensity=e,this.direction=r}},yU=class{constructor(e=C(),r=Ee(.57735,.57735,.57735),i=!0,s=1,n=1){this.intensity=e,this.direction=r,this.castShadows=i,this.specularStrength=s,this.environmentStrength=n}},I3e=class{constructor(){this.r=[0],this.g=[0],this.b=[0]}};function fdt(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e[i];return r}function iB(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]*e;return r}function DC(t,e,r){(r=r||t).length=t.length;for(let i=0;i<t.length;i++)r[i]=t[i]+e[i];return r}function P3e(t){return(t+1)*(t+1)}function mdt(t){return ye(Math.floor(Math.sqrt(t)-1),0,2)}function $3e(t,e,r){const i=t[0],s=t[1],n=t[2],o=r||[];return o.length=P3e(e),e>=0&&(o[0]=.28209479177),e>=1&&(o[1]=.4886025119*i,o[2]=.4886025119*n,o[3]=.4886025119*s),e>=2&&(o[4]=1.09254843059*i*s,o[5]=1.09254843059*s*n,o[6]=.31539156525*(3*n*n-1),o[7]=1.09254843059*i*n,o[8]=.54627421529*(i*i-s*s)),o}function gdt(t,e){const r=P3e(t),i=e||{r:[],g:[],b:[]};i.r.length=i.g.length=i.b.length=r;for(let s=0;s<r;s++)i.r[s]=i.g[s]=i.b[s]=0;return i}function ydt(t,e){const r=mdt(e.r.length);for(const i of t)el(hX,i.direction),$3e(hX,r,Jy),fdt(Jy,Y4),iB(Jy,i.intensity[0],HS),DC(e.r,HS),iB(Jy,i.intensity[1],HS),DC(e.g,HS),iB(Jy,i.intensity[2],HS),DC(e.b,HS);return e}function _dt(t,e){$3e(hX,0,Jy);for(const r of t)e.r[0]+=Jy[0]*Y4[0]*r.intensity[0]*4*Math.PI,e.g[0]+=Jy[0]*Y4[0]*r.intensity[1]*4*Math.PI,e.b[0]+=Jy[0]*Y4[0]*r.intensity[2]*4*Math.PI;return e}function vdt(t,e,r,i){gdt(e,i),ie(r.intensity,0,0,0);let s=!1;const n=bdt,o=wdt,a=xdt;n.length=0,o.length=0,a.length=0;for(const l of t)l instanceof yU&&!s?(oe(r.direction,l.direction),oe(r.intensity,l.intensity),r.specularStrength=l.specularStrength,r.environmentStrength=l.environmentStrength,r.castShadows=l.castShadows,s=!0):l instanceof yU||l instanceof M3e?n.push(l):l instanceof Hte?o.push(l):l instanceof I3e&&a.push(l);ydt(n,i),_dt(o,i);for(const l of a)DC(i.r,l.r),DC(i.g,l.g),DC(i.b,l.b)}const bdt=[],wdt=[],xdt=[],Jy=[0],HS=[0],hX=C(),Y4=[3.141593,2.094395,2.094395,2.094395,.785398,.785398,.785398,.785398,.785398];let Zue=class{constructor(){this.color=C(),this.intensity=1}},Tdt=class{constructor(){this.direction=C(),this.ambient=new Zue,this.diffuse=new Zue}};const L3e=.4;let sB=class{constructor(){this._shOrder=2,this._legacy=new Tdt,this.globalFactor=.5,this.noonFactor=.5,this._sphericalHarmonics=new I3e,this._mainLight=new yU(C(),Ee(1,0,0),!1)}get legacy(){return this._legacy}get sh(){return this._sphericalHarmonics}get mainLight(){return this._mainLight}set(e){vdt(e,this._shOrder,this._mainLight,this._sphericalHarmonics),oe(this._legacy.direction,this._mainLight.direction);const r=1/Math.PI;this._legacy.ambient.color[0]=.282095*this._sphericalHarmonics.r[0]*r,this._legacy.ambient.color[1]=.282095*this._sphericalHarmonics.g[0]*r,this._legacy.ambient.color[2]=.282095*this._sphericalHarmonics.b[0]*r,ae(this._legacy.diffuse.color,this._mainLight.intensity,r),oe(xD,this._legacy.diffuse.color),ae(xD,xD,L3e*this.globalFactor),ue(this._legacy.ambient.color,this._legacy.ambient.color,xD)}copyFrom(e){this._sphericalHarmonics.r=Array.from(e.sh.r),this._sphericalHarmonics.g=Array.from(e.sh.g),this._sphericalHarmonics.b=Array.from(e.sh.b),oe(this._mainLight.direction,e.mainLight.direction),oe(this._mainLight.intensity,e.mainLight.intensity),this._mainLight.castShadows=e.mainLight.castShadows,this._mainLight.specularStrength=e.mainLight.specularStrength,this._mainLight.environmentStrength=e.mainLight.environmentStrength,this.globalFactor=e.globalFactor,this.noonFactor=e.noonFactor}lerpLighting(e,r,i){if(Wr(this._mainLight.intensity,e.mainLight.intensity,r.mainLight.intensity,i),this._mainLight.environmentStrength=Et(e.mainLight.environmentStrength,r.mainLight.environmentStrength,i),this._mainLight.specularStrength=Et(e.mainLight.specularStrength,r.mainLight.specularStrength,i),oe(this._mainLight.direction,r.mainLight.direction),this._mainLight.castShadows=r.mainLight.castShadows,this.globalFactor=Et(e.globalFactor,r.globalFactor,i),this.noonFactor=Et(e.noonFactor,r.noonFactor,i),e.sh.r.length===r.sh.r.length)for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=Et(e.sh.r[s],r.sh.r[s],i),this._sphericalHarmonics.g[s]=Et(e.sh.g[s],r.sh.g[s],i),this._sphericalHarmonics.b[s]=Et(e.sh.b[s],r.sh.b[s],i);else for(let s=0;s<r.sh.r.length;s++)this._sphericalHarmonics.r[s]=r.sh.r[s],this._sphericalHarmonics.g[s]=r.sh.g[s],this._sphericalHarmonics.b[s]=r.sh.b[s]}};const xD=C();let a8=class{constructor(e,r,i){this.shadowMap=e,this.ssaoHelper=r,this.slicePlane=i,this.slot=fe.OPAQUE_MATERIAL,this.hasOccludees=!1,this.enableFillLights=!0,this.transparencyPassType=ut.NONE,this.alignPixelEnabled=!1,this._camera=new ft,this._inverseViewport=Pe(),this.oldLighting=new sB,this.newLighting=new sB,this._fadedLighting=new sB,this._lighting=this.newLighting,this.ssr=new tdt,this.multipassTerrain=new Kht,this.multipassGeometry=new Qht,this.overlays=[],this.cloudsFade=new $ht}get camera(){return this._camera}set camera(e){this._camera=this.ssr.camera=e,this._inverseViewport[0]=1/e.fullViewport[2],this._inverseViewport[1]=1/e.fullViewport[3]}get inverseViewport(){return this._inverseViewport}get lighting(){return this._lighting}get weatherFading(){return this._lighting===this._fadedLighting}fadeLighting(e){const{oldLighting:r,newLighting:i}=this;e>=1?this._lighting=i:(this._fadedLighting.lerpLighting(r,i,e),this._lighting=this._fadedLighting)}},nc=class extends me{constructor(e){super(e),this._handles=new li,this._techniques=new Array,this._techniqueConfiguration=new Z4,this._bindParameters=new a8(null,null,null),this._passParameters=new g3e,this._drawParameters=new y3e,this._weatherTile=Pe(),this._weatherTileCount=128,this._faceIndex=0,this._tileIndex=0,this.coverage=Et(Ba.default.coverage[0],Ba.default.coverage[1],.5),this.density=Et(Ba.default.density[0],Ba.default.density[1],.5),this.absorption=Et(Ba.default.absorption[0],Ba.default.absorption[1],.5),this.cloudSize=Et(Ba.default.cloudSize[0],Ba.default.cloudSize[1],.5),this.detailSize=Et(Ba.default.detailSize[0],Ba.default.detailSize[1],.5),this.smoothness=Et(Ba.default.smoothness[0],Ba.default.smoothness[1],.5),this.cloudHeight=Et(Ba.default.cloudHeight[0],Ba.default.cloudHeight[1],.5),this.raymarchingSteps=Ba.default.raymarchingSteps,this._viewMatrix=xe(),this._dirty=!1,this.running=!1,this._vao=Mc(e.context.renderContext.rctx)}_getTechnique(e){const r=1-this.context.renderContext.bindParameters.cloudsFade.readChannels,i=r===zT.RG?2*e:2*e+1;return this._techniques[i]||(this._techniqueConfiguration.writeTextureChannels=r,this._techniqueConfiguration.steps=e,this._techniques[i]=new _3e({rctx:this.context.renderContext.rctx,viewingMode:this.view.state.viewingMode},this._techniqueConfiguration),this._techniques[i])}updateWeatherTile(){const e=this.view.camera.position.latitude,r=this.view.camera.position.longitude;if(e==null||r==null)return;hr(this._weatherTile,(e+90)/180,(r+180)/360);const i=Math.floor(this._weatherTileCount*Math.abs(2*this._weatherTile[0]-1));this._weatherTile[0]=Math.floor(2*this._weatherTileCount*this._weatherTile[0]),this._weatherTile[1]=Math.floor(4*(this._weatherTileCount-i)*this._weatherTile[1]);let s=0,n=0;if(this.view.environment!=null&&this.view.environment.lighting.type!=="virtual"&&this.view.environment.lighting.date!=null){const o=new Date(this.view.environment.lighting.date);o.setUTCHours(this.view.environment.lighting.date.getUTCHours()+(this.view.environment.lighting.displayUTCOffset??0)),s=31*o.getUTCMonth()+o.getUTCDate(),n=o.getUTCFullYear()}this._weatherTile[0]=(this._weatherTile[0]+s)%(2*this._weatherTileCount),this._weatherTile[1]=(this._weatherTile[1]+n%100)%(4*this._weatherTileCount),DCe(this._passParameters.weatherTile,this._weatherTile)||this.setDirty()}initialize(){const e=Ir(this.view.spatialReference);this._passParameters.cloudRadius=.5*e.radius,this.setDirty(),this.updateWeatherTile(),this._handles.add([this.view.resourceController.scheduler.registerTask(gt.CLOUDS_GENERATOR,this),Q(()=>[this.coverage,this.density,this.absorption,this.cloudSize,this.detailSize,this.smoothness,this.cloudHeight,this.raymarchingSteps],()=>this.setDirty(),xt)])}destroy(){this._handles.destroy(),this._techniques.forEach(e=>as(e)),this._frameBufferCube=ze(this._frameBufferCube),this._techniques.length=0,this._vao.dispose(),this._passParameters.noiseTexture=Re(this._passParameters.noiseTexture)}get _tilesPerFace(){switch(this._techniqueConfiguration.steps){case yc.SIXTEEN:return 1;case yc.HUNDRED:return 4;case yc.COUNT:case yc.TWOHUNDRED:return 8}}_ensureNoiseTexture(){if(this._passParameters.noiseTexture!=null)this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile);else{const e=this.context;this._passParameters.noiseTexture=new uM({context:e}),this._passParameters.noiseTexture.updateWeatherMap(this._passParameters.weatherTile)}return this._passParameters.noiseTexture.textureAtlas!=null}_ensureFrameBufferCube(e){if(this._frameBufferCube==null){const r=new Sr(e);r.target=Rs.TEXTURE_CUBE_MAP,r.wrapMode=Ut.CLAMP_TO_EDGE,this._frameBufferCube=new Vn(this.context.renderContext.rctx,r)}return this._frameBufferCube}get cubeMap(){return this._frameBufferCube}destroyFrameBufferCube(){this._frameBufferCube=ze(this._frameBufferCube)}applyPreset(e,r){const i=e.median,s=n=>{const o=Et(n[0],n[1],i);return r<.5?Et(n[0],o,2*r):Et(o,n[1],2*(r-.5))};this.coverage=s(e.coverage),this.density=s(e.density),this.absorption=s(e.absorption),this.cloudSize=s(e.cloudSize),this.detailSize=s(e.detailSize),this.smoothness=s(e.smoothness),this.cloudHeight=s(e.cloudHeight),this.raymarchingSteps=e.raymarchingSteps}setDirty(){this._dirty=this.running=!0}runTask(e){this._faceIndex===0&&this._tileIndex===0&&(this._passParameters.raymarchingSteps=this.raymarchingSteps,this.updateWeatherTile(),jn(this._passParameters.weatherTile,this._weatherTile));const r=this._getTechnique(this._passParameters.raymarchingSteps);if(!r.compiled||!this.context.renderContext.bindParameters.cloudsFade.isCameraPositionFinal||this.context.renderContext.bindParameters.cloudsFade.isFading||!this._ensureNoiseTexture())return Pa.YIELD;this._faceIndex===0&&this._tileIndex===0&&(this.context.renderContext.bindParameters.cloudsFade.renderingStage=tn.RENDERING,this._passParameters.absorption=this.absorption,this._passParameters.density=this.density,this._passParameters.cloudSize=this.cloudSize,this._passParameters.detailSize=this.detailSize,this._passParameters.smoothness=this.smoothness,this._passParameters.cloudHeight=this.cloudHeight,this._passParameters.coverage=this.coverage,this._dirty=!1);const i=this.context.renderContext.rctx,s=i.bindTechnique(r,this._passParameters,this._bindParameters);i.bindVAO(this._vao),s.assertCompatibleVertexAttributeLocations(this._vao);const n=i.getViewport(),o=r.configuration.cubeMapSize,a=o/this._tilesPerFace,l=this._tileIndex*a;i.setViewport(0,l,o,a);const c=this._ensureFrameBufferCube(o);i.bindFramebuffer(c);const h=Sdt[this._faceIndex],p=Edt[this._faceIndex];PSe(this._viewMatrix,Cdt,h,p),qd(this._drawParameters.viewMatrix,this._viewMatrix);const f=Rs.TEXTURE_CUBE_MAP_POSITIVE_X+this._faceIndex;return c.setColorTextureTarget(f),s.bindDraw(this._drawParameters,this._bindParameters,this._passParameters),i.gl.drawArrays(i.gl.TRIANGLE_STRIP,0,4),i.gl.flush(),i.setViewport(n.x,n.y,n.width,n.height),this.requestRender(),++this._tileIndex,this._faceIndex===4&&this._tileIndex===this._tilesPerFace?(this.running=this._dirty,this._faceIndex=0,this._tileIndex=0,this.context.renderContext.bindParameters.cloudsFade.renderingStage=tn.FINISHED_RENDERING):this._tileIndex===this._tilesPerFace&&(++this._faceIndex,this._tileIndex=0),e.madeProgress(),Pa.YIELD}};u([d({constructOnly:!0})],nc.prototype,"context",void 0),u([d({constructOnly:!0})],nc.prototype,"view",void 0),u([d({constructOnly:!0})],nc.prototype,"requestRender",void 0),u([d()],nc.prototype,"coverage",void 0),u([d()],nc.prototype,"density",void 0),u([d()],nc.prototype,"absorption",void 0),u([d()],nc.prototype,"cloudSize",void 0),u([d()],nc.prototype,"detailSize",void 0),u([d()],nc.prototype,"smoothness",void 0),u([d()],nc.prototype,"cloudHeight",void 0),u([d()],nc.prototype,"raymarchingSteps",void 0),u([d()],nc.prototype,"running",void 0),nc=u([R("esri.views.3d.environment.CloudsGenerator")],nc);const Sdt=[si(1,0,0),si(-1,0,0),si(0,1,0),si(0,-1,0),si(0,0,1)],Edt=[si(0,1,0),si(0,1,0),si(0,0,-1),si(0,0,1),si(0,1,0)],Cdt=yte();let D3e=class extends ui{constructor(){super(...arguments),this.fogColor=C(),this.fogStrength=4e-6,this.atmosphereC=1,this.fogAmount=0}};function Adt(){const t=new Cr;t.attributes.add(E.POSITION,"vec2"),t.include(ag,{textureCoordinateType:sn.Default}),t.varyings.add("worldRay","vec3"),t.varyings.add("eyeDir","vec3");const{vertex:e,fragment:r}=t;return e.uniforms.add(new es("inverseProjectionMatrix",(i,s)=>s.camera.inverseProjectionMatrix),new es("inverseViewMatrix",(i,s)=>mO(Odt,s.camera.viewMatrix))),e.code.add(w`void main(void) {
vec3 posViewNear = (inverseProjectionMatrix * vec4(position, -1, 1)).xyz;
eyeDir = posViewNear;
worldRay = (inverseViewMatrix * vec4(posViewNear, 0)).xyz;
forwardTextureCoordinates();
gl_Position = vec4(position, 1, 1);
}`),r.uniforms.add(new Ie("atmosphereC",i=>i.atmosphereC),new jt("cameraPosition",(i,s)=>s.camera.eye),new Pr("nearFar",(i,s)=>s.camera.nearFar),new et("depthTexture",i=>i.depthTexture),new Ie("fogStrength",i=>i.fogStrength),new Ie("fogAmount",i=>i.fogAmount),new jt("fogColor",i=>i.fogColor)),t.include(s8),r.include(Ch),r.code.add(w`vec2 sphereIntersect(vec3 start, vec3 dir) {
float a = dot(dir, dir);
float b = 2.0 * dot(dir, start);
float d = (b * b) - 4.0 * a * atmosphereC;
if (d < 0.0) {
return vec2(1e5, -1e5);
}
return vec2((-b - sqrt(d)) / (2.0 * a), (-b + sqrt(d)) / (2.0 * a));
}`),r.code.add(w`vec4 applyFog(float dist, vec3 rayDir){
if(dist == -1.0){
vec2 rayAtmosphereIntersect = sphereIntersect(cameraPosition, rayDir);
dist = 0.055 * rayAtmosphereIntersect.y;
}
float fogAmount = fogAmount * (1.0 - exp(-dist * fogStrength));
return vec4(fogAmount * fogColor, fogAmount);
}`),r.code.add(w`vec3 tonemapACES(vec3 x) {
return clamp((x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14), 0.0, 1.0);
}
void main() {
vec3 rayDir = normalize(worldRay);
float terrainDepth = -1.0;
float depthSample = texture(depthTexture, vuv0).r;
float zNorm = 2.0 * depthSample - 1.0;
float linDepth = 2.0 * nearFar[0] * nearFar[1] / (nearFar[1] + nearFar[0] - zNorm * (nearFar[1] - nearFar[0]));
if(depthSample < 1.0 && depthSample > 0.0){
vec3 cameraSpaceRay = normalize(eyeDir);
cameraSpaceRay /= cameraSpaceRay.z;
cameraSpaceRay *= linDepth;
terrainDepth = max(0.0, length(cameraSpaceRay));
}
vec4 fog = applyFog(terrainDepth, rayDir);
fragColor = delinearizeGamma(vec4(tonemapACES(fog.rgb), fog.a));
}`),t}const Odt=xe(),Rdt=Object.freeze(Object.defineProperty({__proto__:null,FogPassParameters:D3e,build:Adt},Symbol.toStringTag,{value:"Module"}));let N3e=class F3e extends Ur{constructor(e){super(e,new nl,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,F3e.shader.get().build(),Er)}initializePipeline(){return It({blending:ca(Te.SRC_ALPHA,Te.ZERO,Te.ONE_MINUS_SRC_ALPHA,Te.ONE),colorWrite:Wt})}};N3e.shader=new $r(Rdt,()=>J(()=>import("./Fog.glsl-44c20467.js"),[],import.meta.url));const Mdt=.95,Idt=1;let sx=class extends me{constructor(e){super(e),this._passParameters=new D3e;const r=e.context.renderContext.rctx;this._vao=Mc(r,T$),this._technique=new N3e(e);const i=Ir(e.view.spatialReference);this._planetRadius=i.radius,this._atmosphereRadius=i.radius+Vv}destroy(){this._technique.release(),this._vao.dispose()}set strength(e){this._passParameters.fogStrength=e}get strength(){return this._passParameters.fogStrength}render(e,r){if(this._update(e,r),this._passParameters.fogAmount<=0)return;const i=this._technique;if(!i.compiled)return void this.context.requestRender();const s=e.offscreenRenderingHelper;s.renderDepthDetached(()=>{this._passParameters.depthTexture=s.depthTexture;const n=e.rctx.bindTechnique(i,this._passParameters,e.bindParameters);this._renderFog(n,e)})}_renderFog(e,r){const i=r.rctx;i.bindVAO(this._vao),e.assertCompatibleVertexAttributeLocations(this._vao),i.drawArrays(Ot.TRIANGLE_STRIP,0,4)}_update(e,r){const i=e.bindParameters.camera;_e(Xue,i.eye);const s=Math.max(0,de(Xue,e.bindParameters.lighting.mainLight.direction)),n=r.color;ae(Yue,n,.1),Wr(this._passParameters.fogColor,Yue,n,s);const o=Oe(i.eye),a=o*o;this._passParameters.atmosphereC=a-this._atmosphereRadius*this._atmosphereRadius,this._passParameters.fogAmount=(1-BI(Mdt*Gm,Idt*Gm,Math.abs(o-this._planetRadius)))*r.amount,this._passParameters.fogStrength=r.strength}static isSupported(e){return e.capabilities.depthTexture}};u([d({constructOnly:!0})],sx.prototype,"context",void 0),u([d({constructOnly:!0})],sx.prototype,"view",void 0),u([d({constructOnly:!0})],sx.prototype,"rctx",void 0),u([d({constructOnly:!0})],sx.prototype,"viewingMode",void 0),sx=u([R("esri.views.3d.environment.Fog")],sx);let Pdt=class{constructor(){this.color=C(),this.strength=0,this.amount=0}};const Xue=C(),Yue=C();let Ea=class extends nl{};u([B({constValue:!0})],Ea.prototype,"hasSliceHighlight",void 0),u([B({constValue:!1})],Ea.prototype,"hasSliceInVertexProgram",void 0),u([B({constValue:!1})],Ea.prototype,"instancedDoublePrecision",void 0),u([B({constValue:!1})],Ea.prototype,"hasModelTransformation",void 0),u([B({constValue:ai.Pass})],Ea.prototype,"pbrTextureBindType",void 0);var Cg;(function(t){t[t.Cone=0]="Cone",t[t.Cylinder=1]="Cylinder",t[t.Underground=2]="Underground",t[t.COUNT=3]="COUNT"})(Cg||(Cg={}));let qte=class extends Ea{constructor(){super(...arguments),this.geometry=Cg.Cone}};u([B({count:Cg.COUNT})],qte.prototype,"geometry",void 0);var k;(function(t){t[t.Color=0]="Color",t[t.Depth=1]="Depth",t[t.Normal=2]="Normal",t[t.Shadow=3]="Shadow",t[t.ShadowHighlight=4]="ShadowHighlight",t[t.ShadowExcludeHighlight=5]="ShadowExcludeHighlight",t[t.Highlight=6]="Highlight",t[t.Alpha=7]="Alpha",t[t.ObjectAndLayerIdColor=8]="ObjectAndLayerIdColor",t[t.COUNT=9]="COUNT"})(k||(k={}));function E$(t){t.attributes.add(E.POSITION,"vec3"),t.vertex.code.add(w`vec3 positionModel() { return position; }`)}function _U({code:t},e){e.doublePrecisionRequiresObfuscation?t.add(w`vec3 dpPlusFrc(vec3 a, vec3 b) {
return mix(a, a + b, vec3(notEqual(b, vec3(0))));
}
vec3 dpMinusFrc(vec3 a, vec3 b) {
return mix(vec3(0), a - b, vec3(notEqual(a, b)));
}
vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = dpPlusFrc(hiA, hiB);
vec3 e = dpMinusFrc(t1, hiA);
vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
return t1 + t2;
}`):t.add(w`vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
vec3 t1 = hiA + hiB;
vec3 e = t1 - hiA;
vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
return t1 + t2;
}`)}let tp=class extends Ps{constructor(e,r){super(e,"mat3",ai.Pass,(i,s,n)=>i.setUniformMatrix3fv(e,r(s,n)))}};function NC(t,e){t.include(E$);const r=t.vertex;r.include(_U,e),t.varyings.add("vPositionWorldCameraRelative","vec3"),t.varyings.add("vPosition_view","vec3"),r.uniforms.add(new jt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH),new jt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new tp("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new es("transformProjFromView",i=>i.transformProjFromView),new pP("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new _h("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new _h("transformWorldFromModelTL",i=>i.transformWorldFromModelTL)),r.code.add(w`vec3 positionWorldCameraRelative() {
vec3 rotatedModelPosition = transformWorldFromModelRS * positionModel();
vec3 transform_CameraRelativeFromModel = dpAdd(
transformWorldFromModelTL,
transformWorldFromModelTH,
-transformWorldFromViewTL,
-transformWorldFromViewTH
);
return transform_CameraRelativeFromModel + rotatedModelPosition;
}`),r.code.add(w`
    void forwardPosition(float fOffset) {
      vPositionWorldCameraRelative = positionWorldCameraRelative();
      if (fOffset != 0.0) {
        vPositionWorldCameraRelative += fOffset * ${e.spherical?w`normalize(transformWorldFromViewTL + vPositionWorldCameraRelative)`:w`vec3(0.0, 0.0, 1.0)`};
      }

      vPosition_view = transformViewFromCameraRelativeRS * vPositionWorldCameraRelative;
      gl_Position = transformProjFromView * vec4(vPosition_view, 1.0);
    }
  `),t.fragment.uniforms.add(new jt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL)),r.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`),t.fragment.code.add(w`vec3 positionWorld() {
return transformWorldFromViewTL + vPositionWorldCameraRelative;
}`)}let k3e=class extends ui{constructor(){super(...arguments),this.transformWorldFromViewTH=C(),this.transformWorldFromViewTL=C(),this.transformViewFromCameraRelativeRS=ts(),this.transformProjFromView=xe()}},U3e=class extends ui{constructor(){super(...arguments),this.transformWorldFromModelRS=ts(),this.transformWorldFromModelTH=C(),this.transformWorldFromModelTL=C()}};function J1(t){t.varyings.add("linearDepth","float")}function BT(t){t.vertex.uniforms.add(new Pr("nearFar",(e,r)=>r.camera.nearFar))}function l8(t){t.vertex.code.add(w`float calculateLinearDepth(vec2 nearFar,float z) {
return (-z - nearFar[0]) / (nearFar[1] - nearFar[0]);
}`)}function TO(t,e){const{vertex:r}=t;switch(e.output){case k.Color:if(e.receiveShadows)return J1(t),void r.code.add(w`void forwardLinearDepth() { linearDepth = gl_Position.w; }`);break;case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:return t.include(NC,e),J1(t),BT(t),l8(t),void r.code.add(w`void forwardLinearDepth() {
linearDepth = calculateLinearDepth(nearFar, vPosition_view.z);
}`)}r.code.add(w`void forwardLinearDepth() {}`)}function _c(t){l8(t),t.vertex.code.add(w`vec4 transformPositionWithDepth(mat4 proj, mat4 view, vec3 pos, vec2 nearFar, out float depth) {
vec4 eye = view * vec4(pos, 1.0);
depth = calculateLinearDepth(nearFar,eye.z);
return proj * eye;
}`),t.vertex.code.add(w`vec4 transformPosition(mat4 proj, mat4 view, vec3 pos) {
return proj * (view * vec4(pos, 1.0));
}`)}let Wte=class extends ui{constructor(){super(...arguments),this.texV=Pe(),this.altitudeFade=0,this.innerScale=0,this.undergroundFadeAlpha=0,this.silhouette=new V3e}},V3e=class{constructor(){this.center=C(),this.v1=C(),this.v2=C()}};function $dt(t){const e=new Cr,{vertex:r,fragment:i}=e;if(G0(r),t.geometry===Cg.Underground)e.attributes.add(E.POSITION,"vec2"),e.varyings.add("color","vec4"),r.uniforms.add(new jt("cameraPosition",(s,n)=>n.camera.eye),new Ie("undergroundFadeAlpha",s=>s.undergroundFadeAlpha)),r.code.add(w`void main(void) {
float ndotl = dot(normalize(cameraPosition), mainLightDirection);
float lighting = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));
color = vec4(vec3(lighting), undergroundFadeAlpha);
gl_Position = vec4(position.xy, 1.0, 1.0);
}`),i.code.add(w`void main() {
fragColor = color;
}`);else{e.include(_c,t),e.attributes.add(E.POSITION,"vec3"),e.varyings.add("vtc","vec2"),e.varyings.add("falloff","float");const s=t.geometry===Cg.Cylinder;r.uniforms.add(new es("proj",(a,l)=>l.camera.projectionMatrix),new es("view",(a,l)=>l.camera.viewMatrix)),s||(e.varyings.add("innerFactor","float"),r.uniforms.add(new jt("silCircleCenter",a=>a.silhouette.center)),r.uniforms.add(new jt("silCircleV1",a=>a.silhouette.v1)),r.uniforms.add(new jt("silCircleV2",a=>a.silhouette.v2)),r.uniforms.add(new Pr("texV",a=>a.texV)),r.uniforms.add(new Ie("innerScale",a=>a.innerScale)));const n=6.2831853,o=1/128;r.code.add(w`
		void main(void) {
      ${s?w`
      vec3 pos = position;
      float ndotl = mainLightDirection.z;
      vtc = vec2(0.0, position.z + 0.05);`:w`
      innerFactor = clamp(-position.z, 0.0, 1.0);
      float scale = position.y * (1.0 + innerFactor * innerScale);
      float phi = position.x * ${w.float(n*o)} + 1.0;
      vec3 pos =  (silCircleCenter + sin(phi) * silCircleV1 + cos(phi) * silCircleV2) * scale;
      float ndotl = dot(normalize(position.y > 0.0 ? pos: silCircleCenter), mainLightDirection);
      vtc.x = position.x  * ${w.float(o)};
      vtc.y = texV.x * (1.0 - position.z) + texV.y * position.z;
      `}
      falloff = max(0.0, smoothstep(-1.0, 0.8, 2.0 * ndotl));

		  gl_Position = transformPosition(proj, view, pos);
		  gl_Position.z = gl_Position.w; // project atmosphere onto the far plane
    }
	  `),i.uniforms.add(new et("tex",a=>a.texture)),s||i.uniforms.add(new Ie("altitudeFade",a=>a.altitudeFade)),i.code.add(w`
		void main() {
			vec4 atmosphereColor = texture(tex, vtc) * falloff;
      ${s?w`fragColor = atmosphereColor;`:w`
			vec4 innerColor = vec4(atmosphereColor.rgb, 1.0 - altitudeFade);
			fragColor = mix(atmosphereColor, innerColor, smoothstep(0.0, 1.0, innerFactor));
      `}
    }`)}return e}const Ldt=Object.freeze(Object.defineProperty({__proto__:null,SilhouetteCircle:V3e,SimpleAtmospherePassParameters:Wte,build:$dt},Symbol.toStringTag,{value:"Module"}));let vU=class z3e extends Ur{initializeProgram(e){return new Lr(e.rctx,z3e.shader.get().build(this.configuration),Er)}initializePipeline(){return this.configuration.geometry===Cg.Cylinder?It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),culling:Dte,depthTest:{func:ci.LEQUAL},colorWrite:Wt}):It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};vU.shader=new $r(Ldt,()=>J(()=>import("./SimpleAtmosphere.glsl-f6320e49.js"),[],import.meta.url));const Ddt=new Uint8ClampedArray([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,0,0,0,15,16,0,0,16,16,0,0,16,16,0,0,16,16,0,0,16,15,0,0,17,15,0,0,17,15,0,0,17,15,0,0,17,14,0,0,18,14,0,0,18,14,0,0,18,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,19,13,0,0,20,13,0,0,20,13,0,0,20,13,0,0,20,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,21,12,0,0,22,12,0,0,22,12,0,0,22,12,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,27,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,28,18,0,0,29,18,0,0,29,18,0,0,29,17,0,0,30,17,0,0,30,17,0,0,30,17,0,0,30,16,0,0,31,16,0,0,31,16,0,0,31,16,0,0,32,16,0,0,32,16,0,0,32,15,0,0,33,15,0,0,33,15,0,0,33,15,0,0,34,15,8,0,34,15,8,0,34,15,8,0,34,15,7,0,35,15,7,0,35,15,7,0,35,21,7,0,36,21,7,0,36,21,7,0,36,21,7,0,37,21,7,0,37,21,7,0,37,20,7,0,38,20,7,0,38,20,7,0,38,20,7,0,39,20,7,0,39,20,7,0,39,20,7,0,39,19,6,0,40,19,6,0,40,19,6,0,40,19,6,0,41,19,6,0,41,19,6,0,41,18,6,0,42,18,6,0,42,18,6,0,42,24,6,0,43,24,6,0,43,24,6,0,43,23,6,0,44,23,6,0,44,23,6,0,44,23,6,0,45,23,6,0,45,23,6,0,45,22,6,0,46,22,6,0,46,22,6,0,46,22,5,0,47,22,5,0,47,22,5,0,47,21,5,0,48,21,5,0,48,21,5,0,48,21,5,0,49,21,5,0,49,26,5,0,49,25,5,0,50,25,5,0,50,25,5,0,50,25,5,0,51,25,5,0,51,25,5,0,51,25,5,0,52,25,5,0,52,25,5,0,52,24,5,0,53,24,5,0,53,24,5,0,53,24,9,0,54,28,9,0,54,28,9,0,54,28,9,0,55,28,9,0,55,27,9,0,56,27,9,0,56,27,9,0,56,27,9,4,57,27,9,4,57,27,9,4,57,26,9,4,58,26,9,4,58,26,9,4,58,26,9,4,59,26,9,4,59,26,9,4,59,26,8,4,60,30,8,4,60,30,8,4,60,29,8,4,61,29,8,4,61,29,8,4,62,29,8,4,62,29,8,4,62,28,8,4,63,28,8,4,63,28,8,4,63,28,12,4,64,28,12,4,64,28,12,4,64,27,12,4,65,27,12,8,65,27,12,8,65,31,12,8,66,31,12,8,66,30,11,8,67,30,11,8,67,30,11,8,67,30,11,8,68,30,11,8,68,30,11,8,68,30,15,7,69,30,15,7,69,30,15,7,69,33,15,11,70,33,15,11,70,32,14,11,71,32,14,11,71,32,14,11,71,32,18,14,72,32,18,14,72,32,18,14,72,31,17,14,73,35,17,14,73,34,17,17,74,34,21,17,74,34,21,17,74,34,20,17,75,34,20,20,75,34,20,20,75,34,23,20,76,34,23,20,76,36,23,23,77,36,23,23,77,36,23,23,77,36,23,23,78,36,26,26,78,36,26,26,78,36,26,26,79,36,26,29,79,38,26,29,80,38,29,29,80,38,29,29,80,38,28,31,81,38,28,31,81,38,31,31,81,37,31,34,82,37,31,34,82,37,31,37,83,40,34,37,83,40,34,37,83,39,33,39,84,39,33,39,84,39,36,42,84,39,36,42,85,39,36,42,85,39,36,42,85,39,39,44,86,39,39,44,86,41,38,47,87,41,41,47,87,41,41,50,87,41,41,49,88,41,41,52,88,40,43,52,89,43,43,52,89,43,43,54,89,42,45,54,90,42,45,57,90,42,45,57,90,42,45,59,91,42,48,59,91,44,47,61,92,44,47,61,92,44,50,61,92,44,49,63,93,44,49,63,93,44,52,66,93,43,52,65,94,46,54,68,94,46,54,70,95,46,54,70,95,46,54,70,95,45,56,72,96,45,56,72,96,45,58,74,97,47,58,76,97,47,58,76,97,47,60,78,98,47,60,78,98,47,60,81,98,49,62,80,99,49,62,82,99,48,61,84,100,48,64,84,100,48,64,84,100,50,63,86,101,50,66,86,101,50,66,88,101,50,65,90,102,52,67,89,103,51,69,91,104,51,68,92,105,52,69,93,107,52,71,94,108,54,70,96,109,53,71,96,111,52,73,98,112,54,72,98,114,53,73,100,115,54,72,100,117,54,73,102,118,55,74,104,120,55,76,105,121,56,77,106,123,56,76,107,124,57,79,107,126,58,78,110,128,57,79,111,129,56,80,113,131,58,79,112,132,57,82,114,134,58,81,116,136,60,82,117,137,59,83,117,139,60,83,119,141,59,84,120,142,60,85,122,144,59,86,122,146,60,86,126,148,62,87,127,149,61,88,127,151,62,88,128,153,63,89,130,155,62,90,131,156,63,90,132,158,64,91,134,160,65,91,135,162,64,92,136,163,63,93,138,165,66,95,139,167,65,95,140,169,66,95,142,171,67,96,142,172,66,97,144,174,67,99,145,176,67,97,148,178,67,99,147,180,68,100,149,181,68,100,150,183,69,101,152,185,70,102,153,187,71,103,155,188,70,103,156,190,70,104,157,192,71,105,158,194,71,106,160,195,72,106,161,197,72,108,161,199,73,108,163,200,73,109,164,202,74,109,165,204,74,110,167,206,75,111,168,207,74,112,170,209,75,112,170,210,76,113,171,212,76,114,173,214,77,115,174,215,78,115,175,217,78,116,175,218,78,117,177,220,78,118,178,221,79,118,180,223,80,120,180,224,81,120,181,226,81,120,182,227,82,121,184,229,82,122,185,230,84,123,186,232,83,123,187,233,84,124,189,234,84,125,188,235,85,126,189,237,86,126,190,238,86,127,191,239,87,127,192,240,87,129,193,242,88,129,194,243,89,130,195,244,90,131,196,245,90,132,197,246,91,132,197,247,92,133,198,248,92,134,199,249,93,135,200,250,94,136,201,251,95,137,202,252,96,138,203,253,97,140,204,254,98,141,205,254,99,142,206,255,101,143,207,255,102,144,208,255,103,146,209,255,104,147,209,255,106,148,210,255,107,149,211,255,108,151,212,255,110,152,213,255,111,153,213,255,112,154,214,255,114,156,215,255,115,157,215,255,117,158,216,255,118,160,217,255,120,161,217,255,121,162,218,255,123,164,218,255,124,165,219,255,125,166,219,255,127,167,220,255,129,169,220,255,130,170,221,255,132,171,221,255,133,173,222,255,134,174,222,255,136,175,223,255,139,178,224,255,142,180,224,255,144,182,225,255,147,185,226,255,150,187,226,255,153,189,227,255,155,191,228,255,158,194,228,255,160,196,229,255,163,198,229,255,165,200,230,255,168,202,231,255,170,203,231,255,172,205,232,255,174,207,232,255,176,209,233,255,178,210,234,255,180,212,234,255,182,214,235,255,184,215,236,255,186,217,237,255,188,219,238,255,190,220,238,255,192,221,239,255,193,222,240,255,194,224,240,255,196,225,241,255,197,226,241,255,198,226,242,255,199,227,242,255,200,228,242,255,201,228,243,255,202,229,243,255,203,230,243,255,204,230,244,255,205,231,244,255,207,232,244,255,208,233,245,255,209,233,245,255,211,234,246,255,213,235,246,255,217,238,247,255,222,240,248,255,226,242,249,255,231,245,250,255,236,247,251,255,241,249,252,255,245,251,253,255,249,252,254,255,255,255,255,255]);function $u(t,e=0){const r=t.stride;return Array.from(t.fields.keys()).filter(i=>{const s=t.fields.get(i)?.optional;return!(s&&s.glPadding)}).map(i=>{const s=t.fields.get(i),n=s.constructor.ElementCount,o=Ndt(s.constructor.ElementType),a=s.offset,l=!(!s.optional||!s.optional.glNormalized);return new sa(i,n,o,a,r,l,e)})}function Ndt(t){const e=Fdt[t];if(e)return e;throw new Error("BufferType not supported in WebGL")}const Fdt={u8:rt.UNSIGNED_BYTE,u16:rt.UNSIGNED_SHORT,u32:rt.UNSIGNED_INT,i8:rt.BYTE,i16:rt.SHORT,i32:rt.INT,f32:rt.FLOAT};let Zte=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=9;const o=this.TypedArrayConstructor;s===void 0&&(s=9*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<9;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<9;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};Zte.ElementCount=9;let Xte=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=16;const o=this.TypedArrayConstructor;s===void 0&&(s=16*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)r[s]=this.typedBuffer[i++];return r}setMat(e,r){let i=e*this.typedBufferStride;for(let s=0;s<16;s++)this.typedBuffer[i++]=r[s]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;for(let l=0;l<16;++l)s[o++]=n[a++]}get buffer(){return this.typedBuffer.buffer}};Xte.ElementCount=16;let q0=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=1;const o=this.TypedArrayConstructor;s===void 0&&(s=o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.stride=s,this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride)}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}get(e){return this.typedBuffer[e*this.typedBufferStride]}set(e,r){this.typedBuffer[e*this.typedBufferStride]=r}get buffer(){return this.typedBuffer.buffer}};q0.ElementCount=1;let W0=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=2;const o=this.TypedArrayConstructor;s===void 0&&(s=2*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,hr(r,this.typedBuffer[e],this.typedBuffer[e+1])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e]=r[1]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e]=i}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};W0.ElementCount=2;let Z0=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.elementCount=3;const o=this.TypedArrayConstructor;s===void 0&&(s=3*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,ie(r,this.typedBuffer[e],this.typedBuffer[e+1],this.typedBuffer[e+2])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e]=r[2]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e]=s}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};Z0.ElementCount=3;let X0=class{constructor(e,r,i=0,s,n){this.TypedArrayConstructor=e,this.start=i,this.elementCount=4;const o=this.TypedArrayConstructor;s===void 0&&(s=4*o.BYTES_PER_ELEMENT);const a=r.byteLength===0?0:i;this.typedBuffer=n==null?new o(r,a):new o(r,a,(n-i)/o.BYTES_PER_ELEMENT),this.typedBufferStride=s/o.BYTES_PER_ELEMENT,this.count=Math.ceil(this.typedBuffer.length/this.typedBufferStride),this.stride=this.typedBufferStride*this.TypedArrayConstructor.BYTES_PER_ELEMENT}sliceBuffer(e,r,i=this.count-r){const s=this.typedBuffer.byteOffset+r*this.stride;return new e(this.buffer,s,this.stride,s+i*this.stride)}getVec(e,r){return e*=this.typedBufferStride,zi(r,this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e++],this.typedBuffer[e])}setVec(e,r){e*=this.typedBufferStride,this.typedBuffer[e++]=r[0],this.typedBuffer[e++]=r[1],this.typedBuffer[e++]=r[2],this.typedBuffer[e]=r[3]}get(e,r){return this.typedBuffer[e*this.typedBufferStride+r]}set(e,r,i){this.typedBuffer[e*this.typedBufferStride+r]=i}setValues(e,r,i,s,n){e*=this.typedBufferStride,this.typedBuffer[e++]=r,this.typedBuffer[e++]=i,this.typedBuffer[e++]=s,this.typedBuffer[e]=n}copyFrom(e,r,i){const s=this.typedBuffer,n=r.typedBuffer;let o=e*this.typedBufferStride,a=i*r.typedBufferStride;s[o++]=n[a++],s[o++]=n[a++],s[o++]=n[a++],s[o]=n[a]}get buffer(){return this.typedBuffer.buffer}};X0.ElementCount=4;let c8=class B3e extends q0{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}static fromTypedArray(e,r){return new B3e(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};c8.ElementType="f32";let fb=class dX extends W0{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(dX,e,r)}static fromTypedArray(e,r){return new dX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};fb.ElementType="f32";let zn=class pX extends Z0{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(pX,e,r)}static fromTypedArray(e,r){return new pX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};zn.ElementType="f32";let Ff=class fX extends X0{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(fX,e,r)}static fromTypedArray(e,r){return new fX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Ff.ElementType="f32";let Q1=class mX extends Zte{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(mX,e,r)}static fromTypedArray(e,r){return new mX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Q1.ElementType="f32";let Yte=class gX extends Zte{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(gX,e,r)}static fromTypedArray(e,r){return new gX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Yte.ElementType="f64";let Jte=class yX extends Xte{constructor(e,r=0,i,s){super(Float32Array,e,r,i,s),this.elementType="f32"}slice(e,r){return this.sliceBuffer(yX,e,r)}static fromTypedArray(e,r){return new yX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Jte.ElementType="f32";let mP=class _X extends Xte{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(_X,e,r)}static fromTypedArray(e,r){return new _X(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};mP.ElementType="f64";let Qte=class vX extends q0{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(vX,e,r)}static fromTypedArray(e,r){return new vX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Qte.ElementType="f64";let Kte=class bX extends W0{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(bX,e,r)}static fromTypedArray(e,r){return new bX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Kte.ElementType="f64";let Yd=class wX extends Z0{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(wX,e,r)}static fromTypedArray(e,r){return new wX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Yd.ElementType="f64";let u8=class xX extends X0{constructor(e,r=0,i,s){super(Float64Array,e,r,i,s),this.elementType="f64"}slice(e,r){return this.sliceBuffer(xX,e,r)}static fromTypedArray(e,r){return new xX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};u8.ElementType="f64";let IA=class TX extends q0{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(TX,e,r)}static fromTypedArray(e,r){return new TX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};IA.ElementType="u8";let h8=class SX extends W0{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(SX,e,r)}static fromTypedArray(e,r){return new SX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};h8.ElementType="u8";let d8=class EX extends Z0{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(EX,e,r)}static fromTypedArray(e,r){return new EX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};d8.ElementType="u8";let rl=class CX extends X0{constructor(e,r=0,i,s){super(Uint8Array,e,r,i,s),this.elementType="u8"}slice(e,r){return this.sliceBuffer(CX,e,r)}static fromTypedArray(e,r){return new CX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};rl.ElementType="u8";let p8=class AX extends q0{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(AX,e,r)}static fromTypedArray(e,r){return new AX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};p8.ElementType="u16";let ere=class OX extends W0{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(OX,e,r)}static fromTypedArray(e,r){return new OX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};ere.ElementType="u16";let f8=class RX extends Z0{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(RX,e,r)}static fromTypedArray(e,r){return new RX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};f8.ElementType="u16";let C$=class MX extends X0{constructor(e,r=0,i,s){super(Uint16Array,e,r,i,s),this.elementType="u16"}slice(e,r){return this.sliceBuffer(MX,e,r)}static fromTypedArray(e,r){return new MX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};C$.ElementType="u16";let m8=class IX extends q0{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(IX,e,r)}static fromTypedArray(e,r){return new IX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};m8.ElementType="u32";let tre=class PX extends W0{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(PX,e,r)}static fromTypedArray(e,r){return new PX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};tre.ElementType="u32";let G3e=class $X extends Z0{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer($X,e,r)}static fromTypedArray(e,r){return new $X(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};G3e.ElementType="u32";let j3e=class LX extends X0{constructor(e,r=0,i,s){super(Uint32Array,e,r,i,s),this.elementType="u32"}slice(e,r){return this.sliceBuffer(LX,e,r)}static fromTypedArray(e,r){return new LX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};j3e.ElementType="u32";let rre=class DX extends q0{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(DX,e,r)}static fromTypedArray(e,r){return new DX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};rre.ElementType="i8";let g8=class NX extends W0{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(NX,e,r)}static fromTypedArray(e,r){return new NX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};g8.ElementType="i8";let H3e=class FX extends Z0{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(FX,e,r)}static fromTypedArray(e,r){return new FX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};H3e.ElementType="i8";let q3e=class kX extends X0{constructor(e,r=0,i,s){super(Int8Array,e,r,i,s),this.elementType="i8"}slice(e,r){return this.sliceBuffer(kX,e,r)}static fromTypedArray(e,r){return new kX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};q3e.ElementType="i8";let W3e=class UX extends q0{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(UX,e,r)}static fromTypedArray(e,r){return new UX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};W3e.ElementType="i16";let A$=class VX extends W0{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(VX,e,r)}static fromTypedArray(e,r){return new VX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};A$.ElementType="i16";let Z3e=class zX extends Z0{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(zX,e,r)}static fromTypedArray(e,r){return new zX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Z3e.ElementType="i16";let X3e=class BX extends X0{constructor(e,r=0,i,s){super(Int16Array,e,r,i,s),this.elementType="i16"}slice(e,r){return this.sliceBuffer(BX,e,r)}static fromTypedArray(e,r){return new BX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};X3e.ElementType="i16";let Y3e=class GX extends q0{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(GX,e,r)}static fromTypedArray(e,r){return new GX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Y3e.ElementType="i32";let J3e=class jX extends W0{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(jX,e,r)}static fromTypedArray(e,r){return new jX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};J3e.ElementType="i32";let Q3e=class HX extends Z0{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(HX,e,r)}static fromTypedArray(e,r){return new HX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};Q3e.ElementType="i32";let K3e=class qX extends X0{constructor(e,r=0,i,s){super(Int32Array,e,r,i,s),this.elementType="i32"}slice(e,r){return this.sliceBuffer(qX,e,r)}static fromTypedArray(e,r){return new qX(e.buffer,e.byteOffset,r,e.byteOffset+e.byteLength)}};K3e.ElementType="i32";function Jue(t){switch(t){case"u8":case"i8":return 1;case"u16":case"i16":return 2;case"u32":case"i32":case"f32":return 4;case"f64":return 8}}let Que=class eMe{constructor(e,r){this.layout=e,this.buffer=typeof r=="number"?new ArrayBuffer(r*e.stride):r;for(const i of e.fields.keys()){const s=e.fields.get(i);this[i]=new s.constructor(this.buffer,s.offset,this.stride)}}get stride(){return this.layout.stride}get count(){return this.buffer.byteLength/this.stride}get byteLength(){return this.buffer.byteLength}getField(e,r){const i=this[e];return i&&i.elementCount===r.ElementCount&&i.elementType===r.ElementType?i:null}slice(e,r){return new eMe(this.layout,this.buffer.slice(e*this.stride,r*this.stride))}copyFrom(e,r=0,i=0,s=e.count){const n=this.stride;if(n%4==0){const o=new Uint32Array(e.buffer,r*n,s*n/4);new Uint32Array(this.buffer,i*n,s*n/4).set(o)}else{const o=new Uint8Array(e.buffer,r*n,s*n);new Uint8Array(this.buffer,i*n,s*n).set(o)}return this}},tMe=class rMe{constructor(e=null){this._stride=0,this._lastAligned=0,this._fields=new Map,e&&(this._stride=e.stride,e.fields.forEach(r=>this._fields.set(r[0],{...r[1],constructor:Vdt(r[1].constructor)})))}vec2f(e,r){return this._appendField(e,fb,r),this}vec2f64(e,r){return this._appendField(e,Kte,r),this}vec3f(e,r){return this._appendField(e,zn,r),this}vec3f64(e,r){return this._appendField(e,Yd,r),this}vec4f(e,r){return this._appendField(e,Ff,r),this}vec4f64(e,r){return this._appendField(e,u8,r),this}mat3f(e,r){return this._appendField(e,Q1,r),this}mat3f64(e,r){return this._appendField(e,Yte,r),this}mat4f(e,r){return this._appendField(e,Jte,r),this}mat4f64(e,r){return this._appendField(e,mP,r),this}vec4u8(e,r){return this._appendField(e,rl,r),this}f32(e,r){return this._appendField(e,c8,r),this}f64(e,r){return this._appendField(e,Qte,r),this}u8(e,r){return this._appendField(e,IA,r),this}u16(e,r){return this._appendField(e,p8,r),this}i8(e,r){return this._appendField(e,rre,r),this}vec2i8(e,r){return this._appendField(e,g8,r),this}vec2i16(e,r){return this._appendField(e,A$,r),this}vec2u8(e,r){return this._appendField(e,h8,r),this}vec4u16(e,r){return this._appendField(e,C$,r),this}u32(e,r){return this._appendField(e,m8,r),this}_appendField(e,r,i){if(this._fields.has(e))return void it(!1,`${e} already added to vertex buffer layout`);const s=r.ElementCount*Jue(r.ElementType),n=this._stride;this._stride+=s,this._fields.set(e,{size:s,constructor:r,offset:n,optional:i})}createBuffer(e){return new Que(this,e)}createView(e){return new Que(this,e)}clone(){const e=new rMe;return e._stride=this._stride,e._fields=new Map,this._fields.forEach((r,i)=>e._fields.set(i,r)),e.BufferType=this.BufferType,e}get stride(){if(this._lastAligned!==this._fields.size){let e=1;this._fields.forEach(r=>e=Math.max(e,Jue(r.constructor.ElementType))),this._stride=Math.floor((this._stride+e-1)/e)*e,this._lastAligned=this._fields.size}return this._stride}get fields(){return this._fields}};function us(){return new tMe}let kdt=class{constructor(e){this.fields=new Array,e.fields.forEach((r,i)=>{const s={...r,constructor:iMe(r.constructor)};this.fields.push([i,s])}),this.stride=e.stride}};const Udt=[c8,fb,zn,Ff,Q1,Jte,Qte,Kte,Yd,u8,Yte,mP,IA,h8,d8,rl,p8,ere,f8,C$,m8,tre,G3e,j3e,rre,g8,H3e,q3e,W3e,A$,Z3e,X3e,Y3e,J3e,Q3e,K3e];function iMe(t){return`${t.ElementType}_${t.ElementCount}`}function Vdt(t){return sMe.get(t)}const sMe=new Map;Udt.forEach(t=>sMe.set(iMe(t),t));function Ra(t,e=!1){return t<=wh?e?new Array(t).fill(0):new Array(t):new Float64Array(t)}function nMe(t){return(Cf(t)?t.length:t.byteLength/8)<=wh?Array.from(t):new Float64Array(t)}function Fd(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function cBt(t,e){for(let r=0;r<e.length;++r)t[r]=e[r];return t}function uBt(t){return Array.isArray(t)?new Float64Array(t):t}function vs(t,e=!1){return t<=wh?e?new Array(t).fill(0):new Array(t):new Float32Array(t)}function hBt(t){return Cf(t)?t.length<wh?t:new Float32Array(t):t.length<wh?Array.from(t):t}function Kue(t){return(Cf(t)?t.length:t.byteLength/8)<=wh?Array.from(t):new Float32Array(t)}function bU(t,e,r){return Array.isArray(t)?t.slice(e,e+r):t.subarray(e,e+r)}function cg(t){return Cf(t)?t.length<wh?t:ehe(t):t.length<wh?Array.from(t):t.BYTES_PER_ELEMENT===Uint16Array.BYTES_PER_ELEMENT?t:ehe(t)}function ehe(t){let e=!0;for(const r of t){if(r>=65536)return Cf(t)?new Uint32Array(t):t;r>=256&&(e=!1)}return e?new Uint8Array(t):new Uint16Array(t)}function wU(t){return t<=wh?new Array(t):t<=65536?new Uint16Array(t):new Uint32Array(t)}function zdt(t){return t<=wh?new Array(t):new Uint32Array(t)}let qS=(()=>{const t=new Uint32Array(131072);for(let e=0;e<t.length;++e)t[e]=e;return t})();const oMe=[0],nB=(()=>{const t=new Uint16Array(65536);for(let e=0;e<t.length;++e)t[e]=e;return t})();function PA(t){if(t===1)return oMe;if(t<wh)return Array.from(new Uint16Array(nB.buffer,0,t));if(t<nB.length)return new Uint16Array(nB.buffer,0,t);if(t>qS.length){const e=Math.max(2*qS.length,t);qS=new Uint32Array(e);for(let r=0;r<qS.length;r++)qS[r]=r}return new Uint32Array(qS.buffer,0,t)}let TD=new Uint8Array(65536);function SO(t){if(t===1)return oMe;if(t<wh)return new Array(t).fill(0);if(t>TD.length){const e=Math.max(2*TD.length,t);TD=new Uint8Array(e)}return new Uint8Array(TD.buffer,0,t)}var WX;(function(t){function e(o,a){const l=o[a],c=o[a+1],h=o[a+2];return Math.sqrt(l*l+c*c+h*h)}function r(o,a){const l=o[a],c=o[a+1],h=o[a+2],p=1/Math.sqrt(l*l+c*c+h*h);o[a]*=p,o[a+1]*=p,o[a+2]*=p}function i(o,a,l){o[a]*=l,o[a+1]*=l,o[a+2]*=l}function s(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]+l[c],h[p+1]=o[a+1]+l[c+1],h[p+2]=o[a+2]+l[c+2]}function n(o,a,l,c,h,p=a){(h=h||o)[p]=o[a]-l[c],h[p+1]=o[a+1]-l[c+1],h[p+2]=o[a+2]-l[c+2]}t.length=e,t.normalize=r,t.scale=i,t.add=s,t.subtract=n})(WX||(WX={}));var Ms;(function(t){t[t.Layer=0]="Layer",t[t.Object=1]="Object",t[t.Mesh=2]="Mesh",t[t.Line=3]="Line",t[t.Point=4]="Point",t[t.Material=5]="Material",t[t.Texture=6]="Texture",t[t.COUNT=7]="COUNT"})(Ms||(Ms={}));function Bdt(t){if(t.length<wh)return Array.from(t);if(Cf(t))return Float64Array.from(t);if(!("BYTES_PER_ELEMENT"in t))return Array.from(t);switch(t.BYTES_PER_ELEMENT){case 1:return Uint8Array.from(t);case 2:return x6(t)?Uint16Array.from(t):Int16Array.from(t);case 4:return Float32Array.from(t);default:return Float64Array.from(t)}}let aMe=class lMe{constructor(e,r,i,s){this.primitiveIndices=e,this._numIndexPerPrimitive=r,this.indices=i,this.position=s,this._children=void 0,it(e.length>=1),it(i.length%this._numIndexPerPrimitive==0),it(i.length>=e.length*this._numIndexPerPrimitive),it(s.size===3||s.size===4);const{data:n,size:o}=s,a=e.length;let l=o*i[this._numIndexPerPrimitive*e[0]];Pb.clear(),Pb.push(l);const c=Ee(n[l],n[l+1],n[l+2]),h=$i(c);for(let m=0;m<a;++m){const g=this._numIndexPerPrimitive*e[m];for(let _=0;_<this._numIndexPerPrimitive;++_){l=o*i[g+_],Pb.push(l);let v=n[l];c[0]=Math.min(v,c[0]),h[0]=Math.max(v,h[0]),v=n[l+1],c[1]=Math.min(v,c[1]),h[1]=Math.max(v,h[1]),v=n[l+2],c[2]=Math.min(v,c[2]),h[2]=Math.max(v,h[2])}}this.bbMin=c,this.bbMax=h;const p=Wr(C(),this.bbMin,this.bbMax,.5);this.radius=.5*Math.max(Math.max(h[0]-c[0],h[1]-c[1]),h[2]-c[2]);let f=this.radius*this.radius;for(let m=0;m<Pb.length;++m){l=Pb.at(m);const g=n[l]-p[0],_=n[l+1]-p[1],v=n[l+2]-p[2],b=g*g+_*_+v*v;if(b<=f)continue;const x=Math.sqrt(b),T=.5*(x-this.radius);this.radius=this.radius+T,f=this.radius*this.radius;const S=T/x;p[0]+=g*S,p[1]+=_*S,p[2]+=v*S}this.center=p,Pb.clear()}getChildren(){if(this._children||kn(this.bbMin,this.bbMax)<=1)return this._children;const e=Wr(C(),this.bbMin,this.bbMax,.5),r=this.primitiveIndices.length,i=new Uint8Array(r),s=new Array(8);for(let c=0;c<8;++c)s[c]=0;const{data:n,size:o}=this.position;for(let c=0;c<r;++c){let h=0;const p=this._numIndexPerPrimitive*this.primitiveIndices[c];let f=o*this.indices[p],m=n[f],g=n[f+1],_=n[f+2];for(let v=1;v<this._numIndexPerPrimitive;++v){f=o*this.indices[p+v];const b=n[f],x=n[f+1],T=n[f+2];b<m&&(m=b),x<g&&(g=x),T<_&&(_=T)}m<e[0]&&(h|=1),g<e[1]&&(h|=2),_<e[2]&&(h|=4),i[c]=h,++s[h]}let a=0;for(let c=0;c<8;++c)s[c]>0&&++a;if(a<2)return;const l=new Array(8);for(let c=0;c<8;++c)l[c]=s[c]>0?new Uint32Array(s[c]):void 0;for(let c=0;c<8;++c)s[c]=0;for(let c=0;c<r;++c){const h=i[c];l[h][s[h]++]=this.primitiveIndices[c]}this._children=new Array;for(let c=0;c<8;++c)l[c]!==void 0&&this._children.push(new lMe(l[c],this._numIndexPerPrimitive,this.indices,this.position));return this._children}static prune(){Pb.prune()}};const Pb=new qt({deallocator:null});let O$=class{constructor(){this.id=vc()}unload(){}};function Gdt(t){return t?{p0:$i(t.p0),p1:$i(t.p1),p2:$i(t.p2)}:{p0:C(),p1:C(),p2:C()}}function the(t,e,r){const i=e[0]-t[0],s=e[1]-t[1],n=r[0]-t[0],o=r[1]-t[1];return .5*Math.abs(i*o-s*n)}function jdt(t,e,r){return pe(oB,e,t),pe(rhe,r,t),Oe(st(oB,oB,rhe))/2}new z0(Vf);new z0(()=>Gdt());const oB=C(),rhe=C();function Hdt(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ie(r,0,0,0),ie(md,0,0,0);let n=0,o=0;for(let a=0;a<e.length-2;a+=3){const l=e[a]*i,c=e[a+1]*i,h=e[a+2]*i;ie(Ao,s[l],s[l+1],s[l+2]),ie(Qy,s[c],s[c+1],s[c+2]),ie(SD,s[h],s[h+1],s[h+2]);const p=jdt(Ao,Qy,SD);p?(ue(Ao,Ao,Qy),ue(Ao,Ao,SD),ae(Ao,Ao,1/3*p),ue(r,r,Ao),n+=p):(ue(md,md,Ao),ue(md,md,Qy),ue(md,md,SD),o+=3)}return(o!==0||n!==0)&&(n!==0?(ae(r,r,1/n),!0):o!==0&&(ae(r,md,1/o),!0))}function qdt(t,e,r){if(!t||!e)return!1;const{size:i,data:s}=t;ie(r,0,0,0);let n=-1,o=0;for(let a=0;a<e.length;a++){const l=e[a]*i;n!==l&&(r[0]+=s[l],r[1]+=s[l+1],r[2]+=s[l+2],o++),n=l}return o>1&&ae(r,r,1/o),o>0}function Wdt(t,e,r,i){if(!t)return!1;ie(i,0,0,0),ie(md,0,0,0);let s=0,n=0;const{size:o,data:a}=t,l=e?e.length-1:a.length/o-1,c=l+(r?2:0);for(let h=0;h<c;h+=2){const p=h<l?h:l,f=h<l?h+1:0,m=(e?e[p]:p)*o,g=(e?e[f]:f)*o;Ao[0]=a[m],Ao[1]=a[m+1],Ao[2]=a[m+2],Qy[0]=a[g],Qy[1]=a[g+1],Qy[2]=a[g+2],ae(Ao,ue(Ao,Ao,Qy),.5);const _=YP(Ao,Qy);_>0?(ue(i,i,ae(Ao,Ao,_)),s+=_):s===0&&(ue(md,md,Ao),n++)}return s!==0?(ae(i,i,1/s),!0):n!==0&&(ae(i,md,1/n),!0)}const Ao=C(),Qy=C(),SD=C(),md=C();let xU=class{constructor(e){this.channel=e,this.id=vc()}};function ZX(t,e,r){for(let i=0;i<r;++i)e[2*i]=t[i],e[2*i+1]=t[i]-e[2*i]}function Zdt(t,e){const r=t.length;for(let i=0;i<r;++i)nC[0]=t[i],e[i]=nC[0];return e}function Xdt(t,e){const r=t.length;for(let i=0;i<r;++i)nC[0]=t[i],nC[1]=t[i]-nC[0],e[i]=nC[1];return e}const nC=new Float32Array(2);function XX(t,e){return t==null&&(t=[]),t.push(e),t}function YX(t,e){if(t==null)return null;const r=t.filter(i=>i!==e);return r.length===0?null:r}function Ydt(t,e,r,i,s){ED[0]=t.get(e,0),ED[1]=t.get(e,1),ED[2]=t.get(e,2),ZX(ED,$b,3),r.set(s,0,$b[0]),i.set(s,0,$b[1]),r.set(s,1,$b[2]),i.set(s,1,$b[3]),r.set(s,2,$b[4]),i.set(s,2,$b[5])}const ED=C(),$b=new Float32Array(6);let mn=class cMe extends O${constructor(e,r,i=[],s=null,n=Ms.Mesh,o=null,a=-1){super(),this.material=e,this.mapPositions=s,this.type=n,this.objectAndLayerIdColor=o,this.edgeIndicesLength=a,this.visible=!0,this._vertexAttributes=new Map,this._indices=new Map,this._boundingInfo=null;for(const[l,c]of r)c&&this._vertexAttributes.set(l,{...c});if(i==null||i.length===0){const l=Jdt(this._vertexAttributes),c=PA(l);this.edgeIndicesLength=this.edgeIndicesLength<0?l:this.edgeIndicesLength;for(const h of this._vertexAttributes.keys())this._indices.set(h,c)}else for(const[l,c]of i)c&&(this._indices.set(l,cg(c)),l===E.POSITION&&(this.edgeIndicesLength=this.edgeIndicesLength<0?this._indices.get(l).length:this.edgeIndicesLength))}instantiate(e={}){const r=new cMe(e.material||this.material,[],void 0,this.mapPositions,this.type,this.objectAndLayerIdColor,this.edgeIndicesLength);return this._vertexAttributes.forEach((i,s)=>{i.exclusive=!1,r._vertexAttributes.set(s,i)}),this._indices.forEach((i,s)=>r._indices.set(s,i)),r._boundingInfo=this._boundingInfo,r.transformation=e.transformation||this.transformation,r}get vertexAttributes(){return this._vertexAttributes}getMutableAttribute(e){let r=this._vertexAttributes.get(e);return r&&!r.exclusive&&(r={...r,exclusive:!0,data:Bdt(r.data)},this._vertexAttributes.set(e,r)),r}setAttributeData(e,r){const i=this._vertexAttributes.get(e);i&&this._vertexAttributes.set(e,{...i,exclusive:!0,data:r})}get indices(){return this._indices}get indexCount(){const e=this._indices.values().next().value;return e?e.length:0}get faceCount(){return this.indexCount/3}get boundingInfo(){return this._boundingInfo==null&&(this._boundingInfo=this._calculateBoundingInfo()),this._boundingInfo}computeAttachmentOrigin(e){return!!(this.type===Ms.Mesh?this._computeAttachmentOriginTriangles(e):this.type===Ms.Line?this._computeAttachmentOriginLines(e):this._computeAttachmentOriginPoints(e))&&(this._transformation!=null&&Ne(e,e,this._transformation),!0)}_computeAttachmentOriginTriangles(e){const r=this.indices.get(E.POSITION),i=this.vertexAttributes.get(E.POSITION);return Hdt(i,r,e)}_computeAttachmentOriginLines(e){const r=this.vertexAttributes.get(E.POSITION),i=this.indices.get(E.POSITION);return Wdt(r,i,i&&Qdt(this.material.parameters,r,i),e)}_computeAttachmentOriginPoints(e){const r=this.indices.get(E.POSITION),i=this.vertexAttributes.get(E.POSITION);return qdt(i,r,e)}invalidateBoundingInfo(){this._boundingInfo=null}_calculateBoundingInfo(){const e=this.indices.get(E.POSITION),r=this.vertexAttributes.get(E.POSITION);if(!e||e.length===0||!r)return null;const i=this.type===Ms.Mesh?3:1;it(e.length%i==0,"Indexing error: "+e.length+" not divisible by "+i);const s=PA(e.length/i);return new aMe(s,i,e,r)}get transformation(){return this._transformation??Un}set transformation(e){this._transformation=e&&e!==Un?xA(e):null}get shaderTransformation(){return this._shaderTransformer!=null?this._shaderTransformer(this.transformation):this.transformation}get shaderTransformer(){return this._shaderTransformer}set shaderTransformer(e){this._shaderTransformer=e}get hasVolatileTransformation(){return this._shaderTransformer!=null}addHighlight(){const e=new xU($0.Highlight);return this.highlights=XX(this.highlights,e),e}removeHighlight(e){this.highlights=YX(this.highlights,e)}};function Jdt(t){const e=t.values().next().value;return e==null?0:e.data.length/e.size}function Qdt(t,e,r){return!(!("isClosed"in t)||!t.isClosed)&&(r?r.length>2:e.data.length>6)}const WS=WX,aB=[[-.5,-.5,.5],[.5,-.5,.5],[.5,.5,.5],[-.5,.5,.5],[-.5,-.5,-.5],[.5,-.5,-.5],[.5,.5,-.5],[-.5,.5,-.5]],Kdt=[0,0,1,-1,0,0,1,0,0,0,-1,0,0,1,0,0,0,-1],ept=[0,0,1,0,1,1,0,1],tpt=[0,1,2,2,3,0,4,0,3,3,7,4,1,5,6,6,2,1,1,0,4,4,5,1,3,2,6,6,7,3,5,4,7,7,6,5],uMe=new Array(36);for(let t=0;t<6;t++)for(let e=0;e<6;e++)uMe[6*t+e]=t;const nx=new Array(36);for(let t=0;t<6;t++)nx[6*t]=0,nx[6*t+1]=1,nx[6*t+2]=2,nx[6*t+3]=2,nx[6*t+4]=3,nx[6*t+5]=0;function rpt(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(24);for(let i=0;i<8;i++)r[3*i]=aB[i][0]*e[0],r[3*i+1]=aB[i][1]*e[1],r[3*i+2]=aB[i][2]*e[2];return new mn(t,[[E.POSITION,new Ge(r,3,!0)],[E.NORMAL,new Ge(Kdt,3)],[E.UV0,new Ge(ept,2)]],[[E.POSITION,tpt],[E.NORMAL,uMe],[E.UV0,nx]])}const lB=[[-.5,0,-.5],[.5,0,-.5],[.5,0,.5],[-.5,0,.5],[0,-.5,0],[0,.5,0]],ipt=[0,1,-1,1,1,0,0,1,1,-1,1,0,0,-1,-1,1,-1,0,0,-1,1,-1,-1,0],spt=[5,1,0,5,2,1,5,3,2,5,0,3,4,0,1,4,1,2,4,2,3,4,3,0],npt=[0,0,0,1,1,1,2,2,2,3,3,3,4,4,4,5,5,5,6,6,6,7,7,7];function opt(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(18);for(let i=0;i<6;i++)r[3*i]=lB[i][0]*e[0],r[3*i+1]=lB[i][1]*e[1],r[3*i+2]=lB[i][2]*e[2];return new mn(t,[[E.POSITION,new Ge(r,3,!0)],[E.NORMAL,new Ge(ipt,3)]],[[E.POSITION,spt],[E.NORMAL,npt]])}const J4=si(-.5,0,-.5),Q4=si(.5,0,-.5),K4=si(0,0,.5),e5=si(0,.5,0),ZS=gs(),XS=gs(),FC=gs(),kC=gs(),UC=gs();pe(ZS,J4,e5),pe(XS,J4,Q4),st(FC,ZS,XS),_e(FC,FC),pe(ZS,Q4,e5),pe(XS,Q4,K4),st(kC,ZS,XS),_e(kC,kC),pe(ZS,K4,e5),pe(XS,K4,J4),st(UC,ZS,XS),_e(UC,UC);const cB=[J4,Q4,K4,e5],apt=[0,-1,0,FC[0],FC[1],FC[2],kC[0],kC[1],kC[2],UC[0],UC[1],UC[2]],lpt=[0,1,2,3,1,0,3,2,1,3,0,2],cpt=[0,0,0,1,1,1,2,2,2,3,3,3];function upt(t,e){Array.isArray(e)||(e=[e,e,e]);const r=new Array(12);for(let i=0;i<4;i++)r[3*i]=cB[i][0]*e[0],r[3*i+1]=cB[i][1]*e[1],r[3*i+2]=cB[i][2]*e[2];return new mn(t,[[E.POSITION,new Ge(r,3,!0)],[E.NORMAL,new Ge(apt,3)]],[[E.POSITION,lpt],[E.NORMAL,cpt]])}function fBt(t,e,r,i,s={uv:!0}){const n=-Math.PI,o=2*Math.PI,a=-Math.PI/2,l=Math.PI,c=Math.max(3,Math.floor(r)),h=Math.max(2,Math.floor(i)),p=(c+1)*(h+1),f=vs(3*p),m=vs(3*p),g=vs(2*p),_=[];let v=0;for(let S=0;S<=h;S++){const O=[],A=S/h,M=a+A*l,P=Math.cos(M);for(let F=0;F<=c;F++){const $=F/c,N=n+$*o,U=Math.cos(N)*P,X=Math.sin(M),Z=-Math.sin(N)*P;f[3*v]=U*e,f[3*v+1]=X*e,f[3*v+2]=Z*e,m[3*v]=U,m[3*v+1]=X,m[3*v+2]=Z,g[2*v]=$,g[2*v+1]=A,O.push(v),++v}_.push(O)}const b=new Array;for(let S=0;S<h;S++)for(let O=0;O<c;O++){const A=_[S][O],M=_[S][O+1],P=_[S+1][O+1],F=_[S+1][O];S===0?(b.push(A),b.push(P),b.push(F)):S===h-1?(b.push(A),b.push(M),b.push(P)):(b.push(A),b.push(M),b.push(P),b.push(P),b.push(F),b.push(A))}const x=[[E.POSITION,b],[E.NORMAL,b]],T=[[E.POSITION,new Ge(f,3,!0)],[E.NORMAL,new Ge(m,3,!0)]];return s.uv&&(T.push([E.UV0,new Ge(g,2,!0)]),x.push([E.UV0,b])),s.offset&&(x[0][0]=E.OFFSET,T[0][0]=E.OFFSET,x.push([E.POSITION,SO(b.length)]),T.push([E.POSITION,new Ge(Float64Array.from(s.offset),3,!0)])),new mn(t,T,x)}function hpt(t,e,r,i){const{vertexAttributes:s,indices:n}=hMe(e,r,i);return new mn(t,s,n)}function hMe(t,e,r){const i=t;let s,n;if(r)s=[0,-1,0,1,0,0,0,0,1,-1,0,0,0,0,-1,0,1,0],n=[0,1,2,0,2,3,0,3,4,0,4,1,1,5,2,2,5,3,3,5,4,4,5,1];else{const h=i*(1+Math.sqrt(5))/2;s=[-i,h,0,i,h,0,-i,-h,0,i,-h,0,0,-i,h,0,i,h,0,-i,-h,0,i,-h,h,0,-i,h,0,i,-h,0,-i,-h,0,i],n=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1]}for(let h=0;h<s.length;h+=3)WS.scale(s,h,t/WS.length(s,h));let o={};function a(h,p){h>p&&([h,p]=[p,h]);const f=h.toString()+"."+p.toString();if(o[f])return o[f];let m=s.length;return s.length+=3,WS.add(s,3*h,s,3*p,s,m),WS.scale(s,m,t/WS.length(s,m)),m/=3,o[f]=m,m}for(let h=0;h<e;h++){const p=n.length,f=new Array(4*p);for(let m=0;m<p;m+=3){const g=n[m],_=n[m+1],v=n[m+2],b=a(g,_),x=a(_,v),T=a(v,g),S=4*m;f[S]=g,f[S+1]=b,f[S+2]=T,f[S+3]=_,f[S+4]=x,f[S+5]=b,f[S+6]=v,f[S+7]=T,f[S+8]=x,f[S+9]=b,f[S+10]=x,f[S+11]=T}n=f,o={}}const l=Kue(s);for(let h=0;h<l.length;h+=3)WS.normalize(l,h);const c=[[E.POSITION,n],[E.NORMAL,n]];return{vertexAttributes:[[E.POSITION,new Ge(Kue(s),3,!0)],[E.NORMAL,new Ge(l,3,!0)]],indices:c}}function JX(t,e,r,i,s,n,o,a,l=null){const c=r?[r[0],r[1],r[2]]:[0,0,0],h=e?[e[0],e[1],e[2]]:[0,0,1];o=o||[0,0];const p=i?[255*i[0],255*i[1],255*i[2],i.length>3?255*i[3]:255]:[255,255,255,255],f=s!=null&&s.length===2?s:[1,1],m=[[E.POSITION,new Ge(c,3,!0)],[E.NORMAL,new Ge(h,3,!0)],[E.UV0,new Ge(o,o.length)],[E.COLOR,new Ge(p,4,!0)],[E.SIZE,new Ge(f,2)]];if(n!=null){const g=[n[0],n[1],n[2],n[3]];m.push([E.AUXPOS1,new Ge(g,4)])}if(a!=null){const g=[a[0],a[1],a[2],a[3]];m.push([E.AUXPOS2,new Ge(g,4)])}return new mn(t,m,null,null,Ms.Point,l)}const dpt=[[-1,-1,0],[1,-1,0],[1,1,0],[-1,1,0]];function mBt(t,e=dpt){const r=new Array(12);for(let h=0;h<4;h++)for(let p=0;p<3;p++)r[3*h+p]=e[h][p];const i=[0,1,2,2,3,0],s=[0,0,1],n=[0,0,0,0,0,0],o=[0,0,1,0,1,1,0,1],a=[255,255,255,255],l=[[E.POSITION,i],[E.NORMAL,n],[E.UV0,i],[E.COLOR,n]],c=[[E.POSITION,new Ge(r,3,!0)],[E.NORMAL,new Ge(s,3,!0)],[E.UV0,new Ge(o,2,!0)],[E.COLOR,new Ge(a,4,!0)]];return new mn(t,c,l)}function ihe(t,e,r,i,s,n=!0,o=!0){let a=0;const l=r,c=e;let h=si(0,a,0),p=si(0,a+c,0),f=si(0,-1,0),m=si(0,1,0);s&&(a=c,p=si(0,0,0),h=si(0,a,0),f=si(0,1,0),m=si(0,-1,0));const g=[p,h],_=[f,m],v=i+2,b=Math.sqrt(c*c+l*l);if(s)for(let P=i-1;P>=0;P--){const F=P*(2*Math.PI/i),$=si(Math.cos(F)*l,a,Math.sin(F)*l);g.push($);const N=si(c*Math.cos(F)/b,-l/b,c*Math.sin(F)/b);_.push(N)}else for(let P=0;P<i;P++){const F=P*(2*Math.PI/i),$=si(Math.cos(F)*l,a,Math.sin(F)*l);g.push($);const N=si(c*Math.cos(F)/b,l/b,c*Math.sin(F)/b);_.push(N)}const x=new Array,T=new Array;if(n){for(let P=3;P<g.length;P++)x.push(1),x.push(P-1),x.push(P),T.push(0),T.push(0),T.push(0);x.push(g.length-1),x.push(2),x.push(1),T.push(0),T.push(0),T.push(0)}if(o){for(let P=3;P<g.length;P++)x.push(P),x.push(P-1),x.push(0),T.push(P),T.push(P-1),T.push(1);x.push(0),x.push(2),x.push(g.length-1),T.push(1),T.push(2),T.push(_.length-1)}const S=vs(3*v);for(let P=0;P<v;P++)S[3*P]=g[P][0],S[3*P+1]=g[P][1],S[3*P+2]=g[P][2];const O=vs(3*v);for(let P=0;P<v;P++)O[3*P]=_[P][0],O[3*P+1]=_[P][1],O[3*P+2]=_[P][2];const A=[[E.POSITION,x],[E.NORMAL,T]],M=[[E.POSITION,new Ge(S,3,!0)],[E.NORMAL,new Ge(O,3,!0)]];return new mn(t,M,A)}function ppt(t,e,r,i,s,n,o){const a=s?aU(s):si(1,0,0),l=n?aU(n):si(0,0,0);o??(o=!0);const c=gs();_e(c,a);const h=gs();ae(h,c,Math.abs(e));const p=gs();ae(p,h,-.5),ue(p,p,l);const f=si(0,1,0);Math.abs(1-de(c,f))<.2&&ie(f,0,0,1);const m=gs();st(m,c,f),_e(m,m),st(f,m,c);const g=2*i+(o?2:0),_=i+(o?2:0),v=vs(3*g),b=vs(3*_),x=vs(2*g),T=new Array(3*i*(o?4:2)),S=new Array(3*i*(o?4:2));o&&(v[3*(g-2)]=p[0],v[3*(g-2)+1]=p[1],v[3*(g-2)+2]=p[2],x[2*(g-2)]=0,x[2*(g-2)+1]=0,v[3*(g-1)]=v[3*(g-2)]+h[0],v[3*(g-1)+1]=v[3*(g-2)+1]+h[1],v[3*(g-1)+2]=v[3*(g-2)+2]+h[2],x[2*(g-1)]=1,x[2*(g-1)+1]=1,b[3*(_-2)]=-c[0],b[3*(_-2)+1]=-c[1],b[3*(_-2)+2]=-c[2],b[3*(_-1)]=c[0],b[3*(_-1)+1]=c[1],b[3*(_-1)+2]=c[2]);const O=(N,U,X)=>{T[N]=U,S[N]=X};let A=0;const M=gs(),P=gs();for(let N=0;N<i;N++){const U=N*(2*Math.PI/i);ae(M,f,Math.sin(U)),ae(P,m,Math.cos(U)),ue(M,M,P),b[3*N]=M[0],b[3*N+1]=M[1],b[3*N+2]=M[2],ae(M,M,r),ue(M,M,p),v[3*N]=M[0],v[3*N+1]=M[1],v[3*N+2]=M[2],x[2*N]=N/i,x[2*N+1]=0,v[3*(N+i)]=v[3*N]+h[0],v[3*(N+i)+1]=v[3*N+1]+h[1],v[3*(N+i)+2]=v[3*N+2]+h[2],x[2*(N+i)]=N/i,x[2*N+1]=1;const X=(N+1)%i;O(A++,N,N),O(A++,N+i,N),O(A++,X,X),O(A++,X,X),O(A++,N+i,N),O(A++,X+i,X)}if(o){for(let N=0;N<i;N++){const U=(N+1)%i;O(A++,g-2,_-2),O(A++,N,_-2),O(A++,U,_-2)}for(let N=0;N<i;N++){const U=(N+1)%i;O(A++,N+i,_-1),O(A++,g-1,_-1),O(A++,U+i,_-1)}}const F=[[E.POSITION,T],[E.NORMAL,S],[E.UV0,T]],$=[[E.POSITION,new Ge(v,3,!0)],[E.NORMAL,new Ge(b,3,!0)],[E.UV0,new Ge(x,2,!0)]];return new mn(t,$,F)}function gBt(t,e,r,i,s,n){i=i||10,s=s==null||s,it(e.length>1);const o=[[0,0,0]],a=[],l=[];for(let c=0;c<i;c++){a.push([0,-c-1,-(c+1)%i-1]);const h=c/i*2*Math.PI;l.push([Math.cos(h)*r,Math.sin(h)*r])}return fpt(t,l,e,o,a,s,n)}function fpt(t,e,r,i,s,n,o=si(0,0,0)){const a=e.length,l=vs(r.length*a*3+(6*i.length||0)),c=vs(r.length*a*3+(i?6:0)),h=new Array,p=new Array;let f=0,m=0;const g=gs(),_=gs(),v=gs(),b=gs(),x=gs(),T=gs(),S=gs(),O=C(),A=gs(),M=gs(),P=gs(),F=gs(),$=gs(),N=zr();ie(A,0,1,0),pe(_,r[1],r[0]),_e(_,_),n?(ue(O,r[0],o),_e(v,O)):ie(v,0,0,1),TU(_,v,A,A,x,v,she),oe(b,v),oe(F,x);for(let z=0;z<i.length;z++)ae(T,x,i[z][0]),ae(O,v,i[z][2]),ue(T,T,O),ue(T,T,r[0]),l[f++]=T[0],l[f++]=T[1],l[f++]=T[2];c[m++]=-_[0],c[m++]=-_[1],c[m++]=-_[2];for(let z=0;z<s.length;z++)h.push(s[z][0]>0?s[z][0]:-s[z][0]-1+i.length),h.push(s[z][1]>0?s[z][1]:-s[z][1]-1+i.length),h.push(s[z][2]>0?s[z][2]:-s[z][2]-1+i.length),p.push(0),p.push(0),p.push(0);let U=i.length;const X=i.length-1;for(let z=0;z<r.length;z++){let H=!1;z>0&&(oe(g,_),z<r.length-1?(pe(_,r[z+1],r[z]),_e(_,_)):H=!0,ue(M,g,_),_e(M,M),ue(P,r[z-1],b),x$(r[z],M,N),yS(N,Eh(P,g),O)?(pe(O,O,r[z]),_e(v,O),st(x,M,v),_e(x,x)):TU(M,b,F,A,x,v,she),oe(b,v),oe(F,x)),n&&(ue(O,r[z],o),_e($,O));for(let Y=0;Y<a;Y++)if(ae(T,x,e[Y][0]),ae(O,v,e[Y][1]),ue(T,T,O),_e(S,T),c[m++]=S[0],c[m++]=S[1],c[m++]=S[2],ue(T,T,r[z]),l[f++]=T[0],l[f++]=T[1],l[f++]=T[2],!H){const te=(Y+1)%a;h.push(U+Y),h.push(U+a+Y),h.push(U+te),h.push(U+te),h.push(U+a+Y),h.push(U+a+te);for(let ne=0;ne<6;ne++){const ve=h.length-6;p.push(h[ve+ne]-X)}}U+=a}const Z=r[r.length-1];for(let z=0;z<i.length;z++)ae(T,x,i[z][0]),ae(O,v,i[z][1]),ue(T,T,O),ue(T,T,Z),l[f++]=T[0],l[f++]=T[1],l[f++]=T[2];const G=m/3;c[m++]=_[0],c[m++]=_[1],c[m++]=_[2];const ee=U-a;for(let z=0;z<s.length;z++)h.push(s[z][0]>=0?U+s[z][0]:-s[z][0]-1+ee),h.push(s[z][2]>=0?U+s[z][2]:-s[z][2]-1+ee),h.push(s[z][1]>=0?U+s[z][1]:-s[z][1]-1+ee),p.push(G),p.push(G),p.push(G);const I=[[E.POSITION,h],[E.NORMAL,p]],V=[[E.POSITION,new Ge(l,3,!0)],[E.NORMAL,new Ge(c,3,!0)]];return new mn(t,V,I)}function yBt(t,e,r,i){it(e.length>1,"createPolylineGeometry(): polyline needs at least 2 points"),it(e[0].length===3,"createPolylineGeometry(): malformed vertex"),it(r==null||r.length===e.length,"createPolylineGeometry: need same number of points and normals"),it(r==null||r[0].length===3,"createPolylineGeometry(): malformed normal");const s=Ra(3*e.length),n=new Array(2*(e.length-1));let o=0,a=0;for(let h=0;h<e.length;h++){for(let p=0;p<3;p++)s[o++]=e[h][p];h>0&&(n[a++]=h-1,n[a++]=h)}const l=[],c=[];if(l.push([E.POSITION,n]),c.push([E.POSITION,new Ge(s,3,!0)]),r){const h=vs(3*r.length);let p=0;for(let f=0;f<e.length;f++)for(let m=0;m<3;m++)h[p++]=r[f][m];l.push([E.NORMAL,n]),c.push([E.NORMAL,new Ge(h,3,!0)])}return i&&(c.push([E.COLOR,new Ge(i,4)]),l.push([E.COLOR,PA(i.length/4)])),new mn(t,c,l,null,Ms.Line)}function _Bt(t,e,r,i,s,n=0){const o=new Array(18),a=[[-r,n,s/2],[i,n,s/2],[0,e+n,s/2],[-r,n,-s/2],[i,n,-s/2],[0,e+n,-s/2]],l=[0,1,2,3,0,2,2,5,3,1,4,5,5,2,1,1,0,3,3,4,1,4,3,5];for(let c=0;c<6;c++)o[3*c]=a[c][0],o[3*c+1]=a[c][1],o[3*c+2]=a[c][2];return new mn(t,[[E.POSITION,new Ge(o,3,!0)]],[[E.POSITION,l]])}function vBt(t,e){const r=t.getMutableAttribute(E.POSITION).data;for(let i=0;i<r.length;i+=3){const s=r[i],n=r[i+1],o=r[i+2];ie(YS,s,n,o),Ne(YS,YS,e),r[i]=YS[0],r[i+1]=YS[1],r[i+2]=YS[2]}}function mpt(t,e=t){const r=t.vertexAttributes,i=r.get(E.POSITION).data,s=r.get(E.NORMAL).data;if(s){const n=e.getMutableAttribute(E.NORMAL).data;for(let o=0;o<s.length;o+=3){const a=s[o+1];n[o+1]=-s[o+2],n[o+2]=a}}if(i){const n=e.getMutableAttribute(E.POSITION).data;for(let o=0;o<i.length;o+=3){const a=i[o+1];n[o+1]=-i[o+2],n[o+2]=a}}}function uB(t,e,r,i,s){return!(Math.abs(de(e,t))>s)&&(st(r,t,e),_e(r,r),st(i,r,t),_e(i,i),!0)}function TU(t,e,r,i,s,n,o){return uB(t,e,s,n,o)||uB(t,r,s,n,o)||uB(t,i,s,n,o)}const she=.99619469809,YS=gs();let gpt=class{constructor(e,r){this.type=Ga.Local,this._configuration=new qte,this._passParameters=new Wte,this._configuration.geometry=Cg.Cylinder,this._technique=r.techniqueRepository.acquire(vU,this._configuration);const i=r.renderContext.rctx;this._vao=this._createVertexArrayObject(i),this._vaoCount=Sa(this._vao,"geometry");const s=new Sr;s.wrapMode=Ut.CLAMP_TO_EDGE,s.flipped=!0,s.width=1,s.height=512,this._passParameters.texture=new Rt(i,s,Ddt)}destroy(){this._passParameters.texture=ze(this._passParameters.texture),this._vao.dispose(),this._technique.release()}render(e){const r=e.rctx,i=r.bindTechnique(this._technique,this._passParameters,e.bindParameters);ypt(nhe,e.bindParameters.camera.viewMatrix),i.setUniformMatrix4fv("view",nhe),r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ot.TRIANGLES,0,this._vaoCount)}renderHaze(){return!1}_createVertexArrayObject(e){const r=hMe(1,2,!1),i=r.indices[0][1],s=r.vertexAttributes[0][1];for(let l=0;l<i.length;l+=3){const c=i[l];i[l]=i[l+2],i[l+2]=c}const n=s.data,o=ohe.createBuffer(i.length),a=o.position;for(let l=0;l<i.length;++l){const c=3*i[l];a.set(l,0,n[c]),a.set(l,1,n[c+1]),a.set(l,2,n[c+2])}return new zf(e,Er,{geometry:$u(ohe)},{geometry:Gr.createVertex(e,Mr.STATIC_DRAW,o.buffer)})}};function ypt(t,e){an(t,e),t[12]=0,t[13]=0,t[14]=0,t[15]=1}const nhe=xe(),ohe=us().vec3f(E.POSITION),_pt=new Uint8ClampedArray([0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,1,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,2,0,0,0,3,0,0,0,3,0,0,0,3,0,0,0,4,0,0,0,4,0,0,0,4,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,5,0,0,0,6,0,0,0,6,0,0,0,7,0,0,0,7,0,0,0,7,0,0,0,8,0,0,0,8,0,0,0,8,0,0,0,9,0,0,0,9,0,0,0,9,0,0,0,10,0,0,0,10,0,0,0,11,0,0,0,11,0,0,0,11,0,0,0,12,0,0,0,12,0,0,0,12,0,0,0,13,0,0,0,13,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,14,0,0,0,15,0,0,0,15,0,0,0,16,0,0,0,16,0,0,0,16,0,0,0,17,0,0,0,17,0,0,0,18,0,0,0,18,0,0,0,19,0,0,0,19,0,0,0,19,0,0,0,20,0,0,0,20,0,0,0,21,0,0,0,21,0,0,0,22,0,0,0,22,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,23,11,0,0,24,11,0,0,24,11,0,0,24,10,0,0,25,10,0,0,25,10,0,0,26,10,0,0,26,9,0,0,27,9,0,0,27,9,0,0,28,9,0,0,28,9,0,0,29,9,0,0,29,8,0,0,30,8,0,0,30,8,0,0,31,8,0,0,31,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,32,8,0,0,33,8,0,0,33,8,0,0,34,7,0,0,35,7,0,0,35,7,0,0,36,7,0,0,36,7,7,0,37,7,7,0,37,7,7,0,38,7,7,0,38,13,7,0,39,13,7,0,39,13,6,0,40,13,6,0,40,12,6,0,41,12,6,0,41,12,6,0,41,12,6,0,42,12,6,0,42,12,6,0,43,12,6,0,43,12,6,0,44,12,6,0,44,11,6,0,45,11,6,6,45,11,6,6,46,11,5,5,47,11,5,5,47,11,5,5,48,11,5,5,48,10,5,5,49,10,5,5,49,10,5,5,50,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,51,15,5,5,52,15,5,5,52,14,5,5,53,14,5,5,54,14,5,5,54,14,5,5,55,14,5,5,55,14,5,5,56,13,4,4,57,13,4,4,57,13,4,4,58,13,4,4,58,13,4,4,59,13,4,4,59,17,4,4,60,17,4,4,60,17,4,4,60,17,4,4,61,17,4,4,61,16,4,4,62,16,4,4,63,16,4,4,63,16,8,4,64,16,8,4,64,16,8,4,65,15,8,4,66,15,8,4,66,15,8,4,67,19,8,4,68,19,8,4,68,18,7,4,69,18,7,4,69,18,7,4,69,18,7,4,70,18,7,4,70,18,7,4,71,18,7,4,71,18,7,4,72,17,7,3,73,17,7,3,73,21,7,3,74,21,7,3,74,20,7,3,75,20,7,3,76,20,7,3,76,20,7,3,77,20,7,3,77,20,7,3,78,20,7,3,78,20,7,7,78,19,6,6,79,19,10,6,80,19,10,6,80,22,9,6,81,22,9,6,81,22,9,6,82,22,9,6,83,22,9,6,83,21,9,6,84,21,9,6,84,21,9,6,85,21,9,6,86,21,9,6,86,23,9,6,87,23,9,6,87,23,9,6,87,23,9,6,88,23,9,6,88,23,9,6,89,23,8,6,90,23,8,6,90,22,8,6,91,22,8,6,91,25,8,6,92,25,8,5,93,25,8,5,93,24,8,5,94,24,8,5,94,24,11,5,95,24,11,5,96,24,11,5,96,26,11,5,97,26,11,5,97,26,11,5,97,26,10,5,98,26,10,5,98,26,10,5,99,25,10,5,100,25,10,5,100,25,10,5,101,25,10,5,101,25,10,5,102,27,10,5,103,27,10,5,103,27,10,5,104,27,10,5,104,27,12,5,105,26,12,5,106,26,12,5,106,29,12,5,106,29,12,5,106,29,12,7,107,28,12,7,108,28,12,7,108,28,12,7,109,28,12,7,109,30,12,7,110,30,11,7,111,30,11,7,111,30,11,7,112,30,11,7,112,29,11,7,113,29,11,7,114,29,11,7,114,31,11,7,115,31,11,7,115,31,11,7,115,31,11,7,116,31,11,7,116,33,13,7,117,33,13,9,117,32,13,9,118,32,13,9,118,32,13,9,119,34,15,8,120,34,15,8,120,34,15,8,121,36,15,8,121,36,15,8,122,36,15,8,122,35,15,8,123,37,14,8,124,37,14,8,124,37,14,8,124,37,14,8,124,39,14,8,125,39,16,8,125,38,16,8,126,38,16,8,127,38,16,8,127,40,16,10,128,40,16,10,128,40,16,10,129,42,18,10,129,41,18,10,130,41,18,10,130,43,18,10,131,43,18,10,131,42,17,10,132,42,17,12,132,42,17,12,133,44,17,12,133,44,17,12,133,46,17,11,134,46,17,11,134,45,19,11,135,45,19,11,135,47,19,11,136,47,19,11,136,47,19,11,137,47,19,11,137,48,20,11,138,48,20,11,138,50,20,13,139,50,20,13,139,49,20,13,140,49,22,13,140,51,22,13,141,51,22,13,141,50,22,13,142,52,22,13,142,52,21,12,143,53,21,12,143,53,21,12,143,53,21,12,143,53,21,14,144,53,23,14,144,55,23,14,145,55,23,14,145,56,23,14,146,56,23,14,146,57,24,14,147,57,24,14,147,59,24,16,148,59,24,16,148,58,24,15,149,58,26,15,149,58,26,15,149,60,26,15,150,60,26,15,150,61,25,15,151,61,25,15,151,62,25,17,152,62,25,17,152,64,25,17,152,64,27,17,152,63,27,17,153,63,27,17,153,65,27,17,153,66,28,17,154,66,28,17,154,67,28,16,155,67,28,16,155,67,30,16,155,69,29,18,156,69,29,18,156,68,29,18,157,70,29,18,157,70,29,18,157,71,31,18,158,71,31,18,158,72,30,19,159,72,30,19,159,74,30,19,159,73,30,19,160,73,32,19,160,74,32,19,161,74,32,21,161,76,32,21,161,78,33,21,161,78,33,21,161,79,35,20,162,78,34,20,163,79,34,22,164,81,36,22,164,82,36,22,165,81,35,22,166,82,37,21,167,84,37,21,167,85,36,21,168,86,38,23,169,88,38,23,169,88,38,23,170,88,39,23,170,89,39,24,171,91,40,24,171,92,40,24,172,93,40,24,173,94,41,25,173,95,41,25,174,96,42,25,175,98,42,25,175,99,43,26,176,99,43,26,177,101,45,26,177,102,44,26,178,103,46,27,179,104,46,27,179,105,46,27,179,106,45,28,180,108,47,28,180,108,46,28,181,109,48,28,182,111,48,29,182,111,49,29,183,114,49,29,184,114,50,30,184,114,50,30,185,116,51,30,185,117,51,30,186,119,52,31,187,119,53,31,187,121,53,31,188,122,54,33,188,123,54,32,189,124,55,32,189,125,55,32,189,126,56,34,190,128,56,34,190,128,57,33,191,130,57,33,191,131,58,35,192,131,58,35,192,133,59,34,193,134,60,35,194,135,60,35,194,136,61,37,195,139,61,37,195,139,62,36,196,141,62,36,196,141,63,38,197,142,63,38,197,143,64,39,198,144,64,39,198,146,66,39,198,146,67,39,198,147,67,38,199,147,68,40,199,149,68,40,200,150,69,40,200,152,70,41,201,154,71,41,201,154,71,42,202,155,72,42,202,156,73,41,203,157,73,43,203,158,74,42,204,160,75,44,204,161,76,44,204,162,77,44,205,164,77,45,205,165,78,45,206,166,79,45,206,168,80,46,207,169,81,46,207,170,83,47,207,171,83,47,207,172,83,47,207,174,85,48,208,175,85,48,208,177,85,48,209,178,87,49,209,180,87,49,210,181,87,49,210,182,89,50,210,182,89,50,211,185,91,50,211,186,91,51,212,186,93,51,212,189,94,52,212,190,95,51,213,192,96,51,213,193,96,53,213,194,97,52,214,195,98,54,214,197,98,55,215,198,100,55,215,199,101,55,215,200,102,55,216,202,103,55,216,203,104,55,216,204,105,57,216,205,106,57,216,207,107,58,216,208,108,58,217,209,109,59,217,210,110,60,217,211,111,60,218,212,112,61,218,213,113,61,218,214,114,62,219,217,115,63,219,217,116,64,219,218,118,64,220,219,119,65,220,220,121,66,220,222,121,67,221,222,122,67,221,222,123,68,221,223,124,69,222,224,125,70,222,225,127,71,222,226,128,72,223,228,129,73,223,228,130,74,223,229,132,75,223,230,135,79,224,231,138,81,224,233,141,84,224,233,144,87,225,235,147,91,225,236,150,94,225,237,154,97,225,238,158,102,225,239,161,107,225,239,165,110,225,240,168,114,226,241,172,118,226,241,176,122,226,241,181,126,226,242,183,130,227,243,186,135,227,243,190,139,227,244,194,143,227,244,197,147,228,244,200,150,228,245,204,154,228,245,207,157,228,245,210,161,229,246,212,164,229,246,215,167,229,246,217,169,229,246,220,172,230,247,221,174,230]),CD=128,ahe=-rX,lhe=0,hB=50,vpt=()=>1-511/512,bpt=U4([[50,.1015625],[500,.21875],[5e3,1-250/512],[5e4,.4140625]]);let wpt=class{constructor(e,r){this.view=e,this.type=Ga.Mars,this._passParameters=new Wte,this._vaoCount=0,this._texV1=1;const i=Ir(e.spatialReference);this._planetRadius=i.radius,this._outerRimWidth=i.outerAtmosphereRimWidth,this._innerRimFactor=(this._planetRadius+ahe)/this._planetRadius,this._middleRimFactor=(this._planetRadius+lhe)/this._planetRadius,this._outerRimFactor=(this._planetRadius+this._outerRimWidth)/this._planetRadius,this._texV0=lhe/this._outerRimWidth,this._texVScale=this._texV1-this._texV0,this._techniqueRepository=r.techniqueRepository;const s=r.renderContext.rctx;this._cameraChangeHandle=Q(()=>this.view.state?.camera,()=>r.requestRender(),Ri),this._vao=this._createRibbon(s),this._vaoCount=Sa(this._vao,"geometry"),this._fadeVao=Mc(s),this._fadeVaoCount=Sa(this._fadeVao,"geometry");const n=new Sr;n.wrapMode=Ut.CLAMP_TO_EDGE,n.flipped=!0,n.width=1,n.height=512,this._passParameters.texture=new Rt(s,n,_pt);const o=new qte;o.geometry=Cg.Cone,this._coneTechnique=this._techniqueRepository.acquire(vU,o),o.geometry=Cg.Underground,this._undergroundTechnique=this._techniqueRepository.acquire(vU,o)}destroy(){this._coneTechnique.release(),this._undergroundTechnique.release(),this._cameraChangeHandle.remove(),this._passParameters.texture=ze(this._passParameters.texture),this._fadeVao.dispose(),this._vao.dispose()}render(e){const r=e.bindParameters.camera;this._update(r);const i=e.rctx;this._passParameters.undergroundFadeAlpha<1&&(i.bindTechnique(this._coneTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._vao),i.drawArrays(Ot.TRIANGLES,0,this._vaoCount)),this._passParameters.undergroundFadeAlpha>0&&(i.bindTechnique(this._undergroundTechnique,this._passParameters,e.bindParameters),i.bindVAO(this._fadeVao),i.drawArrays(Ot.TRIANGLE_STRIP,0,this._fadeVaoCount))}renderHaze(){}_update(e){const r=C(),i=this._planetRadius,s=Oe(e.eye),n=s-i;if(n<0){const m=Math.min(-n/5e3,1);this._passParameters.undergroundFadeAlpha=m}else this._passParameters.undergroundFadeAlpha=0;const o=Math.max(hB,n),a=i+ahe;this._passParameters.innerScale=xpt(i+o,i,a)-1,this._passParameters.altitudeFade=Lte(n),ae(r,e.eye,(i+hB)/s),che(r,e.center,e.up,i,this._passParameters.silhouette);const l=this._computeScreenRimWidth(e,r,e.up,this._passParameters.silhouette),c=vpt(),h=bpt(n);let p=this._texV0+c*this._texVScale,f=this._texV0+l*h*this._texVScale;if(n>hB){che(e.eye,e.center,e.up,i,this._passParameters.silhouette);const m=this._computeScreenRimWidth(e,e.eye,e.up,this._passParameters.silhouette),g=ye((m-1.5)/(l-1.5),0,1);p=this._texV0+g*c*this._texVScale,f=this._texV0+Et(this._texV1,l*h,g)*this._texVScale}hr(this._passParameters.texV,p,f)}_createRibbon(e){const r=vs(3+3*CD*3),i=new Uint32Array(3*CD*5);r[0]=0,r[1]=0,r[2]=-1;for(let o=0;o<CD;o++){const a=9*o+3;r[a]=o,r[a+1]=this._innerRimFactor,r[a+2]=-1,r[a+3]=o,r[a+4]=this._middleRimFactor,r[a+5]=0,r[a+6]=o,r[a+7]=this._outerRimFactor,r[a+8]=1;const l=3*o+1,c=o===CD-1?1:l+3,h=15*o;i[h]=l,i[h+1]=l+1,i[h+2]=c+1,i[h+3]=c+1,i[h+4]=c,i[h+5]=l,i[h+6]=l+1,i[h+7]=l+2,i[h+8]=c+2,i[h+9]=c+2,i[h+10]=c+1,i[h+11]=l+1,i[h+12]=l,i[h+13]=c,i[h+14]=0}const s=uhe.createBuffer(i.length),n=s.position;for(let o=0;o<i.length;++o){const a=3*i[o];n.set(o,0,r[a]),n.set(o,1,r[a+1]),n.set(o,2,r[a+2])}return new zf(e,Er,{geometry:$u(uhe)},{geometry:Gr.createVertex(e,Mr.STATIC_DRAW,s.buffer)})}_computeScreenRimWidth(e,r,i,s){return ue(JS,s.center,s.v2),ae(AD,JS,this._outerRimFactor),wV(dB,r,JS,i),Iue(JS,dB,e.projectionMatrix,e.viewport,JS),Iue(AD,dB,e.projectionMatrix,e.viewport,AD),_i(JS,AD)/e.height}};function che(t,e,r,i,s){const n=Oe(t),o=i*Math.sqrt(n*n-i*i)/n,a=Math.sqrt(i*i-o*o),l=s.v1,c=s.v2;return ae(s.center,t,a/n),st(l,t,e),Xa(l)<1&&st(l,t,r),ae(l,l,o/Oe(l)),st(c,l,t),ae(c,c,o/Oe(c)),o}const dB=xe(),JS=C(),AD=C();function xpt(t,e,r){return t*t/(Math.sqrt(t*t-e*e)*Math.sqrt(t*t-r*r)+e*r)}const uhe=us().vec3f(E.POSITION);var L0;(function(t){t[t.Rain=0]="Rain",t[t.Snow=1]="Snow",t[t.COUNT=2]="COUNT"})(L0||(L0={}));let QX=class extends nl{constructor(){super(...arguments),this.type=L0.Rain}};u([B({count:L0.COUNT})],QX.prototype,"type",void 0);function Tpt(t){const e=new Cr;return e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.INSTANCEFEATUREATTRIBUTE,"float"),e.vertex.uniforms.add(new jt("cameraPosition",(r,i)=>i.camera.eye)),e.vertex.uniforms.add(new jt("offset",(r,i)=>Spt(r,i))),e.vertex.uniforms.add(new Ie("width",r=>r.width)),e.vertex.uniforms.add(new es("proj",(r,i)=>i.camera.projectionMatrix)),e.vertex.uniforms.add(new es("view",(r,i)=>i.camera.viewMatrix)),e.vertex.uniforms.add(new Ie("time",r=>r.time)),e.varyings.add("vUv","vec2"),e.vertex.code.add(w`
    vec3 hash31(float p){
      vec3 p3 = fract(vec3(p) * vec3(0.1031, 0.1030, 0.0973));
      p3 += dot(p3, p3.yzx + 33.33);
      return fract((p3.xxy + p3.yzz) * p3.zyx);
    }

    float hash11(float p){
      p = fract(p * 0.1031);
      p *= p + 33.33;
      p *= p + p;
      return fract(p);
    }

    //https://www.geeks3d.com/20141201/how-to-rotate-a-vertex-by-a-quaternion-in-glsl/
    vec3 rotateVectorByQuaternion(vec3 v, vec4 q){
      return 2.0 * cross(q.xyz, v * q.w + cross(q.xyz, v)) + v;
    }

    void main(void) {

      vUv = position.xz;

      vec3 rand = hash31(instanceFeatureAttribute);

      // Set random position for all particles
      // The hash function space is not high resolution so offset particles by an additional random value
      // This creates grids of 1000 particles which are shifted by random hundreths of the tile width
      // overlaying multiple identical but offset grids
      vec3 randomPosition = 2.0 * (rand + (0.01 + 0.01 * rand) * floor(0.001 * instanceFeatureAttribute)) - 1.0;

      // Random orientation of rain drops
      float angle = 3.1415 * hash11(instanceFeatureAttribute);

      vec3 up = vec3(0, 0, 1);

      // Gravity and wind direction
      vec3 direction = normalize(cameraPosition);

      vec3 tangent = normalize(cross(direction, up));

      // Gravity
      vec3 animatedPos = randomPosition + direction * -time;

      // Rain particles fall straight down and are randomly oriented
      // Snow particles have random sinusoid trajectories and are rotated to face the camera
      ${t.type===L0.Rain?w`
            // Random rotation for particle
            vec3 rotationAxis = up;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));
            vec3 transformedPos = rotateVectorByQuaternion(vec3(0.2, 0.2, 4.0) * (position - vec3(0.5, 0.0, 0.5)), quat);

            // Rotate particle to planetary position
            rotationAxis = tangent;
            angle = 0.5 * -acos(dot(direction, up));
            quat = vec4(rotationAxis * sin(angle), cos(angle));
            transformedPos = rotateVectorByQuaternion(transformedPos, quat);

            vec4 pos = mat4(mat3(view)) * vec4(transformedPos + (mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * pos;
      `:w`
            vec3 rotationAxis = direction;
            vec4 quat = vec4(rotationAxis * sin(angle), cos(angle));

            tangent = rotateVectorByQuaternion(tangent, quat);
            // Random sinusoid from friction
            animatedPos += tangent * 0.25 * sin(dot(animatedPos, direction));
            vec4 pos = mat4(mat3(view)) * vec4((mod(width * animatedPos - offset, width) - 0.5 * width), 1.0);
            gl_Position = proj * (0.5 * vec4(position.xzy, 0.0) + pos);
      `}
    }
  `),e.fragment.uniforms.add(new Ie("opacity",r=>r.opacity),new jt("particleColor",(r,i)=>Ept(i,t))),e.fragment.code.add(w`
    void main() {

      // Cut off corners of the triangle
      if(vUv.x < 0.0 || vUv.y < 0.0){
        discard;
      }

      float d = length(vUv - vec2(0.5));

      ${t.type===L0.Rain?w`d = 0.35 * smoothstep(0.5, 0.0, d);`:w`d = smoothstep(0.5, 0.1, d);`}
      fragColor = opacity * vec4(particleColor * d, d);
    }
  `),e}function Spt(t,e){const r=e.camera.eye,i=.5*t.width,s=1/t.width,n=Y1e(KX,ie(KX,(r[0]+i)*s,(r[1]+i)*s,(r[2]+i)*s));return Mi(n,r,ae(n,n,t.width))}function Ept(t,e){const r=e.type===L0.Rain?Apt:Cpt,i=ae(KX,r,Opt),s=t.camera.eye;_e(hhe,s);const n=Math.max(0,de(hhe,t.lighting.mainLight.direction));return Wr(i,i,r,n)}const KX=C(),hhe=C(),Cpt=Ee(1,1,1),Apt=Ee(.85,.85,.85),Opt=.7,Rpt=Object.freeze(Object.defineProperty({__proto__:null,build:Tpt},Symbol.toStringTag,{value:"Module"}));let Mpt=class extends ui{constructor(){super(...arguments),this.time=0,this.radius=1,this.width=500,this.opacity=1}},eY=class dMe extends Ur{initializeProgram(e){return new Lr(e.rctx,dMe.shader.get().build(this.configuration),t5)}initializePipeline(){return It({blending:ca(Te.ONE,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};eY.shader=new $r(Rpt,()=>J(()=>import("./Precipitation.glsl-0222724b.js"),[],import.meta.url));const t5=new Map([[E.POSITION,0],[E.INSTANCEFEATUREATTRIBUTE,1]]);let pMe=class{constructor(){this.enabled=!0,this._time=0}get time(){return this._time}advance({deltaTime:e,fixedTime:r}){return r!=null?this._time!==r&&(this._time=r,!0):(this._time=this._time+e,e!==0)}},Ipt=class{constructor(e,r){this.deltaTime=e,this.fixedTime=r}},ox=class extends me{constructor(e){super(e),this._numParticles=25e4,this._rainSpeed=.1,this._snowSpeed=.01,this._passParameters=new Mpt,this._animation=new pMe,this._updatingTracking=new vf,this._passParameters.time=0,this._passParameters.radius=Ir(e.view.spatialReference).radius,this._techniqueRepository=e.context.techniqueRepository}destroy(){this._updatingTracking.destroy(),this._numParticles=0,this._snowTechniqueCached=as(this._snowTechniqueCached),this._rainTechniqueCached=as(this._rainTechniqueCached),this._vao=ze(this._vao),this._instanceIdBuffer=ze(this._instanceIdBuffer)}get updating(){return this._updatingTracking.updating}get _rainTechnique(){if(this._rainTechniqueCached==null){const e=new QX;e.type=L0.Rain,this._rainTechniqueCached=this._techniqueRepository.acquire(eY,e)}return this._rainTechniqueCached}get _snowTechnique(){if(this._snowTechniqueCached==null){const e=new QX;e.type=L0.Snow,this._snowTechniqueCached=this._techniqueRepository.acquire(eY,e)}return this._snowTechniqueCached}update(e){return this._animation.advance(e)}render(e,r,i){const s=i==="rainy"?this._rainTechnique:this._snowTechnique;if(!s.compiled)return void this.context.requestRender();const n=e.rctx;if(this._ensureResources(n),s==null||this._vao==null||this._instanceIdBuffer==null||(e.bindParameters.cloudsFade.data!=null&&(this._passParameters.opacity=1-e.bindParameters.cloudsFade.fadeInOutHeight.factor),this._passParameters.opacity<=0))return;const o=.35;r=r<.5?Et(0,o,2*r):Et(o,1,2*(r-.5)),this._passParameters.time=(i==="rainy"?this._rainSpeed:this._snowSpeed)*nQ(this._animation.time)%1e5;const a=n.bindTechnique(s,this._passParameters,e.bindParameters);n.bindVAO(this._vao),a.assertCompatibleVertexAttributeLocations(this._vao),Fte(n,t5,this._instanceIdBuffer,dhe,0),n.capabilities.instancing?.drawArraysInstanced(Ot.TRIANGLES,0,3,this._numParticles*r),kte(n,t5,this._instanceIdBuffer,dhe)}_ensureResources(e){this._vao==null&&(this._vao=this._createVertexArrayObject(e)),this._instanceIdBuffer==null&&(this._instanceIdBuffer=this._createInstanceIndices(e))}_createInstanceIndices(e){const r=[];for(let i=0;i<this._numParticles;i++)r.push(i);return Gr.createVertex(e,Mr.STATIC_DRAW,new Float32Array(r))}_createVertexArrayObject(e){const r=new Float32Array([-1,0,1,1,0,-1,1,0,1]);return new zf(e,t5,{geometry:$u(Ppt)},{geometry:Gr.createVertex(e,Mr.STATIC_DRAW,r)})}};u([d({constructOnly:!0})],ox.prototype,"context",void 0),u([d({constructOnly:!0})],ox.prototype,"view",void 0),u([d({readOnly:!0})],ox.prototype,"updating",null),u([d()],ox.prototype,"_updatingTracking",void 0),ox=u([R("esri.views.3d.environment.Precipitation")],ox);const Ppt=us().vec3f(E.POSITION),dhe=$u(us().f32(E.INSTANCEFEATUREATTRIBUTE),1);function $pt(){const t=new Cr;return t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.COLOR,"vec4"),t.attributes.add(E.SIZE,"float"),t.varyings.add("vcolor","vec4"),t.varyings.add("vsize","float"),t.vertex.uniforms.add(new es("transform",(e,r)=>Lpt(e,r)),new cr("viewport",(e,r)=>r.camera.fullViewport),new Ie("pixelRatio",(e,r)=>r.camera.pixelRatio)),t.vertex.code.add(w`void main(void) {
gl_Position = transform * vec4(position, 0);
vcolor = color / 1.2;
vsize = size * 5.0 * pixelRatio;
gl_PointSize = vsize;
}`),t.fragment.code.add(w`void main() {
float cap = 0.7;
float scale = 1.0 / cap;
float helper = clamp(length(abs(gl_PointCoord - vec2(0.5))), 0.0, cap);
float alpha = clamp((cap - helper) * scale, 0.0, 1.0);
float intensity = alpha * alpha * alpha;
if (vsize < 3.0) {
intensity *= 0.5;
}
fragColor = vec4(vcolor.xyz, intensity);
}`),t}function Lpt(t,e){return an(b_,e.camera.projectionMatrix),b_[10]=24e-8-1,b_[11]=-1,b_[14]=(24e-8-2)*e.camera.near,yi(b_,b_,e.camera.viewMatrix),yi(b_,b_,t.modelMatrix)}const b_=xe(),Dpt=Object.freeze(Object.defineProperty({__proto__:null,build:$pt},Symbol.toStringTag,{value:"Module"}));let Npt=class extends ui{constructor(){super(...arguments),this.modelMatrix=xe()}},fMe=class mMe extends Ur{constructor(e){super(e,new nl,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,mMe.shader.get().build(),Er)}initializePipeline(){return It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:ci.LEQUAL},colorWrite:Wt})}};fMe.shader=new $r(Dpt,()=>J(()=>import("./Stars.glsl-9a2a9150.js"),[],import.meta.url));let Rv=class extends me{get updating(){return this._updatingTracking.updating||this.loading}get loading(){return this._loadDataTask!=null&&!this._loadDataTask.finished}constructor(e){super(e),this._loadDataTask=null,this._numPoints=0,this._renderParameter=new Npt,this._updatingTracking=new vf}initialize(){this._loadDataTask=this._createLoadDataTask()}destroy(){this._loadDataTask=Do(this._loadDataTask),this._updatingTracking.destroy(),this._numPoints=0,this._technique=as(this._technique),this._vao=ze(this._vao),Lb=null}render(e){const{rctx:r}=e;if(this._ensureResources(r),this._technique==null||this._vao==null)return;if(!this._technique.compiled)return void this.requestRender();const i=r.bindTechnique(this._technique,this._renderParameter,e.bindParameters);r.bindVAO(this._vao),i.assertCompatibleVertexAttributeLocations(this._vao),r.drawArrays(Ot.POINTS,0,this._numPoints)}_ensureResources(e){if(this._technique!=null||Lb==null)return;this._technique=new fMe({rctx:e,viewingMode:this.view.state.viewingMode}),this._numPoints=Lb.byteLength/phe;const r=new Float32Array(Lb,0,2*this._numPoints),i=new Uint8Array(Lb,2*this._numPoints*4,this._numPoints);this._vao=this._createVertexArrayObject(e,r,i,this._numPoints),this._updatingTracking.add(()=>this.view.environment.lighting.type!=="virtual"?this.view.environment.lighting.date:null,s=>this._update(s),xt)}_computeDayDuration(e){const r=e,i=new Date(e.getFullYear(),0,1,11,58,56);return(+r-+i)/(+new Date(e.getFullYear()+1,0,1,11,58,55)-+i)}_update(e){if(!e)return;const r=(e.getHours()/12+e.getMinutes()/60*(2/24)+e.getSeconds()/60*(2/1440)-.9972222)%2,i=2*this._computeDayDuration(e),s=an(this._renderParameter.modelMatrix,Upt);pA(s,s,-i*Math.PI),yi(s,kpt,s),pA(s,s,-r*Math.PI),this.requestRender()}_hexToRGB(e){return[parseInt(e.substring(0,2),16),parseInt(e.substring(2,4),16),parseInt(e.substring(4,6),16)]}_unpackUint8Attributes(e){return e>=192?[2.9,e-192]:e>=160?[2.5,e-160]:e>=128?[2,e-128]:e>=96?[1.5,e-96]:e>=64?[1,e-64]:e>=32?[.7,e-32]:[.4,e]}_createVertexArrayObject(e,r,i,s){const n=fhe.createBuffer(s),o=n.position,a=n.color,l=n.size;for(let c=0;c<s;c++){const h=r[2*c],p=r[2*c+1];o.set(c,0,-Math.cos(h)*Math.sin(p)),o.set(c,1,-Math.sin(h)*Math.sin(p)),o.set(c,2,-Math.cos(p));const f=this._unpackUint8Attributes(i[c]),m=this._hexToRGB(Fpt[f[1]]);a.set(c,0,255*m[0]),a.set(c,1,255*m[1]),a.set(c,2,255*m[2]),a.set(c,3,255),l.set(c,f[0])}return new zf(e,Er,{geometry:$u(fhe)},{geometry:Gr.createVertex(e,Mr.STATIC_DRAW,n.buffer)})}_createLoadDataTask(){if(Lb!=null)return null;const e=hb(async r=>{const{data:i}=await QUe("esri/views/3d/environment/resources/stars.wsv",{responseType:"array-buffer",signal:r});this._verifyStarData(i),Lb=i});return e.promise.catch(r=>{ws(r)||K.getLogger(this).error(r)}).then(()=>{this.destroyed||(this.requestRender(),this.notifyChange("updating"))}),e}_verifyStarData(e){if(!e)throw new D("stars:no-data-received","Failed to create stars because star catalogue is missing");const r=e.byteLength/phe;if(r%1!=0||r>5e4||r<5e3)throw new D("stars:invalid-data","Failed to create stars because star catalogue data is invalid")}};u([d({constructOnly:!0})],Rv.prototype,"view",void 0),u([d({constructOnly:!0})],Rv.prototype,"requestRender",void 0),u([d({readOnly:!0})],Rv.prototype,"updating",null),u([d()],Rv.prototype,"_loadDataTask",void 0),u([d()],Rv.prototype,"_updatingTracking",void 0),Rv=u([R("esri.views.3d.environment.Stars")],Rv);const Fpt=["9bb2ff","9eb5ff","aabfff","bbccff","ccd8ff ","dae2ff","e4e9ff","eeefff","f8f6ff","fff9fb","fff5ef","fff1e5","ffeddb","ffe9d2","ffe6ca","ffe3c3","ffe0bb","ffddb4","ffdaad","ffd6a5","ffd29c","ffcc8f","ffc178","ffa94b","ff7b00"],kpt=pte(1,0,0,0,0,.9174771405229186,.39778850739794974,0,0,-.39778850739794974,.9174771405229186,0,0,0,0,1),Upt=pte(1,0,0,0,0,.9174771405229186,-.39778850739794974,0,0,.39778850739794974,.9174771405229186,0,0,0,0,1),phe=9,fhe=us().vec3f(E.POSITION).vec4u8(E.COLOR).f32(E.SIZE);let Lb=null;function Y0(t=zpt){return[t[0],t[1],t[2],t[3]]}function pB(t,e,r=Y0()){return oe(r,t),r[3]=e,r}function mhe(t,e,r=Y0()){return st(r,t,e),_e(r,r),r[3]=-Q1e(t,e),r}function ghe(t,e,r=Y0()){return nU(OD,t,yhe(t)),nU(_he,e,yhe(e)),WV(OD,_he,OD),Vpt(r,Vl(fte(r,OD)))}function RBt(t,e,r,i=Y0()){return pB(Z1e,t,RD),pB(X1e,e,vhe),pB(RQ,r,bhe),ghe(RD,vhe,RD),ghe(RD,bhe,i),i}function MBt(t){return t}function IBt(t){return t[3]}function yhe(t){return zt(t[3])}function Vpt(t,e){return t[3]=e,t}const zpt=[0,0,1,0],OD=Kd(),_he=Kd();Y0();const RD=Y0(),vhe=Y0(),bhe=Y0();function Bpt(t,e,r){const i=t.parallax.anchorPointClouds;t.fadeIn.stage===hu.FINISHED&&(t.fadeIn.factor=0,oe(i,Xm),t.fadeIn.stage=hu.CHANGE_ANCHOR,t.crossFade.enabled=!1,t.fadeInOut.stage=Jn.FINISHED),t.fadeIn.stage===hu.CHANGE_ANCHOR&&t.isCameraPositionFinal&&(jte(t.data)&&t.renderingStage!==tn.RENDERING||t.renderingStage===tn.FADING_TEXTURE_CHANNELS)&&(oe(i,Xm),t.fadeIn.stage=hu.FADE_IN,t.startTime=e,t.renderingStage===tn.FADING_TEXTURE_CHANNELS&&(t.renderingStage=tn.SWITCH_CHANNELS)),t.fadeIn.factor<1&&t.fadeIn.stage===hu.FADE_IN?t.fadeIn.factor=r?ye((e-t.startTime)/(gMe*r),0,1):1:t.fadeIn.factor>=1&&t.fadeIn.stage===hu.FADE_IN&&(t.fadeIn.stage=hu.FINISHED,t.fadeIn.factor=1)}function Gpt(t,e,r){const{fadeInOut:i,crossFade:s}=t;i.stage===Jn.FINISHED&&(t.startTime=e,i.factor=1,i.stage=Jn.FADE_OUT),i.factor>0&&i.stage===Jn.FADE_OUT?i.factor=r?1-ye((e-t.startTime)/(Zpt*r),0,1):0:(i.factor<=0&&i.stage===Jn.FADE_OUT&&(i.factor=0,oe(t.parallax.anchorPointClouds,Xm)),i.factor<=0&&i.stage===Jn.FADE_OUT&&t.isCameraPositionFinal&&(i.factor=0,i.stage=Jn.SWITCH,t.crossFade.enabled=!1,s.factor=1),i.stage===Jn.SWITCH&&(jte(t.data)&&t.renderingStage!==tn.RENDERING||t.renderingStage===tn.FADING_TEXTURE_CHANNELS)&&(t.startTime=e,i.factor=0,i.stage=Jn.FADE_IN,oe(t.parallax.anchorPointClouds,Xm),t.crossFade.enabled=!1,s.factor=1,t.renderingStage===tn.FADING_TEXTURE_CHANNELS&&(t.renderingStage=tn.SWITCH_CHANNELS)),i.factor<1&&i.stage===Jn.FADE_IN?i.factor=r?ye((e-t.startTime)/(gMe*r),0,1):1:i.factor>=1&&i.stage===Jn.FADE_IN&&(i.stage=Jn.FINISHED,i.factor=1))}function jpt(t,e,r,i){const{crossFade:s}=t,n=t.parallax.anchorPointClouds;t.crossFade.enabled&&!i||(oe(t.parallaxNew.anchorPointClouds,Xm),t.startTime=e,s.factor=0,t.crossFade.enabled=!0),s.factor<1&&t.crossFade.enabled?s.factor=r?ye((e-t.startTime)/(Xpt*r),0,1):1:s.factor>=1&&t.crossFade.enabled&&(t.crossFade.enabled=!1,s.factor=1,oe(n,t.parallaxNew.anchorPointClouds),t.renderingStage===tn.FADING_TEXTURE_CHANNELS&&(t.renderingStage=tn.SWITCH_CHANNELS))}function whe(t,e,r,i){const s=t.fadeInOutHeight,n=s.stage===Y1.FINISHED?r:t.startTimeHeightFade;if(i!==0){const o=(r-n)/(Ypt*i);s.factor+=e?-o:o}else s.factor=e?0:1;t.startTimeHeightFade=r,s.factor=ye(s.factor,0,1),s.stage=Y1.HEIGHT_FADE}function Hpt(t,e,r,i,s){t.renderingStage===tn.FINISHED_RENDERING&&(t.renderingStage=tn.FADING_TEXTURE_CHANNELS);const n=Oe(e.eye);t.fadeInOutHeight.factor<0&&(t.fadeInOutHeight.factor=n-ur.radius>Gm?1:0),t.isCameraPositionFinal=D1(t.cameraPositionLastFrame,e.eye),_e(Xm,e.eye),ae(Xm,Xm,ur.radius);const o=t.parallax;o.anchorPointClouds[0]===0&&o.anchorPointClouds[1]===0&&o.anchorPointClouds[2]===0&&oe(o.anchorPointClouds,Xm);const a=Oe(pe(Wpt,o.anchorPointClouds,Xm));let l=!0;a>t.fadeIn.distanceThresholdFactor*o.cloudsHeight||t.fadeIn.stage!==hu.FINISHED?Bpt(t,i,s):a>t.fadeInOut.distanceThresholdFactor*o.cloudsHeight||t.fadeInOut.stage!==Jn.FINISHED?Gpt(t,i,s):a>t.crossFade.distanceThresholdFactor*o.cloudsHeight||t.crossFade.enabled||t.renderingStage===tn.FADING_TEXTURE_CHANNELS?jpt(t,i,s,(r!==Br.IDLE||!jte(t.data))&&t.renderingStage!==tn.FADING_TEXTURE_CHANNELS):l=!1;const c=n-ur.radius;if((c>1.7*Gm||c<-Gm)&&t.fadeInOutHeight.factor<1?t.fadeInOutHeight.factor=1:(c>Gm||c<-.35*Gm)&&t.fadeInOutHeight.factor<1?whe(t,!1,i,s):c<Gm&&c>-.35*Gm&&t.fadeInOutHeight.factor>0?whe(t,!0,i,s):t.fadeInOutHeight.stage=Y1.FINISHED,t.renderingStage===tn.SWITCH_CHANNELS&&(t.readChannels=1-t.readChannels,t.renderingStage=tn.FINISHED),o.radiusCurvatureCorrectionFactor=.84*Math.sqrt(Math.max(n*n-ur.radius*ur.radius,0))/n,mhe(xhe,o.anchorPointClouds,QS),_u(o.transform,Un,QS[3],QS),l){const{parallaxNew:h}=t;mhe(xhe,h.anchorPointClouds,QS),_u(h.transform,Un,QS[3],QS)}oe(t.cameraPositionLastFrame,e.eye)}function qpt(t){return t.crossFade.enabled||t.fadeInOut.stage!==Jn.FINISHED||t.fadeIn.stage!==hu.FINISHED||t.fadeInOutHeight.stage!==Y1.FINISHED||t.renderingStage!==tn.FINISHED}const xhe=Ee(0,0,1),QS=Y0(),Xm=C(),Wpt=C(),gMe=1,Zpt=.5,Xpt=1.3,Ypt=1;let EO=class{constructor(){this._outer=new Map}clear(){this._outer.clear()}get empty(){return this._outer.size===0}get(e,r){return this._outer.get(e)?.get(r)}set(e,r,i){const s=this._outer.get(e);s?s.set(r,i):this._outer.set(e,new Map([[r,i]]))}delete(e,r){const i=this._outer.get(e);i&&(i.delete(r),i.size===0&&this._outer.delete(e))}forEach(e){this._outer.forEach((r,i)=>e(r,i))}};var wn;function The(t=!le("disable-feature:high-quality-idle"),e=null){const r=new EO;return t?(r.set(Br.IDLE,wn.Antialiasing,e!=="low"),r.set(Br.IDLE,wn.HighResolutionAtmosphere,e!=="low"),r.set(Br.IDLE,wn.HighQualityTransparency,!0),r.set(Br.IDLE,wn.SSAO,!0),r.set(Br.IDLE,wn.WaterReflection,!0),r.set(Br.IDLE,wn.PhysicalPixelRendering,!le("esri-mobile"))):(r.set(Br.ANIMATING,wn.HighResolutionShadows,!0),r.set(Br.INTERACTING,wn.HighResolutionShadows,!0)),r.set(Br.IDLE,wn.HighResolutionShadows,!0),r.set(Br.IDLE,wn.HighResolutionVoxel,!0),r}(function(t){t[t.Antialiasing=0]="Antialiasing",t[t.HighQualityTransparency=1]="HighQualityTransparency",t[t.HighResolutionVoxel=2]="HighResolutionVoxel",t[t.HighResolutionAtmosphere=3]="HighResolutionAtmosphere",t[t.SSAO=4]="SSAO",t[t.WaterReflection=5]="WaterReflection",t[t.HighResolutionShadows=6]="HighResolutionShadows",t[t.PhysicalPixelRendering=7]="PhysicalPixelRendering"})(wn||(wn={}));var VC;(function(t){t[t.Immediate=0]="Immediate",t[t.Faded=1]="Faded"})(VC||(VC={}));var hM;const Jpt=[fe.POSTPROCESSING_ENVIRONMENT_OPAQUE,fe.POSTPROCESSING_ENVIRONMENT_TRANSPARENT];let ga=hM=class extends me{constructor(t){super(t),this._context=null,this._atmosphere=null,this._oldWeatherParameters=new fB,this._newWeatherParameters=new fB,this._fadedWeatherParameters=new fB,this._weatherParameters=this._newWeatherParameters}initialize(){this.view._stage.addRenderPlugin(Jpt,this)}destroy(){this.removeHandles(),this.uninitializeRenderContext(),this.view?._stage!=null&&this.view._stage.removeRenderPlugin(this),this._set("view",null)}get atmosphere(){return this._atmosphere}get _atmosphereType(){return this.atmosphere!=null?this.atmosphere.type:Ga.None}get canRender(){return!(this._atmosphere===null&&this._stars===null)}get needsLinearDepth(){return this._atmosphereType===Ga.Realistic}updateAnimation(t){return this._precipitation!=null&&this._precipitation.update(t)}get updating(){return this._stars!=null&&this._stars.updating||this._clouds!=null&&this._clouds.running}get weatherVisible(){return Oe(this.view.state.camera.eye)-Ir(this.view.spatialReference).radius<=Gm}get _stars(){const t=this.view,e=t.environment?.starsEnabled??!1,r=this._get("_stars");return e&&this._context!=null?r??new Rv({view:t,requestRender:()=>this._setNeedsRender()}):(Re(r),null)}get _precipitation(){const t=this._get("_precipitation");if(!this._precipitationEnabled||this._context==null)return Re(t),null;const e=this.view,r=this._context;return t!=null&&t.context===r?t:(Re(t),new ox({context:r,view:e}))}get _clouds(){const t=this._get("_clouds");if(!this.weatherEnabled||this._context==null)return Re(t),null;if(t!=null)return t;const e=this.view,r=this._context;return Re(t),new nc({context:r,view:e,requestRender:()=>this._setNeedsRender()})}get _cloudsComposition(){const t=this._get("_cloudsComposition");if(!this.weatherEnabled||this._context==null)return Re(t),null;const e=this.view.state.viewingMode,r=this._context.renderContext.rctx,i=Ir(this.view.spatialReference).radius;return t!=null&&t.viewingMode===e&&t.planetRadius===i?t:(Re(t),new ix({rctx:r,viewingMode:e,planetRadius:i,requestRender:()=>this._setNeedsRender()}))}get _fog(){const t=this._get("_fog");if(!this.weatherEnabled||this._context==null)return Re(t),null;if(t!=null)return t;const e=this.view,r=this._context,i=this._context.renderContext.rctx,s=this.view.state.viewingMode;return new sx({context:r,view:e,rctx:i,viewingMode:s})}get weatherEnabled(){return!!this.view?.environmentManager?.weatherEnabled}get _precipitationEnabled(){return this.weatherEnabled&&(this.view.environment.weather.type==="rainy"||this.view.environment.weather.type==="snowy")}initializeRenderContext(t=null){this._context=t;const e=()=>this._setNeedsRender();this.addHandles([Q(()=>({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),r=>this._updateAtmosphere(r),Ri),Q(()=>this._stars,e),Q(()=>this._precipitation,e),Q(()=>this._clouds,()=>this._updateWeather(),xt),Q(()=>this._fog,()=>this._updateFogHaze(),xt),Q(()=>this.view.state.mode,()=>{this._setNeedsRender()},Rr),Q(()=>this._weatherUpdateParameters,()=>{this._updateWeather(),this._updateFogHaze()},Ri)])}uninitializeRenderContext(){this._context=null,this._atmosphere=Re(this._atmosphere),this._set("_stars",Re(this._stars)),this._set("_precipitation",Re(this._precipitation)),this._set("_clouds",Re(this._clouds)),this._set("_cloudsComposition",Re(this._cloudsComposition)),this._set("_fog",Re(this._fog))}prepareRender(t){t.bindParameters.cloudsFade.data=Pht(this._clouds)?this._clouds:null,this.view.viewingMode!=="local"&&t.bindParameters.cloudsFade.data?.cubeMap!=null&&(Hpt(t.bindParameters.cloudsFade,t.bindParameters.camera,this.view.state.mode,t.time,this.view.qualitySettings.fadeDuration),this._updateWeatherFading(t.bindParameters),t.bindParameters.cloudsFade.renderingStage===tn.FINISHED&&this._clouds!=null&&this._clouds.coverage===0&&this._clouds.running===!1&&(this._clouds.destroyFrameBufferCube(),t.bindParameters.cloudsFade.data=null))}render(t){if(t.output===k.Color)switch(t.bindParameters.slot){case fe.POSTPROCESSING_ENVIRONMENT_OPAQUE:this._stars!=null&&this._stars.render(t),this.atmosphere!=null&&(this.atmosphere.render(t,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(wn.HighResolutionAtmosphere)),this._cloudsComposition!=null&&t.bindParameters.cloudsFade.data!=null&&(this.weatherVisible&&this._clouds!=null&&this._clouds.updateWeatherTile(),this._cloudsComposition.render(t)),qpt(t.bindParameters.cloudsFade)&&this._context!=null&&t.bindParameters.cloudsFade.data?.cubeMap!=null&&this._context.requestRender());break;case fe.POSTPROCESSING_ENVIRONMENT_TRANSPARENT:if(this.atmosphere!=null&&(this.atmosphere.renderHaze(t,this._weatherParameters.hazeAmount,this.view?.qualitySettings.highResolutionAtmosphere||this.view?._stage?.renderer?.isFeatureEnabled(wn.HighResolutionAtmosphere)),this._weatherParameters.fog.amount>0&&this._fog!=null&&this._fog.render(t,this._weatherParameters.fog),this._precipitation!=null)){const e=this.view.environment.weather;e.type!=="rainy"&&e.type!=="snowy"||this._precipitation.render(t,e.precipitation,e.type)}}}updateLightSources(t,e,r,i){if(this._context!=null){const s=this._context.renderContext;s.bindParameters.oldLighting.copyFrom(s.bindParameters.lighting),s.bindParameters.newLighting.noonFactor=e,s.bindParameters.newLighting.globalFactor=r,s.bindParameters.newLighting.set(t),i===VC.Faded||s.bindParameters.weatherFading?s.bindParameters.fadeLighting(0):s.bindParameters.fadeLighting(1),this._context.requestRender()}}get _weatherUpdateParameters(){const t=this.weatherEnabled?this.view.environment.weather:null;return t==null?null:t.type==="rainy"||t.type==="snowy"?{type:t.type,weatherAdjustment:t.cloudCover,effect:t.precipitation}:{type:t.type,weatherAdjustment:t.type==="foggy"?t.fogStrength:t.cloudCover}}_updateWeatherFading(t){if(!t.weatherFading)return;const e=t.cloudsFade;return e.fadeIn.stage===hu.FADE_IN?(t.fadeLighting(e.fadeIn.factor),void this._fadeWeather(e.fadeIn.factor)):e.fadeInOut.stage===Jn.FADE_IN?(t.fadeLighting(e.fadeInOut.factor),void this._fadeWeather(e.fadeInOut.factor)):e.crossFade.enabled?(t.fadeLighting(e.crossFade.factor),void this._fadeWeather(e.crossFade.factor)):(t.fadeLighting(0),void this._fadeWeather(0))}_fadeWeather(t){const{_newWeatherParameters:e,_oldWeatherParameters:r}=this;t>=1?this._weatherParameters=e:(this._fadedWeatherParameters.lerp(r,e,t),this._weatherParameters=this._fadedWeatherParameters)}_updateWeather(){const t=this._weatherUpdateParameters;t!=null&&this._clouds!=null&&(this._clouds.applyPreset(Ba[t.type],t.weatherAdjustment),this._setNeedsRender())}_setNeedsRender(){this._context!=null&&this._context.requestRender()}_updateFogHaze(){const t=this._weatherUpdateParameters;if(this._fog==null||t==null||this._context==null)return;const e=this._context.renderContext.bindParameters;switch(this._oldWeatherParameters.copyFrom(this._weatherParameters),t.type){case"foggy":this._newWeatherParameters.fog.strength=Et(3e-5,.005,t.weatherAdjustment**3),oe(this._newWeatherParameters.fog.color,She),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;case"rainy":this._newWeatherParameters.fog.strength=Et(4e-6,2e-4,(t.effect??0)**3),oe(this._newWeatherParameters.fog.color,Qpt),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=0,this._setNeedsRender();break;case"snowy":this._newWeatherParameters.fog.strength=Et(4e-6,2e-4,(t.effect??0)**3),oe(this._newWeatherParameters.fog.color,She),this._newWeatherParameters.fog.amount=1,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender();break;default:this._newWeatherParameters.fog.strength=0,this._newWeatherParameters.fog.amount=0,this._newWeatherParameters.hazeAmount=1,this._setNeedsRender()}e.weatherFading?this._fadeWeather(0):this._fadeWeather(1)}_updateAtmosphere(t){const e=this._selectAtmosphereType(t);if(e!==Ga.None&&this._context){if(!this._atmosphere||this._atmosphere.type!==e){this._atmosphere=Re(this._atmosphere);const r=this._getAtmosphereClass(e);r&&(this._atmosphere=new r(this.view,this._context))}}else this._atmosphere=Re(this._atmosphere);this._setNeedsRender()}_getAtmosphereClass(t){switch(t){case Ga.Realistic:return Gue;case Ga.Local:return gpt;case Ga.Mars:return wpt;default:case Ga.None:return null}}_selectAtmosphereType(t){const{enabled:e,viewingMode:r}=t;return!e||$g(this.view.spatialReference)?Ga.None:r===Ue.Local?Ga.Local:this._context!=null&&Gue.isSupported(this._context)&&NI(this.view.spatialReference)?Ga.Realistic:Pg(this.view.spatialReference)?Ga.Mars:Ga.None}get test(){return{atmosphere:this._atmosphere,clouds:this._clouds,selectAtmosphereType:()=>this._selectAtmosphereType({viewingMode:this.view.state.viewingMode,enabled:this.view.environment.atmosphereEnabled}),stubGetAtmosphereClass:t=>{Ehe=hM.prototype._getAtmosphereClass,hM.prototype._getAtmosphereClass=t},restoreGetAtmosphereClass:()=>{hM.prototype._getAtmosphereClass=Ehe}}}};u([d({constructOnly:!0})],ga.prototype,"view",void 0),u([d({readOnly:!0})],ga.prototype,"atmosphere",null),u([d({readOnly:!0})],ga.prototype,"_atmosphereType",null),u([d({type:Boolean,readOnly:!0})],ga.prototype,"updating",null),u([d({readOnly:!0})],ga.prototype,"weatherVisible",null),u([d()],ga.prototype,"_context",void 0),u([d()],ga.prototype,"_atmosphere",void 0),u([d({readOnly:!0})],ga.prototype,"_stars",null),u([d({readOnly:!0})],ga.prototype,"_precipitation",null),u([d({readOnly:!0})],ga.prototype,"_clouds",null),u([d({readOnly:!0})],ga.prototype,"_cloudsComposition",null),u([d({readOnly:!0})],ga.prototype,"_fog",null),u([d({readOnly:!0})],ga.prototype,"weatherEnabled",null),u([d({readOnly:!0})],ga.prototype,"_precipitationEnabled",null),u([d({readOnly:!0})],ga.prototype,"_weatherUpdateParameters",null),ga=hM=u([R("esri.views.3d.environment.EnvironmentRenderer")],ga);let fB=class{constructor(){this.fog=new Pdt,this.hazeAmount=1}copyFrom(e){this.fog.amount=e.fog.amount,this.hazeAmount=e.hazeAmount,this.fog.strength=e.fog.strength,oe(this.fog.color,e.fog.color)}lerp(e,r,i){this.fog.amount=Et(e.fog.amount,r.fog.amount,i),this.hazeAmount=Et(e.hazeAmount,r.hazeAmount,i),this.fog.strength=Et(e.fog.strength,r.fog.strength,i),Wr(this.fog.color,e.fog.color,r.fog.color,i)}};const Qpt=Ee(.5,.5,.5),She=Ee(1.5,1.5,1.5);let Ehe;function Che(t,e,r){if(e.longitude==null||e.latitude==null||r.longitude==null||r.latitude==null)throw new Error("Invalid points: no lon/lat");return Kpt(t,e.longitude,e.latitude,r.longitude,r.latitude)}function Kpt(t,e,r,i,s){const n=zt(r),o=zt(s),a=n-o,l=zt(e)-zt(i),c=Math.sin(a/2),h=Math.sin(l/2),p=2*Gd(Math.sqrt(c*c+Math.cos(n)*Math.cos(o)*h*h))*t;return Math.round(1e4*p)/1e4}function eft(t,e,r){const i=e.spatialReference,s=Ir(i),n=new ht(e.x,t.y,i),o=new ht(r.x,t.y,i),a=new ht(t.x,e.y,i),l=new ht(t.x,r.y,i);return{lon:Che(s.radius,n,o),lat:Che(s.radius,a,l)}}function tft(t,e,r){const i=e/r,s=zt(t),n=Math.sin(i/2),o=Math.cos(s),a=2*Gd(Math.sqrt(n*n/(o*o)));return Vl(a)}function rft(t,e){let r=t/15;return e||(r=Math.round(r)),r}function Ahe(t,e){const r=t?.[0];if(r==null)return null;e||(e={hours:0,minutes:0,seconds:0}),e.hours=rft(r,!0);const i=e.hours%1;e.hours-=i,e.minutes=60*i;const s=e.minutes%1;return e.minutes-=s,e.seconds=Math.round(60*s),e}var Ohe,Rhe,Mhe,tY={exports:{}};tY.exports,Ohe=tY,Rhe=function(){var t=Math.PI,e=Math.sin,r=Math.cos,i=Math.tan,s=Math.asin,n=Math.atan2,o=Math.acos,a=t/180,l=864e5,c=2440588,h=2451545,p={dec:0,ra:0};function f(I){return I.valueOf()/l-.5+c}function m(I){return new Date((I+.5-c)*l)}function g(I){return f(I)-h}var _=23.4397*a;function v(I,V){return n(e(I)*r(_)-i(V)*e(_),r(I))}function b(I,V){return s(e(V)*r(_)+r(V)*e(_)*e(I))}function x(I,V,z){return n(e(I),r(I)*e(V)-i(z)*r(V))}function T(I,V,z){return s(e(V)*e(z)+r(V)*r(z)*r(I))}function S(I,V){return a*(280.16+360.9856235*I)-V}function O(I){return a*(357.5291+.98560028*I)}function A(I){return a*(1.9148*e(I)+.02*e(2*I)+3e-4*e(3*I))}function M(I,V){return I+V+102.9372*a+t}function P(I,V){var z=O(I),H=M(z,A(z));return V||(V={dec:0,ra:0}),V.dec=b(H,0),V.ra=v(H,0),V}var F={PolarException:{NORMAL:0,MIDNIGHT_SUN:1,POLAR_NIGHT:2},getPosition:function(I,V,z,H){var Y=a*-z,te=a*V,ne=g(I),ve=P(ne,p),Fe=S(ne,Y)-ve.ra;return H||(H={azimuth:0,altitude:0}),H.azimuth=x(Fe,te,ve.dec),H.altitude=T(Fe,te,ve.dec),H}},$=[[-.83,"sunrise","sunset"]];F.addTime=function(I,V,z){$.push([I,V,z])};var N=9e-4;function U(I,V){return Math.round(I-N-V/(2*t))}function X(I,V,z){return N+(I+V)/(2*t)+z}function Z(I,V,z){return h+I+.0053*e(V)-.0069*e(2*z)}function G(I,V,z){return o((e(I)-e(V)*e(z))/(r(V)*r(z)))}function ee(I){var V=a*(134.963+13.064993*I),z=a*(93.272+13.22935*I),H=a*(218.316+13.176396*I)+6.289*a*e(V),Y=5.128*a*e(z),te=385001-20905*r(V);return{ra:v(H,Y),dec:b(H,Y),dist:te}}return F.getTimes=function(I,V,z){var H=a*-z,Y=a*V,te=U(g(I),H),ne=X(0,H,te),ve=O(ne),Fe=A(ve),bt=M(ve,Fe),Pt=b(bt,0),dt=Z(ne,ve,bt);function wt(pt){return Z(X(G(pt,Y,Pt),H,te),ve,bt)}function be(pt){var He=(e(pt)-e(Y)*e(Pt))/(r(Y)*r(Pt));return He<-1?F.PolarException.MIDNIGHT_SUN:He>1?F.PolarException.POLAR_NIGHT:F.PolarException.NORMAL}var Me,Ct,we,je,Ze,yt={solarNoon:m(dt),nadir:m(dt-.5),polarException:F.PolarException.NORMAL};for(Me=0,Ct=$.length;Me<Ct;Me+=1)Ze=dt-((je=wt((we=$[Me])[0]*a))-dt),yt[we[1]]=m(Ze),yt[we[2]]=m(je);return yt.polarException=be($[0][0]*a),yt},F.getMoonPosition=function(I,V,z){var H=a*-z,Y=a*V,te=g(I),ne=ee(te),ve=S(te,H)-ne.ra,Fe=T(ve,Y,ne.dec);return Fe+=.017*a/i(Fe+10.26*a/(Fe+5.1*a)),{azimuth:x(ve,Y,ne.dec),altitude:Fe,distance:ne.dist}},F.getMoonFraction=function(I){var V=g(I),z=P(V),H=ee(V),Y=149598e3,te=o(e(z.dec)*e(H.dec)+r(z.dec)*r(H.dec)*r(z.ra-H.ra)),ne=n(Y*e(te),H.dist-Y*r(te));return(1+r(ne))/2},F},(Mhe=Rhe())!==void 0&&(Ohe.exports=Mhe);const GT=p$(tY.exports),Il={local:{altitude:1500,ambientAtNight:.1,ambientAtNoon:.45,ambientAtTwilight:.2,directAtNoon:.65,directAtTwilight:.7},global:{altitude:8e5,ambient:.015,direct:.75},planarDirection:{localAltitude:1e4,globalAltitude:1e6,globalAngles:{azimuth:1.3*Math.PI,altitude:.6*Math.PI}}};let MD=class{constructor(e,r){this.direct=e,this.ambient=r}};function ift(t,e,r,i,s,n){ie(n.ambient.color,1,1,1),n.ambient.intensity=Il.global.ambient,ie(n.direct.color,1,1,1),n.direct.intensity=Il.global.direct;const o=e[2],a=ye((Math.abs(o)-Il.local.altitude)/(Il.global.altitude-Il.local.altitude),0,1);let l;if(n.globalFactor=a,t!=null&&(l=GT.getTimes(t,e[1],e[0])),a<1){let c;if(t!=null)c=uft(t,l,i);else{const h=vMe(i);c={direct:{intensity:Il.local.directAtNoon*h.direct,color:Ee(1,1,1)},ambient:{intensity:Il.local.ambientAtNoon*h.ambient,color:Ee(1,1,1)},timeOfDay:"early afternoon"}}Wr(n.ambient.color,c.ambient.color,n.ambient.color,a),n.ambient.intensity=Et(c.ambient.intensity,n.ambient.intensity,a),Wr(n.direct.color,c.direct.color,n.direct.color,a),n.direct.intensity=Et(c.direct.intensity,n.direct.intensity,a),n.specularStrength=i==="rainy"||i==="snowy"||i==="foggy"?0:1,n.environmentStrength=i==="rainy"?.7:i==="snowy"||i==="foggy"?.75:1}n.noonFactor=t!=null?cft(t,l):1,t!=null?sft(t,e,r,n.direct.directionToLightSource):yMe(s,r,n.direct.directionToLightSource)}function yMe(t,e,r){e===Ue.Global?_e(_B,t.eye):ie(_B,0,0,1),ae(vB,t.viewForward,-1);const i=k4(vB,_B),s=Math.max(i-2*bB,0),n=.85*s/(s+1),o=Math.max(bB,i-bB-n);Th(zhe,-o,t.viewRight),Ne(r,vB,zhe),ue(r,r,ae(hft,t.viewRight,dft)),_e(r,r)}function sft(t,e,r,i){const s=lft,n=jd(aft);if(r===Ue.Global)GT.getPosition(t,0,0,s),ie(i,0,0,-1),dA(n,n,-s.azimuth),bV(n,n,-s.altitude),Ne(i,i,n);else{const o=Il.planarDirection,a=o.globalAngles,l=e[2];let c=(Math.abs(l)-o.localAltitude)/(o.globalAltitude-o.localAltitude);c=ye(c,0,1),c<1?(GT.getPosition(t,e[1],e[0],s),s.azimuth=(1-c)*s.azimuth+c*a.azimuth,s.altitude=(1-c)*s.altitude+c*a.altitude):(s.azimuth=a.azimuth,s.altitude=a.altitude),ie(i,0,-1,0),pA(n,n,-s.azimuth),dA(n,n,-s.altitude),Ne(i,i,n)}}function nft(t,e){if(e===Ue.Global)return!0;const r=Il.planarDirection;return Math.abs(t)<r.localAltitude}const oft=Ee(.5773502691896258,-.5773502691896258,.5773502691896258);let _Me=class{constructor(){this.ambient={color:Ee(1,1,1),intensity:.55},this.direct={color:Ee(1,1,1),intensity:.55,directionToLightSource:$i(oft)},this.noonFactor=.5,this.globalFactor=0,this.specularStrength=1,this.environmentStrength=1}};const aft=xe(),lft={azimuth:0,altitude:0};function cft(t,e){const r=t.valueOf();let i,s;e.polarException===GT.PolarException.MIDNIGHT_SUN?(i=r-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,s=i+432e6):e.polarException===GT.PolarException.POLAR_NIGHT?(i=r-2,s=r-1):(i=e.sunrise.valueOf(),s=e.sunset.valueOf());const n=i+(s-i)/2;return 1-ye(Math.abs(r-n)/432e5,0,1)}function vMe(t){switch(t){case"disabled":case"sunny":case"cloudy":return new MD(1,1);case"rainy":return new MD(.4,1.2);case"snowy":return new MD(.5,1.3);case"foggy":return new MD(.2,1.6)}}function Ihe(t,e){const r=(t[0]+t[1]+t[2])/3;t[0]+=(r-t[0])*e,t[1]+=(r-t[1])*e,t[2]+=(r-t[2])*e}const mB=Ee(.01,.01,.01),rY=Ee(1,.6,.5),iY=Ee(1,.98,.98),Phe=Ee(1,1,1),gB=Ee(.8,.8,1),sY=Ee(.8,.8,1),nY=Ee(.98,.98,1),$he=Ee(1,1,1),yB=yr(.01,Il.local.ambientAtNight),oY=yr(Il.local.directAtTwilight,Il.local.ambientAtTwilight),aY=yr(.9*Il.local.directAtNoon,Il.local.ambientAtNoon),Lhe=yr(Il.local.directAtNoon,Il.local.ambientAtNoon),Dhe=aY,Nhe=iY,Fhe=nY,khe=oY,Uhe=rY,Vhe=sY;function uft(t,e,r){const i=t.valueOf();let s,n;e.polarException===GT.PolarException.MIDNIGHT_SUN?(s=i-60*(t.getHours()+48)*60*1e3-60*t.getMinutes()*1e3,n=s+432e6):e.polarException===GT.PolarException.POLAR_NIGHT?(s=i-2,n=i-1):(s=e.sunrise.valueOf(),n=e.sunset.valueOf());const o=n-s,a=s+o/2,l=o/4,c=a-l,h=a+l,p=.06*o,f=s-p/2,m=s+p/2,g=n-p/2,_=n+p/2,v=Pe(),b=C(),x=C();let T="";if(i<f||i>_)jn(v,yB),oe(b,mB),oe(x,gB),T="night";else if(i<m){const A=(i-f)/(m-f);ah(v,yB,oY,A),Wr(b,mB,rY,A),Wr(x,gB,sY,A),T="sun rising"}else if(i<c){const A=(i-m)/(c-m);ah(v,oY,aY,A),Wr(b,rY,iY,A),Wr(x,sY,nY,A),T="early morning"}else if(i<a){const A=(i-c)/(a-c);ah(v,aY,Lhe,A),Wr(b,iY,Phe,A),Wr(x,nY,$he,A),T="late morning"}else if(i<h){const A=(i-a)/(h-a);ah(v,Lhe,Dhe,A),Wr(b,Phe,Nhe,A),Wr(x,$he,Fhe,A),T="early afternoon"}else if(i<g){const A=(i-h)/(g-h);ah(v,Dhe,khe,A),Wr(b,Nhe,Uhe,A),Wr(x,Fhe,Vhe,A),T="late afternoon"}else if(i<_){const A=(i-g)/(_-g);ah(v,khe,yB,A),Wr(b,Uhe,mB,A),Wr(x,Vhe,gB,A),T="sun setting"}let S=0;switch(r){case"rainy":case"foggy":S=.8;break;case"snowy":S=.5}S>0&&(Ihe(b,S),Ihe(x,S));const O=vMe(r);return{direct:{intensity:v[0]*O.direct,color:b},ambient:{intensity:v[1]*O.ambient,color:x},timeOfDay:T}}const zhe=xe(),_B=C(),vB=C(),hft=C(),bB=.25,dft=.2;let kp=class extends Xr.EventedAccessor{constructor(){super(),this._referencePointUpdateDelay=200,this._referencePointUpdateInterval=3e3,this._referencePointUpdateDistThreshold=1e6,this._referencePosUpdateQuery=null,this._referencePosMapCoordsRequested=null,this._viewHandles=new li,this._preserveAbsoluteDateTime=!1,this._trackingEnabled=!1,this._referencePosResetPreserveAbsoluteTime=!1,this._referencePosUpdateTimer=null,this._referencePosMapCoords=null,this._mainLight=new yU,this._ambientLight=new Hte,this._moonLight=new M3e,this.disableQueries=!1,this._disableWeather=!1,this._renderer=null,this._referencePosWGS84Comparable=null,this._resetReferencePosition()}destroy(){this.disconnectView(),this._viewHandles.destroy()}get _view(){return this._renderer?.view}get updating(){return!((this.disableQueries||!this._referencePosUpdateQuery&&!this._referencePosMapCoordsRequested)&&!this._renderer?.updating)}get weatherEnabled(){return this._view?.environment.atmosphereEnabled&&!this._disableWeather&&this._view?.state?.viewingMode===Ue.Global&&NI(this._view.spatialReference)}get weatherVisible(){return this.weatherEnabled&&this._renderer?.weatherVisible}get referencePositionWGS84Comparable(){return this._referencePosWGS84Comparable}connectView(e){if(this._renderer)return;this._renderer=new ga({view:e});const r=()=>this._updateRenderParameters(),i=()=>this._cameraHandler();this._viewHandles.add([Q(()=>e.environment.lighting,s=>this._updateLightingHandler(s),Rr),Q(()=>e.environment.lighting.type!=="virtual"?e.environment.lighting.date:null,s=>this._lightingDateHandler(s),Rr),Q(()=>e.stationary,()=>this._interactingStationaryHandler()),Q(()=>e.environment.lighting.directShadowsEnabled,r,Rr),Q(()=>e.qualitySettings.ambientOcclusion,r,Rr),Q(()=>e.qualitySettings.reflections,r,Rr),Q(()=>e.environment.background?.color,r,Rr),Q(()=>e.spatialReference,()=>this._resetReferencePosition(!0),Rr),Q(()=>e.environment.weather.type,()=>this._updateLighting(null,VC.Faded),Rr),Q(()=>this.weatherEnabled,()=>this._updateLighting(null,VC.Faded),Rr),Q(()=>e.viewingMode,()=>this._resetReferencePosition(!0),Ri),Q(()=>e.environment.lighting.type!=="virtual"&&e.environment.lighting.cameraTrackingEnabled,s=>this._updateCameraTracking(s),Ri),Q(()=>e.state.camera,i,Ri),Q(()=>this.disableQueries,i)]),this._updateRenderParameters(),this._updateLighting(),this._cameraHandler(),this.notifyChange("updating")}disconnectView(){this._viewHandles.removeAll(),this._resetReferencePosition(),this._renderer=Re(this._renderer)}_updateLightingHandler(e){this._updateCameraTracking(e.type!=="virtual"&&e.cameraTrackingEnabled),this._lightingDateHandler(e.type!=="virtual"?e.date:null),this._updateRenderParameters()}_updateCameraTracking(e){if(this._trackingEnabled=e,e)this._cameraHandler();else{const r=this._view.environment.lighting;r?.type!=="virtual"&&(r.positionTimezoneInfo.autoUpdated=!1)}}_lightingDateHandler(e){const r=this._view.environment.lighting;if(r?.type!=="virtual"){if(e){if(!r.positionTimezoneInfo.autoUpdated){this._preserveAbsoluteDateTime=!0;const i=this._view.spatialReference;if(!H1(i)){const s=this._view.camera.position;if(!this._referencePosMapCoords||!this._referencePosMapCoords.equals(s))return void this._requestReferencePositionUpdate(s)}if(this._preupdateTracking(e),this._referencePosWGS84Comparable!=null){const s=Ahe(this._referencePosWGS84Comparable,Bhe);s!=null&&(r.autoUpdate(null,s),this._trackingEnabled&&(r.positionTimezoneInfo.autoUpdated=!0))}}this._updateLighting(e)}}else this._updateLighting()}_preupdateTracking(e){!this._trackingEnabled&&this._view.environment.lighting.type!=="virtual"&&this._view.environment.lighting.cameraTrackingEnabled&&this._cameraHandler(e)}_cameraHandler(e=null){const r=this._view;if(!r.ready)return;const i=r.stateManager.camera;i&&(this._cameraHandlerClientSide(i,e)||this._cameraHandlerServerSide(i))}_cameraHandlerClientSide(e,r){const i=NI(this._view.spatialReference);if(i&&!H1(this._view.spatialReference))return this._view.environment.lighting.type==="virtual"&&this._updateLighting(),!1;const s=e.position;return this._referencePosWGS84Comparable==null&&(this._referencePosWGS84Comparable=C()),i?V2e(s,this._referencePosWGS84Comparable):ie(this._referencePosWGS84Comparable,s.longitude??0,s.latitude??0,s.z??0),this.notifyChange("referencePositionWGS84Comparable"),this._autoUpdateTimezone(this._referencePosWGS84Comparable,r)||this._updateLighting(r),!0}_cameraHandlerServerSide(e){const r=e.position;(!this._referencePosMapCoords||this._referencePosMapCoordsRequested||this._exceedsReferencePosDistThreshold(r))&&this._requestReferencePositionUpdate(r,!0),this._view.mapCoordsHelper&&this._referencePosWGS84Comparable&&(this._referencePosWGS84Comparable[2]=(r.z??0)*this._view.mapCoordsHelper.unitInMeters,this._referencePosChanged())}_interactingStationaryHandler(){this._view.stationary&&this._executePendingReferencePositionUpdate()}_updateLighting(e,r=VC.Immediate){const i=this._view;e=e||(i.environment.lighting.type==="virtual"?null:i.environment.lighting.date);const s=this._referencePosWGS84Comparable,n=s!=null?pft:fft,o=this.weatherVisible?i.environment.weather.type:"disabled";s!=null?ift(e,s,i.state.viewingMode,o,i.state.camera,n):i.environment.lighting.type==="virtual"&&yMe(i.state.camera,i.state.viewingMode,n.direct.directionToLightSource);const a=this._mainLight,l=n.direct;ae(a.intensity,l.color,l.intensity*Math.PI),oe(a.direction,l.directionToLightSource),a.specularStrength=n.specularStrength,a.environmentStrength=n.environmentStrength;const c=this._ambientLight;ae(c.intensity,n.ambient.color,n.ambient.intensity);const h=this._moonLight;Wr(h.intensity,gft,yft,n.globalFactor);const p=(1-.5*n.globalFactor)*(1-.4*n.noonFactor*(1-n.globalFactor));ae(h.intensity,h.intensity,p),oe(h.direction,l.directionToLightSource),this._renderer.updateLightSources([a,c,h],n.noonFactor,n.globalFactor,r),this._updateRenderParameters()}_autoUpdateTimezone(e,r=null){if(this._view.environment.lighting.type==="virtual"||!this._view.environment.lighting.cameraTrackingEnabled||e==null)return!1;const i=mft;i.setTime((r||this._view.environment.lighting.date).getTime());const s=Ahe(e,Bhe);if(s==null)return!1;let n=this._view.environment.lighting.positionTimezoneInfo;if(n.autoUpdated){if(n.hours===s.hours&&n.minutes===s.minutes&&n.seconds===s.seconds)return!1}else n=s;const o=i.getUTCHours()-(s.hours-n.hours),a=i.getUTCMinutes()-(s.minutes-n.minutes),l=i.getUTCSeconds()-(s.seconds-n.seconds);return i.setUTCHours(o),i.setUTCMinutes(a),i.setUTCSeconds(l),!r&&this._view.environment.lighting.autoUpdate(i,s)}_updateRenderParameters(){const e=this._view._stage;if(!e)return;const r=this._referencePosWGS84Comparable==null||nft(this._referencePosWGS84Comparable[2],this._view.state.viewingMode),i=this._view.environment.background,s=i instanceof BRe?{type:"color",color:jK(Le.toUnitRGBA(i.color))}:{type:"color",color:Vt(0,0,0,1)};e.renderer.setParameters({shadowMap:this._view.environment.lighting.directShadowsEnabled&&r,background:s,environment:this._view.environment,weatherVisible:this._view.environmentManager.weatherVisible,qualitySettings:this._view.qualitySettings})}_resetReferencePosition(e=!1){this._cancelReferencePosUpdates(),this._referencePosMapCoords=null,this._referencePosMapCoordsRequested=null,this._referencePosResetPreserveAbsoluteTime=null,this._referencePosWGS84Comparable=null,this.notifyChange("updating"),e&&this._cameraHandler()}_requestReferencePositionUpdate(e,r=!1){if(!this.disableQueries&&(this._referencePosMapCoordsRequested?this._referencePosMapCoordsRequested.copy(e):this._referencePosMapCoordsRequested=e.clone(),this._referencePosResetPreserveAbsoluteTime=!!r,!this._referencePosUpdateQuery&&!this._referencePosUpdateTimer&&this._view.stationary)){const i=this._referencePosUpdateQuery=YC(this._referencePointUpdateDelay).then(()=>{if(this._referencePosUpdateQuery===i){const n=()=>this._referencePosUpdateQuery!==i;return this._doReferencePositionUpdateQuery(n)}}).catch(n=>{n.name==="mapcoordshelper:missing-geometry-service"&&(this.disableQueries=!0)}).then(()=>{this._referencePosUpdateQuery===i&&(this._referencePosUpdateQuery=null,this._referencePosUpdateTimer||this._executePendingReferencePositionUpdate(),this.notifyChange("updating"))}),s=this._referencePosUpdateTimer=YC(this._referencePointUpdateInterval).then(()=>{this._referencePosUpdateTimer===s&&(this._referencePosUpdateTimer=null,this._referencePosUpdateQuery||this._executePendingReferencePositionUpdate())});this.notifyChange("updating")}}async _doReferencePositionUpdateQuery(e){this._referencePosResetPreserveAbsoluteTime&&(this._preserveAbsoluteDateTime=!1),this._referencePosMapCoords?this._referencePosMapCoords.copy(this._referencePosMapCoordsRequested):this._referencePosMapCoords=this._referencePosMapCoordsRequested.clone(),this._referencePosResetPreserveAbsoluteTime=null,this._referencePosMapCoordsRequested=null;const r=await this._view.mapCoordsHelper.toGeographic(this._referencePosMapCoords);if(!e()&&!isNaN(r[0])&&!isNaN(r[1])){const i=(this._referencePosMapCoords.z??0)*this._view.mapCoordsHelper.unitInMeters;this._referencePosWGS84Comparable?(this._referencePosWGS84Comparable[0]=r[0],this._referencePosWGS84Comparable[1]=r[1],this._referencePosWGS84Comparable[2]=i):this._referencePosWGS84Comparable=[r[0],r[1],i],this._referencePosChanged()}}_executePendingReferencePositionUpdate(){const e=this._referencePosMapCoordsRequested;e&&this._requestReferencePositionUpdate(e,this._referencePosResetPreserveAbsoluteTime)}_referencePosChanged(){this._preserveAbsoluteDateTime?this._updateLighting():this._autoUpdateTimezone(this._referencePosWGS84Comparable)||this._updateLighting(),this.notifyChange("referencePositionWGS84Comparable")}_exceedsReferencePosDistThreshold(e){if(this._referencePosMapCoords){let r=this._referencePosMapCoords.distance(e);return this._view.mapCoordsHelper&&(r*=this._view.mapCoordsHelper.unitInMeters),r>this._referencePointUpdateDistThreshold}return!0}_cancelReferencePosUpdates(){const e=!!this._referencePosUpdateQuery;return this._referencePosUpdateQuery=null,this._referencePosUpdateTimer=null,e}get test(){const e=this;return{get renderer(){return e._renderer},set referencePointUpdateInterval(r){e._referencePointUpdateInterval=r},set referencePointUpdateDistThreshold(r){e._referencePointUpdateDistThreshold=r},set referencePosUpdateTimer(r){e._referencePosUpdateTimer=r},set referencePointUpdateDelay(r){e._referencePointUpdateDelay=r},set disableWeather(r){e._disableWeather=r}}}};u([d({type:Boolean,readOnly:!0})],kp.prototype,"updating",null),u([d()],kp.prototype,"disableQueries",void 0),u([d()],kp.prototype,"_disableWeather",void 0),u([d()],kp.prototype,"weatherEnabled",null),u([d()],kp.prototype,"weatherVisible",null),u([d()],kp.prototype,"referencePositionWGS84Comparable",null),u([d()],kp.prototype,"_renderer",void 0),u([d()],kp.prototype,"_referencePosWGS84Comparable",void 0),kp=u([R("esri.views.3d.environment.SceneViewEnvironmentManager")],kp);const pft=new _Me,fft=new _Me,mft=new Date,Bhe={hours:0,minutes:0,seconds:0},gft=Ee(.22,.22,.33),yft=Ee(.22,.22,.22);var Xi;(function(t){t[t.NONE=0]="NONE",t[t.TILT=1]="TILT",t[t.ALTITUDE=2]="ALTITUDE",t[t.DISTANCE=4]="DISTANCE",t[t.COLLISION=8]="COLLISION",t[t.ALL=15]="ALL",t[t.ALL_EXCEPT_COLLISION=7]="ALL_EXCEPT_COLLISION"})(Xi||(Xi={}));var Kt;(function(t){t[t.NONE=0]="NONE",t[t.ZOOM=1]="ZOOM",t[t.TUMBLE=2]="TUMBLE",t[t.LOOK_AROUND=3]="LOOK_AROUND",t[t.PAN=4]="PAN",t[t.ASCEND=5]="ASCEND"})(Kt||(Kt={}));var ko;(function(t){t[t.TUMBLE=0]="TUMBLE",t[t.LOOK_AROUND=1]="LOOK_AROUND"})(ko||(ko={}));function gP(t,e){return(t&e)!=0}function SU(t,e,r,i,s,n){t!==0&&(r?(n.min=Math.min(n.min,e),n.max=Math.max(n.max,e)):i!=null?(n.min-=Math.max(0,(e-n.min)*(1-i)),n.max+=Math.max(0,(e-n.max)*(1-i))):s&&(n.min-=Math.max(0,e-n.min-s),n.max+=Math.max(0,e-n.max-s)))}const K1={selection:Xi.NONE,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ko.TUMBLE};function bMe(t,e,r,i){return e=e||t.viewForward,oe(i,e),ae(i,i,Math.sign(de(e,r))),i}function _ft(t,e,r,i){return Tft(t,e,r,wft(i,e,r,!0))}function vft(t,e,r,i){const s=de(r,pe(t,i,e));return ue(t,e,ae(t,r,s))}const bft={dir:C(),len:0,clip:Pe()};function wft(t,e,r,i){const s=bft;return t?(r&&i&&(s.len=_i(e,r)),oe(s.dir,t)):i?(s.len=_i(e,r),pe(s.dir,r,e),ae(s.dir,s.dir,1/s.len)):(pe(s.dir,r,e),_e(s.dir,s.dir)),s}function xft(t,e,r){const i=de(t,r.dir),s=-Oi(t,e);if(s<0&&i>=0)return!1;if(i>-1e-6&&i<1e-6)return s>0;if((s<0||i<0)&&!(s<0&&i<0))return!0;const n=s/i;return i>0?n<r.clip[1]&&(r.clip[1]=n):n>r.clip[0]&&(r.clip[0]=n),r.clip[0]<=r.clip[1]}function Tft(t,e,r,i){i.clip[0]=0,i.clip[1]=r?i.len:Number.MAX_VALUE;for(let s=0;s<t.length;s++)if(!xft(t[s],e,i))return!1;return!0}function Sft(t,e,r=K1){const i=ire(t,e,r);if(i===0)return!1;const s=t.renderCoordsHelper,n=s.getAltitude(e.eye)+i,o=bMe(e,r.interactionDirection,Aft(t,e,Math.sign(i),Ift),Mft),a=oe(Pft,e.viewForward),l=s.intersectInfiniteManifold(Eh(e.eye,o),n,wB);return e.eye=l??s.setAltitude(wB,n,e.eye),e.center=vft(wB,e.eye,a,e.center),!0}function ire(t,e,r=K1){if(!Eft(t,r)||!t.state.constraints.altitude)return 0;const i=Oft(t.state.constraints.altitude,Rft);Cft(t,r,i);const s=t.renderCoordsHelper.getAltitude(e.eye),n=ye(s,i.min,i.max)-s;return Math.abs(n)<=1e-6?0:n}function Eft(t,e){const r=t.state.constraints.altitude;return!(!t.state.isGlobal||!r)&&(e.interactionType!==Kt.TUMBLE||!gP(e.selection,Xi.TILT))}function Cft(t,e,r){const i=e.interactionType;if(i===Kt.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===Kt.TUMBLE||i===Kt.ZOOM,c=ire(t,o),h=c===0?0:t.renderCoordsHelper.getAltitude(o.eye);r.min=s,r.max=n,SU(c,h,l,a,.05*h,r)}function Aft(t,e,r,i){return t.renderCoordsHelper.worldUpAtPosition(e.eye,i),ae(i,i,r),i}function Oft(t,e){return e.min=t.min,e.max=t.max,e}const Rft={min:0,max:0},Mft=C(),Ift=C(),Pft=C(),wB=C();function sre(t,e,r=K1){if(!t.state.isLocal)return 0;const i=t.state.constraints.distance;if(!t.pointsOfInterest.surfaceOrigin.renderLocation||i===1/0)return 0;ID.min=0,ID.max=i,Lft(t,r,ID);const s=nre(t,e),n=ID.max-s;return n>=-1e-6?0:n}function $ft(t,e,r=K1){const i=sre(t,e,r);if(i===0)return!1;const s=t.pointsOfInterest.surfaceOrigin;if(!s.renderLocation)return!1;const n=nre(t,e)+i,o=oe(Nft,e.eye),a=bMe(e,r.interactionDirection,Dft(e,s.renderLocation,Uft),kft);if(!db(NOe(s.renderLocation,n),Eh(e.eye,a),PD))return!1;e.eye=PD;const l=pe(Fft,e.eye,o);e.center=ue(PD,e.center,l);const c=t.renderCoordsHelper.getAltitude(e.center),h=t.renderCoordsHelper.intersectInfiniteManifold(e.ray,c,PD);return h!=null&&(e.center=h),!0}function Lft(t,e,r){const i=e.interactionType;if(i===Kt.NONE)return;const{min:s,max:n}=r,{interactionStartCamera:o,interactionFactor:a}=e;if(!o)return;const l=i===Kt.ZOOM||i===Kt.PAN,c=sre(t,o),h=c===0?0:nre(t,o);r.min=s,r.max=n,SU(c,h,l,a,.05*h,r)}function nre(t,e){const r=t.pointsOfInterest.surfaceOrigin;return r.renderLocation?_i(e.eye,r.renderLocation):0}function Dft(t,e,r){return F0(r,t.eye,e)}const ID={min:0,max:0},Nft=C(),Fft=C(),kft=C(),Uft=C(),PD=C();var ls,na;(function(t){t[t.OBJECT=0]="OBJECT",t[t.HUD=1]="HUD",t[t.TERRAIN=2]="TERRAIN",t[t.OVERLAY=3]="OVERLAY",t[t.I3S=4]="I3S",t[t.PCL=5]="PCL",t[t.LOD=6]="LOD",t[t.VOXEL=7]="VOXEL"})(ls||(ls={}));let Vft=class{constructor(){this.verticalOffset=0,this.selectionMode=!1,this.hud=!0,this.selectOpaqueTerrainOnly=!0,this.invisibleTerrain=!1,this.backfacesTerrain=!0,this.isFiltered=!1,this.filteredLayerUids=[],this.store=na.ALL}};(function(t){t[t.MIN=0]="MIN",t[t.MINMAX=1]="MINMAX",t[t.ALL=2]="ALL"})(na||(na={}));let zft=class{constructor(e,r,i){this.object=e,this.geometryId=r,this.triangleNr=i}},Bft=class extends zft{constructor(e,r,i,s){super(e,r,i),this.center=s!=null?$i(s):null}},wMe=class{constructor(e){this.layerUid=e}},y8=class extends wMe{constructor(e,r){super(e),this.graphicUid=r}};function Bf(t){return t!=null&&t.dist!=null}function Ghe(t){return(e,r,i)=>(Wr(jhe,e,r,i),!Cte(t,jhe))}function _8(t){return Bf(t)&&t.intersector===ls.OBJECT&&!!t.target}function v8(t){return Bf(t)&&t.intersector===ls.HUD&&!!t.target&&"center"in t.target&&t.target.center!=null}const jhe=C();let Gft=class{constructor(){this._transform=xe(),this._transformInverse=new $D({value:this._transform},so,xe),this._transformInverseTranspose=new $D(this._transformInverse,Ou,xe),this._transformTranspose=new $D({value:this._transform},Ou,xe),this._transformInverseRotation=new $D({value:this._transform},oOe,ts)}_invalidateLazyTransforms(){this._transformInverse.invalidate(),this._transformInverseTranspose.invalidate(),this._transformTranspose.invalidate(),this._transformInverseRotation.invalidate()}get transform(){return this._transform}get inverse(){return this._transformInverse.value}get inverseTranspose(){return this._transformInverseTranspose.value}get inverseRotation(){return this._transformInverseRotation.value}get transpose(){return this._transformTranspose.value}setTransformMatrix(e){an(this._transform,e)}multiplyTransform(e){yi(this._transform,this._transform,e)}set(e){an(this._transform,e),this._invalidateLazyTransforms()}setAndInvalidateLazyTransforms(e,r){this.setTransformMatrix(e),this.multiplyTransform(r),this._invalidateLazyTransforms()}},$D=class{constructor(e,r,i){this._original=e,this._update=r,this._dirty=!0,this._transform=i()}invalidate(){this._dirty=!0}get value(){return this._dirty&&(this._update(this._transform,this._original.value),this._dirty=!1),this._transform}},jft=class{constructor(e=0){this.offset=e,this.tmpVertex=C()}applyToVertex(e,r,i){const s=e+this.localOrigin[0],n=r+this.localOrigin[1],o=i+this.localOrigin[2],a=this.offset/Math.sqrt(s*s+n*n+o*o);return this.tmpVertex[0]=e+s*a,this.tmpVertex[1]=r+n*a,this.tmpVertex[2]=i+o*a,this.tmpVertex}applyToAabb(e){for(let n=0;n<3;++n)w_[n]=e[0+n]+this.localOrigin[n],LD[n]=e[3+n]+this.localOrigin[n],dR[n]=w_[n];const r=this.applyToVertex(w_[0],w_[1],w_[2]);for(let n=0;n<3;++n)e[n]=r[n],e[n+3]=r[n];const i=n=>{const o=this.applyToVertex(n[0],n[1],n[2]);for(let a=0;a<3;++a)e[a]=Math.min(e[a],o[a]),e[a+3]=Math.max(e[a+3],o[a])};for(let n=1;n<8;++n){for(let o=0;o<3;++o)dR[o]=n&1<<o?LD[o]:w_[o];i(dR)}let s=0;for(let n=0;n<3;++n)w_[n]*LD[n]<0&&(s|=1<<n);if(s!==0&&s!==7){for(let n=0;n<8;++n)if(!(s&n)){for(let o=0;o<3;++o)dR[o]=s&1<<o?0:n&1<<o?w_[o]:LD[o];i(dR)}}for(let n=0;n<3;++n)e[n]-=this.localOrigin[n],e[n+3]-=this.localOrigin[n];return e}};const w_=C(),LD=C(),dR=C();let Hft=class{constructor(e=0){this.componentLocalOriginLength=0,this._tmpVertex=C(),this._mbs=js(),this._obb={center:C(),halfSize:gs(),quaternion:null},this._totalOffset=0,this._offset=0,this._resetOffset(e)}_resetOffset(e){this._offset=e,this._totalOffset=e}set offset(e){this._resetOffset(e)}get offset(){return this._offset}set componentOffset(e){this._totalOffset=this._offset+e}set localOrigin(e){this.componentLocalOriginLength=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2])}applyToVertex(e,r,i){const s=e,n=r,o=i+this.componentLocalOriginLength,a=this._totalOffset/Math.sqrt(s*s+n*n+o*o);return this._tmpVertex[0]=e+s*a,this._tmpVertex[1]=r+n*a,this._tmpVertex[2]=i+o*a,this._tmpVertex}applyToAabb(e){const r=e[0],i=e[1],s=e[2]+this.componentLocalOriginLength,n=e[3],o=e[4],a=e[5]+this.componentLocalOriginLength,l=r*n<0?0:Math.min(Math.abs(r),Math.abs(n)),c=i*o<0?0:Math.min(Math.abs(i),Math.abs(o)),h=s*a<0?0:Math.min(Math.abs(s),Math.abs(a)),p=Math.sqrt(l*l+c*c+h*h);if(p<this._totalOffset)return e[0]-=r<0?this._totalOffset:0,e[1]-=i<0?this._totalOffset:0,e[2]-=s<0?this._totalOffset:0,e[3]+=n>0?this._totalOffset:0,e[4]+=o>0?this._totalOffset:0,e[5]+=a>0?this._totalOffset:0,e;const f=Math.max(Math.abs(r),Math.abs(n)),m=Math.max(Math.abs(i),Math.abs(o)),g=Math.max(Math.abs(s),Math.abs(a)),_=Math.sqrt(f*f+m*m+g*g),v=this._totalOffset/_,b=this._totalOffset/p;return e[0]+=r*(r>0?v:b),e[1]+=i*(i>0?v:b),e[2]+=s*(s>0?v:b),e[3]+=n*(n<0?v:b),e[4]+=o*(o<0?v:b),e[5]+=a*(a<0?v:b),e}applyToMbs(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this._totalOffset/r;return this._mbs[0]=e[0]+e[0]*i,this._mbs[1]=e[1]+e[1]*i,this._mbs[2]=e[2]+e[2]*i,this._mbs[3]=e[3]+e[3]*this._totalOffset/r,this._mbs}applyToObb(e){const r=e.center,i=this._totalOffset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);this._obb.center[0]=r[0]+r[0]*i,this._obb.center[1]=r[1]+r[1]*i,this._obb.center[2]=r[2]+r[2]*i,xu(this._obb.halfSize,e.halfSize,e.quaternion),ue(this._obb.halfSize,this._obb.halfSize,e.center);const s=this._totalOffset/Math.sqrt(this._obb.halfSize[0]*this._obb.halfSize[0]+this._obb.halfSize[1]*this._obb.halfSize[1]+this._obb.halfSize[2]*this._obb.halfSize[2]);return this._obb.halfSize[0]+=this._obb.halfSize[0]*s,this._obb.halfSize[1]+=this._obb.halfSize[1]*s,this._obb.halfSize[2]+=this._obb.halfSize[2]*s,pe(this._obb.halfSize,this._obb.halfSize,e.center),Tg(Zhe,e.quaternion),xu(this._obb.halfSize,this._obb.halfSize,Zhe),this._obb.halfSize[0]*=this._obb.halfSize[0]<0?-1:1,this._obb.halfSize[1]*=this._obb.halfSize[1]<0?-1:1,this._obb.halfSize[2]*=this._obb.halfSize[2]<0?-1:1,this._obb.quaternion=e.quaternion,this._obb}},qft=class{constructor(e=0){this.offset=e,this.sphere=js(),this.tmpVertex=C()}applyToVertex(e,r,i){const s=this.objectTransform.transform;let n=s[0]*e+s[4]*r+s[8]*i+s[12],o=s[1]*e+s[5]*r+s[9]*i+s[13],a=s[2]*e+s[6]*r+s[10]*i+s[14];const l=this.offset/Math.sqrt(n*n+o*o+a*a);n+=n*l,o+=o*l,a+=a*l;const c=this.objectTransform.inverse;return this.tmpVertex[0]=c[0]*n+c[4]*o+c[8]*a+c[12],this.tmpVertex[1]=c[1]*n+c[5]*o+c[9]*a+c[13],this.tmpVertex[2]=c[2]*n+c[6]*o+c[10]*a+c[14],this.tmpVertex}applyToMinMax(e,r){const i=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*i,e[1]+=e[1]*i,e[2]+=e[2]*i;const s=this.offset/Math.sqrt(r[0]*r[0]+r[1]*r[1]+r[2]*r[2]);r[0]+=r[0]*s,r[1]+=r[1]*s,r[2]+=r[2]*s}applyToAabb(e){const r=this.offset/Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]);e[0]+=e[0]*r,e[1]+=e[1]*r,e[2]+=e[2]*r;const i=this.offset/Math.sqrt(e[3]*e[3]+e[4]*e[4]+e[5]*e[5]);return e[3]+=e[3]*i,e[4]+=e[4]*i,e[5]+=e[5]*i,e}applyToBoundingSphere(e){const r=Math.sqrt(e[0]*e[0]+e[1]*e[1]+e[2]*e[2]),i=this.offset/r;return this.sphere[0]=e[0]+e[0]*i,this.sphere[1]=e[1]+e[1]*i,this.sphere[2]=e[2]+e[2]*i,this.sphere[3]=e[3]+e[3]*this.offset/r,this.sphere}};const Hhe=new qft;function lY(t){return t!=null?(Hhe.offset=t,Hhe):null}const qhe=new Hft;function Wft(t){return t!=null?(qhe.offset=t,qhe):null}const Whe=new jft;function Zft(t){return t!=null?(Whe.offset=t,Whe):null}const Yv="terrain",Zhe=Kd(),$A=1e-5;let Xft=class{constructor(e){this.options=new Vft,this._results=new Yft,this.transform=new Gft,this.tolerance=$A,this.verticalOffset=null,this._ray=Io(),this._rayEnd=C(),this._rayBeginTransformed=C(),this._rayEndTransformed=C(),this.viewingMode=e??Ue.Global}get results(){return this._results}get ray(){return this._ray}get rayBegin(){return this._ray.origin}get rayEnd(){return this._rayEnd}reset(e,r,i){this.resetWithRay(Oat(e,r,this._ray),i)}resetWithRay(e,r){this.camera=r,e!==this._ray&&lU(e,this._ray),this.options.verticalOffset!==0?this.viewingMode===Ue.Local?this._ray.origin[2]-=this.options.verticalOffset:this.verticalOffset=this.options.verticalOffset:this.verticalOffset=null,ue(this._rayEnd,this._ray.origin,this._ray.direction),this._results.init(this._ray)}intersect(e=null,r,i,s,n){this.point=r,this.filterPredicate=s,this.tolerance=i??$A;const o=lY(this.verticalOffset);if(e&&e.length>0){const a=n?l=>{n(l)&&this.intersectObject(l)}:l=>{this.intersectObject(l)};for(const l of e){const c=l.getSpatialQueryAccelerator&&l.getSpatialQueryAccelerator();c!=null?(o!=null?c.forEachAlongRayWithVerticalOffset(this._ray.origin,this._ray.direction,a,o):c.forEachAlongRay(this._ray.origin,this._ray.direction,a),this.options.selectionMode&&this.options.hud&&c.forEachDegenerateObject(a)):l.objects.forAll(h=>a(h))}}this.sortResults()}intersectObject(e){const r=e.geometries;if(!r)return;const i=e.shaderTransformation,s=lY(this.verticalOffset);for(const n of r){if(!n.visible)continue;const{material:o,id:a}=n;this.transform.setAndInvalidateLazyTransforms(i,n.shaderTransformation),Ne(this._rayBeginTransformed,this.rayBegin,this.transform.inverse),Ne(this._rayEndTransformed,this.rayEnd,this.transform.inverse);const l=this.transform.transform;s!=null&&(s.objectTransform=this.transform),o.intersect(n,this.transform.transform,this,this._rayBeginTransformed,this._rayEndTransformed,(c,h,p,f,m,g)=>{if(c>=0){if(this.filterPredicate!=null&&!this.filterPredicate(this._ray.origin,this._rayEnd,c))return;const _=f?this._results.hud:this._results,v=f?b=>{const x=new Bft(e,a,p,g);b.set(ls.HUD,x,c,h,Un,m)}:b=>b.set(ls.OBJECT,{object:e,geometryId:a,triangleNr:p},c,h,l,m);if((_.min.drapedLayerOrder==null||m>=_.min.drapedLayerOrder)&&(_.min.dist==null||c<_.min.dist)&&v(_.min),this.options.store!==na.MIN&&(_.max.drapedLayerOrder==null||m<_.max.drapedLayerOrder)&&(_.max.dist==null||c>_.max.dist)&&v(_.max),this.options.store===na.ALL)if(f){const b=new cY(this._ray);v(b),this._results.hud.all.push(b)}else{const b=new zC(this._ray);v(b),this._results.all.push(b)}}})}}sortResults(e=this._results.all){e.sort((r,i)=>r.dist!==i.dist?(r.dist??0)-(i.dist??0):r.drapedLayerOrder!==i.drapedLayerOrder?(r.drapedLayerOrder??Number.MAX_VALUE)-(i.drapedLayerOrder??Number.MAX_VALUE):(i.drapedLayerGraphicOrder??Number.MIN_VALUE)-(r.drapedLayerGraphicOrder??Number.MIN_VALUE))}};function Jd(t){return new Xft(t)}let Yft=class{constructor(){this.min=new zC(Io()),this.max=new zC(Io()),this.hud={min:new cY(Io()),max:new cY(Io()),all:new Array},this.ground=new zC(Io()),this.all=[]}init(e){this.min.init(e),this.max.init(e),this.ground.init(e),this.all.length=0,this.hud.min.init(e),this.hud.max.init(e),this.hud.all.length=0}},zC=class{get ray(){return this._ray}get distanceInRenderSpace(){return this.dist!=null?(ae(DD,this.ray.direction,this.dist),Oe(DD)):null}getIntersectionPoint(e){return!!Bf(this)&&(ae(DD,this.ray.direction,this.dist),ue(e,this.ray.origin,DD),!0)}getTransformedNormal(e){return oe(pR,this.normal),pR[3]=0,ph(pR,pR,this.transformation),oe(e,pR),_e(e,e)}constructor(e){this.intersector=ls.OBJECT,this.normal=C(),this.transformation=xe(),this._ray=Io(),this.init(e)}init(e){this.dist=null,this.target=null,this.drapedLayerOrder=null,this.drapedLayerGraphicOrder=null,this.intersector=ls.OBJECT,lU(e,this._ray)}set(e,r,i,s,n,o,a){this.intersector=e,this.dist=i,oe(this.normal,s??RQ),an(this.transformation,n??Un),this.target=r,this.drapedLayerOrder=o,this.drapedLayerGraphicOrder=a}copy(e){lU(e.ray,this._ray),this.intersector=e.intersector,this.dist=e.dist,this.target=e.target,this.drapedLayerOrder=e.drapedLayerOrder,this.drapedLayerGraphicOrder=e.drapedLayerGraphicOrder,oe(this.normal,e.normal),an(this.transformation,e.transformation)}},cY=class extends zC{constructor(){super(...arguments),this.intersector=ls.HUD}};function ore(t){return new zC(t)}const DD=C(),pR=Qt();function xMe(t,e,r,i){return t.renderCoordsHelper.fromRenderCoords(e.eye,EU,i)!=null&&ube(r,EU)}function b8(t,e){return t.elevationProvider?t.elevationProvider.getElevation(e[0],e[1],e[2],t.renderCoordsHelper.spatialReference,"ground")??0:0}function vS(t,e,r,i){const s=t.state.camera.clone();e&&r&&i&&(s.eye=e,s.center=r,s.up=i),Jft(t,s.ray,x_)||oe(x_,s.center);const n=t.state.constraints,o=n.minimumPoiDistance;if(kn(s.eye,x_)<o){const a=n.collision.enabled;oe(Db,s.viewForward),ae(Db,Db,o),a?s.eye=pe(EU,x_,Db):ue(x_,s.eye,Db);const l=t.renderCoordsHelper,c=l.getAltitude(s.eye),h=n.collision.elevationMargin;a&&c<h&&(pe(Db,x_,s.eye),s.eye=l.setAltitude(EU,h,s.eye),ue(x_,s.eye,Db))}return s.center=x_,s}function Xhe(t,e,r){if(!t.state.isGlobal||!t.stateManager.constraintsManager)return!1;const i=b8(t,e),s=t.stateManager.constraintsManager.nearFarHeuristic,{far:n}=s.compute(e,r,t.renderDataExtent,i,Kft),o=n*n;return kn(e,r)>o}function Jft(t,e,r){let i=Yhe[t.viewingMode];i||(i=Jd(t.state.viewingMode),i.options.backfacesTerrain=!t.state.isGlobal,i.options.invisibleTerrain=!0,Yhe[t.viewingMode]=i);const{isGlobal:s}=t.state;return!(!t.sceneIntersectionHelper.intersectRay(e,i,r)||Xhe(t,e.origin,r))||!(!t.renderCoordsHelper.intersectManifold(e,0,r)||Xhe(t,e.origin,r))||!!s&&Qft(e,r,Ir(t.spatialReference).radius)}function Qft(t,e,r){const i=de(t.origin,t.origin)-r*r,s=i>0?Math.sqrt(i)/3:1;return ae(e,t.direction,s/Oe(t.direction)),ue(e,e,t.origin),!0}const Yhe={},EU=C(),x_=C(),Db=C(),Kft={near:0,far:0};function CO(t,e,r=$d.EYE){const i=t.state.constraints;if(!i.collision.enabled)return!1;const s=b8(t,e.eye),n=t.renderCoordsHelper.getAltitude(e.eye),o=s+i.collision.elevationMargin;if(n>=o)return!1;const a=Oe(e.eye);if(pe(ND,e.center,e.eye),e.eye=t.renderCoordsHelper.setAltitude(emt,o,e.eye),r===$d.EYE_AND_CENTER)e.center=ue(ND,e.eye,ND);else if(r===$d.EYE_AND_CENTER_SCALE){const l=(a-n+o)/a;e.center=ae(ND,e.center,l)}return!0}var $d;(function(t){t[t.EYE=0]="EYE",t[t.EYE_AND_CENTER=1]="EYE_AND_CENTER",t[t.EYE_AND_CENTER_SCALE=2]="EYE_AND_CENTER_SCALE"})($d||($d={}));const ND=C(),emt=C();function eb(t,e,r){t.worldUpAtPosition(e,Jhe),pe(xB,r,e);const i=Oe(xB);return i===0?0:oo(de(xB,Jhe)/i)}const Jhe=C(),xB=C();function TMe(t,e,r=K1,i=!0){fR.eyeCenterDistance=0,fR.requiresTwoSteps=!1;const s=are(t,e,r,void 0,fR);if(s===0)return!1;switch(Th(FD,-s,e.viewRight),r.tiltMode){case ko.LOOK_AROUND:Ne(T_,e.viewForward,FD),ae(T_,T_,fR.eyeCenterDistance),e.center=ue(Jv,e.eye,T_);break;case ko.TUMBLE:pe(T_,e.center,e.eye),Ne(T_,T_,FD),e.eye=pe(Jv,e.center,T_);break;default:r.tiltMode}return e.up=Ne(Jv,e.up,FD),!fR.requiresTwoSteps||!i||TMe(t,e,r,!1)}function are(t,e,r=K1,i=K1,s){if(!t.state.constraints.tilt)return 0;const n=e.distance,o=t.state.constraints.tilt(n,umt);return cmt(t,r,o),i.interactionType===Kt.TUMBLE&&gP(i.selection,Xi.ALTITUDE)&&SMe(t,i.interactionStartCamera,o),r.tiltMode===ko.LOOK_AROUND||i.tiltMode===ko.LOOK_AROUND?rmt(t,e,o,s):tmt(t,e,o)}function tmt(t,e,r){const i=eb(t.renderCoordsHelper,e.center,e.eye),s=i-ye(i,r.min,r.max);return yP(s)?s:0}function rmt(t,e,r,i){switch(i&&(i.requiresTwoSteps=!1),t.viewingMode){case"global":return smt(t,e,r,i);case"local":return imt(t,e,r,i)}}function imt(t,e,r,i){const s=eb(t.renderCoordsHelper,e.center,e.eye),n=ye(s,r.min,r.max),o=s-n;if(!yP(o))return 0;if(i){const a=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,l=t.renderCoordsHelper.getAltitude(e.eye)-a,c=Math.cos(n);Math.abs(c)>1e-4?i.eyeCenterDistance=l/c:i.eyeCenterDistance=e.distance}return o}function smt(t,e,r,i){const s=nmt(t,e,hmt),n=ye(s.tiltAtCenter,r.min,r.max);if(!yP(s.tiltAtCenter-n))return 0;let o,a;return s.centerIsOnSurface?(o=omt(s),a=amt(s,o)):(o=s.constraints.clampTilt(s.eyeCenterDistance,s.tiltAtCenter),i&&o<Math.PI/2&&(i.requiresTwoSteps=!0,o=Math.PI/2-1e-5),a=lmt(s,o)),i&&(i.eyeCenterDistance=uY(s,o)),a}function nmt(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,s=i+Ir(t.spatialReference).radius,n=t.renderCoordsHelper.intersectManifold(e.ray,i,Jv);return r.eyeCenterDistance=e.distance,r.centerIsOnSurface=!1,n!=null?(r.eyeCenterDistance=_i(e.eye,n),r.tiltAtCenter=eb(t.renderCoordsHelper,n,e.eye),r.centerIsOnSurface=!0):t.state.isLocal?r.tiltAtCenter=eb(t.renderCoordsHelper,e.center,e.eye):(wO(YV(JV,s),e.ray,Jv),r.eyeCenterDistance=_i(e.eye,Jv),r.tiltAtCenter=oo(-de(e.viewForward,_e(Jv,Jv)))),r.radius=s,r.eyeRadius=Oe(e.eye),r.constraints=t.state.constraints,r}function yP(t){return Math.abs(t)>1e-9}function omt(t){const{constraints:e,eyeCenterDistance:r,tiltAtCenter:i}=t;let s=i,n=e.clampTilt(r,i);const o=uY(t,n);if(e.clampTilt(o,i)===n)return n;let a=0;for(;a<10&&yP(n-s);){const l=(s+n)/2,c=uY(t,l);yP(e.clampTilt(c,l)-l)?s=l:n=l,a++}return n}function uY(t,e){if(!t.centerIsOnSurface)return t.eyeCenterDistance;const r=Math.PI-ye(e,0,Math.PI),i=Gd(t.radius/t.eyeRadius*Math.sin(r)),s=Math.PI-r-i,n=Math.sin(s)/Math.sin(r);if(t.eyeRadius<t.radius&&n>1){const o=Math.PI-i,a=Math.PI-r-o;return Math.sin(a)/Math.sin(r)*t.eyeRadius}return n*t.eyeRadius}function amt(t,e){const r=Gd(t.radius/t.eyeRadius*Math.sin(t.tiltAtCenter)),i=Gd(t.radius/t.eyeRadius*Math.sin(e));return t.eyeRadius>t.radius?r-i:i-r}function lmt(t,e){return t.tiltAtCenter-Math.PI/2-(e-Math.PI/2)}function cmt(t,e,r){if(e.interactionType===Kt.NONE)return;const{interactionStartCamera:i,interactionFactor:s}=e;if(!i)return;const{min:n,max:o}=r,a=are(t,i,K1,e),l=a===0?0:eb(t.renderCoordsHelper,i.center,i.eye);r.min=n,r.max=o,e.interactionType===Kt.TUMBLE?(gP(e.selection,Xi.ALTITUDE)&&SMe(t,i,r),SU(a,l,!0,s,Qhe,r)):SU(a,l,!1,s,Qhe,r)}function SMe(t,e,r){const i=t.state.constraints;if(t.state.isLocal||!i.altitude||!e)return;const s=Xa(e.center),n=Math.sqrt(s),o=e.distance,a=Ir(t.spatialReference).radius,l=i.altitude.min+a,c=i.altitude.max+a,h=(l*l-o*o-s)/(-2*n*o),p=(c*c-o*o-s)/(-2*n*o);r.min=Math.max(r.min,Math.min(Math.PI-oo(p),r.max)),r.max=Math.min(r.max,Math.PI-oo(h))}const T_=C(),FD=xe(),Jv=C(),Qhe=zt(5),umt={min:0,max:0},hmt={constraints:null,radius:0,eyeRadius:0,centerIsOnSurface:!0,eyeCenterDistance:0,tiltAtCenter:0},fR={eyeCenterDistance:0,requiresTwoSteps:!1};function dmt(t){return t}const w8=t=>t*t,lre=t=>1-w8(1-t),pmt=t=>t<.5?w8(2*t)/2:(lre(2*(t-.5))+1)/2,cre=t=>t*t*t,EMe=t=>1-cre(1-t),CMe=t=>t<.5?cre(2*t)/2:(EMe(2*(t-.5))+1)/2,ure=t=>t*t*t*t,AMe=t=>1-ure(1-t),fmt=t=>t<.5?ure(2*t)/2:(AMe(2*(t-.5))+1)/2,hre=t=>t*t*t*t*t,OMe=t=>1-hre(1-t),mmt=t=>t<.5?hre(2*t)/2:(OMe(2*(t-.5))+1)/2,dre=t=>1-Math.cos(t*Math.PI/2),RMe=t=>1-dre(1-t),gmt=t=>t<.5?dre(2*t)/2:(RMe(2*(t-.5))+1)/2,pre=t=>2**(10*(t-1)),R$=t=>1-pre(1-t),ymt=t=>t<.5?pre(2*t)/2:(R$(2*(t-.5))+1)/2,fre=t=>-(Math.sqrt(1-t*t)-1),MMe=t=>1-fre(1-t),_mt=t=>t<.5?fre(2*t)/2:(MMe(2*(t-.5))+1)/2;function rp(t){const e=2*(t-Math.sqrt((t-1)*t)),r=e/2/t;return i=>i<r?t*i*i:e*i-e+1}function ip(t,e){return(r,i)=>r<e?e*t(r/e,i):1-t((1-r)/(1-e),i)*(1-e)}const vmt=ip(rp(1),1),bmt=ip(rp(1),0),IMe=ip(rp(1),.5),wmt=ip(rp(2),1),xmt=ip(rp(2),0),Tmt=ip(rp(2),.5),Smt=ip(rp(3),1),Emt=ip(rp(3),0),Cmt=ip(rp(3),.5),Amt=ip(rp(4),1),Omt=ip(rp(4),0),Rmt=ip(rp(4),.5),Mmt={linear:dmt,"in-quad":w8,"out-quad":lre,"in-out-quad":pmt,"in-coast-quad":vmt,"out-coast-quad":bmt,"in-out-coast-quad":IMe,"in-cubic":cre,"out-cubic":EMe,"in-out-cubic":CMe,"in-coast-cubic":wmt,"out-coast-cubic":xmt,"in-out-coast-cubic":Tmt,"in-quart":ure,"out-quart":AMe,"in-out-quart":fmt,"in-coast-quart":Smt,"out-coast-quart":Emt,"in-out-coast-quart":Cmt,"in-quint":hre,"out-quint":OMe,"in-out-quint":mmt,"in-coast-quint":Amt,"out-coast-quint":Omt,"in-out-coast-quint":Rmt,"in-sine":dre,"out-sine":RMe,"in-out-sine":gmt,"in-expo":pre,"out-expo":R$,"in-out-expo":ymt,"in-circ":fre,"out-circ":MMe,"in-out-circ":_mt};function rn(t,e,r=Lmt,i=e){i!==e&&i.copyFrom(e),i.computeUp(t.state.viewingMode);let s=!1;for(let a=0;a<Dmt;a++){let l=0;for(const c of $mt)if(gP(r.selection,c.type)){const h=Math.abs(c.error(t,i,r));c.apply(t,i,r)&&(s=!0,l+=h)}if(l===0)break}const n=gP(r.selection,Xi.COLLISION),o=Imt(r.interactionType,t);return n&&CO(t,i,o)&&(s=!0),s&&i.computeUp(t.state.viewingMode),s}function Imt(t,e){switch(t){case Kt.PAN:return $d.EYE_AND_CENTER;case Kt.ASCEND:return e.state.isGlobal?$d.EYE_AND_CENTER_SCALE:$d.EYE_AND_CENTER;default:return $d.EYE}}function nf(t){const e=Math.min(1,t/150);return CMe(e)}function Pmt(t,e,r){return are(t,e,r)*e.distance}const $mt=[{type:Xi.TILT,error:Pmt,apply:TMe},{type:Xi.ALTITUDE,error:ire,apply:Sft},{type:Xi.DISTANCE,error:sre,apply:$ft}],Lmt={selection:Xi.ALL,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ko.TUMBLE},Dmt=5,Fu=C(),Lc=C(),S_=C(),Da=C(),Nb=C(),Nmt=C(),ku={upward:Ee(0,0,1),forward:Ee(0,1,0),sideway:Ee(1,0,0)},Khe=ts();let ede=class{constructor(e=Ue.Global){this.viewingMode=e,this.center=C(),this.pitch=0,this.yaw=0,this.distance=0,this.lookAtDirection=$i(ku.forward)}pixelsPerPanAtZoom(e){return this.size/2/(this._zoomToPanScale*e)}zoomAtPixelsPerPan(e){return this.size/2/(this._zoomToPanScale*e)}pixelsPerRotateAtZoom(){const e=Math.max(Math.cos(Math.abs(this.pitch)),.5);return this.size/2/e}compareTo(e,r){if(r||(r={pan:0,rotate:0,sourceZoom:0,targetZoom:0}),this.viewingMode===Ue.Global){const n=(Oe(this.center)+Oe(e.center))/2;r.pan=k4(this.center,e.center)*n}else r.pan=_i(this.center,e.center);let i=Math.abs(e.yaw-this.yaw);i>=Math.PI&&(i=2*Math.PI-i);const s=Math.abs(e.pitch-this.pitch);return r.rotate=Math.max(i,s),r.sourceZoom=this.distance,r.targetZoom=e.distance,r}interpolate(e,r,i){this.viewingMode===Ue.Global?qat(e.center,r.center,i.pan,this.center):Wr(this.center,e.center,r.center,i.pan),this.distance=isFinite(r.distance)?Et(e.distance,r.distance,i.zoom):e.distance,this.pitch=Et(e.pitch,r.pitch,i.rotate);let s=e.yaw;const n=r.yaw;Math.abs(n-s)>=Math.PI&&(s+=2*(s<n?1:-1)*Math.PI),this.yaw=Et(s,n,i.rotate)}copyFrom(e){oe(this.center,e.center),this.pitch=e.pitch,this.yaw=e.yaw,this.distance=e.distance,oe(this.lookAtDirection,e.lookAtDirection),this.size=e.size,this.copyFromCommon(e),this.viewingMode=e.viewingMode}copyFromRenderCamera(e){const r=this._lookAtOrientation(e.center,Khe);oe(this.center,e.center),pe(Da,e.center,e.eye),yu(Da,Da,r),yu(Nb,e.up,r),this.distance=Oe(Da),this.distance!==0&&(Da[0]/=this.distance,Da[1]/=this.distance,Da[2]/=this.distance),this.pitch=this._eyeUpToPitch(Da),this.yaw=this._eyeUpToYaw(Da,Nb),this.size=Math.sqrt(e.width*e.width+e.height*e.height),this.copyFromCommon(e)}copyFromCommon(e){this.fov=e.fov,this._zoomToPanScale=Math.atan(.5*this.fov)}copyToRenderCamera(e){const r=this._lookAtOrientation(this.center,Khe);Wd(r,r),this._axisAngleVec3(ku.sideway,this.pitch-Math.PI/2,ku.forward,Da),this._axisAngleVec3(ku.upward,this.yaw,Da),this._axisAngleVec3(ku.sideway,this.pitch-Math.PI/2,ku.upward,Nb),this._axisAngleVec3(ku.upward,this.yaw,Nb),ae(Da,Da,this.distance),yu(Da,Da,r),yu(Nb,Nb,r),e.center=this.center,e.eye=pe(Da,this.center,Da),e.up=Nb}_axisAngleVec3(e,r,i,s=i){const n=Math.cos(r),o=Math.sin(r);return ae(Fu,i,n),st(Lc,e,i),ae(Lc,Lc,o),ae(S_,e,(1-n)*de(e,i)),ue(s,ue(s,Fu,Lc),S_)}_lookAtOrientation(e,r=ts()){return this._upAtLookAt(e,S_),st(Fu,this.lookAtDirection,S_),_e(Fu,Fu),Fu[0]===0&&Fu[1]===0&&Fu[2]===0&&oe(Fu,ku.sideway),st(Lc,S_,Fu),_e(Lc,Lc),r[0]=Fu[0],r[1]=Lc[0],r[2]=S_[0],r[3]=Fu[1],r[4]=Lc[1],r[5]=S_[1],r[6]=Fu[2],r[7]=Lc[2],r[8]=S_[2],r}_upAtLookAt(e,r){return this.viewingMode===Ue.Local?oe(r,ku.upward):_e(r,e)}_eyeUpToPitch(e){return Math.PI-k4(ku.upward,e)}_eyeUpToYaw(e,r){const i=Nmt;return Math.abs(r[2])<.5?(oe(i,r),e[2]>0&&ae(i,i,-1)):oe(i,e),st(Lc,i,ku.upward),_e(Lc,Lc),k4(ku.sideway,Lc,ku.upward)}};const CU={desiredScreenFlow:2,minDuration:500,maxDuration:8e3};let Fmt=class PMe{constructor(e){this._createCamera=e,this.compared={sourceZoom:0,targetZoom:0,pan:0,rotate:0},this.settings={desiredScreenFlow:CU.desiredScreenFlow},this.source=e(),this.target=e()}clone(){const e=new PMe(this._createCamera);return e.copyFrom(this),e}copyFrom(e){this.update(e.source,e.target,e.settings)}update(e,r,i){this.source!==e&&this.source.copyFrom(e),this.target!==r&&this.target.copyFrom(r),this.compared=this.source.compareTo(this.target,this.compared),this.settings.desiredScreenFlow=i.desiredScreenFlow!=null?i.desiredScreenFlow:CU.desiredScreenFlow,this.desiredPixelFlow=this.settings.desiredScreenFlow*this.target.size,this.halfWindowSize=this.target.size/2}halfWindowPanAtZoom(e){const r=this.target.pixelsPerPanAtZoom(e);return this.halfWindowSize/r}get hasZoom(){return Math.abs(this.compared.sourceZoom-this.compared.targetZoom)>1e-5}get hasPan(){return this.compared.pan>1e-9}get hasRotate(){return this.compared.rotate>1e-9}},kmt=class{constructor(){this.segments=[]}get time(){return this.segments.reduce((e,r)=>e+r.time,0)}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1),e*=this.time;let i=0,s=0;const n=this.definition;for(let o=0;o<this.segments.length;o++){const a=this.segments[o],l=a.definition;if(e<=a.time||o===this.segments.length-1){if(r=this.segmentInterpolateComponentsAt(a,a.time===0?0:e/a.time,r),n.hasPan&&!isNaN(r.pan)&&isFinite(n.compared.pan)?r.pan=(i+l.compared.pan*r.pan)/n.compared.pan:r.pan=1,n.hasRotate&&!isNaN(r.rotate)&&isFinite(n.compared.rotate)?r.rotate=(s+l.compared.rotate*r.rotate)/n.compared.rotate:r.rotate=1,n.hasZoom&&!isNaN(r.zoom)&&isFinite(l.compared.targetZoom)){const c=r.zoom*(l.compared.targetZoom-l.compared.sourceZoom)+l.compared.sourceZoom,h=this.segments[0].definition.compared.sourceZoom,p=this.segments[this.segments.length-1].definition.compared.targetZoom;r.zoom=(c-h)/(p-h)}else r.zoom=1;return r}e-=a.time,i+=l.compared.pan,s+=l.compared.rotate}}segmentInterpolateComponentsAt(e,r,i){return e.interpolateComponentsAt(r,i)}},TB=class{get time(){return this._time}constructor(e){e&&this.update(e)}update(e){e&&(this.definition?this.definition.copyFrom(e):this.definition=e.clone()),this._updatePrecomputedVariables(),this._updatePixelFlow()}_updatePrecomputedVariables(){const e=this.definition,r=e.compared,i=r.sourceZoom,s=r.targetZoom;this._zoomSign=i>s?1:-1,this._panPixelsAtSource=r.pan*e.source.pixelsPerPanAtZoom(i);const n=(e.source.pixelsPerRotateAtZoom(i)+e.target.pixelsPerRotateAtZoom(s))/2;this._rotatePixels=r.rotate*n}_updatePixelFlow(){const e=this.definition.compared.sourceZoom,r=this.definition.compared.targetZoom,{hasZoom:i,hasPan:s,hasRotate:n}=this.definition;let o=0,a=0;i&&(s&&(o=(r/e-1)/(-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2*this._panPixelsAtSource)),n&&(a=this._zoomSign*(Math.log(e/r)/Math.LN2)*this.definition.halfWindowSize/this._rotatePixels)),this._zoomPixelFlow=0,this._panPixelFlow=0,this._rotatePixelFlow=0;const l=this.definition.desiredPixelFlow;if(i&&s&&n){const c=o+a+o*a;this._zoomPixelFlow=o*a/c*l,this._panPixelFlow=a/c*l,this._rotatePixelFlow=o/c*l}else if(i&&s){const c=1+o;this._zoomPixelFlow=o/c*l,this._panPixelFlow=1/c*l}else if(i&&n){const c=1+a;this._zoomPixelFlow=a/c*l,this._rotatePixelFlow=1/c*l}else if(s&&n){const c=this._panPixelsAtSource/this._rotatePixels,h=1+c;this._panPixelFlow=c/h*l,this._rotatePixelFlow=1/h*l}else s?this._panPixelFlow=l:i?this._zoomPixelFlow=l:n&&(this._rotatePixelFlow=l);this._time=n?this.rotateTime:i?this.zoomTime:s?this.panTime:0}get rotateTime(){return this.definition.hasRotate?this._rotatePixels/this._rotatePixelFlow:0}get zoomTime(){return this.definition.hasZoom?this._zoomSign*(Math.log(this.definition.compared.sourceZoom/this.definition.compared.targetZoom)/Math.LN2)*this.definition.halfWindowSize/this._zoomPixelFlow:0}get panTime(){if(this.definition.hasPan){if(this.definition.hasZoom){const e=-1/(this._zoomSign*this.definition.halfWindowSize)*Math.LN2,r=e*this._panPixelsAtSource;return Math.log(r*(this._zoomPixelFlow/this._panPixelFlow)+1)/(e*this._zoomPixelFlow)}return this._panPixelsAtSource/this._panPixelFlow}return 0}_interpolateComponentsZoom(e){if(e===0||e===1)return e;if(this.definition.hasZoom){const r=this.definition.compared.sourceZoom,i=this.definition.compared.targetZoom;return(r*(r/i)**-e-r)/(i-r)}return e}_interpolateComponentsPan(e){if(e===0||e===1)return e;if(this.definition.hasPan&&this.definition.hasZoom){const r=-1/(this._zoomSign*this.definition.halfWindowSize)*this._zoomPixelFlow;return 1/this._panPixelsAtSource*(this._panPixelFlow*(2**(r*e*this._time)-1))/(r*Math.LN2)}return e}_interpolateComponentsRotate(e){return e}interpolateComponentsAt(e,r){e=Math.min(Math.max(e,0),1);const i=this._interpolateComponentsZoom(e),s=this._interpolateComponentsPan(e),n=this._interpolateComponentsRotate(e);return r?(r.zoom=i,r.pan=s,r.rotate=n):r={zoom:i,pan:s,rotate:n},r}};function Umt(t,e,r){const i=e-t.compared.sourceZoom,s=t.halfWindowPanAtZoom(i);return-t.halfWindowSize*(r.ascensionFactor*Math.LN2*t.compared.pan+s)*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2*s)}function Vmt(t,e,r){const i=1/e,s=Math.log(t.compared.sourceZoom*i),n=1/t.desiredPixelFlow,o=1/Math.LN2,a=e-t.compared.sourceZoom,l=1/a,c=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(a))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*i*n*o*l*c-t.halfWindowSize*s*n*o*l+t.halfWindowSize*s*n*o*c/(a*a)}function zmt(t,e,r){const i=e-t.compared.sourceZoom,s=1/i,n=1/e,o=Math.log(t.compared.sourceZoom*n),a=(r.ascensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(i))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a+2*s*o+2*n-2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function Bmt(t,e){return-t.halfWindowSize*Math.log(t.compared.sourceZoom/e)/(t.desiredPixelFlow*Math.LN2)}function Gmt(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function jmt(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function Hmt(t,e,r){return-t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e))}function qmt(t,e,r){return t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e))}function Wmt(t,e,r){return-2*t.compared.pan*t.halfWindowSize*(r.ascensionFactor+r.descensionFactor-1)/(t.desiredPixelFlow*t.halfWindowPanAtZoom(e*e*e))}function Zmt(t,e,r){return t.halfWindowSize*(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*t.halfWindowPanAtZoom(-e+t.compared.targetZoom))}function Xmt(t,e,r){const i=Math.log(e/t.compared.targetZoom),s=1/t.desiredPixelFlow,n=1/Math.LN2,o=-e+t.compared.targetZoom,a=1/o,l=(-t.halfWindowPanAtZoom(e)-r.descensionFactor*Math.LN2*t.compared.pan+t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return-t.halfWindowSize*i*s*n*a+t.halfWindowSize*i*s*n*l/(o*o)+t.halfWindowSize*s*n*a*l/e}function Ymt(t,e,r){const i=e-t.compared.targetZoom,s=1/i,n=1/e,o=Math.log(e/t.compared.targetZoom),a=(t.halfWindowPanAtZoom(e)+r.descensionFactor*Math.LN2*t.compared.pan-t.halfWindowPanAtZoom(t.compared.targetZoom))/t.halfWindowPanAtZoom(1);return t.halfWindowSize*s*(-2*s*n*a-2*s*o+2*n+2*o*a/(i*i)-a/(e*e))/(t.desiredPixelFlow*Math.LN2)}function Jmt(t,e){return t.halfWindowSize*Math.log(e/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2)}function Qmt(t,e){return t.halfWindowSize/(e*t.desiredPixelFlow*Math.LN2)}function Kmt(t,e){return-t.halfWindowSize/(e*e*t.desiredPixelFlow*Math.LN2)}function egt(t){const e=Math.LN2*t.compared.pan,r=t.compared.sourceZoom-t.compared.targetZoom,i=t.halfWindowPanAtZoom(r),s=t.halfWindowSize*Math.log(t.compared.sourceZoom/t.compared.targetZoom)/(t.desiredPixelFlow*Math.LN2*i);return t.compared.sourceZoom<=t.compared.targetZoom?s*(e-i):s*(e+i)}function tgt(t,e){let r=rgt(t,e);const i={ascensionFactor:e.ascensionFactor!=null?e.ascensionFactor:.5,descensionFactor:e.descensionFactor!=null?e.descensionFactor:.5},s=i.ascensionFactor===0,n=i.descensionFactor===0,o=s?Bmt:Umt,a=s?Gmt:Vmt,l=s?jmt:zmt,c=n?Jmt:Zmt,h=n?Qmt:Xmt,p=n?Kmt:Ymt,f=S=>o(t,S,i)+Hmt(t,S,i)+c(t,S,i),m=S=>a(t,S,i)+qmt(t,S,i)+h(t,S,i),g=S=>l(t,S,i)+Wmt(t,S,i)+p(t,S,i);let _=f(r);const v=egt(t);let b;const x=e.maximumIterations||20,T=e.maximumDistance!=null?e.maximumDistance:1/0;for(b=0;b<x;b++){const O=(m(r)+1e-6)/g(r);if(isNaN(O)||r>=T&&O<0){if(!isFinite(T))return null;r=T,_=f(r);break}if(r-=O,r<t.compared.sourceZoom||r<t.compared.targetZoom)return null;const A=f(r);if(Math.abs(A-_)/_<=.005)break;_=A}return _>v*(1-.3)||r<t.compared.sourceZoom||r<t.compared.targetZoom?null:r}function rgt(t,e){const r=Math.max(t.compared.sourceZoom,t.compared.targetZoom),i=t.source.zoomAtPixelsPerPan(t.desiredPixelFlow/t.compared.pan)/2;return i<r?e.maximumDistance!=null?r+(e.maximumDistance-r)/2:1.5*r:e.maximumDistance?Math.min(e.maximumDistance,i):i}let igt=class extends kmt{constructor(e,r){super(),this._preallocSegments=[new TB,new TB,new TB],this._ascensionSegment=null,this._descensionSegment=null,this.update(e,r)}update(e,r){if(!e)return;this.definition?this.definition.copyFrom(e):this.definition=e.clone();let i=null;r&&r.apex&&(i=tgt(e,r.apex)),this.segments.length=0,this._ascensionSegment=null,this._descensionSegment=null,i==null?this._updateWithoutApex():this._updateWithApex(i,r?.apex)}segmentInterpolateComponentsAt(e,r,i){return i=e.interpolateComponentsAt(r,i),e===this._ascensionSegment?i.zoom=lre(i.zoom):e===this._descensionSegment&&(i.zoom=w8(i.zoom)),i}_updateWithApex(e,r){const[i,s,n]=this._preallocSegments,o=r?.ascensionFactor??.5,a=Math.min(1-o,r?.ascensionFactor!=null&&r.descensionFactor!=null?r.descensionFactor:.5),l=1-o-a;i.definition?i.definition.copyFrom(this.definition):i.definition=this.definition.clone(),i.definition.compared.targetZoom=e,i.definition.compared.pan=this.definition.compared.pan*o,i.definition.compared.rotate=this.definition.compared.rotate*o,i.update(),this._ascensionSegment=i,this.segments.push(i),l>0&&(s.definition?s.definition.copyFrom(this.definition):s.definition=this.definition.clone(),s.definition.copyFrom(this.definition),s.definition.compared.sourceZoom=e,s.definition.compared.targetZoom=e,s.definition.compared.pan=this.definition.compared.pan*l,s.definition.compared.rotate=this.definition.compared.rotate*l,s.update(),this.segments.push(s)),n.definition?n.definition.copyFrom(this.definition):n.definition=this.definition.clone(),n.definition.compared.sourceZoom=e,n.definition.compared.pan=this.definition.compared.pan*a,n.definition.compared.rotate=this.definition.compared.rotate*a,n.update(),this._descensionSegment=n,this.segments.push(n)}_updateWithoutApex(){const[e]=this._preallocSegments;e.update(this.definition),this.segments.push(e)}};const sgt={zoom:0,pan:0,rotate:0};let ngt=class{get time(){return this._time}constructor(e){this._createCamera=e,this._time=0,this.definition=new Fmt(e),this.path=new igt}update(e,r,i){this.definition.update(e,r,i),this.path.update(this.definition,i),this._time=this._applyTimeSettings(Vve(isFinite(this.path.time)?this.path.time:0),i),this._easing=i.easing??(this._time>=1e3?IMe:R$)}cameraAt(e,r){r=r||this._createCamera(),e=Math.min(Math.max(0,e),1),e=this._normalizedEasing(e);const i=this.path.interpolateComponentsAt(e,sgt);return r.interpolate(this.definition.source,this.definition.target,i),r}_normalizedEasing(e){const r=this._easing(0,this._time),i=this._easing(1,this._time);return(this._easing(e,this._time)-r)/(i-r)}_applyTimeSettings(e,r){const i=r.speedFactor!=null?r.speedFactor:1;r.duration!=null?e=r.duration:r.speedFactor!=null&&(e=e/i);const s=r.minDuration!=null?r.minDuration:CU.minDuration/i,n=r.maxDuration!=null?r.maxDuration:CU.maxDuration/i;return Math.min(Math.max(s,e),n)}};const ogt=C();let agt=class{get finished(){return this.currentTime>=this._animation.time}get time(){return this._animation.time}constructor(e){this.currentTime=0,this._animation=new ngt(()=>new ede(e)),this._current=new ede(e)}update(e,r,i){const s=this._animation.definition.source,n=this._animation.definition.target,o=pe(ogt,r.center,e.center),a=Oe(o);a>=1e-5?(o[0]/=a,o[1]/=a,o[2]/=a):(o[0]=0,o[1]=1,o[0]=0),oe(s.lookAtDirection,o),oe(n.lookAtDirection,o),s.copyFromRenderCamera(e),n.copyFromRenderCamera(r),this._current.copyFrom(s),this._animation.update(s,n,i),this.currentTime=0,e.almostEquals(r)&&(this.currentTime=this._animation.time)}cameraAt(e,r){return this._animation.cameraAt(e,this._current),r=r||new ft,this._current.copyToRenderCamera(r),r}step(e,r){return this.finished||(this.currentTime=this.currentTime+Vve(e),this.currentTime>=this.time&&(this.currentTime=this.time)),this.cameraAt(this.currentTime/this.time,r)}};var ys;(function(t){t.Ready="ready",t.Rejected="rejected",t.Running="running",t.Stopped="stopped",t.Finished="finished"})(ys||(ys={}));let Xy=class extends me{constructor(e){super(e),this.state=ys.Ready}get active(){return this.state===ys.Running}get isInteractive(){return!1}get canStop(){return!1}stopController(){return!!this.canStop&&(this.state=ys.Stopped,!0)}finishController(){this.state=ys.Finished}get steppingFinished(){return!1}};u([d({constructOnly:!0})],Xy.prototype,"view",void 0),u([d({readOnly:!0})],Xy.prototype,"active",null),u([d()],Xy.prototype,"state",void 0),u([d({readOnly:!0})],Xy.prototype,"isInteractive",null),Xy=u([R("esri.views.3d.state.controllers.CameraController")],Xy);let _P=class extends Xy{constructor(){super(...arguments),this._asyncResult=null}get canStop(){return!0}set asyncResult(e){this._asyncResult&&(this._asyncResult.reject(Tr()),this._asyncResult=null),this.state===ys.Finished||this.state===ys.Stopped?(rS(e),this.state===ys.Finished?e.resolve():e.reject(Tr())):this._asyncResult=e}get asyncResult(){return this._asyncResult}onControllerStart(){this.state=ys.Running,this.viewAnimation!=null&&this.viewAnimation.when(()=>this.updateStateFromViewAnimation(),()=>this.updateStateFromViewAnimation())}updateStateFromViewAnimation(){this.viewAnimation==null||this.state!==ys.Ready&&this.state!==ys.Running||(this.viewAnimation.state===OA.State.FINISHED?this.finish():this.viewAnimation.state===OA.State.STOPPED&&(this.state=ys.Stopped))}onControllerEnd(){this.viewAnimation==null||this.viewAnimation.done||(this.state===ys.Finished?this.viewAnimation.finish():this.state===ys.Stopped&&this.viewAnimation.stop()),this._asyncResult&&(this.state===ys.Finished?this._asyncResult.resolve():this._asyncResult.reject(Tr()))}finish(){this.finishController()}};_P=u([R("esri.views.3d.state.controllers.AnimationController")],_P);let n0=class extends _P{get intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.mode="interaction",this._hasTarget=!1}initialize(){this.animation=new agt(this.view.state.viewingMode),this.viewAnimation=this.mode==="interaction"?null:new OA}get isInteractive(){return this.mode==="interaction"}begin(e,r){this._hasTarget=!0;const i=this.animationSettings(r);kD.copyFrom(this.view.state.camera);const s=Jd(this.view.state.viewingMode);this.intersectionHelper.intersectRay(kD.ray,s,tde)&&(kD.center=tde),this.animation.update(kD,e,i),this.animation.finished&&this.finish()}finish(){this.animation.currentTime=this.animation.time,super.finish()}get steppingFinished(){return this._hasTarget&&this.animation.finished}stepController(e,r){this._hasTarget&&this.animation.step(e,r)}onControllerEnd(e){this._hasTarget&&(this.animation.cameraAt(this.animation.currentTime/this.animation.time,e),this.animation.currentTime=this.animation.time),super.onControllerEnd(e)}animationSettings(e={}){return{apex:{maximumDistance:this.view.state.constraints.clampAltitude(1/0)/6,ascensionFactor:void 0,descensionFactor:void 0},...e,easing:typeof e.easing=="string"?Mmt[e.easing]:e.easing}}};u([d({constructOnly:!0})],n0.prototype,"mode",void 0),u([d({readOnly:!0})],n0.prototype,"isInteractive",null),n0=u([R("esri.views.3d.state.controllers.PointToPointAnimationController")],n0);const kD=new ft,tde=C();function x8(t=cgt){return[t[0],t[1],t[2],t[3]]}function vP(t,e){return lgt(t[0],t[1],t[2],e,_te.get())}function lgt(t,e,r,i,s=x8()){return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function mre(t,e,r){return st(r,t,e),_e(r,r),r[3]=XV(t,e),r}const cgt=[0,0,1,0];function $Me(t,e,r){return ugt(t,t.screenToRender(e,ke.get()),r)}function ugt(t,e,r){const i=jn(ke.get(),e);if(i[2]=0,!t.unprojectFromRenderScreen(i,r.origin))return null;const s=jn(ke.get(),e);s[2]=1;const n=t.unprojectFromRenderScreen(s,ke.get());return n==null?null:(pe(r.direction,n,r.origin),r)}function AO(t,e,r){return gre(t,t.screenToRender(e,ke.get()),r)}function gre(t,e,r){oe(r.origin,t.eye);const i=ie(ke.get(),e[0],e[1],1),s=t.unprojectFromRenderScreen(i,ke.get());return s==null?null:(pe(r.direction,s,r.origin),r)}function yre(t,e,r,i){const s=AO(e,r,hgt);return db(t,s,i)}const hgt=Io();var LA;(function(t){t[t.Ellipsoid=0]="Ellipsoid",t[t.Silhouette=1]="Silhouette"})(LA||(LA={}));const LMe=30,AU=[1,3e8],T8=80,DMe=8,NMe=200,FMe=1508e5,kMe=5,UMe=50,dgt=5,pgt=10,SB=90,bS={exclude:new Set([Yv])};function lT(t,e,r){return r[0]=e[0]/(t.fullWidth/t.pixelRatio),r[1]=e[1]/(t.fullHeight/t.pixelRatio),r}function hY(t){for(;t>Math.PI;)t-=2*Math.PI;for(;t<-Math.PI;)t+=2*Math.PI;return t}function tb(t,e,r){const i=Th(vte.get(),r[3],r);i==null||LSe(i,Un)||(pe(ii,t.eye,e),Ne(ii,ii,i),t.eye=ue(ii,ii,e),pe(ii,t.center,e),Ne(ii,ii,i),t.center=ue(ii,ii,e),t.up=Ne(ii,t.up,i))}function fgt(t,e,r,i){return yS(t,$Me(e,r,bre),i)}function dY(t,e,r,i){return yS(t,AO(e,r,bre),i)}function _re(t,e,r,i){const s=ke.get();let n=1-r;pe(s,e,t.eye);const o=Oe(s);let a=o*(1-n);n>=0&&a<i&&(a=i,n=-(a-o)/o),Math.abs(o-a)<1e-6||(ae(s,s,n),t.eye=ue(ii,t.eye,s),t.center=Wr(ii,t.center,e,n))}function VMe(t,e,r){e.getScreenCenter(rde),yre(t,e,rde,ii)&&(e.center=ii);const i=e.distance,s=i*r;if(Math.abs(i-s)<1e-6)return;const n=ae(ke.get(),e.viewForward,s);e.eye=pe(ii,e.center,n)}const rde=cs();function EB(t,e){ie(e,0,0,0);for(const r of t)ue(e,e,r);ae(e,e,1/t.length)}function r5(t,e,r,i){return Math.sin(t/Oe(e))*(r+i.radius)}function ide(t,e,r,i){return r5(Math.PI/2,e,r,i)+(t-Math.PI/2)}var Po;(function(t){t[t.Vertical=0]="Vertical",t[t.Horizontal=1]="Horizontal"})(Po||(Po={}));const sde={Elevation:3e4,Angle:zt(16)},UD={Pole:.95,Angle:zt(18),Tilt:45},zMe=zt(80);function BMe(t,e,r,i,s,n){const o=C(),a=js();let l=!0,c=!0;return t.intersectScreen(r,o,n)?a[3]=Oe(o):(c=!1,e.aboveGround&&s!==LA.Ellipsoid?a[3]=Math.max(Oe(e.center),.9*i.radius):a[3]=Oe(e.eye)-e.relativeElevation,s===LA.Silhouette?bP(a,e,r,o):l=yre(a,e,r,o)),{sphere:a,scenePickPoint:l?o:null,hasGeometryIntersection:c}}function S8(t,e,r){return Oe(t.eye)-r.radius>sde.Elevation?Po.Horizontal:(AO(t,e,dde),-Math.sign(t.relativeElevation)*(.5*Math.PI+XV(t.eye,dde.direction))<sde.Angle?Po.Vertical:Po.Horizontal)}function GMe(t,e,r){pe(CB,r,e),t.eye=pe(ii,t.eye,CB),t.center=pe(ii,t.center,CB)}const CB=C();function bP(t,e,r,i){const s=AO(e,r,bre);return s!=null&&(wO(t,s,VD),db(t,s,i)?!(kn(VD,s.origin)<kn(i,s.origin))||(oe(i,VD),!1):(pe(KS,e.eye,e.center),_e(KS,KS),GOe(KS,-de(_e(KS,KS),VD),nde),yS(nde,s,i),!1))}const VD=C(),KS=C(),nde=zr();function jMe(t,e,r,i,s,n){let o=0;if(st(MU,t,e),pe(jD,t,e),Oe(t)<=s||!i.aboveGround){st(r,jD,i.eye);const a=de(t,e)/(Oe(t)*Oe(e));if(a<.9999)o=oo(a);else{const c=Oe(st(C(),t,e))/(Oe(t)*Oe(e));o=Gd(c)}const l=Math.cos(ye(k1.normalize(zt(n)),0,zMe));o=-o-Math.max(0,Oe(e)-s)/(l*s)}else pe(ode,i.eye,i.center),st(r,jD,ode),o=-Oe(jD)/s;return _e(r,r),ae(r,r,Oe(MU)),o}const ode=C();function ade(t,e,r,i){let s,n;const o=Math.cos(ye(k1.normalize(zt(i)),0,zMe));return s=e>r?-(e-r)/(o*r):e<-r?Math.PI-(e+r)/(o*r):oo(e/r),n=t>r?-(t-r)/(o*r):t<-r?Math.PI-(t+r)/(o*r):oo(t/r),(n-s)*r}function mgt(t,e,r,i,s,n,o,a,l,c){const h=ade(t[2],e[2],n[3],a),p=l?ade(t[0],e[0],n[3],180):e[0]-t[0],f=Math.sin(o)*p-Math.cos(o)*h,m=Math.cos(o)*p+Math.sin(o)*h;_e(ii,s);const g=l?f/Math.sqrt(Math.abs(n[3]**2-de(r,ii)**2)):f/n[3],_=m/Math.sqrt(Math.abs(n[3]**2-de(r,i)**2));hr(c,g,_)}function HMe(t,e,r,i,s,n,o,a,l,c){st(MU,t,e),UZ(n.up,n.eye,zD,BD,GD),UZ([0,0,1],n.eye,g0,M1,XMe),oe(r,M1),oe(i,g0),_e(r,r),ae(r,r,Oe(MU)),rue(t,_e(BD,BD),_e(GD,GD),_e(zD,zD),lde),rue(e,BD,GD,zD,cde),mgt(lde,cde,t,g0,M1,o,a,l,c,s)}function ggt(t,e,r,i,s,n,o){Th(OU,s,i),Th(RU,o,n),yi(oC,OU,RU),pe(e,t,r),Ne(e,e,oC),ue(e,e,r)}function qMe(t,e,r,i,s,n){Th(OU,i,r),Th(RU,n,s),yi(oC,OU,RU),pe(ii,t.eye,e),Ne(ii,ii,oC),t.eye=ue(ii,ii,e),pe(ii,t.center,e),Ne(ii,ii,oC),t.center=ue(ii,ii,e),pe(ii,t.up,e),Ne(ii,ii,oC),t.up=ue(ii,ii,e)}function vre(t,e,r,i,s,n){return(Math.abs(i)>Math.PI-UD.Angle||Math.abs(i)<UD.Angle)&&(Math.abs(t[2])<r*UD.Pole||Math.abs(e)>r)&&n.aboveGround&&s<UD.Tilt}function WMe(t,e,r,i,s,n){if(n)mre(r,i,ude),tb(e,t,ude);else{const o=jMe(r,i,hde,e,t[3],s);tb(e,t,vP(hde,o))}}function ZMe(t,e,r,i,s,n,o){const a=o?20:1,l=1e-12;let c,h;oe(Fb,i),HD.copyFrom(e);for(let p=0;p<a&&kn(r,Fb)>l&&(c=kn(r,Fb),HMe(r,Fb,M1,g0,mR,HD,t,s,n,o),qMe(HD,t,g0,mR[1],M1,mR[0]),ggt(Fb,Fb,t,g0,mR[1],M1,mR[0]),h=kn(r,Fb),h<c||p===0);p++)e.copyFrom(HD)}function ygt(t,e,r,i,s,n,o){vre(r,de(e.up,r),t[3],-k1.normalize(zt(s)),n,e)?ZMe(t,e,r,i,-k1.normalize(zt(s)),n,o):WMe(t,e,r,i,n,o)}function _gt(t,e,r,i,s,n){const{eye:o}=t;UZ([0,0,1],o,g0,M1,XMe);const a=e.translation[0]*r.pan,l=s.mode==="zoom"?0:e.translation[1]*r.pan,c=Math.max(Math.sqrt(Math.abs(1-de(t.center,g0)**2/Oe(t.center)**2)),.5),h=(Math.sin(n)*l+Math.cos(n)*a)/c,p=-Math.cos(n)*l+Math.sin(n)*a;switch(_u(i.pan.matrix,i.pan.matrix,h,g0),i.pan.enabled=!0,s.mode){case"pan":_u(i.pan.matrix,i.pan.matrix,p,M1),i.pan.enabled=!0;break;case"zoom":i.zoom=-e.translation[1]*r.zoom}}function vgt(t,e,r,i,s){const{eye:n,viewRight:o}=t,a=st(ke.get(),o,n),l=e.translation[0]*r.pan;switch(l!==0&&(_u(i.pan.matrix,i.pan.matrix,-l,a),i.pan.enabled=!0),s.mode){case"pan":{const c=e.translation[1]*r.pan;c!==0&&(_u(i.pan.matrix,i.pan.matrix,c,o),i.pan.enabled=!0);break}case"zoom":i.zoom=-e.translation[1]*r.zoom}}function bgt(t,e,r,i,s,n,o,a,l){vre(t.center,de(t.up,t.center),Oe(t.center),-k1.normalize(zt(n)),o,e)?_gt(e,r,i,a,l,-k1.normalize(zt(s))):vgt(e,r,i,a,l)}const g0=C(),M1=C(),XMe=C(),zD=C(),BD=C(),GD=C(),lde=C(),cde=C(),mR=Pe(),ude=x8(),OU=xe(),RU=xe(),oC=xe(),Fb=C(),ii=C(),jD=C(),HD=new ft,MU=C(),hde=C(),bre={origin:C(),direction:C()},dde={origin:C(),direction:C()},pde=.6,AB=4,wgt=60;let IU=class extends n0{constructor(){super(...arguments),this._zoomLocation=C(),this._tmpCamera=new ft,this._tmpViewDir=C(),this._tmpRayDir={origin:C(),direction:C()},this._targetOnSphere=C(),this._tmpCenter=C(),this._constraintOptions={selection:Xi.ALL_EXCEPT_COLLISION,interactionType:Kt.ZOOM,interactionFactor:null,interactionStartCamera:new ft,interactionDirection:null,tiltMode:ko.TUMBLE},this._sphere=js()}initialize(){this._intersector=Jd(this.view.state.viewingMode)}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s));let n=!1,o=!1;this.intersectionHelper.intersectScreen(r,this._zoomLocation,this.view.map.ground.opacity===0?bS:{})&&(n=e>0,o=!0),this._tmpCamera.copyFrom(i.camera),n?this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter):this.intersectionHelper.intersectRay(this._tmpCamera.ray,this._intersector,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:oe(this._zoomLocation,this._tmpCamera.center),this._updateCamera(this._tmpCamera,e,this._zoomLocation,r,o),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:R$}}_updateCamera(e,r,i,s,n){const o=Ir(this.view.spatialReference),a=S8(e,s,o),l=Math.abs(this.view.camera.position.z);_e(WD,e.eye),ae(WD,WD,-1),AO(e,s,this._tmpRayDir),_e(this._tmpRayDir.direction,this._tmpRayDir.direction);const c=ye(Math.min(DMe,1/Math.abs(de(WD,this._tmpRayDir.direction)))*l,NMe,FMe);if(a===Po.Horizontal){let h=pde**r;this._sphere[3]=Oe(i),pe(this._tmpViewDir,e.center,e.eye);const p=Math.min(Oe(this._tmpViewDir),c);let f=p*h;if(h<=1&&f<AB&&(f=AB,h=f/p),Math.abs(p-f)<1e-6)return;const m=Oe(e.center);if(this._sphere[3]!==m){const g=this._sphere[3]+h*(m-this._sphere[3]);e.center=ae(qD,e.center,g/m)}ae(this._tmpViewDir,this._tmpViewDir,-h),e.eye=ue(qD,e.center,this._tmpViewDir),rn(this.view,e,this._constraintOptions),kn(i,e.center)>1e-12&&yre(this._sphere,e,s,this._targetOnSphere)&&ygt(this._sphere,e,i,this._targetOnSphere,this.view.camera.heading,this.view.camera.tilt,!0)}else{let h=pde**Math.abs(r);const p=r>0?1:-1;pe(this._tmpViewDir,i,e.eye);const f=Oe(this._tmpViewDir),m=this.view._stage.renderView.getMinimalDepthForArea(null,s[0],s[1],this.view.state.camera,wgt);let g=m??c;g=n&&r>0?Math.min(g,f):g,ae(this._tmpRayDir.direction,this._tmpRayDir.direction,g),ue(i,this._tmpRayDir.origin,this._tmpRayDir.direction);let _=g*h;const v=Math.max(AB,1.01*e.nearFar[0]);if(r>0&&_<v&&(_=v,h=_/g),Math.abs(g-_)<1e-6)return;ae(this._tmpRayDir.direction,this._tmpRayDir.direction,p*(1-h)),e.eye=ue(qD,e.eye,this._tmpRayDir.direction),e.center=ue(qD,e.center,this._tmpRayDir.direction)}CO(this.view,e)}};IU=u([R("esri.views.3d.state.controllers.global.ZoomStepController")],IU);const qD=C(),WD=C(),xgt=.6,Tgt=4,Sgt=60;let PU=class extends n0{constructor(){super(...arguments),this._zoomLocation=C(),this._tmpCamera=new ft,this._tmpRayDir=C(),this._tmpCenter=C(),this._constraintOptions={selection:Xi.ALL,interactionType:Kt.ZOOM,interactionFactor:null,interactionStartCamera:new ft,interactionDirection:null,tiltMode:ko.TUMBLE}}zoomStep(e,r){if(!this.active)return;const i=this.view.state,{interactionStartCamera:s}=this._constraintOptions;s&&(this.animation.finished?s.copyFrom(i.camera):this.animation.cameraAt(1,s)),this._tmpCamera.copyFrom(i.camera);const n=Jd(this.view.state.viewingMode);let o=!1;e>0?(o=this.intersectionHelper.intersectScreenFreePointFallback(r,this._zoomLocation,this.view.map.ground.opacity===0?bS:{}),this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._tmpCenter)&&(this._tmpCamera.center=this._tmpCenter)):this.intersectionHelper.intersectRay(this._tmpCamera.ray,n,this._zoomLocation)?this._tmpCamera.center=this._zoomLocation:oe(this._zoomLocation,this._tmpCamera.center);const a=xgt**e;let l=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,r[0],r[1],this.view.state.camera,Sgt);pe(ZD,this._tmpCamera.eye,this._zoomLocation),_e(ZD,ZD);const c=ye(Math.min(DMe,1/Math.abs(de(Egt,ZD)))*Math.abs(this.view.camera.position.z),NMe,FMe);if(l=l??c,l){const h=C();pe(h,this._zoomLocation,this._tmpCamera.eye),(l<Oe(h)||!o)&&(_e(h,h),ue(this._zoomLocation,this._tmpCamera.eye,ae(h,h,l)))}this._updateCamera(this._tmpCamera,a,this._zoomLocation),this.begin(this._tmpCamera)}animationSettings(){return{duration:600,easing:R$}}_updateCamera(e,r,i){pe(this._tmpRayDir,i,e.eye);const s=Oe(this._tmpRayDir);let n=s*r;const o=r<=1,a=Math.max(Tgt,1.01*e.nearFar[0]);n!==0&&(o&&n<a&&(n=a,r=n/s),Math.abs(s-n)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),e.eye=pe(fde,i,this._tmpRayDir),e.center=Wr(fde,e.center,i,1-r),rn(this.view,e,this._constraintOptions)))}};PU=u([R("esri.views.3d.state.controllers.local.ZoomStepController")],PU);const fde=C(),Egt=Ee(0,0,1),ZD=C();function Cgt(t,e){switch(e){case"primary":return t.pointerType==="touch"||t.button===0;case"secondary":return t.pointerType!=="touch"&&t.button===2;case"tertiary":return t.pointerType!=="touch"&&t.button===1}}function wre(t,e){if(t.pointerType==="touch")return!1;switch(e){case"primary":return t.button===0;case"secondary":return t.button===2;case"tertiary":return t.button===1}}let Agt=class extends ua{constructor(e,r){super(!0),this._view=e,this.registerIncoming("double-click",r,i=>this._handleDoubleClick(i))}_handleDoubleClick(e){const r=e.data;if(Cgt(r,"primary")){const i=this._view.state.isGlobal?new IU({view:this._view,mode:"animation"}):new PU({view:this._view,mode:"animation"});this._view.state.switchCameraController(i),i.zoomStep(Math.log(.5)/Math.log(.6),cs(r.x,r.y)),e.stopPropagation()}}};function Ogt(t,e,r){return t===Ue.Global?new Mgt(r):new Rgt(e,r)}let Rgt=class{constructor(e,r){this._elevationProvider=e,this._referenceEllipsoid=Ir(r),this._unitInMeters=Uo(r,this._referenceEllipsoid.metersPerDegree)}compute(e,r,i,s,n){n||(n={near:0,far:0});let o=e[2]*this._unitInMeters;const a=o,l=o-s,c=this._elevationProvider?.visibleElevationBounds;c&&(o=l>=0?a-this._unitInMeters*c.min:this._unitInMeters*c.max-a);const h={x:(i=i??new vr({xmin:0,ymin:0,zmin:0,xmax:0,ymax:0,zmax:0})).xmax-i.xmin,y:i.ymax-i.ymin,z:4*Math.max(i.xmax-i.xmin,i.ymax-i.ymin)},p=Math.max(h.x,h.y,h.z);pe(kb,r,e),e2[0]=kb[0]>0?i.xmax:i.xmin,e2[1]=kb[1]>0?i.ymax:i.ymin,e2[2]=kb[2]>0?p/2:-p/2,pe(e2,e2,e),_e(kb,kb);const f=1.1*de(e2,kb)*this._unitInMeters,m=Math.sqrt(o*(o+2*this._referenceEllipsoid.radius)),g=Math.max(i.xmax-i.xmin,i.ymax-i.ymin),_=g*$gt*this._unitInMeters,v=g*Lgt*this._unitInMeters,b=ye((o-v)/(_-v),0,1)**3,x=Math.min(Et(m,f,b),m)*Math.max(Math.log(Math.abs(l)),1);return YMe(Math.min(x,Math.max(34064e4,p))/this._unitInMeters,Igt,this._unitInMeters,n)}},Mgt=class{constructor(e){this._referenceEllipsoid=Ir(e)}compute(e,r,i,s,n){n||(n={near:0,far:0});const o=Oe(e),a=o-this._referenceEllipsoid.radius,l=this._referenceEllipsoid.radius+Math.min(0,s),c=Math.abs(a-s),h=Math.max(c,Math.abs(a)),p=Math.sqrt(h*(h+2*l)),f=o+this._referenceEllipsoid.radius;return YMe(1.2*Et(p,f,Lte(h)),ye(2e4-(Math.log(h)-7.983)/9.011*19e3,1e3,2e4),1,n)}};function YMe(t,e,r,i){const s=Pgt/r;return t/e>s?(i.far=t,i.near=i.far/e):(i.near=s,i.far=i.near*e),i}const Igt=2e4,Pgt=2,$gt=.001,Lgt=1e-4,e2=C(),kb=C();let i5=class extends me{constructor(e){super(e)}initialize(){this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e)))}_handleElevationChangeEvent(e){if(this.view.state.cameraController)return;const r=this.view.state.camera;e.spatialReference!=null&&xMe(this.view,r,e.extent,e.spatialReference)&&this._applyToCurrentCamera()}_applyToCurrentCamera(){this.view.state.updateCamera(e=>CO(this.view,e,$d.EYE_AND_CENTER))}};u([d({constructOnly:!0})],i5.prototype,"view",void 0),i5=u([R("esri.views.3d.state.ElevationCollisionConstraint")],i5);let dM=class extends me{constructor(e){super(e),this.nearFarHeuristic=Ogt(e.view.state.viewingMode,e.view.basemapTerrain,e.view.renderCoordsHelper.spatialReference)}initialize(){this.addHandles([Q(()=>[this.view.constraints?.clipDistance?.near,this.view.constraints?.clipDistance?.far],()=>this._clipDistanceNearFarChanged()),Q(()=>this.view.constraints?.clipDistance?.mode,()=>this._updateNearFar()),this.view.state.events.on("before-camera-change",e=>this._updateCameraNearFar(e)),Q(()=>this.view.renderDataExtent,()=>this._updateNearFar(),Rr),Q(()=>[this.view.constraints?.altitude?.min,this.view.constraints?.altitude?.max],()=>this._updateAltitude(),Rr),Q(()=>this.view.constraints?.tilt?.max,()=>this._updateTiltMax(),Rr),Q(()=>this.view.constraints?.tilt?.mode,()=>this._updateTilt(),Rr),Q(()=>this.view.state?.camera,()=>this._updateTiltAutoMax(),Rr),Q(()=>[this.view.map?.ground?.navigationConstraint?.type,this.view.state?.constraints?.collision?.enabled],()=>this._updateCollision(),Rr)]),this.view.state.isLocal&&this.addHandles(Q(()=>this.view.renderDataExtent,e=>this._updateLocalSurfaceDistance(e),xt)),this._updateNearFar(),this.view.state.viewingMode!==Ue.Local&&this._updateAltitude(),this._updateTilt(),this._updateCollision(),this._set("surfaceCollisionConstraint",new i5({view:this.view}))}destroy(){this.surfaceCollisionConstraint&&(this.surfaceCollisionConstraint.destroy(),this._set("surfaceCollisionConstraint",null))}_clipDistanceNearFarChanged(){const e=this.view.constraints?.clipDistance;e&&e.mode!=="auto"&&this.view.state.updateCamera(r=>this._updateCameraNearFarManual(r,e))}_updateNearFar(){this.view.state.updateCamera(e=>this._updateCameraNearFar(e))}_updateCameraNearFar(e){const r=this.view.constraints&&this.view.constraints.clipDistance;(r?r.mode:"auto")==="manual"?this._updateCameraNearFarManual(e,r):this._updateCameraNearFarAuto(e,r)}_updateCameraNearFarAuto(e,r){this.nearFarHeuristic.compute(e.eye,e.center,this.view.renderDataExtent,b8(this.view,e.eye),e),r&&r.autoUpdate(e.near,e.far)}_updateCameraNearFarManual(e,r){r&&(e.near=r.near,e.far=r.far)}_updateCollision(){const e=this.view.map?.ground?.navigationConstraint?.type,r=!e||e==="stay-above",i=this.view.state.constraints.collision;if(r!==i.enabled){i.enabled=r,r&&this._reapplyConstraints(Xi.COLLISION);const s=this.view.constraints&&this.view.constraints.tilt;s&&s.mode!=="auto"||this._updateTiltAuto()}}_updateAltitude(){const e=this.view.constraints&&this.view.constraints.altitude;e&&this.view.state.viewingMode!==Ue.Local?this.view.state.constraints.altitude={min:e.min,max:e.max}:this.view.state.constraints.altitude=null,this._reapplyConstraints()}_updateTiltMax(){const e=this.view.constraints&&this.view.constraints.tilt;e&&e.mode!=="auto"&&(this._updateTiltManual(e),this._reapplyConstraints())}_updateTilt(){const e=this.view.constraints&&this.view.constraints.tilt;(e?e.mode:"auto")==="manual"?this._updateTiltManual(e):this._updateTiltAuto(),this._reapplyConstraints()}_updateTiltManual(e){const r=this.view.state.constraints;r.tilt=r.createConstantMaxTilt(zt(e.max))}_updateTiltAuto(){const e=this.view.state.constraints;e.tilt=e.createDefaultTilt(),this._updateTiltAutoMax()}_updateTiltAutoMax(){const e=this.view.constraints&&this.view.constraints.tilt;if(!e||e.mode!=="auto")return;const r=this.view.state.constraints;if(r.tilt){const i=r.tilt(this.view.state.camera.distance).max;e.autoUpdate(Vl(i))}}_updateLocalSurfaceDistance(e){if(e==null)return;let r=Math.max(e.width,e.height);if(r<=0)return;e.zmax!=null&&e.zmin!=null&&(r=Math.max(r,e.zmax-e.zmin));const i=this.view.state,s=3*r/Math.atan(i.camera.fov/2);s!==i.constraints.distance&&(i.constraints.distance=s)}_reapplyConstraints(e=Xi.ALL){this.view.state.updateCamera(r=>rn(this.view,r,{selection:e,interactionType:Kt.NONE,interactionFactor:null,interactionStartCamera:null,interactionDirection:null,tiltMode:ko.TUMBLE}))}};u([d({constructOnly:!0})],dM.prototype,"view",void 0),u([d({readOnly:!0})],dM.prototype,"surfaceCollisionConstraint",void 0),dM=u([R("esri.views.3d.state.ConstraintsManager")],dM);let Qv=class{get planes(){return this.frustum}get points(){return this._points}get mutablePoints(){return this._points}get direction(){return this._direction}constructor(e){this.renderCoordsHelper=e,this.frustum=fP(),this._points=S3e(),this.lines=new Array(12),this._origin=C(),this._direction=C(),this._altitude=null;for(let r=0;r<12;r++)this.lines[r]={origin:null,direction:C(),endpoint:null}}update(e){E3e(e.viewMatrix,e.projectionMatrix,this.frustum,this._points),oe(this._origin,e.eye),oe(this._direction,e.viewForward),this._altitude=this.renderCoordsHelper.getAltitude(this._origin),this._updateLines()}updatePoints(e){for(let r=0;r<this._points.length;r++)oe(this._points[r],e[r]);C3e(this.frustum,this._points),this._updateLines()}get altitude(){return this._altitude}intersectsSphere(e){return y1(this.frustum,e)}intersectsRay(e){return sdt(this.frustum,e)}intersectsLineSegment(e,r){return ndt(this.frustum,e,r)}intersectsPoint(e){return A3e(this.frustum,e)}_updateLines(){const e=this._points;for(let r=0;r<4;r++){const i=r+4;OB(this.lines[r],e[r],e[i]),OB(this.lines[r+4],e[r],r===3?e[0]:e[r+1]),OB(this.lines[r+8],e[i],r===3?e[4]:e[i+1])}}};function OB(t,e,r){t.origin=e,t.endpoint=r,F0(t.direction,e,r)}Qv.planePointIndices=odt,Qv.nearFarLineIndices=[[Qe.NEAR_BOTTOM_LEFT,Qe.FAR_BOTTOM_LEFT],[Qe.NEAR_BOTTOM_RIGHT,Qe.FAR_BOTTOM_RIGHT],[Qe.NEAR_TOP_RIGHT,Qe.FAR_TOP_RIGHT],[Qe.NEAR_TOP_LEFT,Qe.FAR_TOP_LEFT]];let oI=class extends Xy{set desiredCamera(e){this._set("desiredCamera",e.clone())}constructor(e){super(e)}get canStop(){return!0}get constraintEnabled(){return this.view.state.constraints.collision.enabled}onControllerStart(){this.state=ys.Running,this.addHandles(this.view.basemapTerrain.on("elevation-change",e=>this._handleElevationChangeEvent(e))),this._applyCorrection()}onControllerEnd(){this.removeAllHandles()}stepController(){}_handleElevationChangeEvent(e){(e.spatialReference==null||xMe(this.view,this.desiredCamera,e.extent,e.spatialReference))&&this._applyCorrection()}_applyCorrection(){this.view.state.updateCamera(e=>{e.copyViewFrom(this.desiredCamera),CO(this.view,e,$d.EYE_AND_CENTER)||this.constraintEnabled||(this.state=ys.Stopped)})}};u([d({constructOnly:!0})],oI.prototype,"desiredCamera",null),oI=u([R("esri.views.3d.state.controllers.SurfaceCollisionCorrectionController")],oI);const Dgt=C(),XD=C();function xre(){return{direction:C(),up:C()}}function JMe(t,e,r,i,s){let n=_e(Dgt,t),o=de(n,i);const a=o>0;o=Math.abs(o),o>.99&&(o=Math.abs(de(e,i)),o<.99?(oe(n,e),a&&ae(n,n,-1)):n=null);let l=0;if(n){ae(XD,i,de(i,n)),pe(n,n,XD);const h=de(n,s)/(Oe(n)*Oe(s));st(XD,n,s),l=(de(XD,i)>0?1:-1)*Vl(oo(h))}const c=Vl(oo(-de(i,t)/Oe(t)));return r?(r.heading=l,r.tilt=c,r):{heading:l,tilt:c}}const QMe=Ee(0,1,0),KMe=Ee(0,0,1),gR=xe(),Yg=C(),Jg=C();function eIe(t,e,r,i=xre()){const{direction:s,up:n}=i;return ASe(gR,-zt(e)),dA(gR,gR,zt(r)),Ne(s,KMe,gR),ae(s,s,-1),Ne(n,QMe,gR),i}function Ngt(t,e,r,i){return JMe(e,r,i,KMe,QMe)}function Fgt(t,e,r,i){const s=eIe(t,r,i),n=C();return ae(n,s.direction,-e),ue(n,n,t),{up:s.up,eye:n,heading:r,tilt:i}}function kgt(t){return Vl(t)}function Ugt(t){return zt(t)}function tIe(t,e,r,i,s){const n=t.renderSpatialReference,o=t.map&&t.spatialReference||e.spatialReference;return aa(e,Yg,n),aa(e,Jg,n),Yg[0]-=r/2,Jg[0]+=r/2,Yg[1]-=i/2,Jg[1]+=i/2,Tn(Yg,n,Yg,o),Tn(Jg,n,Jg,o),s?(s.xmin=Yg[0],s.ymin=Yg[1],s.xmax=Jg[0],s.ymax=Jg[1],s.spatialReference=o):s=new vr(Yg[0],Yg[1],Jg[0],Jg[1],o),s}const Vgt=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Ngt,eyeForCenterWithHeadingTilt:Fgt,eyeTiltToLookAtTilt:Ugt,headingTiltToDirectionUp:eIe,lookAtTiltToEyeTilt:kgt,toExtent:tIe},Symbol.toStringTag,{value:"Module"})),rIe=Ee(0,0,1),iIe=_e(C(),Ee(1,1,1)),zgt=new F1(-180,180),yR=xe(),zv=C(),t2=C();function sIe(t,e,r,i=xre()){st(zv,t,rIe),de(zv,zv)===0&&st(zv,t,iIe),Th(yR,-zt(e),t),_u(yR,yR,-zt(r),zv);const{up:s,direction:n}=i;return st(s,zv,t),_e(s,s),Ne(s,s,yR),_e(n,t),el(n,n),Ne(n,n,yR),i}function Bgt(t,e,r,i){const s=zv,n=t2;return _e(s,t),st(t2,s,rIe),de(t2,t2)===0&&st(t2,s,iIe),st(n,t2,s),JMe(e,r,i,s,n)}function Ggt(t,e,r,i){const s={eye:C(),up:null,tilt:i,heading:r},n=zv;n[0]=t[0],n[1]=t[2],n[2]=-t[1];const o=e,a=zt(r),l=zt(i),c=Math.sin(a),h=Math.cos(a),p=Math.sin(l),f=Math.cos(l),m=Oe(n);let g;if(Math.abs(l)<1e-8)g=o+m;else{const ee=m/p,I=Gd(o/ee),V=Math.PI-l-I;g=ee*Math.sin(V)}const _=f*o,v=o*o*(p*p),b=h*h*v,x=g-_,T=x*x,S=b*(b+T-n[1]*n[1]);if(S<0)return ae(s.eye,n,g/m),s.tilt=0,YD(s,t);const O=Math.sqrt(S),A=n[1]*x,M=b+T;let P;if(P=h>0?-O+A:O+A,Math.abs(M)<1e-8)return m<1e-8?(s.eye[0]=0,s.eye[1]=0,s.eye[2]=o):ae(s.eye,n,g/m),s.tilt=0,RB(s.eye),YD(s,t);s.eye[1]=P/M;const F=c*c*v,$=p*o,N=h*$*s.eye[1],U=s.eye[1]*s.eye[1],X=1-U,Z=Math.sqrt(X),G=b*U+F-2*N*Z*x+X*T;return Math.abs(G)<1e-8?(ae(s.eye,n,g/m),s.tilt=0,RB(s.eye),YD(s,t)):(s.eye[0]=(X*(g*n[0]-_*n[0])-$*Z*(n[0]*s.eye[1]*h+n[2]*c))/G,s.eye[2]=(X*(g*n[2]-_*n[2])-$*Z*(n[2]*s.eye[1]*h-n[0]*c))/G,ae(s.eye,s.eye,g),RB(s.eye),YD(s,t))}function RB(t){const e=t[1];t[1]=-t[2],t[2]=e}function YD(t,e){const r=sIe(e,t.heading,t.tilt);return t.up=r.up,t}function jgt(t,e,r){const i=Oe(e),s=Math.sqrt(r*r+i*i-2*r*i*Math.cos(Math.PI-t)),n=Gd(r/(s/Math.sin(t)));return Vl(t-n)}function Hgt(t,e,r){const i=zt(t),s=Oe(e);return Gd(r/(s/Math.sin(i)))+i}function nIe(t,e,r,i,s){let n,o,a,l;const c=e.latitude,h=Ir(t.spatialReference).radius,p=e.longitude,f=tft(c,r,h)/2;n=p-f,o=p+f;const m=zt(c),g=(1+Math.sin(m))/(1-Math.sin(m)),_=(g+1)*Math.tan(i/h/2),v=_*_;function b(T){const S=Math.PI/2;return(T=Mze.normalize(T,-S))>S&&(T=Math.PI-T),T}if(a=1.5*Math.PI-2*Math.atan(.5*(_+Math.sqrt(4*g+v))),l=a+i/h,a=b(a),l=b(l),l<a){const T=l;l=a,a=T}if(a=Math.max(Vl(a),-90),l=Math.min(Vl(l),90),o=zgt.monotonic(n,o),o-n>180){const T=(o-n-180)/2;n+=T,o-=T}const x=t.spatialReference&&t.spatialReference.isGeographic?t.spatialReference:qe.WGS84;return s?(s.xmin=n,s.ymin=a,s.xmax=o,s.ymax=l,s.spatialReference=x):s=new vr(n,a,o,l,x),t.spatialReference&&t.spatialReference.isWebMercator&&bC(s,!1,s),s}const qgt=Object.freeze(Object.defineProperty({__proto__:null,directionToHeadingTilt:Bgt,eyeForCenterWithHeadingTilt:Ggt,eyeTiltToLookAtTilt:Hgt,headingTiltToDirectionUp:sIe,lookAtTiltToEyeTilt:jgt,toExtent:nIe},Symbol.toStringTag,{value:"Module"}));function $U(t){return t.type==="point"}let Tre=class{constructor(e,r=null,i=0){this.array=e,this.spatialReference=r,this.offset=i}};function oIe(t){return"array"in t}function Qm(t,e,r="ground"){if($U(e))return t.getElevation(e.x,e.y,e.z||0,e.spatialReference,r);if(oIe(e)){let i=e.offset;return t.getElevation(e.array[i++],e.array[i++],e.array[i]||0,e.spatialReference??t.spatialReference,r)}return t.getElevation(e[0],e[1],e[2]||0,t.spatialReference,r)}function pY(t,e){return t!=null&&(e==null||(e===Ue.Local?!t.isGeographic||t.isWGS84||t.wkid===Ad.CGCS2000:t.isWebMercator||t.isWGS84||t.wkid===Ad.CGCS2000||t.wkid===Ad.GCSMARS2000||t.wkid===Ad.GCSMARS2000_SPHERE||t.wkid===Ad.GCSMOON2000))}const aIe=K.getLogger("esri.views.3d.support.cameraUtils"),lIe=39.37,cIe=96,fY=1,Wgt=8,Zgt=5,uIe=1,mde=C(),Xgt={heading:0,tilt:0},Kv=new ht,Ygt=new F1(-20037508342788905e-9,20037508342788905e-9),Jgt=new F1(-180,180);var Ma;function M$(t){return t.spatialReference||qe.WGS84}function OO(t){return t.viewingMode==="global"?qgt:Vgt}function Qgt(t,e,r,i,s){return OO(t).headingTiltToDirectionUp(e,r,i,s)}function jy(t,e){if(e==null)return null;const r=t.renderSpatialReference,i=OO(t).headingTiltToDirectionUp,s=C();if(!aa(e.position,s,r))return null;const n=i(s,e.heading,e.tilt);ae(n.direction,n.direction,t.state.camera.distance),ue(n.direction,n.direction,s);const o=vS(t,s,n.direction,n.up);return o.fov=zt(e.fov),o}(function(t){t[t.LOCKED=0]="LOCKED",t[t.ADJUST=1]="ADJUST"})(Ma||(Ma={}));const r2=C();function DA(t,e,r){const i=t.renderSpatialReference,s=E8(t,e.eye,e.viewForward,e.up,Xgt);let n=M$(t);return Tn(e.eye,i,r2,n)||(n=qe.WGS84,Tn(e.eye,i,r2,n)),r==null?new Zd(new ht(r2,n),s.heading,s.tilt,Vl(e.fov)):(r.position.x=r2[0],r.position.y=r2[1],r.position.z=r2[2],r.position.spatialReference=n,r.heading=s.heading,r.tilt=s.tilt,r.fov=Vl(e.fov),r)}function Sre(t,e,r){const i=t.state.camera,s=i.width/2/i.pixelRatio;return t.renderCoordsHelper.viewingMode===Ue.Global&&r!=null&&(e*=Math.cos(zt(r))),e/=t.renderCoordsHelper.unitInMeters,s/(cIe*lIe/e)/Math.tan(i.fovX/2)}function jT(t,e,r){const i=t.state.camera,s=e*Math.tan(i.fovX/2),n=i.width/2/i.pixelRatio;let o=cIe*lIe/(n/s);return t.renderCoordsHelper.viewingMode===Ue.Global&&r!=null&&(o/=Math.cos(zt(r))),o*t.renderCoordsHelper.unitInMeters}function hIe(t,e,r,i,s,n){return dIe(t,e,Sre(t,r,e.latitude),i,s,n)}function dIe(t,e,r,i,s,n){if(cT(n)){const a=new RO(n.signal);return wP(t,i.heading,i.tilt,e,r,s,a),void a.resolver.promise.then(l=>{const c=DU(t,l,i.fov);if(c!=null)return n.resolver.resolve(c);n.resolver.reject()},l=>n.resolver.reject(l))}const o=wP(t,i.heading,i.tilt,e,r,s);return DU(t,o,i.fov,n)}function E8(t,e,r,i,s){return OO(t).directionToHeadingTilt(e,r,i,s)}function Kgt(t,e){return!!(t.basemapTerrain&&t.renderCoordsHelper.fromRenderCoords(e,Kv,t.spatialReference)&&t.elevationProvider&&(Qm(t.elevationProvider,Kv)??0)>(Kv.z??0)-uIe)}async function eyt(t,e,r){if(!t.renderCoordsHelper.fromRenderCoords(e,Kv,t.spatialReference)||!t.elevationProvider)return!1;const i=Kv.z??0;return(await t.elevationProvider.queryElevation(Kv.x,Kv.y,i,Kv.spatialReference,"ground",r)??0)>i-uIe}async function tyt(t,e,r){const i=C();if(e)if(e instanceof ht){if(aa(e,i,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const s=await t.elevationProvider.queryElevation(e.x,e.y,e.z??0,e.spatialReference,"ground",r);return s!=null&&t.renderCoordsHelper.setAltitude(i,s),i}}else oe(i,e);else oe(i,t.state.camera.center);return i}function ryt(t,e){const r=C();if(e&&e instanceof ht){if(aa(e,r,t.renderSpatialReference),e.z==null&&t.basemapTerrain!=null&&t.elevationProvider!=null){const i=Qm(t.elevationProvider,e);i!=null&&t.renderCoordsHelper.setAltitude(r,i)}}else oe(r,e||t.state.camera.center);return r}function wP(t,e,r,i,s,n,o){const a=i&&i instanceof ht?i:null;if(cT(o))return tyt(t,i,o.signal).then(c=>{mY(t,e,r,a,c,s,n,o)},c=>o.resolver.reject(c)),null;const l=ryt(t,i);return mY(t,e,r,a,l,s,n,o)}function mY(t,e,r,i,s,n,o,a){if(i==null){const p=t.renderSpatialReference;if((i=R0(s,p,M$(t)))==null)return null}n=Math.max(n,t.state.constraints.minimumPoiDistance);const l=nyt(t,e,r,s,n,o),c=(0,OO(t).eyeForCenterWithHeadingTilt)(s,n,l.heading,l.tilt);if(o===Ma.ADJUST&&t.viewingMode==="global"&&r>0){const p=()=>{const m=pIe(t,s,n,ayt(t,n,r,s));return o=r-m<1?Ma.LOCKED:Ma.ADJUST,mY(t,e,m,i,s,n,o,a)},f=t.map.ground.navigationConstraint;if(!f||f.type==="stay-above"){if(Kgt(t,c.eye))return p();if(cT(a))return eyt(t,c.eye,a.signal).then(m=>m?p():(a.resolver.resolve({eye:c.eye,up:c.up,center:$i(s),heading:c.heading,tilt:c.tilt}),null)),null}}const h=!a||cT(a)?{center:C(),eye:C(),up:C(),tilt:0,heading:0}:a;return h.eye=c.eye,h.up=c.up,h.center=$i(s),h.heading=c.heading,h.tilt=c.tilt,cT(a)&&a.resolver.resolve(h),h}function aI(t,e,r,i,s,n=null){let o,a,l;if(t.state.isGlobal){if(!pY(e.spatialReference,Ue.Global))return cT(n)&&n.resolver.reject(),null;const v=new ht(e.xmin,e.ymin,e.spatialReference),b=new ht(e.xmax,e.ymax,e.spatialReference),x=e.spatialReference.isGeographic?Jgt:Ygt;o=new ht({x:x.center(v.x,b.x),y:(b.y+v.y)/2,z:e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0,spatialReference:e.spatialReference});const T=Ir(e.spatialReference),S=eft(o,v,b);a=S.lon,l=S.lat,x.diff(v.x,b.x)>x.range/2&&(a+=T.halfCircumference),a=Math.min(a,T.halfCircumference),l=Math.min(l,T.halfCircumference)}else{const v=t.renderSpatialReference??e.spatialReference;v.equals(e.spatialReference)||(e=bg(e,v)),a=e.xmax-e.xmin,l=e.ymax-e.ymin;const b=e.zmax!=null&&e.zmin!=null?(e.zmax+e.zmin)/2:void 0;o=new ht({x:e.xmin+.5*a,y:e.ymin+.5*l,z:b,spatialReference:v})}const c=e.zmax!=null&&e.zmin!=null?e.zmax-e.zmin:0,h=t.state.camera,p=1/Math.tan(h.fovX/2),f=1/Math.tan(h.fovY/2),m=1/Math.tan(h.fov/2),g=Math.max(.5*a*p,.5*l*f,.5*c*m)/fY;if(cT(n)){const v=new RO(n.signal);return wP(t,r,i,o,g,s,v),void v.resolver.promise.then(b=>{const x=DU(t,b,t.camera.fov);if(x!=null)return n.resolver.resolve(x);n.resolver.reject()},b=>n.resolver.reject(b))}const _=wP(t,r,i,o,g,s);return DU(t,_,t.camera.fov,n)}function iyt(t,e,r){const i=t.renderSpatialReference,s=R0(r,i,M$(t));if(s==null)return null;const n=Math.tan(e.fovX/2),o=Math.tan(e.fovY/2),a=YP(e.eye,r),l=2*a*n*fY,c=2*a*o*fY;return t.viewingMode==="global"?nIe(t,s,l,c):tIe(t,s,l,c)}function syt(t,e,r){const i=t.pointsOfInterest.centerOnSurfaceFrequent.distance;if(Math.log(r/i)/Math.LN2>Wgt)return!0;const s=t.renderSpatialReference,n=M$(t),o=R0(e,s,n),a=R0(t.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,s,n);if(o==null||a==null)return!1;const l=Math.tan(.5*t.state.camera.fov)*i;return a.distance(o)/l>Zgt}function nyt(t,e,r,i,s,n){let o=0;return n===Ma.ADJUST&&syt(t,i,s)?(e=0,o=oyt(t,s,r,i)):o=Ere(t,i,s,r),o=t.state.constraints.clampTilt(s,o),{heading:e,tilt:r=pIe(t,i,s,o)}}const LU=.7;function oyt(t,e,r,i){const s=Ere(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);n.max=Math.min(n.max,.5*Math.PI);const o=n.min*(1-LU)+n.max*LU;return Math.min(s,o)}function ayt(t,e,r,i){let s=Ere(t,i,e,r);if(!t.state.constraints.tilt)return s;const n=t.state.constraints.tilt(e);return s=Math.min(s,.5*Math.PI),n.min*(1-LU)+s*LU}function pIe(t,e,r,i){return OO(t).lookAtTiltToEyeTilt(i,e,r)}function Ere(t,e,r,i){return OO(t).eyeTiltToLookAtTilt(i,e,r)}function DU(t,e,r,i){if(e==null)return null;const s=t.renderSpatialReference,n=R0(e.eye,s,M$(t));return n==null?null:i!=null?(i.position=n,i.heading=e.heading,i.tilt=e.tilt,i.fov=r,i):new Zd(n,e.heading,e.tilt,r)}function lyt(t,e){const r=t.basemapTerrain?.tilingScheme;if(r)return r.levelAtScale(e);aIe.error("#scaleToZoom()","Cannot compute zoom from scale without a tiling scheme")}function fIe(t,e){const r=t.basemapTerrain?.tilingScheme;if(r)return r.scaleAtLevel(e);aIe.error("#zoomToScale()","Cannot compute scale from zoom without a tiling scheme")}function mIe(t,e){return Tn(e.center,t.renderSpatialReference,mde,qe.WGS84),jT(t,e.distance,mde[1])}let RO=class{constructor(e){this.signal=e,this.resolver=nn()}};function cT(t){return t&&"resolver"in t}const cyt=.66;function gIe(t){return 360-z6.normalize(t)}function C8(t){return z6.normalize(360-t)}function _R(t){return t!=null&&t.resolver&&t.resolver.reject(),null}function uyt(t,e){return t!=null&&t.resolver&&t.resolver.resolve(e),e}function yIe(t,e,r,i=null){if(!e)return _R(i);const s=t.spatialReference||qe.WGS84;if(e.camera!=null){const c=sS(e.camera.position,s);if(c==null)return _R(i);const h=e.camera.clone();return h.position=c.clone(),uyt(i,h)}if(e.targetGeometry==null)return _R(i);const n=e.get("targetGeometry.spatialReference");if(n&&!S1(n,s))return _R(i);const o=DA(t,t.state.camera);let a=Ma.ADJUST;if(e.rotation!=null&&(o.heading=gIe(e.rotation),a=Ma.LOCKED),r!=null&&(o.tilt=r),e.targetGeometry.type==="point"){const c=e.targetGeometry;let h;const p=e.targetGeometry.clone();return h=e.scale!=null?Sre(t,e.scale,c.latitude):t.state.camera.distance,dIe(t,p,h,o,a,i)}const l=e.targetGeometry.extent;return l?aI(t,l,o.heading,o.tilt,a,i):_R(i)}function hyt(t,e,r=null){return r==null&&(r=new Nf),Ore(t,null,e.clone(),r)}async function dyt(t,e,r){const i=xyt(t,e);if(!i)throw new D("viewpointutils-create:no-target","Missing target for creating viewpoint");const s=new Zd({fov:t.camera.fov}),n=new Nf({camera:s});if(i.target instanceof Nf)return Ub(await myt(t,i.target,i,r,n));if(i.target instanceof Zd)return Ub(vIe(t,i.target,n));const o=i.scale!=null||i.zoom!=null;if(i.target instanceof vr){const c=i.target.xmin===i.target.xmax||i.target.ymin===i.target.ymax;return Ub(o||c?await gY(t,i,i.target.center,s,r,n):await vyt(t,i,i.target,s,r,n))}const a={boundingBox:Gi(),hasZ:!1,screenSpaceObjects:[]},l=o?pyt(t,i):void 0;if(await _Ie(t,i.target,l,a),isFinite(a.boundingBox[0])){let c;if(lf(a.boundingBox,en),rh.x=en[0],rh.y=en[1],rh.z=en[2],rh.spatialReference=t.spatialReference,isFinite(rh.z)&&a.hasZ?c=gK(a.boundingBox):(rh.z=void 0,c=I9e(mK(a.boundingBox,Syt))),o||c)return Ub(await gY(t,i,rh,s,r,n));const h=Tyt(t,a.screenSpaceObjects);return Ub(await wyt(t,i,rh,a.boundingBox,h,s,r,n))}return i.position?Ub(yyt(t,i,s,n)):Ub(await _yt(t,i,s,r,n))}function Cre(t,e){return e.scale==null&&e.zoom!=null?fIe(t,e.zoom):e.scale}function pyt(t,e){const r=Cre(t,e);return r?xct(r):void 0}function Are(t,e){let r=!1;return e.heading!=null?(t.heading=e.heading,r=!0):e.rotation!=null&&(t.heading=gIe(e.rotation),r=!0),e.tilt!=null&&(t.tilt=e.tilt,r=!0),e.fov!=null&&(t.fov=e.fov),r}function Ore(t,e,r,i){const s=t.spatialReference||qe.WGS84;return(e=e??jy(t,r))==null||(i.targetGeometry=R0(e.center,t.renderSpatialReference,s),i.scale=mIe(t,e),i.rotation=C8(r.heading),i.camera=r),i}function NU(t,e,r){const i=()=>new D("viewpointutils:invalid-geometry","The target is missing a valid geometry");if(!e)throw i();if(!S1(e.spatialReference,t.spatialReference))throw new D("viewpointutils:incompatible-spatialreference",`Spatial reference (${e.spatialReference?e.spatialReference.wkid:"unknown"}) is incompatible with the view (${t.spatialReference?.wkid})`,{geometry:e});const s=[];if(!e.hasZ&&t.basemapTerrain){let a;switch(e.type){case"point":a=e;break;case"multipoint":case"polyline":a=e.extent?.center;break;case"mesh":a=e.origin;break;case"extent":a=e.center;break;case"polygon":a=e.centroid}a&&t.basemapTerrain.spatialReference!=null&&S1(a,t.basemapTerrain.spatialReference)&&t.elevationProvider?en[2]=Qm(t.elevationProvider,a)??0:en[2]=0}(0,Eyt[e.type])(e,a=>{s.push(a[0],a[1],a[2])},en);const n=s.length/3;if(n===0)throw i();const o=new Array(s.length);if(wi(s,e.spatialReference,0,o,t.spatialReference,0,n)){e.hasZ&&(r.hasZ=!0);for(let a=0;a<o.length;a+=3)e.hasZ?(en[0]=o[a],en[1]=o[a+1],en[2]=o[a+2]):(en[0]=o[a],en[1]=o[a+1]),yg(r.boundingBox,en)}}async function fyt(t,e,r,i){const s=await Sh(t.whenViewForGraphic(e));if(s.ok===!1||s.value==null||!("whenGraphicBounds"in s.value))return void NU(t,e.geometry,i);const n=s.value,o=await Sh(n.whenGraphicBounds(e,{minDemResolution:r}));if(o.ok===!1)return void NU(t,e.geometry,i);const{screenSpaceObjects:a,boundingBox:l}=o.value;aA(i.boundingBox,l),a&&a.forEach(c=>{i.screenSpaceObjects.push(c)}),isFinite(l[2])&&(i.hasZ=!0)}async function _Ie(t,e,r,i){if(Array.isArray(e)&&e.length===2){const s=e[0],n=e[1];if(typeof s=="number"&&typeof n=="number")return rh.x=s,rh.y=n,rh.z=void 0,rh.spatialReference=t.spatialReference?.isGeographic?t.spatialReference:qe.WGS84,void NU(t,rh,i)}e&&"map"in e&&typeof e.map=="function"?await Oh(e.map(s=>_Ie(t,s,r,i))):e instanceof ob?NU(t,e,i):e instanceof oa&&await fyt(t,e,r,i)}async function myt(t,e,r,i,s){if(e.camera!=null)return vIe(t,e.camera,s);s.scale=e.scale,s.rotation=e.rotation,s.targetGeometry=e.targetGeometry!=null?e.targetGeometry.clone():null,s.camera=null,r.heading!=null?s.rotation=C8(r.heading):r.rotation!=null&&(s.rotation=r.rotation);const n=Cre(t,r);n!=null&&(s.scale=n);const o=new RO(i);return yIe(t,s,r.tilt,o),s.camera=await o.resolver.promise,s}function vIe(t,e,r){const i=t.spatialReference,s=sS(e.position,i);return s==null?null:((e=e.clone()).fov=t.camera.fov,e.position=s,Ore(t,null,e,r))}function gyt(t,e,r,i,s,n){const o=t.renderSpatialReference;return aa(r,QD,o),aa(e,MB,o),n.targetGeometry=new ht(e),s.position=new ht(r),pe(FU,MB,QD),E8(t,QD,FU,i.up,s),n.scale=jT(t,_i(QD,MB),n.targetGeometry.latitude),n.rotation=C8(s.heading),n.camera=s,n}async function gY(t,e,r,i,s,n){if(r==null)throw new D("createfromcenter","invalid point");n.targetGeometry=r.clone();const o=vS(t);if(e.position)return gyt(t,n.targetGeometry,e.position,o,i,n);if(e.zoomFactor){const l=o.distance/e.zoomFactor,c=ae(en,o.viewForward,-l);o.eye=ue(en,o.center,c),n.scale=jT(t,l,r.latitude)}DA(t,o,i);const a=Are(i,e)?Ma.LOCKED:Ma.ADJUST;if(!e.zoomFactor){const l=Cre(t,e);l==null?(aa(r,en,t.renderSpatialReference),A3e(o.frustum,en)?n.scale=jT(t,_i(o.eye,en),r.latitude):n.scale=mIe(t,o)):n.scale=l;const c=new RO(s);hIe(t,n.targetGeometry,n.scale,i,a,c),n.camera=await c.resolver.promise}return n}function yyt(t,e,r,i){const s=vS(t);return oe(FU,s.viewForward),E8(t,s.eye,FU,s.up,IB),r.position=new ht(e.position),r.heading=e.heading!=null?e.heading:IB.heading,r.tilt=e.tilt!=null?e.tilt:IB.tilt,Ore(t,null,r,i)}async function _yt(t,e,r,i,s){const n=vS(t);return gY(t,e,R0(n.center,t.renderSpatialReference,t.spatialReference),r,i,s)}async function vyt(t,e,r,i,s,n){n.targetGeometry=r.clone();const o=vS(t);DA(t,o,i);const a=Are(i,e)?Ma.LOCKED:Ma.ADJUST,l=new RO(s);return aI(t,r,i.heading,i.tilt,a,l),n.camera=await l.resolver.promise,n}function byt(t,e,r,i,s){let n=0;r.z!=null?n=r.z:t.basemapTerrain&&t.elevationProvider&&(n=Qm(t.elevationProvider,r)),ie(en,r.x,r.y,n),wc(t.spatialReference,en,gde,t.renderSpatialReference),qd(JD,gde),Wd(JD,JD),Gi(vR);const o=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];for(let g=0;g<o.length;g++){const _=o[g];let v=i[_[2]];isFinite(v)||(v=n),ie(en,i[_[0]],i[_[1]],v),Tn(en,t.spatialReference,en,t.renderSpatialReference),yg(vR,yu(en,en,JD))}const a=lS(vR),l=lb(vR),c=cS(vR),h=1/Math.tan(e.fovX/2),p=1/Math.tan(e.fovY/2),f=.5*Math.sqrt(a*a+c*c)*Math.max(p,h)+.5*l,m=.5*l*p+.5*Math.max(a,c);return Math.max(f,m)/s}async function wyt(t,e,r,i,s,n,o,a){a.targetGeometry=r.clone();const l=vS(t),c=byt(t,l,r,i,s);DA(t,l,n);const h=Are(n,e)?Ma.LOCKED:Ma.ADJUST;a.scale=jT(t,c,a.targetGeometry.latitude);const p=new RO(o);return hIe(t,a.targetGeometry,a.scale,n,h,p),a.camera=await p.resolver.promise,a}function xyt(t,e){if(!e||!t.spatialReference)return null;const r={target:void 0};return"declaredClass"in e||Array.isArray(e)?r.target=e:(Object.assign(r,e),e.center&&!r.target&&(r.target=e.center)),r}function Ub(t){return t&&t.camera!=null&&(t.rotation=C8(t.camera.heading)),t}function Tyt(t,e){const r=cyt;if(!e.length)return r;let i=Number.NEGATIVE_INFINITY;for(let s=0;s<e.length;s++){const n=e[s].screenSpaceBoundingRect;i=Math.max(i,Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2]),Math.abs(n[3]))}return r-i/Math.min(t.width,t.height)*2}const en=C(),gde=xe(),JD=ts(),vR=Gn(),Syt=Ht(),FU=C(),QD=C(),MB=C(),IB={heading:0,tilt:0},rh=new ht,Eyt={point(t,e,r){r[0]=t.x,r[1]=t.y,t.z!=null&&(r[2]=t.z),e(r)},polygon(t,e,r){const i=t.hasZ;for(let s=0;s<t.rings.length;s++){const n=t.rings[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},polyline(t,e,r){const i=t.hasZ;for(let s=0;s<t.paths.length;s++){const n=t.paths[s];for(let o=0;o<n.length;o++)r[0]=n[o][0],r[1]=n[o][1],i&&(r[2]=n[o][2]),e(r)}},multipoint(t,e,r){const i=t.points,s=t.hasZ;for(let n=0;n<i.length;n++)r[0]=i[n][0],r[1]=i[n][1],s&&(r[2]=i[n][2]),e(r)},extent(t,e,r){t.zmin!=null&&t.zmax!=null?(e(ie(r,t.xmin,t.ymin,t.zmin)),e(ie(r,t.xmax,t.ymin,t.zmin)),e(ie(r,t.xmin,t.ymax,t.zmin)),e(ie(r,t.xmax,t.ymax,t.zmin)),e(ie(r,t.xmin,t.ymin,t.zmax)),e(ie(r,t.xmax,t.ymin,t.zmax)),e(ie(r,t.xmin,t.ymax,t.zmax)),e(ie(r,t.xmax,t.ymax,t.zmax))):(e(ie(r,t.xmin,t.ymin,r[2])),e(ie(r,t.xmax,t.ymin,r[2])),e(ie(r,t.xmin,t.ymax,r[2])),e(ie(r,t.xmax,t.ymax,r[2])))},mesh(t,e,r){const i=t.vertexAttributes&&t.vertexAttributes.position;if(i)for(let s=0;s<i.length;s+=3)e(ie(r,i[s],i[s+1],i[s+2]))}};let Cyt=class{constructor(e,r,i){this.target=e,this.options=r,this.view=i,this.state="pending",this._animationController=null,this._promise=new Promise((s,n)=>{this._resolveCallback=s,this._rejectCallback=n;const o=new AbortController;this.options.signal!=null&&xn(this.options.signal,()=>{this.abort()}),this._abortController=o,this.waitForReady()})}then(e,r){return this._promise.then(e,r)}catch(e){return this._promise.catch(e)}resolve(e){if(this.state!=="finished")return this.state="finished",this._resolveCallback(e)}reject(e){if(this.state!=="finished")return this.state="finished",this._rejectCallback(e)}abort(e=!1){this._abortController.abort(),this.state==="wait-for-animation-finish"&&!e&&this._animationController!=null&&this.view.state.cameraController===this._animationController&&this._animationController.active&&this._animationController.stopController(),this.reject(Tr())}async waitForReady(){if(this.state="wait-for-ready",!this.view.ready)try{await Pn(()=>this.view.ready,this._abortController.signal)}catch(e){return this.reject(e)}this.createViewPoint()}createViewPoint(){this.state!=="finished"&&(this.state="wait-for-viewpoint",this._animationController=this.options.animate?this._getAnimationController():null,dyt(this.view,this.target,this._abortController.signal).then(e=>{if(this.state==="finished")return;const r=e?this._getCameraFromViewpoint(e):null;if(r!=null)if(this.options.animate){if(this._animationController==null)return;this.startAnimation(r,this._animationController)}else this.view.stateManager.setStateCamera(r.camera,{applyConstraints:!r.isFullySpecified,positionAndOrientationOnly:!0,doNotCancelGoToOperation:!0}),this.resolve()},e=>{this.reject(e)}))}_getCameraFromViewpoint(e){const r=!!(this.target instanceof Nf&&this.target.camera||this.target instanceof Zd),i=e.camera;if(i==null)return null;if(!this.view.stateManager.isCompatible(i)){const n=i.position,o=n&&n.spatialReference,a=o?o.wkid:"none",l=this.view.spatialReference?.wkid;return this.reject(new D("GotoAnimation:incompatible-spatialreference",`Resulting camera has an incompatible spatial reference (camera: ${a}, view: ${l})`,{camera:i})),null}const s=jy(this.view,i);return s==null?(this.reject(new D("GotoAnimation:invalid-camera","Resulting camera is invalid")),null):{viewpoint:e,camera:s,isFullySpecified:r}}startAnimation(e,r){this.state="wait-for-animation-finish";const i=r.viewAnimation;if(i==null)return void this.reject(new D("GotoAnimation:missing-animation","Unreachable code in view.stateManager"));if(i.update(e.viewpoint,"running"),!r.active||r.viewAnimation==null||r.viewAnimation.target!==e.viewpoint||this.view.state.cameraController!==r)return this.abort();let s;e.isFullySpecified?(s=new oI({view:this.view,desiredCamera:e.camera}),CO(this.view,e.camera,$d.EYE_AND_CENTER)):rn(this.view,e.camera),r.begin(e.camera,this.options);const n=()=>{const a=this.view.state.cameraController;s&&(a&&a.active?a instanceof n0&&a.viewAnimation!=null&&a.viewAnimation.target===e.viewpoint&&(this.view.state.cameraController=s):r.viewAnimation!=null&&r.viewAnimation.target===e.viewpoint&&r.state==="finished"&&(this.view.state.cameraController=s))},o=a=>{if(this.view.state!=null)switch(r.state){case ys.Finished:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.resolve()}break;case ys.Ready:case ys.Rejected:case ys.Running:case ys.Stopped:switch(this.state){case"pending":case"wait-for-ready":case"wait-for-viewpoint":case"wait-for-animation-finish":this.reject(a)}}};i.when(n,a=>o(a)),r.asyncResult={resolve:()=>o(),reject:a=>o(a)}}_getAnimationController(){let e=null,r=null;const i=this.view.state.cameraController;return i instanceof n0&&(i.updateStateFromViewAnimation(),i.active&&(e=i,r=e.viewAnimation)),e!=null||(e=new n0({view:this.view,mode:"animation"}),r=e.viewAnimation,this.view.state.switchCameraController(e))?e:(r?.stop(),this.reject(new D("GotoAnimation:goto-cannot-interrupt","Cannot start an animation while interacting")),null)}},Yn=class extends me{get camera(){const e=this._get("camera");if(!this.ready)return e;const r=DA(this.view,this.view.state.camera,PB);return r&&e&&r.equals(e)?e:r.clone()}set camera(e){this._updatePropertyBeforeReady("camera",e)||(this.view.elevationProvider?.enableElevationCache(!0),this.setStateCamera(jy(this.view,e),{applyConstraints:!1})||K.getLogger(this).error("#camera=","Invalid camera",e),this.view.elevationProvider?.enableElevationCache(!1))}get contentCamera(){const e=this._get("contentCamera");if(!this.ready)return e;const r=DA(this.view,this.view.state.contentCamera,PB);return r&&e&&r.equals(e)?e:r.clone()}set contentCamera(e){if(this._updatePropertyBeforeReady("contentCamera",e))return;const r=jy(this.view,e);r!=null?(this._updateElevation(r),this.view.state.contentCamera=r):this.view.state.contentCamera=null}installContentCameraReset(e){if(this.removeHandles($B),this.test.contentCameraResetState.clear(),!this.view.state.fixedContentCamera)return!1;const r=this.zoom,i=this.view.state.camera.distance**2,s=Ml(this.view.state.camera.center),n=e.sticky?this.contentCamera.clone():null;return this.addHandles([Q(()=>this.contentCamera,()=>{e.sticky||(this.removeHandles($B),this.test.contentCameraResetState.clear())}),Q(()=>this.zoom,o=>{o!==void 0&&r!==void 0&&(this.test.contentCameraResetState.set("view.zoom",Math.abs(o-r)/2),Math.abs(o-r)>2?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n))}),Q(()=>this.view.state.camera,o=>{const a=kn(s,o.center);this.test.contentCameraResetState.set("camera.center",a/i),a>i?this.contentCamera=null:this.view.state.fixedContentCamera||(this.contentCamera=n)})],$B),!0}get center(){return this.ready?this.view.pointsOfInterest.centerOnContent.location:this._get("center")}set center(e){this._updatePropertyBeforeReady("center",e)||(e?this.isCompatible(e)?this.setStateCamera(this._centerToCamera(e),{applyConstraints:!0})?this.view.pointsOfInterest.centerOnContent.runTask():K.getLogger(this).error("#center=","Invalid center",e):K.getLogger(this).error("#center=","Center has an incompatible spatial reference (center: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):K.getLogger(this).error("#center=","Center may not be null or undefined"))}get extent(){if(!this.ready)return this._get("extent");const e=this.view,r=iyt(e,e.state.camera,e.pointsOfInterest.centerOnContent.renderLocation);return r??this._get("extent")}set extent(e){this._updatePropertyBeforeReady("extent",e)||(e?this.isCompatible(e)?this.setStateCamera(this._extentToCamera(e),{applyConstraints:!0})||K.getLogger(this).error("#extent=","Invalid extent",e):K.getLogger(this).error("#extent=","Extent has an incompatible spatial reference (extent: "+(e.spatialReference?e.spatialReference.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e):K.getLogger(this).error("#extent=","Extent may not be null or undefined"))}get frustum(){const e=this._propertiesPool.get("frustum");return e.renderCoordsHelper=this.view.renderCoordsHelper,e.update(this.view.state.camera),e}get hasInitialView(){return!!this.view.get("map.initialViewProperties.viewpoint")}get scale(){if(this.ready){const e=this.view.pointsOfInterest.centerOnContent;return jT(this.view,e.distance,e.location.latitude)}return this._get("scale")}set scale(e){this._updatePropertyBeforeReady("scale",e)||this.setStateCamera(this._scaleToCamera(e),{applyConstraints:!0})||K.getLogger(this).error("#scale=","Invalid scale",e)}get padding(){if(!this.ready)return this._get("padding");const e=this.view.state.camera,r=e.padding,i=e.pixelRatio,s=this._get("padding"),n=Math.round(r[sr.TOP]/i),o=Math.round(r[sr.RIGHT]/i),a=Math.round(r[sr.BOTTOM]/i),l=Math.round(r[sr.LEFT]/i);return s!=null&&s.top===n&&s.right===o&&s.bottom===a&&s.left===l?s:{top:n,right:o,bottom:a,left:l}}set padding(e){this._updatePropertyBeforeReady("padding",e)||(this._paddingToArray(e,this.view.state.camera.pixelRatio,KD),this.view.state.updateCamera(r=>r.padding=KD))}_paddingToArray(e,r,i){e?zi(i,e.top||0,e.right||0,e.bottom||0,e.left||0):zi(i,0,0,0,0);for(let s=0;s<4;s++)i[s]=Math.round(i[s]*r)}get screenCenter(){const e=this.padding;return xh((this.view.width-(e.left+e.right))/2+e.left,(this.view.height-(e.top+e.bottom))/2+e.top)}get viewpoint(){return this.ready?hyt(this.view,this.camera):this._get("viewpoint")}set viewpoint(e){if(!this._updatePropertyBeforeReady("viewpoint",e))if(e)if(this.isCompatible(e))this.setStateCamera(this._viewpointToCamera(e),{applyConstraints:!e.camera})||K.getLogger(this).error("#viewpoint=","Invalid viewpoint",e);else{const r=e.camera!=null?e.camera.position:e.targetGeometry,i=r!=null&&r.spatialReference;K.getLogger(this).error("#viewpoint=","Viewpoint has an incompatible spatial reference (viewpoint: "+(i?i.wkid:"none")+", view: "+this.view.spatialReference?.wkid+")",e)}else K.getLogger(this).error("#viewpoint=","Viewpoint may not be null or undefined")}get zoom(){return this.ready?lyt(this.view,this.scale):this._get("zoom")}set zoom(e){this._updatePropertyBeforeReady("zoom",e)||e===void 0||this.setStateCamera(this._zoomToCamera(e),{applyConstraints:!0})||K.getLogger(this).error("#zoom=","Invalid zoom",e)}_computeCanvasSize(){if(this._devicePixelRatioOverride)return this.view.state.contentPixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*this._devicePixelRatioOverride),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*this._devicePixelRatioOverride),this._tmpCanvasSize.pixelRatio=this._devicePixelRatioOverride,this._tmpCanvasSize;const e=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio),r=this._usePhysicalPixelRendering?this._windowDevicePixelRatio:e;this._tmpCanvasSize.width=Math.round(this.view.surface.clientWidth*r),this._tmpCanvasSize.height=Math.round(this.view.surface.clientHeight*r);const i=this.view._stage.renderView.renderingContext.parameters.maxTextureSize;return Zx(this._tmpCanvasSize,i)?this._tmpCanvasSize.pixelRatio=r:this._tmpCanvasSize.pixelRatio=this._tmpCanvasSize.width>0?this._tmpCanvasSize.width/this.view.surface.clientWidth:r,this.view.state&&(this.view.state.contentPixelRatio=Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)),this._tmpCanvasSize}get _rasterPixelRatio(){return this._devicePixelRatioOverride!=null?this._devicePixelRatioOverride:this._usePhysicalPixelRenderingAny?this._windowDevicePixelRatio:Math.min(this._windowDevicePixelRatio,this.view.qualitySettings.maximumPixelRatio)}get _usePhysicalPixelRendering(){return this.view?._stage?.renderer.isFeatureEnabled(wn.PhysicalPixelRendering)??!1}get _usePhysicalPixelRenderingAny(){const e=this.view?._stage?.renderer;return e&&(e.isFeatureEnabled(wn.PhysicalPixelRendering,Br.IDLE)||e.isFeatureEnabled(wn.PhysicalPixelRendering,Br.INTERACTING)||e.isFeatureEnabled(wn.PhysicalPixelRendering,Br.ANIMATING))}constructor(e){super(e),this.constraintsManager=null,this.ready=!1,this._windowDevicePixelRatio=1,this._devicePixelRatioOverride=null,this._updatingIgnoreRenderState=!1,this.test={viewStateManager:this,contentCameraResetState:new Map,setDevicePixelRatio:r=>this._devicePixelRatioOverride=r,renderState:null,get maximumPixelRatio(){return this.viewStateManager.view.qualitySettings.maximumPixelRatio},set updatingIgnoreRenderState(r){this.viewStateManager._updatingIgnoreRenderState=r},get updatingIgnoreRenderState(){return this.viewStateManager._updatingIgnoreRenderState||this.renderState!=null}},this._propertiesPool=new M0({frustum:Qv},this),this._cameraSetByUser=!1,this._gotoOperation=null,this._cameraChangeTime=0,this._tmpCanvasSize=new Ayt}initialize(){this._cameraChangeTime=performance.now(),this.addHandles([Vs(()=>this.view.state.events,"before-camera-change",e=>e&&this._updateElevation(e)),Q(()=>this.view.state?.camera,(e,r)=>this._cameraChangedHandler(e,r),Rr)]),No(()=>this.view.state?.camera,e=>this._updateElevation(e),{once:!0,sync:!0}),this.addHandles([QC({prepare:()=>this._prepareFrame()}),Q(()=>this.view.state.cameraController,()=>{this._cameraSetByUser=!0,this.removeHandles(eN)}),Vs(()=>this.view.state.events,"camera-projection-changed",()=>this.notifyChange("scale"))])}destroy(){this.exit(),this._propertiesPool=Re(this._propertiesPool)}init(){this.constraintsManager=new dM({view:this.view}),this._prepareFrame();const e=this._getInitialProperties();this._cameraSetByUser=!1,this._set("ready",!0);for(const r of e)this.set(r.name,r.value);if(!this._cameraSetByUser){const r=this.view.get("map.initialViewProperties.viewpoint")||this.view.initialExtent;r&&this.isCompatible(r)?this._setInitialView(r):this.view.state.viewingMode===Ue.Local&&this.addHandles(No(()=>this.view.basemapTerrain.ready,()=>{this.removeHandles(eN),this._setInitialView(this.view.dataExtent)},{once:!0,initial:!0}),eN)}}exit(){this._cancelGoToOperation(),this.ready&&(this._override("padding",this.padding),this._set("ready",!1),this._clearOverride("hasInitialView"),this._cameraSetByUser=!1,this.removeHandles(eN),this.constraintsManager=Re(this.constraintsManager))}async goTo(e,r){const i={animate:!0,...r};return this._gotoOperation!=null&&this._gotoOperation.abort(i.animate),this._gotoOperation=new Cyt(e,i,this.view),this.view.resourceController.scheduler.stopFrame(),this._gotoOperation}debugSetCameraOnContent(){this.setStateCamera(vS(this.view),{applyConstraints:!1})}step(e){const r=this.view.state,i=r?.cameraController;i&&(r.updateCamera(s=>i.stepController(e,s)),i.steppingFinished&&i.finishController())}_cancelGoToOperation(){this._gotoOperation!=null&&(this._gotoOperation.abort(),this._gotoOperation=null)}_getInitialProperties(){const e=new Set,r=[];for(const{propertyName:i,overrides:s}of Ryt){const n=e.has(i),o=this._isOverridden(i);!n&&o&&r.push({name:i,value:this._get(i)}),this._clearOverride(i),(n||o)&&s.forEach(a=>e.add(a))}return r}_setInitialView(e){if(e==null||this._cameraSetByUser)return;if(e instanceof Zd)return void this.setStateCamera(jy(this.view,e),{applyConstraints:!1});if(e instanceof Nf){if(e.targetGeometry instanceof vr){const n=aI(this.view,e.targetGeometry,0,.5,Ma.LOCKED);return void(n!=null&&this.setStateCamera(jy(this.view,n),{applyConstraints:!0}))}const i={applyConstraints:!e.camera},s=this._viewpointToCamera(e);return void this.setStateCamera(s,i)}const r=aI(this.view,e,0,.5,Ma.LOCKED);r!=null&&this.setStateCamera(jy(this.view,r),{applyConstraints:!0})}_updatePropertyBeforeReady(e,r){return!this.ready&&(this._override(e,r),r&&Oyt.includes(e)&&this._override("hasInitialView",!0),!0)}isCompatible(e){return e!=null&&(e instanceof Nf?e.camera?this.isCompatible(e.camera):this.isCompatible(e.targetGeometry):e instanceof Zd?this.isCompatible(e.position):e.spatialReference&&S1(e.spatialReference,this.view.spatialReference))}_getPreservingHeadingTilt(e=Myt){return this._cameraSetByUser?(e.heading=this.camera.heading,e.tilt=this.camera.tilt):(e.heading=0,e.tilt=.5),e}_centerPointAtDistanceToCamera(e,r,i=E_){const{heading:s,tilt:n}=this._getPreservingHeadingTilt(),o=wP(this.view,s,n,e,r,Ma.ADJUST);return o==null?null:(i.copyFrom(this.view.state.camera),i.eye=o.eye,i.center=o.center,i.up=o.up,i)}_centerToCamera(e){const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.distance;return this._centerPointAtDistanceToCamera(e,i)}_extentToCamera(e){const{heading:r,tilt:i}=this._getPreservingHeadingTilt(),s=aI(this.view,e,r,i,Ma.ADJUST,PB);return s?jy(this.view,s):null}_scaleToCamera(e){if(e==null)return null;const r=this.view.pointsOfInterest.centerOnContent;r.runTask();const i=r.renderLocation,s=r.location.latitude;if(s==null)return null;const n=Sre(this.view,e,s);return this._centerPointAtDistanceToCamera(i,n)}_zoomToCamera(e){return this._scaleToCamera(fIe(this.view,e))}_viewpointToCamera(e){return jy(this.view,yIe(this.view,e))}setStateCamera(e,r){return!(e==null||!this.view.state.stopActiveCameraController())&&(this._cameraSetByUser=!0,r.doNotCancelGoToOperation||this._cancelGoToOperation(),this.view.state.updateCamera(i=>{r.positionAndOrientationOnly?(i.eye=e.eye,i.center=e.center,i.up=e.up):i.copyFrom(e),r.applyConstraints&&rn(this.view,i)}),r.applyConstraints||(this.view.state.cameraController=new oI({view:this.view,desiredCamera:e})),!0)}_prepareFrame(){const{surface:e,canvas:r}=this.view;if(!e||!r)return;this._windowDevicePixelRatio=window.devicePixelRatio;const i=this._computeCanvasSize();if(i.width!==0&&i.height!==0&&(r.width===i.width&&r.height===i.height||(r.width=i.width,r.height=i.height),this.view.state)){const s=this.view.state.camera;s.fullWidth===i.width&&s.fullHeight===i.height&&s.pixelRatio===i.pixelRatio||(E_.copyFrom(s),E_.pixelRatio!==i.pixelRatio&&(this._paddingToArray(this.padding,i.pixelRatio,KD),E_.padding=KD),E_.fullWidth=i.width,E_.fullHeight=i.height,E_.pixelRatio=i.pixelRatio,this.view.state.camera=E_),this._updateViewState()}}_updateElevation(e){const r=this.view.basemapTerrain&&this.view.basemapTerrain.spatialReference,i=this.view.renderCoordsHelper?.getAltitude(e.eye)??0,s=r?b8(this.view,e.eye):0;e.relativeElevation=i-s}_updateViewState(){this.test.renderState!=null?this.view.state.mode=this.test.renderState:this.view.animation?this.view.state.mode=Br.ANIMATING:this.view.interacting?this.view.state.mode=Br.INTERACTING:(this.view.state.mode===Br.ANIMATING&&(this._cameraChangeTime=0),performance.now()-this._cameraChangeTime<=Iyt?this.view.state.mode=Br.INTERACTING:this.view.state.mode=Br.IDLE),this.view.state.rasterPixelRatio=this._rasterPixelRatio}_cameraChangedHandler(e,r){e&&r&&e.almostEquals(r)||(this._cameraChangeTime=performance.now(),this._updateViewState())}};u([d({type:Zd,dependsOn:["view.state.camera","ready"]})],Yn.prototype,"camera",null),u([d({type:Zd,dependsOn:["view.state.contentCamera","ready"]})],Yn.prototype,"contentCamera",null),u([d({type:ht})],Yn.prototype,"center",null),u([d({type:vr})],Yn.prototype,"extent",null),u([d({readOnly:!0})],Yn.prototype,"frustum",null),u([d({readOnly:!0})],Yn.prototype,"hasInitialView",null),u([d({readOnly:!0,type:Boolean})],Yn.prototype,"ready",void 0),u([d({type:Number})],Yn.prototype,"scale",null),u([d()],Yn.prototype,"padding",null),u([d({readOnly:!0})],Yn.prototype,"screenCenter",null),u([d({constructOnly:!0})],Yn.prototype,"view",void 0),u([d({type:Nf})],Yn.prototype,"viewpoint",null),u([d({type:Number})],Yn.prototype,"zoom",null),u([d({readOnly:!0})],Yn.prototype,"_rasterPixelRatio",null),u([d({readOnly:!0})],Yn.prototype,"_usePhysicalPixelRendering",null),u([d({readOnly:!0})],Yn.prototype,"_usePhysicalPixelRenderingAny",null),u([d()],Yn.prototype,"_windowDevicePixelRatio",void 0),u([d()],Yn.prototype,"_devicePixelRatioOverride",void 0),Yn=u([R("esri.views.3d.state.ViewStateManager")],Yn);let Ayt=class{constructor(){this.width=0,this.height=0,this.pixelRatio=1}};const Oyt=["camera","viewpoint","extent","scale","center","zoom"],Ryt=[{propertyName:"camera",overrides:["viewpoint"]},{propertyName:"viewpoint",overrides:["extent"]},{propertyName:"extent",overrides:["center","scale"]},{propertyName:"center",overrides:[]},{propertyName:"scale",overrides:["zoom"]},{propertyName:"zoom",overrides:[]},{propertyName:"padding",overrides:[]}],Myt={heading:0,tilt:0},PB=new Zd,E_=new ft,KD=Qt(),eN="pending-initial-view",$B="content-camera-reset",Iyt=300,yde=100;let Km=class extends Xy{constructor(){super(...arguments),this.startCamera=new ft,this.currentCamera=new ft,this._lastInteraction=0}get isInteractive(){return performance.now()-this._lastInteraction<yde}stepController(e,r){r.copyViewFrom(this.currentCamera),this.currentCamera.copyFrom(r)}onControllerStart(e){this.state=ys.Running,this.startCamera.copyFrom(e),this.currentCamera.copyFrom(e)}onControllerEnd(e){e.copyViewFrom(this.currentCamera)}commitCamera(){this._lastInteraction=performance.now(),setTimeout(()=>this.notifyChange("isInteractive"),yde),this.view.state.updateCamera(e=>this.stepController(0,e)),this.steppingFinished&&this.finishController()}};u([d({readOnly:!0})],Km.prototype,"isInteractive",null),u([d()],Km.prototype,"_lastInteraction",void 0),Km=u([R("esri.views.3d.state.controllers.InteractiveController")],Km);var lu;(function(t){t[t.CENTER=0]="CENTER",t[t.EYE=1]="EYE"})(lu||(lu={}));let lI=class extends Km{get _intersectionHelper(){return this.view.sceneIntersectionHelper}constructor(e){super(e),this.pivot=lu.CENTER,this._rotScale=0,this._lastPoint=Pe(),this._tmpWorldUp=C(),this._tmpViewDir=C(),this._tmpRotCurPoint=Pe(),this._tmpTransf=xe(),this._tmpAxis=C(),this._tmpPivotPoint=C(),this._pivotPos=C(),this._constraintOptions={selection:Xi.ALL,interactionType:Kt.TUMBLE,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ko.TUMBLE}}initialize(){this._rotScale=this.pivot===lu.CENTER?3:1.5}begin(e){if(this.active){switch(this.pivot){case lu.EYE:oe(this._pivotPos,this.startCamera.eye),this._constraintOptions.interactionType=Kt.LOOK_AROUND,this._constraintOptions.tiltMode=ko.LOOK_AROUND,this._constraintOptions.selection=Xi.NONE;break;case lu.CENTER:{const r=this._intersectionHelper.intersectRayFreePointFallback(this.startCamera.ray,this._pivotPos,this.view.map.ground.opacity===0?bS:{});r||oe(this._pivotPos,this.startCamera.center),this._constrainPivotPoint(e,r),this.startCamera.center=this._pivotPos,this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.tiltMode=ko.TUMBLE,this._constraintOptions.selection=Xi.ALL&~Xi.DISTANCE;break}}this._constraintOptions.interactionStartCamera=this.startCamera,lT(this.startCamera,e,this._lastPoint)}}_constrainPivotPoint(e,r){const i=this.startCamera,s=C();pe(s,this._pivotPos,i.eye);const n=Oe(s),o=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(i.eye,_de);let a=Math.max(Math.min(dgt,1/Math.abs(de(_de,i.viewForward)))*o,pgt);r&&(a=Math.min(n,a));const l=Ir(this.view.spatialReference),c=cs(i.width/i.pixelRatio*.5,i.height/i.pixelRatio*.5),h=S8(this.startCamera,c,l);let p=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,i.fullWidth/i.pixelRatio*.5,i.fullHeight/i.pixelRatio*.5,i,2.5*SB,SB),f=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],i,SB);p==null&&f==null||(p=p??f??0,f=f==null||h===Po.Horizontal?p:f,a=p>f?f:p,a=r?Math.min(a,n):a),_e(s,s),oe(this._pivotPos,ue(this._tmpPivotPoint,i.eye,ae(this._tmpPivotPoint,s,a)))}update(e){if(this.active){switch(this.pivot){case lu.EYE:this.currentCamera.center=this._applyRotation(this.currentCamera,e,this.currentCamera.center,this._pivotPos);break;case lu.CENTER:this.currentCamera.center=this._pivotPos,this.currentCamera.eye=this._applyRotation(this.currentCamera,e,this.currentCamera.eye,this._pivotPos)}rn(this.view,this.currentCamera,this._constraintOptions),this.commitCamera()}}end(){this.active&&this.finishController()}_applyRotation(e,r,i,s){this.view.renderCoordsHelper.worldUpAtPosition(s,this._tmpWorldUp),lT(e,r,this._tmpRotCurPoint);let n=(this._lastPoint[1]-this._tmpRotCurPoint[1])*this._rotScale,o=(this._tmpRotCurPoint[0]-this._lastPoint[0])*this._rotScale;pe(this._tmpViewDir,i,s);const a=Oe(this._tmpViewDir),l=oo(de(this._tmpViewDir,this._tmpWorldUp)/a);if(this.pivot===lu.EYE){n*=-.5;const c=.5*Math.PI-l,h=.5*Math.PI*.99;n=c-Math.max(-h,Math.min(h,c+n))}return n=ye(n+l,wa.min,wa.max)-l,st(this._tmpAxis,e.up,this._tmpViewDir),this.pivot===lu.CENTER&&(o=-o),Th(this._tmpTransf,o,this._tmpWorldUp),_u(this._tmpTransf,this._tmpTransf,n,this._tmpAxis),Ne(this._tmpViewDir,this._tmpViewDir,this._tmpTransf),e.up=Ne(LB,e.up,this._tmpTransf),ue(LB,s,this._tmpViewDir),jn(this._lastPoint,this._tmpRotCurPoint),LB}};u([d()],lI.prototype,"pivot",void 0),lI=u([R("esri.views.3d.state.controllers.RotateController")],lI);const LB=C(),_de=C();let DB=class extends ua{constructor(e,r,i,s){super(!0),this._view=e,this.pointerAction=r,this._pivot=i,this.registerIncoming("drag",s,n=>this._handleDrag(n))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!wre(e.data,this.pointerAction))return;const i=cs(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._cameraController=new lI({view:this._view,pivot:this._pivot}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}},yY=class extends Km{constructor(){super(...arguments),this._pickPoint=C(),this._tmpP0=Pe(),this._panAxisAngle=x8(),this._tmpRayDir=C(),this._tmpRayDirPick=C(),this._targetOnSphere=C(),this._navMode=Po.Horizontal,this._tmpRay={origin:C(),direction:C()},this.dragBeginPoint=cs(),this._normalizedAnchorPoint=Pe(),this._constraintOptions={selection:Xi.ALL_EXCEPT_COLLISION,interactionType:Kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:null,tiltMode:ko.TUMBLE},this._sphere=js(),this._hasPickPoint=!1}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;jn(this.dragBeginPoint,e),lT(this.startCamera,e,this._normalizedAnchorPoint);const r=Ir(this.view.spatialReference),i=BMe(this._intersectionHelper,this.startCamera,e,r,LA.Ellipsoid,this.view.map.ground.opacity===0?bS:{});if(this._navMode=S8(this.startCamera,e,r),this._navMode===Po.Horizontal)this._hasPickPoint=!!i.scenePickPoint,this._pickPoint=i.scenePickPoint??this._pickPoint,this._sphere=i.sphere;else{let s;AO(this.startCamera,e,this._tmpRay),_e(this._tmpRay.direction,this._tmpRay.direction),i.scenePickPoint!=null&&(pe(this._tmpRayDirPick,this.startCamera.eye,i.scenePickPoint),s=Oe(this._tmpRayDirPick));const n=Math.abs(this.view.camera.position.z);this.view.renderCoordsHelper.worldUpAtPosition(this.startCamera.eye,vde);let o=ye(Math.min(LMe,1/Math.abs(de(vde,this._tmpRay.direction)))*n,AU[0],AU[1]);const a=this.view._stage.renderView.getMinimalDepthForArea(null,e[0],e[1],this.view.state.camera,T8);o=a??o,o=s!=null?Math.min(o,s):o,this._hasPickPoint=!0,ae(this._tmpRay.direction,this._tmpRay.direction,o),ue(this._pickPoint,this._tmpRay.origin,this._tmpRay.direction)}this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(this.active){if(this.currentCamera.eye=this.startCamera.eye,this.currentCamera.center=this.startCamera.center,this.currentCamera.up=this.startCamera.up,this._navMode===Po.Horizontal){pe(this._tmpRayDir,this.currentCamera.center,this.currentCamera.eye);const r=Oe(this._tmpRayDir);lT(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;if(this._hasPickPoint&&s<r){const o=1-(1-s/r)*(1-this._sphere[3]/Oe(this.currentCamera.center));this.currentCamera.center=ae(tN,this.currentCamera.center,o)}ae(this._tmpRayDir,this._tmpRayDir,-s/r),this.currentCamera.eye=ue(tN,this.currentCamera.center,this._tmpRayDir),this._constraintOptions.interactionFactor=nf(I0(this.dragBeginPoint,e)),rn(this.view,this.currentCamera,this._constraintOptions),this._hasPickPoint&&(bP(this._sphere,this.currentCamera,this.dragBeginPoint,this._targetOnSphere),mre(this._pickPoint,this._targetOnSphere,this._panAxisAngle),tb(this.currentCamera,this._sphere,this._panAxisAngle))}else{const r=Oe(this._tmpRay.direction);lT(this.currentCamera,e,this._tmpP0);const i=12*(this._normalizedAnchorPoint[1]-this._tmpP0[1]);let s=r*2**i;const n=this.view.state.constraints.minimumPoiDistance;if(i<0&&s<n&&(s=n),Math.abs(r-s)<1e-6)return;ae(this._tmpRayDir,this._tmpRay.direction,1-s/r),this.currentCamera.eye=ue(tN,this.currentCamera.eye,this._tmpRayDir),this.currentCamera.center=ue(tN,this.currentCamera.center,this._tmpRayDir)}CO(this.view,this.currentCamera),this.commitCamera()}}end(){this.active&&this.finishController()}};yY=u([R("esri.views.3d.state.controllers.global.ZoomController")],yY);const tN=C(),vde=C();let _Y=class extends Km{constructor(){super(...arguments),this._tmpP=C(),this._tmpDir=C(),this._tmpN=C(),this._tmpP0=Pe(),this._tmpPoi=C(),this._tmpRayDir=C(),this.dragBeginPoint=cs(),this._normalizedAnchorPoint=Pe(),this._constraintOptions={selection:Xi.ALL,interactionType:Kt.ZOOM,interactionFactor:0,interactionStartCamera:null,interactionDirection:C(),tiltMode:ko.TUMBLE},this._plane=zr()}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;jn(this.dragBeginPoint,e),lT(this.startCamera,e,this._normalizedAnchorPoint);const r=this._intersectionHelper.intersectScreenFreePointFallback(e,this._tmpP,this.view.map.ground.opacity===0?bS:{});pe(this._tmpDir,this._tmpP,this.startCamera.eye);const i=Oe(this._tmpDir);_e(this._tmpDir,this._tmpDir);const s=Math.abs(this.view.camera.position.z);let n=ye(Math.min(LMe,1/Math.abs(de(Pyt,this._tmpDir)))*s,AU[0],AU[1]);const o=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,e[0],e[1],this.view.state.camera,T8);n=o??n,n=r?Math.min(n,i):n,ae(this._tmpDir,this._tmpDir,n),ue(this._tmpP,this.startCamera.eye,this._tmpDir),pe(this._tmpN,this.startCamera.eye,this.startCamera.center),_e(this._tmpN,this._tmpN),this._tmpN[1]<0&&el(this._tmpN,this._tmpN),x$(this._tmpP,this._tmpN,this._plane),this._constraintOptions.interactionStartCamera=this.startCamera}update(e){if(!this.active)return;fgt(this._plane,this.currentCamera,this.dragBeginPoint,this._tmpPoi)||oe(this._tmpPoi,this.currentCamera.center),lT(this.currentCamera,e,this._tmpP0);let r=4*(this._tmpP0[1]-this._normalizedAnchorPoint[1]);jn(this._normalizedAnchorPoint,this._tmpP0),pe(this._tmpRayDir,this._tmpPoi,this.currentCamera.eye);const i=Oe(this._tmpRayDir);let s=i*(1-r);this._constraintOptions.interactionDirection&&(oe(this._constraintOptions.interactionDirection,this._tmpRayDir),ae(this._constraintOptions.interactionDirection,this._constraintOptions.interactionDirection,Math.sign(r)/i));const n=this.view.state.constraints.minimumPoiDistance;r>=0&&s<n&&(s=n,r=-(s-i)/i),Math.abs(i-s)<1e-6||(ae(this._tmpRayDir,this._tmpRayDir,r),this.currentCamera.eye=ue(Vb,this.currentCamera.eye,this._tmpRayDir),Wr(Vb,this.currentCamera.center,this._tmpPoi,r),this._tmpPoi[2]>this.startCamera.center[2]?Vb[2]=Math.max(this.startCamera.center[2],Vb[2]):Vb[2]=Math.min(this.startCamera.center[2],Vb[2]),this.currentCamera.center=Vb,this._constraintOptions.interactionFactor=nf(I0(this.dragBeginPoint,e)),rn(this.view,this.currentCamera,this._constraintOptions),this.commitCamera())}end(){this.active&&this.finishController()}};_Y=u([R("esri.views.3d.state.controllers.local.ZoomController")],_Y);const Vb=C(),Pyt=Ee(0,0,1);let $yt=class extends ua{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){const r=e.data;if(r.pointers.size>1||!wre(e.data,this.pointerAction))return;const i=cs(r.center.x,r.center.y);switch(r.action){case"start":this._cameraController&&(this._cameraController.end(),this._cameraController=null),this._view.state.isGlobal?this._cameraController=new yY({view:this._view}):this._cameraController=new _Y({view:this._view}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController&&this._cameraController.update(i);break;case"end":this._cameraController&&(this._cameraController.end(),this._cameraController=null)}e.stopPropagation()}};function fp(t){let e=t*t;return t<0&&(e*=-1),e}function bde(t,e,r){const i=r,s=t.state,n=t.device,o=e.tiltDirection==="forward-down"?1:-1,a=1;return n.deviceType==="standard"?(i.translation[0]=fp(s.axes[0]),i.translation[1]=fp(s.axes[1]),i.translation[2]=fp(s.buttons[7])-fp(s.buttons[6]),i.heading=fp(s.axes[2]),i.tilt=fp(s.axes[3])):n.deviceType==="spacemouse"&&(i.translation[0]=1.2*fp(s.axes[0]),i.translation[1]=1.2*fp(s.axes[1]),i.translation[2]=2*-fp(s.axes[2]),i.heading=1.2*fp(s.axes[5]),i.tilt=1.2*fp(s.axes[3])),i.tilt*=o,ae(i.translation,i.translation,a),i}function wde(t,e){const r=e;return r.translation[0]=t[1]-t[0],r.translation[1]=t[3]-t[2],r.translation[2]=t[4]-t[5],r.heading=t[7]-t[6],r.tilt=t[8]-t[9],r.zoom=t[10]-t[11],r}function NB(t){return t.translation[0]===0&&t.translation[1]===0&&t.translation[2]===0&&t.heading===0&&t.tilt===0&&t.zoom===0}let Xx=class extends Km{constructor(e){super(e),this._filteredSurfaceElevation=0,this._transformation={translation:[0,0,0],heading:0,tilt:0,zoom:0},this._keysButtonState=[0,0,0,0,0,0,0,0,0,0,0,0],this._tmpCamera=new ft,this._headingStart=0,this._constraintOptions={selection:Xi.ALL,interactionType:Kt.NONE,interactionStartCamera:new ft,interactionFactor:0,interactionDirection:null,tiltMode:ko.LOOK_AROUND}}handleEventGamepad(e){const r=bde(e,this.view.navigation.gamepad,this._transformation);(e.action==="end"||NB(r))&&this.finishController()}activateDirection(e){this._keysButtonState[e]=1,wde(this._keysButtonState,this._transformation)}deactivateDirection(e){this._keysButtonState[e]=0;const r=wde(this._keysButtonState,this._transformation);NB(r)&&this.finishController()}onControllerStart(e){this._filteredSurfaceElevation=this.view.pointsOfInterest.cameraOnSurface.location.z,this._headingStart=this.view.camera.heading,super.onControllerStart(e)}_updateFilteredSurfaceElevation(e){const r=this.view.pointsOfInterest.cameraOnSurface.location.z,i=1;this._filteredSurfaceElevation+=i*(r-this._filteredSurfaceElevation)*e}stepController(e,r){this._updateStartHeading(),this._updateFilteredSurfaceElevation(e),this.currentCamera.copyViewFrom(r),this._updateCameraCenter(),this._constraintOptions.interactionStartCamera?.copyFrom(this.currentCamera),this._calculateControlTransformation(e,this.currentCamera,zb),this._applyDisabledMovementTypes(zb),this._applyPan(zb.pan),this._applyRotate(zb.rotate),this._applyZoom(zb.zoom),this._applyAscend(zb.ascend),this._constraintOptions.interactionType=Kt.NONE,this._constraintOptions.selection=Xi.COLLISION,rn(this.view,this.currentCamera,this._constraintOptions),super.stepController(e,r)}_updateStartHeading(){this._transformation.heading!==0&&(this._headingStart=this.view.camera.heading)}_applyRotate(e){if(!e.enabled)return;const r=this.currentCamera;pe(ql,r.center,r.eye),Ne(ql,ql,e.matrix),r.center=ue(ql,ql,r.eye),r.up=Ne(ql,r.up,e.matrix),this._constraintOptions.interactionType=Kt.LOOK_AROUND,this._constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,rn(this.view,r,this._constraintOptions)}_applyPan(e,r=this.currentCamera){e.enabled&&(r.eye=Ne(ql,r.eye,e.matrix),r.center=Ne(ql,r.center,e.matrix),this.view.state.isGlobal&&(r.up=Ne(ql,r.up,e.matrix)),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.selection=Xi.ALL,rn(this.view,r,this._constraintOptions))}_applyZoom(e){if(!e)return;const r=this.currentCamera.viewForward;this.currentCamera.eye=ue(ql,this.currentCamera.eye,ae(ke.get(),r,e)),oe(bR,r),el(bR,bR),this._constraintOptions.interactionDirection=bR,this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,rn(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_applyAscend(e){if(!e)return;const r=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,ke.get());if(this._constraintOptions.interactionDirection=oe(bR,r),this.view.state.isGlobal){const i=Oe(this.currentCamera.eye),s=(i+e)/i;this.currentCamera.eye=ae(ql,this.currentCamera.eye,s),this.currentCamera.center=ae(ql,this.currentCamera.center,s)}else{const i=ae(ke.get(),r,e);this.currentCamera.eye=ue(ql,this.currentCamera.eye,i),this.currentCamera.center=ue(ql,this.currentCamera.center,i)}this._updateCameraCenter(),this._constraintOptions.interactionType=Kt.ASCEND,this._constraintOptions.selection=Xi.COLLISION,rn(this.view,this.currentCamera,this._constraintOptions)&&this._updateCameraCenter(),this._constraintOptions.selection=Xi.ALL_EXCEPT_COLLISION,rn(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null}_calculateControlTransformation(e,r,i){Vyt(i);const s=this._computeVelocities(e);this.view.state.isLocal?this._calculateControlTransformationLocal(s,r,i):this._calculateControlTransformationGlobal(s,r,i)}_updateCameraCenter(){const e=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,r=this.view.renderCoordsHelper,i=this.currentCamera.ray;this.currentCamera.center=r.intersectManifoldClosestSilhouette(i,e,ql)}_calculateControlTransformationLocal(e,r,i){const{viewRight:s,viewForward:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=ie(ke.get(),n[0],n[1],0);_e(l,l);const c=o.translation[0]*e.pan;if(c!==0){const _=ae(ke.get(),s,c);Cc(i.pan.matrix,i.pan.matrix,_),i.pan.enabled=!0}switch(a.mode){case"pan":{const _=-o.translation[1]*e.pan;if(_!==0){const v=ae(ke.get(),l,_);Cc(i.pan.matrix,i.pan.matrix,v),i.pan.enabled=!0}i.zoom=o.zoom*e.zoom;break}case"zoom":i.zoom=(-o.translation[1]+o.zoom)*e.zoom;break;default:a.mode}const h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(_u(i.rotate.matrix,i.rotate.matrix,p,this.view.renderCoordsHelper.worldUpAtPosition(r.eye,ke.get())),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=eb(this.view.renderCoordsHelper,r.center,r.eye),g=ye(m+f,wa.min,wa.max)-m;g&&(_u(i.rotate.matrix,i.rotate.matrix,g,s),i.rotate.enabled=!0)}_calculateControlTransformationGlobal(e,r,i){const{eye:s,viewRight:n}=r,o=this._transformation,a=this.view.navigation.gamepad,l=st(ke.get(),n,s);_e(l,l),el(l,l),bgt(this.startCamera,r,o,e,this.view.camera.heading,this._headingStart,this.view.camera.tilt,i,a),this._tmpCamera.copyFrom(this.currentCamera),this._applyPan(zb.pan,this._tmpCamera);const c=this.view.pointsOfInterest.centerOnSurfaceFrequent.estimatedSurfaceAltitude,h=o.translation[2]*e.ascend;i.ascend=h;const p=-o.heading*e.rotate;p!==0&&(_u(i.rotate.matrix,i.rotate.matrix,p,this._tmpCamera.eye),i.rotate.enabled=!0);const f=o.tilt*e.rotate,m=this._clampTiltDeltaGlobalToValidRange(f,r.ray,c);m!==0&&(_u(i.rotate.matrix,i.rotate.matrix,m,this._tmpCamera.viewRight),i.rotate.enabled=!0),i.zoom+=o.zoom*e.zoom}_clampTiltDeltaGlobalToValidRange(e,r,i){const s=Ir(this.view.spatialReference),n=r5(wa.min,r.origin,i,s);let o=0,a=0;const l=ke.get();if(this.view.renderCoordsHelper.intersectManifold(r,i,l)){const c=eb(this.view.renderCoordsHelper,l,r.origin);o=r5(c,r.origin,i,s),a=r5(wa.max,r.origin,i,s)}else{wO(YV(JV,i+s.radius),r,l);const c=Math.PI+XV(r.direction,l);o=ide(c,r.origin,i,s),a=ide(wa.max,r.origin,i,s)}return ye(o+e,n,a)-o}_getPointAbsoluteSurfaceElevation(e,r,i){const{renderCoordsHelper:s}=this.view,n=s.getAltitude(e),o=r+Math.abs(n-r);return s.setAltitude(i,o,e),o}_clampedDistanceToSurface(e,r){const{renderCoordsHelper:i}=this.view,{camera:s}=this.view.state,{direction:n}=Qgt(this.view,r,0,bIe,Uyt),o=i.intersectManifoldClosestSilhouette(Eh(r,n),e,ke.get()),a=_i(r,o),l=i.intersectManifoldClosestSilhouette(Eh(r,F0(ke.get(),r,s.center)),e,ke.get()),c=_i(r,l);return Math.min(a,c)}_computeHeadingRotateRadius(e){const{renderCoordsHelper:r,state:i}=this.view,{camera:s,isGlobal:n}=i,o=r.intersectManifoldClosestSilhouette(s.ray,this._filteredSurfaceElevation,ke.get());if(n){const a=pe(ke.get(),e,o),l=Oe(a);ae(a,a,1/l);const c=_e(ke.get(),e),h=oo(de(c,a));return l*Math.sin(Math.min(Dyt,h))}{const a=oe(ke.get(),e);return r.setAltitude(a,this._filteredSurfaceElevation),_i(o,a)}}_minimumAscendVelocity(){return this.view.state.constraints.collision.enabled?0:Nyt}_computeVelocities(e){const r=this._filteredSurfaceElevation,i=r+Ir(this.view.spatialReference).radius,{camera:s,isGlobal:n}=this.view.state,o=ke.get(),a=this._getPointAbsoluteSurfaceElevation(s.eye,r,o),l=this._clampedDistanceToSurface(r,o),c=s.width/2,h=xde*s.width,p=xde*s.width,f=l*Math.tan(.5*s.fovX)/c,m=f/i,g=f/this._computeHeadingRotateRadius(o),_=a-r;return{pan:(n?m:f)*h*e,ascend:Math.max(this._minimumAscendVelocity()*e,2**(h*e/c)*_-_),zoom:2**(h*e/c)*l-l,rotate:ye(g*p,Fyt,kyt)*e}}_applyDisabledMovementTypes(e){this.disableMovements==null||this.disableMovements.mode!==void 0&&this.view.state.viewingMode!==this.disableMovements.mode||(e.zoom=this.disableMovements.zoom?0:e.zoom,e.ascend=this.disableMovements.ascend?0:e.ascend,e.pan.enabled=!this.disableMovements.pan,this.disableMovements.pan&&jd(e.pan.matrix),e.rotate.enabled=!this.disableMovements.rotate,this.disableMovements.rotate&&jd(e.rotate.matrix))}static activatesFor(e,r){const i=bde(r,e.navigation.gamepad,Lyt);return!(r.action==="end"||NB(i))}};u([d({constructOnly:!0})],Xx.prototype,"gamepadDevice",void 0),u([d({constructOnly:!0})],Xx.prototype,"disableMovements",void 0),Xx=u([R("esri.views.3d.state.controllers.GamepadKeyboardController")],Xx);const Lyt={translation:[0,0,0],heading:0,tilt:0,zoom:0},bIe=80,Dyt=zt(bIe),xde=.75,Nyt=5,Fyt=zt(30),kyt=zt(80),zb={zoom:0,ascend:0,pan:{enabled:!1,matrix:xe()},rotate:{enabled:!1,matrix:xe()}},ql=C(),bR=C(),Uyt=xre();function Vyt(t){t.zoom=0,t.ascend=0,t.pan.enabled=!1,jd(t.pan.matrix),t.rotate.enabled=!1,jd(t.rotate.matrix)}let zyt=class extends ua{constructor(e){super(!0),this._view=e,this._watchHandles=new li,this._handle=this.registerIncoming("gamepad",r=>this._handleEventGamepad(r)),this._handle.pause()}onInstall(e){super.onInstall(e),this._watchHandles.add([Q(()=>this._view.navigation.gamepad.enabled,r=>{r?this._handle.resume():(this._handle.pause(),this._cameraControllerGamepad&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null))},xt),Q(()=>this._view.navigation.gamepad.device,r=>{this._cameraControllerGamepad&&r&&this._cameraControllerGamepad.gamepadDevice!==r&&(this._cameraControllerGamepad.finishController(),this._cameraControllerGamepad=null)})])}onUninstall(){this._watchHandles.removeAll(),super.onUninstall()}_handleEventGamepad(e){const r=this._view.navigation.gamepad.device;if(r&&e.data.device!==r)return;const i=this._cameraControllerGamepad&&this._cameraControllerGamepad.active;if(i||Xx.activatesFor(this._view,e.data)){if(!i){const s=new Xx({view:this._view,gamepadDevice:e.data.device});this._view.state.switchCameraController(s)&&(this._cameraControllerGamepad=s)}this._cameraControllerGamepad&&this._cameraControllerGamepad.active&&this._cameraControllerGamepad.gamepadDevice===e.data.device&&this._cameraControllerGamepad.handleEventGamepad(e.data)}}};var eu;(function(t){t[t.LEFT=0]="LEFT",t[t.RIGHT=1]="RIGHT",t[t.FORWARD=2]="FORWARD",t[t.BACKWARD=3]="BACKWARD",t[t.UP=4]="UP",t[t.DOWN=5]="DOWN",t[t.HEADINGLEFT=6]="HEADINGLEFT",t[t.HEADINGRIGHT=7]="HEADINGRIGHT",t[t.TILTUP=8]="TILTUP",t[t.TILTDOWN=9]="TILTDOWN",t[t.ZOOMIN=10]="ZOOMIN",t[t.ZOOMOUT=11]="ZOOMOUT"})(eu||(eu={}));let Byt=class extends ua{constructor(e,r){super(!0),this._view=e,this._disableMovements={pan:!0,zoom:!1,ascend:!0,rotate:!1,mode:Ue.Local},this._keyToNumber={[r.left]:eu.LEFT,[r.right]:eu.RIGHT,[r.forward]:eu.FORWARD,[r.backward]:eu.BACKWARD,[r.up]:eu.UP,[r.down]:eu.DOWN,[r.headingLeft]:eu.HEADINGLEFT,[r.headingRight]:eu.HEADINGRIGHT,[r.tiltUp]:eu.TILTUP,[r.tiltDown]:eu.TILTDOWN,[r.zoomIn]:eu.ZOOMIN,[r.zoomOut]:eu.ZOOMOUT},this.registerIncoming("key-down",null,i=>this._handleKeyDown(i)),this.registerIncoming("key-up",null,i=>this._handleKeyUp(i)),this.registerIncoming("blur",null,()=>this._handleBlur())}_handleKeyDown(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&(this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active||(this._cameraControllerKeyboard=new Xx({view:this._view,disableMovements:this._disableMovements}),this._view.state.switchCameraController(this._cameraControllerKeyboard)),this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.activateDirection(r),e.stopPropagation()))}_handleBlur(){this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.finishController(),this._cameraControllerKeyboard=null)}_handleKeyUp(e){if(e.data.native.ctrlKey||e.data.native.metaKey)return;const r=this._keyToNumber[e.data.key];r!=null&&this._cameraControllerKeyboard&&this._cameraControllerKeyboard.active&&(this._cameraControllerKeyboard.deactivateDirection(r),e.stopPropagation())}},Gyt=class extends ua{constructor(e,r){super(!0),this._view=e,this.registerIncoming("mouse-wheel",r,i=>this._handleMouseWheel(i))}_handleMouseWheel(e){if(!this._view.navigation.mouseWheelZoomEnabled)return;const r=e.data;this._cameraController&&this._cameraController.active||(this._cameraController=this._view.state.isGlobal?new IU({view:this._view,mode:"interaction"}):new PU({view:this._view,mode:"interaction"}),this._view.state.switchCameraController(this._cameraController)),this._cameraController.zoomStep(-1/60*r.deltaY,cs(r.x,r.y)),e.preventDefault(),e.stopPropagation()}},kU=class{constructor(e){this._gain=e}reset(e){this._value=e}set gain(e){this._gain=e}get value(){return this._value===void 0?0:this._value}update(e){this._value===void 0?this._value=e:this._value=this._gain*e+(1-this._gain)*this._value}},HT=class extends _P{constructor(){super(...arguments),this._beginCamera=new ft,this._elapsedTimeSec=0,this.constraintOptions={selection:Xi.ALL,interactionType:Kt.PAN,interactionFactor:0,interactionStartCamera:new ft,interactionDirection:null,tiltMode:ko.TUMBLE}}initialize(){this.constraintOptions.interactionType=this.interactionType,this.viewAnimation=new OA}get steppingFinished(){return this.momentum.isFinished(this._elapsedTimeSec)}onControllerStart(e){this._beginCamera.copyFrom(e),this.constraintOptions.interactionStartCamera=this._beginCamera,super.onControllerStart(e)}stepController(e,r){r.copyViewFrom(this._beginCamera),this._elapsedTimeSec+=e,this.momentumStep(this._elapsedTimeSec,r),rn(this.view,r,this.constraintOptions)}};HT=u([R("esri.views.3d.state.controllers.momentum.MomentumController")],HT);let cI=class extends HT{constructor(e){super(e),this.interactionType=Kt.PAN,this._tmpPan=C()}momentumStep(e,r){const i=this.momentum.value(e);ae(this._tmpPan,this.momentum.direction,i),r.eye=pe(Tde,r.eye,this._tmpPan),r.center=pe(Tde,r.center,this._tmpPan),this.constraintOptions.interactionDirection=this._tmpPan}};u([d({constructOnly:!0})],cI.prototype,"momentum",void 0),cI=u([R("esri.views.3d.state.controllers.momentum.PanPlanarMomentumController")],cI);const Tde=C(),jyt=C(),rN=C();let s5=class extends HT{constructor(e){super(e),this.interactionType=Kt.PAN}momentumStep(e,r){const i=this.momentum.value1(e),s=this.momentum.value2(e);oe(rN,r.eye),_e(rN,rN),st(this.momentum.axis2,rN,this.momentum.axis1),qMe(r,jyt,this.momentum.axis1,i,this.momentum.axis2,s)}};u([d({constructOnly:!0})],s5.prototype,"momentum",void 0),s5=u([R("esri.views.3d.state.controllers.momentum.PanSphericalMomentumController")],s5);let Lx=class extends HT{set center(e){this._set("center",$i(e))}set axis(e){this._set("axis",$i(e))}constructor(e){super(e),this.interactionType=Kt.TUMBLE}momentumStep(e,r){const i=this.momentum.value(e);tb(r,this.center,vP(this.axis,i))}};u([d({constructOnly:!0})],Lx.prototype,"momentum",void 0),u([d({constructOnly:!0})],Lx.prototype,"center",null),u([d({constructOnly:!0})],Lx.prototype,"axis",null),Lx=u([R("esri.views.3d.state.controllers.momentum.MomentumController")],Lx);let aC=class extends HT{set zoomCenter(e){this._set("zoomCenter",$i(e))}constructor(e){super(e),this.interactionType=Kt.ZOOM,this.constraintOptions.interactionDirection=C()}momentumStep(e,r){const{interactionDirection:i}=this.constraintOptions;if(!i)return;oe(i,r.eye);const s=this.momentum.valueDelta(0,e);_re(r,this.zoomCenter,s,this.view.state.constraints.minimumPoiDistance),F0(i,r.eye,i)}};u([d({constructOnly:!0})],aC.prototype,"momentum",void 0),u([d({constructOnly:!0})],aC.prototype,"zoomCenter",null),aC=u([R("esri.views.3d.state.controllers.momentum.ZoomPlanarMomentumController")],aC);let ax=class extends HT{set screenCenter(e){this._set("screenCenter",cs(e[0],e[1]))}set sceneCenter(e){this._set("sceneCenter",$i(e))}constructor(e){super(e),this.interactionType=Kt.ZOOM,this.radius=0,this._tmpSceneCenter=C(),this._tmpZoomAxisAngle=x8(),this._sphere=js()}initialize(){this._sphere[3]=this.radius}momentumStep(e,r){const i=this.momentum.valueDelta(0,e);VMe(this._sphere,r,i),this.constraintOptions.interactionType=Kt.ZOOM,rn(this.view,r,this.constraintOptions),bP(this._sphere,r,this.screenCenter,this._tmpSceneCenter),mre(this.sceneCenter,this._tmpSceneCenter,this._tmpZoomAxisAngle),tb(r,this._sphere,this._tmpZoomAxisAngle),this.constraintOptions.interactionType=Kt.PAN}};u([d({constructOnly:!0})],ax.prototype,"momentum",void 0),u([d({constructOnly:!0})],ax.prototype,"screenCenter",null),u([d({constructOnly:!0})],ax.prototype,"sceneCenter",null),u([d({constructOnly:!0})],ax.prototype,"radius",void 0),ax=u([R("esri.views.3d.state.controllers.momentum.ZoomSphericalMomentumController")],ax);let of=class{constructor(e){this._gain=e,this.lastValue=void 0,this.filteredDelta=void 0}update(e){if(this.hasLastValue()){const r=this.computeDelta(e);this._updateDelta(r)}this.lastValue=e}reset(){this.lastValue=void 0,this.filteredDelta=void 0}hasLastValue(){return this.lastValue!==void 0}hasFilteredDelta(){return this.filteredDelta!==void 0}computeDelta(e){return this.lastValue===void 0?NaN:e-this.lastValue}_updateDelta(e){this.filteredDelta!==void 0?this.filteredDelta=(1-this._gain)*this.filteredDelta+this._gain*e:this.filteredDelta=e}},A8=class{constructor(e,r,i){this._initialVelocity=e,this._stopVelocity=r,this._friction=i,this._duration=Math.abs(Math.log(Math.abs(this._initialVelocity)/this._stopVelocity)/Math.log(1-this._friction))}get duration(){return this._duration}isFinished(e){return e>this.duration}get friction(){return this._friction}value(e){return this.valueFromInitialVelocity(this._initialVelocity,e)}valueDelta(e,r){const i=this.value(e);return this.value(e+r)-i}valueFromInitialVelocity(e,r){r=Math.min(r,this.duration);const i=1-this.friction;return e*(i**r-1)/Math.log(i)}},Hyt=class extends A8{constructor(e,r,i,s,n){super(e,r,i),this._sceneVelocity=s,this.direction=n}value(e){return super.valueFromInitialVelocity(this._sceneVelocity,e)}},wIe=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._time=new of(.6),this._screen=[new of(.4),new of(.4)],this._scene=[new of(.6),new of(.6),new of(.6)],this._tmpDirection=C()}add(e,r,i){if(this.enabled){if(this._time.hasLastValue()&&this._time.computeDelta(i)<.015)return;this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._scene[0].update(r[0]),this._scene[1].update(r[1]),this._scene[2].update(r[2]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._scene[0].reset(),this._scene[1].reset(),this._scene[2].reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta()||!this._time.hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?0:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=s==null||i==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){ie(this._tmpDirection,this._scene[0].filteredDelta??0,this._scene[1].filteredDelta??0,this._scene[2].filteredDelta??0);const s=Oe(this._tmpDirection);s>0&&ae(this._tmpDirection,this._tmpDirection,1/s);const n=this._time.filteredDelta;return new Hyt(e,r,i,n==null?0:s/n,this._tmpDirection)}},Sde=class{constructor(e){this._gain=e}update(e){this.filteredValue!==void 0?this.filteredValue=(1-this._gain)*this.filteredValue+this._gain*e:this.filteredValue=e}reset(){this.filteredValue=void 0}get hasFilteredValue(){return this.filteredValue!==void 0}};const Ede=1e-5;let qyt=class extends A8{constructor(e,r,i,s,n,o=0,a){super(e,r,i),this._angularVelocity1=s,this.axis1=n,this.angularVelocity2=o,this.axis2=a}value1(e){return super.valueFromInitialVelocity(this._angularVelocity1,e)}value2(e){return super.valueFromInitialVelocity(this.angularVelocity2,e)}},Wyt=class{constructor(e=300,r=12,i=.84){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this.enabled=!0,this._tmpAxis1=C(),this._tmpAxis2=C(),this._tmpAngles=Pe(),this._time=new of(.3),this._screen=[new of(.4),new of(.4)],this._angle1=new Sde(.6),this._angle2=new Sde(.6),this._axis1=C(),this._axis2=C(),this._lastScene=C()}addMomentumDirectRotation(e,r,i,s,n,o){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;let a=jMe(this._lastScene,r,this._tmpAxis2,s,n,o);this._angle2.update(0),Xa(this._tmpAxis2)<Ede?a=0:_e(this._axis1,this._tmpAxis2),this._angle1.update(a),oe(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}addMomentumPreserveHeading(e,r,i,s,n,o,a){if(this.enabled){if(this._time.hasLastValue()){if(this._time.computeDelta(i)<.01)return;HMe(this._lastScene,r,this._tmpAxis2,this._tmpAxis1,this._tmpAngles,s,n,o,a,!1),Xa(this._tmpAxis2)<Ede?(this._angle1.update(0),this._angle2.update(0)):(this._angle1.update(this._tmpAngles[1]),this._angle2.update(this._tmpAngles[0]),_e(this._axis1,this._tmpAxis1),_e(this._axis2,this._tmpAxis2)),oe(this._lastScene,r)}this._screen[0].update(e[0]),this._screen[1].update(e[1]),this._time.update(i)}}reset(){this._screen[0].reset(),this._screen[1].reset(),this._angle1.reset(),this._angle2.reset(),this._time.reset()}evaluateMomentum(){if(!this.enabled||!this._screen[0].hasFilteredDelta())return null;const e=this._screen[0].filteredDelta,r=this._screen[1].filteredDelta,i=e==null||r==null?null:Math.sqrt(e*e+r*r),s=this._time.filteredDelta,n=i==null||s==null?0:i/s;return Math.abs(n)<this._minimumInitialVelocity?null:this.createMomentum(n,this._stopVelocity,this._friction)}createMomentum(e,r,i){const s=this._time.filteredDelta,n=this._angle1.filteredValue,o=this._angle2.filteredValue,a=s==null||o==null?0:o/s;return new qyt(e,r,i,s==null||n==null?0:n/s,this._axis1,a,this._axis2)}},xIe=class{constructor(e=2.5,r=.01,i=.95,s=12){this._minimumInitialVelocity=e,this._stopVelocity=r,this._friction=i,this._maxVelocity=s,this.enabled=!0,this.value=new of(.8),this.time=new of(.3)}add(e,r){if(this.enabled&&r!=null){if(this.time.hasLastValue()){if(this.time.computeDelta(r)<.01)return;if(this.value.hasFilteredDelta()){const i=this.value.computeDelta(e);this.value.filteredDelta*i<0&&this.value.reset()}}this.time.update(r),this.value.update(e)}}reset(){this.value.reset(),this.time.reset()}evaluateMomentum(){if(!this.enabled||!this.value.hasFilteredDelta()||!this.time.hasFilteredDelta())return null;let e=this.value.filteredDelta/this.time.filteredDelta;return e=ye(e,-this._maxVelocity,this._maxVelocity),Math.abs(e)<this._minimumInitialVelocity?null:this.createMomentum(e,this._stopVelocity,this._friction)}createMomentum(e,r,i){return new A8(e,r,i)}},TIe=class extends xIe{constructor(e=3,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){const i=this.value.lastValue;if(i!=null){let s=e-i;for(;s>Math.PI;)s-=2*Math.PI;for(;s<-Math.PI;)s+=2*Math.PI;e=i+s}super.add(e,r)}},Zyt=class extends A8{constructor(e,r,i){super(e,r,i)}value(e){const r=super.value(e);return Math.exp(r)}valueDelta(e,r){const i=super.value(e),s=super.value(e+r)-i;return Math.exp(s)}},SIe=class extends xIe{constructor(e=2.5,r=.01,i=.95,s=12){super(e,r,i,s)}add(e,r){super.add(Math.log(e),r)}createMomentum(e,r,i){return new Zyt(e,r,i)}},vY=class extends Km{constructor(){super(...arguments),this._smoothRotation=new kU(.05),this._rotationAxis=C(),this._beginAngle=0,this._beginHeading=0,this._panningPlane=zr(),this._beginRadius=0,this._smoothScaling=new kU(.05),this._zoomCenterScreen=cs(),this._zoomMomentumEstimator=new SIe,this._rotationMomentumEstimator=new TIe,this._panSphericalMomentumEstimator=new Wyt,this._panPlanarMomentumEstimator=new wIe,this._adjustedSphere=js(),this._tmp3d=C(),this._tmpScreenPointArray=cs(),this._beginScreenPoint=cs(),this._beginScenePoint=C(),this._screenPickPoint=cs(),this._scenePickPoint=C(),this._mode=Po.Horizontal,this._sphere=js(),this._pointerCount=0,this._tmpInteractionDirection=C(),this._constraintOptions={selection:Xi.ALL,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:new ft,interactionDirection:null,tiltMode:ko.TUMBLE}}get _intersectionHelper(){return this.view.sceneIntersectionHelper}begin(e){if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panPlanarMomentumEstimator.enabled=r,this._panSphericalMomentumEstimator.enabled=r,this._beginHeading=-k1.normalize(zt(this.view.camera.heading)),this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._smoothRotation.reset(),qm(e.center,this._screenPickPoint),jn(this._beginScreenPoint,this._screenPickPoint);const i=Ir(this.view.spatialReference),s=BMe(this._intersectionHelper,this.startCamera,this._screenPickPoint,i,LA.Silhouette,this.view.map.ground.opacity===0?bS:{});s.scenePickPoint!=null&&(this._scenePickPoint=s.scenePickPoint,this._sphere=s.sphere,oe(this._beginScenePoint,this._scenePickPoint),this._mode=S8(this.startCamera,this._screenPickPoint,i),this._mode===Po.Vertical&&this._preparePlanarPanMode(e,s.hasGeometryIntersection),this._constraintOptions.interactionStartCamera?.copyFrom(this.startCamera))}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1;this._mode===Po.Horizontal?(r&&this._zoomSpherical(e),this._panningSpherical(e),r&&this._rotateSpherical(e)):(r&&this._zoomPlanar(e),this._panningPlanar(e),r&&this._rotatePlanar(e)),this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return this._mode===Po.Horizontal?new ax({view:this.view,momentum:r,screenCenter:this._zoomCenterScreen,sceneCenter:this._beginScenePoint,radius:this._sphere[3]}):new aC({view:this.view,momentum:r,zoomCenter:this._beginScenePoint});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Lx({view:this.view,momentum:i,center:this._sphere,axis:this._rotationAxis});if(this._mode===Po.Horizontal){const s=this._panSphericalMomentumEstimator.evaluateMomentum();if(s)return new s5({view:this.view,momentum:s})}else{const s=this._panPlanarMomentumEstimator.evaluateMomentum();if(s)return new cI({view:this.view,momentum:s})}return null}_preparePlanarPanMode(e,r){const i=el(this._tmp3d,this.startCamera.viewForward);x$(this._scenePickPoint,i,this._panningPlane);const s=cs(this._screenPickPoint[0],0),n=C(),o=Oe(this.startCamera.eye);this._adjustedSphere[3]=o<this._sphere[3]?o-100:this._sphere[3],bP(this._adjustedSphere,this.startCamera,s,n);const a=Lo();this.startCamera.projectToRenderScreen(n,a);const l=C(),c=C(),h=C();pe(l,this._scenePickPoint,this.currentCamera.eye);const p=Oe(l);_e(l,l);const f=kMe*Math.max(Math.abs(this.view.camera.position.z),UMe),m=this.view._stage.renderView.getMinimalDepthForArea(null,this._screenPickPoint[0],this._screenPickPoint[1],this.view.state.camera,T8);let g=m??f;g=r?Math.min(g,p):g,oe(h,ue(c,this.currentCamera.eye,ae(c,l,g))),this._panningPlane[3]=-de(this._panningPlane,h),this.startCamera.center=ue(c,this.startCamera.eye,ae(c,this.startCamera.viewForward,g));const _=qm(e.center,this._tmpScreenPointArray);dY(this._panningPlane,this.startCamera,_,this._beginScenePoint)}_zoomSpherical(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),VMe(this._sphere,this.currentCamera,this._smoothScaling.value),qm(e.center,this._zoomCenterScreen),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=nf(e.radius-this._beginRadius),rn(this.view,this.currentCamera,this._constraintOptions)}_panningSpherical(e){const r=qm(e.center,this._tmpScreenPointArray);bP(this._sphere,this.currentCamera,r,this._tmp3d),vre(this._beginScenePoint,de(this.currentCamera.up,this._beginScenePoint),this._sphere[3],this._beginHeading,this.view.camera.tilt,this.startCamera)?(ZMe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this._beginHeading,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumPreserveHeading(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere,this._beginHeading,this.view.camera.tilt)):(WMe(this._sphere,this.currentCamera,this._beginScenePoint,this._tmp3d,this.view.camera.tilt,!1),this._panSphericalMomentumEstimator.addMomentumDirectRotation(r,this._tmp3d,.001*e.timestamp,this.startCamera,this._sphere[3],this.view.camera.tilt)),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=nf(I0(this._screenPickPoint,r)),rn(this.view,this.currentCamera,this._constraintOptions)}_rotateSpherical(e){_e(this._rotationAxis,this._scenePickPoint),this.currentCamera.aboveGround||el(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value,i=r+hY(e.angle-r),s=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=s,this._smoothRotation.update(i);const n=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(n,.001*e.timestamp),tb(this.currentCamera,this._sphere,vP(this._rotationAxis,n)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=nf(e.radius*i),rn(this.view,this.currentCamera,this._constraintOptions)}_panningPlanar(e){const r=qm(e.center,this._tmpScreenPointArray);dY(this._panningPlane,this.currentCamera,r,this._tmp3d)&&(GMe(this.currentCamera,this._beginScenePoint,this._tmp3d),this._panPlanarMomentumEstimator.add(r,this._tmp3d,.001*e.timestamp),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=nf(I0(this._beginScreenPoint,r)),this._constraintOptions.interactionDirection=this.view.renderCoordsHelper.worldUpAtPosition(this.currentCamera.eye,this._tmpInteractionDirection),rn(this.view,this.currentCamera,this._constraintOptions),this._constraintOptions.interactionDirection=null)}_zoomPlanar(e){const r=this._beginRadius/e.radius,i=.001875*Math.min(Math.max(e.radius,40),120);this._smoothScaling.gain=i,this._smoothScaling.update(r),this._zoomMomentumEstimator.add(this._smoothScaling.value,.001*e.timestamp),_re(this.currentCamera,this._beginScenePoint,this._smoothScaling.value,this.view.state.constraints.minimumPoiDistance),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=nf(e.radius-this._beginRadius),rn(this.view,this.currentCamera,this._constraintOptions)}_rotatePlanar(e){oe(this._rotationAxis,this._beginScenePoint),this.currentCamera.aboveGround||el(this._rotationAxis,this._rotationAxis);const r=this._smoothRotation.value;let i=e.angle-r;i=hY(i);const s=r+i,n=.00125*Math.min(Math.max(e.radius,40),120);this._smoothRotation.gain=n,this._smoothRotation.update(s);const o=this._smoothRotation.value-this._beginAngle;this._rotationMomentumEstimator.add(o,.001*e.timestamp),tb(this.currentCamera,this._sphere,vP(this._rotationAxis,o)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=nf(e.radius*o),rn(this.view,this.currentCamera,this._constraintOptions)}};vY=u([R("esri.views.3d.state.controllers.global.PinchAndPanController")],vY);const Cde=Ee(0,0,1),Xyt={ELEVATION_THRESHOLD:3e4,ANGLE_THRESHOLD:16/180*Math.PI};let bY=class extends Km{constructor(){super(...arguments),this._rotationValueSmooth=new kU(.05),this._scalingValueSmooth=new kU(.05),this._planeHorizontal=zr(),this._planeVertical=zr(),this._rotationMomentumEstimator=new TIe,this._panMomentumEstimator=new wIe(300,12,.9),this._zoomMomentumEstimator=new SIe,this._beginRadius=0,this._beginCenter=C(),this._beginAngle=0,this._tmpPoints=[],this._panMode=Po.Horizontal,this._beginCenterScreen=cs(),this._tmpCentroid3d=C(),this._tmpCentroid2d=cs(),this._tmp2d=cs(),this._pointerCount=0,this._constraintOptions={selection:Xi.ALL,interactionType:Kt.NONE,interactionFactor:0,interactionStartCamera:new ft,interactionDirection:null,tiltMode:ko.TUMBLE}}begin(e){if(!this.active)return;const r=this.view.navigation.momentumEnabled;this._zoomMomentumEstimator.enabled=r,this._rotationMomentumEstimator.enabled=r,this._panMomentumEstimator.enabled=r,this._beginRadius=e.radius,this._pointerCount=e.pointers.size,this._beginAngle=e.angle,this._rotationValueSmooth.reset(),this._scalingValueSmooth.reset(),qm(e.center,this._beginCenterScreen),GOe(Cde,0,this._planeHorizontal);const i=C(),s=this._intersectionHelper.intersectScreenFreePointFallback(this._beginCenterScreen,i,this.view.map.ground.opacity===0?bS:{}),n=C();el(n,this.startCamera.viewForward);const o=C();oe(o,Cde);const a=de(n,o),l=Gd(a<0?-a:a);this._panMode=l>=Xyt.ANGLE_THRESHOLD?Po.Horizontal:Po.Vertical;const c=Math.min(kMe,1/Math.abs(de(o,this.startCamera.viewForward)))*Math.max(Math.abs(this.view.camera.position.z),UMe);RZ(this._planeHorizontal,this._planeHorizontal,i),this.startCamera.aboveGround||MZ(this._planeHorizontal,this._planeHorizontal);const h=C(),p=C(),f=C();pe(h,i,this.currentCamera.eye);const m=Oe(h);if(_e(h,h),this._panMode===Po.Vertical){ae(o,o,a),pe(this._planeVertical,n,o),_e(this._planeVertical,this._planeVertical),RZ(this._planeVertical,this._planeVertical,i);const g=this.view._stage.renderView.getMinimalDepthForArea(this.view.voxelWasm,this._beginCenterScreen[0],this._beginCenterScreen[1],this.view.state.camera,T8);let _=g??c;_=s?Math.min(_,m):_,oe(f,ue(p,this.currentCamera.eye,ae(p,h,_))),this._planeVertical[3]=-de(this._planeVertical,f),this._computePlanePoints(e.pointers,this._planeVertical,this.startCamera,this._tmpPoints),EB(this._tmpPoints,this._beginCenter)}else{const g=s?m:c;oe(f,ue(p,this.currentCamera.eye,ae(p,h,g))),this._planeHorizontal[3]=-de(this._planeHorizontal,f),this._computePlanePoints(e.pointers,this._planeHorizontal,this.startCamera,this._tmpPoints),EB(this._tmpPoints,this._beginCenter)}this._constraintOptions.interactionStartCamera?.copyFrom(this.startCamera)}update(e){if(!this.active)return;this.currentCamera.copyFrom(this.startCamera);const r=e.pointers.size>1,i=this._panMode===Po.Horizontal?this._planeHorizontal:this._planeVertical,s=this._beginCenter;if(r){const n=this._beginRadius/e.radius,o=.001875*Math.min(Math.max(e.radius,40),120);this._scalingValueSmooth.gain=o,this._scalingValueSmooth.update(n),_re(this.currentCamera,s,this._scalingValueSmooth.value,this.view.state.constraints.minimumPoiDistance),this._zoomMomentumEstimator.add(this._scalingValueSmooth.value,.001*e.timestamp),this._constraintOptions.interactionType=Kt.ZOOM,this._constraintOptions.interactionFactor=nf(Math.abs(e.radius-this._beginRadius)),rn(this.view,this.currentCamera,this._constraintOptions)}if(this._computePlanePoints(e.pointers,i,this.currentCamera,this._tmpPoints),EB(this._tmpPoints,this._tmpCentroid3d),qm(e.center,this._tmpCentroid2d),GMe(this.currentCamera,s,this._tmpCentroid3d),this._panMomentumEstimator.add(this._tmpCentroid2d,this._tmpCentroid3d,.001*e.timestamp),this._constraintOptions.interactionType=Kt.PAN,this._constraintOptions.interactionFactor=nf(I0(this._beginCenterScreen,this._tmpCentroid2d)),rn(this.view,this.currentCamera,this._constraintOptions),r){const n=this._planeHorizontal,o=s,a=this._rotationValueSmooth.value,l=a+hY(e.angle-a),c=.00125*Math.min(Math.max(e.radius,40),120);this._rotationValueSmooth.gain=c,this._rotationValueSmooth.update(l);const h=this._rotationValueSmooth.value-this._beginAngle;this._rotationMomentumEstimator.add(h,.001*e.timestamp),tb(this.currentCamera,o,vP(n,h)),this._constraintOptions.interactionType=Kt.TUMBLE,this._constraintOptions.interactionFactor=nf(Math.abs(e.radius*h)),rn(this.view,this.currentCamera,this._constraintOptions)}this.commitCamera()}end(e){e.pointers.size===this._pointerCount&&this.update(e),this.finishController();const r=this._zoomMomentumEstimator.evaluateMomentum();if(r)return new aC({view:this.view,momentum:r,zoomCenter:this._beginCenter});const i=this._rotationMomentumEstimator.evaluateMomentum();if(i)return new Lx({view:this.view,momentum:i,center:this._beginCenter,axis:this._planeHorizontal});const s=this._panMomentumEstimator.evaluateMomentum();return s?new cI({view:this.view,momentum:s}):null}_computePlanePoints(e,r,i,s){s.length=e.size;const n=this._tmp2d;let o=0;return e.forEach(a=>{n[0]=a.x,n[1]=a.y,s[o]===void 0&&(s[o]=C()),dY(r,i,n,s[o]),o+=1}),s}get _intersectionHelper(){return this.view.sceneIntersectionHelper}};bY=u([R("esri.views.3d.state.controllers.local.PinchAndPanController")],bY);let Ade=class extends ua{constructor(e,r,i){super(!0),this._view=e,this.pointerAction=r,this._lastEndTimestamp=0,this._lastTimestamp=0,this.registerIncoming("drag",i,s=>this._handleDrag(s))}_handleDrag(e){if(e.data.pointerType==="mouse"&&!wre(e.data,this.pointerAction))return;const r=e.timestamp-this._lastEndTimestamp,i=40,s=this._momentum&&this._momentum.active&&r<i;switch(e.data.action){case"start":case"update":if(s)break;this._controller&&this._controller.active?e.data.timestamp-this._lastTimestamp>2&&(this._controller.update(e.data),this._lastTimestamp=e.timestamp):this._startController(e);break;case"end":case"removed":this._endController(e,!0);break;case"added":this._endController(e,!1),this._startController(e)}e.stopPropagation()}_endController(e,r){if(this._controller&&this._controller.active){this._lastEndTimestamp=e.timestamp;const i=this._controller.end(e.data);r&&i&&(this._momentum=i,this._view.state.switchCameraController(this._momentum))}this._controller=null}_startController(e){this._controller=this._createController(),this._view.state.switchCameraController(this._controller),this._controller.begin(e.data),this._lastTimestamp=e.timestamp}_createController(){return this._view.state.isGlobal?new vY({view:this._view}):new bY({view:this._view})}},Yyt=class extends ua{constructor(e,r){super(!0),this.view=e,this.registerIncoming("pointer-down",r,()=>this.view.state.stopActiveCameraController())}},EIe=class extends ua{constructor(e,r){super(!0),this.key=e,this.registerIncoming("key-down",r,i=>this._handleKeyDown(i))}_handleKeyDown(e){e.data.key===this.key&&(this.activate(),e.stopPropagation())}},Jyt=class extends EIe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({heading:0}).catch(()=>{})}},Qyt=class extends EIe{constructor(e,r,i){super(r,i),this.view=e}activate(){this.view.goTo({tilt:0}).catch(()=>{})}},Kyt=class extends ua{constructor(e,r=!1){super(!0),this._view=e,this._invert=r,this.registerIncoming("vertical-two-finger-drag",i=>this._handleTwoFinger(i))}_handleTwoFinger(e){const r=this._invert?-1:1,i=cs(0,e.data.delta*r);switch(e.data.action){case"begin":this._cameraController?.end(),this._cameraController=new lI({view:this._view,pivot:lu.CENTER}),this._view.state.switchCameraController(this._cameraController),this._cameraController.begin(i);break;case"update":this._cameraController?.update(i);break;case"end":this._cameraController?.end(),this._cameraController=null}}};function Ode(t){const e=t.native;return e?{buttons:e.buttons.map(r=>r.pressed?r.value||1:0),axes:e.axes.map(r=>r0t(r,t.axisThreshold))}:{buttons:[],axes:[]}}function e0t(t,e){if(t.axes.length!==e.axes.length||t.buttons.length!==e.buttons.length)return!1;for(let r=0;r<t.axes.length;r++)if(t.axes[r]!==e.axes[r])return!1;for(let r=0;r<t.buttons.length;r++)if(t.buttons[r]!==e.buttons[r])return!1;return!0}function t0t(t){for(let e=0;e<t.axes.length;e++)if(t.axes[e]!==0)return!1;for(let e=0;e<t.buttons.length;e++)if(t.buttons[e]!==0)return!1;return!0}function r0t(t,e){const r=Math.abs(t);return r<e?0:Math.sign(t)*(r-e)/(1-e)}let i0t=class{constructor(e,r){this._element=e,this._input=r,this._hasEventListeners=!1,this._onConnectGamepad=n=>{this._connectGamepad(n.gamepad)},this._onDisconnectGamepad=n=>{const o=n.gamepad,a=o.index,l=this._inputDevices[a];l&&(this._emitGamepadEvent(o,Ode(l),!1),this._inputDevices.splice(a,1),this._latestUpdate.splice(a,1),this._input.gamepad.devices.remove(l),this.ensurePollingState())},this._frameTask=null,this._latestUpdate=new Array,this._inputDevices=new Array,this._callback=null;const i="getGamepads"in window.navigator,s=window.isSecureContext;this.supported=i&&s,this.supported&&(this._forEachGamepad(n=>this._connectGamepad(n)),window.addEventListener("gamepadconnected",this._onConnectGamepad),window.addEventListener("gamepaddisconnected",this._onDisconnectGamepad),this.ensurePollingState())}destroy(){this.hasEventListeners=!1,this.supported&&(window.removeEventListener("gamepadconnected",this._onConnectGamepad),window.removeEventListener("gamepaddisconnected",this._onDisconnectGamepad))}set hasEventListeners(e){this._hasEventListeners!==e&&(this._hasEventListeners=e,this.ensurePollingState())}get _eventsEnabled(){return this.supported&&this._inputDevices.length>0&&this._hasEventListeners}set onEvent(e){this._callback=e}_connectGamepad(e){const r=new $te(e);r.deviceType!=="unknown"&&(this._inputDevices[e.index]=r,this._input.gamepad.devices.add(r)),this.ensurePollingState()}ensurePollingState(){this._eventsEnabled?this._startPolling():this._stopPolling()}_startPolling(){this._frameTask==null&&(this._frameTask=QC({update:()=>this._readGamepadState()}))}_stopPolling(){this._frameTask!=null&&(this._frameTask.remove(),this._frameTask=null,this._latestUpdate=new Array)}_readGamepadState(){const e=document.hasFocus(),r=this._element.contains(document.activeElement),i=this._input.gamepad.enabledFocusMode==="document"&&!e||this._input.gamepad.enabledFocusMode==="view"&&!r;this._forEachGamepad(s=>{const n=this._inputDevices[s.index];if(!n)return;const o=this._latestUpdate[s.index],a=Ode(n),l=i||t0t(a);o&&(o.timestamp===s.timestamp||!o.active&&l||e0t(o.state,a))||this._emitGamepadEvent(s,a,!l)})}_forEachGamepad(e){const r=window.navigator.getGamepads();for(let i=0;i<r.length;i++){const s=r[i];this._validate(s)&&e(s)}}_emitGamepadEvent(e,r,i){const s=this._latestUpdate[e.index],n=s&&s.active;if(!n&&!i)return;const o=!n&&i?"start":n&&i?"update":"end";this._latestUpdate[e.index]={timestamp:e.timestamp,state:r,active:i},this._callback&&this._callback({device:this._inputDevices[e.index],state:r,action:o})}_validate(e){if(!e||!e.connected)return!1;for(let r=0;r<e.axes.length;r++)if(isNaN(e.axes[r]))return!1;return!0}};const Rde=le("edge"),s0t=le("chrome"),n0t=le("ff"),o0t=le("safari"),Mde="esri-view-surface",i2={touchNone:`${Mde}--touch-none`,touchPan:`${Mde}--touch-pan`};let CIe=class AIe{constructor(e,r){this._input=r,this._active={},this._callback=()=>{},this._activePointerCaptures=new Set,this._keyDownState=new Set,this._eventId=1,this._browserTouchPanningEnabled=!1,this._element=e,e.getAttribute("tabindex")||e.setAttribute("tabindex","0"),this._eventHandlers={"key-down":this._handleKey,"key-up":this._handleKey,"pointer-down":this._handlePointer,"pointer-move":this._handlePointerPreventDefault,"pointer-up":this._handlePointerPreventDefault,"pointer-enter":this._handlePointer,"pointer-leave":this._handlePointer,"pointer-cancel":this._handlePointer,"mouse-wheel":this._handleMouseWheel,"pointer-capture-lost":this._handlePointerCaptureLost},this._updateTouchAction(),this._element.addEventListener("keydown",this._preventAltKeyDefault),this._gamepadSource=new i0t(e,this._input),this._gamepadSource.onEvent=i=>this._callback("gamepad",i)}destroy(){this._callback=()=>{},this.activeEvents=null,this._activePointerCaptures.forEach(e=>{this._releasePointerCaptureSafe(e)}),this._gamepadSource=Re(this._gamepadSource),this._activePointerCaptures=null,this._removeTouchAction(),this._element.removeEventListener("keydown",this._preventAltKeyDefault)}get browserTouchPanningEnabled(){return this._browserTouchPanningEnabled}set browserTouchPanningEnabled(e){this._browserTouchPanningEnabled=e,this._updateTouchAction(),this._updateTouchEventHandling()}set onEventReceived(e){this._callback=e}set activeEvents(e){for(const r in this._active)if(!e||!e.has(r)){const i=this._active[r];this._element.removeEventListener(FB[r],i),delete this._active[r]}e&&e.forEach(r=>{if(!this._active[r]&&FB[r]){const i=(this._eventHandlers[r]||this._handleDefault).bind(this,r);this._element.addEventListener(FB[r],i),this._active[r]=i}}),this._gamepadSource.hasEventListeners=e?.has("gamepad")??!1}setPointerCapture(e,r){r?this._setPointerCatpureSafe(e.pointerId):(this._releasePointerCaptureSafe(e.pointerId),this._activePointerCaptures.delete(e.pointerId))}_updateTouchAction(){this._element.classList.remove(this._browserTouchPanningEnabled?i2.touchNone:i2.touchPan),this._element.classList.add(this._browserTouchPanningEnabled?i2.touchPan:i2.touchNone)}_updateTouchEventHandling(){this._browserTouchPanningEnabled?this._element.addEventListener("touchmove",this._preventMultiTouchPanning):this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_removeTouchAction(){this._element.classList.remove(i2.touchNone),this._element.classList.remove(i2.touchPan),this._element.removeEventListener("touchmove",this._preventMultiTouchPanning)}_setPointerCatpureSafe(e){try{this._element.setPointerCapture(e),this._activePointerCaptures.add(e)}catch{}}_releasePointerCaptureSafe(e){try{if(this._element.hasPointerCapture&&!this._element.hasPointerCapture(e))return;this._element.releasePointerCapture(e)}catch{}}_updateNormalizedPointerLikeEvent(e,r){const i=AAe(this._element,e);return AIe.test.disableSubpixelCoordinates&&(i.x=Math.round(i.x),i.y=Math.round(i.y)),r.x=i.x,r.y=i.y,r}_handleKey(e,r){const i=Irt(r);i&&e==="key-up"&&this._keyDownState.delete(i);const s={native:r,key:i,repeat:!!i&&this._keyDownState.has(i)};i&&e==="key-down"&&this._keyDownState.add(s.key),this._callback(e,s)}_handlePointer(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});this._callback(e,i)}_handlePointerPreventDefault(e,r){const i=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,pointerType:r.pointerType,button:r.button,buttons:r.buttons,eventId:this._eventId++});r.preventDefault(),this._callback(e,i)}_handleMouseWheel(e,r){let i=r.deltaY;switch(r.deltaMode){case 0:Rde&&(i=i/document.documentElement.clientHeight*600);break;case 1:i*=30;break;case 2:i*=900}Rde?i*=.7:s0t||o0t?i*=.6:n0t&&(i*=1.375);const s=100,n=Math.abs(i);n>s&&(i=i/n*200/(1+Math.exp(-.02*(n-s))));const o=this._updateNormalizedPointerLikeEvent(r,{native:r,x:0,y:0,deltaY:i});this._callback(e,o)}_handlePointerCaptureLost(e,r){this._activePointerCaptures.delete(r.pointerId),this._handleDefault(e,r)}_handleDefault(e,r){const i={native:r};r.preventDefault(),this._callback(e,i)}_preventAltKeyDefault(e){e.key==="Alt"&&e.preventDefault()}_preventMultiTouchPanning(e){e.touches.length>1&&e.preventDefault()}};CIe.test={disableSubpixelCoordinates:!1};const FB={"key-down":"keydown","key-up":"keyup","pointer-down":"pointerdown","pointer-up":"pointerup","pointer-move":"pointermove","mouse-wheel":"wheel","pointer-capture-got":"gotpointercapture","pointer-capture-lost":"lostpointercapture","context-menu":"contextmenu","pointer-enter":"pointerenter","pointer-leave":"pointerleave","pointer-cancel":"pointercancel",focus:"focus",blur:"blur"};let a0t=class extends ua{constructor(){super(!0),this.registerIncoming("context-menu",e=>{e.data.native.preventDefault()})}};function OIe(t,e){return Math.abs(e.x-t.x)+Math.abs(e.y-t.y)}function l0t(t,e){const r=e.x-t.x,i=e.y-t.y;return Math.sqrt(r*r+i*i)}function c0t(t,e){if(e?(e.radius=0,e.center.x=0,e.center.y=0):e={radius:0,center:xh()},t.length===0)return e;if(t.length===1)return e.center.x=t[0].x,e.center.y=t[0].y,e;if(t.length===2){const[T,S]=t,[O,A]=[S.x-T.x,S.y-T.y];return e.radius=Math.sqrt(O*O+A*A)/2,e.center.x=(T.x+S.x)/2,e.center.y=(T.y+S.y)/2,e}let r=0,i=0;for(let T=0;T<t.length;T++)r+=t[T].x,i+=t[T].y;r/=t.length,i/=t.length;const s=t.map(T=>T.x-r),n=t.map(T=>T.y-i);let o=0,a=0,l=0,c=0,h=0,p=0,f=0;for(let T=0;T<s.length;T++){const S=s[T],O=n[T],A=S*S,M=O*O;o+=A,a+=M,l+=S*O,c+=A*S,h+=M*O,p+=S*M,f+=O*A}const m=.5*(c+p),g=.5*(h+f),_=o*a-l*l,v=(m*a-g*l)/_,b=(o*g-l*m)/_,x=xh(v+r,b+i);return{radius:Math.sqrt(v*v+b*b+(o+a)/t.length),center:x}}function uI(t){const{native:e}=t,{pointerId:r,button:i,pointerType:s}=e;return s==="mouse"?`${r}:${i}`:`${s}`}let u0t=class extends ua{constructor(e){super(!1),this._navigationTouch=e,this._startStateModifiers=new Set,this._activePointerMap=new Map,this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._drag=this.registerOutgoing("drag"),this.registerIncoming("pointer-drag",this._handlePointerDrag.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-capture-lost",this._handlePointerUpAndPointerLost.bind(this)),this.registerIncoming("pointer-cancel",this._handlePointerUpAndPointerLost.bind(this))}_createPayload(e,r,i,s){return{action:e,pointerType:this._pointerType,button:this._mouseButton,buttons:r.buttons,timestamp:s,pointers:h0t(this._activePointerMap),pointer:r,angle:i.angle,radius:i.radius,center:i.center}}_addPointer(e){const r=e.native.pointerId,i=iN(this._activePointerMap).angle,s={event:e,initialAngle:0,lastAngle:0};this._activePointerMap.set(r,s);const n=n5(s,RIe(this._activePointerMap));s.initialAngle=n,s.lastAngle=n,this._updatePointerAngles(i)}_updatePointer(e){if(e&&e.x==null&&e.y==null)return;const r=e.native.pointerId,i=this._activePointerMap.get(r);i?i.event=e:this._addPointer(e)}_removePointer(e){const r=iN(this._activePointerMap).angle;this._activePointerMap.delete(e),this._updatePointerAngles(r)}_updatePointerAngles(e){const r=iN(this._activePointerMap);this._activePointerMap.forEach(i=>{i.initialAngle=n5(i,r)-e,i.lastAngle=n5(i,r)-e})}_emitEvent(e,r,i){const s=iN(this._activePointerMap);this._drag.emit(this._createPayload(e,r,s,i),void 0,this._startStateModifiers)}_handlePointerUpAndPointerLost(e){const r=e.data.native.pointerId,i=e.timestamp;this._activePointerMap.get(r)&&(this._activePointerMap.size===1?(this._updatePointer(e.data),!this._isCurrentDragSuppressed&&this._emitEvent("end",e.data,i),this._isDragging=!1,this._isCurrentDragSuppressed=!1,this._removePointer(r)):(this._removePointer(r),this._emitEvent("removed",e.data,e.timestamp)))}_handlePointerDrag(e){const r=e.data,i=r.currentEvent,s=e.timestamp;switch(r.action){case"start":case"update":this._isDragging?this._activePointerMap.has(i.native.pointerId)?(this._updatePointer(i),!this._isCurrentDragSuppressed&&this._emitEvent("update",i,s)):(this._addPointer(i),this._emitEvent("added",i,s),this._isCurrentDragSuppressed=this._isSuppressed):(this._updatePointer(i),this._pointerType=e.data.startEvent.pointerType,this._mouseButton=e.data.startEvent.button,this._startStateModifiers=e.modifiers,this._isDragging=!0,this._isCurrentDragSuppressed=this._isSuppressed,!this._isCurrentDragSuppressed&&this._emitEvent("start",i,s))}}get _isSuppressed(){return!!this._navigationTouch&&!this._navigationTouch.browserTouchPanEnabled&&this._pointerType==="touch"&&this._activePointerMap.size===1}};function RIe(t){const e=[];return t.forEach(r=>{e.push(xh(r.event.x,r.event.y))}),c0t(e)}function iN(t){const e=RIe(t);let r=0;return t.forEach(i=>{let s=n5(i,e),n=s-i.lastAngle;for(;n>Math.PI;)n-=2*Math.PI;for(;n<-Math.PI;)n+=2*Math.PI;s=i.lastAngle+n,i.lastAngle=s;const o=s-i.initialAngle;r+=o}),r/=t.size||1,{angle:r,radius:e.radius,center:e.center}}function h0t(t){const e=new Map;return t.forEach((r,i)=>e.set(i,r.event)),e}function n5(t,e){const r=t.event,i=r.x-e.center.x,s=r.y-e.center.y;return Math.atan2(s,i)}var Ide;(function(t){t[t.Left=0]="Left",t[t.Middle=1]="Middle",t[t.Right=2]="Right",t[t.Back=3]="Back",t[t.Forward=4]="Forward",t[t.Undefined=-1]="Undefined"})(Ide||(Ide={}));const _1={maximumDoubleClickDelay:250,maximumDoubleClickDistance:10,maximumDoubleTouchDelay:350,maximumDoubleTouchDistance:35};let d0t=class extends ua{constructor(e=_1.maximumDoubleClickDelay,r=_1.maximumDoubleClickDistance,i=_1.maximumDoubleTouchDelay,s=_1.maximumDoubleTouchDistance,n=zP){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._click=this.registerOutgoing("click"),this._doubleClick=this.registerOutgoing("double-click"),this.registerIncoming("immediate-click",this._handleImmediateClick.bind(this)),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this))}onUninstall(){this._pointerState.forEach(e=>e.doubleClickTimer=Pi(e.doubleClickTimer))}get hasPendingInputs(){return ra(this._pointerState,e=>e.doubleClickTimer!=null)}_clearDoubleClickTimer(e,r){const i=this._pointerState.get(e);i&&(i.doubleClickTimer=Pi(i.doubleClickTimer),r&&this._click.emit(i.event.data,void 0,i.event.modifiers),this._pointerState.delete(e),this.refreshHasPendingInputs())}_doubleClickTimeoutExceeded(e){const r=this._pointerState.get(e);r.pointerDownCount===1&&this._click.emit(r.event.data,void 0,r.event.modifiers),r.doubleClickTimer=null,this._pointerState.delete(e),this.refreshHasPendingInputs()}_getPointerId(e){const{pointerId:r,pointerType:i,button:s}=e.native;return i==="mouse"?`${r}:${s}`:`${i}`}_handleImmediateClick(e){const r=e.data,{pointerType:i}=r.native,s=this._getPointerId(r);if(!this._pointerState.has(s))return void this._startClick(e);const n=this._pointerState.get(s),{data:o,modifiers:a}=n.event,l=i==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;OIe(o,r)>l?(this._clearDoubleClickTimer(s,!0),this._startClick(e)):(this._clearDoubleClickTimer(s,!1),n.pointerDownCount===2&&this._doubleClick.emit(o,void 0,a))}_handlePointerDown(e){const r=uI(e.data),i=this._pointerState.get(r);i&&(i.pointerDownCount+=1)}_startClick(e){const{data:r}=e,{native:{pointerType:i}}=r,s=uI(r),n=i==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay,o=this._clock.setTimeout(()=>this._doubleClickTimeoutExceeded(s),n),a=1;this._pointerState.set(s,{event:e,doubleClickTimer:o,pointerDownCount:a}),this.refreshHasPendingInputs()}},p0t=class extends ua{constructor(e=_1.maximumDoubleClickDelay,r=_1.maximumDoubleClickDistance,i=_1.maximumDoubleTouchDelay,s=_1.maximumDoubleTouchDistance,n=zP){super(!1),this._maximumDoubleClickDelay=e,this._maximumDoubleClickDistance=r,this._maximumDoubleTouchDelay=i,this._maximumDoubleTouchDistance=s,this._clock=n,this._pointerState=new Map,this._immediateDoubleClick=this.registerOutgoing("immediate-double-click"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",this._handlePointerUp.bind(this))}onUninstall(){this._pointerState.forEach(e=>{e.immediateDoubleClick&&e.immediateDoubleClick.timeoutHandle.remove()}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=uI(r);if(!this._pointerState.has(i)){const s={downButton:r.native.button,immediateDoubleClick:null};this._pointerState.set(i,s),this.startCapturingPointer(r.native)}}_handlePointerUp(e){const r=e.data,i=uI(r),s=this._pointerState.get(i);if(s&&s.downButton===r.native.button){const n=s.immediateDoubleClick;if(n){n.timeoutHandle.remove();const o=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDistance:this._maximumDoubleClickDistance;OIe(n,e.data)>o?this._startImmediateDoubleClick(e,s):(this._immediateDoubleClick.emit(e.data,void 0,n.modifiers),this._removeState(r))}else this._startImmediateDoubleClick(e,s)}}_startImmediateDoubleClick(e,r){const i=e.data.native.pointerType==="touch"?this._maximumDoubleTouchDelay:this._maximumDoubleClickDelay;r.immediateDoubleClick={x:e.data.x,y:e.data.y,modifiers:e.modifiers,timeoutHandle:this._clock.setTimeout(()=>this._removeState(e.data),i)}}_removeState(e){const r=uI(e);this._pointerState.delete(r),this.stopCapturingPointer(e.native),this.refreshHasPendingInputs()}};const wR={maximumClickDelay:300,movementUntilMouseDrag:1.5,movementUntilPenDrag:6,movementUntilTouchDrag:6,holdDelay:500};let f0t=class extends ua{constructor(e=wR.maximumClickDelay,r=wR.movementUntilMouseDrag,i=wR.movementUntilPenDrag,s=wR.movementUntilTouchDrag,n=wR.holdDelay,o=zP){super(!1),this._maximumClickDelay=e,this._movementUntilMouseDrag=r,this._movementUntilPenDrag=i,this._movementUntilTouchDrag=s,this._holdDelay=n,this._clock=o,this._pointerState=new Map,this._pointerDrag=this.registerOutgoing("pointer-drag"),this._immediateClick=this.registerOutgoing("immediate-click"),this._pointerHold=this.registerOutgoing("hold"),this.registerIncoming("pointer-down",this._handlePointerDown.bind(this)),this.registerIncoming("pointer-up",a=>{this._handlePointerLoss(a,"pointer-up")}),this.registerIncoming("pointer-capture-lost",a=>{this._handlePointerLoss(a,"pointer-capture-lost")}),this.registerIncoming("pointer-cancel",a=>{this._handlePointerLoss(a,"pointer-cancel")}),this._moveHandle=this.registerIncoming("pointer-move",this._handlePointerMove.bind(this)),this._moveHandle.pause()}onUninstall(){this._pointerState.forEach(e=>{e.holdTimeout=Pi(e.holdTimeout)}),super.onUninstall()}_handlePointerDown(e){const r=e.data,i=r.native.pointerId;let s=null;this._pointerState.size===0&&(s=this._clock.setTimeout(()=>{const o=this._pointerState.get(i);if(o){if(!o.isDragging){const a=o.previousEvent;this._pointerHold.emit(a,void 0,e.modifiers),o.holdEmitted=!0}o.holdTimeout=null}},this._holdDelay));const n={startEvent:r,previousEvent:r,startTimestamp:e.timestamp,isDragging:!1,downButton:r.native.button,holdTimeout:s,modifiers:new Set};this._pointerState.set(i,n),this.startCapturingPointer(r.native),this._moveHandle.resume(),this._pointerState.size>1&&this._startDragging(e)}_createPointerDragData(e,r,i){return{action:e,startEvent:r.startEvent,previousEvent:r.previousEvent,currentEvent:i}}_handlePointerMove(e){const r=e.data,i=r.native.pointerId,s=this._pointerState.get(i);s&&(s.isDragging?this._pointerDrag.emit(this._createPointerDragData("update",s,r),void 0,s.modifiers):l0t(r,s.startEvent)>this._getDragThreshold(r.native.pointerType)&&this._startDragging(e),s.previousEvent=r)}_getDragThreshold(e){switch(e){case"touch":return this._movementUntilTouchDrag;case"pen":return this._movementUntilPenDrag;default:return this._movementUntilMouseDrag}}_startDragging(e){const r=e.data,i=r.native.pointerId;this._pointerState.forEach(s=>{s.holdTimeout!=null&&(s.holdTimeout.remove(),s.holdTimeout=null),s.isDragging||(s.modifiers=e.modifiers,s.isDragging=!0,i===s.startEvent.native.pointerId?this._pointerDrag.emit(this._createPointerDragData("start",s,r)):this._pointerDrag.emit(this._createPointerDragData("start",s,s.previousEvent),e.timestamp))})}_handlePointerLoss(e,r){const i=e.data,s=i.native.pointerId,n=this._pointerState.get(s);n&&(n.holdTimeout!=null&&(n.holdTimeout.remove(),n.holdTimeout=null),n.isDragging?this._pointerDrag.emit(this._createPointerDragData("end",n,r==="pointer-up"?i:n.previousEvent),void 0,n.modifiers):r==="pointer-up"&&n.downButton===i.native.button&&e.timestamp-n.startTimestamp<=this._maximumClickDelay&&!n.holdEmitted&&this._immediateClick.emit(i),this._pointerState.delete(s),this.stopCapturingPointer(i.native),this._pointerState.size===0&&this._moveHandle.pause())}},m0t=class{constructor(e){this._callbacks=e,this._currentCount=0,this._callbacks.condition||(this._callbacks.condition=()=>!0)}handle(e){const r=e.data,i=r.pointers.size;switch(r.action){case"start":this._currentCount=i,this._emitStart(e);break;case"added":this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"update":this._emitUpdate(e);break;case"removed":this._startEvent&&this._emitEnd(this._previousEvent),this._currentCount=i,this._emitStart(e);break;case"end":this._emitEnd(e),this._currentCount=0}this._previousEvent=e}_emitStart(e){this._startEvent=e,this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.start(this._currentCount,e,this._startEvent)}_emitUpdate(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.update(this._currentCount,e,this._startEvent)}_emitEnd(e){this._callbacks.condition?.(this._currentCount,e)&&this._callbacks.end(this._currentCount,e,this._startEvent),this._startEvent=null}},g0t=class extends ua{constructor(e=20,r=40){super(!1),this._threshold=e,this._maxDelta=r,this._state="ready",this._emittedArtificalEnd2=!1,this._vertical=this.registerOutgoing("vertical-two-finger-drag"),this._artificalDrag=this.registerOutgoing("drag"),this._dragEventSeparator=new m0t({start:(i,s)=>this._observeStart(i,s),update:(i,s,n)=>this._observeUpdate(i,s,n),end:(i,s)=>this._observeEnd(s)}),this.registerIncoming("drag",i=>this._dragEventSeparator.handle(i))}get failed(){return this._state==="failed"}_observeStart(e,r){e===1&&this._emittedArtificalEnd2&&(this._emittedArtificalEnd2=!1,this._artificalDrag.emit({action:"start",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),r.stopPropagation()),this._state=e===2?"ready":"failed"}_observeUpdate(e,r,i){if(this._state!=="failed"&&e===2)return this._state==="active"?(this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"update"}),void r.stopPropagation()):void(this._checkMovementWithinLimits(r.data,i.data)?this._checkVerticalThresholdReached(r.data,i.data)&&(this._state="active",this._emittedArtificalEnd2=!0,this._thresholdReachedCenter=r.data.center,this._artificalDrag.emit({action:"end",button:r.data.button,buttons:r.data.buttons,pointerType:r.data.pointerType,timestamp:r.data.timestamp,pointers:r.data.pointers,pointer:r.data.pointer,angle:r.data.angle,radius:r.data.radius,center:r.data.center}),this._vertical.emit({delta:r.data.center.y-this._thresholdReachedCenter.y,action:"begin"}),r.stopPropagation()):this._state="failed")}_observeEnd(e){this._state==="active"&&(this._vertical.emit({delta:e.data.center.y-this._thresholdReachedCenter.y,action:"end"}),this._state="ready",e.stopPropagation())}_checkMovementWithinLimits(e,r){let i=-1/0,s=1/0,n=-1/0,o=1/0;for(const{x:_,y:v}of r.pointers.values())i=Math.max(i,_),s=Math.min(s,_),n=Math.max(n,v),o=Math.min(o,v);let a=-1/0,l=1/0,c=-1/0,h=1/0;for(const{x:_,y:v}of e.pointers.values())a=Math.max(a,_),l=Math.min(l,_),c=Math.max(c,v),h=Math.min(h,v);const p=i-s,f=n-o,m=a-l,g=c-h;return Math.abs(e.center.x-r.center.x)<this._threshold&&Math.abs(m-p)<=this._maxDelta&&Math.abs(g-f)<=this._maxDelta}_checkVerticalThresholdReached(e,r){let i=Math.abs(e.center.y-r.center.y);return e.pointers.forEach((s,n)=>{const o=r.pointers.get(n);i=Math.min(i,Math.abs(s.y-o.y))}),i>=this._threshold}},Up=class extends me{constructor(){super(...arguments),this._handles=new li}destroy(){this._handles=Re(this._handles),this.disconnect()}get primaryDragAction(){return this._get("primaryDragAction")}set primaryDragAction(e){e!=="pan"&&e!=="rotate"||e===this._get("primaryDragAction")||(this._set("primaryDragAction",e),this._updateMode())}get mode(){return this._get("mode")}set mode(e){e!=="default"&&e!=="pro"||e===this._get("mode")||(this._set("mode",e),this._updateMode())}get updating(){return!!this._inputManager?.updating}get latestPointerType(){return this._inputManager?.latestPointerType}get latestPointerLocation(){return this._inputManager?.latestPointerLocation}get multiTouchActive(){return this._inputManager?.multiTouchActive??!1}disconnect(){this.view.viewEvents.disconnect(),this._inputManager=Re(this._inputManager)}connect(){const e=this.view;this._source=new CIe(this.view.surface,e.input);const r=[new p0t,new f0t,new d0t,new u0t(this.view.navigation),new g0t],i=new Jh({eventSource:this._source,recognizers:r});this._inputManager=i,i.installHandlers("prevent-context-menu",[new a0t],fs.INTERNAL),this._modeDragPan=new Ade(e,"primary"),this._modeDragRotate=new DB(e,"secondary",lu.CENTER),this._modeDragZoom=new $yt(e,"tertiary");const s={lookAround:"b",pan:{left:"ArrowLeft",right:"ArrowRight",forward:"ArrowUp",backward:"ArrowDown",up:"u",down:"j",headingLeft:"a",headingRight:"d",tiltUp:"w",tiltDown:"s",zoomIn:"+",zoomOut:"-"},resetHeading:"n",resetTilt:"p"};i.installHandlers("navigation",[new Yyt(e),new Agt(e),new zyt(e),new Byt(e,s.pan),new Gyt(e),new Qyt(e,s.resetTilt),new Jyt(e,s.resetHeading),new DB(e,"primary",lu.EYE,[s.lookAround]),new DB(e,"secondary",lu.CENTER,[s.lookAround]),new Ade(e,"tertiary",[s.lookAround]),this._modeDragRotate,this._modeDragZoom,this._modeDragPan,new Kyt(e)],fs.INTERNAL),this.view.viewEvents.connect(i),this._updateMode(),this._handles.add(Q(()=>this.view.navigation?.browserTouchPanEnabled,n=>{this._source.browserTouchPanningEnabled=!n},xt))}_updateMode(){const e=this.mode,r=this.primaryDragAction,i=wY.get(e)?.get(r);i&&(this._modeDragPan&&(this._modeDragPan.pointerAction=i.pan),this._modeDragRotate&&(this._modeDragRotate.pointerAction=i.rotate),this._modeDragZoom&&(this._modeDragZoom.pointerAction=i.zoom))}get test(){return{inputManager:this._inputManager,modeDragPan:this._modeDragPan,modeDragRotate:this._modeDragRotate,modeDragZoom:this._modeDragZoom}}};u([d()],Up.prototype,"view",void 0),u([d({value:"pan"})],Up.prototype,"primaryDragAction",null),u([d({value:"default"})],Up.prototype,"mode",null),u([d({readOnly:!0})],Up.prototype,"updating",null),u([d()],Up.prototype,"latestPointerType",null),u([d()],Up.prototype,"latestPointerLocation",null),u([d()],Up.prototype,"multiTouchActive",null),u([d()],Up.prototype,"_inputManager",void 0),Up=u([R("esri.views.3d.input.SceneInputManager")],Up);const wY=new Map,kB=new Map,UB=new Map;kB.set("pan",{pan:"primary",rotate:"secondary",zoom:"tertiary"}),kB.set("rotate",{pan:"secondary",rotate:"primary",zoom:"tertiary"}),UB.set("pan",{pan:"primary",rotate:"tertiary",zoom:"secondary"}),UB.set("rotate",{pan:"tertiary",rotate:"primary",zoom:"secondary"}),wY.set("default",kB),wY.set("pro",UB);const y0t=Up;let Zs=class extends me{constructor(){super(...arguments),this.SCENEVIEW_HITTEST_RETURN_INTERSECTOR=!1,this.DECONFLICTOR_SHOW_VISIBLE=!1,this.DECONFLICTOR_SHOW_INVISIBLE=!1,this.DECONFLICTOR_SHOW_GRID=!1,this.LABELS_SHOW_BORDER=!1,this.TEXT_SHOW_BASELINE=!1,this.TEXT_SHOW_BORDER=!1,this.OVERLAY_DRAW_DEBUG_TEXTURE=!1,this.OVERLAY_SHOW_CENTER=!1,this.SHOW_POI=!1,this.TESTS_DISABLE_OPTIMIZATIONS=!1,this.TESTS_DISABLE_FAST_UPDATES=!1,this.DRAW_MESH_GEOMETRY_NORMALS=!1,this.FEATURE_TILE_FETCH_SHOW_TILES=!1,this.FEATURE_TILE_TREE_SHOW_TILES=!1,this.TERRAIN_TILE_TREE_SHOW_TILES=!1,this.I3S_TREE_SHOW_TILES=!1,this.I3S_SHOW_MODIFICATIONS=!1,this.LOD_INSTANCE_RENDERER_DISABLE_UPDATES=!1,this.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL=!1,this.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES=!1,this.LINE_WIREFRAMES=!1}};u([d()],Zs.prototype,"SCENEVIEW_HITTEST_RETURN_INTERSECTOR",void 0),u([d()],Zs.prototype,"DECONFLICTOR_SHOW_VISIBLE",void 0),u([d()],Zs.prototype,"DECONFLICTOR_SHOW_INVISIBLE",void 0),u([d()],Zs.prototype,"DECONFLICTOR_SHOW_GRID",void 0),u([d()],Zs.prototype,"LABELS_SHOW_BORDER",void 0),u([d()],Zs.prototype,"TEXT_SHOW_BASELINE",void 0),u([d()],Zs.prototype,"TEXT_SHOW_BORDER",void 0),u([d()],Zs.prototype,"OVERLAY_DRAW_DEBUG_TEXTURE",void 0),u([d()],Zs.prototype,"OVERLAY_SHOW_CENTER",void 0),u([d()],Zs.prototype,"SHOW_POI",void 0),u([d()],Zs.prototype,"TESTS_DISABLE_OPTIMIZATIONS",void 0),u([d()],Zs.prototype,"TESTS_DISABLE_FAST_UPDATES",void 0),u([d()],Zs.prototype,"DRAW_MESH_GEOMETRY_NORMALS",void 0),u([d()],Zs.prototype,"FEATURE_TILE_FETCH_SHOW_TILES",void 0),u([d()],Zs.prototype,"FEATURE_TILE_TREE_SHOW_TILES",void 0),u([d()],Zs.prototype,"TERRAIN_TILE_TREE_SHOW_TILES",void 0),u([d()],Zs.prototype,"I3S_TREE_SHOW_TILES",void 0),u([d()],Zs.prototype,"I3S_SHOW_MODIFICATIONS",void 0),u([d()],Zs.prototype,"LOD_INSTANCE_RENDERER_DISABLE_UPDATES",void 0),u([d()],Zs.prototype,"LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL",void 0),u([d()],Zs.prototype,"EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES",void 0),u([d()],Zs.prototype,"LINE_WIREFRAMES",void 0),Zs=u([R("esri.views.3d.support.DebugFlags")],Zs);const bi=new Zs;let ih,BC,xY=!1,TY=!1,SY=!1,EY=!1,hI=null;function _0t(t,e){if(!TY||!BC)return;MIe();const r=BC;let i=0;for(let s=0;s<t.accBinsNumX;s++)for(let n=0;n<t.accBinsNumY;n++){const o=t.accBins[s][t.accBinsNumY-1-n];i+=o.length;const a=s*t.accBinsSizeX,l=(s+1)*t.accBinsSizeX,c=n*t.accBinsSizeY,h=(n+1)*t.accBinsSizeY;r.fillText(o.length.toFixed(),a+5,c+15),IIe(a,l,c,h,"blue")}r.fillText("total totalShownLabels: "+i,70,40),r.fillText("total visible labels: "+e.size,70,50),r.fillText("total numTests: "+t.accNumTests,70,30)}function v0t(t){SY=bi.DECONFLICTOR_SHOW_VISIBLE,EY=bi.DECONFLICTOR_SHOW_INVISIBLE,xY=SY||EY,TY=bi.DECONFLICTOR_SHOW_GRID,hI=null,xY||TY?hI=()=>b0t(t):ih&&(ih.parentElement.removeChild(ih),ih=null)}function MIe(){hI&&(hI(),hI=null)}function b0t(t){ih==null&&(ih=document.createElement("canvas"),ih.setAttribute("id","debugCanvas2d"),t.surface.parentElement.style.position="relative",t.surface.parentElement.appendChild(ih));const{state:e}=t,{camera:r,pixelRatio:i}=e,{width:s,height:n}=r,o=s*i,a=n*i;ih.setAttribute("width",`${o}px`),ih.setAttribute("height",`${a}px`),ih.setAttribute("style",`position:absolute;left:0px;top:0px;display:block;pointer-events:none;width:${s}px;height:${n}px`),BC=ih.getContext("2d"),BC.clearRect(0,0,s,n),BC.font="12px Arial"}function IIe(t,e,r,i,s){MIe();const n=ih.height,o=BC;o.beginPath(),o.lineWidth=1,o.strokeStyle=s,o.moveTo(t,n-r),o.lineTo(e,n-r),o.stroke(),o.lineTo(e,n-i),o.stroke(),o.lineTo(e,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.lineTo(t,n-r),o.stroke(),o.closePath()}function w0t(t,e){xY&&(e&&SY||!e&&EY)&&IIe(t.aabr[0],t.aabr[2],t.aabr[1],t.aabr[3],e?"green":"red")}var Ca,Mo;(function(t){t[t.USER=1]="USER",t[t.SCALE_RANGE=2]="SCALE_RANGE",t[t.FILTER=4]="FILTER",t[t.DECONFLICTION=8]="DECONFLICTION",t[t.ALL_GRAPHIC=15]="ALL_GRAPHIC",t[t.ALL_LABEL=255]="ALL_LABEL"})(Ca||(Ca={})),function(t){t[t.GRAPHIC=1]="GRAPHIC",t[t.LABEL=16]="LABEL"}(Mo||(Mo={}));function PIe(t,e){return new NIe(t,kIe,e)}function x0t(t,e){const{curvatureDependent:r,scaleStart:i,scaleFallOffRange:s}=kIe;return new NIe(t,{curvatureDependent:{min:{curvature:r.min.curvature,tiltAngle:r.min.tiltAngle,scaleFallOffFactor:VB.curvatureDependent.min.scaleFallOffFactor},max:{curvature:r.max.curvature,tiltAngle:r.max.tiltAngle,scaleFallOffFactor:VB.curvatureDependent.max.scaleFallOffFactor}},scaleStart:i,scaleFallOffRange:s,minPixelSize:VB.minPixelSize},e)}function T0t(t){return Math.abs(t*t*t)}function $Ie(t,e,r){const i=r.parameters,s=r.paddingPixelsOverride;return xR.scale=Math.min(i.divisor/(e-i.offset),1),xR.factor=T0t(t),xR.minPixelSize=i.minPixelSize,xR.paddingPixels=s,xR}function LIe(t,e){return t===0?e.minPixelSize:e.minPixelSize*(1+2*e.paddingPixels/t)}function Rre(t,e){return Math.max(Et(t*e.scale,t,e.factor),LIe(t,e))}function S0t(t,e,r){const i=$Ie(t,e,r);return i.minPixelSize=0,i.paddingPixels=0,Rre(1,i)}function Pde(t,e,r,i){i.scale=S0t(t,e,r),i.factor=0,i.minPixelSize=r.parameters.minPixelSize,i.paddingPixels=r.paddingPixelsOverride}function DIe(t,e,r=[0,0]){const i=Math.min(Math.max(e.scale,LIe(t[1],e)/Math.max(1e-5,t[1])),1);return r[0]=t[0]*i,r[1]=t[1]*i,r}function E0t(t,e,r,i){return Rre(t,$Ie(e,r,i))}let NIe=class FIe{get paddingPixelsOverride(){return this._paddingPixelsOverride||this.parameters.paddingPixels}constructor(e,r,i,s=C0t(),n){this._viewingMode=e,this._description=r,this._ellipsoidRadius=i,this.parameters=s,this._paddingPixelsOverride=n,this._viewingMode===Ue.Local?(this._coverageCompensation=this._surfaceCoverageCompensationLocal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersLocal):(this._coverageCompensation=this._surfaceCoverageCompensationGlobal,this._calculateCurvatureDependentParameters=this._calculateCurvatureDependentParametersGlobal)}update(e){return(!this.parameters||this.parameters.camera.fovY!==e.fovY||this.parameters.camera.distance!==e.distance)&&(this._calculateParameters(e,this._ellipsoidRadius,this.parameters),!0)}overridePadding(e){return e!==this.paddingPixelsOverride?new FIe(this._viewingMode,this._description,this._ellipsoidRadius,this.parameters,e):this}_calculateParameters(e,r,i){const{scaleStart:s,scaleFallOffRange:n,minPixelSize:o}=this._description,{fovY:a,distance:l}=e,c=this._calculateCurvatureDependentParameters(e,r),h=this._coverageCompensation(e,r,c),{tiltAngle:p,scaleFallOffFactor:f}=c,m=Math.sin(p)*l,g=.5*Math.PI-p-a*(.5-s*h),_=m/Math.cos(g),v=g+a*n*h,b=(_-f*(m/Math.cos(v)))/(1-f);return i.camera.fovY=e.fovY,i.camera.distance=e.distance,i.offset=b,i.divisor=_-b,i.minPixelSize=o,i}_calculateCurvatureDependentParametersLocal(e,r,i=$de){return i.tiltAngle=this._description.curvatureDependent.min.tiltAngle,i.scaleFallOffFactor=this._description.curvatureDependent.min.scaleFallOffFactor,i}_calculateCurvatureDependentParametersGlobal(e,r,i=$de){const s=this._description.curvatureDependent,n=1+e.distance/r,o=Math.sqrt(n*n-1),[a,l]=[s.min.curvature,s.max.curvature],c=ye((o-a)/(l-a),0,1),[h,p]=[s.min,s.max];return i.tiltAngle=Et(h.tiltAngle,p.tiltAngle,c),i.scaleFallOffFactor=Et(h.scaleFallOffFactor,p.scaleFallOffFactor,c),i}_surfaceCoverageCompensationLocal(e,r,i){return(e.fovY-i.tiltAngle)/e.fovY}_surfaceCoverageCompensationGlobal(e,r,i){const s=r*r,n=i.tiltAngle+.5*Math.PI,{fovY:o,distance:a}=e,l=a*a+s-2*Math.cos(n)*a*r,c=Math.sqrt(l),h=Math.sqrt(l-s);return(Math.acos(h/c)-Math.asin(r/(c/Math.sin(n)))+.5*o)/o}};const kIe={curvatureDependent:{min:{curvature:zt(10),tiltAngle:zt(12),scaleFallOffFactor:.5},max:{curvature:zt(70),tiltAngle:zt(40),scaleFallOffFactor:.8}},scaleStart:.3,scaleFallOffRange:.65,minPixelSize:0},VB={curvatureDependent:{min:{scaleFallOffFactor:.7},max:{scaleFallOffFactor:.95}},minPixelSize:14};function C0t(){return{camera:{distance:0,fovY:0},divisor:0,offset:0,minPixelSize:0,paddingPixels:0}}const xR={scale:0,factor:0,minPixelSize:0,paddingPixels:0},$de={tiltAngle:0,scaleFallOffFactor:0};function A0t(t){return t instanceof Float32Array&&t.length>=16}function O0t(t){return Array.isArray(t)&&t.length>=16}function R0t(t){return A0t(t)||O0t(t)}function Mre(t){t.vertex.code.add(w`float screenSizePerspectiveMinSize(float size, vec4 factor) {
float nonZeroSize = 1.0 - step(size, 0.0);
return (
factor.z * (
1.0 +
nonZeroSize *
2.0 * factor.w / (
size + (1.0 - nonZeroSize)
)
)
);
}`),t.vertex.code.add(w`float screenSizePerspectiveViewAngleDependentFactor(float absCosAngle) {
return absCosAngle * absCosAngle * absCosAngle;
}`),t.vertex.code.add(w`vec4 screenSizePerspectiveScaleFactor(float absCosAngle, float distanceToCamera, vec4 params) {
return vec4(
min(params.x / (distanceToCamera - params.y), 1.0),
screenSizePerspectiveViewAngleDependentFactor(absCosAngle),
params.z,
params.w
);
}`),t.vertex.code.add(w`float applyScreenSizePerspectiveScaleFactorFloat(float size, vec4 factor) {
return max(mix(size * factor.x, size, factor.y), screenSizePerspectiveMinSize(size, factor));
}`),t.vertex.code.add(w`float screenSizePerspectiveScaleFloat(float size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorFloat(
size,
screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params)
);
}`),t.vertex.code.add(w`vec2 applyScreenSizePerspectiveScaleFactorVec2(vec2 size, vec4 factor) {
return mix(size * clamp(factor.x, screenSizePerspectiveMinSize(size.y, factor) / max(1e-5, size.y), 1.0), size, factor.y);
}`),t.vertex.code.add(w`vec2 screenSizePerspectiveScaleVec2(vec2 size, float absCosAngle, float distanceToCamera, vec4 params) {
return applyScreenSizePerspectiveScaleFactorVec2(size, screenSizePerspectiveScaleFactor(absCosAngle, distanceToCamera, params));
}`)}function M0t(t){t.uniforms.add(new cr("screenSizePerspective",e=>UIe(e.screenSizePerspective)))}function O8(t){t.uniforms.add(new cr("screenSizePerspectiveAlignment",e=>UIe(e.screenSizePerspectiveAlignment||e.screenSizePerspective)))}function UIe(t){return zi(I0t,t.parameters.divisor,t.parameters.offset,t.parameters.minPixelSize,t.paddingPixelsOverride)}const I0t=Qt();var Ji,Sd,dI,Os,$n;(function(t){t[t.INNER=0]="INNER",t[t.OUTER=1]="OUTER"})(Ji||(Ji={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.HAS_NORTH_POLE=1]="HAS_NORTH_POLE",t[t.HAS_SOUTH_POLE=2]="HAS_SOUTH_POLE",t[t.HAS_BOTH_POLES=3]="HAS_BOTH_POLES"}(Sd||(Sd={})),function(t){t[t.OFF=0]="OFF",t[t.ON=1]="ON"}(dI||(dI={})),function(t){t[t.Color=0]="Color",t[t.ColorNoRasterImage=1]="ColorNoRasterImage",t[t.Highlight=2]="Highlight",t[t.Water=3]="Water",t[t.Occluded=4]="Occluded",t[t.ObjectAndLayerIdColor=5]="ObjectAndLayerIdColor"}(Os||(Os={})),function(t){t[t.FADING=0]="FADING",t[t.IMMEDIATE=1]="IMMEDIATE",t[t.UNFADED=2]="UNFADED"}($n||($n={}));let P0t=class{constructor(e,r){this.vec3=e,this.id=r}};function UU(t,e,r,i){return new P0t(Ee(t,e,r),i)}var Ol;(function(t){t[t.None=0]="None",t[t.ColorAndWater=1]="ColorAndWater",t[t.Highlight=2]="Highlight",t[t.Occluded=3]="Occluded",t[t.ObjectAndLayerIdColor=4]="ObjectAndLayerIdColor"})(Ol||(Ol={}));const Ire=1.3;let Lde=class{get extent(){return this._extent}constructor(e,r){this.index=e,this.renderTargets=r,this._extent=Ht(),this.resolution=0,this.renderLocalOrigin=UU(0,0,0,"O"),this.pixelRatio=1,this.mapUnitsPerPixel=1,this.canvasGeometries=new $0t,this.hasDrapedFeatureSource=!1,this.hasDrapedRasterSource=!1,this.hasTargetWithoutRasterImage=!1,this.index=e,this.validTargets=new Array(r.renderTargets.length).fill(!1)}getValidTexture(e){return this.validTargets[e]?this.renderTargets.getTarget(e).getTexture():null}get _needsColorWithoutRasterImage(){return this.hasDrapedRasterSource&&this.hasDrapedFeatureSource&&this.hasTargetWithoutRasterImage}getColorTexture(e){const r=e===Ol.ColorAndWater?this.renderTargets.getTarget(Os.Color):e===Ol.Highlight?this.renderTargets.getTarget(Os.Highlight):e===Ol.ObjectAndLayerIdColor?this.renderTargets.getTarget(Os.ObjectAndLayerIdColor):this.renderTargets.getTarget(Os.Occluded);return r?r.getTexture():null}getColorTextureNoRasterImage(){return this._needsColorWithoutRasterImage?this.getValidTexture(Os.ColorNoRasterImage):this.hasDrapedFeatureSource?this.getValidTexture(Os.Color):null}getNormalTexture(e){const r=e===Ol.ColorAndWater?this.renderTargets.getTarget(Os.Water):null;return r?r.getTexture():null}draw(e,r){const i=this.computeRenderTargetValidityBitfield();for(const s of this.renderTargets.renderTargets)s.type!==Os.ColorNoRasterImage||this._needsColorWithoutRasterImage?this.validTargets[s.type]=e.drawTarget(this,s,r):this.validTargets[s.type]=!1;return i^this.computeRenderTargetValidityBitfield()?MA.CHANGED:MA.UNCHANGED}computeRenderTargetValidityBitfield(){const e=this.validTargets;return+e[Os.Color]|+e[Os.ColorNoRasterImage]<<1|+e[Os.Highlight]<<2|+e[Os.Water]<<3|+e[Os.Occluded]<<4}setupGeometryViewsCyclical(e){this.setupGeometryViewsDirect();const r=.001*e.range;if(this._extent[0]-r<=e.min){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];ok(this._extent,e.range,0,i)}if(this._extent[2]+r>=e.max){const i=this.canvasGeometries.extents[this.canvasGeometries.numViews++];ok(this._extent,-e.range,0,i)}}setupGeometryViewsDirect(){this.canvasGeometries.numViews=1,C0(this.canvasGeometries.extents[0],this._extent)}hasSomeSizedView(){for(let e=0;e<this.canvasGeometries.numViews;e++){const r=this.canvasGeometries.extents[e];if(r[0]!==r[2]&&r[1]!==r[3])return!0}return!1}applyViewport(e){e.setViewport(this.index===Ji.INNER?0:this.resolution,0,this.resolution,this.resolution)}},$0t=class{constructor(){this.extents=[Ht(),Ht(),Ht()],this.numViews=0}},VIe=class extends Ps{constructor(e,r){super(e,"mat4",ai.Draw,(i,s,n)=>i.setUniformMatrix4fv(e,r(s,n)))}};function kf(t,e){e.instancedDoublePrecision?t.constants.add("cameraPosition","vec3",Nl):t.uniforms.add(new _h("cameraPosition",(r,i)=>ie(zIe,i.camera.viewInverseTransposeMatrix[3]-r.origin[0],i.camera.viewInverseTransposeMatrix[7]-r.origin[1],i.camera.viewInverseTransposeMatrix[11]-r.origin[2])))}function Eu(t,e){if(!e.instancedDoublePrecision)return void t.uniforms.add(new es("proj",(i,s)=>s.camera.projectionMatrix),new VIe("view",(i,s)=>Cc(Dde,s.camera.viewMatrix,i.origin)),new _h("localOrigin",i=>i.origin));const r=i=>ie(zIe,i.camera.viewInverseTransposeMatrix[3],i.camera.viewInverseTransposeMatrix[7],i.camera.viewInverseTransposeMatrix[11]);t.uniforms.add(new es("proj",(i,s)=>s.camera.projectionMatrix),new es("view",(i,s)=>Cc(Dde,s.camera.viewMatrix,r(s))),new jt("localOrigin",(i,s)=>r(s)))}const Dde=xe(),zIe=C();function NA(t){t.uniforms.add(new es("viewNormal",(e,r)=>r.camera.viewInverseTransposeMatrix))}function MO(t,e){t.uniforms.add(new Ie("pixelRatio",(r,i)=>i.camera.pixelRatio/(e.draped?Ire:1)))}function BIe(t,e){const r=t.vertex;e.hasVerticalOffset?(GIe(r),e.hasScreenSizePerspective&&(t.include(Mre),O8(r),kf(t.vertex,e)),r.code.add(w`
      vec3 calculateVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        float viewDistance = length((view * vec4(worldPos, 1.0)).xyz);
        ${e.spherical?w`vec3 worldNormal = normalize(worldPos + localOrigin);`:w`vec3 worldNormal = vec3(0.0, 0.0, 1.0);`}
        ${e.hasScreenSizePerspective?w`
            float cosAngle = dot(worldNormal, normalize(worldPos - cameraPosition));
            float verticalOffsetScreenHeight = screenSizePerspectiveScaleFloat(verticalOffset.x, abs(cosAngle), viewDistance, screenSizePerspectiveAlignment);`:w`
            float verticalOffsetScreenHeight = verticalOffset.x;`}
        // Screen sized offset in world space, used for example for line callouts
        float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * viewDistance, verticalOffset.z, verticalOffset.w);
        return worldNormal * worldOffset;
      }

      vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) {
        return worldPos + calculateVerticalOffset(worldPos, localOrigin);
      }
    `)):r.code.add(w`vec3 addVerticalOffset(vec3 worldPos, vec3 localOrigin) { return worldPos; }`)}const L0t=Qt();function GIe(t){t.uniforms.add(new cr("verticalOffset",(e,r)=>{const{minWorldLength:i,maxWorldLength:s,screenLength:n}=e.verticalOffset,o=Math.tan(.5*r.camera.fovY)/(.5*r.camera.fullViewport[3]),a=r.camera.pixelRatio||1;return zi(L0t,n*a,o,i,s)}))}function R8(t){t.uniforms.add(new lg("alignPixelEnabled",(e,r)=>r.alignPixelEnabled)),t.code.add(w`vec4 alignToPixelCenter(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.500123) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = (floor(xy * widthHeight) + vec2(0.5)) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`),t.code.add(w`vec4 alignToPixelOrigin(vec4 clipCoord, vec2 widthHeight) {
if (!alignPixelEnabled)
return clipCoord;
vec2 xy = vec2(0.5) + 0.5 * clipCoord.xy / clipCoord.w;
vec2 pixelSz = vec2(1.0) / widthHeight;
vec2 ij = floor((xy + 0.5 * pixelSz) * widthHeight) * pixelSz;
vec2 result = (ij * 2.0 - vec2(1.0)) * clipCoord.w;
return vec4(result, clipCoord.zw);
}`)}var su;(function(t){t[t.Occluded=0]="Occluded",t[t.NotOccluded=1]="NotOccluded",t[t.Both=2]="Both",t[t.COUNT=3]="COUNT"})(su||(su={}));var mc;function jIe(t,e){t.include(Mre),t.attributes.add(E.POSITION,"vec3"),t.attributes.add(E.NORMAL,"vec3"),t.attributes.add(E.AUXPOS1,"vec4");const r=t.vertex;Eu(r,e),kf(r,e),r.uniforms.add(new cr("viewport",(i,s)=>s.camera.fullViewport),new Ie("polygonOffset",i=>i.shaderPolygonOffset),new Ie("cameraGroundRelative",(i,s)=>s.camera.aboveGround?1:-1),new Ie("renderTransparentlyOccludedHUD",(i,s)=>s.renderTransparentlyOccludedHUD===su.Occluded?1:s.renderTransparentlyOccludedHUD===su.NotOccluded?0:.75),new et("hudVisibilityTexture",(i,s)=>s.hudVisibilityTexture)),e.hasVerticalOffset&&GIe(r),r.constants.add("smallOffsetAngle","float",.984807753012208),r.code.add(w`struct ProjectHUDAux {
vec3 posModel;
vec3 posView;
vec3 vnormal;
float distanceToCamera;
float absCosAngle;
};`),r.code.add(w`float applyHUDViewDependentPolygonOffset(float pointGroundDistance, float absCosAngle, inout vec3 posView) {
float pointGroundSign = sign(pointGroundDistance);
if (pointGroundSign == 0.0) {
pointGroundSign = cameraGroundRelative;
}
float groundRelative = cameraGroundRelative * pointGroundSign;
if (polygonOffset > .0) {
float cosAlpha = clamp(absCosAngle, 0.01, 1.0);
float tanAlpha = sqrt(1.0 - cosAlpha * cosAlpha) / cosAlpha;
float factor = (1.0 - tanAlpha / viewport[2]);
if (groundRelative > 0.0) {
posView *= factor;
}
else {
posView /= factor;
}
}
return groundRelative;
}`),e.draped&&!e.hasVerticalOffset||NA(r),e.draped||(r.uniforms.add(new Ie("perDistancePixelRatio",(i,s)=>Math.tan(s.camera.fovY/2)/(s.camera.fullViewport[2]/2))),r.code.add(w`void applyHUDVerticalGroundOffset(vec3 normalModel, inout vec3 posModel, inout vec3 posView) {
float distanceToCamera = length(posView);
float pixelOffset = distanceToCamera * perDistancePixelRatio * 0.5;
vec3 modelOffset = normalModel * cameraGroundRelative * pixelOffset;
vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
posModel += modelOffset;
posView += viewOffset;
}`)),e.screenCenterOffsetUnitsEnabled===mc.Screen&&MO(r,e),e.hasScreenSizePerspective&&O8(r),r.code.add(w`
    vec4 projectPositionHUD(out ProjectHUDAux aux) {
      // centerOffset is in view space and is used to implement world size offsetting
      // of labels with respect to objects. It also pulls the label towards the viewer
      // so that the label is visible in front of the object.
      vec3 centerOffset = auxpos1.xyz;

      // The pointGroundDistance is the distance of the geometry to the ground and is
      // negative if the point is below the ground, or positive if the point is above
      // ground.
      float pointGroundDistance = auxpos1.w;

      aux.posModel = position;
      aux.posView = (view * vec4(aux.posModel, 1.0)).xyz;
      aux.vnormal = normal;
      ${e.draped?"":"applyHUDVerticalGroundOffset(aux.vnormal, aux.posModel, aux.posView);"}

      // Screen sized offset in world space, used for example for line callouts
      // Note: keep this implementation in sync with the CPU implementation, see
      //   - MaterialUtil.verticalOffsetAtDistance
      //   - HUDMaterial.applyVerticalOffsetTransformation

      aux.distanceToCamera = length(aux.posView);

      vec3 viewDirObjSpace = normalize(cameraPosition - aux.posModel);
      float cosAngle = dot(aux.vnormal, viewDirObjSpace);

      aux.absCosAngle = abs(cosAngle);

      ${e.hasScreenSizePerspective&&(e.hasVerticalOffset||e.screenCenterOffsetUnitsEnabled===mc.Screen)?"vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(aux.absCosAngle, aux.distanceToCamera, screenSizePerspectiveAlignment);":""}

      ${e.hasVerticalOffset?e.hasScreenSizePerspective?"float verticalOffsetScreenHeight = applyScreenSizePerspectiveScaleFactorFloat(verticalOffset.x, perspectiveFactor);":"float verticalOffsetScreenHeight = verticalOffset.x;":""}

      ${e.hasVerticalOffset?w`
            float worldOffset = clamp(verticalOffsetScreenHeight * verticalOffset.y * aux.distanceToCamera, verticalOffset.z, verticalOffset.w);
            vec3 modelOffset = aux.vnormal * worldOffset;
            aux.posModel += modelOffset;
            vec3 viewOffset = (viewNormal * vec4(modelOffset, 1.0)).xyz;
            aux.posView += viewOffset;
            // Since we elevate the object, we need to take that into account
            // in the distance to ground
            pointGroundDistance += worldOffset;`:""}

      float groundRelative = applyHUDViewDependentPolygonOffset(pointGroundDistance, aux.absCosAngle, aux.posView);

      ${e.screenCenterOffsetUnitsEnabled!==mc.Screen?w`
            // Apply x/y in view space, but z in screen space (i.e. along posView direction)
            aux.posView += vec3(centerOffset.x, centerOffset.y, 0.0);

            // Same material all have same z != 0.0 condition so should not lead to
            // branch fragmentation and will save a normalization if it's not needed
            if (centerOffset.z != 0.0) {
              aux.posView -= normalize(aux.posView) * centerOffset.z;
            }
          `:""}

      vec4 posProj = proj * vec4(aux.posView, 1.0);

      ${e.screenCenterOffsetUnitsEnabled===mc.Screen?e.hasScreenSizePerspective?"float centerOffsetY = applyScreenSizePerspectiveScaleFactorFloat(centerOffset.y, perspectiveFactor);":"float centerOffsetY = centerOffset.y;":""}

      ${e.screenCenterOffsetUnitsEnabled===mc.Screen?"posProj.xy += vec2(centerOffset.x, centerOffsetY) * pixelRatio * 2.0 / viewport.zw * posProj.w;":""}

      // constant part of polygon offset emulation
      posProj.z -= groundRelative * polygonOffset * posProj.w;
      return posProj;
    }
  `),r.include(R8),r.code.add(w`bool testVisibilityHUD(vec4 posProj) {
vec4 posProjCenter = alignToPixelCenter(posProj, viewport.zw);
vec4 occlusionPixel = texture(hudVisibilityTexture, .5 + .5 * posProjCenter.xy / posProjCenter.w);
if (renderTransparentlyOccludedHUD > 0.5) {
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g * renderTransparentlyOccludedHUD < 1.0;
}
return occlusionPixel.r * occlusionPixel.g > 0.0 && occlusionPixel.g == 1.0;
}`)}(function(t){t[t.World=0]="World",t[t.Screen=1]="Screen",t[t.COUNT=2]="COUNT"})(mc||(mc={}));const sN=Gn();function HIe(t,e,r,i,s,n){if(t.visible)if(t.boundingInfo){it(t.type===Ms.Mesh);const o=e.tolerance;qIe(t.boundingInfo,r,i,o,s,n)}else{const o=t.indices.get(E.POSITION),a=t.vertexAttributes.get(E.POSITION);I$(r,i,0,o.length/3,o,a,void 0,s,n)}}const D0t=C();function qIe(t,e,r,i,s,n){if(t==null)return;const o=ZIe(e,r,D0t);if(uxe(sN,t.bbMin),hxe(sN,t.bbMax),s?.applyToAabb(sN),$re(sN,e,o,i)){const{primitiveIndices:a,indices:l,position:c}=t,h=a?a.length:l.length/3;if(h>U0t){const p=t.getChildren();if(p!==void 0){for(const f of p)qIe(f,e,r,i,s,n);return}}I$(e,r,0,h,l,c,a,s,n)}}const WIe=C();function I$(t,e,r,i,s,n,o,a,l){if(o)return N0t(t,e,r,i,s,n,o,a,l);const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],g=e[0]-p,_=e[1]-f,v=e[2]-m;for(let b=r,x=3*r;b<i;++b){let T=h*s[x++],S=c[T++],O=c[T++],A=c[T];T=h*s[x++];let M=c[T++],P=c[T++],F=c[T];T=h*s[x++];let $=c[T++],N=c[T++],U=c[T];a!=null&&([S,O,A]=a.applyToVertex(S,O,A,b),[M,P,F]=a.applyToVertex(M,P,F,b),[$,N,U]=a.applyToVertex($,N,U,b));const X=M-S,Z=P-O,G=F-A,ee=$-S,I=N-O,V=U-A,z=_*V-I*v,H=v*ee-V*g,Y=g*I-ee*_,te=X*z+Z*H+G*Y;if(Math.abs(te)<=Number.EPSILON)continue;const ne=p-S,ve=f-O,Fe=m-A,bt=ne*z+ve*H+Fe*Y;if(te>0){if(bt<0||bt>te)continue}else if(bt>0||bt<te)continue;const Pt=ve*G-Z*Fe,dt=Fe*X-G*ne,wt=ne*Z-X*ve,be=g*Pt+_*dt+v*wt;if(te>0){if(be<0||bt+be>te)continue}else if(be>0||bt+be<te)continue;const Me=(ee*Pt+I*dt+V*wt)/te;Me>=0&&l(Me,Pre(X,Z,G,ee,I,V,WIe),b,!1)}}function N0t(t,e,r,i,s,n,o,a,l){const{data:c,stride:h}=n,p=t[0],f=t[1],m=t[2],g=e[0]-p,_=e[1]-f,v=e[2]-m;for(let b=r;b<i;++b){const x=o[b];let T=3*x,S=h*s[T++],O=c[S++],A=c[S++],M=c[S];S=h*s[T++];let P=c[S++],F=c[S++],$=c[S];S=h*s[T];let N=c[S++],U=c[S++],X=c[S];a!=null&&([O,A,M]=a.applyToVertex(O,A,M,b),[P,F,$]=a.applyToVertex(P,F,$,b),[N,U,X]=a.applyToVertex(N,U,X,b));const Z=P-O,G=F-A,ee=$-M,I=N-O,V=U-A,z=X-M,H=_*z-V*v,Y=v*I-z*g,te=g*V-I*_,ne=Z*H+G*Y+ee*te;if(Math.abs(ne)<=Number.EPSILON)continue;const ve=p-O,Fe=f-A,bt=m-M,Pt=ve*H+Fe*Y+bt*te;if(ne>0){if(Pt<0||Pt>ne)continue}else if(Pt>0||Pt<ne)continue;const dt=Fe*ee-G*bt,wt=bt*Z-ee*ve,be=ve*G-Z*Fe,Me=g*dt+_*wt+v*be;if(ne>0){if(Me<0||Pt+Me>ne)continue}else if(Me>0||Pt+Me<ne)continue;const Ct=(I*dt+V*wt+z*be)/ne;Ct>=0&&l(Ct,Pre(Z,G,ee,I,V,z,WIe),x,!1)}}const Nde=C(),Fde=C();function Pre(t,e,r,i,s,n,o){return ie(Nde,t,e,r),ie(Fde,i,s,n),st(o,Nde,Fde),_e(o,o),o}function ZIe(t,e,r){return ie(r,1/(e[0]-t[0]),1/(e[1]-t[1]),1/(e[2]-t[2]))}function $re(t,e,r,i){return Lre(t,e,r,i,1/0)}function Lre(t,e,r,i,s){const n=(t[0]-i-e[0])*r[0],o=(t[3]+i-e[0])*r[0];let a=Math.min(n,o),l=Math.max(n,o);const c=(t[1]-i-e[1])*r[1],h=(t[4]+i-e[1])*r[1];if(l=Math.min(l,Math.max(c,h)),l<0||(a=Math.max(a,Math.min(c,h)),a>l))return!1;const p=(t[2]-i-e[2])*r[2],f=(t[5]+i-e[2])*r[2];return l=Math.min(l,Math.max(p,f)),!(l<0)&&(a=Math.max(a,Math.min(p,f)),!(a>l)&&a<s)}function XIe(t,e,r,i,s){let n=(r.screenLength||0)*t.pixelRatio;s!=null&&(n=E0t(n,i,e,s));const o=n*Math.tan(.5*t.fovY)/(.5*t.fullHeight);return ye(o*e,r.minWorldLength||0,r.maxWorldLength!=null?r.maxWorldLength:1/0)}function YIe(t,e){const r=e?YIe(e):{};for(const i in t){let s=t[i];s&&s.forEach&&(s=k0t(s)),s==null&&i in r||(r[i]=s)}return r}function F0t(t,e){let r=!1;for(const i in e){const s=e[i];s!==void 0&&(Array.isArray(s)?t[i]===null?(t[i]=s.slice(),r=!0):AJ(t[i],s)&&(r=!0):t[i]!==s&&(r=!0,t[i]=s))}return r}function k0t(t){const e=[];return t.forEach(r=>e.push(r)),e}const JIe={multiply:1,ignore:2,replace:3,tint:4},U0t=1e3;let mb=class extends O${constructor(e,r){super(),this.type=Ms.Material,this.supportsEdges=!1,this._visible=!0,this._renderPriority=0,this._insertOrder=0,this._vertexAttributeLocations=Er,this._pp0=Ee(0,0,1),this._pp1=Ee(0,0,0),this._parameters=YIe(e,r),this.validateParameters(this._parameters)}dispose(){}get parameters(){return this._parameters}update(e){return!1}setParameters(e,r=!0){F0t(this._parameters,e)&&(this.validateParameters(this._parameters),r&&this.parametersChanged())}validateParameters(e){}get visible(){return this._visible}set visible(e){e!==this._visible&&(this._visible=e,this.parametersChanged())}shouldRender(e){return this.isVisible()&&this.isVisibleForOutput(e.output)&&(this.renderOccluded&e.renderOccludedMask)!=0}isVisibleForOutput(e){return!0}get renderOccluded(){return this.parameters.renderOccluded}get renderPriority(){return this._renderPriority}set renderPriority(e){e!==this._renderPriority&&(this._renderPriority=e,this.parametersChanged())}get insertOrder(){return this._insertOrder}set insertOrder(e){e!==this._insertOrder&&(this._insertOrder=e,this.parametersChanged())}get vertexAttributeLocations(){return this._vertexAttributeLocations}isVisible(){return this._visible}parametersChanged(){this.repository!=null&&this.repository.materialChanged(this)}intersectDraped(e,r,i,s,n,o){return this._pp0[0]=this._pp1[0]=s[0],this._pp0[1]=this._pp1[1]=s[1],this.intersect(e,r,i,this._pp0,this._pp1,n)}},QIe=class extends Ipt{constructor(e,r,i){super(r,i),this.camera=e}};var Qi;(function(t){t[t.None=0]="None",t[t.Occlude=1]="Occlude",t[t.Transparent=2]="Transparent",t[t.OccludeAndTransparent=4]="OccludeAndTransparent",t[t.OccludeAndTransparentStencil=8]="OccludeAndTransparentStencil",t[t.Opaque=16]="Opaque"})(Qi||(Qi={}));let Dre=class extends ui{constructor(){super(...arguments),this.renderOccluded=Qi.Occlude}},KIe=class{constructor(){this.factor=new kde,this.factorAlignment=new kde}},kde=class{constructor(){this.scale=0,this.factor=0,this.minPixelSize=0,this.paddingPixels=0}};function wjt(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l)n[i]=e[t[l]],i+=o;else for(let l=0;l<a;++l){const c=e[t[l]];for(let h=0;h<s;h++)n[i]=c,i+=o}}function Ude(t,e,r,i){const s=r.typedBuffer,n=r.typedBufferStride,o=t.length;i*=n;for(let a=0;a<o;++a){const l=2*t[a];s[i]=e[l],s[i+1]=e[l+1],i+=n}}function ePe(t,e,r,i,s){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s==null||s===1)for(let l=0;l<a;++l){const c=3*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}else for(let l=0;l<a;++l){const c=3*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],i+=o}}function FA(t,e,r,i,s=1){const n=r.typedBuffer,o=r.typedBufferStride,a=t.length;if(i*=o,s===1)for(let l=0;l<a;++l){const c=4*t[l];n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}else for(let l=0;l<a;++l){const c=4*t[l];for(let h=0;h<s;++h)n[i]=e[c],n[i+1]=e[c+1],n[i+2]=e[c+2],n[i+3]=e[c+3],i+=o}}function Vde(t,e,r){const i=t.typedBuffer,s=t.typedBufferStride;e*=s;for(let n=0;n<r;++n)i[e]=0,i[e+1]=0,i[e+2]=0,i[e+3]=0,e+=s}function Nre(t,e,r,i,s,n=1){if(!r)return void ePe(t,e,i,s,n);const o=i.typedBuffer,a=i.typedBufferStride,l=t.length,c=r[0],h=r[1],p=r[2],f=r[4],m=r[5],g=r[6],_=r[8],v=r[9],b=r[10],x=r[12],T=r[13],S=r[14];s*=a;let O=0,A=0,M=0;const P=xV(r)?F=>{O=e[F]+x,A=e[F+1]+T,M=e[F+2]+S}:F=>{const $=e[F],N=e[F+1],U=e[F+2];O=c*$+f*N+_*U+x,A=h*$+m*N+v*U+T,M=p*$+g*N+b*U+S};if(n===1)for(let F=0;F<l;++F)P(3*t[F]),o[s]=O,o[s+1]=A,o[s+2]=M,s+=a;else for(let F=0;F<l;++F){P(3*t[F]);for(let $=0;$<n;++$)o[s]=O,o[s+1]=A,o[s+2]=M,s+=a}}function Fre(t,e,r,i,s,n=1){if(!r)return void ePe(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],g=o[5],_=o[6],v=o[8],b=o[9],x=o[10],T=!eee(o),S=1e-6,O=1-S;s*=l;let A=0,M=0,P=0;const F=xV(o)?$=>{A=e[$],M=e[$+1],P=e[$+2]}:$=>{const N=e[$],U=e[$+1],X=e[$+2];A=h*N+m*U+v*X,M=p*N+g*U+b*X,P=f*N+_*U+x*X};if(n===1)if(T)for(let $=0;$<c;++$){F(3*t[$]);const N=A*A+M*M+P*P;if(N<O&&N>S){const U=1/Math.sqrt(N);a[s]=A*U,a[s+1]=M*U,a[s+2]=P*U}else a[s]=A,a[s+1]=M,a[s+2]=P;s+=l}else for(let $=0;$<c;++$)F(3*t[$]),a[s]=A,a[s+1]=M,a[s+2]=P,s+=l;else for(let $=0;$<c;++$){if(F(3*t[$]),T){const N=A*A+M*M+P*P;if(N<O&&N>S){const U=1/Math.sqrt(N);A*=U,M*=U,P*=U}}for(let N=0;N<n;++N)a[s]=A,a[s+1]=M,a[s+2]=P,s+=l}}function V0t(t,e,r,i,s,n=1){if(!r)return void FA(t,e,i,s,n);const o=r,a=i.typedBuffer,l=i.typedBufferStride,c=t.length,h=o[0],p=o[1],f=o[2],m=o[4],g=o[5],_=o[6],v=o[8],b=o[9],x=o[10],T=!eee(o),S=1e-6,O=1-S;if(s*=l,n===1)for(let A=0;A<c;++A){const M=4*t[A],P=e[M],F=e[M+1],$=e[M+2],N=e[M+3];let U=h*P+m*F+v*$,X=p*P+g*F+b*$,Z=f*P+_*F+x*$;if(T){const G=U*U+X*X+Z*Z;if(G<O&&G>S){const ee=1/Math.sqrt(G);U*=ee,X*=ee,Z*=ee}}a[s]=U,a[s+1]=X,a[s+2]=Z,a[s+3]=N,s+=l}else for(let A=0;A<c;++A){const M=4*t[A],P=e[M],F=e[M+1],$=e[M+2],N=e[M+3];let U=h*P+m*F+v*$,X=p*P+g*F+b*$,Z=f*P+_*F+x*$;if(T){const G=U*U+X*X+Z*Z;if(G<O&&G>S){const ee=1/Math.sqrt(G);U*=ee,X*=ee,Z*=ee}}for(let G=0;G<n;++G)a[s]=U,a[s+1]=X,a[s+2]=Z,a[s+3]=N,s+=l}}function tPe(t,e,r,i,s,n=1){const o=i.typedBuffer,a=i.typedBufferStride,l=t.length;if(s*=a,r!==e.length||r!==4)if(n!==1)if(r!==4)for(let c=0;c<l;++c){const h=3*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}else for(let c=0;c<l;++c){const h=4*t[c];for(let p=0;p<n;++p)o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}else{if(r===4){for(let c=0;c<l;++c){const h=4*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=e[h+3],s+=a}return}for(let c=0;c<l;++c){const h=3*t[c];o[s]=e[h],o[s+1]=e[h+1],o[s+2]=e[h+2],o[s+3]=255,s+=a}}else{o[s]=e[0],o[s+1]=e[1],o[s+2]=e[2],o[s+3]=e[3];const c=new Uint32Array(i.typedBuffer.buffer,i.start),h=a/4,p=c[s/=4];s+=h;const f=l*n;for(let m=1;m<f;++m)c[s]=p,s+=h}}function z0t(t,e,r,i){const s=r.typedBuffer,n=r.typedBufferStride,o=t.length,a=e[0];i*=n;for(let l=0;l<o;++l)s[i]=a,i+=n}function rPe(t,e,r,i,s=1){const n=e.typedBuffer,o=e.typedBufferStride;if(i*=o,s===1)for(let a=0;a<r;++a)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o;else for(let a=0;a<r;++a)for(let l=0;l<s;++l)n[i]=t[0],n[i+1]=t[1],n[i+2]=t[2],n[i+3]=t[3],i+=o}function iPe(t,e,r,i,s,n){for(const o of e.fields.keys()){const a=t.vertexAttributes.get(o),l=t.indices.get(o);if(a&&l)sPe(o,a,l,r,i,s,n);else if(o===E.OBJECTANDLAYERIDCOLOR&&t.objectAndLayerIdColor!=null){const c=t.indices.get(E.POSITION);if(it(!!c,`No buffer view for ${o}`),c){const h=c.length,p=s.getField(o,rl);rPe(t.objectAndLayerIdColor,p,h,n)}}}}function sPe(t,e,r,i,s,n,o){switch(t){case E.POSITION:{it(e.size===3);const a=n.getField(t,zn);it(!!a,`No buffer view for ${t}`),a&&Nre(r,e.data,i,a,o);break}case E.NORMAL:{it(e.size===3);const a=n.getField(t,zn);it(!!a,`No buffer view for ${t}`),a&&Fre(r,e.data,s,a,o);break}case E.NORMALCOMPRESSED:{it(e.size===2);const a=n.getField(t,A$);it(!!a,`No buffer view for ${t}`),a&&Ude(r,e.data,a,o);break}case E.UV0:{it(e.size===2);const a=n.getField(t,fb);it(!!a,`No buffer view for ${t}`),a&&Ude(r,e.data,a,o);break}case E.COLOR:case E.SYMBOLCOLOR:{const a=n.getField(t,rl);it(!!a,`No buffer view for ${t}`),it(e.size===3||e.size===4),!a||e.size!==3&&e.size!==4||tPe(r,e.data,e.size,a,o);break}case E.COLORFEATUREATTRIBUTE:{const a=n.getField(t,c8);it(!!a,`No buffer view for ${t}`),it(e.size===1),a&&e.size===1&&z0t(r,e.data,a,o);break}case E.TANGENT:{it(e.size===4);const a=n.getField(t,Ff);it(!!a,`No buffer view for ${t}`),a&&V0t(r,e.data,s,a,o);break}case E.PROFILERIGHT:case E.PROFILEUP:case E.PROFILEVERTEXANDNORMAL:case E.FEATUREVALUE:{it(e.size===4);const a=n.getField(t,Ff);it(!!a,`No buffer view for ${t}`),a&&FA(r,e.data,a,o)}}}function xP(t,e,r=0){const i=ye(t,0,j0t);for(let s=0;s<4;s++)e[r+s]=Math.floor(256*H0t(i*B0t[s]))}function kre(t,e=0){let r=0;for(let i=0;i<4;i++)r+=t[e+i]*G0t[i];return r}const B0t=[1,256,65536,16777216],G0t=[1/256,1/65536,1/16777216,1/4294967296],j0t=kre(new Uint8ClampedArray([255,255,255,255]));function H0t(t){return t-Math.floor(t)}async function D0(t,e){const{data:r}=await Lt(t,{responseType:"image",...e});return r}function q0t(){if(zB==null){const t=e=>Dr(`esri/libs/basisu/${e}`);zB=J(()=>import("./basis_transcoder-72c80d46.js"),[],import.meta.url).then(e=>e.b).then(({default:e})=>e({locateFile:t}).then(r=>(r.initializeBasis(),delete r.then,r)))}return zB}let zB;var Dx;(function(t){t[t.ETC1_RGB=0]="ETC1_RGB",t[t.ETC2_RGBA=1]="ETC2_RGBA",t[t.BC1_RGB=2]="BC1_RGB",t[t.BC3_RGBA=3]="BC3_RGBA",t[t.BC4_R=4]="BC4_R",t[t.BC5_RG=5]="BC5_RG",t[t.BC7_M6_RGB=6]="BC7_M6_RGB",t[t.BC7_M5_RGBA=7]="BC7_M5_RGBA",t[t.PVRTC1_4_RGB=8]="PVRTC1_4_RGB",t[t.PVRTC1_4_RGBA=9]="PVRTC1_4_RGBA",t[t.ASTC_4x4_RGBA=10]="ASTC_4x4_RGBA",t[t.ATC_RGB=11]="ATC_RGB",t[t.ATC_RGBA=12]="ATC_RGBA",t[t.FXT1_RGB=17]="FXT1_RGB",t[t.PVRTC2_4_RGB=18]="PVRTC2_4_RGB",t[t.PVRTC2_4_RGBA=19]="PVRTC2_4_RGBA",t[t.ETC2_EAC_R11=20]="ETC2_EAC_R11",t[t.ETC2_EAC_RG11=21]="ETC2_EAC_RG11",t[t.RGBA32=13]="RGBA32",t[t.RGB565=14]="RGB565",t[t.BGR565=15]="BGR565",t[t.RGBA4444=16]="RGBA4444"})(Dx||(Dx={}));let Tf=null,nN=null;async function nPe(){return nN==null&&(nN=q0t(),Tf=await nN),nN}function W0t(t,e){if(Tf==null)return t.byteLength;const r=new Tf.BasisFile(new Uint8Array(t)),i=aPe(r)?oPe(r.getNumLevels(0),r.getHasAlpha(),r.getImageWidth(0,0),r.getImageHeight(0,0),e):0;return r.close(),r.delete(),i}function Z0t(t,e){if(Tf==null)return t.byteLength;const r=new Tf.KTX2File(new Uint8Array(t)),i=lPe(r)?oPe(r.getLevels(),r.getHasAlpha(),r.getWidth(),r.getHeight(),e):0;return r.close(),r.delete(),i}function oPe(t,e,r,i,s){const n=Ute(e?Ns.COMPRESSED_RGBA8_ETC2_EAC:Ns.COMPRESSED_RGB8_ETC2),o=s&&t>1?(4**t-1)/(3*4**(t-1)):1;return Math.ceil(r*i*n*o)}function aPe(t){return t.getNumImages()>=1&&!t.isUASTC()}function lPe(t){return t.getFaces()>=1&&t.isETC1S()}async function X0t(t,e,r){Tf==null&&(Tf=await nPe());const i=new Tf.BasisFile(new Uint8Array(r));if(!aPe(i))return null;i.startTranscoding();const s=cPe(t,e,i.getNumLevels(0),i.getHasAlpha(),i.getImageWidth(0,0),i.getImageHeight(0,0),(n,o)=>i.getImageTranscodedSizeInBytes(0,n,o),(n,o,a)=>i.transcodeImage(a,0,n,o,0,0));return i.close(),i.delete(),s}async function Y0t(t,e,r){Tf==null&&(Tf=await nPe());const i=new Tf.KTX2File(new Uint8Array(r));if(!lPe(i))return null;i.startTranscoding();const s=cPe(t,e,i.getLevels(),i.getHasAlpha(),i.getWidth(),i.getHeight(),(n,o)=>i.getImageTranscodedSizeInBytes(n,0,0,o),(n,o,a)=>i.transcodeImage(a,n,0,0,o,0,-1,-1));return i.close(),i.delete(),s}function cPe(t,e,r,i,s,n,o,a){const{compressedTextureETC:l,compressedTextureS3TC:c}=t.capabilities,[h,p]=l?i?[Dx.ETC2_RGBA,Ns.COMPRESSED_RGBA8_ETC2_EAC]:[Dx.ETC1_RGB,Ns.COMPRESSED_RGB8_ETC2]:c?i?[Dx.BC3_RGBA,Ns.COMPRESSED_RGBA_S3TC_DXT5_EXT]:[Dx.BC1_RGB,Ns.COMPRESSED_RGB_S3TC_DXT1_EXT]:[Dx.RGBA32,At.RGBA],f=e.hasMipmap?r:Math.min(1,r),m=[];for(let g=0;g<f;g++)m.push(new Uint8Array(o(g,h))),a(g,h,m[g]);return e.internalFormat=p,e.hasMipmap=m.length>1,e.samplingMode=e.hasMipmap?Mt.LINEAR_MIPMAP_LINEAR:Mt.LINEAR,e.width=s,e.height=n,new Rt(t,e,{type:"compressed",levels:m})}const oN=K.getLogger("esri.views.3d.webgl-engine.lib.DDSUtil"),J0t=542327876,Q0t=131072,K0t=4;function Ure(t){return t.charCodeAt(0)+(t.charCodeAt(1)<<8)+(t.charCodeAt(2)<<16)+(t.charCodeAt(3)<<24)}function e_t(t){return String.fromCharCode(255&t,t>>8&255,t>>16&255,t>>24&255)}const t_t=Ure("DXT1"),r_t=Ure("DXT3"),i_t=Ure("DXT5"),s_t=31,n_t=0,o_t=1,a_t=2,l_t=3,c_t=4,u_t=7,h_t=20,d_t=21;function p_t(t,e,r){const i=f_t(r,e.hasMipmap??!1);if(i==null)throw new Error("DDS texture data is null");const{textureData:s,internalFormat:n,width:o,height:a}=i;return e.samplingMode=s.levels.length>1?Mt.LINEAR_MIPMAP_LINEAR:Mt.LINEAR,e.hasMipmap=s.levels.length>1,e.internalFormat=n,e.width=o,e.height=a,new Rt(t,e,s)}function f_t(t,e){const r=new Int32Array(t,0,s_t);if(r[n_t]!==J0t)return oN.error("Invalid magic number in DDS header"),null;if(!(r[h_t]&K0t))return oN.error("Unsupported format, must contain a FourCC code"),null;const i=r[d_t];let s,n;switch(i){case t_t:s=8,n=Ns.COMPRESSED_RGB_S3TC_DXT1_EXT;break;case r_t:s=16,n=Ns.COMPRESSED_RGBA_S3TC_DXT3_EXT;break;case i_t:s=16,n=Ns.COMPRESSED_RGBA_S3TC_DXT5_EXT;break;default:return oN.error("Unsupported FourCC code:",e_t(i)),null}let o=1,a=r[c_t],l=r[l_t];!(3&a)&&!(3&l)||(oN.warn("Rounding up compressed texture size to nearest multiple of 4."),a=a+3&-4,l=l+3&-4);const c=a,h=l;let p,f;r[a_t]&Q0t&&e!==!1&&(o=Math.max(1,r[u_t]));let m=r[o_t]+4;const g=[];for(let _=0;_<o;++_)f=(a+3>>2)*(l+3>>2)*s,p=new Uint8Array(t,m,f),g.push(p),m+=f,a=Math.max(1,a>>1),l=Math.max(1,l>>1);return{textureData:{type:"compressed",levels:g},internalFormat:n,width:c,height:h}}let wS=class extends O${constructor(e,r){super(),this._data=e,this.type=Ms.Texture,this._glTexture=null,this._loadingPromise=null,this._loadingController=null,this.events=new Xr,this.parameters=r||{},this.parameters.mipmap=this.parameters.mipmap!==!1,this.parameters.noUnpackFlip=this.parameters.noUnpackFlip||!1,this.parameters.preMultiplyAlpha=this.parameters.preMultiplyAlpha||!1,this.parameters.wrap=this.parameters.wrap||{s:Ut.REPEAT,t:Ut.REPEAT},this._startPreload(e)}_startPreload(e){e!=null&&(e instanceof HTMLVideoElement?this._startPreloadVideoElement(e):e instanceof HTMLImageElement&&this._startPreloadImageElement(e))}_startPreloadVideoElement(e){if(!($1(e.src)||e.preload==="auto"&&e.crossOrigin)){e.preload="auto",e.crossOrigin="anonymous";const r=!e.paused;if(e.src=e.src,r&&e.autoplay){const i=()=>{e.removeEventListener("canplay",i),e.play()};e.addEventListener("canplay",i)}}}_startPreloadImageElement(e){Ig(e.src)||$1(e.src)||e.crossOrigin||(e.crossOrigin="anonymous",e.src=e.src)}dispose(){this._data=void 0}_createDescriptor(e){const r=new Sr;return r.wrapMode=this.parameters.wrap??Ut.REPEAT,r.flipped=!this.parameters.noUnpackFlip,r.samplingMode=this.parameters.mipmap?Mt.LINEAR_MIPMAP_LINEAR:Mt.LINEAR,r.hasMipmap=!!this.parameters.mipmap,r.preMultiplyAlpha=!!this.parameters.preMultiplyAlpha,r.maxAnisotropy=this.parameters.maxAnisotropy??(this.parameters.mipmap?e.parameters.maxMaxAnisotropy:1),r}get glTexture(){return this._glTexture}get memoryEstimate(){return this._glTexture?.gpuMemoryUsage||m_t(this._data,this.parameters)}load(e){if(this._glTexture!=null)return this._glTexture;if(this._loadingPromise)return this._loadingPromise;const r=this._data;return r==null?(this._glTexture=new Rt(e,this._createDescriptor(e),null),this._glTexture):typeof r=="string"?this._loadFromURL(e,r):r instanceof Image?this._loadFromImageElement(e,r):r instanceof HTMLVideoElement?this._loadFromVideoElement(e,r):r instanceof ImageData||r instanceof HTMLCanvasElement?this._loadFromImage(e,r):(XR(r)||r1(r))&&this.parameters.encoding===m0.DDS_ENCODING?(this._data=void 0,this._loadFromDDSData(e,r)):(XR(r)||r1(r))&&this.parameters.encoding===m0.KTX2_ENCODING?(this._data=void 0,this._loadFromKTX2(e,r)):(XR(r)||r1(r))&&this.parameters.encoding===m0.BASIS_ENCODING?(this._data=void 0,this._loadFromBasis(e,r)):r1(r)?this._loadFromPixelData(e,r):XR(r)?this._loadFromPixelData(e,new Uint8Array(r)):null}get requiresFrameUpdates(){return this._data instanceof HTMLVideoElement}frameUpdate(e){return this._data instanceof HTMLVideoElement&&this._glTexture!=null?this._data.readyState<pI.HAVE_CURRENT_DATA||e===this._data.currentTime?e:(this._glTexture.setData(this._data),this._glTexture.descriptor.hasMipmap&&this._glTexture.generateMipmap(),this.parameters.updateCallback&&this.parameters.updateCallback(),this._data.currentTime):e}_loadFromDDSData(e,r){return this._glTexture=p_t(e,this._createDescriptor(e),r),this._glTexture}_loadFromKTX2(e,r){return this._loadAsync(()=>Y0t(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromBasis(e,r){return this._loadAsync(()=>X0t(e,this._createDescriptor(e),r).then(i=>(this._glTexture=i,i)))}_loadFromPixelData(e,r){it(this.parameters.width>0&&this.parameters.height>0);const i=this._createDescriptor(e);return i.pixelFormat=this.parameters.components===1?At.LUMINANCE:this.parameters.components===3?At.RGB:At.RGBA,i.width=this.parameters.width??0,i.height=this.parameters.height??0,this._glTexture=new Rt(e,i,r),this._glTexture}_loadFromURL(e,r){return this._loadAsync(async i=>{const s=await D0(r,{signal:i});return Dt(i),this._loadFromImage(e,s)})}_loadFromImageElement(e,r){return r.complete?this._loadFromImage(e,r):this._loadAsync(async i=>{const s=await Tve(r,r.src,!1,i);return Dt(i),this._loadFromImage(e,s)})}_loadFromVideoElement(e,r){return r.readyState>=pI.HAVE_CURRENT_DATA?this._loadFromImage(e,r):this._loadFromVideoElementAsync(e,r)}_loadFromVideoElementAsync(e,r){return this._loadAsync(i=>new Promise((s,n)=>{const o=()=>{r.removeEventListener("loadeddata",a),r.removeEventListener("error",l),Pi(c)},a=()=>{r.readyState>=pI.HAVE_CURRENT_DATA&&(o(),s(this._loadFromImage(e,r)))},l=h=>{o(),n(h||new D("Failed to load video"))};r.addEventListener("loadeddata",a),r.addEventListener("error",l);const c=xn(i,()=>l(Tr()))}))}_loadFromImage(e,r){const i=uPe(r);this.parameters.width=i.width,this.parameters.height=i.height;const s=this._createDescriptor(e);return s.pixelFormat=this.parameters.components===3?At.RGB:At.RGBA,s.width=i.width,s.height=i.height,this._glTexture=new Rt(e,s,r),this._glTexture}_loadAsync(e){const r=new AbortController;this._loadingController=r;const i=e(r.signal);this._loadingPromise=i;const s=()=>{this._loadingController===r&&(this._loadingController=null),this._loadingPromise===i&&(this._loadingPromise=null)};return i.then(s,s),i}unload(){if(this._glTexture=ze(this._glTexture),this._loadingController!=null){const e=this._loadingController;this._loadingController=null,this._loadingPromise=null,e.abort()}this.events.emit("unloaded")}};function m_t(t,e){if(t==null)return 0;if(XR(t)||r1(t))return e.encoding===m0.KTX2_ENCODING?Z0t(t,!!e.mipmap):e.encoding===m0.BASIS_ENCODING?W0t(t,!!e.mipmap):t.byteLength;const{width:r,height:i}=t instanceof Image||t instanceof ImageData||t instanceof HTMLCanvasElement||t instanceof HTMLVideoElement?uPe(t):e;return(e.mipmap?4/3:1)*r*i*(e.components||4)||0}function uPe(t){return t instanceof HTMLVideoElement?{width:t.videoWidth,height:t.videoHeight}:t}var pI;(function(t){t[t.HAVE_NOTHING=0]="HAVE_NOTHING",t[t.HAVE_METADATA=1]="HAVE_METADATA",t[t.HAVE_CURRENT_DATA=2]="HAVE_CURRENT_DATA",t[t.HAVE_FUTURE_DATA=3]="HAVE_FUTURE_DATA",t[t.HAVE_ENOUGH_DATA=4]="HAVE_ENOUGH_DATA"})(pI||(pI={}));const TP=128,Vre=.5;function g_t(t,e=TP,r=e*Vre,i=0){const s=hPe(t,e,r,i);return new wS(s,{mipmap:!1,wrap:{s:Ut.CLAMP_TO_EDGE,t:Ut.CLAMP_TO_EDGE},width:e,height:e,components:4,noUnpackFlip:!0})}function hPe(t,e=TP,r=e*Vre,i=0){switch(t){case"circle":default:return y_t(e,r);case"square":return __t(e,r);case"cross":return b_t(e,r,i);case"x":return w_t(e,r,i);case"kite":return v_t(e,r);case"triangle":return x_t(e,r);case"arrow":return T_t(e,r)}}function y_t(t,e){const r=t/2-.5;return P$(t,fPe(r,r,e/2))}function __t(t,e){return dPe(t,e,!1)}function v_t(t,e){return dPe(t,e,!0)}function b_t(t,e,r=0){return pPe(t,e,!1,r)}function w_t(t,e,r=0){return pPe(t,e,!0,r)}function x_t(t,e){return P$(t,mPe(t/2,e,e/2))}function T_t(t,e){const r=e,i=e/2,s=t/2,n=.8*r,o=fPe(s,(t-e)/2-n,Math.sqrt(n*n+i*i)),a=mPe(s,r,i);return P$(t,(l,c)=>Math.max(a(l,c),-o(l,c)))}function dPe(t,e,r){return r&&(e/=Math.SQRT2),P$(t,(i,s)=>{let n=i-.5*t+.25,o=.5*t-s-.75;if(r){const a=(n+o)/Math.SQRT2;o=(o-n)/Math.SQRT2,n=a}return Math.max(Math.abs(n),Math.abs(o))-.5*e})}function pPe(t,e,r,i=0){e-=i,r&&(e*=Math.SQRT2);const s=.5*e;return P$(t,(n,o)=>{let a,l=n-.5*t,c=.5*t-o-1;if(r){const h=(l+c)/Math.SQRT2;c=(c-l)/Math.SQRT2,l=h}return l=Math.abs(l),c=Math.abs(c),a=l>c?l>s?Math.sqrt((l-s)*(l-s)+c*c):c:c>s?Math.sqrt(l*l+(c-s)*(c-s)):l,a-=i/2,a})}function fPe(t,e,r){return(i,s)=>{const n=i-t,o=s-e;return Math.sqrt(n*n+o*o)-r}}function mPe(t,e,r){const i=Math.sqrt(e*e+r*r);return(s,n)=>{const o=Math.abs(s-t)-r,a=n-t+e/2+.75,l=(e*o+r*a)/i,c=-a;return Math.max(l,c)}}function P$(t,e){const r=new Uint8Array(4*t*t);for(let i=0;i<t;i++)for(let s=0;s<t;s++){const n=s+t*i;let o=e(s,i);o=o/t+.5,xP(o,r,4*n)}return r}let Tjt=class extends ui{constructor(e){super(),this.slicePlaneLocalOrigin=e}};function S_t(t,e){gPe(t,e,new jt("slicePlaneOrigin",(r,i)=>bPe(e,r,i)),new jt("slicePlaneBasis1",(r,i)=>VU(e,r,i,i.slicePlane?.basis1)),new jt("slicePlaneBasis2",(r,i)=>VU(e,r,i,i.slicePlane?.basis2)))}function Bs(t,e){gPe(t,e,new _h("slicePlaneOrigin",(r,i)=>bPe(e,r,i)),new _h("slicePlaneBasis1",(r,i)=>VU(e,r,i,i.slicePlane?.basis1)),new _h("slicePlaneBasis2",(r,i)=>VU(e,r,i,i.slicePlane?.basis2)))}function gPe(t,e,...r){if(!e.hasSlicePlane){const o=w`#define rejectBySlice(_pos_) false
#define discardBySlice(_pos_) {}
#define highlightSlice(_color_, _pos_) (_color_)`;return e.hasSliceInVertexProgram&&t.vertex.code.add(o),void t.fragment.code.add(o)}e.hasSliceInVertexProgram&&t.vertex.uniforms.add(...r),t.fragment.uniforms.add(...r);const i=w`struct SliceFactors {
float front;
float side0;
float side1;
float side2;
float side3;
};
SliceFactors calculateSliceFactors(vec3 pos) {
vec3 rel = pos - slicePlaneOrigin;
vec3 slicePlaneNormal = -cross(slicePlaneBasis1, slicePlaneBasis2);
float slicePlaneW = -dot(slicePlaneNormal, slicePlaneOrigin);
float basis1Len2 = dot(slicePlaneBasis1, slicePlaneBasis1);
float basis2Len2 = dot(slicePlaneBasis2, slicePlaneBasis2);
float basis1Dot = dot(slicePlaneBasis1, rel);
float basis2Dot = dot(slicePlaneBasis2, rel);
return SliceFactors(
dot(slicePlaneNormal, pos) + slicePlaneW,
-basis1Dot - basis1Len2,
basis1Dot - basis1Len2,
-basis2Dot - basis2Len2,
basis2Dot - basis2Len2
);
}
bool sliceByFactors(SliceFactors factors) {
return factors.front < 0.0
&& factors.side0 < 0.0
&& factors.side1 < 0.0
&& factors.side2 < 0.0
&& factors.side3 < 0.0;
}
bool sliceEnabled() {
return dot(slicePlaneBasis1, slicePlaneBasis1) != 0.0;
}
bool sliceByPlane(vec3 pos) {
return sliceEnabled() && sliceByFactors(calculateSliceFactors(pos));
}
#define rejectBySlice(_pos_) sliceByPlane(_pos_)
#define discardBySlice(_pos_) { if (sliceByPlane(_pos_)) discard; }`,s=w`vec4 applySliceHighlight(vec4 color, vec3 pos) {
SliceFactors factors = calculateSliceFactors(pos);
const float HIGHLIGHT_WIDTH = 1.0;
const vec4 HIGHLIGHT_COLOR = vec4(0.0, 0.0, 0.0, 0.3);
factors.front /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.front);
factors.side0 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side0);
factors.side1 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side1);
factors.side2 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side2);
factors.side3 /= (2.0 * HIGHLIGHT_WIDTH) * fwidth(factors.side3);
if (sliceByFactors(factors)) {
return color;
}
float highlightFactor = (1.0 - step(0.5, factors.front))
* (1.0 - step(0.5, factors.side0))
* (1.0 - step(0.5, factors.side1))
* (1.0 - step(0.5, factors.side2))
* (1.0 - step(0.5, factors.side3));
return mix(color, vec4(HIGHLIGHT_COLOR.rgb, color.a), highlightFactor * HIGHLIGHT_COLOR.a);
}`,n=e.hasSliceHighlight?w`
        ${s}
        #define highlightSlice(_color_, _pos_) (sliceEnabled() ? applySliceHighlight(_color_, _pos_) : (_color_))
      `:w`#define highlightSlice(_color_, _pos_) (_color_)`;e.hasSliceInVertexProgram&&t.vertex.code.add(i),t.fragment.code.add(i),t.fragment.code.add(n)}function yPe(t,e,r){return t.instancedDoublePrecision?ie(E_t,r.camera.viewInverseTransposeMatrix[3],r.camera.viewInverseTransposeMatrix[7],r.camera.viewInverseTransposeMatrix[11]):e.slicePlaneLocalOrigin}function _Pe(t,e){return t!=null?pe(zU,e.origin,t):e.origin}function vPe(t,e,r){return t.hasSliceTranslatedView?e!=null?Cc(C_t,r.camera.viewMatrix,e):r.camera.viewMatrix:null}function bPe(t,e,r){if(r.slicePlane==null)return Nl;const i=yPe(t,e,r),s=_Pe(i,r.slicePlane),n=vPe(t,i,r);return n!=null?Ne(zU,s,n):s}function VU(t,e,r,i){if(i==null||r.slicePlane==null)return Nl;const s=yPe(t,e,r),n=_Pe(s,r.slicePlane),o=vPe(t,s,r);return o!=null?(ue(TR,i,n),Ne(zU,n,o),Ne(TR,TR,o),pe(TR,TR,zU)):i}const E_t=C(),zU=C(),TR=C(),C_t=xe();function $$(t,e){const r=e.output===k.ObjectAndLayerIdColor,i=e.objectAndLayerIdColorInstanced;r&&(t.varyings.add("objectAndLayerIdColorVarying","vec4"),i?t.attributes.add(E.INSTANCEOBJECTANDLAYERIDCOLOR,"vec4"):t.attributes.add(E.OBJECTANDLAYERIDCOLOR,"vec4")),t.vertex.code.add(w`
     void forwardObjectAndLayerIdColor() {
      ${r?i?w`objectAndLayerIdColorVarying = instanceObjectAndLayerIdColor * 0.003921568627451;`:w`objectAndLayerIdColorVarying = objectAndLayerIdColor * 0.003921568627451;`:w``} }`),t.fragment.code.add(w`
      void outputObjectAndLayerIdColor() {
        ${r?w`fragColor = objectAndLayerIdColorVarying;`:w``} }`)}function A_t(t,e){const{vertex:r,fragment:i}=t;r.include(R8),e.hasMultipassGeometry&&r.include(x3e),e.hasMultipassTerrain&&t.varyings.add("depth","float"),r.code.add(w`
  void main(void) {
    vec4 posProjCenter;
    if (dot(position, position) > 0.0) {
      // Render single point to center of the pixel to avoid subpixel
      // filtering to affect the marker color
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      posProjCenter = alignToPixelCenter(posProj, viewport.zw);

      ${e.hasMultipassGeometry?w`
        // Don't draw vertices behind geometry
        if(geometryDepthTest(.5 + .5 * posProjCenter.xy / posProjCenter.w, projectAux.posView.z)){
          posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
        }`:""}

      ${e.hasMultipassTerrain?"depth = projectAux.posView.z;":""}
      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        // Project out of clip space
        posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
      }

    } else {
      // Project out of clip space
      posProjCenter = vec4(1e038, 1e038, 1e038, 1.0);
    }

    gl_Position = posProjCenter;
    gl_PointSize = 1.0;
  }
  `),e.hasMultipassTerrain&&i.include(Ch),e.hasMultipassTerrain&&i.uniforms.add(new et("terrainDepthTexture",(s,n)=>n.multipassTerrain.linearDepthTexture),new Pr("nearFar",(s,n)=>n.camera.nearFar)),i.include(Pu),i.code.add(w`
  void main() {
    fragColor = vec4(1);
    ${e.hasMultipassTerrain?w`
          // Read the rgba data from the texture linear depth
          vec4 terrainDepthData = texelFetch(terrainDepthTexture, ivec2(gl_FragCoord.xy), 0);

          float terrainDepth = linearDepthFromFloat(rgba2float(terrainDepthData), nearFar);

          // If HUD vertex is behind terrain and the terrain depth is not the initialize value (e.g. we are not looking at the sky)
          // Mark the HUD vertex as occluded by transparent terrain
          if(depth < terrainDepth && terrainDepthData != vec4(0,0,0,1)){
            fragColor.g = 0.5;
          }`:""}
  }
  `)}const O_t=Vt(1,1,0,1),wPe=Vt(1,0,1,1);function J0(t){t.fragment.uniforms.add(new et("depthTexture",(e,r)=>r.highlightDepthTexture)),t.fragment.constants.add("occludedHighlightFlag","vec4",O_t).add("unoccludedHighlightFlag","vec4",wPe),t.fragment.code.add(w`void outputHighlight() {
float sceneDepth = float(texelFetch(depthTexture, ivec2(gl_FragCoord.xy), 0).x);
if (gl_FragCoord.z > sceneDepth + 5e-7) {
fragColor = occludedHighlightFlag;
} else {
fragColor = unoccludedHighlightFlag;
}
}`)}let xPe=class extends Ps{constructor(e,r,i){super(e,"vec4",ai.Pass,(s,n,o)=>s.setUniform4fv(e,r(n,o)),i)}},gc=class extends Ps{constructor(e,r,i){super(e,"float",ai.Pass,(s,n,o)=>s.setUniform1fv(e,r(n,o)),i)}};var Za,zde;(function(t){t[t.Undefined=0]="Undefined",t[t.DefinedSize=1]="DefinedSize",t[t.DefinedScale=2]="DefinedScale"})(Za||(Za={})),function(t){t[t.Undefined=0]="Undefined",t[t.DefinedAngle=1]="DefinedAngle"}(zde||(zde={}));let zre=class{constructor(e){this.field=e}},R_t=class extends zre{constructor(e){super(e),this.minSize=[0,0,0],this.maxSize=[0,0,0],this.offset=[0,0,0],this.factor=[0,0,0],this.type=[Za.Undefined,Za.Undefined,Za.Undefined]}},M_t=class extends zre{constructor(e){super(e),this.colors=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],this.values=[0,0,0,0,0,0,0,0]}},I_t=class extends zre{constructor(e){super(e),this.values=[0,0,0,0,0,0,0,0],this.opacityValues=[0,0,0,0,0,0,0,0]}},P_t=class{};function SR(t){return t!=null}function s2(t){return typeof t=="number"}function M8(t){return typeof t=="string"}function $_t(t){return t==null||M8(t)}function Ln(t,e){t&&t.push(e)}function L_t(t,e,r,i=xe()){const s=t||0,n=e||0,o=r||0;return s!==0&&pA(i,i,-s/180*Math.PI),n!==0&&dA(i,i,n/180*Math.PI),o!==0&&bV(i,i,o/180*Math.PI),i}function C_(t,e,r,i,s){const n=t.minSize,o=t.maxSize;if(t.expression)return Ln(s,"Could not convert size info: expression not supported"),!1;if(t.useSymbolValue){const a=i.symbolSize[r];return e.minSize[r]=a,e.maxSize[r]=a,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=Za.DefinedSize,!0}if(SR(t.field))return SR(t.stops)?t.stops.length===2&&s2(t.stops[0].size)&&s2(t.stops[1].size)?(Bde(t.stops[0].size,t.stops[1].size,t.stops[0].value,t.stops[1].value,e,r),e.type[r]=Za.DefinedSize,!0):(Ln(s,"Could not convert size info: stops only supported with 2 elements"),!1):s2(n)&&s2(o)&&SR(t.minDataValue)&&SR(t.maxDataValue)?(Bde(n,o,t.minDataValue,t.maxDataValue,e,r),e.type[r]=Za.DefinedSize,!0):t.valueUnit==="unknown"?(Ln(s,"Could not convert size info: proportional size not supported"),!1):LT[t.valueUnit]!=null?(e.minSize[r]=-1/0,e.maxSize[r]=1/0,e.offset[r]=0,e.factor[r]=1/LT[t.valueUnit],e.type[r]=Za.DefinedSize,!0):(Ln(s,"Could not convert size info: scale-dependent size not supported"),!1);if(!SR(t.field)){if(t.stops&&t.stops[0]&&s2(t.stops[0].size))return e.minSize[r]=t.stops[0].size,e.maxSize[r]=t.stops[0].size,e.offset[r]=e.minSize[r],e.factor[r]=0,e.type[r]=Za.DefinedSize,!0;if(s2(n))return e.minSize[r]=n,e.maxSize[r]=n,e.offset[r]=n,e.factor[r]=0,e.type[r]=Za.DefinedSize,!0}return Ln(s,"Could not convert size info: unsupported variant of sizeInfo"),!1}function Bde(t,e,r,i,s,n){const o=Math.abs(i-r)>0?(e-t)/(i-r):0;s.minSize[n]=o>0?t:e,s.maxSize[n]=o>0?e:t,s.offset[n]=t-r*o,s.factor[n]=o}function D_t(t,e,r,i){if(t.normalizationField||t.valueRepresentation)return Ln(i,"Could not convert size info: unsupported property"),null;if(!$_t(t.field))return Ln(i,"Could not convert size info: field is not a string"),null;if(e.size){if(t.field)if(e.size.field){if(t.field!==e.size.field)return Ln(i,"Could not convert size info: multiple fields in use"),null}else e.size.field=t.field}else e.size=new R_t(t.field);let s;switch(t.axis){case"width":return s=C_(t,e.size,0,r,i),s?e:null;case"height":return s=C_(t,e.size,2,r,i),s?e:null;case"depth":return s=C_(t,e.size,1,r,i),s?e:null;case"width-and-depth":return s=C_(t,e.size,0,r,i),s&&C_(t,e.size,1,r,i),s?e:null;case null:case void 0:case"all":return s=C_(t,e.size,0,r,i),s=s&&C_(t,e.size,1,r,i),s=s&&C_(t,e.size,2,r,i),s?e:null;default:return Ln(i,`Could not convert size info: unknown axis "${t.axis}""`),null}}function N_t(t,e,r){for(let s=0;s<3;++s){let n=e.unitInMeters;t.type[s]===Za.DefinedSize&&(n*=e.modelSize[s],t.type[s]=Za.DefinedScale),t.minSize[s]=t.minSize[s]/n,t.maxSize[s]=t.maxSize[s]/n,t.offset[s]=t.offset[s]/n,t.factor[s]=t.factor[s]/n}let i;if(t.type[0]!==Za.Undefined)i=0;else if(t.type[1]!==Za.Undefined)i=1;else{if(t.type[2]===Za.Undefined)return Ln(r,"No size axis contains a valid size or scale"),!1;i=2}for(let s=0;s<3;++s)t.type[s]===Za.Undefined&&(t.minSize[s]=t.minSize[i],t.maxSize[s]=t.maxSize[i],t.offset[s]=t.offset[i],t.factor[s]=t.factor[i],t.type[s]=t.type[i]);return!0}function Gde(t,e,r){t[4*e]=r.r/255,t[4*e+1]=r.g/255,t[4*e+2]=r.b/255,t[4*e+3]=r.a}function F_t(t,e,r){if(t.normalizationField)return Ln(r,"Could not convert color info: unsupported property"),null;if(M8(t.field)){if(!t.stops)return Ln(r,"Could not convert color info: missing stops or colors"),null;{if(t.stops.length>8)return Ln(r,"Could not convert color info: too many color stops"),null;e.color=new M_t(t.field);const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.color.values[s]=n.value,Gde(e.color.colors,s,n.color)}}}else{if(!(t.stops&&t.stops.length>=0))return Ln(r,"Could not convert color info: no field and no colors/stops"),null;{const i=t.stops&&t.stops.length>=0&&t.stops[0].color;e.color={field:null,values:[0,0,0,0,0,0,0,0],colors:[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.color.values[s]=1/0,Gde(e.color.colors,s,i)}}return e}function k_t(t,e,r){if(t.normalizationField)return Ln(r,"Could not convert opacity info: unsupported property"),null;if(M8(t.field)){if(!t.stops)return Ln(r,"Could not convert opacity info: missing stops or opacities"),null;{if(t.stops.length>8)return Ln(r,"Could not convert opacity info: too many opacity stops"),null;e.opacity=new I_t(t.field);const i=t.stops;for(let s=0;s<8;++s){const n=i[Math.min(s,i.length-1)];e.opacity.values[s]=n.value,e.opacity.opacityValues[s]=n.opacity}}}else{if(!(t.stops&&t.stops.length>=0))return Ln(r,"Could not convert opacity info: no field and no opacities/stops"),null;{const i=t.stops&&t.stops.length>=0?t.stops[0].opacity:0;e.opacity={field:null,values:[0,0,0,0,0,0,0,0],opacityValues:[0,0,0,0,0,0,0,0]};for(let s=0;s<8;s++)e.opacity.values[s]=1/0,e.opacity.opacityValues[s]=i}}return e}function BB(t,e,r){const i=r===2&&t.rotationType==="arithmetic";e.offset[r]=i?90:0,e.factor[r]=i?-1:1,e.type[r]=1}function U_t(t,e,r){if(!M8(t.field))return Ln(r,"Could not convert rotation info: field is not a string"),null;if(e.rotation){if(t.field)if(e.rotation.field){if(t.field!==e.rotation.field)return Ln(r,"Could not convert rotation info: multiple fields in use"),null}else e.rotation.field=t.field}else e.rotation={field:t.field,offset:[0,0,0],factor:[1,1,1],type:[0,0,0]};switch(t.axis){case"tilt":return BB(t,e.rotation,0),e;case"roll":return BB(t,e.rotation,1),e;case null:case void 0:case"heading":return BB(t,e.rotation,2),e;default:return Ln(r,`Could not convert rotation info: unknown axis "${t.axis}""`),null}}let L$=class{constructor(e,r=[1,1,1],i=[1,1,1],s=1,n=[0,0,0],o=[1,1,1],a=[0,0,0]){this.supports=e,this.modelSize=r,this.symbolSize=i,this.unitInMeters=s,this.anchor=n,this.scale=o,this.rotation=a}};function TPe(t,e,r){if(!t)return null;const i=t.reduce((s,n)=>{if(!s)return s;if(n.valueExpression)return Ln(r,"Could not convert visual variables: arcade expressions not supported"),null;switch(n.type){case"size":return e.supports.size?D_t(n,s,e,r):s;case"color":return e.supports.color?F_t(n,s,r):s;case"opacity":return e.supports.opacity?k_t(n,s,r):null;case"rotation":return e.supports.rotation?U_t(n,s,r):s;default:return null}},new P_t);return!(t.length>0&&i)||i.size||i.color||i.opacity||i.rotation?i&&i.size&&!N_t(i.size,e,r)?null:i:null}let V_t=class{constructor(e,r,i){this.visualVariables=e,this.materialParameters=r,this.requiresShaderTransformation=i}};function kA(t,e){if(!t||bi.TESTS_DISABLE_FAST_UPDATES)return null;const r=TPe(t.visualVariables,e);return r?new V_t(r,EPe(r,e),!!r.size):null}function UA(t,e,r){if(!e||!t)return!1;const i=t.visualVariables,s=TPe(e.visualVariables,r);return!!s&&!!(aN(i.size,s.size,"size")&&aN(i.color,s.color,"color")&&aN(i.rotation,s.rotation,"rotation")&&aN(i.opacity,s.opacity,"opacity"))&&(t.visualVariables=s,t.materialParameters=EPe(s,r),t.requiresShaderTransformation=!!s.size,!0)}function aN(t,e,r){if(!!t!=!!e||t&&t.field!==e?.field)return!1;if(t&&r==="rotation"){const i=t,s=e;for(let n=0;n<3;n++)if(i.type[n]!==s.type[n]||i.offset[n]!==s.offset[n]||i.factor[n]!==s.factor[n])return!1}return!0}let SPe=class extends ui{constructor(e){super(),this.vvSize=e?.size??null,this.vvColor=e?.color??null,this.vvOpacity=e?.opacity??null}};function EPe(t,e){const r=new SPe(t);return r.vvSize&&(r.vvSymbolAnchor=e.anchor,jd(fI),L_t(e.rotation[2],e.rotation[0],e.rotation[1],fI),r.vvSymbolRotationMatrix=r.vvSymbolRotationMatrix||ts(),qd(r.vvSymbolRotationMatrix,fI)),r}function CY(t,e,r){if(!t.vvSize)return r;an(A_,r);const i=t.vvSymbolRotationMatrix;Dg(fI,i[0],i[1],i[2],0,i[3],i[4],i[5],0,i[6],i[7],i[8],0,0,0,0,1),yi(A_,A_,fI);for(let s=0;s<3;++s){const n=t.vvSize.offset[s]+e[0]*t.vvSize.factor[s];jde[s]=ye(n,t.vvSize.minSize[s],t.vvSize.maxSize[s])}return vV(A_,A_,jde),Cc(A_,A_,t.vvSymbolAnchor),A_}function z_t(t,e,r){if(e.vvSize)for(let i=0;i<3;++i){const s=e.vvSize.offset[i]+r[0]*e.vvSize.factor[i];t[i]=ye(s,e.vvSize.minSize[i],e.vvSize.maxSize[i])}else ie(t,1,1,1)}function Sf(t,e){const r=t==null?0:e.attributes[t];return typeof r=="number"&&isFinite(r)?r:0}const A_=xe(),jde=C(),fI=xe();let D$=class extends SPe{constructor(){super(...arguments),this.renderOccluded=Qi.Occlude}};const GC=8;function y0(t,e){const{vertex:r,attributes:i}=t;e.hasVvInstancing&&(e.vvSize||e.vvColor)&&i.add(E.INSTANCEFEATUREATTRIBUTE,"vec4"),e.vvSize?(r.uniforms.add(new jt("vvSizeMinSize",s=>s.vvSize.minSize)),r.uniforms.add(new jt("vvSizeMaxSize",s=>s.vvSize.maxSize)),r.uniforms.add(new jt("vvSizeOffset",s=>s.vvSize.offset)),r.uniforms.add(new jt("vvSizeFactor",s=>s.vvSize.factor)),r.uniforms.add(new tp("vvSymbolRotationMatrix",s=>s.vvSymbolRotationMatrix)),r.uniforms.add(new jt("vvSymbolAnchor",s=>s.vvSymbolAnchor)),r.code.add(w`vec3 vvScale(vec4 _featureAttribute) {
return clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize);
}
vec4 vvTransformPosition(vec3 position, vec4 _featureAttribute) {
return vec4(vvSymbolRotationMatrix * ( vvScale(_featureAttribute) * (position + vvSymbolAnchor)), 1.0);
}`),r.code.add(w`
      const float eps = 1.192092896e-07;
      vec4 vvTransformNormal(vec3 _normal, vec4 _featureAttribute) {
        vec3 vvScale = clamp(vvSizeOffset + _featureAttribute.x * vvSizeFactor, vvSizeMinSize + eps, vvSizeMaxSize);
        return vec4(vvSymbolRotationMatrix * _normal / vvScale, 1.0);
      }

      ${e.hasVvInstancing?w`
      vec4 vvLocalNormal(vec3 _normal) {
        return vvTransformNormal(_normal, instanceFeatureAttribute);
      }

      vec4 localPosition() {
        return vvTransformPosition(position, instanceFeatureAttribute);
      }`:""}
    `)):r.code.add(w`vec4 localPosition() { return vec4(position, 1.0); }
vec4 vvLocalNormal(vec3 _normal) { return vec4(_normal, 1.0); }`),e.vvColor?(r.constants.add("vvColorNumber","int",GC),r.uniforms.add(new gc("vvColorValues",s=>s.vvColor.values,GC),new xPe("vvColorColors",s=>s.vvColor.colors,GC)),r.code.add(w`
      vec4 interpolateVVColor(float value) {
        if (value <= vvColorValues[0]) {
          return vvColorColors[0];
        }

        for (int i = 1; i < vvColorNumber; ++i) {
          if (vvColorValues[i] >= value) {
            float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
            return mix(vvColorColors[i-1], vvColorColors[i], f);
          }
        }
        return vvColorColors[vvColorNumber - 1];
      }

      vec4 vvGetColor(vec4 featureAttribute) {
        return interpolateVVColor(featureAttribute.y);
      }

      ${e.hasVvInstancing?w`
            vec4 vvColor() {
              return vvGetColor(instanceFeatureAttribute);
            }`:"vec4 vvColor() { return vec4(1.0); }"}
    `)):r.code.add(w`vec4 vvColor() { return vec4(1.0); }`)}const BU=.1,ia=.001;function B_t(t){const e=new Cr,r=t.signedDistanceFieldEnabled;if(e.include(jIe,t),e.include(Bs,t),t.occlusionPass)return e.include(A_t,t),e;const{vertex:i,fragment:s}=e;e.include(Mre),s.include(Pu),s.include(kg),e.include(y0,t),e.include($$,t),e.varyings.add("vcolor","vec4"),e.varyings.add("vtc","vec2"),e.varyings.add("vsize","vec2"),t.binaryHighlightOcclusionEnabled&&e.varyings.add("voccluded","float"),i.uniforms.add(new cr("viewport",(c,h)=>h.camera.fullViewport),new Pr("screenOffset",(c,h)=>hr(CPe,2*c.screenOffset[0]*h.camera.pixelRatio,2*c.screenOffset[1]*h.camera.pixelRatio)),new Pr("anchorPosition",c=>GU(c)),new cr("materialColor",c=>c.color)),MO(i,t),r&&(i.uniforms.add(new cr("outlineColor",c=>c.outlineColor)),s.uniforms.add(new cr("outlineColor",c=>Hde(c)?c.outlineColor:ng),new Ie("outlineSize",c=>Hde(c)?c.outlineSize:0))),t.hasScreenSizePerspective&&(M0t(i),O8(i)),(t.debugDrawLabelBorder||t.binaryHighlightOcclusionEnabled)&&e.varyings.add("debugBorderCoords","vec4"),e.attributes.add(E.UV0,"vec2"),e.attributes.add(E.COLOR,"vec4"),e.attributes.add(E.SIZE,"vec2"),e.attributes.add(E.AUXPOS2,"vec4"),i.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 posProj = projectPositionHUD(projectAux);
      forwardObjectAndLayerIdColor();

      if (rejectBySlice(projectAux.posModel)) {
        // Project outside of clip plane
        gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
        return;
      }
      vec2 inputSize;
      ${t.hasScreenSizePerspective?w`
      inputSize = screenSizePerspectiveScaleVec2(size, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspective);
      vec2 screenOffsetScaled = screenSizePerspectiveScaleVec2(screenOffset, projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
         `:w`
      inputSize = size;
      vec2 screenOffsetScaled = screenOffset;`}

      ${t.vvSize?"inputSize *= vvScale(auxpos2).xx;":""}

      vec2 combinedSize = inputSize * pixelRatio;
      vec4 quadOffset = vec4(0.0);

      ${t.occlusionTestEnabled||t.binaryHighlightOcclusionEnabled?"bool visible = testVisibilityHUD(posProj);":""}

      ${t.binaryHighlightOcclusionEnabled?"voccluded = visible ? 0.0 : 1.0;":""}
    `);const n=w`vec2 uv01 = floor(uv0);
vec2 uv = uv0 - uv01;
quadOffset.xy = ((uv01 - anchorPosition) * 2.0 * combinedSize + screenOffsetScaled) / viewport.zw * posProj.w;`;t.pixelSnappingEnabled&&i.include(R8);const o=t.pixelSnappingEnabled?r?w`posProj = alignToPixelOrigin(posProj, viewport.zw) + quadOffset;`:w`posProj += quadOffset;
if (inputSize.x == size.x) {
posProj = alignToPixelOrigin(posProj, viewport.zw);
}`:w`posProj += quadOffset;`;i.code.add(w`
    ${t.occlusionTestEnabled?"if (visible) {":""}
    ${n}
    ${t.vvColor?"vcolor = interpolateVVColor(auxpos2.y) * materialColor;":"vcolor = color / 255.0 * materialColor;"}

    ${t.output===k.ObjectAndLayerIdColor?w`vcolor.a = 1.0;`:""}

    bool alphaDiscard = vcolor.a < ${w.float(ia)};
    ${r?`alphaDiscard = alphaDiscard && outlineColor.a < ${w.float(ia)};`:""}
    if (alphaDiscard) {
      // "early discard" if both symbol color (= fill) and outline color (if applicable) are transparent
      gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
      return;
    } else {
      ${o}
      gl_Position = posProj;
    }

    vtc = uv;

    ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(uv01, 1.5 / combinedSize);":""}
    vsize = inputSize;
    ${t.occlusionTestEnabled?w`} else { vtc = vec2(0.0);
      ${t.debugDrawLabelBorder?"debugBorderCoords = vec4(0.5, 0.5, 1.5 / combinedSize);}":"}"}`:""}
  }
  `),s.uniforms.add(new et("tex",c=>c.texture));const a=t.debugDrawLabelBorder?w`(isBorder > 0.0 ? 0.0 : ${w.float(BU)})`:w.float(BU),l=w`
    ${t.debugDrawLabelBorder?w`
      float isBorder = float(any(lessThan(debugBorderCoords.xy, debugBorderCoords.zw)) || any(greaterThan(debugBorderCoords.xy, 1.0 - debugBorderCoords.zw)));`:""}

    ${r?w`
      vec4 fillPixelColor = vcolor;

      // Attempt to sample texel centers to avoid that thin cross outlines
      // disappear with large symbol sizes.
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/7058#issuecomment-603041
      const float txSize = ${w.float(TP)};
      const float texelSize = 1.0 / txSize;
      // Calculate how much we have to add/subtract to/from each texel to reach the size of an onscreen pixel
      vec2 scaleFactor = (vsize - txSize) * texelSize;
      vec2 samplePos = vtc + (vec2(1.0, -1.0) * texelSize) * scaleFactor;

      // Get distance and map it into [-0.5, 0.5]
      float d = rgba2float(texture(tex, samplePos)) - 0.5;

      // Distance in output units (i.e. pixels)
      float dist = d * vsize.x;

      // Create smooth transition from the icon into its outline
      float fillAlphaFactor = clamp(0.5 - dist, 0.0, 1.0);
      fillPixelColor.a *= fillAlphaFactor;

      if (outlineSize > 0.25) {
        vec4 outlinePixelColor = outlineColor;
        float clampedOutlineSize = min(outlineSize, 0.5*vsize.x);

        // Create smooth transition around outline
        float outlineAlphaFactor = clamp(0.5 - (abs(dist) - 0.5*clampedOutlineSize), 0.0, 1.0);
        outlinePixelColor.a *= outlineAlphaFactor;

        if (
          outlineAlphaFactor + fillAlphaFactor < ${a} ||
          fillPixelColor.a + outlinePixelColor.a < ${w.float(ia)}
        ) {
          discard;
        }

        // perform un-premultiplied over operator (see https://en.wikipedia.org/wiki/Alpha_compositing#Description)
        float compositeAlpha = outlinePixelColor.a + fillPixelColor.a * (1.0 - outlinePixelColor.a);
        vec3 compositeColor = vec3(outlinePixelColor) * outlinePixelColor.a +
          vec3(fillPixelColor) * fillPixelColor.a * (1.0 - outlinePixelColor.a);

        fragColor = vec4(compositeColor, compositeAlpha);
      } else {
        if (fillAlphaFactor < ${a}) {
          discard;
        }

        fragColor = premultiplyAlpha(fillPixelColor);
      }

      // visualize SDF:
      // fragColor = vec4(clamp(-dist/vsize.x*2.0, 0.0, 1.0), clamp(dist/vsize.x*2.0, 0.0, 1.0), 0.0, 1.0);
      `:w`
          vec4 texColor = texture(tex, vtc, -0.5);
          if (texColor.a < ${a}) {
            discard;
          }
          fragColor = texColor * premultiplyAlpha(vcolor);
          `}

    // Draw debug border with transparency, so that original texels along border are still partially visible
    ${t.debugDrawLabelBorder?w`fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), isBorder * 0.5);`:""}
  `;return t.output===k.Alpha&&s.code.add(w`
      void main() {
        ${l}
        fragColor = vec4(fragColor.a);
      }
      `),t.output===k.ObjectAndLayerIdColor&&s.code.add(w`
      void main() {
        ${l}
        outputObjectAndLayerIdColor();
      }
      `),t.output===k.Color&&s.code.add(w`
    void main() {
      ${l}
      ${t.transparencyPassType===ut.FrontFace?"fragColor.rgb /= fragColor.a;":""}
    }
    `),t.output===k.Highlight&&(e.include(J0,t),s.code.add(w`
    void main() {
      ${l}
      ${t.binaryHighlightOcclusionEnabled?w`
          if (voccluded == 1.0) {
            fragColor = vec4(1.0, 1.0, 0.0, 1.0);
          } else {
            fragColor = vec4(1.0, 0.0, 1.0, 1.0);
          }`:"outputHighlight();"}
    }
    `)),e}function Hde(t){return t.outlineColor[3]>0&&t.outlineSize>0}function GU(t,e=CPe){return t.textureIsSignedDistanceField?G_t(t.anchorPosition,t.distanceFieldBoundingBox,e):jn(e,t.anchorPosition),e}function G_t(t,e,r){e!=null?hr(r,t[0]*(e[2]-e[0])+e[0],t[1]*(e[3]-e[1])+e[1]):hr(r,0,0)}const CPe=Pe(),j_t=Object.freeze(Object.defineProperty({__proto__:null,build:B_t,calculateAnchorPosForRendering:GU},Symbol.toStringTag,{value:"Module"})),vh=ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),H_t=Ru(Te.ONE,Te.ONE),APe=Ru(Te.ZERO,Te.ONE_MINUS_SRC_ALPHA);function Q0(t){return t===ut.FrontFace?null:t===ut.Alpha?APe:H_t}function I8(t){return t===ut.FrontFace?Ac:null}const P8=5e5,$8={factor:-1,units:-2};function L8(t){return t?$8:null}function gb(t,e=ci.LESS){return t===ut.NONE||t===ut.FrontFace?e:ci.LEQUAL}let OPe=class RPe extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global}initializeProgram(e){return new Lr(e.rctx,RPe.shader.get().build(this.configuration),Er)}_setPipelineState(e){const r=this.configuration,i=e===ut.NONE,s=e===ut.FrontFace,n=this.configuration.hasPolygonOffset?q_t:null,o=(i||s)&&r.output!==k.Highlight&&(r.depthEnabled||r.occlusionPass)?Ac:null;return It({blending:r.output===k.Color||r.output===k.Alpha||r.output===k.Highlight?i?W_t:Q0(e):null,depthTest:{func:ci.LEQUAL},depthWrite:o,colorWrite:Wt,polygonOffset:n})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}get primitiveType(){return this.configuration.occlusionPass?Ot.POINTS:Ot.TRIANGLES}};OPe.shader=new $r(j_t,()=>J(()=>import("./HUDMaterial.glsl-9d963c6a.js"),[],import.meta.url));const q_t={factor:0,units:-4},W_t=Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA);let Xs=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.screenCenterOffsetUnitsEnabled=mc.World,this.transparencyPassType=ut.NONE,this.spherical=!1,this.occlusionTestEnabled=!0,this.signedDistanceFieldEnabled=!1,this.vvSize=!1,this.vvColor=!1,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.debugDrawLabelBorder=!1,this.binaryHighlightOcclusionEnabled=!0,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.depthEnabled=!0,this.pixelSnappingEnabled=!0,this.draped=!1,this.hasMultipassGeometry=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.occlusionPass=!1,this.objectAndLayerIdColorInstanced=!1}};u([B({count:k.COUNT})],Xs.prototype,"output",void 0),u([B({count:mc.COUNT})],Xs.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([B({count:ut.COUNT})],Xs.prototype,"transparencyPassType",void 0),u([B()],Xs.prototype,"spherical",void 0),u([B()],Xs.prototype,"occlusionTestEnabled",void 0),u([B()],Xs.prototype,"signedDistanceFieldEnabled",void 0),u([B()],Xs.prototype,"vvSize",void 0),u([B()],Xs.prototype,"vvColor",void 0),u([B()],Xs.prototype,"hasVerticalOffset",void 0),u([B()],Xs.prototype,"hasScreenSizePerspective",void 0),u([B()],Xs.prototype,"debugDrawLabelBorder",void 0),u([B()],Xs.prototype,"binaryHighlightOcclusionEnabled",void 0),u([B()],Xs.prototype,"hasSlicePlane",void 0),u([B()],Xs.prototype,"hasPolygonOffset",void 0),u([B()],Xs.prototype,"depthEnabled",void 0),u([B()],Xs.prototype,"pixelSnappingEnabled",void 0),u([B()],Xs.prototype,"draped",void 0),u([B()],Xs.prototype,"hasMultipassGeometry",void 0),u([B()],Xs.prototype,"hasMultipassTerrain",void 0),u([B()],Xs.prototype,"cullAboveGround",void 0),u([B()],Xs.prototype,"occlusionPass",void 0),u([B()],Xs.prototype,"objectAndLayerIdColorInstanced",void 0),u([B({constValue:!0})],Xs.prototype,"hasSliceInVertexProgram",void 0),u([B({constValue:!1})],Xs.prototype,"hasVvInstancing",void 0);let VA=class extends mb{constructor(e){super(e,new ivt),this._configuration=new Xs}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVerticalOffset=!!this.parameters.verticalOffset,this._configuration.hasScreenSizePerspective=!!this.parameters.screenSizePerspective,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?mc.Screen:mc.World,this._configuration.hasPolygonOffset=this.parameters.polygonOffset,this._configuration.draped=this.parameters.isDraped,this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.pixelSnappingEnabled=this.parameters.pixelSnappingEnabled,this._configuration.signedDistanceFieldEnabled=this.parameters.textureIsSignedDistanceField,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.occlusionPass=r.slot===fe.OCCLUSION_PIXELS&&this.parameters.occlusionTest&&(e===k.Color||e===k.Alpha),e===k.Color&&(this._configuration.debugDrawLabelBorder=!!bi.LABELS_SHOW_BORDER),e===k.Highlight&&(this._configuration.binaryHighlightOcclusionEnabled=this.parameters.binaryHighlightOcclusion),this._configuration.depthEnabled=this.parameters.depthEnabled,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!i.options.hud||!e.visible)return;const a=this.parameters;let l=1,c=1;if(qd(jB,r),e.shaderTransformer!=null){const x=e.shaderTransformer(Zde);l=x[0],c=x[5],Y_t(jB)}const h=e.vertexAttributes.get(E.POSITION),p=e.vertexAttributes.get(E.SIZE),f=e.vertexAttributes.get(E.NORMAL),m=e.vertexAttributes.get(E.AUXPOS1);it(h.size>=3);const g=i.point,_=i.camera,v=GU(a);l*=_.pixelRatio,c*=_.pixelRatio;const b=this.parameters.centerOffsetUnits==="screen";for(let x=0;x<h.data.length/h.size;x++){const T=x*h.size;ie(Na,h.data[T],h.data[T+1],h.data[T+2]),Ne(Na,Na,r);const S=x*p.size;O_[0]=p.data[S]*l,O_[1]=p.data[S+1]*c,Ne(Na,Na,_.viewMatrix);const O=x*m.size;if(ie(Uu,m.data[O],m.data[O+1],m.data[O+2]),!b&&(Na[0]+=Uu[0],Na[1]+=Uu[1],Uu[2]!==0)){const M=Uu[2];_e(Uu,Na),pe(Na,Na,ae(Uu,Uu,M))}const A=x*f.size;if(ie(ER,f.data[A],f.data[A+1],f.data[A+2]),this._normalAndViewAngle(ER,jB,_,HB),this._applyVerticalOffsetTransformationView(Na,HB,_,GB),_.applyProjection(Na,fl),fl[0]>-1){fl[0]=Math.floor(fl[0]),fl[1]=Math.floor(fl[1]),b&&(Uu[0]||Uu[1])&&(fl[0]+=Uu[0],Uu[1]!==0&&(fl[1]+=Rre(Uu[1],GB.factorAlignment)),_.unapplyProjection(fl,Na)),fl[0]+=this.parameters.screenOffset[0],fl[1]+=this.parameters.screenOffset[1],DIe(O_,GB.factor,O_);const M=evt*_.pixelRatio;let P=0;if(a.textureIsSignedDistanceField&&(P=a.outlineSize*_.pixelRatio/2),g&&qde(g,fl[0],fl[1],O_,M,P,a,v)){const F=i.ray;if(Ne(Wde,Na,so(K_t,_.viewMatrix)),fl[0]=g[0],fl[1]=g[1],_.unprojectFromRenderScreen(fl,Na)){const $=C();oe($,F.direction);const N=1/Oe($);ae($,$,N),o(_i(F.origin,Na)*N,$,-1,!0,1,Wde)}}}}}intersectDraped(e,r,i,s,n,o){const a=e.vertexAttributes.get(E.POSITION),l=e.vertexAttributes.get(E.SIZE),c=this.parameters,h=GU(c);let p=1,f=1;if(e.shaderTransformer!=null){const g=e.shaderTransformer(Zde);p=g[0],f=g[5]}p*=e.screenToWorldRatio,f*=e.screenToWorldRatio;const m=tvt*e.screenToWorldRatio;for(let g=0;g<a.data.length/a.size;g++){const _=g*a.size,v=a.data[_],b=a.data[_+1],x=g*l.size;O_[0]=l.data[x]*p,O_[1]=l.data[x+1]*f;let T=0;c.textureIsSignedDistanceField&&(T=c.outlineSize*e.screenToWorldRatio/2),qde(s,v,b,O_,m,T,c,h)&&n(o.dist,o.normal,-1,!1)}}createBufferWriter(){return new nvt(this)}_normalAndViewAngle(e,r,i,s){return R0t(r)&&(r=qd(Q_t,r)),yu(s.normal,e,r),Ne(s.normal,s.normal,i.viewInverseTransposeMatrix),s.cosAngle=de(MPe,rvt),s}_updateScaleInfo(e,r,i){const s=this.parameters;s.screenSizePerspective!=null?Pde(i,r,s.screenSizePerspective,e.factor):(e.factor.scale=1,e.factor.factor=0,e.factor.minPixelSize=0,e.factor.paddingPixels=0),s.screenSizePerspectiveAlignment!=null?Pde(i,r,s.screenSizePerspectiveAlignment,e.factorAlignment):(e.factorAlignment.factor=e.factor.factor,e.factorAlignment.scale=e.factor.scale,e.factorAlignment.minPixelSize=e.factor.minPixelSize,e.factorAlignment.paddingPixels=e.factor.paddingPixels)}applyShaderOffsetsView(e,r,i,s,n,o,a){const l=this._normalAndViewAngle(r,i,n,HB);return this._applyVerticalGroundOffsetView(e,l,n,a),this._applyVerticalOffsetTransformationView(a,l,n,o),this._applyPolygonOffsetView(a,l,s[3],n,a),this._applyCenterOffsetView(a,s,a),a}applyShaderOffsetsNDC(e,r,i,s,n){return this._applyCenterOffsetNDC(e,r,i,s),n!=null&&oe(n,s),this._applyPolygonOffsetNDC(s,r,i,s),s}_applyPolygonOffsetView(e,r,i,s,n){const o=s.aboveGround?1:-1;let a=Math.sign(i);a===0&&(a=o);const l=o*a;if(this.parameters.shaderPolygonOffset<=0)return oe(n,e);const c=ye(Math.abs(r.cosAngle),.01,1),h=1-Math.sqrt(1-c*c)/c/s.viewport[2];return ae(n,e,l>0?h:1/h),n}_applyVerticalGroundOffsetView(e,r,i,s){const n=Oe(e),o=i.aboveGround?1:-1,a=.5*i.computeRenderPixelSizeAtDist(n),l=ae(Na,r.normal,o*a);return ue(s,e,l),s}_applyVerticalOffsetTransformationView(e,r,i,s){const n=this.parameters;if(!n.verticalOffset||!n.verticalOffset.screenLength){if(n.screenSizePerspective||n.screenSizePerspectiveAlignment){const c=Oe(e);this._updateScaleInfo(s,c,r.cosAngle)}else s.factor.scale=1,s.factorAlignment.scale=1;return e}const o=Oe(e),a=n.screenSizePerspectiveAlignment??n.screenSizePerspective,l=XIe(i,o,n.verticalOffset,r.cosAngle,a);return this._updateScaleInfo(s,o,r.cosAngle),ae(r.normal,r.normal,l),ue(e,e,r.normal)}_applyCenterOffsetView(e,r,i){const s=this.parameters.centerOffsetUnits!=="screen";return i!==e&&oe(i,e),s&&(i[0]+=r[0],i[1]+=r[1],r[2]&&(_e(ER,i),ue(i,i,ae(ER,ER,r[2])))),i}_applyCenterOffsetNDC(e,r,i,s){const n=this.parameters.centerOffsetUnits!=="screen";return s!==e&&oe(s,e),n||(s[0]+=r[0]/i.fullWidth*2,s[1]+=r[1]/i.fullHeight*2),s}_applyPolygonOffsetNDC(e,r,i,s){const n=this.parameters.shaderPolygonOffset;if(e!==s&&oe(s,e),n){const o=i.aboveGround?1:-1,a=o*Math.sign(r[3]);s[2]-=(a||o)*n}return s}requiresSlot(e,r){if(r===k.Color||r===k.Alpha||r===k.Highlight||r===k.ObjectAndLayerIdColor){if(e===fe.DRAPED_MATERIAL)return!0;const{drawInSecondSlot:i,occlusionTest:s}=this.parameters;return e===(i?fe.LABEL_MATERIAL:fe.HUD_MATERIAL)||s&&e===fe.OCCLUSION_PIXELS}return!1}createGLMaterial(e){return new Z_t(e)}calculateRelativeScreenBounds(e,r,i=Ht()){return X_t(this.parameters,e,r,i),i[2]=i[0]+e[0],i[3]=i[1]+e[1],i}},Z_t=class extends zte{constructor(e){super({...e,...e.material.parameters})}selectProgram(e){return this.ensureTechnique(OPe,e)}beginSlot(e){return this.updateTexture(this._material.parameters.textureId),this._material.setParameters(this.textureBindParameters),this.selectProgram(e)}};function X_t(t,e,r,i=J_t){return jn(i,t.anchorPosition),i[0]*=-e[0],i[1]*=-e[1],i[0]+=t.screenOffset[0]*r,i[1]+=t.screenOffset[1]*r,i}function Y_t(t){const e=t[0],r=t[1],i=t[2],s=t[3],n=t[4],o=t[5],a=t[6],l=t[7],c=t[8],h=1/Math.sqrt(e*e+r*r+i*i),p=1/Math.sqrt(s*s+n*n+o*o),f=1/Math.sqrt(a*a+l*l+c*c);return t[0]=e*h,t[1]=r*h,t[2]=i*h,t[3]=s*p,t[4]=n*p,t[5]=o*p,t[6]=a*f,t[7]=l*f,t[8]=c*f,t}function qde(t,e,r,i,s,n,o,a){let l=e-s-(a[0]>0?i[0]*a[0]:0),c=l+i[0]+2*s,h=r-s-(a[1]>0?i[1]*a[1]:0),p=h+i[1]+2*s;const f=o.distanceFieldBoundingBox;return o.textureIsSignedDistanceField&&f!=null&&(l+=i[0]*f[0],h+=i[1]*f[1],c-=i[0]*(1-f[2]),p-=i[1]*(1-f[3]),l-=n,c+=n,h-=n,p+=n),t[0]>l&&t[0]<c&&t[1]>h&&t[1]<p}const GB=new KIe,J_t=Pe(),Na=C(),ER=C(),fl=Qt(),MPe=C(),Wde=C(),jB=ts(),Q_t=ts(),K_t=xe(),Uu=C(),HB={normal:MPe,cosAngle:0},Zde=xe(),evt=1,tvt=2,O_=[0,0],rvt=Ee(0,0,1);let ivt=class extends d3e{constructor(){super(...arguments),this.renderOccluded=Qi.Occlude,this.color=Vt(1,1,1,1),this.texCoordScale=[1,1],this.polygonOffset=!1,this.anchorPosition=yr(.5,.5),this.screenOffset=[0,0],this.shaderPolygonOffset=1e-5,this.textureIsSignedDistanceField=!1,this.outlineColor=Vt(1,1,1,1),this.outlineSize=0,this.vvSizeEnabled=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.hasSlicePlane=!1,this.pixelSnappingEnabled=!0,this.occlusionTest=!0,this.binaryHighlightOcclusion=!0,this.centerOffsetUnits="world",this.drawInSecondSlot=!1,this.depthEnabled=!0,this.isDraped=!1}};const IPe=us().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4u8(E.COLOR).vec2f(E.SIZE).vec4f(E.AUXPOS1).vec4f(E.AUXPOS2),svt=IPe.clone().vec4u8(E.OBJECTANDLAYERIDCOLOR);let nvt=class{constructor(e){this._material=e,this.vertexBufferLayout=le("enable-feature:objectAndLayerId-rendering")?svt:IPe}elementCount(e){return 6*e.indices.get(E.POSITION).length}write(e,r,i,s,n){Nre(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,e,s.position,n,6),Fre(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,r,s.normal,n,6);const o=i.vertexAttributes.get(E.UV0).data;let a,l,c,h;if(o==null||o.length<4){const b=this._material.parameters;a=0,l=0,c=b.texCoordScale[0],h=b.texCoordScale[1]}else a=o[0],l=o[1],c=o[2],h=o[3];c=Math.min(1.99999,c+1),h=Math.min(1.99999,h+1);let p=i.indices.get(E.POSITION).length,f=n;const m=s.uv0;for(let b=0;b<p;++b)m.set(f,0,a),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,l),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,c),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,h),f+=1,m.set(f,0,a),m.set(f,1,l),f+=1;tPe(i.indices.get(E.COLOR),i.vertexAttributes.get(E.COLOR).data,4,s.color,n,6);const g=i.indices.get(E.SIZE),_=i.vertexAttributes.get(E.SIZE).data;p=g.length;const v=s.size;f=n;for(let b=0;b<p;++b){const x=_[2*g[b]],T=_[2*g[b]+1];for(let S=0;S<6;++S)v.set(f,0,x),v.set(f,1,T),f+=1}if(i.indices.get(E.AUXPOS1)&&i.vertexAttributes.get(E.AUXPOS1)?FA(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,s.auxpos1,n,6):Vde(s.auxpos1,n,6*p),i.indices.get(E.AUXPOS2)&&i.vertexAttributes.get(E.AUXPOS2)?FA(i.indices.get(E.AUXPOS2),i.vertexAttributes.get(E.AUXPOS2).data,s.auxpos2,n,6):Vde(s.auxpos2,n,6*p),i.objectAndLayerIdColor!=null&&i.indices.get(E.POSITION)){const b=i.indices.get(E.POSITION).length,x=s.getField(E.OBJECTANDLAYERIDCOLOR,rl);rPe(i.objectAndLayerIdColor,x,b,n,6)}}};const rm=C(),n2=Qt(),CR=Qt(),qB=C(),ovt=xe(),avt=js(),WB=Io(),lvt=C(),cvt=Ht();class uvt{constructor(){this.aabr=Ht(),this.distance=0,this.culled=!1,this.visible=!1}}class hvt{constructor(e,r){this.graphics3DGraphic=e,this.slicePlaneEnabled=r,this.info={}}}var iu;(function(t){t[t.Idle=0]="Idle",t[t.Process=1]="Process",t[t.Sort=2]="Sort",t[t.Deconflict=3]="Deconflict",t[t.NumStates=4]="NumStates"})(iu||(iu={}));class PPe{constructor(){this.camera=new ft,this.slicePlane=B0(),this.slicePlaneEnabled=!1}copyFrom(e){this.camera.copyFrom(e.camera),_S(e.slicePlane,this.slicePlane),this.slicePlaneEnabled=e.slicePlaneEnabled}}let lC=class extends me{get dirty(){return this._dirty}get state(){return this._state}constructor(t){super(t),this._dirty=!1,this._runningViewState=new PPe,this._state=iu.Idle,this._active=new Map,this._visible=new Map,this._iterators=new mvt,this._accBinsNumX=15,this._accBinsNumY=20,this._accBinsSizeX=0,this._accBinsSizeY=0,this._accBins=null,this.accNumTests=0}destroy(){this._active.clear(),this._visible.clear(),this._iterators=null}setDirty(){!this._dirty&&this._active.size>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._state!==iu.Idle||this._dirty}get updatingProgress(){if(!this.updating)return 1;const t=this._state/iu.NumStates;return this._dirty?.5*t:t}get running(){return this.view.ready&&this.view.state!=null&&this.updating}runTask(t){switch(this._state){case iu.Idle:this._startUpdate(),t.madeProgress();case iu.Process:if(this._state=iu.Process,!this._processActiveGraphics(t))return;case iu.Sort:if(this._state=iu.Sort,!this._sortVisibleGraphics(t))return;case iu.Deconflict:if(this._state=iu.Deconflict,!this._deconflictVisibleGraphics(t))return;default:_0t(this,this._visible),this._state=iu.Idle,this.notifyChange("updating")}}modifyGraphics(t,e){e?t.forEach(r=>this.addToActiveGraphics(r)):t.forEach(r=>this.removeFromActiveGraphics(r)),this.setDirty()}layerSupportsDeconfliction(t){if(t==null||t.type!=="object3d")return!1;const e=t.stageObject;return(e?e.geometries.length:0)!==1?!1:e?.geometries[0]?.material instanceof VA}_startUpdate(){v0t(this.view),this._dirty=!1,this._runningViewState.copyFrom(this.viewState);const{fullWidth:t,fullHeight:e}=this._runningViewState.camera;this._initBins(t,e),this._resetIterators()}addToActiveGraphics(t){t.info[this.visibilityGroup]=new uvt,this._active.set(t.graphics3DGraphic.graphic.uid,t),this.setDirty()}removeFromActiveGraphics(t){this._visible.delete(t.graphics3DGraphic.graphic.uid),dvt(t,this.visibilityGroup),delete t.info[this.visibilityGroup],this._active.delete(t.graphics3DGraphic.graphic.uid),this.setDirty()}_processActiveGraphics(t){const e=this._ensureActiveGraphicsIterator(),r=mO(ovt,this._runningViewState.camera.projectionMatrix),i=this.view.viewingMode==="global"&&this.view.map.ground.opacity===1&&this._runningViewState.camera.relativeElevation>0?avt:null;let s=0;for(i!=null&&(Ne(i,Nl,this._runningViewState.camera.viewMatrix),i[3]=Ir(this.view.spatialReference).radius,s=UOe(i,Nl));!t.done;){t.madeProgress();const n=e.next();if(n.done===!0)return this._resetActiveGraphicsIterator(),!0;const o=n.value,a=o&&o.info[this.visibilityGroup];a&&(this._collectGraphics3DGraphics(o,r,i,s),a.culled?this._visible.delete(o.graphics3DGraphic.graphic.uid):this._visible.set(o.graphics3DGraphic.graphic.uid,o))}return!1}_sortVisibleGraphics(t){const e=this._ensureSortGraphicsIterator();for(;!t.done;){const r=e.next();if(t.madeProgress(),r.done===!0)return this._resetSortGraphicsIterator(),!0}return!1}_deconflictVisibleGraphics(t){const e=this._ensureVisibleGraphicsIterator(),r=this.visibilityGroup===Mo.LABEL;for(;!t.done;){t.madeProgress();const i=e.next();if(i.done===!0)return this._resetVisibleGraphicsIterator(),!0;const s=i.value,n=s.info[this.visibilityGroup];if(!n||n.culled)continue;const o=s.graphics3DGraphic,a=!r||o.isVisible();n.visible=a&&!this._isConflicted(s),n.visible&&this._addToBins(s),this._setGraphicVisibility(s,n.visible),w0t(n,n.visible)}return!1}_resetIterators(){this._iterators.active=null,this._iterators.visible=null,this._iterators.sort=null}_ensureActiveGraphicsIterator(){return this._iterators.active||(this._iterators.active=Xde(this._active)),this._iterators.active}_resetActiveGraphicsIterator(){this._iterators.active=null}_ensureVisibleGraphicsIterator(){return this._iterators.visible||(this._iterators.visible=Xde(this._visible)),this._iterators.visible}_resetVisibleGraphicsIterator(){this._iterators.visible=null}_ensureSortGraphicsIterator(){return this._iterators.sort||(this._iterators.sort=pvt(this._visible,this._iterators.sortArray,this.visibilityGroup)),this._iterators.sort}_resetSortGraphicsIterator(){this._iterators.sort=null}_collectGraphics3DGraphics(t,e,r,i){const s=t.graphics3DGraphic;if(s.destroyed)return;const n=t.info[this.visibilityGroup];if(!s.isVisible(Mo.GRAPHIC,Ca.DECONFLICTION))return void(n.culled=!0);const o=this.getGraphicsLayers(s);Au(n.aabr);let a=null;for(const l of o){if(!this.layerSupportsDeconfliction(l))continue;const c=l.stageObject.geometries[0].material;if(a==null&&(a=_vt,this._getProjectionInfo(l,e,a),a.isOutsideScreen||this._isCulledBySlice(t,rm)||r!=null&&this._isCulledByHorizon(a,r,i)))return void(n.culled=!0);this._expandBoundingRect(n,l,c,a)}a==null?n.culled=!0:(n.distance=a.distance,n.culled=!1)}_getProjectionInfo(t,e,r){const i=this._runningViewState.camera,s=t.stageObject,n=s.geometries[0],o=n.material,a=s.boundingVolumeWorldSpace.bounds;Ne(rm,a,i.viewMatrix);const l=n.vertexAttributes,c=l.get(E.NORMAL).data,h=l.get(E.AUXPOS1).data;o.applyShaderOffsetsView(rm,c,s.transformation,h,i,r.scaleInfo,rm),zi(n2,rm[0],rm[1],rm[2],1),ph(CR,n2,i.projectionMatrix),ae(r.positionNDC,CR,1/CR[3]),o.applyShaderOffsetsNDC(r.positionNDC,h,i,r.positionNDC,qB),r.distanceWithoutPolygonOffset=i.depthNDCToWorld(qB[2]),r.distance=qB[2]===r.positionNDC[2]?r.distanceWithoutPolygonOffset:i.depthNDCToWorld(r.positionNDC[2]),zi(CR,r.positionNDC[0],r.positionNDC[1],r.positionNDC[2],1),ph(n2,CR,e),AT(n2,n2,1/n2[3]),ie(r.positionView,rm[0],rm[1],rm[2])}_isCulledByHorizon(t,e,r){return oe(WB.direction,t.positionView),ie(WB.origin,0,0,0),!!db(e,WB,lvt)&&t.distanceWithoutPolygonOffset>r}_isCulledBySlice(t,e){return t.slicePlaneEnabled&&this._runningViewState.slicePlaneEnabled&&Cte(this._runningViewState.slicePlane,e)}_expandBoundingRect(t,e,r,{positionNDC:i,scaleInfo:s}){const n=this._runningViewState.camera,o=e.getScreenSize(gvt);DIe(o,s.factor,o),o[0]*=n.pixelRatio,o[1]*=n.pixelRatio;const a=ok(r.calculateRelativeScreenBounds(o,s.factorAlignment.scale,cvt),Et(0,n.fullWidth,.5+.5*i[0]),Et(0,n.fullHeight,.5+.5*i[1])),l=this.iconMarginFactor;if(l!==0){const c=l*Math.min(hh(a),Mf(a));a[0]-=c,a[1]-=c,a[2]+=c,a[3]+=c}E1(t.aabr,a,t.aabr)}_isConflicted(t){const e=t.graphics3DGraphic.graphic.uid,r=t.info[this.visibilityGroup];for(let i=Math.floor(r.aabr[0]/this._accBinsSizeX);i<=Math.floor(r.aabr[2]/this._accBinsSizeX);i++)if(!(i<0||i>=this._accBinsNumX))for(let s=Math.floor(r.aabr[1]/this._accBinsSizeY);s<=Math.floor(r.aabr[3]/this._accBinsSizeY);s++){if(s<0||s>=this._accBinsNumY)continue;const n=this._accBins[i][s];for(let o=0;o<n.length;o++){const a=n.data[o],l=a.info[this.visibilityGroup];if(l&&l.visible&&a.graphics3DGraphic.graphic.uid!==e&&(this.accNumTests++,JP(l.aabr,r.aabr)))return!0}}return!1}_initBins(t,e){if(this._accBins==null){this._accBins=[];for(let r=0;r<this._accBinsNumX;r++){this._accBins.push([]);const i=this._accBins[this._accBins.length-1];for(let s=0;s<this._accBinsNumY;s++)i.push(new qt)}}else for(let r=0;r<this._accBinsNumX;r++)for(let i=0;i<this._accBinsNumY;i++)this._accBins[r][i].clear();this._accBinsSizeX=t/this._accBinsNumX,this._accBinsSizeY=e/this._accBinsNumY,this.accNumTests=0}_addToBins(t){const e=t.info[this.visibilityGroup],r=Math.floor(e.aabr[0]/this._accBinsSizeX),i=Math.floor(e.aabr[2]/this._accBinsSizeX),s=Math.floor(e.aabr[1]/this._accBinsSizeY),n=Math.floor(e.aabr[3]/this._accBinsSizeY);for(let o=r;o<=i;o++)if(!(o<0||o>=this._accBinsNumX))for(let a=s;a<=n;a++)a<0||a>=this._accBinsNumY||this._accBins[o][a].push(t)}_setGraphicVisibility(t,e){const r=t.graphics3DGraphic;r.destroyed||(r.setVisibilityFlag(this.visibilityGroup,Ca.DECONFLICTION,e),this.visibilityGroup===Mo.LABEL&&this.view.labeler.setLabelGraphicVisibility(r,e))}};function dvt(t,e){const r=t.graphics3DGraphic;r.destroyed||r.setVisibilityFlag(e,Ca.DECONFLICTION,!0)}function*Xde(t){if(Map.prototype.entries){const e=t.entries();for(let r=e.next();!r.done;r=e.next())yield r.value[1]}else yield*t.values()}function*pvt(t,e,r){e.clear(),t.forEach((s,n)=>{const o=e.pushNew();o.id=n,o.visible=s.graphics3DGraphic.getVisibilityFlag(r,Ca.DECONFLICTION);const a=s.info&&s.info[r];o.prio=s.graphics3DGraphic.deconflictionPriority,o.distance=a?a.distance:Number.MAX_VALUE}),yield;const i=e.iterableSort((s,n)=>s.prio!==n.prio?n.prio-s.prio:s.distance!==n.distance?s.distance-n.distance:s.visible!==n.visible?s.visible?-1:1:s.id-n.id);for(let s=i.next();!s.done;s=i.next())yield;e.forAll(s=>{const n=t.get(s.id);n&&(t.delete(s.id),t.set(s.id,n))}),e.clear()}u([d({constructOnly:!0})],lC.prototype,"view",void 0),u([d({type:Boolean,readOnly:!0})],lC.prototype,"updating",null),lC=u([R("esri.views.3d.layers.graphics.Deconflictor")],lC);class fvt{constructor(){this.id=0,this.visible=!1,this.prio=0,this.distance=0}}class mvt{constructor(e=null,r=null,i=null){this.active=e,this.visible=r,this.sort=i,this.sortArray=new qt({allocator:s=>s||new fvt})}}const gvt=Pe();class yvt{constructor(){this.positionView=C(),this.positionNDC=C(),this.distance=0,this.distanceWithoutPolygonOffset=0,this.scaleInfo=new KIe}get isOutsideScreen(){const e=this.positionNDC;return e[0]<-1||e[1]<-1||e[2]<-1||e[0]>=1||e[1]>=1}}const _vt=new yvt,vvt=2e3;let o5=class extends lC{constructor(e){super(e),this.visibilityGroup=Mo.LABEL,this.iconMarginFactor=0,this._lastDeconfliction=0}get viewState(){return this.parent.viewState}runTask(e){if(this.parent.running)return Pa.YIELD;const r=performance.now();if(e.state!==Br.IDLE&&r-this._lastDeconfliction<vvt)return Pa.YIELD;super.runTask(e),this.state===iu.Idle&&(this._lastDeconfliction=r)}enabledChanged(e,r){this.modifyGraphics(r,e.labelsEnabled)}getGraphicsLayers(e){return e.labelLayers}};u([d({constructOnly:!0})],o5.prototype,"parent",void 0),o5=u([R("esri.views.3d.layers.graphics.LabelDeconflictor")],o5);let AY=class extends lC{constructor(){super(...arguments),this._handles=new li,this._contexts=new Map,this._viewState=new PPe,this.visibilityGroup=Mo.GRAPHIC,this._iconMarginFactor=-.1}get labels(){return this._labels}get viewState(){return this._viewState}initialize(){this._handles.add([Q(()=>this.view?.state?.camera,()=>{this._updateViewState(),this.setDirty()}),Q(()=>this.view?.map?.ground?.opacity,(e,r)=>{e!==1&&r!==1||this.setDirty()}),Q(()=>this.view?.slicePlane,()=>{this._updateSlicePlane(),this._slicePlaneChanged()},xt)]),this._frameTask=this.view.resourceController.scheduler.registerTask(gt.GRAPHICS_DECONFLICTOR,this),this._labels=new o5({view:this.view,parent:this})}destroy(){this._labels.destroy(),this._labels=null,this._handles.destroy(),this._handles=null,this._frameTask&&(this._frameTask.remove(),this._frameTask=null)}get iconMarginFactor(){return this._iconMarginFactor}set iconMarginFactor(e){this._iconMarginFactor=e,this.setDirty()}setDirty(){this._contexts.size>0&&(super.setDirty(),this._labels.setDirty())}runTask(e){super.runTask(e),this.running||this._labels.setDirty()}setInitialIconVisibilityFlag(e,r){const i=!(this._graphicSupportsDeconfliction(r)&&ZB(e));r.setVisibilityFlag(Mo.GRAPHIC,Ca.DECONFLICTION,i)}_updateViewState(){this.view&&this.view.state&&(this._viewState.camera.copyFrom(this.view.state.camera),this._updateSlicePlane())}_updateSlicePlane(){const e=this.view?this.view.slicePlane:null;e!=null&&fRe(e,this._viewState.camera.viewMatrix,this._viewState.slicePlane),this._viewState.slicePlaneEnabled=e!=null}_slicePlaneChanged(){ra(this._contexts,(e,r)=>r.symbolCreationContext.slicePlaneEnabled)&&this.setDirty()}addGraphicsOwner(e){const r=this._getGraphicsContext(e);return{addGraphic:i=>this._addGraphic(e,r,i),removeGraphic:i=>this._removeGraphic(r,i),labelingInfoChange:()=>this._labels.enabledChanged(e,r),featureReductionChange:()=>this.enabledChanged(e,r),slicePlaneEnabledChange:()=>this._slicePlaneEnabledChanged(e,r),clear:()=>r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic))}}removeGraphicsOwner(e){const r=this._contexts.get(e);r&&(r.forEach(i=>this._removeGraphic(r,i.graphics3DGraphic)),this._contexts.delete(e),this.setDirty())}_addGraphic(e,r,i){const s=i.graphic.uid,n=new hvt(i,e.symbolCreationContext.slicePlaneEnabled);r.set(s,n),ZB(e)&&this.addToActiveGraphics(n),e.labelsEnabled&&this._labels.addToActiveGraphics(n)}_removeGraphic(e,r){const i=r.graphic.uid,s=e.get(i);s&&(this.removeFromActiveGraphics(s),this._labels.removeFromActiveGraphics(s),e.delete(i),this.setDirty())}enabledChanged(e,r){const i=ZB(e);i||bvt(e),this.modifyGraphics(r,i)}_slicePlaneEnabledChanged(e,r){const i=e.symbolCreationContext.slicePlaneEnabled;r.forEach(s=>s.slicePlaneEnabled=i),this.setDirty()}getGraphicsLayers(e){return e.layers}_graphicSupportsDeconfliction(e){if(e.isDraped)return!1;const r=e.layers;if(!r||!r.length)return!1;for(const i of r)if(this.layerSupportsDeconfliction(i))return!0;return!1}_getGraphicsContext(e){const r=this._contexts.get(e);if(r)return r;const i=new Map;return this._contexts.set(e,i),this.setDirty(),i}};function ZB(t){const e=t.layer;return!(!e||!e.featureReduction||e.featureReduction.type!=="selection")}function bvt(t){const e=t.graphics3DGraphics;e&&e.forEach(r=>r.setVisibilityFlag(Mo.GRAPHIC,Ca.DECONFLICTION,!0))}AY=u([R("esri.views.3d.layers.graphics.GraphicsDeconflictor")],AY);function $Pe(t){return"declaredClass"in t}function Yde(t){return"declaredClass"in t}function wvt(t){return"declaredClass"in t}function xvt(t,e){return t?wvt(t)?t:new oa({layer:e,sourceLayer:e,visible:t.visible,symbol:re(t.symbol),attributes:re(t.attributes),geometry:LPe(t.geometry)}):null}function LPe(t){return t==null?null:$Pe(t)?t:N1(Tvt(t))}function Tvt(t){const{wkid:e,wkt:r,latestWkid:i}=t.spatialReference,s={wkid:e,wkt:r,latestWkid:i};switch(t.type){case"point":{const{x:n,y:o,z:a,m:l}=t;return{x:n,y:o,z:a,m:l,spatialReference:s}}case"polygon":{const{rings:n,hasZ:o,hasM:a}=t;return{rings:Jde(n),hasZ:o,hasM:a,spatialReference:s}}case"polyline":{const{paths:n,hasZ:o,hasM:a}=t;return{paths:Jde(n),hasZ:o,hasM:a,spatialReference:s}}case"extent":{const{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:g}=t;return{xmin:n,xmax:o,ymin:a,ymax:l,zmin:c,zmax:h,mmin:p,mmax:f,hasZ:m,hasM:g,spatialReference:s}}case"multipoint":{const{points:n,hasZ:o,hasM:a}=t;return{points:NPe(n)?DPe(n):n,hasZ:o,hasM:a,spatialReference:s}}default:return}}function Jde(t){return Svt(t)?t.map(e=>DPe(e)):t}function DPe(t){return t.map(e=>Array.from(e))}function Svt(t){for(const e of t)if(e.length!==0)return NPe(e);return!1}function NPe(t){return t.length>0&&(WA(t[0])||ZA(t[0]))}function Evt(t,e){if(!t)return null;let r;if(Yde(t)){if(e==null)return t.clone();if(Yde(e))return e.copy(t)}return e!=null?(r=e,r.x=t.x,r.y=t.y,r.spatialReference=t.spatialReference,t.hasZ?(r.z=t.z,r.hasZ=t.hasZ):(r.z=void 0,r.hasZ=!1),t.hasM?(r.m=t.m,r.hasM=!0):(r.m=void 0,r.hasM=!1)):(r=Su(t.x,t.y,t.z,t.spatialReference),t.hasM&&(r.m=t.m,r.hasM=!0)),r}function Gjt(t){const{wkid:e,wkt:r,latestWkid:i}=t,s={wkid:e,wkt:r,latestWkid:i};return qe.fromJSON(s)}const XB=K.getLogger("esri.layers.support.labelFormatUtils"),YB={type:"simple",evaluate:()=>null},Cvt={getAttribute:(t,e)=>t.field(e)};async function FPe(t,e,r){if(!t||!t.symbol||!e)return YB;const i=t.where,s=CV(t),n=i?await J(()=>import("./WhereClause-dc16111f.js").then(a=>a.W),[],import.meta.url):null;let o;if(s.type==="arcade"){const a=await H9e(s.expression,r,e);if(a==null)return YB;o={type:"arcade",evaluate(l){try{const c=a.evaluate({$feature:"attributes"in l?a.repurposeFeature(l):l},a.services);if(c!=null)return c.toString()}catch(c){XB.error(new D("arcade-expression-error","Encountered an error when evaluating label expression for feature",{error:c,feature:l,expression:s}))}return null},needsHydrationToEvaluate:()=>hee(s.expression)==null}}else o={type:"simple",evaluate:a=>s.expression.replaceAll(/{[^}]*}/g,l=>{const c=l.slice(1,-1),h=e.get(c);if(!h)return l;let p=null;return"attributes"in a?a&&a.attributes&&(p=a.attributes[h.name]):p=a.field(h.name),p==null?"":kPe(p,h)})};if(i){let a;try{a=n.WhereClause.create(i,e)}catch(c){return XB.error(new D("bad-where-clause","Encountered an error when evaluating where clause, ignoring",{where:i,error:c})),YB}const l=o.evaluate;o.evaluate=c=>{const h="attributes"in c?void 0:Cvt;try{if(a.testFeature(c,h))return l(c)}catch(p){XB.error(new D("bad-where-clause","Encountered an error when evaluating where clause for feature",{where:i,feature:c,error:p}))}return null}}return o}function kPe(t,e){if(t==null)return"";const r=e.domain;if(r){if(r.type==="codedValue"||r.type==="coded-value"){const s=t;for(const n of r.codedValues)if(n.code===s)return n.name}else if(r.type==="range"){const s=+t,n="range"in r?r.range[0]:r.minValue,o="range"in r?r.range[1]:r.maxValue;if(n<=s&&s<=o)return r.name}}let i=t;return e.type==="date"||e.type==="esriFieldTypeDate"?i=Vd(i,zE("short-date")):eT(e)&&(i=zd(+i)),i||""}const jjt=Object.freeze(Object.defineProperty({__proto__:null,createLabelFunction:FPe,formatField:kPe},Symbol.toStringTag,{value:"Module"}));let UPe=class{constructor(e=null,r="center",i="center",s=null,n=[0,0,0],o=0,a=[0,0,0,1],l=[0,0],c="world",h=0,p=0){this.verticalOffset=e,this.horizontalPlacement=r,this.verticalPlacement=i,this.text=s,this.translation=n,this.elevationOffset=o,this.centerOffset=a,this.screenOffset=l,this.centerOffsetUnits=c,this.displayWidth=h,this.displayHeight=p}};function Bre(t,e){if(t.type==="point")return R_(t,e,!1);if($Pe(t))switch(t.type){case"extent":return R_(t.center,e,!1);case"polygon":return R_(t.centroid,e,!1);case"polyline":return R_(Qde(t),e,!0);case"mesh":return R_(t.origin,e,!1)}else switch(t.type){case"extent":return R_(Avt(t),e,!0);case"polygon":return R_(Ovt(t),e,!0);case"polyline":return R_(Qde(t),e,!0)}}function Qde(t){const e=t.paths[0];if(!e||e.length===0)return null;const r=V1e(e,U1e(e)/2);return Su(r[0],r[1],r[2],t.spatialReference)}function Avt(t){return Su(.5*(t.xmax+t.xmin),.5*(t.ymax+t.ymin),t.zmin!=null&&t.zmax!=null&&isFinite(t.zmin)&&isFinite(t.zmax)?.5*(t.zmax+t.zmin):void 0,t.spatialReference)}function Ovt(t){const e=t.rings[0];if(!e||e.length===0)return null;const r=B1e(t.rings,!!t.hasZ);return Su(r[0],r[1],r[2],t.spatialReference)}function R_(t,e,r){const i=r?t:Evt(t);return e&&t?$2e(t,i,e)?i:null:i}function qjt(t,e,r,i=0){if(t){e||(e=Ht());const s=t;let n=.5*s.width*(r-1),o=.5*s.height*(r-1);return s.width<1e-7*s.height?n+=o/20:s.height<1e-7*s.width&&(o+=n/20),zi(e,s.xmin-n-i,s.ymin-o-i,s.xmax+n+i,s.ymax+o+i),e}return null}function VPe(t,e){for(let r=0;r<t.geometries.length;++r){const i=t.geometries[r].getMutableAttribute(E.AUXPOS1);i&&i.data[3]!==e&&(i.data[3]=e,t.geometryVertexAttrsUpdated(t.geometries[r]))}}function mI(t,e,r=null){const i=h$(Od);return t!=null&&(i[0]=t[0],i[1]=t[1],i[2]=t[2]),e!=null?i[3]=e:t!=null&&t.length>3&&(i[3]=t[3]),r&&(i[0]*=r,i[1]*=r,i[2]*=r,i[3]*=r),i}function Wjt(t,e,r,i,s,n=[0,0,0,0]){for(let o=0;o<3;++o)t!=null&&t[o]!=null?n[o]=t[o]:r!=null&&r[o]!=null?n[o]=r[o]:n[o]=s[o];return n[3]=e??i??s[3],n}function Kde(t=i0,e,r,i=1){const s=new Array(3);if(e==null||r==null)s[0]=1,s[1]=1,s[2]=1;else{let n,o=0;for(let a=2;a>=0;a--){const l=t[a];let c;const h=l!=null,p=a===0&&!n&&!h,f=r[a];l==="symbol-value"||p?c=f!==0?e[a]/f:1:h&&l!=="proportional"&&isFinite(l)&&(c=f!==0?l/f:1),c!=null&&(s[a]=c,n=c,o=Math.max(o,Math.abs(c)))}for(let a=2;a>=0;a--)s[a]==null?s[a]=n:s[a]===0&&(s[a]=.001*o)}for(let n=2;n>=0;n--)s[n]/=i;return Ml(s)}function Rvt(t){return t.isPrimitive!=null}function D8(t){return OY(Rvt(t)?[t.width,t.depth,t.height]:t)?null:"Symbol sizes may not be negative values"}function OY(t){const e=r=>r==null||r>=0;return Array.isArray(t)?t.every(e):e(t)}function Mvt(t,e,r,i=xe()){return t&&pA(i,i,-t/180*Math.PI),e&&dA(i,i,e/180*Math.PI),r&&bV(i,i,r/180*Math.PI),i}function Gre(t,e,r){if(r.minDemResolution!=null)return r.minDemResolution;const i=Uo(e),s=lS(t)*i,n=cS(t)*i,o=lb(t)*(e.isGeographic?1:i);return s===0&&n===0&&o===0?r.minDemResolutionForPoints:.01*Math.max(s,n,o)}function zPe(t,e,r,i,s,n,o,a,l,c,h){const p=kvt[h.mode];let f,m,g=0;if(wi(t,e,r,i,l.spatialReference,s,a))return p.requiresAlignment(h)?(g=p.applyElevationAlignmentBuffer(i,s,n,o,a,l,c,h),f=n,m=o):(f=i,m=s),wi(f,l.spatialReference,m,n,c.spatialReference,o,a)?g:void 0}function rb(t,e,r,i,s){const n=($U(t)?t.z:oIe(t)?t.array[t.offset+2]:t[2])||0;switch(r.mode){case"on-the-ground":{const o=Qm(e,t,"ground")??0;return s.verticalDistanceToGround=0,s.sampledElevation=o,void(s.z=o)}case"relative-to-ground":{const o=Qm(e,t,"ground")??0,a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"relative-to-scene":{const o=Qm(e,t,"scene")??0,a=r.geometryZWithOffset(n,i);return s.verticalDistanceToGround=a,s.sampledElevation=o,void(s.z=a+o)}case"absolute-height":{const o=r.geometryZWithOffset(n,i),a=Qm(e,t,"ground")??0;return s.verticalDistanceToGround=o-a,s.sampledElevation=a,void(s.z=o)}default:return void(s.z=0)}}function Ivt(t,e,r,i){return rb(t,e,r,i,cC),cC.z}function N$(t,e,r){return e==null||r==null?t.definedChanged:e==="on-the-ground"&&r==="on-the-ground"?t.staysOnTheGround:e===r||e!=="on-the-ground"&&r!=="on-the-ground"?Is.UPDATE:t.onTheGroundChanged}function Qd(t){return t==="relative-to-ground"||t==="relative-to-scene"}function ib(t){return t!=="absolute-height"}function Pvt(t,e,r,i,s){rb(e,r,s,i,cC),VPe(t,cC.verticalDistanceToGround);const n=cC.sampledElevation,o=an(Uvt,t.transformation);return lN[0]=e.x,lN[1]=e.y,lN[2]=cC.z,wc(e.spatialReference,lN,o,i.spatialReference)?t.transformation=o:console.warn("Could not locate symbol object properly, it might be misplaced"),n}function $vt(t,e,r,i,s,n){let o=0;const a=n.spatialReference;e*=3,i*=3;for(let l=0;l<s;++l){const c=t[e],h=t[e+1],p=t[e+2],f=n.getElevation(c,h,p,a,"ground")??0;o+=f,r[i]=c,r[i+1]=h,r[i+2]=f,e+=3,i+=3}return o/s}function Lvt(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e],g=t[e+1],_=t[e+2],v=n.getElevation(m,g,_,p,"ground")??0;l+=v,r[i]=m,r[i+1]=g,r[i+2]=h==null?_+v+c:v+c,e+=3,i+=3}return l/s}function Dvt(t,e,r,i,s,n,o,a){let l=0;const c=a.calculateOffsetRenderUnits(o),h=a.featureExpressionInfoContext,p=n.spatialReference;e*=3,i*=3;for(let f=0;f<s;++f){const m=t[e],g=t[e+1],_=t[e+2],v=n.getElevation(m,g,_,p,"scene")??0;l+=v,r[i]=m,r[i+1]=g,r[i+2]=h==null?_+v+c:v+c,e+=3,i+=3}return l/s}function Nvt(t){const e=t.meterUnitOffset,r=t.featureExpressionInfoContext;return e!==0||r!=null}function Fvt(t,e,r,i,s,n,o,a){const l=a.calculateOffsetRenderUnits(o),c=a.featureExpressionInfoContext;e*=3,i*=3;for(let h=0;h<s;++h){const p=t[e],f=t[e+1],m=t[e+2];r[i]=p,r[i+1]=f,r[i+2]=c==null?m+l:l,e+=3,i+=3}return 0}let F$=class{constructor(){this.verticalDistanceToGround=0,this.sampledElevation=0,this.z=0}};var Is;(function(t){t[t.NONE=0]="NONE",t[t.UPDATE=1]="UPDATE",t[t.RECREATE=2]="RECREATE"})(Is||(Is={}));const kvt={"absolute-height":{applyElevationAlignmentBuffer:Fvt,requiresAlignment:Nvt},"on-the-ground":{applyElevationAlignmentBuffer:$vt,requiresAlignment:()=>!0},"relative-to-ground":{applyElevationAlignmentBuffer:Lvt,requiresAlignment:()=>!0},"relative-to-scene":{applyElevationAlignmentBuffer:Dvt,requiresAlignment:()=>!0}},Uvt=xe(),cC=new F$,lN=C();function jre(t){return t.mapPositions!=null}function BPe(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;for(const l of o){if(!jre(l))continue;const{update:c,averageGeometrySampledElevation:h}=jPe(l,e,r,i,s);a+=h,c&&n.geometryVertexAttrsUpdated(l)}return a/o.length}function uT(t,e,r,i,s,n){const o=t.stageObject,a=e.centerPointInElevationSR;let l=0;o.usesVerticalDistanceToGround?(i(a,dc),VPe(o,dc.verticalDistanceToGround),l=dc.sampledElevation):(i(a,dc),e.mode!=="absolute-height"&&(l=dc.sampledElevation));const c=an(Vvt,n??o.transformation),h=ie(GPe,c[12],c[13],c[14]);bi.TESTS_DISABLE_OPTIMIZATIONS?(hc[0]=a.x,hc[1]=a.y,hc[2]=dc.z,wc(a.spatialReference,hc,c,s.spatialReference)&&(n?an(n,c):o.transformation=c)):s.setAltitudeOfTransformation(dc.z,c);const p=Hre/s.unitInMeters;return(Math.abs(c[12]-h[0])>=p||Math.abs(c[13]-h[1])>=p||Math.abs(c[14]-h[2])>=p)&&(n?an(n,c):o.transformation=c),l}const Vvt=xe();function zvt(t,e,r,i,s){const n=t.graphics3DSymbolLayer.lodRenderer;if(n==null)return 0;const o=e.centerPointInElevationSR;i(o,dc);const a=e.mode!=="absolute-height"?dc.sampledElevation:0,l=n.instanceData,c=t.instanceIndex,h=Gvt;l.getGlobalTransform(c,h);const p=ie(GPe,h[12],h[13],h[14]);bi.TESTS_DISABLE_OPTIMIZATIONS?(hc[0]=o.x,hc[1]=o.y,hc[2]=dc.z,wc(o.spatialReference,hc,h,s.spatialReference)&&l.setGlobalTransform(c,h)):s.setAltitudeOfTransformation(dc.z,h);const f=Hre/s.unitInMeters;return(bi.TESTS_DISABLE_OPTIMIZATIONS||Math.abs(h[12]-p[0])>=f||Math.abs(h[13]-p[1])>=f||Math.abs(h[14]-p[2])>=f)&&l.setGlobalTransform(c,h),a}function Bvt(t,e,r,i,s){const n=t.stageObject,o=n.geometries;if(o.length===0)return 0;let a=0,l=null,c=0,h=!1;for(const p of o){if(!jre(p))continue;const f=p.vertexAttributes.get(E.POSITION);if(f!==l){const{update:m,averageGeometrySampledElevation:g}=jPe(p,e,r,i,s);c=g,l=f,h=m}h&&n.geometryVertexAttrsUpdated(p),a+=c}return a/o.length}const Hre=.01,hc=C(),Fh=C(),o2=C(),Gvt=xe(),GPe=C(),dc=new F$;function jPe(t,e,r,i,s){let n=!1;const o=t.shaderTransformation,a=e.requiresSampledElevationInfo;Fh[0]=o[12],Fh[1]=o[13],Fh[2]=o[14],t.invalidateBoundingInfo();const l=t.getMutableAttribute(E.POSITION),c=l.data,h=l.size,p=c.length/h,f=new Tre(t.mapPositions,r);let m=0,g=0;for(let _=0;_<p;_++){if(o2[0]=c[m],o2[1]=c[m+1],o2[2]=c[m+2],i(f,dc),a&&(g+=dc.sampledElevation),bi.TESTS_DISABLE_OPTIMIZATIONS)c[m]=f.array[f.offset],c[m+1]=f.array[f.offset+1],c[m+2]=dc.z,wi(c,r,m,c,s.spatialReference,m,1),c[m]-=Fh[0],c[m+1]-=Fh[1],c[m+2]-=Fh[2],n=!0;else{hc[0]=c[m]+Fh[0],hc[1]=c[m+1]+Fh[1],hc[2]=c[m+2]+Fh[2],s.setAltitude(hc,dc.z),c[m]=hc[0]-Fh[0],c[m+1]=hc[1]-Fh[1],c[m+2]=hc[2]-Fh[2];const v=Hre/s.unitInMeters;(Math.abs(o2[0]-c[m])>=v||Math.abs(o2[1]-c[m+1])>=v||Math.abs(o2[2]-c[m+2])>=v)&&(n=!0)}m+=h,f.offset+=3}return g/=p,{update:n,averageGeometrySampledElevation:g}}const jvt=K.getLogger("esri.views.3d.layers.graphics.featureExpressionInfoUtils");function Hvt(t){return{cachedResult:t.cachedResult,arcade:t.arcade?{func:t.arcade.func,context:t.arcade.modules.arcadeUtils.createExecContext(null,{sr:t.arcade.context.spatialReference}),modules:t.arcade.modules}:null}}function Xjt(t){const e=t&&t.expression;if(typeof e=="string"){const r=WPe(e);if(r!=null)return{cachedResult:r}}return null}async function Yjt(t,e,r,i){const s=t&&t.expression;if(typeof s!="string")return null;const n=WPe(s);if(n!=null)return{cachedResult:n};const o=await If();Dt(r);const a=o.arcadeUtils,l=a.createSyntaxTree(s);return a.dependsOnView(l)?(i?.error("Expressions containing '$view' are not supported on ElevationInfo"),{cachedResult:0}):{arcade:{func:a.createFunction(l),context:a.createExecContext(null,{sr:e}),modules:o}}}function HPe(t,e,r){return t.arcadeUtils.createFeature(e.attributes,e.geometry,r)}function N8(t,e){if(t!=null&&!qPe(t)){if(!e||!t.arcade)return void jvt.errorOncePerTick("Arcade support required but not provided");const r=e;r._geometry&&(r._geometry=LPe(r._geometry)),t.arcade.modules.arcadeUtils.updateExecContext(t.arcade.context,e)}}function qvt(t){if(t!=null){if(qPe(t))return t.cachedResult;const e=t.arcade;let r=e?.modules.arcadeUtils.executeFunction(e.func,e.context);return typeof r!="number"&&(t.cachedResult=0,r=0),r}return 0}function Jjt(t,e=!1){let r=t&&t.featureExpressionInfo;const i=r&&r.expression;return e||i==="0"||(r=null),r??null}const Wvt={cachedResult:0};function qPe(t){return t.cachedResult!=null}function WPe(t){return t==="0"?0:null}let Gf=class ZPe{constructor(){this._meterUnitOffset=0,this._renderUnitOffset=0,this._unit="meters",this._metersPerElevationInfoUnit=1,this._featureExpressionInfoContext=null,this.centerPointInElevationSR=null,this.mode=null}get featureExpressionInfoContext(){return this._featureExpressionInfoContext}get meterUnitOffset(){return this._meterUnitOffset}get unit(){return this._unit}set unit(e){this._unit=e,this._metersPerElevationInfoUnit=e2e(e)}get requiresSampledElevationInfo(){return this.mode!=="absolute-height"}reset(){this.mode=null,this._meterUnitOffset=0,this._renderUnitOffset=0,this._featureExpressionInfoContext=null,this.unit="meters"}set offsetMeters(e){this._meterUnitOffset=e,this._renderUnitOffset=0}set offsetElevationInfoUnits(e){this._meterUnitOffset=e*this._metersPerElevationInfoUnit,this._renderUnitOffset=0}addOffsetRenderUnits(e){this._renderUnitOffset+=e}geometryZWithOffset(e,r){const i=this.calculateOffsetRenderUnits(r);return this.featureExpressionInfoContext!=null?i:e+i}calculateOffsetRenderUnits(e){let r=this._meterUnitOffset;const i=this.featureExpressionInfoContext;return i!=null&&(r+=qvt(i)*this._metersPerElevationInfoUnit),r/e.unitInMeters+this._renderUnitOffset}setFromElevationInfo(e){this.mode=e.mode,this.unit=YXe(e.unit)?e.unit:"meters",this.offsetElevationInfoUnits=e.offset??0}updateFeatureExpressionInfoContext(e,r,i){if(e==null)return void(this._featureExpressionInfoContext=null);const s=e&&e.arcade;s&&r!=null&&i!=null?(this._featureExpressionInfoContext=Hvt(e),N8(this._featureExpressionInfoContext,HPe(s.modules,r,i))):this._featureExpressionInfoContext=e}static fromElevationInfo(e){const r=new ZPe;return e!=null&&r.setFromElevationInfo(e),r}},Zvt=class{constructor(e,r,i){this.graphic=e,this.renderingInfo=r,this.layer=i}},Xvt=class{constructor(e,r,i){this.baseMaterial=e,this.edgeMaterials=r,this.properties=i}},Ug=class{get isElevationSource(){return!!this.stageObject.lastValidElevationBB}constructor(e,r,i,s,n,o,a,l=null){this.graphics3DSymbolLayer=e,this.stageObject=r,this._uniqueGeometries=i,this._uniqueMaterials=s,this._sharedResource=n,this.elevationAligner=o,this.elevationContext=a,this._edgeState=l,this.type="object3d",this._stageLayer=null,this._visible=!1,this._addedToStage=!1,this.alignedSampledElevation=0,this.needsElevationUpdates=!1,this.useObjectOriginAsAttachmentOrigin=!1}initialize(e){this._stageLayer=e;const r=e.stage;r.addMany(this._uniqueMaterials),r.addMany(this._uniqueGeometries),r.add(this.stageObject)}destroy(){if(!this._stageLayer)return;const e=this._stageLayer.stage;e.removeMany(this._uniqueMaterials),e.removeMany(this._uniqueGeometries),e.remove(this.stageObject),this._addedToStage&&(this._stageLayer.remove(this.stageObject),this._addedToStage=!1);const r=e.renderer.ensureEdgeView();r.hasObject(this.stageObject)&&r.removeObject(this.stageObject),this.stageObject.dispose(),this._sharedResource!=null&&this._sharedResource.release(),this._visible=!1,this._stageLayer=null}layerOpacityChanged(e,r){if(this._edgeState==null)return;const i=epe(this._edgeState.baseMaterial);let s=!1;for(const n of this._edgeState.edgeMaterials)n.objectTransparency!==i&&(n.objectTransparency=i,s=!0);s&&this.resetEdgeObject(r),this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentOpacities(this.stageObject,[e])}slicePlaneEnabledChanged(e,r){this._edgeState!=null&&(this._stageLayer.stage.renderer.ensureEdgeView().updateAllComponentMaterials(this.stageObject,this._edgeState.edgeMaterials,{hasSlicePlane:e},!r),this._edgeState.properties.hasSlicePlane=e)}setVisibility(e){if(this._stageLayer!=null&&this._visible!==e&&(this._visible=e,this.stageObject.visible=e,this._visible&&!this._addedToStage&&(this._stageLayer.add(this.stageObject),this._addedToStage=!0),this._edgeState)){const r=this._stageLayer.stage.renderer.ensureEdgeView();r.hasObject(this.stageObject)?r.updateObjectVisibility(this.stageObject,e):e&&this._addOrUpdateEdgeObject(r,!1)}}get visible(){return this._visible}alignWithElevation(e,r,i,s){if(this.elevationAligner==null)return;i!=null&&N8(this.elevationContext.featureExpressionInfoContext,i);const n=(o,a)=>rb(o,e,this.elevationContext,r,a);this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,e.spatialReference,n,r),this.resetEdgeObject(s)}alignWithAbsoluteElevation(e,r,i){const s=(n,o)=>{o.sampledElevation=e,o.verticalDistanceToGround=0,o.z=e};this.alignedSampledElevation=this.elevationAligner(this,this.elevationContext,null,s,r),this.resetEdgeObject(i)}getCenterObjectSpace(e=C()){return oe(e,this.stageObject.boundingVolumeObjectSpace.bounds)}getBoundingBoxObjectSpace(e=Gn()){const r=this.stageObject.boundingVolumeObjectSpace;return uxe(e,r.min),hxe(e,r.max),e}computeAttachmentOrigin(e){if(this.useObjectOriginAsAttachmentOrigin){const r=this.stageObject.shaderTransformation;e.render.origin[0]+=r[12],e.render.origin[1]+=r[13],e.render.origin[2]+=r[14],e.render.num++}else for(const r of this.stageObject.geometries)r.computeAttachmentOrigin(Qg)&&(Ne(Qg,Qg,this.stageObject.shaderTransformation),ue(e.render.origin,e.render.origin,Qg),e.render.num++)}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=Yvt,l=gK(o)?1:a.length;for(let h=0;h<l;h++){const p=a[h];M_[0]=o[p[0]],M_[1]=o[p[1]],M_[2]=o[p[2]],Ne(M_,M_,this.stageObject.transformation),Bb[3*h]=M_[0],Bb[3*h+1]=M_[1],Bb[3*h+2]=M_[2]}if(!e(Bb,0,l))return null;Gi(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],Bb[h+p]),o[p+3]=Math.max(o[p+3],Bb[h+p]);c&&i.push({location:Bb.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&r.service&&this.elevationContext.mode!=="absolute-height"){lf(o,Qg);const h=this.elevationContext.mode==="relative-to-scene"?"scene":"ground";let p=0;if(r.useViewElevation)p=r.service.getElevation(Qg[0],Qg[1],h)??0;else try{const f=Gre(o,r.service.spatialReference,r);p=await r.service.queryElevation(Qg[0],Qg[1],s,f,h)??0}catch{}cxe(o,0,0,-this.alignedSampledElevation+p)}return o}addObjectState(e,r){e===$0.Highlight&&r.addObject(this.stageObject,this.stageObject.highlight()),e===$0.MaskOccludee&&r.addObject(this.stageObject,this.stageObject.maskOccludee())}removeObjectState(e){e.removeObject(this.stageObject)}resetEdgeObject(e){if(this._edgeState==null)return;const r=this._stageLayer.stage.renderer.ensureEdgeView();this._visible?this._addOrUpdateEdgeObject(r,e):r.removeObject(this.stageObject)}_addOrUpdateEdgeObject(e,r){const i=this._edgeState;if(i==null)return;const s=epe(i.baseMaterial);for(const n of i.edgeMaterials)n.objectTransparency=s;e.addOrUpdateObject3D(this.stageObject,i.edgeMaterials,i.properties,!r).then(()=>this._stageLayer?.sync())}};function epe(t){return t.isVisible()?t.parameters.transparent?Xt.TRANSPARENT:Xt.OPAQUE:Xt.INVISIBLE}const Bb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],M_=C(),Qg=C(),Yvt=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]];let XPe=class{constructor(e,r=null){this.labelText=r,this.elevationOffset=e??0}};var on;(function(t){t[t.RecreateSymbol=0]="RecreateSymbol",t[t.RecreateGraphics=1]="RecreateGraphics",t[t.FastUpdate=2]="FastUpdate"})(on||(on={}));let qre=class{constructor(e){this.schedule=e,this._abortController=null,this._loadStatus=oh.LOADING,this._loadError=null,this._loader=null,this.logger=null}destroy(){this.abortLoad()}get loadStatus(){return this._loadStatus}load(e,r){return this._loadStatus===oh.LOADED?(e&&e(),this._loader??Promise.resolve()):this._loadStatus===oh.FAILED?(r&&r(this._loadError),this._loader??Promise.resolve()):(this._loader==null&&(this._abortController=new AbortController,this._loader=this.doLoad(this._abortController.signal).then(()=>{this._abortController=null,this._loadStatus=oh.LOADED},i=>{throw this._loadError=i,this._abortController=null,this._loadStatus=oh.FAILED,!ws(i)&&this.logger&&i.message&&this.logger.warn(i.message),i})),this._loader.then(e,r).catch(()=>{}),this._loader)}abortLoad(){this._abortController!=null?this._abortController=Do(this._abortController):this._loadStatus===oh.LOADING&&(this._loadStatus=oh.FAILED),this._loader=null}};var oh;(function(t){t[t.LOADING=0]="LOADING",t[t.LOADED=1]="LOADED",t[t.FAILED=2]="FAILED"})(oh||(oh={}));const YPe=3,RY=3,JPe=10;let QPe=class{constructor(e,r=null){this.geometry=e,this.textures=r}};function cN(t){const e=[];return t.levels.forEach(r=>r.components.forEach(i=>e.push(i.geometry.material))),b6(e)}function tpe(t){const e=new Array;return t.levels.forEach(r=>{r.components.forEach(i=>{i.textures!=null&&e.push(...i.textures)})}),b6(e)}function KPe(t){const e=t.components.map(r=>r.geometry);return b6(e)}function rpe(t){const e=[];return t.levels.forEach(r=>{r.components.forEach(i=>{e.push(i.geometry)})}),b6(e)}function Jvt(t){switch(t){case"sphere":case"cube":case"diamond":case"cylinder":case"cone":case"inverted-cone":case"tetrahedron":return!0}return!1}function e$e(t,e){const r=(i,s,n=!1)=>({levels:i.map(o=>{const a=s(o.tesselation);return n&&mpt(a),{components:[new QPe(a)],faceCount:a.indexCount/3,minScreenSpaceRadius:o.minScreenSpaceRadius}})});switch(t){case"sphere":return r([{tesselation:0,minScreenSpaceRadius:0},{tesselation:1,minScreenSpaceRadius:8},{tesselation:2,minScreenSpaceRadius:16},{tesselation:3,minScreenSpaceRadius:50},{tesselation:4,minScreenSpaceRadius:250}],i=>hpt(e,.5,i,!0));case"cube":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>rpt(e,1));case"cone":return r(JB,i=>ihe(e,1,.5,i,!1),!0);case"inverted-cone":return r(JB,i=>ihe(e,1,.5,i,!0),!0);case"cylinder":return r(JB,i=>ppt(e,1,.5,i,[0,0,1],[0,0,.5]));case"tetrahedron":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>upt(e,1),!0);case"diamond":return r([{tesselation:0,minScreenSpaceRadius:0}],()=>opt(e,1),!0);default:return}}const JB=[{tesselation:6,minScreenSpaceRadius:0},{tesselation:18,minScreenSpaceRadius:7},{tesselation:64,minScreenSpaceRadius:65}],Wre={primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:{bytesPerFeature:0,bytesPerCoordinate:0,bytesPerFeatureLabel:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}}};function s7t(t){return t.type==="web-style"?Wre:Zre(t.symbolLayers.toArray().map(e=>t$e(t,e)))}function Zre(t){let e=0,r=0,i=0,s=!1,n=0;const o={bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:0,bytesPerFeatureLabel:0,bytesPerCoordinate:0}};for(const a of t)a!=null&&(e+=a.primitivesPerFeature,r+=a.primitivesPerCoordinate,i+=a.drawCallsPerFeature,o.bytesPerFeature+=a.memory.bytesPerFeature,o.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.bytesPerCoordinate+=a.memory.bytesPerCoordinate,o.resourceBytes+=a.memory.resourceBytes,o.draped.bytesPerFeature+=a.memory.bytesPerFeature,o.draped.bytesPerFeatureLabel+=a.memory.bytesPerFeatureLabel,o.draped.bytesPerCoordinate+=a.memory.bytesPerCoordinate,s=s||a.estimated,++n);return{primitivesPerFeature:e,primitivesPerCoordinate:r,drawCallsPerFeature:i,estimated:s,memory:o,numComplexities:n}}function n7t(t){const e=Zre(t);return e.numComplexities>0&&(e.primitivesPerFeature/=e.numComplexities,e.primitivesPerCoordinate/=e.numComplexities,e.drawCallsPerFeature/=e.numComplexities,e.memory.bytesPerFeature/=e.numComplexities,e.memory.bytesPerFeatureLabel/=e.numComplexities,e.memory.bytesPerCoordinate/=e.numComplexities,e.memory.resourceBytes/=e.numComplexities,e.memory.draped.bytesPerFeature/=e.numComplexities,e.memory.draped.bytesPerFeatureLabel/=e.numComplexities,e.memory.draped.bytesPerCoordinate/=e.numComplexities),e}const ipe={};function t$e(t,e){const r=r$e(t,e),i=gat(e)?2:0;switch(e.type){case"extrude":return{primitivesPerFeature:-4,primitivesPerCoordinate:4,drawCallsPerFeature:i,estimated:!1,memory:r};case"fill":return t.type==="mesh-3d"?{primitivesPerFeature:0,primitivesPerCoordinate:0,drawCallsPerFeature:i,estimated:!1,memory:r}:e.outline!=null&&e.outline.size>0?{primitivesPerFeature:-4,primitivesPerCoordinate:3,drawCallsPerFeature:0,estimated:!1,memory:r}:{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"water":return{primitivesPerFeature:-2,primitivesPerCoordinate:1,drawCallsPerFeature:0,estimated:!1,memory:r};case"line":return{primitivesPerFeature:-2,primitivesPerCoordinate:2,drawCallsPerFeature:0,estimated:!1,memory:r};case"object":return e.resource?.href?{primitivesPerFeature:16,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!0,memory:r}:{...Qvt(e.resource&&e.resource.primitive||vK),memory:r};case"path":{let s=0,n=0;switch(e.profile){case"circle":s=JPe;break;case"quad":s=4;break;default:return void(e.profile,void 0)}switch(e.join??"simple"){case"round":n=YPe;break;case"miter":case"bevel":n=1;break;default:return}const o=2*s,a=s*n*2;let l=-2*a-o;switch(e.cap){case"none":break;case"butt":case"square":l+=2*(s-1);break;case"round":l+=2*(s*(RY-1)*2+s);break;default:return}return{primitivesPerFeature:l,primitivesPerCoordinate:a+o,drawCallsPerFeature:0,estimated:!1,memory:r}}case"text":case"icon":return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:r};default:return}}function r$e(t,e){const r=t.type==="point-3d";switch(e.type){case"extrude":return e.edges&&e.edges.size>0?Wl.EXTRUDE_EDGES:Wl.EXTRUDE;case"fill":return e.outline!=null&&e.outline.size>0?Wl.FILL_OUTLINE:Wl.FILL;case"water":return Wl.FILL;case"line":return e.join==="round"?Wl.LINE_ROUND:Wl.LINE_MITER;case"path":switch(e.join){case"round":switch(e.profile){case"circle":return Wl.PATH_ROUND_CIRCLE;case"quad":return Wl.PATH_ROUND_QUAD;default:return void(e.profile,void 0)}case"miter":case"bevel":switch(e.profile){case"circle":return Wl.PATH_MITER_CIRCLE;case"quad":return Wl.PATH_MITER_QUAD;default:return void(e.profile,void 0)}default:return}case"object":return r?Wl.OBJECT_POINT:Wl.OBJECT_POLYGON;case"icon":case"text":return r?Wl.ICON_POINT:Wl.ICON_POLYGON;default:return}}function Qvt(t){let e=ipe[t];if(e)return e;const r=e$e(t,null);return e={primitivesPerFeature:KPe(r.levels[0]).reduce((i,s)=>i+s.indices.get(E.POSITION).length/3,0),primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1},ipe[t]=e,e}const Wl={ICON_POINT:{bytesPerFeature:2321.5204640676384,bytesPerFeatureLabel:990.45722,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:2169.5155951150787,bytesPerFeatureLabel:999.2598599999999,bytesPerCoordinate:0}},ICON_POLYGON:{bytesPerFeature:3822.4566594216512,bytesPerFeatureLabel:1004.4288266666666,bytesPerCoordinate:3.8232947206245864,resourceBytes:0,draped:{bytesPerFeature:3656.161389156324,bytesPerFeatureLabel:994.9227800000001,bytesPerCoordinate:3.836714603517761}},OBJECT_POINT:{bytesPerFeature:1286.2669145138564,bytesPerFeatureLabel:1011.4901900000001,bytesPerCoordinate:0,resourceBytes:0,draped:{bytesPerFeature:1286.2669145138564,bytesPerFeatureLabel:1011.4901900000001,bytesPerCoordinate:0}},OBJECT_POLYGON:{bytesPerFeature:2796.828455517831,bytesPerFeatureLabel:1012.9951500000002,bytesPerCoordinate:4.051546356517487,resourceBytes:0,draped:{bytesPerFeature:2796.828455517831,bytesPerFeatureLabel:1012.9951500000002,bytesPerCoordinate:4.051546356517487}},LINE_MITER:{bytesPerFeature:4906.045480276492,bytesPerFeatureLabel:1002.8815266666666,bytesPerCoordinate:24.04850207798191,resourceBytes:0,draped:{bytesPerFeature:4315.785832179941,bytesPerFeatureLabel:998.7028333333334,bytesPerCoordinate:19.457038722015074}},LINE_ROUND:{bytesPerFeature:4893.576398024015,bytesPerFeatureLabel:1015.8812866666666,bytesPerCoordinate:24.039686621147293,resourceBytes:0,draped:{bytesPerFeature:4321.076505943878,bytesPerFeatureLabel:1008.7058400000001,bytesPerCoordinate:19.522527447599565}},PATH_MITER_CIRCLE:{bytesPerFeature:27475.37385725739,bytesPerFeatureLabel:945.1915,bytesPerCoordinate:1936.190695268645,resourceBytes:0,draped:{bytesPerFeature:27475.37385725739,bytesPerFeatureLabel:945.1915,bytesPerCoordinate:1936.190695268645}},PATH_ROUND_CIRCLE:{bytesPerFeature:13432.532036888486,bytesPerFeatureLabel:949.8167000000001,bytesPerCoordinate:4250.913048917402,resourceBytes:0,draped:{bytesPerFeature:13432.532036888486,bytesPerFeatureLabel:949.8167000000001,bytesPerCoordinate:4250.913048917402}},PATH_MITER_QUAD:{bytesPerFeature:17083.041162790672,bytesPerFeatureLabel:1006.4104,bytesPerCoordinate:1543.9135284683243,resourceBytes:0,draped:{bytesPerFeature:17083.041162790672,bytesPerFeatureLabel:1006.4104,bytesPerCoordinate:1543.9135284683243}},PATH_ROUND_QUAD:{bytesPerFeature:24054.406240577355,bytesPerFeatureLabel:976.0122999999999,bytesPerCoordinate:2683.863857257418,resourceBytes:0,draped:{bytesPerFeature:24054.406240577355,bytesPerFeatureLabel:976.0122999999999,bytesPerCoordinate:2683.863857257418}},FILL:{bytesPerFeature:5336.950602511737,bytesPerFeatureLabel:993.6785799999999,bytesPerCoordinate:9.558162275921951,resourceBytes:0,draped:{bytesPerFeature:4643.732435264264,bytesPerFeatureLabel:1003.6394400000001,bytesPerCoordinate:8.123952159573538}},FILL_OUTLINE:{bytesPerFeature:8210.8457089066,bytesPerFeatureLabel:1006.2871066666667,bytesPerCoordinate:14.496686428135353,resourceBytes:0,draped:{bytesPerFeature:6982.149803527473,bytesPerFeatureLabel:1005.1158800000001,bytesPerCoordinate:11.034666572000932}},EXTRUDE:{bytesPerFeature:16336.386002724352,bytesPerFeatureLabel:1013.2957066666665,bytesPerCoordinate:40.50904192903909,resourceBytes:0,draped:{bytesPerFeature:16336.386002724352,bytesPerFeatureLabel:1013.2957066666665,bytesPerCoordinate:40.50904192903909}},EXTRUDE_EDGES:{bytesPerFeature:18251.260762353977,bytesPerFeatureLabel:1044.1864133333333,bytesPerCoordinate:40.594518397678755,resourceBytes:0,draped:{bytesPerFeature:18251.260762353977,bytesPerFeatureLabel:1044.1864133333333,bytesPerCoordinate:40.594518397678755}}},a2=K.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayer");let Vg=class extends qre{constructor(e,r,i,s){super(i.schedule),this.symbol=e,this.symbolLayer=r,this._context=i,this._elevationInfoOverride=null,this.ignoreDrivers=!1,this._drivenProperties={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1},this.complexity=null,this.logger=a2,this._elevationOptions={supportsOffsetAdjustment:!1,supportsOnTheGround:!0},this.skipHighSymbolLodsChanged=!0,this._renderPriority=s.renderPriority,this._renderPriorityStep=s.renderPriorityStep,this._elevationContext=new Gf,this.complexity=this.computeComplexity(),this.ignoreDrivers=s.ignoreDrivers,this.ignoreDrivers||(this._drivenProperties=spe(this._context.renderer)),this._updateElevationContext()}getCachedSize(){return null}get extentPadding(){return 0}_drivenPropertiesChanged(e){if(this.ignoreDrivers)return!1;const r=this._drivenProperties,i=spe(e);return i.color!==r.color||i.opacity!==r.opacity||i.opacityAlwaysOpaque!==r.opacityAlwaysOpaque||i.size!==r.size}get needsDrivenTransparentPass(){return this._drivenProperties.opacity&&!this._drivenProperties.opacityAlwaysOpaque}_logGeometryCreationWarnings(e,r,i,s){const n=e.projectionSuccess,o="polygons"in e?e.polygons:null,a=`${s} geometry failed to be created`;let l=null;n?!this._logGeometryValidationWarnings(r,i,s)&&o&&o.length===0&&i==="rings"&&r.length>0&&r[0].length>2&&(l=`${a} (filled rings should use clockwise winding - try reversing the order of vertices)`):l=`${a} (failed to project geometry to view spatial reference)`,l&&a2.warnOncePerTick(l)}_logGeometryValidationWarnings(e,r,i){const s=`${i} geometry failed to be created`;return!e.length||e.length===1&&!e[0].length?(a2.warnOncePerTick(`${s} (no ${r} were defined)`),!0):(!Array.isArray(e)||!Array.isArray(e[0]))&&(a2.warnOncePerTick(`${s} (${r} should be defined as a 2D array)`),!0)}_validateGeometry(e,r=null,i=null){if(r!=null&&!r.includes(e.type))return this.logger.warn("unsupported geometry type for "+i+` symbol: ${e.type}`),!1;if(e.type==="point"){const s=e;if(!isFinite(s.x)||!isFinite(s.y))return a2.warn("point coordinate is not a valid number, graphic skipped"),!1}return!0}_defaultElevationInfoNoZ(){return Kvt}_defaultElevationInfoZ(){return e1t}_updateElevationContext(){this._elevationInfoOverride!=null?(this._elevationContext.setFromElevationInfo(this._elevationInfoOverride),this._elevationContext.updateFeatureExpressionInfoContext(null)):this._context.layer.elevationInfo?(this._elevationContext.setFromElevationInfo(this._context.layer.elevationInfo),this._elevationContext.updateFeatureExpressionInfoContext(this._context.featureExpressionInfoContext)):this._elevationContext.reset()}getDefaultElevationInfo(e){return e.hasZ?this._defaultElevationInfoZ():this._defaultElevationInfoNoZ()}getGeometryElevationMode(e,r=this.getDefaultElevationInfo(e)){return this._elevationContext.mode||r.mode}setElevationInfoOverride(e){this._elevationInfoOverride=e,this._updateElevationContext()}setGraphicElevationContext(e,r){const i=e.geometry,s=this.getDefaultElevationInfo(i);r.unit=this._elevationContext.unit!=null?this._elevationContext.unit:s.unit,r.mode=this.getGeometryElevationMode(i,s),r.offsetMeters=this._elevationContext.meterUnitOffset??s.offset??0;const n=!this._elevationOptions.supportsOnTheGround&&r.mode==="on-the-ground";n&&(r.mode="relative-to-ground",r.offsetMeters=0);const o=n?Wvt:this._elevationContext.featureExpressionInfoContext;return r.updateFeatureExpressionInfoContext(o,e,this._context.layer),r}prepareSymbolLayerPatch(e){}updateGeometry(e,r){return!1}updateTransform(e,r,i,s){return!1}onRemoveGraphic(e){}_getLayerOpacity(){return this._context.graphicsCoreOwner&&"fullOpacity"in this._context.graphicsCoreOwner?this._context.graphicsCoreOwner.fullOpacity??0:this._context.layer.opacity??1}_getCombinedOpacity(e,r=npe){let i=1;return this.draped||(i*=this._getLayerOpacity()),this._drivenProperties.opacity||(e!=null?i*=e.a:r.hasIntrinsicColor||(i=0)),i}_getCombinedOpacityAndColor(e,r=npe){const i=this._getCombinedOpacity(e,r);if(this._drivenProperties.color)return mI(null,i);const s=e!=null?Le.toUnitRGB(e):i0;return mI(s,i)}_getVertexOpacityAndColor(e,r=null){const i=this._drivenProperties.color?e.color:null,s=this._drivenProperties.opacity?e.opacity:null,n=mI(i,s);return r&&(n[0]*=r,n[1]*=r,n[2]*=r,n[3]*=r),n}isFastUpdatesEnabled(){return this._fastUpdates!=null}computeComplexity(){return t$e(this.symbol,this.symbolLayer)}globalPropertyChanged(e,r,i){switch(e){case"opacity":return this.layerOpacityChanged(r,i),!0;case"elevationInfo":{const s=this._elevationContext.mode;return this._updateElevationContext(),this.layerElevationInfoChanged(r,i,s)!==Is.RECREATE}case"slicePlaneEnabled":return this.slicePlaneEnabledChanged(r,i);case"physicalBasedRenderingEnabled":return this.physicalBasedRenderingChanged();case"pixelRatio":return this.pixelRatioChanged;case"skipHighSymbolLods":return this.skipHighSymbolLodsChanged;default:return!1}}get pixelRatioChanged(){return!0}updateGraphics3DGraphicElevationInfo(e,r,i){let s=Is.UPDATE;return e.forEach(n=>{const o=r(n);if(o!=null){const a=n.graphic;this.setGraphicElevationContext(a,o.elevationContext),o.needsElevationUpdates=i(o.elevationContext.mode)}else s=Is.RECREATE}),s}applyRendererDiff(e,r){return on.RecreateSymbol}getFastUpdateAttrValues(e){if(!this._fastUpdates)return null;const r=this._fastUpdates.visualVariables,i=r.size?Sf(r.size.field,e):0,s=r.color?Sf(r.color.field,e):0,n=r.opacity?Sf(r.opacity.field,e):0;return Vt(i,s,n,0)}get draped(){return this._draped}ensureDrapedStatus(e){return this._draped==null?(this._draped=e,!0):(e!==this.draped&&a2.warnOnce("A symbol can only produce either draped or non-draped visualizations. Use two separate symbol instances for draped and non-draped graphics if necessary."),!1)}test(){const e=()=>({size:this._fastUpdates?.visualVariables.size?.field??null,color:this._fastUpdates?.visualVariables.color?.field??null,opacity:this._fastUpdates?.visualVariables.opacity?.field??null,rotation:this._fastUpdates?.visualVariables.rotation?.field??null});return{drivenProperties:this._drivenProperties,getVisVarFields:e}}};function spe(t){const e={color:!1,opacity:!1,opacityAlwaysOpaque:!0,size:!1};return t&&"visualVariables"in t&&t.visualVariables&&t.visualVariables.forEach(r=>{switch(r.type){case"color":if(e.color=!0,r.stops)for(let i=0;i<r.stops.length;i++){const s=r.stops[i].color;s&&(e.opacity=!0,s.a<1&&(e.opacityAlwaysOpaque=!1))}break;case"opacity":e.opacity=!0,e.opacityAlwaysOpaque=!1;break;case"size":e.size=!0}}),e}const Kvt={mode:"on-the-ground",offset:0,unit:"meters"},e1t={mode:"absolute-height",offset:0,unit:"meters"},npe={hasIntrinsicColor:!1};let K0=class extends O${get geometries(){return this._geometries}get transformation(){return this._transformation??Un}set transformation(e){this._transformation=an(this._transformation??xe(),e),this._invalidateBoundingVolume(),this._emit("objectTransformation",this)}get shaderTransformation(){return this._shaderTransformation??this.transformation}set shaderTransformation(e){this._shaderTransformation=an(this._shaderTransformation??xe(),e),this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)}clearShaderTransformation(){this._shaderTransformation=void 0,this._invalidateBoundingVolume(),this._emit("objectShaderTransformation",this)}constructor(e={}){super(),this.type=Ms.Object,this._hasVolatileTransformation=!1,this._parentLayer=null,this._visible=!0,this.castShadow=e.castShadow??!0,this.usesVerticalDistanceToGround=e.usesVerticalDistanceToGround??!1,this.graphicUid=e.graphicUid,this.layerUid=e.layerUid,e.isElevationSource&&(this.lastValidElevationBB=new i$e),this._geometries=e.geometries?Array.from(e.geometries):new Array}dispose(){this._geometries.length=0}get parentLayer(){return this._parentLayer}set parentLayer(e){it(this._parentLayer==null||e==null,"Object3D can only be added to a single Layer"),this._parentLayer=e}addGeometry(e){e.visible=this._visible,this._geometries.push(e),this._hasVolatileTransformation=this._hasVolatileTransformation||e.hasVolatileTransformation,this._emit("objectGeometryAdded",{object:this,geometry:e}),this._invalidateBoundingVolume()}removeGeometry(e){const r=this._geometries.splice(e,1)[0];r&&(this._emit("objectGeometryRemoved",{object:this,geometry:r}),this._invalidateBoundingVolume())}removeAllGeometries(){for(;this._geometries.length>0;)this.removeGeometry(0)}geometryVertexAttrsUpdated(e){this._emit("objectGeometryUpdated",{object:this,geometry:e}),this._invalidateBoundingVolume()}get visible(){return this._visible}set visible(e){if(this._visible!==e){this._visible=e;for(const r of this._geometries)r.visible=this._visible;this._emit("visibilityChanged",this)}}maskOccludee(){const e=new xU($0.MaskOccludee);for(const r of this._geometries)r.occludees=XX(r.occludees,e);return this._emit("occlusionChanged",this),e}removeOcclude(e){for(const r of this._geometries)r.occludees=YX(r.occludees,e);this._emit("occlusionChanged",this)}highlight(){const e=new xU($0.Highlight);for(const r of this._geometries)r.highlights=XX(r.highlights,e);return this._emit("highlightChanged",this),e}removeHighlight(e){for(const r of this._geometries)r.highlights=YX(r.highlights,e);this._emit("highlightChanged",this)}getCombinedStaticTransformation(e,r){return yi(r,this.transformation,e.transformation)}getCombinedShaderTransformation(e,r=xe()){return yi(r,this.shaderTransformation,e.shaderTransformation)}hasVolativeTransformation(){return this._hasVolatileTransformation}get boundingVolumeWorldSpace(){return this._bvWorldSpace&&!this._hasVolatileTransformation||(this._bvWorldSpace=this._bvWorldSpace||new ope,this._validateBoundingVolume(this._bvWorldSpace,gI.WorldSpace)),this._bvWorldSpace}get boundingVolumeObjectSpace(){return this._bvObjectSpace&&!this._hasVolatileTransformation||(this._bvObjectSpace=this._bvObjectSpace||new ope,this._validateBoundingVolume(this._bvObjectSpace,gI.ObjectSpace)),this._bvObjectSpace}_validateBoundingVolume(e,r){const i=r===gI.ObjectSpace;for(const s of this._geometries){const n=s.boundingInfo;n&&t1t(n,e,i?s.shaderTransformation:this.getCombinedShaderTransformation(s))}Wr(e.bounds,e.min,e.max,.5);for(const s of this._geometries){const n=s.boundingInfo;if(n==null)continue;const o=i?s.shaderTransformation:this.getCombinedShaderTransformation(s),a=SA(o);Ne(ape,n.center,o);const l=_i(ape,e.bounds),c=n.radius*a;e.bounds[3]=Math.max(e.bounds[3],l+c)}}_invalidateBoundingVolume(){const e=this._bvWorldSpace?.bounds;this._bvObjectSpace=this._bvWorldSpace=void 0,this._parentLayer&&e&&this._parentLayer.notifyObjectBBChanged(this,e)}_emit(e,r){this._parentLayer&&this._parentLayer.events.emit(e,r)}get test(){const e=this;return{hasGeometry:r=>e._geometries.includes(r),getGeometryIndex:r=>e._geometries.indexOf(r)}}},i$e=class{constructor(){this.min=Ee(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),this.max=Ee(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE)}isEmpty(){return this.max[0]<this.min[0]&&this.max[1]<this.min[1]&&this.max[2]<this.min[2]}},ope=class extends i$e{constructor(){super(...arguments),this.bounds=js()}};function t1t(t,e,r){const i=t.bbMin,s=t.bbMax;if(xV(r)){const n=ie(r1t,r[12],r[13],r[14]);ue(Vu,i,n),ue(mp,s,n);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Vu[o]),e.max[o]=Math.max(e.max[o],mp[o])}else if(Ne(Vu,i,r),Jr(i,s))for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Vu[n]),e.max[n]=Math.max(e.max[n],Vu[n]);else{Ne(mp,s,r);for(let n=0;n<3;++n)e.min[n]=Math.min(e.min[n],Vu[n],mp[n]),e.max[n]=Math.max(e.max[n],Vu[n],mp[n]);for(let n=0;n<3;++n){oe(Vu,i),oe(mp,s),Vu[n]=s[n],mp[n]=i[n],Ne(Vu,Vu,r),Ne(mp,mp,r);for(let o=0;o<3;++o)e.min[o]=Math.min(e.min[o],Vu[o],mp[o]),e.max[o]=Math.max(e.max[o],Vu[o],mp[o])}}}const r1t=C(),Vu=C(),mp=C(),ape=C();var gI;(function(t){t[t.WorldSpace=0]="WorldSpace",t[t.ObjectSpace=1]="ObjectSpace"})(gI||(gI={}));function Xre(t,e,r,i,s,n){const o=t.clippingExtent;if(aa(e,v1,t.elevationProvider.spatialReference),o!=null&&!fK(o,v1))return null;aa(e,v1,t.renderCoordsHelper.spatialReference),r.shaderTransformer=n,r.localOrigin=t.localOriginFactory.getOrigin(v1);const a=new K0({geometries:[r],castShadow:!1,layerUid:t.layer.uid,graphicUid:s,usesVerticalDistanceToGround:!0});return{object:a,sampledElevation:Pvt(a,e,t.elevationProvider,t.renderCoordsHelper,i)}}function SP(t,e,r){const i=t.elevationContext,s=r.spatialReference;aa(e,v1,s),i.centerPointInElevationSR=Su(v1[0],v1[1],e.hasZ?v1[2]:0,s??null)}function EP(t){switch(t.type){case"point":return t;case"polygon":case"extent":return Bre(t);case"polyline":{const e=t.paths[0];if(!e||e.length===0)return null;const r=V1e(e,U1e(e)/2);return Su(r[0],r[1],r[2],t.spatialReference)}case"mesh":return t.origin}return null}const v1=C();function s$e(){return new Float32Array(2)}function i1t(t){const e=new Float32Array(2);return e[0]=t[0],e[1]=t[1],e}function Ed(t,e){const r=new Float32Array(2);return r[0]=t,r[1]=e,r}function s1t(t,e){return new Float32Array(t,e,2)}function n$e(){return s$e()}function o$e(){return Ed(1,1)}function a$e(){return Ed(1,0)}function l$e(){return Ed(0,1)}const c$e=n$e(),u$e=o$e(),n1t=a$e(),o1t=l$e();Object.freeze(Object.defineProperty({__proto__:null,ONES:u$e,UNIT_X:n1t,UNIT_Y:o1t,ZEROS:c$e,clone:i1t,create:s$e,createView:s1t,fromValues:Ed,ones:o$e,unitX:a$e,unitY:l$e,zeros:n$e},Symbol.toStringTag,{value:"Module"}));function a1t(t){const e=new Cr,{vertex:r,fragment:i}=e;return r.include(R8),e.include(jIe,t),e.include(Bs,t),e.attributes.add(E.UV0,"vec2"),r.uniforms.add(new cr("viewport",(s,n)=>n.camera.fullViewport),new Ie("lineSize",(s,n)=>s.size>0?Math.max(1,s.size)*n.camera.pixelRatio:0),new Pr("pixelToNDC",(s,n)=>hr(cpe,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new Ie("borderSize",(s,n)=>s.borderColor!=null?n.camera.pixelRatio:0),new Pr("screenOffset",(s,n)=>hr(cpe,s.screenOffset[0]*n.camera.pixelRatio,s.screenOffset[1]*n.camera.pixelRatio))),e.varyings.add("coverageSampling","vec4"),e.varyings.add("lineSizes","vec2"),t.hasMultipassGeometry&&e.varyings.add("depth","float"),t.hasScreenSizePerspective&&O8(r),r.code.add(w`
    void main(void) {
      ProjectHUDAux projectAux;
      vec4 endPoint = projectPositionHUD(projectAux);

      vec3 vpos = projectAux.posModel;
      if (rejectBySlice(vpos)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }
    ${t.occlusionTestEnabled?w`
      if (!testVisibilityHUD(endPoint)) {
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }`:""}

    ${t.hasScreenSizePerspective?w`
      vec4 perspectiveFactor = screenSizePerspectiveScaleFactor(projectAux.absCosAngle, projectAux.distanceToCamera, screenSizePerspectiveAlignment);
      vec2 screenOffsetScaled = applyScreenSizePerspectiveScaleFactorVec2(screenOffset, perspectiveFactor);
        `:w`vec2 screenOffsetScaled = screenOffset;`}
      // Add view dependent polygon offset to get exact same original starting point. This is mostly used to get the
      // correct depth value
      vec3 posView = (view * vec4(position, 1.0)).xyz;
      ${t.hasMultipassGeometry?"depth = posView.z;":""}

      applyHUDViewDependentPolygonOffset(auxpos1.w, projectAux.absCosAngle, posView);
      vec4 startPoint = proj * vec4(posView, 1.0);
      // Apply screen offset to both start and end point
      vec2 screenOffsetNorm = screenOffsetScaled * 2.0 / viewport.zw;
      startPoint.xy += screenOffsetNorm * startPoint.w;
      endPoint.xy += screenOffsetNorm * endPoint.w;
      // Align start and end to pixel origin
      vec4 startAligned = alignToPixelOrigin(startPoint, viewport.zw);
      vec4 endAligned = alignToPixelOrigin(endPoint, viewport.zw);
    ${t.depthHudEnabled?t.depthHudAlignStartEnabled?w`endAligned = vec4(endAligned.xy / endAligned.w * startAligned.w, startAligned.zw);`:w`startAligned = vec4(startAligned.xy / startAligned.w * endAligned.w, endAligned.zw);`:""}
      vec4 projectedPosition = mix(startAligned, endAligned, uv0.y);
      // The direction of the line in screen space
      vec2 screenSpaceDirection = normalize(endAligned.xy / endAligned.w - startAligned.xy / startAligned.w);
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x);
    ${t.hasScreenSizePerspective?w`
      float lineSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(lineSize, perspectiveFactor);
      float borderSizeScaled = applyScreenSizePerspectiveScaleFactorFloat(borderSize, perspectiveFactor);
        `:w`
      float lineSizeScaled = lineSize;
      float borderSizeScaled = borderSize;
        `}
      float halfPixelSize = lineSizeScaled * 0.5;

      // Compute full ndc offset, adding 1px padding for doing anti-aliasing and the border size
      float padding = 1.0 + borderSizeScaled;
      vec2 ndcOffset = (-halfPixelSize - padding + uv0.x * (lineSizeScaled + padding + padding)) * pixelToNDC;

      // Offset x/y from the center of the line in screen space
      projectedPosition.xy += perpendicularScreenSpaceDirection * ndcOffset * projectedPosition.w;

      // Compute a coverage varying which we can use in the fragment shader to determine
      // how much a pixel is actually covered by the line (i.e. to anti alias the line).
      // This works by computing two coordinates that can be linearly interpolated and then
      // subtracted to find out how far away from the line edge we are.
      float edgeDirection = (uv0.x * 2.0 - 1.0);

      float halfBorderSize = 0.5 * borderSizeScaled;
      float halfPixelSizeAndBorder = halfPixelSize + halfBorderSize;
      float outerEdgeCoverageSampler = edgeDirection * (halfPixelSizeAndBorder + halfBorderSize + 1.0);

      float isOneSided = float(lineSizeScaled < 2.0 && borderSize < 2.0);

      coverageSampling = vec4(
        // Edge coordinate
        outerEdgeCoverageSampler,

        // Border edge coordinate
        outerEdgeCoverageSampler - halfPixelSizeAndBorder * isOneSided,

        // Line offset
        halfPixelSize - 0.5,

        // Border offset
        halfBorderSize - 0.5 + halfPixelSizeAndBorder * (1.0 - isOneSided)
      );

      lineSizes = vec2(lineSizeScaled, borderSizeScaled);

      gl_Position = projectedPosition;
    }
  `),i.uniforms.add(new cr("uColor",s=>lpe(s.color)),new cr("borderColor",s=>lpe(s.borderColor))),t.hasMultipassGeometry&&(i.include(x3e,t),i.uniforms.add(new Pr("inverseViewport",(s,n)=>n.inverseViewport))),i.code.add(w`
    void main() {
      ${t.hasMultipassGeometry?"if( geometryDepthTest(gl_FragCoord.xy * inverseViewport, depth) ){ discard; }":""}

      // Mix between line and border coverage offsets depending on whether we need
      // a border (based on the sidedness).
      vec2 coverage = min(1.0 - clamp(abs(coverageSampling.xy) - coverageSampling.zw, 0.0, 1.0), lineSizes);

      // Mix between border and line color based on the line coverage (conceptually the line blends on top of the
      // border background).
      //
      // Anti-alias by blending final result using the full (including optional border) coverage and the color alpha
      float borderAlpha = uColor.a * borderColor.a * coverage.y;
      float colorAlpha = uColor.a * coverage.x;

      float finalAlpha = mix(borderAlpha, 1.0, colorAlpha);

    ${t.depthHudEnabled?w`
      if (finalAlpha < 0.01) {
        discard;
      }
      `:w`
      vec3 finalRgb = mix(borderColor.rgb * borderAlpha, uColor.rgb, colorAlpha);
      fragColor = vec4(finalRgb, finalAlpha);
      `}
  }
  `),e}function lpe(t){return t??ng}const cpe=Pe(),l1t=Object.freeze(Object.defineProperty({__proto__:null,build:a1t},Symbol.toStringTag,{value:"Module"}));let h$e=class d$e extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global}initializeProgram(e){return new Lr(e.rctx,d$e.shader.get().build(this.configuration),Er)}setPipelineState(e){const r=e?ci.ALWAYS:ci.LESS;return this.configuration.depthHudEnabled?It({depthTest:{func:r},depthWrite:Ac}):It({blending:ca(Te.ONE,Te.SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:r},colorWrite:Wt})}initializePipeline(){return this.setPipelineState(this.configuration.hasMultipassGeometry)}};h$e.shader=new $r(l1t,()=>J(()=>import("./LineCallout.glsl-cfdf230f.js"),[],import.meta.url));let id=class extends Ea{constructor(){super(...arguments),this.screenCenterOffsetUnitsEnabled=mc.World,this.spherical=!1,this.occlusionTestEnabled=!0,this.hasVerticalOffset=!1,this.hasScreenSizePerspective=!1,this.depthHudEnabled=!1,this.depthHudAlignStartEnabled=!1,this.hasSlicePlane=!1,this.hasMultipassGeometry=!1}};u([B({count:mc.COUNT})],id.prototype,"screenCenterOffsetUnitsEnabled",void 0),u([B()],id.prototype,"spherical",void 0),u([B()],id.prototype,"occlusionTestEnabled",void 0),u([B()],id.prototype,"hasVerticalOffset",void 0),u([B()],id.prototype,"hasScreenSizePerspective",void 0),u([B()],id.prototype,"depthHudEnabled",void 0),u([B()],id.prototype,"depthHudAlignStartEnabled",void 0),u([B()],id.prototype,"hasSlicePlane",void 0),u([B()],id.prototype,"hasMultipassGeometry",void 0),u([B({constValue:!0})],id.prototype,"hasSliceInVertexProgram",void 0),u([B({constValue:!1})],id.prototype,"draped",void 0);let uN=class MY extends mb{get uniqueMaterialIdentifier(){return this._uniqueMaterialIdentifier}constructor(e){super(e,new p$e),this._configuration=new id,this._uniqueMaterialIdentifier=MY.uniqueMaterialIdentifier(this.parameters)}getPassParameters(){return this.parameters}getConfiguration(e,r){const i=r?.slot!==fe.LINE_CALLOUTS;return this._configuration.occlusionTestEnabled=this.parameters.occlusionTest,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.depthHudEnabled=i,this._configuration.depthHudAlignStartEnabled=!!this.parameters.depthHUDAlignStart,this._configuration.screenCenterOffsetUnitsEnabled=this.parameters.centerOffsetUnits==="screen"?mc.Screen:mc.World,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasMultipassGeometry=r.multipassGeometry.enabled,this._configuration}intersect(){}requiresSlot(e,r){if(r===k.Color)switch(e){case fe.LINE_CALLOUTS:case fe.LINE_CALLOUTS_HUD_DEPTH:return!0}return!1}createGLMaterial(e){return new c1t(e)}createBufferWriter(){return new h1t}validateParameters(e){const r=MY.uniqueMaterialIdentifier(e);r!==this._uniqueMaterialIdentifier&&(this._uniqueMaterialIdentifier=r)}static uniqueMaterialIdentifier(e){return JSON.stringify({screenOffset:e.screenOffset||[0,0],centerOffsetUnits:e.centerOffsetUnits||"world"})}},c1t=class extends pb{beginSlot(e){return this.ensureTechnique(h$e,e)}},p$e=class extends Dre{constructor(){super(...arguments),this.screenOffset=Df,this.color=[0,0,0,1],this.size=1,this.occlusionTest=!1,this.shaderPolygonOffset=1e-5,this.depthHUDAlignStart=!1,this.centerOffsetUnits="world",this.hasSlicePlane=!1}};const u1t=us().vec3f(E.POSITION).vec3f(E.NORMAL).vec2f(E.UV0).vec4f(E.AUXPOS1),upe=[Ed(0,0),Ed(1,0),Ed(0,1),Ed(1,0),Ed(1,1),Ed(0,1)];let h1t=class{constructor(){this.vertexBufferLayout=u1t}elementCount(e){return 6*e.indices.get(E.POSITION).length}write(e,r,i,s,n){Nre(i.indices.get(E.POSITION),i.vertexAttributes.get(E.POSITION).data,e,s.position,n,6),Fre(i.indices.get(E.NORMAL),i.vertexAttributes.get(E.NORMAL).data,r,s.normal,n,6),FA(i.indices.get(E.AUXPOS1),i.vertexAttributes.get(E.AUXPOS1).data,s.auxpos1,n,6);for(let o=0;o<upe.length;++o)s.uv0.setVec(n+o,upe[o])}},f$e=class m$e extends Vg{constructor(e,r){super(e,null,r,f1t),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){this._material=new uN(this._materialParameters),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}_perInstanceMaterialParameters(e){const r=this._materialParameters;return r.screenOffset=e.screenOffset||Df,r.centerOffsetUnits=e.centerOffsetUnits||"world",r}get _materialParameters(){const e=new p$e,r=this.symbol,i=r.callout;if(e.color=i.color!=null?Le.toUnitRGBA(i.color):[0,0,0,0],e.color[3]*=this._getLayerOpacity(),e.size=vi(i.size||0),r.verticalOffset){const{screenLength:o,minWorldLength:a,maxWorldLength:l}=r.verticalOffset;e.verticalOffset={screenLength:vi(o),minWorldLength:a||0,maxWorldLength:l??1/0}}e.borderColor=i.border!=null&&i.border.color!=null?Le.toUnitRGBA(i.border.color):null;const s=r.symbolLayers.at(0).type==="object",n=r.type==="label-3d";return e.occlusionTest=!s,e.shaderPolygonOffset=s?0:void 0,e.depthHUDAlignStart=n,e.hasSlicePlane=this._context.slicePlaneEnabled,e.screenSizePerspective=this._context.screenSizePerspectiveEnabled?this._context.sharedResources.screenSizePerspectiveSettings:null,e}_defaultElevationInfoNoZ(){return p1t}createGraphics3DGraphic(e){const r=e.renderingInfo,i=e.graphic,s=this.setGraphicElevationContext(i,new Gf,r.elevationOffset||0),n=r.symbol,o=this._elevationContext.mode==="on-the-ground"&&(n.type==="cim"||!n.symbolLayers.some(l=>l.type==="object"||l.type==="text"));if(n.type!=="label-3d"&&o||n.type==="point-3d"&&n.symbolLayers.every(l=>l.type==="text"&&!Mxe(l)))return null;const a=Bre(i.geometry);return a==null?null:this._createAs3DShape(a,s,r,i.uid)}layerOpacityChanged(){this._material?.setParameters(this._materialParameters)}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=N$(m$e.elevationModeChangeTypes,i,s);return n!==Is.UPDATE||e.forEach(o=>{const a=r(o);a!=null&&this.updateGraphicElevationContext(o.graphic,a)}),n}slicePlaneEnabledChanged(){return this._material?.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}updateGraphicElevationContext(e,r){this.setGraphicElevationContext(e,r.elevationContext,r.metadata!=null?r.metadata.elevationOffset:0),r.needsElevationUpdates=Qd(r.elevationContext.mode)}computeComplexity(){return{primitivesPerFeature:2,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:Wre.memory}}_createVertexData(e){const{translation:r,centerOffset:i}=e,s=new Ge(r?[r[0],r[1],r[2]]:[0,0,0],3,!0),n=new Ge(i?[i[0],i[1],i[2],i[3]]:[0,0,0,1],4,!0);return[[E.POSITION,s],[E.NORMAL,new Ge([0,0,1],3,!0)],[E.AUXPOS1,n]]}_getOrCreateMaterial(e){const r=this._perInstanceMaterialParameters(e),i=uN.uniqueMaterialIdentifier(r);if(this._material&&i===this._material.uniqueMaterialIdentifier)return{material:this._material,isUnique:!1};if(e.materialCollection!=null){let s=e.materialCollection.get(i);return s==null&&(s=new uN(r),e.materialCollection.add(i,s)),{material:s,isUnique:!1}}return{material:new uN(r),isUnique:!0}}_createAs3DShape(e,r,i,s){const n=this._context.layer.uid,o=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:n}),a=this._getOrCreateMaterial(i),l=new mn(a.material,this._createVertexData(i),d1t,null,Ms.Point,o),c=Xre(this._context,e,l,r,s);if(c==null)return null;const h=new Ug(this,c.object,[l],a.isUnique?[a.material]:null,null,uT,r);return h.metadata=new XPe(i.elevationOffset),h.alignedSampledElevation=c.sampledElevation,h.needsElevationUpdates=Qd(r.mode),SP(h,e,this._context.elevationProvider),h}};f$e.elevationModeChangeTypes={definedChanged:Is.UPDATE,staysOnTheGround:Is.UPDATE,onTheGroundChanged:Is.RECREATE};const QB=[0],d1t=[[E.POSITION,QB],[E.NORMAL,QB],[E.AUXPOS1,QB]],p1t={mode:"relative-to-ground",offset:0},f1t={ignoreDrivers:!0,renderPriority:0,renderPriorityStep:1};let m1t=class{constructor(e,r,i=C(),s=Qt(),n=Pe(),o="world",a=0,l=null){this.renderer=e,this.symbol=r,this.translation=i,this.centerOffset=s,this.screenOffset=n,this.centerOffsetUnits=o,this.elevationOffset=a,this.materialCollection=l}},g1t=class extends Zvt{};const hpe=K.getLogger("esri.views.3d.layers.graphics.Graphics3DCalloutSymbolLayerFactory");function y1t(t,e){if(!TK(t))return hpe.error("Graphics3DCalloutSymbolLayerFactory#make",`symbol of type '${t.type}' does not support callouts`),null;if(!t.callout)return null;const r=_1t[t.callout.type];return r?new r(t,e):(hpe.error("Graphics3DCalloutSymbolLayerFactory#make",`unknown or unsupported callout type ${t.callout.type}`),null)}const _1t={line:f$e};let qT=class g$e{constructor(e=null,r={},i,s){this.geometry=e,this.attributes=r,this.centroid=i,this.objectId=s,this.displayId=0,this.geohashX=0,this.geohashY=0}weakClone(){const e=new g$e(this.geometry,this.attributes,this.centroid,this.objectId);return e.displayId=this.displayId,e.geohashX=this.geohashX,e.geohashY=this.geohashY,e}};function g7t(t){return!(t.geometry==null||!t.geometry.coords||!t.geometry.coords.length)}let y7t=class extends qT{},v1t=class y$e{constructor(){this.objectIdFieldName=null,this.globalIdFieldName=null,this.geohashFieldName=null,this.geometryProperties=null,this.geometryType=null,this.spatialReference=null,this.hasZ=!1,this.hasM=!1,this.features=[],this.fields=[],this.transform=null,this.exceededTransferLimit=!1,this.uniqueIdField=null,this.queryGeometryType=null,this.queryGeometry=null}weakClone(){const e=new y$e;return e.objectIdFieldName=this.objectIdFieldName,e.globalIdFieldName=this.globalIdFieldName,e.geohashFieldName=this.geohashFieldName,e.geometryProperties=this.geometryProperties,e.geometryType=this.geometryType,e.spatialReference=this.spatialReference,e.hasZ=this.hasZ,e.hasM=this.hasM,e.features=this.features,e.fields=this.fields,e.transform=this.transform,e.exceededTransferLimit=this.exceededTransferLimit,e.uniqueIdField=this.uniqueIdField,e.queryGeometry=this.queryGeometry,e.queryGeometryType=this.queryGeometryType,e}},sb=class a5{constructor(e=[],r=[],i=!1){this.lengths=e??[],this.coords=r??[],this.hasIndeterminateRingOrder=i}static fromRect(e){const[r,i,s,n]=e,o=s-r,a=n-i;return new a5([5],[r,i,o,0,0,a,-o,0,0,-a])}get isPoint(){return this.lengths.length===0}get maxLength(){return Math.max(...this.lengths)}get size(){return this.lengths.reduce((e,r)=>e+r)}forEachVertex(e){let r=0;this.lengths.length||e(this.coords[0],this.coords[1]);for(let i=0;i<this.lengths.length;i++){const s=this.lengths[i];for(let n=0;n<s;n++)e(this.coords[2*(n+r)],this.coords[2*(n+r)+1]);r+=s}}clone(e){return e?(e.set(this.coords),new a5(this.lengths.slice(),e,this.hasIndeterminateRingOrder)):new a5(this.lengths.slice(),this.coords.slice(),this.hasIndeterminateRingOrder)}};function il(t,e){return t?e?4:3:e?3:2}const k$=K.getLogger("esri.layers.graphics.featureConversionUtils"),_$e={esriGeometryPoint:0,esriGeometryPolyline:2,esriGeometryPolygon:3,esriGeometryMultipoint:0,esriGeometryEnvelope:0},b1t=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n},dpe=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2]},w1t=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+3]},x1t=(t,e,r,i,s,n)=>{t[r]=s,t[r+1]=n,t[r+2]=e[i+2],t[r+3]=e[i+3]};function Yre(t,e,r,i){if(t){if(r)return e&&i?x1t:dpe;if(e&&i)return w1t}else if(e&&i)return dpe;return b1t}function KB({scale:t,translate:e},r){return Math.round((r-e[0])/t[0])}function eG({scale:t,translate:e},r){return Math.round((e[1]-r)/t[1])}function tG({scale:t,translate:e},r,i){return r*t[i]+e[i]}function v7t(t,e,r){return t?e?r?Kre(t):Jre(t):r?Qre(t):F8(t):null}function F8(t){const e=t.coords;return{x:e[0],y:e[1]}}function v$e(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t}function Jre(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2]}}function T1t(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t}function Qre(t){const e=t.coords;return{x:e[0],y:e[1],m:e[2]}}function S1t(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.m,t}function Kre(t){const e=t.coords;return{x:e[0],y:e[1],z:e[2],m:e[3]}}function E1t(t,e){return t.coords[0]=e.x,t.coords[1]=e.y,t.coords[2]=e.z,t.coords[3]=e.m,t}function C1t(t,e,r,i){let s=F8;r&&i?s=Kre:r?s=Jre:i&&(s=Qre);for(const n of e){const{geometry:o,attributes:a}=n,l=o!=null?s(o):null;t.push({attributes:a,geometry:l})}return t}function eie(t,e){return t&&e?E1t:t?T1t:e?S1t:v$e}function A1t(t,e,r,i,s){const n=eie(r,i);for(const{geometry:o,attributes:a}of e){const l=o!=null?n(new sb,o):null;t.push(new qT(l,a,null,s?a[s]:void 0))}return t}function b7t(t,e,r=eie(e.z!=null,e.m!=null)){return r(t,e)}function O1t(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:s!=null?b$e(s,r,i):null});return t}function b$e(t,e,r){if(t==null)return null;const i=il(e,r),s=[];for(let n=0;n<t.coords.length;n+=i){const o=[];for(let a=0;a<i;a++)o.push(t.coords[n+a]);s.push(o)}return e?r?{points:s,hasZ:e,hasM:r}:{points:s,hasZ:e}:r?{points:s,hasM:r}:{points:s}}function R1t(t,e,r,i,s){const n=il(r,i);for(const{geometry:o,attributes:a}of e){const l=o!=null?w$e(new sb,o,n):null;t.push(new qT(l,a,null,s?a[s]:void 0))}return t}function w$e(t,e,r=il(e.hasZ,e.hasM)){t.lengths[0]=e.points.length;const i=t.coords;let s=0;for(const n of e.points)for(let o=0;o<r;o++)i[s++]=n[o];return t}function M1t(t,e,r,i){for(const{geometry:s,attributes:n}of e)t.push({attributes:n,geometry:s!=null?x$e(s,r,i):null});return t}function x$e(t,e,r){if(!t)return null;const i=il(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{paths:o,hasZ:e,hasM:r}:{paths:o,hasZ:e}:r?{paths:o,hasM:r}:{paths:o}}function I1t(t,e,r,i,s){const n=il(r,i);for(const{geometry:o,attributes:a}of e){const l=o!=null?T$e(new sb,o,n):null;t.push(new qT(l,a,null,s?a[s]:void 0))}return t}function T$e(t,e,r=il(e.hasZ,e.hasM)){const{lengths:i,coords:s}=t;let n=0;for(const o of e.paths){for(const a of o)for(let l=0;l<r;l++)s[n++]=a[l];i.push(o.length)}return t}function P1t(t,e,r,i){for(const{geometry:s,attributes:n,centroid:o}of e){const a=s!=null?S$e(s,r,i):null;if(o!=null){const l=F8(o);t.push({attributes:n,centroid:l,geometry:a})}else t.push({attributes:n,geometry:a})}return t}function S$e(t,e,r){if(!t)return null;const i=il(e,r),{coords:s,lengths:n}=t,o=[];let a=0;for(const l of n){const c=[];for(let h=0;h<l;h++){const p=[];for(let f=0;f<i;f++)p.push(s[a++]);c.push(p)}o.push(c)}return e?r?{rings:o,hasZ:e,hasM:r}:{rings:o,hasZ:e}:r?{rings:o,hasM:r}:{rings:o}}function $1t(t,e,r,i,s){for(const{geometry:n,centroid:o,attributes:a}of e){const l=n!=null?E$e(new sb,n,r,i):null,c=s?a[s]:void 0;o!=null?t.push(new qT(l,a,v$e(new sb,o),c)):t.push(new qT(l,a,null,c))}return t}function E$e(t,e,r=e.hasZ,i=e.hasM){return L1t(t,e.rings,r,i)}function L1t(t,e,r,i){const s=il(r,i),{lengths:n,coords:o}=t;let a=0;_0(t);for(const l of e){for(const c of l)for(let h=0;h<s;h++)o[a++]=c[h];n.push(l.length)}return t}const jC=[],yI=[];function w7t(t,e,r,i,s){jC[0]=t;const[n]=C$e(yI,jC,e,r,i,s);return Uf(jC),Uf(yI),n}function C$e(t,e,r,i,s,n){if(Uf(t),!r){for(const o of e){const a=n?o.attributes[n]:void 0;t.push(new qT(null,o.attributes,null,a))}return t}switch(r){case"esriGeometryPoint":return A1t(t,e,i,s,n);case"esriGeometryMultipoint":return R1t(t,e,i,s,n);case"esriGeometryPolyline":return I1t(t,e,i,s,n);case"esriGeometryPolygon":return $1t(t,e,i,s,n);default:k$.error("convertToFeatureSet:unknown-geometry",new D(`Unable to parse unknown geometry type '${r}'`)),Uf(t)}return t}function x7t(t,e,r,i){yI[0]=t,A$e(jC,yI,e,r,i);const s=jC[0];return Uf(jC),Uf(yI),s}function D1t(t,e,r){if(t==null)return null;const i=new sb;return"hasZ"in t&&e==null&&(e=t.hasZ),"hasM"in t&&r==null&&(r=t.hasM),zQ(t)?eie(e??t.z!=null,r??t.m!=null)(i,t):TC(t)?E$e(i,t,e,r):BQ(t)?T$e(i,t,il(e,r)):VQ(t)?w$e(i,t,il(e,r)):void k$.error("convertFromGeometry:unknown-geometry",new D(`Unable to parse unknown geometry type '${t}'`))}function N1t(t,e,r,i){const s=t&&("coords"in t?t:t.geometry);if(s==null)return null;switch(e){case"esriGeometryPoint":{let n=F8;return r&&i?n=Kre:r?n=Jre:i&&(n=Qre),n(s)}case"esriGeometryMultipoint":return b$e(s,r,i);case"esriGeometryPolyline":return x$e(s,r,i);case"esriGeometryPolygon":return S$e(s,r,i);default:return k$.error("convertToGeometry:unknown-geometry",new D(`Unable to parse unknown geometry type '${e}'`)),null}}function F1t(t,e){for(const r of e)t.push({attributes:r.attributes});return t}function A$e(t,e,r,i,s){if(Uf(t),r==null)return F1t(t,e);switch(r){case"esriGeometryPoint":return C1t(t,e,i,s);case"esriGeometryMultipoint":return O1t(t,e,i,s);case"esriGeometryPolyline":return M1t(t,e,i,s);case"esriGeometryPolygon":return P1t(t,e,i,s);default:k$.error("convertToFeatureSet:unknown-geometry",new D(`Unable to parse unknown geometry type '${r}'`))}return t}function T7t(t){const{objectIdFieldName:e,spatialReference:r,transform:i,fields:s,hasM:n,hasZ:o,features:a,geometryType:l,exceededTransferLimit:c,uniqueIdField:h,queryGeometry:p,queryGeometryType:f}=t,m={features:A$e([],a,l,o,n),fields:s,geometryType:l,objectIdFieldName:e,spatialReference:r,uniqueIdField:h,queryGeometry:N1t(p,f,!1,!1)};return i&&(m.transform=i),c&&(m.exceededTransferLimit=c),n&&(m.hasM=n),o&&(m.hasZ=o),m}function S7t(t,e){const r=new v1t,{hasM:i,hasZ:s,features:n,objectIdFieldName:o,spatialReference:a,geometryType:l,exceededTransferLimit:c,transform:h,fields:p}=t;return p&&(r.fields=p),r.geometryType=l??null,r.objectIdFieldName=o??e??null,r.spatialReference=a??null,r.objectIdFieldName?(n&&C$e(r.features,n,l,s,i,r.objectIdFieldName),c&&(r.exceededTransferLimit=c),i&&(r.hasM=i),s&&(r.hasZ=s),h&&(r.transform=h),r):(k$.error(new D("optimized-features:invalid-objectIdFieldName","objectIdFieldName is missing")),r)}function E7t(t){const{transform:e,features:r,hasM:i,hasZ:s}=t;if(!e)return t;for(const n of r)n.geometry!=null&&fpe(n.geometry,n.geometry,i,s,e),n.centroid!=null&&fpe(n.centroid,n.centroid,i,s,e);return t.transform=null,t}function C7t(t,e){const{geometryType:r,features:i,hasM:s,hasZ:n}=e;if(!t)return e;for(let o=0;o<i.length;o++){const a=i[o],l=a.weakClone();l.geometry=new sb,ppe(l.geometry,a.geometry,s,n,r,t),a.centroid&&(l.centroid=new sb,ppe(l.centroid,a.centroid,s,n,"esriGeometryPoint",t)),i[o]=l}return e.transform=t,e}function ppe(t,e,r,i,s,n,o=r,a=i){if(_0(t),e==null||!e.coords.length)return null;const l=_$e[s],{coords:c,lengths:h}=e,p=il(r,i),f=il(r&&o,i&&a),m=Yre(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,KB(n,c[0]),eG(n,c[1])),_0(t,p,0),t;let g,_,v,b,x=0,T=0,S=T;for(const O of h){if(O<l)continue;let A=0;T=S,v=g=KB(n,c[x]),b=_=eG(n,c[x+1]),m(t.coords,c,T,x,v,b),A++,x+=p,T+=f;for(let M=1;M<O;M++,x+=p)v=KB(n,c[x]),b=eG(n,c[x+1]),v===g&&b===_||(m(t.coords,c,T,x,v-g,b-_),T+=f,A++,g=v,_=b);A>=l&&(t.lengths.push(A),S=T)}return Uf(t.coords,S),t.coords.length?t:null}function A7t(t,e,r,i,s,n,o=r,a=i){if(_0(t),!e||!e.coords.length)return null;const l=_$e[s],{coords:c,lengths:h}=e,p=il(r,i),f=il(r&&o,i&&a),m=Yre(r,i,o,a);if(!h.length)return m(t.coords,c,0,0,c[0],c[1]),_0(t,p,0),t;let g=0;const _=n*n;for(const v of h){if(v<l){g+=v*p;continue}const b=t.coords.length/f,x=g,T=g+(v-1)*p;m(t.coords,c,t.coords.length,x,c[x],c[x+1]),IY(t.coords,c,p,_,m,x,T),m(t.coords,c,t.coords.length,T,c[T],c[T+1]);const S=t.coords.length/f-b;S>=l?t.lengths.push(S):Uf(t.coords,b*f),g+=v*p}return t.coords.length?t:null}function k1t(t,e,r,i){const s=t[e],n=t[e+1],o=t[r],a=t[r+1],l=t[i],c=t[i+1];let h=o,p=a,f=l-h,m=c-p;if(f!==0||m!==0){const g=((s-h)*f+(n-p)*m)/(f*f+m*m);g>1?(h=l,p=c):g>0&&(h+=f*g,p+=m*g)}return f=s-h,m=n-p,f*f+m*m}function IY(t,e,r,i,s,n,o){let a,l=i,c=0;for(let h=n+r;h<o;h+=r)a=k1t(e,h,n,o),a>l&&(c=h,l=a);l>i&&(c-n>r&&IY(t,e,r,i,s,n,c),s(t,e,t.length,c,e[c],e[c+1]),o-c>r&&IY(t,e,r,i,s,c,o))}function O7t(t,e,r,i){if(e==null||!e.coords||!e.coords.length)return null;const s=il(r,i);let n=Number.POSITIVE_INFINITY,o=Number.POSITIVE_INFINITY,a=Number.NEGATIVE_INFINITY,l=Number.NEGATIVE_INFINITY;if(e&&e.coords){const c=e.coords;for(let h=0;h<c.length;h+=s){const p=c[h],f=c[h+1];n=Math.min(n,p),a=Math.max(a,p),o=Math.min(o,f),l=Math.max(l,f)}}return uH(t)?p7e(t,n,o,a,l):DQ(n,o,a,l,t),t}function fpe(t,e,r,i,s){const{coords:n,lengths:o}=e,a=il(r,i);if(!n.length)return t!==e&&_0(t),t;rS(s);const{originPosition:l,scale:c,translate:h}=s,p=V1t;p.originPosition=l;const f=p.scale;f[0]=c[0]??1,f[1]=-(c[1]??1),f[2]=c[2]??1,f[3]=c[3]??1;const m=p.translate;if(m[0]=h[0]??0,m[1]=h[1]??0,m[2]=h[2]??0,m[3]=h[3]??0,!o.length){for(let _=0;_<a;++_)t.coords[_]=tG(p,n[_],_);return t!==e&&_0(t,a,0),t}let g=0;for(let _=0;_<o.length;_++){const v=o[_];t.lengths[_]=v;for(let T=0;T<a;++T)t.coords[g+T]=tG(p,n[g+T],T);let b=t.coords[g],x=t.coords[g+1];g+=a;for(let T=1;T<v;T++,g+=a){b+=n[g]*f[0],x+=n[g+1]*f[1],t.coords[g]=b,t.coords[g+1]=x;for(let S=2;S<a;++S)t.coords[g+S]=tG(p,n[g+S],S)}}return t!==e&&_0(t,n.length,o.length),t}function R7t(t,e,r,i,s,n){if(_0(t),t.lengths.push(...e.lengths),r===s&&i===n)for(let o=0;o<e.coords.length;o++)t.coords.push(e.coords[o]);else{const o=il(r,i),a=Yre(r,i,s,n),l=e.coords;for(let c=0;c<l.length;c+=o)a(t.coords,l,t.coords.length,c,l[c],l[c+1])}return t}function U1t(t,e,r,i){let s=0,n=t[i*e],o=t[i*(e+1)];for(let a=1;a<r;a++){const l=n+t[i*(e+a)],c=o+t[i*(e+a)+1],h=(l-n)*(c+o);n=l,o=c,s+=h}return .5*s}function M7t(t,e){const{coords:r,lengths:i}=t;let s=0,n=0;for(let o=0;o<i.length;o++){const a=i[o];n+=U1t(r,s,a,e),s+=a}return Math.abs(n)}function _0(t,e=0,r=0){Uf(t.lengths,r),Uf(t.coords,e)}function Uf(t,e=0){t.length!==e&&(t.length=e)}const V1t={originPosition:"lowerLeft",scale:[1,1,1,1],translate:[0,0,0,0]},mpe=new $o(Array,t=>K6(t,dxe),null,10,5),z1t=Ht();let B1t=class{get labelLayers(){return this._labelLayers||E4e}get extent(){return this._extent}get isElevationSource(){return this.layers.some(e=>e?.isElevationSource)}constructor(e,r,i,s,n){this.graphic=e,this.graphics3DSymbol=r,this.layers=i,this._visibleFlags=Ca.ALL_LABEL,this.deconflictionPriority=0,++r.referenced,this._featureExpressionFeature=n?HPe(n,e,s):null}initialize(e){this._layer=e,this._forEachSymbolLayerGraphic(r=>{r.initialize(e),r.setVisibility(this.isVisible())})}destroy(){this._forEachSymbolLayerGraphic(e=>e.destroy()),this._calloutLayer=null,--this.graphics3DSymbol.referenced,this.graphics3DSymbol=null}get destroyed(){return this.layers==null}clearLabelGraphics(){this._forEachLabelGraphic(e=>e.destroy()),this._labelLayers=null}addLabelGraphic(e,r){this._labelLayers||(this._labelLayers=new Array),this._labelLayers.push(e),e.initialize(r),e.setVisibility(this.isVisible(Mo.LABEL))}setCalloutGraphic(e){this._calloutLayer=e,this._layer&&(e.initialize(this._layer),e.setVisibility(this.isVisible()))}get calloutLayer(){return this._calloutLayer}get isDraped(){let e=!1;return this._forEachSymbolLayerGraphic(r=>{r.type==="draped"&&(e=!0)}),e}isVisible(e=Mo.GRAPHIC,r){const i=r?this._visibleFlags|r|Mo.LABEL*r:this._visibleFlags;return e===Mo.GRAPHIC?(i&Ca.ALL_GRAPHIC)===Ca.ALL_GRAPHIC:(i&Ca.ALL_LABEL)===Ca.ALL_LABEL}setVisibilityFlag(e,r,i){const s=this.isVisible(e);i?this._visibleFlags|=e*r:this._visibleFlags&=~(e*r);const n=this.isVisible(e);if(s===n)return!1;if(e===Mo.LABEL)this._forEachLabelGraphic(o=>o.setVisibility(n));else{this._forEachSymbolLayerGraphic(a=>a.setVisibility(n));const o=this.isVisible(Mo.LABEL);this._forEachLabelGraphic(a=>a.setVisibility(o))}return!0}getVisibilityFlag(e,r){return(this._visibleFlags&e*r)!=0}computeExtent(e){if(!this._extent){const r=this.graphic.geometry;if(r==null)return!1;this._extent=Ht(),_it(r,this._extent);const i=r.spatialReference;if(!Bn(i,e)&&!_$(this._extent,i,this._extent,e))return this._extent=null,!1}return!0}getAsOptimizedGeometry(e,r){return this._optimizedGeometry||(this._optimizedGeometry=this._convertGraphicToOptimizedGeometry(this.graphic,e,r)),this._optimizedGeometry}_convertGraphicToOptimizedGeometry(e,r,i){let s=e.geometry;return s.type!=="mesh"&&s.type!=="extent"||(s=bc.fromExtent(s.type==="mesh"?s.extent:s)),D1t(s,r,i)}get usedMemory(){let e=qCe(this.graphic.attributes);return this._forEachSymbolLayerGraphic(r=>{const i=r.graphics3DSymbolLayer.complexity;if(i==null)return;const s=r.type==="draped"?i.memory.draped:i.memory;e+=s.bytesPerFeature,s.bytesPerCoordinate&&(e+=yit(this.graphic.geometry)*s.bytesPerCoordinate)}),e}computeAttachmentOrigin(){const e={render:{origin:C(),num:0},draped:{origin:Pe(),num:0}};for(const r of this.layers)r?.computeAttachmentOrigin(e);return e.render.num>1&&ae(e.render.origin,e.render.origin,1/e.render.num),e.draped.num>1&&fc(e.draped.origin,e.draped.origin,1/e.draped.num),e}async getProjectedBoundingBox(e,r,i,s,n){return n||(n={boundingBox:null,requiresDrapedElevation:!1,screenSpaceObjects:[]}),n.boundingBox?Gi(n.boundingBox):n.boundingBox=Gi(),n.requiresDrapedElevation=!1,await OV(this.layers,async o=>{if(o==null)return;const a=o.type==="draped"?r:e,l=mpe.acquire(),c=await o.getProjectedBoundingBox(a,i,n.screenSpaceObjects,s,l);isFinite(c[2])&&isFinite(c[5])||(n.requiresDrapedElevation=!0),c&&aA(n.boundingBox,l),mpe.release(l)}),h7e(n.boundingBox)||g7(mK(n.boundingBox,z1t))?n:null}needsElevationUpdates(){for(const e of this.layers)if(e!=null&&(e.type==="object3d"||e.type==="lod-instance")&&e.needsElevationUpdates)return!0;return this._labelLayers?.some(e=>e?.needsElevationUpdates??!1)??!1}alignWithElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type!=="object3d"&&s.type!=="lod-instance"||s.alignWithElevation(e,r,this._featureExpressionFeature,i)})}alignWithAbsoluteElevation(e,r,i){this._forEachRenderedGraphic(s=>{s.type==="object3d"&&s.alignWithAbsoluteElevation(e,r,i)})}addObjectStateSet(e,r){this._forEachSymbolLayerGraphic(i=>i.addObjectState(e,r))}removeObjectState(e){this._forEachSymbolLayerGraphic(r=>r.removeObjectState(e))}_forEachGraphicList(e,r){e?.forEach(i=>i&&r(i))}_forEachSymbolLayerGraphic(e){this._forEachGraphicList(this.layers,e),this._calloutLayer&&e(this._calloutLayer)}_forEachLabelGraphic(e){this._forEachGraphicList(this._labelLayers,e)}_forEachRenderedGraphic(e){this._forEachSymbolLayerGraphic(e),this._forEachLabelGraphic(e)}get test(){const e=this;return{addLabelLayer:r=>{e._labelLayers||(e._labelLayers=new Array),e._labelLayers.push(r)}}}},P7t=class{constructor(e,r){this.scheduler=e,this.schedule=r,this.sharedResources=null,this.streamDataRequester=null,this.elevationProvider=null,this.renderer=null,this.stage=null,this.clippingExtent=null,this.renderCoordsHelper=null,this.overlaySR=null,this.layer=null,this.drapeSourceRenderer=null,this.graphicsCoreOwner=null,this.localOriginFactory=null,this.featureExpressionInfoContext=null,this.screenSizePerspectiveEnabled=!0,this.slicePlaneEnabled=!1,this.physicalBasedRenderingEnabled=!1,this.skipHighSymbolLods=!1,this.isAsync=!1}},G1t=class{constructor(){this.renderPriority=0,this.renderPriorityStep=1,this.ignoreDrivers=!1}};var gpe,ype,_pe,PY={exports:{}};PY.exports,gpe=PY,ype=function(){function t(I,V,z){z=z||2;var H,Y,te,ne,ve,Fe,bt,Pt=V&&V.length,dt=Pt?V[0]*z:I.length,wt=e(I,0,dt,z,!0),be=[];if(!wt||wt.next===wt.prev)return be;if(Pt&&(wt=l(I,V,wt,z)),I.length>80*z){H=te=I[0],Y=ne=I[1];for(var Me=z;Me<dt;Me+=z)(ve=I[Me])<H&&(H=ve),(Fe=I[Me+1])<Y&&(Y=Fe),ve>te&&(te=ve),Fe>ne&&(ne=Fe);bt=(bt=Math.max(te-H,ne-Y))!==0?1/bt:0}return i(wt,be,z,H,Y,bt),be}function e(I,V,z,H,Y){var te,ne;if(Y===ee(I,V,z,H)>0)for(te=V;te<z;te+=H)ne=X(te,I[te],I[te+1],ne);else for(te=z-H;te>=V;te-=H)ne=X(te,I[te],I[te+1],ne);if(ne&&O(ne,ne.next)){var ve=ne.next;Z(ne),ne=ve}return ne}function r(I,V){if(!I)return I;V||(V=I);var z,H=I;do if(z=!1,H.steiner||!O(H,H.next)&&S(H.prev,H,H.next)!==0)H=H.next;else{var Y=H.prev;if(Z(H),(H=V=Y)===H.next)break;z=!0}while(z||H!==V);return V}function i(I,V,z,H,Y,te,ne){if(I){!ne&&te&&g(I,H,Y,te);for(var ve,Fe,bt=I;I.prev!==I.next;)if(ve=I.prev,Fe=I.next,te?n(I,H,Y,te):s(I))V.push(ve.i/z),V.push(I.i/z),V.push(Fe.i/z),Z(I),I=Fe.next,bt=Fe.next;else if((I=Fe)===bt){ne?ne===1?i(I=o(r(I),V,z),V,z,H,Y,te,2):ne===2&&a(I,V,z,H,Y,te):i(r(I),V,z,H,Y,te,1);break}}}function s(I){var V=I.prev,z=I,H=I.next;if(S(V,z,H)>=0)return!1;for(var Y=I.next.next;Y!==I.prev;){if(x(V.x,V.y,z.x,z.y,H.x,H.y,Y.x,Y.y)&&S(Y.prev,Y,Y.next)>=0)return!1;Y=Y.next}return!0}function n(I,V,z,H){var Y=I.prev,te=I,ne=I.next;if(S(Y,te,ne)>=0)return!1;for(var ve=Y.x<te.x?Y.x<ne.x?Y.x:ne.x:te.x<ne.x?te.x:ne.x,Fe=Y.y<te.y?Y.y<ne.y?Y.y:ne.y:te.y<ne.y?te.y:ne.y,bt=Y.x>te.x?Y.x>ne.x?Y.x:ne.x:te.x>ne.x?te.x:ne.x,Pt=Y.y>te.y?Y.y>ne.y?Y.y:ne.y:te.y>ne.y?te.y:ne.y,dt=v(ve,Fe,V,z,H),wt=v(bt,Pt,V,z,H),be=I.prevZ,Me=I.nextZ;be&&be.z>=dt&&Me&&Me.z<=wt;){if(be!==I.prev&&be!==I.next&&x(Y.x,Y.y,te.x,te.y,ne.x,ne.y,be.x,be.y)&&S(be.prev,be,be.next)>=0||(be=be.prevZ,Me!==I.prev&&Me!==I.next&&x(Y.x,Y.y,te.x,te.y,ne.x,ne.y,Me.x,Me.y)&&S(Me.prev,Me,Me.next)>=0))return!1;Me=Me.nextZ}for(;be&&be.z>=dt;){if(be!==I.prev&&be!==I.next&&x(Y.x,Y.y,te.x,te.y,ne.x,ne.y,be.x,be.y)&&S(be.prev,be,be.next)>=0)return!1;be=be.prevZ}for(;Me&&Me.z<=wt;){if(Me!==I.prev&&Me!==I.next&&x(Y.x,Y.y,te.x,te.y,ne.x,ne.y,Me.x,Me.y)&&S(Me.prev,Me,Me.next)>=0)return!1;Me=Me.nextZ}return!0}function o(I,V,z){var H=I;do{var Y=H.prev,te=H.next.next;!O(Y,te)&&A(Y,H,H.next,te)&&$(Y,te)&&$(te,Y)&&(V.push(Y.i/z),V.push(H.i/z),V.push(te.i/z),Z(H),Z(H.next),H=I=te),H=H.next}while(H!==I);return r(H)}function a(I,V,z,H,Y,te){var ne=I;do{for(var ve=ne.next.next;ve!==ne.prev;){if(ne.i!==ve.i&&T(ne,ve)){var Fe=U(ne,ve);return ne=r(ne,ne.next),Fe=r(Fe,Fe.next),i(ne,V,z,H,Y,te),void i(Fe,V,z,H,Y,te)}ve=ve.next}ne=ne.next}while(ne!==I)}function l(I,V,z,H){var Y,te,ne,ve=[];for(Y=0,te=V.length;Y<te;Y++)(ne=e(I,V[Y]*H,Y<te-1?V[Y+1]*H:I.length,H,!1))===ne.next&&(ne.steiner=!0),ve.push(b(ne));for(ve.sort(c),Y=0;Y<ve.length;Y++)z=r(z=p(ve[Y],z),z.next);return z}function c(I,V){return I.x-V.x}function h(I){if(I.next.prev===I)return I;let V=I;for(;;){const z=V.next;if(z.prev===V||z===V||z===I)break;V=z}return V}function p(I,V){var z=f(I,V);if(!z)return V;var H=U(z,I),Y=r(z,z.next);let te=h(H);return r(te,te.next),Y=h(Y),h(V===z?Y:V)}function f(I,V){var z,H=V,Y=I.x,te=I.y,ne=-1/0;do{if(te<=H.y&&te>=H.next.y&&H.next.y!==H.y){var ve=H.x+(te-H.y)*(H.next.x-H.x)/(H.next.y-H.y);if(ve<=Y&&ve>ne){if(ne=ve,ve===Y){if(te===H.y)return H;if(te===H.next.y)return H.next}z=H.x<H.next.x?H:H.next}}H=H.next}while(H!==V);if(!z)return null;if(Y===ne)return z;var Fe,bt=z,Pt=z.x,dt=z.y,wt=1/0;H=z;do Y>=H.x&&H.x>=Pt&&Y!==H.x&&x(te<dt?Y:ne,te,Pt,dt,te<dt?ne:Y,te,H.x,H.y)&&(Fe=Math.abs(te-H.y)/(Y-H.x),$(H,I)&&(Fe<wt||Fe===wt&&(H.x>z.x||H.x===z.x&&m(z,H)))&&(z=H,wt=Fe)),H=H.next;while(H!==bt);return z}function m(I,V){return S(I.prev,I,V.prev)<0&&S(V.next,I,I.next)<0}function g(I,V,z,H){var Y=I;do Y.z===null&&(Y.z=v(Y.x,Y.y,V,z,H)),Y.prevZ=Y.prev,Y.nextZ=Y.next,Y=Y.next;while(Y!==I);Y.prevZ.nextZ=null,Y.prevZ=null,_(Y)}function _(I){var V,z,H,Y,te,ne,ve,Fe,bt=1;do{for(z=I,I=null,te=null,ne=0;z;){for(ne++,H=z,ve=0,V=0;V<bt&&(ve++,H=H.nextZ);V++);for(Fe=bt;ve>0||Fe>0&&H;)ve!==0&&(Fe===0||!H||z.z<=H.z)?(Y=z,z=z.nextZ,ve--):(Y=H,H=H.nextZ,Fe--),te?te.nextZ=Y:I=Y,Y.prevZ=te,te=Y;z=H}te.nextZ=null,bt*=2}while(ne>1);return I}function v(I,V,z,H,Y){return(I=1431655765&((I=858993459&((I=252645135&((I=16711935&((I=32767*(I-z)*Y)|I<<8))|I<<4))|I<<2))|I<<1))|(V=1431655765&((V=858993459&((V=252645135&((V=16711935&((V=32767*(V-H)*Y)|V<<8))|V<<4))|V<<2))|V<<1))<<1}function b(I){var V=I,z=I;do(V.x<z.x||V.x===z.x&&V.y<z.y)&&(z=V),V=V.next;while(V!==I);return z}function x(I,V,z,H,Y,te,ne,ve){return(Y-ne)*(V-ve)-(I-ne)*(te-ve)>=0&&(I-ne)*(H-ve)-(z-ne)*(V-ve)>=0&&(z-ne)*(te-ve)-(Y-ne)*(H-ve)>=0}function T(I,V){return I.next.i!==V.i&&I.prev.i!==V.i&&!F(I,V)&&($(I,V)&&$(V,I)&&N(I,V)&&(S(I.prev,I,V.prev)||S(I,V.prev,V))||O(I,V)&&S(I.prev,I,I.next)>0&&S(V.prev,V,V.next)>0)}function S(I,V,z){return(V.y-I.y)*(z.x-V.x)-(V.x-I.x)*(z.y-V.y)}function O(I,V){return I.x===V.x&&I.y===V.y}function A(I,V,z,H){var Y=P(S(I,V,z)),te=P(S(I,V,H)),ne=P(S(z,H,I)),ve=P(S(z,H,V));return Y!==te&&ne!==ve||!(Y!==0||!M(I,z,V))||!(te!==0||!M(I,H,V))||!(ne!==0||!M(z,I,H))||!(ve!==0||!M(z,V,H))}function M(I,V,z){return V.x<=Math.max(I.x,z.x)&&V.x>=Math.min(I.x,z.x)&&V.y<=Math.max(I.y,z.y)&&V.y>=Math.min(I.y,z.y)}function P(I){return I>0?1:I<0?-1:0}function F(I,V){var z=I;do{if(z.i!==I.i&&z.next.i!==I.i&&z.i!==V.i&&z.next.i!==V.i&&A(z,z.next,I,V))return!0;z=z.next}while(z!==I);return!1}function $(I,V){return S(I.prev,I,I.next)<0?S(I,V,I.next)>=0&&S(I,I.prev,V)>=0:S(I,V,I.prev)<0||S(I,I.next,V)<0}function N(I,V){var z=I,H=!1,Y=(I.x+V.x)/2,te=(I.y+V.y)/2;do z.y>te!=z.next.y>te&&z.next.y!==z.y&&Y<(z.next.x-z.x)*(te-z.y)/(z.next.y-z.y)+z.x&&(H=!H),z=z.next;while(z!==I);return H}function U(I,V){var z=new G(I.i,I.x,I.y),H=new G(V.i,V.x,V.y),Y=I.next,te=V.prev;return I.next=V,V.prev=I,z.next=Y,Y.prev=z,H.next=z,z.prev=H,te.next=H,H.prev=te,H}function X(I,V,z,H){var Y=new G(I,V,z);return H?(Y.next=H.next,Y.prev=H,H.next.prev=Y,H.next=Y):(Y.prev=Y,Y.next=Y),Y}function Z(I){I.next.prev=I.prev,I.prev.next=I.next,I.prevZ&&(I.prevZ.nextZ=I.nextZ),I.nextZ&&(I.nextZ.prevZ=I.prevZ)}function G(I,V,z){this.i=I,this.x=V,this.y=z,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}function ee(I,V,z,H){for(var Y=0,te=V,ne=z-H;te<z;te+=H)Y+=(I[ne]-I[te])*(I[te+1]+I[ne+1]),ne=te;return Y}return t.deviation=function(I,V,z,H){var Y=V&&V.length,te=Y?V[0]*z:I.length,ne=Math.abs(ee(I,0,te,z));if(Y)for(var ve=0,Fe=V.length;ve<Fe;ve++){var bt=V[ve]*z,Pt=ve<Fe-1?V[ve+1]*z:I.length;ne-=Math.abs(ee(I,bt,Pt,z))}var dt=0;for(ve=0;ve<H.length;ve+=3){var wt=H[ve]*z,be=H[ve+1]*z,Me=H[ve+2]*z;dt+=Math.abs((I[wt]-I[Me])*(I[be+1]-I[wt+1])-(I[wt]-I[be])*(I[Me+1]-I[wt+1]))}return ne===0&&dt===0?0:Math.abs((dt-ne)/ne)},t.flatten=function(I){for(var V=I[0][0].length,z={vertices:[],holes:[],dimensions:V},H=0,Y=0;Y<I.length;Y++){for(var te=0;te<I[Y].length;te++)for(var ne=0;ne<V;ne++)z.vertices.push(I[Y][te][ne]);Y>0&&(H+=I[Y-1].length,z.holes.push(H))}return z},t},(_pe=ype())!==void 0&&(gpe.exports=_pe);const zA=p$(PY.exports),k8=K.getLogger("esri.views.3d.support.buffer.math");function j1t(t,e,r){BA(t.typedBuffer,e.typedBuffer,r,t.typedBufferStride,e.typedBufferStride)}function BA(t,e,r,i=3,s=i){if(t.length/i!==Math.ceil(e.length/s))return k8.error("source and destination buffers need to have the same number of elements"),t;const n=t.length/i,o=r[0],a=r[1],l=r[2],c=r[4],h=r[5],p=r[6],f=r[8],m=r[9],g=r[10],_=r[12],v=r[13],b=r[14];let x=0,T=0;for(let S=0;S<n;S++){const O=e[x],A=e[x+1],M=e[x+2];t[T]=o*O+c*A+f*M+_,t[T+1]=a*O+h*A+m*M+v,t[T+2]=l*O+p*A+g*M+b,x+=s,T+=i}return t}function O$e(t,e,r){WT(t.typedBuffer,e.typedBuffer,r,t.typedBufferStride,e.typedBufferStride)}function WT(t,e,r,i=3,s=i){if(t.length/i!==Math.ceil(e.length/s))return void k8.error("source and destination buffers need to have the same number of elements");const n=t.length/i,o=r[0],a=r[1],l=r[2],c=r[3],h=r[4],p=r[5],f=r[6],m=r[7],g=r[8];let _=0,v=0;for(let b=0;b<n;b++){const x=e[_],T=e[_+1],S=e[_+2];t[v]=o*x+c*T+f*S,t[v+1]=a*x+h*T+m*S,t[v+2]=l*x+p*T+g*S,_+=s,v+=i}}function H1t(t,e,r){jU(t.typedBuffer,e,r,t.typedBufferStride)}function jU(t,e,r,i=3){const s=Math.min(t.length/i,e.count),n=e.typedBuffer,o=e.typedBufferStride;let a=0,l=0;for(let c=0;c<s;c++)t[l]=r*n[a],t[l+1]=r*n[a+1],t[l+2]=r*n[a+2],a+=o,l+=i}function q1t(t,e){U8(t.typedBuffer,e.typedBuffer,t.typedBufferStride,e.typedBufferStride)}function U8(t,e,r=3,i=r){const s=Math.min(t.length/r,e.length/i);let n=0,o=0;for(let a=0;a<s;a++){const l=e[n],c=e[n+1],h=e[n+2],p=l*l+c*c+h*h;if(p>0){const f=1/Math.sqrt(p);t[o]=f*l,t[o+1]=f*c,t[o+2]=f*h}n+=i,o+=r}}function W1t(t,e,r){const i=Math.min(t.count,e.count),s=t.typedBuffer,n=t.typedBufferStride,o=e.typedBuffer,a=e.typedBufferStride;let l=0,c=0;for(let h=0;h<i;h++)s[c]=o[l]>>r,s[c+1]=o[l+1]>>r,s[c+2]=o[l+2]>>r,l+=a,c+=n}Object.freeze(Object.defineProperty({__proto__:null,normalize:U8,normalizeView:q1t,scale:jU,scaleView:H1t,shiftRight:W1t,transformMat3:WT,transformMat3View:O$e,transformMat4:BA,transformMat4View:j1t},Symbol.toStringTag,{value:"Module"}));function Z1t(t,e,r){return{objectId:t,target:e,distance:r,type:"vertex"}}function vpe(t,e,r,i,s,n=!1){return{objectId:t,target:e,distance:r,type:"edge",start:i,end:s,draped:n}}function V8(t,e){if(!t||t.symbol)return null;const r=e&&e.renderer;return t&&r!=null&&r.getObservationRenderer?r.getObservationRenderer(t):r}function X1t(t,e){if(t.symbol!=null)return t.symbol;const r=V8(t,e);return r!=null&&r.type!=="dot-density"?r.getSymbol(t,e):null}function D7t(t,e){const r=V8(t,e),i=X1t(t,e);if(i==null)return null;const s={renderer:r,symbol:i};if(r==null||!("visualVariables"in r)||!r.visualVariables)return s;const n=VK(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)switch(a.type){case"color":s.color=l.toRgba();break;case"size":if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;switch(c){case"width":o[0]=h;break;case"depth":o[1]=h;break;case"height":o[2]=h;break;case"width-and-depth":o[0]=o[1]=h;break;default:o[0]=o[1]=o[2]=h}}break;case"opacity":s.opacity=l;break;case"rotation":switch(a.axis){case"tilt":s.tilt=l;break;case"roll":s.roll=l;break;default:s.heading=l}}return o[0]==="proportional"&&o[1]==="proportional"&&o[2]==="proportional"||(s.size=o),s}async function Y1t(t,e){if(t.symbol!=null)return t.symbol;const r=V8(t,e);return r!=null?r.getSymbolAsync(t,e):null}async function N7t(t,e){const r=V8(t,e),i=await Y1t(t,e);if(!i)return null;const s={renderer:r,symbol:i};if(!r||!("visualVariables"in r)||!r.visualVariables)return s;const n=VK(r,t,e)??[],o=["proportional","proportional","proportional"];for(const{variable:a,value:l}of n)if(a.type==="color")s.color=Le.toUnitRGBA(l);else if(a.type==="size")if(a.target==="outline")s.outlineSize=l;else{const c=a.axis,h=a.useSymbolValue?"symbol-value":l;c==="width"?o[0]=h:c==="depth"?o[1]=h:c==="height"?o[2]=h:o[0]=o[1]=c==="width-and-depth"?h:o[2]=h}else a.type==="opacity"?s.opacity=l:a.type==="rotation"&&a.axis==="tilt"?s.tilt=l:a.type==="rotation"&&a.axis==="roll"?s.roll=l:a.type==="rotation"&&(s.heading=l);return(isFinite(o[0])||isFinite(o[1])||isFinite(o[2]))&&(s.size=o),s}function J1t(t,e=0){const r=t[e];return typeof r=="number"&&isFinite(r)?r:null}function Q1t(t){for(let e=0;e<3;e++){const r=t[e];if(typeof r=="number")return isFinite(r)?r:0}return 0}function bpe(t){const e=[[E.POSITION,t.indices]],r=[[E.POSITION,new Ge(t.attributeData.position,3,!0)]];return t.attributeData.colorFeature!=null?(r.push([E.COLORFEATUREATTRIBUTE,new Ge([t.attributeData.colorFeature],1,!0)]),e.push([E.COLORFEATUREATTRIBUTE,new Array(t.indices.length).fill(0)])):t.attributeData.color&&(r.push([E.COLOR,new Ge(t.attributeData.color,4,!0)]),e.push([E.COLOR,SO(t.indices.length)])),t.attributeData.uvMapSpace&&(r.push([E.UVMAPSPACE,new Ge(t.attributeData.uvMapSpace,4,!0)]),e.push([E.UVMAPSPACE,t.indices])),t.attributeData.boundingRect&&(r.push([E.BOUNDINGRECT,new Ge(t.attributeData.boundingRect,9,!0)]),e.push([E.BOUNDINGRECT,t.indices])),new mn(t.material,r,e,t.mapPositions,Ms.Mesh,t.attributeData.objectAndLayerIdColor)}function wpe(t,e=null){const r=[[E.POSITION,t.indices],[E.UV0,t.indices]],i=[[E.POSITION,new Ge(t.attributeData.position,3,!0)],[E.UV0,new Ge(t.attributeData.uv0,2,!0)]];return new mn(t.material,i,r,t.mapPositions,Ms.Mesh,e)}function CP(t){switch(t.type){case"extent":if(t instanceof vr)return bc.fromExtent(t);break;case"polygon":return t}return null}let z8=class{constructor(e,r,i){this.renderData=e,this.layerUid=r,this.graphicUid=i,this.outGeometries=new Array}};function $Y(t,e,r){const i=Array.isArray(t),s=i?t.length/e:t.byteLength/(4*e),n=i?t:new Uint32Array(t,0,s*e),o=r?.minReduction??0,a=r?.originalIndices||null,l=a?a.length:0,c=r?.componentOffsets||null;let h=0;if(c)for(let A=0;A<c.length-1;A++){const M=c[A+1]-c[A];M>h&&(h=M)}else h=s;const p=Math.floor(1.1*h)+1;(im==null||im.length<2*p)&&(im=new Uint32Array(S9e(2*p)));for(let A=0;A<2*p;A++)im[A]=0;let f=0;const m=!!c&&!!a,g=m?l:s;let _=wU(s);const v=new Uint32Array(l),b=1.96;let x=o!==0?Math.ceil(4*b*b/(o*o)*o*(1-o)):g,T=1,S=c?c[1]:g;for(let A=0;A<g;A++){if(A===x){const U=1-f/A;if(U+b*Math.sqrt(U*(1-U)/A)<o)return null;x*=2}if(A===S){for(let U=0;U<2*p;U++)im[U]=0;if(a)for(let U=c[T-1];U<c[T];U++)v[U]=_[a[U]];S=c[++T]}const M=m?a[A]:A,P=M*e,F=tbt(n,P,e);let $=F%p,N=f;for(;im[2*$+1]!==0;){if(im[2*$]===F){const U=im[2*$+1]-1;if(K1t(n,P,U*e,e)){N=_[U];break}}$++,$>=p&&($-=p)}N===f&&(im[2*$]=F,im[2*$+1]=M+1,f++),_[M]=N}if(o!==0&&1-f/s<o)return null;if(m){for(let A=c[T-1];A<v.length;A++)v[A]=_[a[A]];_=cg(v)}const O=i?new Array(f):new Uint32Array(f*e);f=0;for(let A=0;A<g;A++)_[A]===f&&(ebt(n,(m?a[A]:A)*e,O,f*e,e),f++);if(a&&!m){const A=new Uint32Array(l);for(let M=0;M<A.length;M++)A[M]=_[a[M]];_=cg(A)}return{buffer:Array.isArray(O)?O:O.buffer,indices:_,uniqueCount:f}}function K1t(t,e,r,i){for(let s=0;s<i;s++)if(t[e+s]!==t[r+s])return!1;return!0}function ebt(t,e,r,i,s){for(let n=0;n<s;n++)r[i+n]=t[e+n]}function tbt(t,e,r){let i=0;for(let s=0;s<r;s++)i=t[e+s]+i|0,i=i+(i<<11)+(i>>>2)|0;return i>>>0}let im=null;function k7t(t){const e=U$(t.rings,t.hasZ,Ag.CCW_IS_HOLE),r=new Array;let i=0,s=0;for(const a of e.polygons){const l=a.count,c=a.index,h=Fd(e.position,3*c,3*l),p=a.holeIndices.map(m=>m-c),f=cg(zA(h,p,3));r.push({position:h,faces:f}),i+=h.length,s+=f.length}const n=rbt(r,i,s),o=Array.isArray(n.position)?$Y(n.position,3,{originalIndices:n.faces}):$Y(n.position.buffer,6,{originalIndices:n.faces});return n.position=nMe(new Float64Array(o.buffer)),n.faces=o.indices,n}function rbt(t,e,r){if(t.length===1)return t[0];const i=Ra(e),s=new Array(r);let n=0,o=0,a=0;for(const l of t){for(let c=0;c<l.position.length;c++)i[n++]=l.position[c];for(const c of l.faces)s[o++]=c+a;a=n/3}return{position:i,faces:cg(s)}}function U$(t,e,r){const i=t.length,s=new Array(i),n=new Array(i),o=new Array(i);let a=0,l=0,c=0,h=0;for(let m=0;m<i;++m)h+=t[m].length;const p=Ra(3*h);let f=0;for(let m=i-1;m>=0;m--){const g=t[m],_=r===Ag.CCW_IS_HOLE&&ibt(g);if(_&&i!==1)s[a++]=g;else{let v=g.length;for(let x=0;x<a;++x)v+=s[x].length;const b={index:f,pathLengths:new Array(a+1),count:v,holeIndices:new Array(a)};b.pathLengths[0]=g.length,g.length>0&&(o[c++]={index:f,count:g.length}),f=_?hN(g,g.length-1,-1,p,f,g.length,e):hN(g,0,1,p,f,g.length,e);for(let x=0;x<a;++x){const T=s[x];b.holeIndices[x]=f,b.pathLengths[x+1]=T.length,T.length>0&&(o[c++]={index:f,count:T.length}),f=hN(T,0,1,p,f,T.length,e)}a=0,b.count>0&&(n[l++]=b)}}for(let m=0;m<a;++m){const g=s[m];g.length>0&&(o[c++]={index:f,count:g.length}),f=hN(g,0,1,p,f,g.length,e)}return n.length=l,o.length=c,{position:p,polygons:n,outlines:o}}function hN(t,e,r,i,s,n,o){s*=3;for(let a=0;a<n;++a){const l=t[e];i[s++]=l[0],i[s++]=l[1],i[s++]=o?l[2]:0,e+=r}return s/3}function ibt(t){return!CQ(t,!1,!1)}var Ag;(function(t){t[t.NONE=0]="NONE",t[t.CCW_IS_HOLE=1]="CCW_IS_HOLE"})(Ag||(Ag={}));var _I,HU,LY;(function(t){t[t.RasterImage=0]="RasterImage",t[t.Features=1]="Features"})(_I||(_I={})),function(t){t[t.MapLayer=0]="MapLayer",t[t.ViewLayer=1]="ViewLayer",t[t.Outline=2]="Outline",t[t.SnappingHint=3]="SnappingHint"}(HU||(HU={})),function(t){t[t.WithRasterImage=0]="WithRasterImage",t[t.WithoutRasterImage=1]="WithoutRasterImage"}(LY||(LY={}));let R$e=class{constructor(e,r){this._fbo=null;const i=new Sr;i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.LINEAR_MIPMAP_LINEAR,i.hasMipmap=r,i.maxAnisotropy=8,this._fbo=new Vn(e,i)}dispose(){this._fbo=ze(this._fbo)}getTexture(){return this._fbo?.colorTexture}isValid(){return this._fbo!=null}resize(e,r){this._fbo?.resize(e,r)}bind(e){e.bindFramebuffer(this._fbo)}generateMipMap(){const e=this._fbo?.colorTexture;e?.descriptor.hasMipmap&&e.generateMipmap()}disposeRenderTargetMemory(){this._fbo?.resize(0,0)}get gpuMemoryUsage(){return this._fbo?.gpuMemoryUsage??0}},l2=class{constructor(e,r,i,s=!0){this.output=r,this.type=i,this.valid=!1,this.lastUsed=1/0,this.fbo=new R$e(e,s)}},sbt=class{constructor(e){this.renderTargets=[new l2(e,k.Color,Os.Color),new l2(e,k.Color,Os.ColorNoRasterImage),new l2(e,k.Highlight,Os.Highlight,!1),new l2(e,k.Normal,Os.Water),new l2(e,k.Color,Os.Occluded)],le("enable-feature:objectAndLayerId-rendering")&&this.renderTargets.push(new l2(e,k.ObjectAndLayerIdColor,Os.ObjectAndLayerIdColor))}getTarget(e){return this.renderTargets[e].fbo}dispose(){for(const e of this.renderTargets)e.fbo.dispose()}disposeRenderTargetMemory(){for(const e of this.renderTargets)e.fbo.disposeRenderTargetMemory()}validateUsageForTarget(e,r,i){return e?(r.lastUsed=i,!1):i-r.lastUsed>nbt?(r.fbo.disposeRenderTargetMemory(),r.lastUsed=1/0,!1):r.lastUsed<1/0}get gpuMemoryUsage(){return this.renderTargets.reduce((e,r)=>e+r.fbo.gpuMemoryUsage,0)}};const nbt=1e3;let M$e=class extends ui{constructor(){super(...arguments),this.color=Vt(1,1,1,1)}};function obt(){const t=new Cr;return t.include(ep),t.fragment.uniforms.add(new et("tex",e=>e.texture),new cr("uColor",e=>e.color)),t.fragment.code.add(w`void main() {
vec4 texColor = texture(tex, uv);
fragColor = texColor * uColor;
}`),t}const abt=Object.freeze(Object.defineProperty({__proto__:null,TextureOnlyPassParameters:M$e,build:obt},Symbol.toStringTag,{value:"Module"}));let I$e=class{constructor(e){this._context=e,this._perConstructorInstances=new EO,this._frameCounter=0,this._keepAliveFrameCount=xpe}get viewingMode(){return this._context.viewingMode}get constructionContext(){return this._context}destroy(){this._perConstructorInstances.forEach(e=>e.forEach(r=>r.technique.destroy())),this._perConstructorInstances.clear()}acquire(e,r=cbt){const i=r.key;let s=this._perConstructorInstances.get(e,i);if(s==null){const n=new e(this._context,r,()=>this.release(n));s=new lbt(n),this._perConstructorInstances.set(e,i,s)}return++s.refCount,s.technique}releaseAndAcquire(e,r,i){if(i!=null){if(r.key===i.key)return i;this.release(i)}return this.acquire(e,r)}release(e){if(e==null||this._perConstructorInstances.empty)return;const r=this._perConstructorInstances.get(e.constructor,e.key);r!=null&&(--r.refCount,r.refCount===0&&(r.refZeroFrame=this._frameCounter))}frameUpdate(){this._frameCounter++,this._keepAliveFrameCount!==xpe&&this._perConstructorInstances.forEach((e,r)=>{e.forEach((i,s)=>{i.refCount===0&&i.refZeroFrame+this._keepAliveFrameCount<this._frameCounter&&(i.technique.destroy(),this._perConstructorInstances.delete(r,s))})})}async reloadAll(){const e=new Array;this._perConstructorInstances.forEach((r,i)=>{const s=async(n,o)=>{const a=o.shader;a&&(await a.reload(),n.forEach(l=>l.technique.reload(this._context)))};e.push(s(r,i))}),await Promise.all(e)}},lbt=class{constructor(e){this.technique=e,this.refCount=0,this.refZeroFrame=0}};const xpe=-1,cbt=new nl;let P$e=class{constructor(e,r,i,s){this._textureRepository=e,this._techniqueRepository=r,this.materialChanged=i,this.requestRender=s,this._id2glMaterialRef=new EO}dispose(){this._textureRepository.destroy()}acquire(e,r,i){if(this._ownMaterial(e),!e.requiresSlot(r,i))return null;let s=this._id2glMaterialRef.get(i,e.id);if(s==null){const n=e.createGLMaterial({material:e,techniqueRep:this._techniqueRepository,textureRep:this._textureRepository,output:i});s=new ubt(n),this._id2glMaterialRef.set(i,e.id,s)}return s.ref(),s.glMaterial}release(e,r){const i=this._id2glMaterialRef.get(r,e.id);i!=null&&(i.unref(),i.referenced||(ze(i.glMaterial),this._id2glMaterialRef.delete(r,e.id)))}_ownMaterial(e){e.repository!=null&&e.repository!==this&&K.getLogger("esri.views.3d.webgl-engine.lib.GLMaterialRepository").error("Material is already owned by a different material repository"),e.repository=this}},ubt=class{constructor(e){this.glMaterial=e,this._refCnt=0}ref(){++this._refCnt}unref(){--this._refCnt,it(this._refCnt>=0)}get referenced(){return this._refCnt>0}};const hbt={orderedRepackingEnabled:!1},dbt=["layerObjectAdded","layerObjectRemoved","layerObjectsAdded","layerObjectsRemoved","shaderTransformationChanged","objectTransformation","visibilityChanged","occlusionChanged","highlightChanged","objectGeometryAdded","objectGeometryRemoved","objectGeometryUpdated"];let DY=class l5{get bounds(){return this._root.bounds}get halfSize(){return this._root.halfSize}get root(){return this._root.node}get maximumObjectsPerNode(){return this._maximumObjectsPerNode}get maximumDepth(){return this._maximumDepth}get objectCount(){return this._objectCount}constructor(e,r){this.objectToBoundingSphere=e,this._maximumObjectsPerNode=10,this._maximumDepth=20,this._degenerateObjects=new Set,this._root=new So,this._objectCount=0,r&&(r.maximumObjectsPerNode!==void 0&&(this._maximumObjectsPerNode=r.maximumObjectsPerNode),r.maximumDepth!==void 0&&(this._maximumDepth=r.maximumDepth))}destroy(){this._degenerateObjects.clear(),So.clearPool(),NY[0]=null,Gb.prune(),lx.prune()}add(e,r=e.length){this._objectCount+=r,this._grow(e,r);const i=So.acquire();for(let s=0;s<r;s++){const n=e[s];this._isDegenerate(n)?this._degenerateObjects.add(n):(i.init(this._root),this._add(n,i))}So.release(i)}remove(e,r=null){this._objectCount-=e.length;const i=So.acquire();for(const s of e){const n=r??TA(this.objectToBoundingSphere(s),ybt);pM(n[3])?(i.init(this._root),this._remove(s,n,i)):this._degenerateObjects.delete(s)}So.release(i),this._shrink()}update(e,r){if(!pM(r[3])&&this._isDegenerate(e))return;const i=gbt(e);this.remove(i,r),this.add(i)}forEachAlongRay(e,r,i){const s=Eh(e,r);this._forEachNode(this._root,n=>{if(!this._intersectsNode(s,n))return!1;const o=n.node;return o.terminals.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),o.residents!==null&&o.residents.forAll(a=>{this._intersectsObject(s,a)&&i(a)}),!0})}forEachAlongRayWithVerticalOffset(e,r,i,s){const n=Eh(e,r);this._forEachNode(this._root,o=>{if(!this._intersectsNodeWithOffset(n,o,s))return!1;const a=o.node;return a.terminals.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),a.residents!==null&&a.residents.forAll(l=>{this._intersectsObjectWithOffset(n,l,s)&&i(l)}),!0})}forEach(e){this._forEachNode(this._root,r=>{const i=r.node;return i.terminals.forAll(e),i.residents!==null&&i.residents.forAll(e),!0}),this._degenerateObjects.forEach(e)}forEachDegenerateObject(e){this._degenerateObjects.forEach(e)}findClosest(e,r,i,s=()=>!0,n=1/0){let o=1/0,a=1/0,l=null;const c=rG(e,r),h=p=>{if(--n,!s(p))return;const f=this.objectToBoundingSphere(p);if(!y1(i,f))return;const m=Bv(e,r,f),g=m-f[3],_=m+f[3];g<o&&(o=g,a=_,l=p)};return this._forEachNodeDepthOrdered(this._root,p=>{if(n<=0||!y1(i,p.bounds)||(ae(kh,c,p.halfSize),ue(kh,kh,p.bounds),Bv(e,r,kh)>a))return!1;const f=p.node;return f.terminals.forAll(m=>h(m)),f.residents!==null&&f.residents.forAll(m=>h(m)),!0},e,r),l}forEachInDepthRange(e,r,i,s,n,o,a){let l=-1/0,c=1/0;const h={setRange:_=>{i===l5.DepthOrder.FRONT_TO_BACK?(l=Math.max(l,_.near),c=Math.min(c,_.far)):(l=Math.max(l,-_.far),c=Math.min(c,-_.near))}};h.setRange(s);const p=Bv(r,i,e),f=rG(r,i),m=rG(r,-i),g=_=>{if(!a(_))return;const v=this.objectToBoundingSphere(_),b=v,x=Bv(r,i,b)-p,T=x-v[3],S=x+v[3];T>c||S<l||!y1(o,v)||n(_,h)};this._forEachNodeDepthOrdered(this._root,_=>{if(!y1(o,_.bounds)||(ae(kh,f,_.halfSize),ue(kh,kh,_.bounds),Bv(r,i,kh)-p>c)||(ae(kh,m,_.halfSize),ue(kh,kh,_.bounds),Bv(r,i,kh)-p<l))return!1;const v=_.node;return v.terminals.forAll(b=>g(b)),v.residents!==null&&v.residents.forAll(b=>g(b)),!0},r,i)}forEachNode(e){this._forEachNode(this._root,r=>e(r.node,r.bounds,r.halfSize,r.depth))}forEachNeighbor(e,r){const i=p0(r),s=r,n=l=>{const c=this.objectToBoundingSphere(l),h=p0(c),p=i+h;return!(kn(c,s)-p*p<=0)||e(l)};let o=!0;const a=l=>{o&&(o=n(l))};this._forEachNode(this._root,l=>{const c=p0(l.bounds),h=i+c;if(kn(l.bounds,s)-h*h>0)return!1;const p=l.node;return p.terminals.forAll(a),o&&p.residents!==null&&p.residents.forAll(a),o}),o&&this.forEachDegenerateObject(a)}_intersectsNode(e,r){return dN(r.bounds,2*-r.halfSize,sh),dN(r.bounds,2*r.halfSize,nh),Mue(e.origin,e.direction,sh,nh)}_intersectsNodeWithOffset(e,r,i){return dN(r.bounds,2*-r.halfSize,sh),dN(r.bounds,2*r.halfSize,nh),i.applyToMinMax(sh,nh),Mue(e.origin,e.direction,sh,nh)}_intersectsObject(e,r){const i=this.objectToBoundingSphere(r);return!(i[3]>0)||AZ(i,e)}_intersectsObjectWithOffset(e,r,i){const s=this.objectToBoundingSphere(r);return!(s[3]>0)||AZ(i.applyToBoundingSphere(s),e)}_forEachNode(e,r){let i=So.acquire().init(e);const s=[i];for(;s.length!==0;){if(i=s.pop(),r(i)&&!i.isLeaf())for(let n=0;n<i.node.children.length;n++)i.node.children[n]&&s.push(So.acquire().init(i).advance(n));So.release(i)}}_forEachNodeDepthOrdered(e,r,i,s=l5.DepthOrder.FRONT_TO_BACK){let n=So.acquire().init(e);const o=[n];for(mbt(i,s,Epe);o.length!==0;){if(n=o.pop(),r(n)&&!n.isLeaf())for(let a=7;a>=0;--a){const l=Epe[a];n.node.children[l]&&o.push(So.acquire().init(n).advance(l))}So.release(n)}}_remove(e,r,i){Gb.clear();const s=i.advanceTo(r,(n,o)=>{Gb.push(n.node),Gb.push(o)})?i.node.terminals:i.node.residents;if(s.removeUnordered(e),s.length===0)for(let n=Gb.length-2;n>=0;n-=2){const o=Gb.data[n],a=Gb.data[n+1];if(!this._purge(o,a))break}}_nodeIsEmpty(e){if(e.terminals.length!==0)return!1;if(e.residents!==null)return e.residents.length===0;for(let r=0;r<e.children.length;r++)if(e.children[r])return!1;return!0}_purge(e,r){return r>=0&&(e.children[r]=null),!!this._nodeIsEmpty(e)&&(e.residents===null&&(e.residents=new qt({shrink:!0})),!0)}_add(e,r){r.advanceTo(this.objectToBoundingSphere(e))?r.node.terminals.push(e):(r.node.residents.push(e),r.node.residents.length>this._maximumObjectsPerNode&&r.depth<this._maximumDepth&&this._split(r))}_split(e){const r=e.node.residents;e.node.residents=null;for(let i=0;i<r.length;i++){const s=So.acquire().init(e);this._add(r.at(i),s),So.release(s)}}_grow(e,r){if(r!==0&&(Tpe(e,r,i=>this.objectToBoundingSphere(i),Kg),pM(Kg[3])&&!this._fitsInsideTree(Kg)))if(this._nodeIsEmpty(this._root.node))TA(Kg,this._root.bounds),this._root.halfSize=1.25*this._root.bounds[3],this._root.updateBoundsRadiusFromHalfSize();else{const i=this._rootBoundsForRootAsSubNode(Kg);this._placingRootViolatesMaxDepth(i)?this._rebuildTree(Kg,i):this._growRootAsSubNode(i),So.release(i)}}_rebuildTree(e,r){oe(sG,r.bounds),sG[3]=r.halfSize,Tpe([e,sG],2,s=>s,nG);const i=So.acquire().init(this._root);this._root.initFrom(null,nG,nG[3]),this._root.increaseHalfSize(1.25),this._forEachNode(i,s=>(this.add(s.node.terminals.data,s.node.terminals.length),s.node.residents!==null&&this.add(s.node.residents.data,s.node.residents.length),!0)),So.release(i)}_placingRootViolatesMaxDepth(e){const r=Math.log(e.halfSize/this._root.halfSize)*Math.LOG2E;let i=0;return this._forEachNode(this._root,s=>(i=Math.max(i,s.depth),i+r<=this._maximumDepth)),i+r>this._maximumDepth}_rootBoundsForRootAsSubNode(e){const r=e[3],i=e;let s=-1/0;const n=this._root.bounds,o=this._root.halfSize;for(let l=0;l<3;l++){const c=n[l]-o-(i[l]-r),h=i[l]+r-(n[l]+o),p=Math.max(0,Math.ceil(c/(2*o))),f=Math.max(0,Math.ceil(h/(2*o)))+1,m=2**Math.ceil(Math.log(p+f)*Math.LOG2E);s=Math.max(s,m),pN[l].min=p,pN[l].max=f}for(let l=0;l<3;l++){let c=pN[l].min,h=pN[l].max;const p=(s-(c+h))/2;c+=Math.ceil(p),h+=Math.floor(p);const f=n[l]-o-c*o*2;iG[l]=f+(h+c)*o}const a=s*o;return iG[3]=a*L$e,So.acquire().initFrom(null,iG,a,0)}_growRootAsSubNode(e){const r=this._root.node;oe(Kg,this._root.bounds),Kg[3]=this._root.halfSize,this._root.init(e),e.advanceTo(Kg,null,!0),e.node.children=r.children,e.node.residents=r.residents,e.node.terminals=r.terminals}_shrink(){for(;;){const e=this._findShrinkIndex();if(e===-1)break;this._root.advance(e),this._root.depth=0}}_findShrinkIndex(){if(this._root.node.terminals.length!==0||this._root.isLeaf())return-1;let e=null;const r=this._root.node.children;let i=0,s=0;for(;s<r.length&&e==null;)i=s++,e=r[i];for(;s<r.length;)if(r[s++])return-1;return i}_isDegenerate(e){return!pM(this.objectToBoundingSphere(e)[3])}_fitsInsideTree(e){const r=this._root.bounds,i=this._root.halfSize;return e[3]<=i&&e[0]>=r[0]-i&&e[0]<=r[0]+i&&e[1]>=r[1]-i&&e[1]<=r[1]+i&&e[2]>=r[2]-i&&e[2]<=r[2]+i}toJSON(){const{maximumDepth:e,maximumObjectsPerNode:r,_objectCount:i}=this,s=this._nodeToJSON(this._root.node);return{maximumDepth:e,maximumObjectsPerNode:r,objectCount:i,root:{bounds:this._root.bounds,halfSize:this._root.halfSize,depth:this._root.depth,node:s}}}_nodeToJSON(e){const r=e.children.map(n=>n?this._nodeToJSON(n):null),i=e.residents?.map(n=>this.objectToBoundingSphere(n)),s=e.terminals?.map(n=>this.objectToBoundingSphere(n));return{children:r,residents:i,terminals:s}}static fromJSON(e){const r=new l5(i=>i,{maximumDepth:e.maximumDepth,maximumObjectsPerNode:e.maximumObjectsPerNode});return r._objectCount=e.objectCount,r._root.initFrom(e.root.node,e.root.bounds,e.root.halfSize,e.root.depth),r}},So=class AE{constructor(){this.bounds=js(),this.halfSize=0,this.initFrom(null,null,0,0)}init(e){return this.initFrom(e.node,e.bounds,e.halfSize,e.depth)}initFrom(e,r,i,s=this.depth){return this.node=e??AE.createEmptyNode(),r!=null&&TA(r,this.bounds),this.halfSize=i,this.depth=s,this}increaseHalfSize(e){this.halfSize*=e,this.updateBoundsRadiusFromHalfSize()}updateBoundsRadiusFromHalfSize(){this.bounds[3]=this.halfSize*L$e}advance(e){let r=this.node.children[e];r||(r=AE.createEmptyNode(),this.node.children[e]=r),this.node=r,this.halfSize/=2,this.depth++;const i=$$e[e];return this.bounds[0]+=i[0]*this.halfSize,this.bounds[1]+=i[1]*this.halfSize,this.bounds[2]+=i[2]*this.halfSize,this.updateBoundsRadiusFromHalfSize(),this}advanceTo(e,r,i=!1){for(;;){if(this.isTerminalFor(e))return r&&r(this,-1),!0;if(this.isLeaf()){if(!i)return r&&r(this,-1),!1;this.node.residents=null}const s=this._childIndex(e);r&&r(this,s),this.advance(s)}}isLeaf(){return this.node.residents!=null}isTerminalFor(e){return e[3]>this.halfSize/2}_childIndex(e){const r=this.bounds;return(r[0]<e[0]?1:0)+(r[1]<e[1]?2:0)+(r[2]<e[2]?4:0)}static createEmptyNode(){return{children:[null,null,null,null,null,null,null,null],terminals:new qt({shrink:!0}),residents:new qt({shrink:!0})}}static acquire(){return AE._pool.acquire()}static release(e){AE._pool.release(e)}static clearPool(){AE._pool.prune()}};function pbt(t,e){t[0]=Math.min(t[0],e[0]-e[3]),t[1]=Math.min(t[1],e[1]-e[3]),t[2]=Math.min(t[2],e[2]-e[3])}function fbt(t,e){t[0]=Math.max(t[0],e[0]+e[3]),t[1]=Math.max(t[1],e[1]+e[3]),t[2]=Math.max(t[2],e[2]+e[3])}function dN(t,e,r){r[0]=t[0]+e,r[1]=t[1]+e,r[2]=t[2]+e}function Tpe(t,e,r,i){if(e===1){const s=r(t[0]);TA(s,i)}else{sh[0]=1/0,sh[1]=1/0,sh[2]=1/0,nh[0]=-1/0,nh[1]=-1/0,nh[2]=-1/0;for(let s=0;s<e;s++){const n=r(t[s]);pM(n[3])&&(pbt(sh,n),fbt(nh,n))}Wr(i,sh,nh,.5),i[3]=Math.max(nh[0]-sh[0],nh[1]-sh[1],nh[2]-sh[2])/2}}function mbt(t,e,r){if(!lx.length)for(let i=0;i<8;++i)lx.push({index:0,distance:0});for(let i=0;i<8;++i){const s=$$e[i];lx.data[i].index=i,lx.data[i].distance=Bv(t,e,s)}lx.sort((i,s)=>i.distance-s.distance);for(let i=0;i<8;++i)r[i]=lx.data[i].index}function rG(t,e){let r,i=1/0;for(let s=0;s<8;++s){const n=Bv(t,e,Spe[s]);n<i&&(i=n,r=Spe[s])}return r}function Bv(t,e,r){return e*(t[0]*r[0]+t[1]*r[1]+t[2]*r[2])}function pM(t){return!isNaN(t)&&t!==-1/0&&t!==1/0&&t>0}So._pool=new $o(So),function(t){var e;(e=t.DepthOrder||(t.DepthOrder={}))[e.FRONT_TO_BACK=1]="FRONT_TO_BACK",e[e.BACK_TO_FRONT=-1]="BACK_TO_FRONT"}(DY||(DY={}));const $$e=[Ee(-1,-1,-1),Ee(1,-1,-1),Ee(-1,1,-1),Ee(1,1,-1),Ee(-1,-1,1),Ee(1,-1,1),Ee(-1,1,1),Ee(1,1,1)],Spe=[Ee(-1,-1,-1),Ee(-1,-1,1),Ee(-1,1,-1),Ee(-1,1,1),Ee(1,-1,-1),Ee(1,-1,1),Ee(1,1,-1),Ee(1,1,1)],L$e=Math.sqrt(3),NY=[null];function gbt(t){return NY[0]=t,NY}const iG=js(),kh=C(),sh=C(),nh=C(),Gb=new qt,ybt=js(),Kg=js(),sG=js(),nG=js(),pN=[{min:0,max:0},{min:0,max:0},{min:0,max:0}],lx=new qt,Epe=[0,0,0,0,0,0,0,0],mf=DY;var I1;(function(t){t[t.ASYNC=0]="ASYNC",t[t.SYNC=1]="SYNC"})(I1||(I1={}));let D$e=class extends O${get objects(){return this._objects}constructor(e,r,i=""){super(),this.stage=e,this.apiLayerUid=i,this.type=Ms.Layer,this.events=new Xr,this.sliceable=!1,this._objects=new qt,this._objectsAdded=new qt,this._handles=new li,this.apiLayerUid=i,this.visible=r?.visible??!0,this.pickable=r?.pickable??!0,this.updatePolicy=r?.updatePolicy??I1.ASYNC,this._disableOctree=r?.disableOctree??!1,e.add(this);for(const s of dbt)this._handles.add(this.events.on(s,n=>e.handleEvent(s,n)))}destroy(){this._handles.size&&(this._handles.destroy(),this.stage.remove(this),this.invalidateSpatialQueryAccelerator())}add(e){this._objects.push(e),e.parentLayer=this,this.events.emit("layerObjectAdded",{layer:this,object:e}),this._octree!=null&&this._objectsAdded.push(e)}remove(e){this._objects.removeUnordered(e)&&(e.parentLayer=null,this.events.emit("layerObjectRemoved",{layer:this,object:e}),this._octree!=null&&(this._objectsAdded.removeUnordered(e)||this._octree.remove([e])))}addMany(e){this._objects.pushArray(e);for(const r of e)r.parentLayer=this;this.events.emit("layerObjectsAdded",{layer:this,objects:e}),this._octree!=null&&this._objectsAdded.pushArray(e)}removeMany(e){const r=new Array;if(this._objects.removeUnorderedMany(e,e.length,r),r.length!==0){for(const i of r)i.parentLayer=null;if(this.events.emit("layerObjectsRemoved",{layer:this,objects:r}),this._octree!=null){for(let i=0;i<r.length;)this._objectsAdded.removeUnordered(r[i])?(r[i]=r[r.length-1],r.length-=1):++i;this._octree.remove(r)}}}sync(){this.updatePolicy!==I1.SYNC&&this.stage.syncLayer(this.id)}notifyObjectBBChanged(e,r){this._octree==null||this._objectsAdded.includes(e)||this._octree.update(e,r)}getSpatialQueryAccelerator(){return this._octree==null&&this._objects.length>50&&!this._disableOctree?(this._octree=new mf(e=>e.boundingVolumeWorldSpace.bounds),this._octree.add(this._objects.data,this._objects.length)):this._octree!=null&&this._objectsAdded.length>0&&(this._octree.add(this._objectsAdded.data,this._objectsAdded.length),this._objectsAdded.clear()),this._octree}shaderTransformationChanged(){this.invalidateSpatialQueryAccelerator(),this.events.emit("shaderTransformationChanged",this)}invalidateSpatialQueryAccelerator(){this._octree=Re(this._octree),this._objectsAdded.clear()}};function qU(t){return t!=null&&t.type===Ms.Layer}var bh,ZT;(function(t){t[t.Draped=0]="Draped",t[t.Screen=1]="Screen",t[t.World=2]="World",t[t.COUNT=3]="COUNT"})(bh||(bh={})),function(t){t[t.Center=0]="Center",t[t.Tip=1]="Tip",t[t.COUNT=2]="COUNT"}(ZT||(ZT={}));let Jo=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.transparencyPassType=ut.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.writeDepth=!1,this.space=bh.Screen,this.hideOnShortSegments=!1,this.hasCap=!1,this.anchor=ZT.Center,this.hasTip=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}get draped(){return this.space===bh.Draped}};u([B({count:k.COUNT})],Jo.prototype,"output",void 0),u([B({count:ut.COUNT})],Jo.prototype,"transparencyPassType",void 0),u([B()],Jo.prototype,"occluder",void 0),u([B()],Jo.prototype,"hasSlicePlane",void 0),u([B()],Jo.prototype,"writeDepth",void 0),u([B({count:bh.COUNT})],Jo.prototype,"space",void 0),u([B()],Jo.prototype,"hideOnShortSegments",void 0),u([B()],Jo.prototype,"hasCap",void 0),u([B({count:ZT.COUNT})],Jo.prototype,"anchor",void 0),u([B()],Jo.prototype,"hasTip",void 0),u([B()],Jo.prototype,"vvSize",void 0),u([B()],Jo.prototype,"vvColor",void 0),u([B()],Jo.prototype,"vvOpacity",void 0),u([B()],Jo.prototype,"hasOccludees",void 0),u([B()],Jo.prototype,"hasMultipassTerrain",void 0),u([B()],Jo.prototype,"cullAboveGround",void 0),u([B({constValue:!0})],Jo.prototype,"hasVvInstancing",void 0),u([B({constValue:!0})],Jo.prototype,"hasSliceTranslatedView",void 0);const Cpe=8;function N$e(t,e){const r=t.vertex;r.uniforms.add(new Ie("intrinsicWidth",i=>i.width)),e.vvSize?(t.attributes.add(E.SIZEFEATUREATTRIBUTE,"float"),r.uniforms.add(new jt("vvSizeMinSize",i=>i.vvSize.minSize),new jt("vvSizeMaxSize",i=>i.vvSize.maxSize),new jt("vvSizeOffset",i=>i.vvSize.offset),new jt("vvSizeFactor",i=>i.vvSize.factor)),r.code.add(w`float getSize() {
return intrinsicWidth * clamp(vvSizeOffset + sizeFeatureAttribute * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).x;
}`)):(t.attributes.add(E.SIZE,"float"),r.code.add(w`float getSize(){
return intrinsicWidth * size;
}`)),e.vvOpacity?(t.attributes.add(E.OPACITYFEATUREATTRIBUTE,"float"),r.constants.add("vvOpacityNumber","int",8),r.uniforms.add(new gc("vvOpacityValues",i=>i.vvOpacity.values,Cpe),new gc("vvOpacityOpacities",i=>i.vvOpacity.opacityValues,Cpe)),r.code.add(w`float interpolateOpacity( float value ){
if (value <= vvOpacityValues[0]) {
return vvOpacityOpacities[0];
}
for (int i = 1; i < vvOpacityNumber; ++i) {
if (vvOpacityValues[i] >= value) {
float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
return mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f);
}
}
return vvOpacityOpacities[vvOpacityNumber - 1];
}
vec4 applyOpacity( vec4 color ){
return vec4(color.xyz, interpolateOpacity(opacityFeatureAttribute));
}`)):r.code.add(w`vec4 applyOpacity( vec4 color ){
return color;
}`),e.vvColor?(t.include(y0,e),t.attributes.add(E.COLORFEATUREATTRIBUTE,"float"),r.code.add(w`vec4 getColor(){
return applyOpacity(interpolateVVColor(colorFeatureAttribute));
}`)):(t.attributes.add(E.COLOR,"vec4"),r.code.add(w`vec4 getColor(){
return applyOpacity(color);
}`))}function N0(t,e){switch(t.fragment.include(Pu),e.output){case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:t.fragment.code.add(w`float _calculateFragDepth(const in float depth) {
const float SLOPE_SCALE = 2.0;
const float BIAS = 20.0 * .000015259;
float m = max(abs(dFdx(depth)), abs(dFdy(depth)));
float result = depth + SLOPE_SCALE * m + BIAS;
return clamp(result, .0, .999999);
}
void outputDepth(float _linearDepth) {
fragColor = float2rgba(_calculateFragDepth(_linearDepth));
}`);break;case k.Depth:t.fragment.code.add(w`void outputDepth(float _linearDepth) {
fragColor = float2rgba(_linearDepth);
}`)}}let F$e=class{constructor(e,r,i){this._createTexture=e,this._parametersKey=r,this._repository=new Map,this._orphanCache=i.newCache(`procedural-texture-repository:${vc()}`,s=>s.dispose())}destroy(){for(const[e,{texture:r}]of this._repository)r.dispose();this._repository.clear(),this._orphanCache.destroy()}swap(e,r=null){const i=this._acquire(e);return this.release(r),i}release(e){if(e==null)return;const r=this._parametersKey(e),i=this._repository.get(r);if(i&&(i.refCount--,i.refCount===0)){this._repository.delete(r);const{texture:s}=i,n=s.gpuMemoryUsage;this._orphanCache.put(r,s,n)}}_acquire(e){if(e==null)return null;const r=this._parametersKey(e),i=this._repository.get(r);if(i)return i.refCount++,i.texture;const s=this._orphanCache.pop(r)??this._createTexture(e),n=new _bt(s);return this._repository.set(r,n),s}},_bt=class{constructor(e){this.texture=e,this.refCount=1}};function vbt(t,e){return new F$e(r=>{const{encodedData:i,paddedPixels:s}=bbt(r),n=new Sr;return n.internalFormat=At.RGBA,n.width=s,n.height=1,n.wrapMode=Ut.CLAMP_TO_EDGE,new Rt(t,n,i)},r=>`${r.pattern.join(",")}-r${r.pixelRatio}`,e)}function bbt(t){const e=tie(t),r=1/t.pixelRatio,i=k$e(t),s=U$e(t),n=(Math.floor(.5*(s-1))+.5)*r,o=[];let a=1;for(const m of e){for(let g=0;g<m;g++){const _=a*(Math.min(g,m-1-g)+.5)*r/n*.5+.5;o.push(_)}a=-a}const l=Math.round(e[0]/2),c=[...o.slice(l),...o.slice(0,l)],h=i+V$e,p=new Uint8Array(4*h);let f=4;for(const m of c)xP(m,p,f),f+=4;return p.copyWithin(0,f-4,f),p.copyWithin(f,4,8),{encodedData:p,paddedPixels:h}}function tie(t){return t.pattern.map(e=>Math.round(e*t.pixelRatio))}function k$e(t){if(t==null)return 1;const e=tie(t);return Math.floor(e.reduce((r,i)=>r+i))}function U$e(t){return tie(t).reduce((e,r)=>Math.max(e,r))}const V$e=2;function wbt(t){return t==null?ng:t.length===4?t:zi(xbt,t[0],t[1],t[2],1)}const xbt=Qt();function z$e(t,e){t.constants.add("stippleAlphaColorDiscard","float",.001),t.constants.add("stippleAlphaHighlightDiscard","float",.5),e.stippleEnabled?Tbt(t,e):Sbt(t)}function Tbt(t,e){const r=!(e.draped&&e.stipplePreferContinuous),{vertex:i,fragment:s}=t;s.include(Pu),e.draped||(kf(i,e),i.uniforms.add(new Ie("worldToScreenPerDistanceRatio",(n,o)=>1/o.camera.perScreenPixelRatio)),i.code.add(w`float computeWorldToScreenRatio(vec3 segmentCenter) {
float segmentDistanceToCamera = length(segmentCenter - cameraPosition);
return worldToScreenPerDistanceRatio / segmentDistanceToCamera;
}`)),t.varyings.add("vStippleDistance","float"),e.stippleRequiresClamp&&t.varyings.add("vStippleDistanceLimits","vec2"),e.stippleRequiresStretchMeasure&&t.varyings.add("vStipplePatternStretch","float"),i.code.add(w`
    float discretizeWorldToScreenRatio(float worldToScreenRatio) {
      float step = ${Cbt};

      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);
      return discreteWorldToScreenRatio;
    }
  `),i.code.add(w`vec2 computeStippleDistanceLimits(float startPseudoScreen, float segmentLengthPseudoScreen, float segmentLengthScreen, float patternLength) {`),i.code.add(w`
    if (segmentLengthPseudoScreen >= ${r?"patternLength":"1e4"}) {
  `),MO(i,e),i.code.add(w`
        // Round the screen length to get an integer number of pattern repetitions (minimum 1).
        float repetitions = segmentLengthScreen / (patternLength * pixelRatio);
        float flooredRepetitions = max(1.0, floor(repetitions + 0.5));
        float segmentLengthScreenRounded = flooredRepetitions * patternLength;

        ${e.stippleRequiresStretchMeasure?w`
              float stretch = repetitions / flooredRepetitions;

              // We need to impose a lower bound on the stretch factor to prevent the dots from merging together when there is only 1 repetition.
              // 0.75 is the lowest possible stretch value for flooredRepetitions > 1, so it makes sense as lower bound.
              vStipplePatternStretch = max(0.75, stretch);`:""}

        return vec2(0.0, segmentLengthScreenRounded);
      }
      return vec2(startPseudoScreen, startPseudoScreen + segmentLengthPseudoScreen);
    }
  `),s.constants.add("stippleTexturePadding","float",V$e),s.uniforms.add(new et("stipplePatternTexture",n=>n.stippleTexture),new Ie("stipplePatternSDFNormalizer",n=>Ebt(n.stipplePattern)),new Ie("stipplePatternPixelSizeInv",n=>1/rie(n))),s.code.add(w`float padStippleTexture(float u) {
float paddedTextureSize = float(textureSize(stipplePatternTexture, 0).x);
float unpaddedTextureSize = paddedTextureSize - stippleTexturePadding;
return (u * unpaddedTextureSize + stippleTexturePadding * 0.5) / paddedTextureSize;
}`),s.code.add(w`
    float getStippleSDF(out bool isClamped) {
      ${e.stippleRequiresClamp?w`
          float stippleDistanceClamped = clamp(vStippleDistance, vStippleDistanceLimits.x, vStippleDistanceLimits.y);
          vec2 aaCorrectedLimits = vStippleDistanceLimits + vec2(1.0, -1.0) / gl_FragCoord.w;
          isClamped = vStippleDistance < aaCorrectedLimits.x || vStippleDistance > aaCorrectedLimits.y;`:w`
          float stippleDistanceClamped = vStippleDistance;
          isClamped = false;`}

      float u = stippleDistanceClamped * gl_FragCoord.w * stipplePatternPixelSizeInv;
      ${e.stippleScaleWithLineWidth?w`u *= vLineSizeInv;`:""}
      u = padStippleTexture(fract(u));

      float encodedSDF = rgba2float(texture(stipplePatternTexture, vec2(u, 0.5)));
      float sdf = (encodedSDF * 2.0 - 1.0) * stipplePatternSDFNormalizer;

      ${e.stippleRequiresStretchMeasure?w`return (sdf - 0.5) * vStipplePatternStretch + 0.5;`:w`return sdf;`}
    }

    float getStippleSDF() {
      bool ignored;
      return getStippleSDF(ignored);
    }

    float getStippleAlpha() {
      bool isClamped;
      float stippleSDF = getStippleSDF(isClamped);

      float antiAliasedResult = ${e.stippleScaleWithLineWidth?w`clamp(stippleSDF * vLineWidth + 0.5, 0.0, 1.0);`:w`clamp(stippleSDF + 0.5, 0.0, 1.0);`}

      return isClamped ? floor(antiAliasedResult + 0.5) : antiAliasedResult;
    }
  `),e.stippleOffColorEnabled?(s.uniforms.add(new cr("stippleOffColor",n=>wbt(n.stippleOffColor))),s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) {}
#define blendStipple(color, stippleAlpha) mix(color, stippleOffColor, stippleAlpha)`)):s.code.add(w`#define discardByStippleAlpha(stippleAlpha, threshold) if (stippleAlpha < threshold) { discard; }
#define blendStipple(color, stippleAlpha) vec4(color.rgb, color.a * stippleAlpha)`)}function Sbt(t){t.fragment.code.add(w`float getStippleAlpha() { return 1.0; }
#define discardByStippleAlpha(_stippleAlpha_, _threshold_) {}
#define blendStipple(color, _stippleAlpha_) color`)}function Ebt(t){return t?(Math.floor(.5*(U$e(t)-1))+.5)/t.pixelRatio:1}function rie(t){const e=t.stipplePattern;return e?k$e(t.stipplePattern)/e.pixelRatio:1}const Cbt=w.float(.4),hT=64,iie=hT/2,B$e=iie/5,Abt=hT/B$e,Obt=.25;function Rbt(t,e){const r=hPe(t,hT,iie,B$e),i=new Sr;return i.internalFormat=At.RGBA,i.width=hT,i.height=hT,i.wrapMode=Ut.CLAMP_TO_EDGE,new Rt(e,i,r)}function G$e(t,e){const{vertex:r,constants:i}=t;i.add("markerSizePerLineWidth","float",Abt),MO(r,e),r.uniforms.get("markerScale")==null&&r.constants.add("markerScale","float",1),r.code.add(w`float getLineWidth() {
return max(getSize(), 1.0) * pixelRatio;
}
float getScreenMarkerSize() {
return markerSizePerLineWidth * markerScale * getLineWidth();
}`),e.space===bh.World&&(r.constants.add("maxSegmentLengthFraction","float",.45),r.uniforms.add(new Ie("perRenderPixelRatio",(s,n)=>n.camera.perRenderPixelRatio)),r.code.add(w`bool areWorldMarkersHidden(vec4 pos, vec4 other) {
vec3 midPoint = mix(pos.xyz, other.xyz, 0.5);
float distanceToCamera = length(midPoint);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
float worldMarkerSize = getScreenMarkerSize() * screenToWorldRatio;
float segmentLen = length(pos.xyz - other.xyz);
return worldMarkerSize > maxSegmentLengthFraction * segmentLen;
}
float getWorldMarkerSize(vec4 pos) {
float distanceToCamera = length(pos.xyz);
float screenToWorldRatio = perRenderPixelRatio * distanceToCamera * 0.5;
return getScreenMarkerSize() * screenToWorldRatio;
}`))}var kd;(function(t){t[t.BUTT=0]="BUTT",t[t.SQUARE=1]="SQUARE",t[t.ROUND=2]="ROUND",t[t.COUNT=3]="COUNT"})(kd||(kd={}));let ns=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.capType=kd.BUTT,this.transparencyPassType=ut.NONE,this.occluder=!1,this.hasSlicePlane=!1,this.hasPolygonOffset=!1,this.writeDepth=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.roundJoins=!1,this.applyMarkerOffset=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.falloffEnabled=!1,this.innerColorEnabled=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.wireframe=!1,this.objectAndLayerIdColorInstanced=!1}};u([B({count:k.COUNT})],ns.prototype,"output",void 0),u([B({count:kd.COUNT})],ns.prototype,"capType",void 0),u([B({count:ut.COUNT})],ns.prototype,"transparencyPassType",void 0),u([B()],ns.prototype,"occluder",void 0),u([B()],ns.prototype,"hasSlicePlane",void 0),u([B()],ns.prototype,"hasPolygonOffset",void 0),u([B()],ns.prototype,"writeDepth",void 0),u([B()],ns.prototype,"draped",void 0),u([B()],ns.prototype,"stippleEnabled",void 0),u([B()],ns.prototype,"stippleOffColorEnabled",void 0),u([B()],ns.prototype,"stippleScaleWithLineWidth",void 0),u([B()],ns.prototype,"stipplePreferContinuous",void 0),u([B()],ns.prototype,"roundJoins",void 0),u([B()],ns.prototype,"applyMarkerOffset",void 0),u([B()],ns.prototype,"vvSize",void 0),u([B()],ns.prototype,"vvColor",void 0),u([B()],ns.prototype,"vvOpacity",void 0),u([B()],ns.prototype,"falloffEnabled",void 0),u([B()],ns.prototype,"innerColorEnabled",void 0),u([B()],ns.prototype,"hasOccludees",void 0),u([B()],ns.prototype,"hasMultipassTerrain",void 0),u([B()],ns.prototype,"cullAboveGround",void 0),u([B()],ns.prototype,"wireframe",void 0),u([B({constValue:!0})],ns.prototype,"stippleRequiresClamp",void 0),u([B({constValue:!0})],ns.prototype,"stippleRequiresStretchMeasure",void 0),u([B({constValue:!0})],ns.prototype,"hasVvInstancing",void 0),u([B({constValue:!0})],ns.prototype,"hasSliceTranslatedView",void 0),u([B()],ns.prototype,"objectAndLayerIdColorInstanced",void 0);const WU=1;function Mbt(t){const e=new Cr,{vertex:r,fragment:i}=e,s=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha);e.include(S$),e.include(N$e,t),e.include(z$e,t);const n=t.applyMarkerOffset&&!t.draped;n&&(r.uniforms.add(new Ie("markerScale",m=>m.markerScale)),e.include(G$e,{space:bh.World,draped:!1})),t.output===k.Depth&&e.include(N0,t),e.include($$,t),Eu(r,t),r.uniforms.add(new es("inverseProjectionMatrix",(m,g)=>g.camera.inverseProjectionMatrix),new Pr("nearFar",(m,g)=>g.camera.nearFar),new Ie("miterLimit",m=>m.join!=="miter"?0:m.miterLimit),new cr("viewport",(m,g)=>g.camera.fullViewport)),r.constants.add("LARGE_HALF_FLOAT","float",65500),e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.SUBDIVISIONFACTOR,"float"),e.attributes.add(E.UV0,"vec2"),e.attributes.add(E.AUXPOS1,"vec3"),e.attributes.add(E.AUXPOS2,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),J1(e),s&&e.varyings.add("depth","float");const o=t.stippleEnabled&&t.stippleScaleWithLineWidth;o&&e.varyings.add("vLineSizeInv","float");const a=t.capType===kd.ROUND,l=o||a;l&&e.varyings.add("vLineWidth","float");const c=t.innerColorEnabled||a;c&&e.varyings.add("vLineDistance","float");const h=t.stippleEnabled&&a,p=t.falloffEnabled||h;p&&e.varyings.add("vLineDistanceNorm","float"),a&&(e.varyings.add("vSegmentSDF","float"),e.varyings.add("vReverseSegmentSDF","float")),r.code.add(w`#define PERPENDICULAR(v) vec2(v.y, -v.x);
float interp(float ncp, vec4 a, vec4 b) {
return (-ncp - a.z) / (b.z - a.z);
}
vec2 rotate(vec2 v, float a) {
float s = sin(a);
float c = cos(a);
mat2 m = mat2(c, -s, s, c);
return m * v;
}`),r.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),l8(e),r.code.add(w`
    void clipAndTransform(inout vec4 pos, inout vec4 prev, inout vec4 next, in bool isStartVertex) {
      float vnp = nearFar[0] * 0.99;

      if(pos.z > -nearFar[0]) {
        //current pos behind ncp --> we need to clip
        if (!isStartVertex) {
          if(prev.z < -nearFar[0]) {
            //previous in front of ncp
            pos = mix(prev, pos, interp(vnp, prev, pos));
            next = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        } else {
          if(next.z < -nearFar[0]) {
            //next in front of ncp
            pos = mix(pos, next, interp(vnp, pos, next));
            prev = pos;
          } else {
            pos = vec4(0.0, 0.0, 0.0, 1.0);
          }
        }
      } else {
        //current position visible
        if (prev.z > -nearFar[0]) {
          //previous behind ncp
          prev = mix(pos, prev, interp(vnp, pos, prev));
        }
        if (next.z > -nearFar[0]) {
          //next behind ncp
          next = mix(next, pos, interp(vnp, next, pos));
        }
      }

      ${s?"depth = pos.z;":""}
      linearDepth = calculateLinearDepth(nearFar,pos.z);

      pos = projectAndScale(pos);
      next = projectAndScale(next);
      prev = projectAndScale(prev);
    }
  `),MO(r,t),r.code.add(w`
  void main(void) {
    // unpack values from uv0.y
    bool isStartVertex = abs(abs(uv0.y)-3.0) == 1.0;

    float coverage = 1.0;

    // Check for special value of uv0.y which is used by the Renderer when graphics
    // are removed before the VBO is recompacted. If this is the case, then we just
    // project outside of clip space.
    if (uv0.y == 0.0) {
      // Project out of clip space
      gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
    }
    else {
      bool isJoin = abs(uv0.y) < 3.0;

      float lineSize = getSize();
      float lineWidth = lineSize * pixelRatio;

      ${l?w`vLineWidth = lineWidth;`:""}
      ${o?w`vLineSizeInv = 1.0 / lineSize;`:""}

      // convert sub-pixel coverage to alpha
      if (lineWidth < 1.0) {
        coverage = lineWidth;
        lineWidth = 1.0;
      }else{
        // Ribbon lines cannot properly render non-integer sizes. Round width to integer size if
        // larger than one for better quality. Note that we do render < 1 pixels more or less correctly
        // so we only really care to round anything larger than 1.
        lineWidth = floor(lineWidth + 0.5);
      }

      vec4 pos  = view * vec4(position.xyz, 1.0);
      vec4 prev = view * vec4(auxpos1.xyz, 1.0);
      vec4 next = view * vec4(auxpos2.xyz, 1.0);
  `),n&&r.code.add(w`vec4 other = isStartVertex ? next : prev;
bool markersHidden = areWorldMarkersHidden(pos, other);
if(!isJoin && !markersHidden) {
pos.xyz += normalize(other.xyz - pos.xyz) * getWorldMarkerSize(pos) * 0.5;
}`),r.code.add(w`clipAndTransform(pos, prev, next, isStartVertex);
vec2 left = (pos.xy - prev.xy);
vec2 right = (next.xy - pos.xy);
float leftLen = length(left);
float rightLen = length(right);`),(t.stippleEnabled||a)&&r.code.add(w`
      float isEndVertex = float(!isStartVertex);
      vec2 segmentOrigin = mix(pos.xy, prev.xy, isEndVertex);
      vec2 segment = mix(right, left, isEndVertex);
      ${a?w`vec2 segmentEnd = mix(next.xy, pos.xy, isEndVertex);`:""}
    `),r.code.add(w`left = (leftLen > 0.001) ? left/leftLen : vec2(0.0, 0.0);
right = (rightLen > 0.001) ? right/rightLen : vec2(0.0, 0.0);
vec2 capDisplacementDir = vec2(0, 0);
vec2 joinDisplacementDir = vec2(0, 0);
float displacementLen = lineWidth;
if (isJoin) {
bool isOutside = (left.x * right.y - left.y * right.x) * uv0.y > 0.0;
joinDisplacementDir = normalize(left + right);
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);
if (leftLen > 0.001 && rightLen > 0.001) {
float nDotSeg = dot(joinDisplacementDir, left);
displacementLen /= length(nDotSeg * left - joinDisplacementDir);
if (!isOutside) {
displacementLen = min(displacementLen, min(leftLen, rightLen)/abs(nDotSeg));
}
}
if (isOutside && (displacementLen > miterLimit * lineWidth)) {`),t.roundJoins?r.code.add(w`
        vec2 startDir = leftLen < 0.001 ? right : left;
        startDir = PERPENDICULAR(startDir);

        vec2 endDir = rightLen < 0.001 ? left : right;
        endDir = PERPENDICULAR(endDir);

        float factor = ${t.stippleEnabled?w`min(1.0, subdivisionFactor * ${w.float((WU+2)/(WU+1))})`:w`subdivisionFactor`};

        float rotationAngle = acos(clamp(dot(startDir, endDir), -1.0, 1.0));
        joinDisplacementDir = rotate(startDir, -sign(uv0.y) * factor * rotationAngle);
      `):r.code.add(w`if (leftLen < 0.001) {
joinDisplacementDir = right;
}
else if (rightLen < 0.001) {
joinDisplacementDir = left;
}
else {
joinDisplacementDir = (isStartVertex || subdivisionFactor > 0.0) ? right : left;
}
joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);`);const f=t.capType!==kd.BUTT;return r.code.add(w`
        displacementLen = lineWidth;
      }
    } else {
      // CAP handling ---------------------------------------------------
      joinDisplacementDir = isStartVertex ? right : left;
      joinDisplacementDir = PERPENDICULAR(joinDisplacementDir);

      ${f?w`capDisplacementDir = isStartVertex ? -right : left;`:""}
    }
  `),r.code.add(w`
    // Displacement (in pixels) caused by join/or cap
    vec2 dpos = joinDisplacementDir * sign(uv0.y) * displacementLen + capDisplacementDir * displacementLen;

    ${p||c?w`float lineDistNorm = sign(uv0.y) * pos.w;`:""}

    ${c?w`vLineDistance = lineWidth * lineDistNorm;`:""}
    ${p?w`vLineDistanceNorm = lineDistNorm;`:""}

    pos.xy += dpos;
  `),a&&r.code.add(w`vec2 segmentDir = normalize(segment);
vSegmentSDF = (isJoin && isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentOrigin, segmentDir) * pos.w) ;
vReverseSegmentSDF = (isJoin && !isStartVertex) ? LARGE_HALF_FLOAT : (dot(pos.xy - segmentEnd, -segmentDir) * pos.w);`),t.stippleEnabled&&(t.draped?r.uniforms.add(new Ie("worldToScreenRatio",(m,g)=>1/g.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = mix((auxpos2 + position) * 0.5, (position + auxpos1) * 0.5, isEndVertex);
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float segmentLengthScreenDouble = length(segment);
float segmentLengthScreen = segmentLengthScreenDouble * 0.5;
float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);
float segmentLengthRender = length(mix(auxpos2 - position, position - auxpos1, isEndVertex));
vStipplePatternStretch = worldToScreenRatio / discreteWorldToScreenRatio;`),t.draped?r.code.add(w`float segmentLengthPseudoScreen = segmentLengthScreen / pixelRatio * discreteWorldToScreenRatio / worldToScreenRatio;
float startPseudoScreen = uv0.x * discreteWorldToScreenRatio - mix(0.0, segmentLengthPseudoScreen, isEndVertex);`):r.code.add(w`float startPseudoScreen = mix(uv0.x, uv0.x - segmentLengthRender, isEndVertex) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Ie("stipplePatternPixelSize",m=>rie(m))),r.code.add(w`
      float patternLength = ${t.stippleScaleWithLineWidth?"lineSize * ":""} stipplePatternPixelSize;

      // Compute the coordinates at both start and end of the line segment, because we need both to clamp to in the fragment shader
      vStippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, segmentLengthScreen, patternLength);

      vStippleDistance = mix(vStippleDistanceLimits.x, vStippleDistanceLimits.y, isEndVertex);

      // Adjust the coordinate to the displaced position (the pattern is shortened/overextended on the in/outside of joins)
      if (segmentLengthScreenDouble >= 0.001) {
        // Project the actual vertex position onto the line segment. Note that the resulting factor is within [0..1] at the
        // original vertex positions, and slightly outside of that range at the displaced positions
        vec2 stippleDisplacement = pos.xy - segmentOrigin;
        float stippleDisplacementFactor = dot(segment, stippleDisplacement) / (segmentLengthScreenDouble * segmentLengthScreenDouble);

        // Apply this offset to the actual vertex coordinate (can be screen or pseudo-screen space)
        vStippleDistance += (stippleDisplacementFactor - isEndVertex) * (vStippleDistanceLimits.y - vStippleDistanceLimits.x);
      }

      // Cancel out perspective correct interpolation because we want this length the really represent the screen distance
      vStippleDistanceLimits *= pos.w;
      vStippleDistance *= pos.w;

      // Disable stipple distance limits on caps
      vStippleDistanceLimits = isJoin ?
                                 vStippleDistanceLimits :
                                 isStartVertex ?
                                  vec2(-1e038, vStippleDistanceLimits.y) :
                                  vec2(vStippleDistanceLimits.x, 1e038);
    `)),r.code.add(w`
      // Convert back into NDC
      pos.xy = (pos.xy / viewport.zw) * pos.w;

      vColor = getColor();
      vColor.a *= coverage;

      ${t.wireframe&&!t.draped?"pos.z -= 0.001 * pos.w;":""}

      // transform final position to camera space for slicing
      vpos = (inverseProjectionMatrix * pos).xyz;
      gl_Position = pos;
      forwardObjectAndLayerIdColor();
    }
  }
  `),s&&e.include(Ah,t),e.include(Bs,t),i.include(kg),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${s?"terrainDepthTest(gl_FragCoord, depth);":""}
  `),t.wireframe?i.code.add(w`vec4 finalColor = vec4(1.0, 0.0, 1.0, 1.0);`):(a&&i.code.add(w`
      float sdf = min(vSegmentSDF, vReverseSegmentSDF);
      vec2 fragmentPosition = vec2(
        min(sdf, 0.0),
        vLineDistance
      ) * gl_FragCoord.w;

      float fragmentRadius = length(fragmentPosition);
      float fragmentCapSDF = (fragmentRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float capCoverage = clamp(0.5 - fragmentCapSDF, 0.0, 1.0);

      if (capCoverage < ${w.float(ia)}) {
        discard;
      }
    `),h?i.code.add(w`
      vec2 stipplePosition = vec2(
        min(getStippleSDF() * 2.0 - 1.0, 0.0),
        vLineDistanceNorm * gl_FragCoord.w
      );
      float stippleRadius = length(stipplePosition * vLineWidth);
      float stippleCapSDF = (stippleRadius - vLineWidth) * 0.5; // Divide by 2 to transform from double pixel scale
      float stippleCoverage = clamp(0.5 - stippleCapSDF, 0.0, 1.0);
      float stippleAlpha = step(${w.float(ia)}, stippleCoverage);
      `):i.code.add(w`float stippleAlpha = getStippleAlpha();`),i.uniforms.add(new cr("intrinsicColor",m=>m.color)),t.output!==k.ObjectAndLayerIdColor&&i.code.add(w`discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);`),i.code.add(w`vec4 color = intrinsicColor * vColor;`),t.innerColorEnabled&&(i.uniforms.add(new cr("innerColor",m=>m.innerColor??m.color),new Ie("innerWidth",(m,g)=>m.innerWidth*g.camera.pixelRatio)),i.code.add(w`float distToInner = abs(vLineDistance * gl_FragCoord.w) - innerWidth;
float innerAA = clamp(0.5 - distToInner, 0.0, 1.0);
float innerAlpha = innerColor.a + color.a * (1.0 - innerColor.a);
color = mix(color, vec4(innerColor.rgb, innerAlpha), innerAA);`)),i.code.add(w`vec4 finalColor = blendStipple(color, stippleAlpha);`),t.falloffEnabled&&(i.uniforms.add(new Ie("falloff",m=>m.falloff)),i.code.add(w`finalColor.a *= pow(max(0.0, 1.0 - abs(vLineDistanceNorm * gl_FragCoord.w)), falloff);`))),i.code.add(w`
    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(ia)}) {
      discard;
    }

    ${t.output===k.Alpha?w`fragColor = vec4(finalColor.a);`:""}
    ${t.output===k.Color?w`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Color&&t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${t.output===k.Highlight?w`fragColor = vec4(1.0);`:""}
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""}
    ${t.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const Ibt=Object.freeze(Object.defineProperty({__proto__:null,RIBBONLINE_NUM_ROUND_JOIN_SUBDIVISIONS:WU,build:Mbt},Symbol.toStringTag,{value:"Module"})),sie={func:ci.LESS},ZU={func:ci.ALWAYS},Og={mask:255},j$e={mask:0},Pbt=t=>({function:{func:ci.NOTEQUAL,ref:t,mask:t},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.KEEP}}),$bt=t=>({function:{func:ci.ALWAYS,ref:t,mask:t},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.REPLACE}}),yb={function:{func:ci.ALWAYS,ref:xc.OutlineVisualElementMask,mask:xc.OutlineVisualElementMask},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.ZERO}},nb={function:{func:ci.ALWAYS,ref:xc.OutlineVisualElementMask,mask:xc.OutlineVisualElementMask},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.REPLACE}},H$e={function:{func:ci.EQUAL,ref:xc.OutlineVisualElementMask,mask:xc.OutlineVisualElementMask},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.KEEP}},q$e={function:{func:ci.NOTEQUAL,ref:xc.OutlineVisualElementMask,mask:xc.OutlineVisualElementMask},operation:{fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.KEEP}},W$e=new Map([[E.POSITION,0],[E.SUBDIVISIONFACTOR,1],[E.UV0,2],[E.AUXPOS1,3],[E.AUXPOS2,4],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.OPACITYFEATUREATTRIBUTE,7],[E.OBJECTANDLAYERIDCOLOR,8]]);let Z$e=class X$e extends Ur{initializeProgram(e){return new Lr(e.rctx,X$e.shader.get().build(this.configuration),W$e)}_makePipelineState(e,r){const i=this.configuration,s=e===ut.NONE,n=e===ut.FrontFace;return It({blending:i.output===k.Color||i.output===k.Alpha?s?vh:Q0(e):null,depthTest:{func:gb(e)},depthWrite:s?i.writeDepth?Ac:null:I8(e),colorWrite:Wt,stencilWrite:i.hasOccludees?Og:null,stencilTest:i.hasOccludees?r?nb:yb:null,polygonOffset:s||n?i.hasPolygonOffset?Ape:null:$8})}initializePipeline(){const e=this.configuration;if(e.occluder){const r=e.hasPolygonOffset?Ape:null;this._occluderPipelineTransparent=It({blending:vh,polygonOffset:r,depthTest:ZU,depthWrite:null,colorWrite:Wt,stencilWrite:null,stencilTest:q$e}),this._occluderPipelineOpaque=It({blending:vh,polygonOffset:r,depthTest:ZU,depthWrite:null,colorWrite:Wt,stencilWrite:j$e,stencilTest:H$e}),this._occluderPipelineMaskWrite=It({blending:null,polygonOffset:r,depthTest:sie,depthWrite:null,colorWrite:null,stencilWrite:Og,stencilTest:nb})}return this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}get primitiveType(){return this.configuration.wireframe?Ot.LINES:Ot.TRIANGLE_STRIP}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===fe.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===fe.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};Z$e.shader=new $r(Ibt,()=>J(()=>import("./RibbonLine.glsl-c708f405.js"),[],import.meta.url));const Ape={factor:0,units:-4};var tu;(function(t){t[t.LEFT_JOIN_START=-2]="LEFT_JOIN_START",t[t.LEFT_JOIN_END=-1]="LEFT_JOIN_END",t[t.LEFT_CAP_START=-4]="LEFT_CAP_START",t[t.LEFT_CAP_END=-5]="LEFT_CAP_END",t[t.RIGHT_JOIN_START=2]="RIGHT_JOIN_START",t[t.RIGHT_JOIN_END=1]="RIGHT_JOIN_END",t[t.RIGHT_CAP_START=4]="RIGHT_CAP_START",t[t.RIGHT_CAP_END=5]="RIGHT_CAP_END"})(tu||(tu={}));let uC=class extends mb{constructor(e){super(e,new Dbt),this._configuration=new ns,this._vertexAttributeLocations=W$e}isClosed(e,r){return J$e(this.parameters,e,r)}getConfiguration(e,r){this._configuration.output=e,this._configuration.draped=r.slot===fe.DRAPED_MATERIAL;const i=this.parameters.stipplePattern!=null&&e!==k.Highlight;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.stippleScaleWithLineWidth=i&&this.parameters.stippleScaleWithLineWidth,this._configuration.stipplePreferContinuous=i&&this.parameters.stipplePreferContinuous,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.roundJoins=this.parameters.join==="round",this._configuration.capType=this.parameters.cap,this._configuration.applyMarkerOffset=this.parameters.markerParameters!=null&&Fbt(this.parameters.markerParameters),this._configuration.hasPolygonOffset=this.parameters.hasPolygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.innerColorEnabled=this.parameters.innerWidth>0&&this.parameters.innerColor!=null,this._configuration.falloffEnabled=this.parameters.falloff>0,this._configuration.occluder=this.parameters.renderOccluded===Qi.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.wireframe=this.parameters.wireframe,this._configuration}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(E.POSITION).data,l=e.vertexAttributes.get(E.SIZE);let c=this.parameters.width;if(this.parameters.vvSize){const _=e.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0];c*=ye(this.parameters.vvSize.offset[0]+_*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else l&&(c*=l.data[0]);const h=s[0],p=s[1],f=(c/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,g=0;for(let _=0;_<a.length-5;_+=3){const v=a[_],b=a[_+1],x=h-v,T=p-b,S=a[_+3]-v,O=a[_+4]-b,A=ye((S*x+O*T)/(S*S+O*O),0,1),M=S*A-x,P=O*A-T,F=M*M+P*P;F<m&&(m=F,g=_/3)}m<f*f&&n(o.dist,o.normal,g,!1)}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!HRe(r))return void K.getLogger("esri.views.3d.webgl-engine.materials.RibbonLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes,l=a.get(E.POSITION).data;let c=this.parameters.width;if(this.parameters.vvSize){const x=a.get(E.SIZEFEATUREATTRIBUTE).data[0];c*=ye(this.parameters.vvSize.offset[0]+x*this.parameters.vvSize.factor[0],this.parameters.vvSize.minSize[0],this.parameters.vvSize.maxSize[0])}else a.has(E.SIZE)&&(c*=a.get(E.SIZE).data[0]);const h=i.camera,p=kbt;jn(p,i.point);const f=c*h.pixelRatio/2+4*h.pixelRatio;ie(AR[0],p[0]-f,p[1]+f,0),ie(AR[1],p[0]+f,p[1]+f,0),ie(AR[2],p[0]+f,p[1]-f,0),ie(AR[3],p[0]-f,p[1]-f,0);for(let x=0;x<4;x++)if(!h.unprojectFromRenderScreen(AR[x],ey[x]))return;Wa(h.eye,ey[0],ey[1],aG),Wa(h.eye,ey[1],ey[2],lG),Wa(h.eye,ey[2],ey[3],cG),Wa(h.eye,ey[3],ey[0],uG);let m=Number.MAX_VALUE,g=0;const _=Y$e(this.parameters,a,e.indices)?l.length-2:l.length-5;for(let x=0;x<_;x+=3){Zl[0]=l[x]+r[12],Zl[1]=l[x+1]+r[13],Zl[2]=l[x+2]+r[14];const T=(x+3)%l.length;if(Xl[0]=l[T]+r[12],Xl[1]=l[T+1]+r[13],Xl[2]=l[T+2]+r[14],Oi(aG,Zl)<0&&Oi(aG,Xl)<0||Oi(lG,Zl)<0&&Oi(lG,Xl)<0||Oi(cG,Zl)<0&&Oi(cG,Xl)<0||Oi(uG,Zl)<0&&Oi(uG,Xl)<0)continue;if(h.projectToRenderScreen(Zl,Hb),h.projectToRenderScreen(Xl,qb),Hb[2]<0&&qb[2]>0){pe(sm,Zl,Xl);const O=h.frustum,A=-Oi(O[Ai.NEAR],Zl)/de(sm,O[Ai.NEAR]);ae(sm,sm,A),ue(Zl,Zl,sm),h.projectToRenderScreen(Zl,Hb)}else if(Hb[2]>0&&qb[2]<0){pe(sm,Xl,Zl);const O=h.frustum,A=-Oi(O[Ai.NEAR],Xl)/de(sm,O[Ai.NEAR]);ae(sm,sm,A),ue(Xl,Xl,sm),h.projectToRenderScreen(Xl,qb)}else if(Hb[2]<0&&qb[2]<0)continue;Hb[2]=0,qb[2]=0;const S=xte(aT(Hb,qb,Mpe),p);S<m&&(m=S,oe(Ope,Zl),oe(Rpe,Xl),g=x/3)}const v=i.rayBegin,b=i.rayEnd;if(m<f*f){let x=Number.MAX_VALUE;if(sRe(aT(Ope,Rpe,Mpe),aT(v,b,Ubt),jb)){pe(jb,jb,v);const T=Oe(jb);ae(jb,jb,1/T),x=T/_i(v,b)}o(x,jb,g,!1)}}get _layout(){const e=us().vec3f(E.POSITION).f32(E.SUBDIVISIONFACTOR).vec2f(E.UV0).vec3f(E.AUXPOS1).vec3f(E.AUXPOS2);return this.parameters.vvSize?e.f32(E.SIZEFEATUREATTRIBUTE):e.f32(E.SIZE),this.parameters.vvColor?e.f32(E.COLORFEATUREATTRIBUTE):e.vec4f(E.COLOR),this.parameters.vvOpacity&&e.f32(E.OPACITYFEATUREATTRIBUTE),le("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(E.OBJECTANDLAYERIDCOLOR),e}createBufferWriter(){return new Nbt(this._layout,this.parameters)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth||r===k.ObjectAndLayerIdColor?e===fe.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===Qi.OccludeAndTransparentStencil?e===fe.OPAQUE_MATERIAL||e===fe.OCCLUDER_MATERIAL||e===fe.TRANSPARENT_OCCLUDER_MATERIAL:r===k.Color||r===k.Alpha?e===(this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===fe.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new Lbt(e)}validateParameters(e){e.join!=="miter"&&(e.miterLimit=0),e.markerParameters!=null&&(e.markerScale=e.markerParameters.width/e.width)}},Lbt=class extends pb{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(Z$e,e)}},Dbt=class extends D${constructor(){super(...arguments),this.width=0,this.color=Od,this.join="miter",this.cap=kd.BUTT,this.miterLimit=5,this.writeDepth=!0,this.hasPolygonOffset=!1,this.stippleTexture=null,this.stippleScaleWithLineWidth=!1,this.stipplePreferContinuous=!0,this.markerParameters=null,this.markerScale=1,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.isClosed=!1,this.falloff=0,this.innerWidth=0,this.hasOccludees=!1,this.wireframe=!1}},Nbt=class{constructor(e,r){this._parameters=r,this.numJoinSubdivisions=0,this.vertexBufferLayout=e;const i=r.stipplePattern?1:0;switch(this._parameters.join){case"miter":case"bevel":this.numJoinSubdivisions=i;break;case"round":this.numJoinSubdivisions=WU+i}}_isClosed(e){return Y$e(this._parameters,e.vertexAttributes,e.indices)}allocate(e){return this.vertexBufferLayout.createBuffer(e)}elementCount(e){const i=e.indices.get(E.POSITION).length/2+1,s=this._isClosed(e);let n=s?2:2*2;return n+=((s?i:i-1)-(s?0:1))*(2*this.numJoinSubdivisions+4),n+=2,this._parameters.wireframe&&(n=2+4*(n-2)),n}write(e,r,i,s,n){const o=Vbt,a=zbt,l=Bbt,c=i.vertexAttributes.get(E.POSITION).data,h=i.indices&&i.indices.get(E.POSITION),p=i.vertexAttributes.get(E.DISTANCETOSTART)?.data;h&&h.length!==2*(c.length/3-1)&&console.warn("RibbonLineMaterial does not support indices");let f=1,m=0;this._parameters.vvSize?m=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(f=i.vertexAttributes.get(E.SIZE).data[0]);let g=[1,1,1,1],_=0;this._parameters.vvColor?_=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(g=i.vertexAttributes.get(E.COLOR).data);const v=le("enable-feature:objectAndLayerId-rendering")?i.objectAndLayerIdColor:null;let b=0;this._parameters.vvOpacity&&(b=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const x=c.length/3,T=new Float32Array(s.buffer),S=le("enable-feature:objectAndLayerId-rendering")?new Uint8Array(s.buffer):null,O=this.vertexBufferLayout.stride/4;let A=n*O;const M=A;let P=0;const F=p?(G,ee,I)=>P=p[I]:(G,ee,I)=>P+=_i(G,ee),$=le("enable-feature:objectAndLayerId-rendering"),N=(G,ee,I,V,z,H,Y)=>{if(T[A++]=ee[0],T[A++]=ee[1],T[A++]=ee[2],T[A++]=V,T[A++]=Y,T[A++]=z,T[A++]=G[0],T[A++]=G[1],T[A++]=G[2],T[A++]=I[0],T[A++]=I[1],T[A++]=I[2],T[A++]=this._parameters.vvSize?m:f,this._parameters.vvColor)T[A++]=_;else{const te=Math.min(4*H,g.length-4);T[A++]=g[te],T[A++]=g[te+1],T[A++]=g[te+2],T[A++]=g[te+3]}this._parameters.vvOpacity&&(T[A++]=b),$&&(v!=null&&(S[4*A]=v[0],S[4*A+1]=v[1],S[4*A+2]=v[2],S[4*A+3]=v[3]),A++)};A+=O,ie(a,c[0],c[1],c[2]),e&&Ne(a,a,e);const U=this._isClosed(i);if(U){const G=c.length-3;ie(o,c[G],c[G+1],c[G+2]),e&&Ne(o,o,e)}else ie(l,c[3],c[4],c[5]),e&&Ne(l,l,e),N(a,a,l,1,tu.LEFT_CAP_START,0,0),N(a,a,l,1,tu.RIGHT_CAP_START,0,0),oe(o,a),oe(a,l);const X=U?0:1,Z=U?x:x-1;for(let G=X;G<Z;G++){const ee=(G+1)%x*3;ie(l,c[ee],c[ee+1],c[ee+2]),e&&Ne(l,l,e),F(o,a,G),N(o,a,l,0,tu.LEFT_JOIN_END,G,P),N(o,a,l,0,tu.RIGHT_JOIN_END,G,P);const I=this.numJoinSubdivisions;for(let V=0;V<I;++V){const z=(V+1)/(I+1);N(o,a,l,z,tu.LEFT_JOIN_END,G,P),N(o,a,l,z,tu.RIGHT_JOIN_END,G,P)}N(o,a,l,1,tu.LEFT_JOIN_START,G,P),N(o,a,l,1,tu.RIGHT_JOIN_START,G,P),oe(o,a),oe(a,l)}U?(ie(l,c[3],c[4],c[5]),e&&Ne(l,l,e),P=F(o,a,Z),N(o,a,l,0,tu.LEFT_JOIN_END,X,P),N(o,a,l,0,tu.RIGHT_JOIN_END,X,P)):(P=F(o,a,Z),N(o,a,a,0,tu.LEFT_CAP_END,Z,P),N(o,a,a,0,tu.RIGHT_CAP_END,Z,P)),oG(T,M+O,T,M,O),A=oG(T,A-O,T,A,O),this._parameters.wireframe&&this._addWireframeVertices(s,M,A,O)}_addWireframeVertices(e,r,i,s){const n=new Float32Array(e.buffer,i*Float32Array.BYTES_PER_ELEMENT),o=new Float32Array(e.buffer,r*Float32Array.BYTES_PER_ELEMENT,i-r);let a=0;const l=c=>a=oG(o,c,n,a,s);for(let c=0;c<o.length-1;c+=2*s)l(c),l(c+2*s),l(c+1*s),l(c+2*s),l(c+1*s),l(c+3*s)}};function oG(t,e,r,i,s){for(let n=0;n<s;n++)r[i++]=t[e++];return i}function Y$e(t,e,r){return J$e(t,e.get(E.POSITION).data,r?r.get(E.POSITION):null)}function J$e(t,e,r){return!!t.isClosed&&(r?r.length>2:e.length>6)}function Fbt(t){return t.anchor===ZT.Tip&&t.hideOnShortSegments&&t.placement==="begin-end"&&t.worldSpace}const Zl=C(),Xl=C(),sm=C(),jb=C(),kbt=C(),Hb=Lo(),qb=Lo(),Ope=C(),Rpe=C(),Mpe=Vf(),Ubt=Vf(),Vbt=C(),zbt=C(),Bbt=C(),AR=[Lo(),Lo(),Lo(),Lo()],ey=[C(),C(),C(),C()],aG=zr(),lG=zr(),cG=zr(),uG=zr();let nie=class{constructor(e){this._originSR=e,this._origins=new Map,this._objects=new Map,this._gridSize=5e5,this._rootOriginId="root/"+vc()}getOrigin(e){const r=this._origins.get(this._rootOriginId);if(r==null){const h=UU(e[0]+Math.random()-.5,e[1]+Math.random()-.5,e[2]+Math.random()-.5,this._rootOriginId);return this._origins.set(this._rootOriginId,h),h}const i=this._gridSize,s=Math.round(e[0]/i),n=Math.round(e[1]/i),o=Math.round(e[2]/i),a=`${s}/${n}/${o}`;let l=this._origins.get(a);const c=.5*i;if(pe(Bo,e,r.vec3),Bo[0]=Math.abs(Bo[0]),Bo[1]=Math.abs(Bo[1]),Bo[2]=Math.abs(Bo[2]),Bo[0]<c&&Bo[1]<c&&Bo[2]<c){if(l){const h=Math.max(...Bo);if(pe(Bo,e,l.vec3),Bo[0]=Math.abs(Bo[0]),Bo[1]=Math.abs(Bo[1]),Bo[2]=Math.abs(Bo[2]),Math.max(...Bo)<h)return l}return r}return l||(l=UU(s*i,n*i,o*i,a),this._origins.set(a,l)),l}_drawOriginBox(e,r=Vt(1,1,0,1)){const i=window.view,s=i._stage,n=r.toString();if(!this._objects.has(n)){this._material=new uC({width:2,color:r}),s.add(this._material);const m=new D$e(s,{pickable:!1}),g=new K0({castShadow:!1});s.add(g),m.add(g),this._objects.set(n,g)}const o=this._objects.get(n),a=[0,1,5,4,0,2,1,7,6,2,0,1,3,7,5,4,6,2,0],l=a.length,c=new Array(3*l),h=new Array,p=.5*this._gridSize;for(let m=0;m<l;m++)c[3*m]=e[0]+(1&a[m]?p:-p),c[3*m+1]=e[1]+(2&a[m]?p:-p),c[3*m+2]=e[2]+(4&a[m]?p:-p),m>0&&h.push(m-1,m);wi(c,this._originSR,0,c,i.renderSpatialReference,0,l);const f=new mn(this._material,[[E.POSITION,new Ge(c,3,!0)]],[[E.POSITION,h]],null,Ms.Line);s.add(f),o.addGeometry(f)}get test(){const e=this;return{set gridSize(r){e._gridSize=r}}}};const Bo=C();let Q$e=class{constructor(e,r,i,s=null){this.rctx=e,this.sliceHelper=s,this.lastFrameCamera=new ft,this.output=k.Color,this.renderOccludedMask=Ipe,this.bindParameters=new a8(r,i,s!=null?s.plane:null),this.bindParameters.alignPixelEnabled=!0}resetRenderOccludedMask(){this.renderOccludedMask=Ipe}},Gbt=class extends Q$e{constructor(e,r,i,s,n){super(e,i,s,n),this.offscreenRenderingHelper=r,this.sliceHelper=n,this.time=0}};const Ipe=Qi.Occlude|Qi.OccludeAndTransparent|Qi.OccludeAndTransparentStencil;let fM=class extends ft{constructor(){super(...arguments),this._projectionMatrix=xe()}get projectionMatrix(){return this._projectionMatrix}};u([d()],fM.prototype,"_projectionMatrix",void 0),u([d({readOnly:!0})],fM.prototype,"projectionMatrix",null),fM=u([R("esri.views.3d.webgl-engine.lib.CascadeCamera")],fM);const Ppe=16;function oie(t){return Math.ceil(t/Ppe)*Ppe}var GA;(function(t){t[t.Highlight=0]="Highlight",t[t.Default=1]="Default"})(GA||(GA={}));let fN=class{constructor(){this.camera=new fM,this.lightMat=xe()}},jbt=class{constructor(){this.maxNumCascadesHighQuality=4,this.maxNumCascadesLowQuality=4,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.splitSchemeLambda=0}},aie=class{get depthTexture(){return this._fbo?.colorTexture}get textureSize(){return this._textureSize}get numCascades(){return this._numCascades}get cascadeDistances(){return zi(this._usedCascadeDistances,this._cascadeDistances[0],this._numCascades>1?this._cascadeDistances[1]:1/0,this._numCascades>2?this._cascadeDistances[2]:1/0,this._numCascades>3?this._cascadeDistances[3]:1/0)}constructor(e,r){this._rctx=e,this._viewingMode=r,this._enabled=!1,this._snapshots=new Array,this._textureSize=0,this._numCascades=1,this.settings=new jbt,this._projectionView=xe(),this._projectionViewInverse=xe(),this._modelViewLight=xe(),this._cascadeDistances=[0,0,0,0,0],this._usedCascadeDistances=Qt(),this._cascades=[new fN,new fN,new fN,new fN],this._lastOrigin=null,this._maxTextureSize=Math.min(le("esri-mobile")?2048:8192,this._rctx.parameters.maxTextureSize)}dispose(){this.enabled=!1,this.disposeOffscreenBuffers()}disposeOffscreenBuffers(){this._fbo=ze(this._fbo),this._discardAllSnapshots()}set maxCascades(e){this.settings.maxNumCascadesHighQuality=ye(Math.floor(e),1,4)}get maxCascades(){return this.settings.maxNumCascadesHighQuality}set enabled(e){this._enabled=e,e||this.disposeOffscreenBuffers()}get enabled(){return this._enabled}get ready(){return this._enabled&&this.depthTexture!=null}getSnapshot(e){return this.enabled?this._snapshots[e]:null}get cascades(){for(let e=0;e<this._numCascades;++e)dG[e]=this._cascades[e];return dG.length=this._numCascades,dG}start(e,r,i,s,n){it(this.enabled),this._textureSize=this._computeTextureSize(e,n,s),this._ensureDepthTexture();const{near:o,far:a}=this._clampNearFar(i);this._computeCascadeDistances(a,o,s),this._setupMatrices(e,r);const{viewMatrix:l,projectionMatrix:c}=e;for(let h=0;h<this._numCascades;++h)this._constructCascade(h,c,l,r);this._lastOrigin=null,this.clear()}finish(e){it(this.enabled),this._rctx.bindFramebuffer(e)}getShadowMapMatrices(e){if(!this._lastOrigin||!Jr(e,this._lastOrigin)){this._lastOrigin=this._lastOrigin||C(),oe(this._lastOrigin,e);for(let r=0;r<this._numCascades;++r){Cc(kpe,this._cascades[r].lightMat,e);for(let i=0;i<16;++i)Upe[16*r+i]=kpe[i]}}return Upe}takeCascadeSnapshotTo(e,r){it(this.enabled);const i=this._ensureSnapshot(r);this._bindFbo();const s=this._rctx,n=s.bindTexture(i,Rt.TEXTURE_UNIT_FOR_UPDATES);s.gl.copyTexSubImage2D(Rs.TEXTURE_2D,0,e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[0],e.camera.viewport[1],e.camera.viewport[2],e.camera.viewport[3]),s.bindTexture(n,Rt.TEXTURE_UNIT_FOR_UPDATES)}clear(){const e=this._rctx;this._bindFbo(),e.setClearColor(1,1,1,1),e.clearSafe(Bi.COLOR_BUFFER_BIT|Bi.DEPTH_BUFFER_BIT)}_computeTextureSize(e,r,i){const s=Math.min(window.devicePixelRatio,r)/e.pixelRatio,n=Math.max(e.fullWidth,e.fullHeight)*s,o=i?this.settings.textureSizeModHighQuality:this.settings.textureSizeModLowQuality;return Math.floor(Math.min(this._maxTextureSize,oie((this.numCascades===1?1:2)*n*o)))}_ensureDepthTexture(){if(this._fbo?.width===this._textureSize)return;const e=new Sr(this._textureSize);e.wrapMode=Ut.CLAMP_TO_EDGE,e.samplingMode=Mt.NEAREST,this._fbo?.dispose(),this._fbo=new Vn(this._rctx,e,new mU(bn.DEPTH_COMPONENT16,this._textureSize))}_ensureSnapshot(e){let r=this._snapshots[e];if(r!=null&&r.descriptor.width===this._textureSize)return r;this._discardSnapshot(e);const i=new Sr;return i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.NEAREST,i.width=this._textureSize,i.height=this._textureSize,r=new Rt(this._rctx,i),this._snapshots[e]=r,r}_discardSnapshot(e){this._snapshots[e]=ze(this._snapshots[e])}_discardAllSnapshots(){for(let e=0;e<this._snapshots.length;++e)this._discardSnapshot(e);this._snapshots.length=0}_bindFbo(){const e=this._rctx;e.unbindTexture(this.depthTexture),e.bindFramebuffer(this._fbo)}_constructCascade(e,r,i,s){const n=this._cascades[e],o=-this._cascadeDistances[e],a=-this._cascadeDistances[e+1],l=(r[10]*o+r[14])/Math.abs(r[11]*o+r[15]),c=(r[10]*a+r[14])/Math.abs(r[11]*a+r[15]);it(l<c);for(let m=0;m<8;++m){zi($pe,m%4==0||m%4==3?-1:1,m%4==0||m%4==1?-1:1,m<4?l:c,1);const g=gd[m];ph(g,$pe,this._projectionViewInverse),g[0]/=g[3],g[1]/=g[3],g[2]/=g[3]}el(hG,gd[0]),n.camera.viewMatrix=Cc(Hbt,this._modelViewLight,hG);for(let m=0;m<8;++m)Ne(gd[m],gd[m],n.camera.viewMatrix);let h=gd[0][2],p=gd[0][2];for(let m=1;m<8;++m)h=Math.min(h,gd[m][2]),p=Math.max(p,gd[m][2]);h-=200,p+=200,n.camera.near=-p,n.camera.far=-h,Xbt(i,s,h,p,n.camera),yi(n.lightMat,n.camera.projectionMatrix,n.camera.viewMatrix);const f=this._textureSize/(this.numCascades===1?1:2);n.camera.viewport=[e%2==0?0:f,Math.floor(e/2)===0?0:f,f,f]}_setupMatrices(e,r){yi(this._projectionView,e.projectionMatrix,e.viewMatrix),so(this._projectionViewInverse,this._projectionView);const i=this._viewingMode===Ue.Global?e.eye:ie(hG,0,0,1);wV(this._modelViewLight,[0,0,0],[-r[0],-r[1],-r[2]],i)}_clampNearFar(e){let{near:r,far:i}=e;return r<2&&(r=2),i<2&&(i=2),r>=i&&(r=2,i=4),{near:r,far:i}}_computeCascadeDistances(e,r,i){const s=i?this.settings.maxNumCascadesHighQuality:this.settings.maxNumCascadesLowQuality;this._numCascades=Math.min(1+Math.floor(Uut(e/r,4)),s);const n=(e-r)/this._numCascades,o=(e/r)**(1/this._numCascades);let a=r,l=r;for(let c=0;c<this._numCascades+1;++c)this._cascadeDistances[c]=Et(a,l,this.settings.splitSchemeLambda),a*=o,l+=n}get gpuMemoryUsage(){return this._snapshots.reduce((e,r)=>e+(r?.gpuMemoryUsage??0),this._fbo?.gpuMemoryUsage??0)}get test(){return{cascades:this._cascades,textureSize:this._textureSize}}};const Hbt=xe(),$pe=Qt(),gd=[];for(let t=0;t<8;++t)gd.push(Qt());const Lpe=Pe(),Dpe=Pe(),qbt=Pe(),Npe=Pe(),Fpe=Pe(),hG=C(),dG=[],kpe=xe(),Upe=new Array(64),zu=Pe(),c2=Pe(),Wb=[Pe(),Pe(),Pe(),Pe()],Zn=Pe(),pG=Pe(),I_=Pe(),OR=Pe(),u2=Pe(),h2=Pe(),mN=Pe();function Wbt(t,e,r,i,s,n,o,a){hr(zu,0,0);for(let O=0;O<4;++O)_d(zu,zu,t[O]);fc(zu,zu,.25),hr(c2,0,0);for(let O=4;O<8;++O)_d(c2,c2,t[O]);fc(c2,c2,.25),ah(Wb[0],t[4],t[5],.5),ah(Wb[1],t[5],t[6],.5),ah(Wb[2],t[6],t[7],.5),ah(Wb[3],t[7],t[4],.5);let l=0,c=Lf(Wb[0],zu);for(let O=1;O<4;++O){const A=Lf(Wb[O],zu);A<c&&(c=A,l=O)}zs(Zn,Wb[l],t[l+4]);const h=Zn[0];let p,f;Zn[0]=-Zn[1],Zn[1]=h,zs(pG,c2,zu),ms(pG,Zn)<0&&qee(Zn,Zn),ah(Zn,Zn,pG,r),yA(Zn,Zn),p=f=ms(zs(I_,t[0],zu),Zn);for(let O=1;O<8;++O){const A=ms(zs(I_,t[O],zu),Zn);A<p?p=A:A>f&&(f=A)}jn(i,zu),fc(I_,Zn,p-e),_d(i,i,I_);let m=-1,g=1,_=0,v=0;for(let O=0;O<8;++O){zs(OR,t[O],i),yA(OR,OR);const A=Zn[0]*OR[1]-Zn[1]*OR[0];A>0?A>m&&(m=A,_=O):A<g&&(g=A,v=O)}GS(m>0,"leftArea"),GS(g<0,"rightArea"),fc(u2,Zn,p),_d(u2,u2,zu),fc(h2,Zn,f),_d(h2,h2,zu),mN[0]=-Zn[1],mN[1]=Zn[0];const b=bD(i,t[v],h2,_d(I_,h2,mN),1,s),x=bD(i,t[_],h2,I_,1,n),T=bD(i,t[_],u2,_d(I_,u2,mN),1,o),S=bD(i,t[v],u2,I_,1,a);GS(b,"rayRay"),GS(x,"rayRay"),GS(T,"rayRay"),GS(S,"rayRay")}function xr(t,e){return 3*e+t}const Vpe=Pe();function Dc(t,e){return hr(Vpe,t[e],t[e+3]),Vpe}const Yl=Pe(),Xe=ts();function Zbt(t,e,r,i,s){zs(Yl,r,i),fc(Yl,Yl,.5),Xe[0]=Yl[0],Xe[1]=Yl[1],Xe[2]=0,Xe[3]=Yl[1],Xe[4]=-Yl[0],Xe[5]=0,Xe[6]=Yl[0]*Yl[0]+Yl[1]*Yl[1],Xe[7]=Yl[0]*Yl[1]-Yl[1]*Yl[0],Xe[8]=1,Xe[xr(0,2)]=-ms(Dc(Xe,0),t),Xe[xr(1,2)]=-ms(Dc(Xe,1),t);let n=ms(Dc(Xe,0),r)+Xe[xr(0,2)],o=ms(Dc(Xe,1),r)+Xe[xr(1,2)],a=ms(Dc(Xe,0),i)+Xe[xr(0,2)],l=ms(Dc(Xe,1),i)+Xe[xr(1,2)];n=-(n+a)/(o+l),Xe[xr(0,0)]+=Xe[xr(1,0)]*n,Xe[xr(0,1)]+=Xe[xr(1,1)]*n,Xe[xr(0,2)]+=Xe[xr(1,2)]*n,n=1/(ms(Dc(Xe,0),r)+Xe[xr(0,2)]),o=1/(ms(Dc(Xe,1),r)+Xe[xr(1,2)]),Xe[xr(0,0)]*=n,Xe[xr(0,1)]*=n,Xe[xr(0,2)]*=n,Xe[xr(1,0)]*=o,Xe[xr(1,1)]*=o,Xe[xr(1,2)]*=o,Xe[xr(2,0)]=Xe[xr(1,0)],Xe[xr(2,1)]=Xe[xr(1,1)],Xe[xr(2,2)]=Xe[xr(1,2)],Xe[xr(1,2)]+=1,n=ms(Dc(Xe,1),e)+Xe[xr(1,2)],o=ms(Dc(Xe,2),e)+Xe[xr(2,2)],a=ms(Dc(Xe,1),r)+Xe[xr(1,2)],l=ms(Dc(Xe,2),r)+Xe[xr(2,2)],n=-.5*(n/o+a/l),Xe[xr(1,0)]+=Xe[xr(2,0)]*n,Xe[xr(1,1)]+=Xe[xr(2,1)]*n,Xe[xr(1,2)]+=Xe[xr(2,2)]*n,n=ms(Dc(Xe,1),e)+Xe[xr(1,2)],o=ms(Dc(Xe,2),e)+Xe[xr(2,2)],a=-o/n,Xe[xr(1,0)]*=a,Xe[xr(1,1)]*=a,Xe[xr(1,2)]*=a,s[0]=Xe[0],s[1]=Xe[1],s[2]=0,s[3]=Xe[2],s[4]=Xe[3],s[5]=Xe[4],s[6]=0,s[7]=Xe[5],s[8]=0,s[9]=0,s[10]=1,s[11]=0,s[12]=Xe[6],s[13]=Xe[7],s[14]=0,s[15]=Xe[8]}function Xbt(t,e,r,i,s){const n=1/gd[0][3],o=1/gd[4][3];it(n<o);let a=n+Math.sqrt(n*o);const l=Math.sin(oo(t[2]*e[0]+t[6]*e[1]+t[10]*e[2]));a/=l,Wbt(gd,a,l,Lpe,Dpe,qbt,Npe,Fpe),Zbt(Lpe,Dpe,Npe,Fpe,s.projectionMatrix),s.projectionMatrix[10]=2/(r-i),s.projectionMatrix[14]=-(r+i)/(r-i)}function Ybt(t){return Bf(t)&&t.intersector===ls.TERRAIN&&!!t.target}let Jbt=class extends y8{constructor(e,r,i){super(e,r),this.triangleNr=i}};function K$e(t){return Bf(t)&&t.intersector===ls.OVERLAY&&!!t.target}let FY=class{constructor(){this.adds=new qt,this.removes=new qt,this.updates=new qt({allocator:e=>e||new Qbt,deallocator:e=>(e.renderGeometry=null,e)})}clear(){this.adds.clear(),this.removes.clear(),this.updates.clear()}prune(){this.adds.prune(),this.removes.prune(),this.updates.prune()}get empty(){return this.adds.length===0&&this.removes.length===0&&this.updates.length===0}},Qbt=class{},Kbt=class{constructor(){this.adds=new Array,this.removes=new Array,this.updates=new Array}};var ps,eo;(function(t){t[t.ADD=0]="ADD",t[t.UPDATE=1]="UPDATE",t[t.REMOVE=2]="REMOVE"})(ps||(ps={})),function(t){t[t.NONE=0]="NONE",t[t.VISIBILITY=1]="VISIBILITY",t[t.GEOMETRY=2]="GEOMETRY",t[t.TRANSFORMATION=4]="TRANSFORMATION",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.OCCLUDEE=16]="OCCLUDEE"}(eo||(eo={}));function eLe(t){const e=new Map,r=i=>{let s=e.get(i);return s||(s=new Kbt,e.set(i,s)),s};return t.removes.forAll(i=>{fG(i)&&r(i.material).removes.push(i)}),t.adds.forAll(i=>{fG(i)&&r(i.material).adds.push(i)}),t.updates.forAll(i=>{fG(i.renderGeometry)&&r(i.renderGeometry.material).updates.push(i)}),e}function fG(t){return t.geometry.indexCount>=1}let tLe=class{constructor(e,r){this._material=e,this._repository=r,this._map=new Map}destroy(){this._map.forEach((e,r)=>{e!=null&&this._repository.release(this._material,r)})}load(e,r,i){if(!this._material.requiresSlot(r,i))return null;this._map.has(i)||this._map.set(i,this._repository.acquire(this._material,r,i));const s=this._map.get(i);if(s!=null){if(s.ensureResources(e)===f0.LOADED)return s;this._repository.requestRender()}return null}};function V$(t,e){switch(e.normalType){case Fr.Compressed:t.attributes.add(E.NORMALCOMPRESSED,"vec2"),t.vertex.code.add(w`vec3 normalModel() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
return vec3(normalCompressed + sign(normalCompressed) * min(z, 0.0), z);
}`);break;case Fr.Attribute:t.attributes.add(E.NORMAL,"vec3"),t.vertex.code.add(w`vec3 normalModel() {
return normal;
}`);break;case Fr.ScreenDerivative:t.fragment.code.add(w`vec3 screenDerivativeNormal(vec3 positionView) {
return normalize(cross(dFdx(positionView), dFdy(positionView)));
}`);break;default:e.normalType;case Fr.COUNT:case Fr.Ground:}}var Fr;(function(t){t[t.Attribute=0]="Attribute",t[t.Compressed=1]="Compressed",t[t.Ground=2]="Ground",t[t.ScreenDerivative=3]="ScreenDerivative",t[t.COUNT=4]="COUNT"})(Fr||(Fr={}));function B8(t,e){switch(e.normalType){case Fr.Attribute:case Fr.Compressed:t.include(V$,e),t.varyings.add("vNormalWorld","vec3"),t.varyings.add("vNormalView","vec3"),t.vertex.uniforms.add(new pP("transformNormalGlobalFromModel",r=>r.transformNormalGlobalFromModel),new tp("transformNormalViewFromGlobal",r=>r.transformNormalViewFromGlobal)),t.vertex.code.add(w`void forwardNormal() {
vNormalWorld = transformNormalGlobalFromModel * normalModel();
vNormalView = transformNormalViewFromGlobal * vNormalWorld;
}`);break;case Fr.Ground:t.include(NC,e),t.varyings.add("vNormalWorld","vec3"),t.vertex.code.add(w`
        void forwardNormal() {
          vNormalWorld = ${e.spherical?w`normalize(vPositionWorldCameraRelative);`:w`vec3(0.0, 0.0, 1.0);`}
        }
        `);break;case Fr.ScreenDerivative:t.vertex.code.add(w`void forwardNormal() {}`);break;default:e.normalType;case Fr.COUNT:}}let rLe=class extends k3e{constructor(){super(...arguments),this.transformNormalViewFromGlobal=ts()}},iLe=class extends U3e{constructor(){super(...arguments),this.transformNormalGlobalFromModel=ts(),this.toMapSpace=Qt()}},kY=class extends iLe{constructor(e=C()){super(),this.origin=e,this.slicePlaneLocalOrigin=this.origin}},IO=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.indices.get(E.POSITION).length}write(e,r,i,s,n){iPe(i,this.vertexBufferLayout,e,r,s,n)}};const ewt=us().vec3f(E.POSITION),twt=us().vec3f(E.POSITION).vec2f(E.UV0),rwt=us().vec3f(E.POSITION).vec4u8(E.COLOR);us().vec3f(E.POSITION).vec4u8(E.OBJECTANDLAYERIDCOLOR);const iwt=us().vec3f(E.POSITION).vec2f(E.UV0).vec4u8(E.OBJECTANDLAYERIDCOLOR);us().vec3f(E.POSITION).vec4u8(E.COLOR).vec4u8(E.OBJECTANDLAYERIDCOLOR);let lie=class extends mb{intersect(e,r,i,s,n,o){return HIe(e,i,s,n,void 0,o)}};function swt(t){t.fragment.code.add(w`float normals2FoamIntensity(vec3 n, float waveStrength){
float normalizationFactor =  max(0.015, waveStrength);
return max((n.x + n.y)*0.3303545/normalizationFactor + 0.3303545, 0.0);
}`)}function nwt(t){t.fragment.code.add(w`vec3 foamIntensity2FoamColor(float foamIntensityExternal, float foamPixelIntensity, vec3 skyZenitColor, float dayMod){
return foamIntensityExternal * (0.075 * skyZenitColor * pow(foamPixelIntensity, 4.) +  50.* pow(foamPixelIntensity, 23.0)) * dayMod;
}`)}let z$=class extends Ps{constructor(e,r){super(e,"int",ai.Pass,(i,s,n)=>i.setUniform1i(e,r(s,n)))}},owt=class extends Ps{constructor(e,r,i){super(e,"mat4",ai.Draw,(s,n,o,a)=>s.setUniformMatrix4fv(e,r(n,o,a)),i)}},awt=class extends Ps{constructor(e,r,i){super(e,"mat4",ai.Pass,(s,n,o)=>s.setUniformMatrix4fv(e,r(n,o)),i)}},lwt=class extends ui{constructor(){super(...arguments),this.origin=C()}},cwt=class extends lwt{},uwt=class extends ui{constructor(){super(...arguments),this.modelTransformation=Un}},cie=class extends uwt{constructor(){super(...arguments),this.origin=C()}};function G8(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new awt("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),sLe(t))}function XT(t,e){e.receiveShadows&&(t.fragment.uniforms.add(new owt("shadowMapMatrix",(r,i)=>i.shadowMap.getShadowMapMatrices(r.origin),4)),sLe(t))}function sLe(t){const e=t.fragment;e.include(Pu),e.uniforms.add(new et("shadowMapTex",(r,i)=>i.shadowMap.depthTexture),new z$("numCascades",(r,i)=>i.shadowMap.numCascades),new cr("cascadeDistances",(r,i)=>i.shadowMap.cascadeDistances)),e.code.add(w`int chooseCascade(float depth, out mat4 mat) {
vec4 distance = cascadeDistances;
int i = depth < distance[1] ? 0 : depth < distance[2] ? 1 : depth < distance[3] ? 2 : 3;
mat = i == 0 ? shadowMapMatrix[0] : i == 1 ? shadowMapMatrix[1] : i == 2 ? shadowMapMatrix[2] : shadowMapMatrix[3];
return i;
}
vec3 lightSpacePosition(vec3 _vpos, mat4 mat) {
vec4 lv = mat * vec4(_vpos, 1.0);
lv.xy /= lv.w;
return 0.5 * lv.xyz + vec3(0.5);
}
vec2 cascadeCoordinates(int i, vec3 lvpos) {
return vec2(float(i - 2 * (i / 2)) * 0.5, float(i / 2) * 0.5) + (numCascades == 1 ? 1.0 : 0.5) * lvpos.xy;
}
float readShadowMapDepth(vec2 uv, sampler2D _depthTex) {
return rgba2float(texture(_depthTex, uv));
}
float posIsInShadow(vec2 uv, vec3 lvpos, sampler2D _depthTex) {
return readShadowMapDepth(uv, _depthTex) < lvpos.z ? 1.0 : 0.0;
}
float filterShadow(vec2 uv, vec3 lvpos, float texSize, sampler2D _depthTex) {
float halfPixelSize = 0.5 / texSize;
vec2 st = fract((vec2(halfPixelSize) + uv) * texSize);
float s00 = posIsInShadow(uv + vec2(-halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s10 = posIsInShadow(uv + vec2(halfPixelSize, -halfPixelSize), lvpos, _depthTex);
float s11 = posIsInShadow(uv + vec2(halfPixelSize, halfPixelSize), lvpos, _depthTex);
float s01 = posIsInShadow(uv + vec2(-halfPixelSize, halfPixelSize), lvpos, _depthTex);
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float readShadowMap(const in vec3 _vpos, float _linearDepth) {
mat4 mat;
int i = chooseCascade(_linearDepth, mat);
if (i >= numCascades) { return 0.0; }
vec3 lvpos = lightSpacePosition(_vpos, mat);
if (lvpos.z >= 1.0) { return 0.0; }
if (lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) { return 0.0; }
vec2 uv = cascadeCoordinates(i, lvpos);
return filterShadow(uv, lvpos, float(textureSize(shadowMapTex, 0).x), shadowMapTex);
}`)}function zpe(t){t.fragment.uniforms.add(new et("texWaveNormal",e=>e.waveNormal),new et("texWavePerturbation",e=>e.wavePertubation),new cr("waveParams",e=>zi(hwt,e.waveStrength,e.waveTextureRepeat,e.flowStrength,e.flowOffset)),new Pr("waveDirection",e=>hr(dwt,e.waveDirection[0]*e.waveVelocity,e.waveDirection[1]*e.waveVelocity))),t.include(swt),t.fragment.code.add(w`const vec2  FLOW_JUMP = vec2(6.0/25.0, 5.0/24.0);
vec2 textureDenormalized2D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rg - 1.0;
}
float sampleNoiseTexture(vec2 _uv) {
return texture(texWavePerturbation, _uv).b;
}
vec3 textureDenormalized3D(sampler2D _tex, vec2 _uv) {
return 2.0 * texture(_tex, _uv).rgb - 1.0;
}
float computeProgress(vec2 uv, float time) {
return fract(time);
}
float computeWeight(vec2 uv, float time) {
float progress = computeProgress(uv, time);
return 1.0 - abs(1.0 - 2.0 * progress);
}
vec3 computeUVPerturbedWeigth(sampler2D texFlow, vec2 uv, float time, float phaseOffset) {
float flowStrength = waveParams[2];
float flowOffset = waveParams[3];
vec2 flowVector = textureDenormalized2D(texFlow, uv) * flowStrength;
float progress = computeProgress(uv, time + phaseOffset);
float weight = computeWeight(uv, time + phaseOffset);
vec2 result = uv;
result -= flowVector * (progress + flowOffset);
result += phaseOffset;
result += (time - progress) * FLOW_JUMP;
return vec3(result, weight);
}
const float TIME_NOISE_TEXTURE_REPEAT = 0.3737;
const float TIME_NOISE_STRENGTH = 7.77;
vec3 getWaveLayer(sampler2D _texNormal, sampler2D _dudv, vec2 _uv, vec2 _waveDir, float time) {
float waveStrength = waveParams[0];
vec2 waveMovement = time * -_waveDir;
float timeNoise = sampleNoiseTexture(_uv * TIME_NOISE_TEXTURE_REPEAT) * TIME_NOISE_STRENGTH;
vec3 uv_A = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.0);
vec3 uv_B = computeUVPerturbedWeigth(_dudv, _uv + waveMovement, time + timeNoise, 0.5);
vec3 normal_A = textureDenormalized3D(_texNormal, uv_A.xy) * uv_A.z;
vec3 normal_B = textureDenormalized3D(_texNormal, uv_B.xy) * uv_B.z;
vec3 mixNormal = normalize(normal_A + normal_B);
mixNormal.xy *= waveStrength;
mixNormal.z = sqrt(1.0 - dot(mixNormal.xy, mixNormal.xy));
return mixNormal;
}
vec4 getSurfaceNormalAndFoam(vec2 _uv, float _time) {
float waveTextureRepeat = waveParams[1];
vec3 normal = getWaveLayer(texWaveNormal, texWavePerturbation, _uv * waveTextureRepeat, waveDirection, _time);
float foam  = normals2FoamIntensity(normal, waveParams[0]);
return vec4(normal, foam);
}`)}const hwt=Qt(),dwt=Pe();function AP(t,e){e.spherical?t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return normalize(pos + origin);
}`):t.vertex.code.add(w`vec3 getLocalUp(in vec3 pos, in vec3 origin) {
return vec3(0.0, 0.0, 1.0);
}`),e.spherical?t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = normalize(cross(vec3(0.0, 0.0, 1.0), n));
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`):t.vertex.code.add(w`mat3 getTBNMatrix(in vec3 n) {
vec3 t = vec3(1.0, 0.0, 0.0);
vec3 b = normalize(cross(n, t));
return mat3(t, b, n);
}`)}function pwt(t){const e=t.fragment.code;e.add(w`vec3 evaluateDiffuseIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float NdotNG)
{
return ((1.0 - NdotNG) * ambientGround + (1.0 + NdotNG) * ambientSky) * 0.5;
}`),e.add(w`float integratedRadiance(float cosTheta2, float roughness)
{
return (cosTheta2 - 1.0) / (cosTheta2 * (1.0 - roughness * roughness) - 1.0);
}`),e.add(w`vec3 evaluateSpecularIlluminationHemisphere(vec3 ambientGround, vec3 ambientSky, float RdotNG, float roughness)
{
float cosTheta2 = 1.0 - RdotNG * RdotNG;
float intRadTheta = integratedRadiance(cosTheta2, roughness);
float ground = RdotNG < 0.0 ? 1.0 - intRadTheta : 1.0 + intRadTheta;
float sky = 2.0 - ground;
return (ground * ambientGround + sky * ambientSky) * 0.5;
}`)}function uie(t,e){const r=t.fragment.code;t.include(S$),e.pbrMode!==lt.Normal&&e.pbrMode!==lt.Schematic&&e.pbrMode!==lt.Terrain&&e.pbrMode!==lt.TerrainWithWater||(r.add(w`float normalDistribution(float NdotH, float roughness)
{
float a = NdotH * roughness;
float b = roughness / (1.0 - NdotH * NdotH + a * a);
return b * b * INV_PI;
}`),r.add(w`const vec4 c0 = vec4(-1.0, -0.0275, -0.572,  0.022);
const vec4 c1 = vec4( 1.0,  0.0425,  1.040, -0.040);
const vec2 c2 = vec2(-1.04, 1.04);
vec2 prefilteredDFGAnalytical(float roughness, float NdotV) {
vec4 r = roughness * c0 + c1;
float a004 = min(r.x * r.x, exp2(-9.28 * NdotV)) * r.x + r.y;
return c2 * a004 + r.zw;
}`)),e.pbrMode!==lt.Normal&&e.pbrMode!==lt.Schematic||(t.include(pwt),r.add(w`struct PBRShadingInfo
{
float NdotL;
float NdotV;
float NdotH;
float VdotH;
float LdotH;
float NdotNG;
float RdotNG;
float NdotAmbDir;
float NdotH_Horizon;
vec3 skyRadianceToSurface;
vec3 groundRadianceToSurface;
vec3 skyIrradianceToSurface;
vec3 groundIrradianceToSurface;
float averageAmbientRadiance;
float ssao;
vec3 albedoLinear;
vec3 f0;
vec3 f90;
vec3 diffuseColor;
float metalness;
float roughness;
};`),r.add(w`vec3 evaluateEnvironmentIllumination(PBRShadingInfo inputs) {
vec3 indirectDiffuse = evaluateDiffuseIlluminationHemisphere(inputs.groundIrradianceToSurface, inputs.skyIrradianceToSurface, inputs.NdotNG);
vec3 indirectSpecular = evaluateSpecularIlluminationHemisphere(inputs.groundRadianceToSurface, inputs.skyRadianceToSurface, inputs.RdotNG, inputs.roughness);
vec3 diffuseComponent = inputs.diffuseColor * indirectDiffuse * INV_PI;
vec2 dfg = prefilteredDFGAnalytical(inputs.roughness, inputs.NdotV);
vec3 specularColor = inputs.f0 * dfg.x + inputs.f90 * dfg.y;
vec3 specularComponent = specularColor * indirectSpecular;
return (diffuseComponent + specularComponent);
}`),r.add(w`float gamutMapChanel(float x, vec2 p){
return (x < p.x) ? mix(0.0, p.y, x/p.x) : mix(p.y, 1.0, (x - p.x) / (1.0 - p.x) );
}`),r.add(w`vec3 blackLevelSoftCompression(vec3 inColor, PBRShadingInfo inputs){
vec3 outColor;
vec2 p = vec2(0.02 * (inputs.averageAmbientRadiance), 0.0075 * (inputs.averageAmbientRadiance));
outColor.x = gamutMapChanel(inColor.x, p) ;
outColor.y = gamutMapChanel(inColor.y, p) ;
outColor.z = gamutMapChanel(inColor.z, p) ;
return outColor;
}`))}function fwt(t,e){const r=t.fragment.code;t.include(S$),r.add(w`
  struct PBRShadingWater
  {
      float NdotL;   // cos angle between normal and light direction
      float NdotV;   // cos angle between normal and view direction
      float NdotH;   // cos angle between normal and half vector
      float VdotH;   // cos angle between view direction and half vector
      float LdotH;   // cos angle between light direction and half vector
      float VdotN;   // cos angle between view direction and normal vector
  };

  float dtrExponent = ${e.useCustomDTRExponentForWater?"2.2":"2.0"};
  `),r.add(w`vec3 fresnelReflection(float angle, vec3 f0, float f90) {
return f0 + (f90 - f0) * pow(1.0 - angle, 5.0);
}`),r.add(w`float normalDistributionWater(float NdotH, float roughness)
{
float r2 = roughness * roughness;
float NdotH2 = NdotH * NdotH;
float denom = pow((NdotH2 * (r2 - 1.0) + 1.0), dtrExponent) * PI;
return r2 / denom;
}`),r.add(w`float geometricOcclusionKelemen(float LoH)
{
return 0.25 / (LoH * LoH);
}`),r.add(w`vec3 brdfSpecularWater(in PBRShadingWater props, float roughness, vec3 F0, float F0Max)
{
vec3  F = fresnelReflection(props.VdotH, F0, F0Max);
float dSun = normalDistributionWater(props.NdotH, roughness);
float V = geometricOcclusionKelemen(props.LdotH);
float diffusionSunHaze = mix(roughness + 0.045, roughness + 0.385, 1.0 - props.VdotH);
float strengthSunHaze  = 1.2;
float dSunHaze = normalDistributionWater(props.NdotH, diffusionSunHaze)*strengthSunHaze;
return ((dSun + dSunHaze) * V) * F;
}
vec3 tonemapACES(const vec3 x) {
return (x * (2.51 * x + 0.03)) / (x * (2.43 * x + 0.59) + 0.14);
}`)}function nLe(t,e){t.include(fwt,e),t.include(s8),t.include(nwt),e.hasCloudsReflections&&t.include(p3e,e),e.hasScreenSpaceReflections&&t.include(edt,e);const r=t.fragment;r.constants.add("fresnelSky","vec3",[.02,1,15]).add("fresnelMaterial","vec2",[.02,.1]).add("roughness","float",.015).add("foamIntensityExternal","float",1.7).add("ssrIntensity","float",.65).add("ssrHeightFadeStart","float",3e5).add("ssrHeightFadeEnd","float",5e5).add("waterDiffusion","float",.92).add("waterSeaColorMod","float",.8).add("correctionViewingPowerFactor","float",.4).add("skyZenitColor","vec3",[.52,.68,.9]).add("skyColor","vec3",[.67,.79,.9]).add("cloudFresnelModifier","vec2",[1.2,.01]),r.code.add(w`PBRShadingWater shadingInfo;
vec3 getSkyGradientColor(in float cosTheta, in vec3 horizon, in vec3 zenit) {
float exponent = pow((1.0 - cosTheta), fresnelSky[2]);
return mix(zenit, horizon, exponent);
}`),r.uniforms.add(new Ie("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Ie("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)),r.code.add(w`vec3 getSeaColor(in vec3 n, in vec3 v, in vec3 l, vec3 color, in vec3 lightIntensity, in vec3 localUp, in float shadow, float foamIntensity, vec3 viewPosition, vec3 position) {
float reflectionHit = 0.0;
float reflectionHitDiffused = 0.0;
vec3 seaWaterColor = linearizeGamma(color);
vec3 h = normalize(l + v);
shadingInfo.NdotL = clamp(dot(n, l), 0.0, 1.0);
shadingInfo.NdotV = clamp(dot(n, v), 0.001, 1.0);
shadingInfo.VdotN = clamp(dot(v, n), 0.001, 1.0);
shadingInfo.NdotH = clamp(dot(n, h), 0.0, 1.0);
shadingInfo.VdotH = clamp(dot(v, h), 0.0, 1.0);
shadingInfo.LdotH = clamp(dot(l, h), 0.0, 1.0);
float upDotV = max(dot(localUp,v), 0.0);
vec3 skyHorizon = linearizeGamma(skyColor);
vec3 skyZenit = linearizeGamma(skyZenitColor);
vec3 skyColor = getSkyGradientColor(upDotV, skyHorizon, skyZenit );
float upDotL = max(dot(localUp,l),0.0);
float daytimeMod = 0.1 + upDotL * 0.9;
skyColor *= daytimeMod;
float shadowModifier = clamp(shadow, 0.8, 1.0);
vec3 fresnelModifier = fresnelReflection(shadingInfo.VdotN, vec3(fresnelSky[0]), fresnelSky[1]);
vec3 reflSky = lightingEnvironmentStrength * fresnelModifier * skyColor * shadowModifier;
vec3 reflSea = seaWaterColor * mix(skyColor, upDotL * lightIntensity * LIGHT_NORMALIZATION, 2.0 / 3.0) * shadowModifier;
vec3 specular = vec3(0.0);
if(upDotV > 0.0 && upDotL > 0.0) {
vec3 specularSun = brdfSpecularWater(shadingInfo, roughness, vec3(fresnelMaterial[0]), fresnelMaterial[1]);
vec3 incidentLight = lightIntensity * LIGHT_NORMALIZATION * shadow;
specular = lightingSpecularStrength * shadingInfo.NdotL * incidentLight * specularSun;
}
vec3 foam = vec3(0.0);
if(upDotV > 0.0) {
foam = foamIntensity2FoamColor(foamIntensityExternal, foamIntensity, skyZenitColor, daytimeMod);
}
float correctionViewingFactor = pow(max(dot(v, localUp), 0.0), correctionViewingPowerFactor);
vec3 normalCorrectedClouds = mix(localUp, n, correctionViewingFactor);
vec3 reflectedWorld = normalize(reflect(-v, normalCorrectedClouds));`),e.hasCloudsReflections&&r.code.add(w`vec4 cloudsColor = renderClouds(reflectedWorld, position);
cloudsColor.a = 1.0 - cloudsColor.a;
cloudsColor = pow(cloudsColor, vec4(GAMMA));
cloudsColor *= clamp(fresnelModifier.y * cloudFresnelModifier[0] - cloudFresnelModifier[1], 0.0, 1.0) * clamp((1.0 - totalFadeInOut), 0.0, 1.0);`),e.hasScreenSpaceReflections?(r.uniforms.add(new es("view",(i,s)=>s.ssr.camera.viewMatrix),new et("lastFrameColorTexture",(i,s)=>s.ssr.lastFrameColorTexture),new Ie("fadeFactorSSR",(i,s)=>s.ssr.fadeFactor)),r.code.add(w`vec3 viewDir = normalize(viewPosition);
vec4 viewNormalVectorCoordinate = view *vec4(n, 0.0);
vec3 viewNormal = normalize(viewNormalVectorCoordinate.xyz);
vec4 viewUp = view * vec4(localUp, 0.0);
vec3 viewNormalCorrectedSSR = mix(viewUp.xyz, viewNormal, correctionViewingFactor);
vec3 reflected = normalize(reflect(viewDir, viewNormalCorrectedSSR));
vec3 hitCoordinate = screenSpaceIntersection(reflected, viewPosition, viewDir, viewUp.xyz);
vec3 reflectedColor = vec3(0.0);
if (hitCoordinate.z > 0.0)
{
vec2 reprojectedCoordinate = reprojectionCoordinate(hitCoordinate);
vec2 dCoords = smoothstep(0.3, 0.6, abs(vec2(0.5, 0.5) - hitCoordinate.xy));
float heightMod = smoothstep(ssrHeightFadeEnd, ssrHeightFadeStart, -viewPosition.z);
reflectionHit = clamp(1.0 - (1.3 * dCoords.y), 0.0, 1.0) * heightMod * fadeFactorSSR;
reflectionHitDiffused = waterDiffusion * reflectionHit;
reflectedColor = linearizeGamma(texture(lastFrameColorTexture, reprojectedCoordinate).xyz) *
reflectionHitDiffused * fresnelModifier.y * ssrIntensity;
}
float seaColorMod =  mix(waterSeaColorMod, waterSeaColorMod * 0.5, reflectionHitDiffused);
vec3 waterRenderedColor = tonemapACES((1.0 - reflectionHitDiffused) * reflSky + reflectedColor +
reflSea * seaColorMod + specular + foam);`)):r.code.add(w`vec3 waterRenderedColor = tonemapACES(reflSky + reflSea * waterSeaColorMod + specular + foam);`),e.hasCloudsReflections?e.hasScreenSpaceReflections?r.code.add(w`return waterRenderedColor * (1.0 - (1.0 - reflectionHit) * cloudsColor.a) + (1.0 - reflectionHit) * cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor * (1.0 - cloudsColor.a) + cloudsColor.xyz;
}`):r.code.add(w`return waterRenderedColor;
}`)}function mwt(t){const e=new Cr,{vertex:r,fragment:i}=e;Eu(r,t),e.include(_c,t),e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.UV0,"vec2");const s=new cr("waterColor",n=>n.color);if(t.output===k.Color&&t.isDraped)return e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(ia)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vpos = position;
          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(s),i.code.add(w`void main() {
fragColor = waterColor;
}`),e;switch(t.output!==k.Color&&t.output!==k.Alpha||(e.include(AP,t),e.include(TO,t),e.varyings.add("vuv","vec2"),e.varyings.add("vpos","vec3"),e.varyings.add("vnormal","vec3"),e.varyings.add("vtbnMatrix","mat3"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(ia)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vuv = uv0;
        vpos = position;

        vnormal = getLocalUp(vpos, localOrigin);
        vtbnMatrix = getTBNMatrix(vnormal);

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}

        gl_Position = transformPosition(proj, view, vpos);
        ${t.output===k.Color?"forwardLinearDepth();":""}
      }
    `)),e.include(Ah,t),t.output){case k.Alpha:e.include(Bs,t),i.uniforms.add(s),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          fragColor = vec4(waterColor.a);
        }
      `);break;case k.Color:e.include(dU),e.include(Gte,{pbrMode:lt.Disabled,lightingSphericalHarmonicsOrder:2}),e.include(zpe),e.include(Bs,t),e.include(XT,t),e.include(nLe,t),i.uniforms.add(s,new Ie("timeElapsed",n=>n.timeElapsed),r.uniforms.get("view"),r.uniforms.get("localOrigin")),kf(i,t),i.include(kg),G0(i),Fg(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        vec3 localUp = vnormal;
        // the created normal is in tangent space
        vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);

        // we rotate the normal according to the tangent-bitangent-normal-Matrix
        vec3 n = normalize(vtbnMatrix * tangentNormalFoam.xyz);
        vec3 v = -normalize(vpos - cameraPosition);
        float shadow = ${t.receiveShadows?w`1.0 - readShadowMap(vpos, linearDepth)`:"1.0"};
        vec4 vPosView = view * vec4(vpos, 1.0);
        vec4 final = vec4(getSeaColor(n, v, mainLightDirection, waterColor.rgb, mainLightIntensity, localUp, shadow, tangentNormalFoam.w, vPosView.xyz, vpos + localOrigin), waterColor.w);

        // gamma correction
        fragColor = delinearizeGamma(final);
        fragColor = highlightSlice(fragColor, vpos);
        ${t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `);break;case k.Normal:e.include(AP,t),e.include(zpe,t),e.include(Bs,t),e.varyings.add("vpos","vec3"),e.varyings.add("vuv","vec2"),r.uniforms.add(s),r.code.add(w`
        void main(void) {
          if (waterColor.a < ${w.float(ia)}) {
            // Discard this vertex
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
            return;
          }

          vuv = uv0;
          vpos = position;

          gl_Position = transformPosition(proj, view, vpos);
        }
    `),i.uniforms.add(new Ie("timeElapsed",n=>n.timeElapsed)),i.code.add(w`void main() {
discardBySlice(vpos);
vec4 tangentNormalFoam = getSurfaceNormalAndFoam(vuv, timeElapsed);
tangentNormalFoam.xyz = normalize(tangentNormalFoam.xyz);
fragColor = vec4((tangentNormalFoam.xyz + vec3(1.0)) * 0.5, tangentNormalFoam.w);
}`);break;case k.Highlight:e.include(J0,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(ia)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
      }
    `),e.include(Bs,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`);break;case k.ObjectAndLayerIdColor:e.include($$,t),e.varyings.add("vpos","vec3"),r.uniforms.add(s),r.code.add(w`
      void main(void) {
        if (waterColor.a < ${w.float(ia)}) {
          // Discard this vertex
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          return;
        }

        vpos = position;
        gl_Position = transformPosition(proj, view, vpos);
        forwardObjectAndLayerIdColor();
      }
    `),e.include(Bs,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputObjectAndLayerIdColor();
}`)}return e}const gwt=Object.freeze(Object.defineProperty({__proto__:null,build:mwt},Symbol.toStringTag,{value:"Module"}));let oLe=class aLe extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Lr(e.rctx,aLe.shader.get().build(this.configuration),Er)}_setPipelineState(e){const r=this.configuration,i=e===ut.NONE,s=e===ut.FrontFace;return It({blending:r.output!==k.Normal&&r.output!==k.Highlight&&r.output!==k.ObjectAndLayerIdColor&&r.transparent?i?vh:Q0(e):null,depthTest:{func:gb(e)},depthWrite:i?r.writeDepth?Ac:null:I8(e),colorWrite:Wt,polygonOffset:i||s?null:L8(r.enableOffset)})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};oLe.shader=new $r(gwt,()=>J(()=>import("./WaterSurface.glsl-8739fc15.js"),[],import.meta.url));let vo=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.transparencyPassType=ut.NONE,this.spherical=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.transparent=!1,this.enableOffset=!0,this.writeDepth=!1,this.hasScreenSpaceReflections=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasCloudsReflections=!1,this.objectAndLayerIdColorInstanced=!1,this.isDraped=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1}};u([B({count:k.COUNT})],vo.prototype,"output",void 0),u([B({count:ut.COUNT})],vo.prototype,"transparencyPassType",void 0),u([B()],vo.prototype,"spherical",void 0),u([B()],vo.prototype,"receiveShadows",void 0),u([B()],vo.prototype,"hasSlicePlane",void 0),u([B()],vo.prototype,"transparent",void 0),u([B()],vo.prototype,"enableOffset",void 0),u([B()],vo.prototype,"writeDepth",void 0),u([B()],vo.prototype,"hasScreenSpaceReflections",void 0),u([B()],vo.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B()],vo.prototype,"hasCloudsReflections",void 0),u([B()],vo.prototype,"objectAndLayerIdColorInstanced",void 0),u([B()],vo.prototype,"isDraped",void 0),u([B()],vo.prototype,"hasMultipassTerrain",void 0),u([B()],vo.prototype,"cullAboveGround",void 0),u([B({constValue:lt.Water})],vo.prototype,"pbrMode",void 0),u([B({constValue:!0})],vo.prototype,"useCustomDTRExponentForWater",void 0),u([B({constValue:!0})],vo.prototype,"highStepCount",void 0),u([B({constValue:!1})],vo.prototype,"useFillLights",void 0);let ywt=class extends pb{_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.receiveShadows&&this._material.setParameters({receiveShadows:e.shadowMap.enabled})}_updateSSRState(e){e.ssr.enabled!==this._material.parameters.hasScreenSpaceReflections&&this._material.setParameters({hasScreenSpaceReflections:e.ssr.enabled})}_updateCloudsReflectionState(e){const r=e.cloudsFade.data!=null;r!==this._material.parameters.hasCloudsReflections&&this._material.setParameters({hasCloudsReflections:r})}ensureResources(e){return this._techniqueRepository.constructionContext.waterTextureRepository.ensureResources(e)}beginSlot(e){return this._output===k.Color&&(this._updateShadowState(e),this._updateSSRState(e),this._updateCloudsReflectionState(e)),this._material.setParameters(this._techniqueRepository.constructionContext.waterTextureRepository.passParameters),this.ensureTechnique(oLe,e)}},lLe=class extends lie{constructor(e){super(e,new cLe),this._configuration=new vo,this.animation=new pMe}getConfiguration(e,r){return this._configuration.output=e,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasScreenSpaceReflections=this.parameters.hasScreenSpaceReflections,this._configuration.hasCloudsReflections=this.parameters.hasCloudsReflections,this._configuration.isDraped=this.parameters.isDraped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<P8,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}update(e){const r=Math.min(e.camera.relativeElevation,e.camera.distance);this.animation.enabled=Math.sqrt(this.parameters.waveTextureRepeat/this.parameters.waveStrength)*r<_wt;const i=this.animation.advance(e);return this.setParameters({timeElapsed:nQ(this.animation.time)*this.parameters.animationSpeed},!1),this.animation.enabled&&i}requiresSlot(e,r){switch(r){case k.Normal:return e===fe.DRAPED_WATER;case k.Color:if(this.parameters.isDraped)return e===fe.DRAPED_MATERIAL;break;case k.Alpha:break;case k.Highlight:case k.ObjectAndLayerIdColor:return e===fe.OPAQUE_MATERIAL||e===fe.DRAPED_MATERIAL;default:return!1}let i=fe.OPAQUE_MATERIAL;return this.parameters.transparent&&(i=this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),e===i}createGLMaterial(e){return new ywt(e)}createBufferWriter(){return new IO(le("enable-feature:objectAndLayerId-rendering")?iwt:twt)}},cLe=class extends Dre{constructor(){super(...arguments),this.waveStrength=.06,this.waveTextureRepeat=32,this.waveDirection=yr(1,0),this.waveVelocity=.05,this.flowStrength=.015,this.flowOffset=-.5,this.animationSpeed=.35,this.timeElapsed=0,this.color=Vt(0,0,0,0),this.transparent=!0,this.writeDepth=!0,this.hasSlicePlane=!1,this.isDraped=!1,this.receiveShadows=!0,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.origin=C(),this.modelTransformation=null}};const _wt=35e3;let hie=class{constructor(e=0,r=0){this.from=e,this.to=r}get numElements(){return this.to-this.from}};function Bpe(t){const e=new Map;t.forAll(i=>e.set(i.from,i));let r=!0;for(;r;)r=!1,t.forEach(i=>{const s=e.get(i.to);s&&(i.to=s.to,e.delete(s.from),t.removeUnordered(s),r=!0)})}let Gpe=class extends hie{constructor(e,r,i){super(r,i),this.geometry=e}get isVisible(){return this.geometry.visible}get hasHighlights(){return this.geometry.highlights!=null&&this.isVisible}get hasOccludees(){return this.geometry.occludees!=null}},vwt=class{constructor(){this.first=0,this.count=0}},bwt=class{constructor(){this._numElements=0,this._instances=new Map,this.holes=new qt({allocator:e=>e||new hie,deallocator:null}),this.hasHiddenInstances=!1,this.hasHighlights=!1,this.hasOccludees=!1,this.drawCommandsDirty=!0,this.drawCommandsDefault=gN(),this.drawCommandsHighlight=gN(),this.drawCommandsOccludees=gN(),this.drawCommandsShadowHighlightRest=gN()}get numElements(){return this._numElements}get instances(){return this._instances}addInstance(e,r){this.deleteInstance(e),this._instances.set(e,r),this._numElements+=r.numElements}deleteInstance(e){const r=this._instances.get(e);r&&(this._numElements-=r.numElements,this._instances.delete(e))}updateInstance(e,r,i){const s=this._instances.get(e);s&&(this._numElements-=s.numElements,s.from=r,s.to=i,this._numElements+=s.numElements)}updateDrawState(e){e.isVisible?(e.hasHighlights&&(this.hasHighlights=!0),e.hasOccludees&&(this.hasOccludees=!0)):this.hasHiddenInstances=!0}updateDrawCommands(e){if(this.drawCommandsDefault.clear(),this.drawCommandsHighlight.clear(),this.drawCommandsOccludees.clear(),this.drawCommandsShadowHighlightRest.clear(),this.drawCommandsDirty=!1,this._instances.size===0)return;if(!this.needsMultipleCommands()){const i=this.drawCommandsDefault.pushNew(),s=this.holes.front();return this.vao!=null&&this.holes.length===1&&s.to===Math.floor(this.vao.byteSize/e)?(i.first=0,void(i.count=s.from)):(i.first=1/0,i.count=0,this._instances.forEach(n=>{i.first=Math.min(i.first,n.from),i.count=Math.max(i.count,n.to)}),void(i.count-=i.first))}const r=Array.from(this._instances.values()).sort((i,s)=>i.from===s.from?i.to-s.to:i.from-s.from);for(const i of r)i.isVisible&&(jpe(i.hasOccludees?this.drawCommandsOccludees:this.drawCommandsDefault,i),jpe(i.hasHighlights?this.drawCommandsHighlight:this.drawCommandsShadowHighlightRest,i))}needsMultipleCommands(){return this.hasOccludees||this.hasHighlights||this.hasHiddenInstances}};function wwt(t){return t.vao!=null}function gN(){return new qt({allocator:t=>t||new vwt,deallocator:t=>t})}function jpe(t,e){const r=t.back();if(r==null){const i=t.pushNew();return i.first=e.from,void(i.count=e.numElements)}if(xwt(r,e)){const i=e.from-r.first+e.numElements;r.count=i}else{const i=t.pushNew();i.first=e.from,i.count=e.numElements}}function xwt(t,e){return t.first+t.count>=e.from}let Twt=class{constructor(e){this.origin=e,this.buffers=new Array}dispose(){this.buffers.forEach(e=>e.vao.dispose()),this.buffers.length=0}findBuffer(e){return this.buffers.find(r=>r.instances.has(e))}};const Swt=c4+1;let Ewt=class{constructor(e,r,i){this._rctx=e,this._locations=r,this._layout=i,this._cache=e.newCache("VaoCache",Cwt)}dispose(){this._cache.destroy()}newVao(e){const r=e.toString(),i=this._cache.pop(r);if(i!=null){const n=i.pop();return i.length>0&&this._cache.put(r,i,e*i.length,Swt),n}const s=new zf(this._rctx,this._locations,{geometry:this._layout},{geometry:Gr.createVertex(this._rctx,Mr.STATIC_DRAW)});return s.vertexBuffers.geometry.setSize(e),s}deleteVao(e){if(e==null)return null;const r=e.byteSize,i=r.toString(),s=this._cache.pop(i);return s!=null?(s.push(e),this._cache.put(i,s,r*s.length,-1)):this._cache.put(i,[e],r,-1),null}};function Cwt(t,e){if(e===Wy.ALL)return void t.forEach(s=>s.dispose());const r=t.pop(),i=t.length*r.byteSize;return r.dispose(),i}let uLe=class{constructor(e,r,i){this._rctx=e,this._materialRepository=r,this.material=i,this._dataByOrigin=new Map,this._hasHighlights=!1,this._hasOccludees=!1,this._glMaterials=new tLe(this.material,this._materialRepository),this._bufferWriter=i.createBufferWriter(),this._vaoCache=new Ewt(e,i.vertexAttributeLocations,$u(this._bufferWriter.vertexBufferLayout))}dispose(){this._glMaterials.destroy(),this._dataByOrigin.forEach(e=>e.dispose()),this._dataByOrigin.clear(),this._vaoCache.dispose()}get isEmpty(){return this._dataByOrigin.size===0}get hasHighlights(){return this._hasHighlights}get hasOccludees(){return this._hasOccludees}get hasWater(){return!this.isEmpty&&this.material instanceof lLe}get rendersOccluded(){return!this.isEmpty&&this.material.renderOccluded!==Qi.Occlude}get numGeometries(){let e=0;return this._dataByOrigin.forEach(r=>e+=r.buffers.reduce((i,s)=>i+s.instances.size,0)),e}forEachGeometry(e){this._dataByOrigin.forEach(r=>r.buffers.forEach(i=>i.instances.forEach(s=>e(s.geometry))))}modify(e){this._updateGeometries(e.updates),this._addAndRemoveGeometries(e.adds,e.removes),this._updateDrawCommands()}_updateGeometries(e){const r=this._bufferWriter,i=r.vertexBufferLayout.stride/4;for(const s of e){const n=s.renderGeometry,o=this._dataByOrigin.get(n.localOrigin.id),a=o?.findBuffer(n.id);if(a==null)return;const l=a.instances.get(n.id);if(s.updateType&(eo.GEOMETRY|eo.TRANSFORMATION)){const c=bN(r.elementCount(l.geometry.geometry)*i),h=r.vertexBufferLayout.createView(c.buffer);this._writeGeometry(n,h,0),a.vao.vertexBuffers.geometry.setSubData(c,l.from*i,0,l.numElements*i),wN()}s.updateType&(eo.HIGHLIGHT|eo.OCCLUDEE|eo.VISIBILITY)&&(a.drawCommandsDirty=!0)}}_computeDeltas(e,r){const i=new EO;for(const s of e){const n=s.localOrigin;if(n==null)continue;let o=i.get(n.id,null);o==null&&(o=new Hpe(n.vec3),i.set(n.id,null,o)),o.changes.push(s)}for(const s of r){const n=s.localOrigin;if(n==null)continue;const o=this._dataByOrigin.get(n.id),a=o?.findBuffer(s.id);if(a==null)continue;let l=i.get(n.id,a);l==null&&(l=new Hpe(n.vec3),i.set(n.id,a,l)),l.changes.push(s)}return i}_addAndRemoveGeometries(e,r){const{_bufferWriter:i,_dataByOrigin:s}=this,n=i.vertexBufferLayout.stride/4,o=this._computeDeltas(e,r);o.forEach((a,l)=>{const c=a.get(null),h=c!=null?c.changes:[];o.delete(l,null);let p=s.get(l);if(a.forEach((f,m)=>{if(o.delete(l,m),m==null)return void it(!1,"No VAO for removed geometries");if(m.instances.size===f.changes.length)return this._vaoCache.deleteVao(m.vao),MI(p.buffers,m),void(p.buffers.length===0&&h.length===0&&s.delete(l));const g=m.numElements,_=m.vao.byteSize/4,v=h.reduce((S,O)=>S+i.elementCount(O.geometry),0),b=f.changes.reduce((S,O)=>S+i.elementCount(O.geometry),0),x=Math.min((g+v-b)*n,vN),T=x>_;x>XU&&x<_/2?(f.changes.forEach(({id:S})=>m.deleteInstance(S)),m.instances.forEach(({geometry:S})=>h.push(S)),this._vaoCache.deleteVao(m.vao),MI(p.buffers,m)):T?this._applyAndRebuild(m,h,f):this._applyRemoves(m,f)}),h.length>0)for(p==null&&(p=new Twt(c.origin),s.set(l,p)),p.buffers.forEach(f=>this._applyAdds(f,h));h.length>0;)p.buffers.push(this._applyAndRebuild(new bwt,h,null))})}_updateDrawCommands(){this._hasHighlights=!1,this._hasOccludees=!1,this._dataByOrigin.forEach(e=>{e.buffers.forEach(r=>{r.drawCommandsDirty&&(r.hasHiddenInstances=!1,r.hasHighlights=!1,r.hasOccludees=!1,ra(r.instances,i=>(r.updateDrawState(i),r.hasHiddenInstances&&r.hasHighlights&&r.hasOccludees)),r.updateDrawCommands(this._bufferWriter.vertexBufferLayout.stride)),this._hasHighlights=this._hasHighlights||r.hasHighlights,this._hasOccludees=this._hasOccludees||r.hasOccludees})})}_applyAndRebuild(e,r,i){if(i!=null)for(const g of i.changes)e.deleteInstance(g.id);const s=this._bufferWriter,n=s.vertexBufferLayout.stride,o=n/4,a=Math.floor(vN/o);let l=e.numElements;for(;r.length>0;){const g=r.pop(),_=s.elementCount(g.geometry);if(l+_>a&&l>0){r.push(g);break}l+=_;const v=new Gpe(g,0,0);it(e.instances.get(g.id)==null),e.addInstance(g.id,v)}const c=l*o,h=bN(c),p=s.vertexBufferLayout.createView(h.buffer);let f=0;e.hasHiddenInstances=!1,e.hasHighlights=!1,e.hasOccludees=!1,e.instances.forEach((g,_)=>{this._writeGeometry(g.geometry,p,f);const v=f;f+=s.elementCount(g.geometry.geometry),e.updateInstance(_,v,f),e.updateDrawState(g)}),this._vaoCache.deleteVao(e.vao),e.vao=this._vaoCache.newVao(Zpe(c)),e.vao.vertexBuffers.geometry.setSubData(h,0,0,f*o),wN(),e.holes.clear();const m=e.holes.pushNew();return m.from=f,m.to=Math.floor(e.vao.byteSize/n),e.updateDrawCommands(n),e}_applyRemoves(e,r){if(r.changes.length===0)return;for(const a of r.changes){const l=a.id,c=e.instances.get(l);if(!c)continue;e.deleteInstance(l);const h=nm.back();if(h){if(h.to===c.from){h.to=c.to;continue}if(h.from===c.to){h.from=c.from;continue}}const p=nm.pushNew();p.from=c.from,p.to=c.to}Bpe(nm);const i=this._bufferWriter.vertexBufferLayout.stride/4,s=nm.reduce((a,l)=>Math.max(a,l.numElements),0)*i,n=bN(s);n.fill(0,0,s);const o=e.vao.vertexBuffers.geometry;nm.forAll(a=>o.setSubData(n,a.from*i,0,a.numElements*i)),wN(),e.holes.pushArray(nm.data,nm.length),nm.forAll((a,l)=>nm.data[l]=null),nm.clear(),e.drawCommandsDirty=!0}_applyAdds(e,r){if(r.length===0)return;if(!wwt(e))return void this._applyAndRebuild(e,r,null);const i=this._bufferWriter,s=i.vertexBufferLayout.stride/4,n=e.numElements,o=r.reduce((b,x)=>b+i.elementCount(x.geometry),0),a=Math.min((n+o)*s,vN),l=4*a;if(e.vao.byteSize<Zpe(vN-XU)&&l>e.vao.byteSize)return void this._applyAndRebuild(e,r,null);Bpe(e.holes);const c=new Array;for(const b of r){const x=i.elementCount(b.geometry),T=Awt(e.holes,x);c.push(T)}const h=e.vao.vertexBuffers.geometry;let p=0,f=0,m=0;const g=bN(a),_=i.vertexBufferLayout.createView(g.buffer);r.forEach((b,x)=>{const T=c[x];if(T==null)return;if(m!==T){const A=m-f;A>0&&h.setSubData(g,f*s,0,A*s),f=T,p=0}const S=i.elementCount(b.geometry);this._writeGeometry(b,_,p),p+=S,m=T+S;const O=new Gpe(b,T,T+S);it(e.instances.get(b.id)==null),e.addInstance(b.id,O),e.drawCommandsDirty=!0});const v=m-f;v>0&&h.setSubData(g,f*s,0,v*s),T4e(r,(b,x)=>c[x]==null),wN()}_writeGeometry(e,r,i){const s=e.localOrigin.vec3;Vut(qpe,-s[0],-s[1],-s[2]);const n=yi(Owt,qpe,e.transformation);so(yN,n),Ou(yN,yN),this._bufferWriter.write(n,yN,e.geometry,r,i)}updateAnimation(e){return this.material.update(e)}requiresSlot(e,r){return this.material.requiresSlot(e,r)}prepareTechnique(e){const{output:r,bindParameters:i}=e;if(!this.requiresSlot(i.slot,r))return null;const s=r===k.Highlight||r===k.ShadowHighlight;if(s&&!this._hasHighlights)return null;const n=r===k.ShadowExcludeHighlight,o=!(s||n);for(const a of this._dataByOrigin.values())for(const l of a.buffers){if(s&&!l.hasHighlights)continue;const c=(s?l.drawCommandsHighlight:n&&l.needsMultipleCommands()?l.drawCommandsShadowHighlightRest:l.drawCommandsDefault)||null,h=o&&l.drawCommandsOccludees||null;if(c?.length||h?.length){const p=this._glMaterials.load(e.rctx,i.slot,r),f=p!=null?p.beginSlot(i):null;if(f!=null)return f}}return null}render(e,r){const{output:i,bindParameters:s}=e,n=i===k.Highlight||i===k.ShadowHighlight,o=i===k.ShadowExcludeHighlight,a=!(n||o),l=this._rctx;l.appleAmdDriverHelper?.resetIndicesType(),l.bindTechnique(r,this.material.parameters,s);for(const c of this._dataByOrigin.values())for(const h of c.buffers){if(n&&!h.hasHighlights)continue;const p=(n?h.drawCommandsHighlight:o&&h.needsMultipleCommands()?h.drawCommandsShadowHighlightRest:h.drawCommandsDefault)||null,f=a&&h.drawCommandsOccludees||null;(p?.length||f?.length)&&(r.program.bindDraw(new kY(c.origin),s,this.material.parameters),r.ensureAttributeLocations(h.vao),l.bindVAO(h.vao),p?.length&&(r.bindPipelineState(l,s.slot,!1),p.forAll(m=>l.drawArrays(r.primitiveType,m.first,m.count))),f?.length&&(r.bindPipelineState(l,s.slot,!0),f.forAll(m=>l.drawArrays(r.primitiveType,m.first,m.count))))}}get test(){return{material:this.material,glMaterials:this._glMaterials,dataByOrigin:this._dataByOrigin}}},Hpe=class{constructor(e){this.origin=e,this.changes=new Array}};function Awt(t,e){let r;if(!t.some(s=>!(s.numElements<e)&&(r=s,!0)))return null;const i=r.from;return r.from+=e,r.from>=r.to&&t.removeUnordered(r),i}const qpe=xe(),Owt=xe(),yN=xe(),nm=new qt({allocator:t=>t||new hie,deallocator:null}),XU=65536,_N=4*XU,Wpe=1024,hLe=16777216,vN=hLe/4;let c5=new Float32Array(XU);function bN(t){return c5.length<t&&(c5=new Float32Array(t)),c5}function Zpe(t){const e=4*t;return e<=Wpe?Wpe:e<_N?_N:Math.max(Math.min(Math.ceil(1.5*e/_N)*_N,hLe),e)}function wN(){c5=new Float32Array(2)}let Qu=class extends me{constructor(e){super(e),this._pending=new Rwt,this._changes=new FY,this._materialRenderers=new Map,this._sortedMaterialRenderers=new qt,this._geometries=new Map,this._hasHighlights=!1,this._hasWater=!1}destroy(){this._changes.prune(),this._materialRenderers.forEach(e=>e.dispose()),this._materialRenderers.clear(),this._sortedMaterialRenderers.clear(),this._geometries.clear(),this._pending.clear()}get updating(){return!this._pending.empty||this._changes.updates.length>0}get rctx(){return this.rendererContext.rctx}get _materialRepository(){return this.rendererContext.materialRepository}get _localOriginFactory(){return this.rendererContext.localOriginFactory}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return ra(this._materialRenderers,e=>e.rendersOccluded)}get isEmpty(){return!this.updating&&this._materialRenderers.size===0&&this._geometries.size===0}commitChanges(){if(!this.updating)return!1;this._processAddsRemoves();const e=eLe(this._changes);let r=!1,i=!1,s=!1;return e.forEach((n,o)=>{let a=this._materialRenderers.get(o);if(!a&&n.adds.length>0&&(a=new uLe(this.rctx,this._materialRepository,o),this._materialRenderers.set(o,a),r=!0,i=!0,s=!0),!a)return;const l=i||a.hasHighlights,c=s||a.hasWater;a.modify(n),i=i||l!==a.hasHighlights,s=s||c!==a.hasWater,a.isEmpty&&(this._materialRenderers.delete(o),a.dispose(),r=!0)}),this._changes.clear(),r&&this._updateSortedMaterialRenderers(),i&&(this._hasHighlights=ra(this._materialRenderers,n=>n.hasHighlights)),s&&(this._hasWater=ra(this._materialRenderers,n=>n.hasWater)),this.notifyChange("updating"),!0}addGeometries(e,r){if(e.length===0)return;const i=this._validateRenderGeometries(e);for(const n of i)this._geometries.set(n.id,n);const s=this._pending.empty;for(const n of i)this._pending.adds.add(n);s&&this.notifyChange("updating"),r===ps.UPDATE&&this._notifyGraphicGeometryChanged(e)}removeGeometries(e,r){const i=this._pending.empty,s=this._pending.adds;for(const n of e)s.has(n)?(this._pending.removed.add(n),s.delete(n)):this._pending.removed.has(n)||this._pending.removes.add(n),this._geometries.delete(n.id);i&&!this._pending.empty&&this.notifyChange("updating"),r===ps.UPDATE&&this._notifyGraphicGeometryChanged(e)}modifyGeometries(e,r){const i=this._changes.updates.length===0;for(const s of e){const n=this._changes.updates.pushNew();n.renderGeometry=this._validateRenderGeometry(s),n.updateType=r}switch(i&&this._changes.updates.length>0&&this.notifyChange("updating"),r){case eo.TRANSFORMATION:case eo.GEOMETRY:return this._notifyGraphicGeometryChanged(e);case eo.VISIBILITY:return this._notifyGraphicVisibilityChanged(e)}}updateAnimation(e){let r=!1;return this._sortedMaterialRenderers.forAll(i=>r=i.updateAnimation(e)||r),r}render(e){this._sortedMaterialRenderers.forAll(r=>{if(r.material.shouldRender(e)){const i=r.prepareTechnique(e);i!=null&&r.render(e,i)}})}intersect(e,r,i,s,n){return this._geometries.forEach(o=>{if(s&&!s(o))return;this._intersectRenderGeometry(o,i,r,0,e,n);const a=this.rendererContext.longitudeCyclical;a&&(o.boundingSphere[0]-o.boundingSphere[3]<a.min&&this._intersectRenderGeometry(o,i,r,a.range,e,n),o.boundingSphere[0]+o.boundingSphere[3]>a.max&&this._intersectRenderGeometry(o,i,r,-a.range,e,n)),n++}),n}_updateSortedMaterialRenderers(){this._sortedMaterialRenderers.clear();let e=0;this._materialRenderers.forEach((r,i)=>{i.insertOrder=e++,this._sortedMaterialRenderers.push(r)}),this._sortedMaterialRenderers.sort((r,i)=>{const s=i.material.renderPriority-r.material.renderPriority;return s!==0?s:r.material.insertOrder-i.material.insertOrder})}_processAddsRemoves(){this._changes.adds.clear(),this._changes.removes.clear(),this._changes.adds.pushArray(Array.from(this._pending.adds)),this._changes.removes.pushArray(Array.from(this._pending.removes));for(let e=0;e<this._changes.updates.length;){const r=this._changes.updates.data[e];this._pending.has(r.renderGeometry)?this._changes.updates.removeUnorderedIndex(e):e++}this._pending.clear()}_intersectRenderGeometry(e,r,i,s,n,o){if(!e.visible)return;let a=0;s+=e.transformation[12],a=e.transformation[13],mG[0]=i[0]-s,mG[1]=i[1]-a,e.screenToWorldRatio=this.rendererContext.screenToWorldRatio,e.material.intersectDraped(e,null,n,mG,(l,c,h)=>{Mwt(r,h,e.material.renderPriority,o,n,e.layerUid,e.graphicUid)},r)}_notifyGraphicGeometryChanged(e){if(this.drapeSource.notifyGraphicGeometryChanged==null)return;let r;for(const i of e){const s=i.graphicUid;s!=null&&s!==r&&(this.drapeSource.notifyGraphicGeometryChanged(s),r=s)}}_notifyGraphicVisibilityChanged(e){if(this.drapeSource.notifyGraphicVisibilityChanged==null)return;let r;for(const i of e){const s=i.graphicUid;s!=null&&s!==r&&(this.drapeSource.notifyGraphicVisibilityChanged(s),r=s)}}_validateRenderGeometries(e){for(const r of e)this._validateRenderGeometry(r);return e}_validateRenderGeometry(e){return e.localOrigin==null&&(e.localOrigin=this._localOriginFactory.getOrigin(e.boundingSphere)),e}get test(){return{sortedMaterialRenderers:this._sortedMaterialRenderers}}};u([d()],Qu.prototype,"drapeSource",void 0),u([d()],Qu.prototype,"updating",null),u([d()],Qu.prototype,"rctx",null),u([d()],Qu.prototype,"rendererContext",void 0),u([d()],Qu.prototype,"_materialRepository",null),u([d()],Qu.prototype,"_localOriginFactory",null),u([d({readOnly:!0})],Qu.prototype,"isEmpty",null),u([d()],Qu.prototype,"_materialRenderers",void 0),u([d()],Qu.prototype,"_geometries",void 0),Qu=u([R("esri.views.3d.webgl-engine.lib.SortedRenderGeometryRenderer")],Qu);let Rwt=class{constructor(){this.adds=new Set,this.removes=new Set,this.removed=new Set}get empty(){return this.adds.size===0&&this.removes.size===0&&this.removed.size===0}has(e){return this.adds.has(e)||this.removes.has(e)||this.removed.has(e)}clear(){this.adds.clear(),this.removes.clear(),this.removed.clear()}};function Mwt(t,e,r,i,s,n,o){const a=new Jbt(n,o,e),l=c=>{c.set(ls.OVERLAY,a,t.dist,t.normal,t.transformation,r,i)};if((s.results.min.drapedLayerOrder==null||r>=s.results.min.drapedLayerOrder)&&(s.results.min.dist==null||s.results.ground.dist<=s.results.min.dist)&&l(s.results.min),s.options.store!==na.MIN&&(s.results.max.drapedLayerOrder==null||r<s.results.max.drapedLayerOrder)&&(s.results.max.dist==null||s.results.ground.dist>s.results.max.dist)&&l(s.results.max),s.options.store===na.ALL){const c=ore(s.ray);l(c),s.results.all.push(c)}}const mG=Pe();let die=class extends Ps{constructor(e,r){super(e,"vec2",ai.Draw,(i,s,n,o)=>i.setUniform2fv(e,r(s,n,o)))}};const gG=4;function Iwt(){const t=new Cr,e=t.fragment;t.include(ep);const r=(gG+1)/2,i=1/(2*r*r);return e.include(Ch),e.uniforms.add(new et("depthMap",s=>s.depthTexture),new Nd("tex",s=>s.colorTexture),new die("blurSize",s=>s.blurSize),new Ie("projScale",(s,n)=>{const o=_i(n.camera.eye,n.camera.center);return o>5e4?Math.max(0,s.projScale-(o-5e4)):s.projScale}),new Pr("nearFar",(s,n)=>n.camera.nearFar)),e.code.add(w`
    void blurFunction(vec2 uv, float r, float center_d, float sharpness, inout float wTotal, inout float bTotal) {
      float c = texture(tex, uv).r;
      float d = linearDepthFromTexture(depthMap, uv, nearFar);

      float ddiff = d - center_d;

      float w = exp(-r * r * ${w.float(i)} - ddiff * ddiff * sharpness);
      wTotal += w;
      bTotal += w * c;
    }
  `),e.code.add(w`
    void main(void) {
      float b = 0.0;
      float w_total = 0.0;

      float center_d = linearDepthFromTexture(depthMap, uv, nearFar);

      float sharpness = -0.05 * projScale / center_d;
      for (int r = -${w.int(gG)}; r <= ${w.int(gG)}; ++r) {
        float rf = float(r);
        vec2 uvOffset = uv + rf * blurSize;
        blurFunction(uvOffset, rf, center_d, sharpness, w_total, b);
      }

      fragColor = vec4(b / w_total);
    }
  `),t}const Pwt=Object.freeze(Object.defineProperty({__proto__:null,build:Iwt},Symbol.toStringTag,{value:"Module"}));let dLe=class pLe extends Ur{initializeProgram(e){return new Lr(e.rctx,pLe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};dLe.shader=new $r(Pwt,()=>J(()=>import("./SSAOBlur.glsl-293076ca.js"),[],import.meta.url));const $wt="eXKEvZaUc66cjIKElE1jlJ6MjJ6Ufkl+jn2fcXp5jBx7c6KEflSGiXuXeW6OWs+tfqZ2Yot2Y7Zzfo2BhniEj3xoiXuXj4eGZpqEaHKDWjSMe7palFlzc3BziYOGlFVzg6Zzg7CUY5JrjFF7eYJ4jIKEcyyEonSXe7qUfqZ7j3xofqZ2c4R5lFZ5Y0WUbppoe1l2cIh2ezyUho+BcHN2cG6DbpqJhqp2e1GcezhrdldzjFGUcyxjc3aRjDyEc1h7Sl17c6aMjH92pb6Mjpd4dnqBjMOEhqZleIOBYzB7gYx+fnqGjJuEkWlwnCx7fGl+c4hjfGyRe5qMlNOMfnqGhIWHc6OMi4GDc6aMfqZuc6aMzqJzlKZ+lJ6Me3qRfoFue0WUhoR5UraEa6qMkXiPjMOMlJOGe7JrUqKMjK6MeYRzdod+Sl17boiPc6qEeYBlcIh2c1WEe7GDiWCDa0WMjEmMdod+Y0WcdntzhmN8WjyMjKJjiXtzgYxYaGd+a89zlEV7e2GJfnd+lF1rcK5zc4p5cHuBhL6EcXp5eYB7fnh8iX6HjIKEeaxuiYOGc66RfG2Ja5hzjlGMjEmMe9OEgXuPfHyGhPeEdl6JY02McGuMfnqGhFiMa3WJfnx2l4hwcG1uhmN8c0WMc39og1GBbrCEjE2EZY+JcIh2cIuGhIWHe0mEhIVrc09+gY5+eYBlnCyMhGCDl3drfmmMgX15aGd+gYx+fnuRfnhzY1SMsluJfnd+hm98WtNrcIuGh4SEj0qPdkqOjFF7jNNjdnqBgaqUjMt7boeBhnZ4jDR7c5pze4GGjEFrhLqMjHyMc0mUhKZze4WEa117kWlwbpqJjHZ2eX2Bc09zeId+e0V7WlF7jHJ2l72BfId8l3eBgXyBe897jGl7c66cgW+Xc76EjKNbgaSEjGx4fId8jFFjgZB8cG6DhlFziZhrcIh2fH6HgUqBgXiPY8dahGFzjEmMhEFre2dxhoBzc5SGfleGe6alc7aUeYBlhKqUdlp+cH5za4OEczxza0Gcc4J2jHZ5iXuXjH2Jh5yRjH2JcFx+hImBjH+MpddCl3dreZeJjIt8ZW18bm1zjoSEeIOBlF9oh3N7hlqBY4+UeYFwhLJjeYFwaGd+gUqBYxiEYot2fqZ2ondzhL6EYyiEY02Ea0VjgZB8doaGjHxoc66cjEGEiXuXiXWMiZhreHx8frGMe75rY02Ec5pzfnhzlEp4a3VzjM+EhFFza3mUY7Zza1V5e2iMfGyRcziEhDyEkXZ2Y4OBnCx7g5t2eyBjgV6EhEFrcIh2dod+c4Z+nJ5zjm15jEmUeYxijJp7nL6clIpjhoR5WrZraGd+fnuRa6pzlIiMg6ZzfHx5foh+eX1ufnB5eX1ufnB5aJt7UqKMjIh+e3aBfm5lbYSBhGFze6J4c39oc0mUc4Z+e0V7fKFVe0WEdoaGY02Ec4Z+Y02EZYWBfH6HgU1+gY5+hIWUgW+XjJ57ebWRhFVScHuBfJ6PhBx7WqJzlM+Ujpd4gHZziX6HjHmEgZN+lJt5boiPe2GJgX+GjIGJgHZzeaxufnB5hF2JtdN7jJ57hp57hK6ElFVzg6ZzbmiEbndzhIWHe3uJfoFue3qRhJd2j3xoc65zlE1jc3p8lE1jhniEgXJ7e657vZaUc3qBh52BhIF4aHKDa9drgY5+c52GWqZzbpqJe8tjnM+UhIeMfo2BfGl+hG1zSmmMjKJjZVaGgX15c1lze0mEp4OHa3mUhIWHhDyclJ6MeYOJkXiPc0VzhFiMlKaEboSJa5Jze41re3qRhn+HZYWBe0mEc4p5fnORbox5lEp4hGFjhGGEjJuEc1WEhLZjeHeGa7KlfHx2hLaMeX1ugY5+hIWHhKGPjMN7c1WEho1zhoBzZYx7fnhzlJt5exyUhFFziXtzfmmMa6qMYyiEiXxweV12kZSMeWqXSl17fnhzxmmMrVGEe1mcc4p5eHeGjK6MgY5+doaGa6pzlGV7g1qBh4KHkXiPeW6OaKqafqZ2eXZ5e1V7jGd7boSJc3BzhJd2e0mcYot2h1RoY8dahK6EQmWEWjx7e1l2lL6UgXyBdnR4eU9zc0VreX1umqaBhld7fo2Bc6KEc5Z+hDyEcIeBWtNrfHyGe5qMhMuMe5qMhEGEbVVupcNzg3aHhIF4boeBe0mEdlptc39ofFl5Y8uUlJOGiYt2UmGEcyxjjGx4jFF7a657ZYWBnElzhp57iXtrgZN+tfOEhIOBjE2HgU1+e8tjjKNbiWCDhE15gUqBgYN7fnqGc66ce9d7iYSBj0qPcG6DnGGcT3eGa6qMZY+JlIiMl4hwc3aRdnqBlGV7eHJ2hLZjfnuRhDyEeX6MSk17g6Z+c6aUjHmEhIF4gXyBc76EZW18fGl+fkl+jCxrhoVwhDyUhIqGlL2DlI6EhJd2tdN7eYORhEGMa2Faa6pzc3Bzc4R5lIRznM+UY9eMhDycc5Z+c4p5c4iGY117pb6MgXuPrbJafnx2eYOJeXZ5e657hDyEcziElKZjfoB5eHeGj4WRhGGEe6KGeX1utTStc76EhFGJnCyMa5hzfH6HnNeceYB7hmN8gYuMhIVrczSMgYF8h3N7c5pza5hzjJqEYIRdgYuMlL2DeYRzhGGEeX1uhLaEc4iGeZ1zdl6JhrVteX6Me2iMfm5lWqJzSpqEa6pzdnmchHx2c6OMhNdrhoR5g3aHczxzeW52gV6Ejm15frGMc0Vzc4Z+l3drfniJe+9rWq5rlF1rhGGEhoVwe9OEfoh+e7pac09+c3qBY0lrhDycdnp2lJ6MiYOGhGCDc3aRlL2DlJt5doaGdnp2gYF8gWeOjF2Uc4R5c5Z+jEmMe7KEc4mEeYJ4dmyBe0mcgXiPbqJ7eYB7fmGGiYSJjICGlF1reZ2PnElzbpqJfH6Hc39oe4WEc5eJhK6EhqyJc3qBgZB8c09+hEmEaHKDhFGJc5SGiXWMUpaEa89zc6OMnCyMiXtrho+Be5qMc7KEjJ57dmN+hKGPjICGbmiEe7prdod+hGCDdnmchBx7eX6MkXZ2hGGEa657hm98jFFjY5JreYOJgY2EjHZ2a295Y3FajJ6Mc1J+YzB7e4WBjF2Uc4R5eV12gYxzg1qBeId+c9OUc5pzjFFjgY5+hFiMlIaPhoR5lIpjjIKBlNdSe7KEeX2BfrGMhIqGc65zjE2UhK6EklZ+QmWEeziMWqZza3VzdnR4foh+gYF8n3iJiZhrnKp7gYF8eId+lJ6Me1lrcIuGjKJjhmN8c66MjFF7a6prjJ6UnJ5zezyUfruRWlF7nI5zfHyGe657h4SEe8tjhBx7jFFjc09+c39ojICMeZeJeXt+YzRzjHZ2c0WEcIeBeXZ5onSXkVR+gYJ+eYFwdldzgYF7eX2BjJ6UiXuXlE1jh4SEe1mchLJjc4Z+hqZ7eXZ5bm1zlL6Ue5p7iWeGhKqUY5pzjKJjcIeBe8t7gXyBYIRdlEp4a3mGnK6EfmmMZpqEfFl5gYxzjKZuhGFjhoKGhHx2fnx2eXuMe3aBiWeGvbKMe6KGa5hzYzB7gZOBlGV7hmN8hqZlYot2Y117a6pzc6KEfId8foB5rctrfneJfJ6PcHN2hFiMc5pzjH92c0VzgY2EcElzdmCBlFVzg1GBc65zY4OBboeBcHiBeYJ4ewxzfHx5lIRzlEmEnLKEbk1zfJ6PhmN8eYBljBiEnMOEiXxwezyUcIeBe76EdsKEeX2BdnR4jGWUrXWMjGd7fkl+j4WRlEGMa5Jzho+BhDyEfnqMeXt+g3aHlE1jczClhNN7ZW18eHx8hGFjZW18iXWMjKJjhH57gYuMcIuGWjyMe4ZtjJuExmmMj4WRdntzi4GDhFFzYIRdnGGcjJp7Y0F7e4WEkbCGiX57fnSHa657a6prhBCMe3Z+SmmMjH92eHJ2hK6EY1FzexhrvbKMnI5za4OEfnd+eXuMhImBe897hLaMjN+EfG+BeIOBhF1+eZeJi4GDkXZ2eXKEgZ6Ejpd4c2GHa1V5e5KUfqZuhCx7jKp7lLZrg11+hHx2hFWUoot2nI5zgbh5mo9zvZaUe3qRbqKMfqZ2kbCGhFiM";function j8(t){t.fragment.uniforms.add(new cr("projInfo",(e,r)=>Lwt(r))),t.fragment.uniforms.add(new Pr("zScale",(e,r)=>fLe(r))),t.fragment.code.add(w`vec3 reconstructPosition(vec2 fragCoord, float depth) {
return vec3((fragCoord * projInfo.xy + projInfo.zw) * (zScale.x * depth + zScale.y), depth);
}`)}function Lwt(t){const e=t.camera.projectionMatrix;return e[11]===0?zi(Xpe,2/(t.camera.fullWidth*e[0]),2/(t.camera.fullHeight*e[5]),(1+e[12])/e[0],(1+e[13])/e[5]):zi(Xpe,-2/(t.camera.fullWidth*e[0]),-2/(t.camera.fullHeight*e[5]),(1-e[8])/e[0],(1-e[9])/e[5])}const Xpe=Qt();function fLe(t){return t.camera.projectionMatrix[11]===0?hr(Ype,0,1):hr(Ype,1,0)}const Ype=Pe(),Jpe=16;function Dwt(){const t=new Cr,e=t.fragment;return t.include(ep),e.include(Ch),t.include(j8),e.uniforms.add(new Ie("radius",(r,i)=>pie(i.camera))),e.code.add(w`vec3 sphere[16];
void fillSphere() {
sphere[0] = vec3(0.186937, 0.0, 0.0);
sphere[1] = vec3(0.700542, 0.0, 0.0);
sphere[2] = vec3(-0.864858, -0.481795, -0.111713);
sphere[3] = vec3(-0.624773, 0.102853, -0.730153);
sphere[4] = vec3(-0.387172, 0.260319, 0.007229);
sphere[5] = vec3(-0.222367, -0.642631, -0.707697);
sphere[6] = vec3(-0.01336, -0.014956, 0.169662);
sphere[7] = vec3(0.122575, 0.1544, -0.456944);
sphere[8] = vec3(-0.177141, 0.85997, -0.42346);
sphere[9] = vec3(-0.131631, 0.814545, 0.524355);
sphere[10] = vec3(-0.779469, 0.007991, 0.624833);
sphere[11] = vec3(0.308092, 0.209288,0.35969);
sphere[12] = vec3(0.359331, -0.184533, -0.377458);
sphere[13] = vec3(0.192633, -0.482999, -0.065284);
sphere[14] = vec3(0.233538, 0.293706, -0.055139);
sphere[15] = vec3(0.417709, -0.386701, 0.442449);
}
float fallOffFunction(float vv, float vn, float bias) {
float f = max(radius * radius - vv, 0.0);
return f * f * f * max(vn - bias, 0.0);
}`),e.code.add(w`float aoValueFromPositionsAndNormal(vec3 C, vec3 n_C, vec3 Q) {
vec3 v = Q - C;
float vv = dot(v, v);
float vn = dot(normalize(v), n_C);
return fallOffFunction(vv, vn, 0.1);
}`),e.uniforms.add(new Pr("nearFar",(r,i)=>i.camera.nearFar),new et("normalMap",r=>r.normalTexture),new et("depthMap",r=>r.depthTexture),new Pr("zScale",(r,i)=>fLe(i)),new Ie("projScale",r=>r.projScale),new et("rnm",r=>r.noiseTexture),new Pr("rnmScale",(r,i)=>hr(Qpe,i.camera.fullWidth/r.noiseTexture.descriptor.width,i.camera.fullHeight/r.noiseTexture.descriptor.height)),new Ie("intensity",r=>r.intensity),new Pr("screenSize",(r,i)=>hr(Qpe,i.camera.fullWidth,i.camera.fullHeight))),e.code.add(w`
    void main(void) {
      fillSphere();
      vec3 fres = normalize(2.0 * texture(rnm, uv * rnmScale).xyz - 1.0);
      float currentPixelDepth = linearDepthFromTexture(depthMap, uv, nearFar);

      if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
        fragColor = vec4(0);
        return;
      }

      vec3 currentPixelPos = reconstructPosition(gl_FragCoord.xy,currentPixelDepth);

      // get the normal of current fragment
      vec4 norm4 = texture(normalMap, uv);
      vec3 norm = vec3(-1.0) + 2.0 * norm4.xyz;
      bool isTerrain = norm4.w < 0.5;

      float sum = 0.0;
      vec3 tapPixelPos;

      // note: the factor 2.0 should not be necessary, but makes ssao much nicer.
      // bug or deviation from CE somewhere else?
      float ps = projScale / (2.0 * currentPixelPos.z * zScale.x + zScale.y);

      for(int i = 0; i < ${w.int(Jpe)}; ++i) {
        vec2 unitOffset = reflect(sphere[i], fres).xy;
        vec2 offset = vec2(-unitOffset * radius * ps);

        //don't use current or very nearby samples
        if( abs(offset.x) < 2.0 || abs(offset.y) < 2.0){
          continue;
        }

        vec2 tc = vec2(gl_FragCoord.xy + offset);
        if (tc.x < 0.0 || tc.y < 0.0 || tc.x > screenSize.x || tc.y > screenSize.y) continue;
        vec2 tcTap = tc / screenSize;
        float occluderFragmentDepth = linearDepthFromTexture(depthMap, tcTap, nearFar);

        if (isTerrain) {
          if (texture(normalMap, tcTap).w < 0.5) {
            continue;
          }
        }

        tapPixelPos = reconstructPosition(tc, occluderFragmentDepth);

        sum+= aoValueFromPositionsAndNormal(currentPixelPos, norm, tapPixelPos);
      }

      // output the result
      float A = max(1.0 - sum * intensity / float(${w.int(Jpe)}), 0.0);

      // Anti-tone map to reduce contrast and drag dark region farther: (x^0.2 + 1.2 * x^4) / 2.2
      A = (pow(A, 0.2) + 1.2 * A*A*A*A) / 2.2;
      fragColor = vec4(A);
    }
  `),t}function pie(t){return Math.max(10,20*t.computeScreenPixelSizeAtDist(Math.abs(4*t.relativeElevation)))}const Qpe=Pe(),Nwt=Object.freeze(Object.defineProperty({__proto__:null,build:Dwt,getRadius:pie},Symbol.toStringTag,{value:"Module"}));let mLe=class gLe extends Ur{initializeProgram(e){return new Lr(e.rctx,gLe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};mLe.shader=new $r(Nwt,()=>J(()=>import("./SSAO.glsl-24b53bc6.js"),[],import.meta.url));let Fwt=class extends ui{constructor(){super(...arguments),this.projScale=1}},kwt=class extends Fwt{constructor(){super(...arguments),this.intensity=1}},Uwt=class extends ui{},Vwt=class extends Uwt{constructor(){super(...arguments),this.blurSize=Pe()}};const mM=2;let yLe=class{constructor(e,r,i,s){this._view=e,this._techniqueRepository=r,this._rctx=i,this._requestRender=s,this._quadVAO=null,this._passParameters=new kwt,this._drawParameters=new Vwt}dispose(){this.enabled=!1,this._quadVAO=ze(this._quadVAO)}destroy(){this.dispose()}disposeOffscreenBuffers(){this._ssaoFBO?.resize(0,0),this._blurFBO?.resize(0,0)}set enabled(e){e?this._enable():this._disable()}get enabled(){return this._enableTime!=null}get active(){return this.enabled&&this._ssaoTechnique.compiled&&this._blurTechnique.compiled}get colorTexture(){return this._ssaoFBO?.colorTexture}render(e,r,i,s){if(this._enableTime==null||i==null||s==null||this._ssaoFBO==null||this._blurFBO==null)return;if(!this.active)return this._enableTime=r,void this._requestRender();this._enableTime===0&&(this._enableTime=r);const n=this._rctx,o=e.camera,a=this._view.qualitySettings.fadeDuration,l=a>0?Math.min(a,r-this._enableTime)/a:1;this._passParameters.normalTexture=s,this._passParameters.depthTexture=i,this._passParameters.projScale=1/o.computeRenderPixelSizeAtDist(1),this._passParameters.intensity=4*zwt/pie(o)**6*l;const c=o.fullViewport,h=c[2],p=c[3],f=h/mM,m=p/mM;this._ssaoFBO.resize(h,p),this._blurFBO.resize(f,m),this._quadVAO==null&&(this._quadVAO=Mc(this._rctx)),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,h,p),n.bindTechnique(this._ssaoTechnique,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),n.bindVAO(this._quadVAO);const g=Sa(this._quadVAO,"geometry");n.drawArrays(Ot.TRIANGLE_STRIP,0,g);const _=n.bindTechnique(this._blurTechnique,this._passParameters,e);n.setViewport(0,0,f,m),n.bindFramebuffer(this._blurFBO),this._drawParameters.colorTexture=this._ssaoFBO.colorTexture,hr(this._drawParameters.blurSize,0,mM/p),_.bindDraw(this._drawParameters,e,this._passParameters),n.setViewport(0,0,f,m),n.drawArrays(Ot.TRIANGLE_STRIP,0,g),n.bindFramebuffer(this._ssaoFBO),n.setViewport(0,0,h,p),n.setClearColor(1,1,1,0),n.clear(Bi.COLOR_BUFFER_BIT),n.setViewport(0,0,f,m),this._drawParameters.colorTexture=this._blurFBO.colorTexture,hr(this._drawParameters.blurSize,mM/h,0),_.bindDraw(this._drawParameters,e,this._passParameters),n.drawArrays(Ot.TRIANGLE_STRIP,0,g),n.setViewport(c[0],c[1],c[2],c[3]),l<1&&this._requestRender()}_enable(){if(this._enableTime!=null)return;const e=new Sr;e.wrapMode=Ut.CLAMP_TO_EDGE,this._ssaoFBO=new Vn(this._rctx,e),this._blurFBO=new Vn(this._rctx,e);const r=Uint8Array.from(atob($wt),i=>i.charCodeAt(0));e.pixelFormat=At.RGB,e.wrapMode=Ut.REPEAT,e.hasMipmap=!0,e.width=32,e.height=32,this._passParameters.noiseTexture=new Rt(this._rctx,e,r),this._ssaoTechnique==null&&(this._ssaoTechnique=this._techniqueRepository.acquire(mLe)),this._blurTechnique==null&&(this._blurTechnique=this._techniqueRepository.acquire(dLe)),this._enableTime=0,this._requestRender()}_disable(){this._enableTime=null,this._passParameters.noiseTexture=ze(this._passParameters.noiseTexture),this._blurFBO=ze(this._blurFBO),this._ssaoFBO=ze(this._ssaoFBO)}get gpuMemoryUsage(){return(this._blurFBO?.gpuMemoryUsage??0)+(this._ssaoFBO?.gpuMemoryUsage??0)}};const zwt=.5;let fie=class _Le extends Ur{initializeProgram(e){return new Lr(e.rctx,_Le.shader.get().build(),Er)}initializePipeline(){return this.configuration.hasAlpha?It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt}):It({colorWrite:Wt})}};fie.shader=new $r(abt,()=>J(()=>import("./TextureOnly.glsl-36f10818.js"),[],import.meta.url));let mie=class extends nl{constructor(){super(...arguments),this.hasAlpha=!1}};u([B()],mie.prototype,"hasAlpha",void 0);let Im=class extends me{get _bindParameters(){return this._renderContext.bindParameters}get _rctx(){return this.view._stage.renderView.renderingContext}get rctx(){return this._rctx}get materialRepository(){return this._materialRepository}get screenToWorldRatio(){return this._screenToWorldRatio}get localOriginFactory(){return this._localOriginFactory}constructor(e){super(e),this._overlays=null,this._overlayRenderTarget=null,this._hasHighlights=!1,this._rendersOccluded=!1,this._hasWater=!1,this._handles=new li,this._renderers=new Map,this._sortedDrapeSourceRenderersDirty=!1,this._sortedRenderers=new qt,this._passParameters=new M$e,this._materialRepository=null,this._screenToWorldRatio=1,this._localOriginFactory=null,this._camera=new ft,this.worldToPCSRatio=1,this.events=new Xr,this.longitudeCyclical=null}initialize(){const e=this.view._stage.renderView,{waterTextureRepository:r,stippleTextureRepository:i,markerTextureRepository:s}=e;this._shaderTechniqueRepository=new I$e({rctx:this._rctx,viewingMode:Ue.Local,stippleTextureRepository:i,markerTextureRepository:s,waterTextureRepository:r}),this._renderContext=new Q$e(this._rctx,new aie(this._rctx,this.view.state.viewingMode),new yLe(this.view,this._shaderTechniqueRepository,this._rctx,()=>{})),this._handles.add([Q(()=>r.updating,()=>this.events.emit("content-changed"),Ri),Q(()=>this.spatialReference,n=>this._localOriginFactory=new nie(n),Ri),Vs(()=>this.view.allLayerViews,"after-changes",()=>this._sortedDrapeSourceRenderersDirty=!0)]),this._materialRepository=new P$e(e.textureRepository,this._shaderTechniqueRepository,n=>{(n.renderOccluded&YU)>0!==this._rendersOccluded&&this._updateRendersOccluded(),this.events.emit("content-changed"),this.notifyChange("updating"),this.notifyChange("isEmpty")},()=>this.events.emit("content-changed")),this._bindParameters.slot=fe.DRAPED_MATERIAL,this._bindParameters.highlightDepthTexture=u3e(this._rctx),this._camera.near=1,this._camera.far=1e4,this._camera.relativeElevation=null,this._bindParameters.camera=this._camera,this._bindParameters.transparencyPassType=ut.NONE,this._bindParameters.newLighting.noonFactor=0,this._bindParameters.newLighting.globalFactor=0,this._bindParameters.newLighting.set([new Hte(Ee(1,1,1))]),this._handles.add(this.view.resourceController.scheduler.registerTask(gt.STAGE,this))}destroy(){this._handles.destroy(),this._renderers.forEach(e=>e.destroy()),this._renderers.clear(),this._debugTextureTechnique=as(this._debugTextureTechnique),this._passParameters.texture=ze(this._passParameters.texture),this._bindParameters.highlightDepthTexture=ze(this._bindParameters.highlightDepthTexture),this._shaderTechniqueRepository=Re(this._shaderTechniqueRepository),this._temporaryFBO=ze(this._temporaryFBO),this._quadVAO=ze(this._quadVAO),this.disposeOverlays()}get updating(){return this._sortedDrapeSourceRenderersDirty||ra(this._renderers,e=>e.updating)}get hasOverlays(){return this._overlays!=null&&this._overlayRenderTarget!=null}get gpuMemoryUsage(){return this._overlayRenderTarget!=null?this._overlayRenderTarget.gpuMemoryUsage:0}createGeometryDrapeSourceRenderer(e){return this.createDrapeSourceRenderer(e,Qu)}createDrapeSourceRenderer(e,r,i){const s=this._renderers.get(e);s?.destroy();const n=new r({...i,rendererContext:this,drapeSource:e});return this._renderers.set(e,n),this._sortedDrapeSourceRenderersDirty=!0,"fullOpacity"in e&&this._handles.add(Q(()=>e.fullOpacity,()=>this.events.emit("content-changed")),e),n}removeDrapeSourceRenderer(e){if(e==null)return;const r=this._renderers.get(e);r!=null&&(this._sortedDrapeSourceRenderersDirty=!0,this._renderers.delete(e),this._handles.remove(e),r.destroy())}collectUnusedRenderTargetMemory(){let e=!1;const r=C6e();if(this._overlayRenderTarget!=null)for(const i of this._overlayRenderTarget.renderTargets){const s=this.overlays[Ji.INNER].validTargets[i.type];e=this._overlayRenderTarget.validateUsageForTarget(s,i,r)||e}return e}get overlays(){return this._overlays??[]}ensureDrapeTargets(e){this._overlays!=null&&this._overlays.forEach(r=>r.hasTargetWithoutRasterImage=SF(e,i=>i.drapeTargetType===LY.WithoutRasterImage))}ensureDrapeSources(e){this._overlays!=null&&this._overlays.forEach(r=>{r.hasDrapedFeatureSource=SF(e,i=>i.drapeSourceType===_I.Features),r.hasDrapedRasterSource=SF(e,i=>i.drapeSourceType===_I.RasterImage)})}ensureOverlays(e,r){this._overlays==null&&(this._overlayRenderTarget=new sbt(this._rctx),this._overlays=[new Lde(Ji.INNER,this._overlayRenderTarget),new Lde(Ji.OUTER,this._overlayRenderTarget)]),this.ensureDrapeTargets(e),this.ensureDrapeSources(r)}disposeOverlays(){this._overlays=null,this._overlayRenderTarget=ze(this._overlayRenderTarget),this.events.emit("textures-disposed")}get running(){return this.updating}runTask(e){this._processDrapeSources(e,()=>!0)}_processDrapeSources(e,r){let i=!1;for(const[s,n]of this._renderers){if(e.done)break;(s.destroyed||r(s))&&n.commitChanges()&&(i=!0,e.madeProgress())}this._sortedDrapeSourceRenderersDirty&&(this._sortedDrapeSourceRenderersDirty=!1,i=!0,this._updateSortedDrapeSourceRenderers()),i&&(this._overlays!=null&&this._renderers.size===0&&this.disposeOverlays(),this.notifyChange("updating"),this.notifyChange("isEmpty"),this.events.emit("content-changed"),this._updateHasHighlights(),this._updateRendersOccluded(),this._updateHasWater())}processSyncDrapeSources(){this._processDrapeSources(Ll,e=>e.updatePolicy===I1.SYNC)}get isEmpty(){return!bi.OVERLAY_DRAW_DEBUG_TEXTURE&&!ra(this._renderers,e=>!e.isEmpty)}get hasHighlights(){return this._hasHighlights}get hasWater(){return this._hasWater}get rendersOccluded(){return this._rendersOccluded}updateAnimation(e){let r=!1;return this._renderers.forEach(i=>r=i.updateAnimation(e)||r),r}updateDrapeSourceOrder(){this._sortedDrapeSourceRenderersDirty=!0}drawTarget(e,r,i){const s=e.canvasGeometries;if(s.numViews===0)return!1;const{alignPixelEnabled:n,contentPixelRatio:o}=i;this._screenToWorldRatio=o*e.mapUnitsPerPixel/Ire;const a=r.output;if(this.isEmpty||a===k.Highlight&&!this.hasHighlights||a===k.Normal&&!this.hasWater||!e.hasSomeSizedView())return!1;const l=r.fbo;if(!l.isValid())return!1;const c=2*e.resolution,h=e.resolution;l.resize(c,h);const p=this._rctx;if(this._camera.pixelRatio=e.pixelRatio*o,this._renderContext.output=a,this._bindParameters.alignPixelEnabled=n,this._bindParameters.screenToWorldRatio=this._screenToWorldRatio,this._bindParameters.screenToPCSRatio=this._screenToWorldRatio*this.worldToPCSRatio,this._bindParameters.slot=a===k.Normal?fe.DRAPED_WATER:fe.DRAPED_MATERIAL,e.applyViewport(this._rctx),l.bind(p),e.index===Ji.INNER&&(p.setClearColor(0,0,0,0),p.clearSafe(Bi.COLOR_BUFFER_BIT)),r.type===Os.Occluded&&(this._renderContext.renderOccludedMask=YU),bi.OVERLAY_DRAW_DEBUG_TEXTURE&&r.type!==Os.Occluded)for(let f=0;f<s.numViews;f++)this._setViewParameters(s.extents[f],e),this._drawDebugTexture(e.resolution,Gwt[e.index]);return this._renderers.size>0&&this._sortedRenderers.forAll(({drapeSource:f,renderer:m})=>{if(r.type===Os.ColorNoRasterImage&&f.drapeSourceType===_I.RasterImage)return;const{fullOpacity:g}=f,_=g!=null&&g<1&&a===k.Color;_&&(this.bindTemporaryFramebuffer(this._rctx,c,h),p.clearSafe(Bi.COLOR_BUFFER_BIT));for(let v=0;v<s.numViews;v++)this._setViewParameters(s.extents[v],e),m.render(this._renderContext);_&&this._temporaryFBO!=null&&(l.bind(p),this.view._stage.renderView.compositingHelper.compositeOverlay(this._renderContext.bindParameters,this._temporaryFBO.getTexture(),g,e.index))}),p.bindFramebuffer(null),l.generateMipMap(),this._renderContext.resetRenderOccludedMask(),!0}bindTemporaryFramebuffer(e,r,i){this._temporaryFBO==null&&(this._temporaryFBO=new R$e(e,!1)),this._temporaryFBO.resize(r,i),this._temporaryFBO.bind(e)}async reloadShaders(){await this._shaderTechniqueRepository.reloadAll()}notifyContentChanged(){this.events.emit("content-changed")}intersect(e,r,i,s){let n=0;for(const o of this._renderers.values())n=o.intersect?.(e,r,i,s,n)??n}_updateSortedDrapeSourceRenderers(){if(this._sortedRenderers.clear(),this._renderers.size===0)return;const e=this.view.map.allLayers;this._renderers.forEach((r,i)=>{const s=e.indexOf(i.layer),n=s>=0,o=this._renderers.size*(i.renderGroup??(n?HU.MapLayer:HU.ViewLayer))+(n?s:0);this._sortedRenderers.push(new Bwt(i,r,o))}),this._sortedRenderers.sort((r,i)=>r.index-i.index)}_setViewParameters(e,r){const i=this._camera;i.viewport=[0,0,r.resolution,r.resolution],ISe(i.projectionMatrix,0,e[2]-e[0],0,e[3]-e[1],i.near,i.far),d$(i.viewMatrix,[-e[0],-e[1],0])}_updateHasWater(){const e=ra(this._renderers,r=>r.hasWater);e!==this._hasWater&&(this._hasWater=e,this.events.emit("has-water",e))}_updateHasHighlights(){const e=ra(this._renderers,r=>r.hasHighlights);e!==this._hasHighlights&&(this._hasHighlights=e,this.events.emit("has-highlights",e))}_updateRendersOccluded(){const e=ra(this._renderers,r=>r.rendersOccluded);e!==this._rendersOccluded&&(this._rendersOccluded=e,this.events.emit("renders-occluded",e))}_drawDebugTexture(e,r){this._ensureDebugPatternResources(e,r);const i=this._rctx;i.bindTechnique(this._debugTextureTechnique,this._passParameters,null),i.bindVAO(this._quadVAO),i.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(this._quadVAO,"geometry"))}_ensureDebugPatternResources(e,r){if(ie(this._passParameters.color,r[0],r[1],r[2]),this._passParameters.texture)return;const i=new Uint8Array(e*e*4);let s=0;for(let a=0;a<e;a++)for(let l=0;l<e;l++){const c=Math.floor(l/10),h=Math.floor(a/10);c<2||h<2||10*c>e-20||10*h>e-20?(i[s++]=255,i[s++]=255,i[s++]=255,i[s++]=255):(i[s++]=255,i[s++]=255,i[s++]=255,i[s++]=1&c&&1&h?1&l^1&a?0:255:1&c^1&h?0:128)}const n=new Sr(e);n.samplingMode=Mt.NEAREST,this._passParameters.texture=new Rt(this._rctx,n,i);const o=new mie;o.hasAlpha=!0,this._debugTextureTechnique=this._shaderTechniqueRepository.acquire(fie,o),this._quadVAO=Mc(this._rctx)}get test(){return{drapedRenderers:Array.from(this._renderers.values()),getDrapeSourceRenderer:e=>this._renderers.get(e)}}};u([d()],Im.prototype,"_sortedDrapeSourceRenderersDirty",void 0),u([d({autoDestroy:!0})],Im.prototype,"_shaderTechniqueRepository",void 0),u([d({constructOnly:!0})],Im.prototype,"view",void 0),u([d()],Im.prototype,"worldToPCSRatio",void 0),u([d()],Im.prototype,"spatialReference",void 0),u([d({type:Boolean,readOnly:!0})],Im.prototype,"updating",null),u([d()],Im.prototype,"isEmpty",null),Im=u([R("esri.views.3d.terrain.OverlayRenderer")],Im);let Bwt=class{constructor(e,r,i){this.drapeSource=e,this.renderer=r,this.index=i}};const Gwt=[[1,.5,.5],[.5,.5,1]],gie=-2,YU=Qi.OccludeAndTransparent;function yie(t,e,r,i){const s=U$(t.rings,!!t.hasZ,Ag.CCW_IS_HOLE),n=Ra(s.position.length),o=zPe(s.position,t.spatialReference,0,n,0,s.position,0,s.position.length/3,e,r,i),a=o!=null;return new qwt(s.position,n,wLe(s.polygons,s.position,n),bLe(s.outlines,s.position,n),a,o)}function vLe(t,e){const r=U$(t.rings,!1,Ag.CCW_IS_HOLE),i=wi(r.position,t.spatialReference,0,r.position,e,0,r.position.length/3);for(let s=2;s<r.position.length;s+=3)r.position[s]=gie;return{position:r.position,polygons:wLe(r.polygons,r.position),outlines:bLe(r.outlines,r.position),projectionSuccess:i}}function bLe(t,e,r=null){return t.filter(({count:i})=>i>1).map(({index:i,count:s})=>{const n=3*i,o=3*s;return r!=null?new xLe(i,s,Fd(e,n,o),Fd(r,n,o)):new _ie(i,s,Fd(e,n,o))})}function wLe(t,e,r=null){const i=new Array;for(const{index:s,count:n,holeIndices:o,pathLengths:a}of t){if(n<=1)continue;const l=3*s,c=3*n,h=o.map(f=>f-s),p=r!=null?new jwt(s,n,Fd(e,3*s,3*n),Fd(r,l,c),h,a):new Hwt(s,n,Fd(e,3*s,3*n),h,a);i.push(p)}return i}let _ie=class{constructor(e,r,i){this.index=e,this.count=r,this.position=i}},xLe=class extends _ie{constructor(e,r,i,s){super(e,r,i),this.mapPositions=s}},jwt=class extends xLe{constructor(e,r,i,s,n,o){super(e,r,i,s),this.holeIndices=n,this.pathLengths=o}},Hwt=class extends _ie{constructor(e,r,i,s,n){super(e,r,i),this.holeIndices=s,this.pathLengths=n}},qwt=class{constructor(e,r,i,s,n,o){this.position=e,this.mapPositions=r,this.polygons=i,this.outlines=s,this.projectionSuccess=n,this.sampledElevation=o}};function YT(t,e,r,i,s,n=2){const o=1/(Math.abs(r)+Math.abs(i)+Math.abs(s)),a=r*o,l=i*o,c=s<=0?(a>=0?1:-1)*(1-Math.abs(l)):a,h=s<=0?(l>=0?1:-1)*(1-Math.abs(a)):l,p=e*n;t[p]=Kpe(c),t[p+1]=Kpe(h)}function Wwt(t){const e=t.length/3,r=new Int16Array(2*e);let i=0;for(let s=0;s<e;++s)YT(r,s,t[i++],t[i++],t[i++]);return r}function Zwt(t,e,r,i=2){const s=r*i,n=efe(e[s]),o=efe(e[s+1]),a=1-Math.abs(n)-Math.abs(o);t[2]=a,a<0?(t[0]=(n>=0?1:-1)*(1-Math.abs(o)),t[1]=(o>=0?1:-1)*(1-Math.abs(n))):(t[0]=n,t[1]=o),_e(t,t)}function Kpe(t){return ye(Math.round(32767*t),-32767,32767)}function efe(t){return ye(t/32767,-1,1)}function TLe(t,e){const r=t.fragment;switch(r.code.add(w`struct ShadingNormalParameters {
vec3 normalView;
vec3 viewDirection;
} shadingParams;`),e.doubleSidedMode){case bs.None:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return normalize(params.normalView);
}`);break;case bs.View:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return dot(params.normalView, params.viewDirection) > 0.0 ? normalize(-params.normalView) : normalize(params.normalView);
}`);break;case bs.WindingOrder:r.code.add(w`vec3 shadingNormal(ShadingNormalParameters params) {
return gl_FrontFacing ? normalize(params.normalView) : normalize(-params.normalView);
}`);break;default:e.doubleSidedMode;case bs.COUNT:}}var bs;(function(t){t[t.None=0]="None",t[t.View=1]="View",t[t.WindingOrder=2]="WindingOrder",t[t.COUNT=3]="COUNT"})(bs||(bs={}));function SLe({normalTexture:t,metallicRoughnessTexture:e,metallicFactor:r,roughnessFactor:i,emissiveTexture:s,emissiveFactor:n,occlusionTexture:o}){return t==null&&e==null&&s==null&&(n==null||Jr(n,Nl))&&o==null&&(i==null||i===1)&&(r==null||r===1||r===0)}const H8=[1,1,.5],vie=[0,.6,.2],Xwt=[0,1,.2];function ELe(t){t.vertex.code.add(w`vec4 offsetBackfacingClipPosition(vec4 posClip, vec3 posWorld, vec3 normalWorld, vec3 camPosWorld) {
vec3 camToVert = posWorld - camPosWorld;
bool isBackface = dot(camToVert, normalWorld) > 0.0;
if (isBackface) {
posClip.z += 0.0000003 * posClip.w;
}
return posClip;
}`)}let Ywt=class extends nl{constructor(){super(...arguments),this.instancedDoublePrecision=!1}};function CLe(t,e){e.instanced&&e.instancedDoublePrecision&&(t.attributes.add(E.MODELORIGINHI,"vec3"),t.attributes.add(E.MODELORIGINLO,"vec3"),t.attributes.add(E.MODEL,"mat3"),t.attributes.add(E.MODELNORMAL,"mat3"));const r=t.vertex;e.instancedDoublePrecision&&(r.include(_U,e),r.uniforms.add(new _h("viewOriginHi",(i,s)=>Zdt(ie(xN,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),xN)),new _h("viewOriginLo",(i,s)=>Xdt(ie(xN,s.camera.viewInverseTransposeMatrix[3],s.camera.viewInverseTransposeMatrix[7],s.camera.viewInverseTransposeMatrix[11]),xN)))),r.code.add(w`
    vec3 calculateVPos() {
      ${e.instancedDoublePrecision?"return model * localPosition().xyz;":"return localPosition().xyz;"}
    }
    `),r.code.add(w`
    vec3 subtractOrigin(vec3 _pos) {
      ${e.instancedDoublePrecision?w`
          vec3 originDelta = dpAdd(viewOriginHi, viewOriginLo, -modelOriginHi, -modelOriginLo);
          return _pos - originDelta;`:"return vpos;"}
    }
    `),r.code.add(w`
    vec3 dpNormal(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize(modelNormal * _normal.xyz);":"return normalize(_normal.xyz);"}
    }
    `),e.output===k.Normal&&(NA(r),r.code.add(w`
    vec3 dpNormalView(vec4 _normal) {
      ${e.instancedDoublePrecision?"return normalize((viewNormal * vec4(modelNormal * _normal.xyz, 1.0)).xyz);":"return normalize((viewNormal * _normal).xyz);"}
    }
    `)),e.hasVertexTangents&&r.code.add(w`
    vec4 dpTransformVertexTangent(vec4 _tangent) {
      ${e.instancedDoublePrecision?"return vec4(modelNormal * _tangent.xyz, _tangent.w);":"return _tangent;"}

    }
    `)}u([B()],Ywt.prototype,"instancedDoublePrecision",void 0);const xN=C();function ALe(t){t.vertex.code.add(w`
    vec4 decodeSymbolColor(vec4 symbolColor, out int colorMixMode) {
      float symbolAlpha = 0.0;

      const float maxTint = 85.0;
      const float maxReplace = 170.0;
      const float scaleAlpha = 3.0;

      if (symbolColor.a > maxReplace) {
        colorMixMode = ${w.int(pn.Multiply)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxReplace);
      } else if (symbolColor.a > maxTint) {
        colorMixMode = ${w.int(pn.Replace)};
        symbolAlpha = scaleAlpha * (symbolColor.a - maxTint);
      } else if (symbolColor.a > 0.0) {
        colorMixMode = ${w.int(pn.Tint)};
        symbolAlpha = scaleAlpha * symbolColor.a;
      } else {
        colorMixMode = ${w.int(pn.Multiply)};
        symbolAlpha = 0.0;
      }

      return vec4(symbolColor.r, symbolColor.g, symbolColor.b, symbolAlpha);
    }
  `)}function OLe(t,e){e.hasSymbolColors?(t.include(ALe),t.attributes.add(E.SYMBOLCOLOR,"vec4"),t.varyings.add("colorMixMode","mediump float"),t.vertex.code.add(w`int symbolColorMixMode;
vec4 getSymbolColor() {
return decodeSymbolColor(symbolColor, symbolColorMixMode) * 0.003921568627451;
}
void forwardColorMixMode() {
colorMixMode = float(symbolColorMixMode) + 0.5;
}`)):(t.fragment.uniforms.add(new z$("colorMixMode",r=>JIe[r.colorMixMode])),t.vertex.code.add(w`vec4 getSymbolColor() { return vec4(1.0); }
void forwardColorMixMode() {}`))}function xS(t,e){e.hasVertexColors?(t.attributes.add(E.COLOR,"vec4"),t.varyings.add("vColor","vec4"),t.vertex.code.add(w`void forwardVertexColor() { vColor = color; }`),t.vertex.code.add(w`void forwardNormalizedVertexColor() { vColor = color * 0.003921568627451; }`)):t.vertex.code.add(w`void forwardVertexColor() {}
void forwardNormalizedVertexColor() {}`)}function Jwt(t){t.fragment.code.add(w`
    #define discardOrAdjustAlpha(color) { if (color.a < ${w.float(ia)}) { discard; } }
  `)}let dT=class extends Ps{constructor(e,r){super(e,"float",ai.Draw,(i,s,n)=>i.setUniform1f(e,r(s,n)))}};function pT(t,e){RLe(t,e,new Ie("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function Qwt(t,e){RLe(t,e,new dT("textureAlphaCutoff",r=>r.textureAlphaCutoff))}function RLe(t,e,r){const i=t.fragment;switch(e.alphaDiscardMode!==ni.Mask&&e.alphaDiscardMode!==ni.MaskBlend||i.uniforms.add(r),e.alphaDiscardMode){case ni.Blend:return t.include(Jwt);case ni.Opaque:i.code.add(w`void discardOrAdjustAlpha(inout vec4 color) {
color.a = 1.0;
}`);break;case ni.Mask:i.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } else { color.a = 1.0; } }`);break;case ni.MaskBlend:t.fragment.code.add(w`#define discardOrAdjustAlpha(color) { if (color.a < textureAlphaCutoff) { discard; } }`)}}function MLe(t,e){const{vertex:r,fragment:i}=t,s=e.hasModelTransformation;if(s){const o=ts();r.uniforms.add(new es("model",a=>a.modelTransformation??Un)),r.uniforms.add(new tp("normalTransform",a=>(Z1(o,a.modelTransformation??Un),o)))}const n=e.hasColorTexture&&e.alphaDiscardMode!==ni.Opaque;switch(e.output){case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:case k.ObjectAndLayerIdColor:Eu(r,e),t.include(_c,e),t.include(ag,e),t.include(y0,e),t.include(N0,e),t.include(Bs,e),t.include($$,e),BT(t),t.varyings.add("depth","float"),n&&i.uniforms.add(new et("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            ${s?"vpos = (model * vec4(vpos, 1.0)).xyz;":""}
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
            forwardTextureCoordinates();
            forwardObjectAndLayerIdColor();
          }
        `),t.include(pT,e),i.code.add(w`
          void main(void) {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            ${e.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:w`outputDepth(depth);`}
          }
        `);break;case k.Normal:{Eu(r,e),t.include(_c,e),t.include(V$,e),t.include(B8,e),t.include(ag,e),t.include(y0,e),n&&i.uniforms.add(new et("tex",a=>a.texture)),e.normalType===Fr.ScreenDerivative&&t.varyings.add("vPositionView","vec3");const o=e.normalType===Fr.Attribute||e.normalType===Fr.Compressed;r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            ${s?"vpos = (model * vec4(vpos, 1.0)).xyz;":""}

            ${o?w`vNormalWorld = ${s?"normalize(normalTransform * dpNormal(vvLocalNormal(normalModel())))":"dpNormalView(vvLocalNormal(normalModel()))"};`:w`
                  // Get vertex position in camera space for screen-space derivative normals
                  vPositionView = (view * vec4(vpos, 1.0)).xyz;
                `}
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Bs,e),t.include(pT,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}

            ${e.normalType===Fr.ScreenDerivative?w`vec3 normal = screenDerivativeNormal(vPositionView);`:w`
                  vec3 normal = normalize(vNormalWorld);
                  if (gl_FrontFacing == false){
                    normal = -normal;
                  }`}
            fragColor = vec4(0.5 + 0.5 * normal, 1.0);
          }
        `);break}case k.Highlight:Eu(r,e),t.include(_c,e),t.include(ag,e),t.include(y0,e),n&&i.uniforms.add(new et("tex",o=>o.texture)),r.code.add(w`
          void main(void) {
            vpos = calculateVPos();
            ${s?"vpos = (model * vec4(vpos, 1.0)).xyz;":""}
            vpos = subtractOrigin(vpos);
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            forwardTextureCoordinates();
          }
        `),t.include(Bs,e),t.include(pT,e),t.include(J0,e),i.code.add(w`
          void main() {
            discardBySlice(vpos);
            ${n?w`
                    vec4 texColor = texture(tex, ${e.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                    discardOrAdjustAlpha(texColor);`:""}
            outputHighlight();
          }
        `)}}function ILe(t,e){const r=t.fragment;e.hasVertexTangents?(t.attributes.add(E.TANGENT,"vec4"),t.varyings.add("vTangent","vec4"),e.doubleSidedMode===bs.WindingOrder?r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = gl_FrontFacing ? vTangent.w : -vTangent.w;
vec3 tangent = normalize(gl_FrontFacing ? vTangent.xyz : -vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`):r.code.add(w`mat3 computeTangentSpace(vec3 normal) {
float tangentHeadedness = vTangent.w;
vec3 tangent = normalize(vTangent.xyz);
vec3 bitangent = cross(normal, tangent) * tangentHeadedness;
return mat3(tangent, bitangent, normal);
}`)):r.code.add(w`mat3 computeTangentSpace(vec3 normal, vec3 pos, vec2 st) {
vec3 Q1 = dFdx(pos);
vec3 Q2 = dFdy(pos);
vec2 stx = dFdx(st);
vec2 sty = dFdy(st);
float det = stx.t * sty.s - sty.t * stx.s;
vec3 T = stx.t * Q2 - sty.t * Q1;
T = T - normal * dot(normal, T);
T *= inversesqrt(max(dot(T,T), 1.e-10));
vec3 B = sign(det) * cross(normal, T);
return mat3(T, B, normal);
}`),e.textureCoordinateType!==sn.None&&(t.include(Vte,e),r.uniforms.add(e.pbrTextureBindType===ai.Pass?new et("normalTexture",i=>i.textureNormal):new Nd("normalTexture",i=>i.textureNormal)),r.code.add(w`vec3 computeTextureNormal(mat3 tangentSpace, vec2 uv) {
vec3 rawNormal = textureLookup(normalTexture, uv).rgb * 2.0 - 1.0;
return tangentSpace * rawNormal;
}`))}function B$(t,e){const r=t.fragment;e.receiveAmbientOcclusion?(r.uniforms.add(new et("ssaoTex",(i,s)=>s.ssaoHelper.colorTexture)),r.constants.add("blurSizePixelsInverse","float",1/mM),r.code.add(w`float evaluateAmbientOcclusionInverse() {
vec2 ssaoTextureSizeInverse = 1.0 / vec2(textureSize(ssaoTex, 0));
return texture(ssaoTex, gl_FragCoord.xy * blurSizePixelsInverse * ssaoTextureSizeInverse).a;
}
float evaluateAmbientOcclusion() {
return 1.0 - evaluateAmbientOcclusionInverse();
}`)):r.code.add(w`float evaluateAmbientOcclusionInverse() { return 1.0; }
float evaluateAmbientOcclusion() { return 0.0; }`)}function G$(t){t.constants.add("ambientBoostFactor","float",L3e)}function PO(t){t.uniforms.add(new Ie("lightingGlobalFactor",(e,r)=>r.lighting.globalFactor))}function JT(t,e){const r=t.fragment;switch(t.include(B$,e),e.pbrMode!==lt.Disabled&&t.include(uie,e),t.include(Gte,e),t.include(S$),r.code.add(w`
    const float GAMMA_SRGB = 2.1;
    const float INV_GAMMA_SRGB = 0.4761904;
    ${e.pbrMode===lt.Disabled?"":"const vec3 GROUND_REFLECTANCE = vec3(0.2);"}
  `),G$(r),PO(r),G0(r),r.code.add(w`
    float additionalDirectedAmbientLight(vec3 vPosWorld) {
      float vndl = dot(${e.spherical?w`normalize(vPosWorld)`:w`vec3(0.0, 0.0, 1.0)`}, mainLightDirection);
      return smoothstep(0.0, 1.0, clamp(vndl * 2.5, 0.0, 1.0));
    }
  `),Fg(r),r.code.add(w`vec3 evaluateAdditionalLighting(float ambientOcclusion, vec3 vPosWorld) {
float additionalAmbientScale = additionalDirectedAmbientLight(vPosWorld);
return (1.0 - ambientOcclusion) * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor * mainLightIntensity;
}`),e.pbrMode){case lt.Disabled:case lt.WaterOnIntegratedMesh:case lt.Water:t.include(dU),r.code.add(w`vec3 evaluateSceneLighting(vec3 normalWorld, vec3 albedo, float shadow, float ssao, vec3 additionalLight)
{
vec3 mainLighting = evaluateMainLighting(normalWorld, shadow);
vec3 ambientLighting = calculateAmbientIrradiance(normalWorld, ssao);
vec3 albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
vec3 totalLight = mainLighting + ambientLighting + additionalLight;
totalLight = min(totalLight, vec3(PI));
vec3 outColor = vec3((albedoLinear / PI) * totalLight);
return pow(outColor, vec3(INV_GAMMA_SRGB));
}`);break;case lt.Normal:case lt.Schematic:r.code.add(w`const float fillLightIntensity = 0.25;
const float horizonLightDiffusion = 0.4;
const float additionalAmbientIrradianceFactor = 0.02;
vec3 evaluateSceneLightingPBR(vec3 normal, vec3 albedo, float shadow, float ssao, vec3 additionalLight, vec3 viewDir, vec3 normalGround, vec3 mrr, vec3 _emission, float additionalAmbientIrradiance)
{
vec3 viewDirection = -viewDir;
vec3 h = normalize(viewDirection + mainLightDirection);
PBRShadingInfo inputs;
inputs.NdotL = clamp(dot(normal, mainLightDirection), 0.001, 1.0);
inputs.NdotV = clamp(abs(dot(normal, viewDirection)), 0.001, 1.0);
inputs.NdotH = clamp(dot(normal, h), 0.0, 1.0);
inputs.VdotH = clamp(dot(viewDirection, h), 0.0, 1.0);
inputs.NdotNG = clamp(dot(normal, normalGround), -1.0, 1.0);
vec3 reflectedView = normalize(reflect(viewDirection, normal));
inputs.RdotNG = clamp(dot(reflectedView, normalGround), -1.0, 1.0);
inputs.albedoLinear = pow(albedo, vec3(GAMMA_SRGB));
inputs.ssao = ssao;
inputs.metalness = mrr[0];
inputs.roughness = clamp(mrr[1] * mrr[1], 0.001, 0.99);`),r.code.add(w`inputs.f0 = (0.16 * mrr[2] * mrr[2]) * (1.0 - inputs.metalness) + inputs.albedoLinear * inputs.metalness;
inputs.f90 = vec3(clamp(dot(inputs.f0, vec3(50.0 * 0.33)), 0.0, 1.0));
inputs.diffuseColor = inputs.albedoLinear * (vec3(1.0) - inputs.f0) * (1.0 - inputs.metalness);`),e.useFillLights?r.uniforms.add(new lg("hasFillLights",(i,s)=>s.enableFillLights)):r.constants.add("hasFillLights","bool",!1),r.code.add(w`vec3 ambientDir = vec3(5.0 * normalGround[1] - normalGround[0] * normalGround[2], - 5.0 * normalGround[0] - normalGround[2] * normalGround[1], normalGround[1] * normalGround[1] + normalGround[0] * normalGround[0]);
ambientDir = ambientDir != vec3(0.0)? normalize(ambientDir) : normalize(vec3(5.0, -1.0, 0.0));
inputs.NdotAmbDir = hasFillLights ? abs(dot(normal, ambientDir)) : 1.0;
vec3 mainLightIrradianceComponent = inputs.NdotL * (1.0 - shadow) * mainLightIntensity;
vec3 fillLightsIrradianceComponent = inputs.NdotAmbDir * mainLightIntensity * fillLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(normal, ssao) + additionalLight;
inputs.skyIrradianceToSurface = ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;
inputs.groundIrradianceToSurface = GROUND_REFLECTANCE * ambientLightIrradianceComponent + mainLightIrradianceComponent + fillLightsIrradianceComponent ;`),r.uniforms.add(new Ie("lightingSpecularStrength",(i,s)=>s.lighting.mainLight.specularStrength),new Ie("lightingEnvironmentStrength",(i,s)=>s.lighting.mainLight.environmentStrength)),r.code.add(w`vec3 horizonRingDir = inputs.RdotNG * normalGround - reflectedView;
vec3 horizonRingH = normalize(viewDirection + horizonRingDir);
inputs.NdotH_Horizon = dot(normal, horizonRingH);
vec3 mainLightRadianceComponent = lightingSpecularStrength * normalDistribution(inputs.NdotH, inputs.roughness) * mainLightIntensity * (1.0 - shadow);
vec3 horizonLightRadianceComponent = lightingEnvironmentStrength * normalDistribution(inputs.NdotH_Horizon, min(inputs.roughness + horizonLightDiffusion, 1.0)) * mainLightIntensity * fillLightIntensity;
vec3 ambientLightRadianceComponent = lightingEnvironmentStrength * calculateAmbientRadiance(ssao) + additionalLight;
inputs.skyRadianceToSurface = ambientLightRadianceComponent + mainLightRadianceComponent + horizonLightRadianceComponent;
inputs.groundRadianceToSurface = GROUND_REFLECTANCE * (ambientLightRadianceComponent + horizonLightRadianceComponent) + mainLightRadianceComponent;
inputs.averageAmbientRadiance = ambientLightIrradianceComponent[1] * (1.0 + GROUND_REFLECTANCE[1]);`),r.code.add(w`
        vec3 reflectedColorComponent = evaluateEnvironmentIllumination(inputs);
        vec3 additionalMaterialReflectanceComponent = inputs.albedoLinear * additionalAmbientIrradiance;
        vec3 emissionComponent = pow(_emission, vec3(GAMMA_SRGB));
        vec3 outColorLinear = reflectedColorComponent + additionalMaterialReflectanceComponent + emissionComponent;
        ${e.pbrMode===lt.Schematic?w`vec3 outColor = pow(max(vec3(0.0), outColorLinear - 0.005 * inputs.averageAmbientRadiance), vec3(INV_GAMMA_SRGB));`:w`vec3 outColor = pow(blackLevelSoftCompression(outColorLinear, inputs), vec3(INV_GAMMA_SRGB));`}
        return outColor;
      }
    `);break;case lt.Terrain:case lt.TerrainWithWater:t.include(dU),r.code.add(w`const float roughnessTerrain = 0.5;
const float specularityTerrain = 0.5;
const vec3 fresnelReflectionTerrain = vec3(0.04);
vec3 evaluateTerrainLighting(vec3 n, vec3 c, float shadow, float ssao, vec3 al, vec3 vd, vec3 nup) {
vec3 viewDirection = -vd;
vec3 h = normalize(viewDirection + mainLightDirection);
float NdotL = clamp(dot(n, mainLightDirection), 0.001, 1.0);
float NdotV = clamp(abs(dot(n, viewDirection)), 0.001, 1.0);
float NdotH = clamp(dot(n, h), 0.0, 1.0);
float NdotNG = clamp(dot(n, nup), -1.0, 1.0);
vec3 albedoLinear = pow(c, vec3(GAMMA_SRGB));
float lightness = 0.3 * albedoLinear[0] + 0.5 * albedoLinear[1] + 0.2 * albedoLinear[2];
vec3 f0 = (0.85 * lightness + 0.15) * fresnelReflectionTerrain;
vec3 f90 =  vec3(clamp(dot(f0, vec3(50.0 * 0.33)), 0.0, 1.0));
vec3 mainLightIrradianceComponent = (1. - shadow) * NdotL * mainLightIntensity;
vec3 ambientLightIrradianceComponent = calculateAmbientIrradiance(n, ssao) + al;
vec3 ambientSky = ambientLightIrradianceComponent + mainLightIrradianceComponent;
vec3 indirectDiffuse = ((1.0 - NdotNG) * mainLightIrradianceComponent + (1.0 + NdotNG ) * ambientSky) * 0.5;
vec3 outDiffColor = albedoLinear * (1.0 - f0) * indirectDiffuse / PI;
vec3 mainLightRadianceComponent = normalDistribution(NdotH, roughnessTerrain) * mainLightIntensity;
vec2 dfg = prefilteredDFGAnalytical(roughnessTerrain, NdotV);
vec3 specularColor = f0 * dfg.x + f90 * dfg.y;
vec3 specularComponent = specularityTerrain * specularColor * mainLightRadianceComponent;
vec3 outColorLinear = outDiffColor + specularComponent;
vec3 outColor = pow(outColorLinear, vec3(INV_GAMMA_SRGB));
return outColor;
}`);break;default:e.pbrMode;case lt.COUNT:}}function Tc(){const t=new Float32Array(9);return t[0]=1,t[4]=1,t[8]=1,t}function PLe(t){const e=new Float32Array(9);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[8]=t[8],e}function u5(t,e,r,i,s,n,o,a,l){const c=new Float32Array(9);return c[0]=t,c[1]=e,c[2]=r,c[3]=i,c[4]=s,c[5]=n,c[6]=o,c[7]=a,c[8]=l,c}function Kwt(t,e){return new Float32Array(t,e,9)}Object.freeze(Object.defineProperty({__proto__:null,clone:PLe,create:Tc,createView:Kwt,fromValues:u5},Symbol.toStringTag,{value:"Module"}));function ext(t){t.vertex.uniforms.add(new tp("colorTextureTransformMatrix",e=>e.colorTextureTransformMatrix!=null?e.colorTextureTransformMatrix:Tc())),t.varyings.add("colorUV","vec2"),t.vertex.code.add(w`void forwardColorUV(){
colorUV = (colorTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function txt(t){t.vertex.uniforms.add(new tp("normalTextureTransformMatrix",e=>e.normalTextureTransformMatrix!=null?e.normalTextureTransformMatrix:Tc())),t.varyings.add("normalUV","vec2"),t.vertex.code.add(w`void forwardNormalUV(){
normalUV = (normalTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function rxt(t){t.vertex.uniforms.add(new tp("emissiveTextureTransformMatrix",e=>e.emissiveTextureTransformMatrix!=null?e.emissiveTextureTransformMatrix:Tc())),t.varyings.add("emissiveUV","vec2"),t.vertex.code.add(w`void forwardEmissiveUV(){
emissiveUV = (emissiveTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function ixt(t){t.vertex.uniforms.add(new tp("occlusionTextureTransformMatrix",e=>e.occlusionTextureTransformMatrix!=null?e.occlusionTextureTransformMatrix:Tc())),t.varyings.add("occlusionUV","vec2"),t.vertex.code.add(w`void forwardOcclusionUV(){
occlusionUV = (occlusionTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function sxt(t){t.vertex.uniforms.add(new tp("metallicRoughnessTextureTransformMatrix",e=>e.metallicRoughnessTextureTransformMatrix!=null?e.metallicRoughnessTextureTransformMatrix:Tc())),t.varyings.add("metallicRoughnessUV","vec2"),t.vertex.code.add(w`void forwardMetallicRoughnessUV(){
metallicRoughnessUV = (metallicRoughnessTextureTransformMatrix * vec3(vuv0, 1.0)).xy;
}`)}function OP(t){t.include(kg),t.code.add(w`
    vec3 mixExternalColor(vec3 internalColor, vec3 textureColor, vec3 externalColor, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      vec3 internalMixed = internalColor * textureColor;
      vec3 allMixed = internalMixed * externalColor;

      if (mode == ${w.int(pn.Multiply)}) {
        return allMixed;
      }
      if (mode == ${w.int(pn.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(pn.Replace)}) {
        return externalColor;
      }

      // tint (or something invalid)
      float vIn = rgb2v(internalMixed);
      vec3 hsvTint = rgb2hsv(externalColor);
      vec3 hsvOut = vec3(hsvTint.x, hsvTint.y, vIn * hsvTint.z);
      return hsv2rgb(hsvOut);
    }

    float mixExternalOpacity(float internalOpacity, float textureOpacity, float externalOpacity, int mode) {
      // workaround for artifacts in OSX using Intel Iris Pro
      // see: https://devtopia.esri.com/WebGIS/arcgis-js-api/issues/10475
      float internalMixed = internalOpacity * textureOpacity;
      float allMixed = internalMixed * externalOpacity;

      if (mode == ${w.int(pn.Ignore)}) {
        return internalMixed;
      }
      if (mode == ${w.int(pn.Replace)}) {
        return externalOpacity;
      }

      // multiply or tint (or something invalid)
      return allMixed;
    }
  `)}function nxt(t){const e=new Cr,{vertex:r,fragment:i,varyings:s}=e;if(Eu(r,t),e.include(E$),s.add("vpos","vec3"),e.include(y0,t),e.include(CLe,t),e.include(BIe,t),t.hasColorTextureTransform&&e.include(ext),t.output===k.Color||t.output===k.Alpha){t.hasNormalTextureTransform&&e.include(txt),t.hasEmissionTextureTransform&&e.include(rxt),t.hasOcclusionTextureTransform&&e.include(ixt),t.hasMetallicRoughnessTextureTransform&&e.include(sxt),kf(r,t),e.include(V$,t),e.include(_c,t);const n=t.normalType===Fr.Attribute||t.normalType===Fr.Compressed;n&&t.offsetBackfaces&&e.include(ELe),e.include(ILe,t),e.include(B8,t),t.instancedColor&&e.attributes.add(E.INSTANCECOLOR,"vec4"),s.add("vPositionLocal","vec3"),e.include(ag,t),e.include(TO,t),e.include(OLe,t),e.include(xS,t),r.uniforms.add(new cr("externalColor",a=>a.externalColor)),s.add("vcolorExt","vec4"),t.hasMultipassTerrain&&s.add("depth","float");const o=t.hasModelTransformation;if(o){const a=ts();r.uniforms.add(new es("model",l=>l.modelTransformation??Un)),r.uniforms.add(new tp("normalTransform",l=>(Z1(a,l.modelTransformation??Un),a)))}r.code.add(w`
      void main(void) {
        forwardNormalizedVertexColor();
        vcolorExt = externalColor;
        ${t.instancedColor?"vcolorExt *= instanceColor * 0.003921568627451;":""}
        vcolorExt *= vvColor();
        vcolorExt *= getSymbolColor();
        forwardColorMixMode();

        if (vcolorExt.a < ${w.float(ia)}) {
          gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        } else {
          vpos = calculateVPos();
          ${o?"vpos = (model * vec4(vpos, 1.0)).xyz;":""}
          vPositionLocal = vpos - view[3].xyz;
          vpos = subtractOrigin(vpos);
          ${n?w`vNormalWorld = ${o?"normalize(normalTransform * dpNormal(vvLocalNormal(normalModel())))":"dpNormal(vvLocalNormal(normalModel()))"};`:""}
          vpos = addVerticalOffset(vpos, localOrigin);
          ${t.hasVertexTangents?"vTangent = dpTransformVertexTangent(tangent);":""}
          gl_Position = transformPosition(proj, view, vpos);
          ${n&&t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
        }

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        forwardLinearDepth();
        forwardTextureCoordinates();
        ${t.hasColorTextureTransform?w`forwardColorUV();`:""}
        ${t.hasNormalTextureTransform?w`forwardNormalUV();`:""}
        ${t.hasEmissionTextureTransform?w`forwardEmissiveUV();`:""}
        ${t.hasOcclusionTextureTransform?w`forwardOcclusionUV();`:""}
        ${t.hasMetallicRoughnessTextureTransform?w`forwardMetallicRoughnessUV();`:""}
      }
    `)}switch(t.output){case k.Alpha:e.include(Bs,t),e.include(pT,t),e.include(Ah,t),i.uniforms.add(new Ie("opacity",n=>n.opacity),new Ie("layerOpacity",n=>n.layerOpacity)),t.hasColorTexture&&i.uniforms.add(new et("tex",n=>n.texture)),i.include(OP),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        fragColor = vec4(opacity_);
      }
    `);break;case k.Color:e.include(Bs,t),e.include(JT,t),e.include(B$,t),e.include(pT,t),e.include(t.instancedDoublePrecision?G8:XT,t),e.include(Ah,t),kf(i,t),i.uniforms.add(r.uniforms.get("localOrigin"),new jt("ambient",n=>n.ambient),new jt("diffuse",n=>n.diffuse),new Ie("opacity",n=>n.opacity),new Ie("layerOpacity",n=>n.layerOpacity)),t.hasColorTexture&&i.uniforms.add(new et("tex",n=>n.texture)),e.include(Bte,t),e.include(uie,t),i.include(OP),e.include(TLe,t),G$(i),PO(i),Fg(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        shadingParams.viewDirection = normalize(vpos - cameraPosition);
        ${t.normalType===Fr.ScreenDerivative?w`
                vec3 normal = screenDerivativeNormal(vPositionLocal);`:w`
                shadingParams.normalView = vNormalWorld;
                vec3 normal = shadingNormal(shadingParams);`}
        ${t.pbrMode===lt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        vec3 posWorld = vpos + localOrigin;

        float additionalAmbientScale = additionalDirectedAmbientLight(posWorld);
        float shadow = ${t.receiveShadows?"readShadowMap(vpos, linearDepth)":t.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.hasNormalTexture?w`
                mat3 tangentSpace = ${t.hasVertexTangents?"computeTangentSpace(normal);":"computeTangentSpace(normal, vpos, vuv0);"}
                vec3 shadingNormal = computeTextureNormal(tangentSpace, ${t.hasNormalTextureTransform?w`normalUV`:"vuv0"});`:w`vec3 shadingNormal = normal;`}
        vec3 normalGround = ${t.spherical?w`normalize(posWorld);`:w`vec3(0.0, 0.0, 1.0);`}

        ${t.snowCover?w`
                float snow = smoothstep(0.5, 0.55, dot(normal, normalGround));
                albedo = mix(albedo, vec3(1), snow);
                shadingNormal = mix(shadingNormal, normal, snow);
                ssao = mix(ssao, 1.0, snow);`:""}

        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

        ${t.pbrMode===lt.Normal||t.pbrMode===lt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                        emission = mix(emission, vec3(0.0), snow);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, shadingParams.viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        fragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===ut.Color?w`fragColor = premultiplyAlpha(fragColor);`:""}
      }
    `)}return e.include(MLe,t),e}const oxt=Object.freeze(Object.defineProperty({__proto__:null,build:nxt},Symbol.toStringTag,{value:"Module"}));let axt=class extends rLe{constructor(){super(...arguments),this.isSchematic=!1,this.usePBR=!1,this.mrrFactors=Ml(H8),this.hasVertexColors=!1,this.hasSymbolColors=!1,this.doubleSided=!1,this.doubleSidedType="normal",this.cullFace=Ii.Back,this.isInstanced=!1,this.hasInstancedColor=!1,this.emissiveFactor=Ee(0,0,0),this.instancedDoublePrecision=!1,this.normalType=Fr.Attribute,this.receiveSSAO=!0,this.receiveShadows=!0,this.castShadows=!0,this.shadowMappingEnabled=!1,this.ambient=Ee(.2,.2,.2),this.diffuse=Ee(.8,.8,.8),this.externalColor=Vt(1,1,1,1),this.colorMixMode="multiply",this.opacity=1,this.layerOpacity=1,this.origin=C(),this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.offsetTransparentBackfaces=!1,this.vvSize=null,this.vvColor=null,this.vvOpacity=null,this.vvSymbolAnchor=null,this.vvSymbolRotationMatrix=null,this.modelTransformation=null,this.transparent=!1,this.writeDepth=!0,this.customDepthTest=UT.Less,this.textureAlphaMode=ni.Blend,this.textureAlphaCutoff=BU,this.textureAlphaPremultiplied=!1,this.hasOccludees=!1,this.renderOccluded=Qi.Occlude}},lxt=class extends iLe{constructor(){super(...arguments),this.origin=C(),this.slicePlaneLocalOrigin=this.origin}},bie=class $Le extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result,r.textureCoordinateType=r.hasColorTexture||r.hasMetallicRoughnessTexture||r.hasEmissionTexture||r.hasOcclusionTexture||r.hasNormalTexture?sn.Default:sn.None,r.objectAndLayerIdColorInstanced=r.instanced}initializeProgram(e){return this._initializeProgram(e,$Le.shader)}_initializeProgram(e,r){return new Lr(e.rctx,r.get().build(this.configuration),Er)}_convertDepthTestFunction(e){return e===UT.Lequal?ci.LEQUAL:ci.LESS}_makePipeline(e,r){const i=this.configuration,s=e===ut.NONE,n=e===ut.FrontFace;return It({blending:i.output!==k.Color&&i.output!==k.Alpha||!i.transparent?null:s?vh:Q0(e),culling:cxt(i)?n8(i.cullFace):null,depthTest:{func:gb(e,this._convertDepthTestFunction(i.customDepthTest))},depthWrite:(s||n)&&i.writeDepth?Ac:null,colorWrite:Wt,stencilWrite:i.hasOccludees?Og:null,stencilTest:i.hasOccludees?r?nb:yb:null,polygonOffset:s||n?null:L8(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._makePipeline(this.configuration.transparencyPassType,!0),this._makePipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};function cxt(t){return t.cullFace!==Ii.None||!t.hasSlicePlane&&!t.transparent&&!t.doubleSidedMode}bie.shader=new $r(oxt,()=>J(()=>import("./DefaultMaterial.glsl-a9d9e759.js"),[],import.meta.url));let Zt=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.alphaDiscardMode=ni.Opaque,this.doubleSidedMode=bs.None,this.pbrMode=lt.Disabled,this.cullFace=Ii.None,this.transparencyPassType=ut.NONE,this.normalType=Fr.Attribute,this.textureCoordinateType=sn.None,this.customDepthTest=UT.Less,this.spherical=!1,this.hasVertexColors=!1,this.hasSymbolColors=!1,this.hasVerticalOffset=!1,this.hasSlicePlane=!1,this.hasSliceHighlight=!0,this.hasColorTexture=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasScreenSizePerspective=!1,this.hasVertexTangents=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.hasModelTransformation=!1,this.offsetBackfaces=!1,this.vvSize=!1,this.vvColor=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.textureAlphaPremultiplied=!1,this.instanced=!1,this.instancedColor=!1,this.objectAndLayerIdColorInstanced=!1,this.instancedDoublePrecision=!1,this.doublePrecisionRequiresObfuscation=!1,this.writeDepth=!0,this.transparent=!1,this.enableOffset=!0,this.cullAboveGround=!1,this.snowCover=!1,this.hasColorTextureTransform=!1,this.hasEmissionTextureTransform=!1,this.hasNormalTextureTransform=!1,this.hasOcclusionTextureTransform=!1,this.hasMetallicRoughnessTextureTransform=!1}};u([B({count:k.COUNT})],Zt.prototype,"output",void 0),u([B({count:ni.COUNT})],Zt.prototype,"alphaDiscardMode",void 0),u([B({count:bs.COUNT})],Zt.prototype,"doubleSidedMode",void 0),u([B({count:lt.COUNT})],Zt.prototype,"pbrMode",void 0),u([B({count:Ii.COUNT})],Zt.prototype,"cullFace",void 0),u([B({count:ut.COUNT})],Zt.prototype,"transparencyPassType",void 0),u([B({count:Fr.COUNT})],Zt.prototype,"normalType",void 0),u([B({count:sn.COUNT})],Zt.prototype,"textureCoordinateType",void 0),u([B({count:UT.COUNT})],Zt.prototype,"customDepthTest",void 0),u([B()],Zt.prototype,"spherical",void 0),u([B()],Zt.prototype,"hasVertexColors",void 0),u([B()],Zt.prototype,"hasSymbolColors",void 0),u([B()],Zt.prototype,"hasVerticalOffset",void 0),u([B()],Zt.prototype,"hasSlicePlane",void 0),u([B()],Zt.prototype,"hasSliceHighlight",void 0),u([B()],Zt.prototype,"hasColorTexture",void 0),u([B()],Zt.prototype,"hasMetallicRoughnessTexture",void 0),u([B()],Zt.prototype,"hasEmissionTexture",void 0),u([B()],Zt.prototype,"hasOcclusionTexture",void 0),u([B()],Zt.prototype,"hasNormalTexture",void 0),u([B()],Zt.prototype,"hasScreenSizePerspective",void 0),u([B()],Zt.prototype,"hasVertexTangents",void 0),u([B()],Zt.prototype,"hasOccludees",void 0),u([B()],Zt.prototype,"hasMultipassTerrain",void 0),u([B()],Zt.prototype,"hasModelTransformation",void 0),u([B()],Zt.prototype,"offsetBackfaces",void 0),u([B()],Zt.prototype,"vvSize",void 0),u([B()],Zt.prototype,"vvColor",void 0),u([B()],Zt.prototype,"receiveShadows",void 0),u([B()],Zt.prototype,"receiveAmbientOcclusion",void 0),u([B()],Zt.prototype,"textureAlphaPremultiplied",void 0),u([B()],Zt.prototype,"instanced",void 0),u([B()],Zt.prototype,"instancedColor",void 0),u([B()],Zt.prototype,"objectAndLayerIdColorInstanced",void 0),u([B()],Zt.prototype,"instancedDoublePrecision",void 0),u([B()],Zt.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B()],Zt.prototype,"writeDepth",void 0),u([B()],Zt.prototype,"transparent",void 0),u([B()],Zt.prototype,"enableOffset",void 0),u([B()],Zt.prototype,"cullAboveGround",void 0),u([B()],Zt.prototype,"snowCover",void 0),u([B()],Zt.prototype,"hasColorTextureTransform",void 0),u([B()],Zt.prototype,"hasEmissionTextureTransform",void 0),u([B()],Zt.prototype,"hasNormalTextureTransform",void 0),u([B()],Zt.prototype,"hasOcclusionTextureTransform",void 0),u([B()],Zt.prototype,"hasMetallicRoughnessTextureTransform",void 0),u([B({constValue:!0})],Zt.prototype,"hasVvInstancing",void 0),u([B({constValue:!1})],Zt.prototype,"useCustomDTRExponentForWater",void 0),u([B({constValue:!1})],Zt.prototype,"supportsTextureAtlas",void 0),u([B({constValue:!0})],Zt.prototype,"useFillLights",void 0);function uxt(t){const e=new Cr,{vertex:r,fragment:i,varyings:s}=e;return Eu(r,t),e.include(E$),s.add("vpos","vec3"),e.include(y0,t),e.include(CLe,t),e.include(BIe,t),t.output!==k.Color&&t.output!==k.Alpha||(kf(e.vertex,t),e.include(V$,t),e.include(_c,t),t.offsetBackfaces&&e.include(ELe),t.instancedColor&&e.attributes.add(E.INSTANCECOLOR,"vec4"),s.add("vNormalWorld","vec3"),s.add("localvpos","vec3"),t.hasMultipassTerrain&&s.add("depth","float"),e.include(ag,t),e.include(TO,t),e.include(OLe,t),e.include(xS,t),r.uniforms.add(new cr("externalColor",n=>n.externalColor)),s.add("vcolorExt","vec4"),r.code.add(w`
        void main(void) {
          forwardNormalizedVertexColor();
          vcolorExt = externalColor;
          ${t.instancedColor?"vcolorExt *= instanceColor * 0.003921568627451;":""}
          vcolorExt *= vvColor();
          vcolorExt *= getSymbolColor();
          forwardColorMixMode();

          if (vcolorExt.a < ${w.float(ia)}) {
            gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
          } else {
            vpos = calculateVPos();
            localvpos = vpos - view[3].xyz;
            vpos = subtractOrigin(vpos);
            vNormalWorld = dpNormal(vvLocalNormal(normalModel()));
            vpos = addVerticalOffset(vpos, localOrigin);
            gl_Position = transformPosition(proj, view, vpos);
            ${t.offsetBackfaces?"gl_Position = offsetBackfacingClipPosition(gl_Position, vpos, vNormalWorld, cameraPosition);":""}
          }
          ${t.hasMultipassTerrain?w`depth = (view * vec4(vpos, 1.0)).z;`:""}
          forwardLinearDepth();
          forwardTextureCoordinates();
        }
      `)),t.output===k.Alpha&&(e.include(Bs,t),e.include(pT,t),e.include(Ah,t),i.uniforms.add(new Ie("opacity",n=>n.opacity),new Ie("layerOpacity",n=>n.layerOpacity)),t.hasColorTexture&&i.uniforms.add(new et("tex",n=>n.texture)),i.include(OP),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        ${t.hasVertexColors?w`float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}

        fragColor = vec4(opacity_);
      }
    `)),t.output===k.Color&&(e.include(Bs,t),e.include(JT,t),e.include(B$,t),e.include(pT,t),e.include(t.instancedDoublePrecision?G8:XT,t),e.include(Ah,t),kf(e.fragment,t),G0(i),G$(i),PO(i),i.uniforms.add(r.uniforms.get("localOrigin"),r.uniforms.get("view"),new jt("ambient",n=>n.ambient),new jt("diffuse",n=>n.diffuse),new Ie("opacity",n=>n.opacity),new Ie("layerOpacity",n=>n.layerOpacity)),t.hasColorTexture&&i.uniforms.add(new et("tex",n=>n.texture)),e.include(Bte,t),e.include(uie,t),i.include(OP),Fg(i),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, depth);`:""}
        ${t.hasColorTexture?w`
                vec4 texColor = texture(tex, ${t.hasColorTextureTransform?w`colorUV`:w`vuv0`});
                ${t.textureAlphaPremultiplied?"texColor.rgb /= texColor.a;":""}
                discardOrAdjustAlpha(texColor);`:w`vec4 texColor = vec4(1.0);`}
        vec3 viewDirection = normalize(vpos - cameraPosition);
        ${t.pbrMode===lt.Normal?"applyPBRFactors();":""}
        float ssao = evaluateAmbientOcclusionInverse();
        ssao *= getBakedOcclusion();

        float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
        vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
        ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
        vec3 matColor = max(ambient, diffuse);
        ${t.hasVertexColors?w`
                vec3 albedo = mixExternalColor(vColor.rgb * matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(vColor.a * opacity, texColor.a, vcolorExt.a, int(colorMixMode));`:w`
                vec3 albedo = mixExternalColor(matColor, texColor.rgb, vcolorExt.rgb, int(colorMixMode));
                float opacity_ = layerOpacity * mixExternalOpacity(opacity, texColor.a, vcolorExt.a, int(colorMixMode));`}
        ${t.snowCover?w`albedo = mix(albedo, vec3(1), 0.9);`:w``}
        ${w`
            vec3 shadingNormal = normalize(vNormalWorld);
            albedo *= 1.2;
            vec3 viewForward = vec3(view[0][2], view[1][2], view[2][2]);
            float alignmentLightView = clamp(dot(viewForward, -mainLightDirection), 0.0, 1.0);
            float transmittance = 1.0 - clamp(dot(viewForward, shadingNormal), 0.0, 1.0);
            float treeRadialFalloff = vColor.r;
            float backLightFactor = 0.5 * treeRadialFalloff * alignmentLightView * transmittance * (1.0 - shadow);
            additionalLight += backLightFactor * mainLightIntensity;`}
        ${t.pbrMode===lt.Normal||t.pbrMode===lt.Schematic?t.spherical?w`vec3 normalGround = normalize(vpos + localOrigin);`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`:w``}
        ${t.pbrMode===lt.Normal||t.pbrMode===lt.Schematic?w`
                float additionalAmbientIrradiance = additionalAmbientIrradianceFactor * mainLightIntensity[2];
                ${t.snowCover?w`
                        mrr = vec3(0.0, 1.0, 0.04);
                        emission = vec3(0.0);`:""}

                vec3 shadedColor = evaluateSceneLightingPBR(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight, viewDirection, normalGround, mrr, emission, additionalAmbientIrradiance);`:w`vec3 shadedColor = evaluateSceneLighting(shadingNormal, albedo, shadow, 1.0 - ssao, additionalLight);`}
        fragColor = highlightSlice(vec4(shadedColor, opacity_), vpos);
        ${t.transparencyPassType===ut.Color?w`fragColor = premultiplyAlpha(fragColor);`:w``}
      }
    `)),e.include(MLe,t),e}const hxt=Object.freeze(Object.defineProperty({__proto__:null,build:uxt},Symbol.toStringTag,{value:"Module"}));let LLe=class DLe extends bie{initializeConfiguration(e,r){super.initializeConfiguration(e,r),r.hasMetallicRoughnessTexture=!1,r.hasEmissionTexture=!1,r.hasOcclusionTexture=!1,r.hasNormalTexture=!1,r.hasModelTransformation=!1,r.normalType=Fr.Attribute,r.doubleSidedMode=bs.WindingOrder,r.hasVertexTangents=!1}initializeProgram(e){return this._initializeProgram(e,DLe.shader)}};LLe.shader=new $r(hxt,()=>J(()=>import("./RealisticTree.glsl-8de49cbd.js"),[],import.meta.url));let Rg=class extends mb{constructor(e){super(e,fxt),this.supportsEdges=!0,this._configuration=new Zt,this._vertexBufferLayout=mxt(this.parameters)}isVisibleForOutput(e){return e!==k.Shadow&&e!==k.ShadowExcludeHighlight&&e!==k.ShadowHighlight||this.parameters.castShadows}isVisible(){const e=this.parameters;if(!super.isVisible()||e.layerOpacity===0)return!1;const{hasInstancedColor:r,hasVertexColors:i,hasSymbolColors:s,vvColor:n}=e,o=e.colorMixMode==="replace",a=e.opacity>0,l=e.externalColor&&e.externalColor[3]>0,c=r||n||s;return i&&c?o||a:i?o?l:a:c?o||a:o?l:a}getConfiguration(e,r){return this._configuration.output=e,this._configuration.hasNormalTexture=!!this.parameters.normalTextureId,this._configuration.hasColorTexture=!!this.parameters.textureId,this._configuration.hasVertexTangents=this.parameters.hasVertexTangents,this._configuration.instanced=this.parameters.isInstanced,this._configuration.instancedDoublePrecision=this.parameters.instancedDoublePrecision,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.hasVerticalOffset=this.parameters.verticalOffset!=null,this._configuration.hasScreenSizePerspective=this.parameters.screenSizePerspective!=null,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasSliceHighlight=this.parameters.hasSliceHighlight,this._configuration.alphaDiscardMode=this.parameters.textureAlphaMode,this._configuration.normalType=this.parameters.normalType,this._configuration.transparent=this.parameters.transparent,this._configuration.writeDepth=this.parameters.writeDepth,this.parameters.customDepthTest!=null&&(this._configuration.customDepthTest=this.parameters.customDepthTest),this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.cullFace=this.parameters.hasSlicePlane?Ii.None:this.parameters.cullFace,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.hasModelTransformation=this.parameters.modelTransformation!=null,e!==k.Color&&e!==k.Alpha||(this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.hasSymbolColors=this.parameters.hasSymbolColors,this.parameters.treeRendering?this._configuration.doubleSidedMode=bs.WindingOrder:this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?bs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?bs.WindingOrder:bs.None,this._configuration.instancedColor=this.parameters.hasInstancedColor,this._configuration.receiveShadows=this.parameters.receiveShadows&&this.parameters.shadowMappingEnabled,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.textureAlphaPremultiplied=!!this.parameters.textureAlphaPremultiplied,this._configuration.pbrMode=this.parameters.usePBR?this.parameters.isSchematic?lt.Schematic:lt.Normal:lt.Disabled,this._configuration.hasMetallicRoughnessTexture=!!this.parameters.metallicRoughnessTextureId,this._configuration.hasEmissionTexture=!!this.parameters.emissiveTextureId,this._configuration.hasOcclusionTexture=!!this.parameters.occlusionTextureId,this._configuration.offsetBackfaces=!(!this.parameters.transparent||!this.parameters.offsetTransparentBackfaces),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<P8,this._configuration.snowCover=this.hasSnowCover(r),this._configuration.hasColorTextureTransform=!!this.parameters.colorTextureTransformMatrix,this._configuration.hasNormalTextureTransform=!!this.parameters.normalTextureTransformMatrix,this._configuration.hasEmissionTextureTransform=!!this.parameters.emissiveTextureTransformMatrix,this._configuration.hasOcclusionTextureTransform=!!this.parameters.occlusionTextureTransformMatrix,this._configuration.hasMetallicRoughnessTextureTransform=!!this.parameters.metallicRoughnessTextureTransformMatrix),this._configuration}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}intersect(e,r,i,s,n,o){if(this.parameters.verticalOffset!=null){const a=i.camera;ie(_G,r[12],r[13],r[14]);let l=null;switch(i.viewingMode){case Ue.Global:l=_e(tfe,_G);break;case Ue.Local:l=oe(tfe,_xt)}let c=0;const h=pe(vxt,_G,a.eye),p=Oe(h),f=ae(h,h,1/p);let m=null;this.parameters.screenSizePerspective&&(m=de(l,f)),c+=XIe(a,p,this.parameters.verticalOffset,m??0,this.parameters.screenSizePerspective),ae(l,l,c),yu(yG,l,i.transform.inverseRotation),s=pe(gxt,s,yG),n=pe(yxt,n,yG)}HIe(e,i,s,n,lY(i.verticalOffset),o)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Depth||r===k.Normal||r===k.Shadow||r===k.ShadowHighlight||r===k.ShadowExcludeHighlight||r===k.Highlight||r===k.ObjectAndLayerIdColor?e===(this.parameters.transparent?this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:fe.OPAQUE_MATERIAL)||e===fe.DRAPED_MATERIAL:!1}createGLMaterial(e){return new dxt(e)}createBufferWriter(){return new IO(this._vertexBufferLayout)}},dxt=class extends zte{constructor(e){super({...e,...e.material.parameters})}_updateShadowState(e){e.shadowMap.enabled!==this._material.parameters.shadowMappingEnabled&&this._material.setParameters({shadowMappingEnabled:e.shadowMap.enabled})}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output!==k.Color&&this._output!==k.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e));const r=this._material.parameters;this.updateTexture(r.textureId);const i=e.camera.viewInverseTransposeMatrix;return ie(r.origin,i[3],i[7],i[11]),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(r.treeRendering?LLe:bie,e)}},pxt=class extends axt{constructor(){super(...arguments),this.initTextureTransparent=!1,this.treeRendering=!1,this.hasVertexTangents=!1}};const fxt=new pxt;function mxt(t){const e=us().vec3f(E.POSITION);return t.normalType===Fr.Compressed?e.vec2i16(E.NORMALCOMPRESSED,{glNormalized:!0}):e.vec3f(E.NORMAL),t.hasVertexTangents&&e.vec4f(E.TANGENT),(t.textureId||t.normalTextureId||t.metallicRoughnessTextureId||t.emissiveTextureId||t.occlusionTextureId)&&e.vec2f(E.UV0),t.hasVertexColors&&e.vec4u8(E.COLOR),t.hasSymbolColors&&e.vec4u8(E.SYMBOLCOLOR),le("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(E.OBJECTANDLAYERIDCOLOR),e}const gxt=C(),yxt=C(),_xt=Ee(0,0,1),tfe=C(),yG=C(),_G=C(),vxt=C(),bxt=["polygon","extent"];let wxt=class extends Vg{constructor(e,r,i,s){super(e,r,i,s),this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const a=D8(this._getSymbolSize());if(a)throw new D("graphics3dextrudesymbollayer:invalid-size",a)}const e=this.symbolLayer?.material?.color,r=this._getCombinedOpacityAndColor(e),i=Ml(r),s=r[3],n=s<1||this.needsDrivenTransparentPass,o={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,diffuse:i,ambient:i,opacity:s,transparent:n,cullFace:n?Ii.None:Ii.Back,hasVertexColors:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!0,normalType:Fr.Compressed};this._material=new Rg(o),this._bottomMaterial=new Rg({...o,cullFace:Ii.Back}),this._context.stage.add(this._material),this._context.stage.add(this._bottomMaterial)}destroy(){super.destroy(),this._material&&(this._context.stage.remove(this._material),this._context.stage.remove(this._bottomMaterial))}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,bxt,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Gf);return this._createAs3DShape(r,e.renderingInfo,i,s,r.uid)}layerOpacityChanged(e,r){const i=this.symbolLayer?.material?.color,s=this._getCombinedOpacity(i),n=s<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:s,transparent:n}),this._bottomMaterial.setParameters({opacity:s,transparent:n});const o=this._getLayerOpacity();e.forEach(a=>{const l=r(a);l?.layerOpacityChanged(o,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,ib)}slicePlaneEnabledChanged(e,r){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._bottomMaterial.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),e.forEach(i=>{const s=r(i);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._bottomMaterial.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}_getExtrusionSize(e){let r;return r=e.size&&this._drivenProperties.size?J1t(e.size,2)??0:this._getSymbolSize(),r/=this._context.renderCoordsHelper.unitInMeters,r}applyRendererDiff(e,r){return this._drivenPropertiesChanged(r)?on.RecreateSymbol:on.RecreateGraphics}async queryForSnapping(e,r,i,s){const n=this._getExtrusionSize(i)*this._context.renderCoordsHelper.unitInMeters/VI(r),{objectId:o,target:a}=e,l=re(a);switch(l.z=(l.z??0)+n,e.type){case"edge":{const{start:c,end:h}=e,p=re(c),f=re(h);return p.z=(p.z??0)+n,f.z=(f.z??0)+n,[vpe(o,l,1/0,p,f)]}case"vertex":return[Z1t(o,l,1/0),vpe(o,a,1/0,a,l)];default:return[]}}_getSymbolSize(){return this.symbolLayer.size??1}_createAs3DShape(e,r,i,s,n){const o=CP(e.geometry);if(o==null)return null;if(o.rings.length===0||!o.rings.some(P=>P.length>0))return this._logGeometryValidationWarnings(o.rings,"rings","ExtrudeSymbol3DLayer"),null;const a=yie(o,this._context.elevationProvider,this._context.renderCoordsHelper,s);this._logGeometryCreationWarnings(a,o.rings,"rings","ExtrudeSymbol3DLayer");const l=Bre(o);if(l==null)return null;const c=new Array,h=new Array,p=Gn(),f=xe(),m=C(),g=this._context.renderCoordsHelper.viewingMode===Ue.Global;g||this._context.renderCoordsHelper.worldUpAtPosition(null,m),wc(o.spatialReference,[l.x,l.y,0],f,this._context.renderCoordsHelper.spatialReference);const _=xe();so(_,f);const v=ts();Z1(v,_);const{polygons:b,mapPositions:x,position:T}=a;for(const P of b){const F=P.count;if(this._context.clippingExtent&&(Gi(p),fh(p,P.mapPositions),!cf(p,this._context.clippingExtent)))continue;const $=zA(P.mapPositions,P.holeIndices,3);if($.length===0)continue;const N=$.length,U=6*F,X=wU(U+N),Z=wU(N),G=Ra(3*U),ee=Ra(3*U),I=Ra(3*U),V=Ra(U);xxt(T,x,$,P,G,I,ee,V,X,Z,this._getExtrusionSize(r),m,g),BA(G,G,_);const z=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:n,layerUid:this._context.layer.uid}),H=new Axt(G,I,Wwt(ee),V);c.push(rfe(this._material,X,X.length-Z.length,H,i,z),rfe(this._bottomMaterial,Z,0,H,i,z)),h.push(H.heights)}if(c.length===0)return null;const S=new K0({geometries:c,layerUid:this._context.layer.uid,graphicUid:n,isElevationSource:!0});S.transformation=f;const O=TOe(this.symbolLayer,{opacity:this._getLayerOpacity()}),A=O!=null?{baseMaterial:this._material,edgeMaterials:[O],properties:{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}}:null,M=new Ug(this,S,c,null,null,(P,F,$,N,U)=>Ext(P,F,$,N,U,h),s,A);return M.alignedSampledElevation=a.sampledElevation,M.needsElevationUpdates=ib(s.mode),M}};function rfe(t,e,r,i,s,n){const o=SO(e.length),a=[[E.POSITION,new Ge(i.positions,3,!0)],[E.NORMALCOMPRESSED,new Ge(i.normals,2,!0)],[E.COLOR,new Ge(s,4,!0)]],l=[[E.POSITION,e],[E.NORMALCOMPRESSED,e],[E.COLOR,o]];return new mn(t,a,l,i.elevation,Ms.Mesh,n,r)}function xxt(t,e,r,i,s,n,o,a,l,c,h,p,f){const m=r.length/3;let g=0,_=2*i.count;Txt(t,e,i.index,i.count,r,0,m,s,n,o,a,l,c,_,h,p,f);let v=2*i.count;_=0,ife(s,n,a,o,g,i.pathLengths[0],i.count,v,l,_,h),v+=4*i.pathLengths[0],_+=2*i.pathLengths[0],g+=i.pathLengths[0];for(let b=1;b<i.pathLengths.length;++b)ife(s,n,a,o,g,i.pathLengths[b],i.count,v,l,_,h),v+=4*i.pathLengths[b],_+=2*i.pathLengths[b],g+=i.pathLengths[b]}function Txt(t,e,r,i,s,n,o,a,l,c,h,p,f,m,g,_,v){oe(Jl,_);const b=g>0?1:-1;let x=3*r,T=0,S=3*T,O=i,A=3*O;for(let F=0;F<i;++F)v&&(Jl[0]=t[x],Jl[1]=t[x+1],Jl[2]=t[x+2],_e(Jl,Jl)),a[S]=t[x],a[S+1]=t[x+1],a[S+2]=t[x+2],l[S]=e[x],l[S+1]=e[x+1],l[S+2]=e[x+2],c[S]=-b*Jl[0],c[S+1]=-b*Jl[1],c[S+2]=-b*Jl[2],h[T]=0,a[A]=t[x]+g*Jl[0],a[A+1]=t[x+1]+g*Jl[1],a[A+2]=t[x+2]+g*Jl[2],l[A]=e[x],l[A+1]=e[x+1],l[A+2]=e[x+2],c[A]=b*Jl[0],c[A+1]=b*Jl[1],c[A+2]=b*Jl[2],h[O]=g,S+=3,A+=3,x+=3,T+=1,O+=1;x=3*n,S=0,A=3*m;const M=g<0?cfe:lfe,P=g<0?lfe:cfe;for(let F=0;F<o;++F)f[S]=s[x+M[0]],f[S+1]=s[x+M[1]],f[S+2]=s[x+M[2]],p[A]=s[x+P[0]]+i,p[A+1]=s[x+P[1]]+i,p[A+2]=s[x+P[2]]+i,S+=3,A+=3,x+=3}function TN(t,e,r,i,s,n,o){i[n]=i[o],o*=3,t[n*=3]=t[o],t[n+1]=t[o+1],t[n+2]=t[o+2],e[n]=e[o],e[n+1]=e[o+1],e[n+2]=e[o+2],r[n]=s[0],r[n+1]=s[1],r[n+2]=s[2]}const RR=C();function ife(t,e,r,i,s,n,o,a,l,c,h){let p=s,f=s+1,m=s+o,g=s+o+1,_=a,v=a+1,b=a+2*n,x=a+2*n+1;h<0&&(p=s+o+1,g=s),c*=3;for(let T=0;T<n;++T)T===n-1&&(h>0?(f=s,g=s+o):(f=s,p=s+o)),Sxt(t,p,f,m,RR),TN(t,e,i,r,RR,_,p),TN(t,e,i,r,RR,v,f),TN(t,e,i,r,RR,b,m),TN(t,e,i,r,RR,x,g),l[c++]=_,l[c++]=b,l[c++]=x,l[c++]=_,l[c++]=x,l[c++]=v,p++,f++,m++,g++,_+=2,v+=2,b+=2,x+=2}const vG=C(),sfe=C(),nfe=C(),ofe=C(),afe=C();function Sxt(t,e,r,i,s){e*=3,r*=3,i*=3,ie(vG,t[e++],t[e++],t[e++]),ie(sfe,t[r++],t[r++],t[r++]),ie(nfe,t[i++],t[i++],t[i++]),pe(ofe,sfe,vG),pe(afe,nfe,vG),st(s,afe,ofe),_e(s,s)}const d2=C();function Ext(t,e,r,i,s,n){const o=t.stageObject,a=o.geometries,l=a.length,c=e.mode!=="absolute-height";let h=0;const p=o.transformation,f=mO(xe(),p);for(let m=0;m<l;m+=2){const g=a[m];if(!jre(g))continue;const _=g.getMutableAttribute(E.POSITION).data,v=n[m/2],b=new Tre(g.mapPositions),x=_.length/3;let T=0,S=!1,O=0;for(let A=0;A<x;A++){d2[0]=_[T],d2[1]=_[T+1],d2[2]=_[T+2],i(b,SN),c&&(O+=SN.sampledElevation),bi.TESTS_DISABLE_OPTIMIZATIONS?(ie(Nc,b.array[b.offset],b.array[b.offset+1],SN.z+v[T/3]),r!=null&&s.toRenderCoords(Nc,r,Nc),Ne(Nc,Nc,f)):(ie(Nc,_[T],_[T+1],_[T+2]),Ne(Nc,Nc,p),s.setAltitude(Nc,SN.z+v[T/3]),Ne(Nc,Nc,f)),_[T]=Nc[0],_[T+1]=Nc[1],_[T+2]=Nc[2];const M=Cxt/s.unitInMeters;(Math.abs(d2[0]-_[T])>=M||Math.abs(d2[1]-_[T+1])>=M||Math.abs(d2[2]-_[T+2])>=M)&&(S=!0),b.offset+=3,T+=3}S&&(g.invalidateBoundingInfo(),o.geometryVertexAttrsUpdated(a[m]),a[m+1].invalidateBoundingInfo(),o.geometryVertexAttrsUpdated(a[m+1])),h+=O/x}return h/l}const Nc=C(),Jl=C(),SN=new F$,lfe=[0,2,1],cfe=[0,1,2],Cxt=.01;let Axt=class{constructor(e,r,i,s){this.positions=e,this.elevation=r,this.normals=i,this.heights=s}};function Oxt(t,e,r,i,s){if(t==null)return null;const n=t.referencesGeometry()&&s?Rxt(e,i,s):e,o=t.repurposeFeature(n);try{return t.evaluate({...r,$feature:o},t.services)}catch(a){return K.getLogger("esri.views.2d.support.arcadeOnDemand").warn("Feature arcade evaluation failed:",a),null}}const bG=new Map;function Rxt(t,e,r){const{transform:i,hasZ:s,hasM:n}=r;bG.has(e)||bG.set(e,Mxt(e));const o=bG.get(e)(t.geometry,i,s,n);return{...t,geometry:o}}function Mxt(t){const e={};switch(t){case"esriGeometryPoint":return(r,i,s,n)=>rAe(i,e,r,s,n);case"esriGeometryPolygon":return(r,i,s,n)=>iAe(i,e,r,s,n);case"esriGeometryPolyline":return(r,i,s,n)=>sAe(i,e,r,s,n);case"esriGeometryMultipoint":return(r,i,s,n)=>tAe(i,e,r,s,n);default:return K.getLogger("esri.views.2d.support.arcadeOnDemand").error(new D("mapview-arcade",`Unable to handle geometryType: ${t}`)),r=>r}}const uqt=1.2,Ixt=ng;let q8=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.renderGeometries=r,this.boundingBox=i,this._drapeSourceRenderer=s,this.type="draped",this.stage=null,this._visible=!1,this._addedToStage=!1,this.isElevationSource=!1}initialize(e){this.stage=e.stage}setVisibility(e){if(this.stage!=null&&this._visible!==e){if(this._visible=e,e&&!this._addedToStage)return this._addedToStage=!0,void this._drapeSourceRenderer.addGeometries(this.renderGeometries,ps.ADD);if(e||this._addedToStage){for(const r of this.renderGeometries)r.visible=this._visible;this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eo.VISIBILITY)}}}destroy(){this.stage&&this._addedToStage&&this._drapeSourceRenderer.removeGeometries(this.renderGeometries,ps.REMOVE),this._addedToStage=!1,this._visible=!1,this.stage=null}getCenterObjectSpace(e=C()){return ie(e,0,0,0)}getBoundingBoxObjectSpace(e=Gn()){return Gi(e)}addObjectState(e,r){e===$0.Highlight&&(this.renderGeometries.forEach(i=>{const s=i.geometry.addHighlight();r.addRenderGeometry(i,s,this)}),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eo.HIGHLIGHT))}removeObjectState(e){this.renderGeometries.forEach(r=>{e.removeRenderGeometry(r)})}removeRenderGeometryObjectState(e,r){e.geometry.removeHighlight(r),this._addedToStage&&this._drapeSourceRenderer.modifyGeometries(this.renderGeometries,eo.HIGHLIGHT)}computeAttachmentOrigin(e){for(const r of this.renderGeometries)r.geometry.computeAttachmentOrigin(p2)&&(e.draped.origin[0]+=p2[0],e.draped.origin[1]+=p2[1],e.draped.num++)}async getProjectedBoundingBox(e,r,i,s,n){Gi(n);for(let o=0;o<this.renderGeometries.length;o++){const a=this.renderGeometries[o];this._getRenderGeometryProjectedBoundingRect(a,e,ufe,i),u7e(n,ufe)}if(r){let o;lf(n,p2);const a=Gre(n,r.service.spatialReference,r);try{o=await r.service.queryElevation(p2[0],p2[1],s,a,"ground")}catch{}o!=null&&(n[2]=Math.min(n[2],o),n[5]=Math.max(n[5],o))}return n}_getRenderGeometryProjectedBoundingRect(e,r,i,s){if(this.boundingBox)K6(om,this.boundingBox);else{const n=e.boundingSphere,o=n[3];om[0]=n[0]-o,om[1]=n[1]-o,om[2]=n[2]-o,om[3]=n[0]+o,om[4]=n[1]+o,om[5]=n[2]+o}return r(om,0,2),this.calculateRelativeScreenBounds&&s.push({location:lf(om),screenSpaceBoundingRect:this.calculateRelativeScreenBounds()}),mK(om,i)}};const ufe=Ht(),om=Gn(),p2=C();let NLe=class{constructor(e,r,i,s=2048){this.text=e,this._alignment=r,this._parameters=i,this._maxSize=s,this._textWidths=[],this._lineWidths=[],this._renderPixelRatio=null,this._metricsCached=null,this.key=`TextRenderer-${this._parameters.key}-${this._alignment}--${e}`,this._lines=e.split(/\r?\n/)}get displayWidth(){return Math.ceil(this._displayWidth+2*this._backgroundHorizontalPadding)}get displayHeight(){const e=this._lineSpacing*(this._lines.length-1),r=this._lineHeight;return Math.ceil(e+r+2*this._haloSize+this._backgroundTopPadding+this._backgroundBottomPadding)}get renderedWidth(){return Math.ceil(this._toRenderUnit(this.displayWidth))}get renderedHeight(){return Math.ceil(this._toRenderUnit(this.displayHeight))}get firstRenderedBaselinePosition(){return this._toRenderUnit(this._firstLineYOffset+this._baselinePosition)}get _firstLineYOffset(){return this._backgroundTopPadding+this._haloSize}get _metrics(){if(this._metricsCached==null){const e=UY(hfe,EN,EN).getContext("2d");this._setFontProperties(e,this._fontSize);let r=2*this._haloSize;const i=this._parameters.definition.font;i.style!=="italic"&&i.style!=="oblique"&&i.weight!=="bold"&&i.weight!=="bolder"||(r+=.3*e.measureText("A").width),this._textWidths.length=0,this._lineWidths.length=0;let s,n,o=0,a=0,l=0;this._lines.forEach((g,_)=>{const v=e.measureText(g),b=v.width,x=b+r;this._textWidths.push(b),this._lineWidths.push(x),o=Math.max(o,x),a=Math.max(a,v.actualBoundingBoxAscent),l=Math.max(l,v.actualBoundingBoxDescent),_===0&&(s=v),_===this._lines.length-1&&(n=v)});const c=e.font;let h=pfe.get(c);if(!h){const g=e.measureText($xt);h=new Dxt(g.actualBoundingBoxAscent,g.actualBoundingBoxDescent),pfe.set(c,h)}a=Math.max(a,h.actualBoundingBoxAscent),l=Math.max(l,h.actualBoundingBoxDescent);const p=a+l,f=this._hasBackground?s.actualBoundingBoxAscent:a,m=this._hasBackground?n.actualBoundingBoxDescent:l;this._metricsCached=new Lxt(a-f,l-m,p,o,a)}return this._metricsCached}get _lineSpacing(){return(this._lineHeight+this._linePadding)*this._parameters.definition.lineSpacingFactor}get _lineHeight(){return this._metrics.lineHeight}get _linePadding(){return this._lineHeight*Pxt}get _baselinePosition(){return this._metrics.baselinePosition}get _renderedFontSize(){return this._toRenderUnit(this._fontSize)}get _fontSize(){return this._parameters.definition.size}get _renderedHaloSize(){return this._toRenderUnit(this._haloSize)}get _haloSize(){return this._parameters.haloSize}get _backgroundHorizontalPadding(){return this._hasBackground?this._parameters.definition.background.padding[0]:0}get _backgroundVerticalPadding(){return this._hasBackground?this._parameters.definition.background.padding[1]:0}get _backgroundTopPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingTop)}get _backgroundBottomPadding(){return Math.max(0,this._backgroundVerticalPadding-this._metrics.paddingBottom)}get _hasBackground(){return!!this._parameters.backgroundStyle}get renderPixelRatio(){if(this._renderPixelRatio==null){const e=this._parameters.definition.pixelRatio;this._maxSize>0?this._renderPixelRatio=Math.min(e,Math.min(this._maxSize/this.displayWidth,this._maxSize/this.displayHeight)):this._renderPixelRatio=e}return this._renderPixelRatio}_getLineXOffset(e){switch(this._alignment){case P1.Left:return this._backgroundHorizontalPadding;case P1.Center:return(this.displayWidth-this._lineWidths[e])/2;case P1.Right:return this.displayWidth-this._backgroundHorizontalPadding-this._lineWidths[e]}}render(e,r=0,i=0){e.save();const s=r/=this.renderPixelRatio,n=i/=this.renderPixelRatio,o=this._haloSize,a=this._firstLineYOffset;r+=o,i+=a+this._baselinePosition;const l=this._haloSize>0;l&&this._renderHalo(e,s,n,o,a),this._setFontProperties(e,this._renderedFontSize);for(let c=0;c<this._lines.length;++c){const h=this._lines[c],p=this._getLineXOffset(c);l&&(e.globalCompositeOperation="destination-out",e.fillStyle="rgb(0, 0, 0)",this._fillText(e,h,r+p,i),this._renderLineDecoration(e,r+p,i,this._textWidths[c])),e.globalCompositeOperation="source-over",e.fillStyle=this._parameters.textStyle,this._fillText(e,h,r+this._getLineXOffset(c),i),this._renderLineDecoration(e,r+p,i,this._textWidths[c]),i+=this._lineSpacing}if(bi.TEXT_SHOW_BASELINE){e.strokeStyle=dfe,e.setLineDash([2,2]),e.lineWidth=1;let c=n+a;for(let h=0;h<this._lines.length;++h){const p=c+this._baselinePosition;this._drawLine(e,[s,p],[s+this.displayWidth,p]),c+=this._lineSpacing}}if(bi.TEXT_SHOW_BORDER&&(e.strokeStyle=dfe,e.setLineDash([]),e.lineWidth=1,this._drawBox(e,[s,n],[this.displayWidth,this.displayHeight])),this._hasBackground){const c=this._parameters.definition.background.borderRadius*this.renderPixelRatio;this._roundedRect(e,s,n,c),e.globalCompositeOperation="destination-over",e.fillStyle=this._parameters.backgroundStyle,e.fill()}e.restore()}_renderLineDecoration(e,r,i,s,n=!1){if(this._parameters.definition.font.decoration==="none"||s===0)return;const o=1,a=Math.max(this._parameters.definition.size/16,o);switch(this._parameters.definition.font.decoration){case"underline":i+=2*a;break;case"line-through":i-=.33*this._baselinePosition}const l=n?this._haloSize:0;e.strokeStyle=n?this._parameters.haloStyle:this._parameters.textStyle,e.lineWidth=this._toRenderUnit(a+2*l),e.beginPath(),e.moveTo(this._toRenderUnit(r-l),this._toRenderUnit(i)),e.lineTo(this._toRenderUnit(r+s+l),this._toRenderUnit(i)),e.stroke()}_roundedRect(e,r,i,s){r=this._toRenderUnit(r),i=this._toRenderUnit(i);const n=this.renderedWidth,o=this.renderedHeight;s!==0?(s=ye(s,0,Math.floor(o/2)),e.beginPath(),e.moveTo(r,i+s),e.arcTo(r,i,r+s,i,s),e.lineTo(r+n-s,i),e.arcTo(r+n,i,r+n,i+s,s),e.lineTo(r+n,i+o-s),e.arcTo(r+n,i+o,r+n-s,i+o,s),e.lineTo(r+s,i+o),e.arcTo(r,i+o,r,i+o-s,s),e.closePath()):e.rect(r,i,n,o)}_renderHalo(e,r,i,s,n){const o=this.renderedWidth,a=this.renderedHeight,l=UY(hfe,Math.max(o,EN),Math.max(a,EN)),c=l.getContext("2d");c.clearRect(0,0,o,a),this._setFontProperties(c,this._renderedFontSize),c.fillStyle=this._parameters.haloStyle,c.strokeStyle=this._parameters.haloStyle;const h=this._renderedHaloSize<3;c.lineJoin=h?"miter":"round",h?this._renderHaloEmulated(c,s,n):this._renderHaloNative(c,s,n);let p=n+this._baselinePosition;for(let f=0;f<this._lines.length;++f){const m=this._getLineXOffset(f);this._renderLineDecoration(c,s+m,p,this._textWidths[f],!0),p+=this._lineSpacing}e.globalAlpha=this._parameters.definition.halo.color[3],e.drawImage(l,0,0,o,a,this._toRenderUnit(r),this._toRenderUnit(i),o,a),e.globalAlpha=1}_renderHaloEmulated(e,r,i){i+=this._baselinePosition;for(let s=0;s<this._lines.length;++s){const n=this._lines[s],o=this._getLineXOffset(s);for(const[a,l]of FLe)this._fillText(e,n,r+o+this._haloSize*a,i+this._haloSize*l);i+=this._lineSpacing}}_renderHaloNative(e,r,i){const s=2*this._haloSize;i+=this._baselinePosition;for(let n=0;n<this._lines.length;++n){const o=this._lines[n],a=this._getLineXOffset(n),l=5,c=.1;for(let h=0;h<l;h++){const p=1-(l-1)*c+h*c;e.lineWidth=this._toRenderUnit(p*s),this._strokeText(e,o,r+a,i)}i+=this._lineSpacing}}_setFontProperties(e,r){e.font=this._parameters.fontString(r),e.textAlign="left",e.textBaseline="alphabetic"}get _displayWidth(){return this._metrics.displayWidth}_toRenderUnit(e){return e*this.renderPixelRatio}_toRoundedRenderUnit(e){return Math.round(e*this.renderPixelRatio)}_fillText(e,r,i,s){e.fillText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_strokeText(e,r,i,s){e.strokeText(r,this._toRenderUnit(i),this._toRenderUnit(s))}_drawLine(e,r,i){e.beginPath(),e.moveTo(this._toRoundedRenderUnit(r[0])+.5,this._toRoundedRenderUnit(r[1])+.5),e.lineTo(this._toRoundedRenderUnit(i[0])+.5,this._toRoundedRenderUnit(i[1])+.5),e.stroke()}_drawBox(e,r,i){const s=this._toRenderUnit(r[0]),n=this._toRenderUnit(r[1]),o=this._toRenderUnit(i[0]),a=this._toRenderUnit(i[1]),l=Math.floor(s)+.5,c=Math.ceil(s+o)-.5,h=Math.floor(n)+.5,p=Math.ceil(n+a)-.5;e.beginPath(),e.moveTo(l,h),e.lineTo(c,h),e.lineTo(c,p),e.lineTo(l,p),e.lineTo(l,h),e.stroke()}};const FLe=[];for(let e=0;e<360;e+=360/16)FLe.push([Math.cos(Math.PI*e/180),Math.sin(Math.PI*e/180)]);var P1;function UY(t,e,r){return t.canvas||(t.canvas=document.createElement("canvas")),t.canvas.width=e,t.canvas.height=r,t.canvas}(function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"})(P1||(P1={}));const hfe={canvas:null},Pxt=.2,EN=512,dfe="rgb(255, 0, 255, 0.5)",$xt=(()=>{let t="";for(let e=32;e<127;e++)t+=String.fromCharCode(e);return t})();let Lxt=class{constructor(e,r,i,s,n){this.paddingTop=e,this.paddingBottom=r,this.lineHeight=i,this.displayWidth=s,this.baselinePosition=n}},Dxt=class{constructor(e,r){this.actualBoundingBoxAscent=e,this.actualBoundingBoxDescent=r}};const pfe=new Map,Nxt=Object.freeze({left:0,center:.5,right:1}),h5=Object.freeze({"bottom-left":yr(0,0),bottom:yr(.5,0),"bottom-right":yr(1,0),left:yr(0,.5),center:yr(.5,.5),right:yr(1,.5),"top-left":yr(0,1),top:yr(.5,1),"top-right":yr(1,1)});function kLe(t){switch(t){case"left":return P1.Left;case"right":return P1.Right;default:return P1.Center}}function ffe(t){switch(t){case"bottom-left":case"left":case"top-left":return"left";case"bottom":case"center":case"top":return"center";case"bottom-right":case"right":case"top-right":return"right"}}function Fxt(t){switch(t){case"bottom-left":case"bottom":case"bottom-right":return"bottom";case"left":case"center":case"right":return"center";case"top-left":case"top":case"top-right":return"top"}}function kxt(t,e){switch(e){case"bottom":return t==="left"?"bottom-left":t==="right"?"bottom-right":"bottom";case"center":return t;case"top":return t==="left"?"top-left":t==="right"?"top-right":"top"}}function Uxt(t){return t==="middle"?"center":t}let jA=class{constructor(e,r={}){this.geometry=e,this.screenToWorldRatio=1,this._transformation=xe(),this._shaderTransformation=null,this._boundingSphere=null,this.id=vc(),this.layerUid=r.layerUid,this.graphicUid=r.graphicUid,this.shaderTransformer=r.shaderTransformer,this.castShadow=r.castShadow??!1}get transformation(){return this._transformation}get boundingInfo(){return this.geometry.boundingInfo}updateTransformation(e){e(this._transformation),this._shaderTransformation=this._boundingSphere=null}shaderTransformationChanged(){this._shaderTransformation=null}get boundingSphere(){return this._boundingSphere?this._boundingSphere:this.boundingInfo?(this._boundingSphere=Ne(js(),this.boundingInfo.center,this.shaderTransformation),this._boundingSphere[3]=this.boundingInfo.radius*SA(this.shaderTransformation),this._boundingSphere):DOe}get hasShaderTransformation(){return this.shaderTransformer!=null}get material(){return this.geometry.material}get type(){return this.geometry.type}get shaderTransformation(){return this.shaderTransformer==null?this.transformation:(this._shaderTransformation||(this._shaderTransformation=an(xe(),this.shaderTransformer(this.transformation))),this._shaderTransformation)}get indices(){return this.geometry.indices}get vertexAttributes(){return this.geometry.vertexAttributes}get highlights(){return this.geometry.highlights}get occludees(){return this.geometry.occludees}get visible(){return this.geometry.visible}set visible(e){this.geometry.visible=e}};const Vxt=xe(),mfe=Ee(0,0,1),zxt=16,Bxt=1.5,Yx=Vre,Gxt=[Yx/2,Yx/2,1-Yx/2,1-Yx/2],jxt=[TP*Yx,TP*Yx];let VY=class ULe extends Vg{getCachedSize(){return{size:this._getIconSize()}}constructor(e,r,i,s){super(e,r,i,s),this._cimLayers=null,this._cimSymbolMaterials=new Map,this._cimSymbolTextures=new Map,this._cimMaterialParametersInfo=null,this._cimRequiredFields=null,this._cimScaleFactorOrFunction=null,this._size=null,this._symbolTextureRatio=1,this._outlineSize=0,this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!0}}async doLoad(e){this._validateOrThrow();const r=this._prepareMaterialParameters(),i=this._getPrimitive();if(i!=null)this._prepareResourcesPrimitive(r,i);else{const s=zEe(this.symbolLayer),n=_T(s);n&&n.mediaType==="application/json"?await this._prepareResourcesCIM(r,JSON.parse(n.data),e):await this._prepareResourcesHref(r,s,e)}}_validateOrThrow(){if(this._drivenProperties.size)return;const e=D8(this._getIconSize());if(e)throw new D("graphics3diconsymbollayer:invalid-size",e)}_getIconSize(){const e=this.symbolLayer,r=Math.round(e.size!=null?vi(e.size):zxt);return this._drivenProperties.size?Math.max(r,64):r}_generateTextureCIM(e){const r=this._getGraphicHash(e);let i=r===""?null:this._cimSymbolTextures.get(r);if(!i){const s={scaleFactor:this._cimScaleFactorOrFunction},n=this._context.sharedResources.cimSymbolRasterizer.rasterizeCIMSymbol3D(this._cimLayers,e,"esriGeometryPoint",s,void 0,void 0);this._cimMaterialParametersInfo.anchorPosition=this._getAnchorPos("relative",n.anchorPosition);const o={width:n.imageData.width,height:n.imageData.height};i=new wS(n.imageData,o),this._cimSymbolTextures.set(r,i),this._context.stage.add(i)}return i}_prepareMaterialParameters(){const e={anchorPosition:this._getAnchorPos(this.symbolLayer.anchor,this.symbolLayer.anchorPosition)},r=this.symbol;if(Hxt(r)){const{screenLength:i,minWorldLength:s,maxWorldLength:n}=r.verticalOffset;e.verticalOffset={screenLength:vi(i),minWorldLength:s||0,maxWorldLength:n??1/0}}return this._context.screenSizePerspectiveEnabled&&(e.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),e.occlusionTest=!0,e.hasSlicePlane=this._context.slicePlaneEnabled,e}_prepareResourcesPrimitive(e,r){const i=this._getOutlineSize();if(wG(r)&&i===0)throw new Error("Nothing to render");if(this._outlineSize=i,e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,this._context.sharedResources.textures!=null){const n=this._context.sharedResources.textures.fromData(`${r}-icon`,()=>g_t(r));this._texture=n.texture,this._releaseTexture=n,e.textureId=this._texture.id}e.textureIsSignedDistanceField=!0,e.distanceFieldBoundingBox=Gxt;const s=this._getIconSize();this._size=[s,s],this._symbolTextureRatio=1/Yx,this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesHref(e,r,i){this._outlineSize=this._getOutlineSize(),e.color=this._getFillColor(),e.outlineColor=this._getOutlineColor(),e.outlineSize=this._outlineSize,e.textureIsSignedDistanceField=!1;const s=this._getIconSize(),n=s*this._context.graphicsCoreOwner.view.state.rasterPixelRatio;if(this._context.sharedResources.textures!=null){const o=await Sh(this._context.sharedResources.textures.fromUrl(r,n,{signal:i}));if(o.ok===!1)throw xa(o.error),new D("graphics3diconsymbollayer:request-failed",`Failed to load (Request for icon resource failed: ${r})`);this._releaseTexture=o.value;const a=o.value.texture,l=a.parameters.width/a.parameters.height;this._size=l>1?[s,Math.round(s/l)]:[Math.round(s*l),s],e.textureId=a.id}this._createMaterialAndAddToStage(e,this._context.stage)}async _prepareResourcesCIM(e,r,i){const s=new lO({data:r});if(!this._context.sharedResources.cimSymbolRasterizer){const h=(await J(()=>import("./CIMSymbolRasterizer-8b630ece.js"),["./CIMSymbolRasterizer-8b630ece.js","./cimAnalyzer-cb622717.js","./TileClipper-ae6eca9e.js","./definitions-4b766362.js","./number-e491b09e.js","./BidiEngine-9a40f2f4.js","./imageutils-ec034daf.js","./rasterizingUtils-0eaad164.js"],import.meta.url)).CIMSymbolRasterizer;Dt(i),this._context.sharedResources.cimSymbolRasterizer||(this._context.sharedResources.cimSymbolRasterizer=new h(this._context.renderCoordsHelper.spatialReference,!0))}const n=this._context.layer.fields?this._context.layer.fields.map(h=>h.toJSON()):null;let o,a;if(this._cimLayers=await this._context.sharedResources.cimSymbolRasterizer.analyzeCIMSymbol3D(s,n,this._context.renderer&&this._context.renderer.type==="dictionary"?this._context.renderer.fieldMap:null,"esriGeometryPoint",{signal:i}),this._context.renderer&&this._context.renderer.type==="dictionary"&&this._context.renderer.scaleExpression){const h=this._context.renderer;if(isNaN(h.scaleExpression)){const p=h.scaleExpression,f=await q9e(p,this._context.layer.spatialReference,n);a=(m,g,_)=>{const v=Oxt(f,m,{$view:_},"esriGeometryPoint",g);return v!==null?v:1}}else o=Number(h.scaleExpression)}this._cimScaleFactorOrFunction=o||a||1;const l=this._context.renderer?await this._context.renderer.getRequiredFields(this._context.layer.fieldsIndex):[];Dt(i);const c=this._context.layer.fieldsIndex;this._cimRequiredFields=l.map(h=>c.get(h).name),this._cimMaterialParametersInfo=e,this._cimMaterialParametersInfo.color=this._getFillColor(),this._cimMaterialParametersInfo.outlineColor=[0,0,0,0],this._cimMaterialParametersInfo.outlineSize=0,this._cimMaterialParametersInfo.textureIsSignedDistanceField=!1}_getPrimitive(){return this.symbolLayer.resource&&this.symbolLayer.resource.href?null:this.symbolLayer.resource&&this.symbolLayer.resource.primitive||wxe}_getOutlineSize(){let e=0;const r=this.symbolLayer;return r.outline!=null&&r.outline.size!=null?Math.max(vi(r.outline.size),0):(e=wG(this._getPrimitive())?Bxt:0,Math.max(e,0))}_getOutlineColor(){const e=this._getLayerOpacity(),r=this.symbolLayer,i=r?.outline?.color;if(i!=null){const s=Le.toUnitRGB(i),n=i.a*e;return[s[0],s[1],s[2],n]}return[0,0,0,0]}_getFillColor(){if(wG(this._getPrimitive()))return Ixt;const e=this._getPrimitive()==null,r=this.symbolLayer?.material?.color;return this._getCombinedOpacityAndColor(r,{hasIntrinsicColor:e})}_getAnchorPos(e,r){return e==="relative"?yr((r.x||0)+.5,.5-(r.y||0)):e in h5?h5[e]:h5.center}_createMaterialAndAddToStage(e,r){if(this._cimLayers){this._fastUpdates=null;let i=e.textureId?this._cimSymbolMaterials.get(e.textureId):null;return i||(i=new VA(e),this._cimSymbolMaterials.set(e.textureId??0,i),r.add(i)),i}return this._fastUpdates=kA(this._context.renderer,this._fastVisualVariableConvertOptions()),this._fastUpdates&&(e={...e,...this._fastUpdates.materialParameters}),this._material=new VA(e),r.add(this._material),this._material}_setDrapingDependentMaterialParameters(){this.draped&&(this._forEachMaterial(e=>{e.setParameters({verticalOffset:null,screenSizePerspective:null,occlusionTest:!1,hasSlicePlane:!1,shaderPolygonOffset:0,isDraped:this.draped})}),this.layerOpacityChanged())}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._material=null,this._cimSymbolMaterials.clear(),this._cimSymbolTextures.forEach(e=>this._context.stage.remove(e)),this._cimSymbolTextures.clear(),this._releaseTexture=as(this._releaseTexture)}_getScaleFactor(e,r){if(this._drivenProperties.size&&e.size){for(let i=0;i<3;i++){const s=e.size[i];s&&s!=="symbol-value"&&s!=="proportional"&&(e.size[i]=vi(s))}if(e.size[0]==="symbol-value")return 1;if(isFinite(+e.size[0]))return+e.size[0]/r;if(isFinite(+e.size[2]))return+e.size[2]/r}return 1}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;let i,s=[0,0];if(this._cimLayers){if(!this._cimLayers.length)return null;const p=this._generateTextureCIM(r),f={textureId:p.id,...this._cimMaterialParametersInfo};i=this._createMaterialAndAddToStage(f,this._context.stage),s=[p.parameters.width,p.parameters.height]}else s=this._size,i=this._material;const n=EP(r.geometry);if(n==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const o=e.renderingInfo,a=this._getVertexOpacityAndColor(o);let l=1;if(!this._fastUpdates?.visualVariables.size){const p=s[0]>s[1]?s[0]:s[1];l=this._getScaleFactor(o,p)}l*=this._symbolTextureRatio;const c=yr(s[0]*l,s[1]*l),h=this.setGraphicElevationContext(r,new Gf);return this.ensureDrapedStatus(h.mode==="on-the-ground")&&this._setDrapingDependentMaterialParameters(),this.draped?this._createAsOverlay(r,n,i,a,c,e.layer.uid):this._createAs3DShape(r,n,i,a,c,h,r.uid)}layerOpacityChanged(){const e=this._getFillColor(),r=this._getOutlineColor();this._forEachMaterial(i=>{i.setParameters({color:e}),i.setParameters({outlineColor:r})})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=N$(ULe.elevationModeChangeTypes,i,s);if(n!==Is.UPDATE)return n;const o=Qd(s)||s==="absolute-height";return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return this.draped||this._forEachMaterial(e=>{e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return this._getPrimitive()!=null}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!UA(this._fastUpdates,r,this._fastVisualVariableConvertOptions()))return on.RecreateSymbol;this._material!=null&&this._material.setParameters(this._fastUpdates.materialParameters)}return on.FastUpdate}_defaultElevationInfoNoZ(){return qxt}_createAs3DShape(e,r,i,s,n,o,a){const l=this.getFastUpdateAttrValues(e),c=l&&this._fastUpdates?_=>CY(this._fastUpdates.materialParameters,l,_):void 0,h=this._context.layer.uid,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:h}),f=JX(i,mfe,null,s,n,Wxt,null,l,p),m=Xre(this._context,r,f,o,a,c);if(m==null)return null;const g=new Ug(this,m.object,[f],null,null,uT,o);return g.alignedSampledElevation=m.sampledElevation,g.needsElevationUpdates=Qd(o.mode)||o.mode==="absolute-height",g.getScreenSize=this._createScreenSizeGetter(n,c),g.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(g.getScreenSize(),1,_),SP(g,r,this._context.elevationProvider),g}_createAsOverlay(e,r,i,s,n,o){i.renderPriority=this._renderPriority;const a=Qt();aa(r,a,this._context.overlaySR),a[2]=gie;const l=this._context.clippingExtent;if(l!=null&&!fK(l,a))return null;const c=this.getFastUpdateAttrValues(e),h=c&&this._fastUpdates?_=>CY(this._fastUpdates.materialParameters,c,_):void 0,p=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:e.uid,layerUid:this._context.layer.uid}),f=JX(i,mfe,a,s,n,null,null,c,p),m=new jA(f,{layerUid:o,graphicUid:e.uid,shaderTransformer:h}),g=new q8(this,[m],null,this._context.drapeSourceRenderer);return g.getScreenSize=this._createScreenSizeGetter(n,h),g.calculateRelativeScreenBounds=_=>i.calculateRelativeScreenBounds(g.getScreenSize(),1,_),g}_createScreenSizeGetter(e,r){const i=this._outlineSize+2;if(this._fastUpdates&&r){const s=e[0]/this._symbolTextureRatio,n=e[1]/this._symbolTextureRatio;return(o=Pe())=>{const a=r(Vxt);return o[0]=a[0]*s+i,o[1]=a[5]*n+i,o}}{const s=e[0]/this._symbolTextureRatio+i,n=e[1]/this._symbolTextureRatio+i;return(o=Pe())=>(o[0]=s,o[1]=n,o)}}_fastVisualVariableConvertOptions(){const e=Math.max(this._size[0],this._size[1]),r=Ee(e,e,e),i=Fl(1),s=e*i,n=Ee(s,s,s);return new L$({size:!0,color:!0,rotation:!0,opacity:!1},r,n,i)}_getGraphicHash(e){let r="";for(const i of this._cimRequiredFields)r+=i+e.attributes[i];return r}_forEachMaterial(e){this._material!=null&&e(this._material),this._cimSymbolMaterials.forEach(e)}test(){return{...super.test(),material:this._material}}};function Hxt(t){return t&&t.type==="point-3d"&&t.hasVisibleVerticalOffset()}function wG(t){return t!=null&&(t==="cross"||t==="x")}VY.PRIMITIVE_SIZE=jxt,VY.elevationModeChangeTypes={definedChanged:Is.UPDATE,staysOnTheGround:Is.NONE,onTheGroundChanged:Is.RECREATE};const qxt={mode:"relative-to-ground",offset:0},Wxt=Vt(0,0,0,1);function zY(t){switch(t){case"butt":return kd.BUTT;case"square":return kd.SQUARE;case"round":return kd.ROUND;default:return null}}function gfe(t){return t==="diamond"?"kite":t}function BY(t,e,r=null){const i=[],s=[],n=e.mapPositions;Zxt(e,s,i);const o=s[0][1].data,a=i[0][1].length,l=SO(a);return Xxt(e,s,i,l),Qxt(e,s,i,l),Yxt(e,s,i,l),Jxt(e,s,i,l),Kxt(e,s,i,l),eTt(e,s,i,l),tTt(e,s,i,o),new mn(t,s,i,n,Ms.Line,r)}function Zxt(t,e,r){const{attributeData:{position:i},removeDuplicateStartEnd:s}=t,n=rTt(i)&&s,o=i.length/3-(n?1:0),a=new Array(2*(o-1)),l=n?i.slice(0,i.length-3):i;let c=0;for(let h=0;h<o-1;h++)a[c++]=h,a[c++]=h+1;e.push([E.POSITION,new Ge(l,3,n)]),r.push([E.POSITION,a])}function Xxt(t,e,r,i){if(t.attributeData.colorFeature!=null)return;const s=t.attributeData.color;e.push([E.COLOR,new Ge(s??Od,4)]),r.push([E.COLOR,i])}function Yxt(t,e,r,i){if(t.attributeData.normal==null)return;const s=t.attributeData.normal;e.push([E.NORMAL,new Ge(s,3)]),r.push([E.NORMAL,i])}function Jxt(t,e,r,i){t.attributeData.colorFeature!=null&&(e.push([E.COLORFEATUREATTRIBUTE,new Ge([t.attributeData.colorFeature],1,!0)]),r.push([E.COLOR,i]))}function Qxt(t,e,r,i){t.attributeData.sizeFeature==null&&(e.push([E.SIZE,new Ge([t.attributeData.size??1],1,!0)]),r.push([E.SIZE,i]))}function Kxt(t,e,r,i){t.attributeData.sizeFeature!=null&&(e.push([E.SIZEFEATUREATTRIBUTE,new Ge([t.attributeData.sizeFeature],1,!0)]),r.push([E.SIZEFEATUREATTRIBUTE,i]))}function eTt(t,e,r,i){const s=t.attributeData.opacityFeature;s!=null&&(e.push([E.OPACITYFEATUREATTRIBUTE,new Ge([s],1,!0)]),r.push([E.OPACITYFEATUREATTRIBUTE,i]))}function tTt(t,e,r,i){if(t.overlayInfo==null||t.overlayInfo.renderCoordsHelper.viewingMode!==Ue.Global||!t.overlayInfo.spatialReference.isGeographic)return;const s=Ra(i.length),n=Ir(t.overlayInfo.spatialReference);for(let f=0;f<s.length;f+=3)MV(i,f,s,f,n);const o=i.length/3,a=vs(o+1);let l=iTt,c=sTt,h=0,p=0;ie(l,s[p++],s[p++],s[p++]),a[0]=0;for(let f=1;f<o+1;++f)f===o&&(p=0),ie(c,s[p++],s[p++],s[p++]),h+=NCe(l,c),a[f]=h,[l,c]=[c,l];e.push([E.DISTANCETOSTART,new Ge(a,1,!0)]),r.push([E.DISTANCETOSTART,r[0][1]])}function rTt(t){const e=t.length;return t[0]===t[e-3]&&t[1]===t[e-2]&&t[2]===t[e-1]}const iTt=C(),sTt=C();function gqt(t,e){if(t==null||t.length===0)return[];const r=[];return t.forEach(i=>{const s=i.length,n=Ra(3*s);i.forEach((a,l)=>{n[3*l]=a[0],n[3*l+1]=a[1],n[3*l+2]=a[2]});const o={attributeData:{position:n,normal:e},removeDuplicateStartEnd:!1};r.push(o)}),r}function nTt(t,e,r,i){const s=t.type==="polygon"?Ag.CCW_IS_HOLE:Ag.NONE,n=t.type==="polygon"?t.rings:t.paths,{position:o,outlines:a}=U$(n,!!t.hasZ,s),l=Ra(o.length),c=zPe(o,t.spatialReference,0,l,0,o,0,o.length/3,e,r,i),h=c!=null;return{lines:h?VLe(a,o,l):[],projectionSuccess:h,sampledElevation:c}}function oTt(t,e){const r=t.type==="polygon"?Ag.CCW_IS_HOLE:Ag.NONE,i=t.type==="polygon"?t.rings:t.paths,{position:s,outlines:n}=U$(i,!1,r),o=wi(s,t.spatialReference,0,s,e,0,s.length/3);for(let a=2;a<s.length;a+=3)s[a]=gie;return{lines:o?VLe(n,s):[],projectionSuccess:o}}function VLe(t,e,r=null){const i=new Array;for(const{index:s,count:n}of t){if(n<=1)continue;const o=3*s,a=3*n;i.push({position:Fd(e,3*s,3*n),mapPositions:r!=null?Fd(r,o,a):void 0})}return i}function aTt(t){const e=new Cr,r=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha),i=t.space===bh.World;e.include(N$e,t),e.include(G$e,t),t.output===k.Depth&&e.include(N0,t);const{vertex:s,fragment:n}=e;return n.include(Pu),Eu(s,t),e.attributes.add(E.POSITION,"vec3"),e.attributes.add(E.UV0,"vec2"),e.attributes.add(E.AUXPOS1,"vec3"),e.varyings.add("vColor","vec4"),e.varyings.add("vpos","vec3"),e.varyings.add("vUV","vec2"),e.varyings.add("vSize","float"),J1(e),r&&e.varyings.add("depth","float"),t.hasTip&&e.varyings.add("vLineWidth","float"),s.uniforms.add(new Pr("nearFar",(o,a)=>a.camera.nearFar),new cr("viewport",(o,a)=>a.camera.fullViewport)),s.code.add(w`vec4 projectAndScale(vec4 pos) {
vec4 posNdc = proj * pos;
posNdc.xy *= viewport.zw / posNdc.w;
return posNdc;
}`),s.code.add(w`void clip(vec4 pos, inout vec4 prev) {
float vnp = nearFar[0] * 0.99;
if (prev.z > -nearFar[0]) {
float interpolation = (-vnp - pos.z) / (prev.z - pos.z);
prev = mix(pos, prev, interpolation);
}
}`),i?(e.attributes.add(E.NORMAL,"vec3"),NA(s),s.constants.add("tiltThreshold","float",.7),s.code.add(w`vec3 perpendicular(vec3 v) {
vec3 n = (viewNormal * vec4(normal.xyz, 1.0)).xyz;
vec3 n2 = cross(v, n);
vec3 forward = vec3(0.0, 0.0, 1.0);
float tiltDot = dot(forward, n);
return abs(tiltDot) < tiltThreshold ? n : n2;
}`)):s.code.add(w`vec2 perpendicular(vec2 v) {
return vec2(v.y, -v.x);
}`),s.code.add(w`
      #define vecN ${i?"vec3":"vec2"}

      vecN normalizedSegment(vecN pos, vecN prev) {
        vecN segment = pos - prev;
        float segmentLen = length(segment);

        // normalize or zero if too short
        return (segmentLen > 0.001) ? segment / segmentLen : ${i?"vec3(0.0, 0.0, 0.0)":"vec2(0.0, 0.0)"};
      }

      vecN displace(vecN pos, vecN prev, float displacementLen) {
        vecN segment = normalizedSegment(pos, prev);

        vecN displacementDirU = perpendicular(segment);
        vecN displacementDirV = segment;

        ${t.anchor===ZT.Tip?"pos -= 0.5 * displacementLen * displacementDirV;":""}

        return pos + displacementLen * (uv0.x * displacementDirU + uv0.y * displacementDirV);
      }
    `),t.space===bh.Screen&&(s.uniforms.add(new es("inverseProjectionMatrix",(o,a)=>a.camera.inverseProjectionMatrix)),s.code.add(w`vec3 inverseProject(vec4 posScreen) {
posScreen.xy = (posScreen.xy / viewport.zw) * posScreen.w;
return (inverseProjectionMatrix * posScreen).xyz;
}`),s.code.add(w`bool rayIntersectPlane(vec3 rayDir, vec3 planeOrigin, vec3 planeNormal, out vec3 intersection) {
float cos = dot(rayDir, planeNormal);
float t = dot(planeOrigin, planeNormal) / cos;
intersection = t * rayDir;
return abs(cos) > 0.001 && t > 0.0;
}`),s.uniforms.add(new Ie("perScreenPixelRatio",(o,a)=>a.camera.perScreenPixelRatio)),s.code.add(w`
      vec4 toFront(vec4 displacedPosScreen, vec3 posLeft, vec3 posRight, vec3 prev, float lineWidth) {
        // Project displaced position back to camera space
        vec3 displacedPos = inverseProject(displacedPosScreen);

        // Calculate the plane that we want the marker to lie in. Note that this will always be an approximation since ribbon lines are generally
        // not planar and we do not know the actual position of the displaced prev vertices (they are offset in screen space, too).
        vec3 planeNormal = normalize(cross(posLeft - posRight, posLeft - prev));
        vec3 planeOrigin = posLeft;

        ${t.hasCap?`
                if(prev.z > posLeft.z) {
                  vec2 diff = posLeft.xy - posRight.xy;
                  planeOrigin.xy += perpendicular(diff) / 2.0;
                }
              `:""};

        // Move the plane towards the camera by a margin dependent on the line width (approximated in world space). This tolerance corrects for the
        // non-planarity in most cases, but sharp joins can place the prev vertices at arbitrary positions so markers can still clip.
        float offset = lineWidth * perScreenPixelRatio;
        planeOrigin *= (1.0 - offset);

        // Intersect camera ray with the plane and make sure it is within clip space
        vec3 rayDir = normalize(displacedPos);
        vec3 intersection;
        if (rayIntersectPlane(rayDir, planeOrigin, planeNormal, intersection) && intersection.z < -nearFar[0] && intersection.z > -nearFar[1]) {
          return vec4(intersection.xyz, 1.0);
        }

        // Fallback: use depth of pos or prev, whichever is closer to the camera
        float minDepth = planeOrigin.z > prev.z ? length(planeOrigin) : length(prev);
        displacedPos *= minDepth / length(displacedPos);
        return vec4(displacedPos.xyz, 1.0);
      }
  `)),MO(s,t),l8(e),s.code.add(w`void main(void) {
if (uv0.y == 0.0) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
}
else {
float lineWidth = getLineWidth();
float screenMarkerSize = getScreenMarkerSize();
vec4 pos  = view * vec4(position.xyz, 1.0);
vec4 prev = view * vec4(auxpos1.xyz, 1.0);
clip(pos, prev);`),i?(t.hideOnShortSegments&&s.code.add(w`if (areWorldMarkersHidden(pos, prev)) {
gl_Position = vec4(1e038, 1e038, 1e038, 1.0);
return;
}`),s.code.add(w`pos.xyz = displace(pos.xyz, prev.xyz, getWorldMarkerSize(pos));
vec4 displacedPosScreen = projectAndScale(pos);`)):(s.code.add(w`vec4 posScreen = projectAndScale(pos);
vec4 prevScreen = projectAndScale(prev);
vec4 displacedPosScreen = posScreen;
displacedPosScreen.xy = displace(posScreen.xy, prevScreen.xy, screenMarkerSize);`),t.space===bh.Screen&&s.code.add(w`vec2 displacementDirU = perpendicular(normalizedSegment(posScreen.xy, prevScreen.xy));
vec3 lineRight = inverseProject(posScreen + lineWidth * vec4(displacementDirU.xy, 0.0, 0.0));
vec3 lineLeft = pos.xyz + (pos.xyz - lineRight);
pos = toFront(displacedPosScreen, lineLeft, lineRight, prev.xyz, lineWidth);
displacedPosScreen = projectAndScale(pos);`)),s.code.add(w`
        ${r?"depth = pos.z;":""}
        linearDepth = calculateLinearDepth(nearFar,pos.z);

        // Convert back into NDC
        displacedPosScreen.xy = (displacedPosScreen.xy / viewport.zw) * displacedPosScreen.w;

        // Convert texture coordinate into [0,1]
        vUV = (uv0 + 1.0) / 2.0;

        ${i?"":"vUV *= displacedPosScreen.w;"}

        ${t.hasTip?"vLineWidth = lineWidth;":""}

        vSize = screenMarkerSize;
        vColor = getColor();

        // Use camera space for slicing
        vpos = pos.xyz;

        gl_Position = displacedPosScreen;
      }
    }
  `),r&&e.include(Ah,t),e.include(Bs,t),n.uniforms.add(new cr("intrinsicColor",o=>o.color),new et("tex",o=>o.markerTexture)),n.include(kg),e.constants.add("texelSize","float",1/hT),n.code.add(w`float markerAlpha(vec2 samplePos) {
samplePos += vec2(0.5, -0.5) * texelSize;
float sdf = rgba2float(texture(tex, samplePos)) - 0.5;
float distance = sdf * vSize;
distance -= 0.5;
return clamp(0.5 - distance, 0.0, 1.0);
}`),t.hasTip&&(e.constants.add("relativeMarkerSize","float",iie/hT),e.constants.add("relativeTipLineWidth","float",Obt),n.code.add(w`
    float tipAlpha(vec2 samplePos) {
      // Convert coordinates s.t. they are in pixels and relative to the tip of an arrow marker
      samplePos -= vec2(0.5, 0.5 + 0.5 * relativeMarkerSize);
      samplePos *= vSize;

      float halfMarkerSize = 0.5 * relativeMarkerSize * vSize;
      float halfTipLineWidth = 0.5 * max(1.0, relativeTipLineWidth * vLineWidth);

      ${i?"halfTipLineWidth *= fwidth(samplePos.y);":""}

      float distance = max(abs(samplePos.x) - halfMarkerSize, abs(samplePos.y) - halfTipLineWidth);
      return clamp(0.5 - distance, 0.0, 1.0);
    }
  `)),e.constants.add("symbolAlphaCutoff","float",ia),n.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${r?"terrainDepthTest(gl_FragCoord, depth);":""}

    vec4 finalColor = intrinsicColor * vColor;

    ${i?"vec2 samplePos = vUV;":"vec2 samplePos = vUV * gl_FragCoord.w;"}

    ${t.hasTip?"finalColor.a *= max(markerAlpha(samplePos), tipAlpha(samplePos));":"finalColor.a *= markerAlpha(samplePos);"}

    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < symbolAlphaCutoff) {
      discard;
    }

    ${t.output===k.Alpha?w`fragColor = vec4(finalColor.a);`:""}
    ${t.output===k.Color?w`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Color&&t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}
    ${t.output===k.Highlight?w`fragColor = vec4(1.0);`:""}
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""}
  }
  `),e}const lTt=Object.freeze(Object.defineProperty({__proto__:null,build:aTt},Symbol.toStringTag,{value:"Module"})),zLe=new Map([[E.POSITION,0],[E.UV0,2],[E.AUXPOS1,3],[E.NORMAL,4],[E.COLOR,5],[E.COLORFEATUREATTRIBUTE,5],[E.SIZE,6],[E.SIZEFEATUREATTRIBUTE,6],[E.OPACITYFEATUREATTRIBUTE,7]]);let BLe=class GLe extends Ur{initializeProgram(e){return new Lr(e.rctx,GLe.shader.get().build(this.configuration),zLe)}_makePipelineState(e,r){const i=this.configuration,s=e===ut.NONE;return It({blending:i.output===k.Color||i.output===k.Alpha?s?vh:Q0(e):null,depthTest:{func:gb(e)},depthWrite:s?i.writeDepth?Ac:null:I8(e),colorWrite:Wt,stencilWrite:i.hasOccludees?Og:null,stencilTest:i.hasOccludees?r?nb:yb:null,polygonOffset:{factor:0,units:-10}})}initializePipeline(){return this.configuration.occluder&&(this._occluderPipelineTransparent=It({blending:vh,depthTest:ZU,depthWrite:null,colorWrite:Wt,stencilWrite:null,stencilTest:q$e}),this._occluderPipelineOpaque=It({blending:vh,depthTest:ZU,depthWrite:null,colorWrite:Wt,stencilWrite:j$e,stencilTest:H$e}),this._occluderPipelineMaskWrite=It({blending:null,depthTest:sie,depthWrite:null,colorWrite:null,stencilWrite:Og,stencilTest:nb})),this._occludeePipelineState=this._makePipelineState(this.configuration.transparencyPassType,!0),this._makePipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:this.configuration.occluder?e===fe.TRANSPARENT_OCCLUDER_MATERIAL?this._occluderPipelineTransparent:e===fe.OCCLUDER_MATERIAL?this._occluderPipelineOpaque:this._occluderPipelineMaskWrite:super.getPipelineState(e,r)}};BLe.shader=new $r(lTt,()=>J(()=>import("./LineMarker.glsl-df5bdb78.js"),[],import.meta.url));let cTt=class extends mb{constructor(e){super(e,new hTt),this._vertexAttributeLocations=zLe,this._configuration=new Jo,this._layout=this.createLayout()}dispose(){}getConfiguration(e,r){return this._configuration.output=e,this._configuration.space=r.slot===fe.DRAPED_MATERIAL?bh.Draped:this.parameters.worldSpace?bh.World:bh.Screen,this._configuration.hideOnShortSegments=this.parameters.hideOnShortSegments,this._configuration.hasCap=this.parameters.cap!==kd.BUTT,this._configuration.anchor=this.parameters.anchor,this._configuration.hasTip=this.parameters.hasTip,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.occluder=this.parameters.renderOccluded===Qi.OccludeAndTransparentStencil,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}intersect(){}createLayout(){const e=us().vec3f(E.POSITION).vec2f(E.UV0).vec3f(E.AUXPOS1);return this.parameters.worldSpace&&e.vec3f(E.NORMAL),this.parameters.vvSize?e.f32(E.SIZEFEATUREATTRIBUTE):e.f32(E.SIZE),this.parameters.vvColor?e.f32(E.COLORFEATUREATTRIBUTE):e.vec4f(E.COLOR),this.parameters.vvOpacity&&e.f32(E.OPACITYFEATUREATTRIBUTE),e}createBufferWriter(){return new dTt(this._layout,this.parameters)}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth?e===fe.DRAPED_MATERIAL?!0:this.parameters.renderOccluded===Qi.OccludeAndTransparentStencil?e===fe.OPAQUE_MATERIAL||e===fe.OCCLUDER_MATERIAL||e===fe.TRANSPARENT_OCCLUDER_MATERIAL:r===k.Color||r===k.Alpha?e===(this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):e===fe.OPAQUE_MATERIAL:!1}createGLMaterial(e){return new uTt(e)}},uTt=class extends zte{constructor(){super(...arguments),this._markerPrimitive=null}dispose(){super.dispose(),this._markerTextureRepository.release(this._markerPrimitive),this._markerPrimitive=null}_updateParameters(e){const r=this._material.parameters.markerPrimitive;return r!==this._markerPrimitive&&(this._material.setParameters({markerTexture:this._markerTextureRepository.swap(r,this._markerPrimitive)}),this._markerPrimitive=r),this._material.setParameters(this.textureBindParameters),this.ensureTechnique(BLe,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},hTt=class extends D${constructor(){super(...arguments),this.width=0,this.color=[1,1,1,1],this.markerPrimitive="arrow",this.placement="end",this.cap=kd.BUTT,this.anchor=ZT.Center,this.hasTip=!1,this.worldSpace=!1,this.hideOnShortSegments=!1,this.writeDepth=!0,this.hasSlicePlane=!1,this.vvFastUpdate=!1,this.hasOccludees=!1,this.markerTexture=null}},dTt=class{constructor(e,r){this.vertexBufferLayout=e,this._parameters=r}elementCount(){return this._parameters.placement==="begin-end"?12:6}write(e,r,i,s,n){const o=i.vertexAttributes.get(E.POSITION).data,a=o.length/3;let l=[1,0,0];const c=i.vertexAttributes.get(E.NORMAL);this._parameters.worldSpace&&c!=null&&(l=c.data);let h=1,p=0;this._parameters.vvSize?p=i.vertexAttributes.get(E.SIZEFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.SIZE)&&(h=i.vertexAttributes.get(E.SIZE).data[0]);let f=[1,1,1,1],m=0;this._parameters.vvColor?m=i.vertexAttributes.get(E.COLORFEATUREATTRIBUTE).data[0]:i.vertexAttributes.has(E.COLOR)&&(f=i.vertexAttributes.get(E.COLOR).data);let g=0;this._parameters.vvOpacity&&(g=i.vertexAttributes.get(E.OPACITYFEATUREATTRIBUTE).data[0]);const _=new Float32Array(s.buffer);let v=n*(this.vertexBufferLayout.stride/4);const b=(O,A,M,P)=>{if(_[v++]=O[0],_[v++]=O[1],_[v++]=O[2],_[v++]=M[0],_[v++]=M[1],_[v++]=A[0],_[v++]=A[1],_[v++]=A[2],this._parameters.worldSpace&&(_[v++]=l[0],_[v++]=l[1],_[v++]=l[2]),this._parameters.vvSize?_[v++]=p:_[v++]=h,this._parameters.vvColor)_[v++]=m;else{const F=Math.min(4*P,f.length-4);_[v++]=f[F],_[v++]=f[F+1],_[v++]=f[F+2],_[v++]=f[F+3]}this._parameters.vvOpacity&&(_[v++]=g)};let x;(function(O){O[O.ASCENDING=1]="ASCENDING",O[O.DESCENDING=-1]="DESCENDING"})(x||(x={}));const T=(O,A)=>{const M=ie(pTt,o[3*O],o[3*O+1],o[3*O+2]),P=fTt;let F=O+A;do ie(P,o[3*F],o[3*F+1],o[3*F+2]),F+=A;while(D1(M,P)&&F>=0&&F<a);e&&(Ne(M,M,e),Ne(P,P,e)),b(M,P,[-1,-1],O),b(M,P,[1,-1],O),b(M,P,[1,1],O),b(M,P,[-1,-1],O),b(M,P,[1,1],O),b(M,P,[-1,1],O)},S=this._parameters.placement;S!=="begin"&&S!=="begin-end"||T(0,x.ASCENDING),S!=="end"&&S!=="begin-end"||T(a-1,x.DESCENDING)}};const pTt=C(),fTt=C(),Fa={dash:[4,3],dot:[1,3],"long-dash":[8,3],"short-dash":[4,1],"short-dot":[1,1]},mTt={dash:Fa.dash,"dash-dot":[...Fa.dash,...Fa.dot],dot:Fa.dot,"long-dash":Fa["long-dash"],"long-dash-dot":[...Fa["long-dash"],...Fa.dot],"long-dash-dot-dot":[...Fa["long-dash"],...Fa.dot,...Fa.dot],none:null,"short-dash":Fa["short-dash"],"short-dash-dot":[...Fa["short-dash"],...Fa["short-dot"]],"short-dash-dot-dot":[...Fa["short-dash"],...Fa["short-dot"],...Fa["short-dot"]],"short-dot":Fa["short-dot"],solid:null},gTt=8;function yTt(t,e){return t==null?t:{pattern:t.slice(),pixelRatio:e}}function wqt(t){return{pattern:[t,t],pixelRatio:2}}function jLe(t){return t!=null&&t.type==="style"?_Tt(t.style):null}function _Tt(t){return t!=null?yTt(mTt[t],gTt):null}const vTt=["polyline","polygon","extent"],yfe=new L$({size:!0,color:!0,rotation:!1,opacity:!0});let HLe=class qLe extends Vg{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){if(this._fastUpdates=kA(this._context.renderer,yfe),!this._drivenProperties.size&&(this.symbolLayer.size!=null?this.symbolLayer.size:Fl(1))<0)throw new D("graphics3dlinesymbollayer:invalid-size","Symbol sizes may not be negative values")}_getMaterialParameters(e,r=!1){const i=this._getCombinedOpacityAndColor(r&&this._markerColor||this._materialColor);this._patternHidesLine&&!r&&(i[3]=0);const s={width:this._computeMaterialWidth(this.symbolLayer?.size),color:i,hasPolygonOffset:!0,join:this.symbolLayer.join||"miter",cap:zY(this.symbolLayer.cap||"butt"),hasSlicePlane:this._context.slicePlaneEnabled,isClosed:e,stipplePattern:jLe(this.symbolLayer.pattern),stippleScaleWithLineWidth:!0};return this._fastUpdates?.visualVariables?{...s,...this._fastUpdates.materialParameters}:s}get _materialColor(){return this.symbolLayer.material?.color}get _markerColor(){return this.symbolLayer.marker?.color}get _lineMaterial(){return this._lineMaterialCached==null&&(this._lineMaterialCached=new uC(this._getMaterialParameters(!1)),this._context.stage.add(this._lineMaterialCached)),this._lineMaterialCached}get _ringMaterial(){return this._ringMaterialCached==null&&(this._ringMaterialCached=new uC(this._getMaterialParameters(!0)),this._context.stage.add(this._ringMaterialCached)),this._ringMaterialCached}get _wireframeLineMaterial(){return this._wireframeLineMaterialCached==null&&(this._wireframeLineMaterialCached=new uC({...this._getMaterialParameters(!1),wireframe:!0}),this._context.stage.add(this._wireframeLineMaterialCached)),this._wireframeLineMaterialCached}get _wireframeRingMaterial(){return this._wireframeRingMaterialCached==null&&(this._wireframeRingMaterialCached=new uC({...this._getMaterialParameters(!0),wireframe:!0}),this._context.stage.add(this._wireframeRingMaterialCached)),this._wireframeRingMaterialCached}get _markerMaterial(){return this._markerMaterialCached==null&&this.symbolLayer.marker!=null&&(this._markerMaterialCached=new cTt({...this._getMaterialParameters(!1,!0),placement:this.symbolLayer.marker.placement,markerPrimitive:gfe(this.symbolLayer.marker.style)}),this._context.stage.add(this._markerMaterialCached)),this._markerMaterialCached}destroy(){super.destroy(),this._forEachMaterial(e=>this._context.stage.remove(e)),this._lineMaterialCached=null,this._ringMaterialCached=null,this._wireframeLineMaterialCached=null,this._wireframeRingMaterialCached=null,this._markerMaterialCached=null}_getDrivenSize(e){return this._drivenProperties.size&&e.size?vi(Q1t(e.size)):1}_getDrivenColor(e){const r=Vt(1,1,1,1);return this._drivenProperties.color&&e.color&&(r[0]=e.color[0],r[1]=e.color[1],r[2]=e.color[2],e.color.length>0&&(r[3]=e.color[3])),this._drivenProperties.opacity&&e.opacity&&(r[3]=e.opacity),r}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,vTt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Gf);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.draped?this._createAsOverlay(e,this._context.layer.uid):this._createAs3DShape(e,i,r.uid)}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables")return on.RecreateSymbol;{const s=this._fastUpdates;if(!UA(s,r,yfe))return on.RecreateSymbol;this._forEachMaterial(n=>n.setParameters(s.materialParameters))}}return on.FastUpdate}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const r=e.diff.diff,i={};r.size?.type==="complete"&&(i.width=this._computeMaterialWidth(r.size.newValue),delete r.size),r.cap?.type==="complete"&&(i.cap=zY(r.cap.newValue??"butt"),delete r.cap);const s=this._prepareMarkerPatch(e,r);this._prepareMaterialPatch(e,r,s),e.symbolLayerStatePatches.push(()=>this._forEachMaterial(n=>n.setParameters(i)))}layerOpacityChanged(){this._forEachMaterial((e,r)=>this._updateMaterialLayerOpacity(e,r))}_forEachMaterial(e){this._lineMaterialCached!=null&&e(this._lineMaterialCached),this._ringMaterialCached!=null&&e(this._ringMaterialCached),this._wireframeLineMaterialCached!=null&&e(this._wireframeLineMaterialCached),this._wireframeRingMaterialCached!=null&&e(this._wireframeRingMaterialCached),this._markerMaterialCached!=null&&e(this._markerMaterialCached,!0)}_updateMaterialLayerOpacity(e,r=!1){const i=e.parameters.color,s=this.symbolLayer?.material?.color,n=this._patternHidesLine&&!r?0:this._getCombinedOpacity(s),o=Vt(i[0],i[1],i[2],n);e.setParameters({color:o})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=N$(qLe.elevationModeChangeTypes,i,s);if(n!==Is.UPDATE)return n;const o=Qd(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){const e={hasSlicePlane:this._context.slicePlaneEnabled};return this._forEachMaterial(r=>r.setParameters(e)),!0}physicalBasedRenderingChanged(){return!0}_getGeometryAsPolygonOrPolyline(e){switch(e.type){case"extent":if(e instanceof vr)return bc.fromExtent(e);break;case"polygon":case"polyline":return e}return null}_createAs3DShape(e,r,i){const s=e.graphic,n=this._getGeometryAsPolygonOrPolyline(s.geometry),o=n.type==="polygon"?n.rings:n.paths,a=new Array,l=Gn(),c=nTt(n,this._context.elevationProvider,this._context.renderCoordsHelper,r),h=n.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(c,o,h,"LineSymbol3DLayer");for(let m=0;m<c.lines.length;m++){const g=c.lines[m],_=g.position,v=g.mapPositions;if(this._context.clippingExtent!=null&&(Gi(l),fh(l,v),!cf(l,this._context.clippingExtent)))continue;const b=this._createGeometry(n.type==="polygon"?this._ringMaterial:this._lineMaterial,e,_,v,n.type,vI.ELEVATED,i);a.push(b),bi.LINE_WIREFRAMES&&a.push(b.instantiate({material:n.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial})),this._markerMaterial!=null&&a.push(b.instantiate({material:this._markerMaterial}))}if(a.length===0)return null;const p=new K0({geometries:a,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),f=new Ug(this,p,a,null,null,Bvt,r);return f.alignedSampledElevation=c.sampledElevation,f.needsElevationUpdates=Qd(r.mode),f}_createGeometry(e,r,i,s,n,o,a){const l=o===vI.DRAPED?{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper}:null,c=n==="polygon",h=this._fastUpdates?.visualVariables.color,p=this._fastUpdates?.visualVariables.size,f=this._fastUpdates?.visualVariables.opacity,m=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:a,layerUid:this._context.layer.uid}),g={position:i,size:p?null:this._getDrivenSize(r.renderingInfo),color:h?null:this._getDrivenColor(r.renderingInfo),sizeFeature:p?Sf(p.field,r.graphic):null,colorFeature:h?Sf(h.field,r.graphic):null,opacityFeature:f?Sf(f.field,r.graphic):null};return BY(e,{overlayInfo:l,removeDuplicateStartEnd:c,mapPositions:s,attributeData:g},m)}_createAsOverlay(e,r){const i=e.graphic,s=this._getGeometryAsPolygonOrPolyline(i.geometry),n=s.type==="polygon"?s.rings:s.paths,o=s.type==="polygon"?this._ringMaterial:this._lineMaterial;o.renderPriority=this._renderPriority;const a=bi.LINE_WIREFRAMES?s.type==="polygon"?this._wireframeRingMaterial:this._wireframeLineMaterial:null,l=this._markerMaterial;a!=null&&(a.renderPriority=this._renderPriority-.001),l!=null&&(l.renderPriority=this._renderPriority-.002);const c=new Array,h=Gn(),p=Gi(),f=oTt(s,this._context.overlaySR),m=s.type==="polygon"?"rings":"paths";this._logGeometryCreationWarnings(f,n,m,"LineSymbol3DLayer");for(const g of f.lines){if(Gi(h),fh(h,g.position),!cf(h,this._context.clippingExtent))continue;aA(p,h);const _=v=>{const b=this._createGeometry(v,e,g.position,void 0,s.type,vI.DRAPED,i.uid),x=new jA(b,{layerUid:r,graphicUid:i.uid});c.push(x)};if(l!=null){_(l);const v=this.symbolLayer.marker.placement;v!=="begin"&&v!=="begin-end"||fh(h,g.position,0,1),v!=="end"&&v!=="begin-end"||fh(h,g.position,g.position.length-3,1)}_(o),bi.LINE_WIREFRAMES&&_(a)}return new q8(this,c,p,this._context.drapeSourceRenderer)}get _patternHidesLine(){const e=this.symbolLayer.pattern;return e!=null&&e.type==="style"&&e.style==="none"}_computeMaterialWidth(e){return e=e??Fl(1),this._drivenProperties.size?this._fastUpdates?.visualVariables.size?vi(1):1:vi(e)}_prepareMaterialPatch(e,r,i){const s=r.material;if(s==null)return void(i.changed&&i.useMaterialColor&&this._patchMaterialColor(this._getCombinedOpacityAndColor(this._materialColor),this._markerMaterialCached,e));if(s.type==="collection")return;const n=s.type==="complete"?s.newValue?.color:s.diff.color?.type==="complete"?s.diff.color.newValue:null,o=this._getCombinedOpacityAndColor(n);i.useMaterialColor&&this._patchMaterialColor(h$(o),this._markerMaterialCached,e),this._patternHidesLine&&(o[3]=0),this._patchMaterialColor(o,this._lineMaterialCached,e),delete r.material}_prepareMarkerPatch(e,r){const i=r.marker,s=this._markerMaterial;if(i==null||i.type!=="partial"||i.diff==null||i.diff.placement!=null||i.diff.style!=null&&i.diff.style.type!=="complete"||i.diff.color!=null&&i.diff.color.type!=="complete"||s==null)return{changed:!1,useMaterialColor:this._markerColor==null};const n=i.diff.color,o=n!=null,a=o?n.newValue:null,l=a==null&&this._markerColor==null;a&&this._patchMaterialColor(this._getCombinedOpacityAndColor(a),s,e);const c=i.diff.style?.newValue;return c&&e.symbolLayerStatePatches.push(()=>s.setParameters({markerPrimitive:gfe(c)})),delete r.marker,{changed:o,useMaterialColor:l}}_patchMaterialColor(e,r,i){r!=null&&i.symbolLayerStatePatches.push(()=>r.setParameters({color:e}))}};var vI;HLe.elevationModeChangeTypes={definedChanged:Is.RECREATE,staysOnTheGround:Is.NONE,onTheGroundChanged:Is.RECREATE},function(t){t[t.DRAPED=0]="DRAPED",t[t.ELEVATED=1]="ELEVATED"}(vI||(vI={}));let MR=null,JU=!0;function xG(t,e,r){if(!t||!e)throw new Error("Cannot construct image data without dimensions");if(JU)try{return new ImageData(t,e)}catch{JU=!1}return WLe(t,e,r)}function bTt(t,e,r,i){if(!e||!r)throw new Error("Cannot construct image data without dimensions");if(JU)try{return new ImageData(t,e,r)}catch{JU=!1}const s=WLe(e,r,i);return s.data.set(t,0),s}function wTt(){return MR||(MR=document.createElement("canvas"),MR.width=1,MR.height=1),MR}function WLe(t,e,r){return r||(r=wTt()),r.getContext("2d").createImageData(t,e)}var OE;const TG=new WeakMap;let xTt=0,Pm=OE=class extends he{constructor(t){super(t),this.wrap="repeat"}get url(){return this._get("url")||null}set url(t){this._set("url",t),t&&this._set("data",null)}get data(){return this._get("data")||null}set data(t){this._set("data",t),t&&this._set("url",null)}writeData(t,e,r,i){if(t instanceof HTMLImageElement){const s={type:"image-element",src:O0(t.src,i),crossOrigin:t.crossOrigin};e[r]=s}else if(t instanceof HTMLCanvasElement){const s=t.getContext("2d").getImageData(0,0,t.width,t.height),n={type:"canvas-element",imageData:this._encodeImageData(s)};e[r]=n}else if(t instanceof HTMLVideoElement){const s={type:"video-element",src:O0(t.src,i),autoplay:t.autoplay,loop:t.loop,muted:t.muted,crossOrigin:t.crossOrigin,preload:t.preload};e[r]=s}else if(t instanceof ImageData){const s={type:"image-data",imageData:this._encodeImageData(t)};e[r]=s}}readData(t){switch(t.type){case"image-element":{const e=new Image;return e.src=t.src,e.crossOrigin=t.crossOrigin,e}case"canvas-element":{const e=this._decodeImageData(t.imageData),r=document.createElement("canvas");return r.width=e.width,r.height=e.height,r.getContext("2d").putImageData(e,0,0),r}case"image-data":return this._decodeImageData(t.imageData);case"video-element":{const e=document.createElement("video");return e.src=t.src,e.crossOrigin=t.crossOrigin,e.autoplay=t.autoplay,e.loop=t.loop,e.muted=t.muted,e.preload=t.preload,e}default:return}}get transparent(){const t=this.data,e=this.url;if(t instanceof HTMLCanvasElement)return this._imageDataContainsTransparent(t.getContext("2d").getImageData(0,0,t.width,t.height));if(t instanceof ImageData)return this._imageDataContainsTransparent(t);if(e){const r=e.substr(e.length-4,4).toLowerCase(),i=e.substr(0,15).toLocaleLowerCase();if(r===".png"||i==="data:image/png;")return!0}return!1}set transparent(t){this._overrideIfSome("transparent",t)}get contentHash(){const t=typeof this.wrap=="string"?this.wrap:typeof this.wrap=="object"?`${this.wrap.horizontal}/${this.wrap.vertical}`:"",e=(r="")=>`d:${r},t:${this.transparent},w:${t}`;return this.url!=null?e(this.url):this.data!=null?this.data instanceof HTMLImageElement||this.data instanceof HTMLVideoElement?e(this.data.src):(TG.has(this.data)||TG.set(this.data,++xTt),e(TG.get(this.data))):e()}get memoryUsage(){let t=0;if(t+=this.url!=null?this.url.length:0,this.data!=null){const e=this.data;"data"in e?t+=e.data.byteLength:e instanceof HTMLImageElement?t+=e.naturalWidth*e.naturalHeight*3:e instanceof HTMLCanvasElement&&(t+=e.width*e.height*3)}return t}clone(){const t={url:this.url,data:this.data,wrap:this._cloneWrap()};return new OE(t)}cloneWithDeduplication(t){const e=t.get(this);if(e)return e;const r=this.clone();return t.set(this,r),r}_cloneWrap(){return typeof this.wrap=="string"?this.wrap:{horizontal:this.wrap.horizontal,vertical:this.wrap.vertical}}_encodeImageData(t){let e="";for(let r=0;r<t.data.length;r++)e+=String.fromCharCode(t.data[r]);return{data:btoa(e),width:t.width,height:t.height}}_decodeImageData(t){const e=atob(t.data),r=new Uint8ClampedArray(e.length);for(let i=0;i<e.length;i++)r[i]=e.charCodeAt(i);return bTt(r,t.width,t.height)}_imageDataContainsTransparent(t){for(let e=3;e<t.data.length;e+=4)if(t.data[e]!==255)return!0;return!1}static from(t){return typeof t=="string"?new OE({url:t}):t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData||t instanceof HTMLVideoElement?new OE({data:t}):bT(OE,t)}};u([d({type:String,json:{write:U1}})],Pm.prototype,"url",null),u([d({json:{write:{overridePolicy(){return{enabled:!this.url}}}}}),d()],Pm.prototype,"data",null),u([Ve("data")],Pm.prototype,"writeData",null),u([Ae("data")],Pm.prototype,"readData",null),u([d({type:Boolean,json:{write:{overridePolicy(){return{enabled:this._isOverridden("transparent")}}}}})],Pm.prototype,"transparent",null),u([d({json:{write:!0}})],Pm.prototype,"wrap",void 0),u([d({readOnly:!0})],Pm.prototype,"contentHash",null),Pm=OE=u([R("esri.geometry.support.MeshTexture")],Pm);const bI=Pm;let RE=class extends rs(he){constructor(e){super(e),this.offset=[0,0],this.rotation=0,this.scale=[1,1]}};u([d({type:[Number],nonNullable:!0,json:{write:!0}})],RE.prototype,"offset",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0}})],RE.prototype,"rotation",void 0),u([d({type:[Number],nonNullable:!0,json:{write:!0}})],RE.prototype,"scale",void 0),RE=u([R("esri.geometry.support.MeshTextureTransform")],RE);const HC=RE;var GY;let Vp=GY=class extends he{constructor(t){super(t),this.color=null,this.colorTexture=null,this.colorTextureTransform=null,this.normalTexture=void 0,this.normalTextureTransform=void 0,this.alphaMode="auto",this.alphaCutoff=.5,this.doubleSided=!0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=t!=null?t.get(this):null;if(r)return r;const i=new GY(this.clonePropertiesWithDeduplication(e));return t?.set(this,i),i}clonePropertiesWithDeduplication(t){return{color:this.color!=null?this.color.clone():null,colorTexture:this.colorTexture?.cloneWithDeduplication(t),normalTexture:this.normalTexture?.cloneWithDeduplication(t),alphaMode:this.alphaMode,alphaCutoff:this.alphaCutoff,doubleSided:this.doubleSided,colorTextureTransform:this.colorTextureTransform?.clone(),normalTextureTransform:this.normalTextureTransform?.clone()}}get memoryUsage(){return this.getMemoryUsage()}getMemoryUsage(){let t=0;return t+=this.color!=null?16:0,this.colorTexture!=null&&(t+=this.colorTexture.memoryUsage),t+=this.colorTextureTransform!=null?20:0,this.normalTexture!=null&&(t+=this.normalTexture.memoryUsage),t+=this.normalTextureTransform!=null?20:0,t}};u([d({type:Le,json:{write:!0}})],Vp.prototype,"color",void 0),u([d({type:bI,json:{write:!0}})],Vp.prototype,"colorTexture",void 0),u([d({type:HC,json:{write:!0}})],Vp.prototype,"colorTextureTransform",void 0),u([d({type:bI,json:{write:!0}})],Vp.prototype,"normalTexture",void 0),u([d({type:HC,json:{write:!0}})],Vp.prototype,"normalTextureTransform",void 0),u([d({nonNullable:!0,json:{write:!0}})],Vp.prototype,"alphaMode",void 0),u([d({nonNullable:!0,json:{write:!0}})],Vp.prototype,"alphaCutoff",void 0),u([d({nonNullable:!0,json:{write:!0}})],Vp.prototype,"doubleSided",void 0),Vp=GY=u([R("esri.geometry.support.MeshMaterial")],Vp);const wie=Vp;var jY;let sd=jY=class extends wie{constructor(t){super(t),this.emissiveColor=null,this.emissiveTexture=null,this.emissiveTextureTransform=void 0,this.occlusionTexture=null,this.occlusionTextureTransform=void 0,this.metallic=1,this.roughness=1,this.metallicRoughnessTexture=null,this.metallicRoughnessTextureTransform=void 0}clone(){return this.cloneWithDeduplication(null,new Map)}cloneWithDeduplication(t,e){const r=t!=null?t.get(this):null;if(r)return r;const i=new jY(this.clonePropertiesWithDeduplication(e));return t?.set(this,i),i}getMemoryUsage(){let t=super.getMemoryUsage();return t+=this.emissiveColor!=null?16:0,this.emissiveTexture!=null&&(t+=this.emissiveTexture.memoryUsage),t+=this.emissiveTextureTransform!=null?20:0,this.occlusionTexture!=null&&(t+=this.occlusionTexture.memoryUsage),t+=this.occlusionTextureTransform!=null?20:0,this.metallicRoughnessTexture!=null&&(t+=this.metallicRoughnessTexture.memoryUsage),t+=this.metallicRoughnessTextureTransform!=null?20:0,t}clonePropertiesWithDeduplication(t){return{...super.clonePropertiesWithDeduplication(t),emissiveColor:this.emissiveColor?.clone(),emissiveTexture:this.emissiveTexture?.cloneWithDeduplication(t),emissiveTextureTransform:this.emissiveTextureTransform?.clone(),occlusionTexture:this.occlusionTexture?.cloneWithDeduplication(t),occlusionTextureTransform:this.occlusionTextureTransform?.clone(),metallic:this.metallic,roughness:this.roughness,metallicRoughnessTexture:this.metallicRoughnessTexture?.cloneWithDeduplication(t),metallicRoughnessTextureTransform:this.metallicRoughnessTextureTransform?.clone()}}};u([d({type:Le,json:{write:!0}})],sd.prototype,"emissiveColor",void 0),u([d({type:bI,json:{write:!0}})],sd.prototype,"emissiveTexture",void 0),u([d({type:HC,json:{write:!0}})],sd.prototype,"emissiveTextureTransform",void 0),u([d({type:bI,json:{write:!0}})],sd.prototype,"occlusionTexture",void 0),u([d({type:HC,json:{write:!0}})],sd.prototype,"occlusionTextureTransform",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],sd.prototype,"metallic",void 0),u([d({type:Number,nonNullable:!0,json:{write:!0},range:{min:0,max:1}})],sd.prototype,"roughness",void 0),u([d({type:bI,json:{write:!0}})],sd.prototype,"metallicRoughnessTexture",void 0),u([d({type:HC,json:{write:!0}})],sd.prototype,"metallicRoughnessTextureTransform",void 0),sd=jY=u([R("esri.geometry.support.MeshMaterialMetallicRoughness")],sd);const ZLe=sd;var d5;const XLe="esri.geometry.support.MeshVertexAttributes",f2=K.getLogger(XLe);let Uh=d5=class extends he{constructor(t){super(t),this.color=null,this.position=new Float64Array(0),this.uv=null,this.normal=null,this.tangent=null}castColor(t){return ME(t,Uint8Array,[Uint8ClampedArray],{loggerTag:".color=",stride:4},f2)}castPosition(t){return t&&t instanceof Float32Array&&f2.warn(".position=","Setting position attribute from a Float32Array may cause precision problems. Consider storing data in a Float64Array or a regular number array"),ME(t,Float64Array,[Float32Array],{loggerTag:".position=",stride:3},f2)}castUv(t){return ME(t,Float32Array,[Float64Array],{loggerTag:".uv=",stride:2},f2)}castNormal(t){return ME(t,Float32Array,[Float64Array],{loggerTag:".normal=",stride:3},f2)}castTangent(t){return ME(t,Float32Array,[Float64Array],{loggerTag:".tangent=",stride:4},f2)}clone(){const t={position:re(this.position),uv:re(this.uv),normal:re(this.normal),tangent:re(this.tangent),color:re(this.color)};return new d5(t)}clonePositional(){const t={position:re(this.position),normal:re(this.normal),tangent:re(this.tangent),uv:this.uv,color:this.color};return new d5(t)}get memoryUsage(){let t=0;return t+=this.position.byteLength,this.uv!=null&&(t+=this.uv.byteLength),this.normal!=null&&(t+=this.normal.byteLength),this.tangent!=null&&(t+=this.tangent.byteLength),this.color!=null&&(t+=this.color.byteLength),t}};function SG(t,e,r,i){const{loggerTag:s,stride:n}=e;return t.length%n!=0?(i.error(s,`Invalid array length, expected a multiple of ${n}`),new r([])):t}function ME(t,e,r,i,s){if(!t)return t;if(t instanceof e)return SG(t,i,e,s);for(const n of r)if(t instanceof n)return SG(new e(t),i,e,s);if(Array.isArray(t))return SG(new e(t),i,e,s);{const n=r.map(o=>`'${o.name}'`);return s.error(`Failed to set property, expected one of ${n}, but got ${t.constructor.name}`),new e([])}}function IR(t,e,r){e[r]=TTt(t)}function TTt(t){const e=new Array(t.length);for(let r=0;r<t.length;r++)e[r]=t[r];return e}u([d({json:{write:IR}})],Uh.prototype,"color",void 0),u([or("color")],Uh.prototype,"castColor",null),u([d({nonNullable:!0,json:{write:IR}})],Uh.prototype,"position",void 0),u([or("position")],Uh.prototype,"castPosition",null),u([d({json:{write:IR}})],Uh.prototype,"uv",void 0),u([or("uv")],Uh.prototype,"castUv",null),u([d({json:{write:IR}})],Uh.prototype,"normal",void 0),u([or("normal")],Uh.prototype,"castNormal",null),u([d({json:{write:IR}})],Uh.prototype,"tangent",void 0),u([or("tangent")],Uh.prototype,"castTangent",null),Uh=d5=u([R(XLe)],Uh);var gM;const YLe="esri.geometry.support.MeshComponent",STt=K.getLogger(YLe);let Py=gM=class extends he{static from(t){return bT(gM,t)}constructor(t){super(t),this.faces=null,this.material=null,this.shading="source",this.trustSourceNormals=!1}castFaces(t){return ME(t,Uint32Array,[Uint16Array],{loggerTag:".faces=",stride:3},STt)}castMaterial(t){return bT(t&&typeof t=="object"&&("metallic"in t||"roughness"in t||"metallicRoughnessTexture"in t)?ZLe:wie,t)}clone(){return new gM({faces:re(this.faces),shading:this.shading,material:re(this.material),trustSourceNormals:this.trustSourceNormals})}cloneWithDeduplication(t,e){const r={faces:re(this.faces),shading:this.shading,material:this.material?this.material.cloneWithDeduplication(t,e):null,trustSourceNormals:this.trustSourceNormals};return new gM(r)}get memoryUsage(){let t=0;return this.faces!=null&&(t+=this.faces.byteLength),this.material!=null&&(t+=this.material.memoryUsage),t}};u([d({json:{write:!0}})],Py.prototype,"faces",void 0),u([or("faces")],Py.prototype,"castFaces",null),u([d({type:wie,json:{write:!0}})],Py.prototype,"material",void 0),u([or("material")],Py.prototype,"castMaterial",null),u([d({type:String,json:{write:!0}})],Py.prototype,"shading",void 0),u([d({type:Boolean})],Py.prototype,"trustSourceNormals",void 0),Py=gM=u([R(YLe)],Py);const ETt=Py,W8=K.getLogger("esri.geometry.support.meshUtils.normalProjection");function CTt(t,e,r,i,s){return X8(i)?(Z8(v0.TO_PCPF,zn.fromTypedArray(t),Yd.fromTypedArray(e),Yd.fromTypedArray(r),i,zn.fromTypedArray(s)),s):(W8.error("Cannot convert spatial reference to PCPF"),s)}function Tqt(t,e,r,i,s){return X8(i)?(Z8(v0.FROM_PCPF,zn.fromTypedArray(t),Yd.fromTypedArray(e),Yd.fromTypedArray(r),i,zn.fromTypedArray(s)),s):(W8.error("Cannot convert to spatial reference from PCPF"),s)}function Sqt(t,e,r){return wi(t,e,0,r,Sg(e),0,t.length/3),r}function Eqt(t,e,r){return wi(t,Sg(r),0,e,r,0,t.length/3),e}function ATt(t,e,r){return Z1(Eo,r),WT(e,t,Eo),dte(Eo)||U8(e,e),e}function OTt(t,e,r){if(Z1(Eo,r),WT(e,t,Eo,4),dte(Eo)||U8(e,e,4),t!==e)for(let i=3;i<t.length;i+=4)e[i]=t[i];return e}function RTt(t,e,r,i,s){if(!X8(i))return W8.error("Cannot convert spatial reference to PCPF"),s;Z8(v0.TO_PCPF,zn.fromTypedArray(t,4*Float32Array.BYTES_PER_ELEMENT),Yd.fromTypedArray(e),Yd.fromTypedArray(r),i,zn.fromTypedArray(s,4*Float32Array.BYTES_PER_ELEMENT));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function Cqt(t,e,r,i,s){if(!X8(i))return W8.error("Cannot convert to spatial reference from PCPF"),s;Z8(v0.FROM_PCPF,zn.fromTypedArray(t,16),Yd.fromTypedArray(e),Yd.fromTypedArray(r),i,zn.fromTypedArray(s,16));for(let n=3;n<t.length;n+=4)s[n]=t[n];return s}function Z8(t,e,r,i,s,n){if(!e)return;const o=r.count,a=Sg(s);if(JLe(s))for(let l=0;l<o;l++)i.getVec(l,CN),e.getVec(l,am),wc(a,CN,AN,a),qd(Eo,AN),t===v0.FROM_PCPF&&Wd(Eo,Eo),yu(am,am,Eo),n.setVec(l,am);else for(let l=0;l<o;l++){i.getVec(l,CN),e.getVec(l,am),wc(a,CN,AN,a),qd(Eo,AN);const c=K5(r.get(l,1));let h=Math.cos(c);t===v0.TO_PCPF&&(h=1/h),Eo[0]*=h,Eo[1]*=h,Eo[2]*=h,Eo[3]*=h,Eo[4]*=h,Eo[5]*=h,t===v0.FROM_PCPF&&Wd(Eo,Eo),yu(am,am,Eo),_e(am,am),n.setVec(l,am)}return n}function X8(t){return JLe(t)||MTt(t)}function JLe(t){return t.isWGS84||x1e(t)||Pg(t)||$g(t)}function MTt(t){return t.isWebMercator}var v0;(function(t){t[t.TO_PCPF=0]="TO_PCPF",t[t.FROM_PCPF=1]="FROM_PCPF"})(v0||(v0={}));const CN=C(),am=C(),AN=xe(),Eo=ts();var wI;(function(t){t[t.EnableFastUpdates=0]="EnableFastUpdates",t[t.DisableFastUpdates=1]="DisableFastUpdates",t[t.UpdateFastLocalOrigin=2]="UpdateFastLocalOrigin"})(wI||(wI={}));let QLe=class{constructor(e){this.data=e,this.type="encoded-mesh-texture",this.encoding=m0.KTX2_ENCODING}};function fT(t){return t?.type==="encoded-mesh-texture"}async function ITt(t){return new Promise((e,r)=>{const i=new Blob([t]),s=new FileReader;s.onload=()=>{const n=s.result;e(JSON.parse(n))},s.onerror=n=>{r(n)},s.readAsText(i)})}async function PTt(t,e){return e===m0.KTX2_ENCODING?new QLe(t):new Promise((r,i)=>{const s=new Blob([t],{type:e}),n=URL.createObjectURL(s),o=new Image,a=()=>{URL.revokeObjectURL(n),"decode"in o?o.decode().then(()=>r(o),()=>r(o)).then(c):(r(o),c())},l=h=>{URL.revokeObjectURL(n),i(h),c()},c=()=>{o.removeEventListener("load",a),o.removeEventListener("error",l)};o.addEventListener("load",a),o.addEventListener("error",l),o.src=n})}function Ym(t){if(t==null)return null;const e=t.offset!=null?t.offset:c$e,r=t.rotation!=null?t.rotation:0,i=t.scale!=null?t.scale:u$e,s=u5(1,0,0,0,1,0,e[0],e[1],1),n=u5(Math.cos(r),-Math.sin(r),0,Math.sin(r),Math.cos(r),0,0,0,1),o=u5(i[0],0,0,0,i[1],0,0,0,1),a=Tc();return wA(a,n,o),wA(a,s,a),a}K.getLogger("esri.views.3d.layers.graphics.Graphics3DMeshObject3DGraphicLayer");let $Tt=class extends Ug{constructor(){super(...arguments),this._originalGeometries=[],this._fastTransformUpdatesEnabled=!1}get fastTransformUpdatesEnabled(){return this._fastTransformUpdatesEnabled}enableFastTransformUpdates(e,r){if(this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!0;const{stageObject:i}=this,s=i.geometries.slice();i.removeAllGeometries();const n=Gq(EG,i.transformation),o=r.getOrigin(n);for(const a of s){const l=e(a.material),c=a.instantiate({material:l});c.localOrigin=o,i.addGeometry(c)}this._originalGeometries=s}disableFastTransformUpdates(e){if(!this._fastTransformUpdatesEnabled)return;this._fastTransformUpdatesEnabled=!1;const{stageObject:r}=this,i=r.geometries.map(s=>e(s.material));r.removeAllGeometries();for(let s=0;s<this._originalGeometries.length;s++){const n=this._originalGeometries[s],o=i[s];o.setParameters({modelTransformation:null}),o===n.material?r.addGeometry(n):r.addGeometry(n.instantiate({material:o}))}this._originalGeometries.length=0}updateFastLocalOrigin(e,r,i){if(!this._fastTransformUpdatesEnabled)return;const{stageObject:s}=this;if(s.geometries.length===0)return;const n=s.geometries[0].localOrigin,o=Gq(EG,e),a=i.getOrigin(o);if(a===n)return;const l=r?.localMatrix??Un;s.clearShaderTransformation(),s.transformation=e,s.geometries.forEach(c=>{c.transformation=l,c.localOrigin=a})}updateTransform(e,r,i){const{stageObject:s}=this,n=r?.localMatrix??Un;if(!this._fastTransformUpdatesEnabled)return s.clearShaderTransformation(),s.transformation=e,s.geometries.forEach(m=>{m.transformation=n}),void this.resetEdgeObject(i);const o=s.transformation,a=s.geometries[0].transformation,l=e,c=n,h=yi(_fe,o,a),p=yi(vfe,l,c);s.shaderTransformation=l,this._setFastMaterialTransformation({matA:h,matB:p});const f=()=>c;for(const m of s.geometries)m.shaderTransformer=f;this.resetEdgeObject(i)}alignWithElevation(e,r,i,s){if(!this._fastTransformUpdatesEnabled)return void super.alignWithElevation(e,r,i,s);i!=null&&N8(this.elevationContext.featureExpressionInfoContext,i);const n=(m,g)=>rb(m,e,this.elevationContext,r,g),{stageObject:o}=this;if(!o.geometries[0].material.parameters.modelTransformation)return;const a=o.transformation,l=o.geometries[0].transformation,c=yi(_fe,a,l),h=an(LTt,o.shaderTransformation);this.alignedSampledElevation=uT(this,this.elevationContext,e.spatialReference,n,r,h),o.shaderTransformation=h;const p=o.geometries[0].shaderTransformation,f=yi(vfe,h,p);this._setFastMaterialTransformation({matA:c,matB:f}),this.resetEdgeObject(s)}_setFastMaterialTransformation({matA:e,matB:r}){const{stageObject:i}=this;if(i.geometries.length===0)return;const s=i.geometries[0].localOrigin,n=d$(DTt,ae(EG,s.vec3,-1)),o=yi(bfe,n,e),a=yi(wfe,n,r),l=so(bfe,o),c=yi(wfe,a,l);for(const h of i.geometries)h.material.setParameters({modelTransformation:c})}};const EG=C(),_fe=xe(),vfe=xe(),LTt=xe(),bfe=xe(),wfe=xe(),DTt=xe();let NTt=class{constructor(){this._fastTransformOriginalMaterials=new Map,this._fastTransformClonedMaterials=new Map,this._graphicReferenceCount=0}enable(e,r,i){e.enableFastTransformUpdates(s=>{if(this._graphicReferenceCount<=1){if(this._fastTransformOriginalMaterials.has(s))return s;const o=r.byMaterial(s);return this._fastTransformOriginalMaterials.set(s,o),r.delete(s),s}const n=new Rg(s.parameters);return i.stage.add(n),this._fastTransformClonedMaterials.set(n,s),n},i.localOriginFactory)}disable(e,r,i){const s=new Set,n=new Set;e.disableFastTransformUpdates(o=>{if(!this._fastTransformClonedMaterials.has(o)){const c=o,h=this._fastTransformOriginalMaterials.get(c);return r.has(h.uid)?(s.add(c),r.byUid(h.uid).material):(n.add(c),h.material)}const a=o,l=this._fastTransformClonedMaterials.get(a);return this._fastTransformClonedMaterials.delete(a),i.stage.remove(a),a.dispose(),l});for(const o of s)this._fastTransformOriginalMaterials.delete(o),i.stage.remove(o),o.dispose();for(const o of n){const a=this._fastTransformOriginalMaterials.get(o);this._fastTransformOriginalMaterials.delete(o),r.set(a.uid,a)}}onAddGraphic(){this._graphicReferenceCount++}onRemoveGraphic(e,r,i){this._graphicReferenceCount--,this.disable(e,r,i)}forEachMaterialInfo(e){this._fastTransformOriginalMaterials.forEach(e)}forEachClonedMaterial(e){this._fastTransformClonedMaterials.forEach(e)}destroy(e){e.removeMany(Array.from(this._fastTransformClonedMaterials.keys())),e.removeMany(Array.from(this._fastTransformOriginalMaterials.values(),({material:r})=>r)),this._fastTransformClonedMaterials.clear(),this._fastTransformOriginalMaterials.clear()}},FTt=class{constructor(){this._byUid=new Map,this._byMaterial=new Map}get materials(){return Array.from(this._byUid.values(),e=>e.material)}byUid(e){return this._byUid.get(e)}byMaterial(e){return this._byMaterial.get(e)}set(e,r){this._byUid.set(e,r),this._byMaterial.set(r.material,r)}delete(e){const r=this._byMaterial.get(e)?.uid;r&&(this._byUid.delete(r),this._byMaterial.delete(e))}has(e){return this._byUid.has(e)}forEachMaterialInfo(e){this._byUid.forEach(e)}clear(){this._byUid.clear(),this._byMaterial.clear()}};function kTt(t){const e=new Cr,{vertex:r,fragment:i}=e;return e.include(_c,t),e.include(xS,t),e.include(z$e,t),Eu(r,t),t.stippleEnabled&&(e.attributes.add(E.UV0,"vec2"),e.attributes.add(E.AUXPOS1,"vec3"),r.uniforms.add(new cr("viewport",(s,n)=>n.camera.fullViewport))),e.attributes.add(E.POSITION,"vec3"),e.varyings.add("vpos","vec3"),r.code.add(w`void main(void) {
vpos = position;
forwardNormalizedVertexColor();
gl_Position = transformPosition(proj, view, vpos);`),t.stippleEnabled&&(r.code.add(w`vec4 vpos2 = transformPosition(proj, view, auxpos1);
vec2 ndcToPixel = viewport.zw * 0.5;
float lineSegmentPixelSize = length((vpos2.xy / vpos2.w - gl_Position.xy / gl_Position.w) * ndcToPixel);`),t.draped?r.uniforms.add(new Ie("worldToScreenRatio",(s,n)=>1/n.screenToPCSRatio)):r.code.add(w`vec3 segmentCenter = (position + auxpos1) * 0.5;
float worldToScreenRatio = computeWorldToScreenRatio(segmentCenter);`),r.code.add(w`float discreteWorldToScreenRatio = discretizeWorldToScreenRatio(worldToScreenRatio);`),t.draped?r.code.add(w`float startPseudoScreen = uv0.y * discreteWorldToScreenRatio - mix(0.0, lineSegmentPixelSize, uv0.x);
float segmentLengthPseudoScreen = lineSegmentPixelSize;`):r.code.add(w`float segmentLengthRender = length(position - auxpos1);
float startPseudoScreen = mix(uv0.y, uv0.y - segmentLengthRender, uv0.x) * discreteWorldToScreenRatio;
float segmentLengthPseudoScreen = segmentLengthRender * discreteWorldToScreenRatio;`),r.uniforms.add(new Ie("stipplePatternPixelSize",s=>rie(s))),r.code.add(w`vec2 stippleDistanceLimits = computeStippleDistanceLimits(startPseudoScreen, segmentLengthPseudoScreen, lineSegmentPixelSize, stipplePatternPixelSize);
vStippleDistance = mix(stippleDistanceLimits.x, stippleDistanceLimits.y, uv0.x);
vStippleDistance *= gl_Position.w;`)),r.code.add(w`}`),t.output===k.Highlight&&e.include(J0,t),e.include(Bs,t),i.uniforms.add(new Ie("alphaCoverage",(s,n)=>Math.min(1,s.width*n.camera.pixelRatio))),t.hasVertexColors||i.uniforms.add(new cr("constantColor",s=>s.color)),i.code.add(w`
  void main() {
    discardBySlice(vpos);

    vec4 color = ${t.hasVertexColors?"vColor":"constantColor"};

    float stippleAlpha = getStippleAlpha();
    discardByStippleAlpha(stippleAlpha, stippleAlphaColorDiscard);

    vec4 finalColor = blendStipple(vec4(color.rgb, color.a * alphaCoverage), stippleAlpha);

    ${t.output===k.ObjectAndLayerIdColor?w`finalColor.a = 1.0;`:""}

    if (finalColor.a < ${w.float(ia)}) {
      discard;
    }

    ${t.output===k.Color?w`fragColor = highlightSlice(finalColor, vpos);`:""}
    ${t.output===k.Highlight?w`outputHighlight();`:""}
  }
  `),e}const UTt=Object.freeze(Object.defineProperty({__proto__:null,build:kTt},Symbol.toStringTag,{value:"Module"}));let KLe=class eDe extends Ur{get _stippleEnabled(){return this.configuration.stippleEnabled&&this.configuration.output!==k.Highlight}initializeProgram(e){return new Lr(e.rctx,eDe.shader.get().build(this.configuration),Er)}initializePipeline(){const e=this.configuration,r=ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),i=(s,n=null,o=null)=>It({blending:n,depthTest:sie,depthWrite:o,colorWrite:Wt,stencilWrite:e.hasOccludees?Og:null,stencilTest:e.hasOccludees?s?nb:yb:null});return e.output===k.Color?(this._occludeePipelineState=i(!0,e.transparent||this._stippleEnabled?r:null,Ac),i(!1,e.transparent||this._stippleEnabled?r:null,Ac)):i(!1)}get primitiveType(){return Ot.LINES}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};KLe.shader=new $r(UTt,()=>J(()=>import("./NativeLine.glsl-2bfbeed8.js"),[],import.meta.url));let Xu=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.draped=!1,this.stippleEnabled=!1,this.stippleOffColorEnabled=!1,this.stipplePreferContinuous=!0,this.hasOccludees=!1}};u([B({count:k.COUNT})],Xu.prototype,"output",void 0),u([B()],Xu.prototype,"hasSlicePlane",void 0),u([B()],Xu.prototype,"hasVertexColors",void 0),u([B()],Xu.prototype,"transparent",void 0),u([B()],Xu.prototype,"draped",void 0),u([B()],Xu.prototype,"stippleEnabled",void 0),u([B()],Xu.prototype,"stippleOffColorEnabled",void 0),u([B()],Xu.prototype,"stipplePreferContinuous",void 0),u([B()],Xu.prototype,"hasOccludees",void 0),u([B({constValue:!1})],Xu.prototype,"stippleRequiresClamp",void 0),u([B({constValue:!1})],Xu.prototype,"stippleScaleWithLineWidth",void 0),u([B({constValue:!1})],Xu.prototype,"stippleRequiresStretchMeasure",void 0);var QU;(function(t){t[t.START=0]="START",t[t.END=1]="END"})(QU||(QU={}));let xfe=class extends mb{constructor(e){super(e,new BTt),this._configuration=new Xu}getConfiguration(e,r){this._configuration.output=e,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.hasVertexColors=this.parameters.hasVertexColors,this._configuration.transparent=this.parameters.color[3]<1||this.parameters.width<1,this._configuration.draped=r.slot===fe.DRAPED_MATERIAL;const i=this.parameters.stipplePattern!=null;return this._configuration.stippleEnabled=i,this._configuration.stippleOffColorEnabled=i&&this.parameters.stippleOffColor!=null,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.stipplePreferContinuous=this.parameters.stipplePreferContinuous,this._configuration}intersect(e,r,i,s,n,o){if(!i.options.selectionMode||!e.visible)return;if(!HRe(r))return void K.getLogger("esri.views.3d.webgl-engine.materials.NativeLineMaterial").error("intersection assumes a translation-only matrix");const a=e.vertexAttributes.get(E.POSITION).data,l=i.camera,c=jTt;jn(c,i.point);const h=2;ie(PR[0],c[0]-h,c[1]+h,0),ie(PR[1],c[0]+h,c[1]+h,0),ie(PR[2],c[0]+h,c[1]-h,0),ie(PR[3],c[0]-h,c[1]-h,0);for(let _=0;_<4;_++)if(!l.unprojectFromRenderScreen(PR[_],ty[_]))return;Wa(l.eye,ty[0],ty[1],CG),Wa(l.eye,ty[1],ty[2],AG),Wa(l.eye,ty[2],ty[3],OG),Wa(l.eye,ty[3],ty[0],RG);let p=Number.MAX_VALUE,f=0;for(let _=0;_<a.length-5;_+=3){if(wl[0]=a[_]+r[12],wl[1]=a[_+1]+r[13],wl[2]=a[_+2]+r[14],xl[0]=a[_+3]+r[12],xl[1]=a[_+4]+r[13],xl[2]=a[_+5]+r[14],Oi(CG,wl)<0&&Oi(CG,xl)<0||Oi(AG,wl)<0&&Oi(AG,xl)<0||Oi(OG,wl)<0&&Oi(OG,xl)<0||Oi(RG,wl)<0&&Oi(RG,xl)<0)continue;if(l.projectToRenderScreen(wl,Xb),l.projectToRenderScreen(xl,Yb),Xb[2]<0&&Yb[2]>0){pe(lm,wl,xl);const b=l.frustum,x=-Oi(b[Ai.NEAR],wl)/de(lm,b[Ai.NEAR]);ae(lm,lm,x),ue(wl,wl,lm),l.projectToRenderScreen(wl,Xb)}else if(Xb[2]>0&&Yb[2]<0){pe(lm,xl,wl);const b=l.frustum,x=-Oi(b[Ai.NEAR],xl)/de(lm,b[Ai.NEAR]);ae(lm,lm,x),ue(xl,xl,lm),l.projectToRenderScreen(xl,Yb)}else if(Xb[2]<0&&Yb[2]<0)continue;Xb[2]=0,Yb[2]=0;const v=xte(aT(Xb,Yb,Efe),c);v<p&&(p=v,oe(Tfe,wl),oe(Sfe,xl),f=_/3)}const m=i.rayBegin,g=i.rayEnd;if(p<h*h){let _=Number.MAX_VALUE;if(sRe(aT(Tfe,Sfe,Efe),aT(m,g,GTt),Zb)){pe(Zb,Zb,m);const v=Oe(Zb);ae(Zb,Zb,1/v),_=v/_i(m,g)}o(_,Zb,f,!1)}}intersectDraped(e,r,i,s,n,o){if(!i.options.selectionMode)return;const a=e.vertexAttributes.get(E.POSITION).data,l=e.vertexAttributes.get(E.SIZE),c=l?l.data[0]:0,h=s[0],p=s[1],f=((c+1)/2+4)*e.screenToWorldRatio;let m=Number.MAX_VALUE,g=0;for(let _=0;_<a.length-5;_+=3){const v=a[_],b=a[_+1],x=h-v,T=p-b,S=a[_+3]-v,O=a[_+4]-b,A=ye((S*x+O*T)/(S*S+O*O),0,1),M=S*A-x,P=O*A-T,F=M*M+P*P;F<m&&(m=F,g=_/3)}m<f*f&&n(o.dist,o.normal,g,!1)}requiresSlot(e,r){return!(r!==k.Color&&r!==k.Highlight&&r!==k.ObjectAndLayerIdColor||e!==fe.OPAQUE_MATERIAL&&e!==fe.DRAPED_MATERIAL)}createGLMaterial(e){return new VTt(e)}createBufferWriter(){const e=this.parameters.hasVertexColors?rwt:ewt;return this.parameters.stipplePattern==null?new IO(e):new zTt(e.clone().vec3f(E.AUXPOS1).vec2f(E.UV0))}},VTt=class extends pb{constructor(){super(...arguments),this._stipplePattern=null}dispose(){super.dispose(),this._stippleTextureRepository.release(this._stipplePattern),this._stipplePattern=null}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){this._output===k.Color&&this._updateOccludeeState(e);const r=this._material.parameters.stipplePattern;return this._stipplePattern!==r&&(this._material.setParameters({stippleTexture:this._stippleTextureRepository.swap(r,this._stipplePattern)}),this._stipplePattern=r),this.ensureTechnique(KLe,e)}},zTt=class{constructor(e){this.vertexBufferLayout=e}elementCount(e){return e.indices.get(E.POSITION).length}write(e,r,i,s,n){iPe(i,this.vertexBufferLayout,e,r,s,n),this._writeAuxpos1(e,i,s,n),this._writeUV0(e,i,s,n)}_writeAuxpos1(e,r,i,s){const n=i.getField(E.AUXPOS1,zn),o=r.indices.get(E.POSITION),a=r.vertexAttributes.get(E.POSITION).data,l=e,c=n.typedBufferStride,h=n.typedBuffer;s*=c;for(let p=0;p<o.length-1;p+=2)for(const f of[1,0]){const m=3*o[p+f],g=a[m],_=a[m+1],v=a[m+2],b=l[0]*g+l[4]*_+l[8]*v+l[12],x=l[1]*g+l[5]*_+l[9]*v+l[13],T=l[2]*g+l[6]*_+l[10]*v+l[14];h[s]=b,h[s+1]=x,h[s+2]=T,s+=c}}_writeUV0(e,r,i,s){const n=i.getField(E.UV0,fb),o=r.indices.get(E.POSITION),a=r.vertexAttributes.get(E.POSITION).data,l=r.vertexAttributes.get(E.DISTANCETOSTART)?.data,c=n.typedBufferStride,h=n.typedBuffer;let p=0;h[s*=c]=QU.START,h[s+1]=p,s+=c;const f=3*o[0],m=ie(wl,a[f],a[f+1],a[f+2]);e&&Ne(m,m,e);const g=xl,_=o.length-1;let v=1;const b=l?(T,S,O)=>p=l[O]:(T,S,O)=>p+=_i(T,S);for(let T=1;T<_;T+=2){const S=3*o[T];ie(g,a[S],a[S+1],a[S+2]),e&&Ne(g,g,e),b(m,g,v++);for(let O=0;O<2;++O)h[s]=1-O,h[s+1]=p,s+=c;oe(m,g)}const x=3*o[_];ie(g,a[x],a[x+1],a[x+2]),e&&Ne(g,g,e),b(m,g,v),h[s]=QU.END,h[s+1]=p}},BTt=class extends Dre{constructor(){super(...arguments),this.color=Od,this.hasVertexColors=!1,this.hasSlicePlane=!1,this.width=1,this.stipplePreferContinuous=!0,this.hasOccludees=!1,this.stippleTexture=null}};const wl=C(),xl=C(),lm=C(),Zb=C(),Xb=Lo(),Yb=Lo(),Tfe=C(),Sfe=C(),Efe=Vf(),GTt=Vf(),jTt=C(),PR=[Lo(),Lo(),Lo(),Lo()],ty=[C(),C(),C(),C()],CG=zr(),AG=zr(),OG=zr(),RG=zr(),HTt=["mesh"];let qTt=class extends Vg{constructor(e,r,i,s){super(e,r,i,s),this._materialInfoCache=new FTt,this._fastUpdateProcessor=new NTt,this._textures=new Map,this.ensureDrapedStatus(!1)}async doLoad(){bi.DRAW_MESH_GEOMETRY_NORMALS&&(this._debugVertexNormalMaterial=new xfe({color:[1,0,1,1]}),this._debugFaceNormalMaterial=new xfe({color:[0,1,1,1]}))}destroy(){super.destroy(),this._context.stage.removeMany(this._materialInfoCache.materials),this._context.stage.removeMany(Array.from(this._textures.values())),this._materialInfoCache.clear(),this._textures.clear(),this._fastUpdateProcessor.destroy(this._context.stage)}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,HTt,"fill on mesh-3d"))return null;const i=this.setGraphicElevationContext(r,new Gf),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}onRemoveGraphic(e){this._fastUpdateProcessor.onRemoveGraphic(e,this._materialInfoCache,this._context)}layerOpacityChanged(e,r){const i=this._getLayerOpacity();this._updateMaterialParameters(s=>{s.material.setParameters({layerOpacity:i});const n=s.material.parameters;this._setMaterialTransparentParameter(n,s),s.material.setParameters({transparent:n.transparent})}),e.forEach(s=>{const n=r(s);n?.layerOpacityChanged(i,this._context.isAsync)})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,ib)}slicePlaneEnabledChanged(e,r){return this._updateMaterialParameters(({material:i})=>{i.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),e.forEach(i=>{const s=r(i);s?.slicePlaneEnabledChanged(this._context.slicePlaneEnabled,this._context.isAsync)}),!0}physicalBasedRenderingChanged(){const e=this._usePBR();return this._updateMaterialParameters(({material:r})=>r.setParameters({usePBR:e})),!0}updateTransform(e,r,i,s){const n=this._context.renderCoordsHelper.spatialReference,o=WTt,{origin:a,transform:l}=i;switch(wc(r,ie(Go,a.x,a.y,a.z??0),o,n),s){case wI.EnableFastUpdates:this._fastUpdateProcessor.enable(e,this._materialInfoCache,this._context);break;case wI.DisableFastUpdates:this._fastUpdateProcessor.disable(e,this._materialInfoCache,this._context);break;case wI.UpdateFastLocalOrigin:e.updateFastLocalOrigin(o,l,this._context.localOriginFactory)}const{elevationContext:c}=e;c.centerPointInElevationSR=this._getCenterPointInElevationSR(o);const{elevationProvider:h,renderCoordsHelper:p}=this._context,f=(m,g)=>rb(m,h,c,p,g);return e.alignedSampledElevation=uT(e,c,h.spatialReference,f,p,o),e.updateTransform(o,l,this._context.isAsync),!0}_requiresSymbolVertexColors(){return this._drivenProperties.color||this._drivenProperties.opacity}_colorOrTextureUid(e){return e==null?"-":e instanceof Le?e.toHex():e.contentHash}_materialPropertiesDefault(e,r){const i=this._requiresSymbolVertexColors(),s=!!e.vertexAttributes.color,n=!!e.vertexAttributes.tangent;return{hasSymbolVertexColors:i,hasVertexColors:s,hasVertexTangents:n,uid:`vc:${s},vt:${n},vct${r},svc:${i}`}}_textureTransformUid(e){const{offset:r,scale:i,rotation:s}=e??XTt;return`${r[0]},${r[1]},${s},${i[0]},${i[1]}`}_materialProperties(e,r,i){const s=this._materialPropertiesDefault(e,i);if(!r.material)return s;const{color:n,colorTexture:o,colorTextureTransform:a,normalTexture:l,normalTextureTransform:c,doubleSided:h,alphaCutoff:p,alphaMode:f}=r.material,m=this._colorOrTextureUid(n),g=this._colorOrTextureUid(o),_=this._textureTransformUid(a),v=this._colorOrTextureUid(l),b=this._textureTransformUid(c);if(s.color=n,s.colorTexture=o,s.normalTexture=l,s.uid=`${s.uid},cmuid:${m},ctmuid:${g},cttuid:${_},ntmuid:${v},nttuid:${b},ds:${h},ac:${p},am:${f}`,r.material instanceof ZLe){const{metallic:x,roughness:T,metallicRoughnessTexture:S,metallicRoughnessTextureTransform:O,emissiveColor:A,emissiveTexture:M,emissiveTextureTransform:P,occlusionTexture:F,occlusionTextureTransform:$}=r.material,N=this._colorOrTextureUid(S),U=this._textureTransformUid(O),X=this._colorOrTextureUid(A),Z=this._colorOrTextureUid(M),G=this._textureTransformUid(P),ee=this._colorOrTextureUid(F),I=this._textureTransformUid($);s.metallic=x,s.roughness=T,s.metallicRoughnessTexture=S,s.emissiveColor=A,s.emissiveTexture=M,s.occlusionTexture=F,s.colorTextureTransform=this._convertTextureTransform(a),s.normalTextureTransform=this._convertTextureTransform(c),s.emissiveTextureTransform=this._convertTextureTransform(P),s.occlusionTextureTransform=this._convertTextureTransform($),s.metallicRoughnessTextureTransform=this._convertTextureTransform(O),s.uid=`${s.uid},mrm:${x},mrr:${T},mrt:${N},mrtt:${U},emuid:${X},etmuid:${Z},ett:${G},otmuid:${ee},ott:${I}`}return s}_convertTextureTransform(e){if(!e)return null;const{scale:r,offset:i,rotation:s}=e;return{scale:r,offset:i,rotation:zt(s)}}_setInternalColorValueParameters(e,r){r.diffuse=Le.toUnitRGB(e),r.opacity=e.a}_getLoadableTextureResource(e){return e.data?e.data:e.url}_getInternalTextureId(e){const r=this._getInternalTexture(e,ni.Opaque);return r!=null?r.id:null}_getInternalTexture(e,r){const i=this._getLoadableTextureResource(e);if(!i)return null;const s=`${e.contentHash}/${r}`;let n=this._textures.get(s);return n||(n=new wS(fT(i)?i.data:i,{mipmap:!0,wrap:this._castTextureWrap(e.wrap),noUnpackFlip:!0,preMultiplyAlpha:!fT(i)&&r!==ni.Opaque,encoding:fT(i)&&i.encoding!=null?i.encoding:void 0}),this._textures.set(s,n),this._context.stage.add(n),this._context.stage.loadImmediate(n)),n}_castTextureWrap(e="repeat"){if(typeof e=="string"){const r=this._castTextureWrapIndividual(e);return{s:r,t:r}}return{s:this._castTextureWrapIndividual(e.horizontal),t:this._castTextureWrapIndividual(e.vertical)}}_castTextureWrapIndividual(e){switch(e){case"clamp":return Ut.CLAMP_TO_EDGE;case"mirror":return Ut.MIRRORED_REPEAT;default:return Ut.REPEAT}}_setInternalMaterialParameters(e,r){if(e.color!=null&&this._setInternalColorValueParameters(e.color,r),e.colorTexture!=null){const i=this._getInternalTexture(e.colorTexture,r.textureAlphaMode);i!=null?(r.textureId=i.id,r.textureAlphaPremultiplied=!!i.parameters.preMultiplyAlpha):r.textureId=void 0}e.normalTexture!=null&&(r.normalTextureId=this._getInternalTextureId(e.normalTexture)),e.emissiveColor!=null&&(r.emissiveFactor=Le.toUnitRGB(e.emissiveColor)),e.emissiveTexture!=null&&(r.emissiveTextureId=this._getInternalTextureId(e.emissiveTexture)),e.occlusionTexture!=null&&(r.occlusionTextureId=this._getInternalTextureId(e.occlusionTexture)),e.metallicRoughnessTexture!=null&&(r.metallicRoughnessTextureId=this._getInternalTextureId(e.metallicRoughnessTexture)),r.colorTextureTransformMatrix=Ym(e.colorTextureTransform),r.normalTextureTransformMatrix=Ym(e.normalTextureTransform),r.occlusionTextureTransformMatrix=Ym(e.occlusionTextureTransform),r.emissiveTextureTransformMatrix=Ym(e.emissiveTextureTransform),r.metallicRoughnessTextureTransformMatrix=Ym(e.metallicRoughnessTextureTransform)}_setExternalMaterialParameters(e){const r=this._drivenProperties.color;let i=this.symbolLayer.material!=null?this.symbolLayer.material.colorMixMode:null;if(r)e.externalColor=Od;else{const s=this.symbolLayer.material!=null?this.symbolLayer.material.color:null;s!=null?e.externalColor=Le.toUnitRGBA(s):(i=null,e.externalColor=Od)}i&&(e.colorMixMode=i),e.castShadows=!!this.symbolLayer.castShadows}_hasTransparentVertexColors(e){const r=e.vertexAttributes.color;if(r==null)return!1;for(let i=3;i<r.length;i+=4)if(r[i]!==255)return!0;return!1}_getOrCreateMaterial(e,r){const i=r.material?.color,s=r.material?.colorTexture,n=r.material?.alphaMode,o=n==="blend",a=n!=="opaque"&&(this._hasTransparentVertexColors(e)||i!=null&&i.a<1||s!=null&&s.transparent||o),l=this._materialProperties(e,r,a),c=this._materialInfoCache.byUid(l.uid);if(c)return c.material;const h={uid:l.uid,material:null,isComponentTransparent:a,alphaMode:r.material?r.material.alphaMode:"opaque"},p=SLe({normalTexture:l.normalTexture,metallicRoughnessTexture:l.metallicRoughnessTexture,metallicFactor:l.metallic,roughnessFactor:l.roughness,emissiveTexture:l.emissiveTexture,emissiveFactor:Le.toUnitRGB(l.emissiveColor),occlusionTexture:l.occlusionTexture}),f={usePBR:this._usePBR(),isSchematic:p,hasVertexColors:l.hasVertexColors,hasSymbolColors:l.hasSymbolVertexColors,hasVertexTangents:l.hasVertexTangents,ambient:Nl,diffuse:i0,opacity:1,doubleSided:!0,doubleSidedType:"winding-order",cullFace:Ii.None,layerOpacity:this._getLayerOpacity(),hasSlicePlane:this._context.slicePlaneEnabled,initTextureTransparent:!0};f.mrrFactors=p?[...vie]:[l.metallic,l.roughness,H8[2]],r.material&&(f.doubleSided=r.material.doubleSided,f.cullFace=r.material.doubleSided?Ii.None:Ii.Back,f.textureAlphaCutoff=r.material.alphaCutoff),this._setExternalMaterialParameters(f),this._setMaterialTransparentParameter(f,h),this._setInternalMaterialParameters(l,f);const m=new Rg(f);return h.material=m,this._materialInfoCache.set(l.uid,h),this._context.stage.add(m),m}_usePBR(){return this._context.physicalBasedRenderingEnabled}_setMaterialTransparentParameter(e,r){e.transparent=this.needsDrivenTransparentPass||r.isComponentTransparent||e.layerOpacity<1||e.opacity<1||e.externalColor&&e.externalColor[3]<1,r.alphaMode==="auto"?e.textureAlphaMode=e.transparent?ni.MaskBlend:ni.Opaque:e.textureAlphaMode=r.alphaMode==="opaque"?ni.Opaque:r.alphaMode==="mask"?ni.Mask:ni.Blend}_addDebugNormals(e,r){const i=r.length,s=e.spatialReference.isGeographic?20015077/180:1,n=.1*Math.max(e.extent.width*s,e.extent.height*s,e.extent.zmax-e.extent.zmin),o=[],a=[],l=[],c=[];for(let m=0;m<i;m++){const g=r[m],_=g.vertexAttributes.get(E.POSITION),v=g.vertexAttributes.get(E.NORMAL),b=g.indices.get(E.POSITION),x=g.indices.get(E.NORMAL),T=_.data,S=v.data;for(let O=0;O<b.length;O++){const A=3*b[O],M=3*x[O];for(let P=0;P<3;P++)o.push(T[A+P]);for(let P=0;P<3;P++)o.push(T[A+P]+S[M+P]*n);if(a.push(a.length),a.push(a.length),O%3==0){this._calculateFaceNormal(T,b,O,y2),this._getFaceVertices(T,b,O,Go,m2,g2),ue(Go,Go,m2),ue(Go,Go,g2),ae(Go,Go,1/3);for(let P=0;P<3;P++)l.push(Go[P]);for(let P=0;P<3;P++)l.push(Go[P]+y2[P]*n);c.push(c.length),c.push(c.length)}}}const h=r[0].transformation,p=new mn(this._debugVertexNormalMaterial,[[E.POSITION,new Ge(o,3,!0)]],[[E.POSITION,a]],null,Ms.Line);r.push(p),p.transformation=h;const f=new mn(this._debugFaceNormalMaterial,[[E.POSITION,new Ge(l,3,!0)]],[[E.POSITION,c]],null,Ms.Line);f.transformation=h,r.push(f)}_createAs3DShape(e,r,i,s){const n=e.geometry;if(n.type!=="mesh")return null;const o=this._createGeometryInfo(n,r,s);if(o==null)return null;const{geometries:a,objectTransformation:l}=o;bi.DRAW_MESH_GEOMETRY_NORMALS&&this._addDebugNormals(n,a);const c=new K0({geometries:a,layerUid:this._context.layer.uid,graphicUid:s});c.transformation=l;const h=TOe(this.symbolLayer,{opacity:this._getLayerOpacity()}),p=h!=null?new Xvt(a[0].material,[h],{mergeGeometries:!0,hasSlicePlane:this._context.slicePlaneEnabled}):null,f=new $Tt(this,c,a,null,null,uT,i,p);this._fastUpdateProcessor.onAddGraphic(),f.needsElevationUpdates=ib(i.mode),f.useObjectOriginAsAttachmentOrigin=!0,i.centerPointInElevationSR=this._getCenterPointInElevationSR(c.transformation);const{elevationProvider:m,renderCoordsHelper:g}=this._context,_=(v,b)=>rb(v,m,i,g,b);return f.alignedSampledElevation=uT(f,i,m.spatialReference,_,g),f}_getCenterPointInElevationSR(e){const r=Su(0,0,0,this._context.elevationProvider.spatialReference!=null?this._context.elevationProvider.spatialReference:null);return gee([e[12],e[13],e[14]],this._context.renderCoordsHelper.spatialReference,r),r}_createComponentNormals(e,r,i,s){switch(i.shading||"flat"){default:case"source":return this._createComponentNormalsSource(e,r,i,s);case"flat":return this._createComponentNormalsFlat(e,s);case"smooth":return this._createComponentNormalsSmooth(e,s)}}_createComponentNormalsSource(e,r,i,s){if(r==null)return this._createComponentNormalsFlat(e,s);let n=!1;if(!i.trustSourceNormals)for(let o=0;o<s.length;o+=3){this._calculateFaceNormal(e,s,o,y2);for(let a=0;a<3;a++){const l=3*s[o+a];Go[0]=r[l],Go[1]=r[l+1],Go[2]=r[l+2],de(y2,Go)<0&&(r[l]=-r[l],r[l+1]=-r[l+1],r[l+2]=-r[l+2],n=!0)}}return new MG(r,s,n)}_createComponentNormalsFlat(e,r){const i=vs(r.length),s=new Array(3*r.length);for(let n=0;n<r.length;n+=3){const o=this._calculateFaceNormal(e,r,n,y2);for(let a=0;a<3;a++)i[n+a]=o[a],s[n+a]=n/3}return new MG(i,s,!1)}_createComponentNormalsSmooth(e,r){const i={};for(let o=0;o<r.length;o+=3){const a=this._calculateFaceNormal(e,r,o,y2);for(let l=0;l<3;l++){const c=r[o+l];let h=i[c];h||(h={normal:C(),count:0},i[c]=h),ue(h.normal,h.normal,a),h.count++}}const s=vs(3*r.length),n=new Array(3*r.length);for(let o=0;o<r.length;o++){const a=i[r[o]];a.count!==1&&(_e(a.normal,a.normal),a.count=1);for(let l=0;l<3;l++)s[3*o+l]=a.normal[l];n[o]=o}return new MG(s,n,!1)}_getFaceVertices(e,r,i,s,n,o){const a=3*r[i],l=3*r[i+1],c=3*r[i+2];s[0]=e[a],s[1]=e[a+1],s[2]=e[a+2],n[0]=e[l],n[1]=e[l+1],n[2]=e[l+2],o[0]=e[c],o[1]=e[c+1],o[2]=e[c+2]}_calculateFaceNormal(e,r,i,s){return this._getFaceVertices(e,r,i,Go,m2,g2),pe(m2,m2,Go),pe(g2,g2,Go),st(Go,m2,g2),_e(s,Go),s}_getOrCreateComponents(e){return e.components??ZTt}_createPositionBuffer(e,r){let i=e.vertexAttributes.position;const s=r.reprojection===ru.ECEF?r.transformBeforeProject:null;if(s!=null&&(i=BA(new Float64Array(i.length),i,s)),r.reprojection===ru.NONE)return r.needsBufferCopy?new Float64Array(i):i;const n=s!=null?i:new Float64Array(i.length);return wi(i,e.spatialReference,0,n,this._context.renderCoordsHelper.spatialReference,0,i.length/3),n}_createNormalBuffer(e,r,i){let s=e.vertexAttributes.normal;if(s==null)return null;const n=i.reprojection===ru.ECEF?i.transformBeforeProject:null;if(n!=null&&(s=ATt(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===ru.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=n!=null?s:new Float32Array(s.length);return CTt(s,o,r,e.spatialReference,a)}_createTangentBuffer(e,r,i){let s=e.vertexAttributes.tangent;if(s==null)return null;const n=i.reprojection===ru.ECEF?i.transformBeforeProject:null;if(n!=null&&(s=OTt(s,new Float32Array(s.length),n)),this._context.graphicsCoreOwner.view.viewingMode==="local"||i.reprojection===ru.NONE)return i.needsBufferCopy&&e.vertexAttributes.normal===s?new Float32Array(s):s;const o=e.vertexAttributes.position,a=n!=null?s:new Float32Array(s.length);return RTt(s,o,r,e.spatialReference,a)}_createColorBuffer(e){return e.vertexAttributes.color}_createSymbolColorBuffer(e){if(this._requiresSymbolVertexColors()){const r=this._getVertexOpacityAndColor(e),i=COe(this.symbolLayer?.material?.colorMixMode),s=new Uint8Array(4);return AOe(r,i,s),s}return null}_createBuffers(e,r){const i=e.vertexAttributes&&e.vertexAttributes.position;if(!i)return this.logger.warn("Mesh geometry must contain position vertex attributes"),null;const s=e.vertexAttributes.normal,n=e.vertexAttributes.uv,o=e.vertexAttributes.tangent;if(s!=null&&s.length!==i.length)return this.logger.warn("Mesh normal vertex buffer must contain the same number of elements as the position buffer"),null;if(o!=null&&o.length/4!=i.length/3)return this.logger.warn("Mesh tangent vertex buffer must contain the same number of elements as the position buffer"),null;if(n!=null&&n.length/2!=i.length/3)return this.logger.warn("Mesh uv vertex buffer must contain the same number of elements as the position buffer"),null;const a=this._computeReprojectionInfo(e),l=this._createPositionBuffer(e,a),c=this._createColorBuffer(e),h=this._createSymbolColorBuffer(r),p=this._createNormalBuffer(e,l,a),f=this._createTangentBuffer(e,l,a);return{positionBuffer:l,normalBuffer:p,tangentBuffer:f,uvBuffer:n,colorBuffer:c,symbolColorBuffer:h,objectTransformation:a.reprojection===ru.NONE&&a.objectTransformation!=null?a.objectTransformation:this._transformOriginLocal(e,l,p,f),geometryTransformation:a.reprojection===ru.NONE&&a.geometryTransformation!=null?a.geometryTransformation:xe()}}_computeReprojectionInfo(e){const{vertexSpace:r}=e,i=r.isRelative,s=r.isGeoreferenced?this._context.renderCoordsHelper.viewingMode===Ue.Local?ru.NONE:ru.ECEF:ru.NONE;if(i){const{origin:n}=r,o=xe(),a=e.transform?.localMatrix??Un;if(s===ru.NONE)return wc(e.spatialReference,n,o,this._context.renderCoordsHelper.spatialReference),{reprojection:s,objectTransformation:o,geometryTransformation:xA(a),needsBufferCopy:!1};const l=d$(xe(),n);return yi(l,l,a),{reprojection:s,transformBeforeProject:l,needsBufferCopy:!0}}return{reprojection:s,needsBufferCopy:!0}}_transformOriginLocal(e,r,i,s){const n=this._context.renderCoordsHelper.spatialReference,o=e.anchor;ON[0]=o.x,ON[1]=o.y,ON[2]=o.z??0;const a=xe();return wc(e.spatialReference,ON,a,n),so(Cfe,a),BA(r,r,Cfe),i==null&&s==null||(qd($R,a),Wd($R,$R),i!=null&&WT(i,i,$R),s!=null&&WT(s,s,$R,4)),a}_validateFaces(e,r){const i=e.vertexAttributes.position.length/3,s=r.faces;if(s){let n=-1;for(let o=0;o<s.length;o++){const a=s[o];a>n&&(n=a)}if(i<=n)return this.logger.warn(`Vertex index ${n} is out of bounds of the mesh position buffer`),!1}else if(i%3!=0)return this.logger.warn("Mesh position buffer length must be a multiple of 9 if no component faces are defined (3 values per vertex * 3 vertices per triangle)"),!1;return!0}_getOrCreateFaces(e,r){return r.faces??PA(e.vertexAttributes.position.length/3)}_isOutsideClippingArea(e){if(!this._context.clippingExtent)return!1;const r=e.vertexAttributes&&e.vertexAttributes.position;if(!r)return!1;const i=this._context.elevationProvider.spatialReference;let s;const n=r.length/3;return i==null||e.spatialReference.equals(i)?s=r:(s=new Float64Array(r.length),wi(e.vertexAttributes.position,e.spatialReference,0,s,i,0,n)),Gi(IG),fh(IG,s,0,n),!cf(IG,this._context.clippingExtent)}_createGeometryInfo(e,r,i){if(!$f(e.spatialReference,this._context.graphicsCoreOwner.view.spatialReference))return this.logger.warn("Geometry spatial reference is not compatible with the view"),null;if(this._isOutsideClippingArea(e))return null;const s=this._createBuffers(e,r);if(s==null)return null;const{positionBuffer:n,uvBuffer:o,colorBuffer:a,symbolColorBuffer:l,normalBuffer:c,tangentBuffer:h,objectTransformation:p,geometryTransformation:f}=s,m=this._getOrCreateComponents(e),g=new Array;let _=!1;for(const v of m){if(!this._validateFaces(e,v))return null;const b=this._getOrCreateFaces(e,v);if(b.length===0)continue;const x=this._createComponentNormals(n,c,v,b);x.didFlipNormals&&(_=!0);const T=[[E.POSITION,new Ge(n,3,!0)],[E.NORMAL,new Ge(x.normals,3,!0)]],S=[[E.POSITION,b],[E.NORMAL,x.indices]];a!=null&&(T.push([E.COLOR,new Ge(a,4,!0)]),S.push([E.COLOR,b])),l!=null&&(T.push([E.SYMBOLCOLOR,new Ge(l,4,!0)]),S.push([E.SYMBOLCOLOR,SO(b.length)])),o!=null&&(T.push([E.UV0,new Ge(o,2,!0)]),S.push([E.UV0,b])),h!=null&&(T.push([E.TANGENT,new Ge(h,4,!0)]),S.push([E.TANGENT,b]));const O=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:i,layerUid:this._context.layer.uid}),A=this._getOrCreateMaterial(e,v),M=new mn(A,T,S,null,Ms.Mesh,O);M.transformation=f,g.push(M)}return _&&this.logger.warn("Normals have been automatically flipped to be consistent with the counter clock wise face winding order. It is better to generate mesh geometries that have consistent normals."),{geometries:g,objectTransformation:p}}_updateMaterialParameters(e){this._materialInfoCache.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachMaterialInfo(e),this._fastUpdateProcessor.forEachClonedMaterial((r,i)=>{i.setParameters(r.parameters)})}test(){return{...super.test(),materials:this._materialInfoCache.materials}}};class MG{constructor(e,r,i){this.normals=e,this.indices=r,this.didFlipNormals=i}}const ON=C(),Go=C(),m2=C(),g2=C(),y2=C(),Cfe=xe(),$R=ts(),WTt=xe(),IG=Gn(),ZTt=[new ETt],XTt=new HC;var ru;(function(t){t[t.NONE=0]="NONE",t[t.ECEF=1]="ECEF"})(ru||(ru={}));let YTt=class{constructor(e,r,i,s){this.graphics3DSymbolLayer=e,this.instanceIndex=r,this.elevationAligner=i,this.elevationContext=s,this.type="lod-instance",this._highlights=new Set,this.alignedSampledElevation=0,this.isElevationSource=!1,this.needsElevationUpdates=!1}initialize(){}setVisibility(e){const r=this._lodRenderer.instanceData;e!==r.getVisible(this.instanceIndex)&&r.setVisible(this.instanceIndex,e)}destroy(){this.instanceIndex!=null&&(this._lodRenderer.instanceData.removeInstance(this.instanceIndex),this.graphics3DSymbolLayer.notifyDestroyGraphicLayer(this))}alignWithElevation(e,r,i){if(this.elevationAligner){N8(this.elevationContext.featureExpressionInfoContext,i);const s=(o,a)=>rb(o,e,this.elevationContext,r,a),n=this.elevationAligner(this,this.elevationContext,e.spatialReference,s,r);n!=null&&(this.alignedSampledElevation=n)}}getCenterObjectSpace(e=C()){return this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,cm),Ne(e,this._lodRenderer.baseBoundingSphere.center,cm)}getBoundingBoxObjectSpace(e=Gn()){this._lodRenderer.instanceData.getCombinedLocalTransform(this.instanceIndex,cm);const r=this._lodRenderer.baseBoundingBox;Gi(e);for(let i=0;i<8;++i)ie(Vh,1&i?r[3]:r[0],2&i?r[4]:r[1],4&i?r[5]:r[2]),Ne(Vh,Vh,cm),yg(e,Vh);return e}computeAttachmentOrigin(e){this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,cm),e.render.origin[0]+=cm[12],e.render.origin[1]+=cm[13],e.render.origin[2]+=cm[14],e.render.num++}async getProjectedBoundingBox(e,r,i,s,n){const o=this.getBoundingBoxObjectSpace(n),a=JTt,l=gK(o)?1:a.length;this._lodRenderer.instanceData.getGlobalTransform(this.instanceIndex,cm);for(let h=0;h<l;h++){const p=a[h];Vh[0]=o[p[0]],Vh[1]=o[p[1]],Vh[2]=o[p[2]],Ne(Vh,Vh,cm),Jb[3*h]=Vh[0],Jb[3*h+1]=Vh[1],Jb[3*h+2]=Vh[2]}if(!e(Jb,0,l))return null;Gi(o);let c=null;this.calculateRelativeScreenBounds&&(c=this.calculateRelativeScreenBounds());for(let h=0;h<3*l;h+=3){for(let p=0;p<3;p++)o[p]=Math.min(o[p],Jb[h+p]),o[p+3]=Math.max(o[p+3],Jb[h+p]);c&&i.push({location:Jb.slice(h,h+3),screenSpaceBoundingRect:c})}if(r&&(lf(o,PG),this.elevationContext.mode!=="absolute-height")){let h;const p=Gre(o,r.service.spatialReference,r);try{h=await r.service.queryElevation(PG[0],PG[1],s,p,"ground")}catch{}h!=null&&cxe(o,0,0,-this.alignedSampledElevation+h)}return o}addObjectState(e,r){if(e===$0.Highlight){const i=new xU(e);this._addHighlightId(i),r.addExternal(s=>{this._removeHighlightId(s)},i)}}removeObjectState(e){this._highlights.forEach(r=>e.remove(r))}_addHighlightId(e){this._highlights.add(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,!0)}_removeHighlightId(e){this._highlights.delete(e),this._lodRenderer.instanceData.setHighlight(this.instanceIndex,this._highlights.size>0)}get _lodRenderer(){return this.graphics3DSymbolLayer.lodRenderer}};const Jb=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],Vh=C(),PG=C(),JTt=[[0,1,2],[3,1,2],[0,4,2],[3,4,2],[0,1,5],[3,1,5],[0,4,5],[3,4,5]],cm=xe();function QTt(t){const e=new Array;return t.stageResources.geometries.forEach(r=>{const i=t.stageResources.textures;e.push(new QPe(r,i))}),{components:e,minScreenSpaceRadius:t.lodThreshold??0,pivotOffset:t.pivotOffset}}function KTt(t){return{levels:t.map(e=>QTt(e))}}function eSt(t,e,r){if(t.count!==e.count)return void k8.error("source and destination buffers need to have the same number of elements");const i=t.count,s=r[0],n=r[1],o=r[2],a=r[3],l=r[4],c=r[5],h=r[6],p=r[7],f=r[8],m=r[9],g=r[10],_=r[11],v=r[12],b=r[13],x=r[14],T=r[15],S=t.typedBuffer,O=t.typedBufferStride,A=e.typedBuffer,M=e.typedBufferStride;for(let P=0;P<i;P++){const F=P*O,$=P*M,N=A[$],U=A[$+1],X=A[$+2],Z=A[$+3];S[F]=s*N+l*U+f*X+v*Z,S[F+1]=n*N+c*U+m*X+b*Z,S[F+2]=o*N+h*U+g*X+x*Z,S[F+3]=a*N+p*U+_*X+T*Z}}function tSt(t,e,r){xie(t.typedBuffer,e.typedBuffer,r,t.typedBufferStride,e.typedBufferStride)}function xie(t,e,r,i=4,s=i){if(t.length/i!=e.length/s)return void k8.error("source and destination buffers need to have the same number of elements");const n=t.length/i,o=r[0],a=r[1],l=r[2],c=r[3],h=r[4],p=r[5],f=r[6],m=r[7],g=r[8];let _=0,v=0;for(let b=0;b<n;b++){const x=e[_],T=e[_+1],S=e[_+2],O=e[_+3];t[v]=o*x+c*T+f*S,t[v+1]=a*x+h*T+m*S,t[v+2]=l*x+p*T+g*S,t[v+3]=O,_+=s,v+=i}}function rSt(t,e){const r=Math.min(t.count,e.count),i=t.typedBuffer,s=t.typedBufferStride,n=e.typedBuffer,o=e.typedBufferStride;for(let a=0;a<r;a++){const l=a*s,c=a*o,h=n[c],p=n[c+1],f=n[c+2],m=h*h+p*p+f*f;if(m>0){const g=1/Math.sqrt(m);i[l]=g*h,i[l+1]=g*p,i[l+2]=g*f}}}function iSt(t,e,r){KU(t.typedBuffer,e,r,t.typedBufferStride)}function KU(t,e,r,i=4){const s=Math.min(t.length/i,e.count),n=e.typedBuffer,o=e.typedBufferStride;let a=0,l=0;for(let c=0;c<s;c++)t[l]=r*n[a],t[l+1]=r*n[a+1],t[l+2]=r*n[a+2],t[l+3]=r*n[a+3],a+=o,l+=i}Object.freeze(Object.defineProperty({__proto__:null,normalize:rSt,scale:KU,scaleView:iSt,transformMat3:xie,transformMat3View:tSt,transformMat4:eSt},Symbol.toStringTag,{value:"Module"}));function sSt(t,e){Tie(t.typedBuffer,e.typedBuffer,t.typedBufferStride,e.typedBufferStride)}function Tie(t,e,r=2,i=r){const s=e.length/2;let n=0,o=0;if(Cf(e)||A4e(e)){for(let l=0;l<s;++l)t[n]=e[o],t[n+1]=e[o+1],n+=r,o+=i;return}const a=O4e(e);if(C4e(e))for(let l=0;l<s;++l)t[n]=Math.max(e[o]/a,-1),t[n+1]=Math.max(e[o+1]/a,-1),n+=r,o+=i;else for(let l=0;l<s;++l)t[n]=e[o]/a,t[n+1]=e[o+1]/a,n+=r,o+=i}function nSt(t,e,r,i){const s=t.typedBuffer,n=t.typedBufferStride,o=i?.count??t.count;let a=(i?.dstIndex??0)*n;for(let l=0;l<o;++l)s[a]=e,s[a+1]=r,a+=n}Object.freeze(Object.defineProperty({__proto__:null,fill:nSt,normalizeIntegerBuffer:Tie,normalizeIntegerBufferView:sSt},Symbol.toStringTag,{value:"Module"}));function oSt(t,e){j$(t.typedBuffer,e.typedBuffer,t.typedBufferStride,e.typedBufferStride)}function j$(t,e,r=3,i=r){const s=e.length/i;let n=0,o=0;for(let a=0;a<s;++a)t[n]=e[o],t[n+1]=e[o+1],t[n+2]=e[o+2],n+=r,o+=i}function aSt(t,e,r,i,s){const n=t.typedBuffer,o=t.typedBufferStride,a=s?.count??t.count;let l=(s?.dstIndex??0)*o;for(let c=0;c<a;++c)n[l]=e,n[l+1]=r,n[l+2]=i,l+=o}Object.freeze(Object.defineProperty({__proto__:null,copy:j$,copyView:oSt,fill:aSt},Symbol.toStringTag,{value:"Module"}));function lSt(t,e){Sie(t.typedBuffer,e,t.typedBufferStride)}function Sie(t,e,r=4){const i=e.typedBuffer,s=e.typedBufferStride,n=e.count;let o=0,a=0;for(let l=0;l<n;++l)t[o]=i[a],t[o+1]=i[a+1],t[o+2]=i[a+2],t[o+3]=i[a+3],o+=r,a+=s}function cSt(t,e,r,i,s,n){const o=t.typedBuffer,a=t.typedBufferStride,l=n?.count??t.count;let c=(n?.dstIndex??0)*a;for(let h=0;h<l;++h)o[c]=e,o[c+1]=r,o[c+2]=i,o[c+3]=s,c+=a}Object.freeze(Object.defineProperty({__proto__:null,copy:Sie,copyView:lSt,fill:cSt},Symbol.toStringTag,{value:"Module"}));let tDe=class{constructor(e){this._streamDataRequester=e}async loadJSON(e,r){return this._load("json",e,r)}async loadBinary(e,r){return Ig(e)?(Dt(r),YJ(e)):this._load("binary",e,r)}async loadImage(e,r){return this._load("image",e,r)}async _load(e,r,i){if(this._streamDataRequester==null)return(await Lt(r,{responseType:uSt[e]})).data;const s=await Sh(this._streamDataRequester.request(r,e,i));if(s.ok===!0)return s.value;throw xa(s.error),new D("",`Request for resource failed: ${s.error}`)}};const uSt={image:"image",binary:"array-buffer",json:"json","image+type":void 0};function hSt(t={}){return{color:[1,1,1],opacity:1,alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1,castShadows:!0,receiveShadows:!0,receiveAmbientOcclustion:!0,textureColor:null,textureNormal:null,textureOcclusion:null,textureEmissive:null,textureMetallicRoughness:null,colorTextureTransform:null,normalTextureTransform:null,occlusionTextureTransform:null,emissiveTextureTransform:null,metallicRoughnessTextureTransform:null,emissiveFactor:[0,0,0],metallicFactor:1,roughnessFactor:1,colorMixMode:"multiply",...t}}function dSt(t,e={}){return{data:t,parameters:{wrap:{s:Ut.REPEAT,t:Ut.REPEAT,...e.wrap},noUnpackFlip:!0,mipmap:!1,...e}}}function p5(t,e){const r=t.count;e||(e=new t.TypedArrayConstructor(r));for(let i=0;i<r;i++)e[i]=t.get(i);return e}Object.freeze(Object.defineProperty({__proto__:null,makeDense:p5},Symbol.toStringTag,{value:"Module"}));let Afe=class{constructor(e){this._data=e,this._offset4=0,this._dataUint32=new Uint32Array(this._data,0,Math.floor(this._data.byteLength/4))}readUint32(){const e=this._offset4;return this._offset4+=1,this._dataUint32[e]}readUint8Array(e){const r=4*this._offset4;return this._offset4+=e/4,new Uint8Array(this._data,r,e)}remainingBytes(){return this._data.byteLength-4*this._offset4}};var xI,Ofe;(function(t){t.SCALAR="SCALAR",t.VEC2="VEC2",t.VEC3="VEC3",t.VEC4="VEC4",t.MAT2="MAT2",t.MAT3="MAT3",t.MAT4="MAT4"})(xI||(xI={})),function(t){t[t.ARRAY_BUFFER=34962]="ARRAY_BUFFER",t[t.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER"}(Ofe||(Ofe={}));const rDe={baseColorFactor:[1,1,1,1],metallicFactor:1,roughnessFactor:1},pSt={pbrMetallicRoughness:rDe,emissiveFactor:[0,0,0],alphaMode:"OPAQUE",alphaCutoff:.5,doubleSided:!1},fSt={ESRI_externalColorMixMode:"tint"},Rfe=(t={})=>{const e={...rDe,...t.pbrMetallicRoughness},r=mSt({...fSt,...t.extras});return{...pSt,...t,pbrMetallicRoughness:e,extras:r}};function mSt(t){switch(t.ESRI_externalColorMixMode){case"multiply":case"tint":case"ignore":case"replace":break;default:t.ESRI_externalColorMixMode,t.ESRI_externalColorMixMode="tint"}return t}const gSt={magFilter:Mt.LINEAR,minFilter:Mt.LINEAR_MIPMAP_LINEAR,wrapS:Ut.REPEAT,wrapT:Ut.REPEAT},ySt=t=>({...gSt,...t});function _St(t){let e,r;return t.replace(/^(.*\/)?([^/]*)$/,(i,s,n)=>(e=s||"",r=n||"","")),{dirPart:e,filePart:r}}const RN={MAGIC:1179937895,CHUNK_TYPE_JSON:1313821514,CHUNK_TYPE_BIN:5130562,MIN_HEADER_LENGTH:20};let vSt=class Mv{constructor(e,r,i,s){if(this._context=e,this.uri=r,this.json=i,this._glbBuffer=s,this._bufferLoaders=new Map,this._textureLoaders=new Map,this._textureCache=new Map,this._materialCache=new Map,this._nodeParentMap=new Map,this._nodeTransformCache=new Map,this._supportedExtensions=["KHR_texture_basisu"],this._baseUri=_St(this.uri).dirPart,this._checkVersionSupported(),this._checkRequiredExtensionsSupported(),i.scenes==null)throw new D("gltf-loader-unsupported-feature","Scenes must be defined.");if(i.meshes==null)throw new D("gltf-loader-unsupported-feature","Meshes must be defined");if(i.nodes==null)throw new D("gltf-loader-unsupported-feature","Nodes must be defined.");this._computeNodeParents()}static async load(e,r,i){if(Ig(r)){const o=_T(r);if(o&&o.mediaType!=="model/gltf-binary")try{const l=JSON.parse(o.isBase64?atob(o.data):o.data);return new Mv(e,r,l)}catch{}const a=YJ(r);if(Mv._isGLBData(a))return this._fromGLBData(e,r,a)}if(r.endsWith(".gltf")){const o=await e.loadJSON(r,i);return new Mv(e,r,o)}const s=await e.loadBinary(r,i);if(Mv._isGLBData(s))return this._fromGLBData(e,r,s);const n=await e.loadJSON(r,i);return new Mv(e,r,n)}static _isGLBData(e){if(e==null)return!1;const r=new Afe(e);return r.remainingBytes()>=4&&r.readUint32()===RN.MAGIC}static async _fromGLBData(e,r,i){const s=await Mv._parseGLBData(i);return new Mv(e,r,s.json,s.binaryData)}static async _parseGLBData(e){const r=new Afe(e);if(r.remainingBytes()<12)throw new D("gltf-loader-error","GLB binary data is insufficiently large.");const i=r.readUint32(),s=r.readUint32(),n=r.readUint32();if(i!==RN.MAGIC)throw new D("gltf-loader-error","Magic first 4 bytes do not fit to expected GLB value.");if(e.byteLength<n)throw new D("gltf-loader-error","GLB binary data is smaller than header specifies.");if(s!==2)throw new D("gltf-loader-unsupported-feature","An unsupported GLB container version was detected. Only version 2 is supported.");let o,a,l=0;for(;r.remainingBytes()>=8;){const c=r.readUint32(),h=r.readUint32();if(l===0){if(h!==RN.CHUNK_TYPE_JSON)throw new D("gltf-loader-error","First GLB chunk must be JSON.");if(c<0)throw new D("gltf-loader-error","No JSON data found.");o=await ITt(r.readUint8Array(c))}else if(l===1){if(h!==RN.CHUNK_TYPE_BIN)throw new D("gltf-loader-unsupported-feature","Second GLB chunk expected to be BIN.");a=r.readUint8Array(c)}else K.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] More than 2 GLB chunks detected. Skipping.");l+=1}if(!o)throw new D("gltf-loader-error","No GLB JSON chunk detected.");return{json:o,binaryData:a}}async getBuffer(e,r){const i=this.json.buffers[e];if(i.uri==null){if(this._glbBuffer==null)throw new D("gltf-loader-error","GLB buffer not present");return this._glbBuffer}const s=await this._getBufferLoader(e,r);if(s.byteLength!==i.byteLength)throw new D("gltf-loader-error","Buffer byte lengths should match.");return s}async _getBufferLoader(e,r){const i=this._bufferLoaders.get(e);if(i)return i;const s=this.json.buffers[e].uri,n=this._context.loadBinary(this._resolveUri(s),r).then(o=>new Uint8Array(o));return this._bufferLoaders.set(e,n),n}async getAccessor(e,r){if(!this.json.accessors)throw new D("gltf-loader-unsupported-feature","Accessors missing.");const i=this.json.accessors[e];if(i?.bufferView==null)throw new D("gltf-loader-unsupported-feature","Some accessor does not specify a bufferView.");if(i.type in[xI.MAT2,xI.MAT3,xI.MAT4])throw new D("gltf-loader-unsupported-feature",`AttributeType ${i.type} is not supported`);const s=this.json.bufferViews[i.bufferView],n=await this.getBuffer(s.buffer,r),o=xSt[i.type],a=TSt[i.componentType],l=o*a,c=s.byteStride||l;return{raw:n.buffer,byteStride:c,byteOffset:n.byteOffset+(s.byteOffset||0)+(i.byteOffset||0),entryCount:i.count,isDenselyPacked:c===l,componentCount:o,componentByteSize:a,componentType:i.componentType,min:i.min,max:i.max,normalized:!!i.normalized}}async getIndexData(e,r){if(e.indices==null)return;const i=await this.getAccessor(e.indices,r);if(i.isDenselyPacked)switch(i.componentType){case rt.UNSIGNED_BYTE:return new Uint8Array(i.raw,i.byteOffset,i.entryCount);case rt.UNSIGNED_SHORT:return new Uint16Array(i.raw,i.byteOffset,i.entryCount);case rt.UNSIGNED_INT:return new Uint32Array(i.raw,i.byteOffset,i.entryCount)}else switch(i.componentType){case rt.UNSIGNED_BYTE:return p5(this._wrapAccessor(IA,i));case rt.UNSIGNED_SHORT:return p5(this._wrapAccessor(p8,i));case rt.UNSIGNED_INT:return p5(this._wrapAccessor(m8,i))}}async getPositionData(e,r){if(e.attributes.POSITION==null)throw new D("gltf-loader-unsupported-feature","No POSITION vertex data found.");const i=await this.getAccessor(e.attributes.POSITION,r);if(i.componentType!==rt.FLOAT)throw new D("gltf-loader-unsupported-feature","Expected type FLOAT for POSITION vertex attribute, but found "+rt[i.componentType]);if(i.componentCount!==3)throw new D("gltf-loader-unsupported-feature","POSITION vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(zn,i)}async getNormalData(e,r){if(e.attributes.NORMAL==null)throw new D("gltf-loader-error","No NORMAL vertex data found.");const i=await this.getAccessor(e.attributes.NORMAL,r);if(i.componentType!==rt.FLOAT)throw new D("gltf-loader-unsupported-feature","Expected type FLOAT for NORMAL vertex attribute, but found "+rt[i.componentType]);if(i.componentCount!==3)throw new D("gltf-loader-unsupported-feature","NORMAL vertex attribute must have 3 components, but found "+i.componentCount.toFixed());return this._wrapAccessor(zn,i)}async getTangentData(e,r){if(e.attributes.TANGENT==null)throw new D("gltf-loader-error","No TANGENT vertex data found.");const i=await this.getAccessor(e.attributes.TANGENT,r);if(i.componentType!==rt.FLOAT)throw new D("gltf-loader-unsupported-feature","Expected type FLOAT for TANGENT vertex attribute, but found "+rt[i.componentType]);if(i.componentCount!==4)throw new D("gltf-loader-unsupported-feature","TANGENT vertex attribute must have 4 components, but found "+i.componentCount.toFixed());return new Ff(i.raw,i.byteOffset,i.byteStride,i.byteOffset+i.byteStride*i.entryCount)}async getTextureCoordinates(e,r){if(e.attributes.TEXCOORD_0==null)throw new D("gltf-loader-error","No TEXCOORD_0 vertex data found.");const i=await this.getAccessor(e.attributes.TEXCOORD_0,r);if(i.componentCount!==2)throw new D("gltf-loader-unsupported-feature","TEXCOORD_0 vertex attribute must have 2 components, but found "+i.componentCount.toFixed());if(i.componentType===rt.FLOAT)return this._wrapAccessor(fb,i);if(!i.normalized)throw new D("gltf-loader-unsupported-feature","Integer component types are only supported for a normalized accessor for TEXCOORD_0.");return SSt(i)}async getVertexColors(e,r){if(e.attributes.COLOR_0==null)throw new D("gltf-loader-error","No COLOR_0 vertex data found.");const i=await this.getAccessor(e.attributes.COLOR_0,r);if(i.componentCount!==4&&i.componentCount!==3)throw new D("gltf-loader-unsupported-feature","COLOR_0 attribute must have 3 or 4 components, but found "+i.componentCount.toFixed());if(i.componentCount===4){if(i.componentType===rt.FLOAT)return this._wrapAccessor(Ff,i);if(i.componentType===rt.UNSIGNED_BYTE)return this._wrapAccessor(rl,i);if(i.componentType===rt.UNSIGNED_SHORT)return this._wrapAccessor(C$,i)}else if(i.componentCount===3){if(i.componentType===rt.FLOAT)return this._wrapAccessor(zn,i);if(i.componentType===rt.UNSIGNED_BYTE)return this._wrapAccessor(d8,i);if(i.componentType===rt.UNSIGNED_SHORT)return this._wrapAccessor(f8,i)}throw new D("gltf-loader-unsupported-feature","Unsupported component type for COLOR_0 attribute: "+rt[i.componentType])}hasPositions(e){return e.attributes.POSITION!==void 0}hasNormals(e){return e.attributes.NORMAL!==void 0}hasVertexColors(e){return e.attributes.COLOR_0!==void 0}hasTextureCoordinates(e){return e.attributes.TEXCOORD_0!==void 0}hasTangents(e){return e.attributes.TANGENT!==void 0}async getMaterial(e,r,i){let s=e.material?this._materialCache.get(e.material):void 0;if(!s){const n=e.material!=null?Rfe(this.json.materials[e.material]):Rfe(),o=n.pbrMetallicRoughness,a=this.hasVertexColors(e),l=this.getTexture(o.baseColorTexture,r),c=this.getTexture(n.normalTexture,r),h=i?this.getTexture(n.occlusionTexture,r):void 0,p=i?this.getTexture(n.emissiveTexture,r):void 0,f=i?this.getTexture(o.metallicRoughnessTexture,r):void 0,m=e.material!=null?e.material:-1;s={alphaMode:n.alphaMode,alphaCutoff:n.alphaCutoff,color:o.baseColorFactor,doubleSided:!!n.doubleSided,colorTexture:await l,normalTexture:await c,name:n.name,id:m,occlusionTexture:await h,emissiveTexture:await p,emissiveFactor:n.emissiveFactor,metallicFactor:o.metallicFactor,roughnessFactor:o.roughnessFactor,metallicRoughnessTexture:await f,hasVertexColors:a,ESRI_externalColorMixMode:n.extras.ESRI_externalColorMixMode,colorTextureTransform:o?.baseColorTexture?.extensions?.KHR_texture_transform,normalTextureTransform:n.normalTexture?.extensions?.KHR_texture_transform,occlusionTextureTransform:n.occlusionTexture?.extensions?.KHR_texture_transform,emissiveTextureTransform:n.emissiveTexture?.extensions?.KHR_texture_transform,metallicRoughnessTextureTransform:o?.metallicRoughnessTexture?.extensions?.KHR_texture_transform}}return s}async getTexture(e,r){if(!e)return;if((e.texCoord||0)!==0)throw new D("gltf-loader-unsupported-feature","Only TEXCOORD with index 0 is supported.");const i=e.index,s=this.json.textures[i],n=ySt(s.sampler!=null?this.json.samplers[s.sampler]:{}),o=this._getTextureSourceId(s),a=this.json.images[o],l=await this._loadTextureImageData(i,s,r);return BE(this._textureCache,i,()=>{const c=p=>p===33071||p===33648||p===10497,h=p=>{throw new D("gltf-loader-error",`Unexpected TextureSampler WrapMode: ${p}`)};return{data:l,wrapS:c(n.wrapS)?n.wrapS:h(n.wrapS),wrapT:c(n.wrapT)?n.wrapT:h(n.wrapT),minFilter:n.minFilter,name:a.name,id:i}})}getNodeTransform(e){if(e===void 0)return bSt;let r=this._nodeTransformCache.get(e);if(!r){const i=this.getNodeTransform(this._getNodeParent(e)),s=this.json.nodes[e];s.matrix?r=yi(xe(),i,s.matrix):s.translation||s.rotation||s.scale?(r=xA(i),s.translation&&Cc(r,r,s.translation),s.rotation&&(MN[3]=fte(MN,s.rotation),_u(r,r,MN[3],MN)),s.scale&&vV(r,r,s.scale)):r=xA(i),this._nodeTransformCache.set(e,r)}return r}_wrapAccessor(e,r){return new e(r.raw,r.byteOffset,r.byteStride,r.byteOffset+r.byteStride*(r.entryCount-1)+r.componentByteSize*r.componentCount)}_resolveUri(e){return pc(e,this._baseUri)}_getNodeParent(e){return this._nodeParentMap.get(e)}_checkVersionSupported(){const e=DT.parse(this.json.asset.version,"glTF");wSt.validate(e)}_checkRequiredExtensionsSupported(){const e=this.json;if(e.extensionsRequired&&!e.extensionsRequired.every(r=>this._supportedExtensions.includes(r)))throw new D("gltf-loader-unsupported-feature","gltf loader was not able to load unsupported feature. Required extensions: "+e.extensionsRequired.join(", "))}_computeNodeParents(){this.json.nodes.forEach((e,r)=>{e.children&&e.children.forEach(i=>{this._nodeParentMap.set(i,r)})})}async _loadTextureImageData(e,r,i){const s=this._textureLoaders.get(e);if(s)return s;const n=this._createTextureLoader(r,i);return this._textureLoaders.set(e,n),n}_getTextureSourceId(e){if(e.extensions!==void 0&&e.extensions.KHR_texture_basisu!==null)return e.extensions.KHR_texture_basisu.source;if(e.source!==null)return e.source;throw new D("gltf-loader-unsupported-feature","Source is expected to be defined for a texture. It can also be omitted in favour of an KHR_texture_basisu extension tag.")}async _createTextureLoader(e,r){const i=this._getTextureSourceId(e),s=this.json.images[i];if(s.uri){if(s.uri.endsWith(".ktx2")){const l=await this._context.loadBinary(this._resolveUri(s.uri),r);return new QLe(new Uint8Array(l))}return this._context.loadImage(this._resolveUri(s.uri),r)}if(s.bufferView==null)throw new D("gltf-loader-unsupported-feature","Image bufferView must be defined.");if(s.mimeType==null)throw new D("gltf-loader-unsupported-feature","Image mimeType must be defined.");const n=this.json.bufferViews[s.bufferView],o=await this.getBuffer(n.buffer,r);if(n.byteStride!=null)throw new D("gltf-loader-unsupported-feature","byteStride not supported for image buffer");const a=o.byteOffset+(n.byteOffset||0);return PTt(new Uint8Array(o.buffer,a,n.byteLength),s.mimeType)}async getLoadedBuffersSize(){if(this._glbBuffer)return this._glbBuffer.byteLength;const e=await L5(Array.from(this._bufferLoaders.values())),r=await L5(Array.from(this._textureLoaders.values()));return e.reduce((i,s)=>i+(s?.byteLength??0),0)+r.reduce((i,s)=>i+(s?fT(s)?s.data.byteLength:s.width*s.height*4:0),0)}};const bSt=CSe(xe(),Math.PI/2),wSt=new DT(2,0,"glTF"),MN=Kd(),xSt={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},TSt={[rt.BYTE]:1,[rt.UNSIGNED_BYTE]:1,[rt.SHORT]:2,[rt.UNSIGNED_SHORT]:2,[rt.FLOAT]:4,[rt.INT]:4,[rt.UNSIGNED_INT]:4};function SSt(t){switch(t.componentType){case rt.BYTE:return new g8(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case rt.UNSIGNED_BYTE:return new h8(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case rt.SHORT:return new A$(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case rt.UNSIGNED_SHORT:return new ere(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case rt.UNSIGNED_INT:return new tre(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount);case rt.FLOAT:return new fb(t.raw,t.byteOffset,t.byteStride,t.byteOffset+t.byteStride*t.entryCount)}}let ESt=0;async function iDe(t,e,r={},i=!0){const s=await vSt.load(t,e,r),n="gltf_"+ESt++,o={lods:[],materials:new Map,textures:new Map,meta:CSt(s)},a=!(!s.json.asset.extras||s.json.asset.extras.ESRI_type!=="symbolResource"),l=new Map;await ASt(s,async(h,p,f,m)=>{const g=l.get(f)??0;l.set(f,g+1);const _=h.mode!==void 0?h.mode:Ot.TRIANGLES,v=_===Ot.TRIANGLES||_===Ot.TRIANGLE_STRIP||_===Ot.TRIANGLE_FAN?_:null;if(v==null)return void K.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Unsupported primitive mode ("+Ot[_]+"). Skipping primitive.");if(!s.hasPositions(h))return void K.getLogger("esri.views.3d.glTF").warn("Skipping primitive without POSITION vertex attribute.");const b=s.getPositionData(h,r),x=s.getMaterial(h,r,i),T=s.hasNormals(h)?s.getNormalData(h,r):null,S=s.hasTangents(h)?s.getTangentData(h,r):null,O=s.hasTextureCoordinates(h)?s.getTextureCoordinates(h,r):null,A=s.hasVertexColors(h)?s.getVertexColors(h,r):null,M=s.getIndexData(h,r),P={transform:xA(p),attributes:{position:await b,normal:T?await T:null,texCoord0:O?await O:null,color:A?await A:null,tangent:S?await S:null},indices:await M,primitiveType:v,material:RSt(o,await x,n)};let F=null;o.meta!=null&&o.meta.ESRI_lod!=null&&o.meta.ESRI_lod.metric==="screenSpaceRadius"&&(F=o.meta.ESRI_lod.thresholds[f]),o.lods[f]=o.lods[f]||{parts:[],name:m,lodThreshold:F},o.lods[f].parts[g]=P});for(const h of o.lods)h.parts=h.parts.filter(p=>!!p);const c=await s.getLoadedBuffersSize();return{model:o,meta:{isEsriSymbolResource:a,uri:s.uri},customMeta:{},size:c}}function CSt(t){const e=t.json;let r=null;return e.nodes.forEach(i=>{const s=i.extras;s!=null&&(s.ESRI_proxyEllipsoid||s.ESRI_lod)&&(r=s)}),r}async function ASt(t,e){const r=t.json,i=r.scenes[r.scene||0].nodes,s=i.length>1,n=[];for(const a of i){const l=r.nodes[a];n.push(o(a,0)),OSt(l)&&!s&&l.extensions.MSFT_lod.ids.forEach((c,h)=>o(c,h+1))}async function o(a,l){const c=r.nodes[a],h=t.getNodeTransform(a);if(c.weights!=null&&K.getLogger("esri.views.3d.glTF").warn("[Unsupported Feature] Morph targets are not supported."),c.mesh!=null){const p=r.meshes[c.mesh];for(const f of p.primitives)n.push(e(f,h,l,p.name))}for(const p of c.children||[])n.push(o(p,l))}await Promise.all(n)}function OSt(t){return t.extensions&&t.extensions.MSFT_lod&&Array.isArray(t.extensions.MSFT_lod.ids)}function RSt(t,e,r){const i=n=>{const o=`${r}_tex_${n&&n.id}${n&&n.name?"_"+n.name:""}`;if(n&&!t.textures.has(o)){const a=dSt(n.data,{wrap:{s:n.wrapS,t:n.wrapT},mipmap:MSt.includes(n.minFilter),noUnpackFlip:!0});t.textures.set(o,a)}return o},s=`${r}_mat_${e.id}_${e.name}`;if(!t.materials.has(s)){const n=hSt({color:[e.color[0],e.color[1],e.color[2]],opacity:e.color[3],alphaMode:e.alphaMode,alphaCutoff:e.alphaCutoff,doubleSided:e.doubleSided,colorMixMode:e.ESRI_externalColorMixMode,textureColor:e.colorTexture?i(e.colorTexture):void 0,textureNormal:e.normalTexture?i(e.normalTexture):void 0,textureOcclusion:e.occlusionTexture?i(e.occlusionTexture):void 0,textureEmissive:e.emissiveTexture?i(e.emissiveTexture):void 0,textureMetallicRoughness:e.metallicRoughnessTexture?i(e.metallicRoughnessTexture):void 0,emissiveFactor:[e.emissiveFactor[0],e.emissiveFactor[1],e.emissiveFactor[2]],colorTextureTransform:e.colorTextureTransform,normalTextureTransform:e.normalTextureTransform,occlusionTextureTransform:e.occlusionTextureTransform,emissiveTextureTransform:e.emissiveTextureTransform,metallicRoughnessTextureTransform:e.metallicRoughnessTextureTransform,metallicFactor:e.metallicFactor,roughnessFactor:e.roughnessFactor});t.materials.set(s,n)}return s}const MSt=[Mt.LINEAR_MIPMAP_LINEAR,Mt.LINEAR_MIPMAP_NEAREST];function ISt(t,e){switch(e){case Ot.TRIANGLES:return PSt(t);case Ot.TRIANGLE_STRIP:return $St(t);case Ot.TRIANGLE_FAN:return LSt(t)}}function PSt(t){return typeof t=="number"?PA(t):r1(t)?new Uint16Array(t):t}function $St(t){const e=typeof t=="number"?t:t.length;if(e<3)return[];const r=e-2,i=wU(3*r);if(typeof t=="number"){let s=0;for(let n=0;n<r;n+=1)n%2==0?(i[s++]=n,i[s++]=n+1,i[s++]=n+2):(i[s++]=n+1,i[s++]=n,i[s++]=n+2)}else{let s=0;for(let n=0;n<r;n+=1)n%2==0?(i[s++]=t[n],i[s++]=t[n+1],i[s++]=t[n+2]):(i[s++]=t[n+1],i[s++]=t[n],i[s++]=t[n+2])}return i}function LSt(t){const e=typeof t=="number"?t:t.length;if(e<3)return new Uint16Array(0);const r=e-2,i=r<=65536?new Uint16Array(3*r):new Uint32Array(3*r);if(typeof t=="number"){let a=0;for(let l=0;l<r;++l)i[a++]=0,i[a++]=l+1,i[a++]=l+2;return i}const s=t[0];let n=t[1],o=0;for(let a=0;a<r;++a){const l=t[a+2];i[o++]=s,i[o++]=n,i[o++]=l,n=l}return i}let DSt=class{constructor(){this.geometries=new Array,this.materials=new Array,this.textures=new Array}},NSt=class{constructor(e,r,i){this.name=e,this.lodThreshold=r,this.pivotOffset=i,this.stageResources=new DSt,this.numberOfVertices=0}};const $y=K.getLogger("esri.views.3d.layers.graphics.objectResourceUtils");async function sDe(t,e){const r=await FSt(t,e),i=await BSt(r.textureDefinitions??{},e);let s=0;for(const n in i)if(i.hasOwnProperty(n)){const o=i[n];s+=o?.image?o.image.width*o.image.height*4:0}return{resource:r,textures:i,size:s+WCe(r)}}async function FSt(t,e){const r=e!=null&&e.streamDataRequester;if(r)return kSt(t,r,e);const i=await Sh(Lt(t,e));if(i.ok===!0)return i.value.data;xa(i.error),nDe(i.error)}async function kSt(t,e,r){const i=await Sh(e.request(t,"json",r));if(i.ok===!0)return i.value;xa(i.error),nDe(i.error.details.url)}function nDe(t){throw new D("",`Request for object resource failed: ${t}`)}function USt(t){const e=t.params,r=e.topology;let i=!0;switch(e.vertexAttributes||($y.warn("Geometry must specify vertex attributes"),i=!1),e.topology){case"PerAttributeArray":break;case"Indexed":case null:case void 0:{const n=e.faces;if(n){if(e.vertexAttributes)for(const o in e.vertexAttributes){const a=n[o];a&&a.values?(a.valueType!=null&&a.valueType!=="UInt32"&&($y.warn(`Unsupported indexed geometry indices type '${a.valueType}', only UInt32 is currently supported`),i=!1),a.valuesPerElement!=null&&a.valuesPerElement!==1&&($y.warn(`Unsupported indexed geometry values per element '${a.valuesPerElement}', only 1 is currently supported`),i=!1)):($y.warn(`Indexed geometry does not specify face indices for '${o}' attribute`),i=!1)}}else $y.warn("Indexed geometries must specify faces"),i=!1;break}default:$y.warn(`Unsupported topology '${r}'`),i=!1}t.params.material||($y.warn("Geometry requires material"),i=!1);const s=t.params.vertexAttributes;for(const n in s)s[n].values||($y.warn("Geometries with externally defined attributes are not yet supported"),i=!1);return i}function VSt(t,e){const r=new Array,i=new Array,s=new Array,n=new EO,o=t.resource,a=DT.parse(o.version||"1.0","wosr");jSt.validate(a);const l=o.model.name,c=o.model.geometries,h=o.materialDefinitions??{},p=t.textures;let f=0;const m=new Map;for(let g=0;g<c.length;g++){const _=c[g];if(!USt(_))continue;const v=GSt(_),b=_.params.vertexAttributes,x=[];for(const N in b){const U=b[N],X=U.values;x.push([N,new Ge(X,U.valuesPerElement,!0)])}const T=[];if(_.params.topology!=="PerAttributeArray"){const N=_.params.faces;for(const U in N)T.push([U,N[U].values])}const S=v.texture,O=p&&p[S];if(O&&!m.has(S)){const{image:N,parameters:U}=O,X=new wS(N,U);i.push(X),m.set(S,X)}const A=m.get(S),M=A?A.id:void 0,P=v.material;let F=n.get(P,S);if(F==null){const N=h[P.substring(P.lastIndexOf("/")+1)].params;N.transparency===1&&(N.transparency=0);const U=O&&O.alphaChannelUsage,X=N.transparency>0||U==="transparency"||U==="maskAndTransparency",Z=O?oDe(O.alphaChannelUsage):void 0,G={ambient:Ml(N.diffuse),diffuse:Ml(N.diffuse),opacity:1-(N.transparency||0),transparent:X,textureAlphaMode:Z,textureAlphaCutoff:.33,textureId:M,initTextureTransparent:!0,doubleSided:!0,cullFace:Ii.None,colorMixMode:N.externalColorMixMode||"tint",textureAlphaPremultiplied:O?.parameters.preMultiplyAlpha??!1};e!=null&&e.materialParamsMixin&&Object.assign(G,e.materialParamsMixin),F=new Rg(G),n.set(P,S,F)}s.push(F);const $=new mn(F,x,T);f+=T.find(N=>N[0]===E.POSITION)?.[1].length??0,r.push($)}return{engineResources:[{name:l,stageResources:{textures:i,materials:s,geometries:r},pivotOffset:o.model.pivotOffset,numberOfVertices:f,lodThreshold:null}],referenceBoundingBox:zSt(r)}}function zSt(t){const e=Gi();return t.forEach(r=>{const i=r.boundingInfo;i!=null&&(yg(e,i.bbMin),yg(e,i.bbMax))}),e}async function BSt(t,e){const r=new Array;for(const n in t){const o=t[n],a=o.images[0].data;if(!a){$y.warn("Externally referenced texture data is not yet supported");continue}const l=o.encoding+";base64,"+a,c="/textureDefinitions/"+n,h=o.channels==="rgba"?o.alphaChannelUsage||"transparency":"none",p={noUnpackFlip:!0,wrap:{s:Ut.REPEAT,t:Ut.REPEAT},preMultiplyAlpha:oDe(h)!==ni.Opaque},f=e!=null&&e.disableTextures?Promise.resolve(null):D0(l,e);r.push(f.then(m=>({refId:c,image:m,parameters:p,alphaChannelUsage:h})))}const i=await Promise.all(r),s={};for(const n of i)s[n.refId]=n;return s}function oDe(t){switch(t){case"mask":return ni.Mask;case"maskAndTransparency":return ni.MaskBlend;case"none":return ni.Opaque;default:return ni.Blend}}function GSt(t){const e=t.params;return{id:1,material:e.material,texture:e.texture,region:e.texture}}const jSt=new DT(1,2,"wosr"),_2=2.1;async function aDe(t,e){const r=lDe(zW(t));if(r.fileType==="wosr"){const p=await(e.cache?e.cache.loadWOSR(r.url,e):sDe(r.url,e)),{engineResources:f,referenceBoundingBox:m}=VSt(p,e);return{lods:f,referenceBoundingBox:m,isEsriSymbolResource:!1,isWosr:!0}}const i=await(e.cache?e.cache.loadGLTF(r.url,e,!!e.usePBR):iDe(new tDe(e.streamDataRequester),r.url,e,e.usePBR)),s=i.model.meta?.ESRI_proxyEllipsoid,n=i.meta.isEsriSymbolResource&&s!=null&&i.meta.uri.includes("/RealisticTrees/");n&&!i.customMeta.esriTreeRendering&&(i.customMeta.esriTreeRendering=!0,ZSt(i,s));const o=!!e.usePBR,a=i.meta.isEsriSymbolResource?{usePBR:o,isSchematic:!1,treeRendering:n,mrrFactors:[...Xwt]}:{usePBR:o,isSchematic:!1,treeRendering:!1,mrrFactors:[...H8]},l={...e.materialParamsMixin,treeRendering:n},{engineResources:c,referenceBoundingBox:h}=cDe(i,a,l,e.skipHighLods&&r.specifiedLodIndex==null?{skipHighLods:!0}:{skipHighLods:!1,singleLodIndex:r.specifiedLodIndex});return{lods:c,referenceBoundingBox:h,isEsriSymbolResource:i.meta.isEsriSymbolResource,isWosr:!1}}function lDe(t){const e=t.match(/(.*\.(gltf|glb))(\?lod=([0-9]+))?$/);return e?{fileType:"gltf",url:e[1],specifiedLodIndex:e[4]!=null?Number(e[4]):null}:t.match(/(.*\.(json|json\.gz))$/)?{fileType:"wosr",url:t,specifiedLodIndex:null}:{fileType:"unknown",url:t,specifiedLodIndex:null}}function cDe(t,e,r,i){const s=t.model,n=new Array,o=new Map,a=new Map,l=s.lods.length,c=Gi();return s.lods.forEach((h,p)=>{const f=i.skipHighLods===!0&&(l>1&&p===0||l>3&&p===1)||i.skipHighLods===!1&&i.singleLodIndex!=null&&p!==i.singleLodIndex;if(f&&p!==0)return;const m=new NSt(h.name,h.lodThreshold,[0,0,0]);h.parts.forEach(g=>{const _=f?new Rg({}):HSt(s,g,m,e,r,o,a),{geometry:v,vertexCount:b}=qSt(g,_??new Rg({})),x=v.boundingInfo;x!=null&&p===0&&(yg(c,x.bbMin),yg(c,x.bbMax)),_!=null&&(m.stageResources.geometries.push(v),m.numberOfVertices+=b)}),f||n.push(m)}),{engineResources:n,referenceBoundingBox:c}}function HSt(t,e,r,i,s,n,o){const a=e.material+(e.attributes.normal?"_normal":"")+(e.attributes.color?"_color":"")+(e.attributes.texCoord0?"_texCoord0":"")+(e.attributes.tangent?"_tangent":""),l=t.materials.get(e.material),c=e.attributes.texCoord0!=null,h=e.attributes.normal!=null;if(l==null)return null;const p=WSt(l.alphaMode);if(!n.has(a)){if(c){const O=(A,M=!1)=>{if(A!=null&&!o.has(A)){const P=t.textures.get(A);if(P!=null){const F=P.data;o.set(A,new wS(fT(F)?F.data:F,{...P.parameters,preMultiplyAlpha:!fT(F)&&M,encoding:fT(F)&&F.encoding!=null?F.encoding:void 0}))}}};O(l.textureColor,p!==ni.Opaque),O(l.textureNormal),O(l.textureOcclusion),O(l.textureEmissive),O(l.textureMetallicRoughness)}const m=l.color[0]**(1/_2),g=l.color[1]**(1/_2),_=l.color[2]**(1/_2),v=l.emissiveFactor[0]**(1/_2),b=l.emissiveFactor[1]**(1/_2),x=l.emissiveFactor[2]**(1/_2),T=l.textureColor!=null&&c?o.get(l.textureColor):null,S=SLe({normalTexture:l.textureNormal,metallicRoughnessTexture:l.textureMetallicRoughness,metallicFactor:l.metallicFactor,roughnessFactor:l.roughnessFactor,emissiveTexture:l.textureEmissive,emissiveFactor:l.emissiveFactor,occlusionTexture:l.textureOcclusion});n.set(a,new Rg({...i,transparent:p===ni.Blend,customDepthTest:UT.Lequal,textureAlphaMode:p,textureAlphaCutoff:l.alphaCutoff,diffuse:[m,g,_],ambient:[m,g,_],opacity:l.opacity,doubleSided:l.doubleSided,doubleSidedType:"winding-order",cullFace:l.doubleSided?Ii.None:Ii.Back,hasVertexColors:!!e.attributes.color,hasVertexTangents:!!e.attributes.tangent,normalType:h?Fr.Attribute:Fr.ScreenDerivative,castShadows:!0,receiveSSAO:!0,textureId:T?.id,colorMixMode:l.colorMixMode,normalTextureId:l.textureNormal!=null&&c?o.get(l.textureNormal).id:void 0,textureAlphaPremultiplied:T!=null&&!!T.parameters.preMultiplyAlpha,occlusionTextureId:l.textureOcclusion!=null&&c?o.get(l.textureOcclusion).id:void 0,emissiveTextureId:l.textureEmissive!=null&&c?o.get(l.textureEmissive).id:void 0,metallicRoughnessTextureId:l.textureMetallicRoughness!=null&&c?o.get(l.textureMetallicRoughness).id:void 0,emissiveFactor:[v,b,x],mrrFactors:S?[...vie]:[l.metallicFactor,l.roughnessFactor,i.mrrFactors[2]],isSchematic:S,colorTextureTransformMatrix:Ym(l.colorTextureTransform),normalTextureTransformMatrix:Ym(l.normalTextureTransform),occlusionTextureTransformMatrix:Ym(l.occlusionTextureTransform),emissiveTextureTransformMatrix:Ym(l.emissiveTextureTransform),metallicRoughnessTextureTransformMatrix:Ym(l.metallicRoughnessTextureTransform),...s}))}const f=n.get(a);if(r.stageResources.materials.push(f),c){const m=g=>{g!=null&&r.stageResources.textures.push(o.get(g))};m(l.textureColor),m(l.textureNormal),m(l.textureOcclusion),m(l.textureEmissive),m(l.textureMetallicRoughness)}return f}function qSt(t,e){const r=t.attributes.position.count,i=ISt(t.indices||r,t.primitiveType),s=vs(3*r),{typedBuffer:n,typedBufferStride:o}=t.attributes.position;BA(s,n,t.transform,3,o);const a=[[E.POSITION,new Ge(s,3,!0)]],l=[[E.POSITION,i]];if(t.attributes.normal!=null){const c=vs(3*r),{typedBuffer:h,typedBufferStride:p}=t.attributes.normal;Z1(IN,t.transform),WT(c,h,IN,3,p),a.push([E.NORMAL,new Ge(c,3,!0)]),l.push([E.NORMAL,i])}if(t.attributes.tangent!=null){const c=vs(4*r),{typedBuffer:h,typedBufferStride:p}=t.attributes.tangent;Z1(IN,t.transform),xie(c,h,IN,4,p),a.push([E.TANGENT,new Ge(c,4,!0)]),l.push([E.TANGENT,i])}if(t.attributes.texCoord0!=null){const c=vs(2*r),{typedBuffer:h,typedBufferStride:p}=t.attributes.texCoord0;Tie(c,h,2,p),a.push([E.UV0,new Ge(c,2,!0)]),l.push([E.UV0,i])}if(t.attributes.color!=null){const c=new Uint8Array(4*r);t.attributes.color.elementCount===4?t.attributes.color instanceof Ff?KU(c,t.attributes.color,255):t.attributes.color instanceof rl?Sie(c,t.attributes.color):t.attributes.color instanceof C$&&KU(c,t.attributes.color,1/256):(c.fill(255),t.attributes.color instanceof zn?jU(c,t.attributes.color,255,4):t.attributes.color instanceof d8?j$(c,t.attributes.color.typedBuffer,4,t.attributes.color.typedBufferStride):t.attributes.color instanceof f8&&jU(c,t.attributes.color,1/256,4)),a.push([E.COLOR,new Ge(c,4,!0)]),l.push([E.COLOR,i])}return{geometry:new mn(e,a,l),vertexCount:r}}const IN=ts();function WSt(t){switch(t){case"BLEND":return ni.Blend;case"MASK":return ni.Mask;case"OPAQUE":case null:case void 0:return ni.Opaque}}function ZSt(t,e){for(let r=0;r<t.model.lods.length;++r){const i=t.model.lods[r];for(const s of i.parts){const n=s.attributes.normal;if(n==null)return;const o=s.attributes.position,a=o.count,l=C(),c=C(),h=C(),p=new Uint8Array(4*a),f=new Float64Array(3*a),m=so(xe(),s.transform);let g=0,_=0;for(let v=0;v<a;v++){o.getVec(v,c),n.getVec(v,l),Ne(c,c,s.transform),pe(h,c,e.center),tk(h,h,e.radius);const b=h[2],x=Oe(h),T=Math.min(.45+.55*x*x,1);tk(h,h,e.radius),m!==null&&Ne(h,h,m),_e(h,h),r+1!==t.model.lods.length&&t.model.lods.length>1&&Wr(h,h,l,b>-1?.2:Math.min(-4*b-3.8,1)),f[g]=h[0],f[g+1]=h[1],f[g+2]=h[2],g+=3,p[_]=255*T,p[_+1]=255*T,p[_+2]=255*T,p[_+3]=255,_+=4}s.attributes.normal=new zn(f),s.attributes.color=new rl(p)}}}const Bqt=Object.freeze(Object.defineProperty({__proto__:null,fetch:aDe,gltfToEngineResources:cDe,parseUrl:lDe},Symbol.toStringTag,{value:"Module"}));async function XSt(t){if(t===null||t.styleName==null&&t.styleUrl==null)return null;const e=t.name;if(e==null)throw new D("symbolstyleutils:style-symbol-reference-name-missing","Missing name in style symbol reference");const r={portal:t.portal},i=await WK(t,r).catch(()=>null);if(i===null)return null;const s=$ee(e,i.data);if(s&&!s.formatInfos?.some(a=>a.type==="gltf_basisu"))return null;const n=await Lee(i,e,r,"webRef",(a,l)=>pSe(a,l,["gltf_basisu","gltf"])).catch(()=>null);if(n===null||n.type!=="point-3d")return null;const o=n.symbolLayers.items[0];return o.type==="object"?o.resource:null}let YSt=class{constructor(e,r,i){this._elementSize=r,this._buffer=Gr.createVertex(e,Mr.STATIC_DRAW),this.resize(i)}destroy(){this._buffer.dispose()}get elementSize(){return this._elementSize}get capacity(){return this._capacity}get array(){return this._array}get buffer(){return this._buffer}get memoryUsage(){return{cpu:this._capacity*this._elementSize,gpu:this._capacity*this._elementSize}}copyRange(e,r,i,s=0){const n=new Uint8Array(this.array,e*this.elementSize,(r-e)*this.elementSize);new Uint8Array(i.array,s*this.elementSize).set(n)}transferAll(){this._buffer.setData(this._array)}transferRange(e,r){const i=e*this._elementSize,s=r*this._elementSize;this._buffer.setSubData(new Uint8Array(this._array),i,i,s)}resize(e){const r=e*this._elementSize,i=new ArrayBuffer(r);this._array&&(e>=this._capacity?new Uint8Array(i).set(new Uint8Array(this._array)):new Uint8Array(i).set(new Uint8Array(this._array).subarray(0,e*this._elementSize))),this._array=i,this._buffer.setSize(r),this._capacity=e}},JSt=class{constructor(e){this.modelOriginHi=e.getField(E.MODELORIGINHI,zn),this.modelOriginLo=e.getField(E.MODELORIGINLO,zn),this.model=e.getField(E.MODEL,Q1),this.modelNormal=e.getField(E.MODELNORMAL,Q1),this.featureAttribute=e.getField(E.INSTANCEFEATUREATTRIBUTE,Ff),this.color=e.getField(E.INSTANCECOLOR,rl),this.objectAndLayerIdColor=e.getField(E.INSTANCEOBJECTANDLAYERIDCOLOR,rl)}},Mfe=class{constructor(e,r){this._headIndex=0,this._tailIndex=0,this._firstIndex=null,this._captureFirstIndex=!0,this._updating=!1,this._prevHeadIndex=0,this._resized=!1,this._rctx=e,this._instanceBufferLayout=r,this._elementSize=r.stride,this._capacity=1}destroy(){this._buffer&&this._buffer.destroy()}get buffer(){return this._buffer.buffer}get view(){return this._view}get capacity(){return this._capacity}get size(){const e=this._headIndex,r=this._tailIndex;return e>=r?e-r:e+this._capacity-r}get isEmpty(){return this._headIndex===this._tailIndex}get isFull(){return this._tailIndex===(this._headIndex+1)%this._capacity}get headIndex(){return this._headIndex}get tailIndex(){return this._tailIndex}get firstIndex(){return this._firstIndex}get memoryUsage(){return this._buffer?this._buffer.memoryUsage:{cpu:0,gpu:0}}reset(){this._headIndex=0,this._tailIndex=0,this._firstIndex=null}startUpdateCycle(){this._captureFirstIndex=!0}beginUpdate(){it(!this._updating,"already updating"),this._updating=!0,this._prevHeadIndex=this._headIndex}endUpdate(){it(this._updating,"not updating"),this.size<g4e*this.capacity&&this._shrink(),this._resized?(this._buffer.transferAll(),this._resized=!1):this._transferRange(this._prevHeadIndex,this._headIndex),this._updating=!1}allocateHead(){it(this._updating,"not updating"),this.isFull&&this._grow();const e=this.headIndex;return this._captureFirstIndex&&(this._firstIndex=e,this._captureFirstIndex=!1),this._incrementHead(),it(this._headIndex!==this._tailIndex,"invalid pointers"),e}freeTail(){it(this._updating,"not updating"),it(this.size>0,"invalid size");const e=this._tailIndex===this._firstIndex;this._incrementTail(),e&&(this._firstIndex=this._tailIndex)}_grow(){const e=Math.max(e6,Math.floor(this._capacity*v6));this._resize(e)}_shrink(){const e=Math.max(e6,Math.floor(this._capacity*m4e));this._resize(e)}_resize(e){if(it(this._updating,"not updating"),e===this._capacity)return;const r=new YSt(this._rctx,this._elementSize,e);if(this._buffer){this._firstIndex&&(this._firstIndex=(this._firstIndex+this._capacity-this._tailIndex)%this._capacity);const i=this.size,s=this._compactInstances(r);it(s===i,"invalid compaction"),this._buffer.destroy(),this._tailIndex=0,this._headIndex=s,this._prevHeadIndex=0}this._resized=!0,this._capacity=e,this._buffer=r,this._view=new JSt(this._instanceBufferLayout.createView(this._buffer.array))}_compactInstances(e){const r=this._headIndex,i=this._tailIndex;return i<r?(this._buffer.copyRange(i,r,e),r-i):i>r?(this._buffer.copyRange(i,this._capacity,e),r>0&&this._buffer.copyRange(0,r,e,this._capacity-i),r+(this._capacity-i)):0}_incrementHead(e=1){this._headIndex=(this._headIndex+e)%this._capacity}_incrementTail(e=1){this._tailIndex=(this._tailIndex+e)%this._capacity}_transferRange(e,r){e<r?this._buffer.transferRange(e,r):e>r&&(r>0&&this._buffer.transferRange(0,r),this._buffer.transferRange(e,this._capacity))}};const e6=64;var Yi;function QSt(t){let e=us().mat4f64(E.LOCALTRANSFORM).mat4f64(E.GLOBALTRANSFORM).vec4f64(E.BOUNDINGSPHERE).vec3f64(E.MODELORIGIN).mat3f(E.MODEL).mat3f(E.MODELNORMAL).vec2f(E.MODELSCALEFACTORS);return t.includes(E.FEATUREATTRIBUTE)&&(e=e.vec4f(E.FEATUREATTRIBUTE)),t.includes(E.COLOR)&&(e=e.vec4u8(E.COLOR)),t.includes(E.OBJECTANDLAYERIDCOLOR)&&(e=e.vec4u8(E.OBJECTANDLAYERIDCOLOR)),e=e.u8(E.STATE).u8(E.LODLEVEL),e}(function(t){t[t.ALLOCATED=1]="ALLOCATED",t[t.DEFAULT_ACTIVE=2]="DEFAULT_ACTIVE",t[t.VISIBLE=4]="VISIBLE",t[t.HIGHLIGHT=8]="HIGHLIGHT",t[t.HIGHLIGHT_ACTIVE=16]="HIGHLIGHT_ACTIVE",t[t.REMOVE=32]="REMOVE",t[t.TRANSFORM_CHANGED=64]="TRANSFORM_CHANGED",t[t.ACTIVE=18]="ACTIVE"})(Yi||(Yi={}));let Ife=class{constructor(e){this.localTransform=e.getField(E.LOCALTRANSFORM,mP),this.globalTransform=e.getField(E.GLOBALTRANSFORM,mP),this.modelOrigin=e.getField(E.MODELORIGIN,Yd),this.model=e.getField(E.MODEL,Q1),this.modelNormal=e.getField(E.MODELNORMAL,Q1),this.modelScaleFactors=e.getField(E.MODELSCALEFACTORS,fb),this.boundingSphere=e.getField(E.BOUNDINGSPHERE,u8),this.featureAttribute=e.getField(E.FEATUREATTRIBUTE,Ff),this.color=e.getField(E.COLOR,rl),this.objectAndLayerIdColor=e.getField(E.OBJECTANDLAYERIDCOLOR,rl),this.state=e.getField(E.STATE,IA),this.lodLevel=e.getField(E.LODLEVEL,IA)}},IE=class extends me{constructor(e,r){super(e),this.events=new Xr,this._capacity=0,this._size=0,this._next=0,this._layout=QSt(r),this._capacity=e6,this._buffer=this._layout.createBuffer(this._capacity),this._view=new Ife(this._buffer)}get capacity(){return this._capacity}get size(){return this._size}get view(){return this._view}addInstance(){this._size+1>this._capacity&&this._grow();const e=this._findSlot();return this._view.state.set(e,Yi.ALLOCATED),this._size++,this.events.emit("instances-changed"),e}removeInstance(e){const r=this._view.state;it(e>=0&&e<this._capacity&&(r.get(e)&Yi.ALLOCATED)!=0,"invalid instance handle"),this._getStateFlag(e,Yi.ACTIVE)?this._setStateFlags(e,Yi.REMOVE):this.freeInstance(e),this.events.emit("instances-changed")}freeInstance(e){const r=this._view.state;it(e>=0&&e<this._capacity&&(r.get(e)&Yi.ALLOCATED)!=0,"invalid instance handle"),r.set(e,0),this._size--}setLocalTransform(e,r,i=!0){this._view.localTransform.setMat(e,r),i&&this.updateModelTransform(e)}getLocalTransform(e,r){this._view.localTransform.getMat(e,r)}setGlobalTransform(e,r,i=!0){this._view.globalTransform.setMat(e,r),i&&this.updateModelTransform(e)}getGlobalTransform(e,r){this._view.globalTransform.getMat(e,r)}updateModelTransform(e){const r=this._view,i=Fc,s=gp;r.localTransform.getMat(e,Pfe),r.globalTransform.getMat(e,$G);const n=yi($G,$G,Pfe);ie(i,n[12],n[13],n[14]),r.modelOrigin.setVec(e,i),qd(s,n),r.model.setMat(e,s);const o=jat(Fc,n);o.sort(),r.modelScaleFactors.set(e,0,o[1]),r.modelScaleFactors.set(e,1,o[2]),gS(s,s),Wd(s,s),r.modelNormal.setMat(e,s),this._setStateFlags(e,Yi.TRANSFORM_CHANGED),this.events.emit("instance-transform-changed",{index:e})}getModelTransform(e,r){const i=this._view;i.model.getMat(e,gp),i.modelOrigin.getVec(e,Fc),r[0]=gp[0],r[1]=gp[1],r[2]=gp[2],r[3]=0,r[4]=gp[3],r[5]=gp[4],r[6]=gp[5],r[7]=0,r[8]=gp[6],r[9]=gp[7],r[10]=gp[8],r[11]=0,r[12]=Fc[0],r[13]=Fc[1],r[14]=Fc[2],r[15]=1}applyShaderTransformation(e,r){this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,r)}getCombinedModelTransform(e,r){return this.getModelTransform(e,r),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,r),r}getCombinedLocalTransform(e,r){this._view.localTransform.getMat(e,r),this.shaderTransformation!=null&&this.shaderTransformation.applyTransform(this,e,r)}getCombinedMaxScaleFactor(e){let r=this._view.modelScaleFactors.get(e,1);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(Fc,this,e),r*=Math.max(Fc[0],Fc[1],Fc[2])),r}getCombinedMedianScaleFactor(e){let r=this._view.modelScaleFactors.get(e,0);return this.shaderTransformation!=null&&(this.shaderTransformation.scaleFactor(Fc,this,e),r*=KSt(Fc[0],Fc[1],Fc[2])),r}getModel(e,r){this._view.model.getMat(e,r)}setFeatureAttribute(e,r){this._view.featureAttribute.setVec(e,r)}getFeatureAttribute(e,r){this._view.featureAttribute.getVec(e,r)}setColor(e,r){this._view.color.setVec(e,r)}setObjectAndLayerIdColor(e,r){this._view.objectAndLayerIdColor.setVec(e,r)}setVisible(e,r){r!==this.getVisible(e)&&(this._setStateFlag(e,Yi.VISIBLE,r),this.events.emit("instance-visibility-changed",{index:e}))}getVisible(e){return this._getStateFlag(e,Yi.VISIBLE)}setHighlight(e,r){r!==this.getHighlight(e)&&(this._setStateFlag(e,Yi.HIGHLIGHT,r),this.events.emit("instance-highlight-changed"))}getHighlight(e){return this._getStateFlag(e,Yi.HIGHLIGHT)}getState(e){return this._view.state.get(e)}getLodLevel(e){return this._view.lodLevel.get(e)}countFlags(e){let r=0;for(let i=0;i<this._capacity;++i)this.getState(i)&e&&++r;return r}_setStateFlags(e,r){const i=this._view.state;r=i.get(e)|r,i.set(e,r)}_clearStateFlags(e,r){const i=this._view.state;r=i.get(e)&~r,i.set(e,r)}_setStateFlag(e,r,i){i?this._setStateFlags(e,r):this._clearStateFlags(e,r)}_getStateFlag(e,r){return!!(this._view.state.get(e)&r)}_grow(){this._capacity=Math.max(e6,Math.floor(this._capacity*v6)),this._buffer=this._layout.createBuffer(this._capacity).copyFrom(this._buffer),this._view=new Ife(this._buffer)}_findSlot(){const e=this._view.state;let r=this._next;for(;e.get(r)&Yi.ALLOCATED;)r=r+1===this._capacity?0:r+1;return this._next=r+1===this._capacity?0:r+1,r}};function KSt(t,e,r){return Math.max(Math.min(t,e),Math.min(Math.max(t,e),r))}u([d({constructOnly:!0})],IE.prototype,"shaderTransformation",void 0),u([d()],IE.prototype,"_size",void 0),u([d({readOnly:!0})],IE.prototype,"size",null),IE=u([R("esri.views.3d.webgl-engine.lib.lodRendering.InstanceData")],IE);const Fc=C(),gp=ts(),Pfe=xe(),$G=xe();let e2t=class extends mf{constructor(e,r){super(i=>this._instanceData.view.boundingSphere.getVec(i,this._tmpSphere),{maximumDepth:25}),this._instanceData=e,this._boundingSphere=r,this._tmpSphere=js(),this._tmpMat4=xe()}addInstance(e){const r=this._instanceData.view.boundingSphere,i=this._instanceData.getCombinedModelTransform(e,this._tmpMat4);Ne(this._tmpSphere,this._boundingSphere.center,i),this._tmpSphere[3]=this._boundingSphere.radius*SA(i),r.setVec(e,this._tmpSphere),this.add([e])}removeInstance(e){this.remove([e])}},t2t=class{constructor(e,r){this._worldSpaceRadius=e,this._minScreenSpaceRadii=r}selectLevel(e,r,i){const s=i.computeScreenPixelSizeAt(e),n=this._worldSpaceRadius*r/s;let o=0;for(let a=1;a<this._minScreenSpaceRadii.length;++a)n>=this._minScreenSpaceRadii[a]&&(o=a);return o}},r2t=class extends y8{constructor(e,r,i,s,n,o){super(e,r),this.layerUid=e,this.graphicUid=r,this.geometryId=i,this.triangleNr=s,this.baseBoundingSphere=n,this.numLodLevels=o}};function Eie(t){return Bf(t)&&t.intersector===ls.LOD&&!!t.target}let i2t=class{constructor(e,r){const i=e.renderContext.rctx,s=r.geometry;this._materialRepository=e.materialRepository,s.material.setParameters({instancedDoublePrecision:!0});const n=s.material.createBufferWriter(),o=n.vertexBufferLayout,a=n.elementCount(s),l=o.createBuffer(a);n.write(null,null,s,l,0),this.geometry=s,this.material=s.material,this.glMaterials=new tLe(s.material,this._materialRepository),this.vertexBufferLayout=o,this.vbo=Gr.createVertex(i,Mr.STATIC_DRAW,l.buffer),this.vao=new zf(i,Er,{geometry:$u(o)},{geometry:this.vbo}),this.vertexCount=a}destroy(){this.glMaterials.destroy(),this.vbo.dispose(),this.vao.dispose()}get boundingInfo(){return this.geometry.boundingInfo}get triangleCount(){return this.vertexCount/3}intersect(e,r,i,s,n,o,a,l){const c=this.geometry.id;this.material.intersect(this.geometry,e.transform.transform,e,i,s,(h,p,f,m,g)=>{if(h>=0){if(r!=null&&!r(e.rayBegin,e.rayEnd,h))return;const _=new r2t(o.layerUid,o.graphicUid(n),c,f,a,l);if((e.results.min.drapedLayerOrder==null||g>=e.results.min.drapedLayerOrder)&&(e.results.min.dist==null||h<e.results.min.dist)&&e.results.min.set(ls.LOD,_,h,p,e.transform.transform,g),e.options.store!==na.MIN&&(e.results.max.drapedLayerOrder==null||g>=e.results.max.drapedLayerOrder)&&(e.results.max.dist==null||h>e.results.max.dist)&&e.results.max.set(ls.LOD,_,h,p,e.transform.transform,g),e.options.store===na.ALL){const v=ore(e.results.min.ray);v.set(ls.LOD,_,h,p,e.transform.transform,g),e.results.all.push(v)}}})}},s2t=class uDe{static async create(e,r,i){const s=await Promise.allSettled(r.components.map(o=>e.controller.schedule(()=>new i2t(e,o),i))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(Ia);if(dn(i)||n.length!==s.length){n.forEach(o=>o.destroy()),Dt(i);for(const o of s)if(o.status==="rejected")throw o.reason}return new uDe(r.minScreenSpaceRadius,n)}constructor(e,r){this.minScreenSpaceRadius=e,this.components=r}destroy(){this.components.forEach(e=>e.destroy())}intersect(e,r,i,s,n,o,a){this.components.forEach(l=>l.intersect(e,r,i,s,n,o,this.boundingSphere,a))}get boundingBox(){if(this._boundingBox==null){const e=Gi();this.components.forEach(r=>{r.boundingInfo!=null&&(yg(e,r.boundingInfo.bbMin),yg(e,r.boundingInfo.bbMax))}),this._boundingBox=e}return this._boundingBox}get boundingSphere(){if(this._boundingSphere==null){const e=this.boundingBox,r=C();lf(e,r),this._boundingSphere={center:r,radius:.5*lxe(e)}}return this._boundingSphere}get triangleCount(){return this.components.reduce((e,r)=>e+r.triangleCount,0)}};const n2t=t=>{const e=t.baseBoundingSphere.radius,r=t.levels.map(i=>i.minScreenSpaceRadius);return new t2t(e,r)};let nd=class extends me{constructor(e,r){super(e),this.type=ls.LOD,this.isGround=!1,this._handles=new li,this._levels=[],this._defaultRenderInstanceData=[new Array],this._highlightRenderInstanceData=[new Array],this._allRenderInstanceData=[this._defaultRenderInstanceData[0],this._highlightRenderInstanceData[0]],this._instanceIndex=0,this._cycleStartIndex=0,this._slicePlane=!1,this._camera=new ft,this._updateCyclesWithStaticCamera=-1,this._needFullCycle=!1,this.slots=[fe.OPAQUE_MATERIAL,fe.TRANSPARENT_MATERIAL],this.canRender=!0,this._instanceData=new IE({shaderTransformation:e.shaderTransformation},e.optionalFields),this._handles.add(r.registerTask(gt.LOD_RENDERER,this))}initialize(){this._instanceBufferLayout=a2t(this.optionalFields),this._glInstanceBufferLayout=$u(this._instanceBufferLayout,1),this._handles.add([this._instanceData.events.on("instances-changed",()=>this._requestUpdateCycle()),this._instanceData.events.on("instance-transform-changed",({index:e})=>{this._requestUpdateCycle(),this.metadata.notifyGraphicGeometryChanged(e)}),this._instanceData.events.on("instance-visibility-changed",({index:e})=>{this._requestUpdateCycle(!0),this.metadata.notifyGraphicVisibilityChanged(e)}),this._instanceData.events.on("instance-highlight-changed",()=>this._requestUpdateCycle(!0))])}destroy(){this._handles.destroy()}get _enableLevelSelection(){return this.symbol.levels.length>1}get levels(){return this._levels}get baseBoundingBox(){return this._levels[this._levels.length-1].boundingBox}get baseBoundingSphere(){return this._levels[this._levels.length-1].boundingSphere}get baseMaterial(){return this._levels[this._levels.length-1].components[0].material}get slicePlaneEnabled(){return this._slicePlane}set slicePlaneEnabled(e){this._slicePlane=e}get layerUid(){return this.metadata.layerUid}get instanceData(){return this._instanceData}get memoryUsage(){const e={cpu:0,gpu:0};return this._allRenderInstanceData.forEach(r=>r.forEach(i=>{e.cpu+=i.memoryUsage.cpu,e.gpu+=i.memoryUsage.gpu})),e}get renderStats(){const e=this._instanceData.size,r=[];return this._levels.forEach((i,s)=>{const n=this._allRenderInstanceData[0][s].size+this._allRenderInstanceData[1][s].size,o=i.triangleCount;r.push({renderedInstances:n,renderedTriangles:n*o,trianglesPerInstance:o})}),{totalInstances:e,renderedInstances:r.reduce((i,s)=>i+s.renderedInstances,0),renderedTriangles:r.reduce((i,s)=>i+s.renderedTriangles,0),levels:r}}async initializeRenderContext(e,r){this._context=e;const i=e.renderContext.rctx,s=await Promise.allSettled(this.symbol.levels.map(o=>(this._defaultRenderInstanceData[0].push(new Mfe(i,this._instanceBufferLayout)),this._highlightRenderInstanceData[0].push(new Mfe(i,this._instanceBufferLayout)),s2t.create(e,o,r)))),n=s.map(o=>o.status==="fulfilled"?o.value:null).filter(Ia);if(dn(r)||n.length!==s.length){n.forEach(o=>o.destroy()),Dt(r);for(const o of s)if(o.status==="rejected")throw o.reason}this._levels=n,this._levelSelector=n2t(this)}uninitializeRenderContext(){this._invalidateOctree(),this._levels.forEach(e=>e.destroy()),this._defaultRenderInstanceData[0].forEach(e=>e.destroy()),this._highlightRenderInstanceData[0].forEach(e=>e.destroy())}get needsTransparentPass(){return this._levels.some(e=>e.components.some(r=>r.material.requiresSlot(fe.TRANSPARENT_MATERIAL,k.Color)))}get needsHighlight(){return this._highlightRenderInstanceData[0].some(e=>e.size>0)}prepareRender(e){if(!bi.LOD_INSTANCE_RENDERER_DISABLE_UPDATES){if(this._enableLevelSelection){const r=e.bindParameters.contentCamera.equals(this._camera);this._camera.copyFrom(e.bindParameters.contentCamera),r||this._requestUpdateCycle()}this._needFullCycle&&(this.runTask(Ll),this._needFullCycle=!1)}}prepareTechniques(e){if(!this.baseMaterial.isVisible()||!this.baseMaterial.isVisibleForOutput(e.output))return null;const r=this._getInstanceDatas(e.output);if(!r)return null;const i=new Array;return r.forEach(s=>this.levels.forEach((n,o)=>{n.components.forEach(a=>i.push(this._beginComponent(e,s[o],a)))})),i}render(e,r){const i=this._getInstanceDatas(e.output);if(!i)return;let s=0;e.rctx.bindVAO(),i.forEach(n=>this.levels.forEach((o,a)=>{o.components.forEach(l=>this._renderComponent(e,r[s++],n[a],l,a))}))}_getInstanceDatas(e){const r=e!==k.Highlight&&e!==k.ShadowHighlight,i=e!==k.ShadowExcludeHighlight;return r&&i?this._allRenderInstanceData:r?this._defaultRenderInstanceData:i?this._highlightRenderInstanceData:null}intersect(e,r,i,s){if(!this.baseMaterial.isVisible()||this._octree==null)return;const n=C();pe(n,s,i);const o=a=>{this._instanceData.getCombinedModelTransform(a,Dfe),e.transform.set(Dfe),Ne(Nfe,i,e.transform.inverse),Ne(Ffe,s,e.transform.inverse);const l=this._instanceData.getState(a),c=this._instanceData.getLodLevel(a),h=this._levels.length;it((l&Yi.ACTIVE)!=0,"invalid instance state"),it(c>=0&&c<h,"invaid lod level"),this._levels[c].intersect(e,r,Nfe,Ffe,a,this.metadata,h)};this.baseMaterial.parameters.verticalOffset?this._octree.forEach(o):this._octree.forEachAlongRay(i,n,o)}queryDepthRange(e){return this._queryDepthRangeOctree(e)}notifyShaderTransformationChanged(){this._invalidateOctree(),this._requestUpdateCycle()}get _octree(){if(this._octreeCached==null){const e=this._instanceData,r=e.view?.state;if(!r)return null;this._octreeCached=new e2t(e,this.baseBoundingSphere);for(let i=0;i<e.capacity;++i)r.get(i)&Yi.ACTIVE&&this._octreeCached.addInstance(i)}return this._octreeCached}_invalidateOctree(){this._octreeCached=Re(this._octreeCached)}_queryDepthRangeOctree(e){if(this._octree==null)return{near:1/0,far:-1/0};const r=e.viewForward,i=this._octree.findClosest(r,mf.DepthOrder.FRONT_TO_BACK,e.frustum),s=this._octree.findClosest(r,mf.DepthOrder.BACK_TO_FRONT,e.frustum);if(i==null||s==null)return{near:1/0,far:-1/0};const n=e.eye,o=this._instanceData.view;o.boundingSphere.getVec(i,um),pe(um,um,n);const a=de(um,r)-um[3];o.boundingSphere.getVec(s,um),pe(um,um,n);const l=de(um,r)+um[3];return{near:Math.max(e.near,a),far:Math.min(e.far,l)}}_requestUpdateCycle(e=!1){this._updateCyclesWithStaticCamera=-1,this._cycleStartIndex=this._instanceIndex,e&&(this._needFullCycle=!0,this._context.requestRender())}_startUpdateCycle(){this._updateCyclesWithStaticCamera++,this._allRenderInstanceData.forEach(e=>e.forEach(r=>r.startUpdateCycle()))}get running(){return this._instanceData.size>0&&this._updateCyclesWithStaticCamera<1}runTask(e){const{_enableLevelSelection:r,_camera:i,_levelSelector:s}=this;this._allRenderInstanceData.forEach(h=>h.forEach(p=>p.beginUpdate()));const n=this._instanceData,o=n.view;let a=n.size;const l=n.capacity;let c=this._instanceIndex;for(let h=0;h<a&&!e.done;++h){c===this._cycleStartIndex&&this._startUpdateCycle();const p=o.state.get(c);let f=0;if(!(p&Yi.ALLOCATED)){c=c+1===l?0:c+1,a++;continue}const m=o.lodLevel.get(c);if(p&Yi.DEFAULT_ACTIVE&&this._defaultRenderInstanceData[0][m].freeTail(),p&Yi.HIGHLIGHT_ACTIVE&&this._highlightRenderInstanceData[0][m].freeTail(),p&Yi.REMOVE)n.freeInstance(c);else if(p&Yi.VISIBLE){let g=0;r&&(o.modelOrigin.getVec(c,Lfe),g=s.selectLevel(Lfe,n.getCombinedMedianScaleFactor(c),i)),f=p&~(Yi.ACTIVE|Yi.TRANSFORM_CHANGED),g>=0&&(p&Yi.HIGHLIGHT?($fe(this._highlightRenderInstanceData[0][g],o,c),f|=Yi.HIGHLIGHT_ACTIVE):($fe(this._defaultRenderInstanceData[0][g],o,c),f|=Yi.DEFAULT_ACTIVE)),o.state.set(c,f),o.lodLevel.set(c,g)}else f=p&~(Yi.ACTIVE|Yi.TRANSFORM_CHANGED),o.state.set(c,f);if(this._octreeCached!=null){const g=!!(p&Yi.ACTIVE),_=!!(f&Yi.ACTIVE);!g&&_?this._octreeCached.addInstance(c):g&&!_?this._octreeCached.removeInstance(c):g&&_&&p&Yi.TRANSFORM_CHANGED&&(this._octreeCached.removeInstance(c),this._octreeCached.addInstance(c))}c=c+1===l?0:c+1,e.madeProgress()}this._instanceIndex=c,this._allRenderInstanceData.forEach(h=>h.forEach(p=>p.endUpdate())),this._context.requestRender()}_beginComponent(e,r,i){const{bindParameters:s,rctx:n,output:o}=e;if(r.size===0||!i.material.requiresSlot(s.slot,e.output))return null;const a=i.glMaterials.load(n,s.slot,o);return a!=null?a.beginSlot(s):null}_renderComponent(e,r,i,s,n){if(!r)return;const{bindParameters:o,rctx:a}=e;a.appleAmdDriverHelper?.resetIndicesType();const l=a.bindTechnique(r,s.material.parameters,o);a.bindVAO(s.vao),r.ensureAttributeLocations(s.vao),l.bindDraw(l2t,o,s.material.parameters),bi.LOD_INSTANCE_RENDERER_COLORIZE_BY_LEVEL&&e.output===k.Color&&(l.setUniform4fv("externalColor",kfe[Math.min(n,kfe.length-1)]),l.setUniform1i("colorMixMode",JIe.replace));const c=a.capabilities.instancing,h=i.capacity,p=i.headIndex,f=i.tailIndex,m=i.firstIndex,g=this._glInstanceBufferLayout,_=(v,b)=>{Fte(a,Er,i.buffer,g,v),c.drawArraysInstanced(r.primitiveType,0,s.vertexCount,b-v),kte(a,Er,i.buffer,g)};s.material.parameters.transparent&&m!=null?p>f?(it(m>=f&&m<=p,"invalid firstIndex"),_(m,p),_(f,m)):p<f&&(m<=p?(it(m>=0&&m<=p,"invalid firstIndex"),_(m,p),_(f,h),_(0,m)):(it(m>=f&&m<=h,"invalid firstIndex"),_(m,h),_(0,p),_(f,m))):p>f?_(f,p):p<f&&(_(0,p),_(f,h)),a.bindVAO(null)}};function $fe(t,e,r){const i=t.allocateHead();o2t(e,r,t.view,i)}function o2t(t,e,r,i){Ydt(t.modelOrigin,e,r.modelOriginHi,r.modelOriginLo,i),r.model.copyFrom(i,t.model,e),r.modelNormal.copyFrom(i,t.modelNormal,e),t.color&&r.color&&r.color.copyFrom(i,t.color,e),t.objectAndLayerIdColor&&r.objectAndLayerIdColor&&r.objectAndLayerIdColor.copyFrom(i,t.objectAndLayerIdColor,e),t.featureAttribute&&r.featureAttribute&&r.featureAttribute.copyFrom(i,t.featureAttribute,e)}function a2t(t){let e=us().vec3f(E.MODELORIGINHI).vec3f(E.MODELORIGINLO).mat3f(E.MODEL).mat3f(E.MODELNORMAL);return t!=null&&t.includes("featureAttribute")&&(e=e.vec4f(E.INSTANCEFEATUREATTRIBUTE)),t!=null&&t.includes("color")&&(e=e.vec4u8(E.INSTANCECOLOR)),t!=null&&t.includes("objectAndLayerIdColor")&&(e=e.vec4u8(E.INSTANCEOBJECTANDLAYERIDCOLOR)),e}u([d({constructOnly:!0})],nd.prototype,"symbol",void 0),u([d({constructOnly:!0})],nd.prototype,"optionalFields",void 0),u([d({constructOnly:!0})],nd.prototype,"metadata",void 0),u([d({constructOnly:!0})],nd.prototype,"shaderTransformation",void 0),u([d()],nd.prototype,"_instanceData",void 0),u([d()],nd.prototype,"_cycleStartIndex",void 0),u([d({readOnly:!0})],nd.prototype,"_enableLevelSelection",null),u([d()],nd.prototype,"_updateCyclesWithStaticCamera",void 0),u([d({readOnly:!0})],nd.prototype,"running",null),nd=u([R("esri.views.3d.webgl-engine.lib.lodRendering.LodRenderer")],nd);const Lfe=C(),um=Qt(),Dfe=xe(),Nfe=C(),Ffe=C(),kfe=[Vt(1,0,1,1),Vt(0,0,1,1),Vt(0,1,0,1),Vt(1,1,0,1),Vt(1,0,0,1)],l2t=new lxt;let Ufe=class{constructor(e,r,i,s,n,o,a,l,c,h,p,f){this.lodResources=e,this.lodRenderer=r,this.stageResources=i,this.originalMaterialParameters=s,this.resourceSize=n,this.isEsriSymbolResource=o,this.isWosr=a,this.resourceBoundingBox=l,this.symbolSize=c,this.extentPadding=h,this.physicalBasedRenderingEnabled=p,this.pivotOffset=f}},c2t=class extends Vg{getCachedSize(){const[e,r,i]=this._resources!=null?this._resources.symbolSize:[1,1,1];return{width:e,depth:r,height:i}}constructor(e,r,i,s){super(e,r,i,s),this._resources=null,this._optionalFields=new Array,this._instanceIndexToGraphicUid=new Map,this._hasLoadedPBRTextures=!1,this._disposeResourceHandles=new Array,this.skipHighSymbolLodsChanged=!1,this.ensureDrapedStatus(!1),this._hasLoadedPBRTextures=i.physicalBasedRenderingEnabled}async doLoad(e){if(!this._drivenProperties.size&&D8(this.symbolLayer))throw new Error;if(this._isPrimitive){const r=this.symbolLayer.resource,i=r&&Jvt(r.primitive)?r.primitive:vK;this._resources=await this._createResourcesForPrimitive(i,e)}else{const r=await XSt(this.symbol.styleOrigin),i=r?.href??this.symbolLayer.resource.href;this._resources=await this._createResourcesForUrl(i,e)}this.layerOpacityChanged(),this.slicePlaneEnabledChanged(),this.physicalBasedRenderingChanged(),this.complexity=this.computeComplexity()}get extentPadding(){return this._resources!=null?this._resources.extentPadding:0}get _isPrimitive(){return!this.symbolLayer.resource?.href}get lodRenderer(){return this._resources?.lodRenderer}_setMaterialTransparencyParams(e,r=this.symbolLayer?.material?.color){const i=this._getCombinedOpacity(r),s=i<1||this.needsDrivenTransparentPass;return e.transparent=s,e.opacity=i,e.cullFace=s?Ii.None:Ii.Back,e}async _createResourcesForPrimitive(e,r){const i=this.symbolLayer,s=Gn(v7e(e)),n=Ml(mL(s)),o=Ml(L9(n,i)),a=Oe(o),l=!1,c=!1,h={usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0,mrrFactors:[...vie],ambient:i0,diffuse:i0,hasSlicePlane:this._context.slicePlaneEnabled,hasSliceHighlight:!1,castShadows:this.symbolLayer.castShadows,offsetTransparentBackfaces:!this.symbolLayer.isPrimitive},p=!!h.usePBR;this._setMaterialTransparencyParams(h);const f=this.symbol;if(f.type==="point-3d"&&f.verticalOffset){const{screenLength:x,minWorldLength:T,maxWorldLength:S}=f.verticalOffset;h.verticalOffset={screenLength:vi(x),minWorldLength:T||0,maxWorldLength:S??1/0},h.castShadows=!1}if(this._context.screenSizePerspectiveEnabled&&(h.screenSizePerspective=this._context.sharedResources.screenSizePerspectiveSettings),this._drivenProperties.color)h.externalColor=Od;else{const x=i.material!=null?i.material.color:null,T=x!=null?Le.toUnitRGBA(x):Od;h.externalColor=T}this._fastUpdates=kA(this._context.renderer,this._fastVisualVariableConvertOptions(s,o,n,null)),h.isInstanced=!0,this._fastUpdates?(Object.assign(h,this._fastUpdates.materialParameters),this._optionalFields.push(E.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(h.hasInstancedColor=!0,this._optionalFields.push(E.COLOR)),le("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(E.OBJECTANDLAYERIDCOLOR);const m=new Rg(h),g=e$e(e,m);if(!g)throw new Error(`Unknown object symbol primitive: ${e}`);const _=cN(g).map(x=>({opacity:1,transparent:x.parameters.transparent})),v=await this._createStageResources(g,p,r),b=await this._createLodRenderer(g,r);return new Ufe(g,b,v,_,n,l,c,s,o,a,p,null)}async _createResourcesForUrl(e,r){const i={materialParamsMixin:{isInstanced:!0,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows},streamDataRequester:this._context.streamDataRequester,cache:this._context.sharedResources.objectResourceCache};this._fastUpdates=kA(this._context.renderer,this._fastVisualVariableConvertOptions(null,null,null,null)),this._fastUpdates?(Object.assign(i.materialParamsMixin,this._fastUpdates.materialParameters),this._optionalFields.push(E.FEATUREATTRIBUTE)):this._hasPerInstanceColor()&&(i.materialParamsMixin.hasInstancedColor=!0,this._optionalFields.push(E.COLOR)),le("enable-feature:objectAndLayerId-rendering")&&this._optionalFields.push(E.OBJECTANDLAYERIDCOLOR);const s=this.symbol;if(s.type==="point-3d"&&s.verticalOffset){const{screenLength:$,minWorldLength:N,maxWorldLength:U}=s.verticalOffset;i.materialParamsMixin.verticalOffset={screenLength:vi($),minWorldLength:N||0,maxWorldLength:U??1/0},i.materialParamsMixin.castShadows=!1}i.signal=r,i.usePBR=this._context.physicalBasedRenderingEnabled,i.skipHighLods=this._context.skipHighSymbolLods;const n=i.usePBR,o=await aDe(e,i),a=o.isEsriSymbolResource,l=o.isWosr,c=KTt(o.lods);c.levels.sort(($,N)=>$.minScreenSpaceRadius-N.minScreenSpaceRadius);const h=this._context,p=this.symbolLayer.material,f=this._getExternalColorParameters(p),m=this.symbolLayer?.material?.color,g=this._getCombinedOpacity(m,{hasIntrinsicColor:!0}),_=this.needsDrivenTransparentPass,v=cN(c),b=cN(c).map($=>({opacity:$.parameters.opacity||1,transparent:$.parameters.transparent}));v.forEach($=>{const N=$.parameters;$.setParameters(f);const U=N.opacity*g,X=U<1||_||N.transparent;$.setParameters({opacity:U,transparent:X}),h.screenSizePerspectiveEnabled&&$.setParameters({screenSizePerspective:h.sharedResources.screenSizePerspectiveSettings})});const x=o.referenceBoundingBox,T=Ml(mL(x)),S=Ml(c.levels[0].pivotOffset),O=Ml(L9(T,this.symbolLayer)),A=Oe(O),M=this._fastUpdates;UA(M,this._context.renderer,this._fastVisualVariableConvertOptions(x,O,T,S))&&v.forEach($=>$.setParameters(M.materialParameters));const P=await this._createStageResources(c,n,r),F=await this._createLodRenderer(c,r);return new Ufe(c,F,P,b,T,a,l,x,O,A,n,S)}_addDisposeResource(e){this._disposeResourceHandles.push(e)}async _createStageResources(e,r,i){const s=this._context.stage,n=cN(e);r!==this._context.physicalBasedRenderingEnabled&&this.physicalBasedRenderingChanged(),s.addMany(n),this._addDisposeResource(()=>s.removeMany(n));const o=tpe(e);s.addMany(o),this._addDisposeResource(()=>s.removeMany(o)),await s.load(o,i),Dt(i);const a=rpe(e);return s.addMany(a),this._addDisposeResource(()=>s.removeMany(a)),{materials:n,textures:o,geometries:a}}async _createLodRenderer(e,r){const i=this._context.stage,s={layerUid:this._context.layer.uid,graphicUid:l=>this._instanceIndexToGraphicUid.get(l),notifyGraphicGeometryChanged:l=>this._context.notifyGraphicGeometryChanged(this._instanceIndexToGraphicUid.get(l)),notifyGraphicVisibilityChanged:l=>this._context.notifyGraphicVisibilityChanged(this._instanceIndexToGraphicUid.get(l))},n=this._fastUpdates,o=n?{applyTransform:(l,c,h)=>{l.getFeatureAttribute(c,PN),an(h,CY(n.materialParameters,PN,h))},scaleFactor:(l,c,h)=>{c.getFeatureAttribute(h,PN),z_t(l,n.materialParameters,PN)}}:null,a=new nd({symbol:e,optionalFields:this._optionalFields,metadata:s,shaderTransformation:o},this._context.scheduler);return a.slicePlaneEnabled=this._context.slicePlaneEnabled,this._addDisposeResource(()=>{i.removeRenderPlugin(a),a.destroy()}),await i.addRenderPlugin(a.slots,a,r),a}_getExternalColorParameters(e){const r={};return this._drivenProperties.color?r.externalColor=Od:e!=null&&e.color!=null?r.externalColor=Le.toUnitRGBA(e.color):(r.externalColor=Od,r.colorMixMode="ignore"),r}destroy(){super.destroy(),this._cleanupResources()}_cleanupResources(){this._disposeResourceHandles.forEach(e=>e()),this._disposeResourceHandles.length=0,this._resources=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry))return null;const i=EP(r.geometry);if(i==null)return this.logger.warn(`unsupported geometry type for icon symbol: ${r.geometry.type}`),null;const s=this.setGraphicElevationContext(r,new Gf),n=e.renderingInfo;return this._createAs3DShape(r,i,n,s,r.uid,e.layer.uid)}notifyDestroyGraphicLayer(e){this._instanceIndexToGraphicUid.delete(e.instanceIndex)}graphicLayerToGraphicId(){return 0}layerOpacityChanged(){if(this._resources==null)return;const e=this._drivenProperties.opacity,r=!this._isPrimitive,i=this._resources.stageResources.materials,s=this._resources.originalMaterialParameters;for(let n=0;n<i.length;n++){const o=i[n],a=this.symbolLayer?.material?.color,l=s[n],c=this._getCombinedOpacity(a,{hasIntrinsicColor:r})*l.opacity,h=c<1||e||l.transparent;o.setParameters({opacity:c,transparent:h}),this._isPrimitive&&o.setParameters({cullFace:h?Ii.None:Ii.Back})}}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,ib)}slicePlaneEnabledChanged(){if(this._resources==null)return!0;this._resources.lodRenderer.slicePlaneEnabled=this._context.slicePlaneEnabled;for(const e of this._resources.stageResources.materials)e.setParameters({hasSlicePlane:this._context.slicePlaneEnabled});return!0}physicalBasedRenderingChanged(){if(this._resources==null)return!0;const{stageResources:e,isWosr:r}=this._resources;for(const i of e.materials)this._isPrimitive?i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}):r||i.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!1});return this._hasLoadedPBRTextures!==!1||this._context.physicalBasedRenderingEnabled!==!0||(this._hasLoadedPBRTextures=!0,!1)}applyRendererDiff(e,r){if(this._resources==null)return on.RecreateSymbol;const{stageResources:{materials:i},lodRenderer:s,resourceBoundingBox:n,symbolSize:o,resourceSize:a,pivotOffset:l}=this._resources;for(const c in e.diff){if(c!=="visualVariables"||!UA(this._fastUpdates,r,this._fastVisualVariableConvertOptions(n,o,a,l)))return on.RecreateSymbol;for(const h of i)h.setParameters(this._fastUpdates.materialParameters);s.notifyShaderTransformationChanged()}return on.FastUpdate}computeComplexity(){if(this._resources==null)return super.computeComplexity();const e=this._resources.lodResources,r=KPe(e.levels[0]).reduce((n,o)=>n+o.indices.get(E.POSITION).length,0)/3,i=n=>Array.from(n.vertexAttributes.values()).reduce((o,a)=>o+i1(a.data),0)+Array.from(n.indices.values()).reduce((o,a)=>o+i1(a),0),s=tpe(e).reduce((n,o)=>n+(o.parameters.encoding&&o.parameters.encoding==="image/ktx2"?o.memoryEstimate:o.memoryEstimate/4),0)+rpe(e).reduce((n,o)=>n+i(o),0);return{primitivesPerFeature:r,primitivesPerCoordinate:0,drawCallsPerFeature:0,estimated:!1,memory:{...r$e(this.symbol,this.symbolLayer),resourceBytes:s}}}_hasLodRenderer(){return this._resources!=null}_createAs3DShape(e,r,i,s,n,o){if(!this._hasLodRenderer()||this._resources==null)return null;const a=this.getFastUpdateAttrValues(e),l=this._context.clippingExtent;if(aa(r,v2,this._context.elevationProvider.spatialReference),l!=null&&!fK(l,v2))return null;const c=this._requiresTerrainElevation(s),h=this._computeGlobalTransform(r,s,LG,$N),p=this._computeLocalTransform(this._resources,this.symbolLayer,i,Vfe),f=this._resources.lodRenderer.instanceData,m=f.addInstance();this._instanceIndexToGraphicUid.set(m,n),f.setLocalTransform(m,p,!1),f.setGlobalTransform(m,h),a&&f.setFeatureAttribute(m,a),this._fastUpdates==null&&this._hasPerInstanceColor()&&f.setColor(m,mI(i.color,i.opacity,255)),this._context.stage.renderView.objectAndLayerIdRenderHelper!=null&&f.setObjectAndLayerIdColor(m,this._context.stage.renderView.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor({graphicUid:n,layerUid:o}));const g=new YTt(this,m,zvt,s);return c&&(g.alignedSampledElevation=$N.sampledElevation),g.needsElevationUpdates=ib(s.mode),SP(g,r,this._context.elevationProvider),g}_computeGlobalTransform(e,r,i,s){return rb(e,this._context.elevationProvider,r,this._context.renderCoordsHelper,s),v2[0]=e.x,v2[1]=e.y,v2[2]=s.z,wc(e.spatialReference,v2,i,this._context.renderCoordsHelper.spatialReference),i}_computeLocalTransform(e,r,i,s){return jd(s),this._applyObjectRotation(i,!1,s),this._applyObjectRotation(r,!0,s),this._applyObjectScale(e,i,s),this._applyAnchor(e,r,s),s}_applyObjectScale(e,r,i){if(this._fastUpdates?.requiresShaderTransformation)return;const s=this._drivenProperties.size&&r.size?r.size:e.symbolSize,n=Kde(s,e.symbolSize,e.resourceSize,this._context.renderCoordsHelper.unitInMeters);n[0]===1&&n[1]===1&&n[2]===1||vV(i,i,n)}prepareSymbolLayerPatch(e){if(e.diff.type!=="partial")return;const r=e.diff.diff;this._preparePatchTransform(e,r),this._preparePatchColor(e,r)}updateGeometry(e,r){if(this._resources==null)return!0;const i=r&&EP(r);if(i==null)return!1;const s=this.getGeometryElevationMode(r);return e.elevationContext.mode===s&&(this._computeGlobalTransform(i,e.elevationContext,LG,$N),this._requiresTerrainElevation(e.elevationContext)&&(e.alignedSampledElevation=$N.sampledElevation),this._resources.lodRenderer.instanceData.setGlobalTransform(e.instanceIndex,LG,!0),SP(e,i,this._context.elevationProvider),!0)}_preparePatchTransform(e,r){if(!(r.heading||r.tilt||r.roll||r.width||r.height||r.depth||r.anchor||r.anchorPosition)||this._resources==null)return;const i=(g,_,v)=>(g!=null&&g.type==="complete"?g.newValue:_)??v,s=i(r.heading,this.symbolLayer.heading,0),n=i(r.tilt,this.symbolLayer.tilt,0),o=i(r.roll,this.symbolLayer.roll,0),a=i(r.width,this.symbolLayer.width,void 0),l=i(r.height,this.symbolLayer.height,void 0),c=i(r.depth,this.symbolLayer.depth,void 0),h=i(r.anchor,this.symbolLayer.anchor,void 0),p=i(r.anchorPosition,this.symbolLayer.anchorPosition,void 0);delete r.heading,delete r.tilt,delete r.roll,delete r.width,delete r.height,delete r.depth,delete r.anchor,delete r.anchorPosition;const f={heading:s,tilt:n,roll:o,anchor:h,anchorPosition:p},m=this._resources;this.loadStatus===oh.LOADED&&e.symbolLayerStatePatches.push(()=>{m.symbolSize=Ml(L9(m.resourceSize,{width:a,height:l,depth:c,isPrimitive:this.symbolLayer.isPrimitive}))}),e.graphics3DGraphicPatches.push((g,_)=>{const v=this._computeLocalTransform(m,f,_,Vfe),b=g.instanceIndex;m.lodRenderer.instanceData.setLocalTransform(b,v,!0)})}_preparePatchColor(e,r){if(!r.material||r.material.type!=="partial")return;const i=r.material.diff;if(!i.color||i.color.type!=="complete"||i.color.newValue==null||i.color.oldValue==null)return;const s=i.color.newValue,n=s!=null?Le.toUnitRGBA(s):Od;delete i.color;const o=this._resources;o!=null&&e.graphics3DGraphicPatches.push(a=>{let l;this._hasPerInstanceColor()?(o.lodRenderer.instanceData.setColor(a.instanceIndex,n),l=this._setMaterialTransparencyParams({},s)):l=this._setMaterialTransparencyParams({externalColor:n},s);for(const c of o.stageResources.materials)c.setParameters(l)})}_requiresTerrainElevation(e){return e.mode!=="absolute-height"}_applyObjectRotation(e,r,i){if(!this._fastUpdates?.requiresShaderTransformation||!r)return Mvt(e.heading,e.tilt,e.roll,i)}_computeAnchor(e,r,i){const s=C();switch(i.anchor){case"center":oe(s,lf(e)),el(s,s);break;case"top":{const n=lf(e);ie(s,-n[0],-n[1],-e[5]);break}case"bottom":{const n=lf(e);ie(s,-n[0],-n[1],-e[2]);break}case"relative":{const n=lf(e),o=mL(e),a=i.anchorPosition,l=a?Ee(a.x,a.y,a.z):Nl;N6(s,o,l),ue(s,s,n),el(s,s);break}default:r!=null?el(s,r):oe(s,Nl)}return s}_applyAnchor(e,r,i){if(this._fastUpdates?.requiresShaderTransformation)return;const s=this._computeAnchor(e.resourceBoundingBox,e.pivotOffset,r);s&&Cc(i,i,s)}_hasPerInstanceColor(){return this._drivenProperties.color||this._drivenProperties.opacity}_fastVisualVariableConvertOptions(e,r,i,s){const n=e!=null?Ml(mL(e)):i0,o=e!=null?this._computeAnchor(e,s,this.symbolLayer):Nl,a=this._context.renderCoordsHelper.unitInMeters,l=Kde(r??void 0,r,i,a),c=Ee(this.symbolLayer.tilt||0,this.symbolLayer.roll||0,this.symbolLayer.heading||0);return new L$({size:!0,color:!0,rotation:!0,opacity:!1},n,r??i0,a,o,l,c)}};const v2=C(),Vfe=xe(),LG=xe(),PN=Qt(),$N=new F$;let u2t=class{constructor(e,r,i,s){this.vertices=e,this.positionsES=r,this.offset=s;const n=e.length,o=Math.floor(n/2),a=this.offset+3*o,l=i[a],c=i[a+1],h=i[a+2];this.origin=Ee(l,c,h),this.positions=vs(3*n);const p=this.offset+3*n;for(let f=this.offset;f<p;f+=3)this.positions[f]=i[f]-l,this.positions[f+1]=i[f+1]-c,this.positions[f+2]=i[f+2]-h;this.updatePathVertexInformation()}updatePathVertexInformation(){const e=this.vertices.length,r=this.vertices[0];let i=this.offset;const s=this.positions;r.vRight[0]=s[i+3]-s[i],r.vRight[1]=s[i+4]-s[i+1],r.vRight[2]=s[i+5]-s[i+2],i+=3;let n=Oe(r.vRight);r.vMinSiblingLength=n,_e(r.vRight,r.vRight);let o=r;for(let a=1;a<e;++a){const l=this.vertices[a];if(l.vLeft=o.vRight,a<e-1){l.vRight[0]=s[i+3]-s[i],l.vRight[1]=s[i+4]-s[i+1],l.vRight[2]=s[i+5]-s[i+2];const c=Oe(l.vRight);l.vMinSiblingLength=Math.min(n,c),n=c,_e(l.vRight,l.vRight)}else oe(l.vRight,l.vLeft),l.vMinSiblingLength=n;o=l,i+=3}}},h2t=class{constructor(e,r,i,s,n,o={}){this.path=e,this.profile=r,this.extruder=i,this.startCap=s,this.endCap=n,this.options=o,this._extrusionVertexCount=0;const a=this.path.vertices.length-2;this.numExtrusionProfiles=i.numProfilesPerJoin()*a+2,this.numVerticesTotal=r.vertices.length*this.numExtrusionProfiles,this.startCap.vertexBufferStart=this.numVerticesTotal;const l=this.startCap.numVertices;this.numVerticesTotal+=l,this.endCap.vertexBufferStart=this.numVerticesTotal;const c=this.endCap.numVertices;this.numVerticesTotal+=c,this.pathVertexData=zdt(1*this.numVerticesTotal),this.profileRightAxes=vs(4*this.numVerticesTotal),this.profileUpAxes=vs(4*this.numVerticesTotal),this.profileVertexAndNormals=vs(4*this.numVerticesTotal),this.positions=bU(e.positions,e.offset,3*e.vertices.length),this._rebuildGeometry(),this.buildTopology()}emitVertex(e,r,i,s,n){const o=4*this._extrusionVertexCount;if(this.profileRightAxes[o]=r.right[0],this.profileRightAxes[o+1]=r.right[1],this.profileRightAxes[o+2]=r.right[2],this.profileUpAxes[o]=r.up[0],this.profileUpAxes[o+1]=r.up[1],this.profileUpAxes[o+2]=r.up[2],this.profileVertexAndNormals[o]=i[0],this.profileVertexAndNormals[o+1]=i[1],this.profileVertexAndNormals[o+2]=s[0],this.profileVertexAndNormals[o+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,n){const a=this.path.vertices[e],l=a.maxStretchDistance;this.profileRightAxes[o+3]=a.rotationRight[0]*l,this.profileUpAxes[o+3]=a.rotationRight[1]*l}else this.profileRightAxes[o+3]=0,this.profileUpAxes[o+3]=0;++this._extrusionVertexCount}emitCapVertex(e,r,i,s,n,o){const a=4*this._extrusionVertexCount;this.profileRightAxes[a]=r.right[0],this.profileRightAxes[a+1]=r.right[1],this.profileRightAxes[a+2]=r.right[2],this.profileRightAxes[a+3]=n,this.profileUpAxes[a]=r.up[0],this.profileUpAxes[a+1]=r.up[1],this.profileUpAxes[a+2]=r.up[2],this.profileUpAxes[a+3]=o,this.profileVertexAndNormals[a]=i[0],this.profileVertexAndNormals[a+1]=i[1],this.profileVertexAndNormals[a+2]=s[0],this.profileVertexAndNormals[a+3]=s[1],this.pathVertexData[this._extrusionVertexCount]=e,++this._extrusionVertexCount}_rebuildGeometry(){this._extrusionVertexCount=0;const{positions:e,offset:r,vertices:i}=this.path;this.positions=bU(e,r,3*i.length);let s=0;const n=(a,l,c,h,p)=>this.emitCapVertex(s,a,l,c,h,p),o=(a,l,c,h)=>this.emitVertex(s,a,l,c,h);for(this.startCap.rebuildConnectingProfileGeometry(i[s],this.profile,n),s=1;s<i.length-1;++s)this.extruder.extrude(i[s],this.profile,o);this.endCap.rebuildConnectingProfileGeometry(i[s],this.profile,n),s=0,this.startCap.rebuildCapGeometry(i[s],n),s=i.length-1,this.endCap.rebuildCapGeometry(i[s],n)}buildTopology(){const e=this.profile.vertices.length,r=this.profile.numSegments,i=this.numExtrusionProfiles-1;let s=3*(2*(r*i));this.startCap.indexBufferStart=s,this.startCap.firstProfileVertexIndex=0,s+=this.startCap.numIndices,this.endCap.indexBufferStart=s,this.endCap.firstProfileVertexIndex=e*(this.numExtrusionProfiles-1);const n=new Array,o=new Array,a=new Array,l=(c,h,p)=>{n.push(c),n.push(h),n.push(p),o.push(c),o.push(h),o.push(p),a.push(this.pathVertexData[c]),a.push(this.pathVertexData[h]),a.push(this.pathVertexData[p])};for(let c=0;c<r;++c){const h=this.profile.indices[2*c],p=this.profile.indices[2*c+1];for(let f=0;f<i;++f){const m=f*e+h,g=(f+1)*e+p,_=f*e+p;l(m,(f+1)*e+h,g),l(m,g,_)}}this.startCap.buildTopology(this.path.vertices[0],l),this.endCap.buildTopology(this.path.vertices[this.path.vertices.length-1],l),this.vertexIndices=cg(n),this.normalIndices=cg(o),this.pathVertexIndices=cg(a)}onPathChanged(){this._rebuildGeometry()}},Cie=class{rebuildConnectingProfileGeometry(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.frame,r.vertices[s],r.normals[s],0,0)}},zfe=class extends Cie{constructor(){super(),this.numVertices=0,this.numIndices=0}rebuildCapGeometry(){}buildTopology(){}},LN=class extends Cie{constructor(e,r=0,i=!1){super(),this.profile=e,this.profilePlaneOffset=r,this.flip=i}get numVertices(){return this.profile.vertices.length}get numIndices(){return 3*this.profile.numSegments}rebuildConnectingProfileGeometry(e,r,i){const s=this.profilePlaneOffset;for(let n=0;n<r.vertices.length;++n)i(e.frame,r.vertices[n],r.normals[n],s,0)}rebuildCapGeometry(e,r){const i=this.profile,s=this.flip?1:-1,n=this.profilePlaneOffset,o=hDe;hr(o,0,0);for(let a=0;a<i.vertices.length;++a)r(e.frame,i.vertices[a],o,n,s)}buildTopology(e,r){const i=this.profile,s=this.vertexBufferStart+i.indices[0];for(let n=1;n<i.numSegments;++n){const o=i.indices[2*n],a=i.indices[2*n+1],l=this.vertexBufferStart+o,c=this.vertexBufferStart+a;this.flip?r(c,l,s):r(s,l,c)}}},Bfe=class extends Cie{constructor(e){super(),this.flip=!1,this.sign=0,this.breakNormals=!1,this.numSegments=3,this.profile=e.profile,this.flip=e.flip,this.sign=this.flip?1:-1,this.breakNormals=e.breakNormals,this.numSegments=e.subdivisions}get numVertices(){let e=this.profile.vertices.length*(this.numSegments-1)+this.profile.poles.length;return this.breakNormals&&(e+=this.profile.vertices.length),e}get numIndices(){let e=0;const r=this.profile;e+=2*r.numSegments*(this.numSegments-1);for(let i=0;i<r.numSegments;++i){const s=r.indices[2*i],n=r.indices[2*i+1];r.poleIndices[s]===r.poleIndices[n]?e+=1:e+=2}return 3*e}rebuildCapGeometry(e,r){const i=this.profile,s=e.frame,n=.5*this.sign,o=d2t,a=hDe;hr(a,0,0);for(const l of i.poles)l.normal?r(s,l.position,l.normal,n,0):r(s,l.position,a,n,this.sign);if(this.breakNormals)for(let l=0;l<i.vertices.length;++l)r(s,i.vertices[l],i.normals[l],0,0);for(let l=0;l<this.numSegments-1;++l){const c=(1-(l+1)/this.numSegments)*Math.PI*.5,h=Math.sin(c),p=Math.cos(c);for(let f=0;f<i.vertices.length;++f){const m=i.poles[i.poleIndices[f]];zs(o,i.vertices[f],m.position),fc(o,o,h),m.normal?(_d(o,o,m.position),r(s,o,m.normal,n*p,0)):(yA(a,o),fc(a,a,h),_d(o,o,m.position),r(s,o,a,n*p,this.sign*p))}}}buildTopology(e,r){const i=this.profile,s=this.breakNormals?this.vertexBufferStart+i.poles.length:this.firstProfileVertexIndex,n=this.breakNormals?this.vertexBufferStart+i.poles.length+i.vertices.length:this.vertexBufferStart+i.poles.length;for(let o=0;o<i.numSegments;++o){const a=i.indices[2*o],l=i.indices[2*o+1],c=this.vertexBufferStart+i.poleIndices[a],h=this.vertexBufferStart+i.poleIndices[l];let p=s+a,f=s+l;for(let m=0;m<this.numSegments-1;++m){const g=n+m*i.vertices.length+a,_=n+m*i.vertices.length+l;this.flip?(r(g,f,p),r(f,g,_)):(r(p,f,g),r(_,g,f)),p=g,f=_}this.flip?(r(c,f,p),c!==h&&r(c,h,f)):(r(p,f,c),c!==h&&r(f,h,c))}}};const d2t=Pe(),hDe=Pe();let p2t=class{numProfilesPerJoin(){return 1}extrude(e,r,i){for(let s=0;s<r.vertices.length;++s)i(e.frame,r.vertices[s],r.normals[s],!1)}},DG=class{constructor(e,r){this.cutoffAngle=e,this.numBendSubdivisions=r}numProfilesPerJoin(){return this.numBendSubdivisions+1}extrude(e,r,i){const s=m2t,{rotationAngle:n,rotationRight:o,frame:a}=e;if(Math.abs(n)>=this.cutoffAngle){const l=e.rotationFrameUp;for(let c=0;c<this.numBendSubdivisions+1;++c){Th(jfe,.5*-n+c*n/this.numBendSubdivisions,l),f2t(s,a,jfe);for(let h=0;h<r.vertices.length;++h)ms(r.vertices[h],o)*n>=0?i(s,r.vertices[h],r.normals[h],!1):i(a,e.applyMiterStretch(Gfe,r.vertices[h]),r.normals[h],!0)}}else for(let l=0;l<this.numBendSubdivisions+1;++l)for(let c=0;c<r.vertices.length;++c){const h=ms(r.vertices[c],o)*n>=0;i(a,e.applyMiterStretch(Gfe,r.vertices[c]),r.normals[c],!h)}}},dDe=class{constructor(){this.up=C(),this.right=C()}};function f2t(t,e,r){Ne(t.up,e.up,r),Ne(t.right,e.right,r)}const Gfe=Pe(),jfe=xe(),m2t=new dDe;let g2t=class extends mn{constructor(e,r,i,s,n,o,a){super(e,r,i,null,Ms.Mesh,a),this.path=s,this.geometrySR=n,this.stencilWidth=o}};var ug;function pDe(t){return"path"in t}(function(t){t[t.World=0]="World",t[t.Path=1]="Path"})(ug||(ug={}));let fDe=class{constructor(e){this.builder=e}onPathChanged(e){this.builder.onPathChanged()}},mDe=class extends fDe{constructor(e){super(e),this.vertexAttributeColor=Vt(255,255,255,255),this.size=new Array,this.vertexAttributePosition=vs(3*this.builder.numVerticesTotal),this.vertexAttributeNormal=new Int16Array(2*this.builder.numVerticesTotal)}bakeVertexColors(e){this.vertexAttributeColor[0]=255*e[0],this.vertexAttributeColor[1]=255*e[1],this.vertexAttributeColor[2]=255*e[2],this.vertexAttributeColor[3]=255*(e.length>3?e[3]:1)}bake(e){this.size=e;const{numVerticesTotal:r,pathVertexData:i,path:s,positions:n,profileRightAxes:o,profileUpAxes:a,profileVertexAndNormals:l}=this.builder;for(let c=0;c<r;++c){let h=i[c];const p=h===0||h===s.vertices.length-1;h*=3;const f=w2t;let m=0,g=0;const _=4*c,v=ie(x2t,o[_],o[_+1],o[_+2]),b=ie(T2t,a[_],a[_+1],a[_+2]),x=hr(Hfe,l[_]*e[0],l[_+1]*e[1]);if(p)st(f,b,v),m=o[_+3]*e[0],g=a[_+3];else{const A=_2t,M=v2t;hr(A,o[_+3],a[_+3]);const P=b$(A);yA(A,A);const F=ms(x,A);if(Math.abs(F)>P){hr(M,-A[1],A[0]);const $=ms(x,M);fc(A,A,P*Math.sign(F)),fc(M,M,$),_d(x,A,M)}ie(f,0,0,0)}const T=ie(b2t,v[0]*x[0]+b[0]*x[1],v[1]*x[0]+b[1]*x[1],v[2]*x[0]+b[2]*x[1]),S=3*c;this.vertexAttributePosition[S]=n[h]+T[0]+f[0]*m,this.vertexAttributePosition[S+1]=n[h+1]+T[1]+f[1]*m,this.vertexAttributePosition[S+2]=n[h+2]+T[2]+f[2]*m;const O=hr(Hfe,l[_+2],l[_+3]);YT(this.vertexAttributeNormal,c,v[0]*O[0]+b[0]*O[1]+f[0]*g,v[1]*O[0]+b[1]*O[1]+f[1]*g,v[2]*O[0]+b[2]*O[1]+f[2]*g)}}createGeometryData(){const e=this.builder.vertexIndices.length;return new gDe([[E.POSITION,new Ge(this.vertexAttributePosition,3,!0)],[E.NORMALCOMPRESSED,new Ge(this.vertexAttributeNormal,2,!0)],[E.COLOR,new Ge(this.vertexAttributeColor,4)]],[[E.POSITION,this.builder.vertexIndices],[E.NORMALCOMPRESSED,this.builder.normalIndices],[E.COLOR,SO(e)]])}onPathChanged(e){super.onPathChanged(e),this.bake(this.size)}intersect(e,r,i){const s=this.builder.vertexIndices,n=new Ge(this.vertexAttributePosition,3),o=s.length/3;I$(e,r,0,o,s,n,void 0,void 0,i)}},y2t=class extends fDe{constructor(e,r,i,s){super(e),this.sizeAttributeValue=r,this.colorAttributeValue=i,this.opacityAttributeValue=s,this.vvData=null,this.baked=new mDe(e),this.vvData=vs(4*this.builder.path.vertices.length);for(let n=0;n<this.builder.path.vertices.length;++n){this.vvData[4*n]=r,this.vvData[4*n+1]=i,this.vvData[4*n+2]=s;const o=n===0||n===this.builder.path.vertices.length-1;this.vvData[4*n+3]=o?1:0}}createGeometryData(){return new gDe([[E.POSITION,new Ge(this.builder.positions,3,!0)],[E.PROFILERIGHT,new Ge(this.builder.profileRightAxes,4,!0)],[E.PROFILEUP,new Ge(this.builder.profileUpAxes,4,!0)],[E.PROFILEVERTEXANDNORMAL,new Ge(this.builder.profileVertexAndNormals,4,!0)],[E.FEATUREVALUE,new Ge(this.vvData,4,!0)]],[[E.POSITION,this.builder.pathVertexIndices],[E.PROFILERIGHT,this.builder.vertexIndices],[E.PROFILEUP,this.builder.vertexIndices],[E.PROFILEVERTEXANDNORMAL,this.builder.vertexIndices],[E.FEATUREVALUE,this.builder.pathVertexIndices]])}onPathChanged(e){super.onPathChanged(e);const r=e.getMutableAttribute(E.POSITION);r&&(r.data=this.builder.positions)}},gDe=class{constructor(e,r){this.vertexAttributes=e,this.indices=r}};const Hfe=Pe(),_2t=Pe(),v2t=Pe(),b2t=C(),w2t=C(),x2t=C(),T2t=C();function S2t(t,e){let r=null;const i=t.vertices.length,s=.99619469809,n=C(),o=C(),a=C(),l=C(),c=C(),h=C(),p=zr();let f=t.vertices[0];oe(o,e),ie(n,0,1,0),TU(f.vRight,o,n,n,a,o,s),oe(f.frame.up,o),oe(f.frame.right,a);const m=t.positions;let g=t.offset;r=f;for(let _=1;_<i;++_){f=t.vertices[_],ue(c,f.vLeft,f.vRight);let v=Oe(c);v>0?(v=1/Math.sqrt(v),c[0]=c[0]*v,c[1]=c[1]*v,c[2]=c[2]*v):(c[0]=f.vRight[0],c[1]=f.vRight[1],c[2]=f.vRight[2]),h[0]=m[g]+r.frame.up[0],h[1]=m[g+1]+r.frame.up[1],h[2]=m[g+2]+r.frame.up[2],g+=3;const b=ie(E2t,m[g],m[g+1],m[g+2]);x$(b,c,p),yS(p,Eh(h,f.vLeft),l)?(l[0]-=m[g],l[1]-=m[g+1],l[2]-=m[g+2],_e(o,l),st(a,c,o),_e(a,a)):TU(c,r.frame.up,r.frame.right,n,a,o,s),oe(f.frame.up,o),oe(f.frame.right,a),r=f}}const E2t=C();let yDe=class{constructor(){this.vertices=new Array,this.normals=new Array,this.indices=new Array,this.poles=new Array,this.poleIndices=new Array}addVertex(e,r){return this.vertices.push(QE(e)),this.normals.push(QE(r)),this.vertices.length-1}addPole(e,r=null){return this.poles.push({position:QE(e),normal:r?QE(r):null}),this.poles.length-1}addSegment(e,r=null){this.indices.push(e.v0),this.indices.push(e.v1),r&&(this.poleIndices.push(r.v0),this.poleIndices.push(r.v1))}get numSegments(){return this.indices.length/2}translate(e,r){for(const i of this.vertices)i[0]+=e,i[1]+=r;for(const i of this.poles)i.position[0]+=e,i.position[1]+=r}};const _De={top:[0,-.5],bottom:[0,.5]};function NG(t){const r=JPe,i=new yDe,s={v0:0,v1:0};i.addPole(yr(0,0));for(let o=0;o<r;++o){const a=2*o*Math.PI/r,l=Math.cos(a),c=Math.sin(a),h=yr(l*.5,c*.5),p=yr(l,c);i.addVertex(h,p)}for(let o=0;o<r-1;++o){const a={v0:o,v1:o+1};i.addSegment(a,s)}const n={v0:r-1,v1:0};if(i.addSegment(n,s),t!=="center"){const o=_De[t];i.translate(o[0],o[1])}return i}const C2t={center:NG("center"),top:NG("top"),bottom:NG("bottom")},A2t={center:FG("center"),top:FG("top"),bottom:FG("bottom")};function FG(t){const i=new yDe,s=yr(.5*-1,.5*-1),n=yr(.5*1,.5*-1),o=yr(.5*1,.5*1),a=yr(.5*-1,.5*1),l=yr(0,-1),c=yr(1,0),h=yr(0,1),p=yr(-1,0);if(i.addPole(yr(0,.5*1),h),i.addPole(yr(0,.5*1)),i.addPole(yr(0,.5*-1)),i.addPole(yr(0,.5*-1),l),i.addVertex(s,l),i.addVertex(n,l),i.addSegment({v0:0,v1:1},{v0:3,v1:3}),i.addVertex(n,c),i.addVertex(o,c),i.addSegment({v0:2,v1:3},{v0:2,v1:1}),i.addVertex(o,h),i.addVertex(a,h),i.addSegment({v0:4,v1:5},{v0:0,v1:0}),i.addVertex(a,p),i.addVertex(s,p),i.addSegment({v0:6,v1:7},{v0:1,v1:2}),t!=="center"){const f=_De[t];i.translate(f[0],f[1])}return i}function O2t(t,e){return t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t}function R2t(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=1,t}function vDe(t,e,r,i,s){return t[0]=e,t[1]=r,t[2]=i,t[3]=s,t}function M2t(t,e){if(t===e){const r=e[1];t[1]=e[2],t[2]=r}else t[0]=e[0],t[1]=e[2],t[2]=e[1],t[3]=e[3];return t}function I2t(t,e){const r=e[0],i=e[1],s=e[2],n=e[3];let o=r*n-s*i;return o?(o=1/o,t[0]=n*o,t[1]=-i*o,t[2]=-s*o,t[3]=r*o,t):null}function P2t(t,e){const r=e[0];return t[0]=e[3],t[1]=-e[1],t[2]=-e[2],t[3]=r,t}function $2t(t){return t[0]*t[3]-t[2]*t[1]}function bDe(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1],c=r[2],h=r[3];return t[0]=i*a+n*l,t[1]=s*a+o*l,t[2]=i*c+n*h,t[3]=s*c+o*h,t}function L2t(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=Math.sin(r),l=Math.cos(r);return t[0]=i*l+n*a,t[1]=s*l+o*a,t[2]=i*-a+n*l,t[3]=s*-a+o*l,t}function D2t(t,e,r){const i=e[0],s=e[1],n=e[2],o=e[3],a=r[0],l=r[1];return t[0]=i*a,t[1]=s*a,t[2]=n*l,t[3]=o*l,t}function N2t(t,e){const r=Math.sin(e),i=Math.cos(e);return t[0]=i,t[1]=r,t[2]=-r,t[3]=i,t}function F2t(t,e){return t[0]=e[0],t[1]=0,t[2]=0,t[3]=e[1],t}function k2t(t){return"mat2("+t[0]+", "+t[1]+", "+t[2]+", "+t[3]+")"}function U2t(t){return Math.sqrt(t[0]**2+t[1]**2+t[2]**2+t[3]**2)}function V2t(t,e,r,i){return t[2]=i[2]/i[0],r[0]=i[0],r[1]=i[1],r[3]=i[3]-t[2]*r[1],[t,e,r]}function z2t(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t[3]=e[3]+r[3],t}function wDe(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t[3]=e[3]-r[3],t}function B2t(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]&&t[3]===e[3]}function G2t(t,e){const r=t[0],i=t[1],s=t[2],n=t[3],o=e[0],a=e[1],l=e[2],c=e[3],h=sl();return Math.abs(r-o)<=h*Math.max(1,Math.abs(r),Math.abs(o))&&Math.abs(i-a)<=h*Math.max(1,Math.abs(i),Math.abs(a))&&Math.abs(s-l)<=h*Math.max(1,Math.abs(s),Math.abs(l))&&Math.abs(n-c)<=h*Math.max(1,Math.abs(n),Math.abs(c))}function j2t(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t[3]=e[3]*r,t}function H2t(t,e,r,i){return t[0]=e[0]+r[0]*i,t[1]=e[1]+r[1]*i,t[2]=e[2]+r[2]*i,t[3]=e[3]+r[3]*i,t}const q2t=bDe,W2t=wDe;Object.freeze(Object.defineProperty({__proto__:null,LDU:V2t,add:z2t,adjoint:P2t,copy:O2t,determinant:$2t,equals:G2t,exactEquals:B2t,frob:U2t,fromRotation:N2t,fromScaling:F2t,identity:R2t,invert:I2t,mul:q2t,multiply:bDe,multiplyScalar:j2t,multiplyScalarAndAdd:H2t,rotate:L2t,scale:D2t,set:vDe,str:k2t,sub:W2t,subtract:wDe,transpose:M2t},Symbol.toStringTag,{value:"Module"}));function xDe(){return[1,0,0,1]}function Z2t(t){return[t[0],t[1],t[2],t[3]]}function X2t(t,e,r,i){return[t,e,r,i]}function Y2t(t,e){return new Float64Array(t,e,4)}Object.freeze(Object.defineProperty({__proto__:null,clone:Z2t,create:xDe,createView:Y2t,fromValues:X2t},Symbol.toStringTag,{value:"Module"}));let TDe=class{constructor(){this.vLeft=C(),this.vRight=C(),this.vMinSiblingLength=0,this.frame=new dDe}setFrameFromUpVector(e){oe(this.frame.up,e),ue(DR,this.vLeft,this.vRight),_e(DR,DR),ae(Zfe,this.frame.up,de(DR,this.frame.up)),pe(DN,DR,Zfe),_e(DN,DN),st(this.frame.right,DN,this.frame.up)}get foldingAngle(){return Math.PI-this.rotationAngle}},J2t=class extends TDe{get rotationFrameUp(){return this.frame.up}get rotationRight(){return GCe}get rotationAngle(){return ae(P_,this.frame.up,de(this.frame.up,this.vLeft)),pe(P_,this.vLeft,P_),el(P_,P_),_e(P_,P_),ae(w2,this.frame.up,de(this.frame.up,this.vRight)),pe(w2,this.vRight,w2),_e(w2,w2),st(t6,this.rotationFrameUp,this.vLeft),Math.sign(de(t6,this.vRight))*(Math.PI-oo(de(P_,w2)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength/Math.cos(.5*this.foldingAngle))}applyMiterStretch(e,r){const i=this.rotationAngle;if(Math.abs(i)<=0)return r;const s=p7(Math.cos(.5*i));return hr(e,(s-1+1)*r[0],r[1])}},Q2t=class extends TDe{get rotationFrameUp(){const e=Math.sign(de(this.frame.right,this.vRight));return st(LR,this.vRight,this.vLeft),ae(LR,LR,e),_e(LR,LR)}get rotationRight(){const e=this.rotationFrameUp,r=de(e,this.frame.up),i=de(e,this.frame.right);return ae(b2,this.frame.up,-i),ae(Wfe,this.frame.right,r),ue(b2,b2,Wfe),_e(b2,b2),K2t(qfe,this.frame,b2),qfe}get rotationAngle(){const e=Math.sign(de(this.frame.right,this.vRight));return el(t6,this.vLeft),-e*(Math.PI-oo(de(t6,this.vRight)))}get maxStretchDistance(){return Math.abs(this.vMinSiblingLength*p7(Math.cos(.5*this.foldingAngle)))}applyMiterStretch(e,r){const i=this.rotationAngle;if(Math.abs(i)===0)return r;const s=p7(Math.cos(.5*i)),n=this.rotationRight,o=vDe(tEt,1+(s-1)*n[0]*n[0],(s-1)*n[0]*n[1],(s-1)*n[0]*n[1],1+(s-1)*n[1]*n[1]);return $Ce(e,r,o)}};function K2t(t,e,r){hr(t,de(r,e.right),de(r,e.up))}function eEt(t){switch(t){case ug.World:return new J2t;case ug.Path:return new Q2t}}const LR=C(),qfe=Pe(),b2=C(),Wfe=C(),t6=C(),P_=C(),w2=C(),Zfe=C(),DR=C(),DN=C(),tEt=xDe(),kG=8;function rEt(t,e){const r=E.FEATUREVALUE;t.attributes.add(r,"vec4");const i=t.vertex;i.code.add(w`
  bool isCapVertex() {
    return ${r}.w == 1.0;
  }
  `),i.uniforms.add(new Pr("size",s=>s.size)),e.vvSize?(i.uniforms.add(new jt("vvSizeMinSize",s=>s.vvSize.minSize),new jt("vvSizeMaxSize",s=>s.vvSize.maxSize),new jt("vvSizeOffset",s=>s.vvSize.offset),new jt("vvSizeFactor",s=>s.vvSize.factor)),i.code.add(w`
    vec2 getSize() {
      return size * clamp(vvSizeOffset + ${r}.x * vvSizeFactor, vvSizeMinSize, vvSizeMaxSize).xz;
    }
    `)):i.code.add(w`vec2 getSize(){
return size;
}`),e.vvOpacity?(i.constants.add("vvOpacityNumber","int",kG),i.uniforms.add(new gc("vvOpacityValues",s=>s.vvOpacity.values,kG),new gc("vvOpacityOpacities",s=>s.vvOpacity.opacityValues,kG)),i.code.add(w`
    vec4 applyOpacity(vec4 color) {
      float value = ${r}.z;
      if (value <= vvOpacityValues[0]) {
        return vec4( color.xyz, vvOpacityOpacities[0]);
      }

      for (int i = 1; i < vvOpacityNumber; ++i) {
        if (vvOpacityValues[i] >= value) {
          float f = (value - vvOpacityValues[i-1]) / (vvOpacityValues[i] - vvOpacityValues[i-1]);
          return vec4( color.xyz, mix(vvOpacityOpacities[i-1], vvOpacityOpacities[i], f));
        }
      }

      return vec4( color.xyz, vvOpacityOpacities[vvOpacityNumber - 1]);
    }
    `)):i.code.add(w`vec4 applyOpacity(vec4 color){
return color;
}`),e.vvColor?(i.constants.add("vvColorNumber","int",GC),i.uniforms.add(new gc("vvColorValues",s=>s.vvColor.values,GC),new xPe("vvColorColors",s=>s.vvColor.colors,GC)),i.code.add(w`
    vec4 getColor() {
      float value = ${r}.y;
      if (value <= vvColorValues[0]) {
        return applyOpacity(vvColorColors[0]);
      }

      for (int i = 1; i < vvColorNumber; ++i) {
        if (vvColorValues[i] >= value) {
          float f = (value - vvColorValues[i-1]) / (vvColorValues[i] - vvColorValues[i-1]);
          return applyOpacity(mix(vvColorColors[i-1], vvColorColors[i], f));
        }
      }

      return applyOpacity(vvColorColors[vvColorNumber - 1]);
    }
    `)):i.code.add(w`vec4 getColor(){
return applyOpacity(vec4(1, 1, 1, 1));
}`),t.include(E$),t.attributes.add(E.PROFILERIGHT,"vec4"),t.attributes.add(E.PROFILEUP,"vec4"),t.attributes.add(E.PROFILEVERTEXANDNORMAL,"vec4"),i.code.add(w`vec3 calculateVPos() {
vec2 size = getSize();
vec3 origin = position;
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileVertex = profileVertexAndNormal.xy * size;
vec2 profileNormal = profileVertexAndNormal.zw;
float positionOffsetAlongProfilePlaneNormal = 0.0;
float normalOffsetAlongProfilePlaneNormal = 0.0;`),i.code.add(w`if(!isCapVertex()) {
vec2 rotationRight = vec2(profileRight.w, profileUp.w);
float maxDistance = length(rotationRight);`),i.code.add(w`rotationRight = maxDistance > 0.0 ? normalize(rotationRight) : vec2(0, 0);
float rx = dot(profileVertex, rotationRight);
if (abs(rx) > maxDistance) {
vec2 rotationUp = vec2(-rotationRight.y, rotationRight.x);
float ry = dot(profileVertex, rotationUp);
profileVertex = rotationRight * maxDistance * sign(rx) + rotationUp * ry;
}
}else{
positionOffsetAlongProfilePlaneNormal = profileRight.w * size[0];
normalOffsetAlongProfilePlaneNormal = profileUp.w;
}
vec3 offset = right * profileVertex.x + up * profileVertex.y + forward * positionOffsetAlongProfilePlaneNormal;
return origin + offset;
}`),i.code.add(w`vec3 localNormal() {
vec3 right = profileRight.xyz;
vec3 up = profileUp.xyz;
vec3 forward = cross(up, right);
vec2 profileNormal = profileVertexAndNormal.zw;
vec3 normal = right * profileNormal.x + up * profileNormal.y;
if(isCapVertex()) {
normal += forward * profileUp.w;
}
return normal;
}`)}let iEt=class extends D${constructor(){super(...arguments),this.size=yr(1,1)}};function sEt(t){const e=new Cr,{vertex:r,fragment:i}=e;switch(Eu(r,t),e.varyings.add("vpos","vec3"),e.include(rEt,t),t.output!==k.Color&&t.output!==k.Alpha||(e.include(_c,t),e.include(XT,t),e.include(TO,t),e.varyings.add("vnormal","vec3"),e.varyings.add("vcolor","vec4"),t.hasMultipassTerrain&&e.varyings.add("depth","float"),r.code.add(w`
      void main() {
        vpos = calculateVPos();
        vnormal = normalize(localNormal());

        ${t.hasMultipassTerrain?"depth = (view * vec4(vpos, 1.0)).z;":""}
        gl_Position = transformPosition(proj, view, vpos);

        ${t.output===k.Color?"forwardLinearDepth();":""}

        vcolor = getColor();
      }
    `)),e.include(Ah,t),t.output){case k.Alpha:e.include(Bs,t),i.uniforms.add(new Ie("opacity",s=>s.opacity)),i.code.add(w`
      void main() {
        discardBySlice(vpos);
        ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}
        float combinedOpacity = vcolor.a * opacity;
        fragColor = vec4(combinedOpacity);
      }
    `);break;case k.Color:e.include(Bs,t),e.include(JT,t),e.include(B$,t),e.include(XT,t),e.include(TLe,t),kf(i,t),G$(i),PO(i),i.uniforms.add(r.uniforms.get("localOrigin"),new jt("ambient",s=>s.ambient),new jt("diffuse",s=>s.diffuse),new jt("specular",s=>s.specular),new Ie("opacity",s=>s.opacity)),i.include(kg),Fg(i),i.code.add(w`
        void main() {
          discardBySlice(vpos);
          ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, depth);":""}

          shadingParams.viewDirection = normalize(vpos - cameraPosition);
          shadingParams.normalView = vnormal;
          vec3 normal = shadingNormal(shadingParams);
          float ssao = evaluateAmbientOcclusionInverse();

          float additionalAmbientScale = additionalDirectedAmbientLight(vpos + localOrigin);
          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;
          ${t.receiveShadows?"float shadow = readShadowMap(vpos, linearDepth);":t.spherical?"float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);":"float shadow = 0.0;"}
          vec3 albedo = vcolor.rgb * max(ambient, diffuse); // combine the old material parameters into a single one
          float combinedOpacity = vcolor.a * opacity;
          albedo += 0.25 * specular; // don't completely ignore specular for now

          vec3 shadedColor = evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight);
          fragColor = vec4(shadedColor, combinedOpacity);
          fragColor = highlightSlice(fragColor, vpos);
          ${t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}
        }
      `);break;case k.Depth:case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:e.include(_c,t),BT(e),e.varyings.add("depth","float"),r.code.add(w`void main() {
vpos = calculateVPos();
gl_Position = transformPositionWithDepth(proj, view, vpos, nearFar, depth);
}`),e.include(Bs,t),e.include(N0,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputDepth(depth);
}`);break;case k.Normal:e.include(_c,t),e.include(AP,t),NA(r),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
vnormal = normalize((viewNormal * vec4(localNormal(), 1.0)).xyz);
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Bs,t),i.code.add(w`void main() {
discardBySlice(vpos);
vec3 normal = normalize(vnormal);
if (gl_FrontFacing == false) normal = -normal;
fragColor = vec4(vec3(0.5) + 0.5 * normal, 1.0);
}`);break;case k.Highlight:e.include(_c,t),e.include(AP,t),e.varyings.add("vnormal","vec3"),r.code.add(w`void main(void) {
vpos = calculateVPos();
gl_Position = transformPosition(proj, view, vpos);
}`),e.include(Bs,t),e.include(J0,t),i.code.add(w`void main() {
discardBySlice(vpos);
outputHighlight();
}`)}return e}const nEt=Object.freeze(Object.defineProperty({__proto__:null,build:sEt},Symbol.toStringTag,{value:"Module"})),SDe=new Map([[E.POSITION,0],[E.PROFILERIGHT,1],[E.PROFILEUP,2],[E.PROFILEVERTEXANDNORMAL,3],[E.FEATUREVALUE,4]]);let oEt=class extends iEt{constructor(){super(...arguments),this.ambient=Ee(.2,.2,.2),this.diffuse=Ee(.8,.8,.8),this.specular=Ee(0,0,0),this.opacity=1,this.origin=C(),this.modelTransformation=null}},EDe=class CDe extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Lr(e.rctx,CDe.shader.get().build(this.configuration),SDe)}initializePipeline(){const e=this.configuration.transparencyPassType,r=this.configuration,i=e===ut.NONE,s=e===ut.FrontFace;return It({blending:r.output!==k.Color&&r.output!==k.Alpha||!r.transparent?null:i?vh:Q0(e),culling:r.hasSlicePlane&&!r.transparent&&r.doubleSidedMode!==bs.None?YRe:null,depthTest:{func:gb(e)},depthWrite:i||s?Ac:null,colorWrite:Wt,stencilWrite:r.hasOccludees?Og:null,stencilTest:r.hasOccludees?yb:null,polygonOffset:i||s?null:$8})}};EDe.shader=new $r(nEt,()=>J(()=>import("./Path.glsl-2edab2b2.js"),[],import.meta.url));let bo=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.doubleSidedMode=bs.None,this.transparencyPassType=ut.NONE,this.spherical=!1,this.receiveShadows=!1,this.receiveAmbientOcclusion=!1,this.vvSize=!1,this.vvColor=!1,this.vvOpacity=!1,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.doublePrecisionRequiresObfuscation=!1}};u([B({count:k.COUNT})],bo.prototype,"output",void 0),u([B({count:bs.COUNT})],bo.prototype,"doubleSidedMode",void 0),u([B({count:ut.COUNT})],bo.prototype,"transparencyPassType",void 0),u([B()],bo.prototype,"spherical",void 0),u([B()],bo.prototype,"receiveShadows",void 0),u([B()],bo.prototype,"receiveAmbientOcclusion",void 0),u([B()],bo.prototype,"vvSize",void 0),u([B()],bo.prototype,"vvColor",void 0),u([B()],bo.prototype,"vvOpacity",void 0),u([B()],bo.prototype,"hasSlicePlane",void 0),u([B()],bo.prototype,"transparent",void 0),u([B()],bo.prototype,"hasOccludees",void 0),u([B()],bo.prototype,"hasMultipassTerrain",void 0),u([B()],bo.prototype,"cullAboveGround",void 0),u([B()],bo.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B({constValue:lt.Disabled})],bo.prototype,"pbrMode",void 0),u([B({constValue:!0})],bo.prototype,"hasVvInstancing",void 0),u([B({constValue:!1})],bo.prototype,"useCustomDTRExponentForWater",void 0),u([B({constValue:!1})],bo.prototype,"useFillLights",void 0);let aEt=class ADe extends mb{constructor(e){super(e,new cEt),this.supportsEdges=!0,this._vertexAttributeLocations=SDe,this._configuration=new bo,this._vertexBufferLayout=ADe.getVertexBufferLayout()}getConfiguration(e,r){return this._configuration.output=e,this._configuration.vvSize=!!this.parameters.vvSize,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration.vvOpacity=!!this.parameters.vvOpacity,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.hasOccludees=this.parameters.hasOccludees,e!==k.Color&&e!==k.Alpha||(this._configuration.doubleSidedMode=this.parameters.doubleSided&&this.parameters.doubleSidedType==="normal"?bs.View:this.parameters.doubleSided&&this.parameters.doubleSidedType==="winding-order"?bs.WindingOrder:bs.None,this._configuration.receiveShadows=this.parameters.receiveShadows,this._configuration.receiveAmbientOcclusion=!!r.ssaoHelper.active&&this.parameters.receiveSSAO),this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration}isVisibleForOutput(e){return e!==k.Shadow&&e!==k.ShadowExcludeHighlight&&e!==k.ShadowHighlight||this.parameters.castShadows}isVisible(){return super.isVisible()&&this.parameters.opacity>0}intersect(e,r,i,s,n,o){const a=e;if(!pDe(a))return;const l=a.path,c=[this.parameters.size[0],this.parameters.size[1]];if(this.parameters.vvSize){const{offset:v,factor:b,minSize:x,maxSize:T}=this.parameters.vvSize,S=l.sizeAttributeValue;c[0]*=ye(v[0]+S*b[0],x[0],T[0]),c[1]*=ye(v[2]+S*b[2],x[2],T[2])}const h=Math.max(c[0],c[1]),p=e.boundingInfo;if(p==null)return void this._intersectTriangles(l,c,s,n,o);const f=PT(p.bbMin[0]-h,p.bbMin[1]-h,p.bbMin[2]-h,p.bbMax[0]+h,p.bbMax[1]+h,p.bbMax[2]+h),m=[n[0]-s[0],n[1]-s[1],n[2]-s[2]],g=Math.sqrt(m[0]*m[0]+m[1]*m[1]+m[2]*m[2]),_=[g/m[0],g/m[1],g/m[2]];$re(f,s,_,i.tolerance)&&this._intersectTriangles(l,c,s,n,o)}_intersectTriangles(e,r,i,s,n){e.baked.size&&e.baked.size[0]===r[0]&&e.baked.size[1]===r[1]||e.baked.bake(r),e.baked.intersect(i,s,n)}createBufferWriter(){return new IO(this._vertexBufferLayout)}requiresSlot(e,r){switch(r){case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:if(!this.parameters.castShadows)return!1;case k.Color:case k.Alpha:case k.Depth:case k.Normal:case k.Highlight:case k.ObjectAndLayerIdColor:return e===(this.parameters.transparent?fe.TRANSPARENT_MATERIAL:fe.OPAQUE_MATERIAL)||e===fe.DRAPED_MATERIAL;default:return!1}}createGLMaterial(e){return new lEt(e)}static getVertexBufferLayout(){return us().vec3f(E.POSITION).vec4f(E.PROFILERIGHT).vec4f(E.PROFILEUP).vec4f(E.PROFILEVERTEXANDNORMAL).vec4f(E.FEATUREVALUE)}},lEt=class extends pb{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}_updateShadowState(e){this.technique!=null&&e.shadowMap.enabled===this.technique.configuration.receiveShadows||this._material.setParameters({receiveShadows:e.shadowMap.enabled})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||(this._updateShadowState(e),this._updateOccludeeState(e)),this.ensureTechnique(EDe,e)}},cEt=class extends oEt{constructor(){super(...arguments),this.doubleSided=!1,this.doubleSidedType="normal",this.receiveSSAO=!0,this.receiveShadows=!1,this.castShadows=!0,this.hasSlicePlane=!1,this.transparent=!1,this.hasOccludees=!1}};const uEt=["polyline"];let hEt=class extends Vg{constructor(e,r,i,s){super(e,r,i,s),this._intrinsicSize=yr(1,1),this._upVectorAlignment=ug.Path,this._stencilWidth=.1,this.ensureDrapedStatus(!1)}async doLoad(){const e=this.symbolLayer.width!=null?this.symbolLayer.width:this.symbolLayer.height,r=this.symbolLayer.height!=null?this.symbolLayer.height:e;this._vvConvertOptions=new L$({size:!0,color:!0,rotation:!1,opacity:!0},[1,1,1],[e,1,r],this._context.renderCoordsHelper.unitInMeters),this._fastUpdates=this._context.renderer?.visualVariables?.length>0?kA(this._context.renderer,this._vvConvertOptions):null;const i=this.symbolLayer.anchor||"center";this._upVectorAlignment=this.symbolLayer.profileRotation==="heading"?ug.World:ug.Path;const s=this.symbolLayer.profile||"circle";switch(s){default:case"circle":this._profile=C2t[i];break;case"quad":this._profile=A2t[i]}switch(this.symbolLayer.join){case"round":this._extruder=new DG(0,YPe);break;case"bevel":this._extruder=new DG(0,1);break;case"miter":this._extruder=new DG(.8*Math.PI,1);break;default:this._extruder=new p2t}const n=this.symbolLayer.cap||"butt";switch(n){case"none":this._startCap=new zfe,this._endCap=new zfe;break;case"butt":default:this._startCap=new LN(this._profile,0),this._endCap=new LN(this._profile,0,!0);break;case"square":this._startCap=new LN(this._profile,-.5),this._endCap=new LN(this._profile,.5,!0);break;case"round":{const f=s==="quad";this._startCap=new Bfe({profile:this._profile,flip:!1,breakNormals:f,subdivisions:RY}),this._endCap=new Bfe({profile:this._profile,flip:!0,breakNormals:f,subdivisions:RY});break}}const o=this.symbolLayer?.material?.color,a=this._getCombinedOpacityAndColor(o),l=Ml(a),c=a[3],h=c<1||this.needsDrivenTransparentPass,p={diffuse:l,ambient:l,opacity:c,transparent:h,hasVertexColors:!1,hasSlicePlane:this._context.slicePlaneEnabled,castShadows:this.symbolLayer.castShadows,cullFace:h||n==="none"?Ii.None:Ii.Back,offsetTransparentBackfaces:!0};if(!this._drivenProperties.size&&(hr(this._intrinsicSize,e,r),!OY(this._intrinsicSize[0])||!OY(this._intrinsicSize[1])))throw new D("graphics3dpathsymbollayer:invalid-size","Symbol sizes may not be negative values");if(this._fastUpdates&&this._fastUpdates.visualVariables.size||fc(this._intrinsicSize,this._intrinsicSize,1/this._context.renderCoordsHelper.unitInMeters),this._fastUpdates){const f={...p,...this._fastUpdates.materialParameters,size:FCe(this._intrinsicSize)};this._material=new aEt(f)}else p.hasVertexColors=this._drivenProperties.color||this._drivenProperties.opacity,p.normalType=Fr.Compressed,this._material=new Rg(p);this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),this._context.stage.add(this._material)}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,uEt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Gf),s=e.renderingInfo;return this._createAs3DShape(r,s,i,r.uid)}layerOpacityChanged(){const e=this.symbolLayer?.material?.color,r=this._getCombinedOpacity(e),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({opacity:r,transparent:i})}layerElevationInfoChanged(e,r){return this.updateGraphics3DGraphicElevationInfo(e,r,ib)}slicePlaneEnabledChanged(){return this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return this._material.setParameters({usePBR:this._context.physicalBasedRenderingEnabled,isSchematic:!0}),!0}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!UA(this._fastUpdates,r,this._vvConvertOptions))return on.RecreateSymbol;this._material.setParameters(this._fastUpdates.materialParameters)}return on.FastUpdate}_getVertexData(e){let r=0;const i=e.paths,s=[],n=e.spatialReference,o=this._context.elevationProvider.spatialReference,a=this._context.renderCoordsHelper.spatialReference;for(const p of i)r+=p.length;const l=Ra(3*r);let c,h=0;for(const p of i){s.push({offset:h,numVertices:p.length});for(const f of p)l[h++]=f[0],l[h++]=f[1],l[h++]=e.hasZ?f[2]:0}return o==null||n.equals(o)||wi(l,n,0,l,o,0,r)?(o==null||o.equals(a)?c=nMe(l):(c=Ra(3*r),wi(l,o,0,c,a,0,r)),{pathVertexDataInfos:s,vertexDataES:l,vertexDataRS:c}):null}_createAs3DShape(e,r,i,s){const n=e.geometry,o=this._getVertexData(n);if(o==null)return this.logger.warn("PathSymbol3DLayer geometry failed to be created (failed to project geometry to view spatial reference)"),null;if(o.pathVertexDataInfos.length===0)return n.paths.length!==0&&n.paths.some(g=>g.length>0)||this.logger.warn("PathSymbol3DLayer geometry failed to be created (no paths were defined)"),null;const a=new Array,l=n.spatialReference,c=Gn(),h=this._context.renderCoordsHelper,p=new Tre(o.vertexDataES);for(const g of o.pathVertexDataInfos){const _=g.numVertices;if(_<2)continue;const v=g.offset;if(this._context.clippingExtent!=null&&(Gi(c),fh(c,o.vertexDataES,v,_),!cf(c,this._context.clippingExtent)))continue;const b=new Array,x=v+3*_;for(let $=v;$<x;$+=3){p.offset=$;const N=Ivt(p,this._context.elevationProvider,i,h);ie(Fs,o.vertexDataRS[$],o.vertexDataRS[$+1],o.vertexDataRS[$+2]),h.setAltitude(Fs,N),o.vertexDataRS[$]=Fs[0],o.vertexDataRS[$+1]=Fs[1],o.vertexDataRS[$+2]=Fs[2],b.push(eEt(this._upVectorAlignment))}const T=new u2t(b,o.vertexDataES,o.vertexDataRS,v);ODe(T,this._upVectorAlignment,this._context.renderCoordsHelper);const S=new h2t(T,this._profile,this._extruder,this._startCap,this._endCap);let O=null;if(this._fastUpdates){const $=this._fastUpdates.visualVariables,N=Sf($.size?.field,e)??0,U=Sf($.color?.field,e)??0,X=Sf($.opacity?.field,e)??0;O=new y2t(S,N,U,X)}else{const $=[this._intrinsicSize[0],this._intrinsicSize[1]];if(this._drivenProperties.size){const X=r.size;$[0]*=Xfe(X[0],X[2]==="symbol-value"?this.symbolLayer.height||0:X[2],this.symbolLayer.width||0),$[1]*=Xfe(X[2],X[0]==="symbol-value"?this.symbolLayer.width||0:X[0],this.symbolLayer.height||0)}let N;this._drivenProperties.color&&(N=r.color),this._drivenProperties.opacity&&r.opacity!=null&&(N=N?[N[0],N[1],N[2],r.opacity]:[1,1,1,r.opacity]);const U=new mDe(S);U.bake($),N&&U.bakeVertexColors(N),O=U}const{vertexAttributes:A,indices:M}=O.createGeometryData(),P=this._context.stage.renderView.getObjectAndLayerIdColor({graphicUid:s,layerUid:this._context.layer.uid}),F=new g2t(this._material,A,M,O,l,this._stencilWidth,P);F.transformation=Cc(xe(),Un,S.path.origin),a.push(F)}if(a.length===0)return null;const f=new K0({geometries:a,layerUid:this._context.layer.uid,graphicUid:s}),m=new Ug(this,f,a,null,null,(g,_,v,b,x)=>pEt(g,_,b,x,this._upVectorAlignment),i);return m.alignedSampledElevation=0,m.needsElevationUpdates=ib(i.mode),m}};function ODe(t,e,r){const{origin:i,positions:s}=t;let n=t.offset;switch(e){default:case ug.World:for(const o of t.vertices)Fs[0]=s[n++]+i[0],Fs[1]=s[n++]+i[1],Fs[2]=s[n++]+i[2],r.worldUpAtPosition(Fs,Fs),o.setFrameFromUpVector(Fs);break;case ug.Path:Fs[0]=s[n]+i[0],Fs[1]=s[n+1]+i[1],Fs[2]=s[n+2]+i[2],r.worldUpAtPosition(Fs,Fs),S2t(t,Fs)}}function Xfe(t,e,r){switch(t){case"symbol-value":return r;case"proportional":return e;default:return t}}function dEt(t,e,r,i){let s=0;const{origin:n,vertices:o,positions:a,positionsES:l}=t,c=t.offset+3*o.length;for(let h=t.offset;h<c;h+=3)ie(Fs,l[h],l[h+1],l[h+2]),r(Fs,UG),s+=UG.sampledElevation,Fs[0]=a[h]+n[0],Fs[1]=a[h+1]+n[1],Fs[2]=a[h+2]+n[2],i.setAltitude(Fs,UG.z),a[h]=Fs[0]-n[0],a[h+1]=Fs[1]-n[1],a[h+2]=Fs[2]-n[2];return t.updatePathVertexInformation(),s/o.length}function pEt(t,e,r,i,s){const n=t.stageObject,o=n.geometries;let a=0;for(const l of o){if(!pDe(l))continue;const c=l.path,h=c.builder.path;a+=dEt(h,e,r,i),s!==ug.World&&ODe(h,s,i),c.onPathChanged(l),l.invalidateBoundingInfo(),n.geometryVertexAttrsUpdated(l)}return a/o.length}const Fs=C(),UG=new F$;function fEt(t,e,r,i,s=1){if(r.isGeographic&&i===Ue.Global){const c=Ra(e.length),h=e.length,p=Ir(r);for(let f=0;f<h;f+=3)MV(e,f,c,f,p);e=c}hr(In,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY);for(let c=0;c<e.length;c+=3)In[0]=Math.min(In[0],e[c]),In[1]=Math.min(In[1],e[c+1]);const n=In[0]%s,o=In[1]%s,a=In[0]-n,l=In[1]-o;for(let c=0;c<e.length;c+=3){const h=c/3*4;t[h]=(e[c]-a)/s,t[h+1]=(e[c+1]-l)/s,t[h+2]=a/s,t[h+3]=l/s}}function RDe(t,e,r,i,s=1){ie(Qb,1,0,0),ie(Kb,0,1,0),ie(T2,0,0,1),yEt(VG,r),mEt(r,Yfe)&&gEt(Yfe,Qb,Kb,T2,i,VG),hr(In,Number.POSITIVE_INFINITY,Number.POSITIVE_INFINITY),hr(ew,Number.NEGATIVE_INFINITY,Number.NEGATIVE_INFINITY);for(let h=0;h<r.length;h+=3){ie(x2,r[h],r[h+1],r[h+2]);const p=de(Qb,x2),f=de(Kb,x2);In[0]=Math.min(In[0],p),In[1]=Math.min(In[1],f),ew[0]=Math.max(ew[0],p),ew[1]=Math.max(ew[1],f)}const n=de(T2,VG);BG($_,In[0],In[1],n,Qb,Kb,T2),BG(tw,ew[0],In[1],n,Qb,Kb,T2),BG(rw,In[0],ew[1],n,Qb,Kb,T2),pe(tw,tw,$_),ae(tw,tw,.5),pe(rw,rw,$_),ae(rw,rw,.5),ue($_,$_,tw),ue($_,$_,rw);const o=In[0]%s,a=In[1]%s,l=In[0]-o,c=In[1]-a;for(let h=0;h<r.length;h+=3){ie(x2,r[h],r[h+1],r[h+2]);const p=h/3,f=4*p;t[f]=(de(Qb,x2)-l)/s,t[f+1]=(de(Kb,x2)-c)/s,t[f+2]=l/s,t[f+3]=c/s;const m=9*p;for(let g=0;g<3;g++)e[m+g]=$_[g],e[m+g+3]=tw[g],e[m+g+6]=rw[g]}}const VG=C(),x2=C(),Yfe=zr(),Qb=C(),Kb=C(),T2=C(),In=Pe(),ew=Pe(),$_=C(),tw=C(),rw=C();function mEt(t,e){const r=t.length/3-1;return jOe(t,e,0,Math.floor(r/3),Math.floor(r*(2/3)))}function gEt(t,e,r,i,s,n){s!=null?(s.basisMatrixAtPosition(n,hm),ie(NN,hm[0],hm[1],hm[2]),ie(FN,hm[4],hm[5],hm[6]),ie(zG,hm[8],hm[9],hm[10])):(ie(NN,1,0,0),ie(FN,0,1,0),ie(zG,0,0,1));const o=t;de(o,zG)<0&&ae(o,o,-1),oe(i,o);const a=de(o,FN),l=de(o,NN);Math.abs(a)<Math.abs(l)?(gu(e,NN,o,-l),_e(e,e),st(r,e,o),_e(r,r),ae(r,r,-1)):(gu(r,FN,o,-a),_e(r,r),st(e,r,o),_e(e,e))}const hm=xe(),NN=C(),FN=C(),zG=C();function yEt(t,e){ie(NR,0,0,0);for(let r=0;r<e.length-3;r+=3)NR[0]+=e[r],NR[1]+=e[r+1],NR[2]+=e[r+2];ae(t,NR,1/(e.length/3-1))}const NR=C();function BG(t,e,r,i,s,n,o){ie(t,e*s[0]+r*n[0]+i*o[0],e*s[1]+r*n[1]+i*o[1],e*s[2]+r*n[2]+i*o[2])}function _Et(t){const e=new Cr,{vertex:r,fragment:i,attributes:s,varyings:n}=e;Eu(r,t),e.include(_c,t),e.include(xS,t),e.include(y0,t),e.include($$,t),s.add(E.POSITION,"vec3"),t.vvColor&&s.add(E.COLORFEATUREATTRIBUTE,"float"),n.add("vColor","vec4"),n.add("vpos","vec3");const o=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha);o&&n.add("depth","float"),r.uniforms.add(new cr("eColor",c=>c.color));const a=t.output===k.Depth;a&&(e.include(N0,t),BT(e),J1(e)),r.code.add(w`
    void main(void) {
      vpos = position;
      forwardNormalizedVertexColor();
      forwardObjectAndLayerIdColor();

      ${t.hasVertexColors?"vColor *= eColor;":t.vvColor?"vColor = eColor * interpolateVVColor(colorFeatureAttribute);":"vColor = eColor;"}
      ${o?"depth = (view * vec4(vpos, 1.0)).z;":""}
      gl_Position = ${a?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Bs,t),o&&e.include(Ah,t),i.include(kg);const l=t.output===k.Highlight;return l&&e.include(J0,t),i.code.add(w`
  void main() {
    discardBySlice(vpos);
    ${o?"terrainDepthTest(gl_FragCoord, depth);":""}
    vec4 fColor = vColor;

    ${t.output===k.ObjectAndLayerIdColor?w`fColor.a = 1.0;`:""}

    if (fColor.a < ${w.float(ia)}) {
      discard;
    }

    ${t.output===k.Alpha?w`fragColor = vec4(fColor.a);`:""}

    ${t.output===k.Color?w`fragColor = highlightSlice(fColor, vpos); ${t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
    ${l?w`outputHighlight();`:""};
    ${t.output===k.Depth?w`outputDepth(linearDepth);`:""};
    ${t.output===k.ObjectAndLayerIdColor?w`outputObjectAndLayerIdColor();`:""}
  }
  `),e}const vEt=Object.freeze(Object.defineProperty({__proto__:null,build:_Et},Symbol.toStringTag,{value:"Module"}));let MDe=class IDe extends Ur{initializeProgram(e){return new Lr(e.rctx,IDe.shader.get().build(this.configuration),Er)}_createPipeline(e,r){const i=this.configuration,s=e===ut.NONE,n=e===ut.FrontFace;return It({blending:i.output!==k.Color&&i.output!==k.Alpha||!i.transparent?null:s?vh:Q0(e),culling:n8(i.cullFace),depthTest:{func:gb(e)},depthWrite:(s||n)&&i.writeDepth?Ac:null,colorWrite:Wt,stencilWrite:i.hasOccludees?Og:null,stencilTest:i.hasOccludees?r?nb:yb:null,polygonOffset:s||n?i.polygonOffset?bEt:null:L8(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._createPipeline(this.configuration.transparencyPassType,!0),this._createPipeline(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};MDe.shader=new $r(vEt,()=>J(()=>import("./ColorMaterial.glsl-969d7b92.js"),[],import.meta.url));const bEt={factor:1,units:1};let ya=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.cullFace=Ii.None,this.transparencyPassType=ut.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.transparent=!1,this.polygonOffset=!1,this.enableOffset=!0,this.writeDepth=!0,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.objectAndLayerIdColorInstanced=!1,this.vvColor=!1}};u([B({count:k.COUNT})],ya.prototype,"output",void 0),u([B({count:Ii.COUNT})],ya.prototype,"cullFace",void 0),u([B({count:ut.COUNT})],ya.prototype,"transparencyPassType",void 0),u([B()],ya.prototype,"hasSlicePlane",void 0),u([B()],ya.prototype,"hasVertexColors",void 0),u([B()],ya.prototype,"transparent",void 0),u([B()],ya.prototype,"polygonOffset",void 0),u([B()],ya.prototype,"enableOffset",void 0),u([B()],ya.prototype,"writeDepth",void 0),u([B()],ya.prototype,"hasOccludees",void 0),u([B()],ya.prototype,"hasMultipassTerrain",void 0),u([B()],ya.prototype,"cullAboveGround",void 0),u([B()],ya.prototype,"objectAndLayerIdColorInstanced",void 0),u([B()],ya.prototype,"vvColor",void 0),u([B({constValue:!0})],ya.prototype,"hasVvInstancing",void 0),u([B({constValue:!1})],ya.prototype,"vvSize",void 0),u([B({constValue:!1})],ya.prototype,"vvOpacity",void 0);let Jfe=class extends lie{constructor(e){super(e,new xEt),this.supportsEdges=!0,this._configuration=new ya}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.transparent=this.parameters.transparent,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.hasOccludees=this.parameters.hasOccludees,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<P8,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth&&this.parameters.writeLinearDepth||r===k.ObjectAndLayerIdColor?e===fe.DRAPED_MATERIAL?!0:r===k.Highlight?e===fe.OPAQUE_MATERIAL:e===(this.parameters.transparent?this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL:fe.OPAQUE_MATERIAL):!1}createGLMaterial(e){return new wEt(e)}createBufferWriter(){const e=us().vec3f(E.POSITION);return le("enable-feature:objectAndLayerId-rendering")&&e.vec4u8(E.OBJECTANDLAYERIDCOLOR),this.parameters.vvColor?e.f32(E.COLORFEATUREATTRIBUTE):e.vec4u8(E.COLOR),new IO(e)}},wEt=class extends pb{_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this.ensureTechnique(MDe,e)}},xEt=class extends D${constructor(){super(...arguments),this.color=ng,this.transparent=!1,this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ii.None,this.hasOccludees=!1}};var ta;(function(t){t[t.Horizontal=0]="Horizontal",t[t.Vertical=1]="Vertical",t[t.Cross=2]="Cross",t[t.ForwardDiagonal=3]="ForwardDiagonal",t[t.BackwardDiagonal=4]="BackwardDiagonal",t[t.DiagonalCross=5]="DiagonalCross",t[t.COUNT=6]="COUNT"})(ta||(ta={}));const HY=.70710678118,Qfe=HY,TEt=.08715574274;function SEt(t){const e=new Cr,r=t.hasMultipassTerrain&&(t.output===k.Color||t.output===k.Alpha),{vertex:i,fragment:s,attributes:n,varyings:o}=e;Eu(i,t),e.include(_c,t),e.include(xS,t),e.include(y0,t),t.draped?i.uniforms.add(new Ie("worldToScreenRatio",(c,h)=>1/h.screenToPCSRatio)):n.add(E.BOUNDINGRECT,"mat3"),n.add(E.POSITION,"vec3"),n.add(E.UVMAPSPACE,"vec4"),t.vvColor&&n.add(E.COLORFEATUREATTRIBUTE,"float"),o.add("vColor","vec4"),o.add("vpos","vec3"),o.add("vuv","vec2"),r&&o.add("depth","float"),i.uniforms.add(new cr("uColor",c=>c.color));const a=t.style===ta.ForwardDiagonal||t.style===ta.BackwardDiagonal||t.style===ta.DiagonalCross;a&&i.code.add(w`
      const mat2 rotate45 = mat2(${w.float(HY)}, ${w.float(-Qfe)},
                                 ${w.float(Qfe)}, ${w.float(HY)});
    `),t.draped||(kf(i,t),i.uniforms.add(new Ie("worldToScreenPerDistanceRatio",(c,h)=>1/h.camera.perScreenPixelRatio)),i.code.add(w`vec3 projectPointToLineSegment(vec3 center, vec3 halfVector, vec3 point) {
float projectedLength = dot(halfVector, point - center) / dot(halfVector, halfVector);
return center + halfVector * clamp(projectedLength, -1.0, 1.0);
}`),i.code.add(w`vec3 intersectRayPlane(vec3 rayDir, vec3 rayOrigin, vec3 planeNormal, vec3 planePoint) {
float d = dot(planeNormal, planePoint);
float t = (d - dot(planeNormal, rayOrigin)) / dot(planeNormal, rayDir);
return rayOrigin + t * rayDir;
}`),i.code.add(w`
      float boundingRectDistanceToCamera() {
        vec3 center = vec3(boundingRect[0][0], boundingRect[0][1], boundingRect[0][2]);
        vec3 halfU = vec3(boundingRect[1][0], boundingRect[1][1], boundingRect[1][2]);
        vec3 halfV = vec3(boundingRect[2][0], boundingRect[2][1], boundingRect[2][2]);
        vec3 n = normalize(cross(halfU, halfV));

        vec3 viewDir = - vec3(view[0][2], view[1][2], view[2][2]);

        float viewAngle = dot(viewDir, n);
        float minViewAngle = ${w.float(TEt)};

        if (abs(viewAngle) < minViewAngle) {
          // view direction is (almost) parallel to plane -> clamp it to min angle
          float normalComponent = sign(viewAngle) * minViewAngle - viewAngle;
          viewDir = normalize(viewDir + normalComponent * n);
        }

        // intersect view direction with infinite plane that contains bounding rect
        vec3 planeProjected = intersectRayPlane(viewDir, cameraPosition, n, center);

        // clip to bounds by projecting to u and v line segments individually
        vec3 uProjected = projectPointToLineSegment(center, halfU, planeProjected);
        vec3 vProjected = projectPointToLineSegment(center, halfV, planeProjected);

        // use to calculate the closest point to camera on bounding rect
        vec3 closestPoint = uProjected + vProjected - center;

        return length(closestPoint - cameraPosition);
      }
    `)),i.code.add(w`
    vec2 scaledUV() {
      vec2 uv = uvMapSpace.xy ${a?" * rotate45":""};
      vec2 uvCellOrigin = uvMapSpace.zw ${a?" * rotate45":""};

      ${t.draped?"":w`
            float distanceToCamera = boundingRectDistanceToCamera();
            float worldToScreenRatio = worldToScreenPerDistanceRatio / distanceToCamera;
          `}

      // Logarithmically discretize ratio to avoid jittering
      float step = 0.1;
      float discreteWorldToScreenRatio = log(worldToScreenRatio);
      discreteWorldToScreenRatio = ceil(discreteWorldToScreenRatio / step) * step;
      discreteWorldToScreenRatio = exp(discreteWorldToScreenRatio);

      vec2 uvOffset = mod(uvCellOrigin * discreteWorldToScreenRatio, ${w.float(t.patternSpacing)});
      return uvOffset + (uv * discreteWorldToScreenRatio);
    }
  `);const l=t.output===k.Depth;return l&&(e.include(N0,t),BT(e),J1(e)),i.code.add(w`
    void main(void) {
      vuv = scaledUV();
      vpos = position;
      ${r?"depth = (view * vec4(vpos, 1.0)).z;":""}
      forwardNormalizedVertexColor();
      ${t.hasVertexColors?"vColor *= uColor;":t.vvColor?"vColor = uColor * interpolateVVColor(colorFeatureAttribute);":"vColor = uColor;"}
      gl_Position = ${l?w`transformPositionWithDepth(proj, view, vpos, nearFar, linearDepth);`:w`transformPosition(proj, view, vpos);`}
    }
  `),e.include(Bs,t),s.include(kg),t.draped&&s.uniforms.add(new Ie("texelSize",(c,h)=>1/h.camera.pixelRatio)),t.output===k.Highlight&&e.include(J0,t),r&&e.include(Ah,t),t.output!==k.Highlight&&(s.code.add(w`
      const float lineWidth = ${w.float(t.lineWidth)};
      const float spacing = ${w.float(t.patternSpacing)};
      const float spacingINV = ${w.float(1/t.patternSpacing)};

      float coverage(float p, float txlSize) {
        p = mod(p, spacing);

        float halfTxlSize = txlSize / 2.0;

        float start = p - halfTxlSize;
        float end = p + halfTxlSize;

        float coverage = (ceil(end * spacingINV) - floor(start * spacingINV)) * lineWidth;
        coverage -= min(lineWidth, mod(start, spacing));
        coverage -= max(lineWidth - mod(end, spacing), 0.0);

        return coverage / txlSize;
      }
    `),t.draped||s.code.add(w`const int maxSamples = 5;
float sampleAA(float p) {
vec2 dxdy = abs(vec2(dFdx(p), dFdy(p)));
float fwidth = dxdy.x + dxdy.y;
ivec2 samples = 1 + ivec2(clamp(dxdy, 0.0, float(maxSamples - 1)));
vec2 invSamples = 1.0 / vec2(samples);
float accumulator = 0.0;
for (int j = 0; j < maxSamples; j++) {
if(j >= samples.y) {
break;
}
for (int i = 0; i < maxSamples; i++) {
if(i >= samples.x) {
break;
}
vec2 step = vec2(i,j) * invSamples - 0.5;
accumulator += coverage(p + step.x * dxdy.x + step.y * dxdy.y, fwidth);
}
}
accumulator /= float(samples.x * samples.y);
return accumulator;
}`)),s.code.add(w`
    void main() {
      discardBySlice(vpos);
      ${r?"terrainDepthTest(gl_FragCoord, depth);":""}
      vec4 color = vColor;
      color = highlightSlice(color, vpos);

      ${t.output!==k.Highlight?w`color.a *= ${EEt(t)};`:""}

      ${t.output===k.ObjectAndLayerIdColor?w`color.a = 1.0;`:""}

      if (color.a < ${w.float(ia)}) {
        discard;
      }

      ${t.output===k.Alpha?w`fragColor = vec4(color.a);`:""}

      ${t.output===k.Color?w`fragColor = color; ${t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}`:""}
      ${t.output===k.Highlight?w`outputHighlight();`:""}
      ${t.output===k.Depth?w`outputDepth(linearDepth);`:""};
    }
  `),e}function EEt(t){function e(r){return t.draped?w`coverage(vuv.${r}, texelSize)`:w`sampleAA(vuv.${r})`}switch(t.style){case ta.ForwardDiagonal:case ta.Horizontal:return e("y");case ta.BackwardDiagonal:case ta.Vertical:return e("x");case ta.DiagonalCross:case ta.Cross:return w`
        1.0 - (1.0 - ${e("x")}) * (1.0 - ${e("y")})
      `;default:return"0.0"}}const CEt=Object.freeze(Object.defineProperty({__proto__:null,build:SEt},Symbol.toStringTag,{value:"Module"}));let PDe=class $De extends Ur{initializeProgram(e){return new Lr(e.rctx,$De.shader.get().build(this.configuration),LDe)}_setPipelineState(e,r){const i=this.configuration,s=e===ut.NONE,n=e===ut.FrontFace;return It({blending:i.output===k.Color||i.output===k.Alpha?s?vh:Q0(e):null,culling:n8(i.cullFace),depthTest:{func:gb(e)},depthWrite:s?i.writeDepth?Ac:null:I8(e),colorWrite:Wt,stencilWrite:i.hasOccludees?Og:null,stencilTest:i.hasOccludees?r?nb:yb:null,polygonOffset:s||n?i.polygonOffset?AEt:null:L8(i.enableOffset)})}initializePipeline(){return this._occludeePipelineState=this._setPipelineState(this.configuration.transparencyPassType,!0),this._setPipelineState(this.configuration.transparencyPassType,!1)}getPipelineState(e,r){return r?this._occludeePipelineState:super.getPipelineState(e,r)}};PDe.shader=new $r(CEt,()=>J(()=>import("./Pattern.glsl-f3b0c9cf.js"),[],import.meta.url));const AEt={factor:1,units:1};let wo=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.cullFace=Ii.None,this.transparencyPassType=ut.NONE,this.hasSlicePlane=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.writeDepth=!0,this.hasOccludees=!1,this.enableOffset=!0,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.vvColor=!1}};u([B({count:k.COUNT})],wo.prototype,"output",void 0),u([B({count:Ii.COUNT})],wo.prototype,"cullFace",void 0),u([B({count:ta.COUNT})],wo.prototype,"style",void 0),u([B({count:ut.COUNT})],wo.prototype,"transparencyPassType",void 0),u([B()],wo.prototype,"hasSlicePlane",void 0),u([B()],wo.prototype,"hasVertexColors",void 0),u([B()],wo.prototype,"polygonOffset",void 0),u([B()],wo.prototype,"writeDepth",void 0),u([B()],wo.prototype,"hasOccludees",void 0),u([B()],wo.prototype,"patternSpacing",void 0),u([B()],wo.prototype,"lineWidth",void 0),u([B()],wo.prototype,"enableOffset",void 0),u([B()],wo.prototype,"draped",void 0),u([B()],wo.prototype,"hasMultipassTerrain",void 0),u([B()],wo.prototype,"cullAboveGround",void 0),u([B()],wo.prototype,"vvColor",void 0),u([B({constValue:!1})],wo.prototype,"hasVvInstancing",void 0),u([B({constValue:!1})],wo.prototype,"vvSize",void 0),u([B({constValue:!1})],wo.prototype,"vvOpacity",void 0);const LDe=new Map([[E.POSITION,0],[E.COLOR,3],[E.UVMAPSPACE,4],[E.COLORFEATUREATTRIBUTE,5],[E.BOUNDINGRECT,6]]);let Aie=class extends lie{constructor(e){super(e,new MEt),this.supportsEdges=!0,this._vertexAttributeLocations=LDe,this._configuration=new wo}getConfiguration(e,r){return this._configuration.output=e,this._configuration.cullFace=this.parameters.cullFace,this._configuration.hasVertexColors=this.parameters.hasVertexColors&&!this.parameters.vvColor,this._configuration.hasSlicePlane=this.parameters.hasSlicePlane,this._configuration.polygonOffset=this.parameters.polygonOffset,this._configuration.writeDepth=this.parameters.writeDepth,this._configuration.style=this.parameters.style,this._configuration.patternSpacing=this.parameters.patternSpacing,this._configuration.lineWidth=this.parameters.lineWidth,this._configuration.draped=this.parameters.draped,this._configuration.transparencyPassType=r.transparencyPassType,this._configuration.enableOffset=r.camera.relativeElevation<P8,this._configuration.hasMultipassTerrain=r.multipassTerrain.enabled,this._configuration.cullAboveGround=r.multipassTerrain.cullAboveGround,this._configuration.vvColor=!!this.parameters.vvColor,this._configuration}requiresSlot(e,r){return r===k.Color||r===k.Alpha||r===k.Highlight||r===k.Depth&&this.parameters.writeLinearDepth?e===fe.DRAPED_MATERIAL?!0:r===k.Highlight?e===fe.OPAQUE_MATERIAL:e===(this.parameters.writeDepth?fe.TRANSPARENT_MATERIAL:fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL):!1}createGLMaterial(e){return new OEt(e)}createBufferWriter(){const e=us().vec3f(E.POSITION).vec4f(E.UVMAPSPACE);return this.parameters.draped||e.mat3f(E.BOUNDINGRECT),this.parameters.vvColor?e.f32(E.COLORFEATUREATTRIBUTE):e.vec4u8(E.COLOR),new REt(e)}},OEt=class extends pb{_updateParameters(e){return this.ensureTechnique(PDe,e)}_updateOccludeeState(e){e.hasOccludees!==this._material.parameters.hasOccludees&&this._material.setParameters({hasOccludees:e.hasOccludees})}beginSlot(e){return this._output!==k.Color&&this._output!==k.Alpha||this._updateOccludeeState(e),this._updateParameters(e)}},REt=class extends IO{write(e,r,i,s,n){for(const o of this.vertexBufferLayout.fields.keys()){const a=i.vertexAttributes.get(o),l=i.indices.get(o);if(a&&l)switch(o){case E.UVMAPSPACE:{it(a.size===4);const c=s.getField(o,Ff);c&&FA(l,a.data,c,n);break}case E.BOUNDINGRECT:{it(a.size===9);const c=s.getField(o,Q1);c&&this.writeBoundingRect(l,a.data,e,c,n);break}default:sPe(o,a,l,e,r,s,n)}}}writeBoundingRect(e,r,i,s,n){const o=i,a=s.typedBuffer,l=s.typedBufferStride,c=e.length;n*=l;for(let h=0;h<c;++h){const p=9*e[h],f=r[p],m=r[p+1],g=r[p+2];a[n]=o[0]*f+o[4]*m+o[8]*g+o[12],a[n+1]=o[1]*f+o[5]*m+o[9]*g+o[13],a[n+2]=o[2]*f+o[6]*m+o[10]*g+o[14];for(let _=3;_<9;++_)a[n+_]=r[p+_];n+=l}}},MEt=class extends D${constructor(){super(...arguments),this.color=Vt(1,1,1,1),this.writeDepth=!0,this.writeLinearDepth=!1,this.hasVertexColors=!1,this.polygonOffset=!1,this.hasSlicePlane=!1,this.cullFace=Ii.None,this.hasOccludees=!1,this.style=ta.Cross,this.patternSpacing=10,this.lineWidth=1,this.draped=!0}};function IEt(t,e){const r=t?.pattern??null;return r==null?new Jfe(e):r.style==="none"||r.style==="solid"?(r.style==="none"&&(e.color=Vt(0,0,0,0),e.transparent=!0),new Jfe(e)):(e.style=PEt(r.style),new Aie(e))}function PEt(t){switch(t){case"horizontal":return ta.Horizontal;case"vertical":return ta.Vertical;case"cross":return ta.Cross;case"forward-diagonal":return ta.ForwardDiagonal;case"backward-diagonal":return ta.BackwardDiagonal;case"diagonal-cross":return ta.DiagonalCross;default:return}}function $Et(t){return t.material instanceof Aie&&!t.material.parameters.draped}function LEt(t,e){if($Et(t)){const r=t.vertexAttributes.get(E.POSITION).data,i=t.getMutableAttribute(E.UVMAPSPACE).data,s=t.getMutableAttribute(E.BOUNDINGRECT).data;RDe(i,s,r,e)}}function DEt(t,e,r,i,s){const n=BPe(t,e,r,i,s),o=t.stageObject.geometries;for(const a of o)LEt(a,s);return n}const NEt=["polyline","polygon","extent"],Kfe=new L$({size:!1,color:!0,rotation:!1,opacity:!1});let DDe=class NDe extends Vg{constructor(e,r,i,s){super(e,r,i,s),this._needsUV=!1,this._hasOutline=!1}async doLoad(){this._fastUpdates=kA(this._context.renderer,Kfe)}_ensureMaterials(){this._ensureFillMaterial(),this._ensureOutlineMaterial()}_ensureFillMaterial(){if(this._material!=null)return;const e=this.symbolLayer?.material?.color,r=this._getCombinedOpacityAndColor(e);this._material=IEt(this.symbolLayer,{color:r,transparent:r[3]<1||this.needsDrivenTransparentPass,polygonOffset:!1,hasVertexColors:!0,writeLinearDepth:!0,draped:this.draped,hasSlicePlane:this._context.slicePlaneEnabled,...this._fastUpdates?.materialParameters}),this._needsUV=this._material instanceof Aie,this._context.stage.add(this._material)}_ensureOutlineMaterial(){const e=this.symbolLayer.outline;if(this._outlineMaterial||!this._isValidOutline(e))return;this._hasOutline=!0;const r=i=>{const s=jLe(e.pattern);return new uC({width:i,color:this._getOutlineColor(),hasPolygonOffset:!0,hasSlicePlane:this._context.slicePlaneEnabled,isClosed:!0,stipplePattern:s,stippleScaleWithLineWidth:!0,cap:zY(e.patternCap||"butt")})};this._outlineMaterial=r(vi(e.size)),this._context.stage.add(this._outlineMaterial)}_isValidOutline(e){return e!=null&&e.size!=null&&e.size>0&&e.color!=null&&(e.pattern==null||e.pattern.type!=="style"||e.pattern.style!=="none")}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null,this._context.stage.remove(this._outlineMaterial),this._outlineMaterial=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,NEt,this.symbolLayer.type))return null;const i=this._getVertexOpacityAndColor(e.renderingInfo,255),s=this.setGraphicElevationContext(r,new Gf);return this.ensureDrapedStatus(s.mode==="on-the-ground"),this._ensureMaterials(),this.draped?this._createAsOverlay(r,i):this._createAs3DShape(r,i,s)}applyRendererDiff(e,r){for(const i in e.diff){if(i!=="visualVariables"||!UA(this._fastUpdates,r,Kfe))return on.RecreateSymbol;this._material&&this._material.setParameters(this._fastUpdates.materialParameters)}return on.FastUpdate}layerOpacityChanged(){if(this._material!=null){const e=this._material.parameters.color,r=this.symbolLayer?.material?.color,i=this._getCombinedOpacity(r);this._material.setParameters({color:[e[0],e[1],e[2],i],transparent:i<1||this.needsDrivenTransparentPass})}if(this._outlineMaterial!=null){const e=this._outlineMaterial.parameters.color;this._outlineMaterial.setParameters({color:[e[0],e[1],e[2],this._getOutlineOpacity()]})}}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=N$(NDe.elevationModeChangeTypes,i,s);if(n!==Is.UPDATE)return n;const o=Qd(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){if(this._material&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),this._outlineMaterial){const e={hasSlicePlane:this._context.slicePlaneEnabled};this._outlineMaterial.setParameters(e)}return!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,r,i){const s=CP(e.geometry);if(!s)return null;const n=yie(s,this._context.elevationProvider,this._context.renderCoordsHelper,i),o=new FEt(n,r,this._context.layer.uid,e.uid),a=o.renderData.position.length/3;if(this._needsUV&&(o.uvMapSpace=vs(4*a,!0),o.boundingRect=Ra(9*a,!0),RDe(o.uvMapSpace,o.boundingRect,o.renderData.position,this._context.renderCoordsHelper)),o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),this._createAs3DShapeFill(e,o),this._hasOutline&&this._createAs3DShapeOutline(o),this._logGeometryCreationWarnings(o.renderData,s.rings,"rings","FillSymbol3DLayer"),o.outGeometries.length===0)return null;const l=new K0({geometries:o.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:e.uid}),c=new Ug(this,l,o.outGeometries,null,null,DEt,i);return c.alignedSampledElevation=o.renderData.sampledElevation,c.needsElevationUpdates=Qd(i.mode),c}_createAs3DShapeFill(e,r){const i=r.renderData.polygons;for(const{position:s,mapPositions:n,holeIndices:o,index:a,count:l}of i){if(this._context.clippingExtent!=null&&(Gi(yp),fh(yp,n),!cf(yp,this._context.clippingExtent)))continue;const c=zA(n,o,3);if(c.length===0)continue;const h=this._fastUpdates?.visualVariables.color,p=bpe({material:this._material,indices:c,mapPositions:n,attributeData:{position:s,color:h?null:r.color,colorFeature:h?Sf(h.field,e):null,uvMapSpace:this._needsUV?bU(r.uvMapSpace,4*a,4*l):null,boundingRect:this._needsUV?Fd(r.boundingRect,9*a,9*l):null,objectAndLayerIdColor:r.objectAndLayerIdColor}});r.outGeometries.push(p)}}_createAs3DShapeOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{mapPositions:s,position:n}=r[i];if(this._context.clippingExtent!=null&&(Gi(yp),fh(yp,s),!cf(yp,this._context.clippingExtent)))continue;const o=BY(this._outlineMaterial,{overlayInfo:null,removeDuplicateStartEnd:!0,mapPositions:s,attributeData:{position:n}},e.objectAndLayerIdColor);e.outGeometries.push(o)}}_createAsOverlay(e,r){const i=CP(e.geometry);if(i==null)return null;this._material.renderPriority=this._renderPriority+this._renderPriorityStep/2,this._outlineMaterial!=null&&(this._outlineMaterial.renderPriority=this._renderPriority);const s=vLe(i,this._context.overlaySR),n=new kEt(s,r,this._context.layer.uid,e.uid),o=n.renderData.position.length/3;return this._needsUV&&(n.uvMapSpace=vs(4*o,!0),fEt(n.uvMapSpace,n.renderData.position,this._context.overlaySR,this._context.graphicsCoreOwner.view.state.viewingMode)),n.outBoundingBox=Gi(),n.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(n),this._createAsOverlayFill(e,n),this._hasOutline&&this._createAsOverlayOutline(n),this._logGeometryCreationWarnings(n.renderData,i.rings,"rings","FillSymbol3DLayer"),n.outGeometries.length===0?null:new q8(this,n.outGeometries,n.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayFill(e,r){const i=r.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of i){const l=Gi(yp);if(fh(l,s),!cf(l,this._context.clippingExtent))continue;const c=zA(s,n,3);if(c.length===0)continue;aA(r.outBoundingBox,l);const h=this._fastUpdates?.visualVariables.color,p=bpe({material:this._material,indices:c,attributeData:{position:s,color:h?null:r.color,colorFeature:h?Sf(h.field,e):null,uvMapSpace:this._needsUV?bU(r.uvMapSpace,4*o,4*a):null,objectAndLayerIdColor:r.objectAndLayerIdColor}});r.outGeometries.push(new jA(p,r))}}_createAsOverlayOutline(e){if(!this._hasOutline)return;const r=e.renderData.outlines;for(let i=0;i<r.length;++i){const{position:s}=r[i];if(Gi(yp),fh(yp,s),!cf(yp,this._context.clippingExtent))continue;aA(e.outBoundingBox,yp);const n=BY(this._outlineMaterial,{overlayInfo:{spatialReference:this._context.overlaySR,renderCoordsHelper:this._context.renderCoordsHelper},removeDuplicateStartEnd:!0,attributeData:{position:s}},e.objectAndLayerIdColor);e.outGeometries.push(new jA(n,e))}}_getOutlineOpacity(){const e=this.symbolLayer?.outline?.color;return(this.draped?1:this._getLayerOpacity())*(e!=null?e.a:0)}_getOutlineColor(){const e=this.symbolLayer?.outline?.color,r=this._getOutlineOpacity();return mI(e!=null?Le.toUnitRGB(e):null,r)}test(){return{...super.test(),createAsOverlay:(e,r)=>this._createAsOverlay(e,r),createAs3DShape:(e,r,i)=>this._createAs3DShape(e,r,i)}}};DDe.elevationModeChangeTypes={definedChanged:Is.RECREATE,staysOnTheGround:Is.NONE,onTheGroundChanged:Is.RECREATE};const yp=Gn();let FEt=class extends z8{constructor(e,r,i,s){super(e,i,s),this.color=r}},kEt=class extends z8{constructor(e,r,i,s){super(e,i,s),this.color=r}};const UEt="arial-unicode-ms",eme="woff2",tme=new Map,FDe=new Set;let VEt=class{constructor(e,r){this.fontFace=e,this.promise=r}};async function zEt(t){const e=jEt(t),r=tme.get(e);if(r)return r.promise;const i=new FontFace(t.family,`url('${qr.fontsUrl}/woff2/${e}.${eme}') format('${eme}')`,{style:t.style,weight:t.weight}),s=document.fonts;if(s.has(i)&&i.status==="loading")return i.loaded;const n=i.load().then(()=>(s.add(i),i));return tme.set(e,new VEt(i,n)),FDe.add(i),n}function BEt(t){return FDe.has(t)}function GEt(t){if(!t)return UEt;const e=t.toLowerCase().split(" ").join("-");switch(e){case"serif":return"noto-serif";case"sans-serif":return"arial-unicode-ms";case"monospace":return"ubuntu-mono";case"fantasy":return"cabin-sketch";case"cursive":return"redressed";default:return e}}function jEt(t){const e=HEt(t)+qEt(t);return GEt(t.family)+(e.length>0?e:"-regular")}function HEt(t){if(!t.weight)return"";switch(t.weight.toLowerCase()){case"bold":case"bolder":return"-bold"}return""}function qEt(t){if(!t.style)return"";switch(t.style.toLowerCase()){case"italic":case"oblique":return"-italic"}return""}let kDe=class UDe{constructor(e){this.definition=e,this.key=JSON.stringify(e),this.haloSize=Math.round(e.halo.size),this.textStyle=this._colorToRGBA(e.color),this.haloStyle=this._colorToRGB(e.halo.color),this.backgroundStyle=e.background.color[3]!==0?this._colorToRGBA(e.background.color):null}fontString(e){const r=this.definition.font;return`${r.style} ${r.weight} ${e}px ${r.family}, sans-serif`}_colorToRGB(e){return`rgb(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()})`}_colorToRGBA(e){return`rgba(${e.slice(0,3).map(r=>Math.floor(255*r)).toString()},${e[3]})`}static async fromSymbol(e,r){const i=e?.material?.color,s=Le.toUnitRGBA(i)??ng,n=e.size!=null?vi(e.size):12,o=e.lineHeight,a=e.background!=null?Le.toUnitRGBA(e.background.color):ng,l={family:e.font?.family??"sans-serif",decoration:e.font?.decoration??"none",weight:e.font?.weight??"normal",style:e.font?.style??"normal"},c=e.halo,h=c!=null&&c.color!=null&&c.size>0?{size:vi(c.size),color:Le.toUnitRGBA(c.color)}:{size:0,color:ng},p=new UDe({color:s,size:n,background:{color:a,padding:e.background!=null?[.65*n,.5*n]:[0,0],borderRadius:e.background!=null?n*(6/16):0},lineSpacingFactor:o,font:l,halo:h,pixelRatio:r});if(e.font){let f=!1;const m=p.fontString(n);try{f=(await document.fonts.load(m)).some(g=>!BEt(g))}catch{K.getLogger("esri.views.3d.webgl-engine.lib.TextRenderParameters").warnOnce(`Failed to preload font '${m}'. Some text symbology may be rendered using the default browser font.`)}if(!f&&!WEt.has(e.font.family))try{await zEt(e.font)}catch{}}return p}};const WEt=new Set(["Arial","Times New Roman","Courier New","serif","sans-serif","monospace","cursive","fantasy","system-ui","ui-serif","ui-sans-serif","ui-monospace","ui-rounded","math","emoji","fangsong"]);let ZEt=class{constructor(e,r,i){this._renderer=new NLe(e,r,i)}get key(){return this._renderer.key}get baselineAnchorY(){return 1-this._renderer.firstRenderedBaselinePosition/this._renderer.renderedHeight}get displayWidth(){return this._renderer.displayWidth}get displayHeight(){return this._renderer.displayHeight}create(){const e=UY(XEt,this._renderer.renderedWidth,this._renderer.renderedHeight),r=e.getContext("2d");return r.save(),this._renderer.render(r,0,0),r.restore(),new wS(e,{wrap:{s:Ut.CLAMP_TO_EDGE,t:Ut.CLAMP_TO_EDGE},noUnpackFlip:!1,mipmap:!0,preMultiplyAlpha:!0})}};const XEt={canvas:null},YEt=[0,0,1];let JEt=class extends Vg{constructor(e,r,i,s){super(e,r,i,s),this._elevationOptions={supportsOffsetAdjustment:!0,supportsOnTheGround:!1},this.ensureDrapedStatus(!1)}async doLoad(){if(!this._drivenProperties.size){const e=D8(this.symbolLayer.size);if(e)throw new D("graphics3dtextsymbollayer:invalid-size",e)}await this._createTextRenderParameters()}async _createTextRenderParameters(){const e=this._context.graphicsCoreOwner.view.state.rasterPixelRatio;this._textRenderParameters=await kDe.fromSymbol(this.symbolLayer,e)}destroy(){super.destroy()}createGraphics3DGraphic(e){const r=e.graphic,i=EP(r.geometry);if(i==null)return this.logger.warn(`unsupported geometry type for text symbol: ${r.geometry.type}`),null;const s=this.symbolLayer.text;if(s==null||s==="")return null;const n=TK(this.symbol)&&this.symbol.hasVisibleVerticalOffset()?this.symbol.verticalOffset:null;if(n!=null&&!Mxe(this.symbolLayer))return this.logger.errorOncePerTick(`Callouts and vertical offset on text symbols are currently only supported with 'center' horizontal alignment (not with '${this.symbolLayer.horizontalAlignment}' alignment)`),null;const o=new UPe(n,this.symbolLayer.horizontalAlignment,Uxt(this.symbolLayer.verticalAlignment));return this._createAs3DShape(r,i,s,o)}createLabel(e,r,i,s){const n=e.graphic,o=EP(n.geometry);if(o==null)return this.logger.warn(`unsupported geometry type for label: ${n.geometry.type}`),null;const a=r.text;return!a||/^\s+$/.test(a)?null:this._createAs3DShape(n,o,a,r,i,s)}setGraphicElevationContext(e,r,i=0){const s=super.setGraphicElevationContext(e,r);return s.addOffsetRenderUnits(i),s}layerOpacityChanged(){return this.logger.warn("layer opacity change not yet implemented in Graphics3DTextSymbolLayer"),!1}layerElevationInfoChanged(e,r){return rme(e,r,(i,s)=>{this.updateGraphicElevationContext(s,i)}),Is.UPDATE}slicePlaneEnabledChanged(e,r){return rme(e,r,i=>{for(const s of i.stageObject.geometries)s.material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled})}),!0}physicalBasedRenderingChanged(){return!0}get pixelRatioChanged(){return!1}updateGraphicElevationContext(e,r){const i=r.elevationContext;this.setGraphicElevationContext(e,i,r.metadata!=null?r.metadata.elevationOffset:0),r.needsElevationUpdates=Qd(i.mode)||i.mode==="absolute-height"}_defaultElevationInfoNoZ(){return KEt}_createAs3DShape(e,r,i,s,n,o){const a=this.setGraphicElevationContext(e,new Gf,s.elevationOffset),l=e.geometry?.type==="polyline",c=e.uid;let h=null,p=null;if(o==null){const P=kLe(s.horizontalPlacement);h=new ZEt(i,P,this._textRenderParameters);let F=null;if(this._context.sharedResources.textures!=null){p=this._context.sharedResources.textures.fromData(h.key,()=>h.create(),()=>{F?.release()});const $=this._context.stage.renderView.textureRepository.acquire(p.texture.id);if($==null||Rh($))return p.release(),null;F=$}}const f=QEt(h,s),m={occlusionTest:!0,screenOffset:s.screenOffset,anchorPosition:f,polygonOffset:!0,color:[1,1,1,1],centerOffsetUnits:s.centerOffsetUnits,drawInSecondSlot:!0};if(o!=null?m.textureId=o.id:p!=null&&(m.textureId=p.texture.id),s.verticalOffset!=null){const{screenLength:P,minWorldLength:F,maxWorldLength:$}=s.verticalOffset;m.verticalOffset={screenLength:vi(P),minWorldLength:F||0,maxWorldLength:$??1/0}}if(this._context.screenSizePerspectiveEnabled){const{screenSizePerspectiveSettings:P,screenSizePerspectiveSettingsLabels:F}=this._context.sharedResources;m.screenSizePerspective=F.overridePadding(this._textRenderParameters.haloSize+this._textRenderParameters.definition.background.padding[0]),m.screenSizePerspectiveAlignment=P}let g;if(l&&(m.shaderPolygonOffset=1e-4),m.hasSlicePlane=this._context.slicePlaneEnabled,n!=null){const P=JSON.stringify(m);g=n.get(P),g==null&&(g=new VA(m),n.add(P,g))}else g=new VA(m);const _=s.translation,v=h?yr(h.displayWidth,h.displayHeight):Df,b=s.centerOffset,x=JX(g,YEt,_,null,v,b,[0,0],null),T=Xre(this._context,r,x,a,c);if(T==null)return null;const S=new Ug(this,T.object,[x],n==null?[g]:null,p,uT,a);S.alignedSampledElevation=T.sampledElevation,S.needsElevationUpdates=Qd(a.mode)||a.mode==="absolute-height";const{displayWidth:O,displayHeight:A}=h??s;S.getScreenSize=(P=Pe())=>(P[0]=O,P[1]=A,P);const M=new XPe(s.elevationOffset,i);return S.metadata=M,SP(S,r,this._context.elevationProvider),S}};function rme(t,e,r){t&&t.forEach(i=>{const s=e(i);s!=null&&r(s,i.graphic)})}function QEt(t,e){if(e.verticalPlacement==="baseline"){const i=Nxt[e.horizontalPlacement],s=t!=null?t.baselineAnchorY:0;return yr(i,s)}const r=kxt(e.horizontalPlacement,e.verticalPlacement);return h5[r]}const KEt={mode:"relative-to-ground",offset:0},eCt={"calm-small":{waveStrength:.005,perturbationStrength:.02,textureRepeat:12,waveVelocity:.01},"rippled-small":{waveStrength:.02,perturbationStrength:.09,textureRepeat:32,waveVelocity:.07},"slight-small":{waveStrength:.05,perturbationStrength:.07,textureRepeat:28,waveVelocity:.1},"moderate-small":{waveStrength:.075,perturbationStrength:.07,textureRepeat:24,waveVelocity:.1},"calm-medium":{waveStrength:.003125,perturbationStrength:.01,textureRepeat:8,waveVelocity:.02},"rippled-medium":{waveStrength:.035,perturbationStrength:.015,textureRepeat:12,waveVelocity:.07},"slight-medium":{waveStrength:.06,perturbationStrength:.015,textureRepeat:8,waveVelocity:.12},"moderate-medium":{waveStrength:.09,perturbationStrength:.03,textureRepeat:4,waveVelocity:.12},"calm-large":{waveStrength:.01,perturbationStrength:0,textureRepeat:4,waveVelocity:.05},"rippled-large":{waveStrength:.025,perturbationStrength:.01,textureRepeat:8,waveVelocity:.11},"slight-large":{waveStrength:.06,perturbationStrength:.02,textureRepeat:3,waveVelocity:.13},"moderate-large":{waveStrength:.14,perturbationStrength:.03,textureRepeat:2,waveVelocity:.15}},tCt=["polyline","polygon","extent"];let qY=class cx extends Vg{constructor(e,r,i,s){super(e,r,i,s)}async doLoad(){}destroy(){super.destroy(),this._context.stage.remove(this._material),this._material=null}createGraphics3DGraphic(e){const r=e.graphic;if(!this._validateGeometry(r.geometry,tCt,this.symbolLayer.type))return null;const i=this.setGraphicElevationContext(r,new Gf);return this.ensureDrapedStatus(i.mode==="on-the-ground"),this.ensureMaterial(),this.draped?this._createAsOverlay(r):this._createAs3DShape(r,i,r.uid)}ensureMaterial(){if(this._material!=null)return;const e=new cLe,r=this.symbolLayer.color;r!=null&&(e.color=Le.toUnitRGBA(r));const i=this._getCombinedOpacity(r,{hasIntrinsicColor:!0});e.color=[e.color[0],e.color[1],e.color[2],i],e.transparent=i<1||this.needsDrivenTransparentPass,e.waveDirection=this.symbolLayer.waveDirection!=null?cx.headingVectorFromAngle(this.symbolLayer.waveDirection):yr(0,0);const s=this.symbolLayer.waveStrength+"-"+this.symbolLayer.waterbodySize,n=eCt[s];e.waveStrength=n.waveStrength,e.waveTextureRepeat=n.textureRepeat,e.waveVelocity=n.waveVelocity,e.flowStrength=n.perturbationStrength,e.hasSlicePlane=this._context.slicePlaneEnabled,e.isDraped=this.draped,this._material=new lLe(e),this._context.stage.add(this._material)}layerOpacityChanged(){if(this._material==null)return;const e=this._material.parameters.color,r=this._getCombinedOpacity(this.symbolLayer.color,{hasIntrinsicColor:!0}),i=r<1||this.needsDrivenTransparentPass;this._material.setParameters({color:[e[0],e[1],e[2],r],transparent:i})}layerElevationInfoChanged(e,r,i){const s=this._elevationContext.mode,n=N$(cx.elevationModeChangeTypes,i,s);if(n!==Is.UPDATE)return n;const o=Qd(s);return this.updateGraphics3DGraphicElevationInfo(e,r,()=>o)}slicePlaneEnabledChanged(){return this._material!=null&&this._material.setParameters({hasSlicePlane:this._context.slicePlaneEnabled}),!0}physicalBasedRenderingChanged(){return!0}_createAs3DShape(e,r,i){const s=CP(e.geometry);if(s==null)return null;const n=yie(s,this._context.elevationProvider,this._context.renderCoordsHelper,r),o=n.position.length/3,a=Ra(2*o);this._createUVCoordsFromVertices(a,n.mapPositions,o,this._context.elevationProvider.spatialReference);const l=new rCt(n,a,this._context.layer.uid,e.uid);if(l.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(l),this._create3DShapeGeometries(l),this._logGeometryCreationWarnings(l.renderData,s.rings,"rings","WaterSymbol3DLayer"),l.outGeometries.length===0)return null;const c=new K0({geometries:l.outGeometries,castShadow:!1,layerUid:this._context.layer.uid,graphicUid:i}),h=new Ug(this,c,l.outGeometries,null,null,BPe,r);return h.alignedSampledElevation=l.renderData.sampledElevation,h.needsElevationUpdates=Qd(r.mode),h}_createUVCoordsFromVertices(e,r,i,s){const n=Uo(s);Au(L_);for(let l=0;l<i;l++)hr(ime,r[3*l],r[3*l+1]),xC(L_,ime);AT(L_,L_,n);const o=L_[0]%cx.unitSizeOfTexture,a=L_[1]%cx.unitSizeOfTexture;kN[0]=L_[0]-o,kN[1]=L_[1]-a;for(let l=0;l<i;l++)e[2*l]=(r[3*l]*n-kN[0])/cx.unitSizeOfTexture,e[2*l+1]=(r[3*l+1]*n-kN[1])/cx.unitSizeOfTexture}_create3DShapeGeometries(e){const r=e.renderData.polygons,i=e.uvCoords;for(const{count:s,index:n,position:o,mapPositions:a,holeIndices:l}of r){if(this._context.clippingExtent!=null&&(Gi(iw),fh(iw,a),!cf(iw,this._context.clippingExtent)))continue;const c=zA(a,l,3);if(c.length===0)continue;const h=Fd(i,2*n,2*s),p=wpe({material:this._material,indices:c,mapPositions:a,attributeData:{position:o,uv0:h}},e.objectAndLayerIdColor);e.outGeometries.push(p)}}_createAsOverlay(e){const r=CP(e.geometry);if(r==null)return null;this._material.renderPriority=this._renderPriority;const i=vLe(r,this._context.overlaySR),s=i.position.length/3,n=Ra(2*s);this._createUVCoordsFromVertices(n,i.position,s,this._context.overlaySR);const o=new iCt(i,n,this._context.layer.uid,e.uid);return o.objectAndLayerIdColor=this._context.stage.renderView?.getObjectAndLayerIdColor(o),o.outBoundingBox=Gi(),this._createAsOverlayWater(o),this._logGeometryCreationWarnings(o.renderData,r.rings,"rings","WaterSymbol3DLayer"),o.outGeometries.length===0?null:new q8(this,o.outGeometries,o.outBoundingBox,this._context.drapeSourceRenderer)}_createAsOverlayWater(e){const r=e.uvCoords,i=e.renderData.polygons;for(const{position:s,holeIndices:n,index:o,count:a}of i){if(Gi(iw),fh(iw,s),!cf(iw,this._context.clippingExtent))continue;aA(e.outBoundingBox,iw);const l=zA(s,n,3);if(l.length===0)continue;const c=Fd(r,2*o,2*a),h=wpe({material:this._material,indices:l,attributeData:{position:s,uv0:c}},e.objectAndLayerIdColor);e.outGeometries.push(new jA(h,e))}}static headingVectorFromAngle(e){const r=Pe(),i=D6(e);return r[0]=Math.sin(i),r[1]=Math.cos(i),r}test(){return{...super.test(),create3DShape:e=>this._createAs3DShape(e.graphic,e.elevationContext,e.graphicUid),ensureMaterial:()=>this.ensureMaterial()}}};qY.unitSizeOfTexture=100,qY.elevationModeChangeTypes={definedChanged:Is.RECREATE,staysOnTheGround:Is.NONE,onTheGroundChanged:Is.RECREATE};const kN=Pe(),L_=Ht(),ime=Pe(),iw=Gn();let rCt=class extends z8{constructor(e,r,i,s){super(e,i,s),this.uvCoords=r}},iCt=class extends z8{constructor(e,r,i,s){super(e,i,s),this.uvCoords=r}};function sCt(t,e,r,i){const s=oCt[t.type]?.[e.type]||nCt[e.type];return s?new s(t,e,r,i):(K.getLogger("esri.views.3d.layers.graphics.Graphics3DSymbolLayerFactory").error("GraphicsLayerFactory#make",`unknown symbol type ${e.type}`),null)}const nCt={icon:VY,object:c2t,line:HLe,path:hEt,fill:DDe,extrude:wxt,text:JEt,water:qY},oCt={"mesh-3d":{fill:qTt}};let aCt=class extends qre{set symbol(e){this._symbol=e,e.symbolLayers.forEach((r,i)=>{const s=this.symbolLayers[i];s!=null&&(s.symbol=e,s.symbolLayer=r)})}get symbol(){return this._symbol}constructor(e,r,i){super(r.schedule),this._symbol=e,this._context=r,this._backgroundLayers=i,this._destroyed=!1,this.symbolLayers=new Array,this.referenced=0,this._extentPadding=0}async doLoad(e){let r=this._symbol.symbolLayers;this._extentPadding=0,this._backgroundLayers&&(r=this._backgroundLayers.concat(r));const i=r.length;for(;this.symbolLayers.length<r.length;)this.symbolLayers.push(null);this.symbolLayers.length=r.length;const s=[];for(let n=0;n<i;n++){const o=r.at(n);if(o.enabled===!1)continue;UN.renderPriority=1-(1+n)/i,UN.renderPriorityStep=1/i,UN.ignoreDrivers=o.ignoreDrivers;const a=sCt(this.symbol,o,this._context,UN),l=jJ(e,()=>{this.symbolLayers[n]=null,a.destroy()});l&&s.push(l),this.symbolLayers[n]=a}if(await OV(this.symbolLayers,async(n,o)=>{if(n!=null)try{await n.load(),this._extentPadding+=Math.max(this._extentPadding,n.extentPadding)}catch{this.symbolLayers[o]=null}}),s.forEach(n=>n.remove()),Dt(e),this.symbolLayers.length&&!this.symbolLayers.some(n=>!!n))throw new Error}getSymbolLayerSize(e){const r=this.symbolLayers[e];return r!=null?r.getCachedSize():null}get extentPadding(){return this._extentPadding}get symbologySnappingSupported(){return this.symbolLayers.some(e=>e!=null&&e.queryForSnapping)}createGraphics3DGraphic(e,r){const i=e.graphic,s=this.symbolLayers.map(o=>o?.createGraphics3DGraphic(e)??null),n=this._context.arcade||this._context.featureExpressionInfoContext&&this._context.featureExpressionInfoContext.arcade&&this._context.featureExpressionInfoContext.arcade.modules||null;return new B1t(i,r||this,s,e.layer,n)}get complexity(){return Zre(this.symbolLayers.map(e=>e!=null?e.complexity:null))}globalPropertyChanged(e,r){const i=this.symbolLayers.length;for(let s=0;s<i;s++){const n=this.symbolLayers[s],o=a=>{const l=a.layers[s];return l instanceof Ug?l:null};if(n!=null&&!n.globalPropertyChanged(e,r,o))return!1}return!0}applyRendererDiff(e,r){return this.loadStatus!==oh.LOADED?on.RecreateSymbol:this.symbolLayers.reduce((i,s)=>i!==on.RecreateSymbol&&s!=null?Math.min(i,s.applyRendererDiff(e,r)):i,on.FastUpdate)}prepareSymbolPatch(e){if(this.loadStatus===oh.FAILED||e.diff.type!=="partial")return;const r=e.diff.diff;if(!r.symbolLayers||r.symbolLayers.type!=="partial")return;const i=r.symbolLayers.diff;this.symbolLayers.forEach((s,n)=>{if(s==null)return;const o=i[n];if(o){const a={diff:o,graphics3DGraphicPatches:[],symbolLayerStatePatches:[]};s.prepareSymbolLayerPatch(a),e.symbolStatePatches.push(...a.symbolLayerStatePatches),a.graphics3DGraphicPatches.length&&e.graphics3DGraphicPatches.push((l,c)=>{const h=l.layers[n];h!=null&&a.graphics3DGraphicPatches.forEach(p=>p(h,c))})}})}updateGeometry(e,r){return this._updateGeometryOrTransform(e,(i,s)=>i.updateGeometry(s,r))}updateTransform(e,r,i,s){return this._updateGeometryOrTransform(e,(n,o)=>n.updateTransform(o,r,i,s))}_updateGeometryOrTransform(e,r){for(let i=0;i<this.symbolLayers.length;i++){const s=this.symbolLayers[i];if(s==null)continue;const n=e.layers[i];if(!n||!r(s,n))return!1}return!0}onRemoveGraphic(e){for(let r=0;r<this.symbolLayers.length;r++){const i=this.symbolLayers[r];if(i==null)continue;const s=e.layers[r];s!=null&&i.onRemoveGraphic(s)}}getFastUpdateStatus(){let e=0,r=0,i=0;return this.symbolLayers.forEach(s=>{s!=null&&(s.loadStatus===oh.LOADING?e++:s.isFastUpdatesEnabled()?i++:r++)}),{loading:e,slow:r,fast:i}}async queryForSnapping(e,r,i,s){const n=this.symbolLayers.filter(Ia).filter(a=>a.queryForSnapping!=null).map(a=>a.queryForSnapping(e,r,i,s)),o=await Promise.all(n);return Dt(s),o.flat()}destroy(){if(this.destroyed)console.error("Graphics3DSymbol.destroy called when already destroyed!");else{super.destroy();for(const e of this.symbolLayers)e?.destroy();this.symbolLayers.length=0,this._destroyed=!0}}get destroyed(){return this._destroyed}};const UN=new G1t;let lCt=class extends qre{constructor(e,r,i){super(r),this.symbol=e,this._convert=i,this.symbologySnappingSupported=!1,this.graphics3DSymbol=null,this.referenced=0}getSymbolLayerSize(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getSymbolLayerSize(e):null}get symbolLayers(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.symbolLayers:[]}get extentPadding(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.extentPadding:0}async doLoad(e){const r=await this.symbol.fetchSymbol({signal:e});r.id=this.symbol.id,this.graphics3DSymbol=this._convert(r),this.graphics3DSymbol!=null&&await this.graphics3DSymbol.load()}createGraphics3DGraphic(e){return this.graphics3DSymbol!=null?this.graphics3DSymbol.createGraphics3DGraphic(e,this):null}get complexity(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.complexity:Wre}globalPropertyChanged(e,r){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.globalPropertyChanged(e,r)}applyRendererDiff(e,r){return this.graphics3DSymbol!=null?this.graphics3DSymbol.applyRendererDiff(e,r):on.RecreateSymbol}prepareSymbolPatch(e){this.graphics3DSymbol!=null&&this.graphics3DSymbol.prepareSymbolPatch(e)}updateGeometry(e,r){return this.graphics3DSymbol!=null&&this.graphics3DSymbol.updateGeometry(e,r)}updateTransform(e,r,i,s){return this.graphics3DSymbol?.updateTransform(e,r,i,s)??!1}onRemoveGraphic(){}getFastUpdateStatus(){return this.graphics3DSymbol!=null?this.graphics3DSymbol.getFastUpdateStatus():{loading:1,fast:0,slow:0}}destroy(){this.graphics3DSymbol!=null&&this.graphics3DSymbol.destroy(),this.graphics3DSymbol=void 0,super.destroy()}get destroyed(){return this.graphics3DSymbol===void 0}};function Oie(t){return t instanceof lCt?t.graphics3DSymbol:t instanceof aCt?t:null}const RP=K.getLogger("esri.views.3d.layers.graphics.labelPlacement");function cCt(t){const e=_Ct(t);if(e==null)return null;const r=uCt(t,e);if(r==null)return null;const i=r.anchor,s=!!e.hasLabelVerticalOffset;return dCt({anchor:i,verticalOffset:e.verticalOffset,screenOffset:Pe(),centerOffset:Vt(0,0,0,-1),centerOffsetUnits:"world",translation:C(),elevationOffset:0,hasLabelVerticalOffset:s},r,t)}function uCt(t,e){if(e.anchor)return e;const r=t.labelClass.labelPlacement,i=gf[r],s=i||r6(t);return r&&!i&&RP.warnOncePerTick(`the requested label placement '${r}' is currently unsupported in SceneView.`),hCt(s,t)}function Rie(t){const e=t.graphics3DGraphic.graphics3DSymbol,r=Oie(e);return r!=null?r.symbol.symbolLayers.at(0):null}function hCt(t,e){const r=e.graphics3DGraphic.graphic.geometry;if(r==null)return null;if(e.disablePlacement!=null)return e.labelClass.labelPlacement?(RP.warnOncePerTick(sme(t?.placement,e.disablePlacement.logEntityDescription)),r6(e)):t;const i=r.type;switch(i){case"polyline":case"polygon":case"extent":case"multipoint":if(e.labelClass.labelPlacement)return RP.warnOncePerTick(sme(t?.placement,`'${i}' geometries`)),r6(e);break;case"point":case"mesh":return t}return t}function sme(t,e){return`the requested label placement '${t}' is currently unsupported for ${e} in SceneView.`}function r6(t){const e=t.graphics3DGraphic.graphic.geometry;if(e==null)return null;switch(e.type){case"polyline":case"extent":case"multipoint":return{placement:"center-center",normalizedOffset:null,anchor:"center"};case"polygon":{const r=Rie(t);return r!=null&&r.type==="extrude"?gf["above-center"]:{placement:"center-center",normalizedOffset:null,anchor:"center"}}case"point":case"mesh":return gf["above-center"];default:return}}function dCt(t,e,r){const i=r.graphics3DGraphic.graphic.geometry;if(i==null)return null;switch(i.type){case"point":fCt(t,e,r);break;case"polygon":pCt(t,e,r);break;case"mesh":Mie(t,e,r.graphics3DGraphic.layers[0])}return t}function pCt(t,e,r){const i=Rie(r);if(i!=null)switch(i.type){case"extrude":{const s=r.graphics3DGraphic.layers[0];s!=null?(s.getBoundingBoxObjectSpace(TI),lf(TI,t.translation),t.translation[2]=lb(TI)/2):ie(t.translation,0,0,0),Mie(t,e,s);break}}}function fCt(t,e,r){const i=Rie(r);if(i==null)return;const s=r.graphics3DGraphic.layers[0];switch(s!=null?s.getCenterObjectSpace(t.translation):ie(t.translation,0,0,0),i.type){case"icon":case"text":mCt(t,e,r,s);break;case"object":Mie(t,e,s)}}function mCt(t,e,r,i){const{graphics3DGraphic:s}=r,n=i!=null?i.getScreenSize():null;if(s.isDraped||n==null)t.hasLabelVerticalOffset||t.anchor==="center"||(gf[r.labelClass.labelPlacement]&&RP.warnOncePerTick(`the requested placement '${e.placement}' is currently unsupported for draped graphics`),t.anchor="center");else{const o=gCt(r);t.screenOffset[0]=n[0]/2*(e.normalizedOffset[0]-o[0]);const a=n[1]/2*(e.normalizedOffset[1]-o[1]);t.hasLabelVerticalOffset?(t.centerOffset[1]=a,t.centerOffsetUnits="screen"):t.screenOffset[1]=a}}function gCt(t,e=vCt){const{graphics3DGraphic:r}=t,i=r.layers[0],s=i!=null?i.stageObject.geometries[0].material:null;if(s&&s instanceof VA){const n=s.parameters.anchorPosition;e[0]=2*(n[0]-.5),e[1]=2*(n[1]-.5)}else e[0]=0,e[1]=0;return e}function Mie(t,e,r){const i=r!=null?r.getBoundingBoxObjectSpace(TI):TI,s=Ee(i[3]-i[0],i[4]-i[1],i[5]-i[2]),n=Math.sqrt(s[0]*s[0]+s[1]*s[1]);t.centerOffset[0]=n/2*e.normalizedOffset[0];const o=t.translation[2],a=s[2]/2*e.normalizedOffset[1];t.translation[2]=0,t.elevationOffset=o+a;const l=Oe(s);t.centerOffset[2]=l/2*e.normalizedOffset[2]}function yCt(t){return t==="above-center"}function _Ct(t){const e=t.labelClass.labelPlacement,{labelSymbol:r,graphics3DGraphic:i}=t,s=Oie(i.graphics3DSymbol),n=Dl(s,a=>a.symbol.type==="point-3d"?a.symbol:null),o=gf[e]||r6(t);return n!=null&&n.supportsCallout()&&n.hasVisibleVerticalOffset()&&!i.isDraped?{placement:null,hasLabelVerticalOffset:!1,verticalOffset:nme(n.verticalOffset),anchor:null,normalizedOffset:null}:!r||!r.hasVisibleVerticalOffset()||n!=null&&n.supportsCallout()&&n.verticalOffset&&!i.isDraped?{placement:null,verticalOffset:null,anchor:null,normalizedOffset:null,hasLabelVerticalOffset:!1}:o&&yCt(o.placement)?{placement:"above-center",verticalOffset:nme(r.verticalOffset),anchor:"bottom",normalizedOffset:[0,o.normalizedOffset[1],0],hasLabelVerticalOffset:!0}:(RP.errorOncePerTick("Callouts and vertical offset on labels are currently only supported with 'above-center' label placement (not with "+e+" placement)"),null)}function nme(t){const{screenLength:e,minWorldLength:r,maxWorldLength:i}=t;return{screenLength:e,minWorldLength:r,maxWorldLength:i}}const gf={"above-center":{placement:"above-center",normalizedOffset:[0,1,0],anchor:"bottom"},"above-left":{placement:"above-left",normalizedOffset:[-1,1,0],anchor:"bottom-right"},"above-right":{placement:"above-right",normalizedOffset:[1,1,0],anchor:"bottom-left"},"below-center":{placement:"below-center",normalizedOffset:[0,-1,2],anchor:"top"},"below-left":{placement:"below-left",normalizedOffset:[-1,-1,0],anchor:"top-right"},"below-right":{placement:"below-right",normalizedOffset:[1,-1,0],anchor:"top-left"},"center-center":{placement:"center-center",normalizedOffset:[0,0,1],anchor:"center"},"center-left":{placement:"center-left",normalizedOffset:[-1,0,0],anchor:"right"},"center-right":{placement:"center-right",normalizedOffset:[1,0,0],anchor:"left"}},ome={"above-center":["default","esriServerPointLabelPlacementAboveCenter"],"above-left":["esriServerPointLabelPlacementAboveLeft"],"above-right":["esriServerPointLabelPlacementAboveRight"],"below-center":["esriServerPointLabelPlacementBelowCenter"],"below-left":["esriServerPointLabelPlacementBelowLeft"],"below-right":["esriServerPointLabelPlacementBelowRight"],"center-center":["esriServerPointLabelPlacementCenterCenter"],"center-left":["esriServerPointLabelPlacementCenterLeft"],"center-right":["esriServerPointLabelPlacementCenterRight"]};for(const t in ome){const e=ome[t],r=gf[t];e.forEach(i=>{gf[i]=r})}Object.freeze&&(Object.freeze(gf),Object.keys(gf).forEach(t=>{Object.freeze(gf[t]),Object.freeze(gf[t]?.normalizedOffset)}));const vCt=[0,0],TI=Gn();let ame=class{constructor(e){this._stage=e,this._materials=new Map}get(e){return this._materials.get(e)}add(e,r){this._materials.set(e,r),this._stage.add(r)}dispose(){this._stage.removeMany(Array.from(this._materials.values())),this._materials.clear()}};const VN=4096;let bCt=class{constructor(){this.offset={x:0,y:0},this.uvMinMax=Qt()}},wCt=class{constructor(e,r){this.textId=e,this.textRenderer=r,this.placement=new bCt,this.rendered=!1}},xCt=class{constructor(e,r,i){this.size=e,this.cursor=r,this.lineHeight=i}resize(e){this.size.height=e}resetCursor(){this.cursor.x=SI,this.cursor.y=SI+VDe,this.lineHeight=0}getUsage(){return(this.cursor.x+this.cursor.y*this.size.width)/(this.size.width*this.size.height)}},yM=class extends me{constructor(e){super(e),this.type=Ms.Texture,this.id=vc(),this.events=new Xr,this._glTexture=null,this._needsClear=!1,this._elementsToAddOrUpdate=new Map,this._elementsToRemove=new Map,this._elementsToRender=new Map,this._elements=new Map,this._stageObjects=new Map,this.updating=!1}initialize(){this._canvas=document.createElement("canvas"),this._canvas.setAttribute("id","textAtlasCanvas"),this._canvas.setAttribute("style","display:none"),this._ctx=this._canvas.getContext("2d"),this._stage=this.view._stage,this._stage.add(this),this._atlas=new xCt({width:VN,height:256},{x:0,y:0},0),this._updateCanvasElementSize(this._atlas),this._resetAtlasCursor()}unload(){this._glTexture=ze(this._glTexture),this.updating=!1,this.events.emit("unloaded")}get requiresFrameUpdates(){return!1}_createDescriptor(e){const r=new Sr;return r.wrapMode=Ut.CLAMP_TO_EDGE,r.flipped=!0,r.samplingMode=Mt.LINEAR_MIPMAP_LINEAR,r.hasMipmap=!0,r.preMultiplyAlpha=!0,r.maxAnisotropy=e.parameters.maxMaxAnisotropy,r}get glTexture(){return this._glTexture}load(e){return this._glTexture!=null||(this._glTexture=new Rt(e,this._createDescriptor(e),this._canvas),this._frameWorker=this.view.resourceController.scheduler.registerTask(gt.TEXT_TEXTURE_ATLAS,this),this.setDirty()),this._glTexture}dispose(){this._elements=null,this._elementsToAddOrUpdate=null,this._elementsToRemove=null,this._elementsToRender=null,this._frameWorker=Pi(this._frameWorker),this._glTexture&&(this._stage.remove(this),this._glTexture=ze(this._glTexture)),this._canvas.width=0,this._canvas.height=0,this._canvas=null,this._ctx=null}_updateCanvasElementSize(e){this._canvas.setAttribute("width",e.size.width.toString()),this._canvas.setAttribute("height",e.size.height.toString())}_resizeAtlas(e){this._atlas.resize(e),this._glTexture!=null&&this._glTexture.resize(this._atlas.size.width,e),this._updateCanvasElementSize(this._atlas)}_resetAtlasCursor(){this._atlas.resetCursor(),this._needsClear=!0}_addAtlasElement(e,r,i,s){const n=this._atlas,{renderedWidth:o,renderedHeight:a}=e.textRenderer;e.placement.offset.x=n.cursor.x,e.placement.offset.y=n.cursor.y,zi(e.placement.uvMinMax,e.placement.offset.x/n.size.width,1-(e.placement.offset.y+a)/n.size.height,(e.placement.offset.x+o)/n.size.width,1-e.placement.offset.y/n.size.height),n.cursor.x+=i,n.lineHeight=Math.max(n.lineHeight,s),this._elements.set(r,e)}_removeAtlasElement(e){if(e&&this._elements.has(e.textId)){const r=e.placement.offset;this._ctx.clearRect(r.x,r.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),this._elements.delete(e.textId)}}_ensureStageObjects(e){const r=this._stageObjects.get(e);if(r)return r;const i=new Set;return this._stageObjects.set(e,i),i}_addStageObject(e,r){this._ensureStageObjects(e).add(r)}_removeStageObject(e,r){const i=this._stageObjects.get(e);i&&i.delete(r)&&(r.geometries[0].setAttributeData(E.SIZE,[0,0]),r.geometryVertexAttrsUpdated(r.geometries[0]))}_processAddition(e,r){const i=this._atlas,s=e.textId,n=e.textRenderer.renderedWidth,o=e.textRenderer.renderedHeight,a=n+SI,l=o+SI+VDe;if(i.cursor.x+a<i.size.width&&i.cursor.y+l<i.size.height)this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s);else{if(!(i.cursor.y+l+i.lineHeight<i.size.height)){const c=i.cursor.y+l+i.lineHeight-i.size.height,h=i.size.height+c<VN;if(h){const p=Math.ceil(i.size.height*Math.max(1.3,(c+i.size.height)/i.size.height));this._resizeAtlas(Math.min(oie(p),VN))}return!r||!h&&i.size.height===VN?(this._processRemovals(),hC.OK):(this._repack(),hC.REPACK)}i.cursor.x=SI,i.cursor.y+=i.lineHeight,i.lineHeight=0,this._addAtlasElement(e,s,a,l),this._elementsToRender.set(s,e),this._elementsToAddOrUpdate.delete(s)}return hC.OK}_processRemovals(){this._elementsToRemove.forEach((e,r)=>{const i=this._stageObjects.get(r);i&&i.size!==0||this._removeAtlasElement(e),i&&i.size===0&&this._stageObjects.delete(r)}),this._elementsToRemove.clear()}_repack(){this._processRemovals(),this._elements.forEach((e,r)=>{e.rendered=!1,this._elementsToAddOrUpdate.set(r,e)}),this._elements.clear(),this._resetAtlasCursor(),this._elementsToRender.clear()}_processRenderingRequest(e){this._ctx.clearRect(e.placement.offset.x,e.placement.offset.y,e.textRenderer.renderedWidth,e.textRenderer.renderedHeight),e.textRenderer.render(this._ctx,e.placement.offset.x,e.placement.offset.y);const r=this._stageObjects.get(e.textId);r&&r.forEach(i=>{i.geometries[0].setAttributeData(E.UV0,e.placement.uvMinMax),i.geometries[0].setAttributeData(E.SIZE,[e.textRenderer.displayWidth,e.textRenderer.displayHeight]),i.geometryVertexAttrsUpdated(i.geometries[0])}),e.rendered=!0}get running(){return this.updating}runTask(e,r=!0){if(this._glTexture==null)return Pa.YIELD;let i=!1;if(ra(this._elementsToAddOrUpdate,(n,o)=>{if(this._elements.get(o)?.rendered){const l=this._stageObjects.get(o);return l&&l.forEach(c=>{const h=c.geometries[0],p=this._elements.get(o);h.setAttributeData(E.UV0,p.placement.uvMinMax),h.setAttributeData(E.SIZE,[p.textRenderer.displayWidth,p.textRenderer.displayHeight]),c.geometryVertexAttrsUpdated(c.geometries[0])}),this._elementsToAddOrUpdate.delete(o),e.madeProgress(),!1}return this._processAddition(this._elementsToAddOrUpdate.get(o),r)===hC.REPACK&&(i=!0,!0)}),i)return this.runTask(Ll,!1),void e.madeProgress();let s=!1;this._elementsToRender.size>0&&this._needsClear&&(this._ctx.clearRect(0,0,this._canvas.width,this._canvas.height),this._needsClear=!1),ra(this._elementsToRender,(n,o)=>(this._processRenderingRequest(n),this._elementsToRender.delete(o),s=!0,e.madeProgress(),e.done)),s&&this._glTexture.setData(this._canvas),this.updating=this._elementsToRender.size>0,!this.updating&&hbt.orderedRepackingEnabled&&(this.repackOrdered(),e.madeProgress())}addTextTexture(e,r){const i=e.key;this._elementsToAddOrUpdate.has(i)||this._elementsToAddOrUpdate.set(i,new wCt(i,e)),this._addStageObject(i,r),this._elementsToRemove.delete(i),this.setDirty()}removeTextTexture(e,r){const i=e.key;this._elementsToRemove.set(i,this._elements.get(i)),this._removeStageObject(i,r)}setDirty(){this._glTexture&&(this.updating=!0)}repackOrdered(){if(this._elements.size===0)return;const e=[];this._elements.forEach((i,s)=>e.push({element:i,key:s}));let r=!0;for(let i=0;i<e.length-1;i++)if(e[i].key.localeCompare(e[i+1].key)>0){r=!1;break}if(!r||this._elementsToRemove.size){e.sort((i,s)=>i.key.localeCompare(s.key)),this._elements.clear();for(const{element:i,key:s}of e)this._elements.set(s,i);this._repack(),this.setDirty()}}get test(){const{_elements:e,_stageObjects:r,_elementsToRemove:i,_atlas:s}=this,n=this;return{elements:e,stageObjects:r,elementsToRemove:i,atlas:s,resizeAtlas:o=>n._resizeAtlas(o),run:(o,a)=>n.runTask(o,a)}}};u([d({constructOnly:!0})],yM.prototype,"view",void 0),u([d({type:Boolean})],yM.prototype,"updating",void 0),yM=u([R("esri.views.3d.webgl-engine.lib.TextTextureAtlas")],yM);const SI=2,VDe=2;var hC;(function(t){t[t.OK=0]="OK",t[t.REPACK=1]="REPACK"})(hC||(hC={}));let lme=class{constructor(e,r){this.labelingContext=e,this.graphics3DGraphic=r,this.hasGraphics3DResources=!1,this.visible=!1,this.rendered=!1,this.textInitialized=!1,this.textRenderers=new Array,this.textLabelPlacements=new Array}},TCt=class{constructor(e,r,i,s,n){this.labelClass=e,this.graphics3DSymbol=r,this.graphics3DCalloutSymbolLayer=i,this.textRenderParameters=s,this.labelFunction=n,this.calloutSymbolLayerIndex=0}},SCt=class{constructor(e,r,i,s,n,o,a,l){this.layer=r,this.graphics3DCore=i,this.scaleVisibility=s,this.emptySymbolLabelSupported=n,this.elevationInfoOverride=o,this.disablePlacement=a,this.active=l,this.labelClassAbortController=new AbortController,this.labelClassContexts=new Array,this.graphics=new Map,this.labelsToInitialize=new Map,this.stageLayer=new D$e(e,{pickable:!0,disableOctree:!0},r.uid)}destroy(){this.stageLayer.destroy()}},ux=class extends me{constructor(e){super(e),this._dirty=!1,this._labels=new Map,this._labelsToAdd=new Map,this._labelsToRemove=new Map,this._labelingContexts=new Array}setup(){this.dispose(),this._handles=new li,this._handles.add([Q(()=>this.view.state?.camera,()=>this.setDirty()),Q(()=>this.view.state?.rasterPixelRatio,()=>this._resetAllLabels()),this.view.resourceController.scheduler.registerTask(gt.LABELER,this)]),this._textTextureAtlas=new yM({view:this.view}),this._hudMaterialCollection=new ame(this.view._stage),this._calloutMaterialCollection=new ame(this.view._stage)}dispose(){this._handles=Re(this._handles),this._textTextureAtlas=ze(this._textTextureAtlas),this._hudMaterialCollection=ze(this._hudMaterialCollection),this._calloutMaterialCollection=ze(this._calloutMaterialCollection),this._labelingContexts.length=0,this._labels.clear(),this._labelsToAdd.clear(),this._labelsToRemove.clear()}destroy(){this.dispose(),_p.graphic=null,_p.renderingInfo=null,_p.layer=null}_activateLabelingContext(e){e.graphics.forEach((r,i)=>{const s=new lme(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s),r.setVisibilityFlag(Mo.LABEL,Ca.USER,!0)}),e.active=!0}_deactivateLabelingContext(e){e.graphics.forEach((r,i)=>{r.setVisibilityFlag(Mo.LABEL,Ca.USER,!1),this.setLabelGraphicVisibility(r,!1),this._labels.delete(i)}),e.active=!1}_addLabelTextureToAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];i&&this._textTextureAtlas.addTextTexture(i,r.stageObject)}e.rendered=!0}_removeLabelTextureFromAtlas(e){for(const r of e.graphics3DGraphic.labelLayers){if(!r._labelClass)continue;const i=e.textRenderers[r._labelIndex];i!=null&&this._textTextureAtlas.removeTextTexture(i,r.stageObject)}e.rendered=!1}get running(){return this.view.ready&&(this._dirty||this.deconflictor.running)}runTask(e){return this._updateLabels(e),!this._dirty&&this.deconflictor.running&&this.deconflictor.runTask(e),Pa.YIELD}_updateLabels(e){if(this._dirty){this._dirty=!1;for(const r of this._labelingContexts)if(r.active){if(!cme(r)){if(ECt(r)){this._deactivateLabelingContext(r);continue}if(this._createLabelClassContext(r),GG(r)){this._dirty=!0;continue}if(!cme(r))continue}ra(r.labelsToInitialize,(i,s)=>(this._ensureGraphics3DResources(i)&&(this._labels.set(s,i),this.deconflictor.setDirty(),e.madeProgress()),(i.visible&&i.textInitialized||!i.visible&&i.hasGraphics3DResources)&&(r.labelsToInitialize.delete(s),e.madeProgress()),e.done))&&(this._dirty=!0)}this._labelsToRemove.forEach(r=>this._removeLabelTextureFromAtlas(r)),this._labelsToAdd.forEach(r=>this._addLabelTextureToAtlas(r)),this._labelsToRemove.clear(),this._labelsToAdd.clear(),this._dirty||this.notifyChange("updating")}}async _createLabelClassContextAsync(e){const r=e.labelClassAbortController?.signal;await e.layer.when?.(),Dt(r),e.scaleVisibility&&e.scaleVisibility.updateScaleRangeActive();const i=e.graphics3DCore,s=i.layer,n=s.labelingInfo&&s.labelingInfo.filter(o=>!!o.symbol);!n||n.length===0||(await OV(n,async(o,a)=>{const l=o.symbol,c=Oie(i.getOrCreateGraphics3DSymbol(l));if(c==null)return void K.getLogger(this).error("Failed to create Graphics3DSymbol for label");await c.load(),Dt(r);let h=null;TK(l)&&l.hasVisibleCallout()&&(h=y1t(l,i.symbolCreationContext),await h.load(),Dt(r));const p=await Sh(FPe(o,e.layer.fieldsIndex,this.view.spatialReference));if(Dt(r),p.ok===!0){const f=await this._createTextRenderParameters(c.symbol);Dt(r),e.labelClassContexts[a]=new TCt(o,c,h,f,p.value)}else K.getLogger(this).error(`Label expression failed to evaluate: ${p.error}`)}),Dt(r))}async _createLabelClassContext(e){return e.labelClassPromise==null&&(e.labelClassPromise=this._createLabelClassContextAsync(e).catch(r=>{if(ws(r))throw r;e.labelClassContexts.length=0}).then(()=>{e.labelClassAbortController=null,this.notifyChange("updating")}).catch(()=>{}),this.notifyChange("updating")),e.labelClassPromise}async _createTextRenderParameters(e){const r=e.symbolLayers.at(0);return r?.type!=="text"?null:kDe.fromSymbol(r,this.view.state.rasterPixelRatio)}_destroyLabelClassContext(e){for(const i of e.labelClassContexts)--i.graphics3DSymbol.referenced;const r=e.labelClassAbortController;e.labelClassAbortController=new AbortController,Do(r),e.labelClassContexts.length=0,e.labelClassPromise=null,this.notifyChange("updating")}_createTextSymbolGraphic(e,r,i,s,n){const o=new UPe(i.verticalOffset,ffe(i.anchor),Fxt(i.anchor),e.text,i.translation,i.elevationOffset,i.centerOffset,i.screenOffset,i.centerOffsetUnits,e.displayWidth,e.displayHeight);return _p.graphic=r,_p.renderingInfo=null,_p.layer=s,n.createLabel(_p,o,this._hudMaterialCollection,this._textTextureAtlas)}_createLineCalloutGraphic(e,r,i,s,n){return _p.graphic=e,_p.layer=n,_p.renderingInfo=new m1t(null,r,s.translation,s.centerOffset,s.screenOffset,s.centerOffsetUnits,s.elevationOffset,this._calloutMaterialCollection),i.createGraphics3DGraphic(_p)}_ensureGraphics3DResources(e){if(e.hasGraphics3DResources)return!1;const r=e.graphics3DGraphic;if(r.destroyed)return!1;this._ensureTextTextureResources(e);const i=e.labelingContext,s=i.labelClassContexts;if(!s||s.length===0||!i.emptySymbolLabelSupported&&r.layers.length===0)return!1;let n=!1;const o=r.graphic,a=i.layer,l=zN(i.layer);for(let c=0;c<s.length;c++){const h=e.textRenderers[c],p=e.textLabelPlacements[c];if(h==null||p==null)continue;const f=s[c],m=f.graphics3DSymbol,g=m.symbol&&m.symbol.type==="label-3d"?m.symbol:null,_=m.symbolLayers[0];if(!_)continue;_.setElevationInfoOverride(i.elevationInfoOverride);const v=this._createTextSymbolGraphic(h,o,p,a,_);if(v==null)return!1;v._labelClass=f.labelClass,v._labelIndex=c,r.addLabelGraphic(v,i.stageLayer),r.deconflictionPriority=f.textRenderParameters?.definition.size??0,r.setVisibilityFlag(Mo.LABEL,Ca.USER,l),r.setVisibilityFlag(Mo.LABEL,Ca.SCALE_RANGE,!0),r.setVisibilityFlag(Mo.LABEL,Ca.DECONFLICTION,!1),n=!0;const b=f.graphics3DCalloutSymbolLayer;if(b&&p.hasLabelVerticalOffset){b.setElevationInfoOverride(i.elevationInfoOverride);const x=this._createLineCalloutGraphic(o,g,b,p,a);x!=null&&(f.calloutSymbolLayerIndex=r.labelLayers.length,r.addLabelGraphic(x,i.stageLayer))}break}return i.scaleVisibility&&n&&i.scaleVisibility.updateGraphicLabelScaleVisibility(r),e.hasGraphics3DResources=!0,!0}_destroyGraphics3DResources(e){const r=e.labelingContext.labelClassContexts;for(const i of e.graphics3DGraphic.labelLayers){if(i._labelClass==null)continue;const s=r[i._labelIndex].graphics3DSymbol.symbolLayers[0];s?.onRemoveGraphic(i)}e.graphics3DGraphic.deconflictionPriority=0,e.graphics3DGraphic.clearLabelGraphics(),e.hasGraphics3DResources=!1}_ensureTextTextureResources(e){if(e.textInitialized)return;const r=e.labelingContext,i=r.labelClassContexts;if(!i||i.length===0)return;const s=e.graphics3DGraphic.graphic;for(let n=0;n<i.length;n++){const o=i[n];if(e.textRenderers[n]=null,e.textLabelPlacements[n]=null,o?.textRenderParameters==null)continue;const a=o.labelFunction;let l;if(a.type==="arcade")try{const b=a.needsHydrationToEvaluate()?xvt(s,r.layer):s;l=a.evaluate(b)}catch{l=null}else l=a.evaluate(s);if(l==null||l===""||/^\s+$/.test(l))continue;const c=o.graphics3DSymbol,h=c.symbol?.type==="label-3d"?c.symbol:null;if(!c.symbolLayers[0])continue;const p=e.graphics3DGraphic,f=o.labelClass,m=r.disablePlacement,g=cCt({graphics3DGraphic:p,labelSymbol:h,labelClass:f,disablePlacement:m});if(g==null)continue;const _=ffe(g.anchor),v=kLe(_);e.textRenderers[n]=new NLe(l,v,o.textRenderParameters),e.textLabelPlacements[n]=g}e.textInitialized=!0}_destroyTextTextureResources(e){e.textInitialized=!1,e.textRenderers.length=0,e.textLabelPlacements.length=0}_addGraphic(e,r){const i=r.graphic.uid;if(e.graphics.set(i,r),e.active){const s=new lme(e,r);this._labels.set(i,s),e.labelsToInitialize.set(i,s)}this.setDirty(),this.deconflictor.setDirty()}_removeGraphic(e,r){const i=r.graphic.uid,s=this._labels.get(i);e.graphics.delete(i),s&&(this._destroyGraphic(s,i),e.labelsToInitialize.delete(i),this.setDirty(),this.deconflictor.setDirty())}_destroyGraphic(e,r){this._labels.has(r)&&(this._labels.delete(r),this._labelsToAdd.delete(r),this._labelsToRemove.delete(r)),e.textInitialized&&(this._removeLabelTextureFromAtlas(e),this._destroyTextTextureResources(e)),e.hasGraphics3DResources&&this._destroyGraphics3DResources(e)}async _labelingInfoChange(e,r){if(!r)return this._visibilityInfoChange(e),this._resetLabels(e),this._createLabelClassContext(e);for(const i of r){const s=e.graphics.get(i);s&&(this._removeGraphic(e,s),this._addGraphic(e,s))}}_globalPropertyChanged(e,r){for(const i of r.labelClassContexts){const s=new Map;r.graphics.forEach(o=>s.set(o.graphic.uid,o));const n=o=>o.labelLayers[0];if(i.graphics3DSymbol.symbolLayers[0].globalPropertyChanged(e,s,n),i.graphics3DCalloutSymbolLayer){const o=a=>a.labelLayers[i.calloutSymbolLayerIndex];i.graphics3DCalloutSymbolLayer.globalPropertyChanged(e,s,o)}}}_visibilityInfoChange(e){const r=zN(e.layer);r&&!e.active&&this._activateLabelingContext(e),!r&&e.active&&this._deactivateLabelingContext(e),this.setDirty()}_resetAllLabels(){for(const e of this._labelingContexts)this._resetLabels(e)}_resetLabels(e){e.graphics.forEach((r,i)=>{const s=this._labels.get(i);s&&(this._destroyGraphic(s,i),s.visible=!1,s.rendered=!1,e.labelsToInitialize.set(i,s))}),this._destroyLabelClassContext(e),this.setDirty(),this.deconflictor.setDirty()}_findLabelingContext(e){for(const r of this._labelingContexts)if(r.graphics3DCore===e)return r;return null}addGraphicsOwner(e,r,i){const s=i&&i.emptySymbolLabelSupported||!1,n=i&&i.elevationInfoOverride||null,o=i&&i.disablePlacement||null;if(this._findLabelingContext(e))return;const a=e.layer,l=new SCt(this.view._stage,a,e,r,s,n,o,zN(a));return this._labelingContexts.push(l),this.setDirty(),{addGraphic:c=>this._addGraphic(l,c),removeGraphic:c=>this._removeGraphic(l,c),featureReductionChange:()=>{},layerLabelsEnabled:()=>zN(l.layer),labelingInfoChange:c=>this._labelingInfoChange(l,c),elevationInfoChange:()=>this._globalPropertyChanged("elevationInfo",l),slicePlaneEnabledChange:()=>this._globalPropertyChanged("slicePlaneEnabled",l),visibilityInfoChange:()=>this._visibilityInfoChange(l),reset:()=>this._resetLabels(l),clear:()=>{}}}removeGraphicsOwner(e){const r=this._findLabelingContext(e);if(!r)return;const i=this._labelingContexts.indexOf(r);this._labelingContexts.splice(i,1),r.graphics.forEach(s=>this._removeGraphic(r,s)),r.destroy(),this.setDirty()}setLabelGraphicVisibility(e,r){const i=e.graphic.uid,s=this._labels.get(i);s&&s.visible!==r&&(r&&!s.rendered?(this._labelsToAdd.set(i,s),this._labelsToRemove.delete(i),s.textInitialized||s.labelingContext.labelsToInitialize.set(i,s)):!r&&s.rendered&&(this._labelsToRemove.set(i,s),this._labelsToAdd.delete(i)),s.visible=r,this.setDirty())}setDirty(){!this._dirty&&this._labelingContexts.length>0&&(this._dirty=!0,this.notifyChange("updating"))}get updating(){return this._dirty||this._textTextureAtlas?.updating||this.deconflictor.updating||this._labelingContexts.some(e=>GG(e))}get updatingProgress(){if(!this.updating||!this._textTextureAtlas)return 1;const e=this._labelingContexts.length>0?this._labelingContexts.reduce((r,i)=>r+(GG(i)?0:1),0)/this._labelingContexts.length:1;return(this._dirty?0:.3)+(this._textTextureAtlas.updating?0:.1)+.1*e+.5*this.deconflictor.updatingProgress}get test(){return{textTextureAtlas:this._textTextureAtlas,resetAllLabels:()=>this._resetAllLabels()}}};function GG(t){return!!t.labelClassPromise&&!!t.labelClassAbortController}function cme(t){return t.labelClassContexts&&t.labelClassContexts.length}function ECt(t){return t.labelClassContexts===null}function zN(t){return t.labelsVisible===!0&&!!t.labelingInfo?.some(e=>!!e.symbol)}u([d({constructOnly:!0})],ux.prototype,"view",void 0),u([d({constructOnly:!0})],ux.prototype,"deconflictor",void 0),u([d()],ux.prototype,"_textTextureAtlas",void 0),u([d({type:Boolean,readOnly:!0})],ux.prototype,"updating",null),ux=u([R("esri.views.3d.layers.graphics.Labeler")],ux);const _p=new g1t(null,null,null);let _M=class PE{constructor(e,r,i,s=null){this.lij=[0,0,0],this.extent=Ht(),this.resolution=0,this.loadPriority=0,this.measures={visibility:ja.VISIBLE_ON_SURFACE,screenRect:Ht(),distance:0,shouldSplit:!1},this.used=!1,s&&this.acquire(e,r,i,s)}acquire(e,r,i,s){this.tilingScheme=s,this.id=PE.id(e,r,i),this.lij[0]=e,this.lij[1]=r,this.lij[2]=i,s.getExtent(e,r,i,this.extent),this.resolution=s.resolutionAtLevel(e)}release(){this.tilingScheme=null}getChildren(e){const r=this.lij[0]+1,i=2*this.lij[1],s=2*this.lij[2];return e?(e[0].acquire(r,i,s,this.tilingScheme),e[1].acquire(r,i+1,s,this.tilingScheme),e[2].acquire(r,i,s+1,this.tilingScheme),e[3].acquire(r,i+1,s+1,this.tilingScheme),e):[new PE(r,i,s,this.tilingScheme),new PE(r,i+1,s,this.tilingScheme),new PE(r,i,s+1,this.tilingScheme),new PE(r,i+1,s+1,this.tilingScheme)]}copyMeasurementsFrom(e){this.measures.visibility=e.measures.visibility,this.measures.shouldSplit=e.measures.shouldSplit,this.measures.distance=e.measures.distance,C0(e.measures.screenRect,this.measures.screenRect)}static id(e,r,i){return`${e}/${r}/${i}`}};var ja;(function(t){t[t.INVISIBLE=0]="INVISIBLE",t[t.VISIBLE_WHEN_EXTENDED=1]="VISIBLE_WHEN_EXTENDED",t[t.VISIBLE_ON_SURFACE=2]="VISIBLE_ON_SURFACE"})(ja||(ja={}));const zDe=.5*Math.PI,CCt=zDe/Math.PI*180;let ACt=class{constructor(e){this._renderCoordsHelper=e.renderCoordsHelper,this._extent=new Array(4),this._planes=new Array(6),this._maxSpan=0,this._center={origin:C(),direction:C()};for(let r=0;r<4;r++)this._extent[r]={origin:C(),direction:C(),cap:{next:null,direction:C()}},this._planes[r]=zr();this._planes[Ai.NEAR]=zr(),this._planes[Ai.FAR]=zr(),this._planesWithoutFar=this._planes.slice(0,5)}update(e,r,i,s=!0){const n=this._extent;this._toRenderBoundingExtent(e,r,i),ue(this._center.origin,n[0].origin,n[2].origin),ae(this._center.origin,this._center.origin,.5),this._renderCoordsHelper.worldUpAtPosition(this._center.origin,this._center.direction),s||ae(this._center.direction,this._center.direction,-1);for(let o=0;o<4;o++){const a=n[o];this._renderCoordsHelper.worldUpAtPosition(a.origin,a.direction);const l=n[o===3?0:o+1];a.cap.next=l.origin,F0(a.cap.direction,a.origin,l.origin),cP(a.direction,a.cap.direction,a.origin,this._planes[o]),s||ae(a.direction,a.direction,-1)}cP(n[0].cap.direction,n[1].cap.direction,n[0].origin,this._planes[Ai.NEAR]),s?MZ(this._planes[Ai.NEAR],this._planes[Ai.FAR]):(QV(this._planes[Ai.FAR],this._planes[Ai.NEAR]),MZ(this._planes[Ai.NEAR],this._planes[Ai.NEAR])),this._maxSpan=Math.max(Math.abs(e[0]-e[2]),Math.abs(e[1]-e[3])),this._maxSpanSpatialReference=r,this._minGlobalAltitude=.9*Ir(this._maxSpanSpatialReference).radius}isVisibleInFrustum(e,r,i=!1){if(e==null)return!1;if(this._renderCoordsHelper.viewingMode===Ue.Global){const n=this._maxSpanSpatialReference.isGeographic?CCt:zDe*r;if(this._maxSpan>n)return!0;if(e.altitude!=null&&e.altitude>=this._minGlobalAltitude)return this._isVisibleInFrustumGlobal(e)}if(this._maxSpan===0){const n=this._extent[0];return!(i||!e.intersectsRay(Eh(n.origin,n.direction)))}for(let n=0;n<this._extent.length;n++){const o=this._extent[n];if(!i&&e.intersectsRay(Eh(o.origin,o.direction))||e.intersectsLineSegment(aT(o.origin,o.cap.next,RCt),o.cap.direction))return!0}const s=i?this._planes:this._planesWithoutFar;for(let n=0;n<e.lines.length;n++){const o=e.lines[n];if(_ft(s,o.origin,o.endpoint,o.direction))return!0}return!1}_toRenderBoundingExtentGlobal(e,r,i){NQ(e,vp),vp[2]=i,wc(r,vp,jG,this._renderCoordsHelper.spatialReference),so(ume,jG),Gi(kc);for(const{x0:n,x1:o,y0:a,y1:l}of OCt)for(let c=0;c<5;c++){const h=c/4;vp[0]=Et(e[n],e[o],h),vp[1]=Et(e[a],e[l],h),vp[2]=i,Tn(vp,r,vp,this._renderCoordsHelper.spatialReference),Ne(vp,vp,ume),yg(kc,vp)}ie(this._extent[0].origin,kc[0],kc[1],kc[2]),ie(this._extent[1].origin,kc[3],kc[1],kc[2]),ie(this._extent[2].origin,kc[3],kc[4],kc[2]),ie(this._extent[3].origin,kc[0],kc[4],kc[2]);for(let n=0;n<4;++n)Ne(this._extent[n].origin,this._extent[n].origin,jG)}_toRenderBoundingExtentLocal(e,r,i){_$(e,r,ry,this._renderCoordsHelper.spatialReference),ie(this._extent[0].origin,ry[0],ry[1],i),ie(this._extent[1].origin,ry[2],ry[1],i),ie(this._extent[2].origin,ry[2],ry[3],i),ie(this._extent[3].origin,ry[0],ry[3],i)}_toRenderBoundingExtent(e,r,i){switch(this._renderCoordsHelper.viewingMode){case Ue.Global:this._toRenderBoundingExtentGlobal(e,r,i);break;case Ue.Local:this._toRenderBoundingExtentLocal(e,r,i);break;default:this._renderCoordsHelper.viewingMode}}_isVisibleInFrustumGlobal(e){if(Oi(e.planes[Ai.NEAR],this._center.origin)<0&&de(this._center.direction,e.direction)<0)return!0;for(let r=0;r<4;r++){const i=this._extent[r];if(Oi(e.planes[Ai.NEAR],i.origin)<0&&de(i.direction,e.direction)<0)return!0}return!1}};const OCt=[{x0:0,y0:1,x1:2,y1:1},{x0:0,y0:3,x1:2,y1:3},{x0:0,y0:1,x1:0,y1:3},{x0:2,y0:1,x1:2,y1:3}],vp=C(),jG=xe(),ume=xe(),kc=Gn(),ry=Ht(),RCt=Vf();let MCt=class{constructor(e){this._renderCoordsHelper=e,this._surfaceElevation=0,this._cache=new Map,this._frustum=new Qv(e),this._extendedFrustum=new Qv(e),this._intersector=new ACt({renderCoordsHelper:e}),this._renderCoordsHelper=e}begin(e,r){this._surfaceElevation=r,this._aboveGround=this._renderCoordsHelper.getAltitude(e.eye)>r,this._frustum.update(e),this._shortenFrustumFarPlane(this._frustum),this._updateExtendedFrustum(e)}end(){this._cache.clear()}calculate(e){if(this._allTilesInvisible)return ja.INVISIBLE;const r=this._renderCoordsHelper.viewingMode===Ue.Global&&e.lij[0]>=ICt&&e.lij[0]<PCt,i=this._getOrCalculateSingleTileVisibility(e,!r);return i!==ja.INVISIBLE&&r?this._calculateAggregatedChildrenVisibility(e):i}_shortenFrustumFarPlane(e){const r=Qv.nearFarLineIndices,i=e.mutablePoints;for(const s of r){const[n,o]=s,a=i[n],l=i[o];pe(Bu,l,a),ae(Bu,Bu,LCt),ue(i[o],a,Bu)}e.updatePoints(i)}_calculateAggregatedChildrenVisibility(e){let r=ja.INVISIBLE;const i=this._cache.get(e.id);if(i!=null)return i;const s=fme.acquire();e.getChildren(s);for(const n of s){const o=this.calculate(n);if(o!==ja.INVISIBLE&&(r=o,o===ja.VISIBLE_ON_SURFACE))break}return fme.release(s),this._cache.set(e.id,r),r}_getOrCalculateSingleTileVisibility(e,r){const i=this._cache.get(e.id);if(i!=null)return i;const s=this._calculateSingleTileVisibility(e);return r&&this._cache.set(e.id,s),s}_calculateSingleTileVisibility(e){return!this._aboveGround&&this._renderCoordsHelper.viewingMode===Ue.Global&&e.lij[0]<$Ct?this._calculateSingleTileVisibilitySided(e,!1)===ja.INVISIBLE?this._calculateSingleTileVisibilitySided(e,!0):void 0:this._calculateSingleTileVisibilitySided(e,this._aboveGround)}_calculateSingleTileVisibilitySided(e,r){this._intersector.update(e.extent,e.tilingScheme.spatialReference,this._surfaceElevation,r);const i=Ir(e.tilingScheme.spatialReference).radius;return this._intersector.isVisibleInFrustum(this._extendedFrustum,i)?this._intersector.isVisibleInFrustum(this._frustum,i,!0)?ja.VISIBLE_ON_SURFACE:ja.VISIBLE_WHEN_EXTENDED:ja.INVISIBLE}_updateExtendedFrustum(e){this._extendedFrustum.update(e),this._shortenFrustumFarPlane(this._extendedFrustum);const r=this._renderCoordsHelper.worldUpAtPosition(e.eye,Bu);this._aboveGround||el(r,r);const i=oo(-de(r,e.viewForward));if(this._allTilesInvisible=i>(Math.PI+e.fovY)/2,this._allTilesInvisible||(this._hasExtendedFrustum=i>e.fovY/2,!this._hasExtendedFrustum))return;const s=this._extendedFrustumParameters(),n=this._extendedFrustum.mutablePoints;for(let o=0;o<4;o++){const a=s.pointIndices[o],l=n[a],c=this._renderCoordsHelper.getAltitude(l);if(s.needsAltitudeAdjustment(c)){switch(this._renderCoordsHelper.worldUpAtPosition(l,Bu),a){case Qe.FAR_BOTTOM_LEFT:case Qe.FAR_TOP_LEFT:case Qe.NEAR_BOTTOM_LEFT:case Qe.NEAR_TOP_LEFT:IZ(this._extendedFrustum.planes[Ai.LEFT],Bu,Bu);break;case Qe.FAR_BOTTOM_RIGHT:case Qe.FAR_TOP_RIGHT:case Qe.NEAR_BOTTOM_RIGHT:case Qe.NEAR_TOP_RIGHT:IZ(this._extendedFrustum.planes[Ai.RIGHT],Bu,Bu)}ae(Bu,Bu,s.direction),this._renderCoordsHelper.intersectInfiniteManifold(Eh(l,Bu),s.zWithMargin,l)}}if(this._extendedFrustum.updatePoints(n),Wa(n[Qe.NEAR_BOTTOM_LEFT],n[Qe.NEAR_BOTTOM_RIGHT],n[Qe.NEAR_TOP_RIGHT],dme),Wa(n[Qe.NEAR_BOTTOM_RIGHT],n[Qe.NEAR_TOP_RIGHT],n[Qe.NEAR_TOP_LEFT],pme),de(dme,pme)<0){const o=this._extendedFrustum.mutablePoints;this._aboveGround?[o[Qe.NEAR_BOTTOM_LEFT],o[Qe.NEAR_BOTTOM_RIGHT]]=[o[Qe.NEAR_BOTTOM_RIGHT],o[Qe.NEAR_BOTTOM_LEFT]]:[o[Qe.NEAR_TOP_LEFT],o[Qe.NEAR_TOP_RIGHT]]=[o[Qe.NEAR_TOP_RIGHT],o[Qe.NEAR_TOP_LEFT]],this._extendedFrustum.updatePoints(o)}}_extendedFrustumParameters(){return this._aboveGround?this._extendedFrustumParametersAboveSurface():this._extendedFrustumParametersBelowSurface()}_extendedFrustumParametersAboveSurface(){const e=this._surfaceElevation-hme;return{zWithMargin:e,pointIndices:Qv.planePointIndices.bottom,direction:-1,needsAltitudeAdjustment:r=>r>e}}_extendedFrustumParametersBelowSurface(){const e=this._surfaceElevation+hme;return{zWithMargin:e,pointIndices:Qv.planePointIndices.top,direction:1,needsAltitudeAdjustment:r=>r<e}}};const ICt=2,PCt=6,$Ct=12,LCt=.95,hme=1,Bu=C(),dme=zr(),pme=zr(),fme=new $o(Array,t=>{t.length!==4&&(t[0]=new _M,t[1]=new _M,t[2]=new _M,t[3]=new _M)},t=>{t[0].release(),t[1].release(),t[2].release(),t[3].release()});let DCt=class{constructor(e){this._camera=new ft,this._focusOnMap=[0,0],this._screenRect=Ht(),this._tileSize=e.tileSize,this._renderCoordsHelper=e.renderCoordsHelper,this._tilingScheme=e.tilingScheme,this._visibility=new MCt(e.renderCoordsHelper)}begin(e,r,i){this._camera.copyFrom(e),this._surfaceElevation=i,this._focusOnMap[0]=r.x,this._focusOnMap[1]=r.y,DQ(0,0,e.fullWidth,e.fullHeight,this._screenRect),this._visibility.begin(this._camera,i)}end(){this._visibility.end()}updateTile(e){e.measures.visibility=this._visibility.calculate(e),e.measures.distance=M9e(e.extent,this._focusOnMap),e.measures.visibility!==ja.INVISIBLE&&this._updateScreenMeasure(e)}_updateScreenMeasure(e){const r=NCt,i=1<<r,s=e.measures.screenRect;Au(s);let n=0;const o=e.lij[0]+r,a=e.lij[1]<<r,l=e.lij[2]<<r,c=this._tileSizeWithBias(e),h=c*c;for(let p=0;p<i;p++)for(let f=0;f<i;f++)if(n+=this._computeScreenArea(e,o,a+p,l+f,s),n>h)return void(e.measures.shouldSplit=!0);e.measures.shouldSplit=!1}_tileSizeWithBias(e){return e.measures.visibility===ja.VISIBLE_WHEN_EXTENDED?this._tileSize*FCt:this._tileSize}_computeScreenArea(e,r,i,s,n){const o=e.measures.visibility===ja.VISIBLE_WHEN_EXTENDED;this._projectToScreen(r,i,s,o,D_),Au(HG);for(let a=0;a<4;a++)xC(HG,D_[a]);return E1(n,HG,n),the(D_[0],D_[1],D_[2])+the(D_[0],D_[2],D_[3])}_projectToScreen(e,r,i,s,n){this._tilingScheme.ensureMaxLod(e),this._tilingScheme.getExtent(e,r,i,FR),this._toRenderCoords(FR,0,3,N_[0]),this._toRenderCoords(FR,2,3,N_[1]),this._toRenderCoords(FR,2,1,N_[2]),this._toRenderCoords(FR,0,1,N_[3]),s&&(this._projectToPlane(N_,this._camera.frustum[Ai.NEAR]),this._projectToPlane(N_,this._camera.frustum[Ai.TOP]),this._projectToPlane(N_,this._camera.frustum[Ai.BOTTOM]));for(let o=0;o<4;o++)this._camera.projectToRenderScreen(N_[o],mme),this._camera.renderToScreen(mme,n[o])}_projectToPlane(e,r){for(let s=0;s<4;s++)UR[s]=Oi(r,e[s]);const i=Math.max(UR[0],UR[1],UR[2],UR[3]);if(i>0){const s=ae(kR,r,-i);for(let n=0;n<4;n++)ue(e[n],e[n],s)}}_toRenderCoords(e,r,i,s){return kR[0]=e[r],kR[1]=e[i],kR[2]=this._surfaceElevation,this._renderCoordsHelper.toRenderCoords(kR,this._tilingScheme.spatialReference,s),s}};const HG=Ht(),NCt=2,FCt=5,D_=[cs(),cs(),cs(),cs()],FR=Ht(),kR=C(),N_=[C(),C(),C(),C()],UR=[0,0,0,0],mme=Lo();function tZt(t,e,r){if(t==null||r==null)return!1;let i=!0;return Mn[0]=t.xmin!=null?t.xmin:0,Mn[1]=t.ymin!=null?t.ymin:0,Mn[2]=t.zmin!=null?t.zmin:0,i=i&&wi(Mn,t.spatialReference,0,e,r,0,1),Mn[0]=t.xmax!=null?t.xmax:0,Mn[1]=t.ymax!=null?t.ymax:0,Mn[2]=t.zmax!=null?t.zmax:0,i=i&&wi(Mn,t.spatialReference,0,e,r,3,1),t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.zmin==null&&(e[2]=-1/0),t.xmax==null&&(e[3]=1/0),t.ymax==null&&(e[4]=1/0),t.zmax==null&&(e[5]=1/0),i}function BDe(t,e,r){if(t==null||r==null)return!1;let i=!0;return Mn[0]=t.xmin!=null?t.xmin:0,Mn[1]=t.ymin!=null?t.ymin:0,Mn[2]=t.zmin!=null?t.zmin:0,i=i&&wi(Mn,t.spatialReference,0,Mn,r,0,1),e[0]=Mn[0],e[1]=Mn[1],Mn[0]=t.xmax!=null?t.xmax:0,Mn[1]=t.ymax!=null?t.ymax:0,Mn[2]=t.zmax!=null?t.zmax:0,i=i&&wi(Mn,t.spatialReference,0,Mn,r,0,1),e[2]=Mn[0],e[3]=Mn[1],t.xmin==null&&(e[0]=-1/0),t.ymin==null&&(e[1]=-1/0),t.xmax==null&&(e[2]=1/0),t.ymax==null&&(e[3]=1/0),i}const Mn=C();let Qo=class extends me{get tilingScheme(){const e=this.tilingSchemeOwner.tilingScheme;return e?e.clone():null}set filterExtent(e){if(e!=null&&!e.spatialReference.equals(this.viewState.spatialReference))return void K.getLogger(this).error("#extent","extent spatial reference needs to be in the same spatial reference as the view");const r=this._get("filterExtent");if(r===e||r!=null&&e&&r.equals(e))return;const i=e!=null?e.clone():null;this._set("filterExtent",i),this._setDirty()}get _filterExtentRect(){if(this.filterExtent==null)return null;const e=Ht();return BDe(this.filterExtent,e,this.tilingScheme.spatialReference),e}get _rootTileIds(){const{tilingScheme:e}=this;return this._filterExtentRect&&e?e.rootTilesInExtent(this._filterExtentRect):[[0,0,0]]}set suspended(e){e!==this._get("suspended")&&(this._set("suspended",e),this._setDirty())}get updating(){return this._dirty||!!this._pendingTiles}constructor(e){super(e),this.tiles=new Ke,this.tileSize=512,this._idToTile=new Map,this._handles=new li,this._clients=new Set,this._dirty=!1,this._pendingTiles=null,this._newTiles=new qt}initialize(){this._handles.add([Q(()=>[this.tilingScheme,this.tileSize],()=>this._reset(),Rr),Q(()=>[this.tileSize,this.cameraOnSurface?.location,this.tilingScheme,this.viewState?.contentCamera,this.focus?.location],()=>this._setDirty(),Ri)]),this.scheduler&&(this._frameWorker=this.scheduler.registerTask(gt.FEATURE_TILE_TREE,this))}destroy(){this._frameWorker=Pi(this._frameWorker),this._handles=Re(this._handles)}addClient(){const e=UCt();return this._clients.add(e),this._clients.size===1&&this._setDirty(),Zr(()=>this._removeClient(e))}_removeClient(e){this._clients.delete(e),this._hasClients||this._clear()}get _hasClients(){return this._clients.size>0}_setDirty(){!this._hasClients||this.suspended||this._dirty||(this._frameWorker?(this._dirty=!0,this.notifyChange("updating")):this.runTask(Ll))}_clear(){this.tiles.removeAll(),this._idToTile.clear(),this._reset(),this._dirty=!1,this.notifyChange("updating")}get running(){return this.updating}runTask(e){this._dirty=!1,this._pendingTiles||(this._startUpdate(),this._frameWorker!=null&&(this._frameWorker.priority=gt.FEATURE_TILE_TREE_ACTIVE)),this._subdivideTilesForView(e),this._pendingTiles||this._frameWorker==null||(this._frameWorker.priority=gt.FEATURE_TILE_TREE),this.notifyChange("updating")}_startUpdate(){if(this.suspended)return;if(!this.tilingScheme)return void this._clear();this._tileMeasurements||(this._tileMeasurements=new DCt({renderCoordsHelper:this.renderCoordsHelper,tilingScheme:this.tilingScheme,tileSize:this.tileSize}));const e=this.viewState.contentCamera;this._tileMeasurements.begin(e,this.focus.location,this.cameraOnSurface.location.z??0),this._pendingTiles=this._getRootTiles()}_reset(){this._newTiles.clear(),this._tileMeasurements=null,this._pendingTiles=null,this._setDirty()}_getRootTiles(){const{tilingScheme:e}=this;return this._rootTileIds.map(r=>new _M(r[0],r[1],r[2],e))}_purgeHorizonTiles(e){e.sort((r,i)=>{const s=r.measures.screenRect,n=i.measures.screenRect;return s[1]+s[3]-(n[1]+n[3])}),Au(BN);for(let r=0;r<e.length;r++)if(E1(BN,e.data[r].measures.screenRect,BN),Mf(BN)>VCt)return e.data.slice(r,e.length);return[]}_subdivideTilesForView(e){if(!this._pendingTiles)return;const{tilingScheme:r}=this;for(;this._pendingTiles.length>0&&!e.done;){const i=this._pendingTiles.pop();e.madeProgress(),this._filterExtentRect&&!JP(this._filterExtentRect,i.extent)||(this._tileMeasurements.updateTile(i),i.measures.visibility!==ja.INVISIBLE&&(i.measures.shouldSplit?(r.ensureMaxLod(i.lij[0]+1),this._pendingTiles.push(...i.getChildren())):this._newTiles.push(i)))}this._pendingTiles.length===0&&(this._updateTiles(this._purgeHorizonTiles(this._newTiles)),this._newTiles.clear(),this._tileMeasurements.end(),this._pendingTiles=null)}_updateTiles(e){for(const s of this.tiles.items)s.used=!1;const r=e.filter(s=>{const n=this._idToTile.get(s.id);return n?(n.copyMeasurementsFrom(s),n.used=!0):this._idToTile.set(s.id,s),!n}),i=this.tiles.items.filter(s=>!s.used&&(this._idToTile.delete(s.id),!0));this.tiles.removeMany(i),this.tiles.addMany(r),this._sortTiles()}_sortTiles(){this.viewState.fixedContentCamera||this.tiles.sort((e,r)=>e.measures.visibility!==r.measures.visibility?e.measures.visibility===ja.VISIBLE_ON_SURFACE?-1:1:e.measures.distance-r.measures.distance),this.tiles.forEach((e,r)=>e.loadPriority=r)}};u([d({constructOnly:!0})],Qo.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Qo.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Qo.prototype,"tilingSchemeOwner",void 0),u([d({constructOnly:!0})],Qo.prototype,"cameraOnSurface",void 0),u([d({constructOnly:!0})],Qo.prototype,"focus",void 0),u([d({constructOnly:!0})],Qo.prototype,"viewState",void 0),u([d({constructOnly:!0})],Qo.prototype,"terrain",void 0),u([d()],Qo.prototype,"tiles",void 0),u([d()],Qo.prototype,"tileSize",void 0),u([d({readOnly:!0})],Qo.prototype,"tilingScheme",null),u([d()],Qo.prototype,"filterExtent",null),u([d({readOnly:!0})],Qo.prototype,"_filterExtentRect",null),u([d({readOnly:!0})],Qo.prototype,"_rootTileIds",null),u([d({value:!1})],Qo.prototype,"suspended",null),u([d({readOnly:!0})],Qo.prototype,"updating",null),Qo=u([R("esri.views.3d.layers.support.FeatureTileTree3D")],Qo);let kCt=0;function UCt(){return kCt++}const BN=Ht(),VCt=10;let Es=class extends me{constructor(){super(...arguments),this._propertiesPool=new M0({camera:ft},this),this._lastSeenCameraProjectionValues=new ft,this.mode=Br.ANIMATING,this._cssCamera=new ft,this._camera=new ft,this.rasterPixelRatio=1,this.contentPixelRatio=1,this.events=new Xr,this.viewingMode=Ue.Global,this._cameraChanged=!1,this._updateQueue=new Array,this._processingUpdates=!1}init(e,r){this._set("viewingMode",e),this._set("spatialReference",r),this._set("constraints",new Iy({mode:this.viewingMode}))}exit(){this.cameraController?.destroy(),this.cameraController=null,this._propertiesPool.destroy(),this._propertiesPool=new M0({camera:ft},this)}destroy(){this.cameraController?.destroy(),this.cameraController=null,this._propertiesPool?.destroy(),this._propertiesPool=null}createInitialCamera(){if(this.viewingMode===Ue.Global){const e=Ir(this.spatialReference).radius;this.camera=new ft({eye:Ee(4*e,0,0),center:Ee(e,0,0),up:Ee(0,0,1)})}else this.camera=new ft({eye:Ee(0,0,100),center:Ee(0,0,0),up:Ee(0,1,0)})}get animation(){return this.cameraController instanceof _P&&this.cameraController.viewAnimation!=null?this.cameraController.viewAnimation:null}get camera(){return this._camera}get cssCamera(){const e=this._cssCamera.copyFrom(this.camera),{height:r,width:i,pixelRatio:s}=this.camera;return e.pixelRatio=1,e.height=Math.round(r/s),e.width=Math.round(i/s),e}set camera(e){e!==zh&&zh.copyFrom(e),zh.computeUp(this.viewingMode),this.events.emit("before-camera-change",zh);const r=this._camera;if(this._cameraProjectionChanged(this._lastSeenCameraProjectionValues,zh)&&(this._lastSeenCameraProjectionValues.copyFrom(zh),this.events.emit("camera-projection-changed",this._lastSeenCameraProjectionValues)),!r.equals(zh)&&(this._camera=this._propertiesPool.get("camera").copyFrom(zh),this._cameraChanged=!r.almostEquals(zh),this._cameraChanged)){const i=Xve(()=>{this._cameraChanged=!1,i.remove()})}}get pixelRatio(){return this.camera.pixelRatio}get alignPixelEnabled(){return this.pixelRatio===this.rasterPixelRatio&&this.mode===Br.IDLE}get updating(){return!this.alignPixelEnabled}get contentCamera(){return this._contentCamera??this.camera}set contentCamera(e){this._contentCamera=e!=null?e.clone():null}get fixedContentCamera(){return this._contentCamera!=null}get isGlobal(){return this.viewingMode===Ue.Global}get isLocal(){return this.viewingMode===Ue.Local}get navigating(){return!(!this.cameraController||!this.cameraController.isInteractive)}get stationary(){return!this._cameraChanged&&!this.navigating}get cameraController(){return this._get("cameraController")}set cameraController(e){this.stopActiveCameraController()?(this.cameraController?.destroy(),e&&(this.removeHandles(gme),this.addHandles(No(()=>e.state===ys.Finished||e.state===ys.Stopped,()=>{this._set("cameraController",null),this.updateCamera(r=>e.onControllerEnd(r))},{sync:!0,once:!0}),gme),e.onControllerStart(this.camera)),this._set("cameraController",e)):e&&(e.state=ys.Rejected)}switchCameraController(e){return this.cameraController=e,e.state!==ys.Rejected}stopActiveCameraController(){return!(this.cameraController&&!this.cameraController.stopController())}updateCamera(e){this._updateQueue.push(e),this._processUpdateQueue()}_processUpdateQueue(){if(this._updateQueue.length===0||this._processingUpdates)return;this._processingUpdates=!0;const e=this._updateQueue.shift();zh.copyFrom(this._get("camera")),e(zh),this.camera=zh,this._processingUpdates=!1,this._processUpdateQueue()}_cameraProjectionChanged(e,r){return e.fov!==r.fov||e.fullViewport[0]!==r.fullViewport[0]||e.fullViewport[1]!==r.fullViewport[1]||e.fullViewport[2]!==r.fullViewport[2]||e.fullViewport[3]!==r.fullViewport[3]||e.padding[sr.TOP]!==r.padding[sr.TOP]||e.padding[sr.RIGHT]!==r.padding[sr.RIGHT]||e.padding[sr.BOTTOM]!==r.padding[sr.BOTTOM]||e.padding[sr.LEFT]!==r.padding[sr.LEFT]}};u([d()],Es.prototype,"mode",void 0),u([d({readOnly:!0,type:OA})],Es.prototype,"animation",null),u([d({type:ft})],Es.prototype,"camera",null),u([d({type:ft})],Es.prototype,"cssCamera",null),u([d()],Es.prototype,"_cssCamera",void 0),u([d()],Es.prototype,"_camera",void 0),u([d({readOnly:!0})],Es.prototype,"pixelRatio",null),u([d()],Es.prototype,"rasterPixelRatio",void 0),u([d()],Es.prototype,"contentPixelRatio",void 0),u([d({readOnly:!0})],Es.prototype,"alignPixelEnabled",null),u([d({readOnly:!0})],Es.prototype,"updating",null),u([d({})],Es.prototype,"_contentCamera",void 0),u([d({type:ft})],Es.prototype,"contentCamera",null),u([d({readOnly:!0})],Es.prototype,"fixedContentCamera",null),u([d({readOnly:!0})],Es.prototype,"constraints",void 0),u([d({readOnly:!0})],Es.prototype,"events",void 0),u([d({readOnly:!0})],Es.prototype,"isGlobal",null),u([d({readOnly:!0})],Es.prototype,"isLocal",null),u([d({readOnly:!0})],Es.prototype,"viewingMode",void 0),u([d({readOnly:!0})],Es.prototype,"spatialReference",void 0),u([d()],Es.prototype,"navigating",null),u([d()],Es.prototype,"stationary",null),u([d()],Es.prototype,"_cameraChanged",void 0),u([d()],Es.prototype,"cameraController",null),Es=u([R("esri.views.3d.state.ViewState")],Es);const zCt=Es,zh=new ft,gme="ViewStateHandles";let BCt=class{constructor(e,r,i){this.viewingMode=e,this._forEachLayer=r,this._view=i,this._externalIntersectionHandlers=new qt,this._tolerance=$A,this._tmpRay=Io(),this._tmpRegion=Ht(),this._validateHUDIntersector=Jd(this.viewingMode),this._validateHUDIntersector.options.hud=!1}intersectScreen(e,r,i){return this.intersectRay(this._getPickRay(e,this._tmpRay),yme(this.viewingMode),r,i)}intersectScreenFreePointFallback(e,r,i){return this.intersectRayFreePointFallback(this._getPickRay(e,this._tmpRay),r,i)}intersectRayFreePointFallback(e,r,i){return this.intersectRay(e,yme(this.viewingMode),r,i)||this._intersectRayFreePointLocal(e,r)}intersectRay(e,r,i,s){return r.options.selectionMode=!1,r.options.store=na.MIN,this.computeIntersection(e,r,s),!!r.results.min&&r.results.min.getIntersectionPoint(i)}getCenterRayWithSubpixelOffset(e,r,i=.5,s=.5){return e.getRenderCenter(HN,i,s),HN[0]+=.0466,HN[1]-=.0123,gre(e,HN,r)}intersectIntersectorScreen(e,r,i){this.computeIntersection(this._getPickRay(e,this._tmpRay),r,i)}intersectToolIntersectorScreen(e,r,i){const s=this._getPickRay(e,this._tmpRay);this.intersectToolIntersectorRay(s,r,i)}intersectToolIntersectorRay(e,r,i){r.options.selectionMode=!0,this.computeIntersection(e,r,i);const s=r.results.min;this._view.basemapTerrain&&this._view.basemapTerrain.opaque||Bf(s)&&s.intersector!==ls.TERRAIN||(r.options.selectionMode=!1,this.computeIntersection(e,r,i))}setTolerance(e=$A){this._tolerance=e}addIntersectionHandler(e){this._externalIntersectionHandlers.push(e),this._externalIntersectionHandlers.sort((r,i)=>r.type===ls.TERRAIN?1:i.type===ls.TERRAIN?-1:0)}removeIntersectionHandler(e){this._externalIntersectionHandlers.removeUnordered(e)!=null&&this._externalIntersectionHandlers.sort((r,i)=>r.type===ls.TERRAIN?1:i.type===ls.TERRAIN?-1:0)}_getPickRay(e,r){const i=this._view.state.camera;return $Me(i,e,r)}_intersectRayFreePointLocal(e,r){return this.viewingMode!==Ue.Local||e==null||ue(r,e.origin,_e(ke.get(),e.direction)),!1}intersectElevationFromScreen(e,r,i=0,s=null){return this._intersectElevation(this._getPickRay(e,this._tmpRay),r,i,s)}_intersectElevation(e,r,i=0,s=null){if(e==null)return null;const n=r!=null?r.mode:"absolute-height",o=r?.offset??0,a=n!=="on-the-ground"?o+i:0,l=a/this._view.renderCoordsHelper.unitInMeters;if(n==="absolute-height"){if(this._view.renderCoordsHelper.intersectInfiniteManifold(e,a,jN)){const x=this._view.computeMapPointFromVec3d(jN);return x.z??(x.z=0),x.z-=o,x}return null}const c=this._view.state.camera,h=ke.get();c.projectToRenderScreen(e.origin,h);const p=new _me(null,this._forEachLayer),f=this._view.slicePlane,m=f!=null?Ghe(f):null,g=Jd(this.viewingMode);g.options.store=na.MIN,g.options.verticalOffset=l;const _=e.origin,v=ue(ke.get(),_,e.direction);g.reset(_,v,c),g.point=h;const b=s?"type"in s&&s.type==="graphics"?x=>x.layerUid!==s.uid:x=>x.graphicUid!==s.uid:null;switch(n){case"relative-to-scene":{const x=T=>(!b||b(T))&&!!T.lastValidElevationBB;g.intersect(p.layers,h,this._tolerance,null,x),this._externalIntersectionHandlers.forAll(T=>{if(T.type===ls.I3S||T.type===ls.TERRAIN){const S=T.slicePlaneEnabled?m:null;T.intersect(g,S,g.rayBegin,g.rayEnd,h)}});break}case"on-the-ground":case"relative-to-ground":this._externalIntersectionHandlers.forAll(x=>{if(x.isGround){const T=x.slicePlaneEnabled?m:null;x.intersect(g,T,g.rayBegin,g.rayEnd,h)}})}if(g.results.min.getIntersectionPoint(jN)){const x=this._view.computeMapPointFromVec3d(jN);return x.z=i,x}return null}computeIntersection(e,r,i){if(e==null)return;const s=this._view.state.camera,n=ke.get();s.projectToRenderScreen(e.origin,n);const o=new _me(i,this._forEachLayer);r.options.selectOpaqueTerrainOnly=!i||!("include"in i||"exclude"in i);const a=e.origin,l=ue(ke.get(),e.origin,e.direction);r.reset(a,l,s),r.intersect(o.layers,n,this._tolerance);const c=this._view.slicePlane,h=c!=null?Ghe(c):null;r.intersect(o.sliceableLayers,n,this._tolerance,h);const p=i&&(i.requiresGroundFeedback||i.enableDraped);this._externalIntersectionHandlers.forAll(g=>{const _=g.layerUid,v=Array.isArray(_),b=v?_:[_];v&&(r.options.filteredLayerUids=[]);let x=!1;for(const T of b)o.filterLayerUid(T)?x=!0:v&&r.options.filteredLayerUids.push(T);if(r.options.isFiltered=!x,g.isGround&&p||!r.options.isFiltered){const T=g.slicePlaneEnabled?h:null;g.intersect(r,T,a,l,n)}});const f=ke.get(),m=this._view.basemapTerrain;if(i&&i.enableDraped&&m.spatialReference!=null&&r.results.ground.getIntersectionPoint(f)){const g=m.overlayManager.renderer,_=this._view.renderCoordsHelper.spatialReference,v=ke.get();this._view.renderCoordsHelper.fromRenderCoords(f,v,m.spatialReference),v[2]=this._view.elevationProvider?.getElevation(f[0],f[1],f[2],_,"ground")??0,g.intersect(r,v,r.results.ground,b=>o.filterRenderGeometry(b))}r.sortResults(),this._processHUDResults(r)}_processHUDResults(e){const r=e.results.hud;C0(this._tmpRegion,v7);const i=this._view.state.camera,s=[],n=this._tmpRegion,o=b=>{const x=new jCt(b);i.projectToRenderScreen(b.target.center,x.screenPoint),x.screenPoint[0]=Math.floor(x.screenPoint[0]),x.screenPoint[1]=Math.floor(x.screenPoint[1]),s.push(x),xC(n,x.screenPoint)};e.sortResults(r.all),r.min.dist!=null&&o(r.min);for(const b of r.all)r.min.target.object!==b.target.object&&r.max.target.object!==b.target.object&&o(b);if(r.max.dist!=null&&r.max.target.object!==r.min.target.object&&o(r.max),!s.length)return;n[0]===n[2]&&(n[2]+=1),n[1]===n[3]&&(n[3]+=1);const a=i.fullWidth,l=i.fullHeight,c=Math.max(0,n[0]-vM),h=Math.max(0,n[1]-vM),p=Math.min(hh(n)+2*vM,a-c),f=Math.min(Mf(n)+2*vM,l-h),m=new Uint8Array(p*f*4);this._view._stage.renderer.readHUDVisibility(c,h,p,f,m);let g=!0;const _=e.results.max.dist==null;let v=0;for(const b of s)for(const x of GCt)if(m[4*(Math.min(b.screenPoint[0]+x[0],a)-n[0]+(Math.min(b.screenPoint[1]+x[1],l)-n[1])*p)]){g&&(e.results.min.copy(b.result),g=!1),_&&e.results.max.copy(b.result),e.options.store===na.ALL&&e.results.all.splice(v++,0,b.result);break}}};const vM=1,GCt=(()=>{const t=[],e=vM;for(let r=-e;r<=e;r++)for(let i=-e;i<=e;i++)t.push([i+e,r+e]);return t})();let jCt=class{constructor(e){this.result=e,this.screenPoint=Lo()}},GN;function yme(t){return GN&&GN.viewingMode===t||(GN=Jd(t)),GN}let _me=class{constructor(e,r){this.layers=new Array,this.sliceableLayers=new Array,this.include=e?.include,this.exclude=e?.exclude,r(i=>{i.pickable&&this.filterLayerUid(i.apiLayerUid)&&(i.sliceable?this.sliceableLayers:this.layers).push(i)})}filterLayerUid(e){const{include:r,exclude:i}=this;return e==null?r==null&&i==null:(r==null||r.has(e))&&(i==null||!i.has(e))}filterRenderGeometry(e){return this.filterLayerUid(e.layerUid)}};function vme(t){return typeof t=="object"&&"intersect"in t}const jN=C(),HN=Lo();let aZt=class{constructor(e,r){this.spatialReference=e,this._view=r}getElevation(e,r,i){return this._view.elevationProvider.getElevation(e,r,0,this.spatialReference,i)}async queryElevation(e,r,i,s,n){return this._view.elevationProvider.queryElevation(e,r,0,this.spatialReference,n,i,s)}},HCt=class{constructor(e,r,i,s){this.spatialReference=r,this._getElevationQueryProvider=i,this._queries=new Array,this._queryOptions={...s,ignoreInvisibleLayers:!0},this._frameTask=e.registerTask(gt.ELEVATION_QUERY,this)}destroy(){this._frameTask.remove()}queryElevation(e,r,i,s=0){const n=nn(),o={x:e,y:r,minDemResolution:s,result:n,signal:i};return this._queries.push(o),xn(i,()=>{II(this._queries,o),n.reject(Tr())}),n.promise}get running(){return this._queries.length>0}runTask(e){const r=this._queries;this._queries=[];const i=this._getElevationQueryProvider();if(!i)return r.forEach(h=>h.result.reject()),void e.madeProgress();const s=r.map(h=>[h.x,h.y]),n=r.reduce((h,p)=>Math.min(h,p.minDemResolution),1/0),o=new ZP({points:s,spatialReference:this.spatialReference}),a=r.length>1&&r.some(h=>!!h.signal)?new AbortController:null,l=a!=null?a.signal:r[0].signal;if(a!=null){let h=0;r.forEach(p=>xn(p.signal,()=>{h++,p.result.reject(Tr()),h===r.length&&a.abort()}))}const c={...this._queryOptions,minDemResolution:n,signal:l};i.queryElevation(o,c).then(h=>{r.forEach((p,f)=>{p.signal!=null&&p.signal.aborted?p.result.reject(Tr()):p.result.resolve(h.geometry.points[f][2])})}).catch(h=>{r.forEach(p=>p.result.reject(h))}),e.madeProgress()}get test(){const e=this;return{update:()=>e._queries.length>0&&e.runTask(Ll)}}},bM=class extends Xr.EventedMixin(me){get spatialReference(){return this.view?.basemapTerrain?.spatialReference}constructor(e){super(e),this._im=new Array,this._ground=new Array,this._scene=new Array,this._handles=new Map,this.lastElevationQuery=null,this.elevationCacheEnabled=!1}destroy(){this._elevationQueryCached=Re(this._elevationQueryCached)}get _elevationQuery(){return this._elevationQueryCached==null&&(this._elevationQueryCached=new HCt(this.view.resourceController.scheduler,this.view.spatialReference,()=>this.view.map&&this.view.map.ground,{maximumAutoTileRequests:4})),this._elevationQueryCached}enableElevationCache(e){e||(this.lastElevationQuery=null),this.elevationCacheEnabled=e}getElevation(e,r,i,s,n){if(this.elevationCacheEnabled&&this.lastElevationQuery!=null){const a=this.lastElevationQuery;if(e===a.x&&r===a.y&&i===a.z&&Bn(s,a.spatialReference)&&n===a.queryContext)return a.result}let o=null;return o=qN(o,this._im,e,r,i,s,n),o==null&&(o=qN(o,this._ground,e,r,i,s,n)),n==="scene"&&(o=qN(o,this._scene,e,r,i,s,n)),this.elevationCacheEnabled&&(this.lastElevationQuery={x:e,y:r,z:i,spatialReference:s,queryContext:n,result:o}),o}getSphereElevationBounds(e,r){let i=1/0,s=-1/0;for(const n of[this._im,this._ground,this._scene])n.forEach(o=>{if(o.getSphereElevationBounds){const a=o.getSphereElevationBounds(e,r);a!=null&&(i=Math.min(i,a.min),s=Math.max(s,a.max))}});return{min:i,max:s}}queryElevation(e,r,i,s,n,o=null,a=0){const l=nn();return this._elevationQuery.queryElevation(e,r,o,a).then(c=>{n==="scene"&&(c=qN(c,this._scene,e,r,i,s,n)),l.resolve(c)}).catch(c=>{ws(c)?l.reject(c):l.resolve(this.getElevation(e,r,i,s,n))}),l.promise}register(e,r){this._handles.set(r,r.on("elevation-change",i=>this.emit("elevation-change",i))),this._providersFromContext(e).push(r)}unregister(e){this._handles.has(e)&&(this._handles.get(e)?.remove(),this._handles.delete(e));for(const r of[this._im,this._ground,this._scene]){const i=r.indexOf(e);i>-1&&r.splice(i,1)}}_providersFromContext(e){switch(e){case"ground":return this._ground;case"im":return this._im;case"scene":return this._scene}}};function qN(t,e,r,i,s,n,o){for(const a of e){const l=a.getElevation(r,i,s,n,o);l!=null&&(t=t!=null?Math.max(l,t):l)}return t}u([d({constructOnly:!0})],bM.prototype,"view",void 0),u([d()],bM.prototype,"spatialReference",null),bM=u([R("esri.views.3d.support.CombinedElevationProvider")],bM);let wM=class WY{static isValidProfile(e){return e in WY.profiles}static getDefaultProfile(){return le("esri-iPhone")?"low":"medium"}static apply(e,r){const i=WY.profiles[e];r.graphics3D.maxTotalNumberOfFeatures=i.graphics3D.maxTotalNumberOfFeatures,r.graphics3D.maxTotalNumberOfPrimitives=i.graphics3D.maxTotalNumberOfPrimitives,r.graphics3D.polygonLodFactor=i.graphics3D.polygonLodFactor,r.graphics3D.polylineLodFactor=i.graphics3D.polylineLodFactor,r.graphics3D.snapshotAvailable=i.graphics3D.snapshotAvailable,r.graphics3D.skipHighSymbolLods=i.graphics3D.skipHighSymbolLods;const s=r.sceneService.object,n=i.sceneService.object;s.lodFactor=n.lodFactor,s.lodCrossfadeinDuration=n.lodCrossfadeinDuration,s.lodCrossfadeoutDuration=n.lodCrossfadeoutDuration,s.lodCrossfadeUncoveredDuration=n.lodCrossfadeUncoveredDuration,r.sceneService.point.lodFactor=i.sceneService.point.lodFactor,r.sceneService.integratedMesh.lodFactor=i.sceneService.integratedMesh.lodFactor,r.sceneService.pointCloud.lodFactor=i.sceneService.pointCloud.lodFactor,r.sceneService.uncompressedTextureDownsamplingEnabled=i.sceneService.uncompressedTextureDownsamplingEnabled,r.tiledSurface.lodBias=i.tiledSurface.lodBias,r.tiledSurface.angledSplitBias=i.tiledSurface.angledSplitBias,r.tiledSurface.reduceTileLevelDifferences=i.tiledSurface.reduceTileLevelDifferences,r.tiledSurface.textureFadeDuration=i.tiledSurface.textureFadeDuration,r.heatmap.pixelRatio=i.heatmap.pixelRatio,r.heatmap.maxTotalNumberOfFeatures=i.heatmap.maxTotalNumberOfFeatures,r.fadeDuration=i.fadeDuration,r.antialiasingEnabled=i.antialiasingEnabled,r.physicallyBasedRenderingEnabled=i.physicalBasedRenderingEnabled,r.highQualityTransparency=i.highQualityTransparency,r.highResolutionAtmosphere=i.highResolutionAtmosphere,r.reflections=i.reflections,r.ambientOcclusion=i.ambientOcclusion,r.memoryLimit=i.memoryLimit,r.additionalCacheMemory=i.additionalCacheMemory,r.frameRate=i.frameRate,r.maximumPixelRatio=i.maximumPixelRatio}};function bme(){const t=!!le("esri-mobile"),e=!!le("ios"),r=400;return{low:{graphics3D:{maxTotalNumberOfFeatures:25e3,maxTotalNumberOfPrimitives:85e4,polygonLodFactor:.5,polylineLodFactor:1,snapshotAvailable:!1,skipHighSymbolLods:!0},heatmap:{pixelRatio:.125,maxTotalNumberOfFeatures:25e3},sceneService:{object:{lodFactor:.2,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:0},point:{lodFactor:1},integratedMesh:{lodFactor:.6},pointCloud:{lodFactor:.5},uncompressedTextureDownsamplingEnabled:!0},tiledSurface:{lodBias:-1,angledSplitBias:.5,reduceTileLevelDifferences:!1,textureFadeDuration:0},fadeDuration:0,antialiasingEnabled:!1,physicalBasedRenderingEnabled:!1,highQualityTransparency:!1,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:200,additionalCacheMemory:0,frameRate:0,maximumPixelRatio:1},medium:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?.8:1,polylineLodFactor:t?1.2:1.5,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.25,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:t},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!le("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!1,reflections:!1,ambientOcclusion:!1,memoryLimit:t?600:750,additionalCacheMemory:t?-100:150,frameRate:0,maximumPixelRatio:1},high:{graphics3D:{maxTotalNumberOfFeatures:5e4,maxTotalNumberOfPrimitives:17e5,polygonLodFactor:t?1.2:2,polylineLodFactor:t?1.2:2,snapshotAvailable:!e,skipHighSymbolLods:!1},heatmap:{pixelRatio:.5,maxTotalNumberOfFeatures:5e4},sceneService:{object:{lodFactor:1,lodCrossfadeinDuration:0,lodCrossfadeoutDuration:0,lodCrossfadeUncoveredDuration:r},point:{lodFactor:1},integratedMesh:{lodFactor:1},pointCloud:{lodFactor:1},uncompressedTextureDownsamplingEnabled:!1},tiledSurface:{lodBias:0,angledSplitBias:1,reduceTileLevelDifferences:!le("disable-feature:reduce-map-tile-levels"),textureFadeDuration:r},fadeDuration:r,antialiasingEnabled:!0,physicalBasedRenderingEnabled:!0,highQualityTransparency:!0,highResolutionAtmosphere:!0,reflections:!0,ambientOcclusion:!0,memoryLimit:t?900:1500,additionalCacheMemory:t?-150:0,frameRate:0,maximumPixelRatio:t?1:1/0}}}wM.test={reset(){const t=bme();for(const e of Object.keys(t))wM.profiles[e]=t[e]}},function(t){t.profiles=bme()}(wM||(wM={}));const f5=wM;function GDe(){return new Float32Array(4)}function qCt(t){const e=new Float32Array(4);return e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e}function Mg(t,e,r,i){const s=new Float32Array(4);return s[0]=t,s[1]=e,s[2]=r,s[3]=i,s}function WCt(t,e){return new Float32Array(t,e,4)}function jDe(){return GDe()}function HDe(){return Mg(1,1,1,1)}function qDe(){return Mg(1,0,0,0)}function WDe(){return Mg(0,1,0,0)}function ZDe(){return Mg(0,0,1,0)}function XDe(){return Mg(0,0,0,1)}const ZCt=jDe(),XCt=HDe(),YCt=qDe(),JCt=WDe(),QCt=ZDe(),KCt=XDe();Object.freeze(Object.defineProperty({__proto__:null,ONES:XCt,UNIT_W:KCt,UNIT_X:YCt,UNIT_Y:JCt,UNIT_Z:QCt,ZEROS:ZCt,clone:qCt,create:GDe,createView:WCt,fromValues:Mg,ones:HDe,unitW:XDe,unitX:qDe,unitY:WDe,unitZ:ZDe,zeros:jDe},Symbol.toStringTag,{value:"Module"}));const wme=new Le([0,255,255]),xme=new Le([0,0,0]),Tme=1,Sme=.25,Eme=.4,Cme=.2;let $m=class extends me{constructor(){super(...arguments),this.color=wme.clone(),this.haloColor=null,this.haloOpacity=Tme,this.fillOpacity=Sme,this.shadowOpacity=Eme,this.shadowColor=xme.clone(),this.shadowDifference=Cme}static toEngineOptions(e){const r=Le.toUnitRGBA(e.color??wme),i=e.haloColor!=null?Le.toUnitRGBA(e.haloColor):r,s=Le.toUnitRGBA(e.shadowColor??xme),n=e.haloOpacity??Tme,o=e.fillOpacity??Sme,a=e.shadowOpacity??Eme,l=e.shadowDifference??Cme;return{color:Mg(r[0],r[1],r[2],r[3]),haloColor:Mg(i[0],i[1],i[2],i[3]),haloOpacity:n,haloOpacityOccluded:.25*n,fillOpacity:o,fillOpacityOccluded:.25*o,shadowOpacity:a,shadowColor:Vt(s[0],s[1],s[2],s[3]),occludedShadowOpacity:a*(1-l)}}};u([d({type:Le})],$m.prototype,"color",void 0),u([d({type:Le})],$m.prototype,"haloColor",void 0),u([d()],$m.prototype,"haloOpacity",void 0),u([d()],$m.prototype,"fillOpacity",void 0),u([d()],$m.prototype,"shadowOpacity",void 0),u([d({type:Le})],$m.prototype,"shadowColor",void 0),u([d()],$m.prototype,"shadowDifference",void 0),$m=u([R("esri.views.3d.support.HighlightOptions")],$m);const ZY=$m;function eAt(t,e){return e?{...e,query:{...t??{},...e.query}}:{query:t}}function tAt(t){return typeof t=="string"?Fn(t):re(t)}function rAt(t,e,r){const i={};for(const s in t){if(s==="declaredClass")continue;const n=t[s];if(n!=null&&typeof n!="function")if(Array.isArray(n)){i[s]=[];for(let o=0;o<n.length;o++)i[s][o]=rAt(n[o])}else if(typeof n=="object")if(n.toJSON){const o=n.toJSON(r&&r[s]);i[s]=e?o:JSON.stringify(o)}else i[s]=e?n:JSON.stringify(n);else i[s]=n}return i}function dZt(t){return{geometryType:GQ(t[0]),geometries:t.map(e=>e.toJSON())}}function iAt(t,e,r){const i=G9e(e);return t.map(s=>{const n=i.fromJSON(s);return n.spatialReference=r,n})}let hx=class extends he{constructor(e){super(e),this.geometries=[],this.outSpatialReference=null,this.transformation=null,this.transformForward=null}toJSON(){const e=this.geometries.map(s=>s.toJSON()),r=this.geometries[0],i={};return i.outSR=this.outSpatialReference.wkid||JSON.stringify(this.outSpatialReference.toJSON()),i.inSR=r.spatialReference.wkid||JSON.stringify(r.spatialReference.toJSON()),i.geometries=JSON.stringify({geometryType:GQ(r),geometries:e}),this.transformation&&(i.transformation=this.transformation.wkid||JSON.stringify(this.transformation)),this.transformForward!=null&&(i.transformForward=this.transformForward),i}};u([d()],hx.prototype,"geometries",void 0),u([d({json:{read:{source:"outSR"}}})],hx.prototype,"outSpatialReference",void 0),u([d()],hx.prototype,"transformation",void 0),u([d()],hx.prototype,"transformForward",void 0),hx=u([R("esri.rest.support.ProjectParameters")],hx);const Iie=hx,sAt=Sn(Iie);async function YDe(t,e,r){e=sAt(e);const i=tAt(t),s={...i.query,f:"json",...e.toJSON()},n=e.outSpatialReference,o=GQ(e.geometries[0]),a=eAt(s,r);return Lt(i.path+"/project",a).then(({data:{geometries:l}})=>iAt(l,o,n))}async function Pie(t=null,e){if(qr.geometryServiceUrl)return qr.geometryServiceUrl;if(!t)throw new D("internal:geometry-service-url-not-configured");let r;r="portal"in t?t.portal||ao.getDefault():t,await r.load({signal:e});const i=r.helperServices?.geometry?.url;if(!i)throw new D("internal:geometry-service-url-not-configured");return i}async function nAt(t,e,r=null,i){const s=await Pie(r,i),n=new Iie;n.geometries=[t],n.outSpatialReference=e;const o=await YDe(s,n,{signal:i});if(o&&Array.isArray(o)&&o.length===1)return o[0];throw new D("internal:geometry-service-projection-failed")}const oAt=Object.freeze(Object.defineProperty({__proto__:null,getGeometryServiceURL:Pie,projectGeometry:nAt},Symbol.toStringTag,{value:"Module"}));let aAt=class{constructor(e,r){this.spatialReference=r,this.unitInMeters=Uo(this.spatialReference,Ir(this.spatialReference).metersPerDegree),this._geometryServiceURLPromise=Pie(e&&e.get("portalItem")).catch(()=>{throw new D("mapcoordshelper:missing-geometry-service","Must specify geometryService in esri/config")})}async toGeographic(e){const r=await this._geometryServiceURLPromise;let i,s=!0;Array.isArray(e[0])&&typeof e[0]!="number"?i=e:(i=[e],s=!1);const n=i.map(l=>l instanceof ht?l:new ht(l,this.spatialReference)),o=new Iie({geometries:n,outSpatialReference:qe.WGS84}),a=(await YDe(r,o)).map(l=>l.type==="point"?[l.x,l.y]:void 0).filter(l=>!!l);return s?a:a[0]}},Zp=class extends me{constructor(){super(...arguments),this.minTotalNumberOfFeatures=2e3,this.maxTotalNumberOfFeatures=5e4,this.maxTotalNumberOfPrimitives=17e5,this.snapshotAvailable=!0,this.polygonLodFactor=1,this.polylineLodFactor=1,this.skipHighSymbolLods=!1}};u([d()],Zp.prototype,"minTotalNumberOfFeatures",void 0),u([d()],Zp.prototype,"maxTotalNumberOfFeatures",void 0),u([d()],Zp.prototype,"maxTotalNumberOfPrimitives",void 0),u([d()],Zp.prototype,"snapshotAvailable",void 0),u([d()],Zp.prototype,"polygonLodFactor",void 0),u([d()],Zp.prototype,"polylineLodFactor",void 0),u([d()],Zp.prototype,"skipHighSymbolLods",void 0),Zp=u([R("esri.views.3d.support.QualitySettings.Graphics3DSettings")],Zp);let hg=class extends me{constructor(){super(...arguments),this.lodFactor=1}};u([d()],hg.prototype,"lodFactor",void 0),hg=u([R("esri.views.3d.support.QualitySettings.LoDFactorSettings")],hg);let i6=class extends hg{constructor(){super(...arguments),this.lodCrossfadeinDuration=0,this.lodCrossfadeoutDuration=0,this.lodCrossfadeUncoveredDuration=0}};i6=u([R("esri.views.3d.support.QualitySettings.LoDFactor3DObjectSettings")],i6);let Hy=class extends me{constructor(){super(...arguments),this.object=new i6,this.point=new hg,this.integratedMesh=new hg,this.pointCloud=new hg,this.uncompressedTextureDownsamplingEnabled=!1}};u([d({type:i6})],Hy.prototype,"object",void 0),u([d({type:hg})],Hy.prototype,"point",void 0),u([d({type:hg})],Hy.prototype,"integratedMesh",void 0),u([d({type:hg})],Hy.prototype,"pointCloud",void 0),u([d()],Hy.prototype,"uncompressedTextureDownsamplingEnabled",void 0),Hy=u([R("esri.views.3d.support.QualitySettings.SceneServiceSettings")],Hy);let Gv=class extends me{constructor(){super(...arguments),this.lodBias=0,this.angledSplitBias=1,this.reduceTileLevelDifferences=!0,this.textureFadeDuration=400}};u([d()],Gv.prototype,"lodBias",void 0),u([d()],Gv.prototype,"angledSplitBias",void 0),u([d()],Gv.prototype,"reduceTileLevelDifferences",void 0),u([d()],Gv.prototype,"textureFadeDuration",void 0),Gv=u([R("esri.views.3d.support.QualitySettings.TiledSurfaceSettings")],Gv);let dC=class extends me{constructor(){super(...arguments),this.pixelRatio=1,this.maxTotalNumberOfFeatures=5e4}};u([d()],dC.prototype,"pixelRatio",void 0),u([d()],dC.prototype,"maxTotalNumberOfFeatures",void 0),dC=u([R("esri.views.3d.support.QualitySettings.HeatmapSettings")],dC);let _a=class extends me{constructor(){super(...arguments),this.graphics3D=new Zp,this.sceneService=new Hy,this.tiledSurface=new Gv,this.heatmap=new dC,this.fadeDuration=400,this.antialiasingEnabled=!0,this.physicallyBasedRenderingEnabled=!1,this.highQualityTransparency=!0,this.highResolutionAtmosphere=!1,this.reflections=!1,this.ambientOcclusion=!1,this.memoryLimit=750,this.additionalCacheMemory=0,this.frameRate=void 0,this.maximumPixelRatio=1/0}};u([d({type:Zp})],_a.prototype,"graphics3D",void 0),u([d({type:Hy})],_a.prototype,"sceneService",void 0),u([d({type:Gv})],_a.prototype,"tiledSurface",void 0),u([d({type:dC})],_a.prototype,"heatmap",void 0),u([d()],_a.prototype,"fadeDuration",void 0),u([d()],_a.prototype,"antialiasingEnabled",void 0),u([d()],_a.prototype,"physicallyBasedRenderingEnabled",void 0),u([d()],_a.prototype,"highQualityTransparency",void 0),u([d()],_a.prototype,"highResolutionAtmosphere",void 0),u([d()],_a.prototype,"reflections",void 0),u([d()],_a.prototype,"ambientOcclusion",void 0),u([d()],_a.prototype,"memoryLimit",void 0),u([d()],_a.prototype,"additionalCacheMemory",void 0),u([d()],_a.prototype,"frameRate",void 0),u([d()],_a.prototype,"maximumPixelRatio",void 0),_a=u([R("esri.views.3d.support.QualitySettings.QualitySettings")],_a);const Ame=_a;function lAt(t){return WA(t)&&t.length>=3}function cAt(t){return(ZA(t)||Array.isArray(t))&&t.length>=3}function uAt(t){return lAt(t)||cAt(t)}let hAt=class XY{constructor(e,r,i,s){this.viewingMode=e,this.spatialReference=r,this.unitInMeters=i,this._coordinateSystem=s,this._tmpCoordinateSystem=cct(s)}set extent(e){e&&uct(this._coordinateSystem,e,this._coordinateSystem)}getAltitude(e){return _ct(this._coordinateSystem,e)}setAltitude(e,r,i=e){return vRe(this._coordinateSystem,i,r,e)}setAltitudeOfTransformation(e,r){vct(this._coordinateSystem,r,e,r)}worldUpAtPosition(e,r){return fct(this._coordinateSystem,e,r)}worldBasisAtPosition(e,r,i){return mct(this._coordinateSystem,e,r,i)}basisMatrixAtPosition(e,r){const i=this.worldBasisAtPosition(e,vu.X,ke.get()),s=this.worldBasisAtPosition(e,vu.Y,ke.get()),n=this.worldBasisAtPosition(e,vu.Z,ke.get());return Dg(r,i[0],i[1],i[2],0,s[0],s[1],s[2],0,n[0],n[1],n[2],0,0,0,0,1),r}headingAtPosition(e,r){const i=this.worldUpAtPosition(e,ke.get()),s=this.worldBasisAtPosition(e,vu.Y,ke.get()),n=LOe(r,s,i);return Vl(n)}intersectManifoldClosestSilhouette(e,r,i){return Bz(this._coordinateSystem,r,this._tmpCoordinateSystem),yct(this._tmpCoordinateSystem,e,i),i}intersectManifold(e,r,i){Bz(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=ke.get();return gct(this._tmpCoordinateSystem,e,s)?oe(i,s):null}intersectInfiniteManifold(e,r,i){if(this.viewingMode===Ue.Global)return this.intersectManifold(e,r,i);Bz(this._coordinateSystem,r,this._tmpCoordinateSystem);const s=this._tmpCoordinateSystem.value,n=ke.get();return yS(s.plane,e,n)?oe(i,n):null}toRenderCoords(e,r,i){return $U(e)?aa(e,r,this.spatialReference):Tn(e,r,i,this.spatialReference)}fromRenderCoords(e,r,i=null){return $U(r)?(i!=null&&(r.spatialReference=i),gee(e,this.spatialReference,r)):uAt(r)?Tn(e,this.spatialReference,r,i)?r:null:R0(e,this.spatialReference,r)}static create(e,r){switch(e){case Ue.Local:return new XY(Ue.Local,r,Uo(r),pct());case Ue.Global:return new XY(Ue.Global,r,1,dct(r))}}static renderUnitScaleFactor(e,r){return hne(e)/hne(r)}};var Jm;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.BASEMAP=1]="BASEMAP",t[t.I3S_INDEX=2]="I3S_INDEX",t[t.I3S_DATA=3]="I3S_DATA",t[t.SYMBOLOGY=4]="SYMBOLOGY"})(Jm||(Jm={}));const dAt=(()=>{const t=new Array;return t[Jm.ELEVATION]=10,t[Jm.BASEMAP]=10,t[Jm.I3S_INDEX]=10,t[Jm.I3S_DATA]=10,t[Jm.SYMBOLOGY]=5,t})(),pAt=30;function JDe(t){return"usedMemory"in t&&"unloadedMemory"in t&&"ignoresMemoryFactor"in t}function fAt(t){return new oc({view:t})}const WN=1,qG=1,mAt=.75,gAt=.6,Ome=1.3;let oc=class extends me{constructor(e){super(e),this._quality=1,this._usedMemory=0,this._updating=!1,this.minQuality=.1,this._stableQuality=0,this._downscaleMemoryUsed=0,this._canFastRecover=!1,this._memoryPredicted=0,this._cacheStorage=new YTe,this._warnMemoryUsage=null,this._numQualityChanges=0,this._maxMemory=750,this._additionalCacheMemory=0}destroy(){this._cacheStorage.destroy()}set maxMemory(e){e==null||e<=0||(this._stableQuality=0,this._canFastRecover=!1,this._maxMemory<e&&this._updateQuality(WN),this._maxMemory=e)}get maxMemory(){return this._maxMemory}set additionalCacheMemory(e){e!=null&&(this._additionalCacheMemory=e)}get additionalCacheMemory(){return this._additionalCacheMemory}get memoryFactor(){return this._quality}get updating(){return this._updating}get usedMemory(){return this._usedMemory}newCache(e,r){return new uWe(e,this._cacheStorage,r)}resetStableQuality(){this._stableQuality=0}disableMemCache(){this.additionalCacheMemory=-4096}update(){if(this._updateMemory(),this._memoryPredicted<=0&&!this._updating)return;let e=this._layersUpdating();if(this._memoryPredicted<gAt&&this._canFastRecover)this._downscaleMemoryUsed=0,this._stableQuality=0,this._canFastRecover=!1,this._updateQuality(WN);else if(e)(this._memoryPredicted>1.1*qG||this._usedMemory>qG)&&(this._stableQuality>0?(this._downscaleMemoryUsed=0,this._updateQuality(this._stableQuality)):this._quality>this.minQuality&&this._downscaleMemoryUsed<this._usedMemory&&(this._updateQuality(this._quality/Ome),this._downscaleMemoryUsed=this._usedMemory,this._canFastRecover=!1));else if(this._downscaleMemoryUsed=0,this._usedMemory>qG)this._stableQuality=0,this._canFastRecover=!1,e=this._updateQuality(this._quality/Ome),this._downscaleMemoryUsed=this._memoryPredicted;else if(this._stableQuality!==this._quality)if(this._usedMemory<mAt&&this._quality<WN){this._stableQuality=this._quality;const r=.05;e=this._updateQuality(this._quality+r)}else this._quality<1&&(this._canFastRecover=!0);this._updating=e}_updateQuality(e){return(e=Math.min(Math.max(e,this.minQuality),WN))!==this._quality&&(this._quality=e,++this._numQualityChanges,!0)}_layersUpdating(){return this.view.allLayerViews.some(e=>!!e.updating)}_updateMemory(){if(!this.view)return;let e=0;this.view.basemapTerrain&&(e+=this.view.basemapTerrain.usedMemory);const r=this.view?._stage&&this.view._stage.renderView&&this.view._stage.renderer?.edgeView;r!=null&&(e+=r.usedMemory);let i=0;this.view.allLayerViews&&this.view.allLayerViews.forEach(a=>{if(JDe(a)){const l=a.ignoresMemoryFactor?this._quality:1;e+=a.usedMemory*l,i+=a.unloadedMemory*l}});const s=this._warnMemoryUsage==null||Math.round(10*e)!==Math.round(10*this._warnMemoryUsage),n=1048576*this.maxMemory;if(e>n&&s){this._warnMemoryUsage=e;const a=c=>(c/1048576).toLocaleString(void 0,{maximumFractionDigits:1})+" MB",l=Math.round(100*this._quality);K.getLogger(this).warn(`Memory Limit exceeded! Limit: ${a(n)} Current: ${a(e)} Projected: ${a(e+i)} Quality: ${l}%`)}this._usedMemory=e/n,this._memoryPredicted=(e+i)/n;const o=n-e;this._cacheStorage.maxSize=Math.max(0,o+1048576*this.additionalCacheMemory)}get test(){const e=this;return{cacheStorage:this._cacheStorage,resetQualityChanges:()=>{const r=e._numQualityChanges;return e._numQualityChanges=0,r}}}};u([d({constructOnly:!0})],oc.prototype,"view",void 0),u([d()],oc.prototype,"maxMemory",null),u([d()],oc.prototype,"additionalCacheMemory",null),u([d()],oc.prototype,"memoryFactor",null),u([d()],oc.prototype,"updating",null),u([d()],oc.prototype,"usedMemory",null),u([d()],oc.prototype,"_quality",void 0),u([d()],oc.prototype,"_usedMemory",void 0),u([d()],oc.prototype,"_updating",void 0),u([d()],oc.prototype,"_stableQuality",void 0),u([d()],oc.prototype,"_maxMemory",void 0),u([d()],oc.prototype,"_additionalCacheMemory",void 0),oc=u([R("esri.views.3d.support.MemoryController")],oc);let yAt=class{constructor(e){this.client=e,this._cancelled=!1,this.size=0,this.duration=0}},_At=class{constructor(e){this.typeWorkerQuota=e,this.tasks=new Array,this.numWorkers=0,this.statistics=new vAt}},vAt=class{constructor(){this.requests=0,this.size=0,this.duration=0,this.speed=0}},bAt=class{constructor(e,r,i,s){this._workerFunc=e,this._callbackFunc=r,this._maxTotalNumWorkers=i,this._totalNumWorkers=0,this._clients=s.map(n=>new _At(n))}destroy(){this._clients.length=0}hasQuota(e){const r=this._clients[e];return!!r&&(this._totalNumWorkers<this._maxTotalNumWorkers||r.numWorkers+r.tasks.length<r.typeWorkerQuota)}push(e){const r=this._clients[e.client];r&&(this._totalNumWorkers<this._maxTotalNumWorkers?(r.numWorkers++,this._totalNumWorkers++,this._workerFunc(e,(i,s)=>this._taskCallback(i,s))):r.tasks.push(e))}cancel(e){this._taskFinished(e),e._cancelled=!0}_taskFinished(e){const r=this._clients[e.client];this._totalNumWorkers--,r&&(r.numWorkers--,r.statistics.requests++,r.statistics.size+=e.size||0,r.statistics.duration+=e.duration||0,r.statistics.speed=r.statistics.duration>0?r.statistics.size/r.statistics.duration:0,it(r.numWorkers>=0)),this._next()}_next(){for(const e of this._clients)if(e&&e.numWorkers<e.typeWorkerQuota&&this._processQueue(e))return;for(const e of this._clients)if(e&&this._processQueue(e))return}_processQueue(e){for(;e.tasks.length>0;)if(this._workerFunc(e.tasks.shift(),(r,i)=>this._taskCallback(r,i)))return e.numWorkers++,this._totalNumWorkers++,!0;return!1}_taskCallback(e,r){e._cancelled||(this._callbackFunc(e,r),this._taskFinished(e))}getStatsForType(e){const r=this._clients[e];return r?{quota:r.typeWorkerQuota,workers:r.numWorkers,queueSize:r.tasks.length,requestStats:r.statistics}:null}get test(){const e=this;return{set workerFunc(r){e._workerFunc=r}}}},m5=class extends me{constructor(){super(...arguments),this._tasks=new Map,this._onLoadQueue=new Array,this._doneQueue=new Array,this.updating=!1}setup(e,r,i){this._loadQueue=new bAt((s,n)=>this._startLoading(s,n),(s,n)=>this._doneLoadingCB(s,n),e,r),i&&(this._frameTask=i.registerTask(gt.STREAM_DATA_LOADER,this))}destroy(){this._frameTask=Pi(this._frameTask),this._tasks.forEach(e=>Do(e.abortController)),this._loadQueue=Re(this._loadQueue),this._onLoadQueue=null,this._doneQueue=null,this._tasks=null}hasDownloadSlots(e){return this._loadQueue.hasQuota(e)}request(e,r,i,s={}){const n=nn();n.__signal=s!=null?s.signal:null;const o=this._createOrUpdateTask(e,r,i,s,n);return xn(s,()=>this._cancelRequest(o,n)),n.promise}_createTask(e,r,i,s,n,o){const a=new TAt(e,r,i,s,n);return this._updateTask(a,o),this._tasks.set(n,a),this._tasks.size===1&&this._set("updating",!0),this._loadQueue.push(a),a}_cancelRequest(e,r){MI(e.resolvers,r),r.reject(Tr()),e.resolvers.length===0&&(e.status===dd.DOWNLOADING&&(e.status=dd.CANCELLED,this._loadQueue.cancel(e),e.abortController?.abort(),e.request=null,e.abortController=null),e.status=dd.CANCELLED,this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1))}_updateTask(e,r){e.resolvers.push(r)}_createOrUpdateTask(e,r,i,s,n){const o=SAt(s!=null&&s.uid||e,r,i),a=this._tasks.get(o);return a?(this._updateTask(a,n),a):this._createTask(e,s,r,i,o,n)}_doneLoadingCB(e,r){this._loadQueue&&(it(e.status===dd.DOWNLOADING),e.status=dd.DOWNLOADED,this._frameTask?this._doneQueue.push({task:e,err:r}):this._doneLoading(e,r))}get running(){return this._doneQueue.length>0||this._onLoadQueue.length>0}runTask(e){for(;!e.done&&this._onLoadQueue.length>0;){const r=this._onLoadQueue.shift();Dt(r.task.abortController),r.task.abortController=null,r.callback(r.task),e.madeProgress()}for(;!e.done&&this._doneQueue.length>0;){const r=this._doneQueue.shift();r.task.status!==dd.DOWNLOADED&&(r.err=r.err||Tr()),this._doneLoading(r.task,r.err),e.madeProgress()}}_doneLoading(e,r){if(r&&!ws(r)&&e.numRetries>0)return--e.numRetries,void this._loadQueue.push(e);let i=e.result instanceof HTMLImageElement?0:e.resolvers.length;for(const s of e.resolvers)if(r)ws(r)?s.reject(r):s.reject(new D("stream-data-loader:request-error",`Failed to request resource at '${e.url}'. ${r}`,{url:e.url,error:r}));else{--i;const n=i<=0?e.result:re(e.result);s.resolve(n)}this._tasks.delete(e.key),this._tasks.size===0&&this._set("updating",!1)}_startLoading(e,r){if(e.status===dd.CANCELLED)return!1;let i,s;switch(e.startTime=performance.now(),e.status=dd.DOWNLOADING,e.docType){case"binary":s="array-buffer",i=0;break;case"image":s="image";break;case"image+type":s="array-buffer";break;default:s="json"}e.abortController=new AbortController;const n=e.abortController.signal;e.request=Lt(e.url,{...e.options,responseType:s,timeout:i,signal:n});let o=()=>{};const a=c=>{e.duration=performance.now()-e.startTime,e.size=c instanceof ArrayBuffer?c.byteLength:e.size||0,e.result=c,this._frameTask?this._onLoadQueue.push({callback:r,task:e}):(e.abortController=null,r(e))},l=c=>{e.status===dd.DOWNLOADING&&r(e,c),o()};return e.docType!=="image+type"?(e.request.then(c=>a(c.data),l),!0):(e.request.then(c=>{const h=c.data,p=xAt(h);if(s="image",e.size=h.byteLength,p==="unknown")return e.request=Lt(e.url,{responseType:s,timeout:i,signal:n}),void e.request.then(g=>a(g.data),l);const f=new Blob([h],{type:p}),m=window.URL.createObjectURL(f);o=()=>window.URL.revokeObjectURL(m),e.request=Lt(m,{responseType:s,timeout:i,signal:n}),e.request.then(g=>a(new Y8(g.data,p,o)),l)},l),!0)}get test(){return{loadQueue:this._loadQueue}}};u([d({readOnly:!0})],m5.prototype,"updating",void 0),m5=u([R("esri.views.3d.support.StreamDataLoader")],m5);const wAt={numRetries:0};function xAt(t){if(t.byteLength<2)return"unknown";const e=new Uint8Array(t,0,t.byteLength);return e[0]===137&&e[1]===80?"image/png":e[0]===71&&e[1]===73?"image/gif":e[0]===66&&e[1]===77?"image/bmp":e[0]===255&&e[1]===216?"image/jpeg":"unknown"}let Y8=class{constructor(e,r,i){this.image=e,this.type=r,this.release=i}get isOpaque(){return this.type==="image/jpeg"}},TAt=class extends yAt{constructor(e,r,i,s,n){super(s),this.url=e,this.options=r,this.docType=i,this.key=n,this.result=null,this.status=dd.QUEUED,this.request=null,this.abortController=null,this.resolvers=new Array,this.startTime=0,this.numRetries=wAt.numRetries}};function SAt(t,e,r){return`${t}:${e}:${r}`}var dd;(function(t){t[t.QUEUED=1]="QUEUED",t[t.DOWNLOADING=2]="DOWNLOADING",t[t.DOWNLOADED=3]="DOWNLOADED",t[t.CANCELLED=4]="CANCELLED"})(dd||(dd={}));let g5=class extends me{constructor(){super(...arguments),this.updating=!1}};function EAt(t){return new zp({view:t})}u([d({readOnly:!0})],g5.prototype,"updating",void 0),g5=u([R("esri.views.3d.support.ResourceControllerMain")],g5);let zp=class extends g5{constructor(){super(...arguments),this._immediateTask=AA,this._normalTask=AA,this._updatingObjects=aP([]),this._frameTask=null}get immediate(){return this._immediateTask}get normal(){return this._normalTask}initialize(){this._scheduler=Kct(),this._memoryController=fAt(this.view),this._streamDataLoader=new m5,this._streamDataLoader.setup(pAt,dAt,this._scheduler),this.addHandles([Q(()=>this.view.state?.mode,e=>{e!=null&&(this._scheduler.state=e)},Rr),Q(()=>this.view.stationary,()=>this._stationaryChangedHandler())]),this._frameTask=QC({update:e=>this._frame(e)}),this._immediateTask=this._scheduler.registerTask(gt.RESOURCE_CONTROLLER_IMMEDIATE),this._normalTask=this._scheduler.registerTask(gt.RESOURCE_CONTROLLER)}destroy(){this._immediateTask.remove(),this._normalTask.remove(),this._frameTask=Pi(this._frameTask),this._streamDataLoader=Re(this._streamDataLoader),this._memoryController=Re(this._memoryController),this._scheduler=Re(this._scheduler),this.view=null}get updating(){return!!(this._memoryController?.updating||this._streamDataLoader?.updating||this._immediateTask?.updating)||this._updatingObjects?.value.some(e=>e.updating)}get scheduler(){return this._scheduler}get memoryController(){return this._memoryController}createStreamDataRequester(e){const r=this._streamDataLoader;return{request:(i,s,n)=>r.request(i,s,e,n),get busy(){return!r.hasDownloadSlots(e)}}}addUpdatingObject(e){const r=this._updatingObjects;return r.value=[...r.value,e],Zr(()=>{r.value=r.value.filter(i=>i!==e)})}_frame(e){this.view.suspended||this.view.stateManager&&(this.view.stateManager.step(nQ(e.deltaTime)),!this._scheduler)||(this._scheduler.updateBudget(e)?(this._memoryController.update(),this._scheduler.frame()):this._memoryController.updating&&this._memoryController.update())}_stationaryChangedHandler(){this.memoryController.resetStableQuality()}get test(){return{getQueueStats:e=>this._streamDataLoader.test.loadQueue.getStatsForType(e)}}};u([d()],zp.prototype,"view",void 0),u([d()],zp.prototype,"_scheduler",void 0),u([d()],zp.prototype,"_memoryController",void 0),u([d()],zp.prototype,"_streamDataLoader",void 0),u([d()],zp.prototype,"_immediateTask",void 0),u([d()],zp.prototype,"_normalTask",void 0),u([d()],zp.prototype,"_updatingObjects",void 0),u([d({readOnly:!0})],zp.prototype,"updating",null),zp=u([R("esri.views.3d.support.ResourceControllerImpl")],zp);function CAt(t){return JDe(t)}function AAt(t){return"performanceInfo"in t}var qa,ct;(function(t){t[t.INSIDE=0]="INSIDE",t[t.INTERSECTS=1]="INTERSECTS",t[t.OUTSIDE=2]="OUTSIDE"})(qa||(qa={})),function(t){t[t.NORTH=0]="NORTH",t[t.NORTH_EAST=1]="NORTH_EAST",t[t.EAST=2]="EAST",t[t.SOUTH_EAST=3]="SOUTH_EAST",t[t.SOUTH=4]="SOUTH",t[t.SOUTH_WEST=5]="SOUTH_WEST",t[t.WEST=6]="WEST",t[t.NORTH_WEST=7]="NORTH_WEST"}(ct||(ct={}));const S2=C(),OAt=C(),iy=C(),sy=C();function RAt(t,e,r=0){const i=t.extent;if(i==null)return!1;if(r===0)return ube(i,e);const s=Math.min(i[2]-i[0],i[3]-i[1]);return R9e(i,e,r*s)}function ZN(t,e,r,i){oe(S2,r),S2[i]=e[i];const s=pe(S2,S2,e),n=pe(OAt,t,e),o=de(n,s),a=de(s,s);let l;l=o<=0?e:a<=o?r:ue(S2,e,ae(s,s,o/a));const c=pe(S2,t,l);return Math.PI/2-Math.atan(c[2]/Math.sqrt(c[0]*c[0]+c[1]*c[1]))}function MAt(t,e,r){const i=t.extent;if(i==null)return 0;iy[0]=i[0],iy[1]=i[1],iy[2]=r,sy[0]=i[2],sy[1]=i[3],sy[2]=r;let s=1/0,n=1/0;return e[0]<iy[0]?s=ZN(e,iy,sy,0):e[0]>sy[0]&&(s=ZN(e,sy,iy,0)),e[1]<iy[1]?n=ZN(e,iy,sy,1):e[1]>sy[1]&&(n=ZN(e,sy,iy,1)),Math.min(s,n)}function IAt(t,e,r){if(t==null)return Pte();if(t.spatialReference.isGeographic&&!H1(t.spatialReference))return new D("tilingscheme:local-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in local scenes");const i=fu.checkUnsupported(t);if(i!=null)return i;if(r==null)return new D("tilingscheme:extent-not-exist","The layer does not provide a layer extent.");const s=PAt(t,r);if(s)return s;const n=t.spatialReference;return e==null||n.equals(e)||e.isWGS84&&n.isWebMercator?null:new D("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the local scene")}function PAt(t,e){const r=t.lods,i=r[0].resolution*2**r[0].level,s=[i*t.size[0],i*t.size[1]],n=[t.origin.x,t.origin.y],o=lbe(e),a=Ht();fu.computeRowColExtent(o,s,n,a);const l=(a[2]-a[0])*(a[3]-a[1]);if(l>tC){const c=r[0].scale*2**r[0].level;let h=Math.max((o[3]-o[1])/t.size[1],(o[2]-o[0])/t.size[0])*c/i;const p=Math.floor(Math.log(h)/Math.log(10));return h=Math.ceil(h/10**p)*10**p,new D("tilingscheme:too-many-root-tiles","Scale of level 0 of the tiling scheme (1:"+Math.floor(c).toLocaleString()+") is too large for the layer's extent. Suggested scale: 1:"+h.toLocaleString()+".",{level0Scale:c,suggestedLevel0Scale:h,requiredNumRootTiles:l,allowedNumRootTiles:tC})}return null}const $At=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:IAt,isInsideExtent:RAt,tiltToExtentEdge:MAt},Symbol.toStringTag,{value:"Module"}));function LAt(){return!0}function DAt(){return 0}function NAt(t,e){if(t==null)return Pte();const r=t.lods.length-1,i=t.spatialReference,s=H1(i)||Pg(i)||$g(i);if(i.isWebMercator){if(!fu.makeWebMercatorAuxiliarySphere(r).compatibleWith(t))return new D("tilingscheme:incompatible-global-web-mercator","The tiling scheme is not compatible with the ArcGIS Online Web Mercator tiling scheme")}else{if(!s)return new D("tilingscheme:global-unsupported-spatial-reference","The tiling scheme spatial reference is not supported in global scenes");if(!fu.makeGCSWithTileSize(t.spatialReference,t.size[0],r).compatibleWith(t))return t.spatialReference.isWGS84?new D("tilingscheme:incompatible-global-wgs84","The tiling scheme is not compatible with the ArcGIS Online WGS84 tiling scheme"):new D("tilingscheme:incompatible-global","The tiling scheme is not compatible with the ArcGIS Online tiling scheme")}return e==null||t.spatialReference.equals(e)?void 0:new D("tilingscheme:spatial-reference-mismatch","The tiling scheme does not match the spatial reference of the global scene")}const FAt=Object.freeze(Object.defineProperty({__proto__:null,checkIfTileInfoSupportedForViewSR:NAt,isInsideExtent:LAt,tiltToExtentEdge:DAt},Symbol.toStringTag,{value:"Module"})),kAt={[Ue.Global]:FAt,[Ue.Local]:$At};function jm(t,e){t||console.warn("Terrain: "+e)}let Nn=!1,s6=!1;function UAt(t){s6=t,Nn=Nn||t}function VAt(t){Nn=t}function Se(t,e){if(Nn&&!t){const r=new Error().stack?.slice(5);throw console.warn("Terrain internal: "+(e??"")+" at "+r),new Error("Assertion failed"+(e?": "+e:""))}}function YY(t){return J8(t)?{fullExtent:t.fullExtent,minScale:t.layer.minScale,maxScale:t.layer.maxScale,tilemapCache:null}:t.layer}function n6(t){return t?.type==="imagery-tile"||t?.type==="wcs"}function J8(t){return t?.type==="imagery-tile-3d"}function $ie(t){return t?.type==="tile-3d"}function MP(t){return t?.type==="vector-tile-3d"}function QDe(t){return t?.type==="wmts-3d"}function JY(t){return t?.type==="elevation-3d"}function VR(t){return t?.type==="group"}function o6(t){return t&&($ie(t)||QDe(t)||J8(t)||MP(t))}function QY(t){return t&&($ie(t)||J8(t)||MP(t)||QDe(t))}function IP(t){return QY(t)||JY(t)}function zAt(t){const e=t?.sourceLayerInfo?.data;return e!=null&&"type"in e&&e.type==="raster-tile"}function KDe(t){return eNe(t?.sourceLayerInfo)}function BAt(t){const e=t?.sourceLayerInfo?.data;return e!=null&&"type"in e&&e.type==="tile-texture"}function GAt(t){const e=t?.sourceLayerInfo?.data;return e instanceof HTMLImageElement||e instanceof Y8||e instanceof HTMLCanvasElement||e instanceof ImageData}function eNe(t){return t?.data!=null&&"type"in t.data&&t.data.type==="vector-tile"}function qC(t){return t!=null&&"release"in t&&t.release(),null}function Rme(t){return t.fetchTile&&t.hasOverriddenFetchTile!==!1}function Lie(t,e,r,i){return kAt[i].checkIfTileInfoSupportedForViewSR(t,r,e)}function Q8(t,e,r){let i=null,s=null;if(t?.type==="wmts"){const n=jAt(t,e,r);i=n.tileInfo,s=n.fullExtent}else{s=n6(t)?t.getCompatibleFullExtent(e):t.fullExtent;const n=r===Ue.Local;if(n6(t))i=t.getCompatibleTileInfo(e,s,n);else if(t?.type==="vector-tile"){const o=n&&!HAt(e)||qAt.force512VTL,a=t.tileInfo.spatialReference.isGeographic;i=o?t.tileInfo:t.tileInfo.getOrCreateCompatible(256,a?1:2)}else i=t.tileInfo}return i!=null&&s!=null&&Lie(i,s,e,r)==null?{tileInfo:i,fullExtent:s}:null}function jAt(t,e,r){const i=lHe(t);if(i!=null){if(!Ke.isCollection(i))return{tileInfo:i.tileInfo,fullExtent:i.fullExtent};{const s=i.find(n=>Lie(n.tileInfo,n.fullExtent,e,r)==null);if(s)return{tileInfo:s.tileInfo,fullExtent:s.fullExtent}}}return{tileInfo:null,fullExtent:null}}function HAt(t){return t.isWGS84||t.isWebMercator||x1e(t)||!NI(t)}const qAt={force512VTL:!1};function Mme(t){return"["+t[0]+","+t[1]+","+t[2]+"]"}function ny(t){return"("+t[0]+","+t[1]+","+t[2]+")"}function Cd(t,e,r=XAt){return Math.abs(t-e)<r}function a6(t){return t===ct.NORTH_EAST?ct.SOUTH_WEST:t===ct.NORTH_WEST?ct.SOUTH_EAST:t===ct.SOUTH_WEST?ct.NORTH_EAST:ct.NORTH_WEST}function l6(t){return t===ct.NORTH?ct.SOUTH:t===ct.EAST?ct.WEST:t===ct.SOUTH?ct.NORTH:ct.EAST}function WAt(t){return t===ct.NORTH_WEST||t===ct.SOUTH_WEST}function ZAt(t){return t===ct.NORTH_WEST||t===ct.NORTH_EAST}function Ime(t){return t===ct.NORTH_WEST||t===ct.WEST||t===ct.SOUTH_WEST}function Pme(t){return t===ct.NORTH_EAST||t===ct.EAST||t===ct.SOUTH_EAST}function $me(t){return t===ct.SOUTH_EAST||t===ct.SOUTH||t===ct.SOUTH_WEST}function Lme(t){return t===ct.NORTH_EAST||t===ct.NORTH||t===ct.NORTH_WEST}const eg=[ct.NORTH,ct.EAST,ct.SOUTH,ct.WEST],PP=[ct.NORTH_EAST,ct.SOUTH_EAST,ct.SOUTH_WEST,ct.NORTH_WEST],XAt=1e-5;let YAt=class{constructor(e,r){if(this.layer=null,this.memory=0,this.displayedNumberOfFeatures=0,this.maximumNumberOfFeatures=null,this.totalNumberOfFeatures=null,this.layer=e.layer,this.memory=IP(e)?r.basemapTerrain.getUsedMemoryForLayerView(e):e.usedMemory,AAt(e)){const i=e.performanceInfo;this.displayedNumberOfFeatures=i.displayedNumberOfFeatures,this.maximumNumberOfFeatures=i.maximumNumberOfFeatures,this.totalNumberOfFeatures=i.totalNumberOfFeatures}}},JAt=class{constructor(e){if(this.totalMemory=0,this.usedMemory=0,this.quality=1,this.load=0,this.terrainMemory=0,this.edgesMemory=0,this.layerPerformanceInfos=new Array,e.resourceController!=null){const i=e.resourceController.memoryController;this.totalMemory=(i.maxMemory??0)*sA.MEGABYTES,this.usedMemory=Math.round(i.usedMemory*this.totalMemory),this.quality=i.memoryFactor,this.load=e.resourceController.scheduler.load}this.terrainMemory=e.basemapTerrain?.usedMemory??0;const r=e._stage&&e._stage.renderView&&e._stage.renderer.edgeView;this.edgesMemory=r!=null?r.usedMemory:0,e.allLayerViews.items.forEach(i=>{(CAt(i)||IP(i))&&this.layerPerformanceInfos.push(new YAt(i,e))}),this.layerPerformanceInfos.sort((i,s)=>s.memory-i.memory)}},QAt=class{constructor(e){this._gltfLoading=new Map,this._wosrLoading=new Map,this._gltfMemCache=e("gltf-resources",()=>{}),this._wosrMemCache=e("wosr-resources",()=>{})}destroy(){this._gltfLoading.forEach(e=>e.abortController.abort()),this._wosrLoading.forEach(e=>e.abortController.abort()),this._gltfMemCache.destroy(),this._wosrMemCache.destroy()}loadGLTF(e,r,i){const s=i?`gltfPBR:${e}`:`gltf:${e}`,n=this._gltfMemCache.get(s);return n!=null?Promise.resolve(n):this._loadOnce(this._gltfLoading,this._gltfMemCache,s,o=>iDe(new tDe(o.streamDataRequester),e,o,i),r)}loadWOSR(e,r){const i=`wosr:${e}:${r.disableTextures}`,s=this._wosrMemCache.get(i);return s!=null?Promise.resolve(s):this._loadOnce(this._wosrLoading,this._wosrMemCache,i,n=>sDe(e,n),r)}async _loadOnce(e,r,i,s,n){Dt(n);const o=xn(n,()=>this._abortLoad(e,i));let a=e.get(i);if(a)a.refCount++;else{const l=new AbortController;a={refCount:1,abortController:l,promise:s({...n,signal:l.signal})},e.set(i,a)}try{const l=await a.promise;return r.put(i,l,l.size),e.delete(i),Dt(n),l}finally{Pi(o)}}_abortLoad(e,r){const i=e.get(r);i!=null&&--i.refCount>0||(e.delete(r),i?.abortController.abort())}},KAt=class extends rC{constructor(e,r,i){super(r,i),this._streamDataRequester=e}async fromUrl(e,r,i){Dt(i);const s=i!=null?i.signal:null,n=this.makeUid(e,r);let o=this._textureRequests.get(n);if(!o){const a=new AbortController,l=this._streamDataRequester.request(e,"image",{uid:n,signal:a.signal});o=new CRe,o.abortController=a;const c=o;this._textureRequests.set(n,o),o.textureAsync=l.then(async h=>{const p=this._createTexture(e,h,r);return c.texture=p,c.abortController=null,this._stage.add(p),await this._stage.load(p),{uid:n,texture:p,release:()=>this._release(n)}},h=>{throw c.abortController=null,h})}o.referenceCount++;try{return await gT(o.textureAsync,s)}catch(a){throw this._release(n),a}}_createTexture(e,r,i){const s={width:r.width,height:r.height,wrap:{s:Ut.CLAMP_TO_EDGE,t:Ut.CLAMP_TO_EDGE},preMultiplyAlpha:!0};if(gve(e)){if(i||r.width===0&&r.height===0){const n=r.width?r.height/r.width:1;i=i||64,n>1?(r.width=Math.round(i/n),r.height=i):(r.width=i,r.height=Math.round(i*n))}this._stage.renderView?.renderingContext.driverTest.svgPremultipliesAlpha.result&&(s.preMultiplyAlpha=!1)}return new wS(r,s)}},eOt=class{constructor(e){this.streamDataRequester=null,this._graphicsOwners=[],this._screenSizePerspectiveHandles=null,this.cimSymbolRasterizer=null,this._viewState=e.viewState,this._view=e.view,this._pointsOfInterest=e.pointsOfInterest,this.streamDataRequester=e.resourceController.createStreamDataRequester(Jm.SYMBOLOGY),this.objectResourceCache=new QAt((i,s)=>e.resourceController.memoryController.newCache(i,s)),this.textures=new KAt(this.streamDataRequester,e.view._stage,e.resourceController.scheduler);const r=Ir(this._view.spatialReference).radius;this.screenSizePerspectiveSettings=PIe(e.viewingMode,r),this.screenSizePerspectiveSettingsLabels=x0t(e.viewingMode,r)}destroy(){this.textures.destroy(),this.streamDataRequester=null}addGraphicsOwner(e){if(!e)return Zr();this._graphicsOwners.push(e);const r=Q(()=>e.layer?.screenSizePerspectiveEnabled,()=>this._updateScreenSizePerspectiveEnabled());return this._updateScreenSizePerspectiveEnabled(),Zr(()=>{r.remove(),MI(this._graphicsOwners,e),this._updateScreenSizePerspectiveEnabled()})}_updateScreenSizePerspectiveEnabled(){const e=this._graphicsOwners.some(r=>r.layer?.screenSizePerspectiveEnabled===!0);if(e&&!this._screenSizePerspectiveHandles){this._screenSizePerspectiveHandles=new li;const r=()=>this._updateScreenSizePerspectiveSettings();this._screenSizePerspectiveHandles.add([Q(()=>this._pointsOfInterest.centerOnSurfaceInfrequent.distance,r,Rr),this._viewState.events.on("camera-projection-changed",r)]),this._updateScreenSizePerspectiveSettings()}else e||(this._screenSizePerspectiveHandles=Re(this._screenSizePerspectiveHandles))}_updateScreenSizePerspectiveSettings(){const e=this._pointsOfInterest;XN.distance=e.centerOnSurfaceInfrequent.distance,XN.fovY=this._viewState.camera.fovY,this.screenSizePerspectiveSettings.update(XN),this.screenSizePerspectiveSettingsLabels.update(XN),this._view._stage.renderView.requestRender()}get test(){return{screenSizePerspectiveHandles:this._screenSizePerspectiveHandles}}};const XN={distance:0,fovY:0};let $E=class{constructor(e,r,i=""){this.graphics=e,this._symbol=new c1({symbolLayers:[new l1({material:{color:r},outline:{color:[255,255,255],size:1},resource:{primitive:"circle"}}),new uS({text:i,halo:{color:"white",size:1/.75},material:{color:r},size:12})]})}show(e,r){if(r==null)return;this.hide();const i=new ht({x:e[0],y:e[1],z:e[2],spatialReference:r});this._graphic=new oa({geometry:i,symbol:this._symbol}),this.graphics.add(this._graphic)}hide(){this._graphic!=null&&(this.graphics.remove(this._graphic),this._graphic=null)}},e1=class extends me{constructor(e){super(e),this.handles=new li}destroy(){this.handles.destroy()}};u([d({constructOnly:!0})],e1.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],e1.prototype,"surface",void 0),u([d({constructOnly:!0})],e1.prototype,"state",void 0),e1=u([R("esri.views.3d.support.PointOfInterest")],e1);const tOt=Array;let Bp=class extends e1{constructor(e){super(e),this._dirty=!1,this._propertiesPool=new M0({location:ht,renderLocation:tOt},this),this._estimatedSurfaceAltitude=0,this._pendingElevationQueryController=null,this.renderLocation=C(),this._tmpPoint=new ht}initialize(){if(this.scheduler&&this.handles.add(this.scheduler.registerTask(this.task,this)),this.runTask(),this.map){const e=()=>this._setDirty();this.handles.add(Vs(()=>this.map?.ground?.layers,"change",e,{onListenerAdd:e,onListenerRemove:e}))}this._updateRenderLocation()}destroy(){this._cancelPendingRequest(),this._propertiesPool=Re(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get scale(){const e=this._camera,r=_i(e.eye,this.renderLocation),i={renderCoordsHelper:this.renderCoordsHelper,state:{camera:e}};return jT(i,r,0)}get updating(){return this._dirty||this._pendingElevationQueryController!=null}updateRenderLocation(){this._setDirty(),this._updateRenderLocation()}_setDirty(){this._dirty||(this._dirty=!0,this.notifyChange("updating"))}_cancelPendingRequest(){const e=this._pendingElevationQueryController;e&&(this._pendingElevationQueryController=null,e.abort(),this.notifyChange("updating"))}get running(){return!this._pendingElevationQueryController&&this._dirty}runTask(){if(this._cancelPendingRequest(),this._dirty=!1,this.notifyChange("updating"),!this.map||!this.map.ground)return this._updateSurfaceAltitude(0),Pa.YIELD;const e=this.state.spatialReference;this.renderCoordsHelper.fromRenderCoords(this._camera.eye,this._tmpPoint,e);const r=(this._tmpPoint.z??0)>rOt&&this.renderCoordsHelper.viewingMode===Ue.Global&&(e.isWGS84||e.isWebMercator);let i=new AbortController;return this.map.ground.queryElevation(this._tmpPoint,{signal:i.signal,cache:this.cache,minDemResolution:r?iOt:0}).then(s=>this._updateSurfaceAltitude(s.geometry.z??0)).catch(s=>{ws(s)||this._updateSurfaceAltitude(0)}).catch(()=>{}).then(()=>{this._pendingElevationQueryController===i&&(this._pendingElevationQueryController=null,this.notifyChange("updating")),i=null}),this._pendingElevationQueryController=i,Pa.YIELD}_updateSurfaceAltitude(e){this._estimatedSurfaceAltitude!==e&&(this._estimatedSurfaceAltitude=e,this._updateRenderLocation())}_updateRenderLocation(){this.renderCoordsHelper.setAltitude(WG,this._estimatedSurfaceAltitude,this._camera.eye),Jr(this._get("renderLocation"),WG)||(this._set("renderLocation",oe(this._propertiesPool.get("renderLocation"),WG)),this.notifyChange("renderLocation"))}};u([d({constructOnly:!0})],Bp.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Bp.prototype,"cache",void 0),u([d({constructOnly:!0})],Bp.prototype,"task",void 0),u([d({readOnly:!0})],Bp.prototype,"location",null),u([d({constructOnly:!0})],Bp.prototype,"map",void 0),u([d({readOnly:!0})],Bp.prototype,"renderLocation",void 0),u([d({readOnly:!0})],Bp.prototype,"scale",null),u([d({readOnly:!0})],Bp.prototype,"updating",null),Bp=u([R("esri.views.3d.support.CameraOnSurface")],Bp);const WG=C(),rOt=1e5,iOt=1e6,sOt=Array;let pd=class extends e1{constructor(e){super(e),this._propertiesPool=new M0({location:ht,renderLocation:sOt},this),this._currentSurfaceAltitude=0,this._latestSurfaceAltitude=0,this.distance=0,this.renderLocation=C(),this.updating=!1}initialize(){this._frameWorker=this.scheduler.registerTask(this.task,this),this.runTask()}destroy(){this._frameWorker=Pi(this._frameWorker),this._propertiesPool=Re(this._propertiesPool)}get _camera(){return this.state.contentCamera}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}updateRenderLocation(){this.updating=!0,this._updateRenderLocation()}get estimatedSurfaceAltitude(){return this._latestSurfaceAltitude}get running(){return this.updating}runTask(){return this._latestSurfaceAltitude=this.estimateSurfaceAltitudeAtCenter(),this._updateRenderLocation(),this.updating=!1,Pa.YIELD}_updateRenderLocation(){const e=oOt;let r=this._calculateSurfaceIntersection(this._currentSurfaceAltitude,e);const i=this._currentSurfaceAltitude!==this._latestSurfaceAltitude;!r&&i&&(r=this._calculateSurfaceIntersection(this._latestSurfaceAltitude,e),r&&(this._currentSurfaceAltitude=this._latestSurfaceAltitude));const s=aOt;r&&this._latestSurfaceAltitudeChangesDistanceSignificantly(e,s)&&(oe(e,s),this._currentSurfaceAltitude=this._latestSurfaceAltitude),r?this.distance=_i(this._camera.eye,e):(ae(e,this._camera.viewForward,this._get("distance")),ue(e,e,this._camera.eye)),Jr(this._get("renderLocation"),e)||this._set("renderLocation",oe(this._propertiesPool.get("renderLocation"),e))}_calculateSurfaceIntersection(e,r){const i=this._camera;if(!this.renderCoordsHelper.intersectManifold(i.ray,e,r))return!1;if(this.state.isGlobal){const s=Ir(this.renderCoordsHelper.spatialReference).radius,n=s+e,o=Xa(i.eye),a=o<n*n,l=_i(i.eye,r);if(a&&l>s/4){const c=n-Math.sqrt(o);return ae(r,i.viewForward,c),ue(r,r,i.eye),!0}}else{const s=this.surface?.ready?this.surface.extent:null;s!=null&&_$(s,this.surface?.spatialReference,zR,this.renderCoordsHelper.spatialReference)&&(r[0]=ye(r[0],zR[0],zR[2]),r[1]=ye(r[1],zR[1],zR[3]))}return!0}_latestSurfaceAltitudeChangesDistanceSignificantly(e,r){if(this._latestSurfaceAltitude===this._currentSurfaceAltitude||e==null)return!1;if(this._calculateSurfaceIntersection(this._latestSurfaceAltitude,r)){if(bi.TESTS_DISABLE_OPTIMIZATIONS)return!0;const i=this._camera.eye,s=_i(i,e),n=_i(i,r);if(Math.abs(n-s)/s>nOt)return!0}return!1}};u([d({constructOnly:!0})],pd.prototype,"scheduler",void 0),u([d({constructOnly:!0})],pd.prototype,"task",void 0),u([d()],pd.prototype,"distance",void 0),u([d({constructOnly:!0})],pd.prototype,"estimateSurfaceAltitudeAtCenter",void 0),u([d({readOnly:!0})],pd.prototype,"location",null),u([d({readOnly:!0})],pd.prototype,"renderLocation",void 0),u([d()],pd.prototype,"updating",void 0),pd=u([R("esri.views.3d.support.CenterOnSurface")],pd);const nOt=.05,oOt=C(),aOt=C(),zR=Ht();let lOt=class{constructor(e){this._handles=new li,this.events=new Xr,this._contentLayerViews=e.contentLayerViews,this._handles.add(this._contentLayerViews.on("change",r=>this._layerViewsChanged(r))),this._layerViewsChanged({added:this._contentLayerViews.toArray(),removed:[],moved:[],target:this._contentLayerViews})}destroy(){this._handles=Re(this._handles),this._contentLayerViews.destroy()}_layerViewsChanged(e){e.added.forEach(r=>{r.declaredClass==="esri.views.3d.layers.SceneLayerView3D"&&this._handles.add(r.on("visible-geometry-changed",()=>this._contentChanged()),r.uid)}),e.removed.forEach(r=>this._handles.remove(r.uid))}_contentChanged(){this.events.emit("request-update",cOt)}};const cOt={},uOt=Array;let Lm=class extends e1{constructor(e){super(e),this._propertiesPool=new M0({location:ht,renderLocation:uOt},this),this._dirty=!0,this.renderLocation=this._propertiesPool.get("renderLocation")}initialize(){this.handles.add([Q(()=>this.centerOnSurface.renderLocation,()=>this.updateRenderLocation()),Q(()=>this.state.contentCamera,()=>this.updateRenderLocation())]),this.scheduler&&this.handles.add(this.scheduler.registerTask(gt.POINT_OF_INTEREST_FREQUENT,this))}destroy(){this._propertiesPool=Re(this._propertiesPool)}get updating(){return this._dirty||this.centerOnSurface.updating}get location(){const e=this._propertiesPool.get("location");return this.renderCoordsHelper.fromRenderCoords(this.renderLocation,e,this.state.spatialReference),e}get running(){return this._dirty}runTask(){const e=this._get("renderLocation"),r=this.centerOnSurface.renderLocation,i=this.renderCoordsHelper,s=this.state.contentCamera;this._dirty=!1,i.worldUpAtPosition(r,Dme);const n=Math.max(0,(Math.acos(de(Dme,s.viewForward))-.5*Math.PI)*(s.aboveGround?1:-1));if(Number.isNaN(n)){if(!e||!D1(e,r)){const c=this._propertiesPool.get("renderLocation");oe(c,r),this._set("renderLocation",c)}return Pa.YIELD}const o=1-ye(n/(.5*Math.PI),0,1),a=o*o*o;this._calculateScreenHorizontalEdgeOnSurface(Nme);const l=this._propertiesPool.get("renderLocation");return Wr(l,r,Nme,a),e&&D1(e,l)||this._set("renderLocation",l),Pa.YIELD}_calculateScreenHorizontalEdgeOnSurface(e){const r=this.state.contentCamera,i=r.getRenderCenter(Lo());if(i[1]=r.aboveGround?r.padding[sr.BOTTOM]:r.fullHeight-r.padding[sr.TOP],this.estimateSurfaceIntersectionAtRenderPoint(i,e))return e;const s=this.renderCoordsHelper.getAltitude(this.centerOnSurface.renderLocation);if(r.unprojectFromRenderScreen(i,BR)){pe(BR,BR,r.eye);const n=_e(BR,BR);if(this.renderCoordsHelper.intersectManifold(Eh(r.eye,n),s,e))return e}return this.renderCoordsHelper.setAltitude(e,s,r.eye)}updateRenderLocation(){this._dirty=!0}};u([d()],Lm.prototype,"_dirty",void 0),u([d({constructOnly:!0})],Lm.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Lm.prototype,"centerOnSurface",void 0),u([d({constructOnly:!0})],Lm.prototype,"estimateSurfaceIntersectionAtRenderPoint",void 0),u([d({readOnly:!0})],Lm.prototype,"updating",null),u([d({readOnly:!0})],Lm.prototype,"location",null),u([d({readOnly:!0})],Lm.prototype,"renderLocation",void 0),Lm=u([R("esri.views.3d.support.pointsOfInterest.Focus")],Lm);const Dme=C(),BR=C(),Nme=C();let Ly=class extends me{get surface(){return this.view.map?.ground}get surfaceView(){return this.view.basemapTerrain}get renderLocation(){if(!this.location)return null;const e=C();return this.view.renderCoordsHelper.toRenderCoords(this.location,e),e}constructor(e){super(e),this.location=null,this._updateController=null,this._handles=new li}initialize(){this.view.state.isLocal&&(this._handles.add([Q(()=>[this.surfaceView?.spatialReference,this.surfaceView?.extent],()=>this._update()),Vs(()=>this.surface?.layers,"change",()=>this._update())]),this._update())}destroy(){this._handles.destroy()}_update(){if(this._updateController&&(this._updateController.abort(),this._updateController=null),!this.surfaceView||this.surfaceView.extent==null||this.surfaceView.spatialReference==null)return void this._set("location",null);const e=NQ(this.surfaceView.extent),r=new ht({x:e[0],y:e[1],z:0,spatialReference:this.surfaceView.spatialReference});this.surface&&this.surface.layers.length>0?(this._set("location",null),this._updateController=new AbortController,this.surface.queryElevation(r,{noDataValue:0,signal:this._updateController.signal,cache:this.cache}).then(i=>{this._updateController=null,this._set("location",i.geometry)}).catch(i=>{ws(i)||i&&i.name==="elevation-query:invalid-layer"||console.error("StableSurfaceCenter failed to update: ",i)})):this._set("location",r)}};u([d({constructOnly:!0})],Ly.prototype,"view",void 0),u([d({constructOnly:!0})],Ly.prototype,"cache",void 0),u([d()],Ly.prototype,"surface",null),u([d()],Ly.prototype,"surfaceView",null),u([d({readOnly:!0})],Ly.prototype,"location",void 0),u([d({readOnly:!0})],Ly.prototype,"renderLocation",null),Ly=u([R("esri.views.3d.terrain.StableSurfaceCenter")],Ly);let Dy=class extends me{constructor(e){super(e),this._tileGeometryUpdateExtent=Au(),this._tileGeometryUpdateSpatialReference=null,this.events=new Xr,this.updating=!1}initialize(){this.addHandles([this.surface.on("elevation-change",e=>this._tileGeometryChanged(e)),this.scheduler.registerTask(gt.SURFACE_GEOMETRY_UPDATES,this)])}get running(){return this.updating}runTask(){return this.updating&&(this._tileGeometryUpdateSpatialReference&&this._centerIntersectsExtent(this._tileGeometryUpdateExtent,this._tileGeometryUpdateSpatialReference)&&this.events.emit("request-update",hOt),Au(this._tileGeometryUpdateExtent),this._set("updating",!1)),Pa.YIELD}_tileGeometryChanged(e){this._tileGeometryUpdateSpatialReference=e.spatialReference,E1(this._tileGeometryUpdateExtent,e.extent,this._tileGeometryUpdateExtent),this._set("updating",!0)}_furthestCenterOnSurface(){let e=this.centerOnSurfaces[0];for(let r=1;r<this.centerOnSurfaces.length;r++){const i=this.centerOnSurfaces[r];i.distance>e.distance&&(e=i)}return e}_centerIntersectsExtent(e,r){const i=this.state.contentCamera.eye,s=dOt,n=this._furthestCenterOnSurface();return this.renderCoordsHelper.fromRenderCoords(i,sw,r),this.renderCoordsHelper.fromRenderCoords(n.renderLocation,nw,r),sw[0]<nw[0]?(s[0]=sw[0],s[2]=nw[0]):(s[0]=nw[0],s[2]=sw[0]),sw[1]<nw[1]?(s[1]=sw[1],s[3]=nw[1]):(s[1]=nw[1],s[3]=sw[1]),JP(s,e)}};u([d({constructOnly:!0})],Dy.prototype,"state",void 0),u([d({constructOnly:!0})],Dy.prototype,"centerOnSurfaces",void 0),u([d({constructOnly:!0})],Dy.prototype,"renderCoordsHelper",void 0),u([d({constructOnly:!0})],Dy.prototype,"scheduler",void 0),u([d({constructOnly:!0})],Dy.prototype,"surface",void 0),u([d({readOnly:!0})],Dy.prototype,"updating",void 0),Dy=u([R("esri.views.3d.support.SurfaceGeometryUpdates")],Dy);const hOt={},sw=C(),nw=C(),dOt=Au();let lc=class extends me{constructor(e){super(e),this._handles=new li,this._tmpRay=Io(),this._centerRayDirty=!0,this._surfaceAltitudeAtCenter=0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenter=0,this._contentAltitudeAtCenterDirty=!0,this._propertiesPool=new M0({renderPointOfView:pOt},this),this.renderPointOfView=C(),this._pois=new Array,this._debugCenters=new Map}initialize(){const{state:e,basemapTerrain:r,renderCoordsHelper:i,map:s}=this.view;this._surfaceIntersector=Jd(e.viewingMode),e.isGlobal?this._surfaceIntersector.options.backfacesTerrain=!1:this._surfaceIntersector.options.backfacesTerrain=!0,this._surfaceIntersector.options.invisibleTerrain=!1,this._surfaceIntersector.options.store=na.MIN,this._contentIntersector=Jd(e.viewingMode);const n=()=>this._estimateSurfaceAltitudeAtCenter(),o=this.view.resourceController.scheduler,a=this.view.basemapTerrain?.elevationQueryCache,l={state:e,scheduler:o,surface:r,renderCoordsHelper:i};this._set("centerOnSurfaceInfrequent",new pd({...l,task:gt.POINT_OF_INTEREST_INFREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnSurfaceFrequent",new pd({...l,task:gt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:n})),this._set("centerOnContent",new pd({...l,task:gt.POINT_OF_INTEREST_FREQUENT,estimateSurfaceAltitudeAtCenter:()=>this._estimateContentAltitudeAtCenter()})),this._set("cameraOnSurface",new Bp({...l,cache:a,task:gt.POINT_OF_INTEREST_INFREQUENT,map:s})),this._set("surfaceGeometryUpdates",new Dy({...l,centerOnSurfaces:[this.centerOnSurfaceFrequent,this.centerOnContent,this.centerOnSurfaceInfrequent]})),this._set("contentGeometryUpdates",new lOt({contentLayerViews:this.view.allLayerViews,renderCoordsHelper:i})),this._set("surfaceOrigin",new Ly({cache:a,view:this.view})),this._set("focus",new Lm({state:e,scheduler:o,surface:r,renderCoordsHelper:i,centerOnSurface:this.centerOnSurfaceFrequent,estimateSurfaceIntersectionAtRenderPoint:(h,p)=>this._estimateSurfaceIntersectionAtRenderPoint(h,this.view.state.contentCamera,p)})),this._pois.push(this.centerOnContent,this.centerOnSurfaceFrequent,this.centerOnSurfaceInfrequent,this.cameraOnSurface,this.focus);const c=this.view.graphics;this._debugCenters.set(this.centerOnContent,new $E(c,"red","CenterOnContent")),this._debugCenters.set(this.centerOnSurfaceFrequent,new $E(c,"red","CenterOnSurface")),this._debugCenters.set(this.centerOnSurfaceInfrequent,new $E(c,"red","CenterOnSurface")),this._debugCenters.set(this.cameraOnSurface,new $E(c,"blue","CameraOnSurface")),this._debugCenters.set(this.focus,new $E(c,"green","Focus")),this._handles.add([Q(()=>e.contentCamera,h=>this._cameraChanged(h),Rr),Q(()=>r.extent,()=>this._updateCenterPointsOfInterest()),No(()=>!r.updating,()=>this._updateCenterPointsOfInterest(),Rr),Vs(()=>this.surfaceGeometryUpdates.events,"request-update",()=>this._updateCenterPointsOfInterest()),Vs(()=>this.contentGeometryUpdates.events,"request-update",()=>this._updateCenterOnContent()),No(()=>bi.SHOW_POI,h=>this._setDebug(h),xt)]),this._cameraChanged(this.view.state.contentCamera);for(const h of this._pois)h.runTask()}destroy(){this._setDebug(!1),this._handles.destroy(),this._propertiesPool.destroy();for(const e of this._pois)e.destroy();this.surfaceOrigin.destroy()}get updating(){return!(!this.surfaceGeometryUpdates?.updating&&!this._pois.some(e=>e.updating))}get _centerRay(){return this._centerRayDirty&&(this._centerRayCached=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(this.view.state.contentCamera,this._tmpRay),this._centerRayDirty=!1),this._centerRayCached}_estimateContentAltitudeAtCenter(){if(!this._contentAltitudeAtCenterDirty)return this._contentAltitudeAtCenter;this._contentAltitudeAtCenterDirty=!1;const e=this._centerRay;return e==null||(this.view.sceneIntersectionHelper.intersectRay(e,this._contentIntersector,E2,mOt)?this._contentAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(E2):this._contentAltitudeAtCenter=this._estimateSurfaceAltitudeAtCenter()),this._contentAltitudeAtCenter}_estimateSurfaceAltitudeAtCenter(){if(!this.view.basemapTerrain)return 0;if(!this._surfaceAltitudeAtCenterDirty)return this._surfaceAltitudeAtCenter;this._surfaceAltitudeAtCenterDirty=!1;const e=this._centerRay;if(e==null)return this._surfaceAltitudeAtCenter;const r=e.origin,i=ue(E2,e.origin,e.direction);return this._surfaceIntersector.resetWithRay(e,this.view.state.contentCamera),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,r,i),this._surfaceIntersector.results.min.getIntersectionPoint(E2)&&(this._surfaceAltitudeAtCenter=this.view.renderCoordsHelper.getAltitude(E2)),this._surfaceAltitudeAtCenter}_estimateSurfaceIntersectionAtRenderPoint(e,r,i){const s=gre(r,e,fOt);if(s==null)return null;const n=s.origin,o=ue(E2,s.origin,s.direction);return this._surfaceIntersector.resetWithRay(s,r),this.view.basemapTerrain.intersect(this._surfaceIntersector,null,n,o),this._surfaceIntersector.results.min.getIntersectionPoint(i)?i:null}_cameraChanged(e){this._updateCenterPointsOfInterest();const r=e.eye;Jr(this.renderPointOfView,r)||this._set("renderPointOfView",oe(this._propertiesPool.get("renderPointOfView"),r))}_updateCenterPointsOfInterest(){this._centerRayDirty=!0,this._surfaceAltitudeAtCenterDirty=!0,this._contentAltitudeAtCenterDirty=!0;for(const e of this._pois)e.updateRenderLocation()}_updateCenterOnContent(){this._contentAltitudeAtCenterDirty=!0,this.centerOnContent.updateRenderLocation()}_setDebug(e){if(!e)return this._debugCenters.forEach(r=>r.hide()),void this._handles.remove("debug");for(const r of this._pois)this._handles.add(Q(()=>r.renderLocation,i=>this._debugCenters.get(r)?.show(i,r.renderCoordsHelper.spatialReference),xt),"debug")}get test(){return{update:()=>{this.surfaceGeometryUpdates.runTask();for(const e of this._pois)e.runTask()},surfaceGeometryUpdates:this.surfaceGeometryUpdates}}};u([d({readOnly:!0})],lc.prototype,"centerOnContent",void 0),u([d({readOnly:!0})],lc.prototype,"centerOnSurfaceFrequent",void 0),u([d({readOnly:!0})],lc.prototype,"centerOnSurfaceInfrequent",void 0),u([d({readOnly:!0})],lc.prototype,"cameraOnSurface",void 0),u([d({readOnly:!0})],lc.prototype,"focus",void 0),u([d({readOnly:!0})],lc.prototype,"renderPointOfView",void 0),u([d({readOnly:!0})],lc.prototype,"surfaceOrigin",void 0),u([d({readOnly:!0})],lc.prototype,"contentGeometryUpdates",void 0),u([d({readOnly:!0})],lc.prototype,"surfaceGeometryUpdates",void 0),u([d({constructOnly:!0})],lc.prototype,"view",void 0),u([d({readOnly:!0})],lc.prototype,"updating",null),lc=u([R("esri.views.3d.support.PointsOfInterest")],lc);const pOt=Array,E2=C(),fOt=Io(),mOt={exclude:new Set([Yv])};let gOt=class{constructor(e){this._store=e}destroy(){this._store.destroy()}get(e){return this._store.get(e)}put(e,r){this._store.put(e,r,r.values.byteLength+256)}},yOt=class{constructor(e,r,i,s){this._hasNoDataValues=null,this._minValue=null,this._maxValue=null,"pixelData"in e?(this.values=e.pixelData,this.width=e.width,this.height=e.height,this.noDataValue=e.noDataValue):(this.values=e,this.width=r,this.height=i,this.noDataValue=s)}get hasNoDataValues(){if(this._hasNoDataValues==null){const e=this.noDataValue;this._hasNoDataValues=this.values.includes(e)}return this._hasNoDataValues}get minValue(){return this._ensureBounds(),this._minValue}get maxValue(){return this._ensureBounds(),this._maxValue}_ensureBounds(){if(this._minValue!=null)return;const{noDataValue:e,values:r}=this;let i=1/0,s=-1/0,n=!0;for(const o of r)o===e?this._hasNoDataValues=!0:(i=o<i?o:i,s=o>s?o:s,n=!1);n?(this._minValue=0,this._maxValue=0):(this._minValue=i,this._maxValue=s>-3e38?s:0)}},tNe=class{constructor(e,r,i,s,n={}){this._mainMethod=r,this._transferLists=i,this._listeners=[],this._promise=bSe(e,{...n,schedule:s}).then(o=>{if(this._thread===void 0){this._thread=o,this._promise=null,n.hasInitialize&&this.broadcast({},"initialize");for(const a of this._listeners)this._connectListener(a)}else o.close()}),this._promise.catch(o=>K.getLogger("esri.core.workers.WorkerHandle").error(`Failed to initialize ${e} worker: ${o}`))}on(e,r){const i={removed:!1,eventName:e,callback:r,threadHandle:null};return this._listeners.push(i),this._connectListener(i),Zr(()=>{i.removed=!0,II(this._listeners,i),this._thread&&i.threadHandle!=null&&i.threadHandle.remove()})}destroy(){this._thread&&(this._thread.close(),this._thread=null),this._promise=null,this._listeners.length=0,this._transferLists={}}invoke(e,r){return this.invokeMethod(this._mainMethod,e,r)}invokeMethod(e,r,i){if(this._thread){const s=this._transferLists[e],n=s?s(r):[];return this._thread.invoke(e,r,{transferList:n,signal:i})}return this._promise?this._promise.then(()=>(Dt(i),this.invokeMethod(e,r,i))):Promise.reject(null)}broadcast(e,r){return this._thread?Promise.all(this._thread.broadcast(r,e)).then(()=>{}):this._promise?this._promise.then(()=>this.broadcast(e,r)):Promise.reject()}get promise(){return this._promise}_connectListener(e){this._thread&&this._thread.on(e.eventName,e.callback).then(r=>{e.removed||(e.threadHandle=r)})}},Fme=class extends tNe{constructor(e=null){super("LercWorker","_decode",{_decode:r=>[r.buffer]},e,{strategy:"dedicated"}),this.schedule=e,this.ref=0}decode(e,r,i){return e&&e.byteLength!==0?this.invoke({buffer:e,options:r},i):Promise.resolve(null)}release(){--this.ref<=0&&(EI.forEach((e,r)=>{e===this&&EI.delete(r)}),this.destroy())}};const EI=new Map;function _Ot(t=null){let e=EI.get(t);return e||(t!=null?(e=new Fme(r=>t.immediate.schedule(r)),EI.set(t,e)):(e=new Fme,EI.set(null,e))),++e.ref,e}var du,kme,Ume;(function(t){t[t.FILL=1]="FILL",t[t.LINE=2]="LINE",t[t.SYMBOL=3]="SYMBOL",t[t.CIRCLE=4]="CIRCLE"})(du||(du={})),function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.FILL=1]="FILL",t[t.OUTLINE=2]="OUTLINE",t[t.LINE=3]="LINE",t[t.ICON=4]="ICON",t[t.CIRCLE=5]="CIRCLE",t[t.TEXT=6]="TEXT",t[t.TILEINFO=7]="TILEINFO"}(kme||(kme={})),function(t){t[t.PAINTER_CHANGED=0]="PAINTER_CHANGED",t[t.LAYOUT_CHANGED=1]="LAYOUT_CHANGED",t[t.LAYER_CHANGED=2]="LAYER_CHANGED",t[t.LAYER_REMOVED=3]="LAYER_REMOVED",t[t.SPRITES_CHANGED=4]="SPRITES_CHANGED"}(Ume||(Ume={}));let vOt=class{constructor(e){this.xTile=0,this.yTile=0,this.hash=0,this.priority=1,this.colliders=[],this.textVertexRanges=[],this.iconVertexRanges=[],this.tile=e}},JZt=class{constructor(){this.tileSymbols=[],this.parts=[{startTime:0,startOpacity:0,targetOpacity:0,show:!1},{startTime:0,startOpacity:0,targetOpacity:0,show:!1}],this.show=!1}};function KZt(t,e,r,i,s,n){const o=r-s;if(o>=0)return(e>>o)+(i-(n<<o))*(t>>o);const a=-o;return e-(n-(i<<a))*(t>>a)<<a}let eXt=class{constructor(e,r,i){this._rows=Math.ceil(r/i),this._columns=Math.ceil(e/i),this._cellSize=i,this.cells=new Array(this._rows);for(let s=0;s<this._rows;s++){this.cells[s]=new Array(this._columns);for(let n=0;n<this._columns;n++)this.cells[s][n]=[]}}getCell(e,r){const i=Math.min(Math.max(Math.floor(r/this._cellSize),0),this._rows-1),s=Math.min(Math.max(Math.floor(e/this._cellSize),0),this._columns-1);return this.cells[i]&&this.cells[i][s]||null}getCellSpan(e,r,i,s){return[Math.min(Math.max(Math.floor(e/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(r/this._cellSize),0),this.rows-1),Math.min(Math.max(Math.floor(i/this._cellSize),0),this.columns-1),Math.min(Math.max(Math.floor(s/this._cellSize),0),this.rows-1)]}get cellSize(){return this._cellSize}get columns(){return this._columns}get rows(){return this._rows}};function bOt(t,e,r,i,s,n){const o=e[i++];for(let a=0;a<o;a++){const l=new vOt(n);l.xTile=e[i++],l.yTile=e[i++],l.hash=e[i++],l.priority=e[i++];const c=e[i++];for(let f=0;f<c;f++){const m=e[i++],g=e[i++],_=e[i++],v=e[i++],b=!!e[i++],x=e[i++],T=r[i++],S=r[i++],O=e[i++],A=e[i++];l.colliders.push({xTile:m,yTile:g,dxPixels:_,dyPixels:v,hard:b,partIndex:x,width:O,height:A,minLod:T,maxLod:S})}const h=t[i++];for(let f=0;f<h;f++)l.textVertexRanges.push([t[i++],t[i++]]);const p=t[i++];for(let f=0;f<p;f++)l.iconVertexRanges.push([t[i++],t[i++]]);s.push(l)}return i}function rXt(t,e,r){for(const[i,s]of t.symbols)wOt(t,e,r,s,i)}function wOt(t,e,r,i,s){const n=t.layerData.get(s);if(n.type===du.SYMBOL){for(const o of i){const a=o.unique;let l;if(o.selectedForRendering){const c=a.parts[0],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.iconVertexRanges)for(let p=c;p<c+h;p+=4)n.iconOpacity[p/4]=l;if(o.selectedForRendering){const c=a.parts[1],h=c.startOpacity,p=c.targetOpacity;t.allSymbolsFadingOut=t.allSymbolsFadingOut&&p===0;const f=r?Math.floor(127*h)|p<<7:p?255:0;l=f<<24|f<<16|f<<8|f}else l=0;for(const[c,h]of o.textVertexRanges)for(let p=c;p<c+h;p+=4)n.textOpacity[p/4]=l}n.lastOpacityUpdate=e,n.opacityChanged=!0}}let K8=class{constructor(e,r){this.layerUIDs=[],this.isDestroyed=!1,this._data=e;let i=1;const s=new Uint32Array(e);this.layerUIDs=[];const n=s[i++];for(let o=0;o<n;o++)this.layerUIDs[o]=s[i++];this.bufferDataOffset=i,r&&(this.layer=r.getStyleLayerByUID(this.layerUIDs[0]))}get isPreparedForRendering(){return this._data==null}get offset(){return this.bufferDataOffset}get data(){return this._data}destroy(){this.isDestroyed||(this.doDestroy(),this.isDestroyed=!0)}prepareForRendering(e){this._data!=null&&(this.doPrepareForRendering(e,this._data,this.bufferDataOffset),this._data=null)}},xOt=class extends K8{constructor(e,r){super(e,r),this.type=du.LINE,this.lineIndexStart=0,this.lineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.lineIndexStart=i[s++],this.lineIndexCount=i[s++];const n=i[s++];if(n>0){this.patternMap=new Map;for(let o=0;o<n;o++){const a=i[s++],l=i[s++],c=i[s++];this.patternMap.set(a,[l,c])}}this.bufferDataOffset=s}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}hasData(){return this.lineIndexCount>0}triangleCount(){return this.lineIndexCount/3}doDestroy(){this.vao=ze(this.vao)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++],a=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o));i+=o;const l=s[i++],c=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,l));i+=l;const h=this.layer.lineMaterial;this.vao=new Xd(e,h.getAttributeLocations(),h.getLayoutInfo(),{geometry:a},c)}},TOt=class extends K8{constructor(e,r){super(e,r),this.type=du.FILL,this.fillIndexStart=0,this.fillIndexCount=0,this.outlineIndexStart=0,this.outlineIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.fillIndexStart=i[s++],this.fillIndexCount=i[s++],this.outlineIndexStart=i[s++],this.outlineIndexCount=i[s++];const n=i[s++];if(n>0){this.patternMap=new Map;for(let o=0;o<n;o++){const a=i[s++],l=i[s++],c=i[s++];this.patternMap.set(a,[l,c])}}this.bufferDataOffset=s}get memoryUsed(){return(this.data?.byteLength??0)+(this.fillVAO?.memoryEstimate??0)+(this.outlineVAO?.memoryEstimate??0)}hasData(){return this.fillIndexCount>0||this.outlineIndexCount>0}triangleCount(){return(this.fillIndexCount+this.outlineIndexCount)/3}doDestroy(){this.fillVAO=ze(this.fillVAO),this.outlineVAO=ze(this.outlineVAO)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++],a=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o));i+=o;const l=s[i++],c=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,l));i+=l;const h=s[i++],p=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,h));i+=h;const f=s[i++],m=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,f));i+=f;const g=this.layer,_=g.fillMaterial,v=g.outlineMaterial;this.fillVAO=new Xd(e,_.getAttributeLocations(),_.getLayoutInfo(),{geometry:a},c),this.outlineVAO=new Xd(e,v.getAttributeLocations(),v.getLayoutInfo(),{geometry:p},m)}},SOt=class extends K8{constructor(e,r,i){super(e,r),this.type=du.SYMBOL,this.iconPerPageElementsMap=new Map,this.glyphPerPageElementsMap=new Map,this.symbolInstances=[],this.isIconSDF=!1,this.opacityChanged=!1,this.lastOpacityUpdate=0,this.symbols=[];const s=new Uint32Array(e),n=new Int32Array(e),o=new Float32Array(e);let a=this.bufferDataOffset;this.isIconSDF=!!s[a++];const l=s[a++];for(let f=0;f<l;f++){const m=s[a++],g=s[a++],_=s[a++];this.iconPerPageElementsMap.set(m,[g,_])}const c=s[a++];for(let f=0;f<c;f++){const m=s[a++],g=s[a++],_=s[a++];this.glyphPerPageElementsMap.set(m,[g,_])}const h=s[a++],p=s[a++];this.iconOpacity=new Int32Array(h),this.textOpacity=new Int32Array(p),a=bOt(s,n,o,a,this.symbols,i),this.bufferDataOffset=a}get memoryUsed(){return(this.data?.byteLength??0)+(this.iconVAO?.memoryEstimate??0)+(this.textVAO?.memoryEstimate??0)+i1(this.iconOpacity)+i1(this.textOpacity)}hasData(){return this.iconPerPageElementsMap.size>0||this.glyphPerPageElementsMap.size>0}triangleCount(){let e=0;for(const[r,i]of this.iconPerPageElementsMap)e+=i[1];for(const[r,i]of this.glyphPerPageElementsMap)e+=i[1];return e/3}doDestroy(){this.iconVAO=ze(this.iconVAO),this.textVAO=ze(this.textVAO)}updateOpacityInfo(){if(!this.opacityChanged)return;this.opacityChanged=!1;const e=this.iconOpacity,r=this.iconVAO.vertexBuffers.opacity;e.length>0&&e.byteLength===r.byteLength&&r.setSubData(e,0,0,e.length);const i=this.textOpacity,s=this.textVAO.vertexBuffers.opacity;i.length>0&&i.byteLength===s.byteLength&&s.setSubData(i,0,0,i.length)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++],a=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o));i+=o;const l=s[i++],c=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,l));i+=l;const h=s[i++],p=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,h));i+=h;const f=s[i++],m=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,f));i+=f;const g=Gr.createVertex(e,Mr.STATIC_DRAW,this.iconOpacity.buffer),_=Gr.createVertex(e,Mr.STATIC_DRAW,this.textOpacity.buffer),v=this.layer,b=v.iconMaterial,x=v.textMaterial;this.iconVAO=new Xd(e,b.getAttributeLocations(),b.getLayoutInfo(),{geometry:a,opacity:g},c),this.textVAO=new Xd(e,x.getAttributeLocations(),x.getLayoutInfo(),{geometry:p,opacity:_},m)}},EOt=class extends K8{constructor(e,r){super(e,r),this.type=du.CIRCLE,this.circleIndexStart=0,this.circleIndexCount=0;const i=new Uint32Array(e);let s=this.bufferDataOffset;this.circleIndexStart=i[s++],this.circleIndexCount=i[s++],this.bufferDataOffset=s}get memoryUsed(){return(this.data?.byteLength??0)+(this.vao?.memoryEstimate??0)}hasData(){return this.circleIndexCount>0}triangleCount(){return this.circleIndexCount/3}doDestroy(){this.vao=ze(this.vao)}doPrepareForRendering(e,r,i){const s=new Uint32Array(r),n=new Int32Array(s.buffer),o=s[i++],a=Gr.createVertex(e,Mr.STATIC_DRAW,new Int32Array(n.buffer,4*i,o));i+=o;const l=s[i++],c=Gr.createIndex(e,Mr.STATIC_DRAW,new Uint32Array(s.buffer,4*i,l));i+=l;const h=this.layer.circleMaterial;this.vao=new Xd(e,h.getAttributeLocations(),h.getLayoutInfo(),{geometry:a},c)}};const lXt=!0,cXt=32,Vme=200,COt=1/le("mapview-transitions-duration");let AOt=class extends Xr{constructor(){super(...arguments),this._fadeOutResolver=null,this._fadeInResolver=null,this._clips=null,this.computedVisible=!0,this.computedOpacity=1,this.fadeTransitionEnabled=!1,this.inFadeTransition=!1,this._isReady=!1,this._opacity=1,this.parent=null,this._stage=null,this._visible=!0}get clips(){return this._clips}set clips(e){this._clips=e,this.requestRender()}get isReady(){return this._isReady}get opacity(){return this._opacity}set opacity(e){this._opacity!==e&&(this._opacity=Math.min(1,Math.max(e,0)),this.requestRender())}get stage(){return this._stage}set stage(e){if(this._stage===e)return;const r=this._stage;this._stage=e,e?this._stage?.untrashDisplayObject(this)||(this.onAttach(),this.emit("attach")):r?.trashDisplayObject(this)}get transforms(){return this._getTransforms()}_getTransforms(){return this._transforms==null&&(this._transforms=this._createTransforms()),this._transforms}get visible(){return this._visible}set visible(e){this._visible!==e&&(this._visible=e,this.requestRender())}fadeIn(){return this._fadeInResolver||(this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.opacity=1,this.computedOpacity=0,this.fadeTransitionEnabled=!0,this._fadeInResolver=nn(),this.requestRender()),this._fadeInResolver.promise}fadeOut(){return this._fadeOutResolver||(this.opacity=0,this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this.fadeTransitionEnabled=!0,this._fadeOutResolver=nn(),this.requestRender()),this._fadeOutResolver.promise}endTransitions(){this._fadeInResolver?.(),this._fadeInResolver=null,this._fadeOutResolver?.(),this._fadeOutResolver=null,this.computedOpacity=this.visible?this.opacity:0,this.requestRender()}beforeRender(e){this.updateTransitionProperties(e.deltaTime,e.state.scale)}afterRender(e){this._fadeInResolver&&this.computedOpacity===this.opacity?(this._fadeInResolver(),this._fadeInResolver=null):this._fadeOutResolver&&this.computedOpacity===0&&(this._fadeOutResolver(),this._fadeOutResolver=null)}remove(){this.parent?.removeChild(this)}setTransform(e){}processRender(e){this.stage&&this.computedVisible&&this.doRender(e)}requestRender(){this.stage&&this.stage.requestRender()}processDetach(){this._fadeInResolver&&(this._fadeInResolver(),this._fadeInResolver=null),this._fadeOutResolver&&(this._fadeOutResolver(),this._fadeOutResolver=null),this.onDetach(),this.emit("detach")}updateTransitionProperties(e,r){if(this.fadeTransitionEnabled){const i=this._fadeOutResolver||!this.visible?0:this.opacity,s=this.computedOpacity;if(s===i)this.computedVisible=this.visible;else{const n=e*COt;this.computedOpacity=s>i?Math.max(i,s-n):Math.min(i,s+n),this.computedVisible=this.computedOpacity>0;const o=i===this.computedOpacity;this.inFadeTransition=!o,o||this.requestRender()}}else this.computedOpacity=this.opacity,this.computedVisible=this.visible}onAttach(){}onDetach(){}doRender(e){}ready(){this._isReady||(this._isReady=!0,this.emit("isReady"),this.requestRender())}},KY=class dx{static getId(e,r,i,s){return typeof e=="object"?`${e.level}/${e.row}/${e.col}/${e.world}`:`${e}/${r}/${i}/${s}`}constructor(e,r,i,s){this.set(e,r,i,s)}get key(){return this}get id(){return this.toString()}set id(e){this.set(e)}get hash(){const e=4095&this.row,r=4095&this.col,i=63&this.level;return(3&this.world)<<30|r<<22|e<<8|i}acquire(e,r,i,s){this.set(e,r,i,s)}contains(e){const r=e.level-this.level;return r>=0&&this.row===e.row>>r&&this.col===e.col>>r&&this.world===e.world}equals(e){return this.level===e.level&&this.row===e.row&&this.col===e.col&&this.world===e.world}clone(){return new dx(this)}release(){this.level=0,this.row=0,this.col=0,this.world=0}set(e,r,i,s){if(e==null)this.level=0,this.row=0,this.col=0,this.world=0;else if(typeof e=="object")this.level=e.level||0,this.row=e.row||0,this.col=e.col||0,this.world=e.world||0;else if(typeof e=="string"){const[n,o,a,l]=e.split("/");this.level=parseFloat(n),this.row=parseFloat(o),this.col=parseFloat(a),this.world=parseFloat(l)}else this.level=+e,this.row=+r,this.col=+i,this.world=+s||0;return this}toString(){return`${this.level}/${this.row}/${this.col}/${this.world}`}getParentKey(){return this.level<=0?null:new dx(this.level-1,this.row>>1,this.col>>1,this.world)}getChildKeys(){const e=this.level+1,r=this.row<<1,i=this.col<<1,s=this.world;return[new dx(e,r,i,s),new dx(e,r,i+1,s),new dx(e,r+1,i,s),new dx(e,r+1,i+1,s)]}compareRowMajor(e){return this.row<e.row?-1:this.row>e.row?1:this.col<e.col?-1:this.col>e.col?1:0}};KY.pool=new $o(KY,null,null,25,50);let OOt=class extends AOt{constructor(e,r,i,s,n,o,a=n,l=o){super(),this.triangleCountReportedInDebug=0,this.triangleCount=0,this.texture=null,this.key=new KY(e),this.resolution=r,this.x=i,this.y=s,this.width=n,this.height=o,this.rangeX=a,this.rangeY=l}destroy(){this.texture&&(this.texture.dispose(),this.texture=null)}setTransform(e){const r=this.resolution/(e.resolution*e.pixelRatio),i=this.transforms.tileMat3,[s,n]=e.toScreenNoRotation([0,0],[this.x,this.y]),o=this.width/this.rangeX*r,a=this.height/this.rangeY*r;lte(i,o,0,0,0,a,0,s,n,1),wA(this.transforms.dvs,e.displayViewMat3,i)}},ZG=class rNe extends OOt{constructor(e,r,i,s,n,o,a,l=null){super(e,r,i,s,n,o,4096,4096),this.styleRepository=a,this._memCache=l,this.type="vector-tile",this._referenced=0,this._hasSymbolBuckets=!1,this._memoryUsedByLayerData=0,this.layerData=new Map,this.layerCount=0,this.status="loading",this.allSymbolsFadingOut=!1,this.lastOpacityUpdate=0,this.symbols=new Map,this.isCoverage=!1,this.neededForCoverage=!1,this.decluttered=!1,this.invalidating=!1,this.parentTile=null,this.childrenTiles=new Set,this._processed=!1,this._referenced=1,this.id=e.id}get hasSymbolBuckets(){return this._hasSymbolBuckets}get isFading(){return this._hasSymbolBuckets&&performance.now()-this.lastOpacityUpdate<Vme}get isHoldingForFade(){return this._hasSymbolBuckets&&(!this.allSymbolsFadingOut||performance.now()-this.lastOpacityUpdate<Vme)}get wasRequested(){return this.status==="errored"||this.status==="loaded"||this.status==="reloading"}setData(e){this.changeDataImpl(e),this.requestRender(),this.ready(),this.invalidating=!1,this._processed=!0}deleteLayerData(e){let r=!1;for(const i of e)if(this.layerData.has(i)){const s=this.layerData.get(i);this._memoryUsedByLayerData-=s.memoryUsed,s.type===du.SYMBOL&&this.symbols.has(i)&&(this.symbols.delete(i),r=!0),s.destroy(),this.layerData.delete(i),this.layerCount--}this._memCache?.updateSize(this.key.id,this,this._memoryUsedByLayerData),r&&this.emit("symbols-changed"),this.requestRender()}processed(){return this._processed}hasData(){return this.layerCount>0}dispose(){this.status!=="unloaded"&&(iNe.delete(this),rNe._destroyRenderBuckets(this.layerData),this.layerData=null,this.layerCount=0,this._memoryUsedByLayerData=0,this.destroy(),this.status="unloaded")}release(){return--this._referenced==0&&(this.dispose(),this.stage=null,!0)}retain(){++this._referenced}get referenced(){return this._referenced}get memoryUsed(){return this._memoryUsedByLayerData+256}changeDataImpl(e){let r=!1;if(e){const{bucketsWithData:i,emptyBuckets:s}=e,n=this._createRenderBuckets(i);if(s&&s.byteLength>0){const o=new Uint32Array(s);for(const a of o)this._deleteLayerData(a)}for(const[o,a]of n)this._deleteLayerData(o),a.type===du.SYMBOL&&(this.symbols.set(o,a.symbols),r=!0),this._memoryUsedByLayerData+=a.memoryUsed,this.layerData.set(o,a),this.layerCount++;this._memCache?.updateSize(this.key.id,this,this.memoryUsed)}this._hasSymbolBuckets=!1;for(const[i,s]of this.layerData)s.type===du.SYMBOL&&(this._hasSymbolBuckets=!0);r&&this.emit("symbols-changed")}attachWithContext(e){this.stage={context:e,trashDisplayObject(r){r.processDetach()},untrashDisplayObject:()=>!1}}setTransform(e){super.setTransform(e);const r=this.resolution/(e.resolution*e.pixelRatio),i=this.width/this.rangeX*r,s=this.height/this.rangeY*r,n=[0,0];e.toScreen(n,[this.x,this.y]);const o=this.transforms.tileUnitsToPixels;cte(o),sU(o,o,n),ute(o,o,Math.PI*e.rotation/180),hte(o,o,[i,s,1])}_createTransforms(){return{dvs:Tc(),tileMat3:Tc(),tileUnitsToPixels:Tc()}}static _destroyRenderBuckets(e){if(!e)return;const r=new Set;e.forEach(i=>{r.has(i)||(i.destroy(),r.add(i))}),e.clear()}_createRenderBuckets(e){const r=new Map,i=new Map;for(const s of e){const n=this._deserializeBucket(s,i);for(const o of n.layerUIDs)r.set(o,n)}return r}_deserializeBucket(e,r){let i=r.get(e);if(i)return i;switch(new Uint32Array(e)[0]){case du.FILL:i=new TOt(e,this.styleRepository);break;case du.LINE:i=new xOt(e,this.styleRepository);break;case du.SYMBOL:i=new SOt(e,this.styleRepository,this);break;case du.CIRCLE:i=new EOt(e,this.styleRepository)}return r.set(e,i),i}_deleteLayerData(e){if(!this.layerData.has(e))return;const r=this.layerData.get(e);this._memoryUsedByLayerData-=r.memoryUsed,r.destroy(),this.layerData.delete(e),this.layerCount--}};const iNe=new Map;function ROt(){iNe.forEach((t,e)=>{console.log(`
${e.key}:`),t[0].forEach(r=>console.log(r)),console.log("========"),t[1].forEach(r=>console.log(r))})}const dXt={value:.5,readOnly:!0},MOt={readOnly:!0,value:.5,get(){return this.updating?this.updatingProgressValue:1}};let pC=class{constructor(e=0,r=0){this.min=e,this.max=r,this.level=0,this.hasNoDataValues=!1}copyFrom(e){this.min=e.min,this.max=e.max,this.level=e.level,this.hasNoDataValues=e.hasNoDataValues}},IOt=class{constructor(e,r){this.data=e,this.safeWidth=.99999999*(e.width-1),this.dx=(e.width-1)/(r[2]-r[0]),this.dy=(e.width-1)/(r[3]-r[1]),this.x0=r[0],this.y1=r[3]}},POt=class{constructor(e,r,i){this.type="elevation",this.level=e[0],this.i=e[1],this.j=e[2],this.extent=r,this.samplerData=new IOt(i,r)}computeMinMaxValue(e,r,i,s){s.min=1/0,s.max=-1/0,s.hasNoDataValues=!1;const n=e-this.level;if(n<=0)return s;const o=2**n;if(!(Math.floor(r/o)===this.i&&Math.floor(i/o)===this.j))return s;let a=1/0,l=-1/0;const c=this.samplerData.data.width,h=this.samplerData.data.values,p=.5*uP;let f=(c-1)/o,m=(i-this.j*o)*f,g=(r-this.i*o)*f;if(f<1){const _=Math.floor(m),v=Math.floor(g),b=_+v*c,x=h[b],T=h[b+1],S=h[b+c],O=h[b+c+1];if(x+T+S+O<p){const A=m-_,M=g-v,P=oD(x,T,S,O,A,M),F=oD(x,T,S,O,A+f,M),$=oD(x,T,S,O,A,M+f),N=oD(x,T,S,O,A+f,M+f);return s.min=Math.min(P,F,$,N),s.max=Math.max(P,F,$,N),s}m=_,g=v,f=1}else m=Math.floor(m),g=Math.floor(g),f=Math.ceil(f);for(let _=m;_<=m+f;_++)for(let v=g;v<=g+f;v++){const b=h[_+v*c];b<p?(a=Math.min(a,b),l=Math.max(l,b)):s.hasNoDataValues=!0}return s.min=a,s.max=l,s}};const $Ot=.5*uP;function _s(t,e,r){if(r==null)return null;for(const i of r){if(!i)continue;const s=i.safeWidth;let n=ye(i.dy*(i.y1-e),0,s),o=ye(i.dx*(t-i.x0),0,s);const a=Math.floor(n),l=Math.floor(o),c=i.data.width,h=a*c+l,p=i.data.values,f=p[h],m=p[h+1],g=h+c,_=p[g],v=p[g+1];if(f+_+m+v<$Ot){n-=a,o-=l;const b=f+(m-f)*o;return b+(_+(v-_)*o-b)*n}}return null}let cd=class extends me{constructor(e){super(e)}initialize(){this.addHandles([this.layerViews.on("change",()=>this.notifyChange("stencilEnabledExtents"))])}destroy(){}get layerViewsExtent(){return this._computeLayerViewsExtent()}get tiledLayersExtent(){return this._computeTiledLayersExtent()}get stencilEnabledExtents(){return this._computeStencilEnabledExtents()}_computeStencilEnabledExtents(){const e=[];return this.layerViews.forEach(r=>{const i=r.layer;if(i.operationalLayerType==="IntegratedMeshLayer"&&this.viewSpatialReference!=null){const s=sNe(i.fullExtent,this.viewSpatialReference);s!=null&&e.push(lbe(s))}}),e}};function LOt(t,e){return t===Ue.Global?new eJ(e):new tJ(e)}u([d({readOnly:!0})],cd.prototype,"layerViewsExtent",null),u([d({readOnly:!0})],cd.prototype,"tiledLayersExtent",null),u([d({readOnly:!0})],cd.prototype,"stencilEnabledExtents",null),u([d()],cd.prototype,"viewSpatialReference",void 0),u([d()],cd.prototype,"tilingScheme",void 0),u([d()],cd.prototype,"defaultTiledLayersExtent",void 0),u([d({constructOnly:!0})],cd.prototype,"layers",void 0),u([d({constructOnly:!0})],cd.prototype,"layerViews",void 0),cd=u([R("esri.views.3d.terrain.ExtentHelper")],cd);let eJ=class extends cd{_computeLayerViewsExtent(){return this._globalExtent}_computeTiledLayersExtent(){return this._globalExtent}get _globalExtent(){return this.viewSpatialReference.isWebMercator?SRe:Uct}};eJ=u([R("esri.views.3d.terrain.ExtentHelperGlobal")],eJ);let tJ=class extends cd{_computeLayerViewsExtent(){const e=Au(),r=this.viewSpatialReference;this.layerViews.forEach(n=>{const o=n.layer;if(n.isResolved()&&(o.type!=="graphics"||!o.internal)){const a=sNe("fullExtentInLocalViewSpatialReference"in n&&n.fullExtentInLocalViewSpatialReference||n.layer.fullExtent,r);E1(e,a,e)}});const i=g7(e)?e:null,s=this._get("layerViewsExtent");return Kx(i,s)?s:i}_computeTiledLayersExtent(){const e=this.tilingScheme;if(!e)return null;const r=this.viewSpatialReference,i=Au();this.layers.forEach(o=>{if(o.loaded&&GM(o)){const a=Q8(o,r,Ue.Local);if(a==null)return;const{tileInfo:l,fullExtent:c}=a;l!=null&&c!=null&&(n6(o)||e.compatibleWith(l)&&c.spatialReference.equals(e.spatialReference))&&E1(i,c,i)}}),E1(i,this.defaultTiledLayersExtent,i);const s=g7(i)?i:null,n=this._get("tiledLayersExtent");return Kx(s,n)?n:s}};function sNe(t,e){return t==null||t.spatialReference.equals(e)?t:mee(t,t.spatialReference,e)}tJ=u([R("esri.views.3d.terrain.ExtentHelperLocal")],tJ);var nr;(function(t){t[t.ELEVATION=0]="ELEVATION",t[t.MAP=1]="MAP"})(nr||(nr={}));const px=[nr.ELEVATION,nr.MAP];function nNe(){const t=globalThis.require?.modules;if(t){const e=Object.keys(t);for(const r of e)r.search(".glsl")!==-1&&delete t[r]}}const DOt=[[-.1,-2,3.9,2],[-.1,-3.9,3.9,.1],[-2,-3.9,2,.1],[-3.9,-3.9,.1,.1],[-3.9,-2,.1,2],[-3.9,-.1,.1,3.9],[-2,-.1,2,3.9],[-.1,-.1,3.9,3.9]];let F_,Tl=class extends me{get running(){return this._placementDirty&&(this._drapeSources.size>0||this.view.graphics.length>0||bi.OVERLAY_DRAW_DEBUG_TEXTURE)&&!!this._spatialReference&&!this.suspended&&this.surface.ready}get _isSpherical(){return this.view.state.isGlobal}get _worldToPCSRatio(){return this._spatialReference!=null&&this._spatialReference.isGeographic&&!this.view.state.isLocal?Ir(this._spatialReference).metersPerDegree:1}get suspended(){return this.surface.suspended}get updating(){return this.running||this.renderer.updating||this._contentUpdated}get hasHighlights(){return this.renderer.hasHighlights}get rendersOccluded(){return this.renderer.rendersOccluded}constructor(e){super(e),this._handles=new li,this._spatialReference=null,this._renderSR=null,this._overlaySREqualsRenderSR=!0,this._drapeSources=new Set,this._drapeTargets=new Set,this._placementDirty=!1,this._contentUpdated=!1,this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1,this._hasUnusedRenderTargets=!1,this._longitudeCyclical=null,this._latestOriginId=0,this._maxResolution=le("esri-mobile")?2048:4096,this._animationTimeLast=0,this._removeRenderOverlayCallback=()=>{}}initialize(){const e=this.view;this.renderer=new Im({view:e,worldToPCSRatio:this._worldToPCSRatio,spatialReference:this._spatialReference});const r=()=>this.setDrawTexturesDirty();this._groundIntersector=Jd(this.view.state.viewingMode),this._groundIntersector.options.backfacesTerrain=!0,this._groundIntersector.options.invisibleTerrain=!0,this._groundIntersector.options.hud=!1,this._handles.add([this.renderer.events.on("has-highlights",()=>{r(),this.notifyChange("hasHighlights")}),this.renderer.events.on("has-water",s=>e._stage?.renderer.setParameters({hasOverlayWater:s})),this.renderer.events.on("renders-occluded",()=>{r(),this.notifyChange("rendersOccluded")}),this.renderer.events.on("content-changed",r),Q(()=>e.state.camera.pixelRatio,r),Q(()=>e.state.alignPixelEnabled,r),this.renderer.events.on("textures-disposed",()=>this.updateOverlayResult()),Q(()=>[e.pointsOfInterest?.renderPointOfView,e.pointsOfInterest?.centerOnSurfaceFrequent?.location],()=>this.setPlacementDirty()),Q(()=>[e.state?.pixelRatio,e.state?.contentPixelRatio],()=>this.setPlacementDirty(),Rr),this.surface.on("elevation-change",()=>this.setPlacementDirty()),e.on("resize",()=>this.setPlacementDirty()),e.resourceController.scheduler.registerTask(gt.OVERLAY,this),e._stage.renderView.events.on("force-camera-for-screenshot",s=>{this._updateOverlays(Ll,s.camera,Us.BACKGROUND),this.renderer.hasOverlays&&this._drawOverlayTextures(this.renderer.overlays,Us.BACKGROUND,s)})]);let i=s=>this._renderOverlayCallback(s);this._removeRenderOverlayCallback=()=>{i=()=>{}},e._stage?.renderer.setParameters({renderOverlay:s=>i(s)})}_renderOverlayCallback(e){this._contentUpdated=!1;const r=this.renderer;r.processSyncDrapeSources(),r.hasOverlays&&(this._dispatchAnimationUpdate(e),this._drawOverlayTextures(r.overlays,Us.UPDATE,this.view.state)),this._hasUnusedRenderTargets&&this._collectUnusedRenderTargetMemory()}destroy(){this._handles=Re(this._handles),this._removeRenderOverlayCallback(),this.view?._stage?.renderer.setParameters({renderOverlay:()=>{}}),F_!=null&&(F_.hide(),F_=null)}get hasOverlays(){return this.renderer.hasOverlays}setSpatialReference(e){this._spatialReference=e,this.renderer.spatialReference=e,this._longitudeCyclical=null;const r=this.view.renderSpatialReference;e!=null&&r!=null?(this._renderSR=r,this._overlaySREqualsRenderSR=e.equals(this._renderSR),this._isSpherical&&(this._longitudeCyclical=e.isWebMercator?new F1(-20037508342787e-6,20037508342787e-6):new F1(-180,180),this.renderer.longitudeCyclical=this._longitudeCyclical),this.renderer&&(this.renderer.worldToPCSRatio=this._worldToPCSRatio)):this.renderer.disposeOverlays()}get gpuMemoryUsage(){return this.renderer.gpuMemoryUsage}registerDrapeSource(e,r,i){this._drapeSources.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const s=this.renderer.createDrapeSourceRenderer(e,r,i);return this._updateDrapeSourceExtent(e),this._setContentDirty(),this.notifyChange("running"),s}registerGeometryDrapeSource(e){return this.registerDrapeSource(e,Qu)}_updateDrapeSourceExtent(e){this.renderer.overlays.length===2&&e.setDrapingExtent!=null&&this._spatialReference!=null&&e.setDrapingExtent(this.renderer.overlays,this._spatialReference)}unregisterDrapeSource(e){this._drapeSources.has(e)&&(this._drapeSources.delete(e),this.renderer.removeDrapeSourceRenderer(e),this.renderer.ensureDrapeSources(this._drapeSources),this._setContentDirty(),this.notifyChange("running"))}registerDrapeTarget(e){this._drapeTargets.add(e),this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources)}updateOverlayResult(){this.view._stage?.renderer.setParameters({overlays:this.renderer.overlays})}unregisterDrapeTarget(e){this._drapeTargets.delete(e),this.renderer.ensureDrapeTargets(this._drapeTargets)}_setContentDirty(){this.setPlacementDirty(),this.setDrawTexturesDirty()}setPlacementDirty(){this._placementDirty=!0}runTask(e){return this._updateOverlays(e,this.view.state.contentCamera,Us.UPDATE)}_updateOverlays(e,r,i){if(!this._spatialReference)return Pa.YIELD;const s=this._computeOverlayResolution(r);this._computeOverlayExtents(r,s,oy);const n=hh(oy.inner)/hh(oy.outer);this.renderer.ensureOverlays(this._drapeTargets,this._drapeSources);const o=this._updateOverlay(Ji.INNER,oy.inner,s,1*oy.pixelRatioAdjustment,oy.mapUnitsPerPixel),a=this._updateOverlay(Ji.OUTER,oy.outer,s,n*oy.pixelRatioAdjustment,oy.mapUnitsPerPixel);o!==zm.EXTENT&&a!==zm.EXTENT||(this._drapeSources.forEach(l=>this._updateDrapeSourceExtent(l)),this.surface.updateTileOverlayParams(i)),o===zm.NONE&&a===zm.NONE||this.setDrawTexturesDirty(),this._placementDirty=!1,e.madeProgress()}_computeOverlayResolution(e){const r=this.view.state.contentPixelRatio,i=e.fullWidth/e.pixelRatio*r,s=e.fullHeight/e.pixelRatio*r,n=Math.ceil(1.5*Math.max(i,s));return Math.min(oie(n),this._maxResolution)}_updateOverlay(e,r,i,s,n){if(this.renderer.overlays.length===0)return zm.NONE;const o=this.renderer.overlays[e],a=o.mapUnitsPerPixel;if(o.mapUnitsPerPixel=n,o.pixelRatio=s,NOt(r,o.extent)&&i===o.resolution)return a===n?zm.NONE:zm.RERENDER_ONLY;C0(o.extent,r),o.resolution=i;const l=NQ(o.extent);return o.renderLocalOrigin=UU(l[0],l[1],0,"OV_"+this._latestOriginId++),zm.EXTENT}setTileParameters(e){const r=e.renderData.overlay;if(this.renderer.overlays.length>0){const i=this.renderer.overlays[Ji.INNER],s=this.renderer.overlays[Ji.OUTER],n=e.extent;this._rectInsideRect(i.extent,n)||this._rectanglesOverlap(n,i.extent)||this._rectanglesOverlap(n,s.extent)?(this._setTileOverlayData(n,Ji.INNER,r),this._setTileOverlayData(n,Ji.OUTER,r)):(this._clearTileOverlayData(Ji.INNER,r),this._clearTileOverlayData(Ji.OUTER,r))}else this._clearTileOverlayData(Ji.INNER,r),this._clearTileOverlayData(Ji.OUTER,r)}overlayPixelSizeInMapUnits(e){if(this.renderer.overlays.length===0)return 0;const r=this.renderer.overlays[Ji.INNER],i=this.renderer.overlays[Ji.OUTER],s=this._pointIsInExtent(e,r.extent)?r:i;return(s.extent[2]-s.extent[0])/s.resolution}_setTileOverlayData(e,r,i){if(this.renderer.overlays.length===0)return;const s=this.renderer.overlays[r].extent,n=hh(s),o=Mf(s);let a=e[0];if(this._longitudeCyclical){a=this._longitudeCyclical.minimalMonotonic(s[0],a);const l=this._longitudeCyclical.minimalMonotonic(s[0],e[2]);a>l&&(a=l-(e[2]-e[0]))}i.setScale(r,hh(e)/n,Mf(e)/o),i.setOffset(r,(a-s[0])/n,(e[1]-s[1])/o)}_clearTileOverlayData(e,r){r.setScale(e,-1,-1),r.setOffset(e,-1,-1)}async reloadShaders(){nNe(),await this.renderer.reloadShaders(),this.setDrawTexturesDirty(),this.runTask(Ll)}_dispatchAnimationUpdate(e){const r=e-this._animationTimeLast;if(r>=this.surface.view._stage.renderer.animationTimestep||this.view.state.forcedAnimationTime!=null||this._drawTexturesDirty||this._drawTexturesAnimateDirty){const i=r/this.surface.view._stage.renderer.animationTimeDilation,s=new QIe(this.view.state.camera,i,this.view.state.forcedAnimationTime);this.renderer.updateAnimation(s)&&(this._drawTexturesAnimateDirty=!0),this._animationTimeLast=e}}setDrawTexturesDirty(){this.renderer.hasOverlays?(this._contentUpdated=!0,this._drawTexturesDirty=!0,this.view._stage.renderView.requestRender()):this.setPlacementDirty()}_intersectGroundFromView(e,r,i,s){const n=this.view.sceneIntersectionHelper.getCenterRayWithSubpixelOffset(e,UOt,r,i);if(n==null)return!1;const o=n.origin,a=ue(YN,n.origin,n.direction);return this._groundIntersector.reset(o,a,e),this._groundIntersector.intersect([]),this.view.basemapTerrain.intersect(this._groundIntersector,null,o,a),this._groundIntersector.results.min.getIntersectionPoint(s)}_findHorizonBasedPointOfInterest(e,r){let i=.5;const s=.55,n=this.view.renderCoordsHelper.getAltitude(e.eye),o=this.view.pointsOfInterest.centerOnSurfaceFrequent,a=1e-5,l=ye(o.estimatedSurfaceAltitude,e.aboveGround?-1/0:n+a,e.aboveGround?n-a:1/0),c=e.aboveGround;if(this.view.viewingMode==="global"){const h=YN;wO(YV(JV,Ir(this.view.spatialReference).radius+l),Eh(e.eye,e.viewForward),h),pe(h,h,e.eye);const p=k1.normalize(LOe(e.viewForward,h,e.viewRight))/e.fovY+.5,f=p<=0||p>=1?.5:s;i=c?f*p:p+f*(1-p)}else{const h=.5*Math.PI-Math.acos(-e.viewForward[2]),p=Math.tan(h),f=Vt(0,p,1,0),m=ph(f,f,e.projectionMatrix)[1],g=ye(.5+.5*m,0,1);i=g===1||g===0?.5:c?g*s:1-(1-g)*s}return!!this._intersectGroundFromView(e,.5,i,r)&&F6(r,e.eye)<o.distance*o.distance}_computeOverlayExtents(e,r,i){const s=this.view.pointsOfInterest.centerOnSurfaceFrequent.renderLocation,n=C();this._findHorizonBasedPointOfInterest(e,n)||oe(n,s),bi.OVERLAY_SHOW_CENTER?(F_==null&&(F_=new $E(this.view.graphics,"red")),F_.show(n,this._renderSR)):F_?.hide();const o=Math.max(.1,_i(e.eye,n)),a=eb(this.view.renderCoordsHelper,s,e.eye);this._overlaySREqualsRenderSR||Tn(n,this._renderSR,n,this._spatialReference);const l=this.surface.extent,c=!this._isSpherical&&this._spatialReference!=null&&this._spatialReference.isGeographic,h=c&&this._spatialReference!=null?1/Ir(this._spatialReference).metersPerDegree:1,p=this.view.state.contentPixelRatio,f=e.perScreenPixelRatio/p*o*h;i.mapUnitsPerPixel=f/this._worldToPCSRatio;let m=r*f/2*Ire,g=!1,_=c?90:1/0;this._isSpherical&&l!=null&&this._spatialReference!=null&&(this._spatialReference.isWebMercator?(m/=Math.cos(K5(n[1])),_=l[3]):(g=!0,m/=Ir(this._spatialReference).metersPerDegree,_=90),m>=_&&(m=_,n[1]=0,this._spatialReference.isWebMercator&&(n[0]=0)));let v=1;g&&(v=1/Math.max(.2,Math.cos(Math.abs(zt(n[1])))),m*v>180&&(v=180/m),i.mapUnitsPerPixel*=v);const b=Math.log(2)/12;m=Math.exp(Math.round(Math.log(m)/b)*b);const x=m*v,T=32,S=.5*r/(T*x),O=.5*r/(T*m);n[0]=Math.round(n[0]*S)/S,n[1]=Math.round(n[1]*O)/O;const A=i.inner;A[0]=n[0]-x,A[1]=n[1]-m,A[2]=n[0]+x,A[3]=n[1]+m,this._isSpherical&&this._shiftExtentToFitBounds(A,1/0,_);const M=i.outer;if(6*x>hh(l))C0(M,l);else if(Math.PI/2-Math.abs(a-Math.PI/2)<=.25*Math.PI)M[0]=A[0]-x,M[1]=A[1]-m,M[2]=A[2]+x,M[3]=A[3]+m;else{Tn(e.eye,this._renderSR,YN,this._spatialReference),zs(ow,n,YN);let F=-Math.atan2(ow[1],ow[0])+.125*Math.PI;F<0&&(F+=2*Math.PI);const $=Math.floor(F/(.25*Math.PI));AT(ow,DOt[$],2*m),ow[0]*=v,ow[2]*=v,PQ(M,A,ow)}if(this._isSpherical)M[0]=this._longitudeCyclical.clamp(M[0]),M[2]=this._longitudeCyclical.clamp(M[2]),M[1]=Math.max(M[1],-_),M[3]=Math.min(M[3],_);else{const F=y7(A,l,FOt),$=y7(M,l,kOt);Sne(F,$)&&(M[2]=M[0],M[3]=M[1])}const P=Math.abs(A[2]-A[0])/r;i.mapUnitsPerPixel=Math.max(i.mapUnitsPerPixel,P),i.pixelRatioAdjustment=i.mapUnitsPerPixel/P}_drawOverlayTextures(e,r,i){if(e.length===0||!this._drawTexturesDirty&&!this._drawTexturesAnimateDirty)return;const s=this._drawTexturesDirty;this._drawTexturesDirty=!1,this._drawTexturesAnimateDirty=!1;const n=this._drawOverlay(e[Ji.INNER],i),o=this._drawOverlay(e[Ji.OUTER],i);n!==MA.CHANGED&&o!==MA.CHANGED||this.surface.updateTileOverlayParams(Us.UPDATE),this._collectUnusedRenderTargetMemory(),this.updateOverlayResult(),s?(this.surface.requestRender(r),r===Us.UPDATE&&this.surface.requestUpdate()):this.surface.requestRender(Us.BACKGROUND)}_drawOverlay(e,r){return this._longitudeCyclical?e.setupGeometryViewsCyclical(this._longitudeCyclical):e.setupGeometryViewsDirect(),e.draw(this.renderer,r)}_collectUnusedRenderTargetMemory(){this._hasUnusedRenderTargets=!1,this.renderer.hasOverlays&&(this._hasUnusedRenderTargets=this.renderer.collectUnusedRenderTargetMemory())}_rectanglesOverlap(e,r){return e!=null&&(this._longitudeCyclical?(this._longitudeCyclical.contains(r[0],r[2],e[0])||this._longitudeCyclical.contains(r[0],r[2],e[2])||this._longitudeCyclical.contains(e[0],e[2],r[0]))&&!(e[1]>r[3]||e[3]<r[1]):JP(e,r))}_rectInsideRect(e,r){return r!=null&&(this._longitudeCyclical?this._longitudeCyclical.contains(e[0],e[2],r[0])&&this._longitudeCyclical.contains(e[0],e[2],r[2])&&r[1]>e[1]&&r[3]<e[3]:Sne(e,r))}_pointIsInExtent(e,r){if(this._longitudeCyclical)return this._longitudeCyclical.contains(r[0],r[2],e.x)&&e.y>=r[1]&&e.y<=r[3];const i=e.x,s=e.y;return i>r[0]&&i<r[2]&&s>r[1]&&s<r[3]}_shiftExtentToFitBounds(e,r,i){let s=0,n=0;e[0]<-r?s=e[0]+r:e[2]>r&&(s=r-e[2]),e[1]<-i?n=e[1]+i:e[3]>i&&(n=i-e[3]),ok(e,s,n)}get test(){return{renderer:this.renderer,update:()=>this.runTask(Ll)}}};function NOt(t,e){const i=bi.TESTS_DISABLE_OPTIMIZATIONS?0:1e-5*Math.max(t[2]-t[0],t[3]-t[1],e[2]-e[0],e[3]-e[1]);return Math.abs(e[0]-t[0])<=i&&Math.abs(e[1]-t[1])<=i&&Math.abs(e[2]-t[2])<=i&&Math.abs(e[3]-t[3])<=i}u([d()],Tl.prototype,"_spatialReference",void 0),u([d({readOnly:!0})],Tl.prototype,"running",null),u([d()],Tl.prototype,"_placementDirty",void 0),u([d()],Tl.prototype,"_contentUpdated",void 0),u([d()],Tl.prototype,"_isSpherical",null),u([d()],Tl.prototype,"_worldToPCSRatio",null),u([d({autoDestroy:!0})],Tl.prototype,"renderer",void 0),u([d({constructOnly:!0})],Tl.prototype,"view",void 0),u([d({constructOnly:!0})],Tl.prototype,"surface",void 0),u([d()],Tl.prototype,"suspended",null),u([d()],Tl.prototype,"updating",null),u([d({type:Boolean})],Tl.prototype,"hasHighlights",null),u([d({type:Boolean})],Tl.prototype,"rendersOccluded",null),Tl=u([R("esri.views.3d.terrain.OverlayManager")],Tl);const ow=Qt(),YN=C(),oy={inner:Ht(),outer:Ht(),mapUnitsPerPixel:0,pixelRatioAdjustment:1},FOt=Ht(),kOt=Ht(),UOt=Io();var zm;(function(t){t[t.NONE=0]="NONE",t[t.EXTENT=1]="EXTENT",t[t.RERENDER_ONLY=2]="RERENDER_ONLY"})(zm||(zm={}));let oNe=class rJ{constructor(e,r){this._factoryCallback=e,this._lengthCallback=r,this._pool=new Map}acquire(e){if(!rJ.test.disabled){const r=this._pool.get(e);if(r&&r.length!==0)return r.pop()}try{return this._factoryCallback(e)}catch(r){const i=window.performance&&window.performance.memory;let s="";throw i&&(s=`
  totalJSHeapSize: ${i.totalJSHeapSize}, usedJSHeapSize: ${i.usedJSHeapSize}, jsHeapSizeLimit: ${i.jsHeapSizeLimit}`),console.log("Array allocation of size "+e+" failed: "+r+s),r}}release(e){if(rJ.test.disabled)return;const r=this._lengthCallback(e);let i=this._pool.get(r);i||(i=new qt({shrink:!0}),this._pool.set(r,i)),i.push(e)}clear(){this._pool.clear()}get test(){return{size:this._pool.size}}};oNe.test={disabled:!1};let VOt=class{constructor(){this.indices=null,this.vertexAttributes=null,this.boundingBox=Gi(),this.indexCount=0,this.numVerticesPerSide=0,this.uvRange=[0,0,1,1],this.outerEdges=[null,null,null,null],this.innerEdges=[null,null,null,null]}},zme=class{constructor(e,r,i,s,n){this.attributes=e,this.localOrigin=r,this.index0=i,this.stride=s,this.count=n}getVertexIndex(e){return this.getAttributeIndex(e)}getAttributeIndex(e){return Se(0<=e&&e<this.count),this.index0+this.stride*e}_getVertexRaw(e,r){this.attributes.position.getVec(e,r)}getVertexPos(e,r){this._getVertexRaw(this.getAttributeIndex(r),e),ue(e,e,this.localOrigin)}getNormal(e,r){const{typedBuffer:i,typedBufferStride:s}=this.attributes.normalCompressed;Zwt(e,i,this.getAttributeIndex(r),s)}_setNormal(e,r,i,s){const{typedBuffer:n,typedBufferStride:o}=this.attributes.normalCompressed;YT(n,e,r,i,s,o)}_setUV(e,r,i){Ef(this.attributes.uv0,e,r,i)}setNormalFromValues(e,r,i,s){this._setNormal(this.getAttributeIndex(e),r,i,s)}setVertexFromValuesRawPositionUV(e,r,i,s,n,o){const a=this.getAttributeIndex(e);this.attributes.position.setValues(a,r,i,s),this._setUV(a,n,o)}setVertexFromValuesRawPositionUVNormal(e,r,i,s,n,o,a,l,c){const h=this.getAttributeIndex(e);this.attributes.position.setValues(h,r,i,s),this._setUV(h,n,o),this._setNormal(h,a,l,c)}};const zOt=us().vec3f(E.POSITION).vec2i16(E.UV0).vec2i16(E.NORMALCOMPRESSED,{glNormalized:!0}),Die=new oNe(t=>zOt.createBuffer(t),t=>t.count);function BOt(){Die.clear()}function aNe(t){return Die.acquire(t)}function GOt(t){Die.release(t.vertexAttributes),t.vertexAttributes=null,t.indices=null}const Bme=16384;function Ef(t,e,r,i){t.setValues(e,r*Bme,i*Bme)}function Ud(t,e,r,i){t<i[0]?i[0]=t:t>i[3]&&(i[3]=t),e<i[1]?i[1]=e:e>i[4]&&(i[4]=e),r<i[2]?i[2]=r:r>i[5]&&(i[5]=r)}let jOt=class{constructor(){this.sinLonLUT=new Array(Y3+1),this.cosLonLUT=new Array(Y3+1),this.sinLatLUT=new Array(Y3+1),this.cosLatLUT=new Array(Y3+1)}update(e,r,i){const s=r[0],n=r[2];for(let o=0;o<=e;o++){const a=o/e,l=s*(1-a)+n*a;this.sinLonLUT[o]=Math.sin(l),this.cosLonLUT[o]=Math.cos(l);const c=i(a);this.sinLatLUT[o]=Math.sin(c),this.cosLatLUT[o]=Math.cos(c)}}},JN=class{constructor(){this.cornerTiles=[null,null,null,null],this.cornerTileSamplerVersions=[-1,-1,-1,-1]}},HOt=class{constructor(){this.cornerNeighborData=[new JN,new JN,new JN,new JN],this.edgeResolutions=[-1,-1,-1,-1],this.edgePeerNeighbors=[null,null,null,null],this.edgePeerNeighborSamplerVersions=[-1,-1,-1,-1],this.cornerPeerNeighbors=[null,null,null,null]}},qOt=class{constructor(){this.numVerticesPerSide=0,this.samplerData=null,this.clippingArea=null,this.wireframe=!1,this.samplerDataVersion=0,this.neighborData=new HOt}},lNe=class y5{constructor(e){this._getFadeDuration=e,this._fadeStart=0,this._delayedTime=0}clear(){this._current=Re(this._current),this._next=Re(this._next),this._waiting=Re(this._waiting),this._delayed=Re(this._delayed)}get current(){if(this._current==null)return null;if(!this._isFadingEnabled){const r=this._delayed||this._waiting||this._next||this._current;r!==this._current&&(this._current=null,this.clear(),this._current=r)}let e=y5.test.fadeMoment;if(this._delayed!=null&&(e=e||performance.now(),e>=this._delayedTime&&(this._push(this._delayed,b0.Immediate),this._delayed=null)),this._next!=null){e=e||performance.now();const r=this._fadeDuration,i=this._current!=null&&this._next.texture===this._current.texture,s=this._next.type!==$n.FADING,n=e-this._fadeStart>=r;(i||s||n)&&(Re(this._current),this._current=this._next,this._next=this._waiting,this._waiting=null,this._fadeStart=this._alignFadeStart(e))}return this._current}get next(){return this._next}get fadeFactor(){if(this._next==null)return 1;const e=y5.test.fadeMoment||performance.now(),r=Math.max(0,e-this._fadeStart),i=this._fadeDuration;return r>i?0:1-r/i}get isFading(){return this._next!=null||this._delayed!=null}push(e,r=b0.Immediate){this._delayed=Re(this._delayed),this._push(e,r)}_push(e,r){if(this._isFadingEnabled||this.clear(),this._current==null)return void(this._current=e);const i=y5.test.fadeMoment||performance.now();return r!==b0.Immediate?(this._delayed=e,void(this._delayedTime=i+r)):this._next==null?(this._next=e,void(this._fadeStart=this._alignFadeStart(i))):void(e!=null&&(Re(this._waiting),this._waiting=e))}get _fadeDuration(){return this._waiting==null?this._getFadeDuration():.5*this._getFadeDuration()}_alignFadeStart(e){const r=this._getFadeDuration();return e+r-e%r}get _isFadingEnabled(){return this._getFadeDuration()>0}};var b0;lNe.test={fadeMoment:0},function(t){t[t.Immediate=0]="Immediate",t[t.Delayed=5e3]="Delayed"}(b0||(b0={}));var HA;(function(t){t[t.BACK_TO_FRONT=-1]="BACK_TO_FRONT",t[t.NONE=0]="NONE",t[t.FRONT_TO_BACK=1]="FRONT_TO_BACK"})(HA||(HA={}));let cNe=class{constructor(){this._queue=new qt,this.remove=()=>{}}get done(){return this._queue.length===0&&(!this._last||this._last.isLeaf)}resetOne(e){this._queue.clear(),this._queue.push(e),this._last=void 0}reset(e=null){this._queue.clear(),e!=null&&this._queue.pushArray(e),this._last=void 0}skipSubtree(){this._last=void 0}next(){const e=this._last?.children;return e&&e[0]&&this._queue.pushArray(e),this._last=this._queue.pop(),this._last}},WOt=class{constructor(){this._q=new qt}get done(){return this._q.length===0}reset(e){if(this._q.clear(),e!=null){this._q.pushArray(e);for(let r=0;r<this._q.length;++r){const i=this._q.data[r];i.isLeaf||this._q.pushArray(i.children)}}}next(){return this._q.pop()}};function CI(t,e,r){if(e==null||e.fullExtent==null)return!1;const i=e.fullExtent,s=t.extent;if(r){if(s[0]<i.xmin||s[1]<i.ymin||s[2]>i.xmax||s[3]>i.ymax)return!1}else if(i.xmin>s[2]||i.ymin>s[3]||i.xmax<s[0]||i.ymax<s[1])return!1;const n=t.surface.tilingScheme.levels[t.level].scale,o=e.minScale;if(o>0&&n>1.00000001*o)return!1;const a=e.maxScale;return!(a>0&&n<.99999999*a)}function w0(t,e){const r=t.lij,i=e.lij;return r[0]-i[0]||r[1]-i[1]||r[2]-i[2]}function uNe(t,e,r=null){r==null||r.length===0?t===HA.BACK_TO_FRONT?e.sort(ZOt):e.sort(XOt):e.sort((i,s)=>YOt(i,s,t,r))}function ZOt(t,e){const r=e.screenDepth-t.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function XOt(t,e){const r=t.screenDepth-e.screenDepth;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function hNe(t,e,r){const i=t.screenDepth,s=e.screenDepth;return i<s?-r:i>s?r:w0(t,e)}function YOt(t,e,r,i){return Gme(t,i)===Gme(e,i)?hNe(t,e,r):t?r:-r}function Gme(t,e){for(const r of e)if(t.intersectsExtent(r))return!0;return!1}function JOt(t,e){const r=t.distanceToPOI-e.distanceToPOI;if(r!==0)return r;const i=t.lij,s=e.lij;return i[0]-s[0]||i[1]-s[1]||i[2]-s[2]}function QOt(t,e){const r=t.length;for(let i=0;i<r;++i)t.at(i).updateDistanceToPOI(e);t.sort(JOt)}function KOt(t,e,r){let i=1,s=0,n=0;for(;t!==e;)if(i*=.5,s*=.5,n*=.5,1&t.lij[2]&&(s+=.5),!(1&t.lij[1])&&(n+=.5),(t=t.parent)==null)throw new Error("tile was not a descendant of upsampleTile");r.init(e,s,n,i)}function eRt(t){for(let e=0;e<t.length;e++){const r=t[e],i=r.parent;if(i)for(let s=0;s<4;s++){const n=i.children[s];if(n&&n!==r)return!0}}return!1}function OXt(t,e){if(!t||!e||t[0]===e[0])return!1;const r=t[0]<e[0],i=r?t:e,s=r?e:t,n=1<<s[0]-i[0];return Math.floor(s[1]/n)===i[1]&&Math.floor(s[2]/n)===i[2]}let Nie=class{get updating(){return!!this._tileRequested}init(e,r,i,s){this.tile=e,this._layerIdx=r,this._layerClass=i,this._suspended=s,this._tileLayerInfo=e.getLayerInfo(r,i),this._tileRequested=null;const n=this._findAncestorWithData();this._setUpsampleTile(n)}startLoading(){return this._requestNext()}dispose(){this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null),this.tile=null,this._tileLayerInfo=null}setSuspension(e){e!==this._suspended&&(this._suspended=e,e?this._tileRequested&&(this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null):this._tileLayerInfo.data||this.update())}update(){const e=this._findAncestorWithData();return this._setUpsampleTile(e),this._requestNext()}dataArrived(e,r){this._setUpsampleTile(e,r),this._tileRequested=null,e===this.tile?this.tile.updateRenderData(this._layerClass,$n.FADING,r):this._requestNext()}dataMissing(){this._tileRequested=null,this._tileLayerInfo.data=null,this._requestNext()}_agentDone(){this.tile.agentDone(this._layerIdx,this._layerClass),this.dispose()}_requestNext(){if(this._suspended)return!0;const e=this._findNextDownload();if(this._tileRequested){if(e===this._tileRequested)return!0;this._tileRequested.unrequestLayerData(this._layerIdx,this._layerClass,this),this._tileRequested=null}return e!=null?e.requestLayerData(this._layerIdx,this._layerClass,this)&&(this._tileRequested=e):this._agentDone(),!!this._tileRequested}_findNextDownload(){const e=this._layerIdx,r=this._layerClass,i=this.tile.surface.layerViewByIndex(e,r),s=YY(i),{minLevel:n,maxLevel:o}=i.dataLevelRange,a=this._desiredMinLevelDelta,l=this._progressiveLevelModulo+a,c=this._scaleRangeEnabled?CI:()=>!0;let h=this.tile;const p=h.level;let f;const m=this._tileLayerInfo.upsampleInfo,g=m!=null?m.tile.level:-1,_=m!=null&&g-p>=a,v=s?.tilemapCache,b=i.type==="vector-tile-3d"?i.schemaHelper:null;for(;h&&c(h,s,!1)&&h.level>=n;){const x=h.level,T=p-x,S=h.layerInfo[r][e];if(S.data&&T>=a){(!_||x>g)&&this._setUpsampleTile(h),S.dataInvalidated&&(f=h);break}const O=b?.getLevelRowColumn(h.lij)??h.lij;if(v?.getAvailability(O[0],O[1],h.lij[2])!=="unavailable"&&x<=o&&!S.data&&!S.dataMissing&&((!f||h.level===n||x%TRe==0||p-f.level<a)&&(f=h),T>=l))break;h=h.parent}if(f!=null&&p-f.level<a)if(m)f=null;else{const x=this._findAncestorWithData();x!=null&&(this._setUpsampleTile(x),f=x.layerInfo[r][e].dataInvalidated?x:null)}return f}_findAncestorWithData(){const e=this.tile.elevationLevel,r=this._desiredMinLevelDelta;let i;for(let s=this.tile;s;s=s.parent)if(s.hasLayerData(this._layerIdx,this._layerClass)){if(e-s.level>=r)return s;i=s}return i}_setUpsampleTile(e,r){this._tileLayerInfo.setUpsampleInfo(this.tile,e),this.tile.updateRenderData(this._layerClass,$n.FADING,r)}get test(){return{findNextDownload:()=>this._findNextDownload(),tileLayerInfo:this._tileLayerInfo}}},tRt=class extends Nie{get _desiredMinLevelDelta(){throw jme}get _progressiveLevelModulo(){throw jme}dispose(){}};const jme=new Error("Abstract method called on TileAgent"),Uc=new tRt;let dNe=class extends Nie{constructor(){super(...arguments),this._scaleRangeEnabled=!1}get _desiredMinLevelDelta(){return zZ(this.tile.level)-(this.tile.elevationLevel-this.tile.level)}get _progressiveLevelModulo(){return 0}},pNe=class extends Nie{constructor(){super(),this._scaleRangeEnabled=!0}get _desiredMinLevelDelta(){return 0}get _progressiveLevelModulo(){return TRe}};var mT,QT;(function(t){t[t.Stretch=0]="Stretch",t[t.Lut=1]="Lut",t[t.Hillshade=2]="Hillshade",t[t.COUNT=3]="COUNT"})(mT||(mT={})),function(t){t[t.Noop=0]="Noop",t[t.PerBand=1]="PerBand",t[t.COUNT=2]="COUNT"}(QT||(QT={}));function rRt(t){t.fragment.uniforms.add(new et("u_colormap",e=>e.u_colormap),new Ie("u_colormapOffset",e=>e.colormap.u_colormapOffset),new Ie("u_colormapMaxIndex",e=>e.colormap.u_colormapMaxIndex),new Ie("u_opacity",e=>e.common.u_opacity)),t.fragment.code.add(w`vec4 colormap(vec4 currentPixel, bool isFloat) {
float colorIndex = isFloat ? currentPixel.r - u_colormapOffset : currentPixel.r * 255.0 - u_colormapOffset;
vec4 result;
if (currentPixel.a == 0.0 || colorIndex > u_colormapMaxIndex) {
result = vec4(0.0, 0.0, 0.0, 0.0);
} else {
vec2 texelCoordinates = vec2((colorIndex + 0.5), 0.5);
result = texelFetch(u_colormap, ivec2(texelCoordinates), 0);
}
return result;
}`)}function iRt(t){t.fragment.uniforms.add(new et("u_transformGrid",e=>e.u_transformGrid),new Pr("u_transformSpacing",e=>e.common.u_transformSpacing),new Pr("u_targetImageSize",e=>e.common.u_targetImageSize)),t.fragment.code.add(w`vec2 projectPixelLocation(vec2 coords) {
vec2 index_image = floor(coords * u_targetImageSize);
vec2 oneTransformPixel = vec2(4.0, 1.0);
vec2 index_transform = floor(index_image / u_transformSpacing) * oneTransformPixel;
vec2 pos = fract((index_image + 0.5) / u_transformSpacing);
vec2 transform_location = index_transform + 0.5;
vec2 srcLocation;
if (pos.s <= pos.t) {
vec3 ll_abc = texelFetch(u_transformGrid, ivec2(transform_location), 0).rgb;
vec3 ll_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 1.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ll_abc, vec3(pos, 1.0));
srcLocation.t = dot(ll_def, vec3(pos, 1.0));
} else {
vec3 ur_abc = texelFetch(u_transformGrid, ivec2(transform_location.s + 2.0, transform_location.t), 0).rgb;
vec3 ur_def = texelFetch(u_transformGrid, ivec2(transform_location.s + 3.0, transform_location.t), 0).rgb;
srcLocation.s = dot(ur_abc, vec3(pos, 1.0));
srcLocation.t = dot(ur_def, vec3(pos, 1.0));
}
return srcLocation;
}`)}let fNe=class extends ui{constructor(){super(...arguments),this.scale=1,this.offset=Df}};function mNe(t){t.attributes.add(E.POSITION,"vec2"),t.attributes.add(E.UV0,"vec2"),t.vertex.uniforms.add(new Ie("scale",e=>e.scale)),t.vertex.uniforms.add(new Pr("offset",e=>e.offset)),t.varyings.add("uv","vec2"),t.varyings.add("vuv","vec2"),t.vertex.code.add(w`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv = uv0 * scale + offset;
vuv = uv0;
}`)}let sRt=class extends fNe{constructor(e,r,i){super(),this.common=e,this.u_image=r,this.u_transformGrid=i}};function nRt(t,e){t.include(iRt),t.fragment.uniforms.add(new et("u_image",i=>i.u_image),new lg("u_flipY",i=>i.common.u_flipY),new lg("u_applyTransform",i=>i.common.u_applyTransform));const{requireBilinearWithNN:r}=e;r&&t.fragment.uniforms.add(new Pr("u_srcImageSize",i=>i.common.u_srcImageSize)),t.fragment.code.add(w`vec2 getPixelLocation(vec2 coords) {
vec2 targetLocation = u_flipY ? vec2(coords.s, 1.0 - coords.t) : coords;
if (!u_applyTransform) {
return targetLocation;
}
return projectPixelLocation(targetLocation);
}
bool isOutside(vec2 coords){
if (coords.t>1.00001 ||coords.t<-0.00001 || coords.s>1.00001 ||coords.s<-0.00001) {
return true;
} else {
return false;
}
}`),r?t.fragment.code.add(w`vec4 sampleBilinear(sampler2D sampler, vec2 coords, vec2 texSize) {
vec2 texelStart = floor(coords * texSize);
vec2 coord0 = texelStart / texSize;
vec2 coord1 = (texelStart +  vec2(1.0, 0.0)) / texSize;
vec2 coord2 = (texelStart +  vec2(0.0, 1.0)) / texSize;
vec2 coord3 = (texelStart +  vec2(1.0, 1.0)) / texSize;
vec4 color0 = texture(sampler, coord0);
vec4 color1 = texture(sampler, coord1);
vec4 color2 = texture(sampler, coord2);
vec4 color3 = texture(sampler, coord3);
vec2 blend = fract(coords * texSize);
vec4 color01 = mix(color0, color1, blend.x);
vec4 color23 = mix(color2, color3, blend.x);
vec4 color = mix(color01, color23, blend.y);
float alpha = floor(color0.a * color1.a * color2.a * color3.a + 0.5);
color = color * alpha + (1.0 - alpha) * texture(sampler, coords);
return color;
}
vec4 getPixel(vec2 pixelLocation) {
return sampleBilinear(u_image, pixelLocation, u_srcImageSize);
}`):t.fragment.code.add(w`vec4 getPixel(vec2 pixelLocation) {
return texture(u_image, pixelLocation);
}`)}var $e;(function(t){t[t.Normal=0]="Normal",t[t.Average=1]="Average",t[t.Lighten=2]="Lighten",t[t.Lighter=3]="Lighter",t[t.Plus=4]="Plus",t[t.Screen=5]="Screen",t[t.ColorDodge=6]="ColorDodge",t[t.Darken=7]="Darken",t[t.Multiply=8]="Multiply",t[t.ColorBurn=9]="ColorBurn",t[t.Overlay=10]="Overlay",t[t.SoftLight=11]="SoftLight",t[t.HardLight=12]="HardLight",t[t.VividLight=13]="VividLight",t[t.Hue=14]="Hue",t[t.Saturation=15]="Saturation",t[t.Luminosity=16]="Luminosity",t[t.Color=17]="Color",t[t.DestinationOver=18]="DestinationOver",t[t.DestinationAtop=19]="DestinationAtop",t[t.DestinationIn=20]="DestinationIn",t[t.DestinationOut=21]="DestinationOut",t[t.SourceAtop=22]="SourceAtop",t[t.SourceIn=23]="SourceIn",t[t.SourceOut=24]="SourceOut",t[t.Xor=25]="Xor",t[t.Difference=26]="Difference",t[t.Exclusion=27]="Exclusion",t[t.Minus=28]="Minus",t[t.Invert=29]="Invert",t[t.Reflect=30]="Reflect",t[t.COUNT=31]="COUNT"})($e||($e={}));const iJ={normal:$e.Normal,average:$e.Average,lighten:$e.Lighten,lighter:$e.Lighter,screen:$e.Screen,plus:$e.Plus,"color-dodge":$e.ColorDodge,darken:$e.Darken,multiply:$e.Multiply,"color-burn":$e.ColorBurn,overlay:$e.Overlay,"soft-light":$e.SoftLight,"hard-light":$e.HardLight,"vivid-light":$e.VividLight,hue:$e.Hue,saturation:$e.Saturation,luminosity:$e.Luminosity,color:$e.Color,difference:$e.Difference,exclusion:$e.Exclusion,minus:$e.Minus,invert:$e.Invert,reflect:$e.Reflect,"destination-over":$e.DestinationOver,"destination-atop":$e.DestinationAtop,"destination-in":$e.DestinationIn,"destination-out":$e.DestinationOut,"source-atop":$e.SourceAtop,"source-in":$e.SourceIn,"source-out":$e.SourceOut,xor:$e.Xor};function oRt(t){return t===$e.DestinationOver||t===$e.DestinationAtop||t===$e.DestinationIn||t===$e.DestinationOut||t===$e.SourceAtop||t===$e.SourceIn||t===$e.SourceOut||t===$e.Xor}function Fie(t){t.code.add(w`
    float lineFactorAtPosition(float value) {
      float pos = value * ${w.float(257)};
      if(pos < 0.5 || pos > ${w.float(257-.5)}) {
        return 1.0;
      }

      pos = pos + 0.5;
      float modulo = mod(pos, 16.0);
      return modulo <= 2.0 ?  1.0 - abs(modulo - 1.0) : 0.0;
    }

    float lineFactorAtUV(vec2 uv) {
      return max(lineFactorAtPosition(uv.x), lineFactorAtPosition(uv.y));
    }

    float lineFactor(vec2 uv) {
      vec2 offset = fwidth(uv) * 0.25;
      return (lineFactorAtUV(vec2(uv.x + offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y + offset.y)) +
              lineFactorAtUV(vec2(uv.x + offset.x, uv.y - offset.y)) +
              lineFactorAtUV(vec2(uv.x - offset.x, uv.y - offset.y))) / 4.0;
    }

    vec3 gridColor(vec2 uv) {
      float line = lineFactor(uv) * 0.1 + 0.9;
      return vec3(1.0, 0.972, 0.918) * line;
    }`)}function aRt(t,e){const r=e.blendMode;r!==$e.Normal&&(r===$e.Reflect&&t.code.add(w`float reflectBlend(in float cb, in float cl) {
return (cl == 1.0) ? cl : min(cb * cb / (1.0 - cl), 1.0);
}`),r!==$e.ColorDodge&&r!==$e.VividLight||t.code.add(w`float colorDodge(in float cb, in float cl) {
return (cb == 0.0) ? 0.0 : (cl == 1.0) ? 1.0 : min(1.0, cb / (1.0 - cl));
}`),r!==$e.ColorBurn&&r!==$e.VividLight||t.code.add(w`float colorBurn(in float cb, in float cl) {
return (cb == 1.0) ? 1.0 : (cl == 0.0) ? 0.0 : 1.0 - min(1.0, (1.0 - cb) / cl);
}`),r===$e.Overlay&&t.code.add(w`float overlay(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (1.0 - 2.0 * (1.0 - cl ) * (1.0 - cb)) + step(0.5, cl) * (2.0 * cl * cb);
}`),r===$e.HardLight&&t.code.add(w`float hardLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * (2.0 * cl * cb) + step(0.5, cl) * (1.0 - 2.0 * (1.0 - cl) * (1.0 - cb));
}`),r===$e.SoftLight&&t.code.add(w`float softLight(in float cb, in float cl) {
if (cl <= 0.5) {
return cb - (1.0 - 2.0 * cl) * cb * (1.0 - cb);
}
if (cb <= 0.25) {
return cb + (2.0 * cl - 1.0) * cb * ((16.0 * cb - 12.0) * cb + 3.0);
}
return cb + (2.0 * cl - 1.0) * (sqrt(cb) - cb);
}`),r===$e.VividLight&&t.code.add(w`float vividLight(in float cb, in float cl) {
return (1.0 - step(0.5, cl)) * colorBurn(cb, 2.0 * cl) + step(0.5, cl) * colorDodge(cb, (2.0 * (cl - 0.5)));
}`),r!==$e.Hue&&r!==$e.Saturation&&r!==$e.Color&&r!==$e.Luminosity||(t.code.add(w`float minv3(in vec3 c) {
return min(min(c.r, c.g), c.b);
}
float maxv3(in vec3 c) {
return max(max(c.r, c.g), c.b);
}
float lumv3(in vec3 c) {
return dot(c, vec3(0.3, 0.59, 0.11));
}
vec3 clipColor(vec3 color) {
float lum = lumv3(color);
float mincol = minv3(color);
float maxcol = maxv3(color);
if (mincol < 0.0) {
color = lum + ((color - lum) * lum) / (lum - mincol);
}
if (maxcol > 1.0) {
color = lum + ((color - lum) * (1.0 - lum)) / (maxcol - lum);
}
return color;
}
vec3 setLum(vec3 cbase, vec3 clum) {
return clipColor(cbase + vec3(lumv3(clum) - lumv3(cbase)));
}`),r!==$e.Hue&&r!==$e.Saturation||t.code.add(w`float satv3(vec3 c) {
return maxv3(c) - minv3(c);
}
vec3 setLumSat(vec3 cbase, vec3 csat, vec3 clum)
{
float minbase = minv3(cbase);
float sbase = satv3(cbase);
float ssat = satv3(csat);
return setLum(sbase > 0.0 ? (cbase - minbase) * ssat / sbase : vec3(0.0), clum);
}`)),t.code.add(w`
    vec4 applyBlendMode(vec3 cl, float ol, vec3 cb, float ob) {
      ${r===$e.Multiply?w`return vec4(cl * ol * cb * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Average?w`return vec4((cb + cl) * 0.5 * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Lighten?w`return vec4(max(cb, cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Darken?w`return vec4(min(cl, cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Lighter?w`return vec4(cl * ol + cb * ob, ol + ob);`:r===$e.Plus?w`return clamp(vec4(cl.rgb + cb.rgb, ol + ob), 0.0, 1.0);`:r===$e.Minus?w`return vec4(clamp(vec3(cb.rgb - cl.rgb), 0.0, 1.0), ob * ol);`:r===$e.Screen?w`return vec4((cl + cb - cl * cb) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Difference?w`return vec4(abs(cb - cl) * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Invert?w`return vec4((1.0 - cb) * ol * ob + cb * ob * (1.0 - ol), ob);`:r===$e.DestinationOver?w`return vec4(cl * ol * (1.0 - ob) + cb * ob, ol + ob - ol * ob);`:r===$e.DestinationAtop?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * ol, ol);`:r===$e.DestinationOut?w`return vec4(cb * ob * (1.0 - ol), ob * (1.0 - ol));`:r===$e.SourceAtop?w`return vec4(cl * ol * ob + cb * ob * (1.0 - ol), ob);`:r===$e.SourceOut?w`return vec4(cl * ol * (1.0 - ob), ol * (1.0 - ob));`:r===$e.Xor?w`return vec4(cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), ol * (1.0 - ob) + ob * (1.0 - ol));`:r===$e.DestinationIn?w`return vec4(cb * ob * ol, ol * ob);`:r===$e.SourceIn?w`return vec4(cl * ol * ob, ol * ob);`:r===$e.Hue?w`
          vec3 f = setLumSat(cl, cb, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Saturation?w`
          vec3 f = setLumSat(cb, cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Color?w`
          vec3 f = setLum(cl, cb);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Luminosity?w`
          vec3 f = setLum(cb, cl);
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Exclusion?w`
          vec3 f = cl + cb - 2.0 * cl * cb;
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Reflect?w`
          vec3 f = vec3(reflectBlend(cb.r, cl.r), reflectBlend(cb.g, cl.g), reflectBlend(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.ColorDodge?w`
          vec3 f = vec3(colorDodge(cb.r, cl.r), colorDodge(cb.g, cl.g), colorDodge(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.ColorBurn?w`
          vec3 f = vec3(colorBurn(cb.r, cl.r), colorBurn(cb.g, cl.g), colorBurn(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.Overlay?w`
          vec3 f = vec3(overlay(cb.r, cl.r), overlay(cb.g, cl.g), overlay(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.SoftLight?w`
          vec3 f = vec3(softLight(cb.r, cl.r), softLight(cb.g, cl.g), softLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.HardLight?w`
          vec3 f = vec3(hardLight(cb.r, cl.r), hardLight(cb.g, cl.g), hardLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:r===$e.VividLight?w`
          vec3 f = vec3(vividLight(cb.r, cl.r), vividLight(cb.g, cl.g), vividLight(cb.b, cl.b));
          return vec4(f * ol * ob + cl * ol * (1.0 - ob) + cb * ob * (1.0 - ol), mix(ob, 1.0, ol));`:w``}
    }
  `))}var to,yf,tf;(function(t){t[t.Composite=0]="Composite",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.GroupBackgroundComposite=3]="GroupBackgroundComposite",t[t.COUNT=4]="COUNT"})(to||(to={})),function(t){t[t.NotRequired=0]="NotRequired",t[t.Required=1]="Required",t[t.COUNT=2]="COUNT"}(yf||(yf={})),function(t){t[t.Off=0]="Off",t[t.On=1]="On",t[t.COUNT=2]="COUNT"}(tf||(tf={}));function gNe(t,e){const r=e.output===to.GridComposite,i=e.output===to.ColorComposite,s=e.output===to.GroupBackgroundComposite,n=e.output===to.Composite;r&&t.fragment.include(Fie),i&&t.fragment.uniforms.add(new jt("backgroundColor",c=>c.backgroundColor));const o=e.baseOpacityMode===yf.Required;o&&t.fragment.uniforms.add(new Ie("baseOpacity",c=>c.baseOpacity)),n&&t.fragment.uniforms.add(new et("fboColor",c=>c.fboTexture));const a=e.blendMode!==$e.Normal,l=e.premultipliedSource===tf.On;t.fragment.include(aRt,e),t.fragment.code.add(w`
    vec4 getBackground(vec2 uv) {
      return ${o?w`baseOpacity *`:""} ${s?w`vec4(0.0, 0.0, 0.0, 0.0)`:i?w`vec4(backgroundColor, 1.0)`:r?w`vec4(gridColor(uv), 1.0)`:w`texelFetch(fboColor, ivec2(gl_FragCoord.xy), 0)`};
    }

    vec4 blendLayers(vec4 bgColor, vec4 colorLayer, float opacity) {
      ${a?w`
          vec3 cl = colorLayer.a == 0.0 ? colorLayer.rgb : colorLayer.rgb / colorLayer.a;
          vec3 cb = bgColor.a == 0.0 ? bgColor.rgb : bgColor.rgb / bgColor.a;
          return applyBlendMode(clamp(cl, vec3(0.0), vec3(1.0)), colorLayer.a * opacity, cb, bgColor.a);`:w`
          float composeAlpha = colorLayer.a * opacity;
          return ${!l&&(n&&!o||s)?w`colorLayer * opacity;`:w`bgColor * (1.0 - composeAlpha) + colorLayer * opacity;`}`}
    }`)}let e9=class extends sRt{constructor(e,r,i,s,n,o){super(e,s,n),this.colormap=r,this.symbolizer=i,this.u_colormap=o,this.backgroundColor=Nl,this.fboTexture=null,this.baseOpacity=1}},lRt=class extends e9{},cRt=class extends e9{};function uRt(t){const e=new Cr;return e.include(mNe),e.include(nRt,t),e.include(rRt,t),e.include(gNe,t),e.fragment.code.add(w`vec4 applyBackgroundBlend(vec4 layerColor) {
vec4 bgColor = getBackground(vuv);
return blendLayers(bgColor, layerColor, u_opacity);
}`),t.colorizerType===mT.Stretch?dRt(e,t):t.colorizerType===mT.Lut?hRt(e):t.colorizerType===mT.Hillshade&&pRt(e,t),e}function hRt(t){t.fragment.code.add(w`void main() {
vec2 pixelLocation = getPixelLocation(uv);
if (isOutside(pixelLocation)) {
fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
return;
}
vec4 currentPixel = getPixel(pixelLocation);
fragColor = applyBackgroundBlend(colormap(currentPixel, true));
}`)}function dRt(t,e){t.fragment.uniforms.add(new z$("u_bandCount",i=>i.symbolizer.u_bandCount),new gc("u_minCutOff",i=>i.symbolizer.u_minCutOff,3),new gc("u_maxCutOff",i=>i.symbolizer.u_maxCutOff,3),new gc("u_factor",i=>i.symbolizer.u_factor,3),new Ie("u_minOutput",i=>i.symbolizer.u_minOutput),new Ie("u_maxOutput",i=>i.symbolizer.u_maxOutput),new lg("u_useGamma",i=>i.symbolizer.u_useGamma),new gc("u_gamma",i=>i.symbolizer.u_gamma,3),new gc("u_gammaCorrection",i=>i.symbolizer.u_gammaCorrection,3),new Ie("u_opacity",i=>i.common.u_opacity)),t.fragment.code.add(w`float stretchOneValue(float val, float minCutOff, float maxCutOff, float minOutput, float maxOutput, float factor, bool useGamma, float gamma, float gammaCorrection) {
if (val >= maxCutOff) {
return maxOutput;
} else if (val <= minCutOff) {
return minOutput;
}
float stretchedVal;
if (useGamma) {
float tempf = 1.0;
float outRange = maxOutput - minOutput;
float relativeVal = (val - minCutOff) / (maxCutOff - minCutOff);
if (gamma > 1.0) {
tempf -= pow(1.0 / outRange, relativeVal * gammaCorrection);
}
stretchedVal = (tempf * outRange * pow(relativeVal, 1.0 / gamma) + minOutput) / 255.0;
} else {
stretchedVal = minOutput + (val - minCutOff) * factor;
}
return stretchedVal;
}`);const r=e.applyColormap?w`fragColor = applyBackgroundBlend(colormap(vec4(grayVal, grayVal, grayVal, currentPixel.a), !u_useGamma));`:w`fragColor = applyBackgroundBlend(vec4(grayVal, grayVal, grayVal, currentPixel.a));`;t.fragment.code.add(w`
      void main() {
        vec2 pixelLocation = getPixelLocation(uv);
        if (isOutside(pixelLocation)) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }

        vec4 currentPixel = getPixel(pixelLocation);
        ${e.stretchType===QT.Noop?w`
        fragColor = applyBackgroundBlend(currentPixel);`:w`
        if (currentPixel.a == 0.0) {
          fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
          return;
        }
        if (u_bandCount == 1) {
          float grayVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          ${r}
        } else {
          float redVal = stretchOneValue(currentPixel.r, u_minCutOff[0], u_maxCutOff[0], u_minOutput, u_maxOutput, u_factor[0], u_useGamma, u_gamma[0], u_gammaCorrection[0]);
          float greenVal = stretchOneValue(currentPixel.g, u_minCutOff[1], u_maxCutOff[1], u_minOutput, u_maxOutput, u_factor[1], u_useGamma, u_gamma[1], u_gammaCorrection[1]);
          float blueVal = stretchOneValue(currentPixel.b, u_minCutOff[2], u_maxCutOff[2], u_minOutput, u_maxOutput, u_factor[2], u_useGamma, u_gamma[2], u_gammaCorrection[2]);
          fragColor = applyBackgroundBlend(vec4(redVal, greenVal, blueVal, currentPixel.a));
        }`}
      }`)}function pRt(t,e){const r=t.fragment;r.uniforms.add(new et("u_image",s=>s.u_image),new z$("u_hillshadeType",s=>s.symbolizer.u_hillshadeType),new gc("u_sinZcosAs",s=>s.symbolizer.u_sinZcosAs,6),new gc("u_sinZsinAs",s=>s.symbolizer.u_sinZsinAs,6),new gc("u_cosZs",s=>s.symbolizer.u_cosZs,6),new gc("u_weights",s=>s.symbolizer.u_weights,6),new Pr("u_factor",s=>s.symbolizer.u_factor),new Ie("u_minValue",s=>s.symbolizer.u_minValue),new Ie("u_maxValue",s=>s.symbolizer.u_maxValue),new Pr("u_srcImageSize",s=>s.common.u_srcImageSize)),r.include(kg),r.code.add(w`vec4 overlay(float val, float minValue, float maxValue, float hillshade, float alpha) {
val = clamp((val - minValue) / (maxValue - minValue), 0.0, 1.0);
vec4 color = colormap(vec4(val, val, val, 1.0), false);
vec3 hsv = rgb2hsv(color.rgb);
hsv.z = hillshade;
return vec4(hsv2rgb(hsv), 1.0) * alpha * color.a;
}`),r.code.add(w`float getNeighborHoodAlpha(float a, float b, float c, float d, float e, float f, float g, float h, float i){
if (a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0 || a == 0.0 || a == 0.0 || a==0.0) {
return 0.0;
}  else {
return e;
}
}`);const i=e.applyColormap?w`fragColor = applyBackgroundBlend(overlay(ve.r, u_minValue, u_maxValue, hillshade, alpha));`:w`hillshade *= alpha;
fragColor = applyBackgroundBlend(vec4(hillshade, hillshade, hillshade, alpha));`;r.code.add(w`
    void main() {
      vec2 pixelLocation = getPixelLocation(uv);
      if (isOutside(pixelLocation)) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      vec4 currentPixel = getPixel(pixelLocation);
      if (currentPixel.a == 0.0) {
        fragColor = applyBackgroundBlend(vec4(0.0, 0.0, 0.0, 0.0));
        return;
      }

      //mirror edge pixels
      vec2 axy = vec2(-1.0, -1.0);
      vec2 bxy = vec2(0.0, -1.0);
      vec2 cxy = vec2(1.0, -1.0);
      vec2 dxy = vec2(-1.0, 0.0);
      vec2 fxy = vec2(1.0, 0.0);
      vec2 gxy = vec2(-1.0, 1.0);
      vec2 hxy = vec2(0.0, 1.0);
      vec2 ixy = vec2(1.0, 1.0);
      vec2 onePixel = 1.0 / u_srcImageSize;
      if (pixelLocation.s < onePixel.s) {
        axy[0] = 1.0;
        dxy[0] = 1.0;
        gxy[0] = 1.0;
      }
      if (pixelLocation.t < onePixel.t) {
        axy[1] = 1.0;
        bxy[1] = 1.0;
        cxy[1] = 1.0;
      }
      if (pixelLocation.s > 1.0 - onePixel.s) {
        cxy[0] = -1.0;
        fxy[0] = -1.0;
        ixy[0] = -1.0;
      }
      if (pixelLocation.t > 1.0 - onePixel.t) {
        gxy[1] = -1.0;
        hxy[1] = -1.0;
        ixy[1] = -1.0;
      }

      // calculate hillshade
      vec4 va = texture(u_image, pixelLocation + onePixel * axy);
      vec4 vb = texture(u_image, pixelLocation + onePixel * bxy);
      vec4 vc = texture(u_image, pixelLocation + onePixel * cxy);
      vec4 vd = texture(u_image, pixelLocation + onePixel * dxy);
      vec4 ve = texture(u_image, pixelLocation);
      vec4 vf = texture(u_image, pixelLocation + onePixel * fxy);
      vec4 vg = texture(u_image, pixelLocation + onePixel * gxy);
      vec4 vh = texture(u_image, pixelLocation + onePixel * hxy);
      vec4 vi = texture(u_image, pixelLocation + onePixel * ixy);

      // calculate the rate of z change along the x, y, and diagonal direction
      float dzx = (vc + 2.0 * vf + vi - va - 2.0 * vd - vg).r * u_factor.s;
      float dzy = (vg + 2.0 * vh + vi - va - 2.0 * vb - vc).r * u_factor.t;
      float dzd = sqrt(1.0 + dzx * dzx + dzy * dzy);
      float hillshade = 0.0;

      // traditional single light source
      if (u_hillshadeType == 0){
        float cosDelta = u_sinZsinAs[0] * dzy - u_sinZcosAs[0] * dzx;
        float z = (u_cosZs[0] + cosDelta) / dzd;
        if (z < 0.0)  z = 0.0;
        hillshade = z;
      } else {
        // multi-directional with 6 light sources
        for (int k = 0; k < 6; k++) {
        float cosDelta = u_sinZsinAs[k] * dzy - u_sinZcosAs[k] * dzx;
        float z = (u_cosZs[k] + cosDelta) / dzd;
        if (z < 0.0) z = 0.0;
        hillshade = hillshade + z * u_weights[k];
        if (k == 5) break;
        }
      }

      // set color
      float alpha = getNeighborHoodAlpha(va.a, vb.a, vc.a, vd.a, ve.a, vf.a, vg.a, vh.a, vi.a);
      alpha *= u_opacity;
      ${i}
    }
  `)}const fRt=Object.freeze(Object.defineProperty({__proto__:null,ColorizerHillshadeUniforms:cRt,ColorizerStretchUniforms:lRt,ColorizerUniforms:e9,build:uRt},Symbol.toStringTag,{value:"Module"}));function mRt(t,e,r="nearest",i=!1){const s=!(i&&e.pixelType==="u8"),n=s?fn.FLOAT:fn.UNSIGNED_BYTE,o=e.pixels==null||e.pixels.length===0?null:s?e.getAsRGBAFloat():e.getAsRGBA(),a=t.capabilities.textureFloat?.textureFloatLinear,l=new Sr;return l.width=e.width,l.height=e.height,l.internalFormat=t.type===pr.WEBGL2&&s?Je.RGBA32F:At.RGBA,l.samplingMode=!a||r!=="bilinear"&&r!=="cubic"?Mt.NEAREST:Mt.LINEAR,l.dataType=n,l.wrapMode=Ut.CLAMP_TO_EDGE,new Rt(t,l,o)}function gRt(t,e){const{spacing:r,offsets:i,coefficients:s,size:[n,o]}=e,a=r[0]>1,l=new Sr;l.width=a?4*n:n,l.height=o,l.internalFormat=t.type===pr.WEBGL2?Je.RGBA32F:At.RGBA,l.dataType=fn.FLOAT,l.samplingMode=Mt.NEAREST,l.wrapMode=Ut.CLAMP_TO_EDGE;const c=new Float32Array(a?n*o*16:2*i.length);if(a&&s!=null)for(let h=0,p=0;h<s.length;h++)c[p++]=s[h],h%3==2&&(c[p++]=1);else for(let h=0;h<o;h++)for(let p=0;p<n;p++){const f=4*(h*n+p),m=2*(p*o+h);c[f]=i[m],c[f+1]=i[m+1],c[f+3]=i[m]===-1?0:1}return new Rt(t,l,c)}function Hme(t,e){const r=new Sr;return r.internalFormat=At.RGBA,r.width=e.length/4,r.height=1,r.samplingMode=Mt.NEAREST,r.wrapMode=Ut.CLAMP_TO_EDGE,new Rt(t,r,e)}function yRt(t,e,r,i=1,s=!0){return{u_flipY:s,u_applyTransform:!!t,u_opacity:i,u_transformSpacing:t?t.spacing:Df,u_transformGridSize:t?t.size:Df,u_targetImageSize:e,u_srcImageSize:r}}function _Rt(t,e){return{u_colormapOffset:e||0,u_colormapMaxIndex:t?t.length/4-1:0}}function vRt(t){return{u_bandCount:t.bandCount,u_minOutput:t.outMin,u_maxOutput:t.outMax,u_minCutOff:t.minCutOff,u_maxCutOff:t.maxCutOff,u_factor:t.factor,u_useGamma:t.useGamma,u_gamma:t.gamma,u_gammaCorrection:t.gammaCorrection}}function bRt(t){return{u_hillshadeType:t.hillshadeType,u_sinZcosAs:t.sinZcosAs,u_sinZsinAs:t.sinZsinAs,u_cosZs:t.cosZs,u_weights:t.weights,u_factor:t.factor,u_minValue:t.minValue,u_maxValue:t.maxValue}}const qme={bandCount:3,outMin:0,outMax:1,minCutOff:[0,0,0],maxCutOff:[255,255,255],factor:[1/255,1/255,1/255],useGamma:!1,gamma:[1,1,1],gammaCorrection:[1,1,1],colormap:null,colormapOffset:null,stretchType:"none",type:"stretch"};let wRt=class{constructor(e,r,i=null,s=null){this.type="raster-tile",this._memoryUsed=null,this._source=null,this._symbolizerParameters=null,this._bandIds=null,this._interpolation=null,this._dirty=!1,this._transformGrid=null,this.isRendereredSource=!1,this.symbolizerRenderer=null,this.rawPixelData=null,this.lij=null,this.opacity=1,this.lij=e,this.source=r,this.width=i||r.width,this.height=s||r.height}get source(){return this._source}set source(e){this._source=e,this._rasterTexture=ze(this._rasterTexture),this._memoryUsed=null}get symbolizerParameters(){return this.isRendereredSource?{...qme,maxCutOff:[1,1,1],factor:[1,1,1]}:this._symbolizerParameters||qme}set symbolizerParameters(e){this._symbolizerParameters=e}get bandIds(){return this._bandIds}set bandIds(e){e!=null&&e.length>0?this._bandIds&&e.every((r,i)=>!!this._bandIds?.[i]&&r===this._bandIds[i])||(this._bandIds=e,this._dirty=!0):this._bandIds=null}get interpolation(){return this._interpolation||"nearest"}set interpolation(e){if(this._interpolation=e,this._rasterTexture!=null){const r=this._getRasterTextureInterpolation(e);this._rasterTexture.setSamplingMode(r==="bilinear"?Mt.LINEAR:Mt.NEAREST)}}get transformGrid(){return this._transformGrid}set transformGrid(e){this._transformGrid=e,this._transformGridTexture=ze(this._transformGridTexture),this._memoryUsed=null}bind(e){return!!(this.source&&this.source.pixels&&this.source.pixels.length>0)&&((this._rasterTexture==null||this._dirty)&&this._updateRasterTexture(e,this.bandIds),this._rasterTexture!=null&&(this._updateColormapTexture(e),this.transformGrid&&this._transformGridTexture==null&&(this._transformGridTexture=gRt(e,this.transformGrid))),!0)}getUniforms(){const{symbolizerParameters:e,transformGrid:r,width:i,height:s,opacity:n}=this,o=yRt(r,[i,s],[this.source.width,this.source.height],n),a=_Rt(e.colormap,e.colormapOffset),l=this.symbolizerParameters.type==="stretch"?vRt(this.symbolizerParameters):null,c=this.symbolizerParameters.type==="hillshade"?bRt(this.symbolizerParameters):null;return new e9(o,a,l||c,this._rasterTexture,this._transformGridTexture,this._colormapTexture)}get isBilinearWithStretchColorRamp(){const{symbolizerParameters:e}=this;return this.interpolation==="bilinear"&&e.colormap!=null&&e.type==="stretch"}get memoryUsage(){if(this._memoryUsed==null){const e=[this._rasterTexture,this._transformGridTexture,this._colormapTexture];this._memoryUsed=e.map(r=>r!=null?r.descriptor.width*r.descriptor.height*4:0).reduce((r,i)=>r+i,0)}return this._memoryUsed}release(){return this._rasterTexture=ze(this._rasterTexture),this._transformGridTexture=ze(this._transformGridTexture),this._colormapTexture=ze(this._colormapTexture),this.source=null,this.transformGrid=null,this.rawPixelData=null,!0}_updateRasterTexture(e,r){const i=this.source?this.source.extractBands(r):null;if(!(i&&i.pixels&&i.pixels.length>0))return void(this._rasterTexture=ze(this._rasterTexture));const s=r==null&&this.bandIds==null||r!=null&&this.bandIds!=null&&r.join("")===this.bandIds.join("");if(this._rasterTexture!=null&&s)return;this._rasterTexture=ze(this._rasterTexture);const n=this._getRasterTextureInterpolation(this.interpolation);this._rasterTexture=mRt(e,i,n,this.isRendereredSource||this.hasStretchTypeNone())}hasStretchTypeNone(){return"stretchType"in this.symbolizerParameters&&this.symbolizerParameters.stretchType==="none"&&!this.symbolizerParameters.useGamma&&this.source.pixelType==="u8"}_getRasterTextureInterpolation(e){return this.symbolizerParameters.type==="lut"||e==="nearest"||e==="majority"||this.isBilinearWithStretchColorRamp?"nearest":"bilinear"}_updateColormapTexture(e){const r=this._colormap,i=this.symbolizerParameters.colormap;return i?r?i.length!==r.length||i.some((s,n)=>s!==r[n])?(this._colormapTexture=ze(this._colormapTexture),this._colormapTexture=Hme(e,i),void(this._colormap=i)):void 0:(this._colormapTexture=Hme(e,i),void(this._colormap=i)):(this._colormapTexture=ze(this._colormapTexture),void(this._colormap=null))}},_5=class{constructor(){this.waitingAgents=new qt,this._upsampleInfo=null,this.loadingAgent=null,this.requestPromise=null,this.requestAbort=null,this.pendingUpdates=0}static acquire(e){const r=XG.acquire();return r._init(e),r}release(){this.dispose(),v5.delete(this),XG.release(this)}dispose(){this.loadingAgent=ze(this.loadingAgent),this.abortRequest(),this._unsetUpsampleInfo(),this.pendingUpdates=0,this._data=qC(this._data)}static prune(){XG.prune(0)}_init(e){this.waitingAgents.clear(),this._data=qC(this._data),this.dataMissing=!1,this.dataInvalidated=!1,this._unsetUpsampleInfo(),this.abortRequest(),this.loadingAgent=null,this.pendingUpdates=0,this._pool=e,this.elevationBounds=null}invalidateSourceData(){this.dataInvalidated=!0,this.dataMissing=!1,this._unsetUpsampleInfo()}abortRequest(){this.requestAbort=Do(this.requestAbort),this.requestPromise=null}get upsampleInfo(){return this._upsampleInfo}_unsetUpsampleInfo(){this._upsampleInfo!=null&&(this._upsampleInfo.tile.unrefMapData(),this._pool.release(this._upsampleInfo),this._upsampleInfo=null)}setUpsampleInfo(e,r){if(e!==r&&r!=null){if(this._upsampleInfo==null)this._upsampleInfo=this._pool.acquire();else{if(this._upsampleInfo.tile===r)return;this._upsampleInfo.tile.unrefMapData()}r.refMapData(),KOt(e,r,this._upsampleInfo)}else this._unsetUpsampleInfo()}get data(){return this._data}set data(e){qC(this._data),this._data=e}};const XG=new $o(_5,null,()=>{}),v5=new Map;function xRt(){v5.size>0&&(console.log(`${v5.size} live TilePerLayerInfo allocations:`),v5.forEach(t=>console.log(t,`
`)))}let LE=class{constructor(e){this._texture=e,this.type="tile-texture",this._refCount=1}retain(){++this._refCount}release(){--this._refCount,this._refCount===0&&this._texture.dispose()}get texture(){return this._texture}generateMipmap(){this._texture.generateMipmap()}get descriptor(){return this._texture.descriptor}get gpuMemoryUsage(){return this._texture.gpuMemoryUsage}};var vt;(function(t){t[t.NONE=0]="NONE",t[t.SPLIT=1]="SPLIT",t[t.ELEVATION=2]="ELEVATION",t[t.MERGE=4]="MERGE",t[t.RENDERDATA=8]="RENDERDATA",t[t.GEOMETRY=16]="GEOMETRY",t[t.TEXTURE_NOFADING=32]="TEXTURE_NOFADING",t[t.TEXTURE_FADING=64]="TEXTURE_FADING"})(vt||(vt={}));const TRt=.1;let kie=class{constructor(){this.lij=[0,0,0],this._children=[null,null,null,null],this._pendingUpdates=0,this.renderData=null,this._dirty=!0,this._previouslyRendered=!1,this.extent=Ht(),this._elevationBounds=Pe(),this.layerInfo=[[],[]],this.extentInRadians=Ht(),this.centerAtSeaLevel=C(),this._center=[C(),js(),C()],this.up=OQ(),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._maxTesselation=0,this._usedMemory=null,this._mapTileMemoryInternal=0,this._mapDataRefCount=0,this.screenDepth=0,this.renderOrder=0,this._edgeLen=0,this._edgeLen2=0,this._curvatureHeight=0,this.extentMidX=0,this.extentMidY=0,this.distanceToPOI=-1,this._lastPOI=C()}static prune(){Uie.prune(0),Vie.prune(0),_5.prune()}get _isCached(){return!this.shouldLoad&&this._mapDataRefCount<=0}get maxTesselation(){return this._maxTesselation}get isWithinClippingArea(){return this._isWithinClippingArea}get intersectsClippingArea(){return this._intersectsClippingArea}get clippingArea(){return this._clippingArea}get parent(){return this._parent}get children(){return this._children}get surface(){return this._surface}get elevationBounds(){return this._elevationBounds}get level(){return this.lij[0]}get key(){return`${this.lij[0]}/${this.lij[1]}/${this.lij[2]}`}get edgeLen(){return this._edgeLen}get radius(){return this._center[hn.MIDDLE][3]}get visible(){return this._dirty&&this.computeVisibility(),this._visible}get frustumVisibility(){return this._dirty&&this.computeVisibility(),this._frustumVisibility}computeVisibility(){this._dirty=!1;const e=this.parent,r=e?.frustumVisibility??qa.INTERSECTS;this._frustumVisibility=r===qa.INSIDE?qa.INSIDE:r===qa.OUTSIDE?qa.OUTSIDE:this._calculateFrustumVisibilityStatus(this.surface.frustum);const i=this._frustumVisibility!==qa.OUTSIDE&&this._intersectsClippingArea;i!==this._visible&&(this._visible=i,this._surface.emit("tiles-visibility-changed"),this._surface.renderer.setDirty(),this.updateAgentSuspension())}get loadable(){return this.visible||this._surface.view.state.fixedContentCamera}get rendered(){const e=!!this.renderData;return e!==this._previouslyRendered&&(this._surface.emit("tiles-visibility-changed"),this._previouslyRendered=e,this._surface.renderer.setDirty()),e}get shouldLoad(){return this.isLeaf}init(e,r,i){this.lij[0]=e[0],this.lij[1]=e[1],this.lij[2]=e[2],this.ellipsoid=Ir(i.tilingScheme.spatialReference),i.tilingScheme.getExtent(e[0],e[1],e[2],this.extent),i.tilingScheme.convertExtentToRadians(this.extent,this.extentInRadians),this.extentMidX=.5*(this.extent[0]+this.extent[2]),this.extentMidY=.5*(this.extent[1]+this.extent[3]),this._isWithinClippingArea=!0,this._intersectsClippingArea=!0,this._clippingArea=null,this._mapDataRefCount=0,i.upsampleMapCache.pop(this.key),this._edgeLen=0,this._edgeLen2=0,this._center[hn.MIDDLE][3]=0,this.elevationLevel=e?e[0]:0,r&&r.elevationBounds?jn(this._elevationBounds,r.elevationBounds):hr(this._elevationBounds,0,0),this._pendingUpdates=0,this.renderData=null,this.screenDepth=0,this._visible=!1,this._previouslyRendered=!1,this._parent=r,this.unsetChildren(),this._surface=i,this.updateVisibility();for(const s of px){const n=i.numLayers(s),o=this.layerInfo[s];for(const a of o)a.release();o.length=n;for(let a=0;a<n;a++)o[a]=_5.acquire(this._surface.upsampleInfoPool),s===nr.ELEVATION&&this.findElevationBoundsForLayer(a,-1)}this.computeElevationBounds(),this._maxTesselation=Math.min(i.tilingScheme.pixelSize,Y3)}release(){jm(!this.renderData,"tile.renderData was not unloaded"),this._surface.upsampleMapCache.pop(this.key);for(const e of px){for(const r of this.layerInfo[e])r.release();this.layerInfo[e].length=0}this._parent=null;for(let e=0;e<4;++e)this._children[e]=null;this._surface=null,this.setMemoryDirty()}refMapData(){++this._mapDataRefCount,this._isCached||this._surface.upsampleMapCache.pop(this.key)}unrefMapData(){if(--this._mapDataRefCount,this._isCached){this.setMemoryDirty();const e=this._cachedMemory;e>0&&this._surface.upsampleMapCache.put(this.key,this,e)}}setMemoryDirty(){this._usedMemory=null}get usedMemory(){return this._ensureUsedMemory()+(this._isCached?0:this._mapTileMemoryInternal)}get _cachedMemory(){return this._isCached?this._mapTileMemory:0}get _mapTileMemory(){return this._ensureUsedMemory(),this.layerInfo[nr.MAP].reduce((e,r)=>e+(r instanceof ZG?r.memoryUsed/r.referenced:0),this._mapTileMemoryInternal)}get _cpuImageMemorySize(){const r=this._surface.tilingScheme.pixelSize;return r*r*4}_ensureUsedMemory(){if(this._usedMemory!=null)return this._usedMemory;this._usedMemory=0,this._mapTileMemoryInternal=0;let e=0;for(const{data:i}of this.layerInfo[nr.MAP])i instanceof ZG?e+=this._getTerrainDataMemory(i):this._mapTileMemoryInternal+=this._getTerrainDataMemory(i);const r=this._cpuImageMemorySize;for(const i of this.layerInfo[nr.ELEVATION])this._usedMemory+=i.data?r:0;return this.renderData&&(this._usedMemory+=this.renderData.estimatedGeometryMemoryUsage,this._mapTileMemoryInternal+=this.renderData.texture?.gpuMemoryUsage??0),this._isCached&&this._surface.upsampleMapCache.updateSize(this.key,this,this._mapTileMemoryInternal+e),this._usedMemory}getUsedMemoryForLayer(e,r){const i=this.layerInfo[e][r];return i?.data?e===nr.MAP?this._isCached?0:this._getTerrainDataMemory(i.data):e===nr.ELEVATION?this._cpuImageMemorySize:0:0}_getTerrainDataMemory(e){return e instanceof LE?e.texture.gpuMemoryUsage:e instanceof HTMLImageElement||e instanceof Y8?this._cpuImageMemorySize:e instanceof wRt?e.memoryUsage:e instanceof ZG?e.memoryUsed/e.referenced:0}updateScreenDepth(e){const r=this._center[hn.MIDDLE],i=e,s=r[0],n=r[1],o=r[2],a=i[2]*s+i[6]*n+i[10]*o+i[14];this.screenDepth=a<0?0:a/(i[3]*s+i[7]*n+i[11]*o+i[15])}shouldSplit(e,r,i){if(!this.visible||e.frustum!=null&&(!this._intersectsClippingArea||this._calculateFrustumVisibilityStatus(e.frustum)===qa.OUTSIDE))return vt.NONE;const s=this.level;pe(KN,this._center[hn.MIDDLE],r);let n=Xa(KN),o=KN,a=hn.MIDDLE;pe(YG,this._center[hn.TOP],r);const l=Xa(YG);l<n&&(n=l,o=YG,a=hn.TOP),pe(JG,this._center[hn.BOTTOM],r);const c=Xa(JG);if(c<n&&(n=c,o=JG,a=hn.BOTTOM),this._edgeLen2>n&&s<e.maxLod)return vt.SPLIT;const h=i!=null?i-s:1/0,p=Math.sqrt(n),f=e.fovX*p*2,m=this._edgeLen/f,g=()=>{if(s<e.maxLod)return this.elevationLevel=s,vt.NONE;const M=s+Math.ceil(-Math.log2(e.relativeWidthLimit/m));return M!==this.elevationLevel?(this.elevationLevel=M,vt.ELEVATION):vt.NONE};if(h<=.5)return g();const _=de(this.up,KN),v=this._elevationBounds[1]-this._elevationBounds[0],b=v/this.edgeLen;if(e.aboveGround&&_>0&&b<.001&&_/p-Math.sin(this._curvatureHeight/(this.edgeLen*Math.SQRT1_2)*Math.PI)-b>0)return vt.NONE;const x=i!=null?3-Math.min(h,2):1;if(m*x<e.relativeWidthLimit||s>=e.maxLod)return g();if(s<7)return vt.SPLIT;ae(jo,this.up,_),pe(jo,jo,o);const T=Xa(jo);if(T<=this.radius*this.radius)return vt.SPLIT;ae(jo,jo,this.radius/Math.sqrt(T)),ue(jo,jo,this._center[a]),pe(jo,r,jo);const S=Math.min(1,(Math.abs(de(jo,this.up))+.5*v+this._curvatureHeight)/Oe(jo)),O=TRt/e.angledSplitBias,A=e.fovY*p*2;return S*(this._edgeLen/A*x)<O*e.relativeHeightLimit?vt.NONE:vt.SPLIT}setChildren(e,r,i,s){jm(!!(e&&r&&i&&s),"Null child passed"),this._children[0]=e,this._children[1]=r,this._children[2]=i,this._children[3]=s}unsetChildren(){this._children[0]=null,this._children[1]=null,this._children[2]=null,this._children[3]=null}get isLoaded(){return this.renderData?.hasGeometry??!1}load(){this.refMapData();for(const e of px)this._createOrUpdateAgents(0,e);this.surface.renderer.loadTile(this)}unload(e){e.unloadTile(this);for(const r of px){const i=this.layerInfo[r];for(const s of i)s.loadingAgent&&s.loadingAgent!==Uc&&(QN(s.loadingAgent),s.loadingAgent=null),s.pendingUpdates=0}this.resetPendingUpdate(vt.GEOMETRY),this.resetPendingUpdate(vt.TEXTURE_NOFADING),this.resetPendingUpdate(vt.TEXTURE_FADING),this.unrefMapData()}unloadMapData(){const e=this.layerInfo[nr.MAP];for(const r of e)r.loadingAgent&&r.loadingAgent!==Uc&&(QN(r.loadingAgent),r.loadingAgent=null),r.pendingUpdates=0;this.renderData&&this.renderData.releaseTexture(),this.setMemoryDirty()}updateClippingStatus(e){if(Kx(e,this._clippingArea))return!1;const r=this._intersectsClippingArea,i=this._isWithinClippingArea;e!=null?(this._intersectsClippingArea=this.intersectsExtent(e),this._isWithinClippingArea=this._isWithinExtent(e)):(this._intersectsClippingArea=!0,this._isWithinClippingArea=!0),this._clippingArea=e,this.updateVisibility();const s=i&&this._isWithinClippingArea,n=!(i||r||this._isWithinClippingArea||this._intersectsClippingArea);return!this.renderData||s||n||this.setPendingUpdate(vt.GEOMETRY),!0}updateVisibility(){this._dirty=!0,this._surface.setTileTreeDirty()}getLayerInfo(e,r){return this.layerInfo[r][e]}hasLayerData(e,r){const i=this.layerInfo[r][e];return!(!i||!i.data||i.dataInvalidated)}get updating(){if(this.hasPendingUpdates)return!0;for(const e of px){const r=this.layerInfo[e];for(const i of r)if(i.loadingAgent&&i.loadingAgent!==Uc&&i.loadingAgent.updating)return!0}return!1}_isSuspended(e){return!!this.hasPendingUpdate(vt.SPLIT)||e!==nr.ELEVATION&&!this.loadable}get hasPendingUpdates(){return this._pendingUpdates!==0}hasPendingUpdate(e){return(this._pendingUpdates&e)===e}setPendingUpdate(e){this._pendingUpdates|=e,e===vt.SPLIT||e===vt.MERGE?this._surface.setTileTreeDirty():this._surface.requestUpdate()}resetPendingUpdate(e){return!!this.hasPendingUpdate(e)&&(this._pendingUpdates&=~e,!0)}requestLayerData(e,r,i){const s=this.layerInfo[r][e];if(s.waitingAgents.has(i))return console.warn("agent already requested this piece of map data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e),!0;if(s.waitingAgents.push(i),s.data&&!s.dataInvalidated){console.warn("agent requested existing data (tile %s, agent tile %s, layer: %d/%d)",this.lij.toString(),i.tile.lij.toString(),r,e);const a=s.data&&"type"in s.data&&s.data.type==="vector-tile";return i.dataArrived(this,a),!0}if(s.requestPromise)return!0;Do(s.requestAbort),s.requestAbort=new AbortController;const n=this._surface.requestTileData(this,e,r,s.requestAbort);if(!n)return s.requestAbort=null,!1;const o=()=>{s.requestPromise===n&&(s.requestPromise=null,s.requestAbort=null)};return s.requestPromise=n,n.then(o,o),!0}get isLeaf(){return this._children[0]==null}hasLij(e){return this.lij[0]===e[0]&&this.lij[1]===e[1]&&this.lij[2]===e[2]}findByLij(e){if(this.hasLij(e))return this;const r=this._children;return r[0]?r[0].findByLij(e)||r[1].findByLij(e)||r[2].findByLij(e)||r[3].findByLij(e):null}distanceToSquared(e){return Xa(pe(jo,this._center[hn.MIDDLE],e))}containsPoint(e){const r=this.extent;return e[0]>=r[0]&&e[1]>=r[1]&&e[0]<=r[2]&&e[1]<=r[3]}containsPointXY(e,r){const i=this.extent;return e>=i[0]&&r>=i[1]&&e<=i[2]&&r<=i[3]}unrequestLayerData(e,r,i){const s=this.layerInfo[r][e],n=s.waitingAgents,o=n.removeUnordered(i)!=null;jm(o,"agent has not requested this piece of map data"),n.length<1&&(s.abortRequest(),this.setMemoryDirty())}dataArrived(e,r,i){const s=i!=null&&"type"in i&&i.type==="vector-tile",n=this.layerInfo[r][e];n.data=i,n.dataInvalidated=!1,n.waitingAgents.forAll(o=>o.dataArrived(this,s)),n.waitingAgents.clear(),this.setMemoryDirty()}dataMissing(e,r,i){i.notInTilemap||console.error(`Tile ${this.lij.toString()} layer ${r}/${e} error ${i}`);const s=this.layerInfo[r][e];s.dataMissing=!0,s.waitingAgents.forAll(n=>n.dataMissing()),s.waitingAgents.clear(),this.setMemoryDirty()}updateRenderData(e,r,i){switch(i&&this.forEachLoadedNeighbor(s=>s.updateRenderData(e,r)),e){case nr.MAP:return this._updateTexture(r);case nr.ELEVATION:return this._updateGeometry()}}_updateTexture(e){this.renderData&&(this.resetPendingUpdate(e===$n.FADING?vt.TEXTURE_NOFADING:vt.TEXTURE_FADING),this.setPendingUpdate(e===$n.FADING?vt.TEXTURE_FADING:vt.TEXTURE_NOFADING))}_updateGeometry(){this.setPendingUpdate(vt.GEOMETRY);for(const e of this.layerInfo[nr.ELEVATION])e.pendingUpdates|=vt.GEOMETRY}invalidateLayerData(e,r){this.layerInfo[r][e].invalidateSourceData(),this.restartAgents(r)}computeElevationBounds(){const e=this._elevationBounds,r=e[0],i=e[1];hr(e,1/0,-1/0);const s=this.layerInfo[nr.ELEVATION];let n=!0;for(const o of s)o.elevationBounds!=null&&(e[0]=Math.min(e[0],o.elevationBounds.min),e[1]=Math.max(e[1],o.elevationBounds.max),o.elevationBounds.hasNoDataValues||(n=!1));n&&(e[0]=Math.min(e[0],0),e[1]=Math.max(e[1],0)),r===e[0]&&i===e[1]||(this.updateRadiusAndCenter(),this._surface.setTileTreeDirty())}_updateCenter(){const e=this._elevationBounds,r=.5*(e[0]+e[1]),i=this._center;ae(jo,this.up,r),ue(i[hn.MIDDLE],this.centerAtSeaLevel,jo),ae(jo,this.up,e[0]),ue(i[hn.TOP],this.centerAtSeaLevel,jo),ae(jo,this.up,e[1]),ue(i[hn.BOTTOM],this.centerAtSeaLevel,jo)}findElevationBoundsForLayer(e,r){const i=this.layerInfo[nr.ELEVATION][e],s=zZ(this.level),n=Math.max(this.elevationLevel-s,0),o=i.elevationBounds;if(o!=null&&o.level>=r&&o.level<=n)return;const a=this._surface.layerViewByIndex(e,nr.ELEVATION),l=YY(a);if(!CI(this,l,!1))return;const c=ERt;let h=!1;const p=i.data;if(p&&p.level<=n){const f=i.data;c.min=f.samplerData.data.minValue,c.max=f.samplerData.data.maxValue,c.hasNoDataValues=f.samplerData.data.hasNoDataValues,c.level=this.level,h=!0}else{let f,m,g=0;for(let _=this._parent;_&&(!m||g<s)&&(g=this.elevationLevel-_.level,f=m||f,m=_.layerInfo[nr.ELEVATION][e].data,!(!m&&f&&_.level<=n));_=_.parent);m=m||f,m&&(m.computeMinMaxValue(this.lij[0],this.lij[1],this.lij[2],c),c.min!==1/0&&(c.level=m.level,h=!0))}h&&(i.elevationBounds==null&&(i.elevationBounds=new pC),i.elevationBounds.copyFrom(c))}modifyLayers(e,r,i){const s=this.layerInfo[i];for(const a of s)a.loadingAgent&&a.loadingAgent!==Uc&&(QN(a.loadingAgent),a.loadingAgent=null),a.waitingAgents.clear();for(let a=0;a<s.length;++a)e[a]===void 0&&s[a].release();const n=new Array(...s),o=r.length;s.length=o;for(let a=0;a<o;a++){const l=r[a];s[a]=l>-1?n[l]:_5.acquire(this._surface.upsampleInfoPool)}this.setMemoryDirty()}restartAgents(e){this.renderData&&(this._createOrUpdateAgents(0,e),this.updateRenderData(e,$n.FADING))}updateAgents(e){if(this.renderData){const r=this.layerInfo[e];for(const i of r)i.loadingAgent===Uc&&(i.loadingAgent=null);this._createOrUpdateAgents(0,e)}}updateAgentSuspension(){for(const e of px){const r=this._isSuspended(e);for(const i of this.layerInfo[e])i.loadingAgent&&i.loadingAgent!==Uc&&(i.loadingAgent.setSuspension(r),i.loadingAgent===Uc&&this.updateRenderData(e,$n.FADING))}}removeLayerAgent(e,r){const i=this.layerInfo[r][e];i.loadingAgent&&i.loadingAgent!==Uc&&i.loadingAgent.dispose(),i.loadingAgent=null}agentDone(e,r){const i=this.layerInfo[r][e];i.loadingAgent=Uc,i.data||i.upsampleInfo!=null||this._createOrUpdateAgents(e+1,r)}_hasBlendableAncestor(e){return e.blendMode!=="normal"||cA(e.parent)&&this._hasBlendableAncestor(e.parent)}_hasBlendModes(e,r,i){for(let s=e;s<r;++s){const n=this._surface.layerViewByIndex(s,i);if(o6(n)&&n?.layer?.blendMode!=="normal"||cA(n?.layer?.parent)&&this._hasBlendableAncestor(n?.layer?.parent))return!0}return!1}_createOrUpdateAgents(e,r){const i=this.layerInfo[r];if(i.length===0)return;const s=this._isSuspended(r);for(let n=e;n<i.length;++n){const o=i[n];let a=!1;const l=this._surface.layerViewByIndex(n,r),c=YY(l);if(o.loadingAgent?CI(this,c,!1)?(o.loadingAgent!==Uc&&o.loadingAgent.setSuspension(s),o.loadingAgent!==Uc&&(a=o.loadingAgent.update())):o.dispose():CI(this,c,!1)&&(o.loadingAgent=SRt(this,n,r,s),a=o.loadingAgent.startLoading(),a?o.loadingAgent===Uc&&this.setPendingUpdate(vt.GEOMETRY):(QN(o.loadingAgent),o.loadingAgent=Uc)),o.loadingAgent===Uc&&this.updateRenderData(r,$n.FADING),!this._hasBlendModes(e,i.length,r)&&a&&l.isOpaque)return}}_isWithinExtent(e){const r=this.extent;return r[0]>=e[0]&&e[2]>=r[2]&&r[1]>=e[1]&&e[3]>=r[3]}intersectsExtent(e){const r=this.extent;return r[2]>=e[0]&&e[2]>=r[0]&&r[3]>=e[1]&&e[3]>=r[1]}getElevationVerticesPerSide(e){const r=this.elevationLevel-this.level,i=Math.max(this.level-e,zZ(this.level)-r),s=ye(1+(this.maxTesselation>>i),2,this.maxTesselation+1),n=this.getDefaultVerticesPerSide();return Math.max(s,n)}get test(){return{cachedMemory:this._cachedMemory}}_findLIJ(e,r){if(!e)return null;const i=this.surface.rootTiles;if(i!=null){for(const s of i)if(CRt(s,e)){let n=s,o=e[0]-n.level-1;for(;o>=0&&!n.isLeaf&&!r(n);){const a=e[1]>>o&1,l=e[2]>>o&1;n=n.children[2*a+l],o--}return r(n)?n:null}}return null}findNeighborTile(e,r){const i=this.lij,s=this.getNeighborLIJ(i,e);return s?ARt(i,s)?r(this)?this:null:this._findLIJ(s,r):null}findCorner(e,r){const i=e===ct.NORTH_EAST?1:e===ct.NORTH_WEST?0:e===ct.SOUTH_WEST?2:3;let s=this;for(;s.children[0]&&(!r||!r(s));)s=s.children[i];return s}findNeighborCornerTileExact(e,r){return this.findNeighborTile(e,i=>r(i)||i.level===this.level)?.findCorner(a6(e),r)||null}forAllSubtreeOnSide(e,r){const i=e===ct.NORTH?[0,1]:e===ct.NORTH_EAST?[1]:e===ct.EAST?[1,3]:e===ct.SOUTH_EAST?[3]:e===ct.SOUTH?[2,3]:e===ct.SOUTH_WEST?[2]:e===ct.WEST?[0,2]:[0],s=n=>{const o=n.children;!r(n)&&o[0]&&i.forEach(a=>s(o[a]))};s(this)}forallNeighbors(e){PP.forEach(r=>this.findNeighborCornerTileExact(r,e)),eg.forEach(r=>this.findNeighborTile(r,i=>i.level===this.level||e(i))?.forAllSubtreeOnSide(l6(r),e))}getNeighborEdgeStartVertexIndex(e,r){if(!r)return 0;const i=this.level-r.level;if(Se(!Nn||i>=0),i===0)return 0;const s=2**i,n=(1&e)==1,o=n?0:1,a=r.lij[o+1]*s,l=this.lij[o+1],c=l-a,h=n?s-1-c:c;return Nn&&(Se(a<=l&&l<a+s),Se(0<=h&&h<s)),h}forEachLoadedNeighbor(e){const r=this.level,i=s=>s.level===r||s.isLoaded;eg.forEach(s=>{const n=this.findNeighborTile(s,i);n!=null&&n!==this&&n.forAllSubtreeOnSide(l6(s),o=>!!o.isLoaded&&(e(o,s),!0))}),PP.forEach(s=>{const n=this.findNeighborTile(s,i)?.findCorner(a6(s),o=>o.isLoaded);Se(!n||sJ(this,n,s)),n?.isLoaded&&e(n,s)})}getNeighborLIJ(e,r){const i=Lme(r)?-1:$me(r)?1:0,s=Ime(r)?-1:Pme(r)?1:0,n=[e[0],e[1]+i,e[2]+s];return n[1]<0?null:this.surface.isGlobal?this.wrapLIJ(n):n[2]<0?null:n}wrapLIJ(e){return!e||e[1]<0||e[1]>=2**e[0]?null:this.surface.wrapEastWest(e)}get westNeighborWestExtent(){return this.extent[0]*(this.isWestEnd?-1:1)}get eastNeighborEastExtent(){return this.extent[2]*(this.isEastEnd?-1:1)}get isEastEnd(){return this.lij[2]===this.surface.lijEastEnd(this.level)-1}get isWestEnd(){return this.lij[2]===0}get isNorthEnd(){return this.lij[1]===0}get isSouthEnd(){const e=this.surface.extent,r=e?.[1]??null;return r!=null&&this.extent[1]+sl()>=r}checkGeometryWaterproofness(){s6&&(Se(this.isLoaded),this.renderData?.checkGeometryWaterproofness())}shouldHaveNeighbor(e){const r=this.extent,i=this.surface.rootTilesExtent,s=.25*(r[2]-r[0]);if(Lme(e)&&r[3]+s>=i[3]||$me(e)&&r[1]-s<=i[1])return!1;const n=this.surface.isGlobal;return!(!n&&Ime(e)&&r[0]-s<=i[0])&&!(!n&&Pme(e)&&r[2]+s>=i[2])}updateDistanceToPOI(e){const r=this._lastPOI;if(this.distanceToPOI>=0&&r[0]===e[0]&&r[1]===e[1]&&r[2]===e[2])return;oe(this._lastPOI,e);const i=this._center[hn.MIDDLE],s=e[0]-i[0],n=e[1]-i[1],o=e[2]-i[2];this.distanceToPOI=s*s+n*n+o*o}};function SRt(t,e,r,i){const s=r===nr.ELEVATION?Vie.acquire():Uie.acquire();return s.init(t,e,r,i),s}function QN(t){t.dispose(),t instanceof dNe?Vie.release(t):t instanceof pNe&&Uie.release(t)}const Uie=new $o(pNe),Vie=new $o(dNe),ERt=new pC;var hn;function CRt(t,e){const r=t.level,i=e[0];if(r>i)return!1;const s=i-r,n=Math.floor(e[1]/2**s),o=Math.floor(e[2]/2**s);return n===t.lij[1]&&o===t.lij[2]}function ARt(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function ORt(t,e,r){if(t==null||e==null)return!1;if(t.level===0&&e.level===0&&(t.isEastEnd&&e.isWestEnd&&r===ct.EAST||t.isWestEnd&&e.isEastEnd&&r===ct.WEST))return!0;const i=Math.max(1e-6*(t.extent[2]-t.extent[0]),1);switch(r){case ct.NORTH:return Cd(t.extent[3],e.extent[1],i);case ct.SOUTH:return Cd(t.extent[1],e.extent[3],i);case ct.EAST:return Cd(t.extent[2],e.extent[0],i)||Cd(t.extent[2],-e.extent[0],i);case ct.WEST:return Cd(t.extent[0],e.extent[2],i)||Cd(t.extent[0],-e.extent[2],i)}}function sJ(t,e,r){return t!=null&&e!=null&&e!==t&&(t.level>=e.level?Wme(t,e,r):Wme(e,t,a6(r)))}function Wme(t,e,r){Se(t.level>=e.level);const i=WAt(r),s=ZAt(r),n=t.extent,o=e.extent,a=[i?n[0]:n[2],s?n[3]:n[1]],l=[i?o[2]:o[0],s?o[1]:o[3]],c=1e-5*(n[2]-n[0]),h=Cd(a[0],l[0],c)||t.surface.isGlobal&&Cd(a[0],-l[0],c),p=Cd(a[1],l[1],c);if(h&&p)return!0;if(t.level===e.level||!h&&!p)return Se(!1),!1;const f=h?Zme(o[1],o[3],n[1],n[3],c):Zme(o[0],o[2],n[0],n[2],c);return Se(f),f}function Zme(t,e,r,i,s){return t-s<=r&&r<=i&&i<=e+s}(function(t){t[t.TOP=0]="TOP",t[t.MIDDLE=1]="MIDDLE",t[t.BOTTOM=2]="BOTTOM"})(hn||(hn={}));const KN=C(),YG=C(),JG=C(),jo=C();let RRt=class{constructor(){this._scales=Vt(-1,-1,-1,-1),this._offsets=Vt(-1,-1,-1,-1)}clear(){this._scales[0]=this._scales[1]=this._scales[2]=this._scales[3]=-1,this._offsets[0]=this._offsets[1]=this._offsets[2]=this._offsets[3]=-1}setScale(e,r,i){this._scales[2*e]=r,this._scales[2*e+1]=i}setOffset(e,r,i){this._offsets[2*e]=r,this._offsets[2*e+1]=i}get scales(){return this._scales}get offsets(){return this._offsets}};function MRt(t,e){t.varyings.add("tbnTangent","vec3"),t.varyings.add("tbnBiTangent","vec3"),e.spherical?t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), n));
tbnBiTangent = normalize(cross(n, tbnTangent));
}`):t.vertex.code.add(w`void forwardVertexTangent(vec3 n) {
tbnTangent = vec3(1.0, 0.0, 0.0);
tbnBiTangent = normalize(cross(n, tbnTangent));
}`),t.fragment.code.add(w`mat3 getTBNMatrix(vec3 n) {
return mat3(tbnTangent, tbnBiTangent, n);
}`)}let zie=class extends rLe{constructor(){super(...arguments),this.slicePlaneLocalOrigin=C(),this.origin=this.slicePlaneLocalOrigin,this.modelTransformation=null}};var mu;(function(t){t[t.Material=0]="Material",t[t.ShadowMap=1]="ShadowMap",t[t.Highlight=2]="Highlight"})(mu||(mu={}));let IRt=class extends zie{constructor(){super(...arguments),this.identifier=mu.Material,this.output=k.Color,this.transparent=!1,this.integratedMesh=!1}},PRt=class extends zie{constructor(){super(...arguments),this.identifier=mu.ShadowMap}},$Rt=class extends zie{constructor(){super(...arguments),this.identifier=mu.Highlight}},c6=class extends Ps{constructor(e,r){super(e,"vec4",ai.Draw,(i,s,n)=>i.setUniform4fv(e,r(s,n)))}};var x0;function LRt(t,e){const{vertex:r,fragment:i}=t;r.uniforms.add(new c6("overlayTexOffset",(s,n)=>DRt(s,n)),new c6("overlayTexScale",(s,n)=>NRt(s,n))),i.constants.add("overlayOpacity","float",1),i.uniforms.add(new et("ovColorTex",(s,n)=>nJ(s,n))),yNe(t,e)}function yNe(t,e){e.pbrMode!==lt.Water&&e.pbrMode!==lt.WaterOnIntegratedMesh&&e.pbrMode!==lt.TerrainWithWater||t.include(nLe,e);const{vertex:r,fragment:i}=t;t.varyings.add("vtcOverlay","vec4"),r.code.add(w`void setOverlayVTC(in vec2 uv) {
vtcOverlay = vec4(uv, uv) * overlayTexScale + overlayTexOffset;
}`),i.code.add(w`bool isValid(vec2 uv, vec2 dxdy) {
return (uv.x >= 0.0 + dxdy.x) && (uv.x <= 1.0 - dxdy.x) && (uv.y >= 0.0 + dxdy.y) && (uv.y <= 1.0 - dxdy.y);
}
vec4 getOverlayColor(sampler2D ov0Tex, vec4 texCoords) {
vec4 color0 = texture(ov0Tex, vec2(texCoords.x * 0.5, texCoords.y));
vec4 color1 = texture(ov0Tex, vec2(texCoords.z * 0.5 + 0.5, texCoords.w));
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),i.code.add(w`vec4 getCombinedOverlayColor() {
return overlayOpacity * getOverlayColor(ovColorTex, vtcOverlay);
}`),i.code.add(w`vec4 getOverlayColorTexel(vec4 texCoords) {
vec2 texDim =  vec2(textureSize(ovColorTex, 0));
vec4 color0 = texelFetch(ovColorTex, ivec2(vec2(texCoords.x * 0.5, texCoords.y)*texDim), 0);
vec4 color1 = texelFetch(ovColorTex, ivec2(vec2(texCoords.z * 0.5 + 0.5, texCoords.w)*texDim), 0);
bool isValid0 = isValid(texCoords.xy, fwidth(texCoords.xy));
bool isValid1 = isValid(texCoords.zw, vec2(0.0, 0.0));
return mix(color1 * float(isValid1), color0, float(isValid0));
}`),e.pbrMode!==lt.Water&&e.pbrMode!==lt.WaterOnIntegratedMesh&&e.pbrMode!==lt.TerrainWithWater||(G0(i),Fg(i),i.code.add(w`vec4 getOverlayWaterColor(vec4 maskInput, vec4 colorInput, vec3 vposEyeDir,
float shadow, vec3 localUp, mat3 tbn, vec3 position, vec3 positionWorld) {
vec3 n = normalize(tbn *  (2.0 * maskInput.rgb - vec3(1.0)));
vec3 v = vposEyeDir;
vec3 final = getSeaColor(n, v, mainLightDirection, colorInput.rgb, mainLightIntensity, localUp, 1.0 - shadow, maskInput.w, position, positionWorld);
return vec4(final, colorInput.w);
}`))}function nJ(t,e){return e.overlays.length===0?null:t.identifier===mu.Material&&t.output===k.Color?e.overlays[Ji.INNER].getColorTextureNoRasterImage():t.identifier===mu.Material&&t.output===k.ObjectAndLayerIdColor?e.overlays[Ji.INNER].getColorTexture(Ol.ObjectAndLayerIdColor):t.identifier===mu.Highlight?e.overlays[Ji.INNER].getValidTexture(Os.Highlight):null}function DRt(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;cbe(s)>0&&(WC[2*i]=t.toMapSpace[0]/hh(s)-s[0]/hh(s),WC[2*i+1]=t.toMapSpace[1]/Mf(s)-s[1]/Mf(s))}return WC}function NRt(t,e){for(const r of e.overlays){const{index:i,extent:s}=r;cbe(s)>0&&(WC[2*i]=t.toMapSpace[2]/hh(s),WC[2*i+1]=t.toMapSpace[3]/Mf(s))}return WC}(function(t){t[t.Disabled=0]="Disabled",t[t.Enabled=1]="Enabled",t[t.EnabledWithWater=2]="EnabledWithWater",t[t.COUNT=3]="COUNT"})(x0||(x0={}));const WC=Qt();var tg;(function(t){t[t.LayerOnly=0]="LayerOnly",t[t.ColorComposite=1]="ColorComposite",t[t.GridComposite=2]="GridComposite",t[t.COUNT=3]="COUNT"})(tg||(tg={}));let FRt=class extends cie{constructor(){super(...arguments),this.overlayOpacity=1,this.overlaySource=Ol.None}};function GR(t,e){t.vertex.uniforms.add(new u6("overlayTexOffset"),new u6("overlayTexScale")),t.fragment.uniforms.add(new Ie("overlayOpacity",r=>r.overlayOpacity),new et("ovColorTex",(r,i)=>i.overlays.length===0?null:i.overlays[Ji.INNER].getColorTexture(r.overlaySource))),yNe(t,e)}function kRt(t,e){const{vertex:r,fragment:i,varyings:s}=t;s.add("vtc","vec2"),r.uniforms.add(new u6("texOffsetAndScale")),i.uniforms.add(new Xme("tex")),i.uniforms.add(new QG("textureOpacities"));const n=e.textureFadingEnabled&&!e.renderOccluded;n&&(r.uniforms.add(new u6("nextTexOffsetAndScale")),s.add("nvtc","vec2"),i.uniforms.add(new Xme("texNext")),i.uniforms.add(new QG("nextTexOpacities")),i.uniforms.add(new URt("fadeFactor")));const o=e.tileBlendInput===tg.ColorComposite,a=e.tileBlendInput===tg.GridComposite;a&&i.include(Fie),o&&i.uniforms.add(new QG("backgroundColor")),r.code.add(w`
  void forwardTextureCoordinatesWithTransform(in vec2 uv) {
    vtc = uv * texOffsetAndScale.zw + texOffsetAndScale.xy;
    ${n?w`nvtc = uv * nextTexOffsetAndScale.zw + nextTexOffsetAndScale.xy;`:w``}
  }`),i.code.add(w`
    vec4 getColor(vec4 color, vec2 uv, vec3 opacities) {
      ${a||o?w`
              if (opacities.y <= 0.0) {
                return color * opacities.z * opacities.x;
              }
              vec4 bg = vec4(${o?w`backgroundColor`:w`gridColor(uv)`} * opacities.y, opacities.y);
              vec4 layer = color * opacities.z;
              return (bg * (1.0 - layer.a) + layer) * opacities.x;`:w`return color;`}
    }`),n?i.code.add(w`vec4 getTileColor() {
vec4 color = getColor(texture(tex, vtc), vtc, textureOpacities);
if (fadeFactor >= 1.0) {
return color;
}
vec4 nextColor = getColor(texture(texNext, nvtc), nvtc, nextTexOpacities);
return mix(nextColor, color, fadeFactor);
}`):i.code.add(w`vec4 getTileColor() {
return getColor(texture(tex, vtc), vtc, textureOpacities);
}`)}let URt=class extends Ps{constructor(e){super(e,"float")}},QG=class extends Ps{constructor(e){super(e,"vec3")}},u6=class extends Ps{constructor(e){super(e,"vec4")}},Xme=class extends Ps{constructor(e){super(e,"sampler2D")}},_Ne=class extends FRt{};function VRt(t){const e=new Cr,{vertex:r,fragment:i,varyings:s}=e;e.include(E$),e.include(V$,t),e.include(ag,t);const n=()=>{e.include(AP,t),r.code.add(w`vec3 getNormal() {
float z = 1.0 - abs(normalCompressed.x) - abs(normalCompressed.y);
vec3 n = vec3(normalCompressed + vec2(normalCompressed.x >= 0.0 ? 1.0 : -1.0,
normalCompressed.y >= 0.0 ? 1.0 : -1.0) * min(z, 0.0), z);
return normalize(n);
}`)};Eu(r,t),e.include(_c,t);const o=t.overlayMode!==x0.Disabled,a=o&&t.invisible;switch(t.output){case k.Color:{e.include(kRt,t),e.include(JT,t),o&&e.include(GR,{...t,pbrMode:t.pbrMode===lt.Terrain?lt.TerrainWithWater:lt.Water});const l=t.overlayMode===x0.EnabledWithWater;l&&e.include(MRt,t),s.add("vnormal","vec3"),s.add("vpos","vec3"),s.add("vup","vec3"),n(),t.screenSizePerspective&&NA(r);const c=t.receiveShadows&&!t.renderOccluded;c&&e.include(TO,t),t.screenSizePerspective&&(s.add("screenSizeDistanceToCamera","float"),s.add("screenSizeCosAngle","float")),r.code.add(w`
        void main(void) {
          //Position
          vpos = position;
          vec3 positionWorld = position + localOrigin;
          gl_Position = transformPosition(proj, view, vpos);

          //Normal
          vnormal = getNormal();

          //Up
          vup = getLocalUp(position, localOrigin);

          ${l?w`forwardVertexTangent(vnormal);`:w``}

          //Texture UV
          vec2 uv = getUV0();
          forwardTextureCoordinatesWithTransform(uv);
          ${o?w`setOverlayVTC(uv);`:""}
          ${t.tileBorders?w`forwardTextureCoordinates();`:""}

          ${t.screenSizePerspective?w`
          vec3 viewPos = (view * vec4(vpos, 1.0)).xyz;
          screenSizeDistanceToCamera = length(viewPos);
          vec3 viewSpaceNormal = (viewNormal * vec4(normalize(positionWorld), 1.0)).xyz;
          screenSizeCosAngle = abs(viewSpaceNormal.z);`:""}

          ${c?w`forwardLinearDepth();`:""}

        }
      `),e.include(Bs,t),e.include(JT,t),e.include(B$,t),e.include(XT,t),kf(i,t),G$(i),PO(i),i.uniforms.add(r.uniforms.get("localOrigin"),new jt("viewDirection",(h,p)=>_e(Yme,ie(Yme,p.camera.viewMatrix[12],p.camera.viewMatrix[13],p.camera.viewMatrix[14])))),l&&i.uniforms.add(new et("ovWaterTex",(h,p)=>p.overlays.length===0?null:p.overlays[Ji.INNER].getNormalTexture(h.overlaySource)),new VIe("view",(h,p)=>Cc(zRt,p.camera.viewMatrix,h.origin))),i.code.add(w`const float sliceOpacity = 0.2;
float lum(vec3 c) {
return (min(min(c.r, c.g), c.b) + max(max(c.r, c.g), c.b)) * 0.5;
}`),G0(i),Fg(i),i.code.add(w`
        void main() {
          vec3 normal = normalize(vnormal);
          float vndl = dot(normal, mainLightDirection);

          float additionalAmbientScale = smoothstep(0.0, 1.0, clamp(vndl*2.5, 0.0, 1.0));
          float shadow = ${t.receiveShadows&&!t.renderOccluded?"readShadowMap(vpos, linearDepth)":t.spherical?"lightingGlobalFactor * (1.0 - additionalAmbientScale)":"0.0"};

          float ssao = evaluateAmbientOcclusionInverse();
          vec4 tileColor = getTileColor();

          ${o?w`
              vec4 overlayColorOpaque = getOverlayColor(ovColorTex, vtcOverlay);
              vec4 overlayColor = overlayOpacity * overlayColorOpaque;
              ${t.invisible?w`if (overlayColor.a == 0.0) { discard; }`:""}
              vec4 groundColor = tileColor;
              tileColor = tileColor * (1.0 - overlayColor.a) + overlayColor;`:""}

          // If combined alpha is 0 we can discard pixel. The performance impact by having a discard here
          // is neglectable because terrain typically renders first into the framebuffer.
          if(tileColor.a <= 0.0) {
            discard;
          }

          bool sliced = rejectBySlice(vpos);
          if (sliced) {
            tileColor *= sliceOpacity;
          }

          vec3 albedo = tileColor.rgb;

          // heuristic shading function used in the old terrain, now used to add ambient lighting

          vec3 additionalLight = ssao * mainLightIntensity * additionalAmbientScale * ambientBoostFactor * lightingGlobalFactor;

          ${t.pbrMode===lt.Terrain||t.pbrMode===lt.TerrainWithWater?w`fragColor = vec4(evaluateTerrainLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight, normalize(vpos - cameraPosition), vup), tileColor.a);`:w`fragColor = vec4(evaluateSceneLighting(normal, albedo, shadow, 1.0 - ssao, additionalLight), tileColor.a);`}
          ${l?w`
              vec4 overlayWaterMask = getOverlayColor(ovWaterTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, vnormal);
                vec4 waterOverlayColor = vec4(overlayColor.w > 0.0 ? overlayColorOpaque.xyz/overlayColor.w : vec3(1.0), overlayColor.w);
                vec4 viewPosition = view*vec4(vpos, 1.0);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, waterOverlayColor, -normalize(vpos - cameraPosition), shadow, vnormal, tbnMatrix, viewPosition.xyz,  vpos + localOrigin);
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                float opacity = sliced ? sliceOpacity : 1.0;
                // un-gamma the ground color to mix in linear space
                fragColor = mix(groundColor, waterColorNonLinear, waterColorLinear.w) * opacity;
              }`:""}
          ${t.screenSizePerspective?w`
            float perspectiveScale = screenSizePerspectiveScaleFloat(1.0, screenSizeCosAngle, screenSizeDistanceToCamera, vec4(0.0, 0.0, 0.0, 0.0));
            if (perspectiveScale <= 0.25) {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), perspectiveScale * 4.0);
            }
            else if (perspectiveScale <= 0.5) {
              fragColor = mix(fragColor, vec4(0.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.25) * 4.0);
            }
            else if (perspectiveScale >= 0.99) {
              fragColor = mix(fragColor, vec4(0.0, 1.0, 0.0, 1.0), 0.2);
            }
            else {
              fragColor = mix(fragColor, vec4(1.0, 0.0, 1.0, 1.0), (perspectiveScale - 0.5) * 2.0);
            }`:""}
          ${t.visualizeNormals?t.spherical?w`
                  vec3 localUp = normalize(vpos + localOrigin);
                  vec3 right = normalize(cross(vec3(0.0, 0.0, 1.0), localUp));
                  vec3 forward = normalize(cross(localUp, right));
                  mat3 tbn = mat3(right, forward, localUp);
                  vec3 tNormal = normalize(normal * tbn);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:w`
                  vec3 tNormal = normalize(normal);
                  fragColor = vec4(vec3(0.5) + 0.5 * tNormal, 0.0);
              `:""}
          ${t.tileBorders?w`
              vec2 dVuv = fwidth(vuv0);
              vec2 edgeFactors = smoothstep(vec2(0.0), 1.5 * dVuv, min(vuv0, 1.0 - vuv0));
              float edgeFactor = 1.0 - min(edgeFactors.x, edgeFactors.y);
              fragColor = mix(fragColor, vec4(1.0, 0.0, 0.0, 1.0), edgeFactor);`:""}
          fragColor = highlightSlice(fragColor, vpos);
        }
      `)}break;case k.Depth:a&&e.include(GR,t),e.include(N0,t),J1(e),BT(e),r.code.add(w`
              void main(void) {
                ${a?w`setOverlayVTC(getUV0());`:""}
                gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
              }
          `),i.code.add(w`
              void main() {
                ${a?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
                outputDepth(linearDepth);
              }
          `);break;case k.Shadow:case k.ShadowHighlight:case k.ShadowExcludeHighlight:e.include(N0,t),J1(e),BT(e),r.code.add(w`void main(void) {
gl_Position = transformPositionWithDepth(proj, view, position, nearFar, linearDepth);
}`),i.code.add(w`void main() {
outputDepth(linearDepth);
}`);break;case k.Normal:a&&e.include(GR,t),s.add("vnormal","vec3"),NA(r),n(),r.code.add(w`
            void main(void) {
              ${a?w`setOverlayVTC(getUV0());`:""}
              gl_Position = transformPosition(proj, view, position);
              vnormal = normalize((viewNormal * vec4(getNormal(), 1.0)).xyz);
            }
        `),i.code.add(w`
            void main() {
              ${a?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
              vec3 normal = normalize(vnormal);
              if (gl_FrontFacing == false) {
                normal = -normal;
              }
              fragColor = vec4(vec3(0.5) + 0.5 * normal, 0.0);
            }
        `);break;case k.Highlight:o&&e.include(GR,t),r.code.add(w`
          void main() {
            ${o?w`setOverlayVTC(getUV0());`:""}
            gl_Position = transformPosition(proj, view, position);
          }
        `),e.include(J0,t),i.code.add(w`
          void main() {
            ${o?w`if (getCombinedOverlayColor().a == 0.0) { discard; }`:""}
            outputHighlight();
          }
        `)}return t.output===k.ObjectAndLayerIdColor&&(e.include(GR,{...t,pbrMode:lt.Disabled}),r.code.add(w`void main(void) {
gl_Position = transformPosition(proj, view, position);
setOverlayVTC(getUV0());
}`),i.code.add(w`void main() {
fragColor = getOverlayColorTexel(vtcOverlay);
}`)),e}const zRt=xe(),Yme=C(),BRt=Object.freeze(Object.defineProperty({__proto__:null,TerrainPassParameters:_Ne,build:VRt},Symbol.toStringTag,{value:"Module"}));let vNe=class bNe extends Ur{constructor(){super(...arguments),this.useStencil=!1}initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global}initializeProgram(e){return new Lr(e.rctx,bNe.shader.get().build(this.configuration),wNe)}initializePipeline(){return this._stencilPipelineState=this._createPipeline(!0),this._createPipeline(!1)}_createPipeline(e){const r=this.configuration,i=r.backfaceCullingEnabled&&!r.renderOccluded;return It({blending:r.renderOccluded?Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA):null,culling:i?Dte:null,depthTest:r.renderOccluded?null:{func:ci.LESS},depthWrite:r.renderOccluded?null:Ac,colorWrite:Wt,stencilTest:e?Pbt(xc.IntegratedMeshMaskExcluded):null})}getPipelineState(e,r){return this.useStencil?this._stencilPipelineState:super.getPipelineState(e,r)}};vNe.shader=new $r(BRt,()=>J(()=>import("./Terrain.glsl-615ad68e.js"),[],import.meta.url));const wNe=new Map([[E.POSITION,0],[E.UV0,1],[E.NORMALCOMPRESSED,2]]);let GRt=class{constructor(){this.geometry=new VOt,this.intersectionData=null,this.geometryState=null,this._textureRef=new lNe(()=>this.tile.surface.textureFadeDuration),this.overlay=new RRt,this._geometryStateChangedSinceLastUpdate=!0,this._hasGeometry=!1,this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._clippingAreaChanged=!1,this._wireframeChanged=!1,this._dirtyEdgeResolutions=15,this._dirtyEdges=15,this._dirtyCorners=15}get tile(){return this._tile}init(e){this.clear(),this._tile=e;const r=this.geometry;r.indices=null,r.vertexAttributes=null,Gi(r.boundingBox),r.indexCount=0,r.numVerticesPerSide=0,this.intersectionData=null,this.geometryState=new qOt,this.localOrigin=null,this.overlay.clear()}clear(){this.releaseGeometry(),this.releaseTexture(),this._textureRef.clear(),this._tile=null,this.intersectionData=null,this.geometryState=null}updateGeometryIfNeeded(e){if((!this._vao||this._geometryStateChangedSinceLastUpdate||this._wireframeChanged||this._clippingAreaChanged||this._samplerDataChanged||this._numVerticesPerSideChanged||this._dirtyCorners||this._dirtyEdgeResolutions||this._dirtyEdges)&&(this._updateGeometry(e),this._geometryStateChangedSinceLastUpdate=!1),Nn&&this.tile.intersectsClippingArea)for(let r=0;r<4;++r)Se(this.geometry.outerEdges[r].count===this.geometryState.neighborData.edgeResolutions[r]+1)}_calculateEdgeResolution(e,r){const i=this.tile,s=this.geometryState.numVerticesPerSide-1;if(!i.surface.isGlobal){const l=i.surface.extent;if(l!=null&&(e===0&&i.extent[3]>l[3]||e===1&&i.extent[2]>l[2]||e===2&&i.extent[1]<l[1]||e===3&&i.extent[0]<l[0]))return s}const n=i.level,o=eg[e];if(!r)return Se(i.surface?.rootTiles==null||i.surface.updatingRootTiles||!i.shouldHaveNeighbor(o)),s;if(r.isLoaded){const l=r,c=l.renderData.geometryState,h=n-l.level;if(Se(h>=0),h===0){const m=c.numVerticesPerSide-1;return Math.max(m,s)}const p=2**h,f=c.neighborData.edgeResolutions[(e+2)%4]/p;return Math.max(1,f)}Se(!r.isLeaf);let a=s;return r.forAllSubtreeOnSide(l6(o),l=>l===i||(l.isLoaded?(a=Math.max(a,2**(l.level-n)),!0):(Se(!l.isLeaf),!1))),a}updateNeighborData(){const e=this.tile;if(!e.intersectsClippingArea)return;const r=e.renderData.geometryState.neighborData,i=a=>(a.isLoaded||a.level===e.level)&&a?.intersectsClippingArea,s=r.edgePeerNeighbors,n=r.edgePeerNeighborSamplerVersions;for(let a=0;a<4;++a){const l=e.findNeighborTile(eg[a],i),c=Nx(e,l),h=c?.renderData?.geometryState.samplerDataVersion??-1,p=s[a],f=c!==Nx(e,p),m=n[a]!==h;s[a]=l,(f||m)&&(n[a]=h,this._markEdgeDirty(a));const g=r.edgeResolutions[a],_=this._calculateEdgeResolution(a,l);Se(OT(_)),Se(_>=1),r.edgeResolutions[a]=_,g!==_&&this._markEdgeResolutionDirty(a)}const o=r.cornerPeerNeighbors;for(let a=0;a<4;++a){const l=e.findNeighborTile(PP[a],i);o[a]=l;const c=Nx(e,s[a]),h=Nx(e,s[(a+1)%4]),p=Nx(e,l);bp[a]=p,bp[(a+1)%4]=h,bp[(a+2)%4]=e,bp[(a+3)%4]=c,Se(bp.some(_=>_?.isLoaded||_===e));const f=bp.reduce((_,v)=>Math.min(_,v?.level??1/0),1/0);bp.forEach((_,v)=>{_&&_?.level>f&&(bp[v]=null)}),Se(bp.some(_=>_?.isLoaded||_===e));const m=r.cornerNeighborData[a].cornerTiles,g=r.cornerNeighborData[a].cornerTileSamplerVersions;for(let _=0;_<4;++_){const v=bp[_],b=v?.renderData.geometryState.samplerDataVersion??-1,x=m[_]!==v,T=!x&&g[_]!==b;(x||T)&&(m[_]=v,g[_]=b,this._markCornerDirty(a))}Se(m.some(_=>_?.isLoaded||_===e))}Nn&&Se(this.geometryState.neighborData.edgeResolutions.every(a=>a>0));for(let a=0;a<4;++a)bp[a]=null}_updateGeometry(e){if(!this.tile.intersectsClippingArea)return;Nn&&Se(!this.tile.intersectsClippingArea||this.geometryState.neighborData.edgeResolutions.every(l=>l>0)),this.intersectionData=null;const r=this.tile,i=this._vao,s=this.geometry.vertexAttributes,n=!i||!s||this._wireframeChanged||this._numVerticesPerSideChanged||this._samplerDataChanged||this._clippingAreaChanged||this._dirtyEdgeResolutions,o=!n&&(this._dirtyEdges!==0||this._dirtyEdgeResolutions!==0),a=!o&&this._dirtyCorners!==0;n?(this.releaseGeometry(),this._createGeometry(e)):o||a?r.updateEdgeElevations():a?r.updateCornerElevations():console.warn("Update for no reason?"),this._numVerticesPerSideChanged=!1,this._samplerDataChanged=!1,this._dirtyEdgeResolutions=0,this._dirtyEdges=0,this._dirtyCorners=0,this._clippingAreaChanged=!1,this._wireframeChanged=!1}get hasGeometry(){return this._hasGeometry}releaseGeometry(){return this._hasGeometry=!1,this.intersectionData=null,!!this._vao&&(this._vao.dispose(),this._vao=null,GOt(this.geometry),!0)}ensureTexture(e,r){return this._texture!=null&&this._texture.descriptor.width!==e&&this.releaseTexture(),this._texture==null&&(this._texture=r(),this.tile.setMemoryDirty()),this._texture}releaseTexture(){this._texture!=null&&(this._texture.release(),this._texture=null,this.tile.setMemoryDirty())}_markCornerDirty(e){const r=1<<e;this._dirtyCorners|=r}_markEdgeDirty(e){const r=1<<e;this._dirtyEdges|=r,this._markCornerDirty((e+0)%4),this._markCornerDirty((e+3)%4)}_markEdgeResolutionDirty(e){const r=1<<e;this._dirtyEdgeResolutions|=r,this._markEdgeDirty(e)}_markAllEdgesAndCornersDirty(){this._dirtyCorners=15,this._dirtyEdges=15,this._dirtyEdgeResolutions=15}updateGeometryState(){const e=this._getElevationInfo(),r=this.tile,i=e.samplerData?r.getElevationVerticesPerSide(e.maxTileLevel):r.getDefaultVerticesPerSide(),s=Math.max(i,5);let n=r.clippingArea;r.intersectsClippingArea&&!r.isWithinClippingArea||(n=null);const o=this.geometryState;let a=!1;o.numVerticesPerSide!==s&&(this._numVerticesPerSideChanged=!0,o.numVerticesPerSide=s,o.samplerDataVersion++,a=!0),e.changed&&(this._samplerDataChanged=!0,o.samplerData=e.samplerData,o.samplerDataVersion++,a=!0),T0(o.clippingArea,n)||(this._clippingAreaChanged=!0,o.clippingArea=n,a=!0);const l=r.surface.wireframe;return o.wireframe!==l&&(this._wireframeChanged=!0,o.wireframe=l,a=!0),this._geometryStateChangedSinceLastUpdate||(this._geometryStateChangedSinceLastUpdate=a),a&&this._markAllEdgesAndCornersDirty(),this._hasGeometry=!0,this._geometryStateChangedSinceLastUpdate}_createGeometry(e){this.tile.createGeometry();const r=this.geometry.vertexAttributes,i=this.geometry.indices,s=e.gl;this._vao=new zf(e,wNe,{geometry:$u(r.layout)},{geometry:Gr.createVertex(e,s.STATIC_DRAW,r.buffer)},Gr.createIndex(e,s.STATIC_DRAW,i)),this._hasGeometry=!0}get vao(){return this._vao}setTextureReference(e,r=b0.Immediate){e!=null&&e.texture!==this._texture&&this.releaseTexture(),this._textureRef.push(e,r)}get textureReference(){return this._textureRef.current}get nextTextureReference(){return this._textureRef.next}get textureFadeFactor(){return this._textureRef.fadeFactor}get textureIsFading(){return this._textureRef.isFading}_getElevationInfo(){const e=this.geometryState.samplerData,r=this.tile.layerInfo[nr.ELEVATION],i=r.length,s=new Array(i);let n=0,o=0,a=!1;for(let h=0;h<i;h++){const p=r[h];if(p.upsampleInfo!=null){const f=p.upsampleInfo.tile,m=f.layerInfo[nr.ELEVATION][h].data,g=m&&m.samplerData;e&&e[n]===g||(a=!0),s[n++]=g,o=Math.max(o,f.lij[0])}else if(p.data){const f=this.tile.surface.layerViewByIndex(h,nr.ELEVATION);if(CI(this.tile,f.layer,!1)){const m=p.data;e&&e[n]===m.samplerData||(a=!0),s[n++]=m.samplerData,o=this.tile.level}}}e!=null&&e.length!==n&&(a=!0);const l=n>0,c=l?s:null;return l&&(s.length=n),{changed:a,samplerData:c,maxTileLevel:o}}get estimatedGeometryMemoryUsage(){const e=this.intersectionData?.estimatedMemoryUsage??0;return(this.geometry.indices?.byteLength??0)+(this.geometry.vertexAttributes?.byteLength??0)+e}get texture(){return this._texture}get test(){return{hasTexture:this._texture!=null}}checkGeometryWaterproofness(){if(!Nn)return;const e=this.tile;if(!e.isLoaded||!e.intersectsClippingArea||e.level===0)return void Se(e?.isLoaded);const r=e.surface.extent;if(r!=null&&!e.intersectsExtent(r))return;const i=eg.map((a,l)=>r!=null&&(l<2?-1:1)*(e.extent[3-l]-r[3-l])<0),s=e.level;Se(this._dirtyCorners===0),Se(this._dirtyEdges===0),Se(this._dirtyEdgeResolutions===0),Se(!this._numVerticesPerSideChanged),Se(!this._samplerDataChanged),Se(!this._clippingAreaChanged),Se(!this._wireframeChanged);const n=PP.map(a=>e.findNeighborCornerTileExact(a,l=>!l.intersectsClippingArea||l.isLoaded||l.level===e.level)??null).map(a=>a?.intersectsClippingArea?a:null),o=this.geometryState.neighborData;for(let a=0;a<4;++a){const l=o.cornerPeerNeighbors[a],c=n[a];Se(c===l,`Tile[${e.lij}].corner[${a}] out of date: cur=[${l?.lij}] exp=[${c?.lij}]`)}eg.forEach((a,l)=>{if(i[l])return;const c=e.findNeighborTile(a,z=>(z.level===s||z?.isLoaded)&&z?.intersectsClippingArea);if(!c){const z=!e.surface.updatingRootTiles&&e.surface.rootTiles!=null&&e.surface.rootTiles.length>0&&e.shouldHaveNeighbor(a);return void Se(!z)}Se(c.isLoaded||c.level===e.level),Se(c===this.geometryState.neighborData.edgePeerNeighbors[l]);const h=s-c.level;if(!c.isLoaded)return Se(!c.isLeaf),void Se(h===0);const p=c.renderData;Se(ORt(e,c,a)),Se(h>=0);const f=2**h;if(h<0)return void Se(!1);const m=e.renderData,g=m.geometry,_=g.outerEdges[l],v=g.numVerticesPerSide-1,b=p.geometry;if(!b)return void Se(!1);const x=this.geometryState.neighborData.edgePeerNeighbors[l];if(x?.isLoaded){const z=x.renderData;Se(x==x),Se(m.geometryState.neighborData.edgePeerNeighborSamplerVersions[l]===z.geometryState.samplerDataVersion),Se(this.geometryState.neighborData.edgePeerNeighborSamplerVersions[l]===z.geometryState.samplerDataVersion)}const T=(l+2)%4,S=b.outerEdges[T],O=_.count-1,A=S.count-1;Se(O*f===A,`Tile[${e.lij}]:e${l},res=${O} edgeRes mismatch with Neighbor[${c.lij}]:e${T},res=${A} (expected:${O*f})`);const M=e.extent,P=a===ct.NORTH||a===ct.SOUTH,F=S.count-1,$=F/2**h,N=_.count-1;if($<1)return void Se(N===1);Se($===N),Se(OT($));const U=b.numVerticesPerSide-1;Se(h>0||$===Math.max(U,v));const X=e.getNeighborEdgeStartVertexIndex(l,c);Se(0<=X&&X<f);const Z=X*$;Se(0<=Z&&Z<=F-$);let G=0,ee=Z;_.getVertexPos(dm,0),_.getVertexPos(pm,_.count-1);const I=_i(dm,pm),V=Math.max(jRt,1e-4*I);for(let z=0;z<=$;++z){_.getVertexPos(dm,G),S.getVertexPos(pm,ee);const H=z/$,Y=P?M[0]+H*(M[2]-M[0]):a===ct.WEST?M[0]:M[2],te=P?a===ct.SOUTH?M[1]:M[3]:M[1]+H*(M[3]-M[1]),ne=e.surface.extent;if(ne==null||V6(ne,Y,te)){const ve=YP(dm,pm),Fe=ou(dm)-ur.radius,bt=ou(pm)-ur.radius,Pt=ve<V;if(!Pt){console.warn(`Tile edge vertex position mismatch: between [${e.lij}].edge${l}[${G}/${_.count}] and [${c.lij}].edge${T}[${ee}/${S.count}]`),ne!=null&&console.warn("  surface extent= ",ne," x,y=",Y,",",te);const be=C();pe(be,m.localOrigin,p.localOrigin),ou(be)>0&&console.warn(`   localOrigins: ${m.localOrigin} vs ${p.localOrigin} d=${ou(be)} [${be}]`),(()=>{const Me=$i(dm),Ct=$i(pm);e.updateEdgeElevations(),c.updateEdgeElevations(),_.getVertexPos(dm,G),S.getVertexPos(pm,ee);const we=C();Mi(we,dm,Me),ou(we)>0&&console.warn(`  XXX Tile[${e.lij}] edge out of date: ${Me} vs ${dm} d=${ou(we)} [${we}]`),Mi(we,pm,Ct),ou(we)>0&&console.warn(`  XXX Neighbor[${c.lij}] edge out of date: ${Ct} vs ${pm} d=${ou(we)} [${we}]`)})(),Se(Pt,`Mismatch in tile [${e.lij}].edge[${l}][${G}/${_.count}] vs neighbor [${c.lij}].edge[${T}][${ee}/${S.count}] ${ny(dm)} vs ${ny(pm)}  dist=${ve} h(t|n|d)=${Fe}|${bt}|${bt-Fe}`)}_.getNormal(C2,G),S.getNormal(A2,ee),_e(Jme,C2),_e(Qme,A2);const dt=de(Jme,Qme),wt=1-dt<.01||!1||e===c;if(!wt){const be=C();Mi(be,C2,A2);const Me=()=>`Mismatch in tile edge normal ${Mme(e.lij)} (${G}/${_.count-1}) edge ${l} vs neighbor ${Mme(c.lij)}  (${ee}/${S.count-1}) nedge ${T} :${ny(C2)} vs ${ny(A2)}  dot = ${dt} : ${ny(be)}`;console.warn("Mismatch in tile edge normal: ",Me());{e.updateEdgeElevations(),c.updateEdgeElevations();const Ct=C(),we=C();_.getNormal(Ct,G),S.getNormal(we,ee),D1(C2,Ct)||console.warn("Missing update in tile normal: ",ny(C2)," => ",ny(Ct)),D1(A2,we)||console.warn("Missing update in neighbor normal: ",ny(A2)," => ",ny(we))}Se(wt,Me())}}G+=1,ee+=1}})}};const dm=C(),pm=C(),C2=C(),A2=C(),Jme=C(),Qme=C(),jRt=1,bp=[null,null,null,null];function Nx(t,e){return e?.isLoaded||e===t?e:null}const HRt=65536;function qRt(t,e){const r=t.tile,{extent:i,extentInRadians:s,surface:n}=r,o=t.localOrigin,a=t.geometryState,l=n.isWebMercator,c=a.numVerticesPerSide,h=c-1,p=(c-2)**2,f=l&&(e===Sd.HAS_SOUTH_POLE||e===Sd.HAS_BOTH_POLES),m=l&&(e===Sd.HAS_NORTH_POLE||e===Sd.HAS_BOTH_POLES),g=6,_=((f?1:0)+(m?1:0))*g*(h+1),v=a.neighborData,b=v.edgeResolutions.reduce((M,P)=>M+P+1,0),x=aNe(p+_+b),T=t.geometry;T.numVerticesPerSide=a.numVerticesPerSide,T.vertexAttributes=x;const S=T.boundingBox;Gi(S);const O=Bie(t);Ko.update(h,s,O),WRt(t),INe(t,p),xNe(t);const A=[];if((()=>{let M=p+b;const P=o[0],F=o[1],$=o[2],N=r.ellipsoid.radius,U=i[1],X=i[3],Z=(G,ee)=>{const I=ee*c;Ud(-P,-F,G*N-$,S),A.push({connectedRowOffset:I,connectedOuterEdgeOffset:G===1?0:2,rowOffset:M,latitudeResolution:g});const V=ENe(G===-1?U:X,N),z=G*Math.PI/2-V,H=.99*(G===1?1:-1),Y=N+0,te=x.position,ne=x.uv0,{typedBuffer:ve,typedBufferStride:Fe}=x.normalCompressed;for(let bt=1;bt<=g;++bt){const Pt=V+z*(bt/g),dt=Math.cos(Pt),wt=Math.sin(Pt);for(let be=0;be<=h;be++){const Me=be/h,Ct=Ko.sinLonLUT[be],we=Ko.cosLonLUT[be]*dt,je=Ct*dt,Ze=wt,yt=we*Y-P,pt=je*Y-F,He=Ze*Y-$;Ud(yt,pt,He,S),te.setValues(M,yt,pt,He),Ef(ne,M,Me,H),YT(ve,M,we,je,Ze,Fe),++M}}};f&&Z(-1,0),m&&Z(1,h)})(),MNe(T,a.numVerticesPerSide,A,[0,c-1],[0,c-1],a.wireframe),t.intersectionData=null,Nn)for(let M=0;M<4;++M)Se(T.outerEdges[M].count===v.edgeResolutions[M]+1)}function WRt(t){const e=t.tile;if(!e.intersectsClippingArea)return;const r=t.geometryState,i=r.numVerticesPerSide,s=i-2,n=i-1,o=t.geometry,a=o.vertexAttributes,l=a.position,c=a.uv0,{typedBuffer:h,typedBufferStride:p}=a.normalCompressed,f=e.extent,m=f[0],g=f[2],_=f[1],v=f[3],b=e.ellipsoid.radius,x=r.samplerData,T=t.localOrigin,S=T[0],O=T[1],A=T[2],M=l.typedBuffer,P=l.typedBufferStride,F=1/n,$=o.boundingBox;let N=0;if(1<=s){const U=F,X=_*(1-U)+v*U,Z=Ko.sinLatLUT[1],G=Ko.cosLatLUT[1];for(let ee=1;ee<=s;ee++){const I=ee*F,V=m*(1-I)+g*I,z=Ko.sinLonLUT[ee],H=Ko.cosLonLUT[ee],Y=b+_s(V,X,x),te=Y*H*G-S,ne=Y*z*G-O,ve=Y*Z-A;Ud(te,ne,ve,$);const Fe=(ee-1)*P;M[Fe]=te,M[Fe+1]=ne,M[Fe+2]=ve,Ef(c,ee-1,I,U)}}for(let U=1;U<=s;U++){const X=U*F,Z=_*(1-X)+v*X,G=Ko.sinLatLUT[U],ee=Ko.cosLatLUT[U],I=U+1,V=I*F,z=_*(1-V)+v*V,H=Ko.sinLatLUT[I],Y=Ko.cosLatLUT[I],te=Ko.sinLonLUT[0],ne=Ko.cosLonLUT[0],ve=b+_s(m,Z,x);let Fe=ne*ee*ve-S,bt=te*ee*ve-O,Pt=G*ve-A;const dt=N*P;let wt=M[dt],be=M[dt+1],Me=M[dt+2];for(let Ct=1;Ct<=s;Ct++){const we=Ct*F,je=m*(1-we)+g*we,Ze=Ko.sinLonLUT[Ct],yt=Ko.cosLonLUT[Ct];let pt=0,He=0,Tt=0;if(Ct<s){const br=(N+1)*P;pt=M[br],He=M[br+1],Tt=M[br+2]}else{const br=Ko.sinLonLUT[n],xi=Ko.cosLonLUT[n],gn=b+_s(g,Z,x);pt=xi*ee*gn-S,He=br*ee*gn-O,Tt=G*gn-A}const fr=Fe,ar=bt,Li=Pt;Fe=wt,bt=be,Pt=Me,wt=pt,be=He,Me=Tt;const ot=pt-fr,at=He-ar,_t=Tt-Li;let er=0,lr=0,Qr=0;if(U>1){const br=(N-s)*P;er=M[br],lr=M[br+1],Qr=M[br+2]}else{const br=Ko.sinLatLUT[0],xi=Ko.cosLatLUT[0],gn=b+_s(je,_,x);er=yt*xi*gn-S,lr=Ze*xi*gn-O,Qr=br*gn-A}const Di=b+_s(je,z,x),tr=yt*Y*Di-S,Ni=Ze*Y*Di-O,is=H*Di-A;if(U<s){const br=N+s,xi=br*P;M[xi]=tr,M[xi+1]=Ni,M[xi+2]=is,Ud(tr,Ni,is,$),Ef(c,br,we,V)}const Yr=er-tr,Ar=lr-Ni,hs=Qr-is;let Hs=yt*ee,Vr=Ze*ee,hi=G;hi*hi<.999&&(Hs=_t*Ar-at*hs,Vr=ot*hs-_t*Yr,hi=at*Yr-ot*Ar);const Kr=1/Math.sqrt(Hs*Hs+Vr*Vr+hi*hi);YT(h,N,Hs*Kr,Vr*Kr,hi*Kr,p),++N}}}function ZRt(t){t.tile.intersectsClippingArea&&(xNe(t),t9(t))}function XRt(t){t.tile.intersectsClippingArea&&(SNe(t),TNe(t,!0),t9(t))}function xNe(t){t.tile.intersectsClippingArea&&(SNe(t),TNe(t))}function TNe(t,e=!1){const r=t.geometryState,i=t.geometry,s=r.neighborData,n=t.tile,o=n.level,a=n.extent,l=n.ellipsoid.radius,c=n.extentInRadians,h=c[0],p=c[2],f=c[1],m=c[3],g=r.samplerData,_=a[0],v=a[2],b=a[1],x=a[3],T=Bie(t),S=i.boundingBox,O=t.localOrigin,A=O[0],M=O[1],P=O[2],F=i.vertexAttributes,$=F.position,N=$.typedBuffer,U=$.typedBufferStride,X=F.uv0;for(let Z=0;Z<4;++Z){const G=Z===1||Z===3,ee=s.edgeResolutions[Z];Se(OT(ee));const I=ee+1,V=Nx(n,s.edgePeerNeighbors[Z]);if(LNe(n,V,Z)){PNe(t,Z,V);continue}const z=V!=null;Se(!z||V.level===n.level),Se(!z||w0(n,V)<=0);const H=V?.renderData,Y=H?.geometryState;if(Nn){const ot=n.surface;if(!V&&ot&&!ot.updatingRootTiles){const at=eg[Z],_t=n.findNeighborTile(at,er=>er.isLoaded||er.isLeaf||er.level===n.level);_t?_t.intersectsClippingArea&&(Se(!_t.isLoaded),Se(!_t.isLeaf),Se(_t.level===o)):Se(ot?.rootTiles==null||!n.shouldHaveNeighbor(at))}}const te=Z===1?a[2]:a[0],ne=V?.extent,ve=ne&&G?Z===1?ne[0]:ne[2]:te,Fe=Z===0?a[3]:a[1],bt=Z===1?1:0,Pt=Z===0?1:0,dt=Z===1?p:h,wt=Z===0?m:f,be=Math.sin(dt),Me=Math.cos(dt),Ct=Math.sin(wt),we=Math.cos(wt),je=Y?.samplerData,Ze=z?(ot,at,_t)=>.5*(_s(ot,at,g)+_s(_t,at,je)):(ot,at,_t)=>_s(ot,at,g),yt=i.outerEdges[Z],pt=e&&I>3?I-3:1,He=g!=null&&g.some(ot=>ot!=null),Tt=je!=null&&je.some(ot=>ot!=null),fr=He||Tt,ar=1/ee,Li=yt.index0;Se(!ne||Cd(ne[2]-ne[0],a[2]-a[0])),(()=>{const ot=Z===1?-1:Z===3?1:0,at=Z===0?-1:Z===2?1:0,_t=(a[2]-a[0])*ar,er=ot*_t,lr=at*_t,Qr=G?ot*((p-h)*ar):0,Di=G?0:at*ar,tr=Pt,Ni=G?dt+Qr:dt,is=G?Math.sin(Ni):be,Yr=G?Math.cos(Ni):Me,Ar=G?dt-Qr:dt,hs=G?Math.sin(Ar):be,Hs=G?Math.cos(Ar):Me,Vr=G?wt:T(tr+Di),hi=G?Ct:Math.sin(Vr),Kr=G?we:Math.cos(Vr),br=G?wt:T(tr-Di),xi=G?Ct:Math.sin(br),gn=G?we:Math.cos(br);let Vo=0,zo=0,Hn=0;{const ei=0*ar,lo=G?te:_*(1-ei)+v*ei,ha=G?ve:lo,ol=G?b*(1-ei)+x*ei:Fe,ce=G?dt:h*(1-ei)+p*ei,ji=G?be:Math.sin(ce),sp=G?Me:Math.cos(ce),co=G?T(ei):wt,np=G?Math.sin(co):Ct,tt=G?Math.cos(co):we,Ic=l+Ze(lo,ol,ha);Vo=sp*tt*Ic,zo=ji*tt*Ic,Hn=np*Ic}let qn=0,ds=0,Wn=0;{const ei=1*ar,lo=G?te:_*(1-ei)+v*ei,ha=G?ve:lo,ol=G?b*(1-ei)+x*ei:Fe,ce=G?dt:h*(1-ei)+p*ei,ji=G?be:Math.sin(ce),sp=G?Me:Math.cos(ce),co=G?T(ei):wt,np=G?Math.sin(co):Ct,tt=G?Math.cos(co):we,Ic=l+Ze(lo,ol,ha);qn=sp*tt*Ic,ds=ji*tt*Ic,Wn=np*Ic}for(let ei=1;ei<I-1;ei+=pt){let lo=0,ha=0,ol=0;{const al=(ei+1)*ar,Pc=G?te:_*(1-al)+v*al,Hf=G?ve:Pc,ho=G?b*(1-al)+x*al:Fe,xs=G?dt:h*(1-al)+p*al,r_=G?be:Math.sin(xs),wb=G?Me:Math.cos(xs),xb=G?T(al):wt,TS=G?Math.sin(xb):Ct,Tb=G?Math.cos(xb):we,i_=l+Ze(Pc,ho,Hf);lo=wb*Tb*i_,ha=r_*Tb*i_,ol=TS*i_}const ce=lo,ji=ha,sp=ol,co=qn,np=ds,tt=Wn;qn=ce,ds=ji,Wn=sp;{const al=Li+ei,Pc=al*U,Hf=co-A,ho=np-M,xs=tt-P;N[Pc]=Hf,N[Pc+1]=ho,N[Pc+2]=xs,Ud(Hf,ho,xs,S);const r_=ei*ar;Ef(X,al,G?bt:r_,G?r_:Pt)}const Ic=Vo,uo=zo,_b=Hn;Vo=co,zo=np,Hn=tt;const vb=co,Bl=np,zg=tt,bb=1/Math.sqrt(vb*vb+Bl*Bl+zg*zg),rr=zg*bb;let e_=0,Bg=0,t_=0;if(fr&&rr*rr<.999){let al=0,Pc=0,Hf=0;{const ho=Z===0?-1:1;al=ho*(ce-Ic),Pc=ho*(ji-uo),Hf=ho*(sp-_b)}{const ho=ei*ar,xs=G?te:_*(1-ho)+v*ho,r_=G?ve:xs,wb=G?b*(1-ho)+x*ho:Fe,xb=G?dt:h*(1-ho)+p*ho,TS=G?be:Math.sin(xb),Tb=G?Me:Math.cos(xb),i_=G?T(ho):wt,W$=G?Math.sin(i_):Ct,Gl=G?Math.cos(i_):we;let $O=vb,LO=Bl,q=zg;if(z){const ge=l+_s(r_-er,wb-lr,je),Ce=G?Gl:gn;$O=(G?Hs:Tb)*Ce*ge,LO=(G?hs:TS)*Ce*ge,q=(G?W$:xi)*ge}{const ge=l+_s(xs+er,wb+lr,g),Ce=G?Gl:Kr,mr=(G?Yr:Tb)*Ce*ge,yn=(G?is:TS)*Ce*ge,Fi=(G?W$:hi)*ge;z||($O=2*vb-mr,LO=2*Bl-yn,q=2*zg-Fi);const ll=Z===3?-1:1,Sb=ll*($O-mr),tse=ll*(LO-yn),rse=ll*(q-Fi);e_=Hf*tse-Pc*rse,Bg=al*rse-Hf*Sb,t_=Pc*Sb-al*tse;const o9=1/Math.sqrt(e_*e_+Bg*Bg+t_*t_);e_*=o9,Bg*=o9,t_*=o9}}}else e_=vb*bb,Bg=Bl*bb,t_=zg*bb;yt.setNormalFromValues(ei,e_,Bg,t_)}})()}}function SNe(t){$Ne(t)}function ENe(t,e){return Math.PI/2-2*Math.atan(Math.exp(-t/e))}function YRt(t,e,r,i){return ENe(t*(1-i)+e*i,r)}function JRt(t,e,r){return t*(1-r)+e*r}function Bie(t){const e=t.tile;if(e.surface.isWebMercator){const i=e.extent,s=e.ellipsoid.radius;return n=>YRt(i[1],i[3],s,n)}const r=e.extentInRadians;return i=>JRt(r[1],r[3],i)}function QRt(t,e){const r=t.tile.extent,i=t.geometryState,s=r[0],n=r[1],o=r[2]-s,a=r[3]-n,l=i.clippingArea,c=l!=null?Math.max(0,(l[0]-s)/o):0,h=l!=null?Math.max(0,(l[1]-n)/a):0,p=l!=null?Math.min(1,(l[2]-s)/o):1,f=l!=null?Math.min(1,(l[3]-n)/a):1,m=i.numVerticesPerSide,g=(m-2)**2,_=i.neighborData.edgeResolutions.reduce((T,S)=>T+S+1,0),v=aNe(g+_),b=t.geometry,x=b.boundingBox;Gi(x),b.numVerticesPerSide=i.numVerticesPerSide,b.vertexAttributes=v,zi(b.uvRange,c,h,p,f),KRt(t),INe(t,g),CNe(t),MNe(b,i.numVerticesPerSide,[],[0,m-1],[0,m-1],i.wireframe),t.intersectionData=null}function KRt(t){const e=t.tile;if(!e.intersectsClippingArea)return;const r=e.surface,i=t.geometryState,s=i.samplerData,n=t.localOrigin,o=r.isWebMercatorOnPlateeCarree,a=i.clippingArea,l=a??Gie,c=e.extent,h=c[0],p=c[1],f=c[2],m=c[3],g=Math.max(h,l[0]),_=Math.min(f,l[2]),v=Math.max(p,l[1]),b=Math.min(m,l[3]),x=e.ellipsoid.radius,T=e.horizontalScale,S=i.numVerticesPerSide,O=S-1,A=S-2,M=t.geometry,P=M.vertexAttributes,F=P.position,$=P.uv0,{typedBuffer:N,typedBufferStride:U}=P.normalCompressed,X=M.uvRange,Z=X[0],G=X[1],ee=X[2],I=X[3],V=M.boundingBox,z=n[0],H=n[1],Y=n[2],te=F.typedBuffer,ne=F.typedBufferStride;let ve=0;const Fe=ye(p,v,b),bt=o?(Math.PI/2-2*Math.atan(Math.exp(-Fe/x)))*x:Fe*T,Pt=1/O,dt=ye(p*(1-Pt)+m*Pt,v,b);let wt=bt,be=o?(Math.PI/2-2*Math.atan(Math.exp(-dt/x)))*x:dt*T;for(let Me=1;Me<=A;Me++){const Ct=Me/O,we=ye(p*(1-Ct)+m*Ct,v,b),je=ye(Ct,G,I),Ze=be,yt=(Me-1)/O,pt=ye(p*(1-yt)+m*yt,v,b),He=wt,Tt=(Me+1)/O,fr=ye(p*(1-Tt)+m*Tt,v,b),ar=o?(Math.PI/2-2*Math.atan(Math.exp(-fr/x)))*x:fr*T,Li=ye(Tt,G,I);wt=be,be=ar;const ot=ye(h,g,_);let at=ot*T,_t=_s(ot,we,s);const er=1/O,lr=ye(er,Z,ee),Qr=ye(h*(1-lr)+f*lr,g,_);let Di=lr,tr=Qr,Ni=Qr*T,is=_s(Qr,we,s);if(Me===1){const Yr=Ni-z,Ar=wt-H,hs=is-Y,Hs=0*ne;te[Hs]=Yr,te[Hs+1]=Ar,te[Hs+2]=hs,Ud(Yr,Ar,hs,V);const Vr=ye(er,Z,ee);Ef($,ve,Vr,je)}for(let Yr=1;Yr<=A;Yr++){const Ar=Ni,hs=is,Hs=(Yr+1)/O,Vr=ye(Hs,Z,ee),hi=ye(h*(1-Hs)+f*Hs,g,_),Kr=tr;tr=hi;{const ds=ve+1,Wn=ds*ne;if(Me===1||Yr===A){const ei=hi*T,lo=_s(hi,we,s);if(Me===1&&Yr<A){const ha=ei-z,ol=Ze-H,ce=lo-Y;te[Wn]=ha,te[Wn+1]=ol,te[Wn+2]=ce,Ud(ha,ol,ce,V),Ef($,ds,Vr,je)}Ni=ei,is=lo}else Ni=te[Wn]+z,is=te[Wn+2]+Y}const br=Ni,xi=is,gn=at,Vo=_t;at=Ar,_t=hs;const zo=(ve-A)*ne,Hn=Me===1?_s(Kr,pt,s):te[zo+2]+Y,qn=_s(Kr,fr,s);if(Me<A){const ds=ve+A,Wn=ds*ne,ei=Ar-z,lo=ar-H,ha=qn-Y;te[Wn]=ei,te[Wn+1]=lo,te[Wn+2]=ha,Ud(ei,lo,ha,V);const ol=Di;Di=Vr,Ef($,ds,ol,Li)}{const ds=br-gn,Wn=He-ar,ei=Wn*(xi-Vo),lo=ds*(Hn-qn),ha=-Wn*ds,ol=ei*ei+lo*lo+ha*ha;if(ol===0)YT(N,ve,0,0,1,U);else{const ce=1/Math.sqrt(ol);YT(N,ve,ei*ce,lo*ce,ha*ce,U)}}++ve}}}function e3t(t,e){t.tile.intersectsClippingArea&&(ONe(t),ANe(t,!0),t9(t))}function t3t(t,e){t.tile.intersectsClippingArea&&(CNe(t),t9(t))}function CNe(t,e){t.tile.intersectsClippingArea&&(ONe(t),ANe(t,!1))}function ANe(t,e){const r=t.geometryState,i=r.neighborData,s=t.tile,n=s.surface,o=s.extent,a=r.clippingArea,l=a??Gie,c=o[0],h=o[2],p=o[1],f=o[3],m=[f>l[3],h>l[2],p<l[1],c<l[0]],g=t.geometry,_=s.horizontalScale,v=RNe(n.isWebMercatorOnPlateeCarree,s.ellipsoid.radius,_),b=g.boundingBox,x=g.uvRange[0],T=g.uvRange[1],S=g.uvRange[2],O=g.uvRange[3],A=Math.max(c,l[0]),M=Math.min(h,l[2]),P=Math.max(p,l[1]),F=Math.min(f,l[3]),$=t.localOrigin,N=$[0],U=$[1],X=$[2],Z=r.samplerData;for(let G=0;G<4;++G){const ee=G===1||G===3,I=i.edgeResolutions[G];Se(OT(I));const V=I+1,z=m[G],H=Nx(s,i.edgePeerNeighbors[G]);if(!z&&LNe(s,H,G)){PNe(t,G,H);continue}const Y=H!=null&&!z,te=H?.renderData,ne=te?.geometryState;if(Nn&&(Se(!Y||H.level===s.level),Se(!Y||w0(s,H)<=0),s&&!H&&!n.updatingRootTiles)){const ot=eg[G],at=s.findNeighborTile(ot,_t=>_t.isLoaded||_t.isLeaf||_t.level===s.level);n.updatingRootTiles||(at?at.intersectsClippingArea&&(Se(!at.isLoaded),Se(!at.isLeaf),Se(at.level===s.level)):Se(n?.rootTiles==null||!s.shouldHaveNeighbor(ot)))}const ve=ye(G===1?h:c,A,M),Fe=ye(G===0?f:p,P,F),bt=ne?.samplerData,Pt=g.outerEdges[G],dt=e&&V>3?V-3:1,wt=ye(G===1?1:0,x,S),be=ye(G===0?1:0,T,O),Me=Y?(ot,at)=>.5*(_s(ot,at,bt)+_s(ot,at,Z)):(ot,at)=>_s(ot,at,Z),Ct=(h-c)/I,we=ee?G===1?Ct:-Ct:0,je=ee?0:G===0?Ct:-Ct,Ze=-we,yt=-je;let pt=0,He=0,Tt=0;{const ot=0/I,at=ee?ve:ye(c*(1-ot)+h*ot,A,M),_t=ee?ye(p*(1-ot)+f*ot,P,F):Fe,er=Me(at,_t);pt=at*_,He=v(_t),Tt=er}let fr=0,ar=0,Li=0;{const ot=1/I,at=ee?ve:ye(c*(1-ot)+h*ot,A,M),_t=ee?ye(p*(1-ot)+f*ot,P,F):Fe,er=Me(at,_t);fr=at*_,ar=v(_t),Li=er}for(let ot=1;ot<V-1;ot+=dt){const at=ot/I,_t=fr,er=ar,lr=Li;{const Vr=ee?wt:ye(at,x,S),hi=ee?ye(at,T,O):be,Kr=_t-N,br=er-U,xi=lr-X;Ud(_t,br,xi,b),Pt.setVertexFromValuesRawPositionUV(ot,Kr,br,xi,Vr,hi)}{const Vr=(ot+1)/I,hi=ee?ve:ye(c*(1-Vr)+h*Vr,A,M),Kr=ee?ye(p*(1-Vr)+f*Vr,P,F):Fe,br=Me(hi,Kr);fr=hi*_,ar=v(Kr),Li=br}const Qr=fr,Di=Li,tr=pt,Ni=He,is=Tt;pt=_t,He=er,Tt=lr;let Yr=0,Ar=0,hs=0;if(ee){const Vr=ar-er,hi=Di-lr,Kr=Ni-er,br=is-lr,xi=ye(p*(1-at)+f*at,P,F),gn=ve+Ze,Vo=gn*_-_t,zo=_s(gn,xi,Z)-lr,Hn=G===3?-1:1;if(Yr=Hn*(-Kr+Vr)*zo,Ar=Hn*Vo*(-br+hi),hs=-Hn*Vo*(-Kr+Vr),Y){const qn=ve+we,ds=qn*_-_t;Yr=(-Kr+Vr)*(zo-(_s(qn,xi,bt)-lr)),Ar=(Vo-ds)*(-br+hi),hs=-(Vo-ds)*(-Kr+Vr)}}else{const Vr=Qr-_t,hi=Di-lr,Kr=tr-_t,br=is-lr,xi=ye(c*(1-at)+h*at,A,M),gn=Fe+yt,Vo=_s(xi,gn,Z)-lr,zo=v(gn)-er,Hn=G===2?-1:1;if(Yr=Hn*zo*(-br+hi),Ar=Hn*(-Kr+Vr)*Vo,hs=-Hn*zo*(-Kr+Vr),Y){const qn=xi,ds=Fe+je,Wn=v(ds)-er;Yr=(-zo+Wn)*(-br+hi),Ar=(-Kr+Vr)*(-Vo+(_s(qn,ds,bt)-lr)),hs=-(-zo+Wn)*(-Kr+Vr)}}const Hs=1/Math.sqrt(Yr*Yr+Ar*Ar+hs*hs);Pt.setNormalFromValues(ot,Yr*Hs,Ar*Hs,hs*Hs)}}}function ONe(t,e){$Ne(t)}function r3t(t,e){return(Math.PI/2-2*Math.atan(Math.exp(-t/e)))*e}function i3t(t,e){return t*e}function RNe(t,e,r){return t?i=>r3t(i,e):i=>i3t(i,r)}function MNe(t,e,r,i,s,n){const o=e-1,a=t.vertexAttributes.count,l=2*(Math.min(e-2,i[1])-Math.max(1,i[0]))*(Math.min(e-2,s[1])-Math.max(1,s[0])),c=eg.map((T,S)=>S===0&&s[1]<e-2||S===1&&i[1]<e-2||S===2&&s[0]>1||S===3&&i[0]>1),h=t.outerEdges.reduce((T,S,O)=>T+(c[O]?0:o-2+S.count-1),0),p=r.reduce((T,S)=>T+o*(2*(S.latitudeResolution-1)+1),0),f=n?2:1,m=3*(l+h+p)*f,g=a>=HRt?new Uint32Array(m):new Uint16Array(m);let _=0;const v=e-2,b=o-2;Se(b>=0);const x=(T,S,O,A,M,P)=>{const F=T*M,$=P[F],N=P[F+1],U=P[F+2],X=S*M,Z=P[X],G=P[X+1],ee=P[X+2],I=O*M,V=P[I],z=P[I+1],H=P[I+2],Y=A*M,te=P[Y],ne=P[Y+1],ve=P[Y+2];return(Z-te)*(Z-te)+(G-ne)*(G-ne)+(ee-ve)*(ee-ve)>($-V)*($-V)+(N-z)*(N-z)+(U-H)*(U-H)};if(n){const T=(O,A,M)=>{g[_++]=O,g[_++]=A,g[_++]=A,g[_++]=M,g[_++]=M,g[_++]=O,Nn&&(Se(O<a),Se(A<a),Se(M<a),Se(_<=m))};(()=>{for(let O=Math.max(s[0],1)-1;O<Math.min(s[1],e-2)-1;++O){const A=O*v;for(let M=Math.max(i[0],1)-1;M<Math.min(i[1],e-2)-1;++M){const P=O*v+M,F=P+1,$=F+v,N=$-1,U=A+M,X=U+1,Z=X+v,G=Z-1,ee=t.vertexAttributes.position.typedBuffer,I=t.vertexAttributes.position.typedBufferStride;x(U,X,Z,G,I,ee)?(T(P,F,$),T($,N,P)):(T(P,F,N),T(N,$,F))}}})(),Se(_===3*l*f),(()=>{for(let O=0;O<4;++O){const A=_;if(c[O])continue;const M=t.outerEdges[O],P=t.innerEdges[O];let F=0,$=0;const N=M.count,U=P.count;Se(U===o-1);let X=0;const Z=O===1||O===2?(G,ee,I)=>T(G,ee,I):(G,ee,I)=>T(G,I,ee);for(;F<N-1||$<U-1;){const G=P.getVertexIndex($),ee=M.getVertexIndex(F),I=F<N-1,V=$<U-1;I&&(!V||(I?0+o*(F+.5)/(N-1):0)<=(V?1+b*($+.5)/(U-1):0))?(++F,Nn&&Se(F<N),Z(G,ee,M.getVertexIndex(F)),X++):(++$,Nn&&Se($<U),Z(G,ee,P.getVertexIndex($)),X++)}Nn&&(Se(F===N-1),Se($===U-1),Se(X===N+U-2),Se(X===o-2+M.count-1),Se(_===A+3*X*f))}})(),Se(_===3*(l+h)*f);const S=O=>{const A=t.outerEdges[O.connectedOuterEdgeOffset];let M=A.getVertexIndex(0),P=A.stride;for(let F=0;F<O.latitudeResolution;++F){const $=F===0?O.rowOffset:M+e;for(let N=0;N<o;N++)T(M,M+1,$+N),F<O.latitudeResolution-1&&T(M+1,$+N+1,$+N),M+=P;M=$,P=1}};r.forEach(S)}else{(()=>{const S=Math.max(s[0],1)-1,O=Math.min(s[1],e-2)-1,A=Math.max(i[0],1)-1,M=Math.min(i[1],e-2)-1;for(let P=S;P<O;++P){const F=P*v;for(let $=A;$<M;++$){const N=F+$,U=N+1,X=U+v,Z=X-1,G=t.vertexAttributes.position.typedBuffer,ee=t.vertexAttributes.position.typedBufferStride;x(N,U,X,Z,ee,G)?(g[_]=N,g[_+1]=U,g[_+2]=X,g[_+3]=X,g[_+4]=Z,g[_+5]=N):(g[_]=N,g[_+1]=U,g[_+2]=Z,g[_+3]=Z,g[_+4]=U,g[_+5]=X),_+=6}}})(),Se(_===3*l*f),(()=>{for(let S=0;S<4;++S){if(c[S])continue;const O=t.outerEdges[S],A=t.innerEdges[S];let M=0,P=0;const F=O.count,$=A.count;Se($===o-1);const N=S===1||S===2,U=N?1:2,X=N?2:1,Z=O.index0,G=O.stride,ee=A.index0,I=A.stride;for(;M<F-1||P<$-1;){const V=ee+P*I,z=Z+M*G,H=M<F-1,Y=P<$-1,te=H&&(!Y||(H?0+o*(M+.5)/(F-1):0)<=(Y?1+b*(P+.5)/($-1):0));te?++M:++P;const ne=te?z+G:V+I;g[_]=V,g[_+U]=z,g[_+X]=ne,_+=3}}})(),Se(_===3*(l+h)*f);const T=S=>{const O=t.outerEdges[S.connectedOuterEdgeOffset];let A=O.getVertexIndex(0),M=O.stride;for(let P=0;P<S.latitudeResolution;++P){const F=P===0?S.rowOffset:A+e;for(let $=0;$<o;$++){const N=F+$;g[_]=A,g[_+1]=A+1,g[_+2]=N,P<S.latitudeResolution-1?(g[_+3]=A+1,g[_+4]=N+1,g[_+5]=N,_+=6):_+=3,A+=M}A=F,M=1}};r.forEach(T)}Se(_===m),t.indices=g,t.indexCount=m}function INe(t,e){const r=t.localOrigin,i=t.geometry,s=t.geometryState.neighborData.edgeResolutions,n=i.numVerticesPerSide-2,o=i.vertexAttributes;let a=e;for(let l=0;l<4;++l){{const c=l===0||l===2,h=(l===0?n-1:0)*n+(l===1?n-1:0),p=(c?0:1)*n+(c?1:0);i.innerEdges[l]=new zme(o,r,h,p,n)}{const c=a,h=s[l]+1;i.outerEdges[l]=new zme(o,r,c,1,h),a+=h}}}function PNe(t,e,r){const i=(e+2)%4,s=t.geometryState,n=t.tile,o=s.neighborData,a=n.level-r.level,l=e===1||e===3,c=o.edgeResolutions[e];Se(OT(c));const h=c+1,p=t.geometry,f=p.boundingBox,m=p.outerEdges[e],g=p.uvRange[0],_=p.uvRange[1],v=p.uvRange[2],b=p.uvRange[3],x=ye(e===1?1:0,g,v),T=ye(e===0?1:0,_,b),S=r.renderData,O=S.geometryState,A=S.geometry.outerEdges[i],M=n.getNeighborEdgeStartVertexIndex(e,r)*c,P=c*2**a;Se(O.neighborData.edgeResolutions[i]===P),Se(A.count-1===P);const F=S.localOrigin[0]-t.localOrigin[0],$=S.localOrigin[1]-t.localOrigin[1],N=S.localOrigin[2]-t.localOrigin[2],U=m.attributes,X=m.index0,Z=m.stride,G=U.position.typedBuffer,ee=U.position.typedBufferStride,I=U.normalCompressed.typedBuffer,V=U.normalCompressed.typedBufferStride,z=U.uv0,H=A.attributes,Y=A.index0,te=A.stride,ne=H.position.typedBuffer,ve=H.position.typedBufferStride,Fe=H.normalCompressed.typedBuffer,bt=H.normalCompressed.typedBufferStride;for(let Pt=1;Pt<h-1;++Pt){const dt=X+Z*Pt,wt=Y+te*(M+Pt),be=dt*ee,Me=wt*ve,Ct=ne[Me]+F,we=ne[Me+1]+$,je=ne[Me+2]+N;G[be]=Ct,G[be+1]=we,G[be+2]=je,Ud(Ct,we,je,f);const Ze=dt*V,yt=wt*bt;I[Ze]=Fe[yt],I[Ze+1]=Fe[yt+1];const pt=Pt/c,He=l?x:ye(pt,g,v),Tt=l?ye(pt,_,b):T;Ef(z,dt,He,Tt)}}function $Ne(t){const e=t.geometryState,r=e.neighborData,i=t.localOrigin,s=r.cornerNeighborData,n=t.geometry,o=n.outerEdges,a=n.boundingBox,l=t.tile,c=t.tile.surface.view?.viewingMode==="local",h=l.ellipsoid.radius,p=l.extentInRadians,f=l.horizontalScale;let m=0,g=0,_=0;const v=(be,Me,Ct)=>{const we=p[Me===0?1:3],je=p[be===0?0:2],Ze=Math.cos(we),yt=Math.sin(we),pt=Math.sin(je),He=Math.cos(je),Tt=h+Ct;m=He*Ze*Tt,g=pt*Ze*Tt,_=yt*Tt},b=c?(()=>{const be=t.geometryState.clippingArea,Me=l.extent,Ct=be!=null&&(Me[3]>be[3]||Me[2]>be[2]||Me[1]<be[1]||Me[0]<be[0]),we=RNe(l.surface.isWebMercatorOnPlateeCarree,l.ellipsoid.radius,f);return(je,Ze,yt)=>{const pt=je===0?X[0]:X[2],He=Ze===0?X[1]:X[3],Tt=Ct?ye(pt,be[0],be[2]):pt,fr=Ct?ye(He,be[1],be[3]):He,ar=yt;m=Tt*f,g=we(fr),_=ar}})():v;let x=0,T=0,S=0,O=0,A=0,M=0,P=0,F=0,$=0;const N=c&&t.tile.surface.isWebMercatorOnPlateeCarree,U=(be,Me,Ct,we,je)=>{let Ze=0,yt=0,pt=0;if(c){const He=Me*f,Tt=N?(Math.PI/2-2*Math.atan(Math.exp(-Ct/h)))*h:Ct*f;Ze=He-m,yt=Tt-g,pt=we-_}else{const He=Bie(be),Tt=be.tile,fr=Tt.extent,ar=Tt.extentInRadians,Li=(Me-fr[0])/(fr[2]-fr[0]),ot=(Ct-fr[1])/(fr[3]-fr[1]),at=ar[0]*(1-Li)+ar[2]*Li,_t=He(ot),er=Math.cos(_t),lr=Math.sin(_t),Qr=Math.sin(at),Di=Math.cos(at),tr=h+we;Ze=Di*er*tr-m,yt=Qr*er*tr-g,pt=lr*tr-_}switch(je){case 0:P+=Ze,F+=yt,$+=pt;break;case 1:O-=Ze,A-=yt,M-=pt;break;case 2:P-=Ze,F-=yt,$-=pt;break;case 3:O+=Ze,A+=yt,M+=pt}},X=l.extent,Z=e.clippingArea,G=Z??Gie,ee=X[0],I=X[2],V=X[1],z=X[3],H=[z>G[3],I>G[2],V<G[1],ee<G[0]],Y=Math.max(ee,G[0]),te=Math.min(I,G[2]),ne=Math.max(V,G[1]),ve=Math.min(z,G[3]),Fe=n.uvRange[0],bt=n.uvRange[1],Pt=n.uvRange[2],dt=n.uvRange[3],wt=be=>{const Me=s[be].cornerTiles;x=0,T=0,S=1,O=0,A=0,M=0,P=0,F=0,$=0;let Ct=1/0;for(let He=0;He<4;++He)Ct=Math.min(Ct,Me[He]?.level??1/0);for(let He=0;He<4;++He){const Tt=Me[He];jR[He]=Tt?.level===Ct?Tt:null}let we=1,je=0;for(let He=0;He<4;++He){const Tt=jR[He];Tt&&(we=Math.max(we,Tt?.renderData.geometryState.numVerticesPerSide),je=Tt.extent[2]-Tt.extent[0])}const Ze=je,yt=we;Se(yt>1);const pt=Ze/yt;for(let He=0;He<4;++He){const Tt=jR[(He+3)%4],fr=jR[He%4];if(!Tt&&!fr)continue;const ar=He===0?1:He===1?2:He===2?3:0,Li=He===0?2:He===1?3:He===2?0:1;if(Tt&&fr){const ot=KG[He][0]*pt,at=KG[He][1]*pt,_t=Tt.extent,er=_t[ar===0||ar===1?2:0]+ot,lr=_t[ar===0||ar===3?3:1]+at,Qr=fr.extent,Di=Qr[Li===0||Li===1?2:0]+ot,tr=Qr[Li===0||Li===3?3:1]+at,Ni=Tt.renderData,is=fr.renderData,Yr=_s(er,lr,Ni.geometryState.samplerData),Ar=_s(Di,tr,is.geometryState.samplerData);U(Ni,er,lr,.5*(Yr+Ar),He)}else{const ot=Tt??fr,at=Tt?ar:Li,_t=ot.extent,er=KG[He],lr=_t[at===0||at===1?2:0]+er[0]*pt,Qr=_t[at===0||at===3?3:1]+er[1]*pt,Di=ot.renderData,tr=_s(lr,Qr,Di.geometryState.samplerData);U(Di,lr,Qr,tr,He)}}if(!c){const He=Math.sqrt(m*m+g*g+_*_);x=m/He,T=g/He,S=_/He}if(c||S*S<.999){const He=Math.sqrt(O*O+A*A+M*M);O/=He,A/=He,M/=He;const Tt=Math.sqrt(P*P+F*F+$*$);P/=Tt,F/=Tt,$/=Tt,x=M*F-A*$,T=O*$-M*P,S=A*P-O*F;const fr=1/Math.sqrt(x*x+T*T+S*S);x*=fr,T*=fr,S*=fr}};for(let be=0;be<4;++be){const Me=be,Ct=(be+1)%4,we=be===0||be===1?1:0,je=be===0||be===3?1:0,Ze=ye(we,Fe,Pt),yt=ye(je,bt,dt),pt=o[Me],He=be===0||be===3?pt.count-1:0,Tt=o[Ct],fr=be===0||be===1?Tt.count-1:0,ar=s[be].cornerTiles;let Li=-1;for(let _t=0;_t<4;++_t){const er=ar[_t];er&&(Li===-1||w0(ar[Li],er)>0)&&(Li=_t)}const ot=Li,at=ar[ot];if(at!==l){const _t=l.level-at.level,er=2**_t,lr=[at.lij[0]+_t,at.lij[1]*er,at.lij[2]*er],Qr=[lr[1]+er===l.lij[1],be===0&&(ot===1||ot===0&&at!==ar[3])||be===1&&(ot===0||ot===1&&at!==ar[2]),lr[1]===l.lij[1]+1,be===2&&(ot===3||ot===2&&at!==ar[1])||be===3&&(ot===2||ot===3&&at!==ar[0])],Di=Qr.reduce((Ar,hs)=>Ar+(hs?1:0),0);Se(Di===1||Di===2);let tr=-1,Ni=-1;const is=at.renderData;if(Di===1){const Ar=Qr.findIndex(Hs=>Hs);Se(0<=Ar&&Ar<=3),tr=(Ar+2)%4;const hs=t.geometryState.neighborData.edgeResolutions[Ar];Ni=l.getNeighborEdgeStartVertexIndex(Ar,at)*hs+hs*(Ar===0&&be===0||Ar===1&&be===0||Ar===2&&be===1||Ar===3&&be===3?1:0)}else{Se(Qr[1]||Qr[3]),tr=Qr[1]?3:1;const Ar=is.geometryState.neighborData.edgeResolutions[tr];Ni=be===0||be===3?0:Ar}const Yr=is.geometry.outerEdges[tr];{const Ar=pt.index0+He*pt.stride,hs=Tt.index0+fr*Tt.stride,Hs=Yr.index0+Ni*Yr.stride;{const Vr=Yr.attributes.position,hi=Vr.typedBuffer,Kr=Hs*Vr.typedBufferStride,br=t.localOrigin,xi=Yr.localOrigin,gn=hi[Kr]+xi[0]-br[0],Vo=hi[Kr+1]+xi[1]-br[1],zo=hi[Kr+2]+xi[2]-br[2];Ud(gn,Vo,zo,a);{const Hn=pt.attributes.position,qn=Hn.typedBuffer,ds=Ar*Hn.typedBufferStride;qn[ds]=gn,qn[ds+1]=Vo,qn[ds+2]=zo}{const Hn=Tt.attributes.position,qn=Hn.typedBuffer,ds=hs*Hn.typedBufferStride;qn[ds]=gn,qn[ds+1]=Vo,qn[ds+2]=zo}}Ef(pt.attributes.uv0,Ar,Ze,yt),Ef(Tt.attributes.uv0,hs,Ze,yt);{const Vr=Yr.attributes.normalCompressed.typedBuffer,hi=Hs*Yr.attributes.normalCompressed.typedBufferStride;{const Kr=pt.attributes.normalCompressed,br=Kr.typedBuffer,xi=Ar*Kr.typedBufferStride;br[xi]=Vr[hi],br[xi+1]=Vr[hi+1]}{const Kr=Tt.attributes.normalCompressed,br=Kr.typedBuffer,xi=hs*Kr.typedBufferStride;br[xi]=Vr[hi],br[xi+1]=Vr[hi+1]}}}}else{const _t=H[Me],er=H[Ct];let lr;if(_t||er){const Ni=ye(ee*(1-we)+I*we,Y,te),is=ye(V*(1-je)+z*je,ne,ve),Yr=e.samplerData;lr=_s(Ni,is,Yr)}else lr=s3t(ar);b(we,je,lr),wt(be);const Qr=m-i[0],Di=g-i[1],tr=_-i[2];Ud(Qr,Di,tr,a),pt.setVertexFromValuesRawPositionUVNormal(He,Qr,Di,tr,Ze,yt,x,T,S),Tt.setVertexFromValuesRawPositionUVNormal(fr,Qr,Di,tr,Ze,yt,x,T,S)}}for(let be=0;be<4;++be)jR[be]=null}function s3t(t){const e=t.reduce((n,o)=>Math.min(n,o?.level??1/0),1/0);Nn&&(Se(!t[0]||!t[2]||sJ(t[0],t[2],ct.SOUTH_WEST)),Se(!t[1]||!t[3]||sJ(t[1],t[3],ct.NORTH_WEST)));let r=0,i=0;for(let n=0;n<4;++n){const o=t[n];if(o&&o.level===e){const a=n===0||n===1,l=n===0||n===3,c=o.extent,h=c[a?0:2],p=c[l?1:3],f=o.renderData?.geometryState?.samplerData;i+=_s(h,p,f),r++}}const s=r?i/r:0;return Se(s!=null),s}function t9(t){const e=t.vao,r=t.geometry.vertexAttributes.position.typedBuffer;e.vertexBuffers.geometry.setSubData(r,0,0,r.length)}const KG=[[0,1],[1,0],[0,-1],[-1,0]],Ko=new jOt,Gie=DQ(-1/0,-1/0,1/0,1/0),jR=[null,null,null,null];function LNe(t,e,r){if(!e)return!1;const i=w0(t,e);return i>0||i===0&&r>=2}let n3t=class extends kie{get horizontalScale(){return this._horizontalScaleFactor}constructor(e,r,i){super(),this._horizontalScaleFactor=1,this._extentInRenderSR=Ht(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=i.view.renderSpatialReference,n=i.spatialReference,o=s!=null&&kI(s)&&n!=null&&n.isGeographic?this.ellipsoid.radius*Math.PI/180:1;this._horizontalScaleFactor=o;const a=this.surface.isWebMercatorOnPlateeCarree,l=this._extentInRenderSR,c=this.extent;if(a){const h=Ee(c[0],c[1],0);Tn(h,qe.WebMercator,h,qe.PlateCarree);const p=Ee(c[2],c[3],0);Tn(p,qe.WebMercator,p,qe.PlateCarree),l[0]=h[0],l[1]=h[1],l[2]=p[0],l[3]=p[1]}else for(let h=0;h<4;++h)l[h]=c[h]*o;this.centerAtSeaLevel[0]=.5*(l[0]+l[2]),this.centerAtSeaLevel[1]=.5*(l[1]+l[3]),this.centerAtSeaLevel[2]=0,this._edgeLen=Math.max(l[2]-l[0],l[3]-l[1]),this._edgeLen2=this._edgeLen*this._edgeLen,this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateCenter();const e=this._extentInRenderSR,r=.5*(e[2]-e[0]),i=.5*(e[3]-e[1]),s=Math.sqrt(r*r+i*i),n=.5*(this.elevationBounds[0]-this.elevationBounds[1]),o=Math.max(s,n);this._center[hn.MIDDLE][3]=o}_calculateFrustumVisibilityStatus(e){const r=this._aabb(),i=r[0],s=r[1],n=r[2],o=r[3],a=r[4],l=r[5];let c=!0;for(let h=0;h<6;h++){const p=e[h],f=p[0],m=p[1],g=p[2],_=p[3];if(f*(f>0?i:o)+m*(m>0?s:a)+g*(g>0?n:l)+_>=0)return qa.OUTSIDE;c=c&&f*(f<0?i:o)+m*(m<0?s:a)+g*(g<0?n:l)+_<=0}return c?qa.INSIDE:qa.INTERSECTS}_aabb(){const e=this._extentInRenderSR;return f7e(e[0],e[1],this.elevationBounds[0],e[2],e[3],this.elevationBounds[1])}intersectsRay(e,r,i,s){return eF[0]=1/r[0],eF[1]=1/r[1],eF[2]=1/r[2],Lre(this._aabb(),e,eF,i,s)}createGeometry(){QRt(this.renderData,this._horizontalScaleFactor),this.setMemoryDirty()}getDefaultVerticesPerSide(){return this.level<9?3:2}updateCornerElevations(){e3t(this.renderData,this._horizontalScaleFactor)}updateEdgeElevations(){t3t(this.renderData,this._horizontalScaleFactor)}};const eF=C();let o3t=class{constructor(){this.extent=Qt(),this.minLevel=0,this.maxLevel=0,this.callback=null}},b5=class extends me{constructor(){super(...arguments),this._queries=new qt({initialSize:10}),this._queriesInvPtr=0,this._queryQueue=new qt({initialSize:30}),this._queryPool=new $o(o3t)}queryVisibleLevelRange(e,r,i,s){const n=this._queryPool.acquire();Id(n.extent,e),n.minLevel=r??-Number.MAX_VALUE,n.maxLevel=i??Number.MAX_VALUE,n.callback=s,this._queryQueue.push(n),this.notifyChange("updating")}get updating(){return this._queryQueue.length!==0}prepare(){for(;this._queries.length<this._queries.data.length&&this._queryQueue.length>0;){const e=this._queryQueue.pop();this._queries.push(e)}this._queriesInvPtr=this._queries.length}process(){for(let e=0;e<this._queries.length;e++){const r=this._queries.data[e];this._queryPool.release(r),r.callback(e>=this._queriesInvPtr),r.callback=null}this._queries.clear(),this.notifyChange("updating")}queriesForTile(e){const r=e.level;let i=0;for(;i<this._queriesInvPtr;){const s=this._queries.data[i],n=s.extent;r>=s.minLevel&&r<=s.maxLevel&&n[0]<=e.extent[2]&&n[2]>=e.extent[0]&&n[1]<=e.extent[3]&&n[3]>=e.extent[1]?(this._queries.swapElements(i,this._queriesInvPtr-1),this._queriesInvPtr--):i++}}};u([d()],b5.prototype,"updating",null),b5=u([R("esri.views.3d.terrain.ScaleRangeQueries")],b5);let a3t=class extends kie{get convexHull(){return this._convexHull}constructor(e,r,i){super(),this._convexHull=new Array(24),this._boundingSphere=js(),e!==void 0&&this.init(e,r,i)}init(e,r,i){super.init(e,r,i);const s=this.ellipsoid.radius,n=this.extentInRadians[0],o=this.extentInRadians[1],a=this.extentInRadians[2],l=this.extentInRadians[3],c=e[0],h=Et(o,l,.5),p=Et(n,a,.5),f=c===0?0:Math.min(Math.abs(o),Math.abs(l));this._edgeLen=(a-n)*Math.cos(f)*s,this._edgeLen2=this._edgeLen*this._edgeLen,this._curvatureHeight=s-Math.sqrt(s*s-this._edgeLen2/4),W2e(this.centerAtSeaLevel,p,h,this.ellipsoid.radius),_e(this.up,this.centerAtSeaLevel),this.updateRadiusAndCenter()}updateRadiusAndCenter(){this._updateBoundingVolumes();const e=this._center;if(this.lij[0]===0)ie(e[hn.MIDDLE],0,0,0),ie(e[hn.TOP],0,0,0),ie(e[hn.BOTTOM],0,0,0),e[hn.MIDDLE][3]=this.ellipsoid.radius+this.elevationBounds[1];else{this._updateCenter();const r=e[hn.MIDDLE],i=this.convexHull;let s=0;for(let n=0;n<8;++n)s=Math.max(s,l3t(r,i,3*n));e[hn.MIDDLE][3]=Math.sqrt(s)}}_calculateFrustumVisibilityStatus(e){if(!y1(e,this._boundingSphere))return qa.OUTSIDE;if(this.lij[0]<10)return qa.INTERSECTS;const r=this.convexHull,i=this.surface.view.state.camera.near;let s=!0;for(let n=0;n<xO;n++){const o=n===Ai.NEAR,a=e[n],l=a[0],c=a[1],h=a[2],p=a[3]-(o?i:0);let f=!1;for(let m=0;m<8;++m){const g=3*m;if(l*r[g]+c*r[g+1]+h*r[g+2]+p<0){if(f=!0,!s)break}else s=!1}if(!f)return qa.OUTSIDE}return s?qa.INSIDE:qa.INTERSECTS}computeElevationBounds(){super.computeElevationBounds(),this._updateBoundingVolumes()}createGeometry(){qRt(this.renderData,this._getPatchType()),this._updateBoundingVolumes(),this.setMemoryDirty()}_updateBoundingVolumes(){this._updateConvexHull(),this._updateBoundingSphere(),Nn&&this._checkBVs()}_updateBoundingSphere(){const e=this._boundingSphere,r=e,i=this.elevationBounds,s=this.ellipsoid.radius,n=i[1];if(this.level===0)ie(r,0,0,0),e[3]=s+n;else{const o=this.extentInRadians,a=.5*(o[0]+o[2]),l=o[1],c=o[3];aw(tge,a,l,s),aw(rge,a,c,s),ue(r,tge,rge);const h=.5*(i[0]+i[1]);ae(r,r,(s+h)/ou(r));const p=this.convexHull;let f=0;const m=(_,v)=>{const b=_[0]-p[3*v],x=_[1]-p[3*v+1],T=_[2]-p[3*v+2];return Math.sqrt(b*b+x*x+T*T)};for(let _=0;_<8;++_){const v=m(r,_);f=Math.max(f,v)}const g=f;e[3]=g+2}}_updateConvexHull(){const e=this.extentInRadians,r=this.ellipsoid.radius;if(this.level===0)return;const i=this.elevationBounds,s=this._getPatchType(),n=this.surface.isWebMercator,o=n&&s===Sd.HAS_NORTH_POLE,a=n&&s===Sd.HAS_SOUTH_POLE,l=a||o,c=Math.PI/2,h=e[0],p=e[2],f=a?-c:e[1],m=o?c:e[3],g=.5*(h+p),_=i[0],v=r+(l?Math.min(0,_-1):_),b=(ee,I,V)=>aw(ee,I,V,v),x=C(),T=C(),S=C(),O=C();b(x,h,f),b(T,h,m),b(S,p,m),b(O,p,f);const A=(ee,I)=>{for(let V=0;V<3;++V)this._convexHull[3*I+V]=ee[V]};A(x,0),A(T,1),A(S,2),A(O,3);const M=i[1],P=r+(l?Math.max(0,M+1):M),F=C(),$=C(),N=C();aw($,g,m,v),aw(N,g,f,v),ue(F,$,N),_e(F,F);const U=C(),X=C(),Z=(ee,I)=>{Mi(X,ee,I),_e(X,X);const V=-de(ee,U)/de(X,U);Se(V>=0),ae(X,X,V),ue(ee,ee,X)};if(2**this.lij[0]>2*this.lij[1]){const ee=N,I=C();st(I,ege,ee),_e(I,I),st(U,ee,I),_e(U,U),Se(Cd(de(U,ee)/ou(ee),0)),Z(x,T),Z(O,S),A(x,0),A(O,3)}else if(2**this.lij[0]!==2*this.lij[1]){const ee=$,I=C();st(I,ege,ee),_e(I,I),st(U,I,ee),_e(U,U),Z(T,x),Z(S,O),A(T,1),A(S,2)}const G=(ee,I)=>{const V=P/de(I,F);for(let z=0;z<3;++z)this._convexHull[3*ee+z]=I[z]*V};G(4,x),G(5,T),G(6,S),G(7,O)}_getPatchType(){const e=this.lij[1],r=e===0,i=e===(1<<this.level)-1;return r?i?Sd.HAS_BOTH_POLES:Sd.HAS_NORTH_POLE:i?Sd.HAS_SOUTH_POLE:Sd.REGULAR}intersectsRay(e,r,i,s){const n=this._boundingSphere,o=n[3]+i,a=r[0]*r[0]+r[1]*r[1]+r[2]*r[2],l=n[0]-e[0],c=n[1]-e[1],h=n[2]-e[2],p=(l*r[0]+c*r[1]+h*r[2])/a,f=r[0]*p-l,m=r[1]*p-c,g=r[2]*p-h;return f*f+m*m+g*g<o*o}getDefaultVerticesPerSide(){return this.level<Kme.length?Kme[this.level]+1:2}updateCornerElevations(){XRt(this.renderData),this._updateBoundingVolumes()}updateEdgeElevations(){ZRt(this.renderData),this._updateBoundingVolumes()}_checkBVs(){if(!Nn||this.level<=2)return;const e=this._boundingSphere,r=e[3],i=e,s=C(),n=this.ellipsoid.radius,o=this.elevationBounds;o[1],o[0];const a=n+o[0],l=1,c=0,h=this._center[hn.MIDDLE][3],p=this.convexHull,f=(we,je)=>{for(let Ze=0;Ze<3;++Ze)we[Ze]=p[3*je+Ze]};{const we=C(),je=C(),Ze=C(),yt=C(),pt=C(),He=(Tt,fr,ar,Li)=>{f(je,Tt),f(Ze,fr),f(yt,ar),Mi(je,je,Ze),Mi(yt,yt,Ze),st(we,je,yt),_e(we,we);const ot=de(we,Ze);f(pt,Li);const at=de(we,pt),_t=Math.abs(at-ot);Se(Cd(_t,0),`Non coplanar ${Tt},${fr},${ar},${Li} diff = ${_t}`)};He(0,1,2,3),He(4,5,6,7),He(0,1,4,5),He(1,2,5,6),He(2,3,6,7),He(3,0,7,4)}const m=Ra(24),g=(we,je,Ze)=>{const yt=4*we;for(let pt=0;pt<3;++pt)m[yt+pt]=je[pt];m[yt+3]=Ze},_=C(),v=C(),b=C(),x=C(),T=(we,je,Ze,yt)=>{f(_,je),f(v,Ze),f(b,yt),Mi(_,_,v),_e(_,_),Mi(b,b,v),_e(b,b),st(x,_,b),_e(x,x);const pt=de(x,v);g(we,x,pt)};T(0,0,1,2),T(1,1,0,4),T(2,1,5,2),T(3,3,2,6),T(4,4,0,3),T(5,4,6,5);const S=1,O=(we,je,Ze,yt)=>{const pt=4*we;return m[pt]*je+m[pt+1]*Ze+m[pt+2]*yt-m[pt+3]},A=(we,je,Ze,yt)=>O(we,je,Ze,yt)>=-S,M=(we,je)=>A(we,je[0],je[1],je[2]),P=2**this.lij[0]>2*this.lij[1],F=(we,je,Ze)=>Math.sqrt(DNe(we,je,Ze,i[0],i[1],i[2]))<r,$=we=>F(we[0],we[1],we[2]),N=(we,je)=>F(we[je],we[je+1],we[je+2]),U=this.extentInRadians,X=.5*(U[0]+U[2]),Z=U[1],G=U[3],ee=C(),I=C();aw(ee,X,G,a),aw(I,X,Z,a);const V=P?"Upper":"Lower";let z=!0;for(let we=0;we<6;++we){for(let je=0;je<8;++je){const Ze=3*je,yt=A(we,p[Ze],p[Ze+1],p[Ze+2]);z&&(z=yt),Se(yt,`Tile[${this.lij}] Convex hull point ${je} outside of plane ${we}`)}Se(M(we,I),`Tile[${this.lij}] (${V}) bottom mid outside of plane ${we}`),Se(M(we,ee),`Tile[${this.lij}] (${V}) top mid outside of plane ${we}`)}Se(z,"Not all convex hull points are inside  convex hull polyhedron"),Se($(I),`Tile[${this.lij}] (${V}) bottom mid outside of bounding sphere`),Se($(ee),`Tile[${this.lij}] (${V}) top mid outside of bounding sphere`);for(let we=0;we<8;++we){const je=N(p,3*we);Se(je,`Tile[${this.lij}] Convex hull point ${we} outside of bounding sphere`)}for(let we=0;we<6;++we)for(let je=0;je<8;++je){const Ze=3*je;A(we,p[Ze],p[Ze+1],p[Ze+2])||console.error(`Tile[${this.lij}] Convex hull point ${je} outside of plane ${we}`)}const H=this.extentInRadians,Y=Math.max(H[2]-H[0],H[3]-H[1]),te=Math.round(Y*n),ne=this.renderData;if(!ne)return;const{geometry:ve,localOrigin:Fe}=ne,bt=ve.vertexAttributes?.position;if(!bt)return;const Pt=bt.count,dt=C(),wt=ve.numVerticesPerSide-2,be=wt*wt,Me=ne.geometryState.neighborData,Ct=Me.edgeResolutions.reduce((we,je)=>we+je+1,0);for(let we=0;we<Pt;++we){const je=we<be,Ze=!je&&we<be+Ct;let yt=!1,pt=-1;if(Ze){let tr=be;for(let Ni=0;Ni<4;++Ni){const is=Me.edgeResolutions[Ni];if(we===tr||we===tr+is-1){yt=!0;break}if(tr+=is,we<tr){pt=Ni;break}}}const He=Ze?Me.edgePeerNeighbors[pt]:null,Tt=Ze&&He&&w0(this,He)>0;bt.getVec(we,s),ue(dt,s,Fe);const fr=ou(dt)-n;let ar=0,Li=!1;const ot=o[0]-fr,at=fr-o[1],_t=ot>l,er=at>l,lr=_t||er,Qr=()=>{const tr=je?"internal":Ze&&!yt?"edge":yt?"corner":"pole";return`Tile[${this.lij}].vertex[${we}]:${tr}`+(_t?"(below)":er?"(above)":"")+(Tt?"(Neighbor)":"")},Di=YP(dt,i);if(Di>=r+c){const tr=Di-r;lr||(console.error(`${Qr()} is out of the bounding sphere by ${tr.toFixed(0)} / ${r.toFixed(0)}[tol=${c}] h=${fr.toFixed(0)} / [${o[0].toFixed(0)}..${o[1].toFixed(0)}] (${(tr/r).toFixed(0)})`),Li=!0)}for(let tr=0;tr<6;++tr)if(!A(tr,dt[0],dt[1],dt[2])){const Ni=O(tr,dt[0],dt[1],dt[2]),is=we%wt,Yr=(we-is)/wt;tr===0&&ot||tr===5&&at||(console.error(`${Qr()} (${is},${Yr})|${wt}] is out of the bounding trapezoid plane ${tr} h=${Math.round(fr)} / [${Math.round(o[0])}..${Math.round(o[1])}] dist=${Math.round(Ni)} radii = ${Math.round(r)}/${Math.round(h)}} : maxL = ${te}`),++ar)}if(Li||ar>0)break}}};const Kme=[128,64,64,32,16,8,8,4];function l3t(t,e,r){return DNe(t[0],t[1],t[2],e[r],e[r+1],e[r+2])}function DNe(t,e,r,i,s,n){const o=i-t,a=s-e,l=n-r;return o*o+a*a+l*l}const aw=(t,e,r,i)=>{const s=Math.cos(e),n=Math.sin(e),o=Math.cos(r),a=Math.sin(r);t[0]=i*o*s,t[1]=i*o*n,t[2]=i*a},ege=[0,0,1],tge=C(),rge=C();let Gp=class extends me{constructor(){super(...arguments),this.fovX=0,this.fovY=0,this.relativeWidthLimit=0,this.relativeHeightLimit=0,this.maxLod=0,this.angledSplitBias=0,this.aboveGround=!0}};u([d()],Gp.prototype,"fovX",void 0),u([d()],Gp.prototype,"fovY",void 0),u([d()],Gp.prototype,"relativeWidthLimit",void 0),u([d()],Gp.prototype,"relativeHeightLimit",void 0),u([d()],Gp.prototype,"maxLod",void 0),u([d()],Gp.prototype,"angledSplitBias",void 0),u([d()],Gp.prototype,"aboveGround",void 0),u([d()],Gp.prototype,"frustum",void 0),Gp=u([R("esri.views.3d.terrain.SplitLimits")],Gp);let NNe=class extends nl{constructor(){super(...arguments),this.blendMode=$e.Normal}};u([B({count:$e.COUNT})],NNe.prototype,"blendMode",void 0);let AI=class extends NNe{constructor(){super(...arguments),this.output=to.Composite,this.baseOpacityMode=yf.NotRequired,this.premultipliedSource=tf.Off}};u([B({count:to.COUNT})],AI.prototype,"output",void 0),u([B({count:yf.COUNT})],AI.prototype,"baseOpacityMode",void 0),u([B()],AI.prototype,"premultipliedSource",void 0);var KT;function c3t(t){const e=new Cr;if(e.include(mNe),t.background===KT.Only){const r=t.output===to.ColorComposite;return r?e.fragment.uniforms.add(new jt("backgroundColor",i=>i.backgroundColor)):e.fragment.include(Fie),e.fragment.code.add(w`
    void main() {
      fragColor = vec4(${r?w`backgroundColor`:w`gridColor(uv)`}, 1.0);
    }
  `),e}return e.include(gNe,t),e.fragment.uniforms.add(new et("tex",r=>r.texture)),e.fragment.uniforms.add(new Ie("opacity",r=>r.opacity)),e.fragment.code.add(w`void main() {
vec4 bgColor = getBackground(uv);
fragColor = blendLayers(bgColor, texture(tex, uv), opacity);
}`),e}(function(t){t[t.BelowLayer=0]="BelowLayer",t[t.Only=1]="Only",t[t.COUNT=2]="COUNT"})(KT||(KT={}));const u3t=Object.freeze(Object.defineProperty({__proto__:null,get BackgroundMode(){return KT},build:c3t},Symbol.toStringTag,{value:"Module"}));let h3t=class extends fNe{constructor(){super(...arguments),this.opacity=1,this.baseOpacity=1,this.texture=null,this.fboTexture=null,this.backgroundColor=Nl}},FNe=class kNe extends Ur{initializeProgram(e){return new Lr(e.rctx,kNe.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}};FNe.shader=new $r(u3t,()=>J(()=>import("./BlendLayers.glsl-e3f2ff78.js"),[],import.meta.url));let UNe=class extends AI{constructor(){super(...arguments),this.background=KT.BelowLayer}};u([B()],UNe.prototype,"background",void 0);let ej=class{constructor(e,r,i,s,n,o){this.texture=e,this.type=r,e.retain(),this.offsetAndScale=Vt(i.offset[0],i.offset[1],i.scale,i.scale),this.opacities=Ee(s,n,o)}destroy(){this.texture.release()}};function w5(){return[1,0,0,1,0,0]}function d3t(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}function p3t(t,e,r,i,s,n){return[t,e,r,i,s,n]}function f3t(t,e){return new Float64Array(t,e,6)}Object.freeze(Object.defineProperty({__proto__:null,clone:d3t,create:w5,createView:f3t,fromValues:p3t},Symbol.toStringTag,{value:"Module"}));function m3t(t){return t instanceof Float32Array&&t.length>=2}function g3t(t){return Array.isArray(t)&&t.length>=2}function tj(t){return m3t(t)||g3t(t)}const y3t=96,_3t=39.37;function jie(t,e){return e.type?hr(t,e.x,e.y):jn(t,e)}function v3t(t){return Uo(t)}function b3t(t,e){const r=t.targetGeometry,i=e.targetGeometry;return r.x=i.x,r.y=i.y,r.spatialReference=i.spatialReference,t.scale=e.scale,t.rotation=e.rotation,t}const w3t=function(){const t=Pe();return function(e,r,i){const s=r.targetGeometry;jie(t,s);const n=.5*r9(r);return e.xmin=t[0]-n*i[0],e.ymin=t[1]-n*i[1],e.xmax=t[0]+n*i[0],e.ymax=t[1]+n*i[1],e.spatialReference=s.spatialReference,e}}();function r9(t){return t.scale*x3t(t.targetGeometry)}function x3t(t){return t!=null&&Qa(t.spatialReference)?1/(v3t(t.spatialReference)*_3t*y3t):1}function T3t(t){return D6(t.rotation)||0}const Hie=function(){const t=Pe(),e=Pe(),r=Pe();return function(i,s,n,o,a,l){return qee(t,s),fc(e,n,.5*l),hr(r,1/o*l,-1/o*l),Pee(i,e),a&&$V(i,i,a),Iee(i,i,r),LV(i,i,t),i}}(),S3t=function(){const t=Pe();return function(e,r,i,s){const n=r9(r),o=T3t(r);return jie(t,r.targetGeometry),Hie(e,t,i,n,o,s)}}(),E3t=function(){const t=Pe();return function(e,r,i,s){const n=r9(r);return jie(t,r.targetGeometry),Hie(e,t,i,n,0,s)}}();function C3t(t){const e=T1(t);return e?e.valid[1]-e.valid[0]:0}function A3t(t,e){return Math.round(C3t(t)/e)}var oJ;const ay=[0,0];let Iv=oJ=class extends he{constructor(t){super(t),this._viewpoint2D={center:Pe(),rotation:0,scale:0,spatialReference:void 0},this.center=[0,0],this.extent=new vr,this.id=0,this.inverseTransform=w5(),this.resolution=0,this.rotation=0,this.scale=0,this.transform=w5(),this.transformNoRotation=w5(),this.displayMat3=Tc(),this.displayViewMat3=Tc(),this.viewMat3=Tc(),this.viewMat2d=Gk(),this.worldScreenWidth=0,this.size=[0,0]}set pixelRatio(t){this._set("pixelRatio",t),this._update()}set size(t){this._set("size",t),this._update()}set viewpoint(t){if(t){const e=this._viewpoint2D,r=t.targetGeometry;e.center[0]=r.x,e.center[1]=r.y,e.rotation=t.rotation,e.scale=t.scale,e.spatialReference=r.spatialReference}this._update()}copy(t){const e=this.size,r=this.viewpoint;return r&&e?(this.viewpoint=b3t(r,t.viewpoint),this._set("size",jn(e,t.size))):(this.viewpoint=t.viewpoint.clone(),this._set("size",[t.size[0],t.size[1]])),this._set("pixelRatio",t.pixelRatio),this}clone(){return new oJ({size:this.size,viewpoint:this.viewpoint.clone(),pixelRatio:this.pixelRatio})}toMap(t,e,r){return tj(e)?qw(t,e,this.inverseTransform):(ay[0]=e,ay[1]=r,qw(t,ay,this.inverseTransform))}toScreen(t,e,r){return tj(e)?qw(t,e,this.transform):(ay[0]=e,ay[1]=r,qw(t,ay,this.transform))}toScreenNoRotation(t,e,r){return tj(e)?qw(t,e,this.transformNoRotation):(ay[0]=e,ay[1]=r,qw(t,ay,this.transformNoRotation))}getScreenTransform(t,e){const{center:r}=this._viewpoint2D,i=this._get("pixelRatio")||1,s=this._get("size");return Hie(t,r,s,e,0,i),t}_update(){const{center:t,spatialReference:e,scale:r,rotation:i}=this._viewpoint2D,s=this._get("pixelRatio")||1,n=this._get("size"),o=new Nf({targetGeometry:new ht(t[0],t[1],e),scale:r,rotation:i});if(this._set("viewpoint",o),!n||!e||!r)return;this.resolution=r9(o),this.rotation=i,this.scale=r,this.spatialReference=e,jn(this.center,t);const a=n[0]!==0?2/n[0]:0,l=n[1]!==0?-2/n[1]:0;lte(this.displayMat3,a,0,0,0,l,0,-1,1,1);const c=cte(this.viewMat3),h=Ed(n[0]/2,n[1]/2),p=Ed(-n[0]/2,-n[1]/2),f=D6(i);sU(c,c,h),ute(c,c,f),sU(c,c,p),wA(this.displayViewMat3,this.displayMat3,c);const m=Pee(this.viewMat2d,h);return $V(m,m,f),LV(m,m,p),w3t(this.extent,o,n),S3t(this.transform,o,n,s),LEe(this.inverseTransform,this.transform),E3t(this.transformNoRotation,o,n,s),this.worldScreenWidth=A3t(this.spatialReference,this.resolution),this._set("id",this.id+1),this}};u([d({readOnly:!0})],Iv.prototype,"id",void 0),u([d({value:1,json:{write:!0}})],Iv.prototype,"pixelRatio",null),u([d({json:{write:!0}})],Iv.prototype,"size",null),u([d()],Iv.prototype,"spatialReference",void 0),u([d({type:Nf,json:{write:!0}})],Iv.prototype,"viewpoint",null),Iv=oJ=u([R("esri.views.2d.ViewState")],Iv);const O3t=Iv;var aJ,lJ,ige,sge,nge,oge,age,lge,cge,uge,hge,dge,pge,fge,mge,gge,yge,_ge,vge,bge,wge,xge,Tge,Sge,Ege,Cge,Age,Oge,Rge,Mge,Ige,Pge,$ge,Lge,Dge,Nge,Fge,kge,Uge,Vge,zge,Bge,Gge,jge,Hge,qge,Wge,Zge,Xge,Yge,Jge,Qge,Kge,eye,tye,rye,iye,sye,nye,oye,aye;(function(t){t[t.BUTT=0]="BUTT",t[t.ROUND=1]="ROUND",t[t.SQUARE=2]="SQUARE",t[t.UNKNOWN=4]="UNKNOWN"})(aJ||(aJ={})),function(t){t[t.BEVEL=0]="BEVEL",t[t.ROUND=1]="ROUND",t[t.MITER=2]="MITER",t[t.UNKNOWN=4]="UNKNOWN"}(lJ||(lJ={})),function(t){t[t.SCREEN=0]="SCREEN",t[t.MAP=1]="MAP"}(ige||(ige={})),function(t){t[t.Tint=0]="Tint",t[t.Ignore=1]="Ignore",t[t.Multiply=99]="Multiply"}(sge||(sge={})),function(t){t.Both="Both",t.JustBegin="JustBegin",t.JustEnd="JustEnd",t.None="None"}(nge||(nge={})),function(t){t[t.Mosaic=0]="Mosaic",t[t.Centered=1]="Centered"}(oge||(oge={})),function(t){t[t.Normal=0]="Normal",t[t.Superscript=1]="Superscript",t[t.Subscript=2]="Subscript"}(age||(age={})),function(t){t[t.MSSymbol=0]="MSSymbol",t[t.Unicode=1]="Unicode"}(lge||(lge={})),function(t){t[t.Unspecified=0]="Unspecified",t[t.TrueType=1]="TrueType",t[t.PSOpenType=2]="PSOpenType",t[t.TTOpenType=3]="TTOpenType",t[t.Type1=4]="Type1"}(cge||(cge={})),function(t){t[t.Display=0]="Display",t[t.Map=1]="Map"}(uge||(uge={})),function(t){t.None="None",t.Loop="Loop",t.Oscillate="Oscillate"}(hge||(hge={})),function(t){t[t.Z=0]="Z",t[t.X=1]="X",t[t.Y=2]="Y"}(dge||(dge={})),function(t){t[t.XYZ=0]="XYZ",t[t.ZXY=1]="ZXY",t[t.YXZ=2]="YXZ"}(pge||(pge={})),function(t){t[t.Rectangle=0]="Rectangle",t[t.RoundedRectangle=1]="RoundedRectangle",t[t.Oval=2]="Oval"}(fge||(fge={})),function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.Screen=2]="Screen",t[t.Multiply=3]="Multiply",t[t.Add=4]="Add"}(mge||(mge={})),function(t){t[t.TTB=0]="TTB",t[t.RTL=1]="RTL",t[t.BTT=2]="BTT"}(gge||(gge={})),function(t){t[t.None=0]="None",t[t.SignPost=1]="SignPost",t[t.FaceNearPlane=2]="FaceNearPlane"}(yge||(yge={})),function(t){t[t.Float=0]="Float",t[t.String=1]="String",t[t.Boolean=2]="Boolean"}(_ge||(_ge={})),function(t){t[t.Intersect=0]="Intersect",t[t.Subtract=1]="Subtract"}(vge||(vge={})),function(t){t.OpenEnded="OpenEnded",t.Block="Block",t.Crossed="Crossed"}(bge||(bge={})),function(t){t.FullGeometry="FullGeometry",t.PerpendicularFromFirstSegment="PerpendicularFromFirstSegment",t.ReversedFirstSegment="ReversedFirstSegment",t.PerpendicularToSecondSegment="PerpendicularToSecondSegment",t.SecondSegmentWithTicks="SecondSegmentWithTicks",t.DoublePerpendicular="DoublePerpendicular",t.OppositeToFirstSegment="OppositeToFirstSegment",t.TriplePerpendicular="TriplePerpendicular",t.HalfCircleFirstSegment="HalfCircleFirstSegment",t.HalfCircleSecondSegment="HalfCircleSecondSegment",t.HalfCircleExtended="HalfCircleExtended",t.OpenCircle="OpenCircle",t.CoverageEdgesWithTicks="CoverageEdgesWithTicks",t.GapExtentWithDoubleTicks="GapExtentWithDoubleTicks",t.GapExtentMidline="GapExtentMidline",t.Chevron="Chevron",t.PerpendicularWithArc="PerpendicularWithArc",t.ClosedHalfCircle="ClosedHalfCircle",t.TripleParallelExtended="TripleParallelExtended",t.ParallelWithTicks="ParallelWithTicks",t.Parallel="Parallel",t.PerpendicularToFirstSegment="PerpendicularToFirstSegment",t.ParallelOffset="ParallelOffset",t.OffsetOpposite="OffsetOpposite",t.OffsetSame="OffsetSame",t.CircleWithArc="CircleWithArc",t.DoubleJog="DoubleJog",t.PerpendicularOffset="PerpendicularOffset",t.LineExcludingLastSegment="LineExcludingLastSegment",t.MultivertexArrow="MultivertexArrow",t.CrossedArrow="CrossedArrow",t.ChevronArrow="ChevronArrow",t.ChevronArrowOffset="ChevronArrowOffset",t.PartialFirstSegment="PartialFirstSegment",t.Arch="Arch",t.CurvedParallelTicks="CurvedParallelTicks",t.Arc90Degrees="Arc90Degrees"}(wge||(wge={})),function(t){t.Mitered="Mitered",t.Bevelled="Bevelled",t.Rounded="Rounded",t.Square="Square",t.TrueBuffer="TrueBuffer"}(xge||(xge={})),function(t){t.ClosePath="ClosePath",t.ConvexHull="ConvexHull",t.RectangularBox="RectangularBox"}(Tge||(Tge={})),function(t){t.BeginningOfLine="BeginningOfLine",t.EndOfLine="EndOfLine"}(Sge||(Sge={})),function(t){t.Mitered="Mitered",t.Bevelled="Bevelled",t.Rounded="Rounded",t.Square="Square"}(Ege||(Ege={})),function(t){t.Fast="Fast",t.Accurate="Accurate"}(Cge||(Cge={})),function(t){t.BeginningOfLine="BeginningOfLine",t.EndOfLine="EndOfLine"}(Age||(Age={})),function(t){t.Sinus="Sinus",t.Square="Square",t.Triangle="Triangle",t.Random="Random"}(Oge||(Oge={})),function(t){t[t.None=0]="None",t[t.Default=1]="Default",t[t.Force=2]="Force"}(Rge||(Rge={})),function(t){t[t.Buffered=0]="Buffered",t[t.Left=1]="Left",t[t.Right=2]="Right",t[t.AlongLine=3]="AlongLine"}(Mge||(Mge={})),function(t){t[t.Linear=0]="Linear",t[t.Rectangular=1]="Rectangular",t[t.Circular=2]="Circular",t[t.Buffered=3]="Buffered"}(Ige||(Ige={})),function(t){t[t.Discrete=0]="Discrete",t[t.Continuous=1]="Continuous"}(Pge||(Pge={})),function(t){t[t.AcrossLine=0]="AcrossLine",t[t.AloneLine=1]="AloneLine"}($ge||($ge={})),function(t){t[t.Left=0]="Left",t[t.Right=1]="Right",t[t.Center=2]="Center",t[t.Justify=3]="Justify"}(Lge||(Lge={})),function(t){t[t.Base=0]="Base",t[t.MidPoint=1]="MidPoint",t[t.ThreePoint=2]="ThreePoint",t[t.FourPoint=3]="FourPoint",t[t.Underline=4]="Underline",t[t.CircularCW=5]="CircularCW",t[t.CircularCCW=6]="CircularCCW"}(Dge||(Dge={})),function(t){t.Butt="Butt",t.Round="Round",t.Square="Square"}(Nge||(Nge={})),function(t){t.NoConstraint="NoConstraint",t.HalfPattern="HalfPattern",t.HalfGap="HalfGap",t.FullPattern="FullPattern",t.FullGap="FullGap",t.Custom="Custom"}(Fge||(Fge={})),function(t){t[t.None=-1]="None",t[t.Custom=0]="Custom",t[t.Circle=1]="Circle",t[t.OpenArrow=2]="OpenArrow",t[t.ClosedArrow=3]="ClosedArrow",t[t.Diamond=4]="Diamond"}(kge||(kge={})),function(t){t[t.ExtraLeading=0]="ExtraLeading",t[t.Multiple=1]="Multiple",t[t.Exact=2]="Exact"}(Uge||(Uge={})),function(t){t.Bevel="Bevel",t.Round="Round",t.Miter="Miter"}(Vge||(Vge={})),function(t){t[t.Default=0]="Default",t[t.String=1]="String",t[t.Numeric=2]="Numeric"}(zge||(zge={})),function(t){t[t.InsidePolygon=0]="InsidePolygon",t[t.PolygonCenter=1]="PolygonCenter",t[t.RandomlyInsidePolygon=2]="RandomlyInsidePolygon"}(Bge||(Bge={})),function(t){t[t.Tint=0]="Tint",t[t.Replace=1]="Replace",t[t.Multiply=2]="Multiply"}(Gge||(Gge={})),function(t){t[t.ClipAtBoundary=0]="ClipAtBoundary",t[t.RemoveIfCenterOutsideBoundary=1]="RemoveIfCenterOutsideBoundary",t[t.DoNotTouchBoundary=2]="DoNotTouchBoundary",t[t.DoNotClip=3]="DoNotClip"}(jge||(jge={})),function(t){t.NoConstraint="NoConstraint",t.WithMarkers="WithMarkers",t.WithFullGap="WithFullGap",t.WithHalfGap="WithHalfGap",t.Custom="Custom"}(Hge||(Hge={})),function(t){t.Fixed="Fixed",t.Random="Random",t.RandomFixedQuantity="RandomFixedQuantity"}(qge||(qge={})),function(t){t.LineMiddle="LineMiddle",t.LineBeginning="LineBeginning",t.LineEnd="LineEnd",t.SegmentMidpoint="SegmentMidpoint"}(Wge||(Wge={})),function(t){t.OnPolygon="OnPolygon",t.CenterOfMass="CenterOfMass",t.BoundingBoxCenter="BoundingBoxCenter"}(Zge||(Zge={})),function(t){t[t.Low=0]="Low",t[t.Medium=1]="Medium",t[t.High=2]="High"}(Xge||(Xge={})),function(t){t[t.MarkerCenter=0]="MarkerCenter",t[t.MarkerBounds=1]="MarkerBounds"}(Yge||(Yge={})),function(t){t[t.None=0]="None",t[t.PropUniform=1]="PropUniform",t[t.PropNonuniform=2]="PropNonuniform",t[t.DifUniform=3]="DifUniform",t[t.DifNonuniform=4]="DifNonuniform"}(Jge||(Jge={})),function(t){t.Tube="Tube",t.Strip="Strip",t.Wall="Wall"}(Qge||(Qge={})),function(t){t[t.Random=0]="Random",t[t.Increasing=1]="Increasing",t[t.Decreasing=2]="Decreasing",t[t.IncreasingThenDecreasing=3]="IncreasingThenDecreasing"}(Kge||(Kge={})),function(t){t[t.Relative=0]="Relative",t[t.Absolute=1]="Absolute"}(eye||(eye={})),function(t){t[t.Normal=0]="Normal",t[t.LowerCase=1]="LowerCase",t[t.Allcaps=2]="Allcaps"}(tye||(tye={})),function(t){t[t.LTR=0]="LTR",t[t.RTL=1]="RTL"}(rye||(rye={})),function(t){t.Draft="Draft",t.Picture="Picture",t.Text="Text"}(iye||(iye={})),function(t){t[t.Top=0]="Top",t[t.Center=1]="Center",t[t.Baseline=2]="Baseline",t[t.Bottom=3]="Bottom"}(sye||(sye={})),function(t){t[t.Right=0]="Right",t[t.Upright=1]="Upright"}(nye||(nye={})),function(t){t[t.Small=0]="Small",t[t.Medium=1]="Medium",t[t.Large=2]="Large"}(oye||(oye={})),function(t){t[t.Calm=0]="Calm",t[t.Rippled=1]="Rippled",t[t.Slight=2]="Slight",t[t.Moderate=3]="Moderate"}(aye||(aye={}));var cJ,Fx,uJ,h6,hJ,d6,dJ,kx,pJ;(function(t){t[t.BACKGROUND=0]="BACKGROUND",t[t.FILL=1]="FILL",t[t.LINE=2]="LINE",t[t.SYMBOL=3]="SYMBOL",t[t.CIRCLE=4]="CIRCLE"})(cJ||(cJ={})),function(t){t[t.VISIBLE=0]="VISIBLE",t[t.NONE=1]="NONE"}(Fx||(Fx={})),function(t){t[t.POINT=0]="POINT",t[t.LINE=1]="LINE",t[t.LINE_CENTER=2]="LINE_CENTER"}(uJ||(uJ={})),function(t){t[t.MAP=0]="MAP",t[t.VIEWPORT=1]="VIEWPORT",t[t.AUTO=2]="AUTO"}(h6||(h6={})),function(t){t[t.AUTO=0]="AUTO",t[t.LEFT=1]="LEFT",t[t.CENTER=2]="CENTER",t[t.RIGHT=3]="RIGHT"}(hJ||(hJ={})),function(t){t[t.CENTER=0]="CENTER",t[t.LEFT=1]="LEFT",t[t.RIGHT=2]="RIGHT",t[t.TOP=3]="TOP",t[t.BOTTOM=4]="BOTTOM",t[t.TOP_LEFT=5]="TOP_LEFT",t[t.TOP_RIGHT=6]="TOP_RIGHT",t[t.BOTTOM_LEFT=7]="BOTTOM_LEFT",t[t.BOTTOM_RIGHT=8]="BOTTOM_RIGHT"}(d6||(d6={})),function(t){t[t.NONE=0]="NONE",t[t.UPPERCASE=1]="UPPERCASE",t[t.LOWERCASE=2]="LOWERCASE"}(dJ||(dJ={})),function(t){t[t.MAP=0]="MAP",t[t.VIEWPORT=1]="VIEWPORT"}(kx||(kx={})),function(t){t[t.HORIZONTAL=0]="HORIZONTAL",t[t.VERTICAL=1]="VERTICAL"}(pJ||(pJ={}));let wp=class{};wp.backgroundLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:Fx.VISIBLE}},wp.fillLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:Fx.VISIBLE}},wp.lineLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:Fx.VISIBLE},"line-cap":{type:"enum",values:["butt","round","square"],default:aJ.BUTT},"line-join":{type:"enum",values:["bevel","round","miter"],default:lJ.MITER},"line-miter-limit":{type:"number",default:2},"line-round-limit":{type:"number",default:1.05}},wp.symbolLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:Fx.VISIBLE},"symbol-avoid-edges":{type:"boolean",default:!1},"symbol-placement":{type:"enum",values:["point","line","line-center"],default:uJ.POINT},"symbol-sort-key":{type:"number",default:-1},"symbol-spacing":{type:"number",minimum:1,default:250},"icon-allow-overlap":{type:"boolean",default:!1},"icon-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:d6.CENTER},"icon-ignore-placement":{type:"boolean",default:!1},"icon-image":{type:"string"},"icon-keep-upright":{type:"boolean",default:!1},"icon-offset":{type:"array",value:"number",length:2,default:[0,0]},"icon-optional":{type:"boolean",default:!1},"icon-padding":{type:"number",minimum:0,default:2},"icon-rotate":{type:"number",default:0},"icon-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:h6.AUTO},"icon-size":{type:"number",minimum:0,default:1},"text-allow-overlap":{type:"boolean",default:!1},"text-anchor":{type:"enum",values:["center","left","right","top","bottom","top-left","top-right","bottom-left","bottom-right"],default:d6.CENTER},"text-field":{type:"string"},"text-font":{type:"array",value:"string",default:["Open Sans Regular","Arial Unicode MS Regular"]},"text-ignore-placement":{type:"boolean",default:!1},"text-justify":{type:"enum",values:["auto","left","center","right"],default:hJ.CENTER},"text-keep-upright":{type:"boolean",default:!0},"text-letter-spacing":{type:"number",default:0},"text-line-height":{type:"number",default:1.2},"text-max-angle":{type:"number",minimum:0,default:45},"text-max-width":{type:"number",minimum:0,default:10},"text-offset":{type:"array",value:"number",length:2,default:[0,0]},"text-optional":{type:"boolean",default:!1},"text-padding":{type:"number",minimum:0,default:2},"text-rotate":{type:"number",default:0},"text-rotation-alignment":{type:"enum",values:["map","viewport","auto"],default:h6.AUTO},"text-size":{type:"number",minimum:0,default:16},"text-transform":{type:"enum",values:["none","uppercase","lowercase"],default:dJ.NONE},"text-writing-mode":{type:"array",value:"enum",values:["horizontal","vertical"],default:[pJ.HORIZONTAL]}},wp.circleLayoutDefinition={visibility:{type:"enum",values:["visible","none"],default:Fx.VISIBLE}},wp.backgroundPaintDefinition={"background-color":{type:"color",default:[0,0,0,1]},"background-opacity":{type:"number",minimum:0,maximum:1,default:1},"background-pattern":{type:"string"}},wp.fillPaintDefinition={"fill-antialias":{type:"boolean",default:!0},"fill-color":{type:"color",default:[0,0,0,1]},"fill-opacity":{type:"number",minimum:0,maximum:1,default:1},"fill-outline-color":{type:"color",default:[0,0,0,0]},"fill-pattern":{type:"string"},"fill-translate":{type:"array",value:"number",length:2,default:[0,0]},"fill-translate-anchor":{type:"enum",values:["map","viewport"],default:kx.MAP}},wp.linePaintDefinition={"line-blur":{type:"number",minimum:0,default:0},"line-color":{type:"color",default:[0,0,0,1]},"line-dasharray":{type:"array",value:"number",default:[]},"line-gap-width":{type:"number",minimum:0,default:0},"line-offset":{type:"number",default:0},"line-opacity":{type:"number",minimum:0,maximum:1,default:1},"line-pattern":{type:"string"},"line-translate":{type:"array",value:"number",length:2,default:[0,0]},"line-translate-anchor":{type:"enum",values:["map","viewport"],default:kx.MAP},"line-width":{type:"number",minimum:0,default:1}},wp.symbolPaintDefinition={"icon-color":{type:"color",default:[0,0,0,1]},"icon-halo-blur":{type:"number",minimum:0,default:0},"icon-halo-color":{type:"color",default:[0,0,0,0]},"icon-halo-width":{type:"number",minimum:0,default:0},"icon-opacity":{type:"number",minimum:0,maximum:1,default:1},"icon-translate":{type:"array",value:"number",length:2,default:[0,0]},"icon-translate-anchor":{type:"enum",values:["map","viewport"],default:kx.MAP},"text-color":{type:"color",default:[0,0,0,1]},"text-halo-blur":{type:"number",minimum:0,default:0},"text-halo-color":{type:"color",default:[0,0,0,0]},"text-halo-width":{type:"number",minimum:0,default:0},"text-opacity":{type:"number",minimum:0,maximum:1,default:1},"text-translate":{type:"array",value:"number",length:2,default:[0,0]},"text-translate-anchor":{type:"enum",values:["map","viewport"],default:kx.MAP}},wp.rasterPaintDefinition={"raster-opacity":{type:"number",minimum:0,maximum:1,default:1},"raster-hue-rotate":{type:"number",default:0},"raster-brightness-min":{type:"number",minimum:0,maximum:1,default:0},"raster-brightness-max":{type:"number",minimum:0,maximum:1,default:1},"raster-saturation":{type:"number",minimum:-1,maximum:1,default:0},"raster-contrast":{type:"number",minimum:-1,maximum:1,default:0},"raster-fade-duration":{type:"number",minimum:0,default:300}},wp.circlePaintDefinition={"circle-blur":{type:"number",minimum:0,default:0},"circle-color":{type:"color",default:[0,0,0,1]},"circle-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-radius":{type:"number",minimum:0,default:5},"circle-stroke-color":{type:"color",default:[0,0,0,1]},"circle-stroke-opacity":{type:"number",minimum:0,maximum:1,default:1},"circle-stroke-width":{type:"number",minimum:0,default:0},"circle-translate":{type:"array",value:"number",length:2,default:[0,0]},"circle-translate-anchor":{type:"enum",values:["map","viewport"],default:kx.MAP}};const R3t=.125;let M3t=class{constructor(){this._renderParams={context:null,drawPhase:1,state:new O3t({viewpoint:new Nf({targetGeometry:new ht(0,0),scale:1,rotation:0}),size:[256,256]}),stationary:!0,pixelRatio:1,displayLevel:-1,requiredLevel:-1,globalOpacity:1,renderPass:"background",styleLayer:null,styleLayerUID:-1,painter:null,glyphMosaic:null,spriteMosaic:null,profiler:null,renderingOptions:null,requestRender:null,allowDelayedRender:!1,deltaTime:-1,timeline:null,time:0,hasClipping:!1,blendMode:null,dataUploadCounter:0,effects:null,inFadeTransition:!1,requireFBO:!1,highlightGradient:null}}dispose(){this._renderParams=null}render(e,r,i,s,n,o,a,l,c,h,p){this._render(e,r,i,s,n,o,a,l,c,h,p)}renderSymbols(e,r,i,s,n,o,a,l,c,h,p){this._render(e,r,i,s,n,o,a,l,c,h,p,cJ.SYMBOL)}_render(e,r,i,s,n,o,a,l,c,h,p,f){const m=r[0]-o.getLevelShift(r[0]),g=this._renderParams;g.context=e,g.painter=s,g.glyphMosaic=s.glyphMosaic,g.spriteMosaic=s.spriteMosaic,g.pixelRatio=h*p,g.displayLevel=m,g.requiredLevel=m;const _=o.getScale(r[0]),[v,b]=o.getOffset(r,a*_),x=R3t*a*_/c,T=i.transforms.dvs;T[0]=x,T[4]=-x,T[6]=-1-v-l[0]*a*2,T[7]=1+b+(1-l[1])*a*2-2,g.state.size[0]=c/p,g.state.size[1]=c/p,g.state.pixelRatio=p,i.stage||i.attachWithContext(e),i.triangleCount=0,s.drawTile(g,i,n,f)}},VNe=class zNe extends Ur{initializeProgram(e){return new Lr(e.rctx,zNe.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}};VNe.shader=new $r(fRt,()=>J(()=>import("./RasterColorizer.glsl-d1ff8d3a.js"),[],import.meta.url));let xM=class extends AI{constructor(){super(...arguments),this.colorizerType=mT.Stretch,this.stretchType=QT.Noop,this.applyColormap=!0,this.requireBilinearWithNN=!1}};u([B({count:mT.COUNT})],xM.prototype,"colorizerType",void 0),u([B({count:QT.COUNT})],xM.prototype,"stretchType",void 0),u([B()],xM.prototype,"applyColormap",void 0),u([B()],xM.prototype,"requireBilinearWithNN",void 0);let lye=class{constructor(e){this._rctx=e,this._fbos=new Map}get(e){return this._getPool(e)}dispose(){this._fbos.forEach(e=>e.dispose()),this._fbos.clear()}_getPool(e){const r=this._fbos.get(e);if(r)return r;const i=new Vn(this._rctx,new Sr(e),new mU(bn.DEPTH_COMPONENT16,e));return this._fbos.set(e,i),i}};const I3t=K.getLogger("esri.views.3d.terrain");let P3t=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._fbos=[],this._vectorTileHelper=new M3t,this._bindParameters=new a8(null,null,null),this._blendLayersTechniqueConfig=new UNe,this._current=0,this._lastUsedIds=new Array,this._lastCreatedBufferId=0,this._onHoldIds=new Array,this._vaoQuad=Mc(this._rctx,T$)}dispose(){this._fbos.forEach(ze),this._fbos=null,this._vtFBO=ze(this._vtFBO),this._vaoQuad=ze(this._vaoQuad),this._vectorTileHelper=ze(this._vectorTileHelper),this._backgroundTechnique=as(this._backgroundTechnique),this._applyOpacityTechnique=as(this._applyOpacityTechnique),this._blendLayersTechnique=as(this._blendLayersTechnique)}_getBlendLayersTechnique(e,r,i,s=tf.Off,n=KT.BelowLayer){return this._blendLayersTechniqueConfig.output=r,this._blendLayersTechniqueConfig.blendMode=e,this._blendLayersTechniqueConfig.baseOpacityMode=i,this._blendLayersTechniqueConfig.premultipliedSource=s,this._blendLayersTechniqueConfig.background=n,this._blendLayersTechnique=this._techniqueRepository.releaseAndAcquire(FNe,this._blendLayersTechniqueConfig,this._blendLayersTechnique),this._blendLayersTechnique}drawBackground(e,r){const i=this._getBlendLayersTechnique($e.Normal,r?to.ColorComposite:to.GridComposite,yf.NotRequired,tf.Off,KT.Only),s=this._rctx.bindTechnique(i,e,this._bindParameters);this._render(s)}_render(e){this._rctx.bindVAO(this._vaoQuad),e.assertCompatibleVertexAttributeLocations(this._vaoQuad),this._rctx.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(this._vaoQuad,"geometry"))}drawGroup(e,r,i,s,n,o=tf.On){r===to.Composite&&(e.fboTexture=this._fbos[this.getLastOnHoldId()].get(i).colorTexture),e.texture=this.currentFBO(i).colorTexture,this.closeGroup(i);const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawRasterData(e,r,i,s,n,o=tf.Off){if(e.texture==null)return;e.fboTexture=r===to.GroupBackgroundComposite||s===$e.Normal&&n===yf.NotRequired&&o===tf.Off?null:this.switch(i).colorTexture;const a=this._getBlendLayersTechnique(s,r,n,o),l=this._rctx.bindTechnique(a,e,this._bindParameters);this._render(l)}drawImageryTileData(e,r,i,s,n,o){const a=o.sourceLayerInfo.data;if(!a.source||(o.tile.surface.layerViewByIndex(o.layerIndex,nr.MAP).ensureSymbolizerParameters(a),!a.bind(this._rctx)))return;e.fboTexture=s===$e.Normal&&n===yf.NotRequired?null:this.switch(i).colorTexture;const l=this._getRasterColorizerTechnique(a,r,s,n);a.opacity=e.opacity;const c=a.getUniforms();c.scale=o.scale,c.offset=o.offset,c.backgroundColor=e.backgroundColor,c.fboTexture=e.fboTexture,c.baseOpacity=e.baseOpacity;const h=this._rctx.bindTechnique(l,c,null);this._render(h)}_getRasterColorizerTechnique(e,r,i,s){const n=e.symbolizerParameters,o=["stretch","lut","hillshade"].indexOf(n.type);return this._rasterColorizerConfig==null&&(this._rasterColorizerConfig=new xM,this._rctx.gl.getExtension("WEBGL_color_buffer_float"),this._rctx.gl.getExtension("OES_texture_float")),this._rasterColorizerConfig.output=r,this._rasterColorizerConfig.blendMode=i,this._rasterColorizerConfig.baseOpacityMode=s,this._rasterColorizerConfig.colorizerType=o,this._rasterColorizerConfig.applyColormap=!!n.colormap,this._rasterColorizerConfig.requireBilinearWithNN=e.isBilinearWithStretchColorRamp,this._rasterColorizerConfig.stretchType=e.hasStretchTypeNone()?QT.Noop:QT.PerBand,this._rasterColorizerTechnique=this._techniqueRepository.releaseAndAcquire(VNe,this._rasterColorizerConfig,this._rasterColorizerTechnique),this._rasterColorizerTechnique}drawVectorData(e,r,i,s,n,o,a,l,c){const h=this._rctx,p=o.sourceLayerInfo.data,f=o.tile.surface.layerViewByIndex(o.layerIndex,nr.MAP),m=n===yf.Required||e.opacity<1||s!==$e.Normal||r!==to.Composite,g=m?tf.On:tf.Off;this._getBlendLayersTechnique(s,r,n,g).bindPipelineState(h);let _=null,v=null;m?(v=this.currentFBO(i),this._vtFBO==null&&(this._vtFBO=new lye(this._rctx)),_=this._vtFBO.get(i),h.bindFramebuffer(_),this._clearCurrentFBO()):c&&h.clearSafe(Bi.DEPTH_BUFFER_BIT);try{this._vectorTileHelper.render(h,o.sourceLod,p,f.painter,f.layer.styleRepository,f.schemaHelper,Math.round(1/o.scale),o.offset,l,a,f.contentZoom),o.vtlNeighborInfos.forAll(b=>this._vectorTileHelper.renderSymbols(h,b.sourceLod,b.sourceLayerInfo.data,f.painter,f.layer.styleRepository,f.schemaHelper,1,b.offset,l,a,f.contentZoom))}catch(b){I3t.warnOnce("A render call containing vector tiles did not resolve correctly.",b)}return _==null||(h.bindFramebuffer(v),e.texture=_.colorTexture,e.offset=Df,e.scale=1,this.drawRasterData(e,r,i,s,n,g),c)}copyFBOToTexture(e){const r=this._rctx,i=r.bindTexture(e.texture,Rt.TEXTURE_UNIT_FOR_UPDATES),s=e.descriptor;r.gl.copyTexImage2D(Rs.TEXTURE_2D,0,s.pixelFormat,0,0,s.width,s.height,0),e.generateMipmap(),r.bindTexture(i,Rt.TEXTURE_UNIT_FOR_UPDATES)}_clearCurrentFBO(){this._rctx.setClearColor(0,0,0,0),this._rctx.setClearDepth(1),this._rctx.clearSafe(Bi.COLOR_BUFFER_BIT|Bi.DEPTH_BUFFER_BIT)}_initFBO(e,r,i){this._rctx.bindFramebuffer(e),i&&(this._rctx.setViewport(0,0,r,r),this._clearCurrentFBO())}ensureBuffer(e){this._lastUsedIds.length=0,this._lastUsedIds.push(1),this._lastCreatedBufferId=1,this._onHoldIds.length=0,this.bind(e)}bind(e,r=0,i=!0){if(this._current=r,r>=this._fbos.length)for(let s=this._fbos.length;s<=r;s++)this._fbos.push(new lye(this._rctx));this._initFBO(this._fbos[r].get(e),e,i)}_bindNextFreeBuffer(e){this._lastUsedIds.length>0?this.bind(e,this._lastUsedIds.pop()):(this._lastCreatedBufferId++,this.bind(e,this._lastCreatedBufferId))}openGroup(e){this._onHoldIds.push(this._current),this._bindNextFreeBuffer(e)}switch(e){const r=this.currentFBO(e),i=this._current;return this._bindNextFreeBuffer(e),this._lastUsedIds.push(i),r}getLastOnHoldId(){return this._onHoldIds[this._onHoldIds.length-1]}closeGroup(e){const r=this._current;this._bindNextFreeBuffer(e),this._lastUsedIds.push(r),this._lastUsedIds.push(this._onHoldIds.pop())}unbind(){this._rctx.bindFramebuffer(null)}currentFBO(e){return this._fbos[this._current].get(e)}},$3t=class{constructor(){this.sourceLod=[0,0,0],this.offset=[0,0],this.scale=1,this.layerIndex=0,this.vtlNeighborInfos=new qt({allocator:e=>e||new L3t})}},L3t=class{constructor(){this.sourceLayerInfo=null,this.sourceLod=[0,0,0],this.offset=[-1,0]}},D3t=class{constructor(e,r,i,s){this.start=e,this.end=r,this.blendMode=i,this.opacity=s}},N3t=class{constructor(e,r,i){this._rctx=e,this.tileSize=r,this._techniqueRepository=i,this._passParameters=new h3t,this._backgroundTexture=null,this._backgroundColor=null,this._backgroundDirty=!1,this._blackTex=null,this._maxAnisotropy=this._rctx.parameters.maxMaxAnisotropy,this._composition=new P3t(this._rctx,this._techniqueRepository),this._blackTex=new LE(Iht(this._rctx,[0,0,0,1])),this._ensureBackgroundTexture(this.tileSize)}dispose(){this._composition=ze(this._composition),this._backgroundTexture=as(this._backgroundTexture),this._blackTex=as(this._blackTex)}get backgroundIsGrid(){return this._backgroundColor==null}get backgroundColor(){return this._backgroundColor}updateTileTexture(e,r){if(!e.renderData)return;const i=e.surface,s=i.baseOpacity;let n=0,o=0,a=this.tileSize,l=!1;const c=i.view.state.contentPixelRatio;let h=!1;p6.clear(),O2.length=0;const p=e.layerInfo[nr.MAP];let f=p.length,m=0,g=null;for(;m<p.length;m++){const v=i.layerViewByIndex(m,nr.MAP),b=v.layer.opacity;cye[m]=b;const x=v.fullOpacity;if(uye[m]=x,Wxe(v.layer)&&f>=p.length&&(f=m),o6(v)){hye[m]=v.layer.blendMode;let S=v.layer.blendMode!=="normal";if(cA(v.layer.parent)){const O=fJ(v.layer.parent);O!=null&&O!==""&&(S=BNe(v.layer.parent)||S)}S&&(h=S,l=!1)}if(b===0&&!h){p[m].pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING);continue}++o;const T=rj(e,m);if(T){if(p[m].pendingUpdates&=~(vt.TEXTURE_NOFADING&vt.TEXTURE_FADING),cA(v.layer.parent)){const S=fJ(v.layer.parent);S!=null&&S!==""&&GNe(v.layer.parent,m)}MP(v)?a=Math.max(a,this.tileSize*c):s===1&&x===1&&(v.isOpaque||this._dataToTexture(T)&&T.sourceLayerInfo.data.descriptor.isOpaque)&&(l=!0),++n,g===null&&(g=m)}}const _=a/this.tileSize;this._ensureBackgroundTexture(this.tileSize),n!==0&&g!==null?n===1&&!h&&this._useLayerTexture(e,g,f,uye[g])||this._composeMapLayers(e,r,m-1,f,cye,hye,a,_,!l||h,p6,h):this._useBackgroundTexture(e,o)}_ensureBackgroundTexture(e){this._backgroundTexture==null&&(this._backgroundTexture=this._buildTexture(e),this._backgroundDirty=!0),this._backgroundDirty&&(this._composition.bind(e),this._passParameters.offset=Df,this._passParameters.scale=1,this._passParameters.opacity=1,this.backgroundColor!=null&&(this._passParameters.backgroundColor=this.backgroundColor),this._composition.drawBackground(this._passParameters,this.backgroundColor!=null),this._composition.copyFBOToTexture(this._backgroundTexture),this._composition.unbind(),this._backgroundDirty=!1)}_useBackgroundTexture(e,r){let i=b0.Immediate;(e.surface.view.layerViewManager.updating||r>0)&&(i=b0.Delayed);const s=e.renderData;this._backgroundTexture&&s.textureReference==null&&(i=b0.Immediate),s.setTextureReference(this._backgroundTexture!=null?new ej(this._backgroundTexture,$n.FADING,dye,e.surface.baseOpacity,0,1):null,i)}_useLayerTexture(e,r,i,s){const n=r<i,o=n?1:e.surface.baseOpacity,a=n?e.surface.baseOpacity:1,l=rj(e,r);return!!this._dataToTexture(l)&&(e.renderData.setTextureReference(new ej(l.sourceLayerInfo.data,$n.FADING,l,o,a,s)),!0)}_composeMapLayers(e,r,i,s,n,o,a,l,c,h,p){this._composition.ensureBuffer(a);const f=e.surface.baseOpacity;let m=!1,g=Mt.LINEAR_MIPMAP_LINEAR,_=!1,v=0;for(let T=i;T>=0;T--){const S=rj(e,T);if(!S||n[T]===0&&!p)continue;const O=T<s&&f<1&&!m;this._passParameters.baseOpacity=O?f:1;const A=this._passParameters.baseOpacity<1?yf.Required:yf.NotRequired;O&&(m=!0);let M=!1;h.forEach(N=>{N.start===T&&(O2.push(N),this._composition.openGroup(a),M=!0)});const P=v===0,F=M?to.GroupBackgroundComposite:c&&P?this.backgroundIsGrid?to.GridComposite:to.ColorComposite:to.Composite,$=iJ[o[T]];for(KDe(S)?(this._passParameters.opacity=n[T],_=this._composition.drawVectorData(this._passParameters,F,a,$,A,S,l,this.tileSize,_)):zAt(S)?(this._passParameters.opacity=n[T],this._composition.drawImageryTileData(this._passParameters,F,a,$,A,S),this._hasNearestInterpolation(S)&&(g=Mt.NEAREST)):this._dataToTexture(S)&&(this._passParameters.texture=S.sourceLayerInfo.data.texture,this._passParameters.offset=S.offset,this._passParameters.scale=S.scale,this._passParameters.opacity=n[T],this._composition.drawRasterData(this._passParameters,F,a,$,A));O2.length>0&&O2[O2.length-1].end===T;){const N=O2.pop();this._passParameters.opacity=N.opacity,this._passParameters.offset=Df,this._passParameters.scale=1;const U=c&&P?this.backgroundIsGrid?to.GridComposite:to.ColorComposite:to.Composite;this._composition.drawGroup(this._passParameters,U,a,iJ[N.blendMode],A)}v++}const b=e.renderData,x=b.ensureTexture(a,()=>this._buildTexture(a,g));this._composition.copyFBOToTexture(x),this._composition.unbind(),b.setTextureReference(new ej(x,r,dye,m?1:f,0,1))}_hasNearestInterpolation(e){const r=e.sourceLayerInfo.data;return!!r.source&&r.interpolation==="nearest"}_dataToTexture(e){if(GAt(e)){const r=e.sourceLayerInfo;r.data=this._buildTexture(r.data),e.tile.setMemoryDirty()}return BAt(e)}setBackground(e){this._backgroundColor!==e&&(this._backgroundColor=e,this._backgroundDirty=!0)}_buildTexture(e,r=Mt.LINEAR_MIPMAP_LINEAR){if(e==null)return null;const i=new Sr;i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=r,i.maxAnisotropy=this._maxAnisotropy,i.preMultiplyAlpha=!0,i.flipped=!0,i.hasMipmap=!0;const s=this._rctx;let n;if(typeof e=="number")i.width=i.height=e,n=new LE(new Rt(s,i));else if(e instanceof Y8)i.isOpaque=e.isOpaque,n=new LE(new Rt(s,i,e.image)),e.release();else try{i.width=e.width,i.height=e.height,n=new LE(new Rt(s,i,e))}catch{n=new LE(c3e(s)),console.warn("TileRenderer: failed to execute 'texImage2D', cross-origin image may not be loaded.")}const o=s.bindTexture(n.texture,Rt.TEXTURE_UNIT_FOR_UPDATES);return n.generateMipmap(),s.bindTexture(o,Rt.TEXTURE_UNIT_FOR_UPDATES),n}get test(){return{backgroundTexture:this._backgroundTexture}}};function rj(t,e){ml.layerIndex=e,ml.vtlNeighborInfos.clear();const r=t.layerInfo[nr.MAP][e];if(r.data)return hr(ml.offset,0,0),ml.tile=t,ml.scale=1,ml.sourceLod=t.lij,ml.sourceLayerInfo=r,KDe(ml)&&t.forEachLoadedNeighbor((s,n)=>{if(s.level!==t.level)return;const o=s.layerInfo[nr.MAP][e];if(!eNe(o)||r.data===o.data)return;const a=ml.vtlNeighborInfos.pushNew();a.offset=Ny[n],a.sourceLod=s.lij,a.sourceLayerInfo=o}),ml;const i=r.upsampleInfo;if(i){const s=i.tile.layerInfo[nr.MAP][e];return ml.tile=i.tile,jn(ml.offset,i.offset),ml.scale=i.scale,ml.sourceLod=i.tile.lij,ml.sourceLayerInfo=s,ml}return null}function fJ(t){return t.get("uid")}function BNe(t){let e=t.blendMode!=="normal";return cA(t.parent)&&(e=BNe(t.parent)||e),e}function GNe(t,e){cA(t.parent)&&GNe(t.parent,e);const r=fJ(t);if(r!=null&&r!==""){const i=p6.get(r);i?i.start=e:p6.set(r,new D3t(e,e,t.blendMode,t.opacity))}}const cye=new Array,uye=new Array,hye=new Array,p6=new Map,O2=new Array,ml=new $3t,dye={offset:[0,0],scale:1},Ny=new Array;Ny[ct.NORTH]=[0,-1],Ny[ct.NORTH_EAST]=[-1,-1],Ny[ct.EAST]=[-1,0],Ny[ct.SOUTH_EAST]=[-1,1],Ny[ct.SOUTH]=[0,1],Ny[ct.SOUTH_WEST]=[1,1],Ny[ct.WEST]=[1,0],Ny[ct.NORTH_WEST]=[1,-1];const jNe=200,ij=40,F3t=.8,k3t=10,TM=1e-6;function U3t(t,e,r){const i=e,s=r;let n=0,o=1/0;for(let a=0;a<3;++a){{const l=t[a];if(i[a]<l){if(s[a]<=TM)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]<=-TM){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}{const l=t[a+3];if(i[a]>l){if(s[a]>=-TM)return!1;const c=(l-i[a])/s[a];n=Math.max(n,c)}else if(s[a]>=TM){const c=(l-i[a])/s[a];o=Math.min(o,c)}if(n>o)return!1}}return!0}let pye=class{constructor(e,r,i,s,n){this.aabb=e,this.axis=r,this.d=i,this.midStartIndex=s,this.rightStartIndex=n}},qie=class mJ{constructor(e,r,i,s){this.globalTriangleVertexIndices=e,this.firstTriangleIndex=r,this.positionAttribute=s,this._rayDirection=C(),this.bspNodeTree=new Array;const n=i-r,o=n<=HNe?new Uint16Array(n):new Uint32Array(n);this.indices=o;for(let a=0;a<n;++a)o[a]=a;{const a=j3t(e,r,i,s.data,s.stride),l=ye(Math.log2(n/ij),2,k3t),c=(h,p,f)=>{const m=B3t(o,a,h,p),g=p-h;if(g<=ij){const S=new pye(m,void 0,0,h,p);return this.bspNodeTree.push(S),S}const{axis:_,midValue:v}=G3t(m),b=z3t(o,a,h,p,_,v),x=(S,O)=>{if(f>l)return;const A=O-S;return A<ij||A>=F3t*g?void 0:c(S,O,f+1)},T=new pye(m,_,v,b.next,b.mid);return this.bspNodeTree.push(T),T.leftNode=x(h,b.next),T.rightNode=x(b.mid,p),T};c(0,n,0),this.triangleVertexIndices=H3t(o,e,r,i)}}intersectRayTriangleRange(e,r){{if(e>=r)return;const i=this.triangleVertexIndices,s=this.positionAttribute.data,n=this.positionAttribute.stride,o=this._rayOrigin,a=o[0],l=o[1],c=o[2],h=this._rayDirection,p=h[0],f=h[1],m=h[2];for(let g=e,_=3*e;g<r;++g){let v=i[_++]*n;const b=s[v++],x=s[v++],T=s[v];v=i[_++]*n;const S=s[v++],O=s[v++],A=s[v];v=i[_++]*n;const M=S-b,P=O-x,F=A-T,$=s[v++]-b,N=s[v++]-x,U=s[v]-T,X=f*U-N*m,Z=m*$-U*p,G=p*N-$*f,ee=M*X+P*Z+F*G;if(Math.abs(ee)<=Number.EPSILON)continue;const I=a-b,V=l-x,z=c-T,H=I*X+V*Z+z*G;if(ee>0){if(H<0||H>ee)continue}else if(H>0||H<ee)continue;const Y=V*F-P*z,te=z*M-F*I,ne=I*P-M*V,ve=p*Y+f*te+m*ne;if(ee>0){if(ve<0||H+ve>ee)continue}else if(ve>0||H+ve<ee)continue;const Fe=($*Y+N*te+U*ne)/ee;if(Fe>=0){const bt=this.indices[g]+this.firstTriangleIndex,Pt=Pre(M,P,F,$,N,U,V3t);this._callback(Fe,Pt,bt,!1)}}}mJ.numFacesTested+=r-e}intersectRay(e,r){mJ.numFacesTested=0;const i=Ee(e.r0[0],e.r0[1],e.r0[2]),s=Ee(e.r1[0],e.r1[1],e.r1[2]),n=s[0]-i[0],o=s[1]-i[1],a=s[2]-i[2];if(n*n+o*o+a*a<TM)return;this._rayOrigin=i;const l=this._rayDirection;l[0]=n,l[1]=o,l[2]=a;const c=this.triangleVertexIndices.length/3;this._callback=r;const h=this.bspNodeTree[0];this.intersectRayBSP(h,0,c)}intersectRayBSP(e,r,i){const s=this._rayOrigin,n=this._rayDirection;if(!U3t(e.aabb,s,n))return;const o=e.axis,a=e.d;if(s[o]<a||n[o]<0){const l=r,c=e.midStartIndex;if(l<c){const h=e.leftNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}if(this.intersectRayTriangleRange(e.midStartIndex,e.rightStartIndex),s[o]>a||n[o]>0){const l=e.rightStartIndex,c=i;if(l<c){const h=e.rightNode;h!==void 0?this.intersectRayBSP(h,l,c):this.intersectRayTriangleRange(l,c)}}}get estimatedMemoryUsage(){return this.triangleVertexIndices.byteLength+this.indices.byteLength}};qie.numFacesTested=0;const V3t=C(),R2=[1/0,1/0,1/0],M2=[-1/0,-1/0,-1/0];function z3t(t,e,r,i,s,n){let o=r,a=i;for(;o<a;){const c=t[o];e[6*c+s+3]<=n?++o:(--a,t[o]=t[a],t[a]=c)}let l=o;for(a=i;l<a;){const c=t[a-1];e[6*c+s]>=n?--a:(t[a-1]=t[l],t[l]=c,++l)}return{next:o,mid:l}}function B3t(t,e,r,i){if(i<=r)return PT(NaN,NaN,NaN,NaN,NaN,NaN);{const s=6*t[r];for(let n=0;n<3;++n)R2[n]=e[s+0+n],M2[n]=e[s+3+n]}for(let s=r+1;s<i;++s){const n=6*t[s];for(let o=0;o<3;++o)R2[o]=Math.min(R2[o],e[n+0+o]),M2[o]=Math.max(M2[o],e[n+3+o])}return PT(R2[0],R2[1],R2[2],M2[0],M2[1],M2[2])}function G3t(t){const e=t[3]-t[0],r=t[4]-t[1],i=t[5]-t[2],s=e>r?e>i?0:r>i?1:2:r>i?1:i>e?2:0;return{axis:s,midValue:(t[s]+t[s+3])/2}}function j3t(t,e,r,i,s){const n=r-e,o=new Float32Array(6*n);for(let a=0;a<n;++a){const l=3*(a+e),c=t[l]*s,h=t[l+1]*s,p=t[l+2]*s;for(let f=0;f<3;++f){const m=i[c+f],g=i[h+f],_=i[p+f];o[6*a+f]=Math.min(m,g,_),o[6*a+3+f]=Math.max(m,g,_)}}return o}function H3t(t,e,r,i){const s=i-r;let n=0;for(let a=r;a<i;++a)for(let l=0;l<3;++l)n=Math.max(e[3*a+l],n);const o=n<=HNe?new Uint16Array(3*s):new Uint32Array(3*s);for(let a=0;a<s;++a){const l=3*(t[a]+r);for(let c=0;c<3;++c){const h=e[l+c];o[3*a+c]=h}}return o}const HNe=65535;let cn=class extends Ea{constructor(){super(...arguments),this.output=k.Color,this.overlayMode=x0.Disabled,this.tileBlendInput=tg.LayerOnly,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.receiveShadows=!1,this.hasSlicePlane=!1,this.backfaceCullingEnabled=!1,this.textureFadingEnabled=!1,this.renderOccluded=!1,this.hasScreenSpaceReflections=!1,this.hasCloudsReflections=!1,this.invisible=!1,this.tileBorders=!1,this.visualizeNormals=!1,this.screenSizePerspective=!1,this.receiveAmbientOcclusion=!1,this.pbrMode=lt.Terrain}};u([B({count:k.COUNT})],cn.prototype,"output",void 0),u([B({count:x0.COUNT})],cn.prototype,"overlayMode",void 0),u([B({count:tg.COUNT})],cn.prototype,"tileBlendInput",void 0),u([B()],cn.prototype,"spherical",void 0),u([B()],cn.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B()],cn.prototype,"receiveShadows",void 0),u([B()],cn.prototype,"hasSlicePlane",void 0),u([B()],cn.prototype,"backfaceCullingEnabled",void 0),u([B()],cn.prototype,"textureFadingEnabled",void 0),u([B()],cn.prototype,"renderOccluded",void 0),u([B()],cn.prototype,"hasScreenSpaceReflections",void 0),u([B()],cn.prototype,"hasCloudsReflections",void 0),u([B()],cn.prototype,"invisible",void 0),u([B()],cn.prototype,"tileBorders",void 0),u([B()],cn.prototype,"visualizeNormals",void 0),u([B()],cn.prototype,"screenSizePerspective",void 0),u([B()],cn.prototype,"receiveAmbientOcclusion",void 0),u([B({count:lt.COUNT})],cn.prototype,"pbrMode",void 0),u([B({constValue:Fr.Compressed})],cn.prototype,"normalType",void 0),u([B({constValue:sn.Compressed})],cn.prototype,"textureCoordinateType",void 0),u([B({constValue:!1})],cn.prototype,"highStepCount",void 0),u([B({constValue:!1})],cn.prototype,"useCustomDTRExponentForWater",void 0),u([B({constValue:!1})],cn.prototype,"useFillLights",void 0);const sj=7,q3t=10,nj=Gn();var Qn;(function(t){t[t.Opaque=0]="Opaque",t[t.Semitransparent=1]="Semitransparent",t[t.TransparentWithDraped=2]="TransparentWithDraped",t[t.Empty=3]="Empty"})(Qn||(Qn={}));let Jc=class extends me{get _isGlobal(){return this._stage.viewingMode===Ue.Global}constructor(e){super(e),this.type=ls.TERRAIN,this.isGround=!0,this._tileSize=256,this._techniqueConfiguration=new cn,this._passParameters=new _Ne,this._rctx=null,this._renderDataPool=new $o(GRt),this._patchGroups=new Map,this._patchGroupsDirty=!0,this._patchSortingDirty=!0,this._tileIterator=new cNe,this._highestVisibleLODTile=null,this._visible=!0,this._transparencyState=Qn.Opaque,this._castShadows=!0,this._emptyTex=null,this._tileRenderer=null,this._stencilEnabledLayerExtents=new Array,this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this.needsHighlight=!1,this.renderOccludedFlags=Qi.Occlude}initialize(){const e=[fe.OPAQUE_TERRAIN,fe.TRANSPARENT_TERRAIN,fe.OCCLUDED_TERRAIN];this._stage.addRenderPlugin(e,this)}destroy(){this._stage.removeRenderPlugin(this),BOt()}get canRender(){return this._visible&&!!this._rootTiles&&!this.renderingDisabled}set renderingDisabled(e){this._set("renderingDisabled",!!e),this.setDirty()}set transparency(e){this._transparencyState!==e&&(this._techniqueConfiguration.invisible=e===Qn.TransparentWithDraped||e===Qn.Empty,this._transparencyState=e,this.setNeedsRender())}get transparency(){return this._transparencyState}get needsLinearDepth(){return this._overlayRenderer.hasWater}get renderPatchBorders(){return!!this._techniqueConfiguration.tileBorders}set renderPatchBorders(e){this._techniqueConfiguration.tileBorders!==e&&(this._techniqueConfiguration.tileBorders=e,this.setNeedsRender(),this.notifyChange("renderPatchBorders"))}get visualizeNormals(){return!!this._techniqueConfiguration.visualizeNormals}set visualizeNormals(e){this._techniqueConfiguration.visualizeNormals!==e&&(this._techniqueConfiguration.visualizeNormals=e,this.setNeedsRender(),this.notifyChange("visualizeNormals"))}get cullBackFaces(){return this._techniqueConfiguration.backfaceCullingEnabled}set cullBackFaces(e){this._techniqueConfiguration.backfaceCullingEnabled!==e&&(this._techniqueConfiguration.backfaceCullingEnabled=e,this.notifyChange("cullBackFaces"),this.setNeedsRender())}set renderOrder(e){this._set("renderOrder",e),this._setSortingDirty()}get layerUid(){return Yv}get slicePlaneEnabled(){return this._techniqueConfiguration.hasSlicePlane}set slicePlaneEnabled(e){this._techniqueConfiguration.hasSlicePlane!==e&&(this._techniqueConfiguration.hasSlicePlane=e,this.setNeedsRender())}set textureFadingEnabled(e){this._techniqueConfiguration.textureFadingEnabled!==e&&(this._techniqueConfiguration.textureFadingEnabled=e,this.setNeedsRender())}set pbrMode(e){this._techniqueConfiguration.pbrMode!==e&&(this._techniqueConfiguration.pbrMode=e,this.setNeedsRender())}setDebugScreenSizePerspective(e){this._techniqueConfiguration.screenSizePerspective!==e&&(this._techniqueConfiguration.screenSizePerspective=e,this.setNeedsRender())}setRootTiles(e){this._rootTiles=e,this.setDirty()}setNeedsHighlight(e){this.needsHighlight=e,this.setNeedsRender()}setRenderOccludedOverlay(e){this.renderOccludedFlags=e?YU:Qi.Occlude,this.setNeedsRender()}setStencilEnabledLayerExtents(e){this._stencilEnabledLayerExtents=e,this._setSortingDirty()}setTileSize(e){this._tileSize=e,this._tileRenderer!=null&&(this._tileRenderer.tileSize=e),this.setDirty()}_prepareTileForLoading(e){e.renderData||(e.renderData=this._renderDataPool.acquire(),e.renderData.init(e),e.renderData.localOrigin=this._getLocalOriginOfTile(e))}loadTile(e){this._prepareTileForLoading(e),this.updateTileGeometryState(e),this.updateTileTexture(e,vt.TEXTURE_FADING)}updateTileTexture(e,r){this._tileRenderer!=null&&(this._tileRenderer.updateTileTexture(e,r===vt.TEXTURE_FADING?$n.FADING:$n.UNFADED),this.setNeedsRender(),e.resetPendingUpdate(r))}updateTileGeometryState(e){for(const i of e.layerInfo[nr.ELEVATION])i.pendingUpdates&=~vt.GEOMETRY;e.resetPendingUpdate(vt.GEOMETRY);const r=e.renderData.updateGeometryState();return r&&this.setDirty(),r}updateGeometryIfNeeded(e){e.isLoaded&&e.renderData.updateGeometryIfNeeded(this._rctx)}unloadTile(e){const r=e.renderData;r&&(r.releaseGeometry(),this._renderDataPool.release(r),r.clear(),e.renderData=null,e.setMemoryDirty(),this.setDirty())}_getLocalOriginOfTile(e){const r=q3t-sj,i=Math.max(0,Math.floor((e.level-r)/sj)*sj);if(this._isGlobal&&i===0)return Nl;for(;e.parent&&e.level>i;)e=e.parent;return e.centerAtSeaLevel}setVisibility(e){this._visible=e,this.setDirty()}getStats(){return{numTilesRendered:this._numTilesRendered,numTilesCulled:this._numTilesCulled,numOriginsRendered:this._numOriginsRendered}}set wireframe(e){this._get("wireframe")!==e&&(this._set("wireframe",e),this.setNeedsRender())}setDirty(e=Us.UPDATE){this._patchGroupsDirty=!0,this._context.requestRender(e)}_setSortingDirty(e=Us.UPDATE){this._patchSortingDirty=!0,this._context.requestRender(e)}setNeedsRender(e=Us.UPDATE){this._context.requestRender(e)}initializeRenderContext(e){this._context=e,this._rctx=e.renderContext.rctx,this._techniqueRepository=e.techniqueRepository,this._tileRenderer=new N3t(this._rctx,this._tileSize,this._techniqueRepository),this.updateTileBackground(),this._emptyTex=c3e(this._rctx)}uninitializeRenderContext(){this._emptyTex=ze(this._emptyTex),this._tileRenderer=ze(this._tileRenderer)}intersect(e,r,i,s){if(!this._rootTiles||e.options.selectOpaqueTerrainOnly&&e.options.selectionMode&&this.transparency!==Qn.Opaque)return;const n=W3t,o=Z3t;pe(n,s,i),ie(o,1/n[0],1/n[1],1/n[2]);const a=e.results.min,l=e.results.max,c=e.results.ground,h=e.options.store===na.MIN,p=!!e.results.ground.target,f=Zft(e.verticalOffset),m=e.tolerance;let g,_=h&&a.dist!=null?a.dist:1/0;const v=x=>{const T=x.renderData;if(!T?.vao)return;const S=T.geometry;K6(nj,S.boundingBox);const O=T.localOrigin;f!=null&&(f.localOrigin=O,f.applyToAabb(nj));const A=nj;if(I2[0]=i[0]-O[0],I2[1]=i[1]-O[1],I2[2]=i[2]-O[2],!Lre(A,I2,o,m,_))return;const M=(G,ee,I)=>{G.set(this.type,x,ee,I,Un),_=h&&a.dist!=null?a.dist:1/0},P=(G,ee)=>{if(ee!=null&&G>=0&&(e.options.backfacesTerrain||de(ee,n)<0)&&(e.options.invisibleTerrain||!e.options.selectionMode||r==null||r(i,s,G))){if((c.dist==null||G<c.dist)&&M(c,G,ee),e.options.isFiltered)return;e.options.store===na.ALL&&(g==null?(g=ore(e.ray),M(g,G,ee),e.results.all.push(g)):G<g.dist&&M(g,G,ee)),(a.dist==null||G<a.dist)&&M(a,G,ee),e.options.store!==na.MIN&&(l.dist==null||G>l.dist)&&M(l,G,ee)}},F=X3t;pe(F,s,O);const $=S.indices,N=S.vertexAttributes,U=N.getField(E.POSITION,zn),X=new Ge(U.typedBuffer,3,!1,N.stride/4),Z=S.indexCount/3;if(!f&&Z>jNe){const G=x.renderData;G.intersectionData==null&&(G.intersectionData=new qie($,0,Z,X)),G.intersectionData.intersectRay({r0:I2,r1:F},P)}else I$(I2,F,0,Z,$,X,null,f,P)},b=this._rootTiles;b!=null&&(()=>{const x=this._tileIterator;x.reset(b);const T=e.options.invisibleTerrain;for(let S=x.next();S;S=x.next())!(S.visible||T&&S.intersectsClippingArea)||f==null&&!S.intersectsRay(i,n,m,_)||p&&this._useStencilForTile(S)?x.skipSubtree():v(S)})()}processScaleRangeQueries(e,r){if(!r.done)for(this._updatePatchGroups();e.updating&&!r.done;){e.prepare();for(const i of this._patchGroups.values())for(const s of i)s.renderData?.textureReference!=null&&e.queriesForTile(s);e.process(),r.madeProgress()}}prepareTechnique(e){if(e.bindParameters.slot===fe.OCCLUDED_TERRAIN){if(!(e.renderOccludedMask&YU))return null}else{const r=this.transparency===Qn.Opaque?fe.OPAQUE_TERRAIN:fe.TRANSPARENT_TERRAIN;if(e.bindParameters.slot!==r)return null}switch(e.output){case k.Color:return this.transparency===Qn.Empty?null:(this._techniqueConfiguration.hasScreenSpaceReflections=e.bindParameters.ssr.enabled,this._techniqueConfiguration.hasCloudsReflections=e.bindParameters.cloudsFade.data!=null,this._techniqueConfiguration.receiveShadows=e.bindParameters.shadowMap.ready,this._techniqueConfiguration.receiveAmbientOcclusion=e.bindParameters.ssaoHelper.active,this._techniqueConfiguration.overlayMode=this._overlayRenderer.isEmpty?x0.Disabled:this._overlayRenderer.hasWater?x0.EnabledWithWater:x0.Enabled,this._updateTechnique(k.Color,e.bindParameters.slot===fe.OCCLUDED_TERRAIN));case k.Shadow:case k.ShadowExcludeHighlight:return this._castShadows&&e.bindParameters.lighting.globalFactor===1?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Shadow,!1)):null;case k.Depth:return this.transparency===Qn.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Depth,!1));case k.Normal:return this.transparency===Qn.Empty?null:(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Normal,!1));case k.ObjectAndLayerIdColor:return this.transparency===Qn.Empty?null:this._updateTechnique(k.ObjectAndLayerIdColor,!1);case k.Highlight:return this.transparency!==Qn.Empty&&this.needsHighlight?(this._techniqueConfiguration.receiveShadows=this._techniqueConfiguration.receiveAmbientOcclusion=!1,this._updateTechnique(k.Highlight,!1)):null}return null}render(e,r){const i=e.bindParameters.lighting.globalFactor===1;switch(this._updatePatchGroups(),r.useStencil=!1,e.output){case k.Color:{const s=e.bindParameters.slot===fe.OCCLUDED_TERRAIN?Ol.Occluded:Ol.ColorAndWater;this.transparency===Qn.Opaque?this._renderMaterialPass(e,r,s):e.offscreenRenderingHelper.renderToTargets(()=>this._renderMaterialPass(e,r,s),e.offscreenRenderingHelper.tmpColor,e.offscreenRenderingHelper.mainDepth,[0,0,0,0]);break}case k.Depth:case k.Normal:this._renderAuxiliaryPass(e,r,Ol.ColorAndWater);break;case k.Highlight:this.needsHighlight&&this._renderAuxiliaryPass(e,r,Ol.Highlight);break;case k.Shadow:case k.ShadowExcludeHighlight:this._castShadows&&i&&this._renderAuxiliaryPass(e,r,Ol.None);break;case k.ObjectAndLayerIdColor:this._renderAuxiliaryPass(e,r,Ol.ObjectAndLayerIdColor)}}_renderMaterialPass(e,r,i){const{rctx:s}=e;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._numTilesRendered=0,this._numTilesCulled=0,this._numOriginsRendered=0,this._renderPatchGroups(e,r,i)}_renderAuxiliaryPass(e,r,i){const s=e.rctx;this._passParameters.overlaySource=i,s.bindTechnique(r,this._passParameters,e.bindParameters),this._renderPatchGroupsAuxiliary(e,r,i)}updateTileBackground(e=null){if(this._tileRenderer==null)return;const r=this._tileRenderer;let i=null;if(e!=null){const s=Le.toUnitRGBA(e);i=Ee(s[0]||0,s[1]||0,s[2]||0)}r.setBackground(i),this._allTiles.forAll(s=>r.updateTileTexture(s,$n.FADING)),this._techniqueConfiguration.tileBlendInput=r.backgroundIsGrid?tg.GridComposite:r.backgroundColor!=null?tg.ColorComposite:tg.LayerOnly,this.setNeedsRender()}_updatePatchGroups(){if(this._patchGroupsDirty&&(this._highestVisibleLODTile=null,this._rebuildPatchGroups(),this._patchGroupsDirty=!1,this._patchSortingDirty=!0),this._patchSortingDirty&&this.renderOrder!==HA.NONE){const e=Array.from(this._patchGroups.values()),r=this._stencilEnabledLayerExtents;for(const i of e)uNe(this.renderOrder,i,r);e.sort((i,s)=>hNe(i[0],s[0],this.renderOrder)),this._patchGroups=new Map(e.map(i=>[i[0].renderData.localOrigin,i])),this._patchSortingDirty=!1}}_rebuildPatchGroups(){const e=this._rootTiles;if(e!=null){e[0]?.surface.checkAllTilesWaterproofness(),this._patchGroups.clear();for(const r of e)this._rebuildPatchGroupsForRootTile(r)}}_rebuildPatchGroupsForRootTile(e){const r=this._tileIterator;for(r.resetOne(e);!r.done;){const i=r.next(),s=i.renderData;if(!s){this._numTilesCulled++;continue}if(!i.visible){this._numTilesCulled++,r.skipSubtree();continue}const n=s.localOrigin;let o=this._patchGroups.get(n);o||(o=new Array,this._patchGroups.set(n,o)),o.push(i),(!this._highestVisibleLODTile||i.elevationLevel>this._highestVisibleLODTile.elevationLevel)&&(this._highestVisibleLODTile=i),r.skipSubtree()}}_useStencilForTile(e){for(const r of this._stencilEnabledLayerExtents)if(e.intersectsExtent(r))return!0;return!1}_renderPatchGroupsAuxiliary(e,r,i){const s=this._stencilEnabledLayerExtents.length>0;this._patchGroups.forEach(n=>{const o=n[0].renderData.localOrigin;r.program.bindDraw(new kY(o),e.bindParameters,this._passParameters);for(let a=0;a<n.length;a++)this._renderPatch(e,r,n[a],Ot.TRIANGLES,s,i)}),e.rctx.bindVAO(null)}_renderPatchGroups(e,r,i){const s=e.bindParameters.camera,n=r.program;if(this._techniqueConfiguration.screenSizePerspective&&this.pointsOfInterest){const p=PIe(this._stage.viewingMode,this._ellipsoidRadius),f=this.pointsOfInterest.centerOnSurfaceFrequent.distance;p.update({distance:f,fovY:s.fovY})}const o=this._stencilEnabledLayerExtents.length>0,a=i===Ol.Occluded;a&&(n.bindTexture("tex",this._emptyTex),n.setUniform3fv("textureOpacities",Nl),n.setUniform4fv("texOffsetAndScale",ng));const l=this._tileRenderer!=null&&this._tileRenderer.backgroundColor!=null?this._tileRenderer.backgroundColor:Nl;this._techniqueConfiguration.tileBlendInput===tg.ColorComposite&&n.setUniform3fv("backgroundColor",l);const c=this.wireframe?Ot.LINES:Ot.TRIANGLES;this._techniqueConfiguration.textureFadingEnabled&&n.bindTexture("texNext",this._emptyTex);const h=this._patchGroups;for(const p of h.values()){const f=p[0].renderData.localOrigin;r.program.bindDraw(new kY(f),e.bindParameters,this._passParameters),this._numOriginsRendered++;for(const m of p){const g=m.renderData,_=g.textureReference;if(_!=null){if(!a){n.setUniform4fv("texOffsetAndScale",_.offsetAndScale),n.bindTexture("tex",_.texture.texture);const v=g.textureFadeFactor,b=v<1?g.nextTextureReference:null;this._techniqueConfiguration.textureFadingEnabled&&b!=null&&v<1?(n.setUniform1f("fadeFactor",v),n.setUniform4fv("nextTexOffsetAndScale",b.offsetAndScale),n.setUniform3fv("nextTexOpacities",b.opacities),n.bindTexture("texNext",b.texture.texture)):n.setUniform1f("fadeFactor",1),g.textureIsFading&&this.setNeedsRender(),n.setUniform3fv("textureOpacities",_.opacities)}this._renderPatch(e,r,m,c,o,i),m.renderOrder=this._numTilesRendered,this._numTilesRendered++}}}e.rctx.bindVAO(null)}_renderPatch(e,r,i,s,n,o){const a=i.renderData,l=a.vao,c=l.indexBuffer;if(c==null)return void(Nn&&console.error("Rendered tile with no indices: ",i.lij," : ",a));const h=r.program;o===Ol.None||this._overlayRenderer.isEmpty||this._bindOverlayPatchData(h,a.overlay),n&&(r.useStencil=this._useStencilForTile(i),r.bindPipelineState(e.rctx,e.bindParameters.slot));const p=a.geometry.indexCount;e.rctx.bindVAO(l),h.assertCompatibleVertexAttributeLocations(l),e.rctx.drawElements(s,p,c.indexType,0)}_bindOverlayPatchData(e,r){e.setUniform4fv("overlayTexOffset",r.offsets),e.setUniform4fv("overlayTexScale",r.scales)}_updateTechnique(e,r){return this._techniqueConfiguration.output=e,this._techniqueConfiguration.renderOccluded=r,this._shaderTechnique=this._techniqueRepository.releaseAndAcquire(vNe,this._techniqueConfiguration,this._shaderTechnique),this._shaderTechnique}get test(){return{tileRenderer:this._tileRenderer}}};u([d({constructOnly:!0})],Jc.prototype,"_overlayRenderer",void 0),u([d({constructOnly:!0})],Jc.prototype,"_stage",void 0),u([d({readOnly:!0})],Jc.prototype,"_isGlobal",null),u([d({constructOnly:!0})],Jc.prototype,"_allTiles",void 0),u([d({constructOnly:!0})],Jc.prototype,"_ellipsoidRadius",void 0),u([d({value:!1})],Jc.prototype,"renderingDisabled",null),u([d()],Jc.prototype,"renderPatchBorders",null),u([d()],Jc.prototype,"visualizeNormals",null),u([d()],Jc.prototype,"cullBackFaces",null),u([d({value:HA.FRONT_TO_BACK})],Jc.prototype,"renderOrder",null),u([d()],Jc.prototype,"wireframe",null),Jc=u([R("esri.views.3d.terrain.TerrainRenderer")],Jc);const W3t=C(),Z3t=C(),I2=C(),X3t=C();let Y3t=class{constructor(){this.numNodes=0,this.numLeaves=0,this.numVisible=0,this.numRendered=0,this.numSplit=0,this.numMerged=0,this.numRenderedPerLevel=new Array,this.numLoadedPerLevel=new Array}},Dm=class extends me{constructor(e){super(e),this._handles=new li}initialize(){this._handles.add(this.layers.on("change",()=>this._update())),this._handles.add(Q(()=>this.extentHelper.layerViewsExtent,()=>this._setAdHocTilingScheme())),this._update(),this.tilingSchemeLocked||this._setAdHocTilingScheme()}destroy(){this._handles=Re(this._handles),this._waitTask=null,this.layers.destroy()}_update(){if(this._waitTask=null,this.tilingSchemeLocked)return;let e;if(this.layers.some(r=>!(!GM(r)||r.isRejected())&&!(r.isFulfilled()&&!J3t(r,this.viewSpatialReference,this.viewingMode))&&(e=r,!(r?.type==="vector-tile"||n6(r)))),e)if(e.isResolved()){const r=Q8(e,this.viewSpatialReference,this.viewingMode);if(r!=null){const i=new fu(r.tileInfo);this._lockTilingScheme(i)}}else this._updateWhen(e)}_updateWhen(e){const r=e.when().catch(()=>{}).then(()=>{r!==this._waitTask||this.destroyed||this._update()});this._waitTask=r}_lockTilingScheme(e){if(this.viewingMode===Ue.Global){const r=e.levels.length-1;e.spatialReference.isWebMercator?e=fu.makeWebMercatorAuxiliarySphere(r):H1(e.spatialReference)&&(e=fu.makeGCSWithTileSize(e.spatialReference,e.pixelSize,r))}this.tilingSchemeLocked=!0,this.tilingScheme=e,this.extentHelper.tilingScheme=this.tilingScheme,this._updateTiledLayerExtent(),this._handles.removeAll(),this._handles.add(Q(()=>this.extentHelper.tiledLayersExtent,()=>this._updateTiledLayerExtent()))}_updateTiledLayerExtent(){this._set("extent",this.extentHelper.tiledLayersExtent)}_setAdHocTilingScheme(){if(this.viewingMode===Ue.Global){const e=this.extentHelper.viewSpatialReference,r=H1(e)||Pg(e)||$g(e);e.isWebMercator?this.tilingScheme=fu.WebMercatorAuxiliarySphere:r&&(this.tilingScheme=fu.makeGCSWithTileSize(e,256)),this._set("extent",this.extentHelper.layerViewsExtent)}else{const e=this.extentHelper.layerViewsExtent;e==null||Kx(e,this.extent)||(this.tilingScheme=fu.fromExtent(e,this.extentHelper.viewSpatialReference),this._set("extent",e))}}get test(){return{lockTilingScheme:e=>this._lockTilingScheme(e),done:!this._waitTask}}};function J3t(t,e,r){return Q8(t,e,r)!=null}u([d()],Dm.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Dm.prototype,"extent",void 0),u([d({value:!1})],Dm.prototype,"tilingSchemeLocked",void 0),u([d({constructOnly:!0})],Dm.prototype,"viewSpatialReference",void 0),u([d({constructOnly:!0})],Dm.prototype,"layers",void 0),u([d({constructOnly:!0})],Dm.prototype,"extentHelper",void 0),u([d({constructOnly:!0})],Dm.prototype,"viewingMode",void 0),Dm=u([R("esri.views.3d.terrain.TilingSchemeLogic")],Dm);let Q3t=class{constructor(){this.offset=Pe(),this.scale=0,this.tile=null}init(e,r,i,s){this.tile=e,this.offset[0]=r,this.offset[1]=i,this.scale=s}dispose(){this.tile=null,this.offset[0]=0,this.offset[1]=0,this.scale=0}},Yt=class extends Xr.EventedMixin(me){constructor(e){super(e),this._scaleRangeQueries=new b5,this._iteratorPool=new $o(cNe,r=>r.remove=()=>this._iteratorPool.release(r)),this._postorderIterator=new WOt,this._hasPendingUpdates=!1,this._pendingUpdates=0,this._asyncWorkItems=0,this._allTilesDirty=!0,this._allTilesSorted=!0,this._visibleCached=!1,this._usedMemory=null,this._performanceInfo=new Y3t,this._viewChanged=!1,this._inFrameTask=!1,this._viewChangeUpdateDirty=!1,this._eyePosRenderSR=C(),this._eyePosSurfaceSR=C(),this._splitLimits=new Gp,this._frustum=fP(),this._viewProjectionMatrix=xe(),this._layerViews=[new Array,new Array],this._layerIndexByUid=[new Map,new Map],this._basemapLayerViewHandles=new Map,this._handles=new li,this._watchUpdatingTracking=new vf,this._frameTask=AA,this._allTiles=new qt,this._upsampleInfoPool=new $o(Q3t),this._rootTilesExtent=Ht(),this.updatingProgress=.5,this._maxNumUpdating=1,this.maxTextureScale=1.2,this._spatialReference=qe.WebMercator,this.visibleElevationBounds=new pC(1/0,-1/0),this.rootTileElevationBounds=new pC(1/0,-1/0),this._updatingRootTiles=!1,this._pendingTilesForElevationUpdateEvent=new Set,this._pendingTilesToUpdate=new Set,this.totalGeometryUpdates=0,this.totalTileUpdates=0,this.oneBatchPerFrameTask=!0,this._layerViewsDirty=!1,this.unloadedMemory=0,this.ignoresMemoryFactor=!1,this._isWebMercator=!1,this._isWebMercatorOnPlateeCarree=!1,this.overlayManager=new Tl({...e,surface:this}),this._isGlobal=!e.view?.state?.isLocal}initialize(){this._lercDecoder=_Ot(this.view.resourceController),this._tilePool=this.view.state.isLocal?new $o(n3t):new $o(a3t);const e=this.view.resourceController.memoryController;this._upsampleMapCache=e.newCache("terrain-upsample",o=>o.unloadMapData()),this._elevationQueryCache=new gOt(e.newCache("elevation-query")),this._handles.add([Q(()=>this.overlayManager.hasHighlights,o=>this._renderer.setNeedsHighlight(o)),Q(()=>this.overlayManager.rendersOccluded,o=>this._renderer.setRenderOccludedOverlay(o)),Q(()=>this.overlayManager.renderer.isEmpty,()=>this._evaluateTransparency())],"overlayManager"),this._renderer=new Jc({_overlayRenderer:this.overlayManager.renderer,_ellipsoidRadius:Ir(this.view.spatialReference).radius,_stage:this.view._stage,_allTiles:this._allTiles}),this._handles.add([Q(()=>this.baseOpacity,()=>{this._handleLayerViewChanges(),this._updateTileTextures(this._evaluateTransparency()?$n.UNFADED:$n.IMMEDIATE)},Ri),Q(()=>this.hasCompositeBlendMode,()=>this._updateTileTextures(this._evaluateTransparency()?$n.UNFADED:$n.IMMEDIATE),Ri),Q(()=>this.renderingDisabled,()=>this.view?._stage?.renderer.setParameters({terrainRenderingEnabled:!this.renderingDisabled}),Rr),Q(()=>this.backgroundColor,o=>{this._handleLayerViewChanges(),this._renderer.updateTileBackground(o)},Ri),Q(()=>this.snapLevel,()=>this._viewChanged=!0,Rr),Q(()=>this.view.pointsOfInterest,o=>{this._renderer.pointsOfInterest=o,this._watchUpdatingTracking.removeAll(),o&&this._watchUpdatingTracking.add(()=>o.focus.renderLocation,()=>this._allTilesSorted=!1)}),Q(()=>bi.TERRAIN_TILE_TREE_SHOW_TILES,o=>{o&&!this._treeDebugger?J(()=>import("./TerrainTileTree3DDebugger-36d9af5a.js"),["./TerrainTileTree3DDebugger-36d9af5a.js","./TileTreeDebugger-2812c7df.js"],import.meta.url).then(({TerrainTileTree3DDebugger:a})=>{!this._treeDebugger&&bi.TERRAIN_TILE_TREE_SHOW_TILES&&(this._treeDebugger=new a({view:this.view}))}):o||(this._treeDebugger=Re(this._treeDebugger))},xt)]);const{spatialReference:r}=this.view;this._extentHelper=LOt(this.viewingMode,{layers:this.view.map.allLayers,layerViews:this.view.allLayerViews,viewSpatialReference:r});const i=new lP({getCollections:()=>this.view?.defaultsFromMap?.mapCollections?.map(({layers:o})=>o),getChildrenFunction:o=>o&&"layers"in o?o.layers:null}),s=new Dm({layers:i,extentHelper:this._extentHelper,viewingMode:this.viewingMode,viewSpatialReference:r});this._set("tilingSchemeLogic",s),this._updateTilingScheme(),this._elevationDataRequester=this.view.resourceController.createStreamDataRequester(Jm.ELEVATION),this._mapDataRequester=this.view.resourceController.createStreamDataRequester(Jm.BASEMAP);const n=this.view.resourceController.scheduler;this._frameTask=n.registerTask(gt.TERRAIN_SURFACE,this),this._handles.add([Q(()=>this._extentHelper.stencilEnabledExtents,o=>this._renderer.setStencilEnabledLayerExtents(o),xt),Q(()=>this.tilingSchemeLogic.tilingScheme,()=>this._updateTilingScheme(),Rr),Q(()=>this.extent,()=>this._updateRootTiles(),xt),this.view.on("resize",()=>this._viewChangeUpdate()),Q(()=>{const o=this.view,a=o.state;return[this._lodBias,this.lodSnapping,o.resourceController?.memoryController?.memoryFactor,a.camera,a.contentCamera,a.fixedContentCamera]},()=>this._viewChangeUpdate(),Ri),Q(()=>this.view.qualitySettings?.tiledSurface?.textureFadeDuration,o=>this._renderer.textureFadingEnabled=o>0,xt),Q(()=>this.view.qualitySettings?.physicallyBasedRenderingEnabled,o=>this._renderer.pbrMode=o?lt.Terrain:lt.Disabled,xt),Q(()=>this._userClippingExtent,()=>this._updateClippingExtent(),Rr)]),this._handles.add(this.view.allLayerViews.on("after-changes",()=>this._layerViewsDirty=!0)),this._layerViewsDirty=!0,this._handleLayerViewChanges()}destroy(){this._frameTask.remove(),this._handles.destroy(),this._watchUpdatingTracking.destroy(),this._lercDecoder=as(this._lercDecoder),this._removeAllTiles(),this._upsampleMapCache=Re(this._upsampleMapCache),this._elevationQueryCache=Re(this._elevationQueryCache),this._set("tilingSchemeLogic",Re(this.tilingSchemeLogic)),this._basemapLayerViewHandles.forEach((e,r)=>this._unregisterTiledLayerView(r)),this._elevationDataRequester=null,this._mapDataRequester=null,this._set("overlayManager",Re(this.overlayManager)),this._tilePool=Re(this._tilePool),kie.prune(),this._treeDebugger=Re(this._treeDebugger),this._renderer=Re(this._renderer),this._iteratorPool=Re(this._iteratorPool),this._set("view",null),this._extentHelper=Re(this._extentHelper),this._upsampleInfoPool=Re(this._upsampleInfoPool),ROt(),xRt()}get renderer(){return this._renderer}get frustum(){return this._frustum}get snapLevel(){if(this.lodSnapping===dI.ON){const e=this.view,r=this.tilingScheme,i=e.pointsOfInterest?.cameraOnSurface?.scale;if(r&&i){const s=e.state.contentCamera;let n=E8(e,s.eye,s.viewForward,s.up).tilt;n>90&&(n=180-n);const o=2*(n/90)**2,a=r.levelAtScale(i)-o,l=Math.min(a,this._splitLimits.maxLod||1/0);return l<=0?null:l}}return null}get lodSnapping(){return this.view.qualitySettings.tiledSurface.reduceTileLevelDifferences?dI.ON:dI.OFF}get upsampleInfoPool(){return this._upsampleInfoPool}get upsampleMapCache(){return this._upsampleMapCache}get elevationQueryCache(){return this._elevationQueryCache}get mapTileRequester(){return this._mapDataRequester}get _userClippingExtent(){const{spatialReference:e}=this,{clippingArea:r}=this.view;if(r==null||e==null)return null;const i=Ht(),s=BDe(r,i,e)?i:null,n=this._get("extent");return Kx(s,n)?n:s}get rootTilesExtent(){return this._rootTilesExtent}get extent(){const e=y7(this.groundExtent,this._userClippingExtent,Ht()),r=this._get("extent");return Kx(e,r)?r:e}get groundExtent(){return this._tilingSchemeExtent!=null?this._tilingSchemeExtent:this._rootTilesExtent}get _tilingSchemeExtent(){return this.tilingSchemeLogic?.extent}get updating(){return this._hasPendingUpdates||(this._maxNumUpdating=1),!!((this.running||this._watchUpdatingTracking?.updating||this._asyncWorkItems>0)&&this.ready&&!this.suspended||this.overlayManager?.updating)}get running(){return(this._hasPendingUpdates||this._viewChanged||this._allTilesDirty||!this._allTilesSorted||this._layerViewsDirty||this._scaleRangeQueries.updating||this._frameTask.updating)&&this.ready&&!this.suspended}get updatingProgressValue(){return this._maxNumUpdating=Math.max(this._pendingUpdates,this._maxNumUpdating),1-this._pendingUpdates/this._maxNumUpdating}get baseOpacity(){return this.view?.map?.ground?.opacity??1}set baseOpacity(e){this.view.map.ground.opacity=e}get viewingMode(){return this.view.state.viewingMode}get ready(){return this._rootTiles!=null}set renderOrder(e){this._renderer.renderOrder=e,this._set("renderOrder",e)}get rootTiles(){return this._rootTiles}get spatialReference(){return this.tilingScheme?.spatialReference??null}get backgroundColor(){return this.view.map.ground.surfaceColor}set backgroundColor(e){this.view.map.ground.surfaceColor=e}set slicePlaneEnabled(e){this._renderer.slicePlaneEnabled=e,this._set("slicePlaneEnabled",e),this._evaluateTransparency()}get tilingSchemeLocked(){return this.tilingSchemeLogic?.tilingSchemeLocked??!1}get wireframe(){return this._renderer?.wireframe}set wireframe(e){e!==this._renderer.wireframe&&(this._renderer.wireframe=e,this._updateAllTileGeometries())}set _visible(e){e!==this._visibleCached&&(this._visibleCached=e,this._renderer.setVisibility(e),this.suspended=!e)}get opaque(){return this._renderer.transparency===Qn.Opaque}set suspended(e){this._set("suspended",e),this._viewChangeUpdate()}get textureFadeDuration(){return this.view.qualitySettings.tiledSurface.textureFadeDuration??0}intersect(e,r,i,s){this._renderer.intersect(e,r,i,s)}getElevation(e,r,i,s){const n=this._rootTiles;if(n==null||!n.length||n[0].layerInfo[nr.ELEVATION].length===0)return null;const o=Ql;return o[0]=e,o[1]=r,o[2]=i,Tn(o,s,o,this._spatialReference)?mye(n,o[0],o[1]):(K.getLogger(this).error("TerrainSurface.getElevation(): could not project given point to tiling scheme coordinate system"),null)}getElevations(e,r,i){const s=this._rootTiles,n=s?s[0].layerInfo[nr.ELEVATION].length:0;if(s!=null&&s.length&&n!==0)for(let o=0;o<r;++o){const a=3*o;i(o,mye(s,e[a],e[a+1]))}else for(let o=0;o<r;++o)i(o,null)}getScale(e){if(!this.tilingScheme)return null;if(!aa(e,Ql,this.spatialReference))return K.getLogger(this).error("TerrainSurface.getScale(): could not project given point to tiling scheme coordinate system"),null;const r=this._rootTiles;if(r!=null){for(const i of r)if(i?.containsPoint(Ql)){let s=i;for(;s.children[0]&&!s.rendered;){const n=s.children[0].extent;let o=0;Ql[0]>n[2]&&(o+=1),Ql[1]<n[1]&&(o+=2),s=s.children[o]}return this._getLodBiasCorrectedScale(s.level)}}return 1/0}getSphereElevationBounds(e,r){if(Ql[0]=e[0],Ql[1]=e[1],Ql[2]=e[2],Ql[3]=e[3],!Tn(Ql,r,Ql,this.tilingScheme?.spatialReference))return K.getLogger(this).error("TerrainSurface.getSphereElevationBounds(): could not project given point to tiling scheme coordinate system"),null;let i=1/0,s=-1/0;const n=a=>{if(a&&Tne(a.extent,Ql))if(a.isLeaf||a.rendered)i=Math.min(i,a.elevationBounds[0]),s=Math.max(s,a.elevationBounds[1]);else for(const l of a.children)n(l)},o=this._rootTiles;if(o!=null)for(const a of o)n(a);return{min:i,max:s}}getSphereScale(e,r){if(!this.tilingScheme)return null;if(!aa(e,Ql,this.spatialReference))return K.getLogger(this).error("TerrainSurface.getSphereScale(): could not project given point to tiling scheme coordinate system"),null;Ql[3]=r;let i=null;const s=o=>{if(o&&Tne(o.extent,Ql)){const a=o.children;if(a[0]&&!o.rendered)for(const l of a)s(l);else{const l=this._getLodBiasCorrectedScale(o.level);i=i==null?l:Math.min(i,l)}}},n=this._rootTiles;if(n!=null)for(const o of n)s(o);return i}queryVisibleScaleRange(e,r,i,s){const n=r?this.tilingScheme.levelAtScale(r):0,o=i?this.tilingScheme.levelAtScale(i):1/0,a=this._lodBias;this._scaleRangeQueries.queryVisibleLevelRange(e,n+a,o+a,s)}_evaluateTransparency(){const e=this.baseOpacity,r=this.overlayManager.renderer.isEmpty,i=this._renderer.transparency,s=this._allSurfaceLayersTransparent()?r?Qn.Empty:Qn.TransparentWithDraped:e>=1&&!this.hasCompositeBlendMode&&!this._renderer.slicePlaneEnabled?Qn.Opaque:Qn.Semitransparent,n=i!==s;return n&&(this._renderer.transparency=s,this.view?._stage?.renderer.setParameters({terrainTransparency:this._renderer.transparency})),n}_updateTilingScheme(){const e=this.tilingSchemeLogic.tilingScheme;if(e===this.tilingScheme)return;jm(!!e,"tiling scheme cannot be reset to undefined"),this._isGlobal=!this.view?.state?.isLocal,this.tilingScheme&&this._removeAllTiles();const r=e?.spatialReference??qe.WebMercator;this._spatialReference=r,this._isWebMercator=!!r?.isWebMercator,this._isWebMercatorOnPlateeCarree=this._isWebMercator&&kI(this.view?.renderSpatialReference),this._set("tilingScheme",e),this._updateClippingExtent(),e&&(this._updateTiledLayers(),this._renderer.setTileSize(e.pixelSize),this.overlayManager.setSpatialReference(e.spatialReference),this._updateRootTiles())}_acquireTile(e,r,i,s){const n=this._tilePool.acquire();return tF[0]=e,tF[1]=r,tF[2]=i,n.init(tF,s,this),n}get updatingRootTiles(){return this._updatingRootTiles}_updateRootTiles(){const{extent:e,tilingScheme:r}=this;if(!r)return;const i=tMt;let s=r.rootTilesInExtent(e,i,5*tC);if(this._rootTiles!=null){if(s.length>tC)return void K.getLogger(this).warn(Vct);const n=this._rootTiles.map(a=>a.lij),o=y4e(n,s,fye);if(this._updatingRootTiles=!0,o.removed.length>0||o.added.length>0){const a=this._rootTiles.filter(l=>!(o.removed.findIndex(c=>fye(c,l.lij))>-1)||(this._purgeTile(l),!1));o.added.forEach(l=>a.push(this._newRootTile(l))),this._setRootTiles(a)}}else this._updatingRootTiles=!0,s.length>tC&&(K.getLogger(this).warn(zct),s=r.rootTilesInExtent(e,i,tC)),this._setRootTiles(s.map(n=>this._newRootTile(n)));Kx(i,this._rootTilesExtent)||(this._rootTilesExtent=Ht(i)),this._visible=!0,this._viewChangeUpdate(),this.overlayManager.setPlacementDirty(),this.notifyChange("ready"),this._updateAllTileGeometries(),this._updatingRootTiles=!1,this.checkAllTilesWaterproofness()}_updateAllTileGeometries(){const e=this._allTiles.filter(r=>r.isLoaded&&r.intersectsClippingArea);e.forEach(r=>this._renderer.updateTileGeometryState(r)),e.forEach(r=>r.renderData.updateNeighborData()),this._updateTilesGeometries(e),this._pendingTilesToUpdate.clear()}_updateTilesGeometries(e){if(e.length===0)return;e.sort(w0);const r=this.renderer;e.forEach(i=>r.updateGeometryIfNeeded(i)),e.forEach(i=>this._pendingTilesForElevationUpdateEvent.add(i))}_shouldSplit(e){return e.shouldSplit(this._splitLimits,this._eyePosRenderSR,this.snapLevel)===vt.SPLIT}_newRootTile(e){const r=this._acquireTile(0,e[1],e[2],null);return this._shouldSplit(r)&&r.setPendingUpdate(vt.SPLIT),this._loadTile(r),this._markTileToUpdate(r),this._updateRootTileElevationBounds(),r}_setRootTiles(e){if(this._rootTiles=e,this._allTiles.clear(),e!=null){const r=this._iteratorPool.acquire();for(r.reset(e);!r.done;)this._allTiles.push(r.next());r.remove()}this._renderer.setRootTiles(this._rootTiles),this._updateTilesVisibility(e)}_runViewChangeUpdateIfDirty(){this._viewChangeUpdateDirty&&(this._viewChangeUpdateDirty=!1,this._viewChangeUpdate())}_viewChangeUpdate(){this.view&&!this.suspended&&this.tilingScheme&&this._visibleCached&&(this._inFrameTask?this._viewChangeUpdateDirty=!0:(this._viewChangeUpdateDirty=!1,this._updateViewDependentParameters(),this._updateTilesVisibility(this._rootTiles)))}_updateClippingStatus(e){e.updateClippingStatus(this.extent)&&e.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometryState(e)}_updateTilesVisibility(e){if(e==null)return;const r=eRt(e),i=this.visibleElevationBounds;let s=r?i.min:1/0,n=r?i.max:-1/0;const o=this.extent,a=this._viewProjectionMatrix;this.setTileTreeDirty();const l=this._iteratorPool.acquire();for(l.reset(e);!l.done;){const c=l.next();c.updateClippingStatus(o)&&c.resetPendingUpdate(vt.GEOMETRY)&&this._updateTileGeometryState(c),c.setPendingUpdate(vt.RENDERDATA),c.computeVisibility(),c.updateScreenDepth(a),c.renderData&&(s=Math.min(c.elevationBounds[0],s),n=Math.max(c.elevationBounds[1],n))}l.remove(),this._viewChanged=!0,this._allTilesDirty=!0,this._batchUpdatePendingTileGeometries(),isFinite(s)&&isFinite(n)&&(i.min!==s||i.max!==n)&&(this.visibleElevationBounds=new pC(s,n))}_updateRootTileElevationBounds(){let e=1/0,r=-1/0;const i=this._rootTiles;i?.forEach(({elevationBounds:n})=>{e=Math.min(e,n[0]),r=Math.max(r,n[1])});const s=this.rootTileElevationBounds;s.min===e&&s.max===r||(this.rootTileElevationBounds=new pC(e,r))}_updateViewDependentParameters(){const{camera:e,contentCamera:r}=this.view.state,i=Math.tan(.5*r.fovX),s=Math.tan(.5*r.fovY),n=this.tilingScheme.pixelSize,o=2**-this._lodBias*e.pixelRatio;this._splitLimits.aboveGround=e.aboveGround,this._splitLimits.fovX=i,this._splitLimits.fovY=s,this._splitLimits.relativeWidthLimit=n/e.width*this.maxTextureScale*o,this._splitLimits.relativeHeightLimit=n/e.height*this.maxTextureScale*o,this._splitLimits.maxLod=this.tilingScheme.getMaxLod(),this._splitLimits.angledSplitBias=this.view.qualitySettings.tiledSurface.angledSplitBias,this.view.state.fixedContentCamera?(this._splitLimits.frustum==null&&(this._splitLimits.frustum=fP()),gU(this._splitLimits.frustum,r.frustum)):this._splitLimits.frustum=null,gU(this._frustum,e.frustum),yi(this._viewProjectionMatrix,r.projectionMatrix,r.viewMatrix),oe(this._eyePosRenderSR,r.eye),Tn(e.eye,this.view.renderSpatialReference,this._eyePosSurfaceSR,this.spatialReference)}_updateRenderData(e){e.rendered&&!e.shouldLoad&&(qNe(e)?this._loadChildren(e):eMt(e)&&this._loadParent(e))}_updateTileGeometryState(e){e.updateVisibility(),this._renderer.updateTileGeometryState(e)&&this._markTileToUpdate(e),this._usedMemory=null}_markAllTileNeighborsForGeometryUpdate(e){const r=this._pendingTilesToUpdate;e.forEachLoadedNeighbor(i=>{r.add(i)})}_updateTileTexture(e,r){const i=e.resetPendingUpdate(vt.TEXTURE_FADING)?vt.TEXTURE_FADING:!!e.resetPendingUpdate(vt.TEXTURE_NOFADING)&&vt.TEXTURE_NOFADING;i&&(this._renderer.updateTileTexture(e,i),this._usedMemory=null,r.madeProgress())}_emitElevationUpdateEventForTiles(){const e=aj.extent;Au(e),this._pendingTilesForElevationUpdateEvent.forEach(r=>E1(e,r.extent,e)),this._pendingTilesForElevationUpdateEvent.clear(),aj.spatialReference=this.spatialReference,this.emit("elevation-change",aj)}runTask(e){this._handleLayerViewChanges(e),this._frameTask.processQueue(e),this.renderer.processScaleRangeQueries(this._scaleRangeQueries,e),this._inFrameTask=!0,this._pendingUpdates=0,this._hasPendingUpdates=!1,this._updateAllTilesStatus(e),this._sortTiles(e);const r=!this.view.state.fixedContentCamera;this._mergeAndSplit(e,r),this._updateElevation(e),this._updateTextures(e),r||this._mergeAndSplit(e,!0),this._inFrameTask=!1,this._runViewChangeUpdateIfDirty(),this._batchUpdatePendingTileGeometries(),this._emitElevationUpdateEventForTiles(),e.done&&e.hasProgressed&&this.requestUpdate(),this.notifyChange("updatingProgressValue")}_updateAllTilesStatus(e){if(!this._viewChanged||!this._rootTiles||e.done)return;this._viewChanged=!1;const r=this._iteratorPool.acquire();r.reset(this._rootTiles);const i=this.snapLevel,s=this._splitLimits,n=this._eyePosRenderSR;for(;!r.done;){const o=r.next(),a=o.shouldSplit(s,n,i);if(a!==vt.SPLIT){if(o.resetPendingUpdate(vt.SPLIT)&&o.updateAgentSuspension(),a===vt.ELEVATION&&o.updateAgents(nr.ELEVATION),r.skipSubtree(),!o.isLeaf){o.setPendingUpdate(vt.MERGE),o.resetPendingUpdate(vt.SPLIT);const l=this._iteratorPool.acquire();l.resetOne(o);const c=this._viewProjectionMatrix;for(let h=l.next();!l.done;h=l.next())this._updateClippingStatus(h),h.updateVisibility(),h.updateScreenDepth(c);l.remove()}}else o.resetPendingUpdate(vt.MERGE),o.isLeaf&&(o.setPendingUpdate(vt.SPLIT),r.skipSubtree()),o.rendered&&o.setPendingUpdate(vt.RENDERDATA)}r.remove(),this.requestUpdate(),(this.shortBatches||!this.oneBatchPerFrameTask)&&this._batchUpdatePendingTileGeometries(),e.madeProgress()}_sortTiles(e){e.done||this._allTilesSorted||(QOt(this._allTiles,this.view.pointsOfInterest.focus.renderLocation),this._allTilesSorted=!0,this._treeDebugger&&this._treeDebugger.update(),e.madeProgress())}_markTileToUpdate(e){Se(e.isLoaded),e.intersectsClippingArea&&(this._pendingTilesToUpdate.add(e),this._markAllTileNeighborsForGeometryUpdate(e))}_batchUpdatePendingTileGeometries(){const e=this._pendingTilesToUpdate;if(e.size===0)return;const r=Array.from(this._pendingTilesToUpdate.keys()).filter(n=>n.isLoaded&&n.intersectsClippingArea),i=(n,o)=>{!o?.isLoaded||!o.intersectsClippingArea||o.level<n.level||e.has(o)||(e.add(o),r.push(o),o.renderData.updateNeighborData())};r.sort(w0);const s=r.length;for(let n=0;n<s;++n){const o=r[n];Se(o.isLoaded),Se(o.intersectsClippingArea);const a=o.renderData;a.updateNeighborData();const l=a._dirtyEdgeResolutions,c=a.geometryState.neighborData.cornerPeerNeighbors,h=p=>{const f=PP[p];i(o,c[p]?.findCorner(a6(f),m=>m.isLoaded))};for(let p=0;p<4;++p)if(l&1<<p){const f=a.geometryState.neighborData.edgePeerNeighbors[p];f&&f?.level>=o.level&&f.forAllSubtreeOnSide(l6(eg[p]),m=>!(!m.isLoaded||!m.intersectsClippingArea)&&(Se(e.has(m)||w0(o,m)<0),i(o,m),!0)),h((p+1)%4),h(p)}}e.clear(),this._updateTilesGeometries(r),Nn&&s6&&this.checkAllTilesWaterproofness()}_mergeAndSplit(e,r){if(this.suspended||e.done||!this._allTilesDirty)return;this._allTilesDirty=!1,this.requestUpdate();let i=!1;const s=this.view.state.fixedContentCamera;let n=!1;for(;!e.done;){n=!0;let o=!1;const a=!this._allTiles.some(l=>{if(!i&&!s&&!l.visible)return e.done;let c=l;if(l.resetPendingUpdate(vt.MERGE)){if(!r)return l.setPendingUpdate(vt.MERGE),e.done;for(;c.parent?.resetPendingUpdate(vt.MERGE);)c=c.parent;this._mergeTile(c),o=!0,e.madeProgress()}else l.resetPendingUpdate(vt.SPLIT)&&(this._splitTile(l),o=!0,e.madeProgress());return!e.done&&c===l&&l.resetPendingUpdate(vt.RENDERDATA)&&(this._updateRenderData(l),e.madeProgress()),e.done});if(o&&(this._allTilesSorted=!1,this._allTilesDirty=!0),a){if(!i){i=!0;continue}if(!o)break}else this._allTilesDirty=!0}n?e.madeProgress():this._allTilesDirty=!0,!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries(),this._sortTiles(e)}_updateElevation(e){e.done||(this._allTiles.some(r=>(r.resetPendingUpdate(vt.GEOMETRY)&&(this._updateTileGeometryState(r),this._updateTileTexture(r,e),this.shortBatches&&this._batchUpdatePendingTileGeometries(),e.madeProgress()),e.done)),!this.oneBatchPerFrameTask&&this._batchUpdatePendingTileGeometries())}_updateTextures(e){e.done||this._allTiles.some(r=>(this._updateTileTexture(r,e),e.done))}_updateClippingExtent(){this.spatialReference&&(this.updateTileOverlayParams(Us.UPDATE),this.overlayManager.setPlacementDirty(),this._updateRootTiles())}get _lodBias(){const e=this.view.resourceController.memoryController.memoryFactor;return this.view.qualitySettings.tiledSurface.lodBias-(1-e)*kct}_getLodBiasCorrectedScale(e){const r=this.tilingScheme.levels,i=ye(e-this._lodBias,0,r.length-1),s=i-Math.floor(i);return r[Math.floor(i)].scale*(1-s)+r[Math.ceil(i)].scale*s}_removeAllTiles(){this._rootTiles!=null&&(this._rootTiles.forEach(e=>this._purgeTile(e)),this._setRootTiles(null),this.notifyChange("ready")),this._allTiles.clear(),this._visible=!1}_purgeDescendantTiles(e){if(!e.children[0])return!1;let r=!1;for(let i=0;i<4;++i)r=this._purgeTile(e.children[i])||r;return e.unsetChildren(),r}_purgeTile(e){const r=this._purgeDescendantTiles(e)||e.rendered;return this._allTiles.removeUnordered(e),this._unloadTile(e),this._tilePool.release(e),r}_unloadTile(e){this._pendingTilesToUpdate.delete(e),this._pendingTilesForElevationUpdateEvent.delete(e),e.unload(this._renderer)}_splitTile(e){jm(e.isLeaf,"tile that is already split should not be split again!");const r=e.level+1,i=2*e.lij[1],s=2*e.lij[2];e.setChildren(this._createTile(r,i,s,e),this._createTile(r,i,s+1,e),this._createTile(r,i+1,s,e),this._createTile(r,i+1,s+1,e)),e.setPendingUpdate(vt.RENDERDATA),e.updateAgentSuspension(),this._allTiles.pushArray(e.children),this._allTilesDirty=!0,++this._performanceInfo.numSplit}_emitTileScaleChange(e,r=e.level){rF.spatialReference=this.spatialReference,rF.extent=e.extent,rF.scale=this._getLodBiasCorrectedScale(r),this.emit("scale-change",rF)}_createTile(e,r,i,s){jm(!!s,"_createTile sanity check");const n=this._acquireTile(e,r,i,s);return n.updateClippingStatus(this.extent),n.updateScreenDepth(this._viewProjectionMatrix),this._shouldSplit(n)&&n.setPendingUpdate(vt.SPLIT),n}get shortBatches(){return this.view.state.mode!==Br.IDLE}_mergeTile(e){jm(!e.hasPendingUpdate(vt.SPLIT),"_mergeTile sanity check"),this._purgeDescendantTiles(e)&&(jm(!e.renderData,"_mergeTile sanity check"),this._loadTile(e),this._markTileToUpdate(e),this._emitTileScaleChange(e),this.shortBatches&&this._batchUpdatePendingTileGeometries()),this._allTilesDirty=!0,++this._performanceInfo.numMerged}_loadChildren(e){jm(e.rendered,"parent should be rendered"),this._unloadTile(e);const r=e.children;r.forEach(i=>this._loadTile(i)),r.forEach(i=>this._pendingTilesToUpdate.add(i)),this._markAllTileNeighborsForGeometryUpdate(e),this._emitTileScaleChange(e,e.level+1),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_loadParent(e){const r=e.parent;this._unloadChildren(r),this._loadTile(r),this._markTileToUpdate(r),this._emitTileScaleChange(r,r.level),this.shortBatches&&this._batchUpdatePendingTileGeometries()}_unloadChildren(e){const r=e.children;if(r[0])for(let i=0;i<4;++i){const s=r[i];this._unloadChildren(s),this._unloadTile(s)}}_loadTile(e){e.load(),e.setPendingUpdate(vt.RENDERDATA),this.requestUpdate(),this._allTilesDirty=!0,this.overlayManager&&this.overlayManager.hasOverlays&&this.overlayManager.setTileParameters(e)}_elevationDataArrived(e,r,i){const s=new POt(e.lij,e.extent,i);e.dataArrived(r,nr.ELEVATION,s);const n=[e],o=e.level,a=this._iteratorPool.acquire();for(a.reset(n);!a.done;){const l=a.next();l.findElevationBoundsForLayer(r,o),l.computeElevationBounds()}o===0&&this._updateRootTileElevationBounds(),a.remove(),this._updateTilesVisibility(n)}_handleLayerViewChanges(e=Ll){if(!this._layerViewsDirty)return;this._layerViewsDirty=!1;let r=!1;const i=new Set;let s=-1;for(const n of this.view.allLayerViews.items)if(i.add(n.uid),IP(n)||VR(n))if(this._basemapLayerViewHandles.has(n.uid)&&!VR(n)){const o=this._layerClassFromLayerView(n),a=this._getLayerIdxByUID(o,n.uid);a!=null&&((a<s||s==null)&&(r=!0),s=a)}else this._registerTiledLayerView(n),n.layer.loaded&&(r=!0);this._basemapLayerViewHandles.forEach((n,o)=>{i.has(o)||(this._unregisterTiledLayerView(o),r=!0)}),r&&this._updateTiledLayers(),this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._evaluateTransparency(),e.madeProgress()}_allSurfaceLayersTransparent(){let e=this.view.map?.ground?.opacity===0;for(const r of this.view.allLayerViews.items)if(QY(r)&&!Wxe(r.layer)&&r.fullOpacity!==0)return e=!1,e;return e}_hasCompositeBlendMode(){for(const e of this.view.allLayerViews.items)if((o6(e)||VR(e))&&oRt(iJ[e.layer.blendMode]))return!0;return!1}_layerClassFromLayerView(e){return JY(e)?nr.ELEVATION:nr.MAP}_registerTiledLayerView(e){const r=[];if((o6(e)||VR(e))&&r.push(Q(()=>e.layer.blendMode,()=>{this.hasCompositeBlendMode=this._hasCompositeBlendMode(),this._updateTileTextures($n.UNFADED)})),!VR(e)){const i=this._layerClassFromLayerView(e);r.push(Q(()=>e.suspended,()=>this._updateTiledLayers())),r.push(Q(()=>e.fullOpacity,()=>this._updateTileTextures($n.UNFADED))),r.push(Q(()=>"effectiveScaleRange"in e.layer?e.layer.effectiveScaleRange:null,()=>this._restartAllAgents(i))),r.push(e.on("data-changed",()=>{const s=this._getLayerIdxByUID(i,e.uid);s!=null&&this._invalidateLayerData(s,i)}))}this._unregisterTiledLayerView(e.uid),this._basemapLayerViewHandles.set(e.uid,r)}_unregisterTiledLayerView(e){const r=this._basemapLayerViewHandles.get(e);if(r){for(const i of r)i.remove();this._basemapLayerViewHandles.delete(e)}}_updateTiledLayers(){if(!this.tilingScheme||this.view.suspended)return;const e=this.view.allLayerViews,r=[[],[]];let i=null;e.forEach(s=>{if(!s.layer||s.suspended||!IP(s)||!s.fullExtent)return;const n=this._layerClassFromLayerView(s);if(n===nr.MAP){const o=s.displayLevelRange.maxLevel;o!==1/0&&(i===null||o>i)&&(i=o)}r[n].push(s)});for(const s of px){const n=this._layerViews[s],o=r[s];o.reverse();const a=o.length;let l=n.length!==a;const c=new Array(a),h=new Array(n.length);this._layerIndexByUid[s].clear();for(let p=0;p<a;p++){const f=o[p].uid;this._layerIndexByUid[s].set(f,p);const m=n.indexOf(o[p]);c[p]=m,p!==m&&(l=!0),m>-1&&(h[m]=p)}if(l){const p=this._postorderIterator;for(p.reset(this._rootTiles);!p.done;)p.next().modifyLayers(h,c,s);this._layerViews[s]=o,this._restartAllAgents(s),this._updateTilesVisibility(this._rootTiles)}}this.tilingScheme.ensureMaxLod(i)&&this._viewChangeUpdate()}_restartAllAgents(e){const r=this._postorderIterator;for(r.reset(this._rootTiles);!r.done;){const i=r.next();i.restartAgents(e),e===nr.ELEVATION&&i.computeElevationBounds()}this._updateRootTileElevationBounds()}layerViewByIndex(e,r){return this._layerViews[r][e]}numLayers(e){return this._layerViews[e].length}_updateTileTextures(e){this._allTiles.forAll(r=>{r.updateAgents(nr.MAP),e===$n.IMMEDIATE?this.renderer.updateTileTexture(r,vt.TEXTURE_NOFADING):r.updateRenderData(nr.MAP,e)}),this._evaluateTransparency()}_invalidateLayerData(e,r){this._allTiles.forAll(i=>i.removeLayerAgent(e,r)),this._allTiles.forAll(i=>i.invalidateLayerData(e,r))}setTileTreeDirty(){this._allTilesDirty=!0}requestRender(e=Us.UPDATE){this.renderer.setNeedsRender(e)}requestUpdate(){++this._pendingUpdates==1&&(this._hasPendingUpdates=!0)}requestTileData(e,r,i,s){const n=this.layerViewByIndex(r,i),o=n.layer;return!o.tilemapCache||MP(n)?this._requestTileData(e,i,n,s):(++this._asyncWorkItems,o.tilemapCache.fetchAvailability(e.lij[0],e.lij[1],e.lij[2],{...s,timeout:6e3}).then(()=>--this._asyncWorkItems).catch(a=>{throw--this._asyncWorkItems,Dt(s),ws(a)||this._dataMissing(e,i,n,{notInTilemap:!0}),a}).then(()=>this._frameTask.schedule(()=>this._requestTileData(e,i,n,s),s.signal)))}_requestTileData(e,r,i,s){return r===nr.ELEVATION?JY(i)?this._requestElevationTileData(e,i,s):Promise.reject():QY(i)?this._requestMapTileData(e,i,s):Promise.reject()}_requestElevationTileData(e,r,i){++this._asyncWorkItems;const s=a=>{if(dn(i))return;const l=this._layerIndexByUid[nr.ELEVATION].get(r.uid);l!=null?(this._usedMemory=null,this.requestUpdate(),this._elevationDataArrived(e,l,a)):K.getLogger(this).warn("TerrainSurface: received data from unknown layer %d %s",nr.ELEVATION,e.lij.toString())},n=a=>{ws(a)||(this._dataMissing(e,nr.ELEVATION,r,a),this.requestUpdate())};if(Rme(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],{noDataValue:uP,signal:i.signal}).then(a=>{if(!dn(i))return this._frameTask.schedule(()=>s(a),i.signal,n);K.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true.")},n).finally(()=>{--this._asyncWorkItems});const o=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);return this._elevationDataRequester.request(o,"binary",i).then(a=>this._lercDecoder.decode(a,{noDataValue:uP},i.signal)).then(a=>{a?s(new yOt(a)):n(new Error("LERC decoding failed"))},n).finally(()=>{--this._asyncWorkItems})}_requestMapTileData(e,r,i){++this._asyncWorkItems;const s=(h,p)=>{--this._asyncWorkItems,qC(p),dn(i)||(this._dataMissing(e,nr.MAP,r,h),this.requestUpdate())},n=h=>p=>s(p,h),o=h=>this._frameTask.schedule(()=>{--this._asyncWorkItems,this.requestUpdate(),dn(i)?qC(h):this._mapTileDataArrived(e,r,h)},i.signal,n(h)).catch(n(h)),a=(h,p=null)=>this._frameTask.schedule(()=>s(h,p));if(MP(r)){const h=r.schemaHelper.getLevelRowColumn(e.lij);return r.fetchTile(h[0],h[1],h[2],i).then(o,a)}if(J8(r))return r.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(o,a);if($ie(r)&&Rme(r.layer))return r.layer.fetchTile(e.lij[0],e.lij[1],e.lij[2],i).then(h=>{if(dn(i))return K.getLogger(this).warnOnce("A call to fetchTile resolved even though the request was aborted. fetchTile should not resolve if options.signal.aborted is true."),void a(Tr());o(h)},a);let l=r.getTileUrl(e.lij[0],e.lij[1],e.lij[2]);vQe(r.layer)&&r.layer.refreshTimestamp&&(l+=`${l.includes("?")?"&":"?"}_ts=${r.layer.refreshTimestamp}`);const c=r.hasMixedImageFormats?"image+type":"image";return this._mapDataRequester.request(l,c,i).then(o,a)}_mapTileDataArrived(e,r,i){const s=this._getLayerIdxByUID(nr.MAP,r.uid);s!=null?e.dataArrived(s,nr.MAP,i):(qC(i),K.getLogger(this).warn("TerrainSurface: received data from unknown layer"))}_getLayerIdxByUID(e,r){return this._layerIndexByUid[e].get(r)}_dataMissing(e,r,i,s){const n=this._getLayerIdxByUID(r,i.uid);n!=null?e.dataMissing(n,r,s):K.getLogger(this).warn("TerrainSurface: received data from unknown layer")}updateTileOverlayParams(e){this._rootTiles&&this.overlayManager&&(this._allTiles.forAll(r=>{r.renderData&&this.overlayManager.setTileParameters(r)}),this._renderer.setNeedsRender(e))}get performanceInfo(){const e=this._performanceInfo;return e.numNodes=this._allTiles.length,e.numLeaves=e.numVisible=e.numRendered=e.numLoadedPerLevel.length=e.numRenderedPerLevel.length=0,this._allTiles.forAll(r=>{r.isLeaf&&e.numLeaves++;const i=r.level;r.renderData&&(e.numLoadedPerLevel[i]=(e.numLoadedPerLevel[i]||0)+1),r.visible&&(e.numVisible++,r.rendered&&(e.numRenderedPerLevel[i]=(e.numRenderedPerLevel[i]||0)+1,e.numRendered++))}),e}get usedMemory(){return this.tilingScheme?(this._usedMemory==null&&(this._usedMemory=this._recalculateUsedMemory()),this._usedMemory!=null?this._usedMemory:0):0}_recalculateUsedMemory(){return this.tilingScheme?this._allTiles.reduce((e,r)=>e+r.usedMemory,0):null}getUsedMemoryForLayerView(e){let r=this.overlayManager.gpuMemoryUsage;const i=this._layerClassFromLayerView(e),s=this._getLayerIdxByUID(i,e.uid);return s!=null&&this._allTiles.forAll(n=>r+=n.getUsedMemoryForLayer(i,s)),r}getTile(e){if(e==null||this._rootTiles==null)return null;const r=e.split("/").map(a=>+a);if(r[0]===0)return this._rootTiles.find(a=>a.lij[1]===r[1]&&a.lij[2]===r[2]);const i=2**r[0],s=Math.floor(r[1]/i),n=Math.floor(r[2]/i);let o;if(this._rootTiles.some(a=>a.lij[1]===s&&a.lij[2]===n&&(o=a,!0)),o){let a=1<<r[0]-1;for(;o.lij[0]<r[0];){let l=r[1]&a?2:0;if((r[2]&a)>0&&l++,!o.children[l])return null;o=o.children[l],a>>=1}return jm(o.lij[0]===r[0]&&o.lij[1]===r[1]&&o.lij[2]===r[2],"not the right tile?"),o}return null}get renderPatchBorders(){return this._renderer.renderPatchBorders}set renderPatchBorders(e){this._renderer.renderPatchBorders=e}get visualizeNormals(){return this._renderer.visualizeNormals}set visualizeNormals(e){this._renderer.visualizeNormals=e}get renderingDisabled(){return this._renderer.renderingDisabled}set renderingDisabled(e){this._renderer.renderingDisabled=e}get test(){const e=this;return{renderer:e._renderer,lercDecoder:e._lercDecoder,forceReload:()=>{e._rootTiles!=null&&e._rootTiles.length>0&&(e._mergeTile(e._rootTiles[0]),e._viewChangeUpdate())},getTiles:()=>e._allTiles.toArray(),getRenderedTiles(){oj.clear(),e._allTiles.forAll(i=>{i.visible&&i.rendered&&oj.push(i)});const r=oj.toArray();return uNe(e.renderOrder,r),r},lockTilingScheme(r,i){e._extentHelper.defaultTiledLayersExtent=i,e.tilingSchemeLogic.test.lockTilingScheme(r)}}}checkAllTilesWaterproofness(){if(!s6)return;const e=this._rootTiles;if(e==null)return;const r=o=>o?.renderData?.geometry?.indices?.length>0,i=(o,a)=>{r(o)&&console.error("Tile[",o.lij,"] has geometry although parent[",a.lij,"] has geom")},s=o=>{if(o.intersectsClippingArea)if(o.renderData&&!o.renderData.geometryState&&console.error("Tile[",o.lij,"] has renderData but not geometryState"),o.renderData&&!o.renderData.geometry&&console.error("Tile[",o.lij,"] has renderData but not geometryInfo"),!o.renderData?.geometry||(o.renderData.geometry.indices?.length??0)>0||console.error("Tile[",o.lij,"] has renderData but no indices - geometryInfo: ",o.renderData.geometry),r(o)){o.checkGeometryWaterproofness();for(const a of o.children)i(a,o)}else if(o.isLeaf)console.error("Tile[",o.lij,"] has no geometry and no children, from root to leaf");else for(const a of o.children)s(a)},n=o=>{const a=o.parent?.visible??!0,l=o.visible;o.computeVisibility();const c=o.visible;if(l!==c&&a&&console.error(" Tile[",o.lij,"] has out of date visibility: ",l," instead of ",c),!o.isLeaf)for(const h of o.children)n(h)};for(const o of e)s(o),n(o)}get isGlobal(){return this._isGlobal}get isWebMercator(){return this._isWebMercator}get isWebMercatorOnPlateeCarree(){return this._isWebMercatorOnPlateeCarree}isEastEndWrap(e){return this.isGlobal&&e[2]===this.lijEastEnd(e[0])-1}isWestEndWrap(e){return this.isGlobal&&e[2]===0}lijEastEnd(e){return 2**(e+(this.spatialReference!=null&&this.spatialReference.isGeographic?1:0))}wrapEastWest(e){const r=this.lijEastEnd(e[0]),i=e[2];if(0<=i&&i<r)return e;if(!this.isGlobal)return null;const s=(i+(i<0?r:0))%r;return[e[0],e[1],s]}enableInternalChecks(e){VAt(e)}enableWaterproofnessChecks(e){UAt(e)}};u([d()],Yt.prototype,"_renderer",void 0),u([d({constructOnly:!0})],Yt.prototype,"_scaleRangeQueries",void 0),u([d({constructOnly:!0})],Yt.prototype,"view",void 0),u([d({constructOnly:!0})],Yt.prototype,"overlayManager",void 0),u([d()],Yt.prototype,"_hasPendingUpdates",void 0),u([d()],Yt.prototype,"_asyncWorkItems",void 0),u([d()],Yt.prototype,"_allTilesDirty",void 0),u([d()],Yt.prototype,"_allTilesSorted",void 0),u([d()],Yt.prototype,"_viewChanged",void 0),u([d()],Yt.prototype,"_splitLimits",void 0),u([d({readOnly:!0})],Yt.prototype,"_watchUpdatingTracking",void 0),u([d()],Yt.prototype,"_frameTask",void 0),u([d({readOnly:!0})],Yt.prototype,"snapLevel",null),u([d({readOnly:!0})],Yt.prototype,"lodSnapping",null),u([d()],Yt.prototype,"_userClippingExtent",null),u([d()],Yt.prototype,"_rootTilesExtent",void 0),u([d({readOnly:!0})],Yt.prototype,"extent",null),u([d({readOnly:!0})],Yt.prototype,"groundExtent",null),u([d({readOnly:!0})],Yt.prototype,"_tilingSchemeExtent",null),u([d({readOnly:!0})],Yt.prototype,"updating",null),u([d({readOnly:!0})],Yt.prototype,"running",null),u([d(MOt)],Yt.prototype,"updatingProgress",void 0),u([d({readOnly:!0})],Yt.prototype,"updatingProgressValue",null),u([d()],Yt.prototype,"_maxNumUpdating",void 0),u([d()],Yt.prototype,"baseOpacity",null),u([d()],Yt.prototype,"hasCompositeBlendMode",void 0),u([d({readOnly:!0})],Yt.prototype,"viewingMode",null),u([d()],Yt.prototype,"maxTextureScale",void 0),u([d({readOnly:!0})],Yt.prototype,"ready",null),u([d({value:HA.FRONT_TO_BACK})],Yt.prototype,"renderOrder",null),u([d({readOnly:!0})],Yt.prototype,"rootTiles",null),u([d()],Yt.prototype,"_rootTiles",void 0),u([d({readOnly:!0})],Yt.prototype,"spatialReference",null),u([d({type:Le})],Yt.prototype,"backgroundColor",null),u([d({value:!1})],Yt.prototype,"slicePlaneEnabled",null),u([d({readOnly:!0})],Yt.prototype,"tilingScheme",void 0),u([d({readOnly:!0})],Yt.prototype,"tilingSchemeLocked",null),u([d({readOnly:!0})],Yt.prototype,"tilingSchemeLogic",void 0),u([d()],Yt.prototype,"wireframe",null),u([d({value:!1})],Yt.prototype,"suspended",null),u([d()],Yt.prototype,"textureFadeDuration",null),u([d()],Yt.prototype,"visibleElevationBounds",void 0),u([d()],Yt.prototype,"rootTileElevationBounds",void 0),u([d()],Yt.prototype,"_layerViewsDirty",void 0),u([d()],Yt.prototype,"renderPatchBorders",null),u([d()],Yt.prototype,"visualizeNormals",null),u([d()],Yt.prototype,"renderingDisabled",null),Yt=u([R("esri.views.3d.terrain.TerrainSurface")],Yt);const K3t=Yt;function fye(t,e){return t[0]===e[0]&&t[1]===e[1]&&t[2]===e[2]}function qNe(t){const e=t.children;if(!e[0])return!1;for(const r of e)if(r.shouldLoad)return!0;for(const r of e)if(qNe(r))return!0;return!1}function eMt(t){return t.isLeaf&&(t.parent?.shouldLoad??!1)}const Ql=Qt(),tMt=Ht(),tF=[0,0,0],oj=new qt,aj={spatialReference:null,extent:Ht(),context:"ground"},rF={spatialReference:null,extent:null,scale:0};function mye(t,e,r){for(const i of t){if(!i.containsPointXY(e,r))continue;let s=i;for(;s&&!s.renderData;){const o=(e>s.extentMidX?1:0)+(r<s.extentMidY?2:0);s=s.children[o]}const n=s?.renderData?.geometryState.samplerData??null;return _s(e,r,n)}return null}let rMt=class{constructor(e,r,i){this.operation=e,this.geometry=r,this.states=i}},SM=class extends me{constructor(e){super(e),this._residentGeomRecords=new Map,this._dirtyGeomRecords=new Map,this.dirty=!1}commitLayer(e,r){const i=this._dirtyGeomRecords.get(e);i&&(i.forEach((s,n)=>{const o=this._ensureGeomRecord(e,n);s.forEach(({geometry:a,operation:l,states:c},h)=>{let p=!1;if(l===ps.UPDATE){const f=o.get(h);if(f){if(c&eo.TRANSFORMATION){const m=this.model.getObject(n);this.model.updateRenderGeometryTransformation(m,a,f)&&(p=!0)}p||r.updates.push({renderGeometry:f,updateType:c})}else it(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid update")}if(l===ps.REMOVE||p){const f=o.get(h);f?(r.removes.push(f),o.delete(h)):l===ps.REMOVE&&it(!1,"ModelDirtySet.getAddRemoveListFilteredByLayers: invalid remove")}if(l===ps.ADD||p){const f=this.model.getObject(n);if(f!=null){const m=this.model.getRenderGeometry(f,a);r.adds.push(m),o.set(h,m)}}}),o.size===0&&this._residentGeomRecords.get(e).delete(n)}),this._residentGeomRecords.get(e).size===0&&this._residentGeomRecords.delete(e),this._dirtyGeomRecords.delete(e),this.dirty=this._hasDirtyGeometryRecords)}getResidentRenderGeometries(e,r){const i=this._residentGeomRecords.get(e);i&&i.forEach(s=>s.forEach(n=>r.push(n)))}_objectStateChanged(e,r){for(const i of r.geometries)this._updateOrCreateDirtyRecord(r,i,null,ps.UPDATE,e)}visibilityChanged(e){this._objectStateChanged(eo.VISIBILITY,e)}highlightChanged(e){this._objectStateChanged(eo.HIGHLIGHT,e)}occlusionChanged(e){this._objectStateChanged(eo.OCCLUDEE,e)}objectGeometryUpdated(e){this._updateOrCreateDirtyRecord(e.object,e.geometry,null,ps.UPDATE,eo.GEOMETRY)}layerAdded(e){e.objects.forAll(r=>this._layerObjectAdded(e,r))}layerRemoved(e){e.objects.forAll(r=>this._layerObjectRemoved(e,r))}layerObjectAdded(e){this._layerObjectAdded(e.layer,e.object)}_layerObjectAdded(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryAdded(r,s,i)}layerObjectRemoved(e){this._layerObjectRemoved(e.layer,e.object)}layerObjectsAdded(e){for(const r of e.objects)this._layerObjectAdded(e.layer,r)}layerObjectsRemoved(e){for(const r of e.objects)this._layerObjectRemoved(e.layer,r)}_layerObjectRemoved(e,r){const i=e.id;for(const s of r.geometries)this._objectGeometryRemoved(r,s,i)}shaderTransformationChanged(e){const r=this._residentGeomRecords.get(e.id);r&&r.forEach((i,s)=>{const n=this.model.getObject(s);n&&n.hasVolativeTransformation()&&i.forEach(o=>o.shaderTransformationChanged())})}objectTransformation(e){const r=this._getParentLayerId(e),i=e.id;this._ensureGeomRecord(r,i).forEach(s=>{this._updateOrCreateDirtyRecord(e,s.geometry,r,ps.UPDATE,eo.TRANSFORMATION)})}objectShaderTransformation(){}objectGeometryAdded(e){this._objectGeometryAdded(e.object,e.geometry)}_objectGeometryAdded(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,ps.ADD)}objectGeometryRemoved(e){this._objectGeometryRemoved(e.object,e.geometry)}_objectGeometryRemoved(e,r,i=null){this._updateOrCreateDirtyRecord(e,r,i,ps.REMOVE)}_updateOrCreateDirtyRecord(e,r,i,s,n=eo.NONE){i=i??this._getParentLayerId(e);const o=e.id,a=r.id,l=this._ensureDirtyRecord(i,o),c=l.get(a);if(c){const h=c.operation;h===ps.REMOVE&&s===ps.ADD&&c.states!==eo.NONE?c.operation=ps.UPDATE:h===ps.REMOVE&&s===ps.ADD||h===ps.ADD&&s===ps.REMOVE?l.delete(a):h!==ps.UPDATE||s!==ps.REMOVE&&s!==ps.UPDATE?(it((h===ps.REMOVE||h===ps.ADD)&&s===ps.UPDATE,"ModelDirtySet.objectGeometryAdded: inconsistent state"),c.states|=n):(c.operation=s,c.states|=n)}else l.set(a,new rMt(s,r,n));this.dirty=this._hasDirtyGeometryRecords}_ensureGeomRecord(e,r){let i=this._residentGeomRecords.get(e);i||(i=new Map,this._residentGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}get _hasDirtyGeometryRecords(){return ra(this._dirtyGeomRecords,e=>ra(e,r=>r&&r.size>0))}_ensureDirtyRecord(e,r){let i=this._dirtyGeomRecords.get(e);i||(i=new Map,this._dirtyGeomRecords.set(e,i));let s=i.get(r);return s||(s=new Map,i.set(r,s)),s}_getParentLayerId(e){return e.parentLayer?e.parentLayer.id:N6e}formatDebugInfo(){const e=["ADD","UPD",void 0,"REM"];let r="";return this._dirtyGeomRecords.forEach((i,s)=>{i.forEach((n,o)=>{r.length>0&&(r+=`
`),r+=s+"."+o;const a=[];n.forEach(l=>{const c=l.operation;a[c]||(a[c]=[]),a[c].push(l.geometry.id)});for(let l=0;l<a.length;l++)if(a[l]){r+=" "+e[l-1]+": ";for(let c=0;c<a[l].length;c++)r+=a[l][c]+", "}})}),r}get test(){const e=this;return{get residentLayerCount(){return e._residentGeomRecords.size},get residentObjectCount(){return Array.from(e._residentGeomRecords.values()).reduce((r,i)=>r+i.size,0)},commit:r=>e._dirtyGeomRecords.forEach((i,s)=>e.commitLayer(s,r))}}};u([d({constructOnly:!0})],SM.prototype,"model",void 0),u([d()],SM.prototype,"dirty",void 0),SM=u([R("esri.views.3d.webgl-engine.lib.ModelDirtySet")],SM);const iMt=SM;let x5=class extends me{constructor(){super(...arguments),this.dirtySet=new iMt({model:this}),this._content=new Map,this._originFactory=new nie(null)}getObject(e){return this._content.get(e)}add(e){const r=e.id;it(!this._content.has(r),"Model/Stage already contains object to be added"),this._content.set(r,e),qU(e)&&this.dirtySet.layerAdded(e)}remove(e){it(this._content.has(e.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(e.id),e.unload(),qU(e)&&this.dirtySet.layerRemoved(e)}addMany(e){for(const r of e)r!=null&&(it(!this._content.has(r.id),"Model/Stage already contains object to be added"),this._content.set(r.id,r))}removeMany(e){for(const r of e)it(this._content.has(r.id),"Model/Stage doesn't contain object to be removed"),this._content.delete(r.id),r.unload()}has(e){return this._content.has(e.id)}forEachOfType(e,r){this._content.forEach(i=>{i.type===e&&r(i)})}getRenderGeometry(e,r){const{shaderTransformer:i,localOrigin:s}=r,n=new jA(r,{shaderTransformer:i,castShadow:e.castShadow});return n.updateTransformation(o=>e.getCombinedStaticTransformation(r,o)),n.localOrigin=s??this._originFactory.getOrigin(n.boundingSphere),n}updateRenderGeometryTransformation(e,r,i){if(e==null)return!1;i.updateTransformation(n=>e.getCombinedStaticTransformation(r,n));const s=this._originFactory.getOrigin(i.boundingSphere);return i.localOrigin!==s}getStats(){const e={},r=Array.from(this._content.values());for(let i=0;i<Ms.COUNT;++i)e[i]=r.filter(s=>s.type===i).length;return{contentTypes:e,dirtySet:this.dirtySet.formatDebugInfo()}}get test(){return{content:Array.from(this._content.values())}}};u([d({constructOnly:!0})],x5.prototype,"dirtySet",void 0),x5=u([R("esri.views.3d.webgl-engine.parts.Model")],x5);let sMt=class{constructor(e){this._totalCount=e,this._indexRanges=[0,e]}allVisible(){return this.componentCount()===this._totalCount}allInvisible(){return this._indexRanges.length===0}componentCount(){const e=this._indexRanges;let r=0;for(let i=0;i<e.length;i+=2)r+=e[i+1];return r}reset(e){e==="all"||e.length===this._totalCount?this._indexRanges=[0,this._totalCount]:this._indexRanges=nMt(e)}forEachComponent(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i],n=s+r[i+1];for(let o=s;o<n;o++)if(!e(o))return!1}return!0}forEachComponentRange(e){const r=this._indexRanges;for(let i=0;i<r.length;i+=2){const s=r[i];if(!e(s,s+r[i+1]))return!1}return!0}computeOffsetRanges(e){const r=new Array(this._indexRanges.length),i=this._indexRanges;for(let s=0;s<i.length;s+=2){const n=i[s],o=n+i[s+1],a=e[n],l=e[o];r[s]=a,r[s+1]=l-a}return r}};function nMt(t){const e=new Array;if(t.length===0)return e;let r=t[0],i=1;for(let s=1;s<t.length;s++){const n=t[s];r+i===n?i+=1:(e.push(r),e.push(i),r=n,i=1)}return e.push(r),e.push(i),e}let oMt=class{constructor(e,r){this.offsets=r,this.pickability=null,this.highlightCounts=null,this.verticalOffsets=null,this.cachedGeometryRanges=null,this.cachedHighlightRanges=null,this.cachedDefaultRanges=null;const i=this.count;this.visibility=new sMt(i),this.materialDataBuffer=e.getBuffer(i),this.materialDataIndices=new Uint16Array(i);for(let s=0;s<i;s++)this.materialDataIndices[s]=this.materialDataBuffer.acquireIndex()}destroy(){for(let e=0;e<this.count;e++)this.materialDataBuffer.releaseIndex(this.materialDataIndices[e])}get count(){return this.offsets.length-1}get geometryRanges(){return this.cachedGeometryRanges==null&&(this.cachedGeometryRanges=this.visibility.computeOffsetRanges(this.offsets)),this.cachedGeometryRanges}get highlightRanges(){return this.highlightCounts==null?null:(this._updateCachedHighlightRanges(),this.cachedHighlightRanges)}get defaultShadowMapRanges(){return this.highlightCounts==null?this.geometryRanges:(this._updateCachedHighlightRanges(),this.cachedDefaultRanges)}highlightsDirty(){this.cachedHighlightRanges=null,this.cachedDefaultRanges=null}visibilityDirty(){this.cachedGeometryRanges=null,this.highlightsDirty()}_updateCachedHighlightRanges(){if((this.cachedHighlightRanges==null||this.cachedDefaultRanges==null)&&this.highlightCounts!=null){const{highlightRanges:e,defaultRanges:r}=aMt(this.highlightCounts,this.visibility,this.offsets);this.cachedHighlightRanges=e,this.cachedDefaultRanges=r}}};function aMt(t,e,r){const i=[],s=[];let n=r.length,o=r.length;return e.forEachComponent(a=>(t[a]>0?(n!==a-1&&(i.length&&i.push(r[n+1]-i[i.length-1]),i.push(r[a])),n=a):(o!==a-1&&(s.length&&s.push(r[o+1]-s[s.length-1]),s.push(r[a])),o=a),!0)),i.length&&i.push(r[n+1]-i[i.length-1]),s.length&&s.push(r[o+1]-s[s.length-1]),{highlightRanges:i,defaultRanges:s}}let EM=class extends me{constructor(){super(...arguments),this.visible=ZC.Hidden}};var ZC;u([d({autoDestroy:!0})],EM.prototype,"renderable",void 0),u([d({autoDestroy:!0})],EM.prototype,"components",void 0),EM=u([R("esri.views.3d.webgl-engine.collections.Component.ComponentObject")],EM),function(t){t[t.Hidden=0]="Hidden",t[t.Visible=1]="Visible"}(ZC||(ZC={}));function lMt(t,e,r,i){if(r>=e)return t;t==null&&(t=cMt());const s=t.isVisibleBit;let n=t.data;const o=ZNe(n),a=r/o|0,l=r-o*a,c=(e-1)/o|0,h=n,p=i===s;if(!(r<h.length*o)&&p){const f=a+1,m=Math.ceil(h.length*v6),g=c+1;let _=Math.max(f,m);_=Math.min(_,g),n=new Uint32Array(_),n.set(h)}return a<n.length&&(n[a]=hMt(n[a],l,p)),t.data=n,t}function WNe(t,e){if(t==null)return!0;const{isVisibleBit:r,data:i}=t,s=ZNe(i);return e<i.length*s?uMt(r,i,e,s):!t.isVisibleBit}function cMt(t=!0){return{isVisibleBit:!t,data:new Uint32Array(0)}}function uMt(t,e,r,i){const s=r/i|0,n=r-s*i;return dMt(e[s],n)===t}function ZNe(t){return t.BYTES_PER_ELEMENT*8}function hMt(t,e,r){return t&~(1<<e)|(r?1:0)<<e}function dMt(t,e){return(t&1<<e)!=0}let pMt=class{constructor(e,r){this._components=r,this._indices=e.indices!=null?cg(e.indices):PA(e.positions.length/3),this._positions=e.positions,this._componentIntersectionData=new Array(r.count)}getComponentAabb(e,r){this._perComponentAabbs||(this._perComponentAabbs=this._computePerComponentAabbs());for(let i=0;i<6;i++)r[i]=this._perComponentAabbs[6*e+i];return r}getComponentPositions(e,r){r.indices=this._indices,r.data=this._positions,r.stride=3,r.startIndex=this._components.offsets[e],r.endIndex=this._components.offsets[e+1]}intersect(e,r,i,s,n,o,a){const l=new Ge(this._positions,3,!1,3),c=this._indices,h=this._components.offsets,p=ZIe(e,r,fMt),f=e[2],m=r[2];this._components.visibility.forEachComponent(g=>{if(!WNe(this._components.pickability,g))return!0;const _=this.getComponentAabb(g,mMt);if(o!=null){const T=o[g];n!=null?n.componentOffset=T:(e[2]=f-T,r[2]=m-T)}if(n?.applyToAabb(_),!$re(_,e,p,i))return!0;const v=h[g]/3,b=h[g+1]/3,x=(T,S,O)=>a(g,T,yu(S,S,s),O);return n==null&&b-v>jNe?(this._componentIntersectionData[g]==null&&(this._componentIntersectionData[g]=new qie(this._indices,v,b,l)),this._componentIntersectionData[g].intersectRay({r0:e,r1:r},x)):I$(e,r,v,b,c,l,void 0,n,x),!0})}_computePerComponentAabbs(){const e=this._components.count,r=vs(6*e),i=this._indices,s=this._positions,n=this._components.offsets;let o=0;for(let a=0;a<e;a++){const l=n[a],c=n[a+1];let h=1/0,p=1/0,f=1/0,m=-1/0,g=-1/0,_=-1/0;for(let v=l;v<c;v++){const b=3*i[v],x=s[b],T=s[b+1],S=s[b+2];h=Math.min(h,x),p=Math.min(p,T),f=Math.min(f,S),m=Math.max(m,x),g=Math.max(g,T),_=Math.max(_,S)}r[o++]=h,r[o++]=p,r[o++]=f,r[o++]=m,r[o++]=g,r[o++]=_}return r}get positions(){return this._positions}get indices(){return this._indices}};const fMt=C(),mMt=Gn();let gMt=class{constructor(e,r,i){this.material=e,this.geometry=r,this.meta=i}destroy(){this.material.dispose(),this.geometry.dispose()}},yMt=class{constructor(e,r,i,s){this.vao=e,this.primitiveType=r,this.parameters=i,this.indexed=s}dispose(){this.vao.dispose()}},_Mt=class{constructor(){this.near=Number.MAX_VALUE,this.far=-Number.MAX_VALUE}};function vMt(t,e){return{near:t,far:e}}function H$(t){return t?$P(t,1/0,-1/0):vMt(1/0,-1/0)}function $P(t,e,r){return t.near=e,t.far=r,t}function qA(t,e,r=t){return e!=null&&(r.near=Math.min(t.near,e.near),r.far=Math.max(t.far,e.far)),r}function iF(t,e){return t.near<=e&&e<=t.far}const gJ={near:0,far:0};function bMt(t,e){const r=H$(),{eye:i,frustum:s,viewForward:n}=t;e.forAll(o=>{const a=o.offsetObb!=null?o.offsetObb:o.obb,l=de(Mi(Yu,a.center,i),n),c=e8(a,n);if(iF(r,l-c)&&iF(r,l+c))return;const h=EMt(a,s);if(h===-1)return;if(h===0)return ly.far=l+c,ly.near=l-c,void qA(r,ly);const p=sF.pushNew();p.near=l-c,p.far=l+c,p.mask=h,p.object=o});for(let o=0;o<sF.length;o++){const a=sF.data[o];if(iF(r,a.near)&&iF(r,a.far))continue;ly.far=a.far,ly.near=1/0,SMt(a.object.offsetObb!=null?a.object.offsetObb:a.object.obb,i,wMt,c=>{let h=xMt;for(let p=0;p<XNe&&c.length>0;p++){if(!(a.mask&1<<p))continue;TMt(s[p],c,h);const f=c;c=h,h=f}for(let p=0;p<c.length;p+=3){ie(cc,c.data[p],c.data[p+1],c.data[p+2]);const f=de(Mi(cc,cc,i),n);ly.near=Math.min(ly.near,f)}})===0&&(ly.near=0),qA(r,ly)}return sF.length=0,r}const sF=new qt({allocator:t=>t||{near:1/0,far:-1/0,mask:0,object:null},deallocator:t=>(t.object=tO(t.object),t)}),ly=H$(),cc=C(),lw=C(),wMt=new qt({deallocator:null}),xMt=new qt({deallocator:null});function TMt(t,e,r){r.length=0;const i=e.length-3;lj(cc,e,i);const s=Oi(t,cc);s<=0&&(r.push(cc[0]),r.push(cc[1]),r.push(cc[2]));let n=0,o=s;for(;n<i;n+=3){lj(lw,e,n);const a=Oi(t,lw);o*a<0&&(Wr(cc,lw,cc,a/(a-o)),uc(r,cc)),a<=0&&uc(r,lw),o=a,oe(cc,lw)}o*s<0&&(lj(lw,e,i),Wr(cc,lw,cc,s/(s-o)),uc(r,cc))}function lj(t,e,r){return ie(t,e.data[r],e.data[r+1],e.data[r+2])}function uc(t,e){t.push(e[0]),t.push(e[1]),t.push(e[2])}function SMt(t,e,r,i){Tg(yye,t.quaternion),Mi(Yu,e,t.center),xu(Yu,Yu,yye);const s=8*((Yu[0]<-t.halfSize[0]?-1:Yu[0]>t.halfSize[0]?1:0)+3*(Yu[1]<-t.halfSize[1]?-1:Yu[1]>t.halfSize[1]?1:0)+9*(Yu[2]<-t.halfSize[2]?-1:Yu[2]>t.halfSize[2]?1:0)+13),n=gye[s];if(n===0)return n;qV(nF,t.quaternion),hte(nF,nF,t.halfSize);const o=(a,l)=>{const c=gye[s+l+1];return ie(a,((1&c)<<1)-1,(2&c)-1,((4&c)>>1)-1),yu(a,a,nF),ue(a,t.center,a)};return r.length=0,uc(r,o(cj,0)),uc(r,o(_ye,1)),uc(r,o(Yu,2)),uc(r,o(vye,3)),i(r),n===1||(r.length=0,uc(r,cj),uc(r,vye),uc(r,o(Yu,4)),uc(r,o(bye,5)),i(r),n===2||(r.length=0,uc(r,cj),uc(r,bye),uc(r,o(Yu,6)),uc(r,_ye),i(r))),n}const gye=(()=>{const t=new Array(216);let e=0;const r=i=>{for(let s=0;s<i.length;s++)t[e+s]=i[s];e+=8};return r([3,0,6,2,3,1,5,4]),r([2,0,2,3,1,5,4,0]),r([3,1,0,2,3,7,5,4]),r([2,0,1,3,2,6,4,0]),r([1,0,1,3,2,0,0,0]),r([2,1,5,7,3,2,0,0]),r([3,2,0,1,3,7,6,4]),r([2,2,0,1,3,7,6,0]),r([3,3,0,1,5,7,6,2]),r([2,0,1,5,4,6,2,0]),r([1,0,1,5,4,0,0,0]),r([2,1,3,7,5,4,0,0]),r([1,0,2,6,4,0,0,0]),r([0,0,0,0,0,0,0,0]),r([1,1,3,7,5,0,0,0]),r([2,2,3,7,6,4,0,0]),r([1,2,3,7,6,0,0,0]),r([2,3,1,5,7,6,2,0]),r([3,4,0,1,5,7,6,2]),r([2,5,7,6,4,0,1,0]),r([3,5,0,1,3,7,6,4]),r([2,4,5,7,6,2,0,0]),r([1,4,5,7,6,0,0,0]),r([2,5,1,3,7,6,4,0]),r([3,6,0,2,3,7,5,4]),r([2,6,2,3,7,5,4,0]),r([3,7,6,2,3,1,5,4]),t})(),XNe=4;function EMt(t,e){let r=0;for(let i=0;i<XNe;i++){const s=Qw(t,e[i]);if(s>0)return-1;s===0&&(r|=1<<i)}return r}const nF=ts(),yye=Kd(),Yu=C(),cj=C(),_ye=C(),vye=C(),bye=C();let CMt=class{constructor(e){this._objects=e}submit(e,r){this._objects.preSubmit(r),this._objects.visibleObjects.forAll(i=>i.renderable.material.submit(e,r,i))}queryShadowCasterDepthRange(e){return this._objects.visibleObjects.length?bMt(e,this._objects.visibleObjects):null}};function AMt(t){const e=us().vec3f(E.POSITION);return t.normals&&e.vec2i16(E.NORMALCOMPRESSED,{glNormalized:!0}),t.textureCoordinates===sn.Default?e.vec2f(E.UV0):t.textureCoordinates===sn.Atlas&&(e.vec2f(E.UV0),e.vec4u16(E.UVREGION,{glNormalized:!0})),t.colors&&e.vec4u8(E.COLOR,{glNormalized:!0}),e}let OMt=class{constructor(){this.externalColor=Qt(),this.externalColorMixMode=pn.Multiply,this.castShadows=!0,this.pickable=!0,this.elevationOffset=0}},RMt=class extends Ps{constructor(e,r){super(e,"int",ai.Draw,(i,s,n)=>i.setUniform1i(e,r(s,n)))}};var dg;(function(t){t[t.Uniform=0]="Uniform",t[t.Varying=1]="Varying",t[t.COUNT=2]="COUNT"})(dg||(dg={}));const Wie=429496.7296;function YNe(t,e){xP(t/Wie*.5+.5,e)}function MMt(t,e){switch(e.componentData){case dg.Varying:return IMt(t,e);case dg.Uniform:return PMt(t);case dg.COUNT:return;default:e.componentData}}function IMt(t,e){const{vertex:r,fragment:i}=t;r.include(Pu),r.uniforms.add(new Nd("componentColorTex",n=>n.componentParameters.texture.texture)),t.attributes.add(E.COMPONENTINDEX,"float"),t.varyings.add("vExternalColorMixMode","mediump float"),t.varyings.add("vExternalColor","vec4");const s=e.output===k.ObjectAndLayerIdColor;s&&t.varyings.add("vObjectAndLayerIdColor","vec4"),t.include(ALe),r.constants.add("elevationScale","float",2*Wie),r.constants.add("stride","float",le("enable-feature:objectAndLayerId-rendering")?3:2),r.code.add(w`vec2 getComponentTextureCoordinates(float componentIndex, float typeOffset) {
float index = componentIndex * stride + typeOffset;
float texSize = float(textureSize(componentColorTex, 0).x);
float coordX = mod(index, texSize);
float coordY = floor(index / texSize);
return vec2(coordX, coordY) + 0.5;
}`),r.code.add(w`
  vec4 _readComponentColor() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 0.0);

    return texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
   }

   float readElevationOffset() {
    vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 1.0);

    vec4 encodedElevation = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
    return (rgba2float(encodedElevation) - 0.5) * elevationScale;
  }

  ${s?w`
          void forwardObjectAndLayerIdColor() {
            vec2 textureCoordinates = getComponentTextureCoordinates(componentIndex, 2.0);

            vObjectAndLayerIdColor = texelFetch(componentColorTex, ivec2(textureCoordinates), 0);
          }`:w`void forwardObjectAndLayerIdColor() {}`}

  vec4 forwardExternalColor(out bool castShadows) {
    vec4 componentColor = _readComponentColor() * 255.0;

    float shadowFlag = mod(componentColor.b * 255.0, 2.0);
    componentColor.b -= shadowFlag;
    castShadows = shadowFlag >= 1.0;

    int decodedColorMixMode;
    vExternalColor = decodeSymbolColor(componentColor, decodedColorMixMode) * 0.003921568627451; // = 1/255;
    vExternalColorMixMode = float(decodedColorMixMode) + 0.5; // add 0.5 to avoid interpolation artifacts

    return vExternalColor;
  }
`),i.code.add(w`
  void readExternalColor(out vec4 externalColor, out int externalColorMixMode) {
    externalColor = vExternalColor;
    externalColorMixMode = int(vExternalColorMixMode);
  }

  void outputObjectAndLayerIdColor() {
     ${s?w`fragColor = vObjectAndLayerIdColor;`:""}
  }
`)}function PMt(t){const{vertex:e,fragment:r}=t;e.uniforms.add(new c6("externalColor",i=>i.componentParameters.externalColor)),r.uniforms.add(new RMt("externalColorMixMode",i=>i.componentParameters.externalColorMixMode)),t.varyings.add("vExternalColor","vec4"),e.code.add(w`float readElevationOffset() {
return 0.0;
}
void forwardObjectAndLayerIdColor() {
}
vec4 forwardExternalColor(out bool castShadows) {
vExternalColor = externalColor;
castShadows = true;
return externalColor;
}`),r.code.add(w`void readExternalColor(out vec4 color, out int colorMixMode) {
color = vExternalColor;
colorMixMode = externalColorMixMode;
}
void outputObjectAndLayerIdColor() {
fragColor = vec4(1.0,0.0,0.0,0.0);
}`)}var Rd;function $Mt(t,e){const r=t.vertex;switch(r.code.add(w`#define VERTEX_DISCARD_CUTOFF (1.0 - 1.0 / 255.0)`),e.vertexDiscardMode){case Rd.None:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) {}`);break;case Rd.Opaque:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ >  VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`);break;case Rd.Transparent:r.code.add(w`#define vertexDiscardByOpacity(_opacity_) { if (_opacity_ <= VERTEX_DISCARD_CUTOFF) {  gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`)}}(function(t){t[t.None=0]="None",t[t.Transparent=1]="Transparent",t[t.Opaque=2]="Opaque",t[t.COUNT=3]="COUNT"})(Rd||(Rd={}));var pg;function VYt(t){return t&&Pg(t)?pg.Mars:t&&$g(t)?pg.Moon:pg.Earth}(function(t){t[t.Earth=1]="Earth",t[t.Mars=2]="Mars",t[t.Moon=3]="Moon",t[t.COUNT=4]="COUNT"})(pg||(pg={}));var ch;(function(t){t[t.None=0]="None",t[t.NoOverlay=1]="NoOverlay",t[t.ColorOverlay=2]="ColorOverlay",t[t.ColorOverlayWithWater=3]="ColorOverlayWithWater",t[t.COUNT=4]="COUNT"})(ch||(ch={}));let gr=class extends nl{constructor(){super(...arguments),this.output=k.Color,this.textureCoordinateType=sn.None,this.componentData=dg.Uniform,this.cullFace=Ii.Back,this.vertexDiscardMode=Rd.None,this.doubleSidedMode=bs.WindingOrder,this.alphaDiscardMode=ni.Opaque,this.integratedMeshMode=ch.None,this.transparencyPassType=ut.NONE,this.ellipsoidMode=pg.Earth,this.pbrMode=lt.Disabled,this.normalType=Fr.Attribute,this.spherical=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasVertexColors=!1,this.hasNormals=!1,this.hasSlicePlane=!1,this.hasBaseColorTexture=!1,this.receiveAmbientOcclusion=!0,this.receiveShadows=!0,this.blendingEnabled=!0,this.hasScreenSpaceReflections=!1,this.hasPolygonOffset=!1,this.hasMetallicRoughnessTexture=!1,this.hasEmissionTexture=!1,this.hasOcclusionTexture=!1,this.hasNormalTexture=!1,this.hasOccludees=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.hasCloudsReflections=!0,this.snowCover=!1,this.objectAndLayerIdColor=!1}};u([B({count:k.COUNT})],gr.prototype,"output",void 0),u([B({count:sn.COUNT})],gr.prototype,"textureCoordinateType",void 0),u([B({count:dg.COUNT})],gr.prototype,"componentData",void 0),u([B({count:Ii.COUNT})],gr.prototype,"cullFace",void 0),u([B({count:Rd.COUNT})],gr.prototype,"vertexDiscardMode",void 0),u([B({count:bs.COUNT})],gr.prototype,"doubleSidedMode",void 0),u([B({count:ni.COUNT})],gr.prototype,"alphaDiscardMode",void 0),u([B({count:ch.COUNT})],gr.prototype,"integratedMeshMode",void 0),u([B({count:ut.COUNT})],gr.prototype,"transparencyPassType",void 0),u([B({count:pg.COUNT})],gr.prototype,"ellipsoidMode",void 0),u([B({count:lt.COUNT})],gr.prototype,"pbrMode",void 0),u([B({count:Fr.COUNT})],gr.prototype,"normalType",void 0),u([B()],gr.prototype,"spherical",void 0),u([B()],gr.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B()],gr.prototype,"hasVertexColors",void 0),u([B()],gr.prototype,"hasNormals",void 0),u([B()],gr.prototype,"hasSlicePlane",void 0),u([B()],gr.prototype,"hasBaseColorTexture",void 0),u([B()],gr.prototype,"receiveAmbientOcclusion",void 0),u([B()],gr.prototype,"receiveShadows",void 0),u([B()],gr.prototype,"blendingEnabled",void 0),u([B()],gr.prototype,"hasScreenSpaceReflections",void 0),u([B()],gr.prototype,"hasPolygonOffset",void 0),u([B()],gr.prototype,"hasMetallicRoughnessTexture",void 0),u([B()],gr.prototype,"hasEmissionTexture",void 0),u([B()],gr.prototype,"hasOcclusionTexture",void 0),u([B()],gr.prototype,"hasNormalTexture",void 0),u([B()],gr.prototype,"hasOccludees",void 0),u([B()],gr.prototype,"hasMultipassTerrain",void 0),u([B()],gr.prototype,"cullAboveGround",void 0),u([B()],gr.prototype,"hasCloudsReflections",void 0),u([B()],gr.prototype,"snowCover",void 0),u([B()],gr.prototype,"objectAndLayerIdColor",void 0),u([B({constValue:ai.Draw})],gr.prototype,"pbrTextureBindType",void 0),u([B({constValue:!0})],gr.prototype,"hasSliceHighlight",void 0),u([B({constValue:!1})],gr.prototype,"hasSliceInVertexProgram",void 0),u([B({constValue:!1})],gr.prototype,"useCustomDTRExponentForWater",void 0),u([B({constValue:!1})],gr.prototype,"hasVertexTangents",void 0),u([B({constValue:!0})],gr.prototype,"supportsTextureAtlas",void 0),u([B({constValue:!1})],gr.prototype,"highStepCount",void 0),u([B({constValue:!1})],gr.prototype,"instancedDoublePrecision",void 0),u([B({constValue:!0})],gr.prototype,"useFillLights",void 0),u([B({constValue:!1})],gr.prototype,"objectAndLayerIdColorInstanced",void 0);function wye(t,e){t.include(xS,e),t.fragment.include(OP);const r=t.fragment;r.uniforms.add(new c6("baseColor",i=>i.baseColor)),r.uniforms.add(new dT("objectOpacity",i=>i.objectOpacity)),e.hasVertexColors?r.code.add(w`vec3 _baseColor() {
return baseColor.rgb * vColor.rgb;
}
float _baseOpacity() {
return baseColor.a * vColor.a;
}`):r.code.add(w`vec3 _baseColor() {
return baseColor.rgb;
}
float _baseOpacity() {
return baseColor.a;
}`),r.code.add(w`vec4 computeMaterialColor(vec4 textureColor, vec4 externalColor, int externalColorMixMode) {
vec3 baseColor = _baseColor();
float baseOpacity = _baseOpacity();
vec3 color = mixExternalColor(
baseColor,
textureColor.rgb,
externalColor.rgb,
externalColorMixMode
);
float opacity = objectOpacity * mixExternalOpacity(
baseOpacity,
textureColor.a,
externalColor.a,
externalColorMixMode
);
return vec4(color, opacity);
}`)}function xye(t,e){const r=t.fragment;switch(e.doubleSidedMode){case bs.None:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return normal;
}`);break;case bs.View:t.include(NC,e),r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return dot(normal, vPositionWorldCameraRelative) > 0.0 ? -normal : normal;
}`);break;case bs.WindingOrder:r.code.add(w`vec3 _adjustDoublesided(vec3 normal) {
return gl_FrontFacing ? normal : -normal;
}`);break;default:e.doubleSidedMode;case bs.COUNT:}switch(e.normalType){case Fr.Attribute:case Fr.Compressed:t.include(B8,e),r.code.add(w`vec3 shadingNormalWorld() {
return _adjustDoublesided(normalize(vNormalWorld));
}
vec3 shadingNormal_view() {
vec3 normal = normalize(vNormalView);
return gl_FrontFacing ? normal : -normal;
}`);break;case Fr.ScreenDerivative:t.include(NC,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(cross(
dFdx(vPositionWorldCameraRelative),
dFdy(vPositionWorldCameraRelative)
));
}
vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view)));
}`);break;case Fr.Ground:e.spherical?(t.include(NC,e),r.code.add(w`vec3 shadingNormalWorld() {
return normalize(positionWorld());
}`)):r.code.add(w`vec3 shadingNormalWorld() {
return vec3(0.0, 0.0, 1.0);
}`),r.code.add(w`vec3 shadingNormal_view() {
return normalize(cross(dFdx(vPosition_view),dFdy(vPosition_view))).xyz;
}`);break;default:e.normalType;case Fr.COUNT:}}function LMt(t,e){const r=t.fragment;if(e.hasBaseColorTexture&&(e.output===k.Color||e.alphaDiscardMode!==ni.Opaque)){t.include(Vte,e);const i=e.textureCoordinateType===sn.Atlas;r.uniforms.add(new Nd("baseColorTexture",s=>s.texture)),i?(t.include(h3e),r.code.add(w`vec4 readBaseColorTexture() {
return textureAtlasLookup(baseColorTexture, vuv0, vuvRegion);
}`)):r.code.add(w`vec4 readBaseColorTexture() {
return texture(baseColorTexture, vuv0);
}`)}else r.code.add(w`vec4 readBaseColorTexture() { return vec4(1.0); }`)}function DMt(t){const e=new Cr;e.include(NC,t),e.include(B8,t),e.include(xS,t),e.include(ag,t),e.include(TO,t),e.include(MMt,t),e.include(Qwt,t),e.include(S_t,t),e.include(LMt,t),e.include($Mt,t);const{vertex:r,fragment:i}=e;t.pbrMode!==lt.Normal&&t.pbrMode!==lt.Schematic||(e.include(Bte,t),t.hasNormalTexture&&e.include(ILe,t));const s=t.output===k.Shadow||t.output===k.ShadowHighlight||t.output===k.ShadowExcludeHighlight;s&&t.componentData===dg.Varying?r.code.add(w`#define discardShadows(castShadows) { if(!castShadows) { gl_Position = vec4(1e38, 1e38, 1e38, 1.0); return; } }`):r.code.add(w`#define discardShadows(castShadows) {}`);const n=t.integratedMeshMode===ch.ColorOverlay||t.integratedMeshMode===ch.ColorOverlayWithWater,o=n&&t.output===k.Color&&t.pbrMode===lt.WaterOnIntegratedMesh;return n&&(e.include(JT,t),e.include(LRt,t),t.spherical?r.code.add(w`
      const float invEllipsoidRadius = ${w.float(1/(t.ellipsoidMode===pg.Earth?ur.radius:t.ellipsoidMode===pg.Mars?ig.radius:E0.radius))};
      vec2 projectOverlay(vec3 pos) {
        return pos.xy / (1.0 + invEllipsoidRadius * pos.z);
      }
      `):r.code.add(w`vec2 projectOverlay(vec3 pos) { return pos.xy; }`)),o&&(e.varyings.add("tbnTangent","vec3"),e.varyings.add("tbnBiTangent","vec3"),e.varyings.add("groundNormal","vec3")),r.code.add(w`
    void main() {
      bool castShadows;
      vec4 externalColor = forwardExternalColor(castShadows);
      discardShadows(castShadows);

      vertexDiscardByOpacity(externalColor.a);

      ${t.output===k.ObjectAndLayerIdColor?w`externalColor.a = 1.0;`:""}

      if (externalColor.a < ${w.float(ia)}) {
        // Discard this vertex
        gl_Position = vec4(1e38, 1e38, 1e38, 1.0);
        return;
      }

      forwardPosition(readElevationOffset());
      forwardNormal();
      forwardTextureCoordinates();
      forwardVertexColor();
      forwardLinearDepth();
      ${t.output===k.ObjectAndLayerIdColor?w`forwardObjectAndLayerIdColor();`:""}
      ${o?t.spherical?w`
                groundNormal = normalize(positionWorld());
                tbnTangent = normalize(cross(vec3(0.0, 0.0, 1.0), groundNormal));
                tbnBiTangent = normalize(cross(groundNormal, tbnTangent));`:w`
                groundNormal = vec3(0.0, 0.0, 1.0);
                tbnTangent = vec3(1.0, 0.0, 0.0);
                tbnBiTangent = vec3(0.0, 1.0, 0.0);`:""}
      ${n?w`setOverlayVTC(projectOverlay(position));`:""}
    }
  `),t.output===k.Alpha&&(i.include(Ch),e.include(Ah,t),e.include(wye,t),n&&i.uniforms.add(new et("ovColorTex",(a,l)=>nJ(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`
                vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);
                materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        fragColor = vec4(materialColor.a);
      }
    `)),t.output===k.Color&&(i.include(Ch),e.include(Ah,t),e.include(wye,t),e.include(xye,t),e.include(JT,t),t.receiveShadows?(e.include(G8,t),i.code.add(w`float evaluateShadow() {
return readShadowMap(vPositionWorldCameraRelative, linearDepth);
}`)):i.code.add(w`float evaluateShadow() { return 0.0; }`),n&&i.uniforms.add(new et("ovColorTex",(a,l)=>nJ(a,l))),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);
        ${t.hasMultipassTerrain?w`terrainDepthTest(gl_FragCoord, vPosition_view.z);`:""}

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        vec4 externalColor;
        int externalColorMixMode;
        readExternalColor(externalColor, externalColorMixMode);

        vec4 materialColor = computeMaterialColor(
          textureColor,
          externalColor,
          externalColorMixMode
        );
        ${n?w`vec4 overlayColor = getOverlayColor(ovColorTex, vtcOverlay);`:""}
    `),t.pbrMode===lt.Normal||t.pbrMode===lt.Schematic?(Fg(i),i.code.add(w`
        ${t.pbrMode===lt.Normal?w`
                applyPBRFactors();
                if (int(externalColorMixMode) == 3) {
                  mrr = vec3(0.0, 0.6, 0.2);
                }`:""}
        vec3 normalVertex = shadingNormalWorld();
        float additionalIrradiance = 0.02 * mainLightIntensity[2];
      `),t.hasNormalTexture?i.code.add(w`mat3 tangentSpace = computeTangentSpace(normalVertex, vPositionWorldCameraRelative, vuv0);
vec3 shadingNormal = computeTextureNormal(tangentSpace, vuv0);`):i.code.add(w`vec3 shadingNormal = normalVertex;`),i.code.add(w`${t.spherical?w`vec3 normalGround = normalize(positionWorld());`:w`vec3 normalGround = vec3(0.0, 0.0, 1.0);`}
      `),i.code.add(w`
        vec3 viewDir = normalize(vPositionWorldCameraRelative);
        float ssao = 1.0 - occlusion * (1.0 - evaluateAmbientOcclusion());

        ${t.snowCover?w`
                vec3 surfaceNormal = normalize(shadingNormalWorld());
                float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
                materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);

                shadingNormal = mix(shadingNormal, surfaceNormal, snow);
                ssao = mix(ssao, 0.0, snow);
                mrr = mix(mrr, vec3(0.0, 1.0, 0.04), snow);
                emission = mix(emission, vec3(0.0), snow);`:""}

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec3 additionalLight = evaluateAdditionalLighting(ssao, positionWorld());
        vec4 shadedColor = vec4(evaluateSceneLightingPBR(shadingNormal, materialColor.rgb, evaluateShadow(), ssao, additionalLight, viewDir, normalGround, mrr, emission, additionalIrradiance), materialColor.a);
        `)):(t.receiveShadows?i.code.add(w`float shadow = evaluateShadow();`):t.spherical?(PO(i),i.code.add(w`float additionalAmbientScale = additionalDirectedAmbientLight(positionWorld());
float shadow = lightingGlobalFactor * (1.0 - additionalAmbientScale);`)):i.code.add(w`float shadow = 0.0;`),o&&i.uniforms.add(new et("ovNormalTex",(a,l)=>Zie(l))),t.snowCover&&i.code.add(w`vec3 surfaceNormal = normalize(cross(dFdx(vPositionWorldCameraRelative), dFdy(vPositionWorldCameraRelative)));
float snow = smoothstep(0.5, 0.55, dot(surfaceNormal, normalize(positionWorld())));
materialColor.rgb = mix(materialColor.rgb, vec3(1), snow);`),i.code.add(w`
        float ambientOcclusion = evaluateAmbientOcclusion();
        vec3 additionalLight = evaluateAdditionalLighting(ambientOcclusion, positionWorld());

        ${n?w` materialColor = materialColor * (1.0 - overlayColor.a) + overlayColor;`:""}

        vec4 shadedColor = vec4(evaluateSceneLighting(shadingNormalWorld(), materialColor.rgb, shadow, ambientOcclusion, additionalLight), materialColor.a);
      ${o?w`
              vec4 overlayWaterMask = getOverlayColor(ovNormalTex, vtcOverlay);
              float waterNormalLength = length(overlayWaterMask);
              if (waterNormalLength > 0.95) {
                mat3 tbnMatrix = mat3(tbnTangent, tbnBiTangent, groundNormal);
                vec4 waterColorLinear = getOverlayWaterColor(overlayWaterMask, overlayColor, -normalize(vPositionWorldCameraRelative), shadow, groundNormal, tbnMatrix, vPosition_view, positionWorld());
                vec4 waterColorNonLinear = delinearizeGamma(vec4(waterColorLinear.xyz, 1.0));
                // un-gamma the ground color to mix in linear space
                shadedColor = mix(shadedColor, waterColorNonLinear, waterColorLinear.w);
              }`:""}
      `)),i.code.add(w`
        fragColor = highlightSlice(shadedColor, vPositionWorldCameraRelative);
        ${t.transparencyPassType===ut.Color?"fragColor = premultiplyAlpha(fragColor);":""}
      }
    `)),(t.output===k.Depth||s)&&(e.include(N0,t),i.code.add(w`void main() {
discardBySlice(vPositionWorldCameraRelative);
vec4 textureColor = readBaseColorTexture();
discardOrAdjustAlpha(textureColor);
outputDepth(linearDepth);
}`)),t.output===k.Normal&&(e.include(xye,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        // note: the alpha component needs to be 1.0 in order for this material
        // to influence ambient occlusion, see the ssao fragment shader
        float alpha = ${t.normalType===Fr.Ground?"0.0":"1.0"};
        fragColor = vec4(vec3(.5) + .5 * shadingNormal_view(), alpha);
      }
    `)),t.output===k.ObjectAndLayerIdColor&&e.fragment.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`fragColor = getOverlayColorTexel(vtcOverlay);`:"outputObjectAndLayerIdColor();"}
      }
    `),t.output===k.Highlight&&(e.include(J0,t),i.code.add(w`
      void main() {
        discardBySlice(vPositionWorldCameraRelative);

        vec4 textureColor = readBaseColorTexture();
        discardOrAdjustAlpha(textureColor);

        ${n?w`
                vec4 overlayColor = getCombinedOverlayColor();
                if (overlayColor.a == 0.0) {
                  fragColor = vec4(0.0);
                  return;
                }`:""}

        outputHighlight();
      }
    `)),e}function Zie(t){return t.overlays.length===0?null:t.overlays[Ji.INNER].getValidTexture(Os.Water)}const NMt=Object.freeze(Object.defineProperty({__proto__:null,build:DMt,getOverlayNormalTexture:Zie},Symbol.toStringTag,{value:"Module"}));let JNe=class QNe extends Ur{initializeConfiguration(e,r){r.spherical=e.viewingMode===Ue.Global,r.doublePrecisionRequiresObfuscation=e.rctx.driverTest.doublePrecisionRequiresObfuscation.result}initializeProgram(e){return new Lr(e.rctx,QNe.shader.get().build(this.configuration),KNe)}_setPipelineState(e){const r=this.configuration,i=r.integratedMeshMode!==ch.None,s=e===ut.NONE,n=e===ut.FrontFace;return It({blending:r.output!==k.Color&&r.output!==k.Alpha||!r.blendingEnabled?null:s?vh:Q0(e),culling:n8(r.cullFace),depthTest:{func:gb(e)},depthWrite:s||n?Ac:null,colorWrite:Wt,stencilWrite:i||r.hasOccludees?Og:null,stencilTest:i?$bt(xc.IntegratedMeshMaskExcluded):r.hasOccludees?yb:null,polygonOffset:s||n?r.hasPolygonOffset?{factor:2,units:2}:null:$8})}initializePipeline(){return this._setPipelineState(this.configuration.transparencyPassType)}};JNe.shader=new $r(NMt,()=>J(()=>import("./ComponentShader.glsl-1fb0dc31.js"),[],import.meta.url));const KNe=new Map([[E.POSITION,0],[E.NORMAL,1],[E.NORMALCOMPRESSED,1],[E.COLOR,2],[E.UV0,3],[E.UVREGION,4],[E.COMPONENTINDEX,5]]);let FMt=class extends ui{constructor(){super(...arguments),this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){if(this._dirty=!1,this._parameterBlocks!=null)for(const e of this._parameterBlocks)this[e]._setClean()}get dirty(){return this._dirty||this._checkParameterBlocksDirty()}_checkParameterBlocksDirty(){if(this._parameterBlocks==null)return!1;for(const e of this._parameterBlocks)if(this[e].dirty)return!0;return!1}},Xie=class{constructor(){this._dirty=!0}_setDirty(){this._dirty=!0}_setClean(){this._dirty=!1}get dirty(){return this._dirty}};function Cs(t={}){return(e,r)=>{const i=e._parameterCount??0;if(e._parameterCount=i+1,t.vectorOps){const s=t.vectorOps;Object.defineProperty(e,r,{get(){return this[i]},set(n){const o=this[i];if(o==null)this[i]=n;else{if(s.equals(o,n))return;s.copy(o,n)}this._setDirty()}})}else Object.defineProperty(e,r,{get(){return this[i]},set(s){this[i]!==s&&(t.dispose&&this[i]&&this[i].dispose(),this[i]=s,this._setDirty())}})}}function Tye(){return(t,e)=>{const r=t._parameterCount??0;t._parameterCount=r+1,t._parameterBlocks=t._parameterBlocks||[],t._parameterBlocks.push(r),Object.defineProperty(t,e,{get(){return this[r]},set(i){this[r]!==i&&(this[r]=i,this._setDirty())}})}}let i9=class{constructor(e){this._low=C(),this._high=C(),e&&this.set(e)}get low(){return this._low}get high(){return this._high}set(e){oe(this._low,oe(Sye,e));const r=Mi(Sye,e,this._low);oe(this._high,r)}get(e){return ue(e,this._low,this._high)}getLowScaled(e){return ae(e,this._low,1)}};const Sye=gs();let xo=class extends FMt{constructor(e,r){super(),this.toMapSpace=r,this.baseColor=Vt(1,1,1,1),this.usePBR=!1,this.hasParametersFromSource=!1,this.mrrFactors=Ml(H8),this.emissiveFactor=Ee(0,0,0),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null,this.objectOpacity=1,this.commonMaterialParameters=new T5,this.componentParameters=new OI,this.textureAlphaCutoff=BU,this.alphaDiscardMode=ni.Opaque,this.isIntegratedMesh=!1,this.polygonOffsetEnabled=!1,this.ellipsoidMode=pg.Earth,this.hasOccludees=!1,this._techniqueConfiguration=new gr;const i=new i9(e.position),s=PLe(e.rotationScale);gS(s,s),this.transformNormalGlobalFromModel=lOe(Wd(s,s)),this.transformWorldFromModelTL=i.low,this.transformWorldFromModelTH=i.high,this.transformWorldFromModelRS=e.rotationScale}dispose(){this._technique=as(this._technique),this.baseColorTexture=null,this.metallicRoughnessTexture=null,this.emissionTexture=null,this.occlusionTexture=null,this.normalTexture=null}get texture(){return this.baseColorTexture!=null?this.baseColorTexture.glTexture:null}get textureMetallicRoughness(){return this.metallicRoughnessTexture!=null?this.metallicRoughnessTexture.glTexture:null}get textureEmissive(){return this.emissionTexture!=null?this.emissionTexture.glTexture:null}get textureOcclusion(){return this.occlusionTexture!=null?this.occlusionTexture.glTexture:null}get textureNormal(){return this.normalTexture!=null?this.normalTexture.glTexture:null}prepareTechnique(e,r,i,s){const n=this._techniqueConfiguration;n.hasVertexColors=s.colors,n.hasNormals=s.normals,n.textureCoordinateType=s.textureCoordinates,n.hasMetallicRoughnessTexture=this.metallicRoughnessTexture!=null,n.hasEmissionTexture=this.emissionTexture!=null,n.hasOcclusionTexture=this.occlusionTexture!=null,n.hasNormalTexture=this.normalTexture!=null,n.transparencyPassType=r.identifier===mu.Material&&i.transparencyPassType!=null?i.transparencyPassType:ut.NONE,n.hasMultipassTerrain=r.identifier===mu.Material&&i.multipassTerrain!=null&&i.multipassTerrain.enabled,n.cullAboveGround=r.identifier===mu.Material&&i.multipassTerrain!=null&&i.multipassTerrain.cullAboveGround,n.ellipsoidMode=this.ellipsoidMode,n.componentData=this.componentParameters.type,n.cullFace=this.commonMaterialParameters.cullFace,n.doubleSidedMode=this.commonMaterialParameters.doubleSided?bs.View:bs.None,n.hasBaseColorTexture=this.baseColorTexture!=null;const o=this._computeWhichMaterialPass();n.blendingEnabled=o===El.Transparent||o===El.OpaqueAndTransparent,n.alphaDiscardMode=this.alphaDiscardMode,n.integratedMeshMode=this.isIntegratedMesh?UMt(i)?Zie(i)?ch.ColorOverlayWithWater:ch.ColorOverlay:ch.NoOverlay:ch.None,n.hasPolygonOffset=this.polygonOffsetEnabled;const a=this.hasParametersFromSource&&this.baseColorTexture==null;if(n.pbrMode=n.integratedMeshMode===ch.ColorOverlayWithWater?lt.WaterOnIntegratedMesh:this.usePBR?a?lt.Schematic:lt.Normal:lt.Disabled,n.normalType=n.integratedMeshMode===ch.None?n.hasNormals?Fr.Compressed:Fr.ScreenDerivative:Fr.Ground,n.hasSlicePlane=i.slicePlane!=null&&this.commonMaterialParameters.hasSlicePlane,r.identifier===mu.ShadowMap)n.output=k.Shadow,n.vertexDiscardMode=Rd.None;else if(r.identifier===mu.Highlight)n.output=k.Highlight,n.vertexDiscardMode=Rd.None;else{switch(this._computeWhichMaterialPass()===El.OpaqueAndTransparent?n.vertexDiscardMode=r.transparent?Rd.Opaque:Rd.Transparent:n.vertexDiscardMode=Rd.None,n.output=r.output,n.receiveAmbientOcclusion=!1,n.receiveShadows=!1,r.output){case k.Color:n.receiveAmbientOcclusion=i.ssaoHelper.active,n.hasOccludees=i.hasOccludees,n.receiveShadows=i.shadowMap.ready,n.hasScreenSpaceReflections=i.ssr.enabled,n.hasCloudsReflections=i.cloudsFade.data!=null;break;case k.Alpha:n.hasOccludees=i.hasOccludees;break;case k.ObjectAndLayerIdColor:n.objectAndLayerIdColor=!0}n.snowCover=this.hasSnowCover(i)}return this._technique=e.releaseAndAcquire(JNe,n,this._technique),this._setClean(),this._technique}hasSnowCover(e){return e.weather!=null&&e.weatherVisible&&e.weather.type==="snowy"&&e.weather.snowCover==="enabled"}submit(e,r,i){if(this.objectOpacity===0)return;const s=i.renderable.geometry,n=i.components,o=i.renderable.meta.cameraDepthSquared,a=n.geometryRanges,l=n.highlightRanges,c=n.defaultShadowMapRanges;switch(this._computeWhichMaterialPass()){case El.Opaque:e.materialOpaque.submitDraw(this,s,a,o);break;case El.Transparent:e.materialTransparent.submitDraw(this,s,a,o);break;case El.OpaqueAndTransparent:e.materialOpaque.submitDraw(this,s,a,o),e.materialTransparent.submitDraw(this,s,a,o);break;case El.IntegratedMesh:e.materialIntegratedMesh.submitDraw(this,s,a,o),kMt(r)&&e.highlightIntegratedMesh.submitDraw(this,s,a,o)}const h=this.componentParameters.castShadows!==ro.None;h&&e.shadowMap.submitDraw(this,s,a,o),l!=null&&(e.highlight.submitDraw(this,s,l,o),h&&e.highlightShadowMap.submitDraw(this,s,l,o)),h&&c!=null&&e.defaultShadowMap.submitDraw(this,s,c,o)}_computeWhichMaterialPass(){return this.isIntegratedMesh?El.IntegratedMesh:this.objectOpacity<1?El.Transparent:this.componentParameters.opaqueOverride===ro.All?El.Opaque:this.baseColor[3]<1||this.alphaDiscardMode===ni.Blend||this.alphaDiscardMode===ni.MaskBlend?El.Transparent:this.componentParameters.transparent===ro.None?El.Opaque:this.componentParameters.transparent===ro.All?El.Transparent:El.OpaqueAndTransparent}};var El,ro;u([Cs({vectorOps:nbe})],xo.prototype,"baseColor",void 0),u([Cs()],xo.prototype,"usePBR",void 0),u([Cs()],xo.prototype,"hasParametersFromSource",void 0),u([Cs({vectorOps:bne})],xo.prototype,"mrrFactors",void 0),u([Cs({vectorOps:bne})],xo.prototype,"emissiveFactor",void 0),u([Cs({dispose:!0})],xo.prototype,"baseColorTexture",void 0),u([Cs({dispose:!0})],xo.prototype,"metallicRoughnessTexture",void 0),u([Cs({dispose:!0})],xo.prototype,"emissionTexture",void 0),u([Cs({dispose:!0})],xo.prototype,"occlusionTexture",void 0),u([Cs({dispose:!0})],xo.prototype,"normalTexture",void 0),u([Cs()],xo.prototype,"objectOpacity",void 0),u([Tye()],xo.prototype,"commonMaterialParameters",void 0),u([Tye()],xo.prototype,"componentParameters",void 0),u([Cs()],xo.prototype,"textureAlphaCutoff",void 0),u([Cs()],xo.prototype,"alphaDiscardMode",void 0),u([Cs()],xo.prototype,"isIntegratedMesh",void 0),u([Cs()],xo.prototype,"polygonOffsetEnabled",void 0),u([Cs()],xo.prototype,"ellipsoidMode",void 0),u([Cs()],xo.prototype,"hasOccludees",void 0),function(t){t[t.Opaque=0]="Opaque",t[t.Transparent=1]="Transparent",t[t.OpaqueAndTransparent=2]="OpaqueAndTransparent",t[t.IntegratedMesh=3]="IntegratedMesh"}(El||(El={}));let T5=class extends Xie{constructor(){super(...arguments),this.doubleSided=!1,this.cullFace=Ii.Back,this.hasSlicePlane=!0}};u([Cs()],T5.prototype,"doubleSided",void 0),u([Cs()],T5.prototype,"cullFace",void 0),u([Cs()],T5.prototype,"hasSlicePlane",void 0);let OI=class extends Xie{constructor(){super(...arguments),this.externalColor=Vt(1,1,1,1),this.externalColorMixMode=pn.Multiply,this.castShadows=ro.All}get transparent(){return this.externalColor[3]<1?ro.All:ro.None}get opaqueOverride(){return this.externalColorMixMode===pn.Replace&&this.externalColor[3]===1?ro.All:ro.None}get visible(){return this.externalColor[3]>0?ro.All:ro.None}get type(){return dg.Uniform}};u([Cs({vectorOps:nbe})],OI.prototype,"externalColor",void 0),u([Cs()],OI.prototype,"externalColorMixMode",void 0),u([Cs()],OI.prototype,"castShadows",void 0),function(t){t[t.All=0]="All",t[t.Some=1]="Some",t[t.None=2]="None"}(ro||(ro={}));let CM=class extends Xie{constructor(){super(...arguments),this.texture=null,this.transparent=ro.None,this.opaqueOverride=ro.None,this.castShadows=ro.None}get type(){return dg.Varying}};function kMt(t){return t.overlays.length!==0&&t.overlays[Ji.INNER].getValidTexture(Os.Highlight)!=null}function UMt(t){return t.overlays.length!==0&&t.overlays[Ji.INNER].getColorTextureNoRasterImage()!=null}u([Cs()],CM.prototype,"texture",void 0),u([Cs()],CM.prototype,"transparent",void 0),u([Cs()],CM.prototype,"opaqueOverride",void 0),u([Cs()],CM.prototype,"castShadows",void 0);const f6=us().vec3f(E.POSITION).u16(E.COMPONENTINDEX).u16(E.U16PADDING),eFe=us().vec2u8(E.SIDENESS),VMt=$u(eFe),tFe=us().vec3f(E.POSITION0).vec3f(E.POSITION1).u16(E.COMPONENTINDEX).u8(E.VARIANTOFFSET,{glNormalized:!0}).u8(E.VARIANTSTROKE).u8(E.VARIANTEXTENSION,{glNormalized:!0}).u8(E.U8PADDING,{glPadding:!0}).u16(E.U16PADDING,{glPadding:!0}),yJ=tFe.clone().vec3f(E.NORMAL),_J=tFe.clone().vec3f(E.NORMALA).vec3f(E.NORMALB),rFe=new Map([[E.POSITION0,0],[E.POSITION1,1],[E.COMPONENTINDEX,2],[E.VARIANTOFFSET,3],[E.VARIANTSTROKE,4],[E.VARIANTEXTENSION,5],[E.NORMAL,6],[E.NORMALA,6],[E.NORMALB,7],[E.SIDENESS,8]]);function Eye(t,e,r){const i=e/3,s=new Uint32Array(r+1),n=new Uint32Array(r+1),o=(b,x)=>{b<x?s[b+1]++:n[x+1]++};for(let b=0;b<i;b++){const x=t[3*b],T=t[3*b+1],S=t[3*b+2];o(x,T),o(T,S),o(S,x)}let a=0,l=0;for(let b=0;b<r;b++){const x=s[b+1],T=n[b+1];s[b+1]=a,n[b+1]=l,a+=x,l+=T}const c=new Uint32Array(6*i),h=s[r],p=(b,x,T)=>{if(b<x){const S=s[b+1]++;c[2*S]=x,c[2*S+1]=T}else{const S=n[x+1]++;c[2*h+2*S]=b,c[2*h+2*S+1]=T}};for(let b=0;b<i;b++){const x=t[3*b],T=t[3*b+1],S=t[3*b+2];p(x,T,b),p(T,S,b),p(S,x,b)}const f=(b,x)=>{const T=2*b,S=x-b;for(let O=1;O<S;O++){const A=c[T+2*O],M=c[T+2*O+1];let P=O-1;for(;P>=0&&c[T+2*P]>A;P--)c[T+2*P+2]=c[T+2*P],c[T+2*P+3]=c[T+2*P+1];c[T+2*P+2]=A,c[T+2*P+3]=M}};for(let b=0;b<r;b++)f(s[b],s[b+1]),f(h+n[b],h+n[b+1]);const m=new Int32Array(3*i),g=(b,x)=>b===t[3*x]?0:b===t[3*x+1]?1:b===t[3*x+2]?2:-1,_=(b,x)=>{const T=g(b,x);m[3*x+T]=-1},v=(b,x,T,S)=>{const O=g(b,x);m[3*x+O]=S;const A=g(T,S);m[3*S+A]=x};for(let b=0;b<r;b++){let x=s[b];const T=s[b+1];let S=n[b];const O=n[b+1];for(;x<T&&S<O;){const A=c[2*x],M=c[2*h+2*S];A===M?(v(b,c[2*x+1],M,c[2*h+2*S+1]),x++,S++):A<M?(_(b,c[2*x+1]),x++):(_(M,c[2*h+2*S+1]),S++)}for(;x<T;)_(b,c[2*x+1]),x++;for(;S<O;)_(c[2*h+2*S],c[2*h+2*S+1]),S++}return m}let iFe=class{updateSettings(e){this.settings=e,this._edgeHashFunction=e.reducedPrecision?BMt:zMt}write(e,r,i){const s=this._edgeHashFunction(i);aF.seed=s;const n=aF.getIntRange(0,255),o=aF.getIntRange(0,this.settings.variants-1),a=.7,l=aF.getFloat(),c=255*(.5*GMt(-(1-Math.min(l/a,1))+Math.max(0,l-a)/(1-a),1.2)+.5);e.position0.setVec(r,i.position0),e.position1.setVec(r,i.position1),e.componentIndex.set(r,i.componentIndex),e.variantOffset.set(r,n),e.variantStroke.set(r,o),e.variantExtension.set(r,c)}trim(e,r){return e.slice(0,r)}};const Yie=new Float32Array(6),m6=new Uint32Array(Yie.buffer),b1=new Uint32Array(1);function zMt(t){const e=Yie;e[0]=t.position0[0],e[1]=t.position0[1],e[2]=t.position0[2],e[3]=t.position1[0],e[4]=t.position1[1],e[5]=t.position1[2],b1[0]=5381;for(let r=0;r<m6.length;r++)b1[0]=31*b1[0]+m6[r];return b1[0]}function BMt(t){const e=Yie;e[0]=P2(t.position0[0]),e[1]=P2(t.position0[1]),e[2]=P2(t.position0[2]),e[3]=P2(t.position1[0]),e[4]=P2(t.position1[1]),e[5]=P2(t.position1[2]),b1[0]=5381;for(let r=0;r<m6.length;r++)b1[0]=31*b1[0]+m6[r];return b1[0]}const Cye=1e4;function P2(t){return Math.round(t*Cye)/Cye}function GMt(t,e){const r=t<0?-1:1;return Math.abs(t)**e*r}let g6=class{constructor(){this._commonWriter=new iFe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return yJ.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),ue(oF,i.faceNormal0,i.faceNormal1),_e(oF,oF),e.normal.setVec(r,oF)}trim(e,r){return this._commonWriter.trim(e,r)}};g6.Layout=yJ,g6.glLayout=$u(yJ,1);let y6=class{constructor(){this._commonWriter=new iFe}updateSettings(e){this._commonWriter.updateSettings(e)}allocate(e){return _J.createBuffer(e)}write(e,r,i){this._commonWriter.write(e,r,i),e.normalA.setVec(r,i.faceNormal0),e.normalB.setVec(r,i.faceNormal1)}trim(e,r){return this._commonWriter.trim(e,r)}};y6.Layout=_J,y6.glLayout=$u(_J,1);const oF=C(),aF=new PM,fx=-1;var _6;function jMt(t,e,r,i=YMt){const s=t.vertices.position,n=t.vertices.componentIndex,o=zt(i.anglePlanar),a=zt(i.angleSignificantEdge),l=Math.cos(a),c=Math.cos(o),h=vJ.edge,p=h.position0,f=h.position1,m=h.faceNormal0,g=h.faceNormal1,_=XMt(t),v=ZMt(t),b=v.length/4,x=e.allocate(b);let T=0;const S=b,O=r.allocate(S);let A=0,M=0,P=0;const F=w4e(0,b),$=new Float32Array(b);$.forEach((G,ee,I)=>{s.getVec(v[4*ee],p),s.getVec(v[4*ee+1],f),I[ee]=_i(p,f)}),F.sort((G,ee)=>$[ee]-$[G]);const N=new Array,U=new Array;for(let G=0;G<b;G++){const ee=F[G],I=$[ee],V=v[4*ee],z=v[4*ee+1],H=v[4*ee+2],Y=v[4*ee+3],te=Y===fx;if(s.getVec(V,p),s.getVec(z,f),te)ie(m,_[3*H],_[3*H+1],_[3*H+2]),oe(g,m),h.componentIndex=n.get(V),h.cosAngle=de(m,g);else{if(ie(m,_[3*H],_[3*H+1],_[3*H+2]),ie(g,_[3*Y],_[3*Y+1],_[3*Y+2]),h.componentIndex=n.get(V),h.cosAngle=de(m,g),qMt(h,c))continue;h.cosAngle<-.9999&&oe(g,m)}M+=I,P++,te||HMt(h,l)?(e.write(x,T++,h),N.push(I)):WMt(h,o)&&(r.write(O,A++,h),U.push(I))}const X=new Float32Array(N.reverse()),Z=new Float32Array(U.reverse());return{regular:{instancesData:e.trim(x,T),lodInfo:{lengths:X}},silhouette:{instancesData:r.trim(O,A),lodInfo:{lengths:Z}},averageEdgeLength:M/P}}function HMt(t,e){return t.cosAngle<e}function qMt(t,e){return t.cosAngle>e}function WMt(t,e){const r=oo(t.cosAngle),i=vJ.fwd,s=vJ.ortho;return F0(i,t.position1,t.position0),r*(de(st(s,t.faceNormal0,t.faceNormal1),i)>0?-1:1)>e}function ZMt(t){const e=t.faces.length/3,r=t.faces,i=t.neighbors;let s=0;for(let a=0;a<e;a++){const l=i[3*a],c=i[3*a+1],h=i[3*a+2],p=r[3*a],f=r[3*a+1],m=r[3*a+2];s+=l===fx||p<f?1:0,s+=c===fx||f<m?1:0,s+=h===fx||m<p?1:0}const n=new Int32Array(4*s);let o=0;for(let a=0;a<e;a++){const l=i[3*a],c=i[3*a+1],h=i[3*a+2],p=r[3*a],f=r[3*a+1],m=r[3*a+2];(l===fx||p<f)&&(n[o++]=p,n[o++]=f,n[o++]=a,n[o++]=l),(c===fx||f<m)&&(n[o++]=f,n[o++]=m,n[o++]=a,n[o++]=c),(h===fx||m<p)&&(n[o++]=m,n[o++]=p,n[o++]=a,n[o++]=h)}return n}function XMt(t){const e=t.faces.length/3,r=t.vertices.position,i=t.faces,s=uj.v0,n=uj.v1,o=uj.v2,a=new Float32Array(3*e);for(let l=0;l<e;l++){const c=i[3*l],h=i[3*l+1],p=i[3*l+2];r.getVec(c,s),r.getVec(h,n),r.getVec(p,o),pe(n,n,s),pe(o,o,s),st(s,n,o),_e(s,s),a[3*l]=s[0],a[3*l+1]=s[1],a[3*l+2]=s[2]}return a}(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH"})(_6||(_6={}));const vJ={edge:{position0:C(),position1:C(),faceNormal0:C(),faceNormal1:C(),componentIndex:0,cosAngle:0},ortho:C(),fwd:C()},uj={v0:C(),v1:C(),v2:C()},YMt={anglePlanar:4,angleSignificantEdge:35};function JMt(t){const e=QMt(t.data,t.skipDeduplicate,t.indices,t.indicesLength);return Aye.updateSettings(t.writerSettings),Oye.updateSettings(t.writerSettings),jMt(e,Aye,Oye)}function QMt(t,e,r,i){if(e){const o=Eye(r,i,t.count);return new KMt(r,i,o,t)}const s=$Y(t.buffer,t.stride/4,{originalIndices:r,originalIndicesLength:i}),n=Eye(s.indices,i,s.uniqueCount);return{faces:s.indices,facesLength:s.indices.length,neighbors:n,vertices:f6.createView(s.buffer)}}let KMt=class{constructor(e,r,i,s){this.faces=e,this.facesLength=r,this.neighbors=i,this.vertices=s}};const Aye=new g6,Oye=new y6,KYt=us().vec3f(E.POSITION0).vec3f(E.POSITION1),eIt=us().vec3f(E.POSITION0).vec3f(E.POSITION1).u16(E.COMPONENTINDEX).u16(E.U16PADDING,{glPadding:!0});let tIt=class{constructor(e){this._maxCount=e,this._nextIndex=0,this._recycledIndices=[]}get activeCount(){return this._nextIndex-this._recycledIndices.length}get availableCount(){return this._recycledIndices.length+this._maxCount-this._nextIndex}acquire(){return this._recycledIndices.length>0?this._recycledIndices.pop():this.availableCount?this._nextIndex++:void 0}release(e){this._recycledIndices.push(e)}},rIt=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this.textureWidth=4096,this._dirty=!0;const i=new Sr;i.samplingMode=Mt.NEAREST,i.wrapMode=Ut.CLAMP_TO_EDGE,i.width=this.textureWidth,i.height=1,this._texture=new Rt(this._rctx,i),this._data=new rl(new ArrayBuffer(4*this.textureWidth))}dispose(){this._texture.dispose(),this._texture=void 0,this._data=void 0}setData(e,r,i,s,n,o){const a=e*this._fieldCount+r;this._dirty=!0,this._data.set(a,0,i),this._data.set(a,1,s),this._data.set(a,2,n),this._data.set(a,3,o)}setDataElement(e,r,i,s){const n=e*this._fieldCount+r;this._dirty=!0,this._data.set(n,i,s)}getDataElement(e,r,i){const s=e*this._fieldCount+r;return this._dirty=!0,this._data.get(s,i)}resizeToFit(e){const r=(e+1)*this._fieldCount;if(r>this._data.count){const i=Math.ceil(r/this.textureWidth)*this.textureWidth,s=new rl(new ArrayBuffer(4*i));s.typedBuffer.set(this._data.typedBuffer),this._data=s}}updateTexture(){if(!this._dirty)return;const e=this._texture.descriptor.width,r=this._texture.descriptor.height;this._data.count>e*r&&this._texture.resize(e,this._data.count/e),this._texture.setData(this._data.typedBuffer),this._dirty=!1}get texture(){return this._texture}};const sFe=65536;let iIt=class{constructor(e,r=1){this.textureBuffer=new rIt(e,r),this._indexManager=new tIt(sFe)}dispose(){this.textureBuffer.dispose(),this.textureBuffer=void 0}get availableCount(){return this._indexManager.availableCount}get activeCount(){return this._indexManager.activeCount}acquireIndex(){const e=this._indexManager.acquire();return this.textureBuffer.resizeToFit(e),e}releaseIndex(e){this._indexManager.release(e)}},nFe=class{constructor(e,r=1){this._rctx=e,this._fieldCount=r,this._buffers=[]}garbageCollect(){this._buffers=this._buffers.filter(e=>e.activeCount!==0||(e.dispose(),!1))}destroy(){this._buffers.forEach(e=>e.dispose()),this._buffers=[]}getBuffer(e){for(const i of this._buffers)if(i.availableCount>=e)return i;if(e>sFe)return null;const r=new iIt(this._rctx,this._fieldCount);return this._buffers.push(r),r}updateTextures(){for(const e of this._buffers)e.textureBuffer.updateTexture()}};const Rye=K.getLogger("esri.views.3d.webgl-engine.collections.Component.ComponentObjectCollection");class sIt{constructor(e,r){this._renderManager=e,this._viewingMode=r,this._objects=[new qt,new qt],this._renderSubmit=new CMt(this),this._renderManager.register(this._renderSubmit),this._hasObjectAndLayerId=le("enable-feature:objectAndLayerId-rendering"),this._componentBufferManager=new nFe(e.rctx,2+(this._hasObjectAndLayerId?1:0))}destroy(){it(this._objects[ZC.Hidden].length===0&&this._objects[ZC.Visible].length===0,"ObjectCollection should be empty upon disposal"),this._componentBufferManager.destroy();const e=this._objects.flatMap(r=>r.toArray());for(const r of e)r?.destroy()}createObject(e){const r=new EM;return r.toMapSpace=e.toMapSpace,r.transform=e.transform,r.obb=Zce(e.obb),r.components=new oMt(this._componentBufferManager,cg(e.geometry.componentOffsets)),r.renderable=this._createRenderable(e,r.components),r.intersectionGeometry=new pMt(e.geometry.positionData,r.components),this._objects[r.visible].push(r),r}destroyObject(e){const r=e;this._objects[r.visible].removeUnordered(r),r.destroy(),this._notifyDirty()}setObjectVisibility(e,r){const i=e;r!==i.visible&&(this._objects[i.visible].removeUnordered(i),this._objects[r].push(i),i.visible=r,this._notifyDirty())}preSubmit(e){const r=e.camera.eye;this.visibleObjects.forAll(i=>i.renderable.meta.cameraDepthSquared=kn(r,i.obb.center))}getMaterial(e){return e.renderable.material}updateMaterial(e,r){const i=e.renderable.material;r(i),i.dirty&&this._notifyDirty()}setAllComponentVisibilities(e,r){const i=e;i.components.visibility.reset(r),i.components.visibilityDirty(),this._notifyDirty()}forEachVisibleComponent(e,r){return e.components.visibility.forEachComponent(r)}getComponentCount(e){const r=e,i=r.components.visibility.componentCount();return{visible:i,invisible:r.components.count-i}}setComponentData(e,r){const i=e,s=i.renderable.material,n=i.components,o=n.materialDataBuffer,a=n.materialDataIndices,l=new OMt,c=o.textureBuffer,h=new Uint8Array(4),p=new Uint32Array(h.buffer);let f=0,m=0,g=0,_=n.verticalOffsets,v=1/0,b=-1/0,x=!1,T=!1,S=0;for(let O=0;O<n.count;O++){r(O,l),f+=+(l.externalColor[3]<1),m+=+(l.externalColorMixMode===pn.Replace&&l.externalColor[3]===1),g+=+l.castShadows,AOe(l.externalColor,l.externalColorMixMode,h),h[2]=254&h[2]|+l.castShadows,c.setData(a[O],0,h[0],h[1],h[2],h[3]),x||(x=O>0&&S!==p[0]),S=p[0],T||(T=l.elevationOffset!==0),T&&_==null&&(_=new Array(O).fill(0)),_!=null&&(_[O]=l.elevationOffset),v=Math.min(v,l.elevationOffset),b=Math.max(b,l.elevationOffset),YNe(l.elevationOffset,h),c.setData(a[O],1,h[0],h[1],h[2],h[3]);const A=l.objectAndLayerIdColor;A!=null&&c.setData(a[O],2,A[0],A[1],A[2],A[3]),l.pickable!==WNe(n.pickability,O)&&(n.pickability=lMt(n.pickability,n.count,O,l.pickable))}n.verticalOffsets=T?_:null,i.offsetObb=T?ylt(i.obb,v,b,this._viewingMode,i.offsetObb!=null?i.offsetObb:Zce(i.obb)):null,x||T||this._hasObjectAndLayerId?(s.componentParameters=new CM,s.componentParameters.castShadows=hj(g,n.count),s.componentParameters.transparent=hj(f,n.count),s.componentParameters.opaqueOverride=hj(m,n.count),s.componentParameters.texture=c,c.updateTexture()):(s.componentParameters=new OI,s.componentParameters.castShadows=l.castShadows?ro.All:ro.None,s.componentParameters.externalColor=l.externalColor,s.componentParameters.externalColorMixMode=l.externalColorMixMode),this._notifyDirty()}getComponentAabb(e,r,i,s=!1){e.intersectionGeometry.getComponentAabb(r,i);const n=e,o=n.components.verticalOffsets;if(s||o==null)return i;const a=o[r];if(this._viewingMode===Ue.Local||a===0)return i[2]+=a,i[5]+=a,i;const l=Wft(a);return l.localOrigin=n.transform.position,l.applyToAabb(i)}getComponentObb(e){return e.obb}getObjectTransform(e){return e.transform}getComponentPositions(e,r,i){return e.intersectionGeometry.getComponentPositions(r,i)}intersect(e,r,i,s,n,o){const a=e;n!=null&&(n.localOrigin=a.transform.position);const l=gS(Mye,a.transform.rotationScale);Mi(lF,r,a.transform.position),Mi(cF,i,a.transform.position),yu(lF,lF,l),yu(cF,cF,l);const c=Wd(Mye,l);return a.intersectionGeometry.intersect(lF,cF,s,c,n,a.components.verticalOffsets,o)}addEdges(e,r,i,s){const n=e,{indices:o,positions:a}=n.intersectionGeometry,l=n.components.offsets;return r.addComponentObject(e,n.transform,{center:n.obb.center,radius:glt(n.obb)},a,o,l,i,s)}async extractEdgeInformation(e,r,i){const s=e,n=s.components.visibility;if(n.allInvisible())return{buffer:eIt.createBuffer(0),origin:[0,0,0]};const{indices:o,positions:a}=s.intersectionGeometry,l=s.components.offsets,c=f6.createBuffer(a.length/3);j$(c.position.typedBuffer,a,c.position.typedBufferStride,3),O$e(c.position,c.position,s.transform.rotationScale),this._setComponentIndices(c.componentIndex,o,l);const h=c.count,p=this._computeVisibilityIndices(o,n,l,h);return{origin:$i(s.transform.position),buffer:await r.extractComponentsEdgeLocations({indices:p,indicesLength:p.length,skipDeduplicate:!0,data:c,writerSettings:{reducedPrecision:!1,variants:0}},i)}}_setComponentIndices(e,r,i){let s=0;for(let n=0;n<i.length-1;n++){const o=i[n],a=i[n+1];for(let l=o;l<a;l++){const c=r?r[l]:l;e.set(c,s)}s++}}_computeVisibilityIndices(e,r,i,s){if(e&&r.allVisible())return e;let n=0;r.forEachComponentRange((l,c)=>(n+=i[c]-i[l],!0));const o=Cf(e)?new Array(n):e?.BYTES_PER_ELEMENT===2||s<=65536?new Uint16Array(n):new Uint32Array(n);let a=0;return r.forEachComponentRange((l,c)=>{const h=i[l],p=i[c];for(let f=h;f<p;f++)o[a++]=e?e[f]:f;return!0}),o}addComponentHighlight(e,r){const i=e.components;i.highlightCounts==null&&(i.highlightCounts=new Uint32Array(i.count+1)),i.highlightCounts[r]++===0&&(i.highlightsDirty(),this._notifyDirty()),i.highlightCounts[i.count]++}removeComponentHighlight(e,r){const i=e.components;if(i.highlightCounts==null)return void Rye.warn("Removing non-existing highlight.");const s=i.highlightCounts[r],n=i.highlightCounts[i.count];if(s!==0){if(s>1)return i.highlightCounts[r]=s-1,void(i.highlightCounts[i.count]=n-1);i.highlightCounts[r]=0,i.highlightsDirty(),this._notifyDirty(),n===1?i.highlightCounts=null:i.highlightCounts[i.count]=n-1}else Rye.warn("Removing non-existing highlight.")}clearHighlights(e){const r=e.components;r.highlightCounts!=null&&(r.highlightCounts=null,r.highlightsDirty(),this._notifyDirty())}getObjectGPUMemoryUsage(e){return e.renderable.meta.gpuMemoryEstimate}get visibleObjects(){return this._objects[ZC.Visible]}_createRenderable(e,r){const i=this._renderManager.rctx,s=e.geometry,n=s.vertices.layoutParameters,o=Gr.createVertex(i,Mr.STATIC_DRAW,s.vertices.data),a=Dl(s.indices,_=>Gr.createIndex(i,Mr.STATIC_DRAW,_)),l=$u(AMt(n)),c=new Uint16Array(s.vertices.count);for(let _=0;_<r.count;_++){const v=r.offsets[_],b=r.offsets[_+1],x=r.materialDataIndices[_];if(s.indices!=null)for(let T=v;T<b;T++)c[s.indices[T]]=x;else for(let T=v;T<b;T++)c[T]=x}const h=Gr.createVertex(i,Mr.STATIC_DRAW,c.buffer),p=new xo(e.transform,e.toMapSpace),f=new Xd(i,KNe,{data:l,componentIndices:nIt},{data:o,componentIndices:h},a),m=new yMt(f,Ot.TRIANGLES,n,a!=null),g={cameraDepthSquared:.5,gpuMemoryEstimate:o.byteLength+h.byteLength+(a!=null?a.byteLength:0)};return new gMt(p,m,g)}_notifyDirty(){this._renderManager.notifyDirty()}}const nIt=$u(us().u16(E.COMPONENTINDEX));function hj(t,e){return t===e?ro.All:t===0?ro.None:ro.Some}const Mye=Tc(),lF=C(),cF=C();let oFe=class extends ui{constructor(){super(...arguments),this.scale=Pe()}};function oIt(t){const e=new Cr;e.attributes.add(E.POSITION,"vec2"),e.varyings.add("uv0","vec2"),e.varyings.add("uv1","vec2"),e.vertex.uniforms.add(new Pr("scale",i=>i.scale)),e.vertex.code.add(w`void main(void) {
gl_Position = vec4(position, 0.0, 1.0);
uv0 = position * 0.5 + vec2(0.5);
uv1 = (position * 0.5 + vec2(0.5)) * scale;
}`),e.fragment.uniforms.add(new et("tex",i=>i.texture),new et("depthTexture",i=>i.depthTexture),new Pr("scale",i=>i.scale),new Pr("clampUV",i=>aIt(i)));const r=t.haze;return e.fragment.code.add(w`
    void main() {
      ${r?w`vec4`:w`float`} depthSample = texture(depthTexture, uv0) ${r?"":w`.r`};
      if (depthSample ${r?w`== vec4(0)`:w`!= 1.0`} ) {
          fragColor = vec4(0);
          return;
      }
      fragColor = texture(tex, min(uv1, clampUV));
    }
    `),e}function aIt(t){if(!t.texture)return Iye;const e=hr(Iye,t.texture.descriptor.width,t.texture.descriptor.height),r=Hee(e,e,t.scale),i=PCe(r,r);return Wee(i,t.scale,i)}const Iye=Pe(),lIt=Object.freeze(Object.defineProperty({__proto__:null,AtmosphereCompositingPassParameters:oFe,build:oIt},Symbol.toStringTag,{value:"Module"}));let aFe=class lFe extends Ur{initializeProgram(e){return new Lr(e.rctx,lFe.shader.get().build(this.configuration),Er)}initializePipeline(){return this.configuration.haze?It({blending:ca(Te.ONE,Te.ZERO,Te.ONE_MINUS_SRC_COLOR,Te.ONE),depthTest:{func:ci.ALWAYS},colorWrite:Wt}):It({blending:Ru(Te.SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),depthTest:{func:ci.ALWAYS},colorWrite:Wt})}};aFe.shader=new $r(lIt,()=>J(()=>import("./AtmosphereCompositing.glsl-074720fd.js"),[],import.meta.url));let cFe=class extends ui{constructor(){super(...arguments),this.opacity=1}};function cIt(t){const e=new Cr;return e.include(ep),e.fragment.uniforms.add(new et("tex",r=>r.texture)),t.hasOpacityFactor&&e.fragment.uniforms.add(new Ie("opacity",r=>r.opacity)),e.fragment.code.add(w`
    void main() {
      fragColor = texture(tex, uv) ${t.hasOpacityFactor?"* opacity":""};
    }`),e}const uIt=Object.freeze(Object.defineProperty({__proto__:null,CompositingPassParameters:cFe,build:cIt},Symbol.toStringTag,{value:"Module"}));var Ya;(function(t){t[t.None=0]="None",t[t.Alpha=1]="Alpha",t[t.PremultipliedAlpha=2]="PremultipliedAlpha",t[t.COUNT=3]="COUNT"})(Ya||(Ya={}));let bJ=class extends nl{constructor(){super(...arguments),this.alphaMode=Ya.None,this.hasOpacityFactor=!1}};u([B({count:Ya.COUNT})],bJ.prototype,"alphaMode",void 0),u([B()],bJ.prototype,"hasOpacityFactor",void 0);let uFe=class hFe extends Ur{initializeProgram(e){return new Lr(e.rctx,hFe.shader.get().build(this.configuration),Er)}initializePipeline(){switch(this.configuration.alphaMode){case Ya.None:return It({colorWrite:Wt});case Ya.Alpha:return It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt});case Ya.PremultipliedAlpha:case Ya.COUNT:return It({blending:Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}}};uFe.shader=new $r(uIt,()=>J(()=>import("./Compositing.glsl-3a3b8a00.js"),[],import.meta.url));let dFe=class extends ui{};function hIt(){const t=new Cr;return t.include(ep),t.fragment.uniforms.add(new et("tex",e=>e.texture)),t.fragment.code.add(w`void main() {
fragColor = vec4(1.0 - texture(tex, uv).a);
}`),t}const dIt=Object.freeze(Object.defineProperty({__proto__:null,HUDCompositingPassParameters:dFe,build:hIt},Symbol.toStringTag,{value:"Module"}));let pFe=class fFe extends Ur{initializeProgram(e){return new Lr(e.rctx,fFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:{r:!1,g:!0,b:!1,a:!1}})}};pFe.shader=new $r(dIt,()=>J(()=>import("./HUDCompositing.glsl-c5a3928a.js"),[],import.meta.url));let mFe=class extends ui{};function pIt(){const t=new Cr;return t.include(ep),t.fragment.uniforms.add(new et("colorTexture",e=>e.colorTexture),new et("alphaTexture",e=>e.alphaTexture),new et("frontFaceTexture",e=>e.frontFaceTexture)),t.fragment.code.add(w`void main() {
vec4 srcColor = texture(colorTexture, uv);
if(srcColor.a <= 1e-5){
discard;
}
float srcAlpha = texture(alphaTexture, uv).r;
vec4 frontFace = texture(frontFaceTexture, uv);
fragColor = vec4(mix(srcColor.rgb/srcColor.a, frontFace.rgb, frontFace.a), 1.0 - srcAlpha);
}`),t}const fIt=Object.freeze(Object.defineProperty({__proto__:null,OITCompositingPassParameters:mFe,build:pIt},Symbol.toStringTag,{value:"Module"}));let gFe=class yFe extends Ur{initializeProgram(e){return new Lr(e.rctx,yFe.shader.get().build(),Er)}initializePipeline(){return It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}};gFe.shader=new $r(fIt,()=>J(()=>import("./OITCompositing.glsl-c6a2ea26.js"),[],import.meta.url));let _Fe=class extends ui{constructor(){super(...arguments),this.overlayIndex=Ji.INNER,this.opacity=1}};function mIt(){const t=new Cr;return t.include(ep),t.fragment.uniforms.add(new et("tex",e=>e.texture)),t.fragment.uniforms.add(new z$("overlayIdx",e=>e.overlayIndex)),t.fragment.uniforms.add(new Ie("opacity",e=>e.opacity)),t.fragment.code.add(w`void main() {
vec2 overlayUV = overlayIdx == 0 ? vec2(uv.x * 0.5, uv.y) : vec2(uv.x * 0.5 + 0.5, uv.y);
fragColor = texture(tex, overlayUV) * opacity;
}`),t}const gIt=Object.freeze(Object.defineProperty({__proto__:null,OverlayCompositingPassParameters:_Fe,build:mIt},Symbol.toStringTag,{value:"Module"}));let vFe=class bFe extends Ur{initializeProgram(e){return new Lr(e.rctx,bFe.shader.get().build(),Er)}initializePipeline(){return It({blending:Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}};vFe.shader=new $r(gIt,()=>J(()=>import("./OverlayCompositing.glsl-21c095e2.js"),[],import.meta.url));let yIt=class{constructor(e,r){this._rctx=e,this._techniqueRepository=r,this._configuration=new bJ,this._atmosphereConfiguration=new fU,this._passParameters=new cFe,this._atmosphereParameters=new oFe,this._oitParameters=new mFe,this._hudParameters=new dFe,this._overlayParameters=new _Fe}destroy(){this._vao=ze(this._vao)}compositeOIT(e,r,i,s){this._oitParameters.colorTexture=r,this._oitParameters.alphaTexture=i,this._oitParameters.frontFaceTexture=s;const n=this._rctx,o=this._techniqueRepository.acquire(gFe);n.bindTechnique(o,this._oitParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(a,"geometry")),o.release()}compositeHUD(e,r){this._hudParameters.texture=r;const i=this._rctx,s=this._techniqueRepository.acquire(pFe);i.bindTechnique(s,this._hudParameters,e);const n=this._ensureVAO();i.bindVAO(n),i.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(n,"geometry")),s.release()}compositeOverlay(e,r,i,s){this._overlayParameters.texture=r,this._overlayParameters.opacity=i,this._overlayParameters.overlayIndex=s;const n=this._rctx,o=this._techniqueRepository.acquire(vFe);n.bindTechnique(o,this._overlayParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(a,"geometry")),o.release()}compositeAtmosphere(e,r,i,s,n){const o=this._rctx;this._atmosphereParameters.texture=r,this._atmosphereParameters.depthTexture=i,this._atmosphereParameters.scale=s,this._atmosphereConfiguration.haze=n;const a=this._techniqueRepository.acquire(aFe,this._atmosphereConfiguration);o.bindTechnique(a,this._atmosphereParameters,e);const l=this._ensureVAO();o.bindVAO(l),o.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(l,"geometry")),a.release()}composite(e,r,i=Ya.None,s=1){const n=this._rctx;this._configuration.alphaMode=i,this._configuration.hasOpacityFactor=s!==1,this._passParameters.texture=r,this._passParameters.opacity=s;const o=this._techniqueRepository.acquire(uFe,this._configuration);n.bindTechnique(o,this._passParameters,e);const a=this._ensureVAO();n.bindVAO(a),n.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(a,"geometry")),o.release()}_ensureVAO(){return this._vao==null&&(this._vao=Mc(this._rctx)),this._vao}};const _It=1e4,wJ=100,vIt=500,bIt=500,wIt=.1;function xIt(t,e,r){return kre(e,t)*(r[1]-r[0])+r[0]}function TIt(t,e,r){let i=0;if(!e.some(n=>(i+=n.numGeometries,i>=_It)))return IIt.compute(t,e);const s=H$();return r.forAll(n=>{n.visible&&qA(s,SIt(t,n))}),s}function SIt(t,e){if(!e.visible)return;const r=H$(),i=e.getSpatialQueryAccelerator();return i!=null?EIt(r,t,i):CIt(r,t,e.objects),r}function EIt(t,e,r){const i=e.eye,s=e.viewForward,n=e.frustum,o=l=>l.visible,a=r.objectCount;if(a<vIt)$P(yd,e.near,Math.min(t.near,e.far)),r.forEachInDepthRange(i,s,mf.DepthOrder.FRONT_TO_BACK,yd,(l,c)=>{xJ(t,e,l),yd.far=t.near,c.setRange(yd)},n,o),$P(yd,Math.max(t.far,e.near),e.far),r.forEachInDepthRange(i,s,mf.DepthOrder.BACK_TO_FRONT,yd,(l,c)=>{xJ(t,e,l),yd.near=t.far,c.setRange(yd)},n,o);else{const l=Math.max(Math.min(a,bIt),Math.ceil(a*wIt)),c=r.findClosest(s,mf.DepthOrder.FRONT_TO_BACK,n,o,l),h=r.findClosest(s,mf.DepthOrder.BACK_TO_FRONT,n,o,l);c&&h&&(Pye(t,e,c.boundingVolumeWorldSpace.bounds),Pye(t,e,h.boundingVolumeWorldSpace.bounds))}}function CIt(t,e,r){$2.clear(),r.forAll(i=>{i.visible&&i.geometries.length!==0&&$2.add(i)}),$2.empty||($2.sort(e),$P(yd,e.near,Math.min(t.near,e.far)),$2.forEachInDepthRange(yd,mf.DepthOrder.FRONT_TO_BACK,(i,s)=>{s<t.near&&xJ(t,e,i)}),$P(yd,Math.max(t.far,e.near),e.far),$2.forEachInDepthRange(yd,mf.DepthOrder.BACK_TO_FRONT,(i,s,n)=>{t.far=Math.max(t.far,n)}))}function xJ(t,e,r){if(!r.visible||!y1(e.frustum,r.boundingVolumeWorldSpace.bounds))return;const i=r.transformation,s=MIt;r.geometries.forEach(n=>{yi(s,i,n.shaderTransformation);const o=SA(s);wFe(t,e,n.boundingInfo,s,o)})}function wFe(t,e,r,i,s){if(r==null)return;Ne(Rl,r.center,i);const{eye:n,viewForward:o}=e,a=o[0]*(Rl[0]-n[0])+o[1]*(Rl[1]-n[1])+o[2]*(Rl[2]-n[2]);if(Rl[3]=r.radius*s,!(a-Rl[3]>t.near&&a+Rl[3]<t.far)&&y1(e.frustum,Rl))if(r.radius>wJ&&r.getChildren())for(const l of r.getChildren())wFe(t,e,l,i,s);else TJ.unionDepthRangeWithAABB(t,e.viewProjectionMatrix,i,r.bbMin,r.bbMax)}function Pye(t,e,r){const i=e.eye,s=e.viewForward,n=(r[0]-i[0])*s[0]+(r[1]-i[1])*s[1]+(r[2]-i[2])*s[2];t.near=Math.min(t.near,n-r[3]),t.far=Math.max(t.far,n+r[3])}let AIt=class{constructor(){this._items=new qt({allocator:e=>e||{obj:null,distance:0,near:0,far:0},deallocator:e=>(e.obj=null,e.distance=0,e.near=0,e.far=0,e)})}get length(){return this._items.length}get empty(){return this._items.length===0}clear(){this._items.clear()}add(e){this._items.pushNew().obj=e}sort(e){const r=e.eye,i=e.viewForward;this._items.forAll(s=>{const n=s.obj.boundingVolumeWorldSpace.bounds,o=(n[0]-r[0])*i[0]+(n[1]-r[1])*i[1]+(n[2]-r[2])*i[2];s.distance=o,s.near=o-n[3],s.far=o+n[3]}),this._items.sort((s,n)=>s.distance-n.distance)}forEachInDepthRange(e,r,i){if(r===mf.DepthOrder.FRONT_TO_BACK)for(let s=0;s<this._items.length;++s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}else for(let s=this._items.length-1;s>=0;--s){const n=this._items.data[s];n.far<e.near||n.near>e.far||i(n.obj,n.near,n.far)}}},OIt=class{constructor(){this._view=xe(),this._viewProj=xe(),this._frustum=fP(),this._geometries=new Array,this._near=[],this._far=[],this._nearCandidates=[],this._farCandidates=[],this._looseRange={near:0,far:0}}compute(e,r){this._reset(),an(this._view,e.viewMatrix),yi(this._viewProj,e.projectionMatrix,this._view),gU(this._frustum,e.frustum);const i=this._view,s=i[2],n=i[6],o=i[10],a=i[14];r.forAll(f=>f.forEachGeometry(m=>{if(!m.visible||!m.castShadow)return;const g=m.boundingSphere,_=s*g[0]+n*g[1]+o*g[2]+a,v=_-g[3],b=_+g[3];this._geometries.push(m),this._near.push(-b),this._far.push(-v)}));const l=new _Mt;if(this._geometries.length===0)return l;for(let f=0;f<this._geometries.length;++f)this._near[f]>l.far&&(l.far=this._near[f]),this._near[f]>2&&this._far[f]<l.near&&(l.near=this._far[f]);const c=this._looseRange;c.near=Math.max(.5*l.near,2),c.far=2*l.far;let h=0,p=0;for(let f=0;f<this._geometries.length;++f)this._near[f]<l.near&&(this._near[f]>=c.near?l.near=this._near[f]:this._nearCandidates[h++]=f),this._far[f]>l.far&&(this._far[f]<=c.far?l.far=this._far[f]:this._farCandidates[p++]=f);if(this._nearCandidates.length===0&&this._farCandidates.length===0)return l;this._nearCandidates.sort((f,m)=>this._near[f]<this._near[m]?-1:this._near[f]>this._near[m]?1:0),this._farCandidates.sort((f,m)=>this._far[f]<this._far[m]?1:this._far[f]>this._far[m]?-1:0);for(let f=0;f<this._nearCandidates.length;++f){const m=this._nearCandidates[f];if(this._near[m]<l.near){const g=this._geometries[m],_=g.boundingInfo;this._includeNearBoundingInfoRec(_,g.shaderTransformation,l)}}for(let f=0;f<this._farCandidates.length;++f){const m=this._farCandidates[f];if(this._far[m]>l.far){const g=this._geometries[m],_=g.boundingInfo;this._includeFarBoundingInfoRec(_,g.shaderTransformation,l)}}return this._reset(),l}_reset(){this._geometries.length=0,this._near.length=0,this._far.length=0,this._nearCandidates.length=0,this._farCandidates.length=0}_includeNearBoundingInfoRec(e,r,i){if(e==null)return;const s=e.center;Ne(Rl,s,r);const n=SA(r),o=Rl[0],a=Rl[1],l=Rl[2],c=e.radius*n,h=this._frustum;if(h[0][0]*o+h[0][1]*a+h[0][2]*l+h[0][3]>c||h[1][0]*o+h[1][1]*a+h[1][2]*l+h[1][3]>c||h[2][0]*o+h[2][1]*a+h[2][2]*l+h[2][3]>c||h[3][0]*o+h[3][1]*a+h[3][2]*l+h[3][3]>c)return;const p=this._view[2]*o+this._view[6]*a+this._view[10]*l+this._view[14],f=p+c;if(!(-(p-c)<2||-f>=i.near))if(-f>this._looseRange.near)i.near=-f;else{if(c>wJ){const m=e.getChildren();if(m!==void 0){for(const g of m)this._includeNearBoundingInfoRec(g,r,i);return}}TJ.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}_includeFarBoundingInfoRec(e,r,i){if(e==null)return;let s=e.radius;const n=e.center;Ne(Rl,n,r);const o=SA(r),a=Rl[0],l=Rl[1],c=Rl[2];s*=o;const h=this._frustum;if(h[0][0]*a+h[0][1]*l+h[0][2]*c+h[0][3]>s||h[1][0]*a+h[1][1]*l+h[1][2]*c+h[1][3]>s||h[2][0]*a+h[2][1]*l+h[2][2]*c+h[2][3]>s||h[3][0]*a+h[3][1]*l+h[3][2]*c+h[3][3]>s)return;const p=this._view[2]*a+this._view[6]*l+this._view[10]*c+this._view[14]-s;if(!(-p<=i.far))if(-p<this._looseRange.far)i.far=-p;else{if(s>wJ){const f=e.getChildren();if(f!==void 0){for(const m of f)this._includeFarBoundingInfoRec(m,r,i);return}}TJ.unionDepthRangeWithAABB(i,this._viewProj,r,e.bbMin,e.bbMax)}}},RIt=class{constructor(){this._modelViewProj=xe(),this._clipPosition=[Qt(),Qt(),Qt(),Qt(),Qt(),Qt(),Qt(),Qt()]}unionDepthRangeWithAABB(e,r,i,s,n){const o=this._modelViewProj;yi(o,r,i);let a=!1;for(let l=0;l<8;++l){const c=this._clipPosition[l],h=l===0||l===3||l===4||l===7?s[0]:n[0],p=l===0||l===1||l===4||l===5?s[1]:n[1],f=l<4?s[2]:n[2];c[0]=o[0]*h+o[4]*p+o[8]*f+o[12],c[1]=o[1]*h+o[5]*p+o[9]*f+o[13],c[2]=o[2]*h+o[6]*p+o[10]*f+o[14],c[3]=o[3]*h+o[7]*p+o[11]*f+o[15]}for(let l=0;l<12;++l){const c=this._clipPosition[dj[l][0]],h=this._clipPosition[dj[l][1]],p=this._clipPosition[dj[l][2]],f=this._clipTriangle(c,h,p);let m=!0;for(let g=0;g<f.length;++g)if(f[g][3]>=2){m=!1;break}if(!m){a=!0;for(let g=0;g<f.length;++g){const _=f[g][3];Number.isFinite(_)&&(e.near=Math.min(_,e.near),e.far=Math.max(_,e.far))}}}return a}_inside(e,r){return r===0?e[0]>=-e[3]:r===1?e[1]>=-e[3]:r===2?e[0]<=e[3]:r===3?e[1]<=e[3]:void it(!1)}_intersect(e,r,i){let s=0;return i===0?s=(-e[3]-e[0])/(r[0]-e[0]+r[3]-e[3]):i===1?s=(-e[3]-e[1])/(r[1]-e[1]+r[3]-e[3]):i===2?s=(e[3]-e[0])/(r[0]-e[0]-r[3]+e[3]):i===3&&(s=(e[3]-e[1])/(r[1]-e[1]-r[3]+e[3])),k6(Qt(),e,r,s)}_clipTriangle(e,r,i){let s=[e,r,i];for(let n=0;n<4;++n){const o=s;s=[];for(let a=0;a<o.length;++a){const l=o[a],c=o[(a+1)%o.length];this._inside(c,n)?(this._inside(l,n)||s.push(this._intersect(l,c,n)),s.push(c)):this._inside(l,n)&&s.push(this._intersect(l,c,n))}}return s}};const dj=[[0,1,3],[2,3,1],[1,5,2],[6,2,5],[5,4,6],[7,6,4],[4,0,7],[3,7,0],[3,2,7],[6,7,2],[4,5,0],[1,0,5]],Rl=js(),MIt=xe(),yd=H$(),$2=new AIt,IIt=new OIt,TJ=new RIt;let PIt=class{},$It=class extends ui{constructor(){super(...arguments),this.textures=new PIt}};function LIt(){const t=new Cr;return t.attributes.add(E.POSITION,"vec2"),t.vertex.uniforms.add(new cr("drawPosition",(e,r)=>DIt(e,r))),t.varyings.add("vUV","vec2"),t.vertex.code.add(w`void main(void) {
vUV = position;
gl_Position = vec4(drawPosition.xy + vec2(position - 0.5) * drawPosition.zw, 0.0, 1.0);
}`),t.fragment.uniforms.add(new et("textureInput",e=>e.textures.input)),t.fragment.uniforms.add(new et("textureMask",e=>e.textures.mask)),t.fragment.uniforms.add(new et("textureOverlay",e=>e.textures.overlay)),t.fragment.uniforms.add(new lg("maskEnabled",e=>e.magnifier.maskEnabled)),t.fragment.uniforms.add(new lg("overlayEnabled",e=>e.magnifier.overlayEnabled)),t.fragment.code.add(w`const float barrelFactor = 1.1;
vec2 barrel(vec2 uv) {
vec2 uvn = uv * 2.0 - 1.0;
if (uvn.x == 0.0 && uvn.y == 0.0) {
return vec2(0.5, 0.5);
}
float theta = atan(uvn.y, uvn.x);
float r = pow(length(uvn), barrelFactor);
return r * vec2(cos(theta), sin(theta)) * 0.5 + 0.5;
}
void main() {
float mask = maskEnabled ? texture(textureMask, vUV).a : 1.0;
vec4 inputColor = texture(textureInput, barrel(vUV)) * mask;
vec4 overlayColor = overlayEnabled ? texture(textureOverlay, vUV) : vec4(0);
fragColor = overlayColor + (1.0 - overlayColor.a) * inputColor;
}`),t}function DIt(t,e){const r=e.camera.pixelRatio,i=t.magnifier.offset.x*r,s=t.magnifier.offset.y*r;qm(t.magnifier.position,$ye);const n=e.camera.screenToRender($ye,NIt),o=Math.ceil(r*t.magnifier.size),a=e.camera.fullWidth,l=e.camera.fullHeight;return zi(FIt,(n[0]+i)/a*2-1,(n[1]-s)/l*2-1,o/a*2,o/l*2)}const $ye=cs(),NIt=Kwe(),FIt=Qt();async function kIt(t){const e=J(()=>import("./mask-svg-023bbc42.js"),[],import.meta.url),r=J(()=>import("./overlay-svg-d62383f3.js"),[],import.meta.url),i=D0((await e).default,{signal:t}),s=D0((await r).default,{signal:t}),n={mask:await i,overlay:await s};return Dt(t),n}let DE=class extends me{constructor(){super(...arguments),this._handles=new li,this._magnifier=null,this._imageSources=null,this._imageLoadTask=null,this._resources=null,this._passParameters=new $It,this.events=new Xr,this.attributeLocations=new Map([[E.POSITION,0]]),this._tmpScreenPoint=cs(),this._tmpRenderPoint=Kwe()}get updating(){return this._imageSources==null&&this._imageLoadTask!=null&&!this._imageLoadTask.task.finished}get magnifier(){return this._magnifier}set magnifier(e){if(e===this._magnifier)return;this._handles.removeAll(),this._magnifier=e;const r=()=>{this._updateResourceLoading(),this.events.emit("request-render")};this._magnifier!=null&&this._handles.add(Q(()=>Dl(this._magnifier,i=>i.version),r)),r()}get enabled(){return this._validMagnifier!=null}get _validMagnifier(){return this._magnifier!=null&&this._magnifier.visible&&this._magnifier.position!=null&&this._magnifier.size>0?this._magnifier:null}get _factor(){return this._magnifier!=null&&this._magnifier.factor||1}destroy(){this._magnifier=null,this._handles.destroy(),this._imageLoadTask!=null&&(this._imageLoadTask.task.abort(),this._imageLoadTask=null),this._disposeResources()}render(e,r){const i=this._validMagnifier;if(i==null)return;const s=r.camera.pixelRatio,n=Math.ceil(s*i.size);if(this._updateResources(e,n),this._resources==null)return;const o=this._passParameters.textures,a=Math.ceil(1/this._factor*n);o.input.resize(a,a),qm(i.position,this._tmpScreenPoint);const l=r.camera.screenToRender(this._tmpScreenPoint,this._tmpRenderPoint),c=r.camera.fullWidth,h=r.camera.fullHeight,p=.5*a,f=.5*a;l[0]=ye(l[0],p,c-p-1),l[1]=ye(l[1],f,h-f-1);const m=Math.floor(l[0]-p),g=Math.floor(l[1]-f),_=this._resources.program;_.bindTexture("textureInput",o.input),e.gl.copyTexImage2D(o.input.descriptor.target,0,o.input.descriptor.pixelFormat,m,g,a,a,0),this._passParameters.magnifier=i,e.useProgram(_),_.bindPass(this._passParameters,r),e.bindVAO(this._resources.vao),e.setPipelineState(this._resources.pipelineState),e.drawArrays(Ot.TRIANGLE_STRIP,0,4)}_updateResourceLoading(){const e=this._validMagnifier;if(e==null)return;const r=e.maskUrl,i=e.overlayUrl;this._imageLoadTask==null||this._imageLoadTask.maskUrl===r&&this._imageLoadTask.overlayUrl===i||(this._imageLoadTask.task.abort(),this._imageLoadTask=null,this._imageSources=null),this._imageSources==null&&this._imageLoadTask==null&&(this._imageLoadTask={maskUrl:r,overlayUrl:i,task:hb(async s=>{const n=r==null||i==null?kIt(s):null,o=r!=null?D0(r,{signal:s}):n.then(l=>l.mask),a=i!=null?D0(i,{signal:s}):n.then(l=>l.overlay);this._imageSources={mask:await o,overlay:await a},this._disposeResources(),this.events.emit("request-render")})},this._imageLoadTask.task.promise.then(()=>this.notifyChange("updating"),()=>this.notifyChange("updating")))}_updateResources(e,r){if(!this.enabled)return void this._disposeResources();if(this._resources!=null){if(this._passParameters.textures.size!==r){const s=this._createTextureResources(e,r);if(s==null)return void this._disposeResources();this._disposeTextureResources(this._passParameters.textures),this._passParameters.textures=s}return}const i=this._createTextureResources(e,r);i!=null&&(this._resources={program:this._createProgram(e),vao:Mc(e,Nte,this.attributeLocations,0,1),pipelineState:It({blending:Ru(Te.ONE,Te.ONE_MINUS_SRC_ALPHA),depthTest:null,depthWrite:null,colorWrite:Wt})},this._passParameters.textures=i)}_disposeResources(){this._resources!=null&&(this._disposeTextureResources(this._passParameters.textures),this._resources.program.dispose(),this._resources.vao.dispose(),this._resources=null)}_disposeTextureResources(e){e.mask.dispose(),e.overlay.dispose(),e.input.dispose()}_createTextureResources(e,r){if(this._imageSources==null)return null;this._imageSources.overlay.width=r,this._imageSources.overlay.height=r,this._imageSources.mask.width=r,this._imageSources.mask.height=r;const i=new Sr;i.internalFormat=At.RGBA,i.wrapMode=Ut.CLAMP_TO_EDGE,i.flipped=!0,i.preMultiplyAlpha=!gve(this._imageSources.overlay.src)||!e.driverTest.svgPremultipliesAlpha.result;const s=new Rt(e,i,this._imageSources.overlay);i.pixelFormat=i.internalFormat=At.ALPHA,i.preMultiplyAlpha=!1;const n=new Rt(e,i,this._imageSources.mask);return i.pixelFormat=i.internalFormat=At.RGBA,i.flipped=!1,{input:new Rt(e,i),mask:n,overlay:s,size:r}}_createProgram(e){return new Lr(e,LIt(),this.attributeLocations)}};u([d()],DE.prototype,"_imageSources",void 0),u([d()],DE.prototype,"_imageLoadTask",void 0),u([d({readOnly:!0})],DE.prototype,"updating",null),DE=u([R("esri/views/3d/webgl-engine/lib/MagnifierHelper")],DE);let UIt=class{constructor(){this.declaredClass="esri.views.3d.webgl-engine.lib.ObjectAndLayerIdRenderHelper",this.colorZero=new rl(new ArrayBuffer(4)),this._uidToRenderColor=new Map,this._colorToUID=new Map,this._layerUidToGraphicsUidToObjectId=new Map,this._layerUidToId=new Map,this._layerUidToPopupEnabled=new Map}setUidToObjectAndLayerId(e,r,i,s,n,o=null,a=null,l=null){if(!(e&&r&&i&&s)||(this._layerUidToId.set(s,i),this._layerUidToPopupEnabled.set(s,n),!n))return;let c=this._layerUidToGraphicsUidToObjectId.get(s);c||(c=new Map,this._layerUidToGraphicsUidToObjectId.set(s,c)),c.set(r,{objectId:e,attributeNodeId:o,attributeIndex:a,subLayerId:l})}getObjectAndLayerIdColor(e){const r=this.getObjectAndLayerIdColorArray(e);return Vt(r.get(0,1),r.get(0,2),r.get(0,3),255)}getObjectAndLayerIdColorArray(e){if(!e.layerUid||!e.graphicUid)return this.colorZero;const r=this._layerUidToPopupEnabled.get(e.layerUid);if(r===void 0)return K.getLogger(this).warn("popupEnabled is undefined for layerUid "+e.layerUid),this.colorZero;if(r===!1)return this.colorZero;let i=this._uidToRenderColor.get(e.layerUid);i||(i=new Map,this._uidToRenderColor.set(e.layerUid,i));let s=i.get(e.graphicUid);if(!s){for(;!s;){const o=Math.floor(16777214*Math.random())+1;this._colorToUID.has(o)||(s=o)}if(s>16777215)throw new Error("Object ID Overflow");i.set(e.graphicUid,s),this._colorToUID.set(s,e)}const n=new ArrayBuffer(4);return new DataView(n).setUint32(0,s,!1),new rl(n)}getColorToObjectAndLayerIdMapping(){const e=new Map;for(const[r,i]of this._colorToUID.entries()){const s=this._layerUidToGraphicsUidToObjectId.get(i.layerUid);let n=null;s?(n=s.get(i.graphicUid),n||K.getLogger(this).warn("getColorMapping: no entry found for graphicsId "+i.graphicUid)):K.getLogger(this).warn("getColorMapping: no entry found for layerUid "+i.layerUid);const o=this._layerUidToId.get(i.layerUid);o||K.getLogger(this).warn("no layerId found for uid "+i.layerUid),n&&o&&e.set(r,n.attributeNodeId?{type:"object-and-layer-and-i3s-id",oid:n.objectId,lid:o,attrId:n.attributeNodeId,attrIdx:n.attributeIndex,subLayerId:n.subLayerId}:{type:"object-and-layer-id",oid:n.objectId,lid:o})}return e}};var LP;(function(t){t[t.FrontToBack=0]="FrontToBack",t[t.BackToFront=1]="BackToFront"})(LP||(LP={}));let k_=class{constructor(e,r,i=LP.FrontToBack){this._rctx=e,this._techniqueRepository=r,this._sorting=i,this._draws=new qt({initialSize:32,allocator:s=>s||{material:null,geometry:null,geometryRanges:null,bindDrawParams:null,depthSquaredHint:0,indexType:0}}),this._previouslyBoundDraw=new Map}submitDraw(e,r,i,s){const n=this._draws.pushNew();n.geometry=r,n.geometryRanges=i,n.material=e,n.depthSquaredHint=s,n.indexType=(r.indexed?r.vao.indexBuffer.indexType:null)??0}prepare(e,r){return this._draws.map(i=>i.material.prepareTechnique(this._techniqueRepository,e,r,i.geometry.parameters))}dispatch(e,r,i){const s=this._rctx;this._previouslyBoundDraw.clear();let n=null;const o=this._draws.length;for(let a=0;a<o;a++){const l=i[a];l===n&&l.configuration.transparencyPassType===ut.NONE||(s.bindTechnique(l,e,r),n=l);const c=this._draws.data[a],h=c.geometry;s.bindVAO(h.vao),this._previouslyBoundDraw.get(l)!==c.material&&(l.program.bindDraw(c.material,r,e),this._previouslyBoundDraw.set(l,c.material));const p=c.geometryRanges,f=p.length;if(c.indexType!==0){const m=S5.get(c.indexType);for(let g=0;g<f;g+=2){const _=p[g],v=p[g+1];s.drawElements(h.primitiveType,v,c.indexType,_*m)}}else for(let m=0;m<f;m+=2){const g=p[m],_=p[m+1];s.drawArrays(h.primitiveType,g,_)}}}prepareSubmit(){this._draws.clear()}finishSubmit(){const e=this._sorting===LP.FrontToBack?1:-1;this._draws.sort((r,i)=>{const s=e*(r.depthSquaredHint-i.depthSquaredHint);return s!==0?s:r.geometry.vao.byteSize-i.geometry.vao.byteSize})}get count(){return this._draws.length}};const S5=new Map;S5.set(rt.UNSIGNED_BYTE,1),S5.set(rt.UNSIGNED_SHORT,2),S5.set(rt.UNSIGNED_INT,4);let VIt=class{constructor(e,r){this.rctx=e,this.shaderTechniqueRepository=r,this.canRender=!0,this._materialPassParameters=new IRt,this._shadowPassParameters=new PRt,this._highlightPassParameters=new $Rt,this._systems=new Set,this._passes={materialOpaque:new k_(e,r),materialTransparent:new k_(e,r,LP.BackToFront),materialIntegratedMesh:new k_(e,r),shadowMap:new k_(e,r),highlight:new k_(e,r),highlightIntegratedMesh:new k_(e,r),highlightShadowMap:new k_(e,r),defaultShadowMap:new k_(e,r)}}destroy(){this._context=null,this._systems.clear()}register(e){this._systems.add(e)}prepareRender(e){if(this._systems.size!==0){for(const r of Object.values(this._passes))r.prepareSubmit();this._systems.forEach(r=>r.submit(this._passes,e.bindParameters));for(const r of Object.values(this._passes))r.finishSubmit();this.shaderTechniqueRepository.frameUpdate()}}prepareTechniques(e){return this._systems.size===0?null:(this._configure(e),this._materialPassParameters.output=e.output,this._invoke(e,(r,i)=>r.prepare(i,e.bindParameters)))}render(e,r){this._invoke(e,(i,s)=>i.dispatch(s,e.bindParameters,r))}_invoke(e,r){switch(e.bindParameters.slot){case fe.OPAQUE_MATERIAL:switch(e.output){case k.Color:case k.Depth:case k.Normal:case k.ObjectAndLayerIdColor:return r(this._passes.materialOpaque,this._materialPassParameters);case k.Highlight:return r(this._passes.highlight,this._highlightPassParameters);case k.Shadow:return r(this._passes.shadowMap,this._shadowPassParameters);case k.ShadowHighlight:return r(this._passes.highlightShadowMap,this._shadowPassParameters);case k.ShadowExcludeHighlight:return r(this._passes.defaultShadowMap,this._shadowPassParameters)}break;case fe.TRANSPARENT_MATERIAL:switch(e.output){case k.Color:case k.Alpha:case k.Depth:case k.Normal:case k.ObjectAndLayerIdColor:return r(this._passes.materialTransparent,this._materialPassParameters)}break;case fe.INTEGRATED_MESH:switch(e.output){case k.Color:case k.Depth:case k.Normal:case k.ObjectAndLayerIdColor:return r(this._passes.materialIntegratedMesh,this._materialPassParameters);case k.Highlight:return r(this._passes.highlightIntegratedMesh,this._highlightPassParameters)}}return null}notifyDirty(){this._context.requestRender()}slots(){return[fe.OPAQUE_MATERIAL,fe.TRANSPARENT_MATERIAL,fe.INTEGRATED_MESH]}initializeRenderContext(e){this._context=e}uninitializeRenderContext(){}queryDepthRange(e){const r={near:1/0,far:-1/0};return this._systems.forEach(i=>{const s=i.queryShadowCasterDepthRange(e);s!=null&&qA(r,s,r)}),r}_configure(e){const r=e.output===k.Shadow||e.output===k.ShadowHighlight||e.output===k.ShadowExcludeHighlight?this._shadowPassParameters:e.output===k.Highlight?this._highlightPassParameters:this._materialPassParameters;this._updateParameters(e,r)}_updateParameters(e,r){const i=e.bindParameters.camera,s=i.viewInverseTransposeMatrix;ie(pj,s[3],s[7],s[11]),fj.set(pj),oe(r.transformWorldFromViewTH,fj.high),oe(r.transformWorldFromViewTL,fj.low),oe(r.slicePlaneLocalOrigin,pj),qd(r.transformViewFromCameraRelativeRS,i.viewMatrix),an(r.transformProjFromView,i.projectionMatrix),r.identifier===mu.Material&&(this._materialPassParameters.transparent=e.bindParameters.slot===fe.TRANSPARENT_MATERIAL,this._materialPassParameters.integratedMesh=e.bindParameters.slot===fe.INTEGRATED_MESH,Wd(Lye,r.transformViewFromCameraRelativeRS),gS(r.transformNormalViewFromGlobal,Lye))}get needsHighlight(){return this._passes.highlight.count>0||this._passes.highlightIntegratedMesh.count>0}get needsTransparentPass(){return this._passes.materialTransparent.count>0}};const pj=C(),Lye=ts(),fj=new i9;let zIt=class{constructor(){this._step=Fye,this._dilation=1,this._firstIdleTime=0}frame(e,r){if(r?this._firstIdleTime===0&&(this._firstIdleTime=performance.now()):this._firstIdleTime=0,le("disable-feature:high-quality-idle"))this._dilation=1;else{const s=r?performance.now()-this._firstIdleTime:0;if(s>=Dye+GIt)return this._step=1/0,void(this._dilation=1);this._dilation=s>=Dye?jIt:1}const i=ye(e/BIt,Fye,qIt);this._step===1/0?this._step=i:this._step=this._step*Nye+i*(1-Nye)}get value(){return this._step}get timeDilation(){return this._dilation}clear(){this._step=this._firstIdleTime=0}};const BIt=.5,Dye=12e4,GIt=1e4,jIt=10,Nye=.9,HIt=30,Fye=1e3/1,qIt=1e3/HIt,WIt=8.6,ZIt=.4;function XIt(){const t=new Cr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(E.POSITION,"vec2"),t.varyings.add("uv","vec2"),t.attributes.add(E.UV0,"vec2"),e.uniforms.add(new et("coverageTex",n=>n.coverageTexture)),i.add(w`void main() {
vec4 cov = texture(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
return;
}
gl_Position = vec4(position, 0.0, 1.0);
uv = position.xy * 0.5 + vec2(0.5);
}`),r.uniforms.add(new et("tex",n=>n.blurColorTexture),new et("origin",n=>n.highlightColorTexture),new cr("uColor",n=>n.color),new cr("haloColor",n=>n.haloColor),new cr("opacities",n=>zi(YIt,n.haloOpacity,n.haloOpacityOccluded,n.fillOpacity,n.fillOpacityOccluded))),r.constants.add("outlineSize","float",WIt),r.constants.add("blurSize","float",ZIt),s.add(w`void main() {
vec4 blurredHighlightValue = texture(tex, uv);
float highlightIntensity = blurredHighlightValue.a;
if (highlightIntensity == 0.0) {
discard;
}
vec4 origin_color = texture(origin, uv);
float outlineIntensity;
float fillIntensity;
if (blurredHighlightValue.g > blurredHighlightValue.b) {
outlineIntensity = haloColor.w * opacities[1];
fillIntensity = uColor.w * opacities[3];
}
else {
outlineIntensity = haloColor.w * opacities[0];
fillIntensity = uColor.w * opacities[2];
}
float inner = 1.0 - outlineSize / 9.0;
float outer = 1.0 - (outlineSize + blurSize) / 9.0;
float outlineFactor = smoothstep(outer, inner, highlightIntensity);
float fillFactor = any(notEqual(origin_color, vec4(0.0, 0.0, 0.0, 0.0))) ? 1.0 : 0.0;
float intensity = outlineIntensity * outlineFactor * (1.0 - fillFactor) + fillIntensity * fillFactor;
fragColor = vec4(mix(haloColor.rgb, uColor.rgb, fillFactor), intensity);
}`),t}const YIt=Qt(),JIt=Object.freeze(Object.defineProperty({__proto__:null,build:XIt},Symbol.toStringTag,{value:"Module"}));let xFe=class TFe extends Ur{initializeProgram(e){return new Lr(e.rctx,TFe.shader.get().build(),Er)}initializePipeline(){return It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt})}};xFe.shader=new $r(JIt,()=>J(()=>import("./HighlightApply.glsl-6d9b4d79.js"),[],import.meta.url));let SFe=class extends ui{constructor(){super(...arguments),this.blurSize=Pe()}};function QIt(){const t=new Cr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(E.POSITION,"vec2"),t.attributes.add(E.UV0,"vec2"),t.varyings.add("blurCoordinate","vec3"),e.uniforms.add(new et("coverageTex",n=>n.coverageTexture)),r.uniforms.add(new die("blurSize",n=>n.blurSize)),i.add(w`void main() {
gl_Position = vec4(position, 0.0, 1.0);
vec4 cov = texture(coverageTex, uv0);
if (cov.r == 0.0) {
gl_Position = vec4(0.0);
}
blurCoordinate = vec3(gl_Position.xy * 0.5 + vec2(0.5), max(cov.g, cov.b));
}`),r.uniforms.add(new Nd("tex",n=>n.blurInputTexture)),s.add(w`void main() {
vec2 uv = blurCoordinate.xy;
vec4 center = texture(tex, uv);
if (blurCoordinate.z == 1.0) {
fragColor = center;
} else {
vec4 sum = vec4(0.0);
sum += center * 0.204164;
sum += texture(tex, uv + blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv - blurSize * 1.407333) * 0.304005;
sum += texture(tex, uv + blurSize * 3.294215) * 0.093913;
sum += texture(tex, uv - blurSize * 3.294215) * 0.093913;
fragColor = sum;
}
}`),t}const KIt=Object.freeze(Object.defineProperty({__proto__:null,HighlightBlurDrawParameters:SFe,build:QIt},Symbol.toStringTag,{value:"Module"}));let EFe=class CFe extends Ur{initializeProgram(e){return new Lr(e.rctx,CFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};EFe.shader=new $r(KIt,()=>J(()=>import("./HighlightBlur.glsl-9ab60d7f.js"),[],import.meta.url));let AFe=class extends ui{constructor(){super(...arguments),this.invFramebufferDim=Pe()}};function ePt(){const t=new Cr,{vertex:e,fragment:r}=t,i=e.code,s=r.code;return t.attributes.add(E.POSITION,"vec2"),i.add(w`void main() {
gl_Position = vec4(vec2(1.0) - position * 2.0, 0.0, 1.0);
}`),r.uniforms.add(new Nd("tex",n=>n.inputTexture)),r.uniforms.add(new die("invFramebufferDim",n=>n.invFramebufferDim)),s.add(w`void main() {
vec2 coord = gl_FragCoord.xy * invFramebufferDim;
vec4 value = texture(tex, coord);
float mx = floor(max(value.g, value.b));
fragColor = vec4(ceil(value.r), mx, mx, 1.0);
}`),t}const tPt=Object.freeze(Object.defineProperty({__proto__:null,HighlightDownsampleDrawParameters:AFe,build:ePt},Symbol.toStringTag,{value:"Module"}));let OFe=class RFe extends Ur{initializeProgram(e){return new Lr(e.rctx,RFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};OFe.shader=new $r(tPt,()=>J(()=>import("./HighlightDownsample.glsl-16890f52.js"),[],import.meta.url));let kye=class extends ui{constructor(){super(...arguments),this.color=Mg(1,0,1,1),this.haloColor=Mg(1,0,1,1),this.haloOpacity=1,this.haloOpacityOccluded=.25,this.fillOpacity=.2,this.fillOpacityOccluded=.05,this.shadowColor=Vt(1,0,1,1),this.shadowOpacity=.15,this.occludedShadowOpacity=.075}};const rPt=32;let iPt=class{constructor(e,r){this._techniqueRep=e,this._rctx=r,this._viewportToRestore=Qt(),this._passParameters=new kye,this._downsampleDrawParameters=new AFe,this._blurDrawParameters=new SFe,this._grid={coverageMipmap:null,vao:null,verticalCellCount:0,horizontalCellCount:0,cellPixelSize:0,mipmapLevels:0,viewportWidth:0,viewportHeight:0}}_assertResources(){if(this._quadVAO)return;this._quadVAO=Mc(this._rctx);const e=new Sr;e.wrapMode=Ut.CLAMP_TO_EDGE,this._blur0Fbo=new Vn(this._rctx,e),this._blur1Fbo=new Vn(this._rctx,e),this._blurTechnique=this._techniqueRep.acquire(EFe),this._downsampleTechnique=this._techniqueRep.acquire(OFe),this._applyTechnique=this._techniqueRep.acquire(xFe)}dispose(){if(this._blurTechnique=as(this._blurTechnique),this._downsampleTechnique=as(this._downsampleTechnique),this._applyTechnique=as(this._applyTechnique),this._grid.coverageMipmap)for(let e=1;e<this._grid.coverageMipmap.length;e++)this._grid.coverageMipmap[e].dispose();this._grid.vao&&this._grid.vao.dispose(),this._quadVAO&&(this._quadVAO.dispose(),this._quadVAO=null),this._blur0Fbo=ze(this._blur0Fbo),this._blur1Fbo=ze(this._blur1Fbo)}setDefaultOptions(e){this._passParameters={...new kye,...e}}render(e,r,i){this._passParameters.highlightColorTexture=r.colorTexture,this._assertResources();const s=e.camera;Id(this._viewportToRestore,s.fullViewport);const n=s.fullWidth,o=s.fullHeight,a=s.pixelRatio,l=Math.ceil(n/a),c=Math.ceil(o/a);this._blur0Fbo.resize(l,c),this._blur1Fbo.resize(l,c);const h=this._rctx;h.bindVAO(this._quadVAO);let p=null;this._gridUpdateResources(r,rPt),this._gridComputeMipmap(e),this._passParameters.coverageTexture=this._grid.coverageMipmap[this._grid.mipmapLevels].colorTexture,p=this._grid.vao;const f=h.bindTechnique(this._blurTechnique,this._passParameters,e);h.bindVAO(p),h.bindFramebuffer(this._blur0Fbo),h.setViewport(0,0,l,c),h.setClearColor(0,0,0,0),h.clear(Bi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=r.colorTexture,hr(this._blurDrawParameters.blurSize,1/l,0),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Sa(p,"geometry")),h.bindFramebuffer(this._blur1Fbo),h.clear(Bi.COLOR_BUFFER_BIT),this._blurDrawParameters.blurInputTexture=this._blur0Fbo.colorTexture,hr(this._blurDrawParameters.blurSize,0,1/c),f.bindDraw(this._blurDrawParameters,e,this._passParameters),h.drawArrays(this._blurTechnique.primitiveType,0,Sa(p,"geometry")),h.bindFramebuffer(i),h.setViewport(this._viewportToRestore[0],this._viewportToRestore[1],this._viewportToRestore[2],this._viewportToRestore[3]),this._passParameters.blurColorTexture=this._blur1Fbo.colorTexture,h.bindTechnique(this._applyTechnique,this._passParameters,e),h.drawArrays(this._applyTechnique.primitiveType,0,Sa(p,"geometry")),h.bindVAO(null)}_gridUpdateResources(e,r){const i=this._rctx,s=this._grid;let n=!1;if(s.coverageMipmap===null&&(s.coverageMipmap=[e],n=!0),s.viewportWidth===e.width&&s.viewportHeight===e.height||(n=!0,s.viewportWidth=e.width,s.viewportHeight=e.height),s.coverageMipmap[0]=e,s.cellPixelSize!==r&&(s.cellPixelSize=r,n=!0),n){for(let l=1;l<s.coverageMipmap.length;l++)s.coverageMipmap[l].dispose();s.mipmapLevels=Math.ceil(Math.log(s.cellPixelSize)*Math.LOG2E),s.coverageMipmap.length=s.mipmapLevels+1;for(let l=0;l<s.mipmapLevels;l++){const c=s.coverageMipmap[l],h=new Sr(Math.ceil(c.width/2),Math.ceil(c.height/2));h.pixelFormat=At.RGB,h.dataType=fn.UNSIGNED_SHORT_5_6_5,h.wrapMode=Ut.CLAMP_TO_EDGE,s.coverageMipmap[l+1]=new Vn(i,h)}}const o=Math.ceil(e.height/s.cellPixelSize),a=Math.ceil(e.width/s.cellPixelSize);if(!s.vao||s.verticalCellCount!==o||s.horizontalCellCount!==a){s.verticalCellCount=o,s.horizontalCellCount=a;const l=o+1,c=a+1,h=1/o,p=1/a,f=6,m=4,g=new Float32Array(f*m*l*c);let _=0;for(let v=0;v<l;v++)for(let b=0;b<c;b++)g[_]=(b-.5)*p*2-1,g[_+1]=(v-.5)*h*2-1,g[_+2]=b*p,g[_+3]=v*h,g[_+4]=(b+.5)*p*2-1,g[_+5]=(v-.5)*h*2-1,g[_+6]=b*p,g[_+7]=v*h,g[_+8]=(b-.5)*p*2-1,g[_+9]=(v+.5)*h*2-1,g[_+10]=b*p,g[_+11]=v*h,g[_+12]=(b-.5)*p*2-1,g[_+13]=(v+.5)*h*2-1,g[_+14]=b*p,g[_+15]=v*h,g[_+16]=(b+.5)*p*2-1,g[_+17]=(v-.5)*h*2-1,g[_+18]=b*p,g[_+19]=v*h,g[_+20]=(b+.5)*p*2-1,g[_+21]=(v+.5)*h*2-1,g[_+22]=b*p,g[_+23]=v*h,_+=f*m;s.vao&&s.vao.dispose(),s.vao=new zf(i,Er,{geometry:T$},{geometry:Gr.createVertex(i,Mr.STATIC_DRAW,g)})}}_gridComputeMipmap(e){const r=this._rctx,i=this._grid,s=r.bindTechnique(this._downsampleTechnique,this._passParameters,e);r.bindVAO(this._quadVAO);for(let n=0;n<i.mipmapLevels;n++){r.bindFramebuffer(i.coverageMipmap[n+1]);const o=i.coverageMipmap[n+1].width,a=i.coverageMipmap[n+1].height;this._downsampleDrawParameters.inputTexture=i.coverageMipmap[n].colorTexture,hr(this._downsampleDrawParameters.invFramebufferDim,1/o,1/a),s.bindDraw(this._downsampleDrawParameters,e,this._passParameters),r.setViewport(0,0,o,a),r.drawArrays(Ot.TRIANGLE_STRIP,0,Sa(this._quadVAO,"geometry"))}}get gpuMemoryUsage(){let e=(this._blur0Fbo!=null?this._blur0Fbo.gpuMemoryUsage:0)+(this._blur1Fbo!=null?this._blur1Fbo.gpuMemoryUsage:0);if(this._grid.coverageMipmap)for(const r of this._grid.coverageMipmap)e+=r.gpuMemoryUsage;return e}get test(){return{coverage:this._grid.coverageMipmap,blur:[this._blur0Fbo,this._blur1Fbo]}}};const sPt={dataType:fn.UNSIGNED_BYTE,internalFormat:At.RGBA},nPt={};let oPt=class{constructor(e){this._rctx=e,this._activeTargets=new Set,this._colorTextures=new Map,this._depthTextures=new Map,this._fbos=new Map}dispose(){this._depthTextures.forEach(e=>e.dispose()),this._depthTextures.clear(),this._colorTextures.forEach(e=>e.dispose()),this._colorTextures.clear(),this._fbos.forEach(e=>e.dispose()),this._fbos.clear(),this._activeTargets.clear()}disposeTargetResource(e){const r=e.id;this._activeTargets.has(r)&&(this._activeTargets.delete(r),this._disposeWithFramebuffers(this._depthTextures,r),this._disposeWithFramebuffers(this._colorTextures,r))}_disposeWithFramebuffers(e,r){const i=e.get(r);i&&(this._fbos.forEach((s,n)=>{s.colorTexture!==i&&s.depthStencilAttachment!==i||(s.detachColorTexture(),s.detachDepthStencilTexture(),s.dispose(),this._fbos.delete(n))}),i.dispose(),e.delete(r))}_getDepthTexture(e,r,i){let s=this._depthTextures.get(e.id);if(!s||s.descriptor.width===r&&s.descriptor.height===i||(s.dispose(),s=null),!s){const n=new Sr(r,i);n.pixelFormat=At.DEPTH_STENCIL,n.dataType=fn.UNSIGNED_INT_24_8,n.samplingMode=Mt.NEAREST,n.wrapMode=Ut.CLAMP_TO_EDGE,s=new Rt(this._rctx,n),this._depthTextures.set(e.id,s),this._activeTargets.add(e.id)}return s}getAllocatedDepthTexture(e){return this._depthTextures.get(e.id)}getColorTexture(e,r,i){let s=this._colorTextures.get(e.id);if(s&&(s.descriptor.width===r&&s.descriptor.height===i||(s.dispose(),s=tO())),!s){const n=new Sr(r,i);n.internalFormat=e.internalFormat,n.dataType=e.dataType,n.samplingMode=e.samplingMode!=null?e.samplingMode:Mt.LINEAR,n.wrapMode=Ut.CLAMP_TO_EDGE,s=new Rt(this._rctx,n),this._colorTextures.set(e.id,s),this._activeTargets.add(e.id)}return s}getAllocatedColorTexture(e){return this._colorTextures.get(e.id)}registerDepthTarget(e={}){return{id:vc(),...nPt,...e}}registerColorTarget(e={}){return{id:vc(),...sPt,...e}}getFramebuffer(e,r,i,s){const n=this._getKey(i,s);let o=this._fbos.get(n);const a=this.getColorTexture(i,e,r),l=s?this._getDepthTexture(s,e,r):void 0;return o?((o.width!==e||o.height!==r||o.colorTexture!==a||o.depthStencilAttachment!==l)&&(o.detachColorTexture(),o.detachDepthStencilTexture(),o.resize(e,r),o.attachColorTexture(a),o.attachDepthStencil(l)),o):(o=new Vn(this._rctx,a,l),this._fbos.set(n,o),o)}_getKey(e,r){return`${e.id}_${r?r.id:"X"}_${e.name}${r?"_"+r.name:""}`}get gpuMemoryUsage(){let e=0;const r=new Set,i=s=>{r.has(s)||(r.add(s),e+=s.gpuMemoryUsage)};return this._colorTextures.forEach(i),this._depthTextures.forEach(i),e}},aPt=class{constructor(e,r){this._rctx=e,this._compositingHelper=r,this._mainColorTarget=0,this.width=4,this.height=4,this._background={type:"color",color:[0,0,0,1]},this._renderTargetHelper=new oPt(e);const i=this._renderTargetHelper;this._mainColorTargets=[i.registerColorTarget({name:"mainColorTarget0"}),i.registerColorTarget({name:"mainColorTarget1"})],this.frontFaceTarget=i.registerColorTarget({name:"frontFaceTarget"}),this.colorFloatTarget=i.registerColorTarget({name:"colorFloatTarget",dataType:fn.HALF_FLOAT,internalFormat:Je.RGBA16F,samplingMode:Mt.NEAREST}),this.alphaFloatTarget=i.registerColorTarget({name:"alphaFloatTarget",dataType:fn.HALF_FLOAT,internalFormat:Je.R16F,samplingMode:Mt.NEAREST}),this.mainDepth=i.registerDepthTarget({name:"mainDepth"}),this.linearDepth=i.registerColorTarget({name:"linearDepth",samplingMode:Mt.NEAREST}),this.terrainLinearDepth=i.registerColorTarget({name:"terrainLinearDepth"}),this.geometryLinearDepth=i.registerColorTarget({name:"geometryLinearDepth"}),this.normal=i.registerColorTarget({name:"normal"}),this.highlight=i.registerColorTarget({name:"highlight",internalFormat:Je.RGBA4,dataType:fn.UNSIGNED_SHORT_4_4_4_4}),this.hudVisibility=i.registerColorTarget({name:"hudVisibility",internalFormat:Je.RGBA4,dataType:fn.UNSIGNED_SHORT_4_4_4_4}),this.tmpColor=i.registerColorTarget({name:"tmpColor"}),this.tmpDepth=i.registerDepthTarget({name:"tmpDepth"}),this.hudColor=i.registerColorTarget({name:"hudColor"})}dispose(){this._renderTargetHelper.dispose()}set background(e){this._background=e}get background(){return this._background}get currentColorTarget(){return this._mainColorTargets[this._mainColorTarget]}get previousColorTarget(){return this._mainColorTargets[1-this._mainColorTarget]}get framebuffer(){return this.getFramebuffer(this.currentColorTarget,this.mainDepth)}getFramebuffer(e,r){return this._renderTargetHelper.getFramebuffer(this.width,this.height,e,r)}get colorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.currentColorTarget)}get depthTexture(){return this._renderTargetHelper.getAllocatedDepthTexture(this.mainDepth)}get linearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.linearDepth)}get terrainLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.terrainLinearDepth)}get geometryLinearDepthTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.geometryLinearDepth)}get lastFrameColorTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.previousColorTarget)}get normalTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.normal)}get highlightTexture(){return this._renderTargetHelper.getAllocatedColorTexture(this.highlight)}get hudVisibilityTexture(){return this._getColorTexture(this.hudVisibility)}get tmpColorTexture(){return this._getColorTexture(this.tmpColor)}get hudColorTexture(){return this._getColorTexture(this.hudColor)}get mainColorTexture(){return this._getColorTexture(this.currentColorTarget)}setupRenderTarget(e){e?this._mainColorTarget=this._mainColorTarget?0:1:(this._mainColorTarget=0,this.disposeTarget(this._mainColorTargets[1]))}initializeFrame(e){const r=this._rctx;this.width=e.fullWidth,this.height=e.fullHeight,Zx(this,r.parameters.maxTextureSize),this.bindTarget(this.currentColorTarget,this.mainDepth),r.setClearStencil(0);const i=this._background.color;r.setClearColor(i[0]*i[3],i[1]*i[3],i[2]*i[3],i[3]),r.clearSafe(Bi.COLOR_BUFFER_BIT|Bi.DEPTH_BUFFER_BIT|Bi.STENCIL_BUFFER_BIT)}composite(e){this.colorTexture!=null&&this._compositingHelper.composite(e,this.colorTexture,Ya.None)}renderTmpAndCompositeToMain(e,r,i,s=!1){this.renderToTargets(e,this.tmpColor,s?this.tmpDepth:this.mainDepth,lPt),this._compositingHelper.composite(r,this._getColorTexture(this.tmpColor),i)}compositeAtmosphereToMain(e,r,i,s){this.bindTarget(this.currentColorTarget),this._compositingHelper.compositeAtmosphere(e,this._renderTargetHelper.getColorTexture(this.tmpColor,this.width,this.height),i,s,r),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderHUDVisibility(e,r=!1){this.renderToTargets(e,this.hudVisibility,r?this.tmpDepth:this.mainDepth,cPt)}compositeTransparentTerrainOntoHUDVisibility(e){this.renderToTargets(()=>this._compositingHelper.compositeHUD(e,this._getColorTexture(this.tmpColor)),this.hudVisibility,this.tmpDepth)}renderOITPass(e,r,i){let s,n;switch(r){case ut.Color:s=this.colorFloatTarget,n=[0,0,0,0];break;case ut.Alpha:s=this.alphaFloatTarget,n=[1,1,1,1];break;case ut.FrontFace:s=this.frontFaceTarget,n=[0,0,0,0];break;case ut.NONE:case ut.COUNT:return}i?this.renderToTargets(e,s,this.tmpDepth,n,!0,!0):this.renderToTargets(e,s,this.mainDepth,n,!1)}compositeTransparentTerrainOntoMain(e){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Ya.PremultipliedAlpha)}compositeOccludedOntoMain(e,r){this.bindFramebuffer(),this._compositingHelper.composite(e,this._getColorTexture(this.tmpColor),Ya.PremultipliedAlpha,r)}compositeTransparentOntoOpaque(e,r){r?(this.bindTarget(this.hudColor,this.tmpDepth),this._rctx.setClearColor(0,0,0,1e-13),this._rctx.clearSafe(Bi.COLOR_BUFFER_BIT)):this.bindFramebuffer(),this._compositingHelper.compositeOIT(e,this._getColorTexture(this.colorFloatTarget),this._getColorTexture(this.alphaFloatTarget),this._getColorTexture(this.frontFaceTarget))}bindFramebuffer(){this._rctx.bindFramebuffer(this.framebuffer)}renderDepthDetached(e){this.bindTarget(this.currentColorTarget),e(),this.bindTarget(this.currentColorTarget,this.mainDepth)}disposeTarget(e){this._renderTargetHelper.disposeTargetResource(e)}renderToFBO(e,r,i=!1,s=!1){const n=this._rctx;let o=0;if(r){const l=Math.max(1e-13,r[3]);n.setClearColor(r[0],r[1],r[2],l),o|=Bi.COLOR_BUFFER_BIT}i&&(o|=Bi.DEPTH_BUFFER_BIT),s===!1?s=0:(s===!0&&(s=255),o|=Bi.STENCIL_BUFFER_BIT),o&&n.clearSafe(o,s),e(),n.gl.flush(),this.bindTarget(this.currentColorTarget,this.mainDepth)}renderToTargets(e,r,i,s,n=!1,o=!1){const a=this.bindTarget(r,i);return this.renderToFBO(e,s,n,o),a}bindTarget(e,r){const i=this._renderTargetHelper.getFramebuffer(this.width,this.height,e,r);return this._rctx.bindFramebuffer(i),i}_getColorTexture(e){return this._renderTargetHelper.getColorTexture(e,this.width,this.height)}get gpuMemoryUsage(){let e=0;return this._renderTargetHelper&&(e+=this._renderTargetHelper.gpuMemoryUsage),e}};const lPt=[0,0,0,0],cPt=[0,1,0,1];let AM=class extends me{constructor(e){super({}),this._context=e,this._renderPlugins=new qt,this._slots=[];for(let r=0;r<fe.MAX_SLOTS;++r)this._slots[r]=[]}normalizeCtorArgs(){return{}}add(e,r,i){const s=()=>{if(i?.aborted)throw r.uninitializeRenderContext(),Tr();this._renderPlugins.push(r);for(const o of e)this._slots[o].push(r);this._context.requestRender()},n=r.initializeRenderContext(this._context,i);if(Rh(n))return n.then(s);s(),this.notifyChange("_renderPlugins")}remove(e){if(this._renderPlugins.removeUnordered(e)!=null){for(let r=0;r<this._slots.length;++r)this._slots[r]=this._slots[r].filter(i=>i!==e);e.uninitializeRenderContext(),this._context.requestRender(),this.notifyChange("_renderPlugins")}}prepareRender(){this._renderPlugins.forAll(e=>{e.prepareRender&&e.prepareRender(this._context.renderContext)})}updateAnimation(e){let r=!1;return this._renderPlugins.forAll(i=>{i.updateAnimation&&(r=i.updateAnimation(e)||r)}),r}prepareSlots(e){for(const r of e)this._context.renderContext.bindParameters.slot=r,this._slots[r].filter(i=>{i.canRender&&(Uye(i)&&i.prepareTechnique(this._context.renderContext),Vye(i)&&i.prepareTechniques(this._context.renderContext))})}render(){const e=this._slots[this._context.renderContext.bindParameters.slot],r=new Array;e.filter(i=>{if(!i.canRender)return!1;if(Uye(i)){const s=i.prepareTechnique(this._context.renderContext);return s!=null&&(r.push(s),!0)}if(Vye(i)){const s=i.prepareTechniques(this._context.renderContext);return s!=null&&(r.push(s),!0)}return r.push(null),!0}).forEach((i,s)=>i.render(this._context.renderContext,r[s]))}queryDepthRange(e){const r=uPt;return r.near=1/0,r.far=-1/0,this._renderPlugins.forAll(i=>{if(i.queryDepthRange){const s=i.queryDepthRange(e);s&&qA(r,s,r)}}),r}get updating(){return this._renderPlugins.some(e=>e.running)}get needsTransparentPass(){return this._renderPlugins.some(e=>e.needsTransparentPass)}get needsHighlight(){return this._renderPlugins.some(e=>e.needsHighlight)}get needsLinearDepth(){return this._renderPlugins.some(e=>e.needsLinearDepth)}get needsLaserlineWithContrastControl(){const e=this._slots[fe.LASERLINES_CONTRAST_CONTROL];return!!e&&e.length>0}get renderOccludedFlags(){return this._renderPlugins.reduce((e,r)=>e|r.renderOccludedFlags,Qi.None)}};function Uye(t){return"prepareTechnique"in t}function Vye(t){return"prepareTechniques"in t}u([d()],AM.prototype,"_renderPlugins",void 0),u([d({readOnly:!0})],AM.prototype,"updating",null),AM=u([R("esri.views.3d.webgl-engine.lib.RenderPluginManager")],AM);const uPt={near:0,far:0};let MFe=class extends cie{};const s9=255,hPt=1/s9;function dPt(t){const e=new Cr,r=e.fragment;return r.include(Pu),r.include(Ch),e.include(j8),e.include(ep),e.include(G8,t),r.uniforms.add(new et("depthMap",i=>i.linearDepthTexture),new es("inverseViewMatrix",(i,s)=>so(zye,Cc(zye,s.camera.viewMatrix,s.camera.center))),new Pr("nearFar",(i,s)=>s.camera.nearFar)),r.constants.add("sampleValue","float",hPt),r.code.add(w`void main(void) {
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth > nearFar.y || -currentPixelDepth < nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthShadow = readShadowMapDepth(uvShadow, shadowMapTex);
bool shadow = depthShadow < lvpos.z;
if (!shadow) {
discard;
}
fragColor = vec4(sampleValue);
}`),e}const zye=xe(),pPt=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastAccumulatePassParameters:MFe,ShadowCastMaxSamples:s9,build:dPt},Symbol.toStringTag,{value:"Module"}));var eS;(function(t){t[t.Gradient=0]="Gradient",t[t.Threshold=1]="Threshold",t[t.COUNT=2]="COUNT"})(eS||(eS={}));let SJ=class extends nl{constructor(){super(...arguments),this.visualization=eS.Gradient,this.bandsEnabled=!1}};u([B({count:eS.COUNT})],SJ.prototype,"visualization",void 0),u([B()],SJ.prototype,"bandsEnabled",void 0);let IFe=class extends ui{constructor(e){super(),this._data=e,this.sampleScale=0,this.opacityFromElevation=1,this.color=h$(fPt),this.bandSize=.1,this.threshold=.5}get shadowCastMap(){return this._data.shadowCastTexture}};const fPt=Vt(.01,0,.25,1);function mPt(t){const e=new Cr,r=e.fragment;r.include(Pu),r.include(Ch),e.include(j8),e.include(ep);const{visualization:i,bandsEnabled:s}=t;r.constants.add("inverseSampleValue","float",s9),r.uniforms.add(new et("shadowCastMap",a=>a.shadowCastMap),new Ie("sampleScale",a=>a.sampleScale),new Ie("opacityFromElevation",a=>a.opacityFromElevation),new cr("uColor",a=>a.color));const n=i===eS.Gradient,o=i===eS.Threshold;return n&&s?r.uniforms.add(new Ie("bandSize",a=>a.bandSize)):o&&r.uniforms.add(new Ie("threshold",a=>a.threshold)),r.code.add(w`
      void main(void) {
        vec4 record = texture(shadowCastMap, uv);
        float pixelSamples = record.r * inverseSampleValue;
        if (pixelSamples < 1.0) {
          discard;
        }

        float strength = pixelSamples * sampleScale;

        ${o?w`
            if (strength <= threshold) {
              discard;
            }`:""}

        ${n&&s?w`strength = ceil(strength / bandSize) * bandSize;`:""}

        fragColor = vec4(uColor.xyz, uColor.a * opacityFromElevation ${n?w`* strength`:""});
      }
    `),e}const gPt=Object.freeze(Object.defineProperty({__proto__:null,ShadowCastVisualizePassParameters:IFe,build:mPt},Symbol.toStringTag,{value:"Module"}));let PFe=class $Fe extends Ur{constructor(e,r){super(e,r,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,$Fe.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:vh,colorWrite:Wt,depthTest:null,depthWrite:null})}get primitiveType(){return Ot.TRIANGLE_STRIP}};PFe.shader=new $r(gPt,()=>J(()=>import("./ShadowCastVisualize.glsl-e22ab552.js"),[],import.meta.url));const yPt=4e4,_Pt=5e4,LFe=1/512;let E5=class extends me{constructor(e,r,i,s){super({}),this._techniqueRepository=e,this._rctx=r,this._data=i,this._requestRender=s,this._passParameters=new IFe(this._data),this._techniqueConfig=new SJ,this._enabled=!1,this._vao=Mc(r),this._techniqueConfig.visualization=eS.Gradient}normalizeCtorArgs(){return{}}dispose(){this._stop(),this._vao=ze(this._vao),this._techniqueRepository.release(this._technique),this._technique=null}get _visualizeShadowCastTechnique(){return this._technique=this._techniqueRepository.releaseAndAcquire(PFe,this._techniqueConfig,this._technique),this._technique}render(e){if(!this._showVisualization)return;this._passParameters.sampleScale=1/this._data.computedSamples;const r=this._visualizeShadowCastTechnique;this._rctx.bindVAO(this._vao),this._rctx.bindTechnique(r,this._passParameters,e),this._rctx.drawArrays(r.primitiveType,0,Sa(this._vao,"geometry"))}setOptions(e){e.enabled!==void 0&&this._setEnabled(e.enabled),e.color!==void 0&&this._setColor(e.color),e.threshold!==void 0&&(this._threshold=e.threshold),e.visualization!==void 0&&(this._visualization=e.visualization),e.bandSize!==void 0&&(this._bandSize=e.bandSize),e.bandsEnabled!==void 0&&(this._bandsEnabled=e.bandsEnabled)}get opacityFromElevation(){return this._passParameters.opacityFromElevation}set opacityFromElevation(e){this._passParameters.opacityFromElevation!==e&&(this._passParameters.opacityFromElevation=e,this.notifyChange("opacityFromElevation"))}get _showVisualization(){return this._enabled&&this._data.computedSamples>0&&this.opacityFromElevation>LFe}get _threshold(){return this._passParameters.threshold}set _threshold(e){this._threshold!==e&&(this._passParameters.threshold=e,this._requestRenderIfRunning())}get _visualization(){return this._techniqueConfig.visualization}set _visualization(e){e!==this._visualization&&(this._techniqueConfig.visualization=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}get _bandSize(){return this._passParameters.bandSize}set _bandSize(e){e!==this._bandSize&&(this._passParameters.bandSize=e,this._requestRenderIfRunning())}get _bandsEnabled(){return this._techniqueConfig.bandsEnabled}set _bandsEnabled(e){e!==this._bandsEnabled&&(this._techniqueConfig.bandsEnabled=e,this._techniqueRepository.release(this._technique),this._technique=null,this._requestRenderIfRunning())}_setColor(e){const r=this._passParameters.color;wC(e,r)||(Id(this._passParameters.color,e),this._requestRenderIfRunning())}_setEnabled(e){e!==this._enabled&&(e?this._start():this._stop())}_requestRenderIfRunning(){this._enabled&&this._requestRender()}_start(){this._enabled=!0,this._requestRender()}_stop(){this._enabled=!1,this._requestRender()}};u([d()],E5.prototype,"opacityFromElevation",null),E5=u([R("esri.views.3d.webgl-engine.lib.ShadowCastRenderer")],E5);let Jie=class extends nl{constructor(){super(...arguments),this.receiveShadows=!0}};u([B()],Jie.prototype,"receiveShadows",void 0);let DFe=class NFe extends Ur{constructor(e){super(e,new Jie,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,NFe.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:ca(Te.ONE,Te.ONE,Te.ONE,Te.ONE),colorWrite:Wt,depthTest:null,depthWrite:null})}get primitiveType(){return Ot.TRIANGLE_STRIP}};DFe.shader=new $r(pPt,()=>J(()=>import("./ShadowCastAccumulate.glsl-6637a810.js"),[],import.meta.url));let ac=class extends me{constructor(e,r,i,s,n,o){super({}),this._rctx=e,this._stage=i,this._prepareForShadowMapPass=s,this._renderToShadowMap=n,this._requestRender=o,this._progress=0,this._sampleCount=0,this._passParameters=new MFe,this._cachedLightDirections=[],this._depthRange=gJ,this._previewing=!1,this._handles=new li,this._cameraForcedForScreenshot=!1,this._bindParameters=new a8(new aie(e,i.viewingMode),null,null),this._bindParameters.shadowMap.enabled=!0,this._vao=Mc(e),this._accumulationRenderer=new E5(r,e,this,o);const a=this._stage.view.resourceController.scheduler;this._handles.add([a.registerTask(gt.SHADOW_ACCUMULATOR,this),Q(()=>i.renderView,l=>{this._handles.remove(Bye),l!=null&&this._handles.add(l.events.on("force-camera-for-screenshot",()=>this._cameraForcedForScreenshot=!0),Bye)},Ri),Q(()=>this._previewing,()=>this._requestRenderIfEnabled(),Rr)])}normalizeCtorArgs(){return{}}dispose(){this._disable(),this._handles.destroy(),this._accumulationRenderer=ze(this._accumulationRenderer),this._bindParameters.shadowMap.dispose(),this._fbo=ze(this._fbo),this._vao=ze(this._vao),this._accumulationTechniqueCached=as(this._accumulationTechniqueCached),this._cachedLightDirections.length=0,this._sampleCount=0}get computedSamples(){return this._progress}get shadowCastTexture(){return this._fbo?.colorTexture}get isAccumulating(){return this._isPreviewing||this._isRefining}get _accumulationTechnique(){if(this._accumulationTechniqueCached==null){const e={rctx:this._rctx,viewingMode:this._stage.viewingMode};this._accumulationTechniqueCached=new DFe(e)}return this._accumulationTechniqueCached}get _isRefining(){return this._isActive&&!this._isDoneAccumulating&&!this._previewing}get _isPreviewing(){return this._isActive&&this._previewing}get _isActive(){return this._fbo!=null&&this._sampleCount>0}get canAccumulate(){return this._passParameters.linearDepthTexture!==null&&this._depthRange!==gJ&&this._opacityFromElevation>LFe}get _isDoneAccumulating(){return this._progress>=this._sampleCount}get _lightDirections(){return this._cachedLightDirections}set _lightDirections(e){const r=this._cachedLightDirections;if(T0(r,e,D1))return;const i=Math.min(s9,e.length);r.length=i,this._sampleCount=i;for(let s=0;s<i;++s)r[s]=oe(r[s]??C(),e[s]);this._invalidate()}get _opacityFromElevation(){return this._accumulationRenderer.opacityFromElevation}set _opacityFromElevation(e){this._accumulationRenderer.opacityFromElevation=e}get running(){return this._isRefining&&this.canAccumulate&&this._progress>0}runTask(e){for(this._prepareForShadowMapPass(this._bindParameters);!e.done&&!this._isDoneAccumulating;)this._accumulateShadow(),e.madeProgress();this._requestRender()}renderAccumulation(e,r,i,s){if(this._depthRange=r,this._updateCamera(i),this._bindParameters.contentCamera=s,this._passParameters.linearDepthTexture=e,this._passParameters.origin=this._bindParameters.camera.center,this.notifyChange("canAccumulate"),!this.isAccumulating||!this.canAccumulate)return;(this._previewing||this._progress===0||this._cameraForcedForScreenshot)&&this._clear();const n=this._cameraForcedForScreenshot?this._sampleCount:Math.min(vPt,this._sampleCount-this._progress);for(let o=0;o<n;++o)this._accumulateShadow();this._cameraForcedForScreenshot=!1,this._requestRender()}render(e){this._accumulationRenderer.render(e)}setOptions(e){if(e.enabled!==void 0){const r=this._fbo!=null;e.enabled!==r&&(e.enabled?this._enable():this._disable())}e.previewing!==void 0&&(this._previewing=e.previewing),e.lightDirections!==void 0&&(this._lightDirections=e.lightDirections),this._accumulationRenderer.setOptions(e)}readAccumulatedShadow(e,r){return!this._isActive||!this._fbo||this._progress<1||e<0||e>=this._fbo.width||r<0||r>=this._fbo.height?0:(this._fbo.readPixels(e,r,1,1,At.RGBA,fn.UNSIGNED_BYTE,Gye),Gye[0]/this._progress)}_enable(){this._progress=0;const e=new Sr;e.wrapMode=Ut.CLAMP_TO_EDGE,this._fbo=new Vn(this._rctx,e)}_disable(){this._fbo=ze(this._fbo)}_invalidate(){this._progress=0,this._requestRenderIfEnabled()}_clear(){this._rctx.bindFramebuffer(this._fbo),this._rctx.setClearColor(0,0,0,0),this._rctx.clearSafe(Bi.COLOR_BUFFER_BIT),this._progress=0}_accumulateShadow(){this._renderToShadowMap(this._bindParameters,this._sampleLightDirection(),this._depthRange);const e=this._accumulationTechnique;this._rctx.bindFramebuffer(this._fbo),this._rctx.bindTechnique(e,this._passParameters,this._bindParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(e.primitiveType,0,Sa(this._vao,"geometry"))}_sampleLightDirection(){return this._progress++,this._lightDirections[this._progress*bPt%this._lightDirections.length]}_updateCamera(e){!e.equals(this._bindParameters.camera)&&this._fbo&&(this._bindParameters.camera.copyFrom(e),this._fbo.resize(e.fullWidth,e.fullHeight),this._opacityFromElevation=1-BI(yPt,_Pt,e.relativeElevation))}_requestRenderIfEnabled(){this._fbo&&this._requestRender()}get test(){const e=this;return{lightDirections:this._lightDirections,get isDone(){return e._isDoneAccumulating},get isActive(){return e._isActive}}}};u([d()],ac.prototype,"_progress",void 0),u([d()],ac.prototype,"_sampleCount",void 0),u([d()],ac.prototype,"_fbo",void 0),u([d()],ac.prototype,"_depthRange",void 0),u([d()],ac.prototype,"_previewing",void 0),u([d()],ac.prototype,"_accumulationRenderer",void 0),u([d()],ac.prototype,"_isRefining",null),u([d()],ac.prototype,"_isActive",null),u([d()],ac.prototype,"canAccumulate",null),u([d()],ac.prototype,"_isDoneAccumulating",null),u([d()],ac.prototype,"_opacityFromElevation",null),u([d()],ac.prototype,"running",null),ac=u([R("esri.views.3d.webgl-engine.lib.ShadowAccumulator")],ac);const vPt=6,Bye="renderView",bPt=104729,Gye=new Uint8Array(4),jye={highlightedThreshold:.99999,selfShadowThreshold:.025};function wPt(t){const e=new Cr;e.include(XT,t);const r=e.fragment;return r.include(Pu),r.include(Ch),e.include(j8),e.include(ep),r.uniforms.add(new et("defaultDepthTex",(i,s)=>s.shadowMap.getSnapshot(GA.Default)),new et("highlightDepthTex",(i,s)=>s.shadowMap.getSnapshot(GA.Highlight)),new et("depthMap",(i,s)=>s.linearDepthTexture),new et("highlightMap",(i,s)=>s.highlightColorTexture),new cr("uColor",i=>i.shadowColor),new Pr("nearFar",(i,s)=>s.camera.nearFar),new Ie("opacity",i=>i.shadowOpacity),new Ie("occludedOpacity",i=>i.occludedShadowOpacity),new Ie("terminationFactor",i=>i.opacityElevation*i.dayNightTerminator),new jt("lightingMainDirectionView",(i,s)=>_e(qye,Ne(qye,s.lighting.mainLight.direction,s.camera.viewInverseTransposeMatrix))),new Pr("texelSize",(i,s)=>s.linearDepthTexture!=null?hr(xPt,1/s.linearDepthTexture.descriptor.width,1/s.linearDepthTexture.descriptor.height):Df),new es("inverseViewMatrix",(i,s)=>so(Hye,Cc(Hye,s.camera.viewMatrix,s.camera.center)))),r.constants.add("unoccludedHighlightFlag","vec4",wPe).add("highlightedThreshold","float",jye.highlightedThreshold).add("selfShadowThreshold","float",jye.selfShadowThreshold),r.code.add(w`vec3 normalFromDepth(vec3 pixelPos, vec2 fragCoord, vec2 uv, vec2 texelSize, sampler2D depthMap, vec2 nearFar) {
float leftPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(-1.0, 0.0) * texelSize, nearFar);
float rightPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(1.0, 0.0) * texelSize, nearFar);
float bottomPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, -1.0) * texelSize, nearFar);
float topPixelDepth = linearDepthFromTexture(depthMap, uv + vec2(0.0, 1.0) * texelSize, nearFar);
bool pickLeft = abs(pixelPos.z - leftPixelDepth) < abs(pixelPos.z - rightPixelDepth);
bool pickBottom = abs(pixelPos.z - bottomPixelDepth) < abs(pixelPos.z - topPixelDepth);
vec3 fragCoordHorizontal = pickLeft
? vec3(fragCoord + vec2(-1.0, 0.0), leftPixelDepth)
: vec3(fragCoord + vec2(1.0, 0.0), rightPixelDepth);
vec3 fragCoordVertical = pickBottom
? vec3(fragCoord + vec2(0.0, -1.0), bottomPixelDepth)
: vec3(fragCoord + vec2(0.0, 1.0), topPixelDepth);
vec3 verticalPixelPos = reconstructPosition(fragCoordHorizontal.xy, fragCoordHorizontal.z);
vec3 horizontalPixelPos = reconstructPosition(fragCoordVertical.xy, fragCoordVertical.z);
vec3 normal = normalize(cross(verticalPixelPos - pixelPos, horizontalPixelPos - pixelPos));
return pickLeft == pickBottom ? normal : -normal;
}`),r.code.add(w`void main(void) {
vec4 highlightInfo = texture(highlightMap, uv);
float visiblyHighlighted = (1.0 - clamp(distance(unoccludedHighlightFlag, highlightInfo), 0.0, 1.0)) * highlightInfo.a;
if (visiblyHighlighted > highlightedThreshold) {
discard;
}
float depth = rgba2float(texture(depthMap, uv));
if (depth == 0.0) {
discard;
}
float currentPixelDepth = linearDepthFromFloat(depth, nearFar);
if (-currentPixelDepth>nearFar.y || -currentPixelDepth<nearFar.x) {
discard;
}
vec4 currentPixelPos = vec4(reconstructPosition(gl_FragCoord.xy, currentPixelDepth), 1.0);
vec4 worldSpacePos = inverseViewMatrix * currentPixelPos;
mat4 shadowMatrix;
float linearDepth = -currentPixelDepth;
int i = chooseCascade(linearDepth, shadowMatrix);
if (i >= numCascades) {
discard;
}
vec3 lvpos = lightSpacePosition(worldSpacePos.xyz, shadowMatrix);
if (lvpos.z >= 1.0 || lvpos.x < 0.0 || lvpos.x > 1.0 || lvpos.y < 0.0 || lvpos.y > 1.0) {
discard;
}
vec2 uvShadow = cascadeCoordinates(i, lvpos);
float depthHighlight = readShadowMapDepth(uvShadow, highlightDepthTex);
bool shadowHighlight = depthHighlight < lvpos.z;
if (!shadowHighlight) {
discard;
}
float depthDefault = readShadowMapDepth(uvShadow, defaultDepthTex);
bool shadowDefault = depthDefault < lvpos.z;
vec3 normal = normalFromDepth(currentPixelPos.xyz, gl_FragCoord.xy, uv, texelSize, depthMap, nearFar);
bool shaded = dot(normal, lightingMainDirectionView) < selfShadowThreshold;
float fragOpacity = (shadowDefault || shaded) ? occludedOpacity : opacity;
fragColor = vec4(uColor.rgb, uColor.a * fragOpacity * terminationFactor);
}`),e}const Hye=xe(),qye=C(),xPt=Pe(),TPt=Object.freeze(Object.defineProperty({__proto__:null,build:wPt},Symbol.toStringTag,{value:"Module"}));let SPt=class extends cie{constructor(){super(...arguments),this.shadowColor=Vt(1,0,1,1),this.shadowOpacity=.2,this.occludedShadowOpacity=.1,this.opacityElevation=1,this.dayNightTerminator=1}},FFe=class kFe extends Ur{constructor(e){super(e,new Jie,()=>this.destroy())}initializeProgram(e){return new Lr(e.rctx,kFe.shader.get().build(this.configuration),Er)}initializePipeline(){return It({blending:ca(Te.SRC_ALPHA,Te.ONE,Te.ONE_MINUS_SRC_ALPHA,Te.ONE_MINUS_SRC_ALPHA),colorWrite:Wt,depthTest:null,depthWrite:null})}get primitiveType(){return Ot.TRIANGLE_STRIP}};FFe.shader=new $r(TPt,()=>J(()=>import("./ShadowHighlight.glsl-76ec6442.js"),[],import.meta.url));const EPt=.001953125,CPt=4e4,APt=5e4;let OPt=class{constructor(e,r){this._rctx=e,this._viewingMode=r,this._maxOpacity=1,this._passParameters=new SPt,this._drawParameters=new cwt,this._vao=Mc(this._rctx)}get _technique(){return this._techniqueCached==null&&(this._techniqueCached=new FFe({rctx:this._rctx,viewingMode:this._viewingMode})),this._techniqueCached}render(e,r){if(!e.shadowMap.enabled||!e.linearDepthTexture||!this.isVisible)return;const i=this._technique;this._drawParameters.origin=e.camera.center,this._rctx.bindFramebuffer(r),this._rctx.bindTechnique(i,this._passParameters,e).bindDraw(this._drawParameters,e,this._passParameters),this._rctx.bindVAO(this._vao),this._rctx.drawArrays(i.primitiveType,0,Sa(this._vao,"geometry"))}get gpuMemoryUsage(){return this._vao?.memoryEstimate??0}setDefaultOptions(e){this._passParameters={...this._passParameters,...e},this._updateMaxOpacity()}updateParameters(e,r){this._passParameters.opacityElevation=1-BI(CPt,APt,e.relativeElevation);const i=this._viewingMode===Ue.Global?_e(Wye,e.center):ie(Wye,0,0,1),s=de(i,r);this._passParameters.dayNightTerminator=BI(0,1,ye(30*s,0,1))}dispose(){this._vao=ze(this._vao),this._techniqueCached=as(this._techniqueCached)}get isVisible(){const{opacityElevation:e,dayNightTerminator:r}=this._passParameters;return this._maxOpacity*e*r>=EPt}_updateMaxOpacity(){const e=Math.max(this._passParameters.shadowOpacity,this._passParameters.occludedShadowOpacity);this._maxOpacity=e*this._passParameters.shadowColor[3]}};const Wye=C(),Zye=B0();let RPt=class{constructor(){this._plane=B0()}get isEnabled(){return!pRe(this.plane,Zye)}get plane(){return this._plane}set plane(e){_S(e||Zye,this._plane)}},MPt=class extends ui{};function DP(t){t.uniforms.add(new cr("resolution",e=>{const{descriptor:r}=e.colorTexture,i=r.width,s=r.height;return zi(IPt,1/i,1/s,i,s)}))}const IPt=Qt(),L2={maxSearchSteps:8,maxDistanceAreaTex:16};function PPt(){const t=new Cr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(E.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),r.add("maxOffset","vec4"),r.add("pixelCoord","vec2"),DP(i),i.code.add(w`
      void main() {
        uv = position * 0.5 + vec2(0.5);
        gl_Position = vec4(position, 0, 1);

        pixelCoord = uv * resolution.zw;
        offsets[0] = uv.xyxy + resolution.xyxy * vec4( -0.25, 0.125, 1.25, 0.125 );
        offsets[1] = uv.xyxy + resolution.xyxy * vec4( -0.125, 0.25, -0.125, -1.25 );
        maxOffset = vec4( offsets[0].xz, offsets[1].yw ) + vec4( -2.0, 2.0, -2.0, 2.0 ) * resolution.xxyy * float( ${w.int(L2.maxSearchSteps)} );
      }
    `),s.uniforms.add(new et("edgesTexture",n=>n.edges.colorTexture)),s.uniforms.add(new et("areaTexture",n=>n.areaTexture)),s.uniforms.add(new et("searchTexture",n=>n.searchTexture)),DP(s),s.code.add(w`
      #define SMAA_AREATEX_PIXEL_SIZE ( 1.0 / vec2( 160.0, 560.0 ) )
      #define SMAA_AREATEX_SUBTEX_SIZE ( 1.0 / 7.0 )

      vec4 sampleLevelZeroOffset(sampler2D tex, vec2 coord, vec2 offset) {
        return texture(tex, coord + offset.x * resolution.xy, 0.0);
      }

      float searchLength(sampler2D searchTex, vec2 e, float bias, float scale) {
        e.r = bias + e.r * scale;
        return 255.0 * texture( searchTex, e, 0.0 ).r;
      }

      float searchXLeft( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(L2.maxSearchSteps)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x > end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x += 0.25 * resolution.x;
        texcoord.x += resolution.x;
        texcoord.x += 2.0 * resolution.x;
        texcoord.x -= resolution.x * searchLength(searchTex, e, 0.0, 0.5);
        return texcoord.x;
      }

      float searchXRight( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 0.0, 1.0 );
        for ( int i = 0; i < ${w.int(L2.maxSearchSteps)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 2.0, 0.0 ) * resolution.xy;
          if ( ! ( texcoord.x < end && e.g > 0.8281 && e.r == 0.0 ) ) break;
        }
        texcoord.x -= 0.25 * resolution.x;
        texcoord.x -= resolution.x;
        texcoord.x -= 2.0 * resolution.x;
        texcoord.x += resolution.x * searchLength( searchTex, e, 0.5, 0.5 );
        return texcoord.x;
      }

      float searchYUp( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(L2.maxSearchSteps)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord += vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y > end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y -= 0.25 * resolution.y;
        texcoord.y -= resolution.y;
        texcoord.y -= 2.0 * resolution.y;
        texcoord.y += resolution.y * searchLength( searchTex, e.gr, 0.0, 0.5 );
        return texcoord.y;
      }

      float searchYDown( sampler2D edgesTex, sampler2D searchTex, vec2 texcoord, float end ) {
        vec2 e = vec2( 1.0, 0.0 );
        for ( int i = 0; i < ${w.int(L2.maxSearchSteps)}; i ++ ) {
          e = texture( edgesTex, texcoord, 0.0 ).rg;
          texcoord -= vec2( 0.0, 2.0 ) * resolution.xy;
          if ( ! ( texcoord.y < end && e.r > 0.8281 && e.g == 0.0 ) ) break;
        }
        texcoord.y += 0.25 * resolution.y;
        texcoord.y += resolution.y;
        texcoord.y += 2.0 * resolution.y;
        texcoord.y -= resolution.y * searchLength( searchTex, e.gr, 0.5, 0.5 );
        return texcoord.y;
      }

      vec2 getArea( sampler2D areaTex, vec2 dist, float e1, float e2, float offset ) {
        vec2 texcoord = float( ${w.int(L2.maxDistanceAreaTex)} ) * round( 4.0 * vec2( e1, e2 ) ) + dist;
        texcoord = SMAA_AREATEX_PIXEL_SIZE * texcoord + ( 0.5 * SMAA_AREATEX_PIXEL_SIZE );
        texcoord.y += SMAA_AREATEX_SUBTEX_SIZE * offset;
        return texture( areaTex, texcoord, 0.0 ).rg;
      }

      void main() {
        ivec4 subsampleIndices = ivec4(0.0);
        vec4 weights = vec4(0.0);
        vec2 e = texture( edgesTexture, uv ).rg;
        if ( e.g > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.x = searchXLeft( edgesTexture, searchTexture, offsets[0].xy, maxOffset.x );
          coords.y = offsets[1].y;
          d.x = coords.x;
          float e1 = texture( edgesTexture, coords, 0.0 ).r;
          coords.x = searchXRight( edgesTexture, searchTexture, offsets[0].zw, maxOffset.y );
          d.y = coords.x;
          d = d * resolution.z - pixelCoord.x;
          vec2 sqrt_d = sqrt( abs(d) );
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2( 1.0, 0.0 ) ).r;
          weights.rg = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.y ) );
        }

        if ( e.r > 0.0 ) {
          vec2 d;
          vec2 coords;
          coords.y = searchYUp( edgesTexture, searchTexture, offsets[1].xy, maxOffset.z );
          coords.x = offsets[0].x;
          d.x = coords.y;
          float e1 = texture( edgesTexture, coords, 0.0 ).g;
          coords.y = searchYDown( edgesTexture, searchTexture, offsets[1].zw, maxOffset.w );
          d.y = coords.y;
          d = d * resolution.w - pixelCoord.y;
          vec2 sqrt_d = sqrt(abs(d));
          coords.y -= 1.0 * resolution.y;
          float e2 = sampleLevelZeroOffset( edgesTexture, coords, vec2(0.0, 1.0)).g;
          weights.ba = getArea( areaTexture, sqrt_d, e1, e2, float( subsampleIndices.x ) );

          // for some reason the following lines are necessary to prevent
          // texture lookup precision issues on some Intel integrated graphics chips
          vec4 dbg = (offsets[0] + offsets[1] + maxOffset + coords.xyyx);
          weights.r += 0.00000001 * dot(vec4(0, 1, 0, 1), dbg);
        }
        fragColor = weights;
      }
    `),t}const $Pt=Object.freeze(Object.defineProperty({__proto__:null,build:PPt},Symbol.toStringTag,{value:"Module"}));let UFe=class VFe extends Ur{initializeProgram(e){return new Lr(e.rctx,VFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};UFe.shader=new $r($Pt,()=>J(()=>import("./BlendWeights.glsl-9aa5b253.js"),[],import.meta.url));function LPt(){const t=new Cr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(E.POSITION,"vec2"),r.add("uv","vec2"),r.add("offsets[2]","vec4"),DP(i),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0, 1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4( 1.0, 0.0, 0.0, -1.0 );
}`),s.uniforms.add(new et("blendWeightsTexture",n=>n.blend.colorTexture),new et("colorTexture",n=>n.colorTexture)),DP(s),s.code.add(w`void main() {
vec4 a;
a.rb = texture(blendWeightsTexture, uv).rb;
a.g = texture(blendWeightsTexture, offsets[1].zw).g;
a.a = texture(blendWeightsTexture, offsets[1].xy).a;
if ( dot(a, vec4(1.0)) < 1e-5 ) {
fragColor = texture( colorTexture, uv, 0.0 );
} else {
vec2 offset;
offset.x = a.a > a.b ? a.a : -a.b;
offset.y = a.g > a.r ? -a.g : a.r;
if ( abs( offset.x ) > abs( offset.y )) {
offset.y = 0.0;
} else {
offset.x = 0.0;
}
vec4 C = texture( colorTexture, uv, 0.0 );
vec4 Cop = texture( colorTexture, uv + sign( offset ) * resolution.xy, 0.0 );
float s = abs( offset.x ) > abs( offset.y ) ? abs( offset.x ) : abs( offset.y );
fragColor = mix(C, Cop, s);
}
}`),t}const DPt=Object.freeze(Object.defineProperty({__proto__:null,build:LPt},Symbol.toStringTag,{value:"Module"}));let zFe=class BFe extends Ur{initializeProgram(e){return new Lr(e.rctx,BFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};zFe.shader=new $r(DPt,()=>J(()=>import("./Blur.glsl-5dc082c3.js"),[],import.meta.url));const Xye={threshold:.05,localConstrastAdaption:2};function NPt(){const t=new Cr,{attributes:e,varyings:r,vertex:i,fragment:s}=t;return e.add(E.POSITION,"vec2"),DP(i),r.add("uv","vec2"),r.add("offsets[3]","vec4"),i.code.add(w`void main() {
uv = position * 0.5 + vec2(0.5);
gl_Position = vec4(position, 0, 1);
offsets[0] = uv.xyxy + resolution.xyxy * vec4( -1.0, 0.0, 0.0,  1.0 );
offsets[1] = uv.xyxy + resolution.xyxy * vec4(  1.0, 0.0, 0.0, -1.0 );
offsets[2] = uv.xyxy + resolution.xyxy * vec4( -2.0, 0.0, 0.0,  2.0 );
}`),s.uniforms.add(new et("colorTexture",n=>n.colorTexture)),s.code.add(w`
    float absMax3(vec3 v) {
      vec3 t = abs(v);
      return max(max(t.r, t.g), t.b);
    }

    void main() {
      // Calculate color deltas:
      vec4 delta;
      vec3 C = texture(colorTexture, uv).rgb;

      vec3 Cleft = texture(colorTexture, offsets[0].xy).rgb;
      delta.x = absMax3(C - Cleft);

      vec3 Ctop = texture(colorTexture, offsets[0].zw).rgb;
      delta.y = absMax3(C - Ctop);

      vec2 edges = step(vec2(${w.float(Xye.threshold)}), delta.xy);

      // discard if there is no edge:
      if (dot(edges, vec2(1.0)) == 0.0) {
        discard;
      }

      // Calculate right and bottom deltas:
      vec3 Cright = texture(colorTexture, offsets[1].xy).rgb;
      delta.z = absMax3(C - Cright);

      vec3 Cbottom  = texture(colorTexture, offsets[1].zw).rgb;
      delta.w = absMax3(C - Cbottom);

      // Calculate the maximum delta in the direct neighborhood:
      float maxDelta = max(max(max(delta.x, delta.y), delta.z), delta.w);

      // Calculate left-left and top-top deltas:
      vec3 Cleftleft  = texture(colorTexture, offsets[2].xy).rgb;
      delta.z = absMax3(C - Cleftleft);

      vec3 Ctoptop = texture(colorTexture, offsets[2].zw).rgb;
      delta.w = absMax3(C - Ctoptop);

      // Calculate the final maximum delta:
      maxDelta = max(max(maxDelta, delta.z), delta.w);

      // Local contrast adaptation in action:
      edges.xy *= step(maxDelta, float(${w.float(Xye.localConstrastAdaption)}) * delta.xy);

      fragColor = vec4(edges, 0.0, 0.0);
    }
  `),t}const FPt=Object.freeze(Object.defineProperty({__proto__:null,build:NPt},Symbol.toStringTag,{value:"Module"}));let GFe=class jFe extends Ur{initializeProgram(e){return new Lr(e.rctx,jFe.shader.get().build(),Er)}initializePipeline(){return It({colorWrite:Wt})}};GFe.shader=new $r(FPt,()=>J(()=>import("./EdgeDetect.glsl-9e9dfb12.js"),[],import.meta.url));let OM=class extends me{constructor(e,r){super({}),this._rctx=e,this._techniqueRep=r,this._passParameters=new MPt,this._isEnabled=!1}normalizeCtorArgs(){return{}}dispose(){this._abortController=Do(this._abortController),this.disable()}_loadResources(e){if(this._abortController!=null)return!1;if(this._passParameters.searchTexture!=null)return!0;this._abortController=new AbortController;const r=this._abortController.signal;return J(()=>import("./SmaaRenderPassData-660b7d34.js"),[],import.meta.url).then(i=>this._loadTextures(i,r)).then(()=>e()).finally(()=>this._abortController=null),!1}_loadTextures(e,r){return Dt(r),Promise.all([this._loadTextureFromBase64(e.areaTexture,Mt.LINEAR,At.RGB),this._loadTextureFromBase64(e.searchTexure,Mt.NEAREST,At.LUMINANCE)]).then(([i,s])=>{dn(r)?(i.dispose(),s.dispose(),Dt(r)):(this._passParameters.areaTexture=i,this._passParameters.searchTexture=s)})}get updating(){return this._abortController!=null}enable(e){if(this._isEnabled)return!0;if(!this._edgeDetectTechnique||!this._blendWeightsTechnique||!this._blurTechnique){const s=new nl;this._edgeDetectTechnique=this._techniqueRep.releaseAndAcquire(GFe,s,this._edgeDetectTechnique),this._blendWeightsTechnique=this._techniqueRep.releaseAndAcquire(UFe,s,this._blendWeightsTechnique),this._blurTechnique=this._techniqueRep.releaseAndAcquire(zFe,s,this._blurTechnique)}if(!this._loadResources(e))return!1;this._vao=Mht(this._rctx);const r=new Sr(4,4);r.pixelFormat=At.RG,r.internalFormat=Je.RG8,r.wrapMode=Ut.CLAMP_TO_EDGE,this._passParameters.edges=new Vn(this._rctx,r);const i=new Sr(4,4);return i.pixelFormat=At.RGBA,i.wrapMode=Ut.CLAMP_TO_EDGE,this._passParameters.blend=new Vn(this._rctx,i),this._isEnabled=!0,!0}disable(){this._isEnabled&&(this._vao=ze(this._vao),this._passParameters.areaTexture=ze(this._passParameters.areaTexture),this._passParameters.searchTexture=ze(this._passParameters.searchTexture),this._passParameters.blend=ze(this._passParameters.blend),this._passParameters.edges=ze(this._passParameters.edges),this._isEnabled=!1)}get _validPassParameters(){return this._isEnabled?this._passParameters:null}render(e){const r=this._validPassParameters;if(r==null)return;r.colorTexture=e;const i=this._rctx,s=i.getBoundFramebufferObject(),n=e.descriptor.width,o=e.descriptor.height;i.bindVAO(this._vao),i.setViewport(0,0,n,o),r.edges.resize(n,o),i.bindFramebuffer(r.edges),i.setClearColor(0,0,0,1),i.clear(Bi.COLOR_BUFFER_BIT),i.bindTechnique(this._edgeDetectTechnique,r,null),i.drawArrays(Ot.TRIANGLES,0,3),r.blend.resize(n,o),i.bindFramebuffer(r.blend),i.setClearColor(0,0,1,1),i.clear(Bi.COLOR_BUFFER_BIT),i.bindTechnique(this._blendWeightsTechnique,r,null),i.drawArrays(Ot.TRIANGLES,0,3),i.bindFramebuffer(s),i.setClearColor(0,1,0,1),i.clear(Bi.COLOR_BUFFER_BIT),i.bindTechnique(this._blurTechnique,r,null),i.drawArrays(Ot.TRIANGLES,0,3)}_loadTextureFromBase64(e,r,i){return D0(e).then(s=>{const n=new Sr;return n.pixelFormat=i,n.wrapMode=Ut.CLAMP_TO_EDGE,n.width=s.width,n.height=s.height,n.samplingMode=r,new Rt(this._rctx,n,s)})}};u([d()],OM.prototype,"_abortController",void 0),u([d({readOnly:!0})],OM.prototype,"updating",null),OM=u([R("esri.views.3d.webgl-engine.lib.SmaaRenderPass")],OM);function kPt(t,e){const r=-t[0],i=-t[1],s=-t[2],n=e[3],o=e[7],a=e[11],l=e[15];e[0]+=n*r,e[1]+=n*i,e[2]+=n*s,e[4]+=o*r,e[5]+=o*i,e[6]+=o*s,e[8]+=a*r,e[9]+=a*i,e[10]+=a*s,e[12]+=l*r,e[13]+=l*i,e[14]+=l*s}function UPt(t,e){const r=t[0],i=t[1],s=t[2];e[12]+=r*e[0]+i*e[4]+s*e[8],e[13]+=r*e[1]+i*e[5]+s*e[9],e[14]+=r*e[2]+i*e[6]+s*e[10],e[14]+=r*e[3]+i*e[7]+s*e[11]}let VPt=class{constructor(e){this._factory=e,this._originData=new Map}acquire(e){return this.register(this._factory.getOrigin(e))}register(e){const r=this._originData.get(e.id)||new zPt(e);return r.refCount++,this._originData.has(r.origin.id)||this._originData.set(r.origin.id,r),r}release(e){e.refCount--,e.refCount===0&&this._originData.delete(e.origin.id)}updateViewMatrices(e){this._originData.forEach(r=>{an(r.viewMatrix,e),UPt(r.origin.vec3,r.viewMatrix)})}},zPt=class{constructor(e){this.origin=e,this.refCount=0,this.viewMatrix=xe()}},BPt=class extends k3e{constructor(e,r){super(),this.distanceFalloffFactor=e,this.transparency=r,this.transformNormalViewFromGlobal=ts()}},GPt=class extends U3e{constructor(){super(...arguments),this.transformNormalViewFromGlobal=ts(),this.slicePlaneLocalOrigin=C(),this.transformNormalGlobalFromModel=ts()}};function jPt(t){const e=w`bool isNaN( float val )
{
return ( val < 0.0 || 0.0 < val || val == 0.0 ) ? false : true;
}`;t.code.add(e)}const HPt=yr(.5,-4e-4);function qPt(t,e){const r=t.vertex;r.include(jPt),r.constants.add("depthBias","vec2",HPt),r.uniforms.add(new Pr("inverseViewport",(i,s)=>s.inverseViewport)),e.legacy?(r.uniforms.add(new es("proj",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = proj * localView * vec4(globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)):(r.uniforms.add(new tp("transformNormalViewFromGlobal",i=>i.transformNormalViewFromGlobal),new es("transformProjFromView",i=>i.transformProjFromView)),r.code.add(w`vec2 calculateProjectedBiasXY(vec4 projPos, vec3 globalNormal) {
float offsetXY = depthBias.x;
vec4 projNormal = transformProjFromView * vec4(transformNormalViewFromGlobal * globalNormal, 0.0);
return offsetXY * projPos.w * 2.0 * inverseViewport * normalize(projNormal.xyz).xy;
}`)),r.code.add(w`float _calculateProjectedBiasZ(vec4 projPos) {
float offsetZ = depthBias.y;
return sqrt(max(projPos.z,0.0)) * offsetZ;
}
vec4 adjustProjectedPosition(vec4 projPos, vec3 worldNormal, float lineWidth) {
vec2 offsetXY = calculateProjectedBiasXY(projPos, worldNormal);
if (!isNaN(offsetXY.x) && !isNaN(offsetXY.y)) {
projPos.xy += offsetXY;
}
projPos.z += _calculateProjectedBiasZ(projPos);
return projPos;
}`)}function WPt(t,e){const r=t.fragment;r.constants.add("coverageTestThreshold","float",.01),e.antialiasing?r.code.add(w`#define discardByCoverage(radius, coverage) { if (coverage < coverageTestThreshold) discard; }`):r.code.add(w`#define discardByCoverage(radius, coverage) { float coverageLimit = radius <= 0.5 ? coverageTestThreshold : 0.75; if (coverage < coverageLimit) discard; }`)}function ZPt(t,e){const r=t.vertex;e.silhouette?(r.code.add(w`bool isSilhouetteEdge(vec3 viewDir, vec3 normalA, vec3 normalB) {
float faceAVisible = dot(viewDir, normalA);
float faceBVisible = dot(viewDir, normalB);
return faceAVisible * faceBVisible < 0.0;
}`),e.legacy?r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 viewNormalA = _modelToViewNormal(normalA);
vec3 viewNormalB = _modelToViewNormal(normalB);
vec3 viewDir = -viewPos;
if (isSilhouetteEdge(viewDir, viewNormalA, viewNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
vec3 worldNormalA = _modelToWorldNormal(normalA);
vec3 worldNormalB = _modelToWorldNormal(normalB);
vec3 viewDir = -worldPos;
if (isSilhouetteEdge(viewDir, worldNormalA, worldNormalB)) {
return false;
}
gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
return true;
}`)):r.code.add(w`bool discardNonSilhouetteEdges(vec3 viewPos, vec3 worldPos) {
return false;
}`)}function XPt(t,e){const r=t.vertex;r.include(Pu),r.uniforms.add(new Ie("distanceFalloffFactor",i=>i.distanceFalloffFactor)),r.code.add(w`float distanceBasedPerspectiveFactor(float distance) {
return clamp(sqrt(distanceFalloffFactor / distance), 0.0, 1.0);
}`),r.uniforms.add(new Nd("componentDataTex",i=>i.componentDataTexture)),t.attributes.add(E.COMPONENTINDEX,"float"),r.constants.add("componentColorFieldOffset","float",0),r.constants.add("componentOtherFieldOffset","float",1),r.constants.add("componentVerticalOffsetFieldOffset","float",2),r.constants.add("componentFieldCount","float",3),r.constants.add("lineWidthFractionFactor","float",8),r.constants.add("extensionLengthOffset","float",128),r.constants.add("verticalOffsetScale","float",2*Wie),r.code.add(w`vec2 _componentTextureCoords(float componentIndex, float fieldOffset) {
float fieldIndex = componentFieldCount * componentIndex + fieldOffset;
float texSize = float(textureSize(componentDataTex, 0).x);
float colIndex = mod(fieldIndex, texSize);
float rowIndex = floor(fieldIndex / texSize);
return vec2(colIndex, rowIndex) + 0.5;
}
struct ComponentData {
vec4 color;
float lineWidth;
float extensionLength;
float type;
float verticalOffset;
};
ComponentData readComponentData() {
vec2 colorIndex = _componentTextureCoords(componentIndex, componentColorFieldOffset);
vec2 otherIndex = _componentTextureCoords(componentIndex, componentOtherFieldOffset);
vec2 verticalOffsetIndex = _componentTextureCoords(componentIndex, componentVerticalOffsetFieldOffset);
vec4 colorValue = texelFetch(componentDataTex, ivec2(colorIndex), 0);
vec4 otherValue = texelFetch(componentDataTex, ivec2(otherIndex), 0);
float verticalOffset = (rgba2float(texelFetch(componentDataTex, ivec2(verticalOffsetIndex), 0)) - 0.5) * verticalOffsetScale;
return ComponentData(
vec4(colorValue.rgb, colorValue.a * otherValue.w),
otherValue.x * (255.0 / lineWidthFractionFactor),
otherValue.y * 255.0 - extensionLengthOffset,
-(otherValue.z * 255.0) + 0.5,
verticalOffset
);
}`),e.legacy?r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return (model * vec4(normal, 0.0)).xyz;
}
vec3 _modelToViewNormal(vec3 normal) {
return (localView * model * vec4(normal, 0.0)).xyz;
}`):(r.uniforms.add(new pP("transformNormalGlobalFromModel",i=>i.transformNormalGlobalFromModel)),r.code.add(w`vec3 _modelToWorldNormal(vec3 normal) {
return transformNormalGlobalFromModel * normal;
}`)),e.silhouette?(t.attributes.add(E.NORMALA,"vec3"),t.attributes.add(E.NORMALB,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normalize(normalA + normalB));
}`)):(t.attributes.add(E.NORMAL,"vec3"),r.code.add(w`vec3 worldNormal() {
return _modelToWorldNormal(normal);
}`)),e.legacy?r.code.add(w`void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
worldPos = (model * vec4(modelPos, 1.0)).xyz;
viewPos = (localView * vec4(worldPos, 1.0)).xyz;
}`):(r.include(_U,e),r.include(_U,e),r.uniforms.add(new tp("transformViewFromCameraRelativeRS",i=>i.transformViewFromCameraRelativeRS),new pP("transformWorldFromModelRS",i=>i.transformWorldFromModelRS),new _h("transformWorldFromModelTL",i=>i.transformWorldFromModelTL),new _h("transformWorldFromModelTH",i=>i.transformWorldFromModelTH),new jt("transformWorldFromViewTL",i=>i.transformWorldFromViewTL),new jt("transformWorldFromViewTH",i=>i.transformWorldFromViewTH)),r.code.add(w`
      void worldAndViewFromModelPosition(vec3 modelPos, float verticalOffset, out vec3 worldPos, out vec3 viewPos) {
        vec3 rotatedModelPosition = transformWorldFromModelRS * modelPos;

        vec3 transformCameraRelativeFromModel = dpAdd(
          transformWorldFromModelTL,
          transformWorldFromModelTH,
          -transformWorldFromViewTL,
          -transformWorldFromViewTH
        );

        worldPos = transformCameraRelativeFromModel + rotatedModelPosition;

        if (verticalOffset != 0.0) {
          vec3 vUp = ${e.spherical?w`normalize(transformWorldFromModelTL + rotatedModelPosition);`:w`vec3(0.0, 0.0, 1.0);`}
          worldPos += verticalOffset * vUp;
        }

        viewPos = transformViewFromCameraRelativeRS * worldPos;
      }
    `)),r.uniforms.add(new es("transformProjFromView",(i,s)=>s.camera.projectionMatrix)),r.code.add(w`vec4 projFromViewPosition(vec3 position) {
return transformProjFromView * vec4(position, 1.0);
}`),r.code.add(w`float calculateExtensionLength(float extensionLength, float lineLength) {
return extensionLength / (log2(max(1.0, 256.0 / lineLength)) * 0.2 + 1.0);
}`)}function YPt(t){return t.mode===Dn.SKETCH||t.mode===Dn.MIXED}var Dn,Ux;(function(t){t[t.SOLID=0]="SOLID",t[t.SKETCH=1]="SKETCH",t[t.MIXED=2]="MIXED",t[t.COUNT=3]="COUNT"})(Dn||(Dn={})),function(t){t[t.REGULAR=0]="REGULAR",t[t.SILHOUETTE=1]="SILHOUETTE"}(Ux||(Ux={}));function Qie(t,e){const r=t.vertex;switch(t.attributes.add(E.SIDENESS,"vec2"),e.mode===Dn.MIXED?r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
float type;
};`):r.code.add(w`struct UnpackedAttributes {
vec2 sideness;
vec2 sidenessNorm;
float lineWidthPixels;
float extensionLengthPixels;
};`),e.mode){case Dn.MIXED:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float fType = component.type;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
if (fType <= 0.0) {
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
}
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels, fType);
}`);break;case Dn.SKETCH:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
extensionLengthPixels *= variantExtension * 2.0 - 1.0;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Dn.SOLID:r.code.add(w`UnpackedAttributes unpackAttributes(ComponentData component) {
vec2 sidenessNorm = sideness;
vec2 sideness = sidenessNorm * 2.0 - 1.0;
float extensionLengthPixels = component.extensionLength;
float lineWidth = component.lineWidth;
return UnpackedAttributes(sideness, sidenessNorm, lineWidth, extensionLengthPixels);
}`);break;case Dn.COUNT:break;default:e.mode}}function JPt(t,e){const r=t.vertex;switch(t.include(Qie,e),e.mode){case Dn.SOLID:r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return 0.0;
}`);break;case Dn.SKETCH:r.uniforms.add(new dT("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
return strokesAmplitude;
}`);break;case Dn.MIXED:r.uniforms.add(new dT("strokesAmplitude",i=>i.strokesTexture.amplitude)),r.code.add(w`float calculateLineAmplitude(UnpackedAttributes unpackedAttributes) {
float type = unpackedAttributes.type;
if (type <= 0.0) {
return strokesAmplitude;
}
else {
return 0.0;
}
}`)}}function QPt(t,e){t.include(Qie,e);const{vertex:r,fragment:i}=t;switch(YPt(e)&&(r.uniforms.add(new Nd("strokesTexture",s=>s.strokesTexture.texture)),r.uniforms.add(new dT("strokesLog2Resolution",s=>Math.log2(s.strokesTexture.resolution)),new dT("strokeVariants",s=>s.strokesTexture.variants)),t.varyings.add("vStrokeUV","vec2"),i.uniforms.add(new Nd("strokesTexture",s=>s.strokesTexture.texture),new dT("strokesNormalizationScale",s=>s.strokesTexture.normalizationScale)),r.code.add(w`void calculateStyleOutputsSketch(float lineLength, UnpackedAttributes unpackedAttributes) {
vec2 sidenessNorm = unpackedAttributes.sidenessNorm;
float lineIndex = clamp(ceil(log2(lineLength)), 0.0, strokesLog2Resolution);
vStrokeUV = vec2(exp2(lineIndex) * sidenessNorm.y, lineIndex * strokeVariants + variantStroke + 0.5) / vec2(textureSize(strokesTexture, 0));
vStrokeUV.x += variantOffset;
}`),t.fragment.include(Pu),i.code.add(w`float calculateLineOffsetSketch() {
float offsetNorm = rgba2float(texture(strokesTexture, vStrokeUV));
return (offsetNorm - 0.5) * strokesNormalizationScale;
}
float calculateLinePressureSketch() {
return rgba2float(texture(strokesTexture, vStrokeUV + vec2(0.0, 0.5)));
}`)),e.mode){case Dn.SOLID:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes) {}`),i.code.add(w`float calculateLineOffset() {
return 0.0;
}
float calculateLinePressure() {
return 1.0;
}`);break;case Dn.SKETCH:r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}`),i.code.add(w`float calculateLineOffset() {
return calculateLineOffsetSketch();
}
float calculateLinePressure() {
return calculateLinePressureSketch();
}`);break;case Dn.MIXED:t.varyings.add("vType","float"),r.code.add(w`void calculateStyleOutputs(UnpackedAttributes unpackedAttributes)
{
vType = unpackedAttributes.type;
if (unpackedAttributes.type <= 0.0) {
calculateStyleOutputsSketch(vLineLengthPixels, unpackedAttributes);
}
}`),i.code.add(w`float calculateLineOffset() {
if (vType <= 0.0) {
return calculateLineOffsetSketch();
}
else {
return 0.0;
}
}
float calculateLinePressure() {
if (vType <= 0.0) {
return calculateLinePressureSketch();
}
else {
return 1.0;
}
}`)}}function KPt(t){const e=new Cr,{vertex:r,fragment:i}=e;return t.legacy&&r.uniforms.add(new Yye("model"),new Yye("localView")),e.include(qPt,t),e.include(XPt,t),e.include(JPt,t),e.include(Qie,t),e.include(QPt,t),e.include(Bs,t),e.include(ZPt,t),e.include(WPt,t),e.include(Ah,t),e.varyings.add("vColor","vec4"),e.varyings.add("vRadius","float"),e.varyings.add("vPosition","vec3"),e.varyings.add("vWorldPosition","vec3"),e.varyings.add("vViewPos","vec3"),e.varyings.add("vLineLengthPixels","float"),e.varyings.add("vSizeFalloffFactor","float"),r.uniforms.add(new Pr("pixelToNDC",(s,n)=>hr(e$t,2/n.camera.fullViewport[2],2/n.camera.fullViewport[3])),new cr("viewport",(s,n)=>n.camera.fullViewport),new Ie("pixelRatio",(s,n)=>n.camera.pixelRatio)),e.attributes.add(E.POSITION0,"vec3"),e.attributes.add(E.POSITION1,"vec3"),e.attributes.add(E.VARIANTOFFSET,"float"),e.attributes.add(E.VARIANTSTROKE,"float"),e.attributes.add(E.VARIANTEXTENSION,"float"),r.code.add(w`
    const float opaqueCutoff = 1.0 / 255.0;

    void calculateGeometricOutputs(vec3 viewPosV0, vec3 viewPosV1, vec3 worldPosV0, vec3 worldPosV1, vec3 worldNormal, UnpackedAttributes unpackedAttributes) {
      vec2 sideness = unpackedAttributes.sideness;
      vec2 sidenessNorm = unpackedAttributes.sidenessNorm;

      vWorldPosition = mix(worldPosV0, worldPosV1, sidenessNorm.y).xyz;

      vec3 viewPos = mix(viewPosV0, viewPosV1, sidenessNorm.y);
      vViewPos = viewPos;

      vec4 projPosV0 = projFromViewPosition(viewPosV0);
      vec4 projPosV1 = projFromViewPosition(viewPosV1);
      vec4 projPos = projFromViewPosition(viewPos);

      vec3 screenSpaceLineNDC = (projPosV1.xyz / projPosV1.w - projPosV0.xyz / projPosV0.w);
      vec2 ndcToPixel = viewport.zw * 0.5;
      vec2 screenSpaceLinePixels = screenSpaceLineNDC.xy * ndcToPixel;
      float lineLengthPixels = length(screenSpaceLinePixels);

      float dzPerPixel = screenSpaceLineNDC.z / lineLengthPixels;
      vec2 screenSpaceDirection = screenSpaceLinePixels / lineLengthPixels;
      vec2 perpendicularScreenSpaceDirection = vec2(screenSpaceDirection.y, -screenSpaceDirection.x) * sideness.x;

      float falloffFactor = distanceBasedPerspectiveFactor(-viewPos.z) * pixelRatio;
      float lineWidthPixels = unpackedAttributes.lineWidthPixels * falloffFactor;

      float extensionLengthPixels = calculateExtensionLength(unpackedAttributes.extensionLengthPixels, lineLengthPixels) * falloffFactor;
      float lineAmplitudePixels = calculateLineAmplitude(unpackedAttributes) * pixelRatio;

      vSizeFalloffFactor = falloffFactor;

      float lineWidthAndAmplitudePixels = lineWidthPixels + lineAmplitudePixels + lineAmplitudePixels;
      float extendedLineLengthPixels = lineLengthPixels + extensionLengthPixels + extensionLengthPixels;

      ${t.antialiasing?w`
        const float aaPaddingPixels = 1.0;

        // Line size with padding
        float halfAAPaddedLineWidthAndAmplitudePixels = lineWidthAndAmplitudePixels * 0.5 + aaPaddingPixels;
        float aaPaddedRoundedCapSizePixels = lineWidthPixels * 0.5 + aaPaddingPixels;`:w`
        float halfAAPaddedLineWidthAndAmplitudePixels = max(lineWidthAndAmplitudePixels, 1.0) * 0.5;
        float aaPaddedRoundedCapSizePixels = max(lineWidthPixels, 1.0) * 0.5;`}

      // Half line width in NDC including padding for anti aliasing
      vec2 halfAAPaddedLineWidthAndAmplitudeNDC = halfAAPaddedLineWidthAndAmplitudePixels * pixelToNDC;
      vec2 aaPaddedRoundedCapSizeNDC = aaPaddedRoundedCapSizePixels * pixelToNDC;
      vec2 extensionLengthNDC = extensionLengthPixels * pixelToNDC;

      // Compute screen space position of vertex, offsetting for line size and end caps
      vec2 ndcOffset = (
          screenSpaceDirection * sideness.y * (aaPaddedRoundedCapSizeNDC + extensionLengthNDC)
        + perpendicularScreenSpaceDirection * halfAAPaddedLineWidthAndAmplitudeNDC
      );

      projPos.xy += ndcOffset * projPos.w;
      projPos.z += (dzPerPixel * (aaPaddedRoundedCapSizePixels + extensionLengthPixels)) * sideness.y * projPos.w;

      projPos = adjustProjectedPosition(projPos, worldNormal, 1.0 + max((lineWidthAndAmplitudePixels - 1.0) * 0.5, 0.0));

      // Line length with end caps
      float aaPaddedLineWithCapsLengthPixels = extendedLineLengthPixels + aaPaddedRoundedCapSizePixels + aaPaddedRoundedCapSizePixels;

      float pixelPositionAlongLine = aaPaddedLineWithCapsLengthPixels * sidenessNorm.y - aaPaddedRoundedCapSizePixels;

      // Position in pixels with origin at first vertex of line segment
      vPosition = vec3(
        halfAAPaddedLineWidthAndAmplitudePixels * sideness.x,
        pixelPositionAlongLine,
        pixelPositionAlongLine / extendedLineLengthPixels
      );

      // The line width radius in pixels
      vRadius = lineWidthPixels * 0.5;
      vLineLengthPixels = extendedLineLengthPixels;

      // discard short edges below a certain length threshold
      ${t.mode===Dn.SKETCH?w`
        if (lineLengthPixels <= 3.0) {
          gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
          return;
        }`:t.mode===Dn.MIXED?w`
        if (lineLengthPixels <= 3.0 && unpackedAttributes.type <= 0.0) {
           gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
           return;
        }`:""}
      gl_Position = projPos;
    }

    void main() {
      ComponentData component = readComponentData();
      UnpackedAttributes unpackedAttributes = unpackAttributes(component);

      vec3 worldPosV0, worldPosV1, viewPosV0, viewPosV1;
      worldAndViewFromModelPosition(position0, component.verticalOffset, worldPosV0, viewPosV0);
      worldAndViewFromModelPosition(position1, component.verticalOffset, worldPosV1, viewPosV1);

      // Component color
      vColor = component.color;

      // Discard fully transparent edges
      if (vColor.a < opaqueCutoff) {
        gl_Position = vec4(10.0, 10.0, 10.0, 1.0);
        return;
      }

      if (discardNonSilhouetteEdges(viewPosV0, worldPosV0)) {
        return;
      }

      // General geometric computation for all types of edges
      calculateGeometricOutputs(viewPosV0, viewPosV1, worldPosV0, worldPosV1, worldNormal(), unpackedAttributes);

      // Specific computation for different edge styles
      calculateStyleOutputs(unpackedAttributes);
    }
  `),i.code.add(w`
    vec2 lineWithCapsDistance(float radius, vec2 position, float lineLength) {
      float positionX = position.x - calculateLineOffset();

      if (radius < 1.0) {
        float coverageX = clamp(min(radius, positionX + 0.5) - max(-radius, positionX - 0.5), 0.0, 1.0);
        float coverageY = clamp(min(lineLength, position.y + 0.5) - max(0.0, position.y - 0.5), 0.0, 1.0);
        return vec2(0.5 - min(coverageX, coverageY), 0.0);
      }
      else {
        // Between -radius -> 0 for start cap, 0 for line, 0 -> radius
        float positionOnCap = position.y - clamp(position.y, 0.0, lineLength);

        vec2 lineToPosition = vec2(positionX, positionOnCap);
        return vec2(length(lineToPosition) - radius, positionOnCap / radius);
      }
    }

    void main() {
      ${t.hasMultipassTerrain?"terrainDepthTest(gl_FragCoord, vViewPos.z);":""}
      float radius = vRadius * calculateLinePressure();

      vec2 distance = lineWithCapsDistance(radius, vPosition.xy, vLineLengthPixels);
      float coverage = clamp(0.5 - distance.x, 0.0, 1.0);

      discardByCoverage(radius, coverage);
      discardBySlice(vWorldPosition);

      fragColor = vec4(vColor.rgb, vColor.a * coverage);
    }
  `),e}const e$t=Pe();let Yye=class extends Ps{constructor(e){super(e,"mat4")}};const t$t=Object.freeze(Object.defineProperty({__proto__:null,build:KPt},Symbol.toStringTag,{value:"Module"}));let HFe=class qFe extends Ur{initializeProgram(e){return new Lr(e.rctx,qFe.shader.get().build(this.configuration),rFe)}initializePipeline(e){return e.blendMinMax?It({blending:ca(Te.ONE,Te.ONE,Te.ZERO,Te.ONE,Eg.ADD,e.blendMinMax.MAX),depthTest:{func:ci.LEQUAL},colorWrite:Wt}):It({depthTest:{func:ci.LEQUAL},depthWrite:Ac,colorWrite:Wt})}};HFe.shader=new $r(t$t,()=>J(()=>import("./EdgeShader.glsl-050b1d15.js"),[],import.meta.url));let Nm=class extends Ea{constructor(){super(...arguments),this.mode=Dn.SOLID,this.hasSlicePlane=!1,this.silhouette=!1,this.legacy=!1,this.antialiasing=!1,this.doublePrecisionRequiresObfuscation=!1,this.hasMultipassTerrain=!1,this.cullAboveGround=!1,this.spherical=!1}};u([B({count:Dn.COUNT})],Nm.prototype,"mode",void 0),u([B()],Nm.prototype,"hasSlicePlane",void 0),u([B()],Nm.prototype,"silhouette",void 0),u([B()],Nm.prototype,"legacy",void 0),u([B()],Nm.prototype,"antialiasing",void 0),u([B()],Nm.prototype,"doublePrecisionRequiresObfuscation",void 0),u([B()],Nm.prototype,"hasMultipassTerrain",void 0),u([B()],Nm.prototype,"cullAboveGround",void 0),u([B()],Nm.prototype,"spherical",void 0);const r$t=8,mj=128,i$t={type:"uber",hasSlicePlane:!1,strokesTexture:null,legacy:!0,spherical:!0},s$t={solid:Dn.SOLID,sketch:Dn.SKETCH,uber:Dn.MIXED};let gj=class WFe{constructor(e,r,i){this._rctx=e,this._shaderTechniqueRepository=r,this._configuration=new Nm,this.refCount=0,this._renderables=new Set,this._sortedRenderables={[Xt.TRANSPARENT]:{[Xt.TRANSPARENT]:new qt,[Xt.OPAQUE]:new qt},[Xt.OPAQUE]:{[Xt.TRANSPARENT]:new qt,[Xt.OPAQUE]:new qt}},this._renderablesDirty=!1,this._drawParameters=new GPt,this._settings={...i$t,...i},this.key=WFe.getKey(this._settings.type,this._settings.hasSlicePlane,this._settings.legacy);const s=this._settings.strokesTexture.variants;this.writerSettings={variants:s,reducedPrecision:bi.TESTS_DISABLE_OPTIMIZATIONS},this._configuration.legacy=this._settings.legacy,this._configuration.mode=s$t[this._settings.type],this._configuration.silhouette=!1,this._configuration.antialiasing=!!this._rctx.capabilities.blendMinMax,this._configuration.hasSlicePlane=this._settings.hasSlicePlane,this._configuration.doublePrecisionRequiresObfuscation=e.driverTest.doublePrecisionRequiresObfuscation.result,this._configuration.spherical=i.spherical}dispose(){this._technique=as(this._technique)}addRenderable(e){this._renderables.add(e),this._renderablesDirty=!0}removeRenderable(e){this._renderables.delete(e),this._renderablesDirty=!0}setRenderablesDirty(){this._renderablesDirty=!0}forEachRenderable(e,r){if(this._renderablesDirty&&this._sortRenderables(),r!==Xt.INVISIBLE){const i=this._sortedRenderables[r];i[Xt.TRANSPARENT].forAll(e),i[Xt.OPAQUE].forAll(e)}}updateTechnique(e,r){return this._configuration.hasMultipassTerrain=!!e.multipassTerrain.enabled,this._configuration.cullAboveGround=!!e.multipassTerrain.cullAboveGround,this._configuration.silhouette=r,this._technique=this._shaderTechniqueRepository.releaseAndAcquire(HFe,this._configuration,this._technique),this._technique}bindRegularEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!1),e,r)}bindSilhouetteEdges(e,r){return this._lastOriginId=null,this._rctx.bindTechnique(this.updateTechnique(r,!0),e,r)}renderRegularEdges(e,r,i,s,n){this._render(e,r,r.regular.vao,i,s,n)}renderSilhouetteEdges(e,r,i,s,n){this._render(e,r,r.silhouette.vao,i,s,n)}_render(e,r,i,s,n,o){o>0&&(this._bindDraw(e,r,s,n),this._rctx.bindVAO(i),this._rctx.capabilities.instancing.drawArraysInstanced(Ot.TRIANGLE_FAN,0,4,o))}_bindDraw(e,r,i,s){if(this._drawParameters.componentDataTexture=r.components.buffer.textureBuffer.texture,this._drawParameters.strokesTexture=this._settings.strokesTexture,"origin"in r.transform)this._lastOriginId!==r.transform.origin.origin.id&&(e.setUniformMatrix4fv("localView",r.transform.origin.viewMatrix),this._lastOriginId=r.transform.origin.origin.id),e.setUniformMatrix4fv("model",r.transform.modelMatrix),this._drawParameters.slicePlaneLocalOrigin=r.transform.origin.origin.vec3;else{const n=new i9(r.transform.position),o=Wd(Jye,gS(Jye,r.transform.rotationScale));this._drawParameters.transformWorldFromModelTL=n.low,this._drawParameters.transformWorldFromModelTH=n.high,this._drawParameters.transformWorldFromModelRS=r.transform.rotationScale,this._drawParameters.transformNormalGlobalFromModel=o;const a=s.camera.viewInverseTransposeMatrix;ie(this._drawParameters.slicePlaneLocalOrigin,a[3],a[7],a[11])}e.bindDraw(this._drawParameters,s,i)}_sortRenderables(){this._renderablesDirty=!1,this._sortedRenderables[Xt.TRANSPARENT][Xt.TRANSPARENT].clear(),this._sortedRenderables[Xt.TRANSPARENT][Xt.OPAQUE].clear(),this._sortedRenderables[Xt.OPAQUE][Xt.TRANSPARENT].clear(),this._sortedRenderables[Xt.OPAQUE][Xt.OPAQUE].clear(),this._renderables.forEach(r=>{r.objectTransparency!==Xt.INVISIBLE&&r.edgeTransparency!==Xt.INVISIBLE&&this._sortedRenderables[r.objectTransparency][r.edgeTransparency].push(r)});const e=(r,i)=>"origin"in r.transform?"origin"in i.transform?r.transform.origin.origin.id<i.transform.origin.origin.id?-1:r.transform.origin.origin.id>i.transform.origin.origin.id?1:0:1:0;this._sortedRenderables[Xt.TRANSPARENT][Xt.TRANSPARENT].sort(e),this._sortedRenderables[Xt.TRANSPARENT][Xt.OPAQUE].sort(e),this._sortedRenderables[Xt.OPAQUE][Xt.TRANSPARENT].sort(e),this._sortedRenderables[Xt.OPAQUE][Xt.OPAQUE].sort(e)}static getKey(e,r,i){return`edges-t:${e}:${r}:${i}`}};const Jye=Tc();function HJt(t,e){return e.push(t.buffer),{buffer:t.buffer,layout:new kdt(t.layout)}}function uF(t){return new tMe(t.layout).createView(t.buffer)}let n$t=class extends tNe{constructor(e){super("EdgeProcessingWorker","extract",{extract:r=>[r.dataBuffer],extractComponentsEdgeLocations:r=>[r.dataBuffer],extractEdgeLocations:r=>[r.dataBuffer]},e)}async process(e,r,i){if(i)return JMt(e);const s=await this.invoke(new yj(e),r);return this._unpackOutput(s)}async extractEdgeLocations(e,r){const i=await this.invokeMethod("extractEdgeLocations",new yj(e),r);return uF(i)}async extractComponentsEdgeLocations(e,r){const i=await this.invokeMethod("extractComponentsEdgeLocations",new yj(e),r);return uF(i)}_unpackOutput(e){return{regular:{instancesData:uF(e.regular.instancesData),lodInfo:{lengths:new Float32Array(e.regular.lodInfo.lengths)}},silhouette:{instancesData:uF(e.silhouette.instancesData),lodInfo:{lengths:new Float32Array(e.silhouette.lodInfo.lengths)}},averageEdgeLength:e.averageEdgeLength}}},yj=class{constructor(e){this.dataBuffer=e.data.buffer,this.writerSettings=e.writerSettings,this.skipDeduplicate=e.skipDeduplicate,this.indices=Cf(e.indices)?e.indices:e.indices.buffer,this.indicesType=Cf(e.indices)?"Array":S6(e.indices)?"Uint32Array":"Uint16Array",this.indicesLength=e.indicesLength}};function o$t(t){const r=HR.resolution,i=r/2,s=new Uint8Array(4*r*r),n=4*r*i,o=HR.amplitude,a=2*o,l=4*r,c=Math.log2(r)+1,h=HR.strokes.length;let p=(c-1)*h*l;for(const{distance:g,pressure:_}of HR.strokes){let v=g,b=_,x=p;for(let T=0;T<c;T++){T!==0&&(v=Qye(v,NP.DISTANCE),b=Qye(b,NP.PRESSURE));for(let S=0;S<HR.resolution;S++){const O=.5+(v?v[S%v.length]/a:0),A=b?b[S%b.length]:1;xP(O,s,x),xP(A,s,x+n),x+=4}x-=l*(h+1)}p+=l}const f=new Sr;f.width=f.height=r;const m=new Rt(t,f,s);return new l$t(r,a,o,h,m)}function Qye(t,e){if(!t)return null;const r=t.length/2,i=a$t*r,s=new Array(r);let n=0;const o=e===NP.PRESSURE;for(let a=0;a<t.length;a+=2){const l=(t[a]+t[a+1])/2;s[n++]=o?Math.min(i,1-(1-l)*Kye):Math.min(i,l*Kye)}return s}var NP;(function(t){t[t.DISTANCE=0]="DISTANCE",t[t.PRESSURE=1]="PRESSURE"})(NP||(NP={}));const a$t=.1,Kye=.5;let l$t=class{constructor(e,r,i,s,n){this.resolution=e,this.normalizationScale=r,this.amplitude=i,this.variants=s,this.texture=n}dispose(){this.texture=ze(this.texture)}};const HR={amplitude:8,resolution:256,strokes:[{distance:[-1.59027,-1.59426,-1.59674,-1.59766,-1.59702,-1.59479,-1.59095,-1.5855,-1.57843,-1.56973,-1.55942,-1.5475,-1.53398,-1.5189,-1.50226,-1.4841,-1.46446,-1.44337,-1.42088,-1.39703,-1.37188,-1.34547,-1.31786,-1.28912,-1.2593,-1.22847,-1.19668,-1.16402,-1.13053,-1.09629,-1.06137,-1.02582,-.98972,-.95313,-.91611,-.87872,-.84102,-.80306,-.76488,-.72654,-.68807,-.64952,-.61092,-.57232,-.53375,-.49527,-.45692,-.41874,-.38078,-.34309,-.3057,-.26867,-.23204,-.19585,-.16015,-.12497,-.09036,-.05634,-.02296,.00977,.04183,.07321,.10389,.13386,.16313,.19169,.21956,.24672,.27321,.299,.32413,.34858,.37237,.3955,.41798,.43981,.461,.48154,.50145,.52073,.53939,.55744,.57488,.5917,.6079,.62347,.63837,.65259,.66609,.67885,.69083,.70201,.71235,.72183,.73042,.73812,.7449,.75076,.7557,.75973,.76284,.76507,.76642,.76692,.76659,.76545,.76352,.76083,.7574,.75324,.74837,.74279,.73652,.72959,.72199,.71377,.70493,.69553,.68558,.67515,.66426,.65298,.64135,.62944,.6173,.60499,.59257,.58008,.56759,.55513,.54275,.5305,.51842,.50654,.4949,.48353,.47246,.4617,.45128,.44121,.43149,.42213,.41313,.40448,.39617,.38818,.3805,.37309,.36594,.35902,.35229,.34572,.33927,.33292,.32663,.32035,.31407,.30774,.30135,.29486,.28824,.28148,.27454,.26739,.26002,.25241,.24454,.23639,.22796,.21922,.21016,.20076,.19098,.18082,.17023,.1592,.14768,.13566,.1231,.10996,.09624,.08188,.06688,.05121,.03485,.01778,0,-.0185,-.03771,-.05763,-.07824,-.09952,-.12144,-.14396,-.16706,-.19069,-.21481,-.23938,-.26436,-.28971,-.31539,-.34136,-.36759,-.39404,-.42067,-.44746,-.47437,-.50136,-.52839,-.55544,-.58248,-.60948,-.63642,-.66329,-.6901,-.71684,-.74352,-.77015,-.79675,-.82332,-.84988,-.87644,-.90301,-.92958,-.95615,-.98272,-1.00926,-1.03575,-1.06217,-1.08847,-1.11463,-1.1406,-1.16633,-1.19178,-1.2169,-1.24164,-1.26595,-1.28979,-1.31312,-1.3359,-1.35809,-1.37963,-1.4005,-1.42064,-1.44,-1.45853,-1.47616,-1.49285,-1.50853,-1.52313,-1.53659,-1.54886,-1.55986,-1.56955,-1.57788,-1.5848],pressure:[-.01365,-.00206,.01025,.02327,.03696,.05129,.06619,.08163,.09755,.11393,.1307,.14784,.16531,.18308,.20111,.21938,.23786,.25651,.2753,.29419,.31315,.33215,.35115,.37015,.38913,.40806,.42694,.44576,.46449,.48313,.50167,.5201,.53839,.55653,.57448,.59222,.60971,.62692,.6438,.66033,.67648,.69221,.70753,.72242,.73688,.75093,.76456,.77779,.79063,.80309,.81517,.82686,.83817,.84911,.85967,.86987,.87972,.88924,.89845,.90734,.91594,.92425,.93229,.94005,.94754,.95475,.96166,.96826,.97451,.9804,.98588,.99092,.99549,.99957,.99685,.99381,.99131,.98936,.98796,.98711,.98681,.98706,.98787,.98923,.99113,.99357,.99654,1,.99607,.99171,.98695,.98181,.97634,.97057,.96452,.95824,.95175,.94506,.93818,.93113,.92389,.91647,.90887,.90109,.89314,.88501,.87672,.86831,.85978,.85119,.84256,.83393,.82533,.8168,.80836,.80002,.79181,.78374,.77582,.7681,.76059,.75331,.74629,.73955,.73311,.72697,.72116,.71568,.71054,.70572,.70121,.697,.69304,.68931,.68576,.68236,.67905,.67582,.67262,.66941,.66619,.66291,.65957,.65613,.65259,.64892,.6451,.6411,.6369,.63248,.62783,.62295,.61783,.61247,.60688,.60104,.59498,.58868,.58216,.57542,.56845,.56125,.5538,.5461,.53813,.52986,.52129,.51239,.50316,.49359,.4837,.47349,.46299,.45223,.44124,.43005,.41869,.40719,.39557,.38386,.37207,.36023,.34836,.33648,.32464,.31287,.30119,.28963,.27822,.26698,.25594,.2451,.23448,.22409,.21391,.20394,.19415,.18452,.17503,.16565,.15636,.14713,.13794,.1288,.11968,.11058,.10151,.09247,.08346,.07447,.06552,.05659,.0477,.03885,.03007,.02137,.01278,.00433,-.00393,-.012,-.01983,-.02738,-.03463,-.04155,-.0481,-.05429,-.0601,-.06553,-.07057,-.07524,-.07954,-.08347,-.08703,-.09022,-.09303,-.09544,-.09744,-.09898,-.10004,-.10059,-.1006,-.10005,-.09892,-.0972,-.09487,-.09192,-.08833,-.08409,-.07918,-.07357,-.06724,-.06019,-.0524,-.04386,-.03455,-.02448]},{distance:[-3.46259,-3.47131,-3.47668,-3.47863,-3.47712,-3.4721,-3.46352,-3.45138,-3.43566,-3.41635,-3.39347,-3.36704,-3.33709,-3.30368,-3.26684,-3.22667,-3.18322,-3.1366,-3.08689,-3.0342,-2.97865,-2.92036,-2.85946,-2.79607,-2.73034,-2.66241,-2.59242,-2.52052,-2.44686,-2.37159,-2.29485,-2.2168,-2.13757,-2.05731,-1.97616,-1.89426,-1.81174,-1.72875,-1.64543,-1.56191,-1.47833,-1.39483,-1.3115,-1.22847,-1.14581,-1.06361,-.98193,-.90083,-.82036,-.74054,-.66141,-.583,-.50532,-.4284,-.35228,-.277,-.20261,-.12916,-.05672,.01463,.08485,.15384,.22153,.28784,.35269,.41602,.47776,.53787,.59629,.653,.70799,.76123,.81274,.86253,.9106,.95698,1.0017,1.04477,1.0862,1.126,1.16415,1.20065,1.23546,1.26857,1.29994,1.32953,1.35731,1.38321,1.40719,1.42921,1.44922,1.46719,1.48309,1.49691,1.50862,1.51825,1.52581,1.53133,1.53486,1.53644,1.53616,1.53409,1.53031,1.52493,1.51803,1.50972,1.50009,1.48924,1.47725,1.46421,1.45019,1.43527,1.4195,1.40295,1.38568,1.36778,1.34929,1.3303,1.31087,1.29108,1.27099,1.25066,1.23018,1.2096,1.18898,1.16838,1.14785,1.12745,1.10721,1.08719,1.06741,1.04791,1.02871,1.00986,.99136,.97324,.95551,.93819,.92127,.90476,.88866,.87296,.85767,.84277,.82823,.81406,.80022,.7867,.77346,.76049,.74774,.73519,.72278,.71049,.69827,.68606,.67381,.66145,.64893,.63618,.62313,.60973,.5959,.5816,.56675,.5513,.53516,.51826,.50053,.4819,.46231,.44169,.42002,.39725,.37336,.34834,.32219,.2949,.2665,.23698,.20638,.17469,.14193,.10809,.07316,.03714,0,-.03827,-.07772,-.11836,-.16022,-.20332,-.24768,-.29332,-.34024,-.38844,-.43788,-.48854,-.54036,-.59329,-.64724,-.70211,-.75782,-.81425,-.87128,-.92881,-.98674,-1.04498,-1.10346,-1.1621,-1.22086,-1.27969,-1.33854,-1.3974,-1.45625,-1.51511,-1.57396,-1.63283,-1.69173,-1.75067,-1.80968,-1.86875,-1.9279,-1.98712,-2.04639,-2.10568,-2.16495,-2.22416,-2.28322,-2.34208,-2.40063,-2.4588,-2.51647,-2.57354,-2.62989,-2.68543,-2.74002,-2.79357,-2.84597,-2.89711,-2.94689,-2.99521,-3.04195,-3.087,-3.13023,-3.17152,-3.21075,-3.24779,-3.28252,-3.3148,-3.34451,-3.37154,-3.39577,-3.41709,-3.43539,-3.45059],pressure:[.87183,.87151,.87129,.87118,.87117,.87128,.87149,.87182,.87225,.8728,.87347,.87424,.87513,.87613,.87723,.87845,.87978,.88122,.88276,.88441,.88616,.88801,.88996,.892,.89414,.89637,.89868,.90108,.90356,.90611,.90874,.91144,.91421,.91704,.91993,.92287,.92587,.92892,.93201,.93514,.93831,.94151,.94474,.94799,.95126,.95456,.95786,.96118,.9645,.96783,.97116,.97448,.9778,.98111,.98441,.9877,.99096,.99421,.99742,.99938,.99622,.9931,.99001,.98697,.98397,.98101,.97811,.97526,.97246,.96972,.96703,.96441,.96185,.95935,.95691,.95455,.95225,.95002,.94786,.94577,.94376,.94182,.93995,.93817,.93646,.93483,.93328,.93181,.93042,.92911,.92788,.92673,.92566,.92467,.92376,.92293,.92217,.92149,.92088,.92034,.91987,.91947,.91913,.91886,.91864,.91849,.91838,.91833,.91834,.91839,.91849,.91863,.91883,.91907,.91935,.91968,.92005,.92046,.92092,.92142,.92195,.92253,.92314,.9238,.92449,.92521,.92598,.92677,.9276,.92847,.92936,.93029,.93125,.93224,.93325,.9343,.93537,.93646,.93758,.93872,.93988,.94106,.94225,.94346,.94469,.94593,.94718,.94844,.94971,.95098,.95226,.95354,.95482,.9561,.95738,.95867,.95995,.96122,.9625,.96377,.96504,.9663,.96757,.96883,.97009,.97135,.97261,.97387,.97513,.9764,.97767,.97895,.98023,.98153,.98284,.98416,.98549,.98684,.98821,.9896,.99101,.99244,.99389,.99537,.99688,.99842,1,.99839,.99675,.99508,.99336,.99161,.98982,.98799,.98613,.98422,.98228,.98029,.97827,.97622,.97414,.97202,.96987,.9677,.96551,.9633,.96107,.95882,.95656,.9543,.95202,.94975,.94747,.94519,.94292,.94065,.93838,.93613,.93388,.93164,.92941,.9272,.92499,.9228,.92062,.91846,.91631,.91418,.91207,.90998,.90792,.90588,.90387,.90189,.89995,.89804,.89617,.89434,.89256,.89083,.88914,.88752,.88595,.88443,.88299,.88161,.8803,.87907,.87791,.87683,.87584,.87494,.87412,.8734,.87278,.87225]},{distance:[.39335,.43437,.47737,.52234,.56923,.61801,.66864,.72109,.7753,.83123,.88882,.94801,1.00875,1.07097,1.13461,1.1996,1.26586,1.33333,1.40193,1.47158,1.54221,1.61373,1.68607,1.75913,1.83284,1.90711,1.98186,2.05699,2.13243,2.20809,2.28387,2.35971,2.4355,2.51117,2.58663,2.66179,2.73658,2.81092,2.88473,2.95792,3.03043,3.10217,3.17308,3.24309,3.31211,3.3801,3.44697,3.51267,3.57712,3.64028,3.70208,3.76247,3.8214,3.87881,3.93467,3.98892,4.04152,4.09244,4.14164,4.18908,4.23474,4.27859,4.32061,4.36077,4.39905,4.43544,4.46992,4.50249,4.53314,4.56185,4.58864,4.61349,4.63642,4.65745,4.67657,4.69381,4.7092,4.72274,4.73447,4.74441,4.75259,4.75903,4.76376,4.76682,4.76822,4.768,4.76618,4.76279,4.75786,4.75142,4.74348,4.73409,4.72326,4.71102,4.69739,4.68241,4.6661,4.64849,4.6296,4.60948,4.58816,4.56567,4.54204,4.51732,4.49154,4.46473,4.43694,4.4082,4.37854,4.348,4.31662,4.28443,4.25145,4.21773,4.1833,4.14819,4.11243,4.07606,4.03912,4.00162,3.96361,3.92512,3.88618,3.84683,3.80708,3.76697,3.72653,3.68579,3.64478,3.60351,3.56202,3.52033,3.47845,3.43642,3.39425,3.35196,3.30957,3.2671,3.22455,3.18196,3.13933,3.09668,3.05402,3.01136,2.96873,2.92613,2.88357,2.84108,2.79865,2.75631,2.71407,2.67195,2.62994,2.58807,2.54634,2.50477,2.46338,2.42216,2.38114,2.34032,2.29971,2.25933,2.21916,2.17923,2.13954,2.10008,2.06087,2.02189,1.98316,1.94468,1.90644,1.86845,1.83069,1.79316,1.75586,1.71877,1.68189,1.6452,1.60868,1.57232,1.53611,1.50004,1.46407,1.4282,1.39241,1.35668,1.321,1.28535,1.24972,1.2141,1.17849,1.14286,1.10723,1.07158,1.03593,1.00028,.96464,.92902,.89344,.85793,.8225,.78719,.75203,.71705,.68231,.64784,.61369,.57991,.54656,.51368,.48134,.44959,.41849,.3881,.35848,.32967,.30174,.27474,.24872,.22373,.19982,.17702,.15539,.13497,.11579,.09791,.08137,.06621,.05248,.04022,.02948,.02029,.01271,.00677,.00252,0,-76e-5,27e-5,.00314,.00788,.01451,.02307,.03357,.04604,.0605,.07697,.09546,.11599,.13858,.16322,.18992,.21869,.24952,.28241,.31735,.35434],pressure:[.95248,.95236,.95228,.95223,.95222,.95224,.95231,.95241,.95256,.95274,.95296,.95322,.95352,.95385,.95423,.95465,.9551,.9556,.95613,.9567,.95731,.95796,.95864,.95936,.96012,.96091,.96173,.96259,.96348,.9644,.96535,.96633,.96734,.96838,.96944,.97053,.97164,.97277,.97393,.9751,.97629,.9775,.97873,.97997,.98122,.98249,.98376,.98505,.98634,.98763,.98893,.99023,.99154,.99284,.99414,.99544,.99673,.99802,.9993,.99942,.99816,.99691,.99568,.99445,.99324,.99205,.99087,.98972,.98858,.98746,.98636,.98528,.98423,.9832,.98219,.98121,.98025,.97931,.9784,.97752,.97666,.97582,.97501,.97423,.97347,.97274,.97203,.97135,.9707,.97007,.96948,.9689,.96836,.96784,.96735,.96689,.96646,.96605,.96567,.96533,.965,.96471,.96445,.96421,.964,.96382,.96367,.96355,.96346,.96339,.96335,.96334,.96336,.9634,.96348,.96358,.9637,.96385,.96403,.96423,.96446,.96471,.96499,.96529,.96561,.96595,.96631,.96669,.96709,.96751,.96795,.9684,.96887,.96935,.96984,.97035,.97087,.9714,.97194,.97249,.97304,.97361,.97418,.97476,.97534,.97592,.97651,.97711,.9777,.9783,.9789,.9795,.9801,.9807,.9813,.9819,.9825,.98309,.98369,.98428,.98486,.98545,.98603,.98661,.98718,.98775,.98832,.98888,.98944,.99,.99056,.99112,.99167,.99223,.99279,.99335,.99392,.99449,.99507,.99565,.99624,.99684,.99745,.99807,.9987,.99934,1,.99933,.99866,.99797,.99727,.99656,.99583,.9951,.99435,.99359,.99283,.99205,.99126,.99046,.98966,.98885,.98803,.9872,.98637,.98554,.9847,.98387,.98303,.98219,.98134,.9805,.97967,.97883,.978,.97717,.97634,.97552,.97471,.97389,.97309,.97229,.9715,.97071,.96993,.96915,.96838,.96762,.96687,.96612,.96539,.96466,.96395,.96324,.96255,.96187,.9612,.96055,.95991,.95929,.95869,.95811,.95754,.957,.95648,.95599,.95552,.95508,.95467,.95428,.95393,.9536,.95331,.95305,.95283,.95264]},{distance:[2.85606,2.86149,2.86432,2.8645,2.862,2.85686,2.84912,2.83886,2.82618,2.81117,2.79393,2.77456,2.75314,2.72975,2.70447,2.67734,2.64844,2.61784,2.58564,2.55196,2.5169,2.48057,2.44305,2.40438,2.36462,2.32383,2.28208,2.23943,2.19591,2.15153,2.10628,2.06016,2.01321,1.96548,1.91702,1.86793,1.8183,1.76829,1.71803,1.66767,1.61737,1.56726,1.51746,1.46803,1.41902,1.37044,1.32228,1.27452,1.22716,1.18023,1.13376,1.08781,1.04244,.99769,.95357,.91003,.86701,.82447,.78238,.74069,.69938,.65836,.61758,.57699,.53656,.49627,.45611,.41611,.37632,.33683,.29776,.25924,.22141,.18441,.14839,.11346,.07972,.04727,.01619,-.01348,-.0417,-.0684,-.09351,-.11698,-.13875,-.1588,-.17713,-.19381,-.20889,-.22242,-.23444,-.24501,-.25421,-.26216,-.26897,-.27473,-.27951,-.28336,-.28631,-.28836,-.28948,-.28963,-.28873,-.28673,-.28355,-.27916,-.27354,-.26673,-.25878,-.2498,-.23992,-.22929,-.21802,-.20623,-.19398,-.18134,-.16836,-.1551,-.14163,-.12809,-.11461,-.1013,-.08826,-.07557,-.06335,-.0517,-.04077,-.03065,-.02143,-.01321,-.00606,0,.00496,.00888,.01181,.01385,.01511,.0157,.01574,.01533,.01458,.01358,.0124,.01112,.00979,.00851,.00738,.0065,.006,.00596,.00646,.00754,.00924,.01161,.01471,.01858,.02323,.02865,.03481,.04169,.0493,.05765,.06677,.07671,.08754,.09934,.11222,.12628,.14159,.15823,.17624,.19561,.21632,.23828,.26142,.28563,.31083,.33696,.36397,.39185,.42057,.4501,.48036,.51125,.54264,.5744,.60646,.63871,.67105,.70337,.73556,.76751,.79918,.83048,.86139,.8919,.92202,.95184,.98144,1.01094,1.04045,1.0701,1.10002,1.13029,1.16103,1.1923,1.22416,1.25664,1.28979,1.32364,1.35824,1.39363,1.42985,1.4669,1.50475,1.54332,1.58252,1.62227,1.6625,1.70312,1.744,1.78501,1.82598,1.8668,1.90734,1.94754,1.98732,2.02666,2.06555,2.10402,2.1421,2.17985,2.2173,2.25448,2.29139,2.328,2.36424,2.4,2.43515,2.46955,2.50309,2.53565,2.56717,2.59761,2.62692,2.65505,2.68191,2.7074,2.73138,2.75375,2.7744,2.79324,2.81017,2.82504,2.83772,2.8481],pressure:[.22758,.23641,.24578,.25568,.26609,.27699,.28835,.30016,.31237,.32495,.33789,.35113,.36466,.37843,.39241,.40658,.4209,.43535,.44989,.4645,.47916,.49385,.50853,.5232,.53784,.55243,.56696,.58141,.59578,.61004,.62419,.63821,.65209,.6658,.67934,.69268,.70582,.71873,.73139,.7438,.75594,.76779,.77935,.79061,.80156,.81221,.82254,.83258,.84231,.85176,.86091,.86978,.87837,.88669,.89473,.9025,.91,.91725,.92425,.931,.93752,.9438,.94985,.95566,.96124,.96658,.97168,.97652,.98109,.98539,.98939,.99309,.99646,.99949,.99783,.99552,.99361,.99209,.99098,.99029,.99003,.99019,.99079,.99181,.99324,.9951,.99735,1,.99698,.99361,.98992,.98592,.98163,.97709,.97231,.96731,.96212,.95676,.95122,.94554,.93973,.93378,.92773,.92157,.91532,.90899,.90258,.89612,.88961,.88308,.87653,.87,.8635,.85705,.85068,.8444,.83823,.83219,.82628,.82052,.81493,.80952,.8043,.79929,.7945,.78994,.78561,.78151,.77765,.77402,.77062,.76742,.76443,.76161,.75896,.75645,.75406,.75175,.74951,.7473,.74511,.74289,.74064,.73833,.73592,.73341,.73078,.728,.72507,.72197,.71869,.71522,.71156,.70769,.70363,.69936,.69489,.69021,.68533,.68023,.67492,.66939,.66363,.65765,.65145,.64501,.63833,.63143,.62428,.61691,.60931,.60148,.59344,.58521,.57679,.5682,.55948,.55063,.54167,.53264,.52354,.51439,.50522,.49603,.48686,.47773,.46865,.45964,.45072,.44192,.43324,.42469,.41629,.40804,.39994,.392,.3842,.37655,.36903,.36164,.35437,.3472,.34012,.33312,.3262,.31933,.31251,.30574,.299,.2923,.28563,.27899,.27239,.26583,.25933,.25288,.24652,.24025,.2341,.22808,.22221,.21653,.21104,.20576,.20072,.19592,.19138,.18712,.18313,.17943,.17602,.17292,.17013,.16766,.16551,.16369,.16222,.1611,.16036,.16001,.16007,.16055,.16148,.16286,.16471,.16705,.16988,.17321,.17706,.18144,.18636,.19182,.19785,.20443,.21158,.2193]},{distance:[-2.31317,-2.3191,-2.32189,-2.32154,-2.31811,-2.31174,-2.30254,-2.29062,-2.27609,-2.25904,-2.23954,-2.21767,-2.19355,-2.16732,-2.13907,-2.10885,-2.07672,-2.04268,-2.00677,-1.96911,-1.92985,-1.88914,-1.84713,-1.80397,-1.75979,-1.71467,-1.66864,-1.62171,-1.57395,-1.52546,-1.47625,-1.42628,-1.3755,-1.32384,-1.27131,-1.218,-1.16408,-1.10972,-1.05508,-1.00031,-.94551,-.89077,-.83615,-.7817,-.72757,-.6739,-.62076,-.56821,-.51625,-.46484,-.41397,-.36366,-.314,-.26506,-.21689,-.16957,-.12316,-.07766,-.03301,.01085,.05399,.09643,.13827,.17967,.22079,.26176,.30265,.34342,.38397,.42414,.46381,.50285,.54115,.57863,.61524,.65093,.6856,.71914,.75153,.78275,.81283,.84182,.86972,.89651,.92208,.94634,.96919,.99052,1.01025,1.02835,1.04484,1.05976,1.07309,1.08479,1.09492,1.1036,1.11096,1.11714,1.12224,1.12627,1.12916,1.13083,1.13125,1.13036,1.12816,1.12466,1.11992,1.11397,1.10677,1.09827,1.08849,1.07746,1.06527,1.05203,1.03786,1.02283,1.00695,.99025,.97279,.9546,.93573,.9163,.8965,.8765,.85647,.83652,.81687,.79775,.77939,.76199,.74568,.73049,.71635,.70316,.69082,.67925,.66834,.65804,.64831,.63911,.63032,.62184,.61363,.60564,.59788,.59036,.58308,.57597,.5689,.56177,.55447,.5469,.53896,.53062,.5219,.51283,.5034,.49355,.48335,.47287,.46223,.45154,.44085,.43012,.41923,.40805,.39648,.38441,.37176,.35849,.34458,.32999,.31461,.29833,.28109,.26288,.2437,.22361,.20265,.18082,.15807,.13434,.1096,.0838,.0569,.02894,0,-.0298,-.0604,-.09173,-.12364,-.15594,-.18843,-.22092,-.25331,-.28559,-.31781,-.35006,-.38244,-.41502,-.44785,-.48098,-.5144,-.54811,-.58218,-.61666,-.65153,-.68677,-.72232,-.75807,-.79397,-.83002,-.86628,-.90281,-.93968,-.97693,-1.01465,-1.05282,-1.09139,-1.13031,-1.16956,-1.20917,-1.24905,-1.28907,-1.32908,-1.36891,-1.40844,-1.44765,-1.48658,-1.52527,-1.56376,-1.60206,-1.64016,-1.67801,-1.71552,-1.75264,-1.78936,-1.8257,-1.86161,-1.89702,-1.93182,-1.96584,-1.99894,-2.03102,-2.06203,-2.0919,-2.12056,-2.14794,-2.17397,-2.19852,-2.22138,-2.24235,-2.26129,-2.27805,-2.29243,-2.30422],pressure:[.9681,.97424,.98046,.98674,.99309,.9995,.99404,.98754,.981,.97444,.96785,.96124,.95462,.94801,.94139,.93479,.92822,.92167,.91515,.90868,.90225,.89589,.88959,.88336,.87722,.87115,.86519,.85932,.85356,.84792,.84239,.83699,.83173,.8266,.82162,.81679,.81211,.80759,.80324,.79906,.79505,.79121,.78756,.78409,.78081,.77771,.77481,.77211,.76959,.76728,.76516,.76324,.76153,.76001,.75869,.75757,.75665,.75593,.7554,.75507,.75493,.75498,.75523,.75565,.75627,.75706,.75803,.75917,.76049,.76197,.76361,.76541,.76737,.76947,.77172,.77409,.7766,.77923,.78198,.78484,.7878,.79086,.79401,.79724,.80055,.80394,.8074,.81092,.8145,.81813,.82182,.82556,.82934,.83317,.83703,.84093,.84487,.84884,.85284,.85687,.86094,.86503,.86915,.87329,.87746,.88166,.88587,.89011,.89436,.89863,.90291,.9072,.91149,.91579,.92009,.92438,.92867,.93295,.9372,.94144,.94566,.94985,.954,.95812,.96219,.96623,.97021,.97415,.97802,.98184,.9856,.9893,.99293,.9965,1,.99657,.9932,.98991,.98668,.98352,.98042,.97738,.9744,.97148,.9686,.96577,.96298,.96023,.95751,.95482,.95214,.94949,.94684,.9442,.94156,.93892,.93627,.93361,.93094,.92825,.92555,.92284,.9201,.91735,.91458,.91179,.90899,.90616,.90332,.90047,.8976,.89472,.89183,.88893,.88603,.88314,.88024,.87735,.87448,.87162,.86878,.86597,.86319,.86044,.85774,.85508,.85247,.84993,.84744,.84503,.84269,.84042,.83825,.83616,.83417,.83227,.83048,.8288,.82724,.82578,.82445,.82324,.82215,.82119,.82037,.81967,.81911,.81868,.81839,.81824,.81823,.81835,.81862,.81903,.81957,.82026,.82109,.82206,.82317,.82443,.82583,.82737,.82906,.83089,.83287,.83499,.83726,.83968,.84223,.84494,.84778,.85077,.8539,.85717,.86058,.86412,.86781,.87163,.87559,.87968,.88391,.88826,.89275,.89737,.90211,.90698,.91198,.91709,.92233,.92768,.93315,.93873,.94441,.95019,.95607,.96205]},{distance:[4.72925,4.81721,4.9037,4.98859,5.07177,5.15311,5.23249,5.3098,5.38491,5.45772,5.52811,5.59598,5.66122,5.72375,5.78346,5.84028,5.8941,5.94486,5.99248,6.03689,6.07803,6.11584,6.15028,6.18128,6.20882,6.23285,6.25336,6.27031,6.28369,6.29348,6.29969,6.3023,6.30133,6.29678,6.28867,6.27703,6.26187,6.24324,6.22116,6.19567,6.16683,6.13468,6.09928,6.06068,6.01896,5.97417,5.92639,5.87569,5.82217,5.76589,5.70696,5.64545,5.58147,5.5151,5.44644,5.37559,5.30265,5.2277,5.15085,5.0722,4.99184,4.90987,4.82639,4.74151,4.65533,4.56794,4.47945,4.38996,4.29959,4.20843,4.11658,4.02416,3.93125,3.83796,3.74437,3.65057,3.55666,3.46272,3.36884,3.27509,3.18155,3.08831,2.99545,2.90303,2.81114,2.71984,2.62922,2.53933,2.45026,2.36207,2.27484,2.18862,2.10349,2.01951,1.93675,1.85528,1.77515,1.69644,1.61919,1.54348,1.46935,1.39685,1.32605,1.25698,1.18967,1.12417,1.06049,.99863,.93862,.88044,.82408,.76953,.71676,.66574,.61644,.56882,.52282,.47841,.43553,.39413,.35414,.31551,.27817,.24206,.20712,.17328,.14048,.10866,.07776,.04772,.01848,-.00999,-.03776,-.06487,-.09134,-.11721,-.14251,-.16725,-.19144,-.21509,-.2382,-.26076,-.28275,-.30416,-.32496,-.34511,-.36459,-.38334,-.40134,-.41852,-.43485,-.45026,-.46471,-.47815,-.49052,-.50179,-.51189,-.52081,-.52849,-.5349,-.54003,-.54383,-.54627,-.54734,-.54702,-.54528,-.54211,-.53752,-.53149,-.52403,-.51515,-.50487,-.4932,-.48015,-.46575,-.45001,-.43297,-.41463,-.39503,-.37419,-.35213,-.32887,-.30443,-.27885,-.25214,-.22432,-.19541,-.16544,-.13442,-.10235,-.06926,-.03514,0,.03616,.07336,.11159,.15088,.19125,.23272,.27531,.31906,.36401,.41019,.45764,.5064,.55651,.60802,.66096,.71538,.77129,.82874,.88776,.94836,1.01056,1.07438,1.13982,1.20687,1.27554,1.34581,1.41766,1.49107,1.56599,1.64239,1.72025,1.79951,1.88013,1.96209,2.04532,2.12979,2.21546,2.30226,2.39017,2.47911,2.56905,2.65991,2.75164,2.84416,2.93742,3.03133,3.12582,3.2208,3.31619,3.41191,3.50785,3.60393,3.70006,3.79612,3.89202,3.98765,4.08291,4.17767,4.27182,4.36525,4.45783,4.54944,4.63995],pressure:[.30942,.30838,.30765,.30724,.30715,.30738,.30795,.30884,.31007,.31164,.31354,.31578,.31837,.32129,.32455,.32815,.33209,.33636,.34097,.34591,.35117,.35675,.36265,.36887,.37539,.38221,.38933,.39674,.40442,.41238,.4206,.42907,.43779,.44675,.45593,.46533,.47493,.48473,.49471,.50486,.51517,.52563,.53623,.54694,.55777,.5687,.57971,.59079,.60194,.61313,.62435,.6356,.64686,.65811,.66935,.68056,.69174,.70286,.71391,.72489,.73579,.74659,.75728,.76785,.7783,.7886,.79876,.80877,.81861,.82827,.83776,.84706,.85617,.86507,.87378,.88227,.89056,.89863,.90649,.91412,.92153,.92872,.93568,.94241,.94892,.95519,.96122,.96702,.97258,.97791,.98299,.98783,.99242,.99677,.99911,.99525,.99164,.98827,.98515,.98228,.97966,.97728,.97514,.97324,.97159,.97017,.96898,.96801,.96727,.96674,.96641,.96629,.96635,.96661,.96703,.96762,.96838,.96928,.97032,.97149,.97279,.9742,.97572,.97734,.97905,.98085,.98273,.98468,.98669,.98877,.99091,.99311,.99535,.99765,1,.9976,.99516,.99267,.99014,.98755,.98491,.98222,.97947,.97666,.97378,.97083,.96781,.96471,.96153,.95826,.9549,.95144,.94787,.9442,.94042,.93651,.93249,.92834,.92407,.91966,.91512,.91045,.90564,.90069,.8956,.89037,.885,.87949,.87384,.86806,.86214,.85608,.84988,.84356,.83711,.83053,.82383,.81702,.81009,.80306,.79594,.78872,.78141,.77403,.76657,.75905,.75148,.74385,.73619,.72849,.72076,.71302,.70526,.69749,.68972,.68195,.67419,.66644,.65871,.65099,.64329,.63561,.62795,.62032,.61271,.60512,.59755,.59001,.58248,.57497,.56749,.56002,.55256,.54512,.5377,.5303,.52291,.51554,.50819,.50087,.49358,.48632,.4791,.47192,.4648,.45773,.45072,.44378,.43692,.43015,.42346,.41687,.41039,.40403,.39779,.39168,.38571,.37989,.37423,.36873,.36342,.35828,.35335,.34862,.34409,.3398,.33573,.3319,.32831,.32498,.32192,.31912,.3166,.31436,.31242,.31077]}]};function e0e(t){let e=null;for(const r of t){const i=r.type;if(c$t(r)){if(e==null)e=i;else if(e!==i)return"uber"}}return e??"uber"}function t0e(t){let e=Xt.INVISIBLE;for(const{material:r}of t)if(ZFe(r)){if(r.color[3]*r.opacity<1)return Xt.TRANSPARENT;e=Xt.OPAQUE}return e}function r0e(t){let e=Xt.INVISIBLE;for(const{material:r}of t)if(ZFe(r)){switch(r.objectTransparency){case Xt.TRANSPARENT:case Xt.INVISIBLE:return Xt.TRANSPARENT;case Xt.OPAQUE:if(r.opacity<1)return Xt.TRANSPARENT}e=Xt.OPAQUE}return e}function ZFe(t){return t.size*t.color[3]*t.opacity>0}function c$t(t){return t.size*t.color[3]>0}function i0e(t,e,r,i){for(let s=0;s<t.length;s++){const n=t[s].index,o=e[s],a=e[s+1];if(i)for(let l=o;l<a;l++){const c=i[l];r.set(c,n)}else for(let l=o;l<a;l++)r.set(l,n)}}let jp=class extends me{constructor(t){super(t),this._updatingHandles=new vf,this._perObjectData=new Map,this._perObjectDataEvictionCache=new Set,this._renderers=new Map,this._gpuMemoryUsage=0,this._workerAbort=new AbortController,this._tmpModelPosition=C(),this._localOrigins=new VPt(new nie(t.renderSR))}initialize(){this._worker=new n$t(this.schedule),this._componentColorManager=new nFe(this.rctx,3);const t=eFe.createBuffer(4);for(let e=0;e<4;e++)t.sideness.set(e,0,e===0||e===3?0:1),t.sideness.set(e,1,e===0||e===1?0:1);this._verticesBufferObject=Gr.createVertex(this.rctx,Mr.STATIC_DRAW,t.buffer)}destroy(){this.destroyed||(this._perObjectData.forEach(t=>this._discardObjectEntry(t)),this._perObjectData.clear(),this._strokesTexture=ze(this._strokesTexture),this._componentColorManager=Re(this._componentColorManager),this._workerAbort.abort(),this._worker.destroy(),this._verticesBufferObject=ze(this._verticesBufferObject),this._renderers.clear(),this._updatingHandles.destroy(),this._set("schedule",m$t))}get updating(){return this._updatingHandles.updating}get usedMemory(){return this._gpuMemoryUsage}shouldRender(){return this._renderers.size>0}async addComponentObject(t,e,r,i,s,n,o,a){if(this.hasObject(t))return this.getObjectMemoryUsage(t);let l;const c=new n0e(new Promise(p=>l=p),r.center,r.radius);this._perObjectData.set(t,c);const h=await this._updatingHandles.addPromise(this._addComponentGeometry(e,c,i,s,n,o,a));return this.setNeedsRender(),l(),h}async addOrUpdateObject3D(t,e,r,i){if(this.destroyed)return void K.getLogger(this).warn("Attempt to add an object to a destroyed instance");const s=this._perObjectData.get(t);let n;s?.renderables.length>0&&this._perObjectDataEvictionCache.add(s);const o=t.boundingVolumeWorldSpace.bounds,a=new n0e(new Promise(c=>n=c),o,p0(o));this._perObjectData.set(t,a);const l=new Array;if(r.mergeGeometries&&t.geometries.length>1&&u$t(t))l.push(this._addObjectMergedGeometries(t,a,e,r,i));else for(let c=0;c<t.geometries.length;c++){const h=t.geometries[c];h.material.supportsEdges&&l.push(this._addGeometry(t,a,h,e[0],r,i))}await this._updatingHandles.addPromise(Promise.all(l)),this._perObjectDataEvictionCache.delete(a),this._discardObjectEntry(s),this.setNeedsRender(),n()}_discardObjectEntry(t){t&&(t.renderables.length&&(t.renderables.forEach(e=>this._removeRenderable(e)),this.setNeedsRender()),t.loaded=null)}hasObject(t){return this._perObjectData.has(t)}async updateAllComponentOpacities(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));if(r==null)return;const i=e instanceof Array?s=>e[s]:()=>e;r.renderables.forEach(s=>{const n=s.components.meta.length;for(let o=0;o<n;o++){const a=i(o),l=s.components.meta[o],c=l.index;l.material.opacity=a,s.components.buffer.textureBuffer.setDataElement(c,1,3,255*a)}this._updateTransparency(s)}),this.setNeedsRender()}async getObjectMemoryUsage(t){const e=await this._getObjectEntry(t);return e!=null?e.renderables.reduce((r,i)=>r+i.statistics.gpuMemoryUsage,0):0}async updateAllComponentMaterials(t,e,r,i){const s=t instanceof K0,n=!!r.hasSlicePlane,o=e0e(e),a=gj.getKey(o,n,s),l=await this._updatingHandles.addPromise(this._getObjectEntry(t));l!=null&&(l.renderables.forEach(c=>{if(a!==c.rendererKey){const h=this._renderers.get(c.rendererKey),p=this._acquireRenderer(o,n,s);h.removeRenderable(c),--h.refCount,c.rendererKey=a,p.addRenderable(c)}for(let h=0;h<e.length;h++)c.components.meta[h].material=e[h];i&&this._updateComponentBuffer(c.components),this._updateTransparency(c)}),this.setNeedsRender())}async updateAllVerticalOffsets(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));r!=null&&(r.renderables.forEach(i=>{const s=i.components.meta;for(let n=0;n<s.length;n++)i.components.meta[n].verticalOffset=e?.[n]??0;this._updateComponentBuffer(i.components)}),this.setNeedsRender())}async updateObjectVisibility(t,e){const r=await this._updatingHandles.addPromise(this._getObjectEntry(t));r!=null&&(r.renderables.forEach(i=>i.visible=e),this.setNeedsRender())}removeObject(t){const e=this._perObjectData.get(t);e&&(this._perObjectData.delete(t),this._discardObjectEntry(e))}async _getObjectEntry(t){const e=this._perObjectData.get(t);if(!e)throw new Error("no object");return await e.loaded,e.loaded==null?null:e}render(t,e){if(this._componentColorManager==null)return;this._localOrigins.updateViewMatrices(t.camera.viewMatrix);const r=t.camera.viewInverseTransposeMatrix,i=C(),s=new i9;let n=0,o=0;if(this._renderers.forEach(l=>{if(l.refCount===0)this._renderers.delete(l.key),l.dispose();else{let c=!0,h=!0;l.forEachRenderable(p=>{p.visible&&(n+=p.statistics.averageEdgeLength,o++,c&&p.regular&&(l.updateTechnique(t,!1),c=!1),h&&p.silhouette&&(l.updateTechnique(t,!0),h=!1))},e)}}),this._componentColorManager.garbageCollect(),this._componentColorManager.updateTextures(),o===0)return;const a=new BPt(40*n/o,e);ie(i,r[3],r[7],r[11]),s.set(i),oe(a.transformWorldFromViewTH,s.high),oe(a.transformWorldFromViewTL,s.low),qd(a.transformViewFromCameraRelativeRS,t.camera.viewMatrix),Wd(c0e,a.transformViewFromCameraRelativeRS),gS(a.transformNormalViewFromGlobal,c0e),a.transformProjFromView=t.camera.projectionMatrix,this._updateObjectCameraDistances(t),this._renderers.forEach(l=>{this._renderRegularEdges(l,t,a),this._renderSilhouetteEdges(l,t,a)})}_updateTransparency(t){const e=t0e(t.components.meta),r=r0e(t.components.meta);e===t.edgeTransparency&&r===t.objectTransparency||(t.edgeTransparency=e,t.objectTransparency=r,this._renderers.get(t.rendererKey).setRenderablesDirty())}_computeModelTransformWithLocalOrigin(t,e,r){t.getCombinedShaderTransformation(e,r);const i=e.localOrigin!=null?this._localOrigins.register(e.localOrigin):this._localOrigins.acquire(ie(this._tmpModelPosition,r[12],r[13],r[14]));return e.localOrigin=i.origin,kPt(i.origin.vec3,r),i}_updateComponentBuffer(t){const{meta:e,buffer:r}=t,i=new Uint8Array(4);for(let s=0;s<e.length;s++){const n=e[s].material,o=e[s].index,a=ye(Math.round(n.size*r$t),0,255),l=ye(n.extensionLength,-mj,255-mj)+mj,c=n.type==="solid"?_6.SOLID:_6.SKETCH,h=255*n.opacity,p=n.color,f=255*p[0],m=255*p[1],g=255*p[2],_=255*p[3];r.textureBuffer.setData(o,0,f,m,g,_),r.textureBuffer.setData(o,1,a,l,c,h),YNe(e[s].verticalOffset,i),r.textureBuffer.setData(o,2,i[0],i[1],i[2],i[3])}}_createComponentBuffers(t){if(this._componentColorManager==null)return null;const e=new Array,r=this._componentColorManager.getBuffer(t.length);for(let s=0;s<t.length;s++){const n=t[s],o=r.acquireIndex();e.push({index:o,verticalOffset:0,material:n})}const i=new h$t(r,e);return this._updateComponentBuffer(i),i}_extractEdges(t,e,r,i,s,n=s.length){return this._worker.process({data:e,indices:s,indicesLength:n,writerSettings:t,skipDeduplicate:r},this._workerAbort.signal,i)}_createRenderable(t,e,r,i,s){const n=c=>this._verticesBufferObject!=null?new d$t(new zf(this.rctx,rFe,{vertices:VMt,instances:c===Ux.REGULAR?g6.glLayout:y6.glLayout},{vertices:this._verticesBufferObject,instances:Gr.createVertex(this.rctx,Mr.STATIC_DRAW,c===Ux.REGULAR?t.regular.instancesData.buffer:t.silhouette.instancesData.buffer)}),c===Ux.REGULAR?t.regular.lodInfo:t.silhouette.lodInfo):null,o=t.regular.lodInfo.lengths.length>0?n(Ux.REGULAR):null,a=t.silhouette.lodInfo.lengths.length>0?n(Ux.SILHOUETTE):null,l=(o?.vao.memoryEstimate??0)+(a?.vao.memoryEstimate??0);return new f$t(o,a,{gpuMemoryUsage:l,externalMemoryUsage:s,averageEdgeLength:t.averageEdgeLength},r,t0e(e.meta),r0e(e.meta),e,i)}async _addGeometry(t,e,r,i,s,n){const o=r.vertexAttributes.get(E.POSITION),a=r.indices.get(E.POSITION),l=xe(),c=this._computeModelTransformWithLocalOrigin(t,r,l),h=new l0e(o,a,l,c);return this._addPositionData(e,h,r.edgeIndicesLength,i,s,n)}async _addPositionData(t,e,r,i,s,n=!1){if(t.loaded==null)return;const o=this._createComponentBuffers([i]);if(o==null||r<=0)return;const a=this._acquireRenderer(i.type,!!s.hasSlicePlane,!0),{modelTransform:l,origin:c}=e,h=e.indices,p=e.position,f=p.data.length/p.size,m=f6.createBuffer(f);for(let v=0;v<f;v++)m.position.set(v,0,p.data[v*p.size]),m.position.set(v,1,p.data[v*p.size+1]),m.position.set(v,2,p.data[v*p.size+2]);i0e(o.meta,[0,m.componentIndex.count],m.componentIndex);const g=await this._updatingHandles.addPromise(this._extractEdges(a.writerSettings,m,!1,n,h,r));if(t.loaded==null)return;const _=this._createRenderable(g,o,new p$t(l,c),a.key,!1);t.renderables.push(_),a.addRenderable(_),this._gpuMemoryUsage+=_.statistics.gpuMemoryUsage}async _addComponentGeometry(t,e,r,i,s,n,o){if(e.loaded==null)return 0;const a=this._createComponentBuffers(n);if(a==null)return 0;const l=e0e(n),c=this._acquireRenderer(l,o.hasSlicePlane||!1,!1),h=f6.createBuffer(r.length/3);j$(h.position.typedBuffer,r,h.position.typedBufferStride,3),i0e(a.meta,s,h.componentIndex,i);const p=!0,f=c.writerSettings,m=await this._updatingHandles.addPromise(this._extractEdges(f,h,p,!1,i));if(e.loaded==null)return 0;const g=this._createRenderable(m,a,t,c.key,!0);return e.renderables.push(g),c.addRenderable(g),g.statistics.gpuMemoryUsage}async _addObjectMergedGeometries(t,e,r,i,s){const n=new Map;let o=0,a=null,l=0;for(let b=0;b<t.geometries.length;b++){const x=t.geometries[b];if(!x.material.supportsEdges)continue;!a&&x.localOrigin&&(a=x);const T=x.vertexAttributes.get(E.POSITION);l+=T.data.length/T.size,o+=x.edgeIndicesLength}const c=l>=65536?Uint32Array:Uint16Array,h=o?new c(o):null,p=[];let f=0;for(let b=0;b<t.geometries.length;b++){const x=t.geometries[b];if(!x.material.supportsEdges)continue;const T=x.vertexAttributes.get(E.POSITION),S=x.indices.get(E.POSITION);let O=n.get(T.data);if(O==null){O=p.length/3;for(let A=0;A<T.data.length;A+=T.size)p.push(T.data[A]),p.push(T.data[A+1]),p.push(T.data[A+2]);n.set(T.data,O)}if(S)for(let A=0;A<x.edgeIndicesLength;A++)h[f++]=O+S[A]}const m=a||t.geometries[0],g=xe(),_=this._computeModelTransformWithLocalOrigin(t,m,g);for(let b=0;b<t.geometries.length;b++)t.geometries[b].localOrigin=_.origin;const v=new l0e({data:p,size:3},h,g,_);await this._updatingHandles.addPromise(this._addPositionData(e,v,h.length,r[0],i,s))}_acquireRenderer(t,e,r){const i=gj.getKey(t,e,r);let s=this._renderers.get(i);return this._strokesTexture==null&&(this._strokesTexture=o$t(this.rctx)),s||(s=new gj(this.rctx,this.techniqueRepository,{type:t,hasSlicePlane:e,strokesTexture:this._strokesTexture,legacy:r,spherical:this.viewingMode===Ue.Global}),this._renderers.set(i,s)),++s.refCount,s}_removeRenderable(t){s0e(t.regular),s0e(t.silhouette);const e=this._renderers.get(t.rendererKey);if(e){e.removeRenderable(t),--e.refCount,"origin"in t.transform&&this._localOrigins.release(t.transform.origin),this._gpuMemoryUsage-=t.statistics.externalMemoryUsage?0:t.statistics.gpuMemoryUsage;for(const r of t.components.meta)t.components.buffer.releaseIndex(r.index)}}_updateObjectCameraDistances(t){const e=t.camera.eye,r=t.camera.viewForward,i=C(),s=n=>{Mi(i,n.center,e);const o=de(i,r),a=n.radius,l=o<-a?1/0:o<a?0:o-a;n.renderables.forEach(c=>c.distanceToCamera=l)};this._perObjectData.forEach(s),this._perObjectDataEvictionCache.forEach(s)}_renderRegularEdges(t,e,r){const i=t.bindRegularEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!o0e(o)||!o.visible)return;const a=hF(o.regular.lod.lengths,o.distanceToCamera,n);t.renderRegularEdges(i,o,r,e,a)},s)}_renderSilhouetteEdges(t,e,r){const i=t.bindSilhouetteEdges(r,e),s=r.transparency,n=e.camera.perScreenPixelRatio;t.forEachRenderable(o=>{if(!a0e(o)||!o.visible)return;const a=hF(o.silhouette.lod.lengths,o.distanceToCamera,n);t.renderSilhouetteEdges(i,o,r,e,a)},s)}get test(){return{hasRenderedPrimitives:t=>{let e=!1;const r=t.perScreenPixelRatio,i=(s,n)=>s.forEachRenderable(o=>{o.visible&&!e&&(o0e(o)&&(e=hF(o.regular.lod.lengths,o.distanceToCamera,r)>0),!e&&a0e(o)&&(e=hF(o.silhouette.lod.lengths,o.distanceToCamera,r)>0))},n);return this._renderers.forEach(s=>{e||(i(s,Xt.OPAQUE),i(s,Xt.TRANSPARENT))}),e}}}};function s0e(t){t!=null&&(t.vao.vertexBuffers.instances.dispose(),t.vao.disposeVAOOnly(),t.vao=null)}function u$t(t){let e=null,r=null;for(let i=0;i<t.geometries.length;i++){const s=t.geometries[i];if(s.material.supportsEdges){if(e){if(!T0(e,s.transformation))return!1}else e=s.transformation;if(r||s.localOrigin==null){if(r&&r.localOrigin!=null&&s.localOrigin!=null&&r.localOrigin.id!==s.localOrigin.id)return!1}else r=s}}return!0}u([d({constructOnly:!0})],jp.prototype,"rctx",void 0),u([d({constructOnly:!0})],jp.prototype,"renderSR",void 0),u([d({constructOnly:!0})],jp.prototype,"viewingMode",void 0),u([d({constructOnly:!0})],jp.prototype,"techniqueRepository",void 0),u([d({constructOnly:!0})],jp.prototype,"setNeedsRender",void 0),u([d({constructOnly:!0})],jp.prototype,"schedule",void 0),u([d({readOnly:!0})],jp.prototype,"_updatingHandles",void 0),u([d({readOnly:!0})],jp.prototype,"updating",null),jp=u([R("esri.views.3d.webgl-engine.lib.edgeRendering.EdgeView")],jp);class n0e{constructor(e,r,i){this.center=r,this.radius=i,this.renderables=new Array,this.loaded=e,this.loaded.then(()=>{this.loaded!=null&&(this.loaded=!0)})}}let h$t=class{constructor(e,r){this.buffer=e,this.meta=r}};class d$t{constructor(e,r){this.vao=e,this.lod=r}}class p$t{constructor(e,r){this.modelMatrix=e,this.origin=r}}let f$t=class{constructor(e,r,i,s,n,o,a,l){this.regular=e,this.silhouette=r,this.statistics=i,this.transform=s,this.edgeTransparency=n,this.objectTransparency=o,this.components=a,this.rendererKey=l,this.distanceToCamera=0,this.visible=!0}};function o0e(t){return t.regular!=null}function a0e(t){return t.silhouette!=null}function hF(t,e,r){const i=e*r,s=U0e(t,i,!0);return s===-1?i<t[0]?t.length:0:t.length-s}class l0e{constructor(e,r,i,s){this.position=e,this.indices=r,this.modelTransform=i,this.origin=s}}const c0e=ts(),m$t=()=>Promise.reject();function jf(t){return window.WebGL2RenderingContext&&t instanceof window.WebGL2RenderingContext}let u0e=class{constructor(e,r,i,s,n,o,a,l,c){this.createQuery=e,this.deleteQuery=r,this.resultAvailable=i,this.getResult=s,this.disjoint=n,this.beginTimeElapsed=o,this.endTimeElapsed=a,this.createTimestamp=l,this.timestampBits=c}},Fy=!1;function g$t(t,e){if(e.disjointTimerQuery)return null;let r=t.getExtension("EXT_disjoint_timer_query_webgl2");return r&&jf(t)?new u0e(()=>t.createQuery(),i=>{t.deleteQuery(i),Fy=!1},i=>t.getQueryParameter(i,t.QUERY_RESULT_AVAILABLE),i=>t.getQueryParameter(i,t.QUERY_RESULT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{Fy||(Fy=!0,t.beginQuery(r.TIME_ELAPSED_EXT,i))},()=>{t.endQuery(r.TIME_ELAPSED_EXT),Fy=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>t.getQuery(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):(r=t.getExtension("EXT_disjoint_timer_query"),r?new u0e(()=>r.createQueryEXT(),i=>{r.deleteQueryEXT(i),Fy=!1},i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_AVAILABLE_EXT),i=>r.getQueryObjectEXT(i,r.QUERY_RESULT_EXT),()=>t.getParameter(r.GPU_DISJOINT_EXT),i=>{Fy||(Fy=!0,r.beginQueryEXT(r.TIME_ELAPSED_EXT,i))},()=>{r.endQueryEXT(r.TIME_ELAPSED_EXT),Fy=!1},i=>r.queryCounterEXT(i,r.TIMESTAMP_EXT),()=>r.getQueryEXT(r.TIMESTAMP_EXT,r.QUERY_COUNTER_BITS_EXT)):null)}function y$t(t,e){const r=t.capabilities.disjointTimerQuery;return r==null?null:new _$t(r,e)}let _$t=class{constructor(e,r){this._timer=e,this._queryPool=new Array,this._queryResults=new Map,this._currentQuery=null,r.forEach(i=>{const s=this._timer.createQuery(),n=this._timer.createQuery();this._queryPool.push(s,n),this._queryResults.set(i,null)})}start(){Fy||(this._currentQuery=this._queryPool.pop(),this._currentQuery!=null&&(this._timer.disjoint(),this._timer.beginTimeElapsed(this._currentQuery)))}stop(e){if(this._timer.disjoint()||this._currentQuery==null||!this._queryResults.has(e))return this.abort(),null;this._timer.endTimeElapsed();const r=this._queryResults.get(e);if(r==null)return this._queryResults.set(e,this._currentQuery),this._currentQuery=null,null;if(!this._timer.resultAvailable(r))return this._queryPool.unshift(this._currentQuery),this._currentQuery=null,null;const i=this._timer.getResult(r)/1e6;return this._queryPool.unshift(r),this._queryResults.set(e,this._currentQuery),this._currentQuery=null,i}abort(){this._currentQuery!=null&&(this._timer.deleteQuery(this._currentQuery),this._queryPool.unshift(this._timer.createQuery()),this._currentQuery=null)}dispose(){this._currentQuery!=null&&this._timer.deleteQuery(this._currentQuery),this._queryPool.forEach(e=>{this._timer.deleteQuery(e)}),this._queryResults.forEach(e=>{e!=null&&this._timer.deleteQuery(e)})}};var Vi;(function(t){t.OVERLAY="overlay",t.PREPARE="prepare",t.SHADOW_MAP="shadow map",t.LINEAR_DEPTH="linear depth",t.ACCUMULATED_SHADOWS="accumulated shadows",t.NORMALS="normals",t.OBJECT_AND_LAYER_ID_COLOR="object/layer id color",t.SSAO="SSAO",t.OPAQUE="opaque",t.OPAQUE_EDGES="opaque edges",t.VOXEL="voxel",t.TRANSPARENT="transparent",t.TRANSPARENT_EDGES="transparent edges",t.HUD_VISIBILITY="HUD visibility",t.TRANSPARENT_TERRAIN="transparent terrain",t.ENVIRONMENT="environment",t.LASER_LINE="laser line",t.OCCLUDED="occluded",t.ANTIALIASING="antialiasing",t.HIGHLIGHTS="highlights",t.HUD="HUD",t.HUD_OCCLUDED="HUD occluded",t.FINISH="finish"})(Vi||(Vi={}));const h0e="Total";let v$t=class{constructor(e){this._rctx=e,this._startTimeStampCPU=0,this._lastTimeStampCPU=0,this._totalCPUTime=new r0(h0e),this._cpuTimeSamplers=new Map(Object.values(Vi).map(r=>[r,new r0(r)])),this._enableGPUTimer=0,this._totalGPUTime=new r0("GPU"),this._gpuTimeSamplers=new Map(Object.values(Vi).map(r=>[r,new r0(r)])),this._totalTime=0,this._totalFrameCount=0}get totalCPUTimeSampler(){return this._totalCPUTime}get cpuTimeSamplers(){return Array.from(this._cpuTimeSamplers.values())}get totalGPUTimeSampler(){return this._totalGPUTime}get gpuTimeSamplers(){return Array.from(this._gpuTimeSamplers.values())}get gpuSamplingEnabled(){return this._gpuTimerPool!=null}get totalTime(){return this._totalTime}get totalFrameCount(){return this._totalFrameCount}get elapsedTime(){return performance.now()-this._startTimeStampCPU}enableGPUPerformanceInfo(){if(this._gpuTimerPool==null){const e=[...Object.values(Vi),h0e];this._gpuTimerPool=y$t(this._rctx,e)}return this._gpuTimerPool==null?{hasGPUTimerSupport:!1,remove:()=>{}}:(++this._enableGPUTimer,{hasGPUTimerSupport:!0,remove:iQ(()=>{--this._enableGPUTimer,this._enableGPUTimer===0&&(this._gpuTimerPool=ze(this._gpuTimerPool))})})}startFrame(){this._startTimeStampCPU=this._lastTimeStampCPU=performance.now(),this._gpuTimerPool!=null&&this._gpuTimerPool.start()}advance(e){const r=performance.now();if(this._cpuTimeSamplers.get(e).record(r-this._lastTimeStampCPU),this._lastTimeStampCPU=r,this._gpuTimerPool!=null){const i=this._gpuTimerPool.stop(e);this._gpuTimeSamplers.get(e).record(i),this._gpuTimerPool.start()}}finishFrame(){if(this._gpuTimerPool!=null){const r=this._gpuTimerPool.stop(Vi.FINISH);this._gpuTimeSamplers.get(Vi.FINISH).record(r)}const e=performance.now()-this._startTimeStampCPU;this._totalTime=this._totalTime+e,this._totalCPUTime.record(e),this._gpuTimerPool!=null&&this._totalGPUTime.record(this.gpuTimeSamplers.reduce((r,i)=>r+(i.last||0),0)),++this._totalFrameCount}},Qc=class extends me{get _bindParameters(){return this._renderContext.bindParameters}updateRenderFeature(t=null,e=!le("disable-feature:high-quality-idle")){this._renderStateFeatures=The(e,t),this.notifyChange("_renderStateFeatures"),this._requestRender()}isFeatureEnabled(t,e=this._state){return this._renderStateFeatures?.get(e,t)??!1}setFeatureEnabled(t,e,r){this._renderStateFeatures?.set(e,t,r),this.notifyChange("_renderStateFeatures"),this._requestRender()}get _antialiasing(){return this._antialiasingEnabled||this.isFeatureEnabled(wn.Antialiasing)}get _highQualityTransparency(){return this._highQualityTransparencyEnabled||this.isFeatureEnabled(wn.HighQualityTransparency)}get hasReflections(){return this.hasWater&&(this._ssrEnabled||this.isFeatureEnabled(wn.WaterReflection))}get hasWater(){return this._hasWater||this._hasOverlayWater}constructor(t,e,r,i,s,n,o,a){super({}),this._stage=t,this._materialRepository=e,this._techniqueRepository=i,this._rctx=s,this._compositingHelper=n,this._magnifierHelper=o,this._requestRender=a,this._materialRenderers=new qt,this._needsTransparentPass=!1,this._hasHUDElements=!1,this._hasHighlights=!1,this._hasWater=!1,this._hasOverlayWater=!1,this._renderOverlay=l=>{},this._isRendering=!1,this._fallbackDepthStencilTexture=null,this._sliceHelper=new RPt,this._state=Br.IDLE,this._renderStateFeatures=null,this._antialiasingEnabled=!0,this._highQualityTransparencyEnabled=!0,this._terrainRenderingEnabled=!0,this._terrainTransparency=Qn.Opaque,this._ssrEnabled=!1,this._ssaoEnabled=!1,this._hasAnimations=!1,this._animationTimestep=new zIt,this._handles=new li,this._renderHiddenTransparentEdges=()=>{},this._oitUsed=!1,this.updateRenderFeature(t.view.qualityProfile),this._smaaPass=new OM(this._rctx,i),a(),this._offscreen=new aPt(this._rctx,this._compositingHelper),this.performanceInfo=new v$t(this._rctx),this._shadowMap=new aie(this._rctx,t.viewingMode),this._ssaoHelper=new yLe(t.view,i,this._rctx,a),this._highlight=new iPt(i,this._rctx),this._shadowHighlight=new OPt(this._rctx,t.viewingMode),this._shadowAccumulator=new ac(this._rctx,i,t,l=>{const c=this.shadowsEnabled;this._shadowMap.enabled=!0,this._prepare(l.camera,l.contentCamera),this._renderPlugins.prepareRender(),this._shadowMap.enabled=c},(l,c,h)=>{l.shadowMap.start(l.camera,c,h,!0,this._stage.view.qualitySettings.maximumPixelRatio),this._renderShadowCascades(k.Shadow,l.shadowMap),l.camera.setGLViewport(this._rctx),this._prepare(l.camera,l.contentCamera)},a),this._renderContext=new Gbt(this._rctx,this._offscreen,this._shadowMap,this._ssaoHelper,this._sliceHelper),this._renderPlugins=new AM({renderContext:this._renderContext,techniqueRepository:i,textureRepository:r,materialRepository:this._materialRepository,requestRender:a,controller:t}),this.renderPassManager=new VIt(this._rctx,this._techniqueRepository),this._renderPlugins.add(this.renderPassManager.slots(),this.renderPassManager),this._handles.add([Q(()=>this._stage.view.state.camera,()=>a(),Ri),Q(()=>bi.EDGES_SHOW_HIDDEN_TRANSPARENT_EDGES,l=>{this._renderHiddenTransparentEdges=l?()=>this._renderEdges(Xt.TRANSPARENT):()=>{},a()},xt),Q(()=>this._ssaoEnabled||this.isFeatureEnabled(wn.SSAO),l=>this._ssaoHelper.enabled=l,Ri)])}normalizeCtorArgs(){return{}}destroy(){this._handles.destroy(),this._smaaPass.dispose(),this._gpuTimerHandle=Pi(this._gpuTimerHandle),this._materialRenderers.forAll(t=>t.dispose()),this._materialRenderers.clear(),this._offscreen.dispose(),this._fallbackDepthStencilTexture=ze(this._fallbackDepthStencilTexture),this._shadowMap.dispose(),this._ssaoHelper.destroy(),this._highlight.dispose(),this._shadowHighlight.dispose(),this._shadowAccumulator.dispose(),this._edgeView=Re(this._edgeView),this.renderPassManager.destroy(),aMe.prune()}disposeOffscreenBuffers(){this._offscreen.dispose(),this._shadowMap.disposeOffscreenBuffers(),this._smaaPass.disable(),this._ssaoHelper.disposeOffscreenBuffers()}get updating(){return this._antialiasing&&this._smaaPass.updating||this._edgeView!=null&&this._edgeView.updating||this._shadowAccumulator.running||this._renderPlugins.updating||!this.isCameraFinal}ensureEdgeView(){if(this._edgeView==null){const t=this._stage.view.resourceController;this._edgeView=new jp({rctx:this._rctx,renderSR:this._stage.view.renderSpatialReference,viewingMode:this._stage.viewingMode,techniqueRepository:this._techniqueRepository,setNeedsRender:()=>this._requestRender(),schedule:b$t(t)}),this._handles.add(Q(()=>Dl(this._edgeView,e=>e.updating),()=>this._requestRender(),Rr)),this._requestRender()}return this._edgeView}get edgeView(){return this._edgeView}get isCameraFinal(){return KK(this._bindParameters.ssr.reprojectionMatrix,Un)}set _reprojectionMatrix(t){AJ(this._bindParameters.ssr.reprojectionMatrix,t)&&this.notifyChange("isCameraFinal")}get shadowsEnabled(){return!!this._shadowMap?.enabled}setParameters(t){const{_shadowMap:e,_bindParameters:r}=this;if(t.qualitySettings?.reflections!==void 0&&this._ssrEnabled!==t.qualitySettings.reflections&&(this._ssrEnabled=t.qualitySettings.reflections,this._requestRender()),t.qualitySettings?.ambientOcclusion!==void 0&&this._ssaoEnabled!==t.qualitySettings.ambientOcclusion&&(this._ssaoEnabled=t.qualitySettings.ambientOcclusion,this._requestRender()),t.shadowMap!==void 0&&this._shadowMap.enabled!==t.shadowMap&&(this._shadowMap.enabled=t.shadowMap,this._requestRender()),t.shadowMapMaxCascades!==void 0&&e.maxCascades!==t.shadowMapMaxCascades&&(e.maxCascades=t.shadowMapMaxCascades,this._requestRender()),t.environment!=null){t.environment.weather!=null&&(this._bindParameters.weather=t.environment.weather,this._bindParameters.weatherVisible=!!t.weatherVisible);const i=t.environment.lighting.type!=="virtual";r.enableFillLights!==i&&(r.enableFillLights=i,this._requestRender())}t.background&&this._offscreen.background!==t.background&&(this._offscreen.background=t.background,this._requestRender()),t.antialiasingEnabled!==void 0&&this._antialiasingEnabled!==t.antialiasingEnabled&&(this._antialiasingEnabled=t.antialiasingEnabled,this._requestRender()),t.highQualityTransparency!==void 0&&this._highQualityTransparencyEnabled!==t.highQualityTransparency&&(this._highQualityTransparencyEnabled=t.highQualityTransparency,this._requestRender()),t.defaultHighlightOptions!==void 0&&(this._highlight.setDefaultOptions(t.defaultHighlightOptions),this._shadowHighlight.setDefaultOptions(t.defaultHighlightOptions),this._requestRender()),t.overlays!==void 0&&this._bindParameters.overlays!==t.overlays&&(this._bindParameters.overlays=t.overlays,this._requestRender()),t.hasOverlayWater!==void 0&&this._hasOverlayWater!==t.hasOverlayWater&&(this._hasOverlayWater=t.hasOverlayWater,this._requestRender()),t.renderOverlay!==void 0&&this._renderOverlay!==t.renderOverlay&&(this._renderOverlay=t.renderOverlay,this._requestRender()),t.slicePlane!==void 0&&this._sliceHelper.plane!==t.slicePlane&&(this._sliceHelper.plane=t.slicePlane,this._requestRender()),t.terrainRenderingEnabled!==void 0&&this._terrainRenderingEnabled!==t.terrainRenderingEnabled&&(this._terrainRenderingEnabled=t.terrainRenderingEnabled,this._requestRender()),t.terrainTransparency!==void 0&&this._terrainTransparency!==t.terrainTransparency&&(this._terrainTransparency=t.terrainTransparency,this._requestRender()),t.shadowCastOptions!==void 0&&this._shadowAccumulator.setOptions(t.shadowCastOptions)}get hasSlicePlane(){return!!this._sliceHelper.plane}get renderPlugins(){return this._renderPlugins}get _hasOITSupport(){return this._rctx.driverTest.floatBufferBlend.result}get _oitEnabled(){return this._highQualityTransparency&&this._hasOITSupport}modify(t,e){this._isRendering&&console.warn("Renderer.modify called while rendering");const{adds:r,removes:i,updates:s}=t;if(r.length===0&&i.length===0&&s.length===0)return;const n=eLe(t);let o=!1;n.forEach((a,l)=>{if(e.done)return;let c=this._materialRenderers.find(h=>h.material===l);c==null&&a.adds.length>0&&(c=new uLe(this._rctx,this._materialRepository,l),this._materialRenderers.push(c)),c&&(c.modify(a),c.isEmpty&&(o=!0)),a.removes.forEach(h=>t.removes.removeUnordered(h)),a.adds.forEach(h=>t.adds.removeUnordered(h)),a.updates.forEach(h=>t.updates.removeUnordered(h)),e.madeProgress()}),o&&this._materialRenderers.filterInPlace(a=>!a.isEmpty||(a.dispose(),!1)),this._hasHighlights=this._materialRenderers.some(a=>a.hasHighlights),this._bindParameters.hasOccludees=this._materialRenderers.some(a=>a.hasOccludees),this._hasWater=this._materialRenderers.some(a=>a.hasWater),this._hasHUDElements=this._materialRenderers.some(a=>a.requiresSlot(fe.LINE_CALLOUTS_HUD_DEPTH,k.Color)||a.requiresSlot(fe.HUD_MATERIAL,k.Color)||a.requiresSlot(fe.LABEL_MATERIAL,k.Color)),this._requestRender()}updateAnimation(t){const e=this._hasAnimations;return this._hasAnimations=!1,this._materialRenderers.forAll(r=>this._hasAnimations=r.updateAnimation(t)||this._hasAnimations),this._hasAnimations=this._renderPlugins.updateAnimation(t)||this._hasAnimations,this._hasAnimations!==e&&(this._gpuTimerHandle=e?Pi(this._gpuTimerHandle):this.performanceInfo.enableGPUPerformanceInfo()),this._hasAnimations}get animationTimestep(){return this._animationTimestep.value}get animationTimeDilation(){return this._animationTimestep.timeDilation}resetAnimation(){this._animationTimestep.clear()}render(t,e,r,i,s){this._isRendering=!0,this._oitUsed=!1,this.performanceInfo.startFrame();const{camera:n,contentCamera:o,mode:a,alignPixelEnabled:l}=r;this._state=a,this._renderOverlay(s),this.performanceInfo.advance(Vi.OVERLAY),this._renderContext.time=s,this._bindParameters.transparencyPassType=ut.NONE,this._bindParameters.alignPixelEnabled=l;const c=this._offscreen;c.setupRenderTarget(this.hasReflections);const h=B0(this._sliceHelper.plane);i===VT.OFF&&(this._sliceHelper.plane=null),this._rctx.bindFramebuffer(t),n.setGLViewport(this._rctx),this._prepare(n,o),this._renderPlugins.prepareRender(),this.performanceInfo.advance(Vi.PREPARE);const p=this._computeDepthRange(n);this._renderShadowMap(t,n,this._bindParameters.lighting.mainLight.direction,p),this.performanceInfo.advance(Vi.SHADOW_MAP),c.initializeFrame(n),this._ensureBindParameters(n,o);const f=this._terrainRenderingEnabled&&(this._terrainTransparency===Qn.Semitransparent||this._terrainTransparency===Qn.TransparentWithDraped),m=this._highQualityTransparency&&f,g=this._needsTransparentPass||this._renderPlugins.needsTransparentPass;this._prepareShaders(m,g),this._renderLinearDepth(),this.performanceInfo.advance(Vi.LINEAR_DEPTH),this._accumulateShadows(p,n,o),this.performanceInfo.advance(Vi.ACCUMULATED_SHADOWS),this._renderNormal(),this.performanceInfo.advance(Vi.NORMALS),this._ensureBindParametersSSR(s),this._renderSSAO(s),this.performanceInfo.advance(Vi.SSAO),this._renderContext.output=k.Color,c.bindFramebuffer(),this._renderOpaqueGeometry(),this.performanceInfo.advance(Vi.OPAQUE),this._renderTerrainLinearDepth(m),this._setMultipassTerrain(m),this._renderEdges(Xt.OPAQUE),this.performanceInfo.advance(Vi.OPAQUE_EDGES),this._offscreen.bindTarget(this._offscreen.currentColorTarget,this._offscreen.mainDepth),this._renderSlot(fe.VOXEL),this.performanceInfo.advance(Vi.VOXEL),this._renderHiddenTransparentEdges(),g&&(this._oitEnabled?this._renderOITPass(fC.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(Vi.TRANSPARENT),this._renderGeometryLinearDepth(m);const _=this._renderHUDVisibility(m);m||this._renderInternalSlot(fe.LINE_CALLOUTS),this.performanceInfo.advance(Vi.HUD_VISIBILITY),this._renderObjectAndLayerIdColor(e),this.performanceInfo.advance(Vi.OBJECT_AND_LAYER_ID_COLOR),this._renderEdges(Xt.TRANSPARENT,m),this.performanceInfo.advance(Vi.TRANSPARENT_EDGES),this._renderTransparentTerrain(),f&&_&&(m?this._renderLineCallouts(su.Occluded):c.compositeTransparentTerrainOntoHUDVisibility(this._bindParameters),this._renderHUD(su.Occluded,c.framebuffer),this.performanceInfo.advance(Vi.HUD_OCCLUDED)),this.performanceInfo.advance(Vi.TRANSPARENT_TERRAIN),this._setTerrainCulling(!1),f&&(c.compositeTransparentTerrainOntoMain(this._bindParameters),m&&(this._renderEdges(Xt.OPAQUE),this.performanceInfo.advance(Vi.OPAQUE_EDGES),g&&(this._oitEnabled?this._renderOITPass(fC.Geometry):this._renderTransparentGeometry()),this.performanceInfo.advance(Vi.TRANSPARENT),this._renderEdges(Xt.TRANSPARENT),this.performanceInfo.advance(Vi.TRANSPARENT_EDGES))),m&&this._renderLineCallouts(su.NotOccluded),this._setMultipassEnabled(!1),this._shadowAccumulator.render(this._bindParameters),c.renderToTargets(()=>{this._renderInternalSlot(fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._renderSlot(fe.POSTPROCESSING_ENVIRONMENT_TRANSPARENT),this._renderSlot(fe.LASERLINES)},c.currentColorTarget,c.mainDepth),this.performanceInfo.advance(Vi.ENVIRONMENT),this._renderPlugins.needsLaserlineWithContrastControl&&c.renderTmpAndCompositeToMain(()=>this._renderSlot(fe.LASERLINES_CONTRAST_CONTROL),this._bindParameters,Ya.PremultipliedAlpha),this.performanceInfo.advance(Vi.LASER_LINE),this._renderOccluded(),this.performanceInfo.advance(Vi.OCCLUDED);const v=i===VT.ON&&this._magnifierHelper.enabled,b=v&&t==null?this._offscreen.getFramebuffer(this._offscreen.tmpColor,this._offscreen.tmpDepth):t;this._rctx.bindFramebuffer(b);const x=this._offscreen.colorTexture;this._renderAntiAliasing(x)||x==null||this._compositingHelper.composite(this._bindParameters,x,Ya.None),this.performanceInfo.advance(Vi.ANTIALIASING),this._renderHUD(su.NotOccluded,b),this.performanceInfo.advance(Vi.HUD),this._renderHighlights(b,this._bindParameters),this.performanceInfo.advance(Vi.HIGHLIGHTS),v&&this._magnifierHelper.render(this._rctx,this._bindParameters),b!==t&&(this._rctx.bindFramebuffer(t),this._compositingHelper.composite(this._bindParameters,this._offscreen.tmpColorTexture,Ya.None)),this._disposeOITBuffers(),this._renderContext.lastFrameCamera.copyFrom(this._bindParameters.camera),this._sliceHelper.plane=h,this._isRendering=!1,this.onPostRender&&this.onPostRender(),this.performanceInfo.finishFrame()}_prepareShaders(t,e){this._renderContext.output=k.Color,this._prepareOpaqueGeometrySlots(),this._setMultipassTerrain(t),this._prepareSlots(fe.TRANSPARENT_TERRAIN),this._setMultipassTerrain(!1),t||this._prepareInternalSlots(this._materialRenderers,fe.LINE_CALLOUTS),e&&this._prepareTransparencySlots(),this._prepareInternalSlots(this._materialRenderers,fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),this._prepareSlots(fe.POSTPROCESSING_ENVIRONMENT_TRANSPARENT,fe.LASERLINES),this._rctx.gl.flush()}_renderObjectAndLayerIdColor(t){if(t!=null&&le("enable-feature:objectAndLayerId-rendering")){const e=this._renderContext.output;this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>this._renderGeometryAndTransparentTerrainPass(k.ObjectAndLayerIdColor),[0,0,0,0],!0,!0),this._rctx.bindFramebuffer(t),this._offscreen.renderToFBO(()=>{this._bindParameters.renderTransparentlyOccludedHUD=su.NotOccluded,this._renderInternalSlot(fe.HUD_MATERIAL)},void 0,!0,!0),this._renderContext.output=e}}finish(t){this._hasAnimations||this._animationTimestep.clear();const e=this.performanceInfo.gpuSamplingEnabled,r=t===Us.BACKGROUND;if(r||e){const i=r?this.performanceInfo.elapsedTime:0,s=e?this.performanceInfo.totalGPUTimeSampler.last:this._rctx.gl.getError(),n=Math.max(i,s);this._animationTimestep.frame(n,r)}}readDepthPixels(t,e,r){const i=this._offscreen.bindTarget(this._offscreen.linearDepth,this._offscreen.tmpDepth);if(!this._needsLinearDepth){this._ensureBindParameters(t,t),this._bindParameters.camera.setGLViewport(this._rctx),this._rctx.setClearColor(0,0,0,0);const s=Bi.COLOR_BUFFER_BIT|Bi.DEPTH_BUFFER_BIT|Bi.STENCIL_BUFFER_BIT;this._rctx.clearSafe(s),this._renderGeometryAndTransparentTerrainPass(k.Depth)}i.readPixels(e[0],e[1],e[2],e[3],At.RGBA,fn.UNSIGNED_BYTE,r)}readHUDVisibility(t,e,r,i,s){this._offscreen.bindTarget(this._offscreen.hudVisibility).readPixels(t,e,r,i,At.RGBA,fn.UNSIGNED_BYTE,s)}readAccumulatedShadow(t){return this._shadowAccumulator.readAccumulatedShadow(t[0],t[1])}_setMultipassTerrain(t){this._setMultipassEnabled(t),this._setTerrainCulling(t)}_setMultipassEnabled(t){this._bindParameters.multipassTerrain.enabled=this._bindParameters.multipassGeometry.enabled=t}_setTerrainCulling(t){this._bindParameters.multipassTerrain.cullAboveGround=t}_prepareSlots(...t){this._renderPlugins.prepareSlots(t)}_renderSlot(t){this._bindParameters.slot=t,this._renderPlugins.render()}_renderEdges(t,e=!1){const r=this._edgeView;r!=null&&r.shouldRender()&&this._offscreen.renderTmpAndCompositeToMain(()=>r.render(this._bindParameters,t),this._bindParameters,Ya.Alpha,e)}_renderShadowMap(t,e,r,i){const s=this._shadowMap;s.enabled&&(s.start(e,r,i,this.isFeatureEnabled(wn.HighResolutionShadows),this._stage.view.qualitySettings.maximumPixelRatio),this._shadowHighlight.updateParameters(e,r),this._needsShadowHighlight?(this._renderShadowCascades(k.ShadowHighlight,this._shadowMap,n=>s.takeCascadeSnapshotTo(n,GA.Highlight)),s.clear(),this._renderShadowCascades(k.ShadowExcludeHighlight,this._shadowMap,n=>{s.takeCascadeSnapshotTo(n,GA.Default),this._renderGeometryAndTransparentTerrainPass(k.ShadowHighlight)})):this._renderShadowCascades(k.Shadow),s.finish(t),e.setGLViewport(this._rctx))}_renderShadowCascades(t,e=this._shadowMap,r=i=>{}){for(const i of e.cascades)i.camera.setGLViewport(this._rctx),this._prepare(i.camera,i.camera),this._renderGeometryAndTransparentTerrainPass(t),r(i)}get _needsLinearDepth(){return this._ssaoHelper.active||this._renderPlugins.needsLinearDepth||this.hasReflections||this._needsShadowHighlight||this._needsShadowCast}_renderLinearDepth(){this._needsLinearDepth?this._offscreen.renderToTargets(()=>this._renderGeometryAndTransparentTerrainPass(k.Depth),this._offscreen.linearDepth,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.linearDepth),this._bindParameters.linearDepthTexture=this._offscreen.linearDepthTexture}_renderTerrainLinearDepth(t){if(t){const e=this._renderContext.output;this._renderContext.output=k.Depth,this._offscreen.renderToTargets(()=>this._renderTransparentTerrain(),this._offscreen.terrainLinearDepth,this._offscreen.tmpDepth,[-1e10,-1e10,-1e10,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.terrainLinearDepth);this._bindParameters.multipassTerrain.linearDepthTexture=this._offscreen.terrainLinearDepthTexture}_renderGeometryLinearDepth(t){if(t){const e=this._renderContext.output;this._offscreen.renderToTargets(()=>this._renderGeometryPass(k.Depth),this._offscreen.geometryLinearDepth,this._offscreen.tmpDepth,[1,1,1,1],!0,!0),this._renderContext.output=e}else this._offscreen.disposeTarget(this._offscreen.geometryLinearDepth);this._bindParameters.multipassGeometry.linearDepthTexture=this._offscreen.geometryLinearDepthTexture}get _needsNormal(){return this._ssaoHelper.active}_renderNormal(){this._needsNormal?this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(k.Normal)},this._offscreen.normal,this._offscreen.tmpDepth,[0,0,0,0],!0,!0):this._offscreen.disposeTarget(this._offscreen.normal)}get _needsDepthRange(){return this._shadowMap.enabled||this._needsShadowCast}_computeDepthRange(t){if(!this._needsDepthRange)return gJ;const e=TIt(t,this._materialRenderers,this._stage.layers);return qA(e,this.renderPlugins.queryDepthRange(t)),e.near=Math.max(t.near,e.near),e.far=Math.min(t.far,e.far),e}_renderGeometryAndTransparentTerrainPass(t){this._renderContext.output=t,this._prepareSlots(fe.TRANSPARENT_TERRAIN),this._renderGeometryPass(t),this._renderTransparentTerrain()}_renderGeometryPass(t){this._renderContext.output=t,this._prepareSlots(fe.TRANSPARENT_MATERIAL),this._renderOpaqueGeometry(),this._renderTransparentGeometry()}_renderSSAO(t){this._ssaoHelper.render(this._bindParameters,t,this._offscreen.linearDepthTexture,this._offscreen.normalTexture)}_prepareOpaqueGeometrySlots(){this._prepareSlots(fe.INTEGRATED_MESH,fe.OPAQUE_TERRAIN,fe.OPAQUE_MATERIAL,fe.POSTPROCESSING_ENVIRONMENT_OPAQUE),this._prepareInternalSlots(this._materialRenderers,fe.OPAQUE_MATERIAL)}_renderOpaqueGeometry(){this._renderSlot(fe.INTEGRATED_MESH),this._renderSlot(fe.OPAQUE_TERRAIN),this._renderInternalSlot(fe.OPAQUE_MATERIAL),this._renderSlot(fe.OPAQUE_MATERIAL),this._renderSlot(fe.POSTPROCESSING_ENVIRONMENT_OPAQUE)}_renderTransparentGeometry(){this._renderInternalSlot(fe.TRANSPARENT_MATERIAL),this._renderSlot(fe.TRANSPARENT_MATERIAL)}_renderTransparentTerrain(){this._renderSlot(fe.TRANSPARENT_TERRAIN)}_renderHUDVisibility(t){let e=!1;return this._renderContext.offscreenRenderingHelper&&this._renderContext.offscreenRenderingHelper.renderHUDVisibility(()=>{this._bindParameters.hudVisibilityTexture=this._renderContext.offscreenRenderingHelper.hudVisibilityTexture,e=this._renderInternalSlot(fe.OCCLUSION_PIXELS)},t),e}_renderLineCallouts(t){this._bindParameters.renderTransparentlyOccludedHUD=t,t===su.Occluded?this._offscreen.renderToTargets(()=>this._renderInternalSlot(fe.LINE_CALLOUTS),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderInternalSlot(fe.LINE_CALLOUTS)}_renderHUD(t,e){this._hasHUDElements&&(this._oitEnabled?(this._renderOITPass(fC.HUD,t),this._rctx.bindFramebuffer(e),this._compositingHelper.composite(this._bindParameters,this._offscreen.hudColorTexture,Ya.PremultipliedAlpha)):t===su.Occluded?this._offscreen.renderToTargets(()=>this._renderHUDElements(su.Occluded),this._offscreen.currentColorTarget,this._offscreen.tmpDepth,void 0,!0,!0):this._renderHUDElements(t))}_renderHUDElements(t){this._bindParameters.renderTransparentlyOccludedHUD=t,this._prepareInternalSlots(this._materialRenderers,fe.LINE_CALLOUTS_HUD_DEPTH,fe.HUD_MATERIAL,fe.LABEL_MATERIAL),this._renderInternalSlot(fe.LINE_CALLOUTS_HUD_DEPTH),this._renderInternalSlot(fe.HUD_MATERIAL),this._renderInternalSlot(fe.LABEL_MATERIAL)}get _needsHighlight(){return this._hasHighlights||this._renderPlugins.needsHighlight}get _needsShadowHighlight(){return this._shadowMap.enabled&&this._shadowHighlight.isVisible&&this._needsHighlight}_renderHighlights(t,e){if(!this._needsHighlight)return void this._offscreen.disposeTarget(this._offscreen.highlight);const r=this._highlight,i=this._offscreen.renderToTargets(()=>{this._renderGeometryAndTransparentTerrainPass(k.Highlight),this._rctx.clearSafe(Bi.DEPTH_BUFFER_BIT),this._renderHUDElements(su.Both)},this._offscreen.highlight,this._offscreen.tmpDepth,[0,0,0,0],!0,!0);this._bindParameters.highlightColorTexture=i.colorTexture,this._needsShadowHighlight&&this._shadowHighlight.render(e,t),r.render(this._bindParameters,i,t)}get _needsShadowCast(){return this._shadowAccumulator.isAccumulating}_accumulateShadows(t,e,r){this._needsShadowCast&&this._offscreen.linearDepthTexture!=null&&this._shadowAccumulator.renderAccumulation(this._offscreen.linearDepthTexture,t,e,r)}_prepareTransparencySlots(){this._renderContext.output=k.Alpha,this._bindParameters.transparencyPassType=ut.Alpha,this._prepareInternalSlots(this._materialRenderers,fe.TRANSPARENT_MATERIAL),this._prepareSlots(fe.TRANSPARENT_MATERIAL),this._renderContext.output=k.Color,this._bindParameters.transparencyPassType=ut.Color,this._prepareInternalSlots(this._materialRenderers,fe.TRANSPARENT_MATERIAL),this._prepareSlots(fe.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ut.FrontFace,this._prepareInternalSlots(this._materialRenderers,fe.TRANSPARENT_MATERIAL),this._prepareSlots(fe.TRANSPARENT_MATERIAL),this._bindParameters.transparencyPassType=ut.NONE}_renderOITPass(t,e=su.Both){const r=t===fC.HUD,i=r?()=>this._renderHUDElements(e):()=>this._renderTransparentGeometry(),s=o=>{this._bindParameters.transparencyPassType=o,this._offscreen.renderOITPass(i,o,r)},n=this._renderContext.output;this._renderContext.output=k.Alpha,s(ut.Alpha),this._renderContext.output=k.Color,s(ut.Color),s(ut.FrontFace),this._offscreen.compositeTransparentOntoOpaque(this._bindParameters,r),this._bindParameters.transparencyPassType=ut.NONE,this._renderContext.output=n,this._oitUsed=!0}_disposeOITBuffers(){this._oitUsed||(this._offscreen.disposeTarget(this._offscreen.alphaFloatTarget),this._offscreen.disposeTarget(this._offscreen.colorFloatTarget),this._offscreen.disposeTarget(this._offscreen.frontFaceTarget))}_renderOccluded(){let t=0;Gu.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&n.material.renderOccluded===Qi.OccludeAndTransparentStencil&&(t|=n.material.renderOccluded,Gu.push(n))});const e=this._offscreen,r=(n,o,a,l,c)=>{t&o&&(e.renderToTargets(a,e.tmpColor,e.mainDepth,[0,0,0,0],l,c),e.compositeOccludedOntoMain(this._bindParameters,n))};Gu.length!==0&&(this._prepareInternalSlots(Gu,fe.OCCLUDER_MATERIAL,fe.TRANSPARENT_OCCLUDER_MATERIAL),this._renderInternalSlot(fe.OCCLUDER_MATERIAL,Gu),r(.5,Qi.OccludeAndTransparentStencil,()=>this._renderInternalSlot(fe.TRANSPARENT_OCCLUDER_MATERIAL,Gu),!1,!1)),Gu.clear(),this._materialRenderers.forAll(n=>{n.material&&n.material.isVisible()&&(n.material.renderOccluded===Qi.OccludeAndTransparent||n.material.renderOccluded===Qi.Transparent||n.material.renderOccluded===Qi.Opaque)&&(t|=n.material.renderOccluded,Gu.push(n))});const i=this._renderPlugins.renderOccludedFlags;if(t|=i,!t)return;const s=n=>{this._renderContext.renderOccludedMask=n,this._prepareInternalSlots(Gu,fe.OPAQUE_MATERIAL,fe.TRANSPARENT_MATERIAL,fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL),i>Qi.Occlude&&this._renderSlot(fe.OCCLUDED_TERRAIN),this._renderInternalSlot(fe.OPAQUE_MATERIAL,Gu),this._renderInternalSlot(fe.TRANSPARENT_MATERIAL,Gu),this._renderInternalSlot(fe.TRANSPARENT_DEPTH_WRITE_DISABLED_MATERIAL,Gu),this._renderContext.resetRenderOccludedMask()};this._renderContext.output=k.Color,r(.5,Qi.OccludeAndTransparent,()=>s(Qi.OccludeAndTransparent),!0,xc.OutlineVisualElementMask),r(.5,Qi.Transparent,()=>s(Qi.Transparent),!0,xc.OutlineVisualElementMask),r(1,Qi.Opaque,()=>s(Qi.Opaque),!0,xc.OutlineVisualElementMask),Gu.clear()}_renderAntiAliasing(t){if(this._antialiasing){if(this._smaaPass.enable(()=>this._requestRender())&&t!=null)return this._smaaPass.render(t),!0}else this._smaaPass.disable();return!1}_prepare(t,e){this._needsTransparentPass=this._materialRenderers.some(r=>r.requiresSlot(fe.TRANSPARENT_MATERIAL,k.Color)),this._bindParameters.camera=t,this._bindParameters.contentCamera=e}_ensureBindParameters(t,e){this._bindParameters.camera=t,this._bindParameters.contentCamera=e;const r=this._renderContext.offscreenRenderingHelper;this._bindParameters.hudVisibilityTexture=r.hudVisibilityTexture,this._bindParameters.mainColorTexture=r.mainColorTexture,this._bindParameters.highlightDepthTexture=r.depthTexture??this._getFallbackDepthTexture()}_ensureBindParametersSSR(t){if(this._bindParameters.ssr.enabled=this.hasReflections,this._bindParameters.ssr.enabled){this._ssrEnableTime==null&&(this._ssrEnableTime=t),this._renderContext.lastFrameCamera.equals(this._bindParameters.camera)?this._reprojectionMatrix=Un:(so(p0e,this._bindParameters.camera.viewMatrix),so(d0e,this._bindParameters.camera.projectionMatrix),yi(D2,p0e,d0e),yi(D2,this._renderContext.lastFrameCamera.viewMatrix,D2),yi(D2,this._renderContext.lastFrameCamera.projectionMatrix,D2),this._reprojectionMatrix=D2),this._bindParameters.ssr.lastFrameColorTexture=this._offscreen.lastFrameColorTexture;const e=this._stage.view.qualitySettings.fadeDuration;this._bindParameters.ssr.fadeFactor=e>0?Math.min(e,t-this._ssrEnableTime)/e:1,this._bindParameters.ssr.fadeFactor<1&&this._requestRender()}else this._reprojectionMatrix=Un,this._bindParameters.ssr.lastFrameColorTexture=null,this._ssrEnableTime=null}_prepareInternalSlots(t,...e){for(const r of e)this._bindParameters.slot=r,t.forAll(i=>{i.material.shouldRender(this._renderContext)&&i.prepareTechnique(this._renderContext)})}_renderInternalSlot(t,e=this._materialRenderers){let r=!1;return this._bindParameters.slot=t,e.forAll(i=>{if(i.material.shouldRender(this._renderContext)){const s=i.prepareTechnique(this._renderContext);s!=null&&(i.render(this._renderContext,s),r=!0)}}),r}_getFallbackDepthTexture(){return this._fallbackDepthStencilTexture||(this._fallbackDepthStencilTexture=u3e(this._rctx)),this._fallbackDepthStencilTexture}get gpuMemoryUsage(){return{offscreen:this._offscreen?.gpuMemoryUsage??0,highlights:(this._highlight?.gpuMemoryUsage??0)+(this._shadowHighlight?.gpuMemoryUsage??0),shadows:this._shadowMap?.gpuMemoryUsage??0,ssao:this._ssaoHelper?.gpuMemoryUsage??0}}get test(){const t=this;return{offscreen:this._offscreen,shadowMap:this._shadowMap,ssao:this._ssaoHelper,highlight:this._highlight,lighting:this._bindParameters.lighting,materialRenderers:this._materialRenderers,shadowAccumulator:this._shadowAccumulator,weatherIsFading:this._bindParameters.cloudsFade.isFading,resetRenderStateFeatures:()=>{t._renderStateFeatures=The()},getFramebufferTexture:e=>{switch(e){case jv.Color:return t._offscreen.colorTexture;case jv.LinearDepth:return t._offscreen.linearDepthTexture;case jv.Normals:return t._offscreen.normalTexture;case jv.ShadowMap:return t._shadowMap.depthTexture;case jv.HudVisibility:return t._offscreen.hudVisibilityTexture;case jv.Highlight:return t._offscreen.highlightTexture}}}}};var fC,jv;u([d()],Qc.prototype,"_renderPlugins",void 0),u([d()],Qc.prototype,"_shadowAccumulator",void 0),u([d()],Qc.prototype,"_state",void 0),u([d()],Qc.prototype,"_renderStateFeatures",void 0),u([d()],Qc.prototype,"_antialiasingEnabled",void 0),u([d({readOnly:!0})],Qc.prototype,"_antialiasing",null),u([d()],Qc.prototype,"_ssaoEnabled",void 0),u([d()],Qc.prototype,"_smaaPass",void 0),u([d({autoDestroy:!0})],Qc.prototype,"_edgeView",void 0),u([d()],Qc.prototype,"updating",null),u([d()],Qc.prototype,"isCameraFinal",null),Qc=u([R("esri.views.3d.webgl-engine.lib.Renderer")],Qc),function(t){t[t.Geometry=0]="Geometry",t[t.HUD=1]="HUD"}(fC||(fC={})),function(t){t[t.Color=0]="Color",t[t.LinearDepth=1]="LinearDepth",t[t.Normals=2]="Normals",t[t.ShadowMap=3]="ShadowMap",t[t.HudVisibility=4]="HudVisibility",t[t.Highlight=5]="Highlight"}(jv||(jv={}));const Gu=new qt,d0e=xe(),p0e=xe(),D2=xe();function b$t(t){return e=>t.immediate.schedule(e)}let XFe=class YFe{constructor(e){this._rctx=e,this._indexBuffer=this._createIndexbuffer(),this._program=this._createHelperProgram()}static getShaderSources(){return{vertex:`#version 300 es
    precision highp float;

    void main(void) {
      gl_Position = vec4(0.0, 0.0, float(gl_VertexID)-2.0, 1.0);
    }`,fragment:`#version 300 es
    precision highp float;

    out vec4 fragColor;

    void main(void) {
      fragColor = vec4(0.0, 0.0, 0.0, 1.0);
    }`}}_createHelperProgram(){const e=YFe.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}_createIndexbuffer(){return Gr.createIndex(this._rctx,Mr.STATIC_DRAW,new Uint32Array([0]))}resetIndicesType(){this._program.compiled&&this._indexBuffer&&(this._rctx.bindVAO(null),this._rctx.useProgram(this._program),this._rctx.bindBuffer(this._indexBuffer,St.ELEMENT_ARRAY_BUFFER),this._rctx.drawElements(Ot.POINTS,1,rt.UNSIGNED_INT,0))}dispose(){this._program.dispose(),this._indexBuffer.dispose()}},f0e=class{constructor(){this.blend=!1,this.blendColor={r:0,g:0,b:0,a:0},this.blendFunction={srcRGB:Te.ONE,dstRGB:Te.ZERO,srcAlpha:Te.ONE,dstAlpha:Te.ZERO},this.blendEquation={mode:Eg.ADD,modeAlpha:Eg.ADD},this.colorMask={r:!0,g:!0,b:!0,a:!0},this.faceCulling=!1,this.cullFace=ff.BACK,this.frontFace=RA.CCW,this.scissorTest=!1,this.scissorRect={x:0,y:0,width:0,height:0},this.depthTest=!1,this.depthFunction=ci.LESS,this.clearDepth=1,this.depthWrite=!0,this.depthRange={zNear:0,zFar:1},this.viewport=null,this.stencilTest=!1,this.polygonOffsetFill=!1,this.polygonOffset=[0,0],this.stencilFunction={face:ff.FRONT_AND_BACK,func:ci.ALWAYS,ref:0,mask:1},this.clearStencil=0,this.stencilWriteMask=1,this.stencilOperation={face:ff.FRONT_AND_BACK,fail:Gs.KEEP,zFail:Gs.KEEP,zPass:Gs.KEEP},this.clearColor={r:0,g:0,b:0,a:0},this.program=null,this.vertexBuffer=null,this.indexBuffer=null,this.uniformBuffer=null,this.pixelPackBuffer=null,this.pixelUnpackBuffer=null,this.copyReadBuffer=null,this.copyWriteBuffer=null,this.uniformBufferBindingPoints=new Array,this.readFramebuffer=null,this.drawFramebuffer=null,this.renderbuffer=null,this.activeTexture=0,this.textureUnitMap=new Array,this.vertexArrayObject=null}},w$t=class{constructor(e){this._allocations=new Map,e?Error.stackTraceLimit=1/0:(this.add=()=>{},this.remove=()=>{})}add(e){this._allocations.set(e,new Error().stack)}remove(e){this._allocations.delete(e)}get information(){let e="";if(this._allocations.size>0){e+=`${this._allocations.size} live object allocations:
`;const r=new Map;this._allocations.forEach(i=>{r.set(i,(r.get(i)??0)+1)}),r.forEach((i,s)=>{const n=s.split(`
`);n.shift(),n.shift(),e+=`${i}: ${n.shift()}
`,n.forEach(o=>e+=`   ${o}
`)})}return e}};const x$t={RECORD_ALLOCATIONS:!1};let T$t=class{constructor(){for(this._current=new Array,this._max=new Array,this._allocations=new w$t(x$t.RECORD_ALLOCATIONS);this._current.length<io.COUNT;)this._current.push(0),this._max.push(0)}resetMax(){for(this._max.length=0;this._max.length<this._current.length;)this._max.push(0)}increment(e,r){const i=++this._current[e];this._max[e]=Math.max(i,this._max[e]),this._allocations.add(r)}decrement(e,r){--this._current[e],this._allocations.remove(r)}get max(){return this._max}get current(){return this._current}get total(){return this.current.reduce((e,r)=>e+r,0)}get resourceInformation(){let e="";if(this.total>0){e+=`Live objects:
`;for(let r=0;r<io.COUNT;++r){const i=this._current[r];i>0&&(e+=`${io[r]}: ${i}
`)}}return e+=this._allocations.information,e}},S$t=class{constructor(e,r,i){const s=r.textureFilterAnisotropic,n=i.maxAnisotropy??1/0;this.versionString=e.getParameter(e.VERSION),this.maxVertexTextureImageUnits=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),this.maxVertexAttributes=e.getParameter(e.MAX_VERTEX_ATTRIBS),this.maxMaxAnisotropy=s?Math.min(e.getParameter(s.MAX_TEXTURE_MAX_ANISOTROPY),n):1,this.maxTextureImageUnits=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),this.maxTextureSize=e.getParameter(e.MAX_TEXTURE_SIZE),this.maxRenderbufferSize=e.getParameter(e.MAX_RENDERBUFFER_SIZE),this.maxViewportDims=e.getParameter(e.MAX_VIEWPORT_DIMS),jf(e)?(this.maxUniformBufferBindings=e.getParameter(e.MAX_UNIFORM_BUFFER_BINDINGS),this.maxVertexUniformBlocks=e.getParameter(e.MAX_VERTEX_UNIFORM_BLOCKS),this.maxFragmentUniformBlocks=e.getParameter(e.MAX_FRAGMENT_UNIFORM_BLOCKS),this.maxUniformBlockSize=e.getParameter(e.MAX_UNIFORM_BLOCK_SIZE),this.uniformBufferOffsetAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT),this.maxArrayTextureLayers=e.getParameter(e.MAX_ARRAY_TEXTURE_LAYERS),this.maxSamples=e.getParameter(e.MAX_SAMPLES)):(this.maxUniformBufferBindings=0,this.maxVertexUniformBlocks=0,this.maxFragmentUniformBlocks=0,this.maxUniformBlockSize=0,this.uniformBufferOffsetAlignment=1,this.maxArrayTextureLayers=1,this.maxSamples=1)}};const E$t=["layout","centroid","smooth","case","mat2x2","mat2x3","mat2x4","mat3x2","mat3x3","mat3x4","mat4x2","mat4x3","mat4x4","uint","uvec2","uvec3","uvec4","samplerCubeShadow","sampler2DArray","sampler2DArrayShadow","isampler2D","isampler3D","isamplerCube","isampler2DArray","usampler2D","usampler3D","usamplerCube","usampler2DArray","coherent","restrict","readonly","writeonly","resource","atomic_uint","noperspective","patch","sample","subroutine","common","partition","active","filter","image1D","image2D","image3D","imageCube","iimage1D","iimage2D","iimage3D","iimageCube","uimage1D","uimage2D","uimage3D","uimageCube","image1DArray","image2DArray","iimage1DArray","iimage2DArray","uimage1DArray","uimage2DArray","image1DShadow","image2DShadow","image1DArrayShadow","image2DArrayShadow","imageBuffer","iimageBuffer","uimageBuffer","sampler1DArray","sampler1DArrayShadow","isampler1D","isampler1DArray","usampler1D","usampler1DArray","isampler2DRect","usampler2DRect","samplerBuffer","isamplerBuffer","usamplerBuffer","sampler2DMS","isampler2DMS","usampler2DMS","sampler2DMSArray","isampler2DMSArray","usampler2DMSArray","trunc","round","roundEven","isnan","isinf","floatBitsToInt","floatBitsToUint","intBitsToFloat","uintBitsToFloat","packSnorm2x16","unpackSnorm2x16","packUnorm2x16","unpackUnorm2x16","packHalf2x16","unpackHalf2x16","outerProduct","transpose","determinant","inverse","texture","textureSize","textureProj","textureLod","textureOffset","texelFetch","texelFetchOffset","textureProjOffset","textureLodOffset","textureProjLod","textureProjLodOffset","textureGrad","textureGradOffset","textureProjGrad","textureProjGradOffset"];var m0e,JFe={exports:{}};(m0e=["precision","highp","mediump","lowp","attribute","const","uniform","varying","break","continue","do","for","while","if","else","in","out","inout","float","int","void","bool","true","false","discard","return","mat2","mat3","mat4","vec2","vec3","vec4","ivec2","ivec3","ivec4","bvec2","bvec3","bvec4","sampler1D","sampler2D","sampler3D","samplerCube","sampler1DShadow","sampler2DShadow","struct","asm","class","union","enum","typedef","template","this","packed","goto","switch","default","inline","noinline","volatile","public","static","extern","external","interface","long","short","double","half","fixed","unsigned","input","output","hvec2","hvec3","hvec4","dvec2","dvec3","dvec4","fvec2","fvec3","fvec4","sampler2DRect","sampler3DRect","sampler2DRectShadow","sizeof","cast","namespace","using"])!==void 0&&(JFe.exports=m0e);const C$t=p$(JFe.exports);var g0e,EJ={exports:{}};EJ.exports,g0e=EJ,function(t){var e=["<<=",">>=","++","--","<<",">>","<=",">=","==","!=","&&","||","+=","-=","*=","/=","%=","&=","^^","^=","|=","(",")","[","]",".","!","~","*","/","%","+","-","<",">","&","^","|","?",":","=",",",";","{","}"];e!==void 0&&(g0e.exports=e)}();const y0e=p$(EJ.exports);var QFe={exports:{}};(function(t){(function(e){var r=function(){return["abs","acos","all","any","asin","atan","ceil","clamp","cos","cross","dFdx","dFdy","degrees","distance","dot","equal","exp","exp2","faceforward","floor","fract","gl_BackColor","gl_BackLightModelProduct","gl_BackLightProduct","gl_BackMaterial","gl_BackSecondaryColor","gl_ClipPlane","gl_ClipVertex","gl_Color","gl_DepthRange","gl_DepthRangeParameters","gl_EyePlaneQ","gl_EyePlaneR","gl_EyePlaneS","gl_EyePlaneT","gl_Fog","gl_FogCoord","gl_FogFragCoord","gl_FogParameters","gl_FragColor","gl_FragCoord","gl_FragData","gl_FragDepth","gl_FragDepthEXT","gl_FrontColor","gl_FrontFacing","gl_FrontLightModelProduct","gl_FrontLightProduct","gl_FrontMaterial","gl_FrontSecondaryColor","gl_LightModel","gl_LightModelParameters","gl_LightModelProducts","gl_LightProducts","gl_LightSource","gl_LightSourceParameters","gl_MaterialParameters","gl_MaxClipPlanes","gl_MaxCombinedTextureImageUnits","gl_MaxDrawBuffers","gl_MaxFragmentUniformComponents","gl_MaxLights","gl_MaxTextureCoords","gl_MaxTextureImageUnits","gl_MaxTextureUnits","gl_MaxVaryingFloats","gl_MaxVertexAttribs","gl_MaxVertexTextureImageUnits","gl_MaxVertexUniformComponents","gl_ModelViewMatrix","gl_ModelViewMatrixInverse","gl_ModelViewMatrixInverseTranspose","gl_ModelViewMatrixTranspose","gl_ModelViewProjectionMatrix","gl_ModelViewProjectionMatrixInverse","gl_ModelViewProjectionMatrixInverseTranspose","gl_ModelViewProjectionMatrixTranspose","gl_MultiTexCoord0","gl_MultiTexCoord1","gl_MultiTexCoord2","gl_MultiTexCoord3","gl_MultiTexCoord4","gl_MultiTexCoord5","gl_MultiTexCoord6","gl_MultiTexCoord7","gl_Normal","gl_NormalMatrix","gl_NormalScale","gl_ObjectPlaneQ","gl_ObjectPlaneR","gl_ObjectPlaneS","gl_ObjectPlaneT","gl_Point","gl_PointCoord","gl_PointParameters","gl_PointSize","gl_Position","gl_ProjectionMatrix","gl_ProjectionMatrixInverse","gl_ProjectionMatrixInverseTranspose","gl_ProjectionMatrixTranspose","gl_SecondaryColor","gl_TexCoord","gl_TextureEnvColor","gl_TextureMatrix","gl_TextureMatrixInverse","gl_TextureMatrixInverseTranspose","gl_TextureMatrixTranspose","gl_Vertex","greaterThan","greaterThanEqual","inversesqrt","length","lessThan","lessThanEqual","log","log2","matrixCompMult","max","min","mix","mod","normalize","not","notEqual","pow","radians","reflect","refract","sign","sin","smoothstep","sqrt","step","tan","texture2D","texture2DLod","texture2DProj","texture2DProjLod","textureCube","textureCubeLod","texture2DLodEXT","texture2DProjLodEXT","textureCubeLodEXT","texture2DGradEXT","texture2DProjGradEXT","textureCubeGradEXT","textureSize","texelFetch"]}();r!==void 0&&(t.exports=r)})()})(QFe);const A$t=p$(QFe.exports);var xp=999,_0e=9999,_j=0,vj=1,v0e=2,b0e=3,w0e=4,dF=5,O$t=6,R$t=7,M$t=8,x0e=9,I$t=10,T0e=11,P$t=["block-comment","line-comment","preprocessor","operator","integer","float","ident","builtin","keyword","whitespace","eof","integer"];function $$t(){var t,e,r,i=0,s=0,n=xp,o=[],a=[],l=1,c=0,h=0,p=!1,f=!1,m="";return function(U){return a=[],U!==null?_(U.replace?U.replace(/\r\n/g,`
`):U):v()};function g(U){U.length&&a.push({type:P$t[n],data:U,position:h,line:l,column:c})}function _(U){var X;for(i=0,r=(m+=U).length;t=m[i],i<r;){switch(X=i,n){case _j:i=O();break;case vj:i=S();break;case v0e:i=T();break;case b0e:i=A();break;case w0e:i=F();break;case T0e:i=P();break;case dF:i=$();break;case _0e:i=N();break;case x0e:i=x();break;case xp:i=b()}X!==i&&(m[X]===`
`?(c=0,++l):++c)}return s+=i,m=m.slice(i),a}function v(U){return o.length&&g(o.join("")),n=I$t,g("(eof)"),a}function b(){return o=o.length?[]:o,e==="/"&&t==="*"?(h=s+i-1,n=_j,e=t,i+1):e==="/"&&t==="/"?(h=s+i-1,n=vj,e=t,i+1):t==="#"?(n=v0e,h=s+i,i):/\s/.test(t)?(n=x0e,h=s+i,i):(p=/\d/.test(t),f=/[^\w_]/.test(t),h=s+i,n=p?w0e:f?b0e:_0e,i)}function x(){return/[^\s]/g.test(t)?(g(o.join("")),n=xp,i):(o.push(t),e=t,i+1)}function T(){return t!=="\r"&&t!==`
`||e==="\\"?(o.push(t),e=t,i+1):(g(o.join("")),n=xp,i)}function S(){return T()}function O(){return t==="/"&&e==="*"?(o.push(t),g(o.join("")),n=xp,i+1):(o.push(t),e=t,i+1)}function A(){if(e==="."&&/\d/.test(t))return n=dF,i;if(e==="/"&&t==="*")return n=_j,i;if(e==="/"&&t==="/")return n=vj,i;if(t==="."&&o.length){for(;M(o););return n=dF,i}if(t===";"||t===")"||t==="("){if(o.length)for(;M(o););return g(t),n=xp,i+1}var U=o.length===2&&t!=="=";if(/[\w_\d\s]/.test(t)||U){for(;M(o););return n=xp,i}return o.push(t),e=t,i+1}function M(U){for(var X,Z,G=0;;){if(X=y0e.indexOf(U.slice(0,U.length+G).join("")),Z=y0e[X],X===-1){if(G--+U.length>0)continue;Z=U.slice(0,1).join("")}return g(Z),h+=Z.length,(o=o.slice(Z.length)).length}}function P(){return/[^a-fA-F0-9]/.test(t)?(g(o.join("")),n=xp,i):(o.push(t),e=t,i+1)}function F(){return t==="."||/[eE]/.test(t)?(o.push(t),n=dF,e=t,i+1):t==="x"&&o.length===1&&o[0]==="0"?(n=T0e,o.push(t),e=t,i+1):/[^\d]/.test(t)?(g(o.join("")),n=xp,i):(o.push(t),e=t,i+1)}function $(){return t==="f"&&(o.push(t),e=t,i+=1),/[eE]/.test(t)||t==="-"&&/[eE]/.test(e)?(o.push(t),e=t,i+1):/[^\d]/.test(t)?(g(o.join("")),n=xp,i):(o.push(t),e=t,i+1)}function N(){if(/[^\d\w_]/.test(t)){var U=o.join("");return n=C$t.indexOf(U)>-1?M$t:A$t.indexOf(U)>-1?R$t:O$t,g(o.join("")),n=xp,i}return o.push(t),e=t,i+1}}function L$t(t){var e=$$t(),r=[];return r=(r=r.concat(e(t))).concat(e(null))}function D$t(t){return L$t(t)}function N$t(t){return t.map(e=>e.type!=="eof"?e.data:"").join("")}const bj=["GL_OES_standard_derivatives","GL_EXT_frag_depth","GL_EXT_draw_buffers","GL_EXT_shader_texture_lod"];function F$t(t,e="100",r="300 es"){const i=/^\s*\#version\s+([0-9]+(\s+[a-zA-Z]+)?)\s*/;for(const s of t)if(s.type==="preprocessor"){const n=i.exec(s.data);if(n){const o=n[1].replaceAll(/\s\s+/g," ");if(o===r)return o;if(o===e)return s.data="#version "+r,e;throw new Error("unknown glsl version: "+o)}}return t.splice(0,0,{type:"preprocessor",data:"#version "+r},{type:"whitespace",data:`
`}),null}function k$t(t,e){for(let r=e-1;r>=0;r--){const i=t[r];if(i.type!=="whitespace"&&i.type!=="block-comment"){if(i.type!=="keyword")break;if(i.data==="attribute"||i.data==="in")return!0}}return!1}function RM(t,e,r,i){i=i||r;for(const s of t)if(s.type==="ident"&&s.data===r)return i in e?e[i]++:e[i]=0,RM(t,e,i+"_"+e[i],i);return r}function KFe(t,e,r="afterVersion"){function i(l,c){for(let h=c;h<l.length;h++){const p=l[h];if(p.type==="operator"&&p.data===";")return h}return null}function s(l){let c=-1,h=0,p=-1;for(let f=0;f<l.length;f++){const m=l[f];if(m.type==="preprocessor"&&(/\#(if|ifdef|ifndef)\s+.+/.test(m.data)?++h:/\#endif\s*.*/.test(m.data)&&--h),r!=="afterVersion"&&r!=="afterPrecision"||m.type==="preprocessor"&&/^#version/.test(m.data)&&(p=Math.max(p,f)),r==="afterPrecision"&&m.type==="keyword"&&m.data==="precision"){const g=i(l,f);if(g===null)throw new Error("precision statement not followed by any semicolons!");p=Math.max(p,g)}c<p&&h===0&&(c=f)}return c+1}const n={data:`
`,type:"whitespace"},o=l=>l<t.length&&/[^\r\n]$/.test(t[l].data);let a=s(t);o(a-1)&&t.splice(a++,0,n);for(const l of e)t.splice(a++,0,l);o(a-1)&&o(a)&&t.splice(a,0,n)}function U$t(t,e,r,i="lowp"){KFe(t,[{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:i},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function V$t(t,e,r,i,s="lowp"){KFe(t,[{type:"keyword",data:"layout"},{type:"operator",data:"("},{type:"keyword",data:"location"},{type:"whitespace",data:" "},{type:"operator",data:"="},{type:"whitespace",data:" "},{type:"integer",data:i.toString()},{type:"operator",data:")"},{type:"whitespace",data:" "},{type:"keyword",data:"out"},{type:"whitespace",data:" "},{type:"keyword",data:s},{type:"whitespace",data:" "},{type:"keyword",data:r},{type:"whitespace",data:" "},{type:"ident",data:e},{type:"operator",data:";"}],"afterPrecision")}function z$t(t,e){let r,i,s=-1;for(let n=e;n<t.length;n++){const o=t[n];if(o.type==="operator"&&(o.data==="["&&(r=n),o.data==="]")){i=n;break}o.type==="integer"&&(s=parseInt(o.data,10))}return r&&i&&t.splice(r,i-r+1),s}function S0e(t,e){if(t.startsWith("#version 300"))return t;const r=D$t(t);if(F$t(r,"100","300 es")==="300 es")return t;let i=null,s=null;const n={},o={};for(let a=0;a<r.length;++a){const l=r[a];switch(l.type){case"keyword":e===lh.VERTEX_SHADER&&l.data==="attribute"?l.data="in":l.data==="varying"&&(l.data=e===lh.VERTEX_SHADER?"out":"in");break;case"builtin":if(/^texture(2D|Cube)(Proj)?(Lod|Grad)?(EXT)?$/.test(l.data.trim())&&(l.data=l.data.replaceAll(/(2D|Cube|EXT)/g,"")),e===lh.FRAGMENT_SHADER&&l.data==="gl_FragColor"&&(i||(i=RM(r,n,"fragColor"),U$t(r,i,"vec4")),l.data=i),e===lh.FRAGMENT_SHADER&&l.data==="gl_FragData"){const c=z$t(r,a+1),h=RM(r,n,"fragData");V$t(r,h,"vec4",c,"mediump"),l.data=h}else e===lh.FRAGMENT_SHADER&&l.data==="gl_FragDepthEXT"&&(s||(s=RM(r,n,"gl_FragDepth")),l.data=s);break;case"ident":if(E$t.includes(l.data)){if(e===lh.VERTEX_SHADER&&k$t(r,a))throw new Error("attribute in vertex shader uses a name that is a reserved word in glsl 300 es");l.data in o||(o[l.data]=RM(r,n,l.data)),l.data=o[l.data]}}}for(let a=r.length-1;a>=0;--a){const l=r[a];if(l.type==="preprocessor"){const c=l.data.match(/\#extension\s+(.*)\:/);if(c&&c[1]&&bj.includes(c[1].trim())){const f=r[a+1];r.splice(a,f&&f.type==="whitespace"?2:1)}const h=l.data.match(/\#ifdef\s+(.*)/);h&&h[1]&&bj.includes(h[1].trim())&&(l.data="#if 1");const p=l.data.match(/\#ifndef\s+(.*)/);p&&p[1]&&bj.includes(p[1].trim())&&(l.data="#if 0")}}return B$t(t,N$t(r))}function B$t(t,e){return e}const G$t=4294967295;let j$t=class{constructor(e,r,i,s,n=new Map){this._context=e,this._locations=s,this._uniformBlockBindings=n,this._refCount=1,this._compiled=!1,this._nameToUniformLocation={},this._nameToUniform1={},this._nameToUniform1v=new Map,this._nameToUniform2=new Map,this._nameToUniform3=new Map,this._nameToUniform4=new Map,this._nameToUniformMatrix3=new Map,this._nameToUniformMatrix4=new Map,e||console.error("RenderingContext isn't initialized!"),r.length===0&&console.error("Shaders source should not be empty!"),this._context.type===pr.WEBGL2&&(r=S0e(r,lh.VERTEX_SHADER),i=S0e(i,lh.FRAGMENT_SHADER)),this._vShader=E0e(this._context,lh.VERTEX_SHADER,r),this._fShader=E0e(this._context,lh.FRAGMENT_SHADER,i),this._vShader&&this._fShader||console.error("Error loading shaders!"),this._context.instanceCounter.increment(io.Shader,this),oX()&&(this.vertexShader=r,this.fragmentShader=i);const o=this._context.gl,a=o.createProgram();if(o.attachShader(a,this._vShader),o.attachShader(a,this._fShader),this._locations.forEach((l,c)=>o.bindAttribLocation(a,l,c)),o.linkProgram(a),oX()&&!o.getProgramParameter(a,o.LINK_STATUS)&&console.error(`Could not link shader
validated: ${o.getProgramParameter(a,o.VALIDATE_STATUS)}, gl error ${o.getError()}, vertex: ${o.getShaderParameter(this._vShader,o.COMPILE_STATUS)}, fragment: ${o.getShaderParameter(this._fShader,o.COMPILE_STATUS)}, info log: ${o.getProgramInfoLog(a)}, vertex source: ${this.vertexShader}, fragment source: ${this.fragmentShader}`),this._context.type===pr.WEBGL2){const l=o;for(const[c,h]of this._uniformBlockBindings){const p=l.getUniformBlockIndex(a,c);p<G$t&&l.uniformBlockBinding(a,p,h)}}this._glName=a,this._context.instanceCounter.increment(io.Program,this)}get glName(){return this._glName}get hasGLName(){return this._glName!=null}get compiled(){if(this._compiled)return!0;const e=this._context.gl.getExtension("KHR_parallel_shader_compile");return e==null||this.glName==null?(this._compiled=!0,!0):(this._compiled=!!this._context.gl.getProgramParameter(this.glName,e.COMPLETION_STATUS_KHR),this._compiled)}dispose(){if(--this._refCount>0)return;const e=this._context.gl;this._vShader&&(e.deleteShader(this._vShader),this._vShader=null,this._context.instanceCounter.decrement(io.Shader,this)),this._fShader&&(e.deleteShader(this._fShader),this._fShader=null),this._glName&&(e.deleteProgram(this._glName),this._glName=null,this._context.instanceCounter.decrement(io.Program,this))}ref(){++this._refCount}_getUniformLocation(e){return this._nameToUniformLocation[e]===void 0&&this.glName!=null&&(this._nameToUniformLocation[e]=this._context.gl.getUniformLocation(this.glName,e)),this._nameToUniformLocation[e]}hasUniform(e){return this._getUniformLocation(e)!==null}setUniform1i(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1i(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1iv(e,r){fm(this._nameToUniform1v,e,r)&&this._context.gl.uniform1iv(this._getUniformLocation(e),r)}setUniform2iv(e,r){fm(this._nameToUniform2,e,r)&&this._context.gl.uniform2iv(this._getUniformLocation(e),r)}setUniform3iv(e,r){fm(this._nameToUniform3,e,r)&&this._context.gl.uniform3iv(this._getUniformLocation(e),r)}setUniform4iv(e,r){fm(this._nameToUniform4,e,r)&&this._context.gl.uniform4iv(this._getUniformLocation(e),r)}setUniform1f(e,r){const i=this._nameToUniform1[e];i!==void 0&&r===i||(this._context.gl.uniform1f(this._getUniformLocation(e),r),this._nameToUniform1[e]=r)}setUniform1fv(e,r){fm(this._nameToUniform1v,e,r)&&this._context.gl.uniform1fv(this._getUniformLocation(e),r)}setUniform2f(e,r,i){const s=this._nameToUniform2.get(e);s===void 0?(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),this._nameToUniform2.set(e,[r,i])):r===s[0]&&i===s[1]||(this._context.gl.uniform2f(this._getUniformLocation(e),r,i),s[0]=r,s[1]=i)}setUniform2fv(e,r){fm(this._nameToUniform2,e,r)&&this._context.gl.uniform2fv(this._getUniformLocation(e),r)}setUniform3f(e,r,i,s){const n=this._nameToUniform3.get(e);n===void 0?(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),this._nameToUniform3.set(e,[r,i,s])):r===n[0]&&i===n[1]&&s===n[2]||(this._context.gl.uniform3f(this._getUniformLocation(e),r,i,s),n[0]=r,n[1]=i,n[2]=s)}setUniform3fv(e,r){fm(this._nameToUniform3,e,r)&&this._context.gl.uniform3fv(this._getUniformLocation(e),r)}setUniform4f(e,r,i,s,n){const o=this._nameToUniform4.get(e);o===void 0?(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),this._nameToUniform4.set(e,[r,i,s,n])):o!==void 0&&r===o[0]&&i===o[1]&&s===o[2]&&n===o[3]||(this._context.gl.uniform4f(this._getUniformLocation(e),r,i,s,n),o[0]=r,o[1]=i,o[2]=s,o[3]=n)}setUniform4fv(e,r){fm(this._nameToUniform4,e,r)&&this._context.gl.uniform4fv(this._getUniformLocation(e),r)}setUniformMatrix3fv(e,r,i=!1){fm(this._nameToUniformMatrix3,e,r)&&this._context.gl.uniformMatrix3fv(this._getUniformLocation(e),i,r)}setUniformMatrix4fv(e,r,i=!1){fm(this._nameToUniformMatrix4,e,r)&&this._context.gl.uniformMatrix4fv(this._getUniformLocation(e),i,r)}stop(){}};function E0e(t,e,r){const i=t.gl,s=i.createShader(e);return i.shaderSource(s,r),i.compileShader(s),oX()&&!i.getShaderParameter(s,i.COMPILE_STATUS)&&(console.error("Compile error in ".concat(e===lh.VERTEX_SHADER?"vertex":"fragment"," shader")),console.error(i.getShaderInfoLog(s)),console.error(H$t(r))),s}function H$t(t){let e=2;return t.replaceAll(`
`,()=>`
`+q$t(e++)+":")}function q$t(t){return t>=1e3?t.toString():("  "+t).slice(-3)}function fm(t,e,r){const i=t.get(e);return i?AJ(i,r):(t.set(e,Array.from(r)),!0)}let W$t=class{constructor(e){this._rctx=e,this._store=new EO}dispose(){this._store.forEach(e=>e.forEach(r=>r.dispose())),this._store.clear()}acquire(e,r,i,s){const n=this._store.get(e,r);if(n!=null)return n.ref(),n;const o=new j$t(this._rctx,e,r,i,s);return o.ref(),this._store.set(e,r,o),o}get test(){let e=0;return this._store.forEach(r=>r.forEach(i=>e+=i.hasGLName?2:1)),{cachedWebGLObjects:e}}},q$=class{constructor(){this._result=!1}dispose(){this._program=ze(this._program)}get result(){return this._program!=null&&(this._result=this._test(this._program),this.dispose()),this._result}},Z$t=class extends q${constructor(e){super(),this._rctx=e,this._helperProgram=null,this._rctx.type===pr.WEBGL2&&le("mac")&&le("chrome")&&(this._program=this._prepareProgram(),this._helperProgram=this._prepareHelperProgram())}dispose(){super.dispose(),this._helperProgram?.dispose(),this._helperProgram=null}_test(e){const r=this._rctx;r.resetState();const i=new Sr(1);i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.NEAREST;const s=new Vn(r,i),n=Gr.createIndex(this._rctx,Mr.STATIC_DRAW,new Uint8Array([0]));r.bindFramebuffer(s),r.setViewport(0,0,1,1),r.useProgram(this._helperProgram),r.bindBuffer(n,St.ELEMENT_ARRAY_BUFFER),r.drawElements(Ot.POINTS,1,rt.UNSIGNED_BYTE,0),r.useProgram(e),r.bindVAO(null),r.drawArrays(Ot.TRIANGLES,0,258);const o=new Uint8Array(4);return s.readPixels(0,0,1,1,At.RGBA,fn.UNSIGNED_BYTE,o),s.dispose(),n.dispose(),o[0]===255}_prepareProgram(){const r=`#version 300 es
    precision highp float;

    out float triangleId;

    const vec3 triangleVertices[3] = vec3[3](vec3(-0.5, -0.5, 0.0), vec3(0.5, -0.5, 0.0), vec3(0.0, 0.5, 0.0));

    void main(void) {
      triangleId = floor(float(gl_VertexID)/3.0);

      vec3 position = triangleVertices[gl_VertexID % 3];
      float offset = triangleId / ${w.float(85)};
      position.z = 0.5 - offset;

      gl_Position = vec4(position, 1.0);
    }
    `,i=`#version 300 es
    precision highp float;

    in float triangleId;

    out vec4 fragColor;

    void main(void) {
      fragColor = triangleId == ${w.float(85)} ? vec4(0.0, 1.0, 0.0, 1.0) : vec4(1.0, 0.0, 0.0, 1.0);
    }
    `;return this._rctx.programCache.acquire(r,i,new Map([]))}_prepareHelperProgram(){const e=XFe.getShaderSources();return this._rctx.programCache.acquire(e.vertex,e.fragment,new Map([]))}},X$t=class extends q${constructor(e){super(),this._rctx=e,this._program=C0e(this._rctx,!1),this._obfuscated=C0e(this._rctx,!0)}dispose(){super.dispose(),this._obfuscated=ze(this._obfuscated)}_test(e){if(le("force-double-precision-obfuscation"))return!0;if(this._obfuscated==null)return!1;const r=this._runProgram(e),i=this._runProgram(this._obfuscated);return r!==0&&(i===0||r/i>5)}_runProgram(e){const r=this._rctx;r.resetState();const i=new Sr(1);i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.NEAREST;const s=new Vn(r,i),n=Gr.createVertex(r,Mr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Xd(r,new Map([["position",0]]),{geometry:[new sa("position",2,rt.UNSIGNED_SHORT,0,4)]},{geometry:n}),a=Ee(5633261287538229e-9,2626832878767164e-9,1.4349880495278358e6),l=Ee(563327146742708e-8,2.6268736381334523e6,1434963231608387e-9),c=new Float32Array(6);ZX(a,c,3);const h=new Float32Array(6);ZX(l,h,3),r.useProgram(e),e.setUniform3f("u_highA",c[0],c[2],c[4]),e.setUniform3f("u_lowA",c[1],c[3],c[5]),e.setUniform3f("u_highB",h[0],h[2],h[4]),e.setUniform3f("u_lowB",h[1],h[3],h[5]),r.bindFramebuffer(s),r.setViewport(0,0,1,1),r.bindVAO(o),r.drawArrays(Ot.TRIANGLE_STRIP,0,4);const p=new Uint8Array(4);s.readPixels(0,0,1,1,At.RGBA,fn.UNSIGNED_BYTE,p),o.dispose(),s.dispose();const f=(a[2]-l[2])/25,m=kre(p);return Math.abs(f-m)}};function C0e(t,e){const r=`

  precision highp float;

  attribute vec2 position;

  uniform vec3 u_highA;
  uniform vec3 u_lowA;
  uniform vec3 u_highB;
  uniform vec3 u_lowB;

  varying vec4 v_color;

  ${e?"#define DOUBLE_PRECISION_REQUIRES_OBFUSCATION":""}

  #ifdef DOUBLE_PRECISION_REQUIRES_OBFUSCATION

  vec3 dpPlusFrc(vec3 a, vec3 b) {
    return mix(a, a + b, vec3(notEqual(b, vec3(0))));
  }

  vec3 dpMinusFrc(vec3 a, vec3 b) {
    return mix(vec3(0), a - b, vec3(notEqual(a, b)));
  }

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = dpPlusFrc(hiA, hiB);
    vec3 e = dpMinusFrc(t1, hiA);
    vec3 t2 = dpMinusFrc(hiB, e) + dpMinusFrc(hiA, dpMinusFrc(t1, e)) + loA + loB;
    return t1 + t2;
  }

  #else

  vec3 dpAdd(vec3 hiA, vec3 loA, vec3 hiB, vec3 loB) {
    vec3 t1 = hiA + hiB;
    vec3 e = t1 - hiA;
    vec3 t2 = ((hiB - e) + (hiA - (t1 - e))) + loA + loB;
    return t1 + t2;
  }

  #endif

  const float MAX_RGBA_FLOAT =
    255.0 / 256.0 +
    255.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 +
    255.0 / 256.0 / 256.0 / 256.0 / 256.0;

  const vec4 FIXED_POINT_FACTORS = vec4(1.0, 256.0, 256.0 * 256.0, 256.0 * 256.0 * 256.0);

  vec4 float2rgba(const float value) {
    // Make sure value is in the domain we can represent
    float valueInValidDomain = clamp(value, 0.0, MAX_RGBA_FLOAT);

    // Decompose value in 32bit fixed point parts represented as
    // uint8 rgba components. Decomposition uses the fractional part after multiplying
    // by a power of 256 (this removes the bits that are represented in the previous
    // component) and then converts the fractional part to 8bits.
    vec4 fixedPointU8 = floor(fract(valueInValidDomain * FIXED_POINT_FACTORS) * 256.0);

    // Convert uint8 values (from 0 to 255) to floating point representation for
    // the shader
    const float toU8AsFloat = 1.0 / 255.0;

    return fixedPointU8 * toU8AsFloat;
  }

  void main() {
    vec3 val = dpAdd(u_highA, u_lowA, -u_highB, -u_lowB);

    v_color = float2rgba(val.z / 25.0);

    gl_Position = vec4(position * 2.0 - 1.0, 0.0, 1.0);
  }
  `,i=`
  precision highp float;

  varying vec4 v_color;

  void main() {
    gl_FragColor = v_color;
  }
  `;return t.programCache.acquire(r,i,new Map([["position",0]]))}let Y$t=class extends q${constructor(e){if(super(),this._rctx=e,!e.gl)return;if(e.type===pr.WEBGL1)return void(this._result=!(!e.capabilities.textureFloat?.textureFloat||!e.capabilities.colorBufferFloat?.textureFloat));if(!(e.capabilities.textureFloat?.textureFloat&&e.capabilities.colorBufferFloat?.textureFloat&&e.capabilities.colorBufferFloat?.floatBlend))return;const r=`
    precision highp float;
    attribute vec2 a_pos;

    void main() {
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
     precision highp float;

     void main() {
      gl_FragColor = vec4(0.5, 0.5, 0.5, 0.5);
     }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Sr(1);i.wrapMode=Ut.CLAMP_TO_EDGE,i.dataType=fn.FLOAT,i.internalFormat=Je.RGBA32F,i.samplingMode=Mt.NEAREST;const s=new Vn(r,i),n=Gr.createVertex(r,Mr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Xd(r,new Map([["a_pos",0]]),{geometry:[new sa("a_pos",2,rt.UNSIGNED_SHORT,0,4)]},{geometry:n});r.useProgram(e);const a=r.getBoundFramebufferObject(),{x:l,y:c,width:h,height:p}=r.getViewport();r.bindFramebuffer(s),r.setViewport(0,0,1,1),r.bindVAO(o),r.drawArrays(Ot.TRIANGLE_STRIP,0,4);const f=It({blending:APe});r.setPipelineState(f),r.drawArrays(Ot.TRIANGLE_STRIP,0,4);const m=r.gl.getError();return r.setViewport(l,c,h,p),r.bindFramebuffer(a),o.dispose(),s.dispose(),m!==1282||(console.warn("Device claims support for WebGL extension EXT_float_blend but does not support it. Using fall back."),!1)}},J$t=class extends q${constructor(e){super(),this._rctx=e;const r=`
      precision highp float;
      attribute vec2 a_pos;
      uniform highp sampler2D u_texture;
      varying vec4 v_color;

      float getBit(in float bitset, in int bitIndex) {
        float offset = pow(2.0, float(bitIndex));
        return mod(floor(bitset / offset), 2.0);
      }

      void main() {
        vec4 value = texture2D(u_texture, vec2(0.0));
        float bit = getBit(value.x * 255.0, 1);

        v_color = bit * vec4(1.0);
        gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
      }
      `,i=`
      precision highp float;
      varying vec4 v_color;

      void main() {
        gl_FragColor = v_color;
      }
      `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}_test(e){const r=this._rctx,i=new Sr(1);i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.NEAREST;const s=new Vn(r,i),n=new Uint8Array(4),o=Gr.createVertex(r,Mr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),a=new Xd(r,new Map([["a_position",0]]),{geometry:[new sa("a_position",2,rt.SHORT,0,4)]},{geometry:o});r.useProgram(e);const l=new Rt(r,i,new Uint8Array([2,255,0,0]));e.setUniform1i("u_texture",0),r.bindTexture(l,0);const c=r.getBoundFramebufferObject();r.bindFramebuffer(s),r.useProgram(e);const{x:h,y:p,width:f,height:m}=r.getViewport();r.setViewport(0,0,1,1),r.bindVAO(a),r.drawArrays(Ot.TRIANGLE_STRIP,0,4),r.setViewport(h,p,f,m),s.readPixels(0,0,1,1,At.RGBA,fn.UNSIGNED_BYTE,n),a.dispose(),s.dispose();const g=n[0]!==255||n[1]!==255||n[2]!==255||n[3]!==255;return g&&K.getLogger("esri.views.webgl.testSamplerPrecision").warn(`A problem was detected with your graphics driver. Your driver does not appear to honor sampler precision specifiers, which may result in rendering issues due to numerical instability. We recommend ensuring that your drivers have been updated to the latest version. Applying lowp sampler workaround. [${n[0]}.${n[1]}.${n[2]}.${n[3]}]`),r.bindFramebuffer(c),g}};new sa("a_pos",2,rt.BYTE,0,2);new sa("a_pos",2,rt.BYTE,0,4),new sa("a_tex",2,rt.BYTE,2,4);const Q$t={geometry:[new sa("a_pos",2,rt.UNSIGNED_SHORT,0,4)]};let K$t=class extends q${constructor(e){super(),this._rctx=e;const r=`
    precision highp float;

    attribute vec2 a_pos;
    varying vec2 v_uv;

    void main() {
      v_uv = a_pos;
      gl_Position = vec4(a_pos * 2.0 - 1.0, 0.0, 1.0);
    }
    `,i=`
    precision highp float;

    varying vec2 v_uv;

    uniform sampler2D u_texture;

    void main() {
      gl_FragColor = texture2D(u_texture, v_uv);
    }
    `;this._program=e.programCache.acquire(r,i,new Map([["a_pos",0]]))}dispose(){super.dispose()}_test(e){const r=this._rctx;if(!r.gl)return e.dispose(),!0;const i=new Sr(1);i.wrapMode=Ut.CLAMP_TO_EDGE,i.samplingMode=Mt.NEAREST;const s=new Vn(r,i),n=Gr.createVertex(r,Mr.STATIC_DRAW,new Uint16Array([0,0,1,0,0,1,1,1])),o=new Xd(r,new Map([["a_pos",0]]),Q$t,{geometry:n}),a=new Sr;a.samplingMode=Mt.LINEAR,a.wrapMode=Ut.CLAMP_TO_EDGE;const l=new Rt(r,a,MM);r.useProgram(e),r.bindTexture(l,0),e.setUniform1i("u_texture",0);const c=r.getBoundFramebufferObject(),{x:h,y:p,width:f,height:m}=r.getViewport();r.bindFramebuffer(s),r.setViewport(0,0,1,1),r.setClearColor(0,0,0,0),r.setBlendingEnabled(!1),r.clearSafe(Bi.COLOR_BUFFER_BIT),r.bindVAO(o),r.drawArrays(Ot.TRIANGLE_STRIP,0,4);const g=new Uint8Array(4);return s.readPixels(0,0,1,1,At.RGBA,fn.UNSIGNED_BYTE,g),o.dispose(),s.dispose(),l.dispose(),r.setViewport(h,p,f,m),r.bindFramebuffer(c),g[0]!==255}};const MM=new Image;MM.src="data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8'%3F%3E%3Csvg width='5' height='5' version='1.1' viewBox='0 0 5 5' xmlns='http://www.w3.org/2000/svg'%3E%3Crect width='5' height='5' fill='%23f00' fill-opacity='.5'/%3E%3C/svg%3E%0A",MM.width=5,MM.height=5,MM.decode();let eLt=class{constructor(e){this.rctx=e,this.floatBufferBlend=new Y$t(e),this.svgPremultipliesAlpha=new K$t(e),this.doublePrecisionRequiresObfuscation=new X$t(e),this.ignoresSamplerPrecision=new J$t(e),this.drawArraysRequiresIndicesTypeReset=new Z$t(e)}dispose(){this.ignoresSamplerPrecision.dispose(),this.doublePrecisionRequiresObfuscation.dispose(),this.svgPremultipliesAlpha.dispose(),this.floatBufferBlend.dispose(),this.drawArraysRequiresIndicesTypeReset.dispose()}};function tLt(t,e){if(e.disjointTimerQuery)return null;if(jf(t))return{drawBuffers:t.drawBuffers.bind(t),MAX_DRAW_BUFFERS:t.MAX_DRAW_BUFFERS,MAX_COLOR_ATTACHMENTS:t.MAX_COLOR_ATTACHMENTS};if(e.drawBuffers)return null;const r=t.getExtension("WEBGL_draw_buffers");return r?{drawBuffers:r.drawBuffersWEBGL.bind(r),MAX_DRAW_BUFFERS:r.MAX_DRAW_BUFFERS_WEBGL,MAX_COLOR_ATTACHMENTS:r.MAX_COLOR_ATTACHMENTS_WEBGL}:null}function rLt(t){if(jf(t))return t;const e=t.getExtension("ANGLE_instanced_arrays");return e?{drawArraysInstanced:e.drawArraysInstancedANGLE.bind(e),drawElementsInstanced:e.drawElementsInstancedANGLE.bind(e),vertexAttribDivisor:e.vertexAttribDivisorANGLE.bind(e)}:null}function iLt(t,e){if(e.compressedTextureETC)return null;const r=t.getExtension("WEBGL_compressed_texture_etc");return r?{COMPRESSED_R11_EAC:r.COMPRESSED_R11_EAC,COMPRESSED_SIGNED_R11_EAC:r.COMPRESSED_SIGNED_R11_EAC,COMPRESSED_RG11_EAC:r.COMPRESSED_RG11_EAC,COMPRESSED_SIGNED_RG11_EAC:r.COMPRESSED_SIGNED_RG11_EAC,COMPRESSED_RGB8_ETC2:r.COMPRESSED_RGB8_ETC2,COMPRESSED_SRGB8_ETC2:r.COMPRESSED_SRGB8_ETC2,COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2:r.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2,COMPRESSED_RGBA8_ETC2_EAC:r.COMPRESSED_RGBA8_ETC2_EAC,COMPRESSED_SRGB8_ALPHA8_ETC2_EAC:r.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC}:null}function sLt(t,e){if(e.compressedTextureS3TC)return null;const r=t.getExtension("WEBGL_compressed_texture_s3tc");return r?{COMPRESSED_RGB_S3TC_DXT1:r.COMPRESSED_RGB_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT1:r.COMPRESSED_RGBA_S3TC_DXT1_EXT,COMPRESSED_RGBA_S3TC_DXT3:r.COMPRESSED_RGBA_S3TC_DXT3_EXT,COMPRESSED_RGBA_S3TC_DXT5:r.COMPRESSED_RGBA_S3TC_DXT5_EXT}:null}function nLt(t,e){if(jf(t))return{MIN:t.MIN,MAX:t.MAX};if(e.blendMinMax)return null;{const r=t.getExtension("EXT_blend_minmax");return r?{MIN:r.MIN_EXT,MAX:r.MAX_EXT}:null}}function oLt(t,e){if(e.textureFilterAnisotropic)return null;const r=t.getExtension("EXT_texture_filter_anisotropic")||t.getExtension("MOZ_EXT_texture_filter_anisotropic")||t.getExtension("WEBKIT_EXT_texture_filter_anisotropic");return r?{MAX_TEXTURE_MAX_ANISOTROPY:r.MAX_TEXTURE_MAX_ANISOTROPY_EXT,TEXTURE_MAX_ANISOTROPY:r.TEXTURE_MAX_ANISOTROPY_EXT}:null}function aLt(t,e){if(jf(t))return{textureFloat:!0,textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!0,textureHalfFloatLinear:!0,HALF_FLOAT:t.HALF_FLOAT,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F};if(t instanceof WebGLRenderingContext){const r=!e.textureHalfFloat&&t.getExtension("OES_texture_half_float");return{textureFloat:!e.textureFloat&&!!t.getExtension("OES_texture_float"),textureFloatLinear:!e.textureFloatLinear&&!!t.getExtension("OES_texture_float_linear"),textureHalfFloat:!!r,textureHalfFloatLinear:!e.textureHalfFloatLinear&&!!t.getExtension("OES_texture_half_float_linear"),HALF_FLOAT:r?r.HALF_FLOAT_OES:void 0}}return null}function lLt(t,e){if(jf(t)){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float")||!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),i=!e.colorBufferFloat&&t.getExtension("EXT_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,R16F:t.R16F,RG16F:t.RG16F,RGBA16F:t.RGBA16F,R32F:t.R32F,RG32F:t.RG32F,RGBA32F:t.RGBA32F,R11F_G11F_B10F:t.R11F_G11F_B10F,RGB16F:t.RGB16F}:null}if(t instanceof WebGLRenderingContext){const r=!e.colorBufferHalfFloat&&t.getExtension("EXT_color_buffer_half_float"),i=!e.colorBufferFloat&&t.getExtension("WEBGL_color_buffer_float"),s=!e.floatBlend&&!e.colorBufferFloat&&t.getExtension("EXT_float_blend");return r||i||s?{textureFloat:!!i,textureHalfFloat:!!r,floatBlend:!!s,RGBA16F:r?r.RGBA16F_EXT:void 0,RGB16F:r?r.RGB16F_EXT:void 0,RGBA32F:i?i.RGBA32F_EXT:void 0}:null}return null}function A0e(t,e,r,i,s){if(i&&jf(t))return!0;if(e[r])return!1;for(const n of s)if(t.getExtension(n))return!0;return!1}function cLt(t,e){if(!jf(t)||e.textureNorm16)return null;const r=t.getExtension("EXT_texture_norm16");return r?{R16:r.R16_EXT,RG16:r.RG16_EXT,RGB16:r.RGB16_EXT,RGBA16:r.RGBA16_EXT,R16_SNORM:r.R16_SNORM_EXT,RG16_SNORM:r.RG16_SNORM_EXT,RGB16_SNORM:r.RGB16_SNORM_EXT,RGBA16_SNORM:r.RGBA16_SNORM_EXT}:null}function uLt(t,e){const r=e.loseContext&&t.getExtension("WEBGL_lose_context");return r?{loseRenderingContext:()=>r.loseContext()}:null}function hLt(t,e){if(jf(t))return{createVertexArray:t.createVertexArray.bind(t),deleteVertexArray:t.deleteVertexArray.bind(t),bindVertexArray:t.bindVertexArray.bind(t)};if(e.vao)return null;const r=t.getExtension("OES_vertex_array_object")||t.getExtension("MOZ_OES_vertex_array_object")||t.getExtension("WEBKIT_OES_vertex_array_object");return r?{createVertexArray:r.createVertexArrayOES.bind(r),deleteVertexArray:r.deleteVertexArrayOES.bind(r),bindVertexArray:r.bindVertexArrayOES.bind(r)}:null}let dLt=class{constructor(e,r){this._gl=e,this._instancing=null,this._vertexArrayObject=null,this._compressedTextureETC=null,this._compressedTextureS3TC=null,this._textureFilterAnisotropic=null,this._textureFloat=null,this._colorBufferFloat=null,this._minMaxBlending=null,this._loseContext=null,this._drawBuffers=null,this._textureNorm16=null,this._depthTexture=null,this._textureFloatLinear=null,this._disabledExtensions=r.disabledExtensions||{},this._debugWebGLExtensions=r.debugWebGLExtensions||{}}get drawBuffers(){return this._drawBuffers||(this._drawBuffers=tLt(this._gl,this._disabledExtensions)),this._drawBuffers}get instancing(){return this._instancing||(this._instancing=rLt(this._gl)),this._instancing}get vao(){return this._vertexArrayObject||(this._vertexArrayObject=hLt(this._gl,this._disabledExtensions)),this._vertexArrayObject}get compressedTextureETC(){return this._compressedTextureETC||(this._compressedTextureETC=iLt(this._gl,this._disabledExtensions)),this._compressedTextureETC}get compressedTextureS3TC(){return this._compressedTextureS3TC||(this._compressedTextureS3TC=sLt(this._gl,this._disabledExtensions)),this._compressedTextureS3TC}get textureFilterAnisotropic(){return this._textureFilterAnisotropic||(this._textureFilterAnisotropic=oLt(this._gl,this._disabledExtensions)),this._textureFilterAnisotropic}get disjointTimerQuery(){return this._disjointTimerQuery||(this._disjointTimerQuery=g$t(this._gl,this._disabledExtensions)),this._disjointTimerQuery}get textureFloat(){return this._textureFloat||(this._textureFloat=aLt(this._gl,this._disabledExtensions)),this._textureFloat}get colorBufferFloat(){return this._colorBufferFloat||(this._colorBufferFloat=lLt(this._gl,this._disabledExtensions)),this._colorBufferFloat}get blendMinMax(){return this._minMaxBlending||(this._minMaxBlending=nLt(this._gl,this._disabledExtensions)),this._minMaxBlending}get depthTexture(){return this._depthTexture===null&&(this._depthTexture=A0e(this._gl,this._disabledExtensions,"depthTexture",!0,["WEBGL_depth_texture","MOZ_WEBGL_depth_texture","WEBKIT_WEBGL_depth_texture"])),this._depthTexture}get loseContext(){return this._loseContext||(this._loseContext=uLt(this._gl,this._debugWebGLExtensions)),this._loseContext}get textureNorm16(){return this._textureNorm16||(this._textureNorm16=cLt(this._gl,this._disabledExtensions)),this._textureNorm16}get textureFloatLinear(){return this._textureFloatLinear===null&&(this._textureFloatLinear=A0e(this._gl,this._disabledExtensions,"textureFloatLinear",!1,["OES_texture_float_linear"])),this._textureFloatLinear}enable(e){return this[e]}},pLt=class{constructor(e,r){this.gl=e,this.instanceCounter=new T$t,this.programCache=new W$t(this),this._state=new f0e,this._numOfDrawCalls=0,this._numOfTriangles=0,this.type=jf(e)?pr.WEBGL2:pr.WEBGL1,this._loadExtensions(),this.configure(r)}get gl2(){return this.type===pr.WEBGL1?null:this.gl}configure(e){this._capabilities=new dLt(this.gl,e),this._parameters=new S$t(this.gl,this._capabilities,e),Rt.TEXTURE_UNIT_FOR_UPDATES=this._parameters.maxTextureImageUnits-1;const r=this.gl.getParameter(this.gl.VIEWPORT);this._state=new f0e,this._state.viewport={x:r[0],y:r[1],width:r[2],height:r[3]},this._stateTracker=new _ht({setBlending:i=>{if(i){this.setBlendingEnabled(!0),this.setBlendEquationSeparate(i.opRgb,i.opAlpha),this.setBlendFunctionSeparate(i.srcRgb,i.dstRgb,i.srcAlpha,i.dstAlpha);const s=i.color;this.setBlendColor(s.r,s.g,s.b,s.a)}else this.setBlendingEnabled(!1)},setCulling:i=>{i?(this.setFaceCullingEnabled(!0),this.setCullFace(i.face),this.setFrontFace(i.mode)):this.setFaceCullingEnabled(!1)},setPolygonOffset:i=>{i?(this.setPolygonOffsetFillEnabled(!0),this.setPolygonOffset(i.factor,i.units)):this.setPolygonOffsetFillEnabled(!1)},setDepthTest:i=>{i?(this.setDepthTestEnabled(!0),this.setDepthFunction(i.func)):this.setDepthTestEnabled(!1)},setStencilTest:i=>{if(i){this.setStencilTestEnabled(!0);const s=i.function;this.setStencilFunction(s.func,s.ref,s.mask);const n=i.operation;this.setStencilOp(n.fail,n.zFail,n.zPass)}else this.setStencilTestEnabled(!1)},setDepthWrite:i=>{i?(this.setDepthWriteEnabled(!0),this.setDepthRange(i.zNear,i.zFar)):this.setDepthWriteEnabled(!1)},setColorWrite:i=>{i?this.setColorMask(i.r,i.g,i.b,i.a):this.setColorMask(!1,!1,!1,!1)},setStencilWrite:i=>{i?this.setStencilWriteMask(i.mask):this.setStencilWriteMask(0)}}),this.enforceState(),ze(this._driverTest),this._driverTest=new eLt(this)}dispose(){ze(this._driverTest),this.programCache.dispose(),this.bindVAO(null),this.unbindBuffer(St.ARRAY_BUFFER),this.unbindBuffer(St.ELEMENT_ARRAY_BUFFER),this.type===pr.WEBGL2&&(this.unbindBuffer(St.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(St.PIXEL_PACK_BUFFER),this.unbindBuffer(St.PIXEL_UNPACK_BUFFER),this.unbindBuffer(St.COPY_READ_BUFFER),this.unbindBuffer(St.COPY_WRITE_BUFFER)),this._state.textureUnitMap.length=0,fd()&&console.log(this.instanceCounter.resourceInformation)}get driverTest(){return this._driverTest}get contextAttributes(){return this.gl.getContextAttributes()}get parameters(){return this._parameters}setPipelineState(e){this._stateTracker.setPipeline(e)}setBlendingEnabled(e){this._state.blend!==e&&(e===!0?this.gl.enable(this.gl.BLEND):this.gl.disable(this.gl.BLEND),this._state.blend=e,this._stateTracker.invalidateBlending())}externalProgramUpdate(){this._state.program?.stop(),this._state.program=null}externalTextureUnitUpdate(e,r){for(let i=0;i<e.length;++i)this._state.textureUnitMap[e[i]]=null;r>=0&&(this._state.activeTexture=r)}externalVertexArrayObjectUpdate(){const e=this.capabilities.vao;e&&(e.bindVertexArray(null),this._state.vertexArrayObject=null),this._state.vertexBuffer=null,this._state.indexBuffer=null}externalVertexBufferUpdate(){this._state.vertexBuffer=null}externalIndexBufferUpdate(){this._state.indexBuffer=null}setBlendColor(e,r,i,s){e===this._state.blendColor.r&&r===this._state.blendColor.g&&i===this._state.blendColor.b&&s===this._state.blendColor.a||(this.gl.blendColor(e,r,i,s),this._state.blendColor.r=e,this._state.blendColor.g=r,this._state.blendColor.b=i,this._state.blendColor.a=s,this._stateTracker.invalidateBlending())}setBlendFunction(e,r){e===this._state.blendFunction.srcRGB&&r===this._state.blendFunction.dstRGB||(this.gl.blendFunc(e,r),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=e,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=r,this._stateTracker.invalidateBlending())}setBlendFunctionSeparate(e,r,i,s){this._state.blendFunction.srcRGB===e&&this._state.blendFunction.srcAlpha===i&&this._state.blendFunction.dstRGB===r&&this._state.blendFunction.dstAlpha===s||(this.gl.blendFuncSeparate(e,r,i,s),this._state.blendFunction.srcRGB=e,this._state.blendFunction.srcAlpha=i,this._state.blendFunction.dstRGB=r,this._state.blendFunction.dstAlpha=s,this._stateTracker.invalidateBlending())}setBlendEquation(e){this._state.blendEquation.mode!==e&&(this.gl.blendEquation(e),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=e,this._stateTracker.invalidateBlending())}setBlendEquationSeparate(e,r){this._state.blendEquation.mode===e&&this._state.blendEquation.modeAlpha===r||(this.gl.blendEquationSeparate(e,r),this._state.blendEquation.mode=e,this._state.blendEquation.modeAlpha=r,this._stateTracker.invalidateBlending())}setColorMask(e,r,i,s){this._state.colorMask.r===e&&this._state.colorMask.g===r&&this._state.colorMask.b===i&&this._state.colorMask.a===s||(this.gl.colorMask(e,r,i,s),this._state.colorMask.r=e,this._state.colorMask.g=r,this._state.colorMask.b=i,this._state.colorMask.a=s,this._stateTracker.invalidateColorWrite())}setClearColor(e,r,i,s){this._state.clearColor.r===e&&this._state.clearColor.g===r&&this._state.clearColor.b===i&&this._state.clearColor.a===s||(this.gl.clearColor(e,r,i,s),this._state.clearColor.r=e,this._state.clearColor.g=r,this._state.clearColor.b=i,this._state.clearColor.a=s)}setFaceCullingEnabled(e){this._state.faceCulling!==e&&(e===!0?this.gl.enable(this.gl.CULL_FACE):this.gl.disable(this.gl.CULL_FACE),this._state.faceCulling=e,this._stateTracker.invalidateCulling())}setPolygonOffsetFillEnabled(e){this._state.polygonOffsetFill!==e&&(e===!0?this.gl.enable(this.gl.POLYGON_OFFSET_FILL):this.gl.disable(this.gl.POLYGON_OFFSET_FILL),this._state.polygonOffsetFill=e,this._stateTracker.invalidatePolygonOffset())}setPolygonOffset(e,r){this._state.polygonOffset[0]===e&&this._state.polygonOffset[1]===r||(this._state.polygonOffset[0]=e,this._state.polygonOffset[1]=r,this.gl.polygonOffset(e,r),this._stateTracker.invalidatePolygonOffset())}setCullFace(e){this._state.cullFace!==e&&(this.gl.cullFace(e),this._state.cullFace=e,this._stateTracker.invalidateCulling())}setFrontFace(e){this._state.frontFace!==e&&(this.gl.frontFace(e),this._state.frontFace=e,this._stateTracker.invalidateCulling())}setScissorTestEnabled(e){this._state.scissorTest!==e&&(e===!0?this.gl.enable(this.gl.SCISSOR_TEST):this.gl.disable(this.gl.SCISSOR_TEST),this._state.scissorTest=e)}setScissorRect(e,r,i,s){this._state.scissorRect.x===e&&this._state.scissorRect.y===r&&this._state.scissorRect.width===i&&this._state.scissorRect.height===s||(this.gl.scissor(e,r,i,s),this._state.scissorRect.x=e,this._state.scissorRect.y=r,this._state.scissorRect.width=i,this._state.scissorRect.height=s)}setDepthTestEnabled(e){this._state.depthTest!==e&&(e===!0?this.gl.enable(this.gl.DEPTH_TEST):this.gl.disable(this.gl.DEPTH_TEST),this._state.depthTest=e,this._stateTracker.invalidateDepthTest())}setClearDepth(e){this._state.clearDepth!==e&&(this.gl.clearDepth(e),this._state.clearDepth=e)}setDepthFunction(e){this._state.depthFunction!==e&&(this.gl.depthFunc(e),this._state.depthFunction=e,this._stateTracker.invalidateDepthTest())}setDepthWriteEnabled(e){this._state.depthWrite!==e&&(this.gl.depthMask(e),this._state.depthWrite=e,this._stateTracker.invalidateDepthWrite())}setDepthRange(e,r){this._state.depthRange.zNear===e&&this._state.depthRange.zFar===r||(this.gl.depthRange(e,r),this._state.depthRange.zNear=e,this._state.depthRange.zFar=r,this._stateTracker.invalidateDepthWrite())}setStencilTestEnabled(e){this._state.stencilTest!==e&&(e===!0?this.gl.enable(this.gl.STENCIL_TEST):this.gl.disable(this.gl.STENCIL_TEST),this._state.stencilTest=e,this._stateTracker.invalidateStencilTest())}setClearStencil(e){e!==this._state.clearStencil&&(this.gl.clearStencil(e),this._state.clearStencil=e)}setStencilFunction(e,r,i){this._state.stencilFunction.func===e&&this._state.stencilFunction.ref===r&&this._state.stencilFunction.mask===i||(this.gl.stencilFunc(e,r,i),this._state.stencilFunction.face=ff.FRONT_AND_BACK,this._state.stencilFunction.func=e,this._state.stencilFunction.ref=r,this._state.stencilFunction.mask=i,this._stateTracker.invalidateStencilTest())}setStencilFunctionSeparate(e,r,i,s){this._state.stencilFunction.face===e&&this._state.stencilFunction.func===r&&this._state.stencilFunction.ref===i&&this._state.stencilFunction.mask===s||(this.gl.stencilFuncSeparate(e,r,i,s),this._state.stencilFunction.face=e,this._state.stencilFunction.func=r,this._state.stencilFunction.ref=i,this._state.stencilFunction.mask=s,this._stateTracker.invalidateStencilTest())}setStencilWriteMask(e){this._state.stencilWriteMask!==e&&(this.gl.stencilMask(e),this._state.stencilWriteMask=e,this._stateTracker.invalidateStencilWrite())}setStencilOp(e,r,i){this._state.stencilOperation.face===ff.FRONT_AND_BACK&&this._state.stencilOperation.fail===e&&this._state.stencilOperation.zFail===r&&this._state.stencilOperation.zPass===i||(this.gl.stencilOp(e,r,i),this._state.stencilOperation.face=ff.FRONT_AND_BACK,this._state.stencilOperation.fail=e,this._state.stencilOperation.zFail=r,this._state.stencilOperation.zPass=i,this._stateTracker.invalidateStencilTest())}setStencilOpSeparate(e,r,i,s){this._state.stencilOperation.face===e&&this._state.stencilOperation.fail===r&&this._state.stencilOperation.zFail===i&&this._state.stencilOperation.zPass===s||(this.gl.stencilOpSeparate(e,r,i,s),this._state.stencilOperation.face=e,this._state.stencilOperation.fail=r,this._state.stencilOperation.zFail=i,this._state.stencilOperation.zPass=s,this._stateTracker.invalidateStencilTest())}setActiveTexture(e,r=!1){const i=this._state.activeTexture;return e>=0&&(r||e!==this._state.activeTexture)&&(this.gl.activeTexture(Jz+e),this._state.activeTexture=e),i}clear(e){e&&this.gl.clear(e)}clearSafe(e,r=255){e&&(e&Bi.COLOR_BUFFER_BIT&&this.setColorMask(!0,!0,!0,!0),e&Bi.DEPTH_BUFFER_BIT&&this.setDepthWriteEnabled(!0),e&Bi.STENCIL_BUFFER_BIT&&this.setStencilWriteMask(r),this.gl.clear(e))}drawArrays(e,r,i){if(fd()&&(this._numOfDrawCalls++,this._numOfTriangles+=O0e(e,i)),this.gl.drawArrays(e,r,i),fd()){const s=kue(this);s&&console.error("drawArrays:",s)}}drawElements(e,r,i,s){if(fd()&&(this._numOfDrawCalls++,this._numOfTriangles+=O0e(e,r)),this.gl.drawElements(e,r,i,s),fd()){const n=kue(this);if(n){const o=this.getBoundVAO(),a=o?.indexBuffer,l=o?.vertexBuffers,c={indexBuffer:a,vertexBuffers:l},h={mode:e,count:r,type:i,offset:s},p=a?.size??0,f=s+r,m=p<f?`. Buffer is too small. Attempted to draw index ${f} of ${p}`:"";console.error(`drawElements: ${n}${m}`,{args:h,vao:c})}}}logInfo(){fd()&&console.log(`DrawCalls: ${this._numOfDrawCalls}, Triangles: ${this._numOfTriangles}`)}resetInfo(){fd()&&(this._numOfDrawCalls=0,this._numOfTriangles=0)}get capabilities(){return this._capabilities}setViewport(e,r,i,s){i=Math.max(Math.round(i),1),s=Math.max(Math.round(s),1);const n=this._state.viewport;n.x===e&&n.y===r&&n.width===i&&n.height===s||(n.x=e,n.y=r,n.width=i,n.height=s,this.gl.viewport(e,r,i,s))}getViewport(){const e=this._state.viewport;return{x:e.x,y:e.y,width:e.width,height:e.height}}useProgram(e){this._state.program!==e&&(this._state.program?.stop(),this._state.program=e,this.gl.useProgram(e?.glName??null))}bindTexture(e,r,i=!1){(r>=this.parameters.maxTextureImageUnits||r<0)&&console.error("Input texture unit is out of range of available units!");const s=this._state.textureUnitMap[r];return e==null||e.glName==null?(s!=null&&(this.setActiveTexture(r,i),this.gl.bindTexture(s.descriptor.target,null)),this._state.textureUnitMap[r]=null,s):i||s!==e?(this.setActiveTexture(r,i),this.gl.bindTexture(e.descriptor.target,e.glName),e.applyChanges(),this._state.textureUnitMap[r]=e,s):(e.isDirty&&(this.setActiveTexture(r,i),e.applyChanges()),s)}unbindTexture(e){if(e!=null)for(let r=0;r<this.parameters.maxTextureImageUnits;r++)this._state.textureUnitMap[r]===e&&(this.bindTexture(null,r),this._state.textureUnitMap[r]=null)}bindFramebuffer(e,r=!1){if(r||this._state.readFramebuffer!==e||this._state.drawFramebuffer!==e){if(e==null)return this.gl.bindFramebuffer(ea.FRAMEBUFFER,null),this._state.readFramebuffer=null,void(this._state.drawFramebuffer=null);e.initializeAndBind(ea.FRAMEBUFFER),this._state.readFramebuffer=e,this._state.drawFramebuffer=e}}bindFramebufferSeparate(e,r,i=!1){const s=r===ea.READ_FRAMEBUFFER,n=s?this._state.readFramebuffer:this._state.drawFramebuffer;(i||n!==e)&&(e==null?this.gl.bindFramebuffer(r,null):e.initializeAndBind(r),s?this._state.readFramebuffer=e??null:this._state.drawFramebuffer=e??null)}blitFramebuffer(e,r,i=0,s=0,n=e.width,o=e.height,a=0,l=0,c=r.width,h=r.height,p=Bi.COLOR_BUFFER_BIT,f=Mt.NEAREST){this.bindFramebufferSeparate(e,ea.READ_FRAMEBUFFER),this.bindFramebufferSeparate(r,ea.DRAW_FRAMEBUFFER),this.gl.blitFramebuffer(i,s,n,o,a,l,c,h,p,f)}bindBuffer(e,r){if(e)switch(r??(r=e.bufferType),r){case St.ARRAY_BUFFER:this._state.vertexBuffer=Vc(this.gl,e,r,this._state.vertexBuffer);break;case St.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Vc(this.gl,e,r,this._state.indexBuffer);break;case St.UNIFORM_BUFFER:this._state.uniformBuffer=Vc(this.gl,e,r,this._state.uniformBuffer);break;case St.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Vc(this.gl,e,r,this._state.pixelPackBuffer);break;case St.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Vc(this.gl,e,r,this._state.pixelUnpackBuffer);break;case St.COPY_READ_BUFFER:this._state.copyReadBuffer=Vc(this.gl,e,r,this._state.copyReadBuffer);break;case St.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Vc(this.gl,e,r,this._state.copyWriteBuffer)}}bindRenderbuffer(e){const r=this.gl;e||(r.bindRenderbuffer(r.RENDERBUFFER,null),this._state.renderbuffer=null),this._state.renderbuffer!==e&&(r.bindRenderbuffer(r.RENDERBUFFER,e.glName),this._state.renderbuffer=e)}_getBufferBinding(e,r){if(r>=this.parameters.maxUniformBufferBindings||r<0)return console.error("Uniform buffer binding point is out of range!"),null;const i=this._state.uniformBufferBindingPoints;let s=i[r];return s==null&&(s={buffer:null,offset:0,size:0},i[r]=s),s}bindBufferBase(e,r,i){const s=this._getBufferBinding(e,r);s!=null&&(s.buffer===i&&s.offset===0&&s.size===0||(this.gl.bindBufferBase(e,r,i?i.glName:null),s.buffer=i,s.offset=0,s.size=0))}bindBufferRange(e,r,i,s,n){const o=this._getBufferBinding(e,r);if(o!=null&&!(o.buffer===i&&o.offset===s&&o.size===n)){if(s%this._parameters.uniformBufferOffsetAlignment!=0)return void console.error("Uniform buffer binding offset is not a multiple of the context offset alignment");this.gl.bindBufferRange(e,r,i.glName,s,n),o.buffer=i,o.offset=s,o.size=n}}bindUBO(e,r,i,s){r!=null?(fd()&&(s??r.byteLength)>this._parameters.maxUniformBlockSize&&console.error("Attempting to bind more data than the maximum uniform block size"),r.initialize(),i!==void 0&&s!==void 0?this.bindBufferRange(St.UNIFORM_BUFFER,e,r.buffer,i,s):this.bindBufferBase(St.UNIFORM_BUFFER,e,r.buffer)):this.bindBufferBase(St.UNIFORM_BUFFER,e,null)}unbindUBO(e){for(let r=0,i=this._state.uniformBufferBindingPoints.length;r<i;r++){const s=this._state.uniformBufferBindingPoints[r];s!=null&&s.buffer===e.buffer&&this.bindBufferBase(St.UNIFORM_BUFFER,r,null)}}unbindBuffer(e){switch(e){case St.ARRAY_BUFFER:this._state.vertexBuffer=Vc(this.gl,null,e,this._state.vertexBuffer);break;case St.ELEMENT_ARRAY_BUFFER:this._state.indexBuffer=Vc(this.gl,null,e,this._state.indexBuffer);break;case St.UNIFORM_BUFFER:this._state.uniformBuffer=Vc(this.gl,null,e,this._state.uniformBuffer);break;case St.PIXEL_PACK_BUFFER:this._state.pixelPackBuffer=Vc(this.gl,null,e,this._state.pixelPackBuffer);break;case St.PIXEL_UNPACK_BUFFER:this._state.pixelUnpackBuffer=Vc(this.gl,null,e,this._state.pixelUnpackBuffer);break;case St.COPY_READ_BUFFER:this._state.copyReadBuffer=Vc(this.gl,null,e,this._state.copyReadBuffer);break;case St.COPY_WRITE_BUFFER:this._state.copyWriteBuffer=Vc(this.gl,null,e,this._state.copyWriteBuffer)}}bindVAO(e=null){e!=null?this._state.vertexArrayObject!==e&&(e.bind(),this._state.vertexArrayObject=e):this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null)}async clientWaitAsync(e=10){const r=this.gl,i=r.fenceSync(nX.SYNC_GPU_COMMANDS_COMPLETE,0);if(!i)throw new Error("Client wait failed, could not create sync object");let s;this.instanceCounter.increment(io.Sync,i),r.flush();do await YC(e),s=r.clientWaitSync(i,0,0);while(s===pU.TIMEOUT_EXPIRED);if(this.instanceCounter.decrement(io.Sync,i),r.deleteSync(i),s===pU.WAIT_FAILED)throw new Error("Client wait failed")}getBoundFramebufferObject(e=ea.FRAMEBUFFER){return e===ea.READ_FRAMEBUFFER?this._state.readFramebuffer:this._state.drawFramebuffer}getBoundVAO(){return this._state.vertexArrayObject}resetState(){this.useProgram(null),this.bindVAO(null),this.bindFramebuffer(null,!0),this.unbindBuffer(St.ARRAY_BUFFER),this.unbindBuffer(St.ELEMENT_ARRAY_BUFFER),this.type===pr.WEBGL2&&(this.unbindBuffer(St.UNIFORM_BUFFER),this._state.uniformBufferBindingPoints.length=0,this.unbindBuffer(St.PIXEL_PACK_BUFFER),this.unbindBuffer(St.PIXEL_UNPACK_BUFFER),this.unbindBuffer(St.COPY_READ_BUFFER),this.unbindBuffer(St.COPY_WRITE_BUFFER));for(let e=0;e<this.parameters.maxTextureImageUnits;++e)this.bindTexture(null,e);this.setBlendingEnabled(!1),this.setBlendFunction(Te.ONE,Te.ZERO),this.setBlendEquation(Eg.ADD),this.setBlendColor(0,0,0,0),this.setFaceCullingEnabled(!1),this.setCullFace(ff.BACK),this.setFrontFace(RA.CCW),this.setPolygonOffsetFillEnabled(!1),this.setPolygonOffset(0,0),this.setScissorTestEnabled(!1),this.setScissorRect(0,0,this.gl.canvas.width,this.gl.canvas.height),this.setDepthTestEnabled(!1),this.setDepthFunction(ci.LESS),this.setDepthRange(0,1),this.setStencilTestEnabled(!1),this.setStencilFunction(ci.ALWAYS,0,0),this.setStencilOp(Gs.KEEP,Gs.KEEP,Gs.KEEP),this.setClearColor(0,0,0,0),this.setClearDepth(1),this.setClearStencil(0),this.setColorMask(!0,!0,!0,!0),this.setStencilWriteMask(4294967295),this.setDepthWriteEnabled(!0),this.setViewport(0,0,this.gl.canvas.width,this.gl.canvas.height)}enforceState(){const e=this.capabilities.vao;e&&e.bindVertexArray(null);const{gl:r,gl2:i}=this;for(let n=0;n<this.parameters.maxVertexAttributes;n++)r.disableVertexAttribArray(n);if(this._state.vertexBuffer?r.bindBuffer(this._state.vertexBuffer.bufferType,this._state.vertexBuffer.glName):r.bindBuffer(St.ARRAY_BUFFER,null),this._state.indexBuffer?r.bindBuffer(this._state.indexBuffer.bufferType,this._state.indexBuffer.glName):r.bindBuffer(St.ELEMENT_ARRAY_BUFFER,null),i!=null){this._state.uniformBuffer?i.bindBuffer(this._state.uniformBuffer.bufferType,this._state.uniformBuffer.glName):i.bindBuffer(St.UNIFORM_BUFFER,null);for(let n=0;n<this._parameters.maxUniformBufferBindings;n++){const o=this._state.uniformBufferBindingPoints[n];if(o!=null){const{buffer:a,offset:l,size:c}=o;a!==null?l===0&&c===0?i.bindBufferBase(St.UNIFORM_BUFFER,n,a.glName):i.bindBufferRange(St.UNIFORM_BUFFER,n,a.glName,l,c):i.bindBufferBase(St.UNIFORM_BUFFER,n,null)}}this._state.pixelPackBuffer?i.bindBuffer(this._state.pixelPackBuffer.bufferType,this._state.pixelPackBuffer.glName):i.bindBuffer(St.PIXEL_PACK_BUFFER,null),this._state.pixelUnpackBuffer?i.bindBuffer(this._state.pixelUnpackBuffer.bufferType,this._state.pixelUnpackBuffer.glName):i.bindBuffer(St.PIXEL_UNPACK_BUFFER,null),this._state.copyReadBuffer?i.bindBuffer(this._state.copyReadBuffer.bufferType,this._state.copyReadBuffer.glName):i.bindBuffer(St.COPY_READ_BUFFER,null),this._state.copyWriteBuffer?i.bindBuffer(this._state.copyWriteBuffer.bufferType,this._state.copyWriteBuffer.glName):i.bindBuffer(St.COPY_WRITE_BUFFER,null),i.bindFramebuffer(ea.READ_FRAMEBUFFER,null),i.readBuffer(i.BACK),this._state.readFramebuffer&&(i.bindFramebuffer(ea.READ_FRAMEBUFFER,this._state.readFramebuffer.glName),i.readBuffer(eh.COLOR_ATTACHMENT0)),i.bindFramebuffer(ea.DRAW_FRAMEBUFFER,this._state.drawFramebuffer?.glName??null)}else this._state.readFramebuffer=this._state.drawFramebuffer,r.bindFramebuffer(ea.FRAMEBUFFER,this._state.drawFramebuffer?.glName??null);if(e&&this._state.vertexArrayObject){const n=this._state.vertexArrayObject;this._state.vertexArrayObject&&(this._state.vertexArrayObject.unbind(),this._state.vertexArrayObject=null),this.bindVAO(n)}r.useProgram(this._state.program?.glName??null),r.blendColor(this._state.blendColor.r,this._state.blendColor.g,this._state.blendColor.b,this._state.blendColor.a),r.bindRenderbuffer(r.RENDERBUFFER,this._state.renderbuffer?this._state.renderbuffer.glName:null),this._state.blend===!0?r.enable(this.gl.BLEND):r.disable(this.gl.BLEND),r.blendEquationSeparate(this._state.blendEquation.mode,this._state.blendEquation.modeAlpha),r.blendFuncSeparate(this._state.blendFunction.srcRGB,this._state.blendFunction.dstRGB,this._state.blendFunction.srcAlpha,this._state.blendFunction.dstAlpha),r.clearColor(this._state.clearColor.r,this._state.clearColor.g,this._state.clearColor.b,this._state.clearColor.a),r.clearDepth(this._state.clearDepth),r.clearStencil(this._state.clearStencil),r.colorMask(this._state.colorMask.r,this._state.colorMask.g,this._state.colorMask.b,this._state.colorMask.a),r.cullFace(this._state.cullFace),r.depthFunc(this._state.depthFunction),r.depthRange(this._state.depthRange.zNear,this._state.depthRange.zFar),this._state.depthTest===!0?r.enable(r.DEPTH_TEST):r.disable(r.DEPTH_TEST),r.depthMask(this._state.depthWrite),r.frontFace(this._state.frontFace),r.lineWidth(1),this._state.faceCulling===!0?r.enable(r.CULL_FACE):r.disable(r.CULL_FACE),r.polygonOffset(this._state.polygonOffset[0],this._state.polygonOffset[1]),this._state.polygonOffsetFill===!0?r.enable(r.POLYGON_OFFSET_FILL):r.disable(r.POLYGON_OFFSET_FILL),r.scissor(this._state.scissorRect.x,this._state.scissorRect.y,this._state.scissorRect.width,this._state.scissorRect.height),this._state.scissorTest===!0?r.enable(r.SCISSOR_TEST):r.disable(r.SCISSOR_TEST),r.stencilFunc(this._state.stencilFunction.func,this._state.stencilFunction.ref,this._state.stencilFunction.mask),r.stencilOpSeparate(this._state.stencilOperation.face,this._state.stencilOperation.fail,this._state.stencilOperation.zFail,this._state.stencilOperation.zPass),this._state.stencilTest===!0?r.enable(r.STENCIL_TEST):r.disable(r.STENCIL_TEST),r.stencilMask(this._state.stencilWriteMask);for(let n=0;n<this.parameters.maxTextureImageUnits;n++){r.activeTexture(Jz+n),r.bindTexture(Rs.TEXTURE_2D,null),r.bindTexture(Rs.TEXTURE_CUBE_MAP,null),this.type===pr.WEBGL2&&(r.bindTexture(Rs.TEXTURE_3D,null),r.bindTexture(Rs.TEXTURE_2D_ARRAY,null));const o=this._state.textureUnitMap[n];o!=null&&r.bindTexture(o.descriptor.target,o.glName)}r.activeTexture(Jz+this._state.activeTexture);const s=this._state.viewport;r.viewport(s.x,s.y,s.width,s.height),this.resetInfo()}_loadExtensions(){this.type===pr.WEBGL1&&this.gl.getExtension("OES_element_index_uint"),this.gl.getExtension("KHR_parallel_shader_compile")}};function Vc(t,e,r,i){return e?i!==e&&t.bindBuffer(r,e.glName):t.bindBuffer(r,null),e}function O0e(t,e){switch(t){case Ot.POINTS:return 2*e;case Ot.TRIANGLES:return e/3;case Ot.TRIANGLE_STRIP:case Ot.TRIANGLE_FAN:return e-2;default:return 0}}let fLt=class extends pLt{constructor(e,r,i){super(e,r),this.newCache=i,this._refCount=1,this._appleAmdDriverHelper=null}destroy(){--this._refCount>0||this.dispose()}ref(){++this._refCount}dispose(){super.dispose(),this._appleAmdDriverHelper?.dispose()}bindTechnique(e,r,i,s){return this.useProgram(e.program),e.bindPipelineState(this,i?.slot,!!s),e.program.bindPass(r,i),e.program}get appleAmdDriverHelper(){return this.driverTest.drawArraysRequiresIndicesTypeReset.result?(this._appleAmdDriverHelper=this._appleAmdDriverHelper??new XFe(this),this._appleAmdDriverHelper):null}get test(){return this.programCache.test}},NE=class extends me{constructor(e,r,i){super({}),this._stage=e,this._techniqueRepository=r,this._rctx=i,this._textures=new Map,this._loadingCount=0,this._frameUpdates=new Map,this.events=new Xr,this._frameTask=e.view.resourceController.scheduler.registerTask(gt.TEXTURE_UNLOAD)}normalizeCtorArgs(){return{}}destroy(){this._frameTask.remove(),this._stage.forEachOfType(Ms.Texture,e=>e.unload())}get updating(){return this._loadingCount>0||this._frameTask.updating}get textureTechnique(){return this._textureTechnique==null&&(this._textureTechnique=this._techniqueRepository.acquire(fie,new mie)),this._textureTechnique}acquire(e){const r=this._textures.get(e);return r?(r.ref(),r.loadingPromise??r):this._createNewRef(e)}update(){let e=!1;this._frameUpdates.forEach(r=>{const i=r.texture.frameUpdate(r.previousToken);i>=0&&i!==r.previousToken&&(r.previousToken=i,e=!0)}),e&&this.events.emit("changed",Us.BACKGROUND)}_createNewRef(e){const r=this._stage.getObject(e);if(r==null)return it(r!==void 0),null;const i=r.events.on("unloaded",()=>{i.remove(),this._onTextureUnloaded(e)}),s=new mLt(e,()=>{this._frameTask.schedule(()=>{s.isUnreferenced&&r.unload()})});return this._textures.set(e,s),s.ref(),r.glTexture!=null?(this._updateGLTexture(s,r.glTexture),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s):(this._loadingCount++,s.loadingPromise=this._stage.schedule(()=>{const n=r.load(this._rctx),o=l=>(this._loadingCount--,s.loadingPromise=null,this._updateGLTexture(s,l),r.requiresFrameUpdates&&this._frameUpdates.set(e,{texture:r,previousToken:-1}),s),a=l=>(this._loadingCount--,s.loadingPromise=null,ws(l)||K.getLogger(this).error(l),null);return Rh(n)?n.then(o,a):o(n)}),s.loadingPromise)}_updateGLTexture(e,r){e.glTexture=r,this.events.emit("changed",Us.UPDATE)}_onTextureUnloaded(e){this._textures.delete(e),this._frameUpdates.delete(e)}};u([d()],NE.prototype,"_loadingCount",void 0),u([d()],NE.prototype,"_frameTask",void 0),u([d()],NE.prototype,"updating",null),NE=u([R("esri.views.3d.webgl-engine.lib.TextureRepository")],NE);let mLt=class{constructor(e,r){this.id=e,this._release=r,this._refCount=0}get isUnreferenced(){return this._refCount===0}ref(){++this._refCount}release(){--this._refCount,this._refCount>0||(this._refCount!==0?(K.getLogger("esri.views.3d.webgl-engine.lib.TextureRepository.RefCountedTextureImpl").error("Cannot dereference texture that has no references!"),this._refCount=0):this._release())}};function gLt(t,e){return new F$e(r=>Rbt(r,t),r=>r,e)}let IM=class extends me{constructor(){super(...arguments),this._passParameters=new yLt,this._loading=0}get passParameters(){return this._passParameters}destroy(){this._passParameters.waveNormal=ze(this._passParameters.waveNormal),this._passParameters.wavePertubation=ze(this._passParameters.wavePertubation)}get updating(){return this._loading>0}ensureResources(e){if(this._loading>0)return f0.LOADING;if(this._passParameters.waveNormal!=null&&this._passParameters.wavePertubation!=null)return f0.LOADED;const r=new Sr;return r.samplingMode=Mt.LINEAR_MIPMAP_LINEAR,r.hasMipmap=!0,r.maxAnisotropy=8,++this._loading,D0(Dr("esri/images/materials/water/normals.jpg")).then(i=>this._passParameters.waveNormal=new Rt(e,{...r,width:i.width,height:i.height},i)).catch(i=>K.getLogger(this).error("Failed to load water material normal texture.",i)).finally(()=>--this._loading),++this._loading,D0(Dr("esri/images/materials/water/perturbation.jpg")).then(i=>this._passParameters.wavePertubation=new Rt(e,{...r,width:i.width,height:i.height},i)).catch(i=>K.getLogger(this).error("Failed to load water material pertubation texture.",i)).finally(()=>--this._loading),f0.LOADING}};u([d()],IM.prototype,"_loading",void 0),u([d({type:Boolean,readOnly:!0})],IM.prototype,"updating",null),IM=u([R("esri.views.3d.webgl-engine.materials.internal.WaterTextureRepository")],IM);let yLt=class extends ui{};const R0e=2048,_Lt=1.5,vLt=8;function bLt(t,e){const{format:r,quality:i,rotation:s,disableDecorations:n}=t||{},o=Kie(t,e.padding),a=ALt(t,{width:e.width-o.left-o.right,height:e.height-o.top-o.bottom}),{width:l,height:c}=CLt(t,a),h=MLt(r),p=DLt[h];return{format:h,quality:ye(i??p,0,100),area:a,width:l,height:c,rotation:s,disableDecorations:!!n,ignoreBackground:!(!t||!t.ignoreBackground),ignorePadding:!(!t||!t.ignorePadding)}}function wLt(t,e){const r=bLt(t,e),i=r.area,s=r.width/i.width,n=Kie(r,e.padding),o=n.left+n.right,a=n.top+n.bottom,l=e.width-o,c=e.height-a,h=Math.floor(l*s+o),p=Math.floor(c*s+a),f=t&&t.layers?t.layers:[],m=r.ignoreBackground,g=r.ignorePadding;return{framebufferWidth:h,framebufferHeight:p,region:{x:Math.floor(i.x*s)+n.left,y:Math.floor(i.y*s)+n.top,width:r.width,height:r.height},format:r.format,quality:r.quality,rotation:r.rotation,pixelRatio:s,layers:f,disableDecorations:r.disableDecorations,ignoreBackground:m,ignorePadding:g,objectAndLayerIdColor:!1}}function wj(t,e,r){const{ctx:i,canvas:s}=e4e(t,r),n=i.getImageData(0,0,t.width,t.height),o=TLt(s,e);return t4e(s),{dataUrl:o,data:n}}function xj(t,e){const{ctx:r,canvas:i}=e4e(t,e),s=r.getImageData(0,0,t.width,t.height);return t4e(i),s}function e4e(t,e){const r=xLt();e.premultipliedAlpha&&PLt(t),r.width=t.width,r.height=t.height;const i=r.getContext("2d",{willReadFrequently:!0});return i.putImageData(t,0,0),e.flipY&&ILt(i),{ctx:i,canvas:r}}function t4e(t){t.width=0,t.height=0}function xLt(){return Tj==null&&(Tj=document.createElement("canvas")),Tj}let Tj=null;function TLt(t,e){const r=$Lt[e.format],i=e.quality/100;return t.toDataURL(r,i)}function SLt(t,e,r,i=0,s=0,n=t.width-i,o=t.height-s,a=!1){const{data:l}=t,{width:c,height:h,data:p}=e,f=n/c,m=o/h,g=Math.ceil(f/2),_=Math.ceil(m/2),v=t.width;for(let b=0;b<h;b++)for(let x=0;x<c;x++){const T=4*(x+(a?h-b-1:b)*c);let S=0,O=0,A=0,M=0,P=0,F=0;const $=(b+.5)*m;for(let N=Math.floor(b*m);N<(b+1)*m;N++){const U=Math.abs($-(N+.5))/_,X=(x+.5)*f,Z=U*U;for(let G=Math.floor(x*f);G<(x+1)*f;G++){const ee=Math.abs(X-(G+.5))/g,I=Math.sqrt(Z+ee*ee);if(I>=1)continue;let V=2*I*I*I-3*I*I+1;const z=4*(i+G+(s+N)*v);F+=V*l[z+3],O+=V,!r&&l[z+3]<255&&(V=V*l[z+3]/255),A+=V*l[z],M+=V*l[z+1],P+=V*l[z+2],S+=V}}p[T]=A/S,p[T+1]=M/S,p[T+2]=P/S,p[T+3]=F/O}return e}function ELt(t,e,r){if(!e)return t;const{framebufferWidth:i,framebufferHeight:s,pixelRatio:n,region:o}=t,a=Kie(t,r),l=a.left+a.right,c=a.top+a.bottom,h=i-l,p=s-c,f=Math.min(vLt,Math.min((R0e-l)/h,(R0e-c)/p));return f<_Lt?t:{...t,framebufferWidth:Math.round(h*f)+l,framebufferHeight:Math.round(p*f)+c,pixelRatio:n*f,resample:{region:{x:Math.round((o.x-a.left)*f)+a.left,y:Math.round((o.y-a.top)*f)+a.top,width:Math.round(o.width*f),height:Math.round(o.height*f)},width:i,height:s}}}function CLt(t,e){if(!t)return e;const r=t.width,i=t.height;if(r!=null&&i!=null)return{width:Math.floor(r),height:Math.floor(i)};if(r==null&&i==null)return e;const s=e.width/e.height;return i==null?{width:Math.floor(r),height:Math.floor(r/s)}:{width:Math.floor(i*s),height:Math.floor(i)}}function ALt(t,e){const r={x:0,y:0,width:e.width,height:e.height};if(t&&t.area){t.area.x!=null&&(r.x=Math.floor(t.area.x)),t.area.y!=null&&(r.y=Math.floor(t.area.y));const i=t.area.width!=null?Math.floor(t.area.width):null,s=t.area.height!=null?Math.floor(t.area.height):null;if(r.width=e.width-r.x,r.height=e.height-r.y,i!=null&&s!=null)r.width=Math.min(r.width,i),r.height=Math.min(r.height,s);else if(i==null&&s!=null){const n=Math.min(r.width,i);r.height=n/r.width*r.height,r.width=n}else if(i!=null&&s==null){const n=Math.min(r.height,s);r.width=n/r.height*r.width,r.height=n}}return OLt(RLt(r,t),e)}function OLt(t,e){const r=Math.floor(Math.max(t.x,0)),i=Math.floor(Math.max(t.y,0)),s={x:r,y:i,width:Math.floor(Math.min(t.width,e.width-r)),height:Math.floor(Math.min(t.height,e.height-i))},n=s.width/s.height,o=t.width/t.height;if(o===n)return s;if(o>n){const c=Math.floor(s.width/o),h=s.height-c;return{x:s.x,y:Math.floor(s.y+h/2),width:s.width,height:c}}const a=Math.floor(s.height*o),l=s.width-a;return{x:Math.floor(s.x+l/2),y:s.y,width:a,height:s.height}}function RLt(t,e){if(!e||e.width==null||e.height==null)return t;const r=e.width/e.height,i=t.width/t.height;if(i===r)return t;if(i<r){const n=Math.floor(t.height*r);return t.x-=(n-t.width)/2,t.width=n,t}const s=Math.floor(t.width/r);return t.y-=(s-t.height)/2,t.height=s,t}function Kie(t,e){return!e||t&&t.ignorePadding?NLt:e}function MLt(t){switch(t){case"png":case"jpg":case"jpeg":return t;default:return LLt}}function ILt(t){t.save(),t.globalCompositeOperation="copy",t.scale(1,-1),t.translate(0,-t.canvas.height),t.drawImage(t.canvas,0,0),t.restore()}function PLt(t){const e=t.data,r=e.length;for(let i=0;i<r;i+=4){const s=e[i+3];if(s!==255&&s>0){const n=255/s;e[i]=e[i]*n,e[i+1]=e[i+1]*n,e[i+2]=e[i+2]*n}}}const $Lt={png:"image/png",jpg:"image/jpeg",jpeg:"image/jpeg"},M0e=98,LLt="png",DLt={png:100,jpg:M0e,jpeg:M0e},NLt={top:0,right:0,bottom:0,left:0};let FLt=class{constructor(e,r){this.parameters=e,this.frameHasDecorations=r}},kLt=class{constructor(e,r,i,s){this._rctx=e,this._renderFunctions=r,this._forceCameraHook=i,this._disposeOffscreenBuffers=s,this.supersample=!0,this._screenshotQueue=new Array}destroy(){this._rctx=null}async takeScreenshot(e){await this._renderFunctions.prepareOverlay(),this._renderFunctions.requestRenderScene(Us.BACKGROUND);const r=nn();return this._screenshotQueue.push({settings:e,resolver:r}),r.promise}update(e,r){for(const i of this._screenshotQueue){if(this._rctx==null){i.resolver.reject();continue}const s={...i.settings,pixelRatio:i.settings.pixelRatio*e.parameters.camera.pixelRatio},n=this._renderScreenshot(e,s,r);i.resolver(n)}this._screenshotQueue.length=0}_renderScreenshotOverlay(e,r,i){e.width=r.width,e.height=r.height;const s=e.getContext("2d"),n=i.pixelRatio;return s.save(),s.translate(0,r.height),s.scale(1,-1),i.region&&s.translate(-i.region.x,-i.region.y),s.scale(n,n),r=this._renderFunctions.renderOverlay(e,r),s.restore(),r}_readbackScreenshot(e,r){return e.resample?this._readbackScreenshotResampled({...e,resample:e.resample},r):this._readbackScreenshotImmediate(e,r)}_readbackScreenshotResampled(e,r){const{framebufferWidth:i,framebufferHeight:s,region:n,resample:o}=e,a=this._ensureScreenshotEncodeCanvas();let l=xG(i,s,a);this._rctx.gl.readPixels(0,0,i,s,At.RGBA,rt.UNSIGNED_BYTE,new Uint8Array(l.data.buffer)),r(),l=this._renderScreenshotOverlay(a,l,{...e,region:void 0});const c=xG(n.width,n.height,a);return SLt(l,c,!0,o.region.x,s-(o.region.y+o.region.height),o.region.width,o.region.height)}_readbackScreenshotImmediate(e,r){const{framebufferHeight:i,region:s}=e,n=this._ensureScreenshotEncodeCanvas(),o=xG(s.width,s.height,n);return this._rctx.gl.readPixels(s.x,i-(s.y+s.height),s.width,s.height,At.RGBA,rt.UNSIGNED_BYTE,new Uint8Array(o.data.buffer)),r(),this._renderScreenshotOverlay(n,o,e)}_renderScreenshot(e,r,i){let s=null;const n=e.parameters.camera,o={width:r.framebufferWidth,height:r.framebufferHeight};Zx(o,Math.min(this._rctx.parameters.maxTextureSize,this._rctx.parameters.maxRenderbufferSize));let a=!1;const l=r.disableDecorations&&e.frameHasDecorations,c=o.width!==n.fullWidth||o.height!==n.fullHeight,h=r.ignorePadding&&n.pixelRatio!==r.pixelRatio,p=c||l||h||r.objectAndLayerIdColor,f=r.objectAndLayerIdColor?new Vn(this._rctx,new Sr(o.width,o.height),new mU(bn.DEPTH_STENCIL,o.width,o.height)):null;if(p){const v=n.clone();if(r.ignorePadding){const O=h$(v.padding);for(let A=0;A<4;A++)O[A]=Math.round(O[A]/v.pixelRatio*r.pixelRatio);v.padding=O}v.fullWidth=o.width,v.fullHeight=o.height,v.pixelRatio=r.pixelRatio;const b=n.fovX-v.fovX,x=n.fovY-v.fovY;b<0&&b<x?v.fovX=n.fovX:x<0&&x<b&&(v.fovY=n.fovY);const T={camera:v,contentCamera:v,mode:Br.IDLE,alignPixelEnabled:!0,contentPixelRatio:v.pixelRatio};this._forceCameraHook(T),a=!0,s=new Vn(this._rctx,new Sr(o.width,o.height),new mU(bn.DEPTH_STENCIL,o.width,o.height));const S=r.disableDecorations?VT.OFF:VT.ON;this._renderFunctions.renderScene(s,f,T,S,i),this._disposeOffscreenBuffers()}const m=()=>{this._rctx.bindFramebuffer(null),ze(s)},g=this._readbackScreenshot(r,m);m();let _=null;if(r.objectAndLayerIdColor){const v=()=>{this._rctx.bindFramebuffer(null),ze(f)};this._rctx.bindFramebuffer(f),_=this._readbackScreenshot(r,v),this._rctx.bindFramebuffer(null),v()}if(p&&!this._rctx.contextAttributes.alpha)for(let v=3;v<g.data.length;v+=4)g.data[v]=255;if(_&&!this._rctx.contextAttributes.alpha)for(let v=3;v<_.data.length;v+=4)_.data[v]=255;return a&&this._forceCameraHook(e.parameters),[g,_]}_ensureScreenshotEncodeCanvas(){return this._screenshotEncodeCanvas||(this._screenshotEncodeCanvas=document.createElement("canvas")),this._screenshotEncodeCanvas}},To=class extends me{constructor(t){super({}),this.events=new Xr,this.waterTextureRepository=new IM,this._magnifierHelper=new DE,this.objectAndLayerIdRenderHelper=le("enable-feature:objectAndLayerId-rendering")?new UIt:null,this._needsUpdate=!0,this._needsRender=!0,this._idleSuspend=!0,this._needsWaterReflectionUpdate=!1,this._lastAnimationUpdate=0,this._container=t.container,this._viewingMode=t.viewingMode,this._initializeContext(t),this.addHandles([Q(()=>this.waterTextureRepository?.updating,()=>this.requestRender(),xt),Q(()=>t.view.qualityProfile,i=>this.renderer?.updateRenderFeature(i),Ri),this._magnifierHelper.events.on("request-render",()=>this.requestRender())]);const{memoryController:e}=t.view.resourceController;this.stippleTextureRepository=vbt(this._rctx,e),this.markerTextureRepository=gLt(this._rctx,e),this._shaderTechniqueRepository=new I$e({rctx:this._rctx,viewingMode:t.viewingMode,stippleTextureRepository:this.stippleTextureRepository,waterTextureRepository:this.waterTextureRepository,markerTextureRepository:this.markerTextureRepository}),this._textureRepository=new NE(t,this._shaderTechniqueRepository,this._rctx),this.addHandles(this._textureRepository.events.on("changed",i=>this.requestRender(i))),this._materialRepository=new P$e(this._textureRepository,this._shaderTechniqueRepository,()=>this.requestRender(),()=>this.requestRender()),this._compositingHelper=new yIt(this._rctx,this._shaderTechniqueRepository),this.renderer=new Qc(t,this._materialRepository,this._textureRepository,this._shaderTechniqueRepository,this._rctx,this._compositingHelper,this._magnifierHelper,i=>this.requestRender(i));const r={renderScene:(i,s,n,o,a)=>this.renderer.render(i,s,n,o,a),requestRenderScene:i=>this.requestRender(i),prepareOverlay:()=>t.options.screenshot.prepareOverlay(),renderOverlay:(i,s)=>t.options.screenshot.renderOverlay(i,s)};this._screenshotManager=new kLt(this._rctx,r,i=>this.events.emit("force-camera-for-screenshot",i),()=>this.renderer.disposeOffscreenBuffers()),this._registerFrameTask(t)}normalizeCtorArgs(){return{}}destroy(){this._container.contains(this._canvas)&&this._container.removeChild(this._canvas),this._frameTask=Pi(this._frameTask),this._shaderTechniqueRepository=Re(this._shaderTechniqueRepository)}requestRender(t=Us.UPDATE){this._needsRender=!0,t===Us.UPDATE&&(this._needsUpdate=!0)}get updating(){return this._needsUpdate||this._needsWaterReflectionUpdate||this.renderer.updating||this._textureRepository.updating||this.waterTextureRepository.updating||this._magnifierHelper.updating}get textureRepository(){return this._textureRepository}get compositingHelper(){return this._compositingHelper}set magnifier(t){this._magnifierHelper.magnifier=t}setIdleSuspend(t){this._idleSuspend!==t&&(this._idleSuspend=t,this.requestRender())}get renderingContext(){return this._rctx}get capabilities(){return this._rctx.capabilities}get canvas(){return this._canvas}takeScreenshot(t){return this._screenshotManager.takeScreenshot(t).then(e=>e[0])}takeScreenshotWithOID(t){return t.objectAndLayerIdColor=!0,this._screenshotManager.takeScreenshot(t)}getAlpha(){return!!this._rctx.contextAttributes.alpha}getMinimalDepthForArea(t,e,r,i,s,n=s){const o=i.constrainWindowSize(e,r,s*i.pixelRatio,n*i.pixelRatio),a=this._ensureDepthBuffer(o);this.renderer.readDepthPixels(i,o,a);let l=Number.MAX_VALUE;for(let c=0;c<o[2]*o[3];c++){const h=xIt(4*c,a,i.nearFar);l>h&&h!==i.nearFar[0]&&h!==i.nearFar[1]&&(l=h)}if(t!=null){const c=t.pickDepth(e*i.pixelRatio,r*i.pixelRatio,i);c!=null&&l>c&&c!==i.nearFar[0]&&c!==i.nearFar[1]&&(l=c)}return l===Number.MAX_VALUE?void 0:l}_ensureDepthBuffer(t){const e=4*t[2]*t[3];return(this._tmpDepthBuffer==null||this._tmpDepthBuffer.byteLength<e)&&(this._tmpDepthBuffer=new Uint8Array(e)),this._tmpDepthBuffer}async reloadShaders(){nNe(),await this._shaderTechniqueRepository.reloadAll(),this.requestRender()}_registerFrameTask(t){const e=t.view.state;let r=!1,i=Us.BACKGROUND,s=!1;const n={preRender:({time:o})=>{r=this.updating,i=this._needsUpdate?Us.UPDATE:Us.BACKGROUND,t.commitSyncLayers();const a=o-this._lastAnimationUpdate;if(a>this.renderer.animationTimestep||e.forcedAnimationTime!=null||r||this._needsRender){const l=a/this.renderer.animationTimeDilation,c=new QIe(e.camera,l,e.forcedAnimationTime);this.renderer.updateAnimation(c)&&this.requestRender(Us.BACKGROUND),this._lastAnimationUpdate=o}},render:({time:o})=>{if((this._needsRender||!this._idleSuspend||!this.renderer.isCameraFinal||this._needsWaterReflectionUpdate)&&e.camera.fullWidth>0&&e.camera.fullHeight>0){const a=this._needsUpdate&&this._idleSuspend&&this.renderer.isCameraFinal;this._needsRender=!1,this._needsUpdate=!1,this._needsWaterReflectionUpdate=!1,this.renderer.render(null,null,e,VT.ON,o),s=!0,a&&this.renderer.hasReflections&&(this.requestRender(Us.BACKGROUND),this._needsWaterReflectionUpdate=!0)}},update:({time:o})=>{const a=new FLt(e,this.renderer.hasSlicePlane||this._magnifierHelper.enabled);this._textureRepository.update(),this._screenshotManager.update(a,o)},finish:()=>{s&&(this.renderer.finish(e.mode===Br.IDLE?i:Us.UPDATE),s=!1)}};this._frameTask=QC(n)}_initializeContext(t){const e=t.options;this._canvas=e.canvas,this._canvas||(this._canvas=document.createElement("canvas")),this._canvas.setAttribute("style","width: 100%; height:100%; display:block;");const r={alpha:e.alpha||!1,premultipliedAlpha:!0,antialias:!1,depth:!0,stencil:e.stencil??!0,powerPreference:"high-performance",preserveDrawingBuffer:e.preserveDrawingBuffer??!1},i=wht("3d",this._canvas,r);i!=null?(this._rctx=this._newRenderingContext(i,t),this._loadShaderOnlyExtensions(),!e.alpha&&this._rctx.contextAttributes.alpha&&K.getLogger(this).error("WebGL context has alpha channel even though no alpha channel was requested"),!this._rctx.contextAttributes.alpha&&le("safari")>=11&&(this._container.style.backgroundColor="black"),this._container.appendChild(this._canvas)):K.getLogger(this).error("A WebGL2 context could not be created.")}_newRenderingContext(t,e){const r={disabledExtensions:e.options.deactivatedWebGLExtensions||{},debugWebGLExtensions:e.options.debugWebGLExtensions||{},maxAnisotropy:8},i=(s,n)=>e.view.resourceController.memoryController.newCache(s,n);return new fLt(t,r,i)}_loadShaderOnlyExtensions(){this._rctx.capabilities.enable("textureFloat")}getObjectAndLayerIdColor(t){return this.objectAndLayerIdRenderHelper!=null?this.objectAndLayerIdRenderHelper.getObjectAndLayerIdColor(t):null}get componentObjectCollection(){return this._componentObjectCollection==null&&(this._componentObjectCollection=new sIt(this.renderer.renderPassManager,this._viewingMode)),this._componentObjectCollection}set componentObjectCollection(t){this._componentObjectCollection=t}};u([d({type:Boolean,readOnly:!0})],To.prototype,"updating",null),u([d({autoDestroy:!0})],To.prototype,"_rctx",void 0),u([d({autoDestroy:!0})],To.prototype,"_container",void 0),u([d({autoDestroy:!0})],To.prototype,"_canvas",void 0),u([d({autoDestroy:!0})],To.prototype,"stippleTextureRepository",void 0),u([d({autoDestroy:!0})],To.prototype,"markerTextureRepository",void 0),u([d({autoDestroy:!0})],To.prototype,"waterTextureRepository",void 0),u([d({autoDestroy:!0})],To.prototype,"_magnifierHelper",void 0),u([d({readOnly:!0})],To.prototype,"objectAndLayerIdRenderHelper",void 0),u([d({autoDestroy:!0})],To.prototype,"_textureRepository",void 0),u([d({autoDestroy:!0})],To.prototype,"_compositingHelper",void 0),u([d({autoDestroy:!0,readOnly:!0})],To.prototype,"renderer",void 0),u([d({autoDestroy:!0})],To.prototype,"_screenshotManager",void 0),u([d()],To.prototype,"componentObjectCollection",null),u([d({autoDestroy:!0})],To.prototype,"_componentObjectCollection",void 0),u([d()],To.prototype,"_needsUpdate",void 0),u([d()],To.prototype,"_needsWaterReflectionUpdate",void 0),To=u([R("esri.views.3d.webgl-engine.parts.RenderView")],To);let Ju=class extends me{constructor(e){super(e),this._model=new x5,this._layers=new qt,this._asyncChangeSet=new FY,this._syncChangeSet=new FY,this._layerSyncSet=new Set}initialize(){this._set("renderView",new To(this)),this._frameTask=this.view.resourceController.scheduler.registerTask(gt.STAGE,this),this.addHandles(this._frameTask)}destroy(){this.removeAllHandles()}get viewingMode(){return this.view.state.viewingMode}get updating(){return this.running||this.renderView.updating||this._frameTask.updating}get renderer(){return this.renderView?.renderer}add(e){this._model.add(e),qU(e)&&this._addLayer(e),this.renderView.requestRender()}remove(e){e==null||this.destroyed||(this._model.remove(e),qU(e)&&this._removeLayer(e),this.renderView.requestRender())}addMany(e){e!=null&&(this._model.addMany(e),this.renderView.requestRender())}removeMany(e){e!=null&&(this._model?.removeMany(e),this.renderView?.requestRender())}async load(e,r){e!=null&&(Array.isArray(e)||(e=[e]),await Promise.all(e.filter(i=>i.glTexture==null).map(i=>this.schedule(()=>this._model.has(i)?i.load(this.renderView.renderingContext):null),r)))}loadImmediate(e){return e.load(this.renderView.renderingContext)}forEachOfType(e,r){this._model.forEachOfType(e,r)}handleEvent(e,r){this.destroyed||(this._model.dirtySet[e](r),this.renderView.requestRender())}get running(){return this._model.dirtySet.dirty||!this._asyncChangeSet.empty}runTask(e){this._frameTask.processQueue(e),this._commit(e)}_commit(e){const r=this._model.dirtySet;this._asyncChangeSet.empty||e.done||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{if(e.done)return;const s=this._layerSyncSet.has(i.id)||i.updatePolicy===I1.SYNC,n=s?this._syncChangeSet:this._asyncChangeSet;r.commitLayer(i.id,n),this._layerSyncSet.delete(i.id),n.empty||(this.renderer.modify(n,s?Ll:e),this.renderView.requestRender(),e.madeProgress())}),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ll),this.renderView.requestRender(),e.madeProgress()),this._layers.forAll(i=>{e.done||this._layerSyncSet.has(i.id)||i.updatePolicy!==I1.ASYNC||(r.commitLayer(i.id,this._asyncChangeSet),this._asyncChangeSet.empty||(this.renderer.modify(this._asyncChangeSet,e),this.renderView.requestRender(),e.madeProgress()))}),this._layerSyncSet.clear(),this.notifyChange("running")}commitSyncLayers(){const e=this._model.dirtySet;this._layers.forAll(r=>{(this._layerSyncSet.has(r.id)||r.updatePolicy===I1.SYNC)&&(e.commitLayer(r.id,this._syncChangeSet),this._layerSyncSet.delete(r.id))});for(const r of this._layerSyncSet)e.commitLayer(r,this._syncChangeSet);this._layerSyncSet.clear(),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ll),this.renderView.requestRender())}_commitLayer(e){this._model.dirtySet.commitLayer(e.id,this._syncChangeSet),this._layerSyncSet.delete(e.id),this._syncChangeSet.empty||(this.renderer.modify(this._syncChangeSet,Ll),this.renderView.requestRender())}schedule(e,r){return this._frameTask.schedule(e,r)}reschedule(e,r){return this._frameTask.reschedule(e,r)}syncLayer(e){this._layerSyncSet.add(e),this.renderView.requestRender()}getObject(e){return this._model.getObject(e)}get layers(){return this._layers}_addLayer(e){this._layers.includes(e)||this._layers.push(e)}_removeLayer(e){this._commitLayer(e),this._layers.removeUnordered(e)!=null&&(this._model.dirtySet.getResidentRenderGeometries(e.id,this._syncChangeSet.removes),this.renderer.modify(this._syncChangeSet,Ll))}addRenderPlugin(e,r,i){const s=this.renderer.renderPlugins.add(e,r,i),n=()=>{vme(r)&&this.view.sceneIntersectionHelper.addIntersectionHandler(r)};if(Rh(s))return s.then(n);n()}removeRenderPlugin(e){this.destroyed||(vme(e)&&this.view.sceneIntersectionHelper.removeIntersectionHandler(e),this.renderer.renderPlugins.remove(e))}get performanceInfo(){return{renderer:this.renderer.performanceInfo,model:this._model.getStats()}}get test(){const e=this;return{getCount:r=>e._model.test.content.filter(i=>i.type===r).length,model:e._model}}};Ju.DebugSettings={endFrameContentValidation:!1},u([d({constructOnly:!0})],Ju.prototype,"view",void 0),u([d({constructOnly:!0})],Ju.prototype,"options",void 0),u([d({readOnly:!0})],Ju.prototype,"viewingMode",null),u([d({constructOnly:!0})],Ju.prototype,"container",void 0),u([d({readOnly:!0})],Ju.prototype,"updating",null),u([d({constructOnly:!0})],Ju.prototype,"_model",void 0),u([d({autoDestroy:!0})],Ju.prototype,"renderView",void 0),u([d({readOnly:!0})],Ju.prototype,"renderer",null),u([d({readOnly:!0})],Ju.prototype,"running",null),Ju=u([R("esri.views.3d.webgl-engine.Stage")],Ju);let TQt=class extends y8{constructor(e,r,i,s){super(r,i),this.point=e,this.createGraphic=s}};function r4e(t){return Bf(t)&&t.intersector===ls.PCL&&!!t.target}let EQt=class extends wMe{constructor(e,r,i,s,n){super(e),this.layerUid=e,this.sublayerUid=r,this.nodeIndex=i,this.componentIndex=s,this.triangleNr=n}},AQt=class extends y8{constructor(e,r,i){super(r,null),this.point=e,this.createVoxelGraphic=i}};function n9(t){return Bf(t)&&t.intersector===ls.I3S&&!!t.target}function i4e(t){return Bf(t)&&t.intersector===ls.VOXEL&&!!t.target}function I0e(t,e){return _8(t)||v8(t)?FP(t.target?.object,e):Ybt(t)?e.map?.ground:r4e(t)||n9(t)||K$e(t)||i4e(t)?FP(t.target,e):null}function RQt(t,e){const r=CJ(t,e);return r!=null&&r.type==="graphic"?r.graphic:null}function CJ(t,e){if(t==null)return null;if(_8(t)||v8(t))return P0e(t.target?.object,e);if(r4e(t)){const r=t.target.createGraphic();return{type:"graphic",graphic:r,layer:r.layer}}if(i4e(t)){const r=t.target.createVoxelGraphic();return{type:"graphic",graphic:r,layer:r.layer}}return K$e(t)||Eie(t)?P0e(t.target,e):n9(t)?ULt(t.target,e):null}function P0e(t,e){if(t==null||t.graphicUid==null)return null;const r=FP(t,e);if(r==null)return null;if(r===e.graphics)return e.graphicsView==null||typeof t.graphicUid!="number"?null:e.graphicsView.getHit(t.graphicUid);const i=e.allLayerViews.find(s=>s.layer===r);return!i||i.suspended||t.graphicUid==null?null:"getHit"in i?i.getHit(t.graphicUid):null}function ULt(t,e){const r=FP(t,e);if(r==null)return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getGraphicFromIntersectorTarget"in i?zLt(i.getGraphicFromIntersectorTarget(t)):null}function VLt(t,e){const r=FP(t,e);if(r==null)return null;const i=e.allLayerViews.find(s=>s.layer===r);return i&&!i.suspended&&"getAABBFromIntersectorTarget"in i?i.getAABBFromIntersectorTarget(t):null}function zLt(t){return t!=null?{type:"graphic",graphic:t,layer:t.layer}:null}function FP(t,e){return t&&t.layerUid!=null?e.graphicsView!=null&&t.layerUid===e.graphicsView.processor.layer.id?e.graphics:e.map.findLayerByUid(t.layerUid):null}function MQt(t,e){if(_8(t)||v8(t))return p0(t.target.object.boundingVolumeWorldSpace.bounds);if(Eie(t)){RSe(pF,t.transformation);const r=Math.max(pF[0],pF[1],pF[2]);return t.target.baseBoundingSphere.radius*r}return n9(t)?Dl(VLt(t.target,e),r=>.5*lxe(r)):null}function IQt(t){return!_8(t)&&!v8(t)&&(Eie(t)?t.target.numLodLevels>1:!!n9(t))}const pF=C();let Sj,Ej;function BLt(t){const e=o3e(t);for(;e.length>1;){const r=$0e(e.shift());if(r.available)return r}return $0e(e.shift())}function $0e(t){switch(t){case pr.WEBGL1:return GLt();case pr.WEBGL2:return jLt()}}function GLt(){return Sj||(Sj=WLt()),Sj}function jLt(){return Ej||(Ej=ZLt()),Ej}let s4e=class{constructor(){this.available=!1,this.majorPerformanceCaveat=!1,this.maxTextureSize=0,this.supportsVertexShaderSamplers=!1,this.supportsHighPrecisionFragment=!1,this.supportsElementIndexUint=!1,this.supportsStandardDerivatives=!1,this.supportsInstancedArrays=!1,this.supportsTextureFloat=!1,this.supportsTextureHalfFloat=!1,this.supportsColorBufferFloat=!1,this.supportsColorBufferFloatBlend=!1,this.supportsColorBufferHalfFloat=!1}},HLt=class extends s4e{constructor(){super(...arguments),this.type=pr.WEBGL1}},qLt=class extends s4e{constructor(){super(...arguments),this.type=pr.WEBGL2,this.supportsElementIndexUint=!0,this.supportsStandardDerivatives=!0,this.supportsInstancedArrays=!0,this.supportsTextureFloat=!0,this.supportsTextureHalfFloat=!0}};function n4e(t,e){if(t===pr.WEBGL1&&typeof WebGLRenderingContext>"u"||t===pr.WEBGL2&&typeof WebGL2RenderingContext>"u")return null;const r=document.createElement("canvas");if(!r)return null;let i=aX(r,t,{failIfMajorPerformanceCaveat:!0});if(i==null&&(i=aX(r,t),i!=null&&(e.majorPerformanceCaveat=!0)),i==null)return i;if(t===pr.WEBGL1){const n=i.getParameter(i.VERSION),o=n?.match(/^WebGL\s+([\d.]*)/);if(o){const a=parseFloat(o[1]);e.available=a>=.94}}else e.available=!0;e.maxTextureSize=i.getParameter(i.MAX_TEXTURE_SIZE),e.supportsVertexShaderSamplers=i.getParameter(i.MAX_VERTEX_TEXTURE_IMAGE_UNITS)>0;const s=i.getShaderPrecisionFormat(i.FRAGMENT_SHADER,i.HIGH_FLOAT);return s&&(e.supportsHighPrecisionFragment=s.precision>0),i}function WLt(){const t=new HLt,e=n4e(pr.WEBGL1,t);return e==null||(t.supportsElementIndexUint=e.getExtension("OES_element_index_uint")!==null,t.supportsStandardDerivatives=e.getExtension("OES_standard_derivatives")!==null,t.supportsInstancedArrays=e.getExtension("ANGLE_instanced_arrays")!==null,t.supportsTextureFloat=e.getExtension("OES_texture_float")!==null,t.supportsTextureHalfFloat=e.getExtension("OES_texture_half_float")!==null,t.supportsColorBufferFloat=e.getExtension("WEBGL_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=e.getExtension("EXT_color_buffer_half_float")!==null),t}function ZLt(){const t=new qLt,e=n4e(pr.WEBGL2,t);return e==null||(t.supportsColorBufferFloat=e.getExtension("EXT_color_buffer_float")!==null,t.supportsColorBufferFloatBlend=e.getExtension("EXT_float_blend")!==null,t.supportsColorBufferHalfFloat=t.supportsColorBufferFloat||e.getExtension("EXT_color_buffer_half_float")!==null),t}function XLt(t){const e=BLt(t);if(!e.available)return new D("webgl:required",t==="3d"?"WebGL2 is required but not supported.":"WebGL is required but not supported.",new Error().stack);if(t==="3d"&&e.majorPerformanceCaveat)return new D("webgl:major-performance-caveat-detected","Your WebGL implementation doesn't seem to support hardware accelerated rendering. Check your browser settings or if your GPU is in a blocklist.");if(!e.supportsHighPrecisionFragment)return new D("webgl:high-precision-fragment-required","WebGL support for high precision fragment shaders is required but not supported.");if(!e.supportsVertexShaderSamplers)return new D("webgl:vertex-shader-samplers-required","WebGL support for vertex shader samplers is required but not supported.");if(e.type===pr.WEBGL1){if(!e.supportsElementIndexUint)return new D("webgl:element-index-uint-required","WebGL support for uint vertex indices is required but not supported.");if(!e.supportsStandardDerivatives)return new D("webgl:standard-derivatives-required","WebGL support for standard derivatives is required but not supported.");if(!e.supportsInstancedArrays)return new D("webgl:instanced-arrays-required","WebGL support for instanced rendering is required but not supported.")}return null}function YLt(t){return t&&"nodeType"in t}function JLt(t){return t&&typeof t.render=="function"}const L0e={component:"esri-component"};let mx=class extends me{constructor(){super(...arguments),this.widget=null}destroy(){this.node=null,this.widget?.destroy()}get id(){return this.get("widget.id")||this.get("node.id")}set node(e){const r=this._get("node");e!==r&&(e&&e.classList.add(L0e.component),r&&r.classList.remove(L0e.component),this._set("node",e))}castNode(e){return this.widget?.destroy(),e?typeof e=="string"||YLt(e)?(this._set("widget",null),G6(e)):(JLt(e)&&!e.domNode&&(e.domNode=document.createElement("div")),this._set("widget",e),e.domNode):(this._set("widget",null),null)}};u([d({dependsOn:[]})],mx.prototype,"id",null),u([d()],mx.prototype,"node",null),u([or("node")],mx.prototype,"castNode",null),u([d({readOnly:!0})],mx.prototype,"widget",void 0),mx=u([R("esri.views.ui.Component")],mx);const C5=mx,QLt={left:0,top:0,bottom:0,right:0},o4e={bottom:30,top:15,right:15,left:15},cy="esri-ui",zc={ui:cy,corner:`${cy}-corner`,innerContainer:`${cy}-inner-container`,manualContainer:`${cy}-manual-container`,cornerContainer:`${cy}-corner-container`,topLeft:`${cy}-top-left`,topRight:`${cy}-top-right`,bottomLeft:`${cy}-bottom-left`,bottomRight:`${cy}-bottom-right`};function KLt(t){return t&&!t._started&&typeof t.postMixInProperties=="function"&&typeof t.buildRendering=="function"&&typeof t.postCreate=="function"&&typeof t.startup=="function"}function fF(t){return t===0?"0":`${t}px`}function Cj(t){const e=typeof t=="object"&&t!==null&&Object.getPrototypeOf(t);return(e===null||e===Object.prototype)&&("component"in t||"index"in t||"position"in t)?t:null}function Aj(t,{top:e,bottom:r,left:i,right:s}){t.style.top=e,t.style.bottom=r,t.style.left=i,t.style.right=s}let Fm=class extends Xr.EventedAccessor{constructor(t){super(t),this._cornerNameToContainerLookup={},this._positionNameToContainerLookup={},this._components=new Array,this._componentMap=new Map,this._locale=Ld(),this.view=null,this._applyViewPadding=()=>{const e=this.container;e&&Aj(e,this._toPixelPosition(this._getViewPadding()))},this._applyUIPadding=()=>{const e=this._innerContainer;e&&Aj(e,this._toPixelPosition(this.padding))},this._initContainers()}initialize(){this.addHandles([Q(()=>[this.view?.padding,this.container],this._applyViewPadding,xt),Q(()=>this.padding,this._applyUIPadding,xt),Q(()=>[this.container,this._locale],([t,e])=>{t&&t.setAttribute("lang",e)},xt),Q0e(t=>{this._locale=t})])}destroy(){this.container=null;for(const t of this._components)t.destroy();this._components.length=0,this._componentMap.clear()}set container(t){const e=this._get("container");t!==e&&(t&&(t.classList.add(zc.ui),wst(t),this._attachContainers(t)),e&&(e.classList.remove(zc.ui),Aj(e,{top:"",bottom:"",left:"",right:""}),Fbe(e)),this._set("container",t))}get height(){const t=this.view?.height??0;if(t===0)return t;const e=this._getViewPadding(),{top:r,bottom:i}=e;return Math.max(t-r-i,0)}get padding(){return this._get("padding")}set padding(t){this._overrideIfSome("padding",t)}castPadding(t){return typeof t=="number"?{bottom:t,top:t,right:t,left:t}:{...o4e,...t}}get width(){const t=this.view?.width??0;if(t===0)return t;const e=this._getViewPadding(),{left:r,right:i}=e;return Math.max(t-r-i,0)}add(t,e){let r,i,s;if(Array.isArray(t))return void t.forEach(o=>this.add(o,e));const n=Cj(t);n&&({index:r,position:e,component:t,key:i}=n),e&&typeof e=="object"&&({index:r,key:i,position:e,internal:s}=e),!t||e&&!this._isValidPosition(e)||this._add(t,e,r,i,s)}remove(t,e){if(!t)return;if(Array.isArray(t))return t.map(i=>this.remove(i,e));const r=this._find(t);if(r){if(this._componentMap.has(t)&&this._componentMap.get(t)?.key!==e)return;const i=this._components.indexOf(r);return r.node.parentNode?.removeChild(r.node),this._componentMap.delete(t),this._components.splice(i,1)[0]}}empty(t,e={removeInternal:!1}){if(Array.isArray(t)){for(const s of t)this.empty(s,e);return}const r=this._positionNameToContainerLookup[t??"manual"],i=Array.prototype.slice.call(r.children).map(s=>this._findByNode(s)).filter(s=>s==null?!1:!(this._componentMap.get(s)?.internal??!1)||e.removeInternal);for(const s of i)this.remove(s)}move(t,e){if(Array.isArray(t)&&t.forEach(n=>this.move(n,e)),!t)return;let r;const i=Cj(t)||Cj(e);if(i&&(r=i.index,e=i.position,t=i.component||t),e&&!this._isValidPosition(e))return;const s=this.remove(t);s&&this.add(s,{position:e,index:r})}find(t){if(!t)return null;const e=this._findById(t);return e&&(e.widget||e.node)}getComponents(t,e={includeInternal:!1}){return t?Array.isArray(t)?t.map(r=>this._getComponentsAtPosition(r,e)).flat():this._getComponentsAtPosition(t,e):this._components.filter(r=>e.includeInternal||!this._componentMap.get(r)?.internal).map(({widget:r,node:i})=>r??i)}getPosition(t){for(const e in this._positionNameToContainerLookup)if(this._positionNameToContainerLookup[e].contains(t))return e;return null}_add(t,e,r,i,s){t instanceof C5||(t=new C5({node:t})),this._place({component:t,position:e,index:r}),this._components.push(t),this._componentMap.set(t,{key:i,internal:s})}_find(t){return t?t instanceof C5?this._findByComponent(t):typeof t=="string"?this._findById(t):this._findByNode(t.domNode||t):null}_getViewPadding(){return this.view?.padding??QLt}_attachContainers(t){t.appendChild(this._innerContainer),t.appendChild(this._manualContainer)}_initContainers(){const t=document.createElement("div");t.classList.add(zc.innerContainer,zc.cornerContainer);const e=document.createElement("div");e.classList.add(zc.innerContainer,zc.manualContainer);const r=document.createElement("div");r.classList.add(zc.topLeft,zc.corner),t.appendChild(r);const i=document.createElement("div");i.classList.add(zc.topRight,zc.corner),t.appendChild(i);const s=document.createElement("div");s.classList.add(zc.bottomLeft,zc.corner),t.appendChild(s);const n=document.createElement("div");n.classList.add(zc.bottomRight,zc.corner),t.appendChild(n),this._innerContainer=t,this._manualContainer=e;const o=T7();this._cornerNameToContainerLookup={"top-left":r,"top-right":i,"bottom-left":s,"bottom-right":n,"top-leading":o?i:r,"top-trailing":o?r:i,"bottom-leading":o?n:s,"bottom-trailing":o?s:n},this._positionNameToContainerLookup={manual:e,...this._cornerNameToContainerLookup}}_isValidPosition(t){return!!this._positionNameToContainerLookup[t]}_place(t){const e=t.position??"manual",{component:r,index:i}=t,s=this._positionNameToContainerLookup[e],n=i!=null&&i>-1;if(KLt(r.widget)&&r.widget.startup(),!n)return void s.appendChild(r.node);const o=Array.from(s.children);if(i===0)return void(s.firstChild?Ine(r.node,s.firstChild):s.appendChild(r.node));i>=o.length?s.appendChild(r.node):Ine(r.node,o[i])}_toPixelPosition(t){return{top:fF(t.top),left:fF(t.left),right:fF(t.right),bottom:fF(t.bottom)}}_findByComponent(t){return this._components.find(e=>e===t)??null}_findById(t){return this._components.find(({id:e})=>e===t)??null}_findByNode(t){return this._components.find(({node:e})=>e===t)??null}_getComponentsAtPosition(t,e){const r=this._positionNameToContainerLookup[t];return Array.prototype.slice.call(r.children).map(i=>this._findByNode(i)).filter(Ia).filter(i=>e.includeInternal||!this._componentMap.get(i)?.internal).map(({widget:i,node:s})=>i??s)}};u([d()],Fm.prototype,"_locale",void 0),u([d()],Fm.prototype,"container",null),u([d()],Fm.prototype,"height",null),u([d({value:o4e})],Fm.prototype,"padding",null),u([or("padding")],Fm.prototype,"castPadding",null),u([d()],Fm.prototype,"view",void 0),u([d()],Fm.prototype,"width",null),Fm=u([R("esri.views.ui.UI")],Fm);const eDt=Fm;function D0e(t,e){return t&&"copyright"in t&&(!e||typeof t.originOf=="function"&&t.originOf("copyright")==="user")}function tDt(t,e){return t.length!==e.length||t.some((r,i)=>r.text!==e[i].text)}function mF(t,e,r){!r||!e||t.find(i=>i.layerView===e&&i.text===r)||t.push({text:r,layerView:e})}function rDt(t){return t.type==="bing-maps"}const U_=[];let FE=class extends wT{constructor(t){super(t),this._clear=()=>{this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.handles.remove("suspension"),this.notifyChange("state")},this._pendingAttributions=new Set,this._fetchedAttributionData=new Map,this.items=new Ke,this.view=null,this._allLayerViewsChange=e=>{this.handles.remove("suspension");const r=this.get("view.allLayerViews");r&&this.handles.add(r.map(i=>Q(()=>[i.suspended,i.layer?.attributionVisible],()=>this._updateAttributionItems())),"suspension"),e&&e.removed&&e.removed.forEach(i=>{this._pendingAttributions.delete(i),this._fetchedAttributionData.delete(i)}),this._updateAttributionItems()},this.handles.add([Vs(()=>this.view?.allLayerViews,"change",e=>this._allLayerViewsChange(e),{onListenerAdd:()=>this._allLayerViewsChange(),onListenerRemove:this._clear}),No(()=>this.view?.stationary===!0,()=>this._updateAttributionItems())])}destroy(){this.view=null,this._fetchedAttributionData.clear(),this._pendingAttributions.clear(),this.items.removeAll()}get state(){return this.get("view.ready")?this._pendingAttributions.size>0?"loading":"ready":"disabled"}_updateAttributionItems(){const t=this.view,e=t?.allLayerViews;U_.length=0,t&&e?(e.forEach(r=>{if(r.suspended||!r.layer?.attributionVisible)return;const i=r.layer;if(D0e(i,"user"))return void mF(U_,r,i.copyright);if(i.hasAttributionData){if(this._fetchedAttributionData.has(r)){const n=this._fetchedAttributionData.get(r);return void(n?mF(U_,r,this._getDynamicAttribution(n,t,i)):D0e(i)&&mF(U_,r,i.copyright))}return void this._fetchAttributionData(r)}const s=i.get("portalItem.accessInformation");mF(U_,r,s||i.copyright)}),tDt(this.items,U_)&&(this.items.removeAll(),this.items.addMany(U_)),U_.length=0,this.notifyChange("state")):this._clear()}async _fetchAttributionData(t){if(this._pendingAttributions.has(t))return;this._pendingAttributions.add(t);const e=await Sh(t.layer.fetchAttributionData());if(this._pendingAttributions.has(t)){const r=e.ok?this._createContributionIndex(e.value,rDt(t.layer)):null;this._pendingAttributions.delete(t),this._fetchedAttributionData.set(t,r)}this._updateAttributionItems()}_createContributionIndex(t,e){const r=t.contributors,i={};if(!r)return i;for(let s=0;s<r.length;s++){const n=r[s],o=n.coverageAreas;if(!o)return;for(const a of o){const l=a.bbox,c=a.zoomMin-(e&&a.zoomMin?1:0),h=a.zoomMax-(e&&a.zoomMax?1:0),p=new vr({xmin:l[1],ymin:l[0],xmax:l[3],ymax:l[2],spatialReference:qe.WGS84}),f={extent:bC(p),attribution:n.attribution||"",score:a.score!=null?a.score:100,id:s};for(let m=c;m<=h;m++)i[m]??(i[m]=[]),i[m].push(f)}}return i.maxKey=Math.max.apply(null,Object.keys(i)),i}_getDynamicAttribution(t,e,r){const{extent:i,scale:s}=e;let n=r.tileInfo?.scaleToZoom(s)??0;if(n=Math.min(t.maxKey??0,Math.round(n)),!i||n==null||n<=-1)return"";const o=t[n],a=sS(i.center.clone().normalize(),e.spatialReference),l=new Set;return o?o.filter(c=>{const h=c.id,p=!l.has(h)&&a&&c.extent&&EQ(c.extent,a);return p&&l.add(h),p}).sort((c,h)=>h.score-c.score||c.objectId-h.objectId).map(c=>c.attribution).join(", "):""}};u([d({readOnly:!0,type:Ke})],FE.prototype,"items",void 0),u([d({readOnly:!0})],FE.prototype,"state",null),u([d()],FE.prototype,"view",void 0),FE=u([R("esri.widgets.Attribution.AttributionViewModel")],FE);const a4e=FE,N2="esri-attribution",V_={base:`${N2} esri-widget`,poweredBy:`${N2}__powered-by`,sources:`${N2}__sources`,open:`${N2}--open`,sourcesOpen:`${N2}__sources--open`,link:`${N2}__link`,widgetIcon:"esri-icon-description",interactive:"esri-interactive"};let Sl=class extends Rc{constructor(e,r){super(e,r),this._isOpen=!1,this._attributionTextOverflowed=!1,this._prevSourceNodeHeight=0,this._resizeObserver=new ResizeObserver(i=>i.forEach(({target:s})=>this._checkSourceTextOverflow(s))),this.iconClass=V_.widgetIcon,this.icon=null,this.itemDelimiter=" | ",this.messages=null,this.viewModel=new a4e}initialize(){this.addHandles(Vs(()=>this.viewModel?.items,"change",()=>this.scheduleRender()))}destroy(){this._resizeObserver?.disconnect()}get _isInteractive(){return this._isOpen||this._attributionTextOverflowed}get attributionText(){return this.viewModel.items.reduce((e,r)=>(e.includes(r.text)||e.push(r.text),e),[]).join(this.itemDelimiter)}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}render(){const e={[V_.open]:this._isOpen};return j("div",{bind:this,class:this.classes(V_.base,e),dir:"ltr",onclick:this._toggleState,onkeydown:this._toggleState},this.renderSourcesNode(),this.renderPoweredBy())}renderPoweredBy(){return j("div",{class:V_.poweredBy},"Powered by"," ",j("a",{class:V_.link,href:"http://www.esri.com/",target:"_blank",rel:"noreferrer"},"Esri"))}renderSourcesNode(){const e=this._isOpen,r=this._isInteractive,i=r?"0":"",{attributionText:s}=this,n={[V_.sourcesOpen]:e,[V_.interactive]:r};return j("div",{afterCreate:this._afterSourcesNodeCreate,bind:this,class:this.classes(V_.sources,n),innerHTML:s,tabindex:i})}_afterSourcesNodeCreate(e){this._prevSourceNodeHeight=e.clientWidth,this._resizeObserver.observe(e)}_checkSourceTextOverflow(e){let r=!1;const{clientHeight:i,clientWidth:s,scrollWidth:n}=e,o=n>s,a=this._attributionTextOverflowed!==o;if(this._attributionTextOverflowed=o,a&&(r=!0),this._isOpen){const l=i<this._prevSourceNodeHeight;this._prevSourceNodeHeight=i,l&&(this._isOpen=!1,r=!0)}r&&this.scheduleRender()}_toggleState(){this._isInteractive&&(this._isOpen=!this._isOpen)}};u([d()],Sl.prototype,"_isOpen",void 0),u([d()],Sl.prototype,"_isInteractive",null),u([d()],Sl.prototype,"_attributionTextOverflowed",void 0),u([d()],Sl.prototype,"_prevSourceNodeHeight",void 0),u([d({readOnly:!0,dependsOn:["viewModel.items.length","itemDelimiter"]})],Sl.prototype,"attributionText",null),u([d()],Sl.prototype,"iconClass",void 0),u([d()],Sl.prototype,"icon",void 0),u([d()],Sl.prototype,"itemDelimiter",void 0),u([d()],Sl.prototype,"label",null),u([d(),Aa("esri/widgets/Attribution/t9n/Attribution")],Sl.prototype,"messages",void 0),u([d()],Sl.prototype,"view",null),u([d({type:a4e})],Sl.prototype,"viewModel",void 0),u([Hm()],Sl.prototype,"_toggleState",null),Sl=u([R("esri.widgets.Attribution")],Sl);const iDt=Sl,sDt=t=>{let e=class extends t{constructor(...r){super(...r),this.goToOverride=null,this.view=null}callGoTo(r){const{view:i}=this;return rS(i),this.goToOverride?this.goToOverride(i,r):i.goTo(r.target,r.options)}};return u([d()],e.prototype,"goToOverride",void 0),u([d()],e.prototype,"view",void 0),e=u([R("esri.widgets.support.GoTo")],e),e},nDt="esri.widgets.CompassViewModel";let gx=class extends sDt(me){constructor(e){super(e),this._handles=new li,this.orientation={x:0,y:0,z:0},this.view=null,this._updateForCamera=this._updateForCamera.bind(this),this._updateForRotation=this._updateForRotation.bind(this),this._updateRotationWatcher=this._updateRotationWatcher.bind(this)}initialize(){this._handles.add(Q(()=>this.view,this._updateRotationWatcher,xt))}destroy(){Pi(this._handles),this.view=null}get canShowNorth(){const e=this.get("view.spatialReference");return!(!e||!e.isWebMercator&&!e.isGeographic)}get state(){return this.get("view.ready")?this.canShowNorth?"compass":"rotation":"disabled"}reset(){if(!this.get("view.ready"))return;const e={};this.view?.type==="2d"?e.rotation=0:e.heading=0,this.callGoTo({target:e})}_updateForRotation(e){e!=null&&(this.orientation={z:e})}_updateForCamera(e){if(!e)return;const r=-e.heading;this.orientation={x:0,y:0,z:r}}_updateRotationWatcher(e){this._handles.removeAll(),e&&this._handles.add(e.type==="2d"?Q(()=>e?.rotation,this._updateForRotation,xt):Q(()=>e?.camera,this._updateForCamera,xt))}};u([d({readOnly:!0})],gx.prototype,"canShowNorth",null),u([d()],gx.prototype,"orientation",void 0),u([d({readOnly:!0})],gx.prototype,"state",null),u([d()],gx.prototype,"view",void 0),gx=u([R(nDt)],gx);const l4e=gx,z_={base:"esri-compass esri-widget--button esri-widget",text:"esri-icon-font-fallback-text",icon:"esri-compass__icon",rotationIcon:"esri-icon-dial",northIcon:"esri-icon-compass",widgetIcon:"esri-icon-locate-circled",interactive:"esri-interactive",disabled:"esri-disabled"};let Hp=class extends Rc{constructor(e,r){super(e,r),this.iconClass=z_.widgetIcon,this.icon=null,this.messages=null,this.viewModel=new l4e}get goToOverride(){return this.viewModel.goToOverride}set goToOverride(e){this.viewModel.goToOverride=e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}reset(){return this.viewModel.reset()}render(){const{orientation:e,state:r}=this.viewModel,i=r==="disabled",s=(r==="rotation"?"rotation":"compass")=="compass",n=i?-1:0,o={[z_.disabled]:i,[z_.interactive]:!i},a={[z_.northIcon]:s,[z_.rotationIcon]:!s},{messages:l}=this;return j("div",{bind:this,class:this.classes(z_.base,o),onclick:this._reset,onkeydown:this._reset,role:"button",tabIndex:n,"aria-label":l.reset,title:l.reset},j("span",{"aria-hidden":"true",class:this.classes(z_.icon,a),styles:this._toRotationTransform(e)}),j("span",{class:z_.text},l.reset))}_reset(){this.viewModel.reset()}_toRotationTransform(e){return{transform:`rotateZ(${e.z}deg)`}}};u([d()],Hp.prototype,"goToOverride",null),u([d()],Hp.prototype,"iconClass",void 0),u([d()],Hp.prototype,"icon",void 0),u([d()],Hp.prototype,"label",null),u([d(),Aa("esri/widgets/Compass/t9n/Compass")],Hp.prototype,"messages",void 0),u([d()],Hp.prototype,"view",null),u([d({type:l4e})],Hp.prototype,"viewModel",void 0),u([Hm()],Hp.prototype,"_reset",null),Hp=u([R("esri.widgets.Compass")],Hp);const oDt=Hp,F2="esri-navigation-toggle",Bh={base:`${F2} esri-widget`,button:`${F2}__button esri-widget--button`,activeButton:`${F2}__button--active`,panButton:`${F2}__button--pan`,rotateButton:`${F2}__button--rotate`,isLayoutHorizontal:`${F2}--horizontal`,rotationIcon:"esri-icon-rotate",panIcon:"esri-icon-pan",widgetIcon:"esri-icon-pan2",disabled:"esri-disabled"};let kE=class extends me{constructor(t){super(t),this.navigationMode="pan",this.view=null}initialize(){this.own(No(()=>this.view?.inputManager,()=>this._setNavigationMode()))}destroy(){this.view=null}get state(){return this.get("view.ready")&&this.view?.type==="3d"?"ready":"disabled"}toggle(){this.state!=="disabled"&&(this.navigationMode=this.navigationMode!=="pan"?"pan":"rotate",this._setNavigationMode())}_setNavigationMode(){this.get("view.inputManager").primaryDragAction=this.navigationMode==="pan"?"pan":"rotate"}};u([d({readOnly:!0})],kE.prototype,"state",null),u([d()],kE.prototype,"navigationMode",void 0),u([d()],kE.prototype,"view",void 0),kE=u([R("esri.widgets.NavigationToggleViewModel")],kE);const c4e=kE;let qp=class extends Rc{constructor(e,r){super(e,r),this.iconClass=Bh.widgetIcon,this.icon=null,this.messages=null,this.viewModel=new c4e}get label(){return this.messages?.widgetLabel??""}set label(e){this._overrideIfSome("label",e)}set layout(e){e!=="horizontal"&&(e="vertical"),this._set("layout",e)}get view(){return this.viewModel.view}set view(e){this.viewModel.view=e}toggle(){return this.viewModel.toggle()}render(){const e=this.get("viewModel.state")==="disabled",r=this.get("viewModel.navigationMode")==="pan",i={[Bh.disabled]:e,[Bh.isLayoutHorizontal]:this.layout==="horizontal"},s={[Bh.activeButton]:r},n={[Bh.activeButton]:!r},o=e?-1:0,a=this.messages.toggle;return j("div",{bind:this,class:this.classes(Bh.base,i),onclick:this._toggle,onkeydown:this._toggle,tabIndex:o,"aria-label":a,title:a},j("div",{class:this.classes(Bh.button,Bh.panButton,s)},j("span",{class:Bh.panIcon})),j("div",{class:this.classes(Bh.button,Bh.rotateButton,n)},j("span",{class:Bh.rotationIcon})))}_toggle(){this.toggle()}};u([d()],qp.prototype,"iconClass",void 0),u([d()],qp.prototype,"icon",void 0),u([d()],qp.prototype,"label",null),u([d({value:"vertical"})],qp.prototype,"layout",null),u([d(),Aa("esri/widgets/NavigationToggle/t9n/NavigationToggle")],qp.prototype,"messages",void 0),u([d()],qp.prototype,"view",null),u([d({type:c4e})],qp.prototype,"viewModel",void 0),u([Hm()],qp.prototype,"_toggle",null),qp=u([R("esri.widgets.NavigationToggle")],qp);const aDt=qp,qR={button:"esri-widget--button esri-widget",disabled:"esri-disabled",interactive:"esri-interactive",iconText:"esri-icon-font-fallback-text",icon:"esri-icon"};let ky=class extends Rc{constructor(){super(...arguments),this.enabled=!0,this.iconClass=null,this.icon=null,this.title=""}render(){const t=this.enabled?0:-1,e={[qR.disabled]:!this.enabled,[qR.interactive]:this.enabled};return j("div",{bind:this,class:this.classes(qR.button,e),onclick:this._triggerAction,onkeydown:this._triggerAction,role:"button",tabIndex:t,title:this.title},j("span",{"aria-hidden":"true",role:"presentation",class:this.classes(qR.icon,this.iconClass??"")}),j("span",{class:qR.iconText},this.title))}_triggerAction(){this.action.call(this)}};u([d()],ky.prototype,"action",void 0),u([d()],ky.prototype,"enabled",void 0),u([d()],ky.prototype,"iconClass",void 0),u([d()],ky.prototype,"icon",void 0),u([d()],ky.prototype,"title",void 0),u([Hm()],ky.prototype,"_triggerAction",null),ky=u([R("esri.widgets.IconButton")],ky);const N0e=ky;let UE=class extends me{get canZoomIn(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMaxScale");return e===0||t>e}get canZoomOut(){if(!this.get("view.ready"))return!1;const t=this.get("view.animation.target.scale")||this.get("view.scale"),e=this.get("view.constraints.effectiveMinScale");return e===0||t<e}};u([d({readOnly:!0})],UE.prototype,"canZoomIn",null),u([d({readOnly:!0})],UE.prototype,"canZoomOut",null),u([d()],UE.prototype,"view",void 0),UE=u([R("esri.widgets.Zoom.ZoomConditions2D")],UE);const lDt=UE;let VE=class extends me{get canZoomIn(){return!!this.view.ready}get canZoomOut(){return!!this.view.ready}};u([d({readOnly:!0})],VE.prototype,"canZoomIn",null),u([d({readOnly:!0})],VE.prototype,"canZoomOut",null),u([d()],VE.prototype,"view",void 0),VE=u([R("esri.widgets.Zoom.ZoomConditions3D")],VE);const cDt=VE;let Pv=class extends me{constructor(e){super(e)}destroy(){this.view=null}get canZoomIn(){return this._zoomConditions!=null&&this._zoomConditions.canZoomIn}get canZoomOut(){return this._zoomConditions!=null&&this._zoomConditions?.canZoomOut}get state(){return this.view?.ready?"ready":"disabled"}set view(e){e?e.type==="2d"?this._zoomConditions=new lDt({view:e}):e.type==="3d"&&(this._zoomConditions=new cDt({view:e})):this._zoomConditions=null,this._set("view",e)}zoomIn(){if(!this.canZoomIn)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomIn():gC(e.goTo({zoomFactor:2}))}zoomOut(){if(!this.canZoomOut)return;const e=this.view;e.type==="2d"?e.mapViewNavigation.zoomOut():gC(e.goTo({zoomFactor:.5}))}};u([d()],Pv.prototype,"_zoomConditions",void 0),u([d()],Pv.prototype,"canZoomIn",null),u([d()],Pv.prototype,"canZoomOut",null),u([d({readOnly:!0})],Pv.prototype,"state",null),u([d()],Pv.prototype,"view",null),Pv=u([R("esri.widgets.Zoom.ZoomViewModel")],Pv);const u4e=Pv,WR={base:"esri-zoom esri-widget",horizontalLayout:"esri-zoom--horizontal",zoomInIcon:"esri-icon-plus",zoomOutIcon:"esri-icon-minus",widgetIcon:"esri-icon-zoom-in-magnifying-glass"};let km=class extends Rc{constructor(t,e){super(t,e),this.iconClass=WR.widgetIcon,this.icon=null,this.messages=null,this.viewModel=new u4e}initialize(){this._zoomInButton=new N0e({action:this.zoomIn.bind(this),iconClass:WR.zoomInIcon}),this._zoomOutButton=new N0e({action:this.zoomOut.bind(this),iconClass:WR.zoomOutIcon})}destroy(){this._zoomInButton=Re(this._zoomInButton),this._zoomOutButton=Re(this._zoomOutButton)}get label(){return this.messages?.widgetLabel??""}set label(t){this._overrideIfSome("label",t)}set layout(t){t!=="horizontal"&&(t="vertical"),this._set("layout",t)}set view(t){this.viewModel.view=t}get view(){return this.viewModel.view}render(){const t=this.viewModel,e={[WR.horizontalLayout]:this.layout==="horizontal"},{canZoomIn:r,canZoomOut:i}=t;this._zoomInButton.enabled=r,this._zoomOutButton.enabled=i;const{zoomIn:s,zoomOut:n}=this.messages;return this._zoomInButton.title=s,this._zoomOutButton.title=n,j("div",{class:this.classes(WR.base,e)},this._zoomInButton.render(),this._zoomOutButton.render())}zoomIn(){return this.viewModel.zoomIn()}zoomOut(){return this.viewModel.zoomOut()}};u([d()],km.prototype,"iconClass",void 0),u([d()],km.prototype,"icon",void 0),u([d()],km.prototype,"label",null),u([d({value:"vertical"})],km.prototype,"layout",null),u([d(),Aa("esri/widgets/Zoom/t9n/Zoom")],km.prototype,"messages",void 0),u([d()],km.prototype,"view",null),u([d({type:u4e})],km.prototype,"viewModel",void 0),km=u([R("esri.widgets.Zoom")],km);const uDt=km;function hDt(t){return t?.view!==void 0}let A5=class extends eDt{constructor(t){super(t),this._defaultPositionLookup={attribution:"manual",compass:"top-left","navigation-toggle":"top-left",zoom:"top-left"},this.components=[],this._updateViewAwareWidgets=e=>{this.components.forEach(r=>{const i=this._find(r),s=i?.widget;hDt(s)&&(s.view=e)})},this._componentsWatcher=(e,r)=>{this._removeComponents(r),this._addComponents(e),this._adjustPadding(e)}}initialize(){this.addHandles([Q(()=>this.components,this._componentsWatcher,xt),Q(()=>this.view,this._updateViewAwareWidgets,xt)])}_add(t,e,r,i,s){let n=t;if(typeof t=="string"&&this._defaultPositionLookup[t]){if(this._find(t))return;n=this._createComponent(t)}super._add(n,e,r,i,s)}_removeComponents(t){t.forEach(e=>{const r=this._find(e);r&&(this.remove(r),r.destroy())})}_adjustPadding(t){if(!t.includes("attribution")&&!this._isOverridden("padding")){const{top:e}=this.padding;this.padding=e}}_addComponents(t){this.constructed&&t.forEach(e=>this.add(this._createComponent(e),this._defaultPositionLookup[e]))}_createComponent(t){const e=this._createWidget(t);return new C5({id:t,node:e})}_createWidget(t){const{view:e}=this;switch(t){case"attribution":return new iDt({view:e});case"compass":return new oDt({view:e});case"navigation-toggle":return new aDt({view:e});case"zoom":return new uDt({view:e})}}};u([d()],A5.prototype,"components",void 0),A5=u([R("esri.views.ui.DefaultUI")],A5);const h4e=A5;let O5=class extends h4e{constructor(t){super(t),this.components=["attribution","zoom","navigation-toggle","compass"]}};u([d()],O5.prototype,"components",void 0),O5=u([R("esri.views.ui.3d.DefaultUI3D")],O5);const d4e=O5;let Ye=class extends Ect(qct(Mct(vut))){constructor(t){super(t),this._userClippingArea=null,this._clippingArea=null,this._initialDefaultSpatialReference=null,this._defaults={},this._externallySet={environment:!1},this._createGraphicsViewController=null,this._resolveWhenReady=[],this._propertiesPool=new M0({slicePlane:oRe},this),this._resourceController=EAt(this),this._defaultToMapOptions={include:new Set},this._defaultHitTestOptions={exclude:new Set},this.deconflictor=new AY({view:this}),this.labeler=new ux({view:this,deconflictor:this.deconflictor.labels}),this.sharedSymbolResources=null,this.analyses=new CA,this.basemapTerrain=null,this.elevationProvider=null,this.canvas=null,this.constraints=new $x,this.environmentManager=new kp,this.floors=new Ke,this.fullOpacity=1,this.graphicsView=null,this.analysisViewManager=new xut({view:this}),this.groundView=null,this.map=null,this.screenSizePerspectiveEnabled=!0,this.state=new zCt,this.spatialReference=null,this.alphaCompositingEnabled=!1,this.preserveDrawingBufferEnabled=!1,this.supersampleScreenshotsEnabled=!0,this.type="3d",this.ui=new d4e,this._numUpdating=0,this._lastUpdateTime=0,this.updatingProgress=.5,this.highlightOptions=new ZY,this.voxelWasm=null,this.voxelWasmPromise=null,_Ze(),t&&t.environment||(this._defaults.environment=new SE,this.environment=this._defaults.environment);const e=(r=null)=>{r!=null&&r.type===mi.MOVE||(this._updatingChanged(),this.map&&this.map.allLayers.forEach(async i=>{try{await i.when()}catch{}this._updatingChanged()}))};this.addHandles([Vs(()=>this.map?.allLayers,"after-changes",r=>e(r),{onListenerAdd:()=>e(),onListenerRemove:()=>e(),sync:!0}),this.allLayerViews.on("after-changes",r=>this._updateUpdatingMonitors(r)),Q(()=>this.map,r=>{r&&"load"in r&&r.load&&r.load().catch(()=>{})})]),this.inputManager=new y0t({view:this}),this.stateManager=new Yn({view:this})}initialize(){this.groundView=new Hct({view:this}),this._updateUpdatingMonitors();const t=()=>this._updateDefaultToMapOptions();this.addHandles(Vs(()=>this.map?.allLayers,"after-changes",t,{onListenerAdd:t,onListenerRemove:t})),this.updatingHandles.add(()=>this.qualitySettings.memoryLimit,e=>{this.resourceController&&(this.resourceController.memoryController.maxMemory=e)},xt),this.updatingHandles.add(()=>this.qualitySettings.additionalCacheMemory,e=>{this.resourceController&&(this.resourceController.memoryController.additionalCacheMemory=e)},xt),this.updatingHandles.add(()=>this.qualitySettings.frameRate??0,e=>I6e(e>0?1e3/Math.ceil(e):0),xt),this.updatingHandles.add(()=>this.map?.ground,t,Ri),this.updatingHandles.add(()=>this.map?.ground?.opacity,()=>this._updateDefaultHitTestOptions(),Ri),this.addHandles(Q(()=>this.spatialReference,()=>this.notifyChange("clippingArea"),Rr))}destroy(){this.destroyed||(this.updatingHandles.removeAll(),this.removeAllHandles(),this.invalidate(),this.activeTool=null,this.layerViewManager.clear(),this._exitSurface(),this._disposeGraphicsView(),this.sharedSymbolResources=Re(this.sharedSymbolResources),this._set("labeler",Re(this.labeler)),this._set("deconflictor",Re(this.deconflictor)),this._resourceController=Re(this._resourceController),this._set("stateManager",Re(this.stateManager)),this._set("inputManager",Re(this.inputManager)),this.state.destroy(),this._propertiesPool.destroy(),this.removeHandles("updatingMonitors"),this._set("environmentManager",Re(this.environmentManager)),this.groundView=Re(this.groundView),this._exitBasemapTerrain(),this._stage?.destroy(),this.removeAllHandles(),this.updatingHandles.removeAll(),this.handles.removeAll())}get renderSpatialReference(){return this.renderCoordsHelper&&this.renderCoordsHelper.spatialReference}get basemapSpatialReference(){return this.basemapTerrain?.spatialReference}get animation(){return this.state?.animation}get camera(){return this.stateManager?.camera}set camera(t){this.stateManager&&(this.stateManager.camera=t)}get contentCamera(){return this.stateManager?.contentCamera}set contentCamera(t){this.stateManager&&(this.stateManager.contentCamera=t)}installContentCameraReset(t={sticky:!1}){return this.stateManager.installContentCameraReset(t)}get center(){return this.stateManager?.center}set center(t){this.stateManager&&(this.stateManager.center=t)}get clippingArea(){if(this.viewingMode==="global")return null;let t=this._userClippingArea||("clippingArea"in this.map?this.map?.clippingArea:void 0);return!this._userClippingArea&&!this.get("map.clippingEnabled")||t==null?(this._clippingArea=null,null):t instanceof vr?this.spatialReference&&(t=gF(t,this.spatialReference),t==null)?(K.getLogger(this).error("#clippingArea","setting clippingArea with incompatible SpatialReference"),this._clippingArea):(t=t.clone(),t.intersection(this._groundAndLayersExtent)==null&&(t.xmin=t.xmax,t.ymin=t.ymax),t.zmin=void 0,t.zmax=void 0,t.equals(this._clippingArea)||(this._clippingArea=t),this._clippingArea):(K.getLogger(this).error("#clippingArea","only clippingArea geometries of type Extent are supported"),this._clippingArea)}set clippingArea(t){this.ready&&this.viewingMode==="global"&&t!=null?K.getLogger(this).error("#clippingArea=","Clipping area is only supported in local viewingMode"):this._userClippingArea=t}get renderDataExtent(){if(this.state.viewingMode===Ue.Global)return null;const t=this.renderSpatialReference,e=this.dataExtent;return e==null||t==null||e.spatialReference.equals(t)?e:gF(e,t)}get dataExtent(){let t=this._groundAndLayersExtent;const e=this.spatialReference||qe.WGS84,r=gF(this.clippingArea,e);r!=null&&(t=t!=null?t.intersection(r):r);const i=this._get("dataExtent");return t!=null&&t.equals(i)?i:t}get _groundAndLayersExtent(){const t=this.spatialReference||qe.WGS84;let e;const r=n=>{const o=gF(n,t);o!=null&&(e!=null?e.union(o):e=o.clone())},i=this.basemapTerrain;if(i?.spatialReference){const n=i.groundExtent;r(new vr({xmin:n[0],ymin:n[1],zmin:0,xmax:n[2],ymax:n[3],zmax:0,spatialReference:i.spatialReference}))}if(this.map){const n=o=>{o.fullExtent==null||o.type==="graphics"&&o.internal||r(o.fullExtent)};this.map.allLayers.forEach(o=>n(o))}if(e==null)return null;e.hasZ?(e.zmin=Math.min(0,e.zmin??0),e.zmax=Math.max(0,e.zmax??0)):(e.zmin=0,e.zmax=0);const s=this._get("_groundAndLayersExtent");return e.equals(s)?s:e}set environment(t){t!==this._defaults.environment&&(this._externallySet.environment=!0),this._set("environment",t)}castEnvironment(t){return t?t instanceof SE?t:t instanceof jRe?this.environment!=null?this.environment.cloneWithWebsceneEnvironment(t):SE.fromWebsceneEnvironment(t):Sn(SE,t):new SE}get extent(){return this.stateManager?.extent}set extent(t){this.stateManager&&(this.stateManager.extent=t)}get screenCenter(){return this.stateManager?.screenCenter}get frustum(){return this.stateManager?.frustum}get initialExtentRequired(){return this.stateManager&&!this.stateManager.hasInitialView}get _defaultsFromMapSettings(){return{required:{tileInfo:!1,heightModelInfo:!0,extent:!1}}}get interacting(){return this.navigating||(this.toolViewManager?.interacting??!1)}get stationary(){return!this.animation&&!this.resizing&&(this.state==null||this.state.stationary)}get navigating(){return this.state?.navigating??!1}get padding(){return this.stateManager?.padding}set padding(t){this.stateManager&&(this.stateManager.padding=t)}set qualityProfile(t){f5.isValidProfile(t)&&(f5.apply(t,this.qualitySettings),this._set("qualityProfile",t))}get qualityProfile(){return this._get("qualityProfile")||f5.getDefaultProfile()}set slicePlane(t){if(this._stage!=null&&this._stage.renderer.setParameters({slicePlane:t}),t==null)return void this._set("slicePlane",null);const e=this._propertiesPool.get("slicePlane");_S(t,e),this._set("slicePlane",e)}get typeSpecificPreconditionsReady(){return!!this.viewingMode}get resolution(){return this.spatialReference!=null?wct(this.scale,this.spatialReference):0}get scale(){return this.stateManager?.scale}set scale(t){this.stateManager&&(this.stateManager.scale=t)}get heightModelInfo(){const t=this.getDefaultHeightModelInfo();return t!=null?dS.deriveUnitFromSR(t,this.spatialReference):null}get updating(){if(this.destroyed)return!1;let t=0,e=this.layerViewManager.updating,r=e?this.layerViewManager.updatingRemaining:0;this.allLayerViews.forEach(s=>{if(s.isFulfilled()){if(s.updating){if(e=!0,s.suspended||IP(s))return;++r,t+=s.updatingProgress}}else++r});for(const s of this._updatingObjects)s!=null&&s.updating&&(r+=.1,t+=.5*.1);for(const s of this._updatingObjectsWithProgress)s!=null&&s.updating&&(++r,t+=s.updatingProgress);const i=!this.stateManager.test.updatingIgnoreRenderState&&this.state.updating;if(e=!!(e||r>0||this.updatingHandles.updating||!this.ready||!this.stationary||i||this._createGraphicsViewController||this.inputManager?.updating||this.map?.allLayers?.some(s=>!s.isFulfilled())),e?(this._numUpdating=Math.max(r,this._numUpdating),t+=this._numUpdating-r):this._numUpdating=0,this._numUpdating>0?t/=this._numUpdating:t=e?0:1,this._get("updatingProgress")!==t){const s=performance.now();if(t<1){const n=Math.min((s-this._lastUpdateTime)/2e3,1);t=this.updatingProgress*(1-n)+t*n}this._set("updatingProgress",t),this._lastUpdateTime=e&&t<1?s:0}return e}get _updatingObjects(){return[this.graphicsView,this.basemapView,this._resourceController,this._stage,this.featureTiles,this.pointsOfInterest,this.environmentManager,this.overlay,this._featureTreeDebugger,this.toolViewManager,this.analysisViewManager]}get _updatingObjectsWithProgress(){return[this.deconflictor,this.labeler,this.basemapTerrain]}get viewingMode(){const t=this._predeterminedViewingMode;if(t!=null)return Fz(t);const e=this.spatialReference;return e?this.defaultsFromMap?.viewingMode!=null&&e.equals(this.defaultsFromMap.spatialReference)?Fz(this.defaultsFromMap.viewingMode):pY(e,Ue.Global)?"global":"local":"global"}set viewingMode(t){this.ready?K.getLogger(this).error("#viewingMode","viewingMode cannot be set once view is ready"):this._overrideIfSome("viewingMode",t)}get viewpoint(){return this.stateManager?.viewpoint}set viewpoint(t){this.stateManager&&(this.stateManager.viewpoint=t)}get zoom(){return this.stateManager.zoom}set zoom(t){this.stateManager&&(this.stateManager.zoom=t)}get resourceController(){return this._resourceController}get performanceInfo(){return new JAt(this)}on(t,e,r,i){return this.viewEvents.on(t,e,r,i)||super.on(t,e)}hasEventListener(t){return super.hasEventListener(t)||this.viewEvents.hasHandler(t)}toMap(t,e){if(!this.ready)return K.getLogger(this).error("#toMap()","Scene view cannot be used before it is ready"),null;const r=e?this.externalToInternalIntersectOptions(e):this._defaultToMapOptions,i=r.graphics!=null&&(r.graphics.include!=null||r.graphics.exclude!=null),s=uce(t)?cce(this,t):t,n=qm(s);r.enableDraped=r.include&&!r.include.has(Yv)||r.exclude&&r.exclude.has(Yv);const o=this.sceneIntersectionHelper,a=Jd(this.state.viewingMode);if(a.options.selectionMode=!0,a.options.store=i?na.ALL:na.MIN,o.intersectIntersectorScreen(n,a,r),i){for(const l of a.results.all){const c=CJ(l,this);if(c==null)return this._intersectResultToMapPoint(l);if(c.type!=="graphic"||this._testGraphicUidFilter(r.graphics,c.graphic))return this._intersectResultToMapPoint(l)}return null}return this._intersectResultToMapPoint(a.results.min)}toScreen(t){if(!this.ready)return K.getLogger(this).error("#toScreen()","Scene view cannot be used before it is ready"),null;const e=(t.z==null?Qm(this.elevationProvider,t):null)??0;return aa(t,k2,this.renderSpatialReference,e),this.state.camera.projectToScreen(k2,Oj),xh(Oj[0],Oj[1])}pixelSizeAt(t){return this.ready?t?(aa(t,k2,this.renderSpatialReference),this.state.camera.computeScreenPixelSizeAt(k2)):0:(K.getLogger(this).error("#pixelSizeAt()","Scene view cannot be used before it is ready"),null)}overlayPixelSizeInMapUnits(t){const e=this.basemapTerrain.overlayManager;return e?e.overlayPixelSizeInMapUnits(t):1}hitTest(t,e){if(!this.ready)return K.getLogger(this).error("#hitTest()","Scene view cannot be used before it is ready"),null;const r=uce(t)?cce(this,t):t,i=cs(r.x,r.y),s=e?this.externalToInternalIntersectOptions(e):this._defaultHitTestOptions;s.requiresGroundFeedback=!0,s.enableDraped=!0;const n=Jd(this.state.viewingMode);n.options.selectionMode=!0,n.options.store=na.ALL,this.sceneIntersectionHelper.intersectIntersectorScreen(i,n,s);const o=this._intersectResultsToHits(n.results.all,s.graphics),a=n.results.ground,l=I0e(a,this),c=l!=null&&"type"in l&&l.type==="integrated-mesh"?l:null,h={screenPoint:r,results:o,ground:{mapPoint:this._intersectResultToMapPoint(a),distance:Bf(a)?a.distanceInRenderSpace:0,layer:c}};return bi.SCENEVIEW_HITTEST_RETURN_INTERSECTOR&&(h.intersector=n),Promise.resolve(h)}async popupHitTest(t){const{results:e,ground:r}=await cCe(this,t);let i=null;return!(e.length===0||Math.abs((e[0].distance??0)-r.distance)<1e-5)||r.layer&&r.layer.type==="integrated-mesh"||(i=r.mapPoint),{results:e,screenPoint:t,mapPoint:i}}goTo(t,e){return this.updatingHandles.addPromise(this.stateManager.goTo(t,e))}async whenAnalysisView(t){if(t.parent==null)throw new D("view:no-analysisview-for-analysis","The analysis has not been added to view.analyses",{analysis:t});switch(t.parent.type){case"line-of-sight":case"dimension":return(await this.whenLayerView(t.parent)).whenAnalysisView();default:return this.analysisViewManager.whenAnalysisView(t)}}whenLayerView(t){return super.whenLayerView(t)}async takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return wj(r,e,this._pixelFormat())}async _takeScreenshot(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshot(e);return xj(r,this._pixelFormat())}async _takeScreenshotWithObjectAndLayerId(t){const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e);return[xj(r[0],this._pixelFormat()),xj(r[1],this._pixelFormat())]}_completeSettings(t){const e=wLt(t,this);return e.pixelRatio/=this.state.pixelRatio,ELt(e,this.supersampleScreenshotsEnabled,this.padding)}_pixelFormat(){return{flipY:!0,premultipliedAlpha:this._stage.renderView.getAlpha()}}get test(){return{takeScreenshot:t=>this._takeScreenshot(t),takeScreenshotWithObjectAndLayerId:t=>this._takeScreenshotWithObjectAndLayerId(t)}}async takeScreenshotWithObjectAndLayerId(t){if(!le("enable-feature:objectAndLayerId-rendering"))throw new Error("has enable-feature:objectAndLayerId-rendering must be true");const e=this._completeSettings(t);await this.whenReady();const r=await this._stage.renderView.takeScreenshotWithOID(e),i=wj(r[0],e,this._pixelFormat()),s=this._completeSettings(t);return s.format="png",[i,wj(r[1],s,this._pixelFormat())]}getColorToObjectAndLayerIdMapping(){if(this._stage.renderView.objectAndLayerIdRenderHelper==null)throw new Error("has enable-feature:objectAndLayerId-rendering must be true");return this._stage.renderView.objectAndLayerIdRenderHelper.getColorToObjectAndLayerIdMapping()}addUpdatingPromise(t){return this.updatingHandles.addPromise(t)}importLayerView(t){return Sue.importLayerView(t)}hasLayerViewModule(t){return Sue.hasLayerViewModule(t)}forceDOMReadyCycle(){this.forceReadyCycle()}getDefaultSpatialReference(){return this.map&&"initialViewProperties"in this.map&&this.map?.initialViewProperties?.spatialReference||this.defaultsFromMap?.spatialReference||this.defaultsFromMap?.ready&&this._initialDefaultSpatialReference||null}async validate(){let t=XLt(this.type);const e=le("safari");if(e&&e<9&&(t=new D("sceneview:browser-not-supported","This browser is not supported by SceneView (Safari < 9)",{type:"safari",requiredVersion:9,detectedVersion:e})),t!=null)throw K.getLogger(this).warn("#validate()",t.message),t}get _predeterminedViewingMode(){const t=this._isOverridden("viewingMode")?this._get("viewingMode"):(this.map&&"initialViewProperties"in this.map?this.map.initialViewProperties?.viewingMode:null)??null;return t!=null?Bce(t):null}getSpatialReferenceSupport({spatialReference:t,layer:e}){const r=this._predeterminedViewingMode;if(r!=null)return this._validateSpatialReferenceForViewingMode(t,e,r)?{constraints:this._makeSpatialReferenceConstraints(t,e,r)}:null;const i=this._validateSpatialReferenceForViewingMode(t,e,Ue.Local),s=this._validateSpatialReferenceForViewingMode(t,e,Ue.Global);return i||s?i&&s?{constraints:this._makeSpatialReferenceConstraints(t,e,null)}:i?{constraints:this._makeSpatialReferenceConstraints(t,e,Ue.Local)}:{constraints:this._makeSpatialReferenceConstraints(t,e,Ue.Global)}:null}_validateSpatialReferenceForViewingMode(t,e,r){return!!pY(t,r)&&(e==null||!!yoe(e)||(!GM(e)||Q8(e,t,r)!=null)&&(!goe(e)||r!==Ue.Global))}_makeSpatialReferenceConstraints(t,e,r){if(e==null)return[{spatialReference:t,viewingMode:r}];const i=t.isWebMercator,s=t.isWGS84;return yoe(e)&&(i||s)?!s||r===Ue.Local||Lie(e.tileInfo,e.fullExtent,t,Ue.Global)===null?[{spatialReference:t,viewingMode:r},{spatialReference:qe.WebMercator,viewingMode:r}]:[{spatialReference:i?qe.WGS84:qe.WebMercator,viewingMode:r}]:GM(e)||goe(e)||!i&&!s?GM(e)&&i&&r!==Ue.Global?[{spatialReference:t,viewingMode:r},{spatialReference:qe.WGS84,viewingMode:Ue.Local}]:[{spatialReference:t,viewingMode:r}]:[{spatialReference:t,viewingMode:r},{spatialReference:i?qe.WGS84:qe.WebMercator,viewingMode:r}]}_validateSpatialReference(t){const e=this.getSpatialReferenceSupport({spatialReference:t})!=null,r=this._predeterminedViewingMode;return e||(r!=null?K.getLogger(this).warnOnce(`Spatial reference defined on view not supported in ${Fz(r)} viewing mode.`):t.isGeographic&&K.getLogger(this).warnOnce("Spatial reference is geographic but not supported.")),e}whenReady(){return new Promise(t=>{this.ready?t(this):this._resolveWhenReady.push(t)})}computeMapPointFromVec3d(t,e){let r=this.spatialReference||qe.WGS84;return Tn(t,this.renderSpatialReference,t,r)||(r=qe.WGS84,Tn(t,this.renderSpatialReference,t,r)),e?(e.x=t[0],e.y=t[1],e.z=t[2],e.spatialReference=r):e=new ht(t,r),e}trackGraphicState(t){if(!t.graphic)return K.getLogger(this).error("trackGraphicState","GraphicState.graphic must not be null or undefined to start tracking"),null;const e=this.getViewForGraphic(t.graphic);let r=null,i=!1;const s=n=>{!i&&n!=null&&"processor"in n&&n.processor?.type==="graphics-3d"&&n.processor.graphicsCore&&(r=n.processor.graphicsCore.trackGraphicState(t))};return e!=null?s(e):this.whenViewForGraphic(t.graphic,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,r!=null&&(r.remove(),r=null)}}}highlight(t){if(Array.isArray(t))return Sc(t.map(r=>this.highlight(r)));if(Ke.isCollection(t))return Sc(t.toArray().map(r=>this.highlight(r)));const e=this.getViewForGraphic(t);return e&&"highlight"in e?e.highlight(t):Zr()}maskOccludee(t){if(!t)return K.getLogger(this).error("maskOccludee","GraphicState.graphic must not be null or undefined to mask an occludee"),null;const e=this.getViewForGraphic(t);let r=null,i=!1;const s=n=>{!i&&n!=null&&drt(n)&&(r=n.maskOccludee(t))};return e!=null?s(e):this.whenViewForGraphic(t,{waitForLayer:!0}).then(n=>s(n),()=>{}).catch(()=>{}),{remove:()=>{i=!0,r!=null&&(r.remove(),r=null)}}}getViewForGraphic(t){return t.layer===this.graphics?this.graphicsView:t.layer?this.allLayerViews.find(e=>e.layer===t.layer):null}graphicChanged(t){this.graphicsView!=null&&this.graphicsView.graphicChanged(t)}async whenViewForGraphic(t,e){if(t.layer===this)return await Pn(()=>this.graphicsView),this.graphicsView;if(!t.layer||!this.map)throw new D("no-view-for-graphic");return e&&e.waitForLayer&&!this.map.allLayers.includes(t.layer)?new Promise((r,i)=>{const s=this.map.allLayers.on("change",n=>{n.added.includes(t.layer)&&(s.remove(),this.whenLayerView(t.layer).then(r,i))})}):this.whenLayerView(t.layer)}externalToInternalIntersectOptions(t){const e=this._externalToInternalRenderItems(t.include,RI.INCLUDE),r=this._externalToInternalRenderItems(t.exclude,RI.EXCLUDE);return{include:e.layerUids,exclude:r.layerUids,graphics:{include:e.graphicUids,exclude:r.graphicUids}}}_intersectResultToMapPoint(t,e){return t.getIntersectionPoint(k2)?(e=this.computeMapPointFromVec3d(k2,e),t.intersector===ls.TERRAIN&&this.basemapTerrain&&(e.z=Qm(this.basemapTerrain,e)??0),e):null}_intersectResultsToHits(t,e){const r=new Array;let i=null;for(let s=0;s<t.length;s++){const n=t[s],o=I0e(n,this);if(o!=null&&(o===this.map.ground||"type"in o&&o.type==="integrated-mesh"))break;const a=CJ(n,this);if(a==null)continue;if(a.type==="graphic"){if(i==null&&s!==t.length-1&&(i=new Set),i!=null){const h=this._getGraphicFilterUid(a.graphic);if(i.has(h))continue;i.add(h)}if(!this._testGraphicUidFilter(e,a.graphic))continue}const l=this._intersectResultToMapPoint(n),c=n.distanceInRenderSpace;r.push({...a,mapPoint:l,distance:c})}return r}_getGraphicFilterUid(t){const e=t.sourceLayer,r=t.layer,i=e&&"objectIdField"in e?e:r&&"objectIdField"in r?r:e;if(i){const s=i.objectIdField??Tct,n=t.attributes?.[s];if(n)return`o-${i.id}-${n}`}return`u-${t.uid}`}_testGraphicUidFilter(t,e){const r=this._getGraphicFilterUid(e);return t==null||(t.include==null||t.include.has(r))&&(t.exclude==null||!t.exclude.has(r))}_externalToInternalRenderItems(t,e,r={layerUids:void 0,graphicUids:void 0}){if(!t)return r;if(t instanceof oa)dDt(r,this._getGraphicFilterUid(t)),e===RI.INCLUDE&&(this.graphicsView!=null&&t.layer===this?ZR(r,this.graphicsView.processor.layer.id):t.layer&&ZR(r,t.layer.uid));else if(qj(t))for(const i of t)i===this.graphics&&this.graphicsView!=null?ZR(r,this.graphicsView.processor.layer.id):i===this.map.ground?ZR(r,Yv):this._externalToInternalRenderItems(i,e,r);else"uid"in t&&ZR(r,t.uid);return r}_initBasemapTerrain(){this._set("basemapTerrain",new K3t({view:this})),this._set("elevationProvider",new bM({view:this})),this.elevationProvider.register("ground",this.basemapTerrain)}_exitBasemapTerrain(){this.basemapTerrain&&(this.elevationProvider.unregister(this.basemapTerrain),this.elevationProvider.destroy(),this._set("elevationProvider",null),this.basemapTerrain.destroy(),this._set("basemapTerrain",null))}_initGlobe(){this._initCoordinateSystem(),this.state.createInitialCamera(),this._initBasemapTerrain(),this._set("pointsOfInterest",new lc({view:this})),this._set("featureTiles",new Qo({renderCoordsHelper:this.renderCoordsHelper,cameraOnSurface:this.pointsOfInterest.cameraOnSurface,focus:this.pointsOfInterest.focus,tilingSchemeOwner:this.basemapTerrain,viewState:this.state,scheduler:this._resourceController.scheduler,terrain:this.basemapTerrain}));const t=()=>{const e=this.basemapTerrain?.extent;if(this.clippingArea||e)if(e&&this.basemapTerrain.spatialReference){const r=this.basemapTerrain.extent!=null&&this.basemapTerrain.spatialReference!=null?bg(U6(this.basemapTerrain.extent,this.basemapTerrain.spatialReference),this.spatialReference):null;this.clippingArea!=null?this.featureTiles.filterExtent=this.clippingArea.intersection(r):this.featureTiles.filterExtent=r}else this.featureTiles.filterExtent=this.clippingArea;else this.featureTiles.filterExtent=null};this.addHandles([this.updatingHandles.add(()=>bi.FEATURE_TILE_TREE_SHOW_TILES,e=>{e&&this.featureTiles&&!this._featureTreeDebugger?this.updatingHandles.addPromise(J(()=>import("./FeatureTileTree3DDebugger-597bc9b4.js"),["./FeatureTileTree3DDebugger-597bc9b4.js","./TileTreeDebugger-2812c7df.js"],import.meta.url)).then(({FeatureTileTree3DDebugger:r})=>{!this._featureTreeDebugger&&bi.FEATURE_TILE_TREE_SHOW_TILES&&(this._featureTreeDebugger=new r({view:this}))}):e||!this._featureTreeDebugger||bi.FEATURE_TILE_TREE_SHOW_TILES||(this._featureTreeDebugger.destroy(),this._featureTreeDebugger=null)},Ri),this.updatingHandles.add(()=>this.clippingArea,t,Ri),this.updatingHandles.add(()=>this.basemapTerrain.extent,t,Ri)],"feature-tiles"),this.stateManager.init()}_exitGlobe(){this.state&&(this.stateManager.exit(),this.removeHandles("render-coords-helper"),this.removeHandles("feature-tiles"),this.featureTiles.destroy(),this._set("featureTiles",null),this.pointsOfInterest.destroy(),this._set("pointsOfInterest",null),this._exitBasemapTerrain(),this.state.exit(),this._exitCoordinateSystem())}_initCoordinateSystem(){if(this.spatialReference){const t=this.spatialReference;this.mapCoordsHelper&&this.mapCoordsHelper.spatialReference.equals(t)||this._set("mapCoordsHelper",new aAt(this.map,t));const e=this.state.isGlobal,r=bct(e,t);r!==this.renderSpatialReference&&(this._set("renderCoordsHelper",hAt.create(this.state.viewingMode,r)),e||this.addHandles(Q(()=>this.basemapTerrain?.extent,i=>{const s=this.renderCoordsHelper.spatialReference;i==null||i[0]===0&&i[1]===0&&i[2]===0&&i[3]===0||!_$(i,this.basemapTerrain.spatialReference,F0e,s)||(this.renderCoordsHelper.extent=F0e)},Rr),"render-coords-helper"),this.sceneIntersectionHelper&&this.sceneIntersectionHelper.setTolerance($A/this.renderCoordsHelper.unitInMeters))}else this._set("mapCoordsHelper",null),this._set("renderCoordsHelper",null)}_exitCoordinateSystem(){this.mapCoordsHelper&&(this.removeHandles("render-coords-helper"),this._set("renderCoordsHelper",null),this._set("mapCoordsHelper",null))}_updatingChanged(){this.notifyChange("updating")}_updateUpdatingMonitors(t=null){t!=null&&t.type===mi.MOVE||(this.removeHandles("updatingMonitors"),this.allLayerViews.forEach(e=>{e.destroyed||(this.addHandles(Q(()=>[e.updating,e.updatingProgress],()=>this._updatingChanged(),Rr),"updatingMonitors"),e.when(()=>this._updatingChanged(),()=>this._updatingChanged()))}),this._updatingChanged())}async _prepareScreenshotOverlay(){this.overlay&&await this.overlay.prepare()}_renderScreenshotOverlay(t,e){if(!this.overlay||!this.overlay.hasVisibleItems)return e;const r=t.getContext("2d");return r.putImageData(e,0,0),this.overlay.renderCanvas(t),r.getImageData(0,0,e.width,e.height)}_initStage(){const t={deactivatedWebGLExtensions:this.deactivatedWebGLExtensions,debugWebGLExtensions:this.debugWebGLExtensions,alpha:this.alphaCompositingEnabled,preserveDrawingBuffer:this.preserveDrawingBufferEnabled,canvas:this.renderCanvas,screenshot:{prepareOverlay:()=>this._prepareScreenshotOverlay(),renderOverlay:(s,n)=>this._renderScreenshotOverlay(s,n)}},e=new BCt(this.state.viewingMode,s=>this._stage.layers.forAll(s),this);this._set("sceneIntersectionHelper",e);const r=G6(this.surface);this._stage=new Ju({view:this,options:t,container:r}),this._stage.renderer.setParameters({slicePlane:this.slicePlane}),this.addHandles([this.updatingHandles.add(()=>this.qualitySettings.antialiasingEnabled,()=>this._stage.renderer.setParameters({antialiasingEnabled:this.qualitySettings.antialiasingEnabled}),xt),this.updatingHandles.add(()=>this.qualitySettings.highQualityTransparency,s=>this._stage.renderer.setParameters({highQualityTransparency:s}),xt),Q(()=>this.magnifier,s=>this._stage.renderView.magnifier=s,Ri),this.on("pointer-move",()=>this._stage?.renderer.resetAnimation()),w1(this._stage.renderView.canvas,"webglcontextlost",s=>this.fatalError=new D("webgl-context-lost",s.statusMessage))],"stage");const i=()=>{this._stage.renderer.setParameters({defaultHighlightOptions:ZY.toEngineOptions(this.highlightOptions)})};this.addHandles(this.updatingHandles.add(()=>[this.highlightOptions.color,this.highlightOptions.haloColor,this.highlightOptions.haloOpacity,this.highlightOptions.fillOpacity,this.highlightOptions.shadowOpacity,this.highlightOptions.shadowColor,this.highlightOptions.shadowDifference],i),"stage"),i(),this.renderCoordsHelper&&this.sceneIntersectionHelper.setTolerance($A/this.renderCoordsHelper.unitInMeters),this._set("canvas",this._stage.renderView.canvas)}_exitStage(){this._set("sceneIntersectionHelper",null),this._stage=Re(this._stage),this.removeHandles("stage"),this._set("canvas",null)}_initSurface(t){this._exitSurface(),this.state.init(t,this.spatialReference),this._initStage(),this._initGlobe(),this.sharedSymbolResources=new eOt({view:this,viewingMode:t,resourceController:this._resourceController,pointsOfInterest:this.pointsOfInterest,viewState:this.state})}_exitSurface(){this.sharedSymbolResources&&(this.sharedSymbolResources.objectResourceCache.destroy(),this.sharedSymbolResources.destroy(),this.sharedSymbolResources=null,this._exitGlobe(),this._exitStage())}_createGraphicsViewIfNeeded(){if(this.graphicsView||this._createGraphicsViewController||this.graphics.length===0)return;this.removeHandles("graphics-view"),this._createGraphicsViewController=new AbortController;const t=()=>{this._createGraphicsViewController=null,this._updatingChanged()};this._createGraphicsViewAsync(this._createGraphicsViewController.signal).then(t,t),this._updatingChanged()}async _createGraphicsViewAsync(t){const e=(await J(()=>import("./GraphicsView3D-6a12ed3d.js"),["./GraphicsView3D-6a12ed3d.js","./GraphicsProcessor-5c167a1f.js","./Graphics3DScaleVisibility-18b9f7c2.js","./rendererConversion-fa3e158c.js","./optimizedFeatureQueryEngineAdapter-59eeddb7.js","./centroid-3dcadaf5.js","./PooledRBush-31030974.js","./quickselect-7692f5ca.js"],import.meta.url)).default;Dt(t),await Pn(()=>this.basemapTerrain?.ready,t),this._set("graphicsView",new e({view:this}))}_disposeGraphicsView(){this._createGraphicsViewController&&(this._createGraphicsViewController.abort(),this._createGraphicsViewController=null),this.removeHandles("graphics-view"),this.graphicsView!=null&&(this.removeHandles(this.graphicsView.processor.layer.id),this.graphicsView.destroy(),this._set("graphicsView",null))}_startup(){const t=Bce(this.viewingMode);if(t===Ue.Global&&(this._clippingArea=null),this._initSurface(t),this._set("ready",!0),this.addHandles(Vs(()=>this.graphics,"after-changes",()=>this._createGraphicsViewIfNeeded()),"graphics-view"),this._createGraphicsViewIfNeeded(),!this._externallySet.environment){const r=this.get("map.initialViewProperties.environment");r&&(this.environment=r)}this.labeler.setup(),this.environmentManager.connectView(this),this.inputManager.connect();const e=this._resolveWhenReady;this._resolveWhenReady=[],e.forEach(r=>r(this))}_teardown(){this._initialDefaultSpatialReference=null,this.inputManager.disconnect(),this.environmentManager.disconnectView(),this.labeler.dispose(),this._disposeGraphicsView(),this.removeHandles("graphics-view"),this._exitSurface(),this._set("ready",!1)}_updateDefaultToMapOptions(){if(this._defaultToMapOptions.include.clear(),this.map){this.map.ground&&this._defaultToMapOptions.include.add(Yv);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&this._defaultToMapOptions.include.add(t.uid)}}_updateDefaultHitTestOptions(){if(this._defaultHitTestOptions.exclude.clear(),this.map){this.map.ground&&this.map.ground.opacity<1&&this._defaultHitTestOptions.exclude.add(Yv);for(const t of this.map.allLayers.items)t.type==="integrated-mesh"&&t.opacity<1&&this._defaultHitTestOptions.exclude.add(t.uid)}}addVoxelLayerViewToWasm(t){return this.voxelWasm==null?(this.voxelWasmPromise==null&&(this.voxelWasmPromise=J(()=>import("./VoxelWasmPerSceneView-e93af6f8.js"),[],import.meta.url).then(e=>(this.voxelWasm=new e.default(this),this.voxelWasm))),this.voxelWasmPromise.then(e=>e.addVoxelLayer(t))):this.voxelWasm.addVoxelLayer(t)}removeVoxelLayerViewFromWasm(t){this.voxelWasm!=null&&this.voxelWasm.removeVoxelLayer(t)<1&&(this.voxelWasm=null,this.voxelWasmPromise=null)}};function ZR(t,e){t.layerUids||(t.layerUids=new Set),t.layerUids.add(e)}function dDt(t,e){t.graphicUids||(t.graphicUids=new Set),t.graphicUids.add(e)}function gF(t,e){return t!=null&&$f(t.spatialReference,e)?bg(t,e):null}var RI;Ye.type="3d",u([d()],Ye.prototype,"_userClippingArea",void 0),u([d()],Ye.prototype,"_resourceController",void 0),u([d()],Ye.prototype,"_stage",void 0),u([d({readOnly:!0})],Ye.prototype,"deconflictor",void 0),u([d({readOnly:!0})],Ye.prototype,"labeler",void 0),u([d(Hk(CA,"analyses"))],Ye.prototype,"analyses",void 0),u([d({type:OA,readOnly:!0})],Ye.prototype,"animation",null),u([d({readOnly:!0})],Ye.prototype,"basemapTerrain",void 0),u([d({readOnly:!0})],Ye.prototype,"elevationProvider",void 0),u([d()],Ye.prototype,"camera",null),u([d({type:Zd})],Ye.prototype,"contentCamera",null),u([d({readOnly:!0})],Ye.prototype,"canvas",void 0),u([d({type:ht})],Ye.prototype,"center",null),u([d({type:vr})],Ye.prototype,"clippingArea",null),u([d({type:$x})],Ye.prototype,"constraints",void 0),u([d({type:vr,readOnly:!0})],Ye.prototype,"renderDataExtent",null),u([d({type:vr,readOnly:!0})],Ye.prototype,"dataExtent",null),u([d({type:vr,readOnly:!0})],Ye.prototype,"_groundAndLayersExtent",null),u([d({value:null,type:SE})],Ye.prototype,"environment",null),u([or("environment")],Ye.prototype,"castEnvironment",null),u([d({readOnly:!0})],Ye.prototype,"environmentManager",void 0),u([d({type:vr})],Ye.prototype,"extent",null),u([d()],Ye.prototype,"floors",void 0),u([d()],Ye.prototype,"screenCenter",null),u([d()],Ye.prototype,"frustum",null),u([d({type:Number,readOnly:!0})],Ye.prototype,"fullOpacity",void 0),u([d({readOnly:!0})],Ye.prototype,"graphicsView",void 0),u([d({readOnly:!0})],Ye.prototype,"analysisViewManager",void 0),u([d()],Ye.prototype,"groundView",void 0),u([d({type:Boolean})],Ye.prototype,"initialExtentRequired",null),u([d()],Ye.prototype,"_defaultsFromMapSettings",null),u([d()],Ye.prototype,"interacting",null),u([d()],Ye.prototype,"stationary",null),u([d()],Ye.prototype,"navigating",null),u([d()],Ye.prototype,"map",void 0),u([d({readOnly:!0})],Ye.prototype,"mapCoordsHelper",void 0),u([d()],Ye.prototype,"padding",null),u([d({type:lc,readOnly:!0})],Ye.prototype,"pointsOfInterest",void 0),u([d({type:Qo,readOnly:!0})],Ye.prototype,"featureTiles",void 0),u([d()],Ye.prototype,"_featureTreeDebugger",void 0),u([d({type:Boolean})],Ye.prototype,"screenSizePerspectiveEnabled",void 0),u([d({constructOnly:!0})],Ye.prototype,"deactivatedWebGLExtensions",void 0),u([d({constructOnly:!0})],Ye.prototype,"debugWebGLExtensions",void 0),u([d({constructOnly:!0})],Ye.prototype,"renderCanvas",void 0),u([d({constructOnly:!0})],Ye.prototype,"state",void 0),u([d({readOnly:!0})],Ye.prototype,"inputManager",void 0),u([d({readOnly:!0})],Ye.prototype,"stateManager",void 0),u([d({type:["low","medium","high"]})],Ye.prototype,"qualityProfile",null),u([d({type:Ame,get(){let t=this._get("qualitySettings");return t||(t=new Ame,f5.apply(this.qualityProfile,t)),t}})],Ye.prototype,"qualitySettings",void 0),u([d()],Ye.prototype,"slicePlane",null),u([d({readOnly:!0})],Ye.prototype,"typeSpecificPreconditionsReady",null),u([d({readOnly:!0})],Ye.prototype,"renderCoordsHelper",void 0),u([d({readOnly:!0})],Ye.prototype,"sceneIntersectionHelper",void 0),u([d({type:Number,dependsOn:["scale","spatialReference"],readOnly:!0})],Ye.prototype,"resolution",null),u([d({type:Number})],Ye.prototype,"scale",null),u([d()],Ye.prototype,"heightModelInfo",null),u([d()],Ye.prototype,"spatialReference",void 0),u([d({type:Boolean,constructOnly:!0})],Ye.prototype,"alphaCompositingEnabled",void 0),u([d({constructOnly:!0})],Ye.prototype,"preserveDrawingBufferEnabled",void 0),u([d({type:Boolean})],Ye.prototype,"supersampleScreenshotsEnabled",void 0),u([d({readOnly:!0})],Ye.prototype,"type",void 0),u([d(),or(t=>t instanceof h4e?t:bT(d4e,t))],Ye.prototype,"ui",void 0),u([d({type:Boolean,readOnly:!0,dependsOn:["graphicsView.updating","basemapView.updating","basemapTerrain.updating","layerViewManager.updating","layerViewManager.updatingRemaining","_resourceController.updating","_stage.updating","featureTiles.updating","pointsOfInterest.updating","environmentManager.updating","overlay.updating","updatingHandles.updating","featureTreeDebugger.updating","labeler.updating","deconflictor.updating","ready","stationary","inputManager.updating","toolViewManager.updating","analysisViewManager.updating","state.updating"]})],Ye.prototype,"updating",null),u([d()],Ye.prototype,"_updatingObjects",null),u([d()],Ye.prototype,"_updatingObjectsWithProgress",null),u([d({type:Number,readOnly:!0,dependsOn:["updating"]})],Ye.prototype,"updatingProgress",void 0),u([d({type:["global","local"]})],Ye.prototype,"viewingMode",null),u([d({type:Nf})],Ye.prototype,"viewpoint",null),u([d({type:Number})],Ye.prototype,"zoom",null),u([d({type:ZY})],Ye.prototype,"highlightOptions",void 0),Ye=u([R("esri.views.SceneView")],Ye),function(t){t[t.INCLUDE=0]="INCLUDE",t[t.EXCLUDE=1]="EXCLUDE"}(RI||(RI={}));const k2=C(),Oj=cs(),F0e=Ht(),pDt=Ye;const k0e=document.location.pathname,fDt=k0e.substring(0,k0e.lastIndexOf("/")),mDt=`${document.location.origin}${fDt}/oauth-callback-api.html`;HV.registerOAuthInfos([new vZ({appId:"KojZjH6glligLidj",popup:!0,popupCallbackUrl:mDt})]);window.setOAuthResponseHash=t=>{HV.setOAuthResponseHash(t)};const gDt="https://services2.arcgis.com/cFEFS0EWrhfDeVw9/arcgis/rest/services/SO__3857__CH_Zurich__Buildings_InnerCity/SceneServer",yDt=new URLSearchParams(window.location.search),_Dt=new iRe({outFields:["*"],title:"Sample 3D Object Layer",url:yDt.get("url")||gDt}),vDt=new zAe({basemap:"topo-vector",ground:"world-elevation",layers:[_Dt]}),ese=new pDt({spatialReference:qe.WebMercator,viewingMode:"local",container:"viewDiv",map:vDt,qualityProfile:"high",camera:{position:{spatialReference:qe.WebMercator,x:950536.3463579026,y:6.0024481828584075e6,z:2058.876304641366},heading:8.074740948860455,tilt:34.11767720840555},environment:{lighting:{directShadowsEnabled:!0}}});window.view=ese;const bDt=new Dst({view:ese});ese.ui.add(bDt,"top-right");export{B_t as $,_Fe as A,mIt as B,b3e as C,GU as D,Hht as E,uxt as F,Iwt as G,Dwt as H,Zie as I,pie as J,cRt as K,lRt as L,e9 as M,uRt as N,WU as O,Mbt as P,XIt as Q,SFe as R,Xut as S,QIt as T,AFe as U,DMt as V,ePt as W,MFe as X,nxt as Y,s9 as Z,_Ne as _,y3e as a,tkt as a$,dPt as a0,wPt as a1,PPt as a2,LPt as a3,NPt as a4,mwt as a5,IFe as a6,mPt as a7,KPt as a8,aTt as a9,ht as aA,D as aB,Do as aC,u as aD,d as aE,R as aF,e5t as aG,Uj as aH,nn as aI,K4t as aJ,Sc as aK,w1 as aL,Zr as aM,SFt as aN,pje as aO,UFt as aP,CFt as aQ,tGe as aR,vf as aS,li as aT,xt as aU,Re as aV,bc as aW,aS as aX,ooe as aY,DFt as aZ,rkt as a_,kTt as aa,sEt as ab,SEt as ac,_Et as ad,EFt as ae,AFt as af,TFt as ag,hwe as ah,LFt as ai,VFt as aj,$Ft as ak,OFt as al,BFt as am,aGe as an,PFt as ao,zFt as ap,GFt as aq,jFt as ar,NFt as as,lje as at,me as au,ws as av,hb as aw,Dt as ax,Tr as ay,J as az,V3e as b,qr as b$,re as b0,oV as b1,vg as b2,K as b3,Ke as b4,_T as b5,oa as b6,yqe as b7,_qe as b8,QP as b9,qT as bA,sb as bB,qt as bC,RDt as bD,Rj as bE,V0e as bF,p$ as bG,BK as bH,rYe as bI,Ld as bJ,MDt as bK,JTe as bL,Lt as bM,mL as bN,Gn as bO,v7e as bP,C as bQ,Pf as bR,Iu as bS,lO as bT,Nge as bU,Vge as bV,Fl as bW,h0 as bX,zs as bY,Wrt as bZ,Pe as b_,qe as ba,TC as bb,U0 as bc,Le as bd,c1 as be,uS as bf,hO as bg,Et as bh,wT as bi,_I as bj,I1 as bk,uSe as bl,Q as bm,Rr as bn,D7t as bo,N7t as bp,gV as bq,xvt as br,$0 as bs,cb as bt,Ri as bu,qjt as bv,uqt as bw,jTe as bx,WO as by,Ia as bz,$dt as c,DNt as c$,Bn as c0,jK as c1,lUt as c2,v$ as c3,Mee as c4,vne as c5,Ht as c6,rA as c7,Vl as c8,GV as c9,pB as cA,$i as cB,MBt as cC,IBt as cD,nU as cE,yhe as cF,zZe as cG,so as cH,xe as cI,Ne as cJ,LSe as cK,Kd as cL,Ms as cM,D$e as cN,K0 as cO,wS as cP,No as cQ,mut as cR,Pn as cS,T9t as cT,sS as cU,nAt as cV,Oc as cW,e$ as cX,Xr as cY,MCe as cZ,gNt as c_,Jr as ca,ANt as cb,ie as cc,Tn as cd,gu as ce,Wa as cf,Zat as cg,Xa as ch,n8t as ci,s8t as cj,the as ck,zA as cl,CNt as cm,ENt as cn,_i as co,ZP as cp,vr as cq,Sg as cr,$f as cs,Yot as ct,HVt as cu,jUt as cv,he as cw,Ml as cx,zpt as cy,Ee as cz,Tpt as d,lbe as d$,Ue as d0,rCe as d1,k1e as d2,po as d3,xh as d4,ece as d5,fs as d6,iT as d7,eEe as d8,M4t as d9,t5t as dA,BE as dB,G5t as dC,T0 as dD,mi as dE,SF as dF,y4t as dG,O7t as dH,Au as dI,Txe as dJ,$T as dK,LY as dL,dn as dM,XWe as dN,nkt as dO,x1 as dP,U6 as dQ,ps as dR,WDt as dS,Rh as dT,mn as dU,E as dV,Ge as dW,jA as dX,eo as dY,gie as dZ,Ut as d_,cEe as da,ao as db,i5t as dc,Fn as dd,sg as de,Eqe as df,VDt as dg,QK as dh,tAt as di,le as dj,$o as dk,lCe as dl,MOt as dm,dXt as dn,Lie as dp,Vs as dq,_r as dr,Bd as ds,Nst as dt,Wnt as du,Ve as dv,F2e as dw,FOe as dx,rs as dy,nt as dz,$pt as e,yT as e$,jJe as e0,T1 as e1,xT as e2,zQ as e3,VQ as e4,Ebe as e5,BQ as e6,YNt as e7,P8e as e8,WVt as e9,TW as eA,Nk as eB,I2e as eC,zNt as eD,xP as eE,lHe as eF,Uet as eG,vi as eH,la as eI,oUt as eJ,Aee as eK,VW as eL,aUt as eM,DV as eN,yKe as eO,zEt as eP,b4t as eQ,sUt as eR,Ig as eS,ESe as eT,x2e as eU,tEe as eV,YK as eW,_Ot as eX,as as eY,xa as eZ,yOt as e_,Nce as ea,qVt as eb,uat as ec,rRe as ed,K9e as ee,Blt as ef,Rze as eg,Gi as eh,yg as ei,st as ej,_e as ek,lP as el,E8t as em,U8t as en,QI as eo,gt as ep,Clt as eq,w8t as er,jXe as es,y$ as et,mA as eu,bg as ev,Uo as ew,wW as ex,Js as ey,bW as ez,a1t as f,fee as f$,Ae as f0,dS as f1,i2e as f2,G4 as f3,$se as f4,QYe as f5,KYe as f6,eJe as f7,Oce as f8,SK as f9,wze as fA,oFt as fB,One as fC,nFt as fD,Qa as fE,O9e as fF,T7t as fG,v1t as fH,mOe as fI,XR as fJ,wi as fK,si as fL,Tg as fM,xu as fN,gs as fO,Fk as fP,Nit as fQ,Fit as fR,O6t as fS,tte as fT,Ait as fU,qUt as fV,B6t as fW,z6t as fX,gT as fY,L5 as fZ,ete as f_,Tkt as fa,y4e as fb,Vk as fc,Oh as fd,Ckt as fe,Ekt as ff,dQe as fg,I4t as fh,JMt as fi,QMt as fj,jMt as fk,HJt as fl,f6 as fm,KYt as fn,eIt as fo,jVe as fp,CZe as fq,dze as fr,D1t as fs,N1t as ft,GQ as fu,C$e as fv,x7t as fw,w7t as fx,Y9e as fy,eT as fz,Wte as g,IFt as g$,dUt as g0,Sbe as g1,MI as g2,ekt as g3,f5t as g4,Or as g5,y5t as g6,ob as g7,EUt as g8,CUt as g9,fA as gA,Ki as gB,E1 as gC,Kx as gD,v7 as gE,Ul as gF,sf as gG,LK as gH,pc as gI,or as gJ,iO as gK,wDt as gL,GZe as gM,oe as gN,FDt as gO,BDt as gP,aHe as gQ,UL as gR,Pae as gS,Cu as gT,Dl as gU,L5t as gV,kFt as gW,aje as gX,nje as gY,RFt as gZ,MFt as g_,N1 as ga,RUe as gb,Ett as gc,SUt as gd,bSe as ge,Gt as gf,B9 as gg,Lqe as gh,yV as gi,iS as gj,ZSe as gk,bQe as gl,xee as gm,FI as gn,a2e as go,s2e as gp,Mu as gq,sV as gr,xQe as gs,SSe as gt,PXe as gu,t0 as gv,Z8t as gw,Ng as gx,UAe as gy,AQe as gz,Adt as h,vlt as h$,FFt as h0,tst as h1,xg as h2,qit as h3,xAe as h4,WUt as h5,QJe as h6,no as h7,AA as h8,Evt as h9,mBt as hA,JP as hB,Ra as hC,vs as hD,OV as hE,bi as hF,xn as hG,C0 as hH,Ji as hI,VUt as hJ,y7 as hK,skt as hL,vae as hM,_g as hN,Int as hO,uEe as hP,Bnt as hQ,eRe as hR,Ox as hS,ed as hT,q3 as hU,Z3 as hV,mSe as hW,SV as hX,aO as hY,kr as hZ,lEe as h_,Pi as ha,gC as hb,VV as hc,t2e as hd,gkt as he,qm as hf,Lf as hg,DUt as hh,aa as hi,cs as hj,Su as hk,Jjt as hl,Yjt as hm,GUt as hn,rb as ho,Gf as hp,F$ as hq,If as hr,IOt as hs,K8t as ht,rS as hu,Nct as hv,Sh as hw,Sne as hx,hh as hy,Mf as hz,M$e as i,aJ as i$,Nl as i0,Un as i1,KK as i2,cBt as i3,BA as i4,wc as i5,yi as i6,Z1 as i7,Eqt as i8,WT as i9,xSe as iA,fpe as iB,Ha as iC,GVe as iD,y6t as iE,D5t as iF,EWe as iG,GE as iH,OW as iI,w6t as iJ,W4t as iK,_6t as iL,vc as iM,ue as iN,js as iO,Lat as iP,mf as iQ,Vf as iR,aT as iS,j8t as iT,zat as iU,HDt as iV,vUe as iW,nu as iX,QJ as iY,KUe as iZ,Dr as i_,Tqt as ia,Cqt as ib,vV as ic,Sqt as id,CTt as ie,RTt as ig,hne as ih,Ci as ii,ts as ij,ATt as ik,OTt as il,ye as im,wRt as io,BLt as ip,z6 as iq,wd as ir,noe as is,d$ as it,vZe as iu,YC as iv,zDt as iw,$ne as ix,r5t as iy,Kp as iz,KT as j,fg as j$,lJ as j0,sO as j1,ak as j2,fV as j3,vYe as j4,gTe as j5,EV as j6,g$ as j7,Uk as j8,eYe as j9,qoe as jA,oEe as jB,tV as jC,U1 as jD,PJe as jE,OJe as jF,qXe as jG,n2e as jH,oW as jI,mV as jJ,r2e as jK,aEe as jL,rnt as jM,tnt as jN,Kst as jO,yce as jP,tl as jQ,znt as jR,A0 as jS,bA as jT,PT as jU,p4t as jV,xCe as jW,Cne as jX,uh as jY,mg as jZ,Dd as j_,tYe as ja,Tee as jb,V0 as jc,XK as jd,XTe as je,aJe as jf,oJe as jg,nJe as jh,kYe as ji,QSe as jj,xYe as jk,SYe as jl,bTe as jm,oYe as jn,aYe as jo,lYe as jp,uYe as jq,hYe as jr,dYe as js,pYe as jt,fYe as ju,mYe as jv,gYe as jw,yYe as jx,Abe as jy,_Ye as jz,VRt as k,kg as k$,KI as k0,aee as k1,KXe as k2,rP as k3,k as k4,fe as k5,ls as k6,pr as k7,ci as k8,ff as k9,hFt as kA,gFt as kB,dFt as kC,pFt as kD,fFt as kE,mFt as kF,yFt as kG,ONt as kH,HU as kI,Qi as kJ,Vt as kK,Id as kL,pe as kM,Jfe as kN,uC as kO,yBt as kP,ke as kQ,an as kR,Cr as kS,Eu as kT,_c as kU,w as kV,Bs as kW,Ah as kX,et as kY,Ie as kZ,BU as k_,Gs as ka,Qe as kb,Ai as kc,hAt as kd,bct as ke,Qv as kf,wn as kg,na as kh,ore as ki,AQt as kj,dZt as kk,iAt as kl,bC as km,jE as kn,hP as ko,HUt as kp,Gjt as kq,wI as kr,u7 as ks,_Ft as kt,vFt as ku,nO as kv,B6 as kw,lFt as kx,cFt as ky,uFt as kz,obt as l,xDt as l$,ut as l0,Ru as l1,Te as l2,B as l3,Ii as l4,$r as l5,Ea as l6,Ur as l7,Lr as l8,Er as l9,Rlt as lA,_8t as lB,T8t as lC,YOe as lD,nMe as lE,f8e as lF,KC as lG,S6t as lH,i1 as lI,Tct as lJ,U0e as lK,Elt as lL,_d as lM,hr as lN,fc as lO,qee as lP,yA as lQ,X6t as lR,b$ as lS,Kwe as lT,Lo as lU,Wr as lV,ae as lW,t8t as lX,qat as lY,kke as lZ,wh as l_,It as la,Q0 as lb,n8 as lc,gb as ld,Ac as le,I8 as lf,Wt as lg,Og as lh,nb as li,yb as lj,L8 as lk,lie as ll,P8 as lm,IO as ln,twt as lo,zte as lp,Dre as lq,JUt as lr,_Ce as ls,hd as lt,VI as lu,g7t as lv,uBt as lw,U8 as lx,tNe as ly,ra as lz,c3t as m,lSt as m$,sA as m0,lNt as m1,e2e as m2,BJ as m3,n$t as m4,oi as m5,M2e as m6,bF as m7,coe as m8,QNt as m9,Ir as mA,b8t as mB,ur as mC,yu as mD,mK as mE,Jue as mF,tDe as mG,iDe as mH,Uh as mI,bI as mJ,fT as mK,ZLe as mL,ISt as mM,ETt as mN,j1t as mO,O$e as mP,HNt as mQ,q1t as mR,aSt as mS,tSt as mT,rSt as mU,cSt as mV,sSt as mW,nSt as mX,Ff as mY,iSt as mZ,rl as m_,aA as ma,_4t as mb,Sn as mc,IDt as md,DT as me,Skt as mf,p2e as mg,oQ as mh,V1 as mi,oE as mj,BH as mk,Pkt as ml,h2e as mm,bT as mn,z5 as mo,s5t as mp,UVe as mq,P2e as mr,Qm as ms,h$ as mt,gqt as mu,BY as mv,rQe as mw,WP as mx,DQ as my,w9 as mz,oFe as n,L as n$,C$ as n0,d8 as n1,zn as n2,H1t as n3,oSt as n4,f8 as n5,Yd as n6,fb as n7,HC as n8,_2 as n9,GI as nA,T6t as nB,HXe as nC,KP as nD,sFt as nE,eFt as nF,rFt as nG,tFt as nH,iFt as nI,gh as nJ,Oze as nK,LPe as nL,P6 as nM,S0 as nN,KY as nO,B0 as nP,zP as nQ,_S as nR,P0 as nS,Oi as nT,Tte as nU,Th as nV,vte as nW,QC as nX,NZe as nY,ng as nZ,wqt as n_,dV as na,kt as nb,Io as nc,a4t as nd,YVt as ne,$Me as nf,yS as ng,Oe as nh,$2e as ni,zr as nj,x$ as nk,KVt as nl,de as nm,Jd as nn,Yv as no,zd as np,Vd as nq,zE as nr,h4 as ns,hUt as nt,b6 as nu,nS as nv,rAt as nw,eAt as nx,aCe as ny,wct as nz,oIt as o,xfe as o$,xNt as o0,Ky as o1,o8 as o2,Mg as o3,Oat as o4,wC as o5,qCt as o6,rdt as o7,el as o8,Nzt as o9,Qt as oA,vh as oB,$8 as oC,mb as oD,HIe as oE,pb as oF,us as oG,iPe as oH,it as oI,Nre as oJ,lf as oK,m4t as oL,ft as oM,yue as oN,iQ as oO,qd as oP,xte as oQ,n4t as oR,kn as oS,q8t as oT,ZNt as oU,gue as oV,Dg as oW,IV as oX,yee as oY,zt as oZ,jd as o_,Lzt as oa,Dzt as ob,H8t as oc,M6t as od,Trt as oe,Hd as of,R6t as og,Oa as oh,kit as oi,zPe as oj,fBt as ok,SOe as ol,pn as om,DZ as on,EDt as oo,ykt as op,E7t as oq,S7t as or,qCe as os,m6t as ot,cbe as ou,kf as ov,cr as ow,NA as ox,jt as oy,ia as oz,cFe as p,Hrt as p$,Bre as p0,sNt as p1,rUe as p2,Hkt as p3,jkt as p4,Bkt as p5,WE as p6,hKe as p7,Gkt as p8,lRe as p9,V2e as pA,ACe as pB,CCe as pC,Ot as pD,jNt as pE,Q0e as pF,TQ as pG,BNt as pH,ove as pI,ms as pJ,Fje as pK,w5 as pL,d3t as pM,LEe as pN,Mot as pO,NNt as pP,CQ as pQ,$8e as pR,Ort as pS,RCe as pT,oCe as pU,brt as pV,vrt as pW,Dit as pX,r9e as pY,eit as pZ,jrt as p_,Klt as pa,UUt as pb,ja as pc,Qct as pd,aP as pe,ca as pf,ui as pg,nl as ph,ASe as pi,dA as pj,LOe as pk,Cc as pl,Got as pm,JVt as pn,ihe as po,fpt as pp,cP as pq,pA as pr,o4t as ps,ugt as pt,Ste as pu,ict as pv,vu as pw,t8 as px,jee as py,ZUt as pz,cIt as q,R7t as q$,KJ as q0,XJ as q1,Y0 as q2,ghe as q3,RBt as q4,k7t as q5,B0e as q6,wu as q7,mve as q8,NDt as q9,j8 as qA,Pr as qB,es as qC,zf as qD,$u as qE,Gr as qF,Mr as qG,ep as qH,ph as qI,YIe as qJ,G8t as qK,F0t as qL,Mc as qM,ze as qN,Eh as qO,qlt as qP,g_t as qQ,VA as qR,S9e as qS,fh as qT,Ivt as qU,JX as qV,Vre as qW,UM as qX,S1 as qY,A7t as qZ,ppe as q_,zj as qa,bxe as qb,nUt as qc,Mrt as qd,ktt as qe,GCe as qf,Wd as qg,wA as qh,iot as qi,lte as qj,bot as qk,gS as ql,Jrt as qm,ah as qn,yr as qo,D6 as qp,e4t as qq,O0 as qr,$1 as qs,_xe as qt,lA as qu,kDt as qv,j6 as qw,wZ as qx,x8e as qy,Ch as qz,hIt as r,uf as r$,KNt as r0,fQ as r1,v7t as r2,x$e as r3,S$e as r4,b$e as r5,vpe as r6,Z1t as r7,g6t as r8,xbe as r9,l8 as rA,Pu as rB,J0 as rC,sa as rD,rt as rE,zi as rF,cxe as rG,f8t as rH,m8t as rI,y8t as rJ,fK as rK,TQt as rL,Jct as rM,tZt as rN,O8t as rO,R8t as rP,Jm as rQ,_$ as rR,ube as rS,MK as rT,XE as rU,GOe as rV,zUt as rW,aU as rX,zl as rY,CC as rZ,Gqe as r_,D8e as ra,UNt as rb,v8e as rc,C8e as rd,E$e as re,EQ as rf,INt as rg,YTe as rh,uWe as ri,K6 as rj,Ll as rk,h8t as rl,p8t as rm,f4t as rn,d7e as ro,Qw as rp,c8t as rq,Dlt as rr,xU as rs,v4t as rt,Tjt as ru,VIe as rv,die as rw,_h as rx,m7 as ry,BT as rz,mFe as s,EL as s$,r8t as s0,z2e as s1,H1 as s2,tQe as s3,e8t as s4,Hat as s5,I0 as s6,zI as s7,cg as s8,xC as s9,exe as sA,Gnt as sB,okt as sC,w2e as sD,CS as sE,zXe as sF,iV as sG,a$ as sH,o$ as sI,cO as sJ,m2e as sK,Kje as sL,mkt as sM,aCt as sN,y1t as sO,m1t as sP,n7t as sQ,s7t as sR,M0 as sS,P7t as sT,Mo as sU,Ca as sV,aZt as sW,nie as sX,Pa as sY,dNt as sZ,oh as s_,jn as sa,Gq as sb,t8e as sc,e8e as sd,wQ as se,zot as sf,Tot as sg,wot as sh,i0 as si,II as sj,Iot as sk,UDt as sl,D1 as sm,QVt as sn,n9 as so,lU as sp,Ybt as sq,RQt as sr,A6t as ss,IQt as st,MQt as su,YP as sv,Mi as sw,wrt as sx,WNt as sy,mue as sz,dFe as t,lXe as t$,C6t as t0,RW as t1,b6t as t2,Zvt as t3,rV as t4,hS as t5,lCt as t6,on as t7,BDe as t8,ACt as t9,iQe as tA,sn as tB,_lt as tC,Wx as tD,$8t as tE,uO as tF,P8t as tG,Xt as tH,VTe as tI,zTe as tJ,Wjt as tK,I8t as tL,x8t as tM,T7 as tN,j as tO,JQ as tP,kEe as tQ,UEe as tR,pet as tS,FEe as tT,yet as tU,_et as tV,vet as tW,jEe as tX,os as tY,qSe as tZ,aXe as t_,dxe as ta,W0e as tb,T4e as tc,GNt as td,Wft as te,D8t as tf,N8t as tg,EQt as th,wte as ti,M8t as tj,C8t as tk,A8t as tl,S8t as tm,zN as tn,nPe as to,AMt as tp,dat as tq,xot as tr,d8t as ts,L8t as tt,pat as tu,ZJe as tv,Zce as tw,ZC as tx,hBt as ty,xA as tz,D3e as u,Tne as u$,pV as u0,Eet as u1,uUt as u2,vst as u3,Hxe as u4,j5t as u5,mUt as u6,qq as u7,pUt as u8,fUt as u9,NOe as uA,c4 as uB,qK as uC,k8t as uD,F8t as uE,TA as uF,Bat as uG,m0 as uH,vie as uI,H8 as uJ,ni as uK,VYt as uL,_kt as uM,ZVt as uN,jJ as uO,LDt as uP,fP as uQ,kI as uR,Xjt as uS,E3e as uT,ylt as uU,g8t as uV,y1 as uW,Pat as uX,Alt as uY,Bce as uZ,v8t as u_,QEe as ua,Hqe as ub,w7 as uc,s1 as ud,A7 as ue,Aa as uf,Hm as ug,Rc as uh,Gx as ui,k3 as uj,wet as uk,FCe as ul,DCe as um,k6 as un,sk as uo,F0 as up,XV as uq,I6t as ur,Fo as us,O1 as ut,QV as uu,HOe as uv,i8t as uw,SLe as ux,QLe as uy,Tve as uz,Dht as v,Nqe as v$,pAt as v0,X6 as v1,Jt as v2,v4e as v3,jCe as v4,HCe as v5,GDt as v6,cUt as v7,kme as v8,cJ as v9,XNt as vA,SDt as vB,OXt as vC,qNt as vD,VXe as vE,E6t as vF,fu as vG,$Dt as vH,zqe as vI,Jwt as vJ,Qu as vK,Sr as vL,Vn as vM,fn as vN,Rt as vO,Bi as vP,Sa as vQ,Ire as vR,Eg as vS,wjt as vT,Mt as vU,At as vV,Je as vW,$5t as vX,b7t as vY,pO as vZ,kK as v_,wp as va,h6 as vb,SNt as vc,TNt as vd,F6 as ve,Abt as vf,rte as vg,kee as vh,Dp as vi,pv as vj,JC as vk,RJ as vl,uVt as vm,cTt as vn,ZT as vo,lXt as vp,d6 as vq,du as vr,pu as vs,dJ as vt,uJ as vu,pJ as vv,hJ as vw,Ume as vx,Cqe as vy,yit as vz,g3e as w,k4t as w$,Fqe as w0,NTe as w1,Fet as w2,tWe as w3,ket as w4,UK as w5,Rk as w6,fNt as w7,Ka as w8,PTe as w9,PM as wA,JJe as wB,OK as wC,WHe as wD,P4t as wE,$4t as wF,cZ as wG,lK as wH,L4t as wI,Kxe as wJ,N4t as wK,OHe as wL,SHe as wM,D4t as wN,CK as wO,bHe as wP,$je as wQ,NHe as wR,oO as wS,Zke as wT,Jxe as wU,V4t as wV,wk as wW,Tk as wX,XI as wY,Pje as wZ,ZQe as w_,HM as wa,H8e as wb,WV as wc,tk as wd,N6 as we,c8e as wf,l8e as wg,RNt as wh,nVe as wi,eXt as wj,cXt as wk,PLe as wl,kx as wm,Vme as wn,KZt as wo,rXt as wp,Fx as wq,JZt as wr,ZG as ws,u5 as wt,Tc as wu,Xd as wv,s$e as ww,Ed as wx,HAt as wy,qAt as wz,Bht as x,m5t as x$,U4t as x0,vHe as x1,UHe as x2,aV as x3,F4t as x4,B4t as x5,z4t as x6,G4t as x7,j4t as x8,gVt as x9,YUt as xA,HL as xB,_u as xC,k1 as xD,Rat as xE,IWe as xF,q9e as xG,p7e as xH,M7t as xI,C7t as xJ,nZe as xK,U5t as xL,Mk as xM,KB as xN,eG as xO,ADt as xP,ODt as xQ,y7t as xR,ZWe as xS,G1 as xT,_L as xU,AUt as xV,RUt as xW,OUt as xX,MUt as xY,IUt as xZ,dve as x_,Zwe as xa,Xwe as xb,s$ as xc,sDt as xd,xtt as xe,jW as xf,uk as xg,xFt as xh,Stt as xi,Cee as xj,oTt as xk,nTt as xl,kv as xm,_rt as xn,qDt as xo,g4t as xp,V6 as xq,_Bt as xr,vBt as xs,ppt as xt,gBt as xu,Srt as xv,Zi as xw,pte as xx,kNt as xy,elt as xz,nI as y,Rge as y$,g5t as y0,_5t as y1,Ck as y2,Gk as y3,WKe as y4,Tx as y5,GKe as y6,qw as y7,LV as y8,$V as y9,qge as yA,Wge as yB,FNt as yC,FQ as yD,G1e as yE,$Nt as yF,$9e as yG,F8e as yH,LNt as yI,Zge as yJ,VNt as yK,qkt as yL,iUt as yM,Kkt as yN,Qkt as yO,UEt as yP,eUt as yQ,tUt as yR,Ole as yS,Mle as yT,Rle as yU,Ykt as yV,Jkt as yW,gge as yX,age as yY,lge as yZ,cge as y_,ige as ya,PV as yb,nge as yc,nKe as yd,WK as ye,zWe as yf,ZK as yg,dSe as yh,$ee as yi,pSe as yj,qet as yk,zW as yl,rJe as ym,iJe as yn,sJe as yo,Oxt as yp,PNt as yq,Ege as yr,bge as ys,R8e as yt,wge as yu,Fge as yv,xge as yw,JNt as yx,Oge as yy,Hge as yz,pIt as z,rye as z0,nye as z1,yge as z2,iye as z3,eV as z4,Bk as z5,rUt as z6,aKe as z7,lKe as z8,Zkt as z9,Xkt as za,vEe as zb,Wkt as zc,GEt as zd,cKe as ze,jQ as zf,rWe as zg,I5t as zh,ukt as zi,xkt as zj,Lkt as zk,z8t as zl,jjt as zm,Bqt as zn};
